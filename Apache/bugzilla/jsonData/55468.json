[{"count": 0, "tags": [], "bug_id": 55468, "attachment_id": null, "id": 169655, "time": "2013-08-22T14:33:43Z", "creator": "shaggie76@hotmail.com", "creation_time": "2013-08-22T14:33:43Z", "is_private": false, "text": "Longer POST bodies get truncated when mod_deflate inflates gzip-encoded data. This seems to be a recent regression.\n\nWe have been using SetInputFilter DEFLATE with gzip-encoded POST bodies with great success for many months on Linux with Apache 2.2.22. We also have been using it on Windows 7 with 2.4.2 with no problems for the same period.\n\nWe recently updated both to 2.4.6 and started having problems with truncated POSTs -- it took a while to boil it down because at first it seemed coincident with an upgrade to PHP 5.5 however I've made an isolated test case that just uses CGI to rule out PHP entirely so I'm pretty sure recent changes to mod_deflate.c are responsible.\n\nHere's a quick hack I used to reproduce the problem on Windows\n\nhttpd.conf snip:\n\nAlias /inflate/ \"S:/InflateTests/\"\n\n<Directory \"S:/InflateTests\">\n    SetInputFilter DEFLATE\n    Options +ExecCGI\n    AddHandler cgi-script .pl\n\n    Order allow,deny\n    Allow from all\n    Require all granted\n</Directory>\n\necho.pl:\n\n#!d:/Perl/perl/bin/perl.exe\nprint \"Content-Type: text/plain\\n\\n\";\n$len = 0;\nwhile (<>) { print; $len += length($_); }\n\nprint(\"$len bytes echoed\\n\");\n\nrepro steps:\n\nI used mod_deflate.c as a test upload\n\n1) wget -O- --post-file=mod_deflate.c http://localhost/inflate/echo.pl\n... echoes full file, 58603 bytes echoed\n\n2) gzip -n mod_deflate.c\n3) wget -O- --post-file=mod_deflate.c.gz --header=\"Content-Encoding: gzip\" http://localhost/inflate/echo.pl\n... echoes about half of the file, 32480 bytes echoed"}, {"count": 1, "tags": [], "creator": "shaggie76@hotmail.com", "attachment_id": null, "is_private": false, "id": 169656, "time": "2013-08-22T14:58:17Z", "bug_id": 55468, "creation_time": "2013-08-22T14:58:17Z", "text": "I just downgraded my local Apache to 2.4.2 and cannot reproduce the problem any more."}, {"count": 2, "tags": [], "bug_id": 55468, "attachment_id": null, "id": 169657, "time": "2013-08-22T18:44:29Z", "creator": "shaggie76@hotmail.com", "creation_time": "2013-08-22T18:44:29Z", "is_private": false, "text": "The fine gents over at apachelounge provided me a 2.4.4 archive to quickly test against and it *did not* have the bug."}, {"count": 3, "tags": [], "text": "(In reply to Glen Miner from comment #2)\n> The fine gents over at apachelounge provided me a 2.4.4 archive to quickly\n> test against and it *did not* have the bug.\n\nCan you mix/match the mod_deflate.so just to make 100% certain it's strictly in that module and not some intra-module thing?", "is_private": false, "bug_id": 55468, "id": 169658, "time": "2013-08-22T18:50:34Z", "creator": "covener@gmail.com", "creation_time": "2013-08-22T18:50:34Z", "attachment_id": null}, {"count": 4, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "is_private": false, "id": 169659, "time": "2013-08-22T18:55:51Z", "bug_id": 55468, "creation_time": "2013-08-22T18:55:51Z", "text": "Any messages in the error log?"}, {"count": 5, "tags": [], "text": "Good idea about module mix-match; it confirmed that the bug is in mod_deflate.so because the mod from 2.4.6 reproduced the problem when dropped into 2.4.4 server.\n\nError log is clean.", "is_private": false, "bug_id": 55468, "id": 169660, "time": "2013-08-22T19:06:19Z", "creator": "shaggie76@hotmail.com", "creation_time": "2013-08-22T19:06:19Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 55468, "attachment_id": null, "id": 169666, "time": "2013-08-22T21:11:08Z", "creator": "shaggie76@hotmail.com", "creation_time": "2013-08-22T21:11:08Z", "is_private": false, "text": "I'm sorry if I'm naive but the one thing that jumps out at me in mod_deflate.c between 2.4.4 and 2.4.6 is that it now calls ap_remove_input_filter (line 1024) on  EOS (previously it just break out of the loop).\n\nIE: the comment here seems to imply that left-over data may not be processed? \n\n    /* If we are about to return nothing for a 'blocking' read and we have\n     * some data in our zlib buffer, flush it out so we can return something.\n     */\n\nI'm just fumbling in the dark here -- I hope it helps."}, {"count": 7, "tags": [], "creator": "shaggie76@hotmail.com", "attachment_id": null, "is_private": false, "id": 177544, "time": "2014-09-04T19:21:07Z", "bug_id": 55468, "creation_time": "2014-09-04T19:21:07Z", "text": "Our production servers got updated to Ubuntu 14 LTS and this brought us up to apache 2.4.\n\nLinux war-api-dev 3.13.0-35-generic #62-Ubuntu SMP Fri Aug 15 01:58:42 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux\n\ndpkg -s apache2\n...\nVersion: 2.4.7-1ubuntu4.1\n\nI re-ran this test and confirmed it's still broken. This is extremely unfortunate because it means we now have to screw around to try to back out this nightmare."}, {"count": 8, "tags": [], "bug_id": 55468, "attachment_id": null, "id": 177546, "time": "2014-09-04T21:49:54Z", "creator": "shaggie76@hotmail.com", "creation_time": "2014-09-04T21:49:54Z", "is_private": false, "text": "I spent some time building httpd-2.4.10 from src with the intention of trying to fix this myself only to discover that it seems to be fixed -- or at least my test case passes now -- I will try to find a built package to install in our production environment to test with."}, {"count": 9, "tags": [], "text": "2.4.10 is included with Ubuntu utopic -- for posterity this is how we got our Ubuntu 14.04 LTS to upgrade just apache to get around this.\n\nsudo vi /etc/apt/sources.list\n\nAdd these lines:\n\ndeb http://us.archive.ubuntu.com/ubuntu/ utopic main restricted universe multiverse\ndeb-src http://us.archive.ubuntu.com/ubuntu/ utopic main restricted universe multiverse\n\nsudo vi /etc/apt/preferences\n\nAdd these lines:\n\nPackage: apache2*\nPin: release n=utopic\nPin-Priority: 999\n\nPackage: *\nPin: release a=utopic\nPin-Priority: -10\n\nsudo apt-get update\nsudo apt-get dist-upgrade", "is_private": false, "bug_id": 55468, "id": 177550, "time": "2014-09-05T01:17:06Z", "creator": "shaggie76@hotmail.com", "creation_time": "2014-09-05T01:17:06Z", "attachment_id": null}]