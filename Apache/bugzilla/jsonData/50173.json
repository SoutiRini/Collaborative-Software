[{"count": 0, "tags": [], "text": "Hi,\n I am using JMeter with a Test Plan that uses a JDBC Request with a PreparedStatement query type.\n When running this I am getting the following error in the jmeter.log file\n\n2010/10/28 11:30:31 INFO  - jmeter.threads.JMeterThread: Thread started: JDBC Users 1-1 \n2010/10/28 12:13:38 ERROR - jmeter.threads.JMeterThread: Error while processing sampler 'PREPARED SELECT Customer JDBC Request' : java.lang.NullPointerException\n\tat org.apache.jmeter.protocol.jdbc.sampler.JDBCSampler.getStringFromResultSet(JDBCSampler.java:415)\n\tat org.apache.jmeter.protocol.jdbc.sampler.JDBCSampler.resultSetsToString(JDBCSampler.java:268)\n\tat org.apache.jmeter.protocol.jdbc.sampler.JDBCSampler.sample(JDBCSampler.java:208)\n\tat org.apache.jmeter.threads.JMeterThread.process_sampler(JMeterThread.java:348)\n\tat org.apache.jmeter.threads.JMeterThread.run(JMeterThread.java:243)\n\tat java.lang.Thread.run(Thread.java:619)\n\n The query (below) can be expected to return a number of records \nSELECT * FROM Customer WHERE ID=?;\nthe param is set to 1\n\n If I use instead a SelectStatement results are returned so the query itself is not at fault.\n\n I have retrieved the code for the v2_4 tag to identify the root cause for the NPE and create a patch. This bug report includes a patch against trunk as the issue is also in trunk. \n The root cause is due to:\norg.apache.jmeter.protocol.jdbc.sampler.JDBCSampler.sample(Entry e)\n \n The code path for PreparedStatements types starting on line 204 has in it a call to\norg.hsqldb.jdbc.JDBCPreparedStatement.executeUpdate() \nwhich returns a ResultSet. The side effect of the call is to set the JDBCPreparedStatement.currentResultSet field member to null.\n JDBCSampler does not keep the ResultSet reference. Instead it is discarded.\n\n The call on the next line (208)\nString sb = resultSetsToString(pstmt,true,null)\n again tries to get the ResultSet on line 267. This causes a NullPointerException because the JDBCPreparedStatement.currentResultSet field was set to null earlier.\n\n Looking at the code path for a CALLABLE statement type (line 190) shows better handling for queries that return ResultSet.\n\n The two lines \n207,208\n\n replaced with\n                boolean hasResultSet = pstmt.execute();\n                String sb = resultSetsToString(pstmt,hasResultSet,null);\n                \n fixes the defect.\n\nRegards,\nJeremy Whiting\nRed Hat", "attachment_id": null, "id": 141125, "creator": "jeremy.whiting@hushmail.com", "time": "2010-10-28T10:14:39Z", "bug_id": 50173, "creation_time": "2010-10-28T10:14:39Z", "is_private": false}, {"count": 1, "attachment_id": 26222, "creator": "jeremy.whiting@hushmail.com", "is_private": false, "id": 141126, "time": "2010-10-28T10:18:29Z", "bug_id": 50173, "creation_time": "2010-10-28T10:18:29Z", "tags": [], "text": "Created attachment 26222\nFile with SVN diff patch details.\n\nAttempted to run the Ant test target but this failed.\n\nBUILD FAILED\nJMeter-trunk/build.xml:1723: <fixcrlf> error: srcdir does not exist: 'JMeter-trunk/bin/testfiles'"}, {"count": 2, "tags": [], "bug_id": 50173, "is_private": false, "id": 141136, "creation_time": "2010-10-28T18:07:31Z", "time": "2010-10-28T18:07:31Z", "creator": "sebb@apache.org", "text": "(In reply to comment #1)\n> Attempted to run the Ant test target but this failed.\n> \n> BUILD FAILED\n> JMeter-trunk/build.xml:1723: <fixcrlf> error: srcdir does not exist:\n> 'JMeter-trunk/bin/testfiles'\n\nIn that case, you have not downloaded the full source.", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 50173, "attachment_id": null, "text": "Thanks for the patch, applied to SVN:\n\nURL: http://svn.apache.org/viewvc?rev=1028518&view=rev\nLog:\nBug 50173 - JDBCSampler discards ResultSet from a PreparedStatement\n\nModified:\n   jakarta/jmeter/trunk/src/protocol/jdbc/org/apache/jmeter/protocol/jdbc/sampler/JDBCSampler.java\n   jakarta/jmeter/trunk/xdocs/changes.xml", "id": 141137, "time": "2010-10-28T18:14:00Z", "creator": "sebb@apache.org", "creation_time": "2010-10-28T18:14:00Z", "is_private": false}]