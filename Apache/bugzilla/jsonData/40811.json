[{"count": 0, "tags": [], "bug_id": 40811, "text": "In web.xml, if I define a listener-class, the contextInitialized method in this\nclass is called twice when Tomcat starts up (startup.sh). In both cases the\ncontext being initialized is the same - and in my case there is only one context.\n\nThis clearly is not correct behaviour. Tomcat should only invoke the\ncontextInitialized method once for each context being initialized.\n\nI have tried to use static class members to flag my context as having already\nbeen initialized, but this does not work. It seems as if two independant class\nloaders are loading my listener, because they do not share static class variables.\n\nI'm sure whoever reads this will need some information about the environment.\nIt's basically a really simple Fedora Core 5 setup with Tomcat 5.5.20 running\nand mod_jk integration to Apache. Tomcat works fine once it is running - it just\nbreaks my webapp that the listener class is executed twice.\n\nWhat can I do to work around this if indeed it is a bug?", "id": 95055, "time": "2006-10-24T04:30:26Z", "creator": "mberg_public@yahoo.com", "creation_time": "2006-10-24T04:30:26Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 40811, "text": "Your webapp is probably being deployed twice. (Which is the common cause of \nthis issue) This usually occurs when the webapp lives in the webapps/ dir and \nthe there is context configuration defined for it too.\n\nLook at the mail archives in the tomcat-user list for the topic of webapp being \ndeployed multiple times.", "id": 95056, "time": "2006-10-24T04:44:18Z", "creator": "funkman@joedog.org", "creation_time": "2006-10-24T04:44:18Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 40811, "text": "(In reply to comment #1)\n\nThanks for your reply.\n\n> Your webapp is probably being deployed twice. (Which is the common cause of \n> this issue)\n\nI agree this seems to be what is happening, I just don't understand why.\n\n> This usually occurs when the webapp lives in the webapps/ dir and \n> the there is context configuration defined for it too.\n\nMy webapp does live in the webapps/ dir, but as far as I know there is nothing\nspecial configured with respect to context information. The server.xml just\nlooks like this:\n\n...cut...\n        <Engine name=\"Catalina\" defaultHost=\"search.hyperpal.com\">\n\n            <Host name=\"search.hyperpal.com\" appBase=\"webapps\"\n                  unpackWARs=\"true\" autoDeploy=\"true\"\n                  xmlValidation=\"false\" xmlNamespaceAware=\"false\">\n\n                <Context path=\"\"\n                    docBase=\"search.hyperpal.com\" reloadable=\"true\" debug=\"0\"\n                />\n\n            </Host>\n\n        </Engine>\n...cut... \n\n> Look at the mail archives in the tomcat-user list for the topic of webapp\nbeing deployed multiple times.\n\nI tried browsing through the tomcat-user list but there are thousands of topics\nthere and no search function (that I could find anyway).\n\nBeing the noob that I apparently am, is there any way you can provide more\nspecific links to information about this topic? Or at least show me a way to\nsearch those archives.\n\n/Mike\n", "id": 95057, "attachment_id": null, "creator": "mberg_public@yahoo.com", "creation_time": "2006-10-24T05:06:54Z", "time": "2006-10-24T05:06:54Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 40811, "text": "Remove \n                <Context path=\"\"\n                    docBase=\"search.hyperpal.com\" reloadable=\"true\" debug=\"0\"\n                />\n", "id": 95058, "attachment_id": null, "creator": "funkman@joedog.org", "creation_time": "2006-10-24T05:12:14Z", "time": "2006-10-24T05:12:14Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 40811, "is_private": false, "id": 95068, "creation_time": "2006-10-24T09:24:29Z", "time": "2006-10-24T09:24:29Z", "creator": "mberg_public@yahoo.com", "text": "\n> Remove \n>                 <Context path=\"\"\n>                     docBase=\"search.hyperpal.com\" reloadable=\"true\" debug=\"0\"\n>                 />\n> \n\nThanks for the help - I really appreciate it.\n\nIndeed, this solved the double instantiation. But without the context\ninformation, I am no longer able to access my application at http://x/index.jsp,\nbecause tomcat no longer associates the root level with my search.hyperpal.com\nfolder. It just falls into the old ROOT folder.\n\nIs the essential problem here that my app lives in Tomcat's webapps folder? If\nso, is the correct solution then to move the app out of webapps and keep the\n<context> thing in server.xml, only with a docbase pointing at the\nout-of-webapps folder?\n\nRegardless of the hows and whys, I still maintain that strictly speaking Tomcat\nshould never try to initialize the same context twice. This simply isn't correct\nbehaviour even if the user by means of configuration (or lack thereof) indicates\nthat he wants this to happen. Especially since the programmer has no way to\navoid being initialized twice by conventional means (static class member variables).\n\n", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 40811, "is_private": false, "text": "Some supplemental info, following up on my previous post regarding automatic\ndeployment (see above)\n\nAccording to the official documentation:\n\nhttp://tomcat.apache.org/tomcat-5.5-doc/config/host.html#Automatic%20Application%20Deployment\n\n\"Any subdirectory within the application base directory  that appears to be an\nunpacked web application (that is, it contains a /WEB-INF/web.xml file) will\nreceive an automatically generated Context element, even if this directory is\nnot mentioned in the conf/server.xml file\"\n\nWhat is missing here is a small but important extra statement \"... and even if\nit IS mentioned in conf/server.xml\".\n\nContinuing...:\n\n\"Finally, note that if you are defining contexts explicitly, you should probably\nturn off automatic application deployment. Otherwise, your context will be\ndeployed twice each, and that may cause problems for your app.\"\n\nThis is precisely what is happening to me. So I modified my <host> element in\nserver.xml:\n\n            <Host name=\"search.hyperpal.com\" appBase=\"webapps\"\n                  unpackWARs=\"true\" autoDeploy=\"false\"\n                  xmlValidation=\"false\" xmlNamespaceAware=\"false\">\n\n                <Context path=\"\"\n                    docBase=\"search.hyperpal.com\" reloadable=\"true\" debug=\"0\"\n                />\n\n            </Host>\n\n(note: autodeploy=false on the Host element)\n\nThis still does not work. Tomcat deploys my application twice regardless of the\nHost setting.\n\n", "id": 95069, "time": "2006-10-24T11:19:20Z", "creator": "mberg_public@yahoo.com", "creation_time": "2006-10-24T11:19:20Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 40811, "is_private": false, "text": "Right ... I finally figured this out. The trick is to use\ndeployOnStartup=\"false\" on the Host element in server.xml.\n\nI can't say I fully understand why my app continues to work, but I assume it's\nbecause I have a <context> element in my server.xml and tomcat always deploys\ncontext'ed applications.\n\nThat takes care of my immediate problem, but I still believe that deploying the\nsame application/context more than once is extremely undesirable and something\nthat the dev team needs to give more thought. There is no situation where this\nyields any meaningful result, and it would be more than helpful if Tomcat could\navoid that. I imagine this can be done by modifying the webapp/* autodeployment\ncode (the DefaultContext code I suppose) so apps that have a context defined in\nserver.xml or meta-inf/context.xml aren't autodeployed. It makes a lot of sense.\n\nI'm leaving this resolved-invalid for the time being so you have an opportunity\nto leave a comment - if not for my sake then for others with the same problems.\n", "id": 95075, "time": "2006-10-24T15:04:04Z", "creator": "mberg_public@yahoo.com", "creation_time": "2006-10-24T15:04:04Z", "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 40811, "is_private": false, "text": "(In reply to comment #5)\n> Some supplemental info, following up on my previous post regarding automatic\n> deployment (see above)\n> \n> According to the official documentation:\n> \n>\nhttp://tomcat.apache.org/tomcat-5.5-doc/config/host.html#Automatic%20Application%20Deployment\n> \n> \"Any subdirectory within the application base directory  that appears to be an\n> unpacked web application (that is, it contains a /WEB-INF/web.xml file) will\n> receive an automatically generated Context element, even if this directory is\n> not mentioned in the conf/server.xml file\"\n> \n> What is missing here is a small but important extra statement \"... and even if\n> it IS mentioned in conf/server.xml\".\n\n  That is not only one thing that is missing here. I have a problem with\nautomatically generated Context element for subdirectory within the application\nbase directory  that NOT appears to be an unpacked web application (that is, it\nDOES NOT contain a /WEB-INF/web.xml file!) And when I try to browse files from\nthat directory a get an exception. Here is the snippet from tomcat log file\n\nAug 19, 2007 2:00:41 PM org.apache.jasper.compiler.TldLocationsCache\nprocessWebDotXml\nWARNING: Internal Error: File /WEB-INF/web.xml not found\nAug 19, 2007 2:00:42 PM org.apache.catalina.core.StandardWrapperValve invoke\nSEVERE: Servlet.service() for servlet jsp threw exception\norg.apache.jasper.JasperException: File \"/WEB-INF/struts-html.tld\" not found\n        at\norg.apache.jasper.compiler.DefaultErrorHandler.jspError(DefaultErrorHandler.java:51)\n\nThis comes when I browse a page in a subdirectory, as I mentioned.\nI have several subdirs and they are made to serve a certain purpose. I cannot\ngive them up. I even thought of making each a separate webapp, but it's no good\nfor me either because they must use one and the same context path.\n\nDoes anyone have any idea, how to go around this bug? I think of posting this as\na separate bug for I suprisantly haven't found it posted yet. May be I just\nfailed to do something of what you know could help here...", "id": 106898, "time": "2007-08-19T08:26:19Z", "creator": "natkinnat@mail.ru", "creation_time": "2007-08-19T08:26:19Z", "attachment_id": null}, {"count": 8, "attachment_id": null, "creator": "natkinnat@mail.ru", "is_private": false, "id": 106899, "time": "2007-08-19T09:40:09Z", "bug_id": 40811, "creation_time": "2007-08-19T09:40:09Z", "tags": [], "text": "a problem with\n> automatically generated Context element for subdirectory within the application\n> base directory  that NOT appears to be an unpacked web application (that is, it\n> DOES NOT contain a /WEB-INF/web.xml file!) \n\nThis trick helps with above described problem as well\n\nThe trick is to use deployOnStartup=\"false\" on the Host element in server.xml.\n\n\n\n"}, {"count": 9, "tags": [], "bug_id": 40811, "is_private": false, "id": 124752, "creation_time": "2009-02-09T11:45:30Z", "time": "2009-02-09T11:45:30Z", "creator": "markt@apache.org", "text": "The issues reported above are all expected for the configurations used.\n\nGenerally, placing a dir or a war in a host's appBase and then also defining it in server.xml with a path other than the path that is automatically derived from the dir/war name will result in double deployment.", "attachment_id": null}]