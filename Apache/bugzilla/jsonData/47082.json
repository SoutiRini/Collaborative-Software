[{"count": 0, "attachment_id": 23532, "bug_id": 47082, "is_private": false, "id": 126454, "time": "2009-04-22T22:17:44Z", "creator": "muhammed.k@gmail.com", "creation_time": "2009-04-22T22:17:44Z", "tags": [], "text": "Created attachment 23532\nsample java file which demonstrates the issue\n\nHSSFSheet autoSizeColumn method do not auto size column perfectly when there is leading white spaces in any cell. \n\nSuppose there is few leading whitespaces in cell, and when we call autoSizeColumn on the particular column, we can see the generated excel do not auto size perfectly. It looks like the autoSizeColumn method discards the leading zeros in the text cell before finding the maximum width of each cell.\n\nrun the attached java code, which generates autoSizeColumn.xls, and see the autosize is not perfect."}, {"attachment_id": null, "tags": [], "bug_id": 47082, "text": "Exact reason is POI uses TextLayout to find the width, for which,\nlayout.getBounds().getWidth() return same value for \"A\", \" A\", \"A \".\n\nlayout = new TextLayout(\"A\", font, frc);   \"A\" width = 0.26875\nlayout = new TextLayout(\" A\", font, frc);  \" A\" width = 0.26875\nlayout = new TextLayout(\"A \", font, frc);  \"A \" width = 0.26875\nlayout = new TextLayout(\"AA\", font, frc);  \"AA\" width = 0.535546875", "count": 1, "id": 126462, "time": "2009-04-23T08:46:37Z", "creator": "muhammed.k@gmail.com", "creation_time": "2009-04-23T08:46:37Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 47082, "text": "Created attachment 23539\nsample output which does not exhibit the problem", "id": 126499, "time": "2009-04-24T11:56:24Z", "creator": "yegor@dinom.ru", "creation_time": "2009-04-24T11:56:24Z", "is_private": false, "attachment_id": 23539}, {"count": 3, "tags": [], "text": "Created attachment 23540\nscreenshot from Excel 2007 - row3 is resized correctly", "attachment_id": 23540, "id": 126500, "creator": "yegor@dinom.ru", "time": "2009-04-24T11:57:16Z", "bug_id": 47082, "creation_time": "2009-04-24T11:57:16Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 47082, "attachment_id": null, "text": "Works fine to me. See attached output and a screenshot. \n\nTry the latest trunk. Daily builds can be downloaded from http://encore.torchbox.com/poi-svn-build/\n\nYegor", "id": 126501, "time": "2009-04-24T11:58:42Z", "creator": "yegor@dinom.ru", "creation_time": "2009-04-24T11:58:42Z", "is_private": false}, {"count": 5, "tags": [], "creator": "muhammed.k@gmail.com", "attachment_id": null, "is_private": false, "id": 126511, "time": "2009-04-24T20:11:57Z", "bug_id": 47082, "creation_time": "2009-04-24T20:11:57Z", "text": "I have tried with poi-3.5-beta6-20090424.jar and still able to reproduce the issue.\nMay I know which version of java you are using. I tried with java 1.5.\n\njava version \"1.5.0_16\"\nJava(TM) 2 Runtime Environment, Standard Edition (build 1.5.0_16-b02)\nJava HotSpot(TM) Client VM (build 1.5.0_16-b02, mixed mode, sharing)\n\nMuhammed"}, {"count": 6, "tags": [], "text": "Looks like working fine with java 1.6.\n\njava version \"1.6.0_04\"\nJava(TM) SE Runtime Environment (build 1.6.0_04-b12)\nJava HotSpot(TM) Client VM (build 10.0-b19, mixed mode, sharing)\n\nAny chance to get a fix for POI 3.2, where we are using it with java 1.4.2\n\nThanks\nMuhammed", "attachment_id": null, "bug_id": 47082, "id": 126512, "time": "2009-04-24T20:18:58Z", "creator": "muhammed.k@gmail.com", "creation_time": "2009-04-24T20:18:58Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 47082, "attachment_id": null, "id": 126514, "time": "2009-04-24T22:45:16Z", "creator": "yegor@dinom.ru", "creation_time": "2009-04-24T22:45:16Z", "is_private": false, "text": "(In reply to comment #6)\n> Looks like working fine with java 1.6.\n> \n> java version \"1.6.0_04\"\n> Java(TM) SE Runtime Environment (build 1.6.0_04-b12)\n> Java HotSpot(TM) Client VM (build 10.0-b19, mixed mode, sharing)\n> \n> Any chance to get a fix for POI 3.2, where we are using it with java 1.4.2\n> \n> Thanks\n> Muhammed\n\n(In reply to comment #6)\n> Looks like working fine with java 1.6.\n> \n> java version \"1.6.0_04\"\n> Java(TM) SE Runtime Environment (build 1.6.0_04-b12)\n> Java HotSpot(TM) Client VM (build 10.0-b19, mixed mode, sharing)\n> \n> Any chance to get a fix for POI 3.2, where we are using it with java 1.4.2\n> \n> Thanks\n> Muhammed\n\nIt might be a jdkspecific bug,  your  code works with java 1.5.13 and java 1.6.13. Try a different version of Java. I don't think there will be a special fix for JDK 1.5.0_16.\n\nYegor"}, {"count": 8, "tags": [], "bug_id": 47082, "text": "I have a workaround for this. If I replace all whitespaces with some character(say \u2018I\u2019 \u2013 the one which take least width), autoSize seems to be working fine. \n\nFor those who uses jdk 1.4 & 1.5, is it possible to provide a patch like this?\n\nSee the line below -  txt = txt.replaceAll(\" \", \"i\");\n\n    public void autoSizeColumn(short column, boolean useMergedCells) {\n        AttributedString str;\n        TextLayout layout;\n        /**\n         * Excel measures columns in units of 1/256th of a character width\n         * but the docs say nothing about what particular character is used.\n         * '0' looks to be a good choice.\n         */\n        char defaultChar = '0';\n       \n        /**\n         * This is the multiple that the font height is scaled by when determining the\n         * boundary of rotated text.\n         */\n        double fontHeightMultiple = 2.0;\n       \n        FontRenderContext frc = new FontRenderContext(null, true, true);\n\n        HSSFWorkbook wb = new HSSFWorkbook(book);\n        HSSFFont defaultFont = wb.getFontAt((short) 0);\n\n        str = new AttributedString(\"\" + defaultChar);\n        copyAttributes(defaultFont, str, 0, 1);\n        layout = new TextLayout(str.getIterator(), frc);\n        int defaultCharWidth = (int)layout.getAdvance();\n\n        double width = -1;\n        rows:\n        for (Iterator it = rowIterator(); it.hasNext();) {\n            HSSFRow row = (HSSFRow) it.next();\n            HSSFCell cell = row.getCell(column);\n\n            if (cell == null) {\n                continue;\n            }\n            int colspan = 1;\n            for (int i = 0 ; i < getNumMergedRegions(); i++) {\n                CellRangeAddress region = getMergedRegion(i);\n                if (containsCell(region, row.getRowNum(), column)) {\n                                                                                                    if (!useMergedCells) {\n                                                                                                                        // If we're not using merged cells, skip this one and move on to the next. \n                        continue rows;\n                    }\n                                                                                cell = row.getCell(region.getFirstColumn());\n                    colspan = 1 + region.getLastColumn() - region.getFirstColumn();\n                                                                                \n                }\n            }\n\n            HSSFCellStyle style = cell.getCellStyle();\n            HSSFFont font = wb.getFontAt(style.getFontIndex());\n\n            if (cell.getCellType() == HSSFCell.CELL_TYPE_STRING) {\n                HSSFRichTextString rt = cell.getRichStringCellValue();\n                String[] lines = rt.getString().split(\"\\\\n\");\n                for (int i = 0; i < lines.length; i++) {\n                    String txt = lines[i] + defaultChar;\n                txt = txt.replaceAll(\" \", \"i\");\n                    ...\n                    ...", "id": 126599, "time": "2009-04-28T22:39:24Z", "creator": "muhammed.k@gmail.com", "creation_time": "2009-04-28T22:39:24Z", "is_private": false, "attachment_id": null}, {"count": 9, "attachment_id": null, "bug_id": 47082, "text": "I'm closing it as \"wontfix\". \nThe issue with leading white spaces is JDK-specific. Users of JDK 1.5.0_16 are advised to upgrade to a newer version. \n\nYegor", "id": 127324, "time": "2009-05-23T01:33:51Z", "creator": "yegor@dinom.ru", "creation_time": "2009-05-23T01:33:51Z", "tags": [], "is_private": false}]