[{"count": 0, "attachment_id": null, "bug_id": 56084, "text": "With the following configuration: \nApache <VirtualHost *:80>...\n        <Files wp-login.php>\n                Order Deny,Allow\n                Deny from all\n        </Files>\n</VirtualHost>\n\nThe following file is not accessible:\nhttp://127.0.0.1/wp-login.php\nAs a forbidden error message by Apache is returned.\n\nIf a user or attacker accesses the following URL, the access controls by Apache are completely ignored:\nhttp://127.0.0.1/fcgi-php-fpm/wp-login.php\nIn the above case, wp-login.php is executed by PHP and a login screen is shown.\n\n-----\nIn another scenario where directory-wide permissions are set to disable access, the following configuration is used:\n<VirtualHost *:80>\n        <Directory /var/www/>\n          <Files *.php>\n              SetHandler fcgi-php-fpm\n          </Files>\n                Order Deny,Allow\n                Deny from all\n        </Directory>               \n</VirtualHost>\nThis configuration denies access to anyone trying to access the web server's document root.\n\nThe following URL:\nhttp://127.0.0.1/somefile.php\nReturns a forbidden error message by Apache.\n\nHowever, the following URL renders:\nhttp://127.0.0.1/fcgi-php-fpm/somefile.php\n\nThis all seem very strange, despite that PHP-FPM and Apache are 2 separate packages, services, applications, etc.\n\n\nPlease note the following configuration within Apache:\nconf.d/php5-fpm:Action fcgi-php-fpm /fcgi-php-fpm virtual\nconf.d/php5-fpm:Alias /fcgi-php-fpm /fcgi-php-fpm\nconf.d/php5-fpm:FastCgiExternalServer /fcgi-php-fpm -socket /var/run/php5-fpm.sock -pass-header Authorization\nsites-available/default:              SetHandler fcgi-php-fpm\nsites-enabled/000-default:            SetHandler fcgi-php-fpm\n\n\nIs it somehow possible to disable direct access to the Alias /fcgi-php-fpm ?\n\n\nNote: This has been reported to PHP as well as it's unclear whether the bug is in Apache or PHP, despite that it looks like it's most likely an Apache bug.\n\n\nThe main problem is that you can bypass the access controls in place by Apache by prepending the Alias \"/fcgi-php-fpm/\" to a PHP file.", "id": 172775, "time": "2014-01-29T01:04:30Z", "creator": "hansv@senseofsecurity.com.au", "creation_time": "2014-01-29T01:04:30Z", "tags": [], "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 56084, "text": "Every request to /fcgi-php-fpm is mapped to something that doesn't exist on disk (by the Alias directive), so no <Directory> or <Files> configuration is applicable.\n\nIn other words, httpd is not mapping any of those PHP files to disk.  So from its perspective, there is no access control.\n\nThe fcgi script executes whatever you pass it (as PATH_INFO?), but most of the limiting in httpd that would limit URLs or PATH_INFO will apply the same to the original request as it does when mod_actions internally redirects it.\n\nCan you log %{SCRIPT_FILENAME}e, %{PATH_TRANSLATED}e, and %{PATH_INFO}e for both cases?\n\nappend to httpd.conf:\n\n  CustomLog logs/pr56084.log \"%h %l %u %t \\\"%r\\\" %>s %b SF=%{SCRIPT_FILENAME}e PT=%{PATH_TRANSLATED}e PI=%{PATH_INFO}e\"\n\nUnfortunately even if these differ, they are not set until the handler is already running, so it would not be useful for core apache directives to act on.  But it might be useful for mod_fastcgi or php-fpm.", "id": 172779, "time": "2014-01-29T02:01:01Z", "creator": "covener@gmail.com", "creation_time": "2014-01-29T02:01:01Z", "tags": [], "is_private": false}, {"count": 2, "attachment_id": null, "bug_id": 56084, "text": "Hi Eric, thanks for the quick response.\n\nHere's the information you requested.\n\n\nLog entries when accessing the website in its default state: (i.e. like a normal user)\nroot@SC01:/etc/apache2/sites-available# tail -f /var/log/apache2/pr56084.log\n59.167.247.251 - - [29/Jan/2014:13:38:09 +1100] \"GET /sos/ HTTP/1.1\" 200 5820 SF=/fcgi-php-fpm PT=/var/www/sos/index.php PI=/sos/index.php\n59.167.247.251 - - [29/Jan/2014:13:38:10 +1100] \"GET /sos/?mcsf_action=main_css HTTP/1.1\" 200 355 SF=/fcgi-php-fpm PT=/var/www/sos/index.php PI=/sos/index.php\n59.167.247.251 - - [29/Jan/2014:13:38:27 +1100] \"GET /sos/about-us/ HTTP/1.1\" 200 3968 SF=/fcgi-php-fpm PT=/var/www/sos/index.php PI=/sos/index.php\n59.167.247.251 - - [29/Jan/2014:13:38:27 +1100] \"GET /sos/?mcsf_action=main_css HTTP/1.1\" 200 355 SF=/fcgi-php-fpm PT=/var/www/sos/index.php PI=/sos/index.php\n59.167.247.251 - - [29/Jan/2014:13:38:29 +1100] \"GET /sos/contact-details/ HTTP/1.1\" 200 5149 SF=/fcgi-php-fpm PT=/var/www/sos/index.php PI=/sos/index.php\n59.167.247.251 - - [29/Jan/2014:13:38:29 +1100] \"GET /sos/?mcsf_action=main_css HTTP/1.1\" 200 355 SF=/fcgi-php-fpm PT=/var/www/sos/index.php PI=/sos/index.php\n59.167.247.251 - - [29/Jan/2014:13:38:30 +1100] \"GET /sos/sitecontnt/themes/sos/i/formbg.jpg HTTP/1.1\" 404 3751 SF=/fcgi-php-fpm PT=/var/www/sos/index.php PI=/sos/index.php\n-----------------------------------------------------------------------\n\nLog entries when prepending the \"fcgi-php-fpm\" alias string to requests:\nroot@SC01:/etc/apache2/sites-available# tail -f /var/log/apache2/pr56084.log\n59.167.247.251 - - [29/Jan/2014:13:40:04 +1100] \"GET /fcgi-php-fpm/sos/ HTTP/1.1\" 404 3550 SF=/fcgi-php-fpm PT=/var/www/sos/index.php PI=/sos/\n59.167.247.251 - - [29/Jan/2014:13:40:05 +1100] \"GET /sos/?mcsf_action=main_css HTTP/1.1\" 200 355 SF=/fcgi-php-fpm PT=/var/www/sos/index.php PI=/sos/index.php\n59.167.247.251 - - [29/Jan/2014:13:40:10 +1100] \"GET /fcgi-php-fpm/sos/index.php HTTP/1.1\" 301 25 SF=/fcgi-php-fpm PT=/var/www/sos/index.php PI=/sos/index.php\n59.167.247.251 - - [29/Jan/2014:13:40:10 +1100] \"GET /fcgi-php-fpm/sos/ HTTP/1.1\" 404 3550 SF=/fcgi-php-fpm PT=/var/www/sos/index.php PI=/sos/\n59.167.247.251 - - [29/Jan/2014:13:40:10 +1100] \"GET /sos/?mcsf_action=main_css HTTP/1.1\" 200 355 SF=/fcgi-php-fpm PT=/var/www/sos/index.php PI=/sos/index.php\n59.167.247.251 - - [29/Jan/2014:13:40:13 +1100] \"GET /fcgi-php-fpm/sos/wp-login.php HTTP/1.1\" 200 1451 SF=/fcgi-php-fpm PT=/var/www/sos/wp-login.php PI=/sos/wp-login.php\n59.167.247.251 - - [29/Jan/2014:13:40:13 +1100] \"GET /sos/?mcsf_action=main_css HTTP/1.1\" 200 355 SF=/fcgi-php-fpm PT=/var/www/sos/index.php PI=/sos/index.php\n59.167.247.251 - - [29/Jan/2014:13:40:35 +1100] \"GET /fcgi-php-fpm/sos/wp-admin/ HTTP/1.1\" 302 25 SF=/fcgi-php-fpm PT=/var/www/sos/wp-admin/index.php PI=/sos/wp-admin/\n-----------------------------------------------------------------------", "id": 172780, "time": "2014-01-29T02:43:11Z", "creator": "hansv@senseofsecurity.com.au", "creation_time": "2014-01-29T02:43:11Z", "tags": [], "is_private": false}, {"count": 3, "attachment_id": null, "bug_id": 56084, "text": "It's an Apache misconfiguration that's not pointed out very clearly.\n\nThe following is the fix:\n        <Location /fcgi-php-fpm>\n            # here we prevent direct access to this Location url,\n            # env=REDIRECT_STATUS will let us use this fcgi-bin url\n            # only after an internal redirect (by Action upper)\n            Order Deny,Allow\n            Deny from all\n            Allow from env=REDIRECT_STATUS\n        </Location>\n\nIt would be useful to point this out somewhere.\n\nThe above restricts direct access, but not internal access via PHP-FPM sockets.", "id": 172781, "time": "2014-01-29T04:31:41Z", "creator": "hansv@senseofsecurity.com.au", "creation_time": "2014-01-29T04:31:41Z", "tags": [], "is_private": false}, {"count": 4, "attachment_id": null, "bug_id": 56084, "text": "You can also use rewrite rules to restrict access (eg.. to directories based on IP) to the proxied fastcgi service: \n\nRewriteEngine On\nRewriteCond %{REQUEST_URI} ^[^\\/]*/login/.*$ [NC]\nRewriteCond %{REMOTE_HOST} !^(?:127\\.0\\.0\\.1)|(?:1\\.2\\.3\\.4)$\nRewriteRule ^.*$   -   [NC,F]\n\nPlease note that these rules are context sensitive, relative to any proxy directives", "id": 172789, "time": "2014-01-29T13:16:58Z", "creator": "trizk@inficron.com", "creation_time": "2014-01-29T13:16:58Z", "tags": [], "is_private": false}]