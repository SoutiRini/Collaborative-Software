[{"count": 0, "attachment_id": null, "bug_id": 54474, "text": "RFC 2817 section 5.3 Establishing a Tunnel with CONNECT says:\n\"If at any point either one of the peers gets disconnected, any\noutstanding data that came from that peer will be passed to the other\none, and after that also the other connection will be terminated by\nthe proxy.\"\nWhich is not what apache 2.4 does.\n\nAfter upgrade from apache 2.2.23 to 2.4.3 I've encountered problem loading page without Content-Length from HTTPS backend thru proxy.\nBackend server sends webpage and closes connection just fine. Proxy keeps connection to client open and eventually closes it after few seconds with message \"AH01382: Request header read timeout\".\n\nStrange thing is that all requests were fine in 2.2.23 and requests with defined Content-Length are fine in 2.4.3 too.\n\nI was able to make naive workaround which is probably completelly wrong:\n\n--- httpd-2.4.3/modules/proxy/mod_proxy_connect.c  2012-07-28 16:40:23.000000000 +0200\n+++ httpd-2.4.3-fixed/modules/proxy/mod_proxy_connect.c   2013-01-23 14:38:10.000000000 +0100\n@@ -481,6 +481,8 @@\n      * Close the socket and clean up\n      */\n \n+    apr_socket_close(client_socket);\n+\n     if (client_error)\n         apr_socket_close(sock);\n     else", "id": 164828, "time": "2013-01-23T14:01:08Z", "creator": "pavel@verotel.cz", "creation_time": "2013-01-23T14:01:08Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "text": "Oh, to make it more weird:\nThe problem was seen with wget. LWP was able to fetch the page without waiting to timeout.", "attachment_id": null, "id": 164829, "creator": "pavel@verotel.cz", "time": "2013-01-23T14:03:36Z", "bug_id": 54474, "creation_time": "2013-01-23T14:03:36Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 54474, "attachment_id": null, "id": 164830, "time": "2013-01-23T15:39:57Z", "creator": "covener@gmail.com", "creation_time": "2013-01-23T15:39:57Z", "is_private": false, "text": "(In reply to comment #1)\n> Oh, to make it more weird:\n> The problem was seen with wget. LWP was able to fetch the page without\n> waiting to timeout.\n\nmaybe one sends asks for connection-close or http/1.0 and not the other?"}, {"count": 3, "tags": [], "bug_id": 54474, "is_private": false, "text": "debug (In reply to comment #2)\n> (In reply to comment #1)\n> > Oh, to make it more weird:\n> > The problem was seen with wget. LWP was able to fetch the page without\n> > waiting to timeout.\n> \n> maybe one sends asks for connection-close or http/1.0 and not the other?\n\nChecked. LWP sends just GET, not CONNECT.\n\nBut it doesn't matter really. Apache 2.2 was able to close the client connection when backend closed it's side.\nDo you know where exactly is the code supposed to do it?\n\nAnd I realized this are two bugs in one report.\n1) open connection.\n2) CONNECT is guarded by RequestReadTimeout from mod_reqtimeout instead of general Timeout.", "id": 164907, "time": "2013-01-28T12:36:17Z", "creator": "pavel@verotel.cz", "creation_time": "2013-01-28T12:36:17Z", "attachment_id": null}, {"count": 4, "tags": [], "text": "Created attachment 29917\nDisable Keep-alive for CONNECT\n\nRFC2817\n5.3 Establishing a Tunnel with CONNECT\n...\nIf at any point either one of the peers gets disconnected, any\noutstanding data that came from that peer will be passed to the other\none, and after that also the other connection will be terminated by\nthe proxy. If there is outstanding data to that peer undelivered,\nthat data will be discarded.\n\nThis means we can't keep connection alive after CONNECT method.", "attachment_id": 29917, "id": 165048, "creator": "pavel@verotel.cz", "time": "2013-02-04T12:50:00Z", "bug_id": 54474, "creation_time": "2013-02-04T12:50:00Z", "is_private": false}, {"count": 5, "tags": [], "text": "mod_proxy_connect has significant changes compared to 2.2, to make it work through https. So it's not really surprising that it behaves differently than in 2.2. \n\nThanks for the debugging.\ncommitted to trunk: r1442320\nproposed for 2.4", "attachment_id": null, "id": 165058, "creator": "sf@sfritsch.de", "time": "2013-02-04T20:05:27Z", "bug_id": 54474, "creation_time": "2013-02-04T20:05:27Z", "is_private": false}, {"count": 6, "tags": [], "text": "fixed in 2.4.4", "is_private": false, "id": 165608, "creator": "sf@sfritsch.de", "time": "2013-03-03T16:48:13Z", "bug_id": 54474, "creation_time": "2013-03-03T16:48:13Z", "attachment_id": null}]