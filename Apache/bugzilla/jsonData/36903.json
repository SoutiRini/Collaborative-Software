[{"count": 0, "tags": [], "bug_id": 36903, "is_private": false, "text": "In attempting to upgrade our build process to ANT 1.6.5 from ANT 1.6.2, we have \nencountered various hangs in java or other forked processes during our build \nprocess.\nIt appears to be a serious regression in the ANT Java Task.\n\nWe observed this behavior with ANT 1.6.{3,4,5} -- this bug is present in all \nthree latest versions.\nEverything worked perfectly with ANT 1.6.2.\n\nSeems Bug fix 24918 has caused this regression.\nCompared the sources of ANT 1.6.2 and 1.6.5 for Java Task;\nthe only notable change was this fix for 24918.\n\nBy just commenting these lines out and recompiling this 1 file, the hanging \nproblems go away, and everything works on ANT 1.6.5.\n\napache-ant-1.6.5\\src\\main\\org\\apache\\tools\\ant\\taskdefs\\Java.java\n\n    /**\n     * Set up properties on the redirector that we needed to store locally.\n     */\n    protected void setupRedirector() {\n        redirector.setInput(input);\n        redirector.setInputString(inputString);\n        redirector.setOutput(output);\n        redirector.setError(error);\n        if (redirectorElement != null) {\n            redirectorElement.configure(redirector);\n        }\n        // if (!spawn && input == null && inputString == null) {\n        //    #24918: send standard input to the process by default.\n        //    redirector.setInputStream(new KeepAliveInputStream(getProject\n().getDefaultInputStream()));\n        // }\n    }\n \nWe need this fix before we can upgrade our ANT version to the latest release :-(\n\nWe observed that sometimes adding fork=\"yes\" to Java Task works around the \nproblem, but at other points removing fork=\"yes\" works around the problem, so \nhave not been able to establish a consistent pattern for how to work around \nthis.\nWe also observed that having fork=\"yes\" option when running a java task, can \nsometimes cause other unrelated processes later on to hang, even though the \njava process itself successfully terminates (or so it seemed).\n\nWe have fairly complicated build scripts that invoke numerous java and non-java \nprocesses;\nI have not yet been able to isolate a simple reproducible case.\nWe also do our builds using Cruise Control \n(http://cruisecontrol.sourceforge.net) and first observed it there.\nThough, it has nothing to do with Cruise Control, as I can reproduce the \nproblems easily by invoking the same ANT targets directly from bash command \nline.", "id": 80730, "time": "2005-10-04T05:49:03Z", "creator": "nomorogbe@idiominc.com", "creation_time": "2005-10-04T05:49:03Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 36903, "attachment_id": null, "text": "Could it be that a process started by ant waits for standard input?\nDoes adding a redirector with an empty inputstring help?", "id": 80756, "time": "2005-10-04T20:44:46Z", "creator": "jkf@apache.org", "creation_time": "2005-10-04T20:44:46Z", "is_private": false}, {"count": 2, "tags": [], "text": "(In reply to comment #1)\n> Could it be that a process started by ant waits for standard input?\n> Does adding a redirector with an empty inputstring help?\n\nWe use a fully automated build process, so am not aware of our processes \nwaiting for standard input, but we use some third party tools which am not sure \nabout.\n\nYes, adding inputstring=\"\" to java task makes processes downstream stop \nhanging, but why should this impact other processes?\nRemoving fork=\"yes\" from the java process has the same effect sometimes.\nBut these are just workarounds.\n\nNarrowed down the hangs in our build process to two scenarios.\nOne involves third party application (tomcat), the other does not.\nAm attaching a standalone test-case for the first scenario.\nWill attach the second scenario later; have not been able to make a\nreproducible standalone test-case for the other one yet.\n\nHave put together a standalone test case that hangs on ANT 1.6.{3,4,5}, but \nworks on ANT 1.6.2.\n\nNOTE:\n\n1. have observed that this test case hangs if ant is invoked via cygwin (bash) \nshell or a parent java process like Cruise Control\n(http://cruisecontrol.sourceforge.net).\nIt works as is if run in DOS Shell.\n\n2. test-case works in bash if you remove fork=\"yes\" from the ListProperties \njava task\n\n3. test-case works in bash if you add inputstring=\"\" to the ListProperties java \ntask\n\nStrange that making these changes to java task will affect completely unrelated \nprocesses downstream.\n\n4. test-case works as is in bash or Cruise Control on ANT 1.6.2\n\nSTEPS:\n\n1. Compile this java file into classes folder\n\nListProperties.java\n-------------------\n\npublic class ListProperties {\n\n\tpublic static void main(String[] ignore) {\n\t\tSystem.getProperties().list(System.out);\n\t}\n}\n\n2. Use this ANT file:\n\ntest.xml\n--------\n\n<project name=\"tests\" default=\"test\" basedir=\".\">\n  <description>\n    Tests build file\n  </description>\n\n  <property environment=\"system\"/>\n\n  <property name=\"classes\" location=\"classes\"/>\n\n  <!-- classpath -->\n  <path id=\"class.path\">\n    <pathelement location=\"${classes}\"/>\n  </path>\n\n  <target name=\"setup\">\n    <java classname=\"ListProperties\"\n          classpathref=\"class.path\"\n          failonerror=\"true\"\n          fork=\"yes\"\n          dir=\"${basedir}\"/>\n  </target>\n\n  <target name=\"test\" depends=\"setup\">\n\n    <exec executable=\"${system.CATALINA_HOME}/bin/shutdown.bat\">\n    </exec>\n\n    <parallel>\n\n      <exec executable=\"${system.CATALINA_HOME}/bin/startup.bat\">\n      </exec>\n\n      <sequential>\n        <echo message=\"Waiting for http://localhost:8080/tomcat-\ndocs/index.html\"/>\n\n        <waitfor maxwait=\"3\" maxwaitunit=\"minute\" checkevery=\"3000\"\n                 timeoutproperty=\"web.page.not.available\">\n          <http url=\"http://localhost:8080/tomcat-docs/index.html\"/>\n        </waitfor>\n\n        <exec executable=\"${system.CATALINA_HOME}/bin/shutdown.bat\">\n        </exec>\n\n      </sequential>\n\n    </parallel>\n\n  </target>\n\n</project>\n\n3. Download and unzip jakarta-tomcat-5.0.28\n\n   http://mirrors.ccs.neu.edu/Apache/dist/jakarta/tomcat-5/v5.0.28/bin/jakarta-\ntomcat-5.0.28.zip\n\n4. Configure bash environment; example:\n\nbash> export CATALINA_HOME=d:\\\\jakarta-tomcat-5.0.28\n\n5. Run like this passing in your classes path:\n\nbash> ant -f test.xml -Dclasses=classes\n\n(Ignore exception thrown trying to stop tomcat since it is not running yet)\n\nAnt process will hang.\nLet it run for more than 5 minutes, exceeding the wait timeout; it is hanging \nsomewhere.\n\nAlso, open a web browser and paste in the http url. Web page opens up and is \navailable.\n\n", "is_private": false, "id": 80844, "creator": "nomorogbe@idiominc.com", "time": "2005-10-06T16:01:34Z", "bug_id": 36903, "creation_time": "2005-10-06T16:01:34Z", "attachment_id": null}, {"count": 3, "tags": [], "text": "1. Is this Unix or Windows? The bugrep says Win2K, but the details says bash\nwhich implies unix.\n\n2. On the javacommand, add the attribute inputstring=\"\"\n Does this make the problem go away?\n\nIf you are using unix, and (2) works, then this is a duplicate of an existing\nproblem that we are aware of..if it is windows then it may be a new version of\nthe  same problem.\n\n", "is_private": false, "id": 80944, "creator": "stevel@apache.org", "time": "2005-10-10T11:31:01Z", "bug_id": 36903, "creation_time": "2005-10-10T11:31:01Z", "attachment_id": null}, {"count": 4, "tags": [], "text": "(I read \"bash\" as \"cygwin\", but that could just be my personal bias.)", "is_private": false, "id": 80955, "creator": "mbenson@apache.org", "time": "2005-10-10T16:13:10Z", "bug_id": 36903, "creation_time": "2005-10-10T16:13:10Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 36903, "is_private": false, "text": "(In reply to comment #3)\n> 1. Is this Unix or Windows? The bugrep says Win2K, but the details says bash\n> which implies unix.\n> 2. On the javacommand, add the attribute inputstring=\"\"\n>  Does this make the problem go away?\n> If you are using unix, and (2) works, then this is a duplicate of an existing\n> problem that we are aware of..if it is windows then it may be a new version of\n> the  same problem.\n\nThis is Windows; am running Cygwin on Windows.\nIt sounds like same bug, but on Windows.\nIt also happens on Windows when ANT is invoked by a parent process like Cruise \nControl.\nAdding inputstring=\"\" makes problem go away.\nPlease, see my \"NOTE\" in previous comment.", "id": 80995, "time": "2005-10-11T15:38:22Z", "creator": "nomorogbe@idiominc.com", "creation_time": "2005-10-11T15:38:22Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 36903, "attachment_id": null, "text": "I am able to reproduce the problem with Java 5/Java 6 and Ant 1.7.0 under Windows2000 and WindowsXP (but not under Ubuntu 7.04).\n\nThe test script will hang (i.e. wait for input) when it entered the run target in sample\\build.xml. It will not hang if you add inputstring=\"\" in line 69 in this script.\n\nProcess Explorer indicates that one thread in the hanging java process is trying to establish a socket connection.\n\nAttaching a java monitoring tool to the ant process will prevent the script from hanging.\n\nUnfortunately the sample's size exceeds the file limit here, so I will provide it on request by e-mail.", "id": 114173, "time": "2008-03-02T10:09:34Z", "creator": "fs5@gmx.net", "creation_time": "2008-03-02T10:09:34Z", "is_private": false}, {"count": 7, "tags": [], "text": "\n\n*** This bug has been marked as a duplicate of bug 34461 ***", "is_private": false, "id": 120019, "creator": "bodewig@apache.org", "time": "2008-08-22T04:42:37Z", "bug_id": 36903, "creation_time": "2008-08-22T04:42:37Z", "attachment_id": null}]