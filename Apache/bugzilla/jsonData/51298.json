[{"count": 0, "tags": [], "bug_id": 51298, "attachment_id": null, "id": 146754, "time": "2011-05-31T07:25:12Z", "creator": "amosleaf@gmail.com", "creation_time": "2011-05-31T07:25:12Z", "is_private": false, "text": "Environment:\nOS:windows2008, JDK:1.6 Tomcat:6.0.28\n\nHow to reproduce it:\n(1)We have a server running in tomcat.\n(2)We have a servlet to write file into HttpServletResponse, key code is like this:\n\nOutputStream output = resp.getOutputStream(); //get response outputstream\n... ...\noutput.write(b, 0, len); // write some file into it, client will receive it\n\n(3)Use LoadRunner(Stress testing tool) simulate 300 concurrent HttpRequest, when server received these requests, should write 10M's file content into the response.\nBut, not all request can successfully, some of it disconnected when write file into response.\n\nI use log4j record exception like this:\n\nClientAbortException:  java.net.SocketException: Connection reset by peer: socket write error\n\tat org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:358)\n\tat org.apache.tomcat.util.buf.ByteChunk.append(ByteChunk.java:323)\n\tat org.apache.catalina.connector.OutputBuffer.writeBytes(OutputBuffer.java:381)\n\tat org.apache.catalina.connector.OutputBuffer.write(OutputBuffer.java:370)\n\tat org.apache.catalina.connector.CoyoteOutputStream.write(CoyoteOutputStream.java:89)\n\tat com.dt.puppet.dp.view.PuppetDownloadView.render(PuppetDownloadView.java:92)\n\tat org.nutz.mvc.invoker.ActionInvokerImpl.invoke(ActionInvokerImpl.java:269)\n\tat org.nutz.mvc.ActionInvoking.invoke(ActionInvoking.java:37)\n\tat org.nutz.mvc.NutMvcContent.handle(NutMvcContent.java:81)\n\tat org.nutz.mvc.NutFilter.doFilter(NutFilter.java:57)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:298)\n\tat org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:857)\n\tat org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:588)\n\tat org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489)\n\tat java.lang.Thread.run(Unknown Source)\nCaused by: java.net.SocketException: Connection reset by peer: socket write error\n\tat java.net.SocketOutputStream.socketWrite0(Native Method)\n\tat java.net.SocketOutputStream.socketWrite(Unknown Source)\n\tat java.net.SocketOutputStream.write(Unknown Source)\n\tat org.apache.coyote.http11.InternalOutputBuffer.realWriteBytes(InternalOutputBuffer.java:741)\n\tat org.apache.tomcat.util.buf.ByteChunk.flushBuffer(ByteChunk.java:432)\n\tat org.apache.tomcat.util.buf.ByteChunk.append(ByteChunk.java:347)\n\tat org.apache.coyote.http11.InternalOutputBuffer$OutputStreamOutputBuffer.doWrite(InternalOutputBuffer.java:765)\n\tat org.apache.coyote.http11.filters.IdentityOutputFilter.doWrite(IdentityOutputFilter.java:127)\n\tat org.apache.coyote.http11.InternalOutputBuffer.doWrite(InternalOutputBuffer.java:574)\n\tat org.apache.coyote.Response.doWrite(Response.java:560)\n\tat org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:353)\n\t... 21 more\n\n\n(4) Here is the server.xml, you can see the parameter:\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<Server port=\"8005\" shutdown=\"SHUTDOWN\">\n<GlobalNamingResources>\n<Resource auth=\"Container\" description=\"User database that can be updated and saved\" factory=\"org.apache.catalina.users.MemoryUserDatabaseFactory\" name=\"UserDatabase\" pathname=\"conf/tomcat-users.xml\" type=\"org.apache.catalina.UserDatabase\"/>\n</GlobalNamingResources>\n<Service>\n<Connector URIEncoding=\"UTF-8\" acceptCount=\"1000\" connectionTimeout=\"30000\" disableUploadTimeout=\"true\" enableLookups=\"false\" maxHttpHeaderSize=\"8192\" maxPostSize=\"0\" maxSpareThreads=\"75\" maxThreads=\"1500\" minSpareThreads=\"25\" port=\"80\" protocol=\"HTTP/1.1\" redirectport=\"8443\"/>\n<Engine defaultHost=\"localhost\" name=\"Catalina\">\n<Realm className=\"org.apache.catalina.realm.UserDatabaseRealm\" resourceName=\"UserDatabase\"/>\n<Host appBase=\"webapps\" autoDeploy=\"false\" deployOnStartup=\"false\" name=\"localhost\" xmlNamespaceAware=\"false\" xmlValidation=\"false\">\n<Context cookies=\"false\" docBase=\"WDM\" path=\"/\" reload=\"false\"/>\n</Host>\n</Engine>\n</Service>\n</Server>\n\n\nWhen find this exception, I adjust the Tomcat Connector parameter, add these two parameter:\nmaxKeepAliveRequests=\"-1\"  keepAliveTimeout=\"\"(test many number)\nBut still have this problem.\n\n\nSo, Please tell me what I should do to avoid the exception when write something to response."}, {"count": 1, "tags": [], "creator": "markt@apache.org", "text": "The client is dropping the connection. This is not a Tomcat issue. The users list can help you diagnose this.", "id": 146755, "time": "2011-05-31T08:08:17Z", "bug_id": 51298, "creation_time": "2011-05-31T08:08:17Z", "is_private": false, "attachment_id": null}]