[{"count": 0, "tags": [], "creator": "andrew@cloudaccess.net", "text": "Created attachment 26073\nPatch that kind-of fixes this issue\n\nHello,\n\nI've noticed that after adding 10 000 vhosts or more, Apache is taking abnormally long time to restart. I've ran oprofile when restart was running and here is where it spent 94% of its time:\n\nhttp://gdr.pastebin.pl/28191\n\nIt was looking for the last non-null element of a leaf list in directive tree. \n\nPlease note that I know that the patch I'm proposing probably isn't applicable to mainline source, it's more that I want to indicate that there is a problem. Anyway, patch description follows:\n\nBecause changing the tree structure to some else would break compatibility with modules, I've decided to address it by extending ap_directive_t with an extra field, \"last\".\n\nIn the first leaf on a given level, leaf->last keeps a pointer to last known non-null element. It may not be the last non-null element in that list, but it's still closer to the end than first element.\n\nIt decreased restart time from minutes to several seconds (6 secs for 30k vhosts).\n\nIf you would rather browse source than read patch, it's at http://github.com/gjedeer/httpd", "id": 140163, "time": "2010-09-25T05:04:10Z", "bug_id": 50002, "creation_time": "2010-09-25T05:04:10Z", "is_private": false, "attachment_id": 26073}, {"count": 1, "tags": [], "creator": "nick@webthing.com", "text": "You haven't actually described a bug.  Please reopen with details if you want to describe something different from 41887.\n\n*** This bug has been marked as a duplicate of bug 41887 ***", "id": 140164, "time": "2010-09-25T05:25:15Z", "bug_id": 50002, "creation_time": "2010-09-25T05:25:15Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 50002, "attachment_id": null, "text": "This is not the same bug.\n\nWhat slows things down here can be described as following:\n\nApache restarts. It kills all the subprocesses and re-reads configs. Re-reading configs (stored on a local, very fast disk) takes little I/O and 100% CPU. For 30k vhosts, it takes from 3 to 5 minutes before this phase finishes. During that time, server is inaccessible.\n\nThis happens because of inefficient processing of lots of <VirtualHost> directives and my patch addresses that as described previously.\n\nBug 41887 is about lowering I/O by avoiding stat calls. This bug is about avoiding unnecessarily high CPU usage and lowering config reading time.\n\nHOW TO REPRODUCE:\n\nGenerate a config file with 30 000 entries similar to this one:\nhttp://gdr.pastebin.pl/28193\nThey may all point to the same directory, it doesn't matter for this test. Restart httpd, measure time when sites are inaccessible (several minutes). Observe CPU usage (100% usage of 1 CPU core).\n\nApply patch, test again. The server is up in seconds.", "id": 140167, "time": "2010-09-25T05:58:23Z", "creator": "andrew@cloudaccess.net", "creation_time": "2010-09-25T05:58:23Z", "is_private": false}, {"count": 3, "text": "(In reply to comment #2)\n\n> Apply patch, test again. The server is up in seconds.\n\nAnd what happens when you apply the pr41887 patch?", "bug_id": 50002, "is_private": false, "id": 140168, "time": "2010-09-25T06:55:16Z", "creator": "nick@webthing.com", "creation_time": "2010-09-25T06:55:16Z", "tags": [], "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 50002, "is_private": false, "id": 140179, "attachment_id": null, "creator": "andrew@cloudaccess.net", "creation_time": "2010-09-26T07:36:20Z", "time": "2010-09-26T07:36:20Z", "text": "(In reply to comment #3)\n\nWith patch 41887 and -T:\nhttp://gdr.pastebin.pl/28236\n\nWith patch 50002:\nhttp://gdr.pastebin.pl/28237\n\nUnpatched httpd:\nhttp://gdr.pastebin.pl/28238\n\nPlease note that it's an idle test server, on production machines it really takes minutes but for obvious reasons I won't do measurements there."}, {"count": 5, "tags": [], "bug_id": 50002, "attachment_id": null, "text": "We're using server with this patch for 2 days now on a production server with 29342 vhosts and I can see no side effects. Also, the restart time went down from 2:31 to 0:09. I'll be installing it on our other servers because everything seems work well.", "id": 140337, "time": "2010-09-30T16:29:22Z", "creator": "andrew@cloudaccess.net", "creation_time": "2010-09-30T16:29:22Z", "is_private": false}, {"count": 6, "tags": [], "creator": "sf@sfritsch.de", "text": "Thanks for the patch. Commited in r1003808\n\nThough it would really make sense to use some mass virtual hosting module for this number of vhosts", "id": 140386, "time": "2010-10-02T11:02:17Z", "bug_id": 50002, "creation_time": "2010-10-02T11:02:17Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "creator": "andrew@cloudaccess.net", "is_private": false, "text": "(In reply to comment #6)\n> Thanks for the patch. Commited in r1003808\n> \n> Though it would really make sense to use some mass virtual hosting module for\n> this number of vhosts\n\nIt would, however sometimes it's just not applicable. I have researched this before diving into profiling the core.", "id": 140428, "time": "2010-10-04T05:46:37Z", "bug_id": 50002, "creation_time": "2010-10-04T05:46:37Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 50002, "attachment_id": null, "is_private": false, "id": 154244, "time": "2012-02-26T17:08:33Z", "creator": "sf@sfritsch.de", "creation_time": "2012-02-26T17:08:33Z", "text": "fixed in 2.4.1"}]