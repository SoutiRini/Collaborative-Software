[{"count": 0, "tags": [], "bug_id": 36751, "text": "We have a Apache server 2.0.54 running on Windows XP Pro.\n\n\nIn httpd.conf, we created a few mod_perl filters to render web pages.\nwe use all of the following:\nPerlResponseHandler \nPerlOutputFilterHandler \nPerlFixupHandler \n\nThe apache server does not have problem if we run the apache binary(msi/no-ssl) \nwithout SSL.\n\nThen, we decided to enable SSL.\nI downloaded the source code of Apache/2.0.54 and openssl/0.9.7g and compiled \nthem with Microsoft Visual Studio .NET 2003.\n\nApache can startup without any problem, however, while we try to load some web \npages, especially when load pages very frequently. The child process will crash \nand the browser stuck for a long time while the child respowns.\nIn error.log, i saw this:\nApache2::Filter: (620019) APR does not understand this error code at -e line 0\n[Tue Sep 20 18:35:18 2005] [notice] Parent: child process\ned with status 9 -- Restarting.\n\nThe problem does not happen all the time. It happens randomly after you try to \nload a few pages.\nIt seems that mod_perl call APR to translate some error code but unsucessful.\nThen apache killed itself afterwards(probably because of mod_perl).\n\n\nThe environment is:\nApache/2.0.54 (Win32) mod_ssl/2.0.54 OpenSSL/0.9.7g DAV/2 mod_perl/2.0.0 \nPerl/v5.8.6\n\nApache/2.0.54 and openssl/0.9.7g are compiled by Microsoft Visual Studio .NET \n2003.\n\nI also tried mod_perl 2.0.1 and openssl 0.9.8 but not helpful.", "id": 80243, "time": "2005-09-21T02:43:26Z", "creator": "shien.xie@hp.com", "creation_time": "2005-09-21T02:43:26Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 36751, "text": "If you think that mod_perl has killed the server then this is a mod_perl bug; see:\nhttp://perl.apache.org/docs/2.0/user/help/help.html#Reporting_Problems\n\nIf you think there is some mod_ssl issue in here then you need to demonstrate it\ne.g. by getting a backtrace from a crash.", "id": 80257, "time": "2005-09-21T10:19:13Z", "creator": "jorton@redhat.com", "creation_time": "2005-09-21T10:19:13Z", "is_private": false, "attachment_id": null}, {"count": 2, "attachment_id": 16505, "bug_id": 36751, "text": "Created attachment 16505\nLocal variables are in the file.", "id": 80403, "time": "2005-09-23T22:46:02Z", "creator": "shien.xie@hp.com", "creation_time": "2005-09-23T22:46:02Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 36751, "text": "\nHere is the backtrace info. (From MS Visual Studio .NET 2003)\n\neverytime when you load a page from browser,\n\nfunction \nstatic int ssl3_write_pending(SSL *s, int type, const unsigned char *buf,\n\t\t\t      unsigned int len)\nis called.\n\nThis is the call stack.\n\tssleay32.dll!ssl3_write_pending(ssl_st * s=0x06bd0ee8, int type=23, \nconst unsigned char * buf=0x06bbb26c, unsigned int len=4775)  Line 756\tC\n \tssleay32.dll!do_ssl3_write(ssl_st * s=0x06bd0ee8, int type=23, const \nunsigned char * buf=0x06bbb26c, unsigned int len=4775, int \ncreate_empty_fragment=0)  Line 713 + 0x15\tC\n \tssleay32.dll!ssl3_write_bytes(ssl_st * s=0x06bd0ee8, int type=23, const \nvoid * buf_=0x06bbb26c, int len=4775)  Line 542 + 0x1a\tC\n \tssleay32.dll!ssl3_write(ssl_st * s=0x06bd0ee8, const void * \nbuf=0x06bbb26c, int len=4775)  Line 1721 + 0x13\tC\n \tssleay32.dll!SSL_write(ssl_st * s=0x06bd0ee8, const void * \nbuf=0x06bbb26c, int num=4775)  Line 878 + 0x15\tC\n \tmod_ssl.so!ssl_filter_write(ap_filter_t * f=0x06b80538, const char * \ndata=0x06bbb26c, unsigned int len=4775)  Line 773 + 0x13\tC\n \tmod_ssl.so!ssl_io_filter_output(ap_filter_t * f=0x06b80538, \napr_bucket_brigade * bb=0x06bad4c0)  Line 1364 + 0x11\tC\n \tlibhttpd.dll!ap_pass_brigade(ap_filter_t * next=0x06b80538, \napr_bucket_brigade * bb=0x06bad4c0)  Line 512 + 0x10\tC\n \tlibhttpd.dll!chunk_filter(ap_filter_t * f=0x06bad630, \napr_bucket_brigade * b=0x06bad4c0)  Line 218 + 0x10\tC\n \tlibhttpd.dll!ap_pass_brigade(ap_filter_t * next=0x06bad630, \napr_bucket_brigade * bb=0x06bad4c0)  Line 512 + 0x10\tC\n \tlibhttpd.dll!ap_http_header_filter(ap_filter_t * f=0x06b8d558, \napr_bucket_brigade * b=0x06bad4c0)  Line 1692\tC\n \tlibhttpd.dll!ap_pass_brigade(ap_filter_t * next=0x06b8d558, \napr_bucket_brigade * bb=0x06bad4c0)  Line 512 + 0x10\tC\n \tlibhttpd.dll!ap_content_length_filter(ap_filter_t * f=0x06b8d540, \napr_bucket_brigade * b=0x06bad4c0)  Line 1233\tC\n \tlibhttpd.dll!ap_pass_brigade(ap_filter_t * next=0x06b8d540, \napr_bucket_brigade * bb=0x06bad4c0)  Line 512 + 0x10\tC\n \tlibhttpd.dll!ap_byterange_filter(ap_filter_t * f=0x06b8d528, \napr_bucket_brigade * bb=0x06bad4c0)  Line 2876 + 0x10\tC\n \tlibhttpd.dll!ap_pass_brigade(ap_filter_t * next=0x06b8d528, \napr_bucket_brigade * bb=0x06bad4c0)  Line 512 + 0x10\tC\n \tmod_perl.so!modperl_wbucket_pass()  + 0xf4\t\n \tmod_perl.so!modperl_wbucket_flush()  + 0x1b\t\n \tmod_perl.so!modperl_output_filter_handler()  + 0x28\t\n \tmod_perl.so!modperl_wbucket_pass()  + 0xf4\t\n \tmod_perl.so!modperl_wbucket_flush()  + 0x1b\t\n \tmod_perl.so!modperl_io_perlio_restore_stdout()  + 0xd0\t\n\n\nWhen error accurs, the return value of BIO_write is -1, which is different from \ns->s3->wbuf.left\n\t\t\ti=BIO_write(s->wbio,\n\t\t\t\t(char *)&(s->s3->wbuf.buf[s->s3->wbuf.offset]),\n\t\t\t\t(unsigned int)s->s3->wbuf.left);\n\nThen the function returns with -1.\n\nThe attached file is the locals when reach this point.\n\n\n\n\n\nthen, in ssl_filter_write(),\n\nthen SSL_get_error is called:\n\nint ssl_err = SSL_get_error(filter_ctx->pssl, res);\nThis is the call stack,\n\tssleay32.dll!SSL_get_error(const ssl_st * s=0x06bfdd08, int i=-1)  Line \n1818\tC\n \tmod_ssl.so!ssl_filter_write(ap_filter_t * f=0x06b82620, const char * \ndata=0x06dd0000, unsigned int len=346)  Line 776 + 0xf\tC\n \tmod_ssl.so!ssl_io_filter_output(ap_filter_t * f=0x06b82620, \napr_bucket_brigade * bb=0x06b918a0)  Line 1364 + 0x11\tC\n \tlibhttpd.dll!ap_pass_brigade(ap_filter_t * next=0x06b82620, \napr_bucket_brigade * bb=0x06b918a0)  Line 512 + 0x10\tC\n \tlibhttpd.dll!ap_http_header_filter(ap_filter_t * f=0x06bb0b20, \napr_bucket_brigade * b=0x06b918a0)  Line 1692\tC\n \tlibhttpd.dll!ap_pass_brigade(ap_filter_t * next=0x06bb0b20, \napr_bucket_brigade * bb=0x06b918a0)  Line 512 + 0x10\tC\n \tlibhttpd.dll!ap_content_length_filter(ap_filter_t * f=0x06bb0b08, \napr_bucket_brigade * b=0x06b918a0)  Line 1233\tC\n \tlibhttpd.dll!ap_pass_brigade(ap_filter_t * next=0x06bb0b08, \napr_bucket_brigade * bb=0x06b918a0)  Line 512 + 0x10\tC\n \tlibhttpd.dll!ap_byterange_filter(ap_filter_t * f=0x06bb0af0, \napr_bucket_brigade * bb=0x06b918a0)  Line 2876 + 0x10\tC\n \tlibhttpd.dll!ap_pass_brigade(ap_filter_t * next=0x06bb0af0, \napr_bucket_brigade * bb=0x06b918a0)  Line 512 + 0x10\tC\n \tlibhttpd.dll!default_handler(request_rec * r=0x06bafcd8)  Line 3610 + \n0x13\tC\n \tlibhttpd.dll!ap_run_handler(request_rec * r=0x06bafcd8)  Line 153 + 0x4e\n\tC\n \tlibhttpd.dll!ap_invoke_handler(request_rec * r=0x06bafcd8)  Line 364 + \n0x9\tC\n \tlibhttpd.dll!ap_process_request(request_rec * r=0x06bafcd8)  Line 249 + \n0x9\tC\n \tlibhttpd.dll!ap_process_http_connection(conn_rec * c=0x06b82270)  Line \n251 + 0x9\tC\n \tlibhttpd.dll!ap_run_process_connection(conn_rec * c=0x06b82270)  Line \n43 + 0x4e\tC\n \tlibhttpd.dll!ap_process_connection(conn_rec * c=0x06b82270, void * \ncsd=0x06b821a0)  Line 178\tC\n \tlibhttpd.dll!worker_main(void * thread_num_val=0x000000f8)  Line 733\n\tC\n \tmsvcr71d.dll!_threadstartex(void * ptd=0x06b82098)  Line 241 + 0xd\n\tC\n \tkernel32.dll!GetModuleFileNameA()  + 0x1b4\t\n\nIn function SSL_get_error, the flow skips all if statements and hit the last \nreturn statement,\n\treturn(SSL_ERROR_SYSCALL);\n\t\nThen, in function ssl_filter_write, ap_log_error() will be called with a \nstring \"SSL output filter write failed.\",\nwhich is the error message you see in apache error log(debug mode).\n\n        else if (ssl_err == SSL_ERROR_SYSCALL) {\n            ap_log_error(APLOG_MARK, APLOG_INFO, outctx->rc, c->base_server,\n                        \"SSL output filter write failed.\");\n                        \nThe attached file is the locals when reach this point.\n\nBy the way, we configured and use the mod_perl filter functions. Once SSL \ngenerate that error message, mod_perl calls \n       MP_RUN_CROAK(modperl_output_filter_flush(filter),\n                     \"Apache2::Filter\");\nin modperl_run_filter(modperl_filter_t *filter) from modperl_filter.c, \nwhich kills apache child process.", "id": 80404, "time": "2005-09-23T22:52:35Z", "creator": "shien.xie@hp.com", "creation_time": "2005-09-23T22:52:35Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "text": "I'm confused, which is the stack backtrace *when the process crashes*?  \n\nYou have given two stack traces but then described how the code continues from\nthere, so neither of those stack traces are actually triggered by the crash?\n\n> By the way, we configured and use the mod_perl filter functions. Once SSL \n> generate that error message, mod_perl calls \n>       MP_RUN_CROAK(modperl_output_filter_flush(filter),\n>                     \"Apache2::Filter\");\n> in modperl_run_filter(modperl_filter_t *filter) from modperl_filter.c, \n> which kills apache child process.\n\nso what is the stack trace *when the child process is killed*?", "attachment_id": null, "bug_id": 36751, "id": 80414, "time": "2005-09-24T16:37:05Z", "creator": "jorton@redhat.com", "creation_time": "2005-09-24T16:37:05Z", "is_private": false}, {"count": 5, "tags": [], "text": "The first stacktrace is where SSL write operation fails.\n\nThe second stacktrace is where error code \"SSL_ERROR_SYSCALL\" is returned and \nwhere \"SSL output filter write failed\" is wrote into apache's error log.\n\nThe crash is triggered by mod_perl. Mod_perl calls MP_RUN_CROAK to kill apache \nchild process when SSL returns that error code to it, which it can not \nunderstand. I will put more debug info once I get it.\n\n\n\n", "attachment_id": null, "bug_id": 36751, "id": 80445, "time": "2005-09-25T18:25:21Z", "creator": "shien.xie@hp.com", "creation_time": "2005-09-25T18:25:21Z", "is_private": false}, {"count": 6, "tags": [], "text": "So, neither of these two stacktrace is *when the process crashes*?  \nI did not attach the stacktrace of that because I thought the root cause is \nwhy SSL returns that error code, not why mod_perl kills apache.\n\nAnyway, I will paste the stacktrace *when the process crashes* on Monday.", "attachment_id": null, "bug_id": 36751, "id": 80446, "time": "2005-09-25T18:34:37Z", "creator": "shien.xie@hp.com", "creation_time": "2005-09-25T18:34:37Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 36751, "text": "Oh, I see what you're saying...\n\nif a mod_perl \"croak\" means the whole process is terminated, then that much\nreally is a mod_perl bug.  Output filters may very well fail and return errors\nunder abnormal circumstances such as aborted connections.  \n\nThere is probably some separate mod_ssl error code handling issue here too w.r.t\nthe  error number conversion failure. ", "id": 80447, "time": "2005-09-25T18:57:58Z", "creator": "jorton@redhat.com", "creation_time": "2005-09-25T18:57:58Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "bugs@mdarwin.ca", "attachment_id": null, "id": 80448, "time": "2005-09-25T19:01:58Z", "bug_id": 36751, "creation_time": "2005-09-25T19:01:58Z", "is_private": false, "text": "from Carp(3perl) man page:\n\ncroak   - die of errors (from perspective of caller)"}, {"count": 9, "tags": [], "bug_id": 36751, "attachment_id": 16540, "text": "Created attachment 16540\nbacktrace info while mod_perl crashes Apache", "id": 80516, "time": "2005-09-27T21:47:19Z", "creator": "shien.xie@hp.com", "creation_time": "2005-09-27T21:47:19Z", "is_private": false}, {"count": 10, "attachment_id": null, "bug_id": 36751, "text": "If load SSL and mod_perl(use filter function) in same apache server, \nopenssl returns \"SSL output filter write failed\" very frequently, (once every 5-\n6 pages have been loaded by browser), it that a normal behavior of SSL?\n\n\n\n", "id": 80517, "time": "2005-09-27T21:58:29Z", "creator": "shien.xie@hp.com", "creation_time": "2005-09-27T21:58:29Z", "tags": [], "is_private": false}, {"count": 11, "tags": [], "bug_id": 36751, "attachment_id": null, "id": 80518, "time": "2005-09-27T22:01:01Z", "creator": "shien.xie@hp.com", "creation_time": "2005-09-27T22:01:01Z", "is_private": false, "text": "It is likely that bug 36557 is about the same problem."}, {"count": 12, "tags": [], "bug_id": 36751, "text": "The fact that mod_perl aborts the process if an output filter fails is a\nmod_perl bug; the mod_ssl behaviour is fine here, please report it following:\n\nhttp://perl.apache.org/docs/2.0/user/help/help.html#Reporting_Problems", "id": 80530, "time": "2005-09-28T09:33:33Z", "creator": "jorton@redhat.com", "creation_time": "2005-09-28T09:33:33Z", "is_private": false, "attachment_id": null}, {"count": 13, "tags": [], "creator": "jorton@redhat.com", "text": "*** Bug 36557 has been marked as a duplicate of this bug. ***", "id": 80532, "attachment_id": null, "bug_id": 36751, "creation_time": "2005-09-28T09:34:17Z", "time": "2005-09-28T09:34:17Z", "is_private": false}, {"count": 14, "tags": [], "creator": "issac@apache.org", "text": "I'm not sure if mod_perl is intentionally shutting down Apache's process or not...  \nI think the problem is that croak ultimately calls exit (see dump file I\nposted).    Usually - even in an embedded environment, this is what one expects\ncroak (or die) to do.  I think it may be problematic in an environment like\nmod_perl2 where there are multiple interpreters living in the same process.  In\nsuch a case, we don't want the entire process to die - I'd guess just the one\nembedded interpreter (which would have to be replaced inside the child process).\n I'd also guess that this was noticed by Simon and myself on Win32 platforms\nsince unlike mod_worker which, although is threaded, spawns multiple child\nprocesses, each containing worker threads, mpm_nt has only one child process, so\nwhen it goes, we're stuck waiting until the child fully recycles... \n\nIn any case, I'll follow-up on this on the mod_perl list.", "id": 80546, "time": "2005-09-28T12:37:25Z", "bug_id": 36751, "creation_time": "2005-09-28T12:37:25Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "text": "Created attachment 16542\nms (vc2003) dump of perl calling exit(9)", "attachment_id": 16542, "bug_id": 36751, "id": 80547, "time": "2005-09-28T12:39:04Z", "creator": "issac@apache.org", "creation_time": "2005-09-28T12:39:04Z", "is_private": false}]