[{"count": 0, "tags": [], "bug_id": 51306, "is_private": false, "text": "Occasionally we got errors like following:\n======\n2011-05-30 03:40:17,697 ERROR [pool-1-thread-2] (org.apache.catalina.ha.session.DeltaManager) Manager [localhost#]: Unable to receive message through TCP channel\njava.lang.NullPointerException\nat java.io.ObjectOutputStream$BlockDataOutputStream.getUTFLength(ObjectOutputStream.java:2106)\nat java.io.ObjectOutputStream$BlockDataOutputStream.writeUTF(ObjectOutputStream.java:1977)\nat java.io.ObjectOutputStream.writeUTF(ObjectOutputStream.java:849)\nat org.apache.catalina.ha.session.DeltaRequest.writeExternal(DeltaRequest.java:267)\nat org.apache.catalina.ha.session.DeltaRequest.serialize(DeltaRequest.java:287)\nat org.apache.catalina.ha.session.DeltaManager.serializeDeltaRequest(DeltaManager.java:716)\nat org.apache.catalina.ha.session.DeltaManager.requestCompleted(DeltaManager.java:1224)\nat org.apache.catalina.ha.session.DeltaSession.expire(DeltaSession.java:403)\nat org.apache.catalina.ha.session.DeltaManager.handleSESSION_EXPIRED(DeltaManager.java:1546)\nat org.apache.catalina.ha.session.DeltaManager.messageReceived(DeltaManager.java:1452)\nat org.apache.catalina.ha.session.DeltaManager.messageDataReceived(DeltaManager.java:1173)\nat org.apache.catalina.ha.session.ClusterSessionListener.messageReceived(ClusterSessionListener.java:92)\nat org.apache.catalina.ha.tcp.SimpleTcpCluster.messageReceived(SimpleTcpCluster.java:901)\nat org.apache.catalina.ha.tcp.SimpleTcpCluster.messageReceived(SimpleTcpCluster.java:882)\nat org.apache.catalina.tribes.group.GroupChannel.messageReceived(GroupChannel.java:269)\nat org.apache.catalina.tribes.group.ChannelInterceptorBase.messageReceived(ChannelInterceptorBase.java:79)\nat org.apache.catalina.tribes.group.interceptors.TcpFailureDetector.messageReceived(TcpFailureDetector.java:110)\nat org.apache.catalina.tribes.group.ChannelInterceptorBase.messageReceived(ChannelInterceptorBase.java:79)\nat org.apache.catalina.tribes.group.ChannelInterceptorBase.messageReceived(ChannelInterceptorBase.java:79)\nat org.apache.catalina.tribes.group.ChannelCoordinator.messageReceived(ChannelCoordinator.java:241)\nat org.apache.catalina.tribes.transport.ReceiverBase.messageDataReceived(ReceiverBase.java:225)\nat org.apache.catalina.tribes.transport.nio.NioReplicationTask.drainChannel(NioReplicationTask.java:188)\nat org.apache.catalina.tribes.transport.nio.NioReplicationTask.run(NioReplicationTask.java:91)\nat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\nat java.lang.Thread.run(Thread.java:662) \n\nIt looks like the functionality of Tomcat is not affected by this.\n\nThe NPE comes from trying to write null sessionId, but why does Tomcat try to send something from handling received authoritative SESSION_EXPIRED message?", "id": 146790, "time": "2011-06-01T12:21:28Z", "creator": "mikhailov.dmitry@gmail.com", "creation_time": "2011-06-01T12:21:28Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 51306, "attachment_id": null, "text": "http://svn.apache.org/viewvc?view=revision&revision=818062 explains why this code is here.\n\nIt looks like a race condition to me at the moment but more research is required.\n\nJust for background, how many nodes are there in your cluster?", "id": 146822, "time": "2011-06-02T17:37:37Z", "creator": "markt@apache.org", "creation_time": "2011-06-02T17:37:37Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 51306, "is_private": false, "text": "Our clusters vary in size from 2 to 11 Tomcats, these problems happen in all configurations.", "id": 146913, "time": "2011-06-07T07:46:15Z", "creator": "mikhailov.dmitry@gmail.com", "creation_time": "2011-06-07T07:46:15Z", "attachment_id": null}, {"count": 3, "attachment_id": null, "creator": "mikhailov.dmitry@gmail.com", "is_private": false, "id": 146914, "time": "2011-06-07T07:46:49Z", "bug_id": 51306, "creation_time": "2011-06-07T07:46:49Z", "tags": [], "text": "I'm not sure http://svn.apache.org/viewvc?view=revision&revision=818062 explains what is happening. While what the comment says is totally true, the stack trace I pasted shows that the problem happens on *secondary nodes*: while handling received remove session expiration event, for some reasons DeltaManager tries to broadcast it to the whole cluster again."}, {"count": 4, "tags": [], "bug_id": 51306, "is_private": false, "text": "There seem to be two problems in this stack trace.\n\nThe first problem is  DeltaRequest#getSize() > 1 in non-primary node . \nUsually, DeltaRequest#getSize() must be 0 in non-primary node. and, r818062 works correctly. \nHowever, r818062 doesn't work correctly because DeltaRequest#getSize() is more than 1 in this case. \nThis is a potential bug. \n\nThe second problem is  DeltaRequest#sessionId() is null in non-primary node .\nWhen handleSESSION_CREATED is completed, DeltaRequest#sessionId is always non-null. \nWhen setMaxInactiveInterval is called in handleSESSION_CREATED, the action is added to DeltaRequest. \nAs a result, it becomes DeltaRequest#getSize() >1. \nThis is probably bug.\nFor instance, when handleSESSION_EXPIRED is processed while processing handleSESSION_CREATED, \nsessionId of DeltaRequest will become null and DeltaRequest#getSize() > 1. \nAnd, NPE will be thrown out. \n\nThe workaround is..\nCorrect these bugs or Synchronize between handleSESSION_CREATED and handleSESSION_EXPIRED.\n\nI will correct not to add action to DeltaRequest when setMaxInactiveInterval is called in handleSESSION_CREATED. \nAdditionally, I will correct the potential bug of r818062.", "id": 147045, "time": "2011-06-13T08:57:57Z", "creator": "kfujino@apache.org", "creation_time": "2011-06-13T08:57:57Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 51306, "attachment_id": null, "text": "Fixed in 7.0.x and will be included in 7.0.17 onwards.\n\nProposed for 6.0.x", "id": 147049, "time": "2011-06-13T09:52:21Z", "creator": "kfujino@apache.org", "creation_time": "2011-06-13T09:52:21Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 51306, "attachment_id": null, "text": "Is there a workaround for this issue? What should I not do in my code to prevent this?\nThe cause r818062 is from 2009, so I must go back very far to get a Tomcat version which doesn't have this bug, with the risk, that I get back old bugs.", "id": 147097, "time": "2011-06-14T10:37:39Z", "creator": "ronald-lists@klop.ws", "creation_time": "2011-06-14T10:37:39Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 51306, "attachment_id": null, "text": "It's a bug in Tomcat, some funky cyclic implementation that I still fully don't understand. Invoking listeners on expiring sessions....maybe valid...maybe not needed....\n\nHowever, does this bug really cause a problem in your app? The session is going to expire no matter what, even if this error message is printed. \n\nBesides the error message in the log, is your app actually experiencing any symptoms from this?\n\nbest\nFilip", "id": 147124, "time": "2011-06-15T01:50:50Z", "creator": "fhanik@apache.org", "creation_time": "2011-06-15T01:50:50Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 51306, "attachment_id": null, "id": 147129, "time": "2011-06-15T08:59:35Z", "creator": "ronald-lists@klop.ws", "creation_time": "2011-06-15T08:59:35Z", "is_private": false, "text": "I have customers who are 'logged out' in their words and that correlates with the times of these errors in the logs. No hard evidence though.\nAnd the weirdest thing is that it only happens since two or three weeks."}, {"count": 9, "tags": [], "text": "This has been fixed in 6.0.x and will be included in 6.0.33 onwards.", "attachment_id": null, "id": 147318, "creator": "kfujino@apache.org", "time": "2011-06-21T11:36:50Z", "bug_id": 51306, "creation_time": "2011-06-21T11:36:50Z", "is_private": false}, {"count": 10, "attachment_id": null, "creator": "mikhailov.dmitry@gmail.com", "is_private": false, "id": 147547, "time": "2011-06-28T09:16:36Z", "bug_id": 51306, "creation_time": "2011-06-28T09:16:36Z", "tags": [], "text": "Thanks a lot!"}]