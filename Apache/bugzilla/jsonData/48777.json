[{"count": 0, "tags": [], "creator": "jean-sebastien.frerot@gameloft.com", "attachment_id": null, "is_private": false, "id": 134695, "time": "2010-02-19T13:47:28Z", "bug_id": 48777, "creation_time": "2010-02-19T13:47:28Z", "text": "here is the configuration\n\n<Proxy balancer://images>\n    BalancerMember http://10.100.0.28 retry=60 timeout=5\n    BalancerMember http://10.100.0.29 retry=60 timeout=5\n    BalancerMember http://10.100.0.30 retry=60 timeout=5\n    BalancerMember http://10.100.0.44 retry=60 timeout=5\n    ProxySet lbmethod=bytraffic timeout=5\n    Order deny,allow\n    Deny from all\n    Allow from all \n</Proxy>\n\nRewriteRule ^/common(.*) balancer://images$1 [P]\nProxyPassReverse /common balancer://images\n\nHow to reproduce the problem:\nset one of the balancer member to drop all reply packets returning to the requester server: \n[10.100.0.30]: sudo iptables -A OUTPUT -d 10.100.0.89 -j DROP\n\nif you go to the balancer-manager page of 10.100.0.89 you will see that this node http://10.100.0.30 will flip forth and back from \"ok\" to \"err\" without considering the 60 seconds retry parameter. And by looking at the Elected field, you'll see requests still going to this server.\n\ntcpdump results:\n12:46:11.468623 IP 10.100.0.89.39148 > 10.100.0.30.80: . ack 2312 win 23 <nop,nop,timestamp 925863575 1017403,nop,nop,sack 1 {2311:2312}>\n12:46:11.495487 IP 10.100.0.89.39550 > 10.100.0.30.80: S 1784562342:1784562342(0) win 5840 <mss 1460,sackOK,timestamp 925863582 0,nop,wscale 9>\n12:46:11.520143 IP 10.100.0.89.39050 > 10.100.0.30.80: F 0:0(0) ack 1 win 17 <nop,nop,timestamp 925863588 1012082>\n12:46:11.555322 IP 10.100.0.89.37903 > 10.100.0.30.80: F 0:0(0) ack 1 win 17 <nop,nop,timestamp 925863597 1000084>\n12:46:11.571507 IP 10.100.0.89.37680 > 10.100.0.30.80: F 526220930:526220930(0) ack 4086845075 win 17 <nop,nop,timestamp 925863601 997939>\n12:46:11.571512 IP 10.100.0.89.39551 > 10.100.0.30.80: S 1775937170:1775937170(0) win 5840 <mss 1460,sackOK,timestamp 925863601 0,nop,wscale 9>\n12:46:11.753822 IP 10.100.0.89.39471 > 10.100.0.30.80: S 1738586911:1738586911(0) win 5840 <mss 1460,sackOK,timestamp 925863647 0,nop,wscale 9>\n12:46:11.774826 IP 10.100.0.89.38406 > 10.100.0.30.80: F 0:0(0) ack 1 win 17 <nop,nop,timestamp 925863652 1005140>\n12:46:11.778066 IP 10.100.0.89.37680 > 10.100.0.30.80: F 0:0(0) ack 1 win 17 <nop,nop,timestamp 925863653 997939>\n12:46:11.849827 IP 10.100.0.89.39139 > 10.100.0.30.80: F 459:459(0) ack 504 win 14 <nop,nop,timestamp 925863671 1013569>\n12:46:11.933836 IP 10.100.0.89.39050 > 10.100.0.30.80: F 0:0(0) ack 1 win 17 <nop,nop,timestamp 925863692 1012082>\n12:46:12.001753 IP 10.100.0.89.38976 > 10.100.0.30.80: F 1357893028:1357893028(0) ack 641429889 win 142 <nop,nop,timestamp 925863708 1011320>\n12:46:12.001775 IP 10.100.0.89.39552 > 10.100.0.30.80: S 1787212656:1787212656(0) win 5840 <mss 1460,sackOK,timestamp 925863708 0,nop,wscale 9>\n12:46:12.015495 IP 10.100.0.89.39477 > 10.100.0.30.80: S 1748850970:1748850970(0) win 5840 <mss 1460,sackOK,timestamp 925863712 0,nop,wscale 9>\n12:46:12.101656 IP 10.100.0.89.39483 > 10.100.0.30.80: S 1746295340:1746295340(0) win 5840 <mss 1460,sackOK,timestamp 925863733 0,nop,wscale 9>\n12:46:12.194069 IP 10.100.0.89.37680 > 10.100.0.30.80: F 0:0(0) ack 1 win 17 <nop,nop,timestamp 925863757 997939>\n12:46:12.205816 IP 10.100.0.89.38976 > 10.100.0.30.80: F 0:0(0) ack 1 win 142 <nop,nop,timestamp 925863760 1011320>\n12:46:12.206577 IP 10.100.0.89.39484 > 10.100.0.30.80: S 1741309974:1741309974(0) win 5840 <mss 1460,sackOK,timestamp 925863760 0,nop,wscale 9>\n12:46:12.217813 IP 10.100.0.89.36664 > 10.100.0.30.80: F 0:0(0) ack 1 win 17 <nop,nop,timestamp 925863763 991676>\n12:46:12.325818 IP 10.100.0.89.38423 > 10.100.0.30.80: F 0:0(0) ack 1 win 17 <nop,nop,timestamp 925863790 1005548>\n12:46:12.518073 IP 10.100.0.89.38451 > 10.100.0.30.80: F 0:0(0) ack 1 win 17 <nop,nop,timestamp 925863838 1006166>\n12:46:12.563846 IP 10.100.0.89.39559 > 10.100.0.30.80: S 1796546847:1796546847(0) win 5840 <mss 1460,sackOK,timestamp 925863849 0,nop,wscale 9>\n12:46:12.622322 IP 10.100.0.89.38976 > 10.100.0.30.80: F 0:0(0) ack 1 win 142 <nop,nop,timestamp 925863864 1011320>\n12:46:12.770186 IP 10.100.0.89.39165 > 10.100.0.30.80: F 1343:1343(0) ack 1309 win 17 <nop,nop,timestamp 925863900 1016019>\n12:46:12.770417 IP 10.100.0.89.39050 > 10.100.0.30.80: F 0:0(0) ack 1 win 17 <nop,nop,timestamp 925863900 1012082>\n12:46:12.774981 IP 10.100.0.89.39489 > 10.100.0.30.80: S 1762397365:1762397365(0) win 5840 <mss 1460,sackOK,timestamp 925863902 0,nop,wscale 9>\n12:46:12.789824 IP 10.100.0.89.39490 > 10.100.0.30.80: S 1751438195:1751438195(0) win 5840 <mss 1460,sackOK,timestamp 925863906 0,nop,wscale 9>\n...\n\n\nNote that this problem doesn't not occur if I shutdown apache. It only occurs if the server looses the network. However if I shutdown apache, then shutdown the server, after 60 seconds I will have the same problematic behavior.\n\n\nPackages version on debian:\napache2           2.2.9-10+lenny6\napache2.2-common  2.2.9-10+lenny6"}]