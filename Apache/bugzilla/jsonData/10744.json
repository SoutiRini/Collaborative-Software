[{"count": 0, "tags": [], "bug_id": 10744, "attachment_id": null, "id": 19414, "time": "2002-07-12T15:31:53Z", "creator": "abatko@cs.mcgill.ca", "creation_time": "2002-07-12T15:31:53Z", "is_private": false, "text": "I have been able to get the following error messages\nin httpd-error.log by modifying suexec.c just to see\nwhat would happen if execv() returned.\n\n[error] Premature end of script headers: hello.pl\n[error] failed to open log file\n[error] fopen: Permission denied\n\nThere is a comment near the end of suexec.c's main()\nfunction which says that the log file will be closed\nso that CGI can't tamper with it.  It also states that\n\"If the exec fails, it will be reopened automatically\nwhen log_err is called.\"  So this is what I wanted to\ntest.  I did the test by simply preceeding execv() with\nthe \"kaboom\" log_err() statement that *would* be called\nif execv() returned.  Here's a diff of what I mean:\n\n\n--- suexec.c.orig       Fri Jul 12 10:42:48 2002\n+++ suexec.c    Fri Jul 12 11:13:30 2002\n@@ -620,6 +620,7 @@\n         ap_execve(cmd, &argv[3], environ);\n     }\n #else /*NEED_HASHBANG_EMUL*/\n+    log_err(\"(%d)%s: exec failed (%s)\\n\", errno, strerror(errno), cmd);\n     execv(cmd, &argv[3]);\n #endif /*NEED_HASHBANG_EMUL*/\n\n\nI may be totally wrong by performing the test like\nthis but as far as I see, if execv() ever returns,\nthe \"kaboom\" line will not execute as expected because\nfopen will bomb.\n\nPlease let me know if I am wrong about any of this."}, {"count": 1, "tags": [], "creator": "apache-0@rachinsky.de", "attachment_id": null, "id": 23178, "time": "2002-09-21T00:40:13Z", "bug_id": 10744, "creation_time": "2002-09-21T00:40:13Z", "is_private": false, "text": "I think the problem is that suexec can't reopen the logs because it already has dropped \nprivileges. Perhaps setting the fd close-on-exec would be better than explicitly closing it, but I \ndon't know if that is portable."}, {"count": 2, "tags": [], "text": "FWIW, this bug has been reported against Debian's apache package too\nand it includes a patch:\n\nhttp://bugs.debian.org/cgi-bin/bugreport.cgi?bug=153528\n\nThoughts?", "is_private": false, "id": 46344, "creator": "willy@debian.org", "time": "2003-10-27T21:27:45Z", "bug_id": 10744, "creation_time": "2003-10-27T21:27:45Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 10744, "is_private": false, "id": 46345, "attachment_id": null, "creator": "apache-0@rachinsky.de", "creation_time": "2003-10-27T21:36:37Z", "time": "2003-10-27T21:36:37Z", "text": "the patch in the Debian BTS looks good."}, {"count": 4, "tags": [], "bug_id": 10744, "attachment_id": null, "id": 69991, "time": "2005-01-23T13:55:05Z", "creator": "roland.illig@gmx.de", "creation_time": "2005-01-23T13:55:05Z", "is_private": false, "text": "(In reply to comment #3)\n> the patch in the Debian BTS looks good.\n\nBut be sure to check the result of the call to fcntl(). If we did not succeed in\nsetting the CLOEXEC flag, bad things may happen.\n\nRoland"}, {"count": 5, "tags": [], "creator": "apache-0@rachinsky.de", "attachment_id": null, "id": 70002, "time": "2005-01-23T18:40:05Z", "bug_id": 10744, "creation_time": "2005-01-23T18:40:05Z", "is_private": false, "text": "(In reply to comment #4)\n> But be sure to check the result of the call to fcntl(). If we did not succeed in\n> setting the CLOEXEC flag, bad things may happen.\n\nACK.\n\nHow about this one?\n\n@@ -638,19 +642,15 @@\n     umask(SUEXEC_UMASK);\n #endif /* SUEXEC_UMASK */\n\n-    /*\n-     * Be sure to close the log file so the CGI can't\n-     * mess with it.  If the exec fails, it will be reopened\n-     * automatically when log_err is called.  Note that the log\n-     * might not actually be open if LOG_EXEC isn't defined.\n-     * However, the \"log\" cell isn't ifdef'd so let's be defensive\n-     * and assume someone might have done something with it\n-     * outside an ifdef'd LOG_EXEC block.\n-     */\n     if (log != NULL) {\n-       fclose(log);\n-       log = NULL;\n+        fflush(log);\n+        setbuf(log,NULL);\n+        if(fcntl(fileno(log),F_SETFD,FD_CLOEXEC)==-1) {\n+                log_err(\"error: can't set close-on-exec flag\");\n+                exit(122);\n+        }\n     }\n+\n\n     /*\n      * Execute the command, replacing our image with its own."}, {"count": 6, "tags": [], "bug_id": 10744, "is_private": false, "id": 103644, "attachment_id": 20270, "creator": "frankbugs@x09.de", "creation_time": "2007-05-24T10:19:09Z", "time": "2007-05-24T10:19:09Z", "text": "Created attachment 20270\nA patch against suexec.c of Apache 2.2.4\n\nJust a patch against the newest Apache. (In preparation for a posting on the\nhttpd-dev mailinglist)"}, {"count": 7, "tags": [], "bug_id": 10744, "is_private": false, "id": 130838, "attachment_id": null, "creator": "sf@sfritsch.de", "creation_time": "2009-10-03T06:47:24Z", "time": "2009-10-03T06:47:24Z", "text": "commited to trunk as r821321"}]