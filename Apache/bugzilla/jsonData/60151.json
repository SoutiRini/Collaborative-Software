[{"count": 0, "attachment_id": null, "bug_id": 60151, "is_private": false, "id": 193818, "time": "2016-09-19T19:33:47Z", "creator": "per.carlson@vegvesen.no", "creation_time": "2016-09-19T19:33:47Z", "tags": [], "text": "After upgrading from Tomcat 8.0.32 to 8.0.37 all bases using Datasources started failing.\n\nStart of forensics:\n\n19-Sep-2016 10:45:49.046 WARNING [localhost-startStop-1] org.apache.naming.NamingContext.lookup Unexpected exception resolving reference\n java.lang.NullPointerException\n        at java.lang.Class.forName0(Native Method)\n        at java.lang.Class.forName(Class.java:348)\n        at org.apache.naming.factory.ResourceLinkFactory.getObjectInstance(ResourceLinkFactory.java:150)\n        at javax.naming.spi.NamingManager.getObjectInstance(NamingManager.java:321)\n        at org.apache.naming.NamingContext.lookup(NamingContext.java:847)\n        at org.apache.naming.NamingContext.lookup(NamingContext.java:158)\n        at org.apache.naming.NamingContext.lookup(NamingContext.java:835)\n        at org.apache.naming.NamingContext.lookup(NamingContext.java:158)\n        at org.apache.naming.NamingContext.lookup(NamingContext.java:835)\n        at org.apache.naming.NamingContext.lookup(NamingContext.java:158)\n        at org.apache.naming.NamingContext.lookup(NamingContext.java:835)\n        at org.apache.naming.NamingContext.lookup(NamingContext.java:172)\n        at org.apache.naming.SelectorContext.lookup(SelectorContext.java:157)\n        at javax.naming.InitialContext.lookup(InitialContext.java:417)\n        at org.springframework.jndi.JndiTemplate$1.doInContext(JndiTemplate.java:155)\n        at org.springframework.jndi.JndiTemplate.execute(JndiTemplate.java:87)\n        at org.springframework.jndi.JndiTemplate.lookup(JndiTemplate.java:152)\n        at org.springframework.jndi.JndiTemplate.lookup(JndiTemplate.java:179)\n        at org.springframework.jndi.JndiLocatorSupport.lookup(JndiLocatorSupport.java:95)\n        at org.springframework.jdbc.datasource.lookup.JndiDataSourceLookup.getDataSource(JndiDataSourceLookup.java:45)\n        at org.springframework.boot.autoconfigure.jdbc.JndiDataSourceAutoConfiguration.dataSource(JndiDataSourceAutoConfiguration.java:58)\n        at org.springframework.boot.autoconfigure.jdbc.JndiDataSourceAutoConfiguration$$EnhancerBySpringCGLIB$$6f321833.CGLIB$dataSource$0(<generated>)\n        at org.springframework.boot.autoconfigure.jdbc.JndiDataSourceAutoConfiguration$$EnhancerBySpringCGLIB$$6f321833$$FastClassBySpringCGLIB$$9024b67d.invoke(<generated>)\n        at org.springframework.cglib.proxy.MethodProxy.invokeSuper(MethodProxy.java:228)\n        at org.springframework.context.annotation.ConfigurationClassEnhancer$BeanMethodInterceptor.intercept(ConfigurationClassEnhancer.java:355)\n        at org.springframework.boot.autoconfigure.jdbc.JndiDataSourceAutoConfiguration$$EnhancerBySpringCGLIB$$6f321833.dataSource(<generated>)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:498)\n        at org.springframework.beans.factory.support.SimpleInstantiationStrategy.instantiate(SimpleInstantiationStrategy.java:162)\n        at org.springframework.beans.factory.support.ConstructorResolver.instantiateUsingFactoryMethod(ConstructorResolver.java:588)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.instantiateUsingFactoryMethod(AbstractAutowireCapableBeanFactory.java:1123)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBeanInstance(AbstractAutowireCapableBeanFactory.java:1018)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:510)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:482)\n        at org.springframework.beans.factory.support.AbstractBeanFactory$1.getObject(AbstractBeanFactory.java:306)\n        at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:230)\n        at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:302)\n        at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:197)\n        at org.springframework.beans.factory.support.DefaultListableBeanFactory.findAutowireCandidates(DefaultListableBeanFactory.java:1192)\n        at org.springframework.beans.factory.support.DefaultListableBeanFactory.doResolveDependency(DefaultListableBeanFactory.java:1116)\n        at org.springframework.beans.factory.support.DefaultListableBeanFactory.resolveDependency(DefaultListableBeanFactory.java:1014)\n        at org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor$AutowiredFieldElement.inject(AutowiredAnnotationBeanPostProcessor.java:545)\n        at org.springframework.beans.factory.annotation.InjectionMetadata.inject(InjectionMetadata.java:88)\n        at org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor.postProcessPropertyValues(AutowiredAnnotationBeanPostProcessor.java:331)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean(AbstractAutowireCapableBeanFactory.java:1214)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:543)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:482)\n        at org.springframework.beans.factory.support.AbstractBeanFactory$1.getObject(AbstractBeanFactory.java:306)\n        at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:230)\n        at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:302)\n        at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:197)\n        at org.springframework.beans.factory.support.ConstructorResolver.instantiateUsingFactoryMethod(ConstructorResolver.java:368)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.instantiateUsingFactoryMethod(AbstractAutowireCapableBeanFactory.java:1123)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBeanInstance(AbstractAutowireCapableBeanFactory.java:1018)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:510)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:482)\n        at org.springframework.beans.factory.support.AbstractBeanFactory$1.getObject(AbstractBeanFactory.java:306)\n        at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:230)\n        at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:302)\n        at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:197)\n        at org.springframework.beans.factory.support.DefaultListableBeanFactory.findAutowireCandidates(DefaultListableBeanFactory.java:1192)\n        at org.springframework.beans.factory.support.DefaultListableBeanFactory.doResolveDependency(DefaultListableBeanFactory.java:1116)\n        at org.springframework.beans.factory.support.DefaultListableBeanFactory.resolveDependency(DefaultListableBeanFactory.java:1014)\n        at org.springframework.beans.factory.support.ConstructorResolver.resolveAutowiredArgument(ConstructorResolver.java:813)\n        at org.springframework.beans.factory.support.ConstructorResolver.createArgumentArray(ConstructorResolver.java:741)\n        at org.springframework.beans.factory.support.ConstructorResolver.autowireConstructor(ConstructorResolver.java:185)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.autowireConstructor(AbstractAutowireCapableBeanFactory.java:1143)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBeanInstance(AbstractAutowireCapableBeanFactory.java:1046)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:510)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:482)\n        at org.springframework.beans.factory.support.AbstractBeanFactory$1.getObject(AbstractBeanFactory.java:306)\n        at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:230)\n        at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:302)\n        at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:197)\n        at org.springframework.beans.factory.support.DefaultListableBeanFactory.findAutowireCandidates(DefaultListableBeanFactory.java:1192)\n        at org.springframework.beans.factory.support.DefaultListableBeanFactory.doResolveDependency(DefaultListableBeanFactory.java:1116)\n        at org.springframework.beans.factory.support.DefaultListableBeanFactory.resolveDependency(DefaultListableBeanFactory.java:1014)\n        at org.springframework.beans.factory.support.ConstructorResolver.resolveAutowiredArgument(ConstructorResolver.java:813)\n        at org.springframework.beans.factory.support.ConstructorResolver.createArgumentArray(ConstructorResolver.java:741)\n        at org.springframework.beans.factory.support.ConstructorResolver.autowireConstructor(ConstructorResolver.java:185)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.autowireConstructor(AbstractAutowireCapableBeanFactory.java:1143)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBeanInstance(AbstractAutowireCapableBeanFactory.java:1046)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:510)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:482)\n        at org.springframework.beans.factory.support.AbstractBeanFactory$1.getObject(AbstractBeanFactory.java:306)\n        at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:230)\n        at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:302)\n        at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:197)\n        at org.springframework.beans.factory.support.DefaultListableBeanFactory.findAutowireCandidates(DefaultListableBeanFactory.java:1192)\n        at org.springframework.beans.factory.support.DefaultListableBeanFactory.doResolveDependency(DefaultListableBeanFactory.java:1116)\n        at org.springframework.beans.factory.support.DefaultListableBeanFactory.resolveDependency(DefaultListableBeanFactory.java:1014)\n        at org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor$AutowiredFieldElement.inject(AutowiredAnnotationBeanPostProcessor.java:545)\n        at org.springframework.beans.factory.annotation.InjectionMetadata.inject(InjectionMetadata.java:88)\n        at org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor.postProcessPropertyValues(AutowiredAnnotationBeanPostProcessor.java:331)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean(AbstractAutowireCapableBeanFactory.java:1214)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:543)\n        at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:482)\n        at org.springframework.beans.factory.support.AbstractBeanFactory$1.getObject(AbstractBeanFactory.java:306)\n        at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:230)\n        at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:302)\n        at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:197)\n        at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:772)\n        at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:839)\n        at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:538)\n        at org.springframework.boot.context.embedded.EmbeddedWebApplicationContext.refresh(EmbeddedWebApplicationContext.java:118)\n        at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:766)\n        at org.springframework.boot.SpringApplication.createAndRefreshContext(SpringApplication.java:361)\n        at org.springframework.boot.SpringApplication.run(SpringApplication.java:307)\n        at org.springframework.boot.context.web.SpringBootServletInitializer.run(SpringBootServletInitializer.java:149)\n        at org.springframework.boot.context.web.SpringBootServletInitializer.createRootApplicationContext(SpringBootServletInitializer.java:129)\n        at org.springframework.boot.context.web.SpringBootServletInitializer.onStartup(SpringBootServletInitializer.java:85)\n        at org.springframework.web.SpringServletContainerInitializer.onStartup(SpringServletContainerInitializer.java:175)\n        at org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:5303)\n        at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:145)\n        at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:725)\n        at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:701)\n        at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:717)\n        at org.apache.catalina.startup.HostConfig.deployWAR(HostConfig.java:940)\n        at org.apache.catalina.startup.HostConfig$DeployWar.run(HostConfig.java:1816)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:266)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\n\n\nwhich ultimately leads to\n\n19-Sep-2016 10:45:49.064 SEVERE [localhost-startStop-1] org.apache.catalina.core.ContainerBase.addChildInternal ContainerBase.addChild: start:\n org.apache.catalina.LifecycleException: Failed to start component [StandardEngine[Catalina].StandardHost[localhost].StandardContext[]]\n        at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:162)\n        at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:725)\n        at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:701)\n        at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:717)\n        at org.apache.catalina.startup.HostConfig.deployWAR(HostConfig.java:940)\n        at org.apache.catalina.startup.HostConfig$DeployWar.run(HostConfig.java:1816)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:266)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\n\nCaused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'parkeringsomradeResource': Injection of autowired dependencies failed; nested exception is \n<snip/>\norg.springframework.beans.BeanInstantiationException: Failed to instantiate [javax.sql.DataSource]: Factory method 'dataSource' threw exception; nested exception is org.springframework.jdbc.datasource.lookup.DataSourceLookupFailureException: Failed to look up JNDI DataSource with name 'java:comp/env/jdbc/parkregcache'; nested exception is javax.naming.NamingException; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration$JdbcTemplateConfiguration': Injection of autowired dependencies failed; nested exception is org.springframework.beans.factory.BeanCreationException: Could not autowire field: private javax.sql.DataSource org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration$JdbcTemplateConfiguration.dataSource; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'dataSource' defined in class path resource [org/springframework/boot/autoconfigure/jdbc/JndiDataSourceAutoConfiguration.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [javax.sql.DataSource]: Factory method 'dataSource' threw exception; nested exception is org.springframework.jdbc.datasource.lookup.DataSourceLookupFailureException: Failed to look up JNDI DataSource with name 'java:comp/env/jdbc/parkregcache'; nested exception is javax.naming.NamingException\n\n\nAfter downgrading to Tomcat 8.0.36 all bases started working again.\n\nI can unicast complete stacktraces and configuration if needed."}, {"count": 1, "tags": [], "bug_id": 60151, "is_private": false, "text": "Configuration please. We need to see the DataSource configuration and the details of which file(s) it is in.", "id": 193824, "time": "2016-09-20T06:41:18Z", "creator": "markt@apache.org", "creation_time": "2016-09-20T06:41:18Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "per.carlson@vegvesen.no", "text": "Created attachment 34276\nserver.xml", "id": 193825, "time": "2016-09-20T07:55:58Z", "bug_id": 60151, "creation_time": "2016-09-20T07:55:58Z", "is_private": false, "attachment_id": 34276}, {"count": 3, "tags": [], "creator": "per.carlson@vegvesen.no", "attachment_id": 34277, "is_private": false, "id": 193826, "time": "2016-09-20T07:59:14Z", "bug_id": 60151, "creation_time": "2016-09-20T07:59:14Z", "text": "Created attachment 34277\nsvvint/datasource1-include.xml"}, {"count": 4, "tags": [], "text": "Created attachment 34278\nsvvconf/context1-include.xml", "attachment_id": 34278, "bug_id": 60151, "id": 193827, "time": "2016-09-20T08:02:48Z", "creator": "per.carlson@vegvesen.no", "creation_time": "2016-09-20T08:02:48Z", "is_private": false}, {"count": 5, "tags": [], "creator": "per.carlson@vegvesen.no", "attachment_id": null, "text": "Added server.xml and the includes XML-files", "id": 193829, "time": "2016-09-20T08:03:11Z", "bug_id": 60151, "creation_time": "2016-09-20T08:03:11Z", "is_private": false}, {"count": 6, "tags": [], "text": "That doesn't show where the ResourceLink is created.\n\nTomcat 8.0.x has always documented that the type attribute of a ResourceLink is required. As of 8.0.37 this requirement is enforced.\n\nIt looks appears from the stack trace that that type attribute is missing. The ResourceLink configuration information should confirm that.", "attachment_id": null, "bug_id": 60151, "id": 193830, "time": "2016-09-20T09:25:33Z", "creator": "markt@apache.org", "creation_time": "2016-09-20T09:25:33Z", "is_private": false}, {"count": 7, "tags": [], "text": "I assume you are referring to the following clause in the in the changelog:\n\n\"When retrieving an object via a ResourceLink, ensure that the object obtained is of the expected type.\"\n\nIt might just be me, but I think this very potential breakage of bases is under-communicated. I'd preferred a much more clear notification of the impacts of this change.", "attachment_id": null, "bug_id": 60151, "id": 193831, "time": "2016-09-20T09:36:17Z", "creator": "per.carlson@vegvesen.no", "creation_time": "2016-09-20T09:36:17Z", "is_private": false}, {"count": 8, "tags": [], "creator": "markt@apache.org", "text": "Setting state to NEEDINFO as we need to see the ResourceLink configuration to confirm the root cause of the NPE.", "id": 193891, "time": "2016-09-21T13:45:15Z", "bug_id": 60151, "creation_time": "2016-09-21T13:45:15Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "After reviewing the code, I've applied a fix to improve the exception error message when the type is missing or incorrect.\n\nThis has been fixed in the following branches:\n- 9.0.x for 9.0.0.M11 onwards\n- 8.5.x for 8.5.6 onwards\n- 8.0.x for 8.0.38 onwards\n- 7.0.x for 7.0.73 onwards\n- 6.0.x for 6.0.46 onwards", "id": 193892, "time": "2016-09-21T14:09:42Z", "bug_id": 60151, "creation_time": "2016-09-21T14:09:42Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 60151, "attachment_id": 34288, "text": "Created attachment 34288\ncontext.xml\n\nAs you suspected, the type attribute of the ResourceLinks is missing.", "id": 193898, "time": "2016-09-21T19:32:52Z", "creator": "per.carlson@vegvesen.no", "creation_time": "2016-09-21T19:32:52Z", "is_private": false}, {"count": 11, "tags": [], "text": "Thanks for the confirmation.\n\nGiven that the docs have said that type is a required attribute since at least 6.0.0 and that I have added a better error message for the next round of releases I'm going to mark this as fixed.", "attachment_id": null, "bug_id": 60151, "id": 193899, "time": "2016-09-21T20:12:53Z", "creator": "markt@apache.org", "creation_time": "2016-09-21T20:12:53Z", "is_private": false}]