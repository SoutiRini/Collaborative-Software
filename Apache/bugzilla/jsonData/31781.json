[{"count": 0, "attachment_id": null, "bug_id": 31781, "text": "The following does not work:\n\n    RewriteRule \"^([a-zA-Z0-9]+)$\" \"vanity_url/$1.html\"\n\"[CO=my_cookie_name:%{HTTP_REFERER}:mydomain.com]\"\n\nIf you replace %{HTTP_REFERER} with another environment variable, it still does\nnot work. If you replace it with a back reference (e.g. $1, $2, $3, ...), it\nworks. If you replace it with static content, it also works.", "id": 65323, "time": "2004-10-19T15:36:35Z", "creator": "wchao@yahoo.com", "creation_time": "2004-10-19T15:36:35Z", "tags": [], "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 31781, "is_private": false, "id": 65326, "time": "2004-10-19T16:53:24Z", "creator": "nd@perlig.de", "creation_time": "2004-10-19T16:53:24Z", "tags": [], "text": "Cannot reproduce. But... what do you mean by \"does not work\"?"}, {"count": 2, "tags": [], "bug_id": 31781, "attachment_id": null, "id": 65328, "time": "2004-10-19T18:40:49Z", "creator": "wchao@yahoo.com", "creation_time": "2004-10-19T18:40:49Z", "is_private": false, "text": "I ended up replacing it with the following configuration options, which achieve\nwhat I want:\n\n    # These SetEnvIf statements get evaluated per request, before the\n    # Rewrite* statements. The Header statement sets a cookie to\n    # remember the visitor's original referrer until the visitor submits the\n    # contact form.\n    SetEnvIf Request_Method \".*\" set_referrer_url_from_http_referer\n    SetEnvIf Referer \"^$\" !set_referrer_url_from_http_referer\n    SetEnvIf Referer \"^http://(www\\.)?mydomain\\.com\"\n!set_referrer_url_from_http_referer\n    SetEnvIf Request_URI \"^/vanity_url/\" !set_referrer_url_from_http_referer\n    Header add Set-Cookie \"original_referrer_url=%{HTTP_REFERER}e;\ndomain=.mydomain.com\" env=set_referrer_url_from\n\n    # The Rewrite* statements are needed to handle the case when\n    # vanity URLs are used. Vanity URLs are of the form\n    # www.mydomain.com/abc. A vanity URL of the form /(abc) gets remapped\n    # to /vanity_url/abc.html, etc.... The original referrer information is\n    # also retained, which is important because if we simply did it in the\n    # SetEnvIf and Header section above, the referrer would be lost because\n    # the rewrite causes an internal redirect, which causes the referrer\n    # HTTP header to be lost.\n    RewriteEngine on\n    RewriteBase /\n    RewriteCond \"/home/mydomain/www/public_html/vanity_url/$1.html\" -s\n    RewriteCond \"%{HTTP_REFERER}\" \"^http://(.+)$\"\n    RewriteRule \"^([a-zA-Z0-9]+)$\" \"vanity_url/$1.html\"\n[CO=original_referrer_url:%1:.mydomain.com,L]\n\n    RewriteCond \"/home/mydomain/www/public_html/vanity_url/$1.html\" -s\n    RewriteRule \"^([a-zA-Z0-9]+)$\" \"vanity_url/$1.html\" [L]\n\nWhen I said the original configuration setting did not work, I meant that it did\nnot set the cookie as I wanted. Regardless, now I have my problem resolved in a\ngood way. however, I think cookie flag of the RewriteRule directive does not\nallow environment variables. If it were consistent, you would think that the\ncookie flag should allow environment variables."}, {"count": 3, "tags": [], "creator": "nd@perlig.de", "attachment_id": null, "id": 65331, "creation_time": "2004-10-19T19:07:33Z", "time": "2004-10-19T19:07:33Z", "bug_id": 31781, "text": "> it did not set the cookie as I wanted.\n\nYes..., but what did it instead?\nI mean, I've tested your case and it *did* insert the variables as one would\nexpect. Actually it is the same subroutine which inserts all other stuff\n($1..$9, map lookups etc) as well and which works also for environment variables\nand so on.", "is_private": false}, {"count": 4, "tags": [], "bug_id": 31781, "attachment_id": null, "is_private": false, "id": 65332, "time": "2004-10-19T20:11:13Z", "creator": "wchao@yahoo.com", "creation_time": "2004-10-19T20:11:13Z", "text": "I will try this Thursday night and get back to you. Right now my problem is\nsolved. That being said, I appreciate you taking a look at it and also realize\nthat feedback is helpful for you in solving the problem, so I'll get back to you\nwith the information on Thursday."}, {"count": 5, "attachment_id": null, "creator": "wchao@yahoo.com", "is_private": false, "id": 65403, "time": "2004-10-21T02:41:39Z", "bug_id": 31781, "creation_time": "2004-10-21T02:41:39Z", "tags": [], "text": "I went back and tried it again the old way (before I got it working with a\nhack). The old way was to specify %{HTTP_REFERER} directly in the cookie flag.\nThe hack I ended up adopting to get around the problem was to use a regexp to\nfilter out the http:// prefix. What ends up happening under the old way is that\nthere is no cookie set on the browser. In the rewrite log below, notice that the\nsetting cookie line has a mangled Set-Cookie HTTP header. It seems like Apache\nis interpreting the colon in http:// as the field delimiter, which it should not\ndo. With the RewriteCond line in the new way (the hack), I strip out the http://\nprefix, and that causes it to work.\n\n64.52.119.227 - - [20/Oct/2004:21:34:52 --0500]\n[www.microoffice.us/sid#95bd398][rid#9689598/initial] (3) [per-dir\n/home/microoffice/www/public_html/] strip per-dir prefix:\n/home/microoffice/www/public_html/voice -> voice\n64.52.119.227 - - [20/Oct/2004:21:34:52 --0500]\n[www.microoffice.us/sid#95bd398][rid#9689598/initial] (3) [per-dir\n/home/microoffice/www/public_html/] applying pattern '^([a-zA-Z0-9]+)$' to uri\n'voice'\n64.52.119.227 - - [20/Oct/2004:21:34:52 --0500]\n[www.microoffice.us/sid#95bd398][rid#9689598/initial] (4) RewriteCond:\ninput='/home/microoffice/www/public_html/vanity_url/voice.html' pattern='-s' =>\nmatched\n64.52.119.227 - - [20/Oct/2004:21:34:52 --0500]\n[www.microoffice.us/sid#95bd398][rid#9689598/initial] (2) [per-dir\n/home/microoffice/www/public_html/] rewrite voice -> vanity_url/voice.html\n64.52.119.227 - - [20/Oct/2004:21:34:52 --0500]\n[www.microoffice.us/sid#95bd398][rid#9689598/initial] (5) setting cookie\n'microoffice_original_referrer_url=http; path=/;\ndomain=//wynand.microoffice.us/~wchao/test/test.html; expires=Thu, 21-Oct-2004\n02:34:52 GMT'\n64.52.119.227 - - [20/Oct/2004:21:34:52 --0500]\n[www.microoffice.us/sid#95bd398][rid#9689598/initial] (3) [per-dir\n/home/microoffice/www/public_html/] add per-dir prefix: vanity_url/voice.html ->\n/home/microoffice/www/public_html/vanity_url/voice.html\n64.52.119.227 - - [20/Oct/2004:21:34:52 --0500]\n[www.microoffice.us/sid#95bd398][rid#9689598/initial] (2) [per-dir\n/home/microoffice/www/public_html/] trying to replace prefix\n/home/microoffice/www/public_html/ with /\n64.52.119.227 - - [20/Oct/2004:21:34:52 --0500]\n[www.microoffice.us/sid#95bd398][rid#9689598/initial] (5) strip matching prefix:\n/home/microoffice/www/public_html/vanity_url/voice.html -> vanity_url/voice.html\n64.52.119.227 - - [20/Oct/2004:21:34:52 --0500]\n[www.microoffice.us/sid#95bd398][rid#9689598/initial] (4) add subst prefix:\nvanity_url/voice.html -> /vanity_url/voice.html\n64.52.119.227 - - [20/Oct/2004:21:34:52 --0500]\n[www.microoffice.us/sid#95bd398][rid#9689598/initial] (1) [per-dir\n/home/microoffice/www/public_html/] internal redirect with\n/vanity_url/voice.html [INTERNAL REDIRECT]\n64.52.119.227 - - [20/Oct/2004:21:34:52 --0500]\n[www.microoffice.us/sid#95bd398][rid#968d730/initial/redir#1] (3) [per-dir\n/home/microoffice/www/public_html/] strip per-dir prefix:\n/home/microoffice/www/public_html/vanity_url/voice.html -> vanity_url/voice.html\n64.52.119.227 - - [20/Oct/2004:21:34:52 --0500]\n[www.microoffice.us/sid#95bd398][rid#968d730/initial/redir#1] (3) [per-dir\n/home/microoffice/www/public_html/] applying pattern '^([a-zA-Z0-9]+)$' to uri\n'vanity_url/voice.html'\n64.52.119.227 - - [20/Oct/2004:21:34:52 --0500]\n[www.microoffice.us/sid#95bd398][rid#968d730/initial/redir#1] (3) [per-dir\n/home/microoffice/www/public_html/] strip per-dir prefix:\n/home/microoffice/www/public_html/vanity_url/voice.html -> vanity_url/voice.html\n64.52.119.227 - - [20/Oct/2004:21:34:52 --0500]\n[www.microoffice.us/sid#95bd398][rid#968d730/initial/redir#1] (3) [per-dir\n/home/microoffice/www/public_html/] applying pattern '^([a-zA-Z0-9]+)$' to uri\n'vanity_url/voice.html'\n64.52.119.227 - - [20/Oct/2004:21:34:52 --0500]\n[www.microoffice.us/sid#95bd398][rid#968d730/initial/redir#1] (1) [per-dir\n/home/microoffice/www/public_html/] pass through\n/home/microoffice/www/public_html/vanity_url/voice.html\n"}, {"count": 6, "tags": [], "text": "No activity in over 4 years.  Original reporter found a work-around.  Closing the bug report; it can be re-opened if need be.", "is_private": false, "id": 127289, "creator": "poirier@pobox.com", "time": "2009-05-22T07:58:58Z", "bug_id": 31781, "creation_time": "2009-05-22T07:58:58Z", "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 31781, "is_private": false, "text": "Marking as duplicate of #47241 which contains a proposed patch.\n\n*** This bug has been marked as a duplicate of bug 47241 ***", "id": 127729, "time": "2009-06-07T23:58:12Z", "creator": "jonathan@phillipoux.net", "creation_time": "2009-06-07T23:58:12Z", "attachment_id": null}]