[{"count": 0, "tags": [], "creator": "joe.stepowski@gmail.com", "text": "Upgraded from Spring Boot v1.3.6 to v.1.4.0, which in turn upgraded the embedded tomcat container from 8.0.36 to 8.5.4.\n\nWe are now seeing a bunch of the following exceptions after the app has been running for a number of hours:\n\n2016-08-24 00:00:03.129 ERROR 15154 --- [https-jsse-nio-172.30.72.54-30020-Acceptor-0] [] org.apache.tomcat.util.net.NioEndpoint   : Socket accept failed\n\njava.io.IOException: Too many open files\n        at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)\n        at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422)\n        at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250)\n        at org.apache.tomcat.util.net.NioEndpoint$Acceptor.run(NioEndpoint.java:457)\n        at java.lang.Thread.run(Thread.java:745)\n\nRunning lsof for the Spring Boot pid shows thousands of entries like the following:\n\njava    9694 xxx 1251u  sock                0,6       0t0 6636870 can't identify protocol\n\nDowngrading to embedded tomcat 8.0.36 (whilst remaining on Spring Boot 1.4.0) fixes the issue.", "id": 193290, "time": "2016-08-24T01:30:44Z", "bug_id": 60035, "creation_time": "2016-08-24T01:30:44Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 60035, "attachment_id": null, "is_private": false, "id": 193315, "time": "2016-08-24T15:15:44Z", "creator": "markt@apache.org", "creation_time": "2016-08-24T15:15:44Z", "text": "I'm starting to look at this. I've already found and fixed an unrelated file descriptor leak and I can see a couple more places where fixes might be required. However, I haven't - yet - seen anything that looks like the leak described in this report.\n\nAny information on how to reproduce it would be very helpful. For example, does it require HTTPS, WebSocket, Servlet 3.0 Async or Servlet 3.1 non-blocking? A test case that generates the leak would be even better."}, {"count": 2, "tags": [], "bug_id": 60035, "is_private": false, "text": "Hi Mark\n\nI have been able to pinpoint that the issue started with 8.5.3.  8.5.2 seems to be ok.  \n\nI can see from the 8.5.3 changlog at least one change around sockets: \"Fix a cause of multiple attempts to close the same socket\"\n\nI downloaded, built and deployed the sample Spring Boot app from one of the tutorials.  Couldn't reproduce the issue, even with 8.5.4, although the app is pretty \"dumb\":\nhttps://spring.io/guides/gs/spring-boot/\nhttps://github.com/spring-guides/gs-spring-boot/archive/master.zip \n\nUsers connect to our app over https, and our app connects to ldap over http and other webservices over https.  No WebSocket, Servlet 3.0 Async or Servlet 3.1 non-blocking.\n\nCheers\nJoe", "id": 193317, "time": "2016-08-25T05:44:47Z", "creator": "joe.stepowski@gmail.com", "creation_time": "2016-08-25T05:44:47Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 193331, "time": "2016-08-25T19:37:18Z", "bug_id": 60035, "creation_time": "2016-08-25T19:37:18Z", "is_private": false, "text": "Thanks for tracking down which version this appeared in. I'll take a look at the diff between the two tags. I agree that the change you highlight is a good place to start."}, {"count": 4, "tags": [], "bug_id": 60035, "is_private": false, "text": "I've reviewed the changes and I don't see anything problematic yet. There is what looks like a single fd leak on first use that I want to track down but that is unlikely to be related to this issue.\n\nGiven that you were able to test 8.5.2 and 8.5.3 that suggests you have a way of reproducing this. Can you share that?", "id": 193340, "time": "2016-08-26T07:48:05Z", "creator": "markt@apache.org", "creation_time": "2016-08-26T07:48:05Z", "attachment_id": null}, {"count": 5, "text": "I think I have been able to reproduce this:\n\n- Run Tomcat on machine 1\n- Run abs test on machine 2\n- Disable network on machine 1\n\nOften, but not always, this leaves sockets open. I've searched through the commits to figure out when was introduced and have narrowed it down to this commit:\nhttp://svn.apache.org/viewvc?view=revision&revision=1746551\n\nNext up is figuring out why and fixing it.", "bug_id": 60035, "attachment_id": null, "id": 193346, "time": "2016-08-26T13:18:50Z", "creator": "markt@apache.org", "creation_time": "2016-08-26T13:18:50Z", "tags": [], "is_private": false}, {"count": 6, "tags": [], "bug_id": 60035, "attachment_id": null, "text": "Good news. I've figured out the root cause and there will be a fix in the next release.\n\nIndirectly, r1746551 was the issue.\n\nThe problem occurs for TLS connections when the connection is dropped after the socket has been accepted but before the handshake is complete. The socket ended up in a loop:\n- timeout -> ERROR event\n- process ERROR (this is the new bit from r1746551)\n- try to finish handshake\n- need more data from client\n- register with poller for READ\n- wait for timeout\n- timeout ...\n\n... and around you go.", "id": 193349, "time": "2016-08-26T16:53:17Z", "creator": "markt@apache.org", "creation_time": "2016-08-26T16:53:17Z", "is_private": false}, {"count": 7, "tags": [], "creator": "markt@apache.org", "text": "This has been fixed in the following branches:\n- 9.0.x for 9.0.0.M10 onwards\n- 8.5.x for 8.5.5 onwards\n\n8.0.x and earlier were not affected.", "id": 193350, "time": "2016-08-26T18:21:46Z", "bug_id": 60035, "creation_time": "2016-08-26T18:21:46Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "marcus.hughes@cua.com.au", "text": "Hi Mark, Apologies Joe went quiet - but he left the company. Thanks for looking into this, it kind of brought down all the servers we deployed the upgrade onto so was pretty serious for us. What you have identified sounds a very likely candidate.\n\nWe'll update our tomcat jars and let you know how we go. Thanks again.", "id": 193558, "time": "2016-09-08T01:34:06Z", "bug_id": 60035, "creation_time": "2016-09-08T01:34:06Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "creator": "marcus.hughes@cua.com.au", "text": "All indications are that this fixed our issues. Thanks again.", "id": 193667, "time": "2016-09-13T05:13:02Z", "bug_id": 60035, "creation_time": "2016-09-13T05:13:02Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 60035, "is_private": false, "text": "Thanks for confirming the fix.", "id": 193671, "time": "2016-09-13T08:14:00Z", "creator": "markt@apache.org", "creation_time": "2016-09-13T08:14:00Z", "attachment_id": null}, {"count": 11, "text": "*** Bug 60555 has been marked as a duplicate of this bug. ***", "bug_id": 60035, "is_private": false, "id": 195884, "time": "2017-01-05T20:37:36Z", "creator": "markt@apache.org", "creation_time": "2017-01-05T20:37:36Z", "tags": [], "attachment_id": null}, {"count": 12, "tags": [], "creator": "vbhandari@vmware.com", "attachment_id": null, "id": 200199, "time": "2017-08-04T20:47:37Z", "bug_id": 60035, "creation_time": "2017-08-04T20:47:37Z", "is_private": false, "text": "(In reply to Mark Thomas from comment #7)\n> This has been fixed in the following branches:\n> - 9.0.x for 9.0.0.M10 onwards\n> - 8.5.x for 8.5.5 onwards\n> \n> 8.0.x and earlier were not affected.\n\nAs mentioned in https://bz.apache.org/bugzilla/show_bug.cgi?id=60555#c4 this bug effects the 7.0 line as well. Can you please check and confirm based on @hiki's comments in 60555."}]