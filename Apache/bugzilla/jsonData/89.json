[{"count": 0, "tags": [], "bug_id": 89, "text": "Using apache1.3.12, tomcat3.1\r\n\r\nmod_jserv + Tomcat do not deal properly with rewritten URIs. \r\nWith this mount point:\r\n\tApJServMount /wdlcontext  ajpv12://localhost:8008/wdlcontext1.4.0\r\nthis request:\r\n\t/wdlcontext/wdlInstall?blabla\r\nwill fail because tomcat will only use the original URI passed by mod_jserv\r\ninstead of using the context set by mod_jserv. \r\n\r\nThis is very problematic when using mod_rewrite.\r\n\r\nA patch-candidate for Ajp12ConnectionHandler.java is at the end. \r\nCould somebody please review it?\r\n\r\nthanks.\r\n\r\njpa\r\n\r\n\r\n==== debug message before the fix ===========\r\n==> /local/jakarta-tomcat/logs/tomcat.log <==\r\nAJP: CP=wdlcontext1.4.0\r\nAJP: context=null\r\nAJP: servlet=wdlInstall\r\nAJP: serverName=dev.phoenixnet.com\r\nAJP: PI=null\r\nAJP: PT=null\r\nAJP: QS=null\r\nAJP: RA=134.122.3.102\r\nAJP: RH=\r\nAJP: RU=null\r\nAJP: AT=null\r\nAJP: Meth=GET\r\nAJP: URI: /wdlcontext/wdlInstall CP:wdlcontext1.4.0 LP: null\r\nAJP: URI: /wdlcontext/wdlInstall CP:wdlcontext1.4.0 LP: null\r\nAJP: serverName=jabgrall2\r\nAJP: Server jvmRoute=null\r\nRequest: /wdlcontext/wdlInstall\r\nQuery: null\r\nProcessRequest: R( /wdlcontext/wdlInstall)\r\n\r\n==== debug message after the fix ============\r\n==> /local/jakarta-tomcat/logs/tomcat.log <==\r\nAJP: CP=wdlcontext1.4.0\r\nAJP: context=Ctx(/wdlcontext1.4.0,/local/ebetween/contexts/wdlcontext1.4.0)\r\nAJP: servlet=wdlInstall\r\nAJP: serverName=dev.phoenixnet.com\r\nAJP: PI=null\r\nAJP: PT=null\r\nAJP: QS=null\r\nAJP: RA=134.122.3.102\r\nAJP: RH=\r\nAJP: RU=null\r\nAJP: AT=null\r\nAJP: Meth=GET\r\nAJP: URI: /wdlcontext/wdlInstall CP:wdlcontext1.4.0 LP: null\r\nAJP: URI: /wdlcontext/wdlInstall CP:wdlcontext1.4.0 LP: /wdlInstall\r\nAJP: serverName=jabgrall2\r\nAJP: Server jvmRoute=null\r\nRequest: /wdlcontext/wdlInstall\r\nQuery: null\r\nProcessRequest: R( /wdlcontext1.4.0 + /wdlInstall)\r\nAfter processing: R( /wdlcontext1.4.0 + /wdlInstall + null)\r\n\r\n\r\n======== PATCH FOR AJPV12 context lookup fix =========\r\n--- Ajp12ConnectionHandler.java Thu Apr  6 19:11:36 2000\r\n+++ Ajp12ConnectionHandler.java.fix     Sat Aug 12 22:30:36 2000\r\n@@ -224,6 +224,16 @@\r\n                    \r\n                    if( contextPath!= null )\r\n                        context=contextM.getContext( contextPath );\r\n+                   /* \r\n+                    * XXX jpa:200008122227\r\n+                    * With this mount:\r\n+                    *    ApJServMount /wdlcontext1.4.0\r\najpv12://localhost:8008/wdlcontext1.4.0\r\n+                    * mod_jserv will return 'wdlcontext1.4.0' as the\r\nmountpoint (=context)\r\n+                    *  instead of '/wdlcontext1.4.0'\r\n+                    * So let's try to fix it by adding the \r\n+                    */\r\n+                   if( context == null )\r\n+                       context=contextM.getContext( \"/\" + contextPath ); \r\n                    if( doLog ) log(\"AJP: context=\" + context );\r\n                    \r\n                    servletName = ajpin.readString(null);         //Servlet\r\n@@ -264,10 +274,25 @@\r\n                    requestURI = ajpin.readString(\"\");             //request\r\nuri\r\n                    if( doLog ) log(\"AJP: URI: \" + requestURI + \" CP:\" +\r\ncontextPath + \" LP: \" + lookupPath);\r\n \r\n-                   // XXX don't set lookup path - problems with URL\r\nrewriting.\r\n-                   // need to be fixed.\r\n-                   //          if(contextPath!=null && contextPath.length()\r\n>0 )\r\n-                   //              lookupPath=requestURI.substring(\r\ncontextPath.length() + 1 );\r\n+                   /* \r\n+                    * XXX jpa:200008122227\r\n+                    * With this rewrite rule: \r\n+                    *  RewriteRule ^(.*)/wdlzone/wdlInstall\r\n$1/wdlcontext1.4.0/wdlInstall [PT]\r\n+                    * and this mount point:\r\n+                    *  ApJServMount /wdlcontext1.4.0\r\najpv12://localhost:8008/wdlcontext1.4.0\r\n+                    * and this context\r\n+                    *    <Context path = \"/wdlcontext1.4.0\" docBase = \"....\r\n+                    * and this request\r\n+                    *    /wdlzone/wdlInstall?blabla\r\n+                    * The contextPath (after the above '/' fixup) is\r\n'/wdlcontext1.4.0'\r\n+                    *  and the uri is '/wdlzone/wdlInstall' \r\n+                    * the servlet name is 'wdlInstall'\r\n+                    * So the lookupPath is is based on the position of the\r\nservlet name.\r\n+                    * Prior to the following fix, zones and contexts in\r\nmounting points were\r\n+                    *  irrelevant. Only the original uri was then used by\r\ntomcat.\r\n+                    */\r\n+                   if(contextPath!=null && contextPath.length() >0 )\r\n+                       lookupPath=requestURI.substring(\r\nrequestURI.indexOf(servletName)-1 );\r\n                    if( doLog ) log(\"AJP: URI: \" + requestURI + \" CP:\" +\r\ncontextPath + \" LP: \" + lookupPath);\r\n                    \r\n                    dummy = ajpin.readString(null);\r\n//script filename\r\n\r\n\r\n---------------------------------------------------------------------\r\n", "id": 69, "time": "2000-09-01T19:28:20Z", "creator": "dev@tomcat.apache.org", "creation_time": "2000-09-01T19:28:20Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "cmanolache@yahoo.com", "attachment_id": null, "is_private": false, "id": 4851, "time": "2001-08-25T16:45:28Z", "bug_id": 89, "creation_time": "2001-08-25T16:45:28Z", "text": "Sorry, this is a tricky one - I'm not sure we can support it from many reasons,\nincluding the spec ( which require the 'original' URI - and all rewriting \nhappens on the unescaped uri ), and because it can mess so many other things.\n\nIn a future version we may try to find a good solution, but for now I don't\nthink this can go in."}]