[{"count": 0, "tags": [], "text": "The problem seems to relate to parsing the body content when the **Transfer-\nEncoding: chunked** header is present.  It appears that the chunk length gets\ncorrupted under load and the client is unable to parse the chunk out of the \nresponse body.\n\nWhen the NIO connector parameter **socket.appWriteBufSize** is set to a value \nlarger than the total response body, the error condition does not occur.\n\nOne might succesfully argue that this is proper performance tuning.  The Tomcat \ndocuments point out that to scale a large number of long held connections, the \nbuffer sizes may need to be less than the response body (the memory footprint \nwould be quite large otherwise).\n\nCould there be a race condition involving the response buffering code?  \n\nI have confirmed this behavior on both JDKs 1.5 and 1.6 on both Windows 2003 \nand Linux.\n\nApache Bench does not appear to fully parse the response so it will not be \nhelpful in reproducing the issue.   The Grinder framework does.  I am including \nthe Grinder scripts so that the issue may be reproduced.", "is_private": false, "id": 110435, "creator": "guy.molinari@dig.com", "time": "2007-11-12T09:08:54Z", "bug_id": 43846, "creation_time": "2007-11-12T09:08:54Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 43846, "attachment_id": 21114, "is_private": false, "id": 110437, "time": "2007-11-12T09:14:10Z", "creator": "guy.molinari@dig.com", "creation_time": "2007-11-12T09:14:10Z", "text": "Created attachment 21114\nJython/Grinder script\n\nJython script referenced from grinder properties file.\t This script does most\nof the interaction with the Tomcat server.  It is configured via a grinder\nproperties file."}, {"count": 2, "tags": [], "bug_id": 43846, "attachment_id": 21115, "is_private": false, "id": 110438, "time": "2007-11-12T09:16:30Z", "creator": "guy.molinari@dig.com", "creation_time": "2007-11-12T09:16:30Z", "text": "Created attachment 21115\nGrinder properties file\n\nUse this file as a starting point for your Grinder setup.  This defines the\nnumber of threads, etc. to configure the test client."}, {"count": 3, "tags": [], "bug_id": 43846, "attachment_id": 21116, "is_private": false, "id": 110439, "time": "2007-11-12T09:20:56Z", "creator": "guy.molinari@dig.com", "creation_time": "2007-11-12T09:20:56Z", "text": "Created attachment 21116\nReponse generator servlet\n\nThis is a very simple Java servlet.  It generates a reponse body >8K.  This\nsomewhat larger response seems to render with Transfer-Encoding: chunked rather\nthan a Content-Length header.  This is what we want because the smaller\nresponse bodies seem to work OK.  In the real world responses larger than 8K\nare the norm."}, {"count": 4, "tags": [], "bug_id": 43846, "text": "Thank you, I will take a look.\nFilip", "id": 110440, "time": "2007-11-12T10:53:05Z", "creator": "fhanik@apache.org", "creation_time": "2007-11-12T10:53:05Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "text": "I'm unable to get your grinder scripts to work.\nThere are several errors that happen, for one, random is not available on a\nclean download of grinder.\n\nwhat would be helpful, is if you could create a test case, that I can run\nwithout trying to figure out grinder (sorry I'm a newbie to this) for most of a day.\n\nthanks\nFilip", "is_private": false, "id": 110493, "creator": "fhanik@apache.org", "time": "2007-11-13T11:41:23Z", "bug_id": 43846, "creation_time": "2007-11-13T11:41:23Z", "attachment_id": null}, {"count": 6, "tags": [], "text": "Created attachment 21123\nUse this Jython script instead\n\nUse this script instead of the first one attached.   Sorry for the trouble\nFilip.", "is_private": false, "id": 110494, "creator": "guy.molinari@dig.com", "time": "2007-11-13T11:46:35Z", "bug_id": 43846, "creation_time": "2007-11-13T11:46:35Z", "attachment_id": 21123}, {"count": 7, "tags": [], "bug_id": 43846, "text": "My apolgies Filip.   I've attached an updated Jython script.  This one does not \ndepend on random.", "id": 110495, "time": "2007-11-13T11:49:21Z", "creator": "guy.molinari@dig.com", "creation_time": "2007-11-13T11:49:21Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "fhanik@apache.org", "is_private": false, "text": "I'm able to reproduce the problem in the connector using a JMeter script.\nThe error doesn't exist in the previous trunk connector, now in sandbox\nhttp://svn.apache.org/viewvc/tomcat/sandbox/gdev6x/\n\nThere are features in that branch not present in current release. I will look\ninto the option of porting the NIO enhancements from that branch to 6.0.x\n\nFilip", "id": 110502, "time": "2007-11-13T14:00:46Z", "bug_id": 43846, "creation_time": "2007-11-13T14:00:46Z", "attachment_id": null}, {"count": 9, "tags": [], "creator": "fhanik@apache.org", "is_private": false, "text": "I've created a patch for 6.0.x branch (a port from the sandbox)\nhttp://people.apache.org/~fhanik/patches/apache-tomcat-6.0.x-niofix.zip\n\nfeel free to try it out, and let me know the feedback\n\nFilip", "id": 110505, "time": "2007-11-13T15:28:13Z", "bug_id": 43846, "creation_time": "2007-11-13T15:28:13Z", "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 43846, "attachment_id": null, "is_private": false, "id": 110539, "time": "2007-11-14T12:10:26Z", "creator": "guy.molinari@dig.com", "creation_time": "2007-11-14T12:10:26Z", "text": "I've run a series of tests of various kinds and it appears that this issue is \nfixed in the patched version.   Would this fix going into a 6.0.15 release?"}, {"count": 11, "attachment_id": null, "bug_id": 43846, "text": "Patch has been added to 6.0.x and will go out with 6.0.16 next release.\nThanks for the feedback.\n", "id": 110746, "time": "2007-11-19T20:19:58Z", "creator": "fhanik@apache.org", "creation_time": "2007-11-19T20:19:58Z", "tags": [], "is_private": false}]