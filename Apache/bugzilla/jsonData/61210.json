[{"count": 0, "tags": [], "text": "I noticed that when using the Security Manager in Tomcat you always see the following warning messages on startup (one for every application that's deployed):\n\n~~~\nWARNING [localhost-startStop-1] org.apache.juli.ClassLoaderLogManager.readConfiguration Reading /apache-tomcat-8.5.15/webapps/ROOT/WEB-INF/classes/logging.properties is not permitted. See \"per context logging\" in the default catalina.policy file.\nWARNING [localhost-startStop-1] org.apache.juli.ClassLoaderLogManager.readConfiguration Reading /apache-tomcat-8.5.15/webapps/examples/WEB-INF/classes/logging.properties is not permitted. See \"per context logging\" in the default catalina.policy file.\nWARNING [localhost-startStop-1] org.apache.juli.ClassLoaderLogManager.readConfiguration Reading /apache-tomcat-8.5.15/webapps/docs/WEB-INF/classes/logging.properties is not permitted. See \"per context logging\" in the default catalina.policy file.\n~~~\n\nWhile the message is technically accurate (reading the file is prohibited), it isn't pertinent to the user because the file may not (doesn't in this case) exist in any of these three applications. Is it possible to check that the file exists at this point so that we can only print the message when it's present? Do so would remove an extra warning (that may not be applicable) from the log file and give users a clean vanilla log to start with.", "is_private": false, "id": 199342, "creator": "csutherl@apache.org", "time": "2017-06-22T21:25:37Z", "bug_id": 61210, "creation_time": "2017-06-22T21:25:37Z", "attachment_id": null}, {"count": 1, "tags": [], "text": "1. From your logs, you are running Tomcat 8.5.15. I am changing the Version field to match that.\n\n2. Generally, this is a feature.\nThe message text tells one to look into the catalina.policy file,\nand there is a comment there that explains the issue. \n\n\"// Note: To enable per context logging configuration\" ...\n\nhttps://svn.apache.org/viewvc/tomcat/tc8.5.x/tags/TOMCAT_8_5_15/conf/catalina.policy?view=markup#l93\n\n\nAny ideas how to improve users' experience here?\n\nAllowing to read some random logging.properties files is not an option,\nas it is insecure.\n\n\n\n\n- An idea:\nAdd an explanation of this issue to Documentation and change message text to tell users to read that documentation page as well.\n\nhttp://tomcat.apache.org/tomcat-8.5-doc/security-manager-howto.html", "is_private": false, "id": 199346, "creator": "knst.kolinko@gmail.com", "time": "2017-06-22T22:29:53Z", "bug_id": 61210, "creation_time": "2017-06-22T22:29:53Z", "attachment_id": null}, {"count": 2, "tags": [], "text": "I was thinking add a privileged block that tested if the file existed and don't trigger the warning if it doesn't. Note I haven't dug into the code to see hwo easy this would be yet.", "is_private": false, "id": 199348, "creator": "markt@apache.org", "time": "2017-06-22T23:02:56Z", "bug_id": 61210, "creation_time": "2017-06-22T23:02:56Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "csutherl@apache.org", "attachment_id": null, "id": 199360, "time": "2017-06-23T12:02:23Z", "bug_id": 61210, "creation_time": "2017-06-23T12:02:23Z", "is_private": false, "text": "(In reply to Konstantin Kolinko from comment #1)\n> 1. From your logs, you are running Tomcat 8.5.15. I am changing the Version\n> field to match that.\n\nI tested with 8.5.x too, apparently I copied the wrong logs.\n\n> 2. Generally, this is a feature.\n> The message text tells one to look into the catalina.policy file,\n> and there is a comment there that explains the issue. \n\nLike I said, the message is accurate however the file that it's warning about doesn't exist. This could cause users to see a warning in the log file that needs to be fixed when in fact there is no problem. \n> \n> Any ideas how to improve users' experience here?\n> \n> Allowing to read some random logging.properties files is not an option,\n> as it is insecure.\n\nI'm not sure what you're after here. I don't want anyone to be able to read the file :) I want the warning message to be conditional based on whether or not the file actually exists."}, {"count": 4, "attachment_id": null, "bug_id": 61210, "is_private": false, "id": 199361, "time": "2017-06-23T12:04:05Z", "creator": "csutherl@apache.org", "creation_time": "2017-06-23T12:04:05Z", "tags": [], "text": "(In reply to Mark Thomas from comment #2)\n> I was thinking add a privileged block that tested if the file existed and\n> don't trigger the warning if it doesn't. Note I haven't dug into the code to\n> see hwo easy this would be yet.\n\n+1, that's what I was hoping for. I haven't played much with privileged blocks, but I can try and mock up a quick patch to do that."}, {"count": 5, "tags": [], "bug_id": 61210, "attachment_id": 35077, "is_private": false, "id": 199437, "time": "2017-06-26T17:21:22Z", "creator": "csutherl@apache.org", "creation_time": "2017-06-26T17:21:22Z", "text": "Created attachment 35077\nFirst attempt\n\nHere's my first attempt at checking whether or not the file exists before logging. The problem with this is that the privileged block is still failing checkPermission. I'm not quite sure how to fix it as I modeled my change after some other doPrivileged calls in the same class. The only difference is that I'm returning a value to check later in the readConfiguration method instead of Void. Can anyone point me in the right direction?"}, {"count": 6, "tags": [], "bug_id": 61210, "attachment_id": null, "id": 199439, "time": "2017-06-26T18:28:27Z", "creator": "markt@apache.org", "creation_time": "2017-06-26T18:28:27Z", "is_private": false, "text": "It fails because the call originates in JULI and JULI doesn't have permissions to read the file. All the Privileged block does is stop the security manager also checking that all of the callers up the stack also have permission to read the file.\n\nAn alternative approach will be required."}, {"count": 7, "attachment_id": null, "bug_id": 61210, "is_private": false, "id": 199440, "time": "2017-06-26T19:39:35Z", "creator": "markt@apache.org", "creation_time": "2017-06-26T19:39:35Z", "tags": [], "text": "There is a way to do this.\n\nHint: Take a look at org.apache.juli.WebappProperties and how it is used."}, {"count": 8, "tags": [], "bug_id": 61210, "attachment_id": null, "id": 199585, "time": "2017-07-05T16:50:51Z", "creator": "markt@apache.org", "creation_time": "2017-07-05T16:50:51Z", "is_private": false, "text": "Coty, I have a patch for this but I thought you might want to figure this out for yourself. If you want another hint (or just want me to apply my patch), let me know."}, {"count": 9, "tags": [], "bug_id": 61210, "attachment_id": null, "id": 199588, "time": "2017-07-05T17:31:49Z", "creator": "csutherl@apache.org", "creation_time": "2017-07-05T17:31:49Z", "is_private": false, "text": "I've been meaning to circle back to this (and a few others...) but haven't been able to make time just yet. I do recall being a bit confused by your last hint because I couldn't see the correlation between how WebappProperties was used and what I should be doing. Care to drop another hint? If you want to push the patch you have ready, you can commit it and I'll just review what you did and maybe do something similar next time :)"}, {"count": 10, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "A slightly bigger hint:\n\nJULI cannot have any external dependencies.\nThe \"Does this file exist?\" test needs to happen in a privileged block.\nThat privileged block needs to be located in a class in a JAR that has full privs (i.e. CATALINA_BASE/lib).\nYou need a way to call into a that class from JULI.", "id": 199589, "time": "2017-07-05T17:40:22Z", "bug_id": 61210, "creation_time": "2017-07-05T17:40:22Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 61210, "attachment_id": null, "id": 200392, "time": "2017-08-21T09:53:45Z", "creator": "markt@apache.org", "creation_time": "2017-08-21T09:53:45Z", "is_private": false, "text": "It has been a while so I've applied my patch for this.\n\nFixed in:\n- trunk for 9.0.0.M27 onwards\n- 8.5.x for 8.5.21 onwards\n- 8.0.x for 8.0.47 onwards"}]