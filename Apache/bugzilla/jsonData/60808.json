[{"count": 0, "tags": [], "text": "A corner case was discovered: if request.getParameterMap().keySet().retainAll(set) is called even after the internal ParameterMap is locked.\n\nReproducible step:\n- Create a simple JSP page like this:\n<%\n// test.jsp\nout.println(\"request.getParameterMap(): \" + request.getParameterMap());\nrequest.getParameterMap().keySet().retainAll(java.util.Collections.emptySet());\nout.println(\"request.getParameterMap(): \" + request.getParameterMap());\n%>\n- Request the page. e.g, http://localhost:8080/examples/test.jsp?p1=v1&p2=v2\n- You will notice the second output is empty.\n\nAccording to the javadoc of javax.servlet.ServletRequest#getParameterMap(), the returned map must be immutable. But, its #keySet() seems to return a mutable set. It could have returned an unmodifiable set at least like Collections.unmodifiableMap(map) does.", "is_private": false, "bug_id": 60808, "id": 197410, "time": "2017-03-03T00:49:00Z", "creator": "woonsan@apache.org", "creation_time": "2017-03-03T00:49:00Z", "attachment_id": null}, {"count": 1, "text": "Patch available via PR: https://github.com/apache/tomcat/pull/46\nPlease review the PR.\n\nThanks,\n\nWoonsan", "bug_id": 60808, "attachment_id": null, "id": 197415, "time": "2017-03-03T07:14:30Z", "creator": "woonsan@apache.org", "creation_time": "2017-03-03T07:14:30Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "text": "Generally, I think it would be safer (in terms of future additions to Map and changes to the implementation of LinkedHashMap) and probably require less code if ParameterMap used composition rather than extension.", "attachment_id": null, "bug_id": 60808, "id": 197418, "time": "2017-03-03T11:23:53Z", "creator": "markt@apache.org", "creation_time": "2017-03-03T11:23:53Z", "is_private": false}, {"count": 3, "tags": [], "creator": "woonsan@apache.org", "is_private": false, "id": 197434, "attachment_id": null, "bug_id": 60808, "creation_time": "2017-03-03T16:32:43Z", "time": "2017-03-03T16:32:43Z", "text": "Hi Mark,\n\nYes, that makes more sense to use containment instead of extending. Even if newer JVM has more new API support in the future, ParameterMap implementing j.u.Map with a contained delegate map should be a lot safer in any case.\nI'll create a new pull request using containment soon and update it here.\n\nRegards,\n\nWoonsan"}, {"count": 4, "tags": [], "text": "I've created a new PR: https://github.com/apache/tomcat/pull/47,\nfollowing Mark's suggestion to use containment instead of inheritance.\nIndeed, it helps reduce code size and safer in the future changes in JVM.\n\nPlease take a review.", "is_private": false, "bug_id": 60808, "id": 197437, "time": "2017-03-03T18:49:13Z", "creator": "woonsan@apache.org", "creation_time": "2017-03-03T18:49:13Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 60808, "is_private": false, "text": "Thanks for the report and the patch. I took the opportunity to do some additional clean-up at the same time - particularly of the Javadoc.\n\nFixed in:\n- trunk for 9.0.0.M18 onwards\n- 8.5.x for 8.5.12 onwards\n- 8.0.x for 8.0.42 onwards\n- 7.0.x for 7.0.76 onwards", "id": 197482, "time": "2017-03-06T15:38:03Z", "creator": "markt@apache.org", "creation_time": "2017-03-06T15:38:03Z", "attachment_id": null}]