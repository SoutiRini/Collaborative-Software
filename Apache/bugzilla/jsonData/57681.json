[{"count": 0, "tags": [], "bug_id": 57681, "text": "Created attachment 32553\nParallel classloading port from Tc8.0 into Tc7.0\n\nRelated to fix in Tomcat8.0:\nFix https://issues.apache.org/bugzilla/show_bug.cgi?id=56530\nAdd a web application class loader implementation that supports the parallel loading of web application classes.\n\nSource file to patch:\nhttps://svn.apache.org/viewvc/tomcat/tc7.0.x/trunk/java/org/apache/catalina/loader/WebappClassLoader.java?revision=1661811&view=markup", "id": 181617, "time": "2015-03-09T22:34:15Z", "creator": "koturano@amazon.com", "creation_time": "2015-03-09T22:34:15Z", "is_private": false, "attachment_id": 32553}, {"count": 1, "tags": [], "bug_id": 57681, "is_private": false, "text": "\n\n*** This bug has been marked as a duplicate of bug 56530 ***", "id": 181619, "time": "2015-03-09T22:37:24Z", "creator": "markt@apache.org", "creation_time": "2015-03-09T22:37:24Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 57681, "text": "And for the record the patch is nowhere close to correct.", "id": 181621, "time": "2015-03-09T22:38:15Z", "creator": "markt@apache.org", "creation_time": "2015-03-09T22:38:15Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "koturano@amazon.com", "text": "The fix in bug 56530 is for Tomcat 8, not Tomcat 7. Why my request is marked as resolved?", "id": 181622, "time": "2015-03-09T22:44:53Z", "bug_id": 57681, "creation_time": "2015-03-09T22:44:53Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 57681, "attachment_id": null, "id": 181623, "creation_time": "2015-03-09T22:46:42Z", "time": "2015-03-09T22:46:42Z", "creator": "markt@apache.org", "text": "Because we don't have separate Bugzilla entries for exactly the same issue in different versions of Tomcat.", "is_private": false}, {"count": 5, "tags": [], "bug_id": 57681, "attachment_id": 32554, "is_private": false, "id": 181638, "time": "2015-03-10T16:08:28Z", "creator": "koturano@amazon.com", "creation_time": "2015-03-10T16:08:28Z", "text": "Created attachment 32554\nPatch to work with JDK1.6"}, {"count": 6, "tags": [], "bug_id": 57681, "text": "Attachment 'Parallel classloading port from Tc8.0 into Tc7.0' was incomplete and should not be used, apologies for attaching a wrong diff.\n\n'Patch to work with JDK6' re-implements getClassLoadingLock() in WebappClassloader and turns serial WebappClassLoader into parallel.", "id": 181640, "time": "2015-03-10T16:12:28Z", "creator": "koturano@amazon.com", "creation_time": "2015-03-10T16:12:28Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 57681, "attachment_id": null, "text": "This patch is also wrong.\n\nTHe correct way to address this is described in bug 56530.", "id": 181647, "time": "2015-03-10T17:13:27Z", "creator": "markt@apache.org", "creation_time": "2015-03-10T17:13:27Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 57681, "attachment_id": 32554, "id": 181849, "creation_time": "2015-03-17T21:42:43Z", "time": "2015-03-17T21:42:43Z", "creator": "koturano@amazon.com", "text": "Comment on attachment 32554\nPatch to work with JDK1.6\n\n--- WebappClassLoader_r1661811.java\t2015-03-09 21:53:27.000000000 +0000\n+++ WebappClassLoader_patch.java\t2015-03-17 14:21:56.000000000 +0000\n@@ -1599,7 +1599,25 @@ public class WebappClassLoader\n      * @exception ClassNotFoundException if the class was not found\n      */\n     @Override\n-    public synchronized Class<?> loadClass(String name, boolean resolve)\n+    public Class<?> loadClass(String name, boolean resolve)\n+        throws ClassNotFoundException {\n+        // check local cache without entering the global synchronized block and return if the class is found\n+        if (resourceEntries.containsKey(name)) {\n+            Class<?> clazz = findLoadedClass0(name);\n+            if (clazz != null) {\n+                if (log.isDebugEnabled())\n+                    log.debug(\"  Returning class from cache\");\n+                if (resolve)\n+                    resolveClass(clazz);\n+                return (clazz);\n+            }\n+            \n+        }\n+        // class is not found in local cache - call the original synchronized method\n+        return loadClass0(name, resolve);\n+    }\n+\n+    private synchronized Class<?> loadClass0(String name, boolean resolve)\n         throws ClassNotFoundException {\n \n         if (log.isDebugEnabled())", "is_private": false}, {"count": 9, "tags": [], "bug_id": 57681, "attachment_id": 32584, "text": "Created attachment 32584\nLock free read for already loaded/cached classes", "id": 181850, "time": "2015-03-17T21:47:44Z", "creator": "koturano@amazon.com", "creation_time": "2015-03-17T21:47:44Z", "is_private": false}, {"count": 10, "tags": [], "creator": "markt@apache.org", "text": "(In reply to Alex Koturanov from comment #8)\n> Comment on attachment 32554 [details]\n> Patch to work with JDK1.6\n\nDoesn't implement parallel loading.\n\nCreates significant risk of a ConcurrentModificationException during the lock free read.\n\nIgnores the discussion in bug 56530.", "id": 181851, "time": "2015-03-17T22:01:48Z", "bug_id": 57681, "creation_time": "2015-03-17T22:01:48Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "bug_id": 57681, "attachment_id": 32927, "id": 184125, "creation_time": "2015-07-22T13:45:57Z", "time": "2015-07-22T13:45:57Z", "creator": "huxing.zhang@gmail.com", "text": "Created attachment 32927\nBack port parallel class loading to tomcat 7.\n\nHi Mark, Christopher, and Konstantin:\n\nI have back ported the parallel class loading feature to tomcat7. \n\nCould you please take some time to review this?\n\nThe basic idea here is:\n\n1. Keep WebappClassLoader as default which is serial class loading enabled, and one can configure to use ParallelWebappClassloader by specifying loaderClass in context.xml (just as in Tomcat8). If user specified to use ParallelWebappClassloader,  parallel class loading will only be enabled if tomcat is running on JRE7 or above.\n2. Call ClassLoader.registerAsParallelCapable() via reflection, so that jdk7 is still not required to build tomcat 7 core code.\n3. Call ClassLoader.getClassLoadingLock() via reflection to obtain a dedicated object lock if parallel class loading enabled, or return the WebappClassLoader object lock if not.\n4. Introduce JreCompat.getInstance().isJre7Supported() to determine whether tomcat is running on JRE7 (or above) or not.\n5. Remove StandardClassLoader as well as MBean registration in Bootstrap, since\n   1) it is deprecated\n   2) it can avoid adding JRECompat to Bootstrap class loader's classpath\n6. Add unit test to make sure parallel class loading is working as expected.", "is_private": false}, {"count": 12, "tags": [], "bug_id": 57681, "attachment_id": null, "id": 184176, "creation_time": "2015-07-27T02:30:15Z", "time": "2015-07-27T02:30:15Z", "creator": "huxing.zhang@gmail.com", "text": "Hi, Any update on this?", "is_private": false}, {"count": 13, "tags": [], "creator": "huxing.zhang@gmail.com", "text": "Is there anything else I can do to push it forward?\nThe patch respects the discussion in bug 56530.", "id": 184228, "time": "2015-07-30T01:51:51Z", "bug_id": 57681, "creation_time": "2015-07-30T01:51:51Z", "is_private": false, "attachment_id": null}, {"count": 14, "tags": [], "creator": "markt@apache.org", "is_private": false, "text": "Removing deprecated code is not an option since it may break existing code. That is why it was deprecated rather than deleted in the first place. The patch needs to be re-worked not to do this.\n\nI've started to add some of the external plumbing required by this feature so the patch should be a little smaller.", "id": 184958, "time": "2015-09-04T08:20:07Z", "bug_id": 57681, "creation_time": "2015-09-04T08:20:07Z", "attachment_id": null}, {"count": 15, "tags": [], "creator": "huxing.zhang@gmail.com", "attachment_id": null, "is_private": false, "id": 184962, "time": "2015-09-04T10:37:58Z", "bug_id": 57681, "creation_time": "2015-09-04T10:37:58Z", "text": "To make StandardClassLoader parallel capable, we can simply add JRECompact to the Bootstrap class loader's class path, and then apply the static initialization of WebappClassLoaderBase's to it.\nIf we don't want to JreCompat to be in the Bootstrap ClassLoader's class path, I think adding the following code should work for StandardClassLoader:\n\npublic class StandardClassLoader {\n    ...\n    static {\n        try {\n            // parallel class loading capable\n            final Method registerParallel =\n                    ClassLoader.class.getDeclaredMethod(\"registerAsParallelCapable\");\n            AccessController.doPrivileged(new PrivilegedAction<Object>() {\n                public Object run() {\n                    registerParallel.setAccessible(true);\n                    return null;\n                }\n            });\n            registerParallel.invoke(null);\n        } catch (NoSuchMethodException e) {\n            // expect java 6 or lower\n        } catch (Exception e) {\n            // ignore\n        }\n    }\n    ...\n}\n\nIf there is anything else I can help, please feel free to let me know."}, {"count": 16, "tags": [], "creator": "markt@apache.org", "text": "I opted for the simpler replacement of StandardClassLoader with URLClassLoader wherever the StandardClassLoader was used.", "id": 185036, "time": "2015-09-08T11:04:00Z", "bug_id": 57681, "creation_time": "2015-09-08T11:04:00Z", "is_private": false, "attachment_id": null}, {"count": 17, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 185039, "time": "2015-09-08T13:47:36Z", "bug_id": 57681, "creation_time": "2015-09-08T13:47:36Z", "text": "This has been fixed using a variation of this patch in 7.0.x for 7.0.65 onwards.\n\nMany thanks for the patch."}, {"count": 18, "tags": [], "bug_id": 57681, "attachment_id": null, "is_private": false, "id": 185040, "time": "2015-09-08T14:17:58Z", "creator": "huxing.zhang@gmail.com", "creation_time": "2015-09-08T14:17:58Z", "text": "Hi Mark,\n\nGlad to hear the patch has been accepted! Thanks for your hard work!\nBTW, I am interested in becoming a tomcat committer, any advice on that?"}, {"count": 19, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 185041, "time": "2015-09-08T14:20:09Z", "bug_id": 57681, "creation_time": "2015-09-08T14:20:09Z", "text": "(In reply to Huxing Zhang from comment #18)\n> Hi Mark,\n> \n> Glad to hear the patch has been accepted! Thanks for your hard work!\n> BTW, I am interested in becoming a tomcat committer, any advice on that?\n\nKeep contributing patches."}]