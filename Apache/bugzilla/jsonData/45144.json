[{"count": 0, "tags": [], "bug_id": 45144, "is_private": false, "id": 117398, "attachment_id": 22083, "creator": "clovis.wichoski@gmail.com", "creation_time": "2008-06-05T12:39:32Z", "time": "2008-06-05T12:39:32Z", "text": "Created attachment 22083\nthe full jstack -l output\n\nHi,\n\nabout system:\nrunning on a IBM System x3200 (Xeon dual core) machine with\nCentOS Linux 2.6.18-53.1.19.el5 #1 SMP Wed May 7 08:22:53 EDT 2008 x86_64 x86_64 x86_64 GNU/Linux\n\n/opt/java/jdk1.6.0_06/bin/java -server -version\njava version \"1.6.0_06\"\nJava(TM) SE Runtime Environment (build 1.6.0_06-b02)\nJava HotSpot(TM) 64-Bit Server VM (build 10.0-b22, mixed mode)\n\nAbout the Problem:\n\nwhen getting new connection from the pool i'm getting many thread BLOCKED for 2 minutes, sometimes seconds, when this occurs today, i take a jstack from JVM and discover that the org.apache.tomcat.dbcp.dbcp.PoolableConnectionFactory is locked and many threads BLOCKED waiting to lock the same instance of PoolableConnectionFactory, follow i cut the most important part of the stack trace:\n\nThe blocker part:\n\"http-80-exec-18\" daemon prio=10 tid=0x0000000054387400 nid=0x442f runnable [0x0000000043137000..0x0000000043138c90]\n   java.lang.Thread.State: RUNNABLE\n\tat java.net.SocketInputStream.socketRead0(Native Method)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:129)\n\tat com.sap.dbtech.rte.comm.BasicSocketComm.receiveConnect(BasicSocketComm.java:707)\n\tat com.sap.dbtech.rte.comm.BasicSocketComm.dbConnectExchange(BasicSocketComm.java:789)\n\tat com.sap.dbtech.rte.comm.BasicSocketComm.connectDB(BasicSocketComm.java:233)\n\tat com.sap.dbtech.rte.comm.SocketComm$1.open(SocketComm.java:38)\n\tat com.sap.dbtech.jdbc.DriverSapDB.openConnection(DriverSapDB.java:966)\n\tat com.sap.dbtech.jdbc.DriverSapDB.openByURL(DriverSapDB.java:891)\n\tat com.sap.dbtech.jdbc.DriverSapDB.connect(DriverSapDB.java:208)\n\t- locked <0x00002aaab74c6978> (a com.sap.dbtech.jdbc.DriverSapDB)\n\tat org.apache.tomcat.dbcp.dbcp.DriverConnectionFactory.createConnection(DriverConnectionFactory.java:38)\n\tat org.apache.tomcat.dbcp.dbcp.PoolableConnectionFactory.makeObject(PoolableConnectionFactory.java:294)\n\t- locked <0x00002aaab74c6a18> (a org.apache.tomcat.dbcp.dbcp.PoolableConnectionFactory)\n\tat org.apache.tomcat.dbcp.pool.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:974)\n\tat org.apache.tomcat.dbcp.dbcp.PoolingDataSource.getConnection(PoolingDataSource.java:96)\n\tat org.apache.tomcat.dbcp.dbcp.BasicDataSource.getConnection(BasicDataSource.java:880)\n\tat org.exolab.castor.jdo.engine.DatabaseRegistry.createConnection(DatabaseRegistry.java:399)\n\tat org.exolab.castor.jdo.engine.TransactionContextImpl.getConnection(TransactionContextImpl.java:203)\n\tat org.exolab.castor.persist.TransactionContext.query(TransactionContext.java:644)\n\t- locked <0x00002aaafc1adb20> (a org.exolab.castor.jdo.engine.TransactionContextImpl)\n\tat org.exolab.castor.jdo.engine.OQLQueryImpl.execute(OQLQueryImpl.java:458)\n\tat org.exolab.castor.jdo.engine.OQLQueryImpl.execute(OQLQueryImpl.java:405)\n\tat com.supridatta.act.produtos.PedidoAction.onIncluir(PedidoAction.java:70)\n\tat com.supridatta.bean.DataPersist.gravar(DataPersist.java:213)\n        ...\n   Locked ownable synchronizers:\n\t- <0x00002aaad0bfb648> (a java.util.concurrent.locks.ReentrantLock$NonfairSync)\n\n\nThe blocked part:\n\"http-80-exec-43\" daemon prio=10 tid=0x000000005356f000 nid=0x5619 waiting for monitor entry [0x0000000044046000..0x0000000044047c10]\n   java.lang.Thread.State: BLOCKED (on object monitor)\n\tat org.apache.tomcat.dbcp.dbcp.PoolableConnectionFactory.makeObject(PoolableConnectionFactory.java:294)\n\t- waiting to lock <0x00002aaab74c6a18> (a org.apache.tomcat.dbcp.dbcp.PoolableConnectionFactory)\n\tat org.apache.tomcat.dbcp.pool.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:974)\n\tat org.apache.tomcat.dbcp.dbcp.PoolingDataSource.getConnection(PoolingDataSource.java:96)\n\tat org.apache.tomcat.dbcp.dbcp.BasicDataSource.getConnection(BasicDataSource.java:880)\n\tat org.exolab.castor.jdo.engine.DatabaseRegistry.createConnection(DatabaseRegistry.java:399)\n\tat org.exolab.castor.jdo.engine.TransactionContextImpl.getConnection(TransactionContextImpl.java:203)\n\tat org.exolab.castor.persist.TransactionContext.query(TransactionContext.java:644)\n\t- locked <0x00002aaafd720be0> (a org.exolab.castor.jdo.engine.TransactionContextImpl)\n\tat org.exolab.castor.jdo.engine.OQLQueryImpl.execute(OQLQueryImpl.java:458)\n\tat org.exolab.castor.jdo.engine.OQLQueryImpl.execute(OQLQueryImpl.java:414)\n\tat com.supridatta.bean.DataPersist.consulta(DataPersist.java:500)\n        ...\n   Locked ownable synchronizers:\n\t- <0x00002aaad0bfb648> (a java.util.concurrent.locks.ReentrantLock$NonfairSync)"}, {"count": 1, "tags": [], "bug_id": 45144, "is_private": false, "id": 117401, "attachment_id": null, "creator": "clovis.wichoski@gmail.com", "creation_time": "2008-06-05T13:19:51Z", "time": "2008-06-05T13:19:51Z", "text": "This is how the Resource is configured:\n\n<Resource name=\"jdbc/conces_primary\"\n              auth=\"Container\"\n              type=\"javax.sql.DataSource\"\n              username=\"DBUSER\"\n              password=\"secret\"\n              driverClassName=\"com.sap.dbtech.jdbc.DriverSapDB\"\n              url=\"jdbc:sapdb://dbserver/DBNAME\"\n              maxActive=\"300\"\n              maxIdle=\"15\"\n              validationQuery=\"SELECT NOW() FROM DBA.DUAL\"\n              minEvictableIdleTimeMillis=\"1800000\"\n              testOnBorrow=\"true\"\n              timeBetweenEvictionRunsMillis=\"900000\"\n              numTestsPerEvictionRun=\"15\"\n              initialSize=\"3\"/>"}, {"count": 2, "tags": [], "text": "This is not a Tomcat bug. It is a duplicate of https://issues.apache.org/jira/browse/DBCP-212.   \n\nIf you do not really need maxIdle as low as 15 with maxActive at 300, increasing (or eliminating) the maxIdle setting should reduce incidence, unless the thrashing is due to abandoned connections, which should be fixed if that is the case.  Obviously, you should also research what is causing the driver connect to hang.", "is_private": false, "bug_id": 45144, "id": 117465, "time": "2008-06-07T06:45:37Z", "creator": "phil@steitz.com", "creation_time": "2008-06-07T06:45:37Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 45144, "attachment_id": null, "is_private": false, "id": 117468, "time": "2008-06-07T07:40:04Z", "creator": "markt@apache.org", "creation_time": "2008-06-07T07:40:04Z", "text": "Closing based on previous comment"}]