[{"count": 0, "tags": [], "creator": "robert.leathley@ricardo.com", "is_private": false, "id": 60078, "attachment_id": null, "bug_id": 29873, "creation_time": "2004-07-01T09:02:11Z", "time": "2004-07-01T09:02:11Z", "text": "Requesting a page authorised by mod_auth_ldap results in a crash and the\nfollowing stack trace:\n\n\n#0  0xc01f45a0 in kill+0x10 () from /usr/lib/libc.2\n#1  0x138584 in sig_coredump (sig=10) at mpm_common.c:955\n#2  <signal handler called>\n#3  0x708c8 in util_ald_create_cache (st=0x4006fac0, hashfunc=0x4001f3ba\n<util_ldap_compare_node_hash>,\n    comparefunc=0x4001f3c2 <util_ldap_compare_node_compare>, copyfunc=0x4001f3ca\n<util_ldap_compare_node_copy>,\n    freefunc=0x4001f3d2 <util_ldap_compare_node_free>) at util_ldap_cache_mgr.c:297\n#4  0x70474 in util_ald_create_caches (st=0x4006fac0,\n    url=0x4008d290\n\"ldap://172.30.53.57:389/ou=users,ou=isis,dc=ricardo,dc=com?uid?one\") at\nutil_ldap_cache_mgr.c:224\n#5  0x6cf90 in util_ldap_cache_checkuserid (r=0x400ec808, ldc=0x40072aa8,\n    url=0x4008d290\n\"ldap://172.30.53.57:389/ou=users,ou=isis,dc=ricardo,dc=com?uid?one\",\n    basedn=0x4008d2e8 \"ou=users,ou=isis,dc=ricardo,dc=com\", scope=1,\nattrs=0x4008d310,\n    filter=0x7b040a98 \"(&(objectclass=*)(uid=engineer1))\", bindpw=0x400ee302\n\"engineer21\", binddn=0x7b042aa8,\n    retvals=0x7b040a94) at util_ldap.c:725\n#6  0x722fc in mod_auth_ldap_check_user_id (r=0x400ec808) at mod_auth_ldap.c:367\n#7  0x14f118 in ap_run_check_user_id (r=0x400ec808) at request.c:68\n#8  0x15066c in ap_process_request_internal (r=0x400ec808) at request.c:192\n#9  0xbf300 in ap_process_request (r=0x400ec808) at http_request.c:244\n#10 0xb4924 in ap_process_http_connection (c=0x400e6890) at http_core.c:250\n#11 0x134838 in ap_run_process_connection (c=0x400e6890) at connection.c:42\n#12 0x135034 in ap_process_connection (c=0x400e6890, csd=0x400e67d8\n\"@\\016g\\240\") at connection.c:175\n#13 0x116e00 in child_main (child_num_arg=8) at prefork.c:609\n#14 0x117224 in make_child (s=0x40038260, slot=8) at prefork.c:703\n#15 0x11763c in perform_idle_server_maintenance (p=0x40034b80) at prefork.c:838\n#16 0x117fe4 in ap_mpm_run (_pconf=0x40034b80, plog=0x40074d80, s=0x40038260) at\nprefork.c:1039\n#17 0x125dfc in main (argc=3, argv=0x7b040394) at main.c:617\n\n\nDisabling the cache avoids the problem.  The same code works correctly (with\ncache enabled) on Linux & w2k."}, {"count": 1, "tags": [], "bug_id": 29873, "attachment_id": null, "id": 60079, "creation_time": "2004-07-01T14:42:07Z", "time": "2004-07-01T14:42:07Z", "creator": "robert.leathley@ricardo.com", "text": "this is also a problem with 2.0.50:\n\n#0  0xc01f45a0 in kill+0x10 () from /usr/lib/libc.2\n#1  0x13895c in sig_coredump (sig=10) at mpm_common.c:955\n#2  <signal handler called>\n#3  0x70d30 in util_ald_create_cache (st=0x4008d468, hashfunc=0x4001ef6a\n<util_ldap_compare_node_hash>,\n    comparefunc=0x4001ef72 <util_ldap_compare_node_compare>, copyfunc=0x4001ef7a\n<util_ldap_compare_node_copy>,\n    freefunc=0x4001ef82 <util_ldap_compare_node_free>) at util_ldap_cache_mgr.c:303\n#4  0x708c4 in util_ald_create_caches (st=0x4008d468, url=0x4006a578\n\"ldap://172.30.53.57:389/ou=users,ou=isis,dc=ricardo,dc=com?uid?one\")\n\n    at util_ldap_cache_mgr.c:226\n#5  0x6d2ac in util_ldap_cache_checkuserid (r=0x40106f40, ldc=0x400ac048,\n    url=0x4006a578\n\"ldap://172.30.53.57:389/ou=users,ou=isis,dc=ricardo,dc=com?uid?one\",\n    basedn=0x4006a5d0 \"ou=users,ou=isis,dc=ricardo,dc=com\", scope=1,\nattrs=0x4006a5f8, filter=0x7b040a38 \"(&(objectclass=*)(uid=kdm))\",\n\n    bindpw=0x40108904 \"kdm\", binddn=0x7b042a48, retvals=0x7b040a34) at\nutil_ldap.c:768\n#6  0x7277c in mod_auth_ldap_check_user_id (r=0x40106f40) at mod_auth_ldap.c:367\n#7  0x14f718 in ap_run_check_user_id (r=0x40106f40) at request.c:68\n#8  0x150c6c in ap_process_request_internal (r=0x40106f40) at request.c:192\n#9  0xbf7b0 in ap_process_request (r=0x40106f40) at http_request.c:244\n#10 0xb4dd4 in ap_process_http_connection (c=0x40100fc8) at http_core.c:250\n#11 0x134c00 in ap_run_process_connection (c=0x40100fc8) at connection.c:42\n#12 0x1353fc in ap_process_connection (c=0x40100fc8, csd=0x40100f10\n\"@\\020\\016\\330\") at connection.c:175\n#13 0x1171a4 in child_main (child_num_arg=1) at prefork.c:609\n#14 0x1175c8 in make_child (s=0x40037e00, slot=1) at prefork.c:703\n#15 0x11768c in startup_children (number_to_start=4) at prefork.c:721\n#16 0x117f20 in ap_mpm_run (_pconf=0x40034720, plog=0x40074920, s=0x40037e00) at\nprefork.c:940\n#17 0x1261ac in main (argc=3, argv=0x7b0403e4) at main.c:617 \n\n\nhttpd -V gives:\n\nServer version: Apache/2.0.50\nServer built:   Jul  1 2004 15:07:35\nServer's Module Magic Number: 20020903:8\nArchitecture:   32-bit\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D HTTPD_ROOT=\"/usr/local/Ricardo/isis/BETA/apache\"\n -D SUEXEC_BIN=\"/usr/local/Ricardo/isis/BETA/apache/bin/suexec\"\n -D DEFAULT_PIDLOG=\"logs/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_LOCKFILE=\"logs/accept.lock\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"\n\n\nalso in apr.h:\n#define APR_HAS_SHARED_MEMORY 1", "is_private": false}, {"count": 2, "tags": [], "bug_id": 29873, "attachment_id": null, "text": "This is also a problem on SGI Irix 6.5 with 2.0.49 (crashes with cache enabled,\nok without).", "id": 60080, "time": "2004-07-01T15:39:15Z", "creator": "robert.leathley@ricardo.com", "creation_time": "2004-07-01T15:39:15Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 29873, "text": "SGI 2.0.49 stack trace:\n\n#0  0x1004e914 in util_ald_create_cache (st=0x102e5608, hashfunc=0x1004fc58\n<util_ldap_compare_node_hash>,\n    comparefunc=0x1004fcc8 <util_ldap_compare_node_compare>, copyfunc=0x1004fd98\n<util_ldap_compare_node_copy>,\n    freefunc=0x1004feec <util_ldap_compare_node_free>) at util_ldap_cache_mgr.c:296\n296         cache->marktime = 0;\n(gdb) bt\n#0  0x1004e914 in util_ald_create_cache (st=0x102e5608, hashfunc=0x1004fc58\n<util_ldap_compare_node_hash>,\n    comparefunc=0x1004fcc8 <util_ldap_compare_node_compare>, copyfunc=0x1004fd98\n<util_ldap_compare_node_copy>,\n    freefunc=0x1004feec <util_ldap_compare_node_free>) at util_ldap_cache_mgr.c:296\n#1  0x1004e50c in util_ald_create_caches (st=0x102e5608, url=0x102dbb18\n\"ldap://172.30.53.57:389/ou=users,ou=isis,dc=ricardo,dc=com?uid?one\")\n\n    at util_ldap_cache_mgr.c:224\n#2  0x1004ca44 in util_ldap_cache_checkuserid (r=0x10365248, ldc=0x102f4f60,\n    url=0x102dbb18\n\"ldap://172.30.53.57:389/ou=users,ou=isis,dc=ricardo,dc=com?uid?one\",\nbasedn=0x102dbb70 \"ou=users,ou=isis,dc=ricardo,dc=com\",\n\n    scope=1, attrs=0x102dbb98, filter=0x7fff0ae0 \"(&(objectclass=*)(uid=kdm))\",\nbindpw=0x10366cec \"kdm\", binddn=0x7fff2af0, retvals=0x7fff0ad8)\n\n    at util_ldap.c:725\n#3  0x10050d78 in mod_auth_ldap_check_user_id (r=0x10365248) at mod_auth_ldap.c:367\n#4  0x100e3968 in ap_run_check_user_id (r=0x10365248) at request.c:69\n#5  0x100e4e18 in ap_process_request_internal (r=0x10365248) at request.c:192\n#6  0x10089c28 in ap_process_request (r=0x10365248) at http_request.c:244\n#7  0x10089298 in ap_process_http_connection (c=0x1035f2e8) at http_core.c:250\n#8  0x1010214c in ap_run_process_connection (c=0x1035f2e8) at connection.c:42\n#9  0x10102814 in ap_process_connection (c=0x1035f2e8, csd=0x1035f230) at\nconnection.c:175\n#10 0x100daaf8 in child_main (child_num_arg=3) at prefork.c:609\n#11 0x100dad78 in make_child (s=0x102ae140, slot=3) at prefork.c:703\n#12 0x100dae60 in startup_children (number_to_start=2) at prefork.c:721\n#13 0x100db5a0 in ap_mpm_run (_pconf=0x102aaa68, plog=0x102eab68, s=0x102ae140)\nat prefork.c:940\n#14 0x10110810 in main (argc=3, argv=0x7fff2f24) at main.c:617 ", "id": 60089, "time": "2004-07-02T08:40:28Z", "creator": "robert.leathley@ricardo.com", "creation_time": "2004-07-02T08:40:28Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 29873, "text": "I see this same crash with httpd-2.0.50-dev (also with 2.0.49) on Solaris 8.\n\nStack looks like this (Removed some unneeded arguments):\n#0  util_ald_create_cache (st=0x107c50,\n    hashfunc=0x30d04 <util_ldap_search_node_hash>,\n    comparefunc=0x30d1c <util_ldap_search_node_compare>,\n    copyfunc=0x30d3c <util_ldap_search_node_copy>,\n    freefunc=0x30e84 <util_ldap_search_node_free>) at util_ldap_cache_mgr.c:263\n#1  0x315c0 in util_ald_create_caches (st=0x107c50,\n#2  0x300c4 in util_ldap_cache_checkuserid (r=0x160880, ldc=0x123630,\n#3  0xfef219a0 in mod_auth_ldap_check_user_id (r=0x160880)\n#4  0x71990 in ap_run_check_user_id (r=0x160880) at request.c:68\n\nSo httpd crashes in util_ald_create_cache. What makes this very interesting is\nthat if I compile util_ldap_cache_mgr.c without optimization, it does not crash\n(The rest of the httpd is compiled with \"-g -O\" in this case). Using GCC 3.3.2.\n\nRob, maybe you can try if compiling without optimization makes the crash go away\nfor you as well.\n\nChanged the summary and OS as this does not look like HP specific issue.\n", "id": 60090, "time": "2004-07-02T09:09:58Z", "creator": "jah@progress.com", "creation_time": "2004-07-02T09:09:58Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 29873, "attachment_id": null, "text": "Both the sgi & hp versions were compiled with -g (no -O optimisation) in the\nprevious stack traces.\n\nThe hp version was originally compiled with hp's cc.  It has since been\nrecompiled with aCC (c++ compiler) and this appears to fix the problem.\n\nThe sgi version was compiled with gcc 3.3.  The sgi's cc crashed and could not\ncompile Apache.", "id": 60148, "time": "2004-07-05T10:58:26Z", "creator": "robert.leathley@ricardo.com", "creation_time": "2004-07-05T10:58:26Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 29873, "text": "Commenting out \"cache->marktime = 0;\" and \"cache->last_purge = 0;\" from\nutil_ald_create_cache results no crash on Solaris 8 (GCC 3.3.2) with optimized\nbuild.\n\nLooks like this crash has something to do with the apr_time_t values of\nutil_ald_cache structure.\n", "id": 60149, "time": "2004-07-05T11:13:01Z", "creator": "jah@progress.com", "creation_time": "2004-07-05T11:13:01Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 29873, "text": "This problem also occurs on Irix 6.5 with MIPSpro Compiler version 7.3.1.3m, \nbuilding 32 bit debug version.\n\nStack trace from SGI CVD debugger:\n\nutil_ald_create_cache(st = 0x102c0b80, hashfunc = 0x1004fd50, comparefunc = \n0x1004fdb0, copyfunc = 0x1004fe80, freefunc = 0x1004ffe0) \n[\"util_ldap_cache_mgr.c\":296]\nutil_ald_create_caches(st = 0x102c0b80, url \n= \"ldap://172.30.53.57:389/ou=users,ou=isis,dc=ricardo,dc=com\\?uid\\?one\") \n[\"util_ldap_cache_mgr.c\":224]\nutil_ldap_cache_checkuserid(r = 0x1033fb88, ldc = 0x102e66e0, url \n= \"ldap://172.30.53.57:389/ou=users,ou=isis,dc=ricardo,dc=com\\?uid\\?one\", \nbasedn = \"ou=users,ou=isis,dc=ricardo,dc=com\", scope = 1, attrs = 0x102e3450, \nfilter = \"(&(objectclass=*)(uid=kdm))\", bindpw = \"kdm\", binddn = 0x7fff0b34, \nretvals = 0x7fff0b24) [\"util_ldap.c\":725]\nmod_auth_ldap_check_user_id(r = 0x1033fb88) [\"mod_auth_ldap.c\":367]\nap_run_check_user_id(r = 0x1033fb88) [\"request.c\":68]\nap_process_request_internal(r = 0x1033fb88) [\"request.c\":192]\nap_process_request(r = 0x1033fb88) [\"http_request.c\":244]\nap_process_http_connection(c = 0x10339c28) [\"http_core.c\":250]\nap_run_process_connection(c = 0x10339c28) [\"connection.c\":42]\nap_process_connection(c = 0x10339c28, csd = 0x10339b70) [\"connection.c\":175]\nchild_main(child_num_arg = 4) [\"prefork.c\":609]\nmake_child(s = 0x10289698, slot = 4) [\"prefork.c\":703]\nstartup_children(number_to_start = 1) [\"prefork.c\":721]\nap_mpm_run(_pconf = 0x10285fc0, plog = 0x102c60e0, s = 0x10289698) \n[\"prefork.c\":940]\nmain(argc = 3, argv = 0x7fff2f24) [\"main.c\":617]\n__start(<stripped>) [\"crt1text.s\":177]\n", "id": 60151, "time": "2004-07-05T11:58:25Z", "creator": "keith.miller@ricardo.com", "creation_time": "2004-07-05T11:58:25Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "jah@progress.com", "attachment_id": null, "id": 60185, "time": "2004-07-06T10:02:52Z", "bug_id": 29873, "creation_time": "2004-07-06T10:02:52Z", "is_private": false, "text": "This seems to be an alignment issue. The optimized build on Solaris uses the\n'std' assembly instruction to store the apr_time_t values into the structure.\nHowever, the memory block returned by apr_rmm_calloc is not always aligned to an\n8-byte boundary. When the structure is not aligned, this instruction will crash\nthe program with a bus error.\n\nI have verified this by adding code to util_ald_create_cache that will try to\nreallocate the block if it's not aligned and this does cure the crash. But it\ndoes not solve the underlying problem that apr_rmm_calloc will allocate\nunaligned memory blocks.\n"}, {"count": 9, "tags": [], "bug_id": 29873, "attachment_id": 12041, "id": 60192, "creation_time": "2004-07-06T14:09:18Z", "time": "2004-07-06T14:09:18Z", "creator": "jah@progress.com", "text": "Created attachment 12041\nPatch to util_ldap_cache_mgr.c", "is_private": false}, {"count": 10, "tags": [], "creator": "jah@progress.com", "attachment_id": null, "id": 60193, "time": "2004-07-06T14:13:35Z", "bug_id": 29873, "creation_time": "2004-07-06T14:13:35Z", "is_private": false, "text": "The attached patch will make the crash go away on Solaris but I don't think it\nis the right way to solve this problem. We need to somehow get apr_rmm_calloc to\nalways get us memory blocks with correct alignment instead of resorting to\nworkarounds like this.\n\nThis problem might be specific to 64-bit systems as 32-bit systems probably have\nno need to do memory allocations in 8-byte chunks.\n"}, {"count": 11, "tags": [], "text": "Yes, nice work tracking this down.  The pointers returned by apr_rmm are not\ngetting aligned at all :( I'll attach an apr_rmm.c patch.", "is_private": false, "id": 60194, "creator": "jorton@redhat.com", "time": "2004-07-06T15:10:55Z", "bug_id": 29873, "creation_time": "2004-07-06T15:10:55Z", "attachment_id": null}, {"count": 12, "tags": [], "creator": "jorton@redhat.com", "is_private": false, "id": 60197, "attachment_id": null, "bug_id": 29873, "creation_time": "2004-07-06T15:22:34Z", "time": "2004-07-06T15:22:34Z", "text": "Can you try this: http://www.apache.org/~jorton/apr_rmm.diff\n\n"}, {"count": 13, "tags": [], "creator": "jah@progress.com", "text": "Joe,\n\nThe patch does not work quite as it is, presumably because it is against an\nApache 2.1 apr_rmm.c. The 2.0.50-dev apr_rmm.c needs a small edit before your\npatch will apply to it. Or maybe my copy of apr_rmm.c is just old...\n\nBut the results are good, no more crashes when running with the patched apr_rmm.c.\n", "id": 60222, "time": "2004-07-07T08:33:18Z", "bug_id": 29873, "creation_time": "2004-07-07T08:33:18Z", "is_private": false, "attachment_id": null}, {"count": 14, "tags": [], "bug_id": 29873, "attachment_id": null, "text": "Has the patch at http://www.apache.org/~jorton/apr_rmm.diff landed inside APR yet?", "id": 63809, "time": "2004-09-19T15:01:16Z", "creator": "minfrin@sharp.fm", "creation_time": "2004-09-19T15:01:16Z", "is_private": false}, {"count": 15, "tags": [], "bug_id": 29873, "attachment_id": null, "id": 63845, "time": "2004-09-20T08:42:40Z", "creator": "jorton@redhat.com", "creation_time": "2004-09-20T08:42:40Z", "is_private": false, "text": "The changes are in HEAD, feel free to backport if you want them in 0.9.x, Graham."}, {"count": 16, "tags": [], "bug_id": 29873, "attachment_id": null, "id": 64023, "time": "2004-09-22T09:21:27Z", "creator": "jorton@redhat.com", "creation_time": "2004-09-22T09:21:27Z", "is_private": false, "text": "Ne'er mind, I've backported all the alignment fixes for the next 2.0 release.\nThanks for testing, Jari."}]