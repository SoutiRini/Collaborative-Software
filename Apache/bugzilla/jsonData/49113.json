[{"count": 0, "tags": [], "bug_id": 49113, "attachment_id": null, "id": 136084, "time": "2010-04-13T05:58:45Z", "creator": "robert.blandward@btinternet.com", "creation_time": "2010-04-13T05:58:45Z", "is_private": false, "text": "Hi,\n\nI have recently re-compiled and make installed httpd 2.2.15 to upgrade our exisiting httpd 2.2.6 live environment. We use no third party modules.  Our config parameters (from our exisiting 2.2.6 config.nice) are:\n\n\"./configure\" \\\n\"--prefix=/usr/local/apache2_stellent\" \\\n\"--disable-ipv6\" \\\n\"--disable-auth\" \\\n\"--disable-autoindex\" \\\n\"--enable-cache\" \\\n\"--enable-disk-cache\" \\\n\"--enable-expires\" \\\n\"--enable-headers\" \\\n\"--enable-mime-magic\" \\\n\"--enable-proxy\" \\\n\"--enable-proxy-http\" \\\n\"--enable-rewrite\" \\\n\"--enable-vhost-alias\" \\\n\"$@\"\n\nI am building on Solaris 9 9/05, with Sunfreeware builds of gcc3.4.6 and libiconv 1.13.1.\n\nconfigure, make and make install all work, and we are not modifying any makefiles.\n\nWe are using httpd in this case as a reverse proxy/httpd accellerator using disk-cache through to an Oracle/Stellent content manager (Win 2003SP2,IIS6)\n\nWhat we are seeing though once using httpd 2.2.15 binaries, is that when accessing PDF's using firefox, the document window (viewing inside firefox) will display the first page, but when scrolling down it will lock temporarily (approx 3-4 minutes) and then error saying \"There was an error reading this document (14)\". That, or the document will immediately fail to load with the error \"There was an error processing a page. There was a problem reading this document (109).\n\nViewing the same document in IE7, winxp sp2, the page does not load at all and says \"Internet explorer cannot download xxx.pdf from xxx.  Internet explorer was not able to open this internet site.  The requested site is either unavailable or cannot be found.  Please try again later.\"\n\nThere is nothing in the error_log.  The access_log (for same document) only reports:\n\nIE access entry:\n*removed* - - [13/Apr/2010:10:41:51 +0100] \"GET /consumption/groups/public/documents/article/ncc043240.pdf HTTP/1.1\" 206 23801 \"http://*removed*/consumption/idcplg?IdcService=SS_GET_PAGE&ssDocName=NCC007171\" \"Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 1.1.4322; .NET CLR 2.0.50727; .NET CLR 3.0.4506.2152; .NET CLR 3.5.30729)\"\n\nFirefox access entries:\n*removed* - - [13/Apr/2010:10:50:21 +0100] \"GET /consumption/groups/public/documents/article/ncc043240.pdf HTTP/1.1\" 206 23801 \"http://*removed*/consumption/idcplg?IdcService=SS_GET_PAGE&ssDocName=NCC007171\" \"Mozilla/5.0 (Windows; U; Windows NT 5.1; en-GB; rv:1.9.2.3) Gecko/20100401 Firefox/3.6.3 (.NET CLR 3.5.30729)\"\n*removed* - - [13/Apr/2010:10:50:21 +0100] \"GET /consumption/groups/public/documents/article/ncc043240.pdf HTTP/1.1\" 206 23801 \"-\" \"Mozilla/5.0 (Windows; U; Windows NT 5.1; en-GB; rv:1.9.2.3) Gecko/20100401 Firefox/3.6.3 (.NET CLR 3.5.30729)\"\n\nThe PDF being accesses above is multipage and colour, and above the filesize threshold so is being accessed using byterange requests.\n\nIn my investigation so far, I have compiled all versions of httpd 2.2.x since 2.2.6 to see when the problem appeared, and the last version it worked in was 2.2.11.  The problems first appeared in 2.2.12, and appear to be identical in minor version 13, 14 and 15.\n\nPease can we find out why this broke in builds after 11?\n\nRegards,\nRob"}, {"count": 1, "tags": [], "bug_id": 49113, "attachment_id": null, "id": 136086, "time": "2010-04-13T08:26:37Z", "creator": "rpluem@apache.org", "creation_time": "2010-04-13T08:26:37Z", "is_private": false, "text": "Does it work without caching enabled?"}, {"count": 2, "tags": [], "text": "(In reply to comment #1)\n> Does it work without caching enabled?\n\nYes.\n\nI have commented out the disk caching v-host directives:\n\nCacheRoot /apachedata/cache/wsaNCC\nCacheEnable disk /\nCacheDirLevels 5\nCacheDirLength 3\nCacheIgnoreNoLastMod On\nCacheLastModifiedFactor 1\nCacheDefaultExpire 79200\nCacheMaxExpire 79200\nCacheStorePrivate On\n\nand the PDF's can be loaded multiple times, on multiple browsers without error, albeit slowly.", "attachment_id": null, "id": 136087, "creator": "robert.blandward@btinternet.com", "time": "2010-04-13T08:43:12Z", "bug_id": 49113, "creation_time": "2010-04-13T08:43:12Z", "is_private": false}, {"count": 3, "tags": [], "text": "Please do the following with caching enabled.\n\n1. Set loglevel to debug and attach the output of the logfiles.\n2. Capture the traffic for a failing document and attach the network snapshot.\n3. Check if the files in the cache root are complete or if they were already corrupted during caching.\n\nQuestion: Does it work for the first request, when the document is not cached yet?", "attachment_id": null, "id": 136092, "creator": "rpluem@apache.org", "time": "2010-04-13T11:21:35Z", "bug_id": 49113, "creation_time": "2010-04-13T11:21:35Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 49113, "attachment_id": null, "id": 136093, "time": "2010-04-13T11:32:25Z", "creator": "rpluem@apache.org", "creation_time": "2010-04-13T11:32:25Z", "is_private": false, "text": "What is the complete size / length of the PDF requested in your logs?"}, {"count": 5, "tags": [], "bug_id": 49113, "attachment_id": null, "is_private": false, "id": 136095, "time": "2010-04-13T11:48:52Z", "creator": "rpluem@apache.org", "creation_time": "2010-04-13T11:48:52Z", "text": "Does the following patch fix your issue?\n\nIndex: modules/cache/mod_cache.c\n===================================================================\n--- modules/cache/mod_cache.c   (revision 933687)\n+++ modules/cache/mod_cache.c   (working copy)\n@@ -473,7 +473,8 @@\n          * We include 304 Not Modified here too as this is the origin server\n          * telling us to serve the cached copy.\n          */\n-        if (exps != NULL || cc_out != NULL) {\n+        if ((exps != NULL || cc_out != NULL)\n+            && r->status != HTTP_PARTIAL_CONTENT) {\n             /* We are also allowed to cache any response given that it has a\n              * valid Expires or Cache Control header. If we find a either of\n              * those here,  we pass request through the rest of the tests. From\n@@ -486,6 +487,9 @@\n              * include the following: an Expires header (section 14.21); a\n              * \"max-age\", \"s-maxage\",  \"must-revalidate\", \"proxy-revalidate\",\n              * \"public\" or \"private\" cache-control directive (section 14.9).\n+             *\n+             * But do NOT store 206 responses in any case since we\n+             * don't (yet) cache partial responses.\n              */\n         }\n         else {"}, {"text": "One last remark: Please clean your disk cache before testing the patch as it may contain corrupted versions of the PDF file.", "tags": [], "creator": "rpluem@apache.org", "is_private": false, "count": 6, "id": 136096, "time": "2010-04-13T11:56:21Z", "bug_id": 49113, "creation_time": "2010-04-13T11:56:21Z", "attachment_id": null}, {"count": 7, "tags": [], "text": "Created attachment 25281\ninstance default access.log", "attachment_id": 25281, "id": 136111, "creator": "robert.blandward@btinternet.com", "time": "2010-04-14T04:09:21Z", "bug_id": 49113, "creation_time": "2010-04-14T04:09:21Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 49113, "attachment_id": 25282, "id": 136112, "time": "2010-04-14T04:09:53Z", "creator": "robert.blandward@btinternet.com", "creation_time": "2010-04-14T04:09:53Z", "is_private": false, "text": "Created attachment 25282\ninstance default error_log"}, {"count": 9, "tags": [], "bug_id": 49113, "attachment_id": 25283, "is_private": false, "id": 136113, "time": "2010-04-14T04:10:33Z", "creator": "robert.blandward@btinternet.com", "creation_time": "2010-04-14T04:10:33Z", "text": "Created attachment 25283\ninitial v-host catch-all access_log"}, {"count": 10, "tags": [], "bug_id": 49113, "attachment_id": 25284, "is_private": false, "id": 136114, "time": "2010-04-14T04:10:55Z", "creator": "robert.blandward@btinternet.com", "creation_time": "2010-04-14T04:10:55Z", "text": "Created attachment 25284\ninitial v-host catch-all error_log"}, {"count": 11, "tags": [], "bug_id": 49113, "attachment_id": 25285, "is_private": false, "id": 136115, "time": "2010-04-14T04:12:52Z", "creator": "robert.blandward@btinternet.com", "creation_time": "2010-04-14T04:12:52Z", "text": "Created attachment 25285\nmain v-host client access v-host access_log"}, {"count": 12, "tags": [], "bug_id": 49113, "attachment_id": 25286, "is_private": false, "id": 136116, "time": "2010-04-14T04:13:17Z", "creator": "robert.blandward@btinternet.com", "creation_time": "2010-04-14T04:13:17Z", "text": "Created attachment 25286\nmain v-host client access v-host error_log"}, {"count": 13, "tags": [], "bug_id": 49113, "attachment_id": 25287, "is_private": false, "id": 136117, "time": "2010-04-14T04:15:19Z", "creator": "robert.blandward@btinternet.com", "creation_time": "2010-04-14T04:15:19Z", "text": "Created attachment 25287\nproxypass and disk caching v-host access_log"}, {"count": 14, "tags": [], "text": "Created attachment 25288\nproxypass and disk caching v-host error_log", "attachment_id": 25288, "id": 136118, "creator": "robert.blandward@btinternet.com", "time": "2010-04-14T04:15:44Z", "bug_id": 49113, "creation_time": "2010-04-14T04:15:44Z", "is_private": false}, {"count": 15, "tags": [], "bug_id": 49113, "attachment_id": 25289, "is_private": false, "id": 136119, "time": "2010-04-14T04:17:53Z", "creator": "robert.blandward@btinternet.com", "creation_time": "2010-04-14T04:17:53Z", "text": "Created attachment 25289\nsnoop output, non promiscuous, port 80, just for PDF access."}, {"count": 16, "tags": [], "creator": "robert.blandward@btinternet.com", "is_private": false, "id": 136120, "creation_time": "2010-04-14T04:24:00Z", "time": "2010-04-14T04:24:00Z", "bug_id": 49113, "text": "(In reply to comment #3)\n> Please do the following with caching enabled.\n> \n> 1. Set loglevel to debug and attach the output of the logfiles.\n> 2. Capture the traffic for a failing document and attach the network snapshot.\n> 3. Check if the files in the cache root are complete or if they were already\n> corrupted during caching.\n> \n> Question: Does it work for the first request, when the document is not cached\n> yet?\n\n1. Logfiles attached\n2. Snoop output attached\n3. The cache element 'data' portion is only 24K, and does contain PDF data, byterange, but is not complete due to its size. The PDF used in the examples above is 499132 bytes.\n\nI have been clearing down the disk cache in-between each test, and can therefore confirm that the PDF is not in disk cache, and cannot be viewed on initial access.", "attachment_id": null}, {"text": "(In reply to comment #5)\n> Does the following patch fix your issue?\n> \n> Index: modules/cache/mod_cache.c\n> ===================================================================\n> --- modules/cache/mod_cache.c   (revision 933687)\n> +++ modules/cache/mod_cache.c   (working copy)\n> @@ -473,7 +473,8 @@\n>           * We include 304 Not Modified here too as this is the origin server\n>           * telling us to serve the cached copy.\n>           */\n> -        if (exps != NULL || cc_out != NULL) {\n> +        if ((exps != NULL || cc_out != NULL)\n> +            && r->status != HTTP_PARTIAL_CONTENT) {\n>              /* We are also allowed to cache any response given that it has a\n>               * valid Expires or Cache Control header. If we find a either of\n>               * those here,  we pass request through the rest of the tests.\n> From\n> @@ -486,6 +487,9 @@\n>               * include the following: an Expires header (section 14.21); a\n>               * \"max-age\", \"s-maxage\",  \"must-revalidate\", \"proxy-revalidate\",\n>               * \"public\" or \"private\" cache-control directive (section 14.9).\n> +             *\n> +             * But do NOT store 206 responses in any case since we\n> +             * don't (yet) cache partial responses.\n>               */\n>          }\n>          else {\n\n\nI have made these changes, and at first testing, they appear to have resolved the issue.  Not only that, but the entire PDF (approx 480k) is cached despite it being requested by byterange.\n\nIs this a regression issue from 2.2.12 onwards, or was the caching of partial_content requests purposefully allowed as desirable functionality?", "tags": [], "creator": "robert.blandward@btinternet.com", "is_private": false, "count": 17, "id": 136129, "time": "2010-04-14T06:05:51Z", "bug_id": 49113, "creation_time": "2010-04-14T06:05:51Z", "attachment_id": null}, {"count": 18, "tags": [], "bug_id": 49113, "attachment_id": null, "is_private": false, "id": 136132, "time": "2010-04-14T08:01:35Z", "creator": "rpluem@apache.org", "creation_time": "2010-04-14T08:01:35Z", "text": "(In reply to comment #17)\n\n> I have made these changes, and at first testing, they appear to have resolved\n> the issue.  Not only that, but the entire PDF (approx 480k) is cached despite\n> it being requested by byterange.\n> \n> Is this a regression issue from 2.2.12 onwards, or was the caching of\n> partial_content requests purposefully allowed as desirable functionality?\n\nThis is a regression. Fixed in trunk as r933919."}, {"count": 19, "tags": [], "creator": "robert.blandward@btinternet.com", "is_private": false, "text": "(In reply to comment #18)\n> (In reply to comment #17)\n> \n> > I have made these changes, and at first testing, they appear to have resolved\n> > the issue.  Not only that, but the entire PDF (approx 480k) is cached despite\n> > it being requested by byterange.\n> > \n> > Is this a regression issue from 2.2.12 onwards, or was the caching of\n> > partial_content requests purposefully allowed as desirable functionality?\n> \n> This is a regression. Fixed in trunk as r933919.\n\nGreat news.  Thanks for your time and help.", "id": 136134, "time": "2010-04-14T08:12:26Z", "bug_id": 49113, "creation_time": "2010-04-14T08:12:26Z", "attachment_id": null}, {"count": 20, "tags": [], "text": "*** Bug 49786 has been marked as a duplicate of this bug. ***", "attachment_id": null, "id": 139277, "creator": "rpluem@apache.org", "time": "2010-08-20T02:45:38Z", "bug_id": 49113, "creation_time": "2010-08-20T02:45:38Z", "is_private": false}, {"count": 21, "tags": [], "bug_id": 49113, "attachment_id": null, "is_private": false, "id": 149040, "time": "2011-09-06T08:36:05Z", "creator": "duncan@harris3.org", "creation_time": "2011-09-06T08:36:05Z", "text": "When is this fix likely to be merged into 2.2.x ? Seems like a fairly serious regression and thus worth fixing in the current best version a.s.a.p. We are following the 2.2.x track and have had to manually apply the patch from r933919."}, {"count": 22, "tags": [], "bug_id": 49113, "attachment_id": null, "is_private": false, "id": 149042, "time": "2011-09-06T12:04:43Z", "creator": "rpluem@apache.org", "creation_time": "2011-09-06T12:04:43Z", "text": "(In reply to comment #21)\n> When is this fix likely to be merged into 2.2.x ? Seems like a fairly serious\n> regression and thus worth fixing in the current best version a.s.a.p. We are\n> following the 2.2.x track and have had to manually apply the patch from\n> r933919.\n\nProposed for backport as r1165626."}, {"count": 23, "tags": [], "creator": "colin@colino.net", "is_private": false, "text": "(In reply to comment #22)\n> (In reply to comment #21)\n> > When is this fix likely to be merged into 2.2.x ? Seems like a fairly serious\n> > regression and thus worth fixing in the current best version a.s.a.p. We are\n> > following the 2.2.x track and have had to manually apply the patch from\n> > r933919.\n> \n> Proposed for backport as r1165626.\n\nIs there any status update about this backport ? I'm bitten by that bug and manually patch Debian's Apache2 (2.2.16) each time the package is updated.\n\nThanks!", "id": 158737, "time": "2012-05-02T12:21:18Z", "bug_id": 49113, "creation_time": "2012-05-02T12:21:18Z", "attachment_id": null}, {"count": 24, "tags": [], "bug_id": 49113, "attachment_id": null, "id": 159471, "time": "2012-05-29T20:01:20Z", "creator": "sf@sfritsch.de", "creation_time": "2012-05-29T20:01:20Z", "is_private": false, "text": "will be in 2.2.23: r1343951"}]