[{"attachment_id": 34334, "tags": [], "bug_id": 60219, "is_private": false, "count": 0, "id": 194206, "time": "2016-10-07T17:21:26Z", "creator": "ignacio@reportingstandard.com", "creation_time": "2016-10-07T17:21:26Z", "text": "Created attachment 34334\nFormulaParser.java patch content ASCII\n\nA formula cell contains a reference to a cell in an external workbook. This is represented in POI as \n\n[1]Shee1!A1\n\nwhere [1] is an index on a table to de-reference external workbooks. The current parser has no problems with this. But, if the sheet name contains spaces or \"special\" characters, the formula cell contains:\n\n'[1]Sheet 1'!A1\n\nNote the quote starts before the square bracket indicating an external file reference.\n\nWe resolved this problem by editing the FormulaParser.java file and I'm now submitting a patch for revision."}, {"count": 1, "tags": [], "text": "Created attachment 34342\nFormulaParser.java and unit test patch for quoted external sheet names\n\nThanks for the patch! I added a unit test (attached) to make sure this stays fixed in the future.\n\nUnfortunately, this patch cannot be committed yet because it breaks o.a.p.hssf.usermodel.TestBugs#bug45970.\n\nrow.getCell(1).setCellFormula(\"'[$http://gagravarr.org/FormulaRefs2.xls]Sheet1'!B2\");\n\n> No external workbook with name '$http://gagravarr.org/FormulaRefs2.xls'\n> java.lang.RuntimeException: No external workbook with name '$http://gagravarr.org/FormulaRefs2.xls'\n>         at org.apache.poi.hssf.model.LinkTable.getExternalSheetIndex(LinkTable.java:445)\n>         at org.apache.poi.hssf.model.InternalWorkbook.getExternalSheetIndex(InternalWorkbook.java:2012)\n>         at org.apache.poi.hssf.usermodel.HSSFEvaluationWorkbook.getSheetExtIx(HSSFEvaluationWorkbook.java:300)\n>         at org.apache.poi.hssf.usermodel.HSSFEvaluationWorkbook.get3DReferencePtg(HSSFEvaluationWorkbook.java:94)\n>         at org.apache.poi.ss.formula.FormulaParser.createAreaRefParseNode(FormulaParser.java:957)\n>         at org.apache.poi.ss.formula.FormulaParser.parseRangeable(FormulaParser.java:568)\n>         at org.apache.poi.ss.formula.FormulaParser.parseRangeExpression(FormulaParser.java:311)\n>         at org.apache.poi.ss.formula.FormulaParser.parseSimpleFactor(FormulaParser.java:1517)\n>         ...\n>         at org.apache.poi.ss.formula.FormulaParser.unionExpression(FormulaParser.java:1857)\n>         at org.apache.poi.ss.formula.FormulaParser.parse(FormulaParser.java:2005)\n>         at org.apache.poi.ss.formula.FormulaParser.parse(FormulaParser.java:170)\n>         at org.apache.poi.ss.formula.FormulaParser.parse(FormulaParser.java:190)\n>         at org.apache.poi.hssf.model.HSSFFormulaParser.parse(HSSFFormulaParser.java:108)\n>         at org.apache.poi.hssf.usermodel.HSSFCell.setCellFormula(HSSFCell.java:622)\n>         at org.apache.poi.hssf.usermodel.TestBugs.bug45970(TestBugs.java:1852)", "attachment_id": 34342, "bug_id": 60219, "id": 194248, "time": "2016-10-08T23:36:26Z", "creator": "onealj@apache.org", "creation_time": "2016-10-08T23:36:26Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 60219, "is_private": false, "count": 2, "id": 194249, "time": "2016-10-08T23:41:39Z", "creator": "onealj@apache.org", "creation_time": "2016-10-08T23:41:39Z", "text": "Committed disabled unit test in r1763937."}, {"count": 3, "text": "Hi,\n\nSorry, I don't understand this part of the comment:\n\n\"Unfortunately, this patch cannot be committed yet because it breaks o.a.p.hssf.usermodel.TestBugs#bug45970.\"\n\nrow.getCell(1).setCellFormula(\"'[$http://gagravarr.org/FormulaRefs2.xls]Sheet1'!B2\");\n\nThe error message generated is right cause the Excel sheet referenced in the URL does not exists. So maybe there is a bug in the output of test case o.a.p.hssf.usermodel.TestBugs#bug45970 because it MUST raise that exception", "bug_id": 60219, "is_private": false, "id": 194297, "time": "2016-10-10T09:37:21Z", "creator": "ignacio@reportingstandard.com", "creation_time": "2016-10-10T09:37:21Z", "tags": [], "attachment_id": null}, {"count": 4, "tags": [], "text": "OK, I've dig into the problem of TestBugs#bug45970 and this is what I see.\n\non line 1852 of o.a.p.hssf.usermodel.TestBugs.java there is the following:\n\nrow.getCell(1).setCellFormula(\"'[$http://gagravarr.org/FormulaRefs2.xls]Sheet1'!B2\");\n\nDuring setCellFormula operation, the referenced external workbook is not in the LinkTable as you can see in the following stack trace:\n\nLinkTable.getExternalSheetIndex(String, String, String) line: 443\t\nInternalWorkbook.getExternalSheetIndex(String, String, String) line: 2012\t\nHSSFEvaluationWorkbook.getSheetExtIx(SheetIdentifier) line: 300\t\nHSSFEvaluationWorkbook.get3DReferencePtg(CellReference, SheetIdentifier) line: 94\t\nFormulaParser.createAreaRefParseNode(SheetIdentifier, FormulaParser$SimpleRangePart, FormulaParser$SimpleRangePart) line: 957\t\nFormulaParser.parseRangeable() line: 568\t\nFormulaParser.parseRangeExpression() line: 311\t\nFormulaParser.parseSimpleFactor() line: 1516\t\nFormulaParser.percentFactor() line: 1474\t\nFormulaParser.powerFactor() line: 1461\t\nFormulaParser.Term() line: 1834\t\nFormulaParser.additiveExpression() line: 1962\t\nFormulaParser.concatExpression() line: 1946\t\nFormulaParser.comparisonExpression() line: 1903\t\nFormulaParser.intersectionExpression() line: 1876\t\nFormulaParser.unionExpression() line: 1856\t\nFormulaParser.parse() line: 2004\t\nFormulaParser.parse(String, FormulaParsingWorkbook, FormulaType, int, int) line: 170\t\nFormulaParser.parse(String, FormulaParsingWorkbook, FormulaType, int) line: 190\t\nHSSFFormulaParser.parse(String, HSSFWorkbook, FormulaType, int) line: 108\t\nHSSFCell.setCellFormula(String) line: 622\t\nTestBugs.bug45970() line: 1852\t\n\n\nLinkTable.getExternalSheetIndex(String, String, String) line: 443 returns -1 because and on line 445 of o.a.p.hssf.model.LinkTable.java a RuntimeException is raised.\n\nThere are three options:\n1) Modify LinkTable to automatically add a new external reference to the link table rather that raise an exception (this way looks easy for POI users)\n2) Modify test case 45970 to add an external workbook reference before setting the formula\n3) Other, such as define a policy for unreferenced external workbooks and either raise an error or create the reference automatically.\n\nGoing for (2) seems obvious and the simplest way to fix this problem, but makes live more difficult to developers\nGoing for (1) seems possible in a short period of time, but might break existing test cases (I'm not 100% sure about this)\nGoing for (3) seems to be the right position in a long term. But requires more work\n\nAny preference?", "attachment_id": null, "id": 194299, "creator": "ignacio@reportingstandard.com", "time": "2016-10-10T10:31:08Z", "bug_id": 60219, "creation_time": "2016-10-10T10:31:08Z", "is_private": false}, {"count": 5, "attachment_id": null, "creator": "ignacio@reportingstandard.com", "is_private": false, "id": 194308, "time": "2016-10-10T15:36:25Z", "bug_id": 60219, "creation_time": "2016-10-10T15:36:25Z", "tags": [], "text": "I'm sorry to be so active at this time.\n\no.a.p.hssf.usermodel.TestHSSFFormulaEvaluator.java#testXRefs suggest me that the preferred option is (2) (the external workbook must be added to the linkTable before the setFormula is called)\n\nThis means the code o.a.p.hssf.usermodel.TestBugs#bug45970 MUST always fail and the current situation (the test pass without a fail) pass because the resolution of the formula reference contains a bug and the external workbook is recognised as a worksheet of the current workbook.\n\nIn order to fix code in bug45970. The changes should be like this:\n\n-------------------------------------------------------------------\n// Link our new workbook\nwb1.linkExternalWorkbook(\"$http://gagravarr.org/FormulaRefs2.xls\", new String[] {\"Sheet1\"});\n       \n// Change 4       row.getCell(1).setCellFormula(\"'[$http://gagravarr.org/FormulaRefs2.xls]Sheet1'!B2\");\nrow.getCell(1).setCellValue(123.0);\n\n// Link our new workbook\nwb1.linkExternalWorkbook(\"$http://example.com/FormulaRefs.xls\", new String[] {\"Sheet1\"});\n       \n// Add 5\nrow = s.createRow(5);\nrow.createCell(1, CellType.FORMULA);\n       row.getCell(1).setCellFormula(\"'[$http://example.com/FormulaRefs.xls]Sheet1'!B1\");\nrow.getCell(1).setCellValue(234.0);\n-------------------------------------------------------------------\n\nNote I'm adding the external workbook to the current workbook prior to set a formula that uses cells in that workbook.\n\nThe current implementation of linkExternalWorkbook requires the external workbook to be instantiated as a Workbook object. In order to support referencing external workbooks that are now already instantiated a new method linkExternalWorkbook(String name, String sheetNames[]) is required.\n\nThe attached new patch contains all required changes and passes complete conformance suite.\n\nThe changes include:\n\nadded linkExternalWorkbook(String name, String sheetNames[]) to  src/java/org/apache/poi/ss/usermodel/Workbook.java and added implementation of derived classes. Note XSSF... does not implements external workbooks at all.\n\nTestBugs now can uncomment two final tests (that pass OK) to check the external references."}, {"count": 6, "tags": [], "text": "Created attachment 34354\nFull patch, passes conf suite", "attachment_id": 34354, "bug_id": 60219, "id": 194310, "time": "2016-10-10T15:40:15Z", "creator": "ignacio@reportingstandard.com", "creation_time": "2016-10-10T15:40:15Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 60219, "attachment_id": 34357, "is_private": false, "id": 194321, "time": "2016-10-11T10:52:05Z", "creator": "ignacio@reportingstandard.com", "creation_time": "2016-10-11T10:52:05Z", "text": "Created attachment 34357\nAlternative patch to previous one\n\nThis is an alternative patch to the full patch. This one does not change the Workbook interface. Only the TestBugs.java and FormulaParser.java"}, {"count": 8, "tags": [], "bug_id": 60219, "text": "Are these external references saved in the xls or xlsx file? If so, then you are correct that the HSSFWorkbook and XSSFWorkbook need a method to add a link to an external workbook (I'm assuming it would also be valid to remove a link, in which case we would need an add, remove and get external links methods).\n\nIf only the FormulaEvaluator needs to know about external references (if this information is not saved in the workbook or is always auto-created when an external reference is found), then there is no need to complicate the API with multiple ways to link workbooks for evaluation.\n\nRelevant: https://poi.apache.org/spreadsheet/eval.html#external\n\nFWIW, I tested attachment 34354 and it passes with the current test suite.", "id": 194458, "time": "2016-10-15T20:02:00Z", "creator": "onealj@apache.org", "creation_time": "2016-10-15T20:02:00Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 60219, "text": "Patch 34357 should be OK to fix this bug and does not modify the signature of Workbook interface. I propose you incorporate patch 34357 to current version and close this bug", "id": 194615, "time": "2016-10-21T10:59:33Z", "creator": "ignacio@reportingstandard.com", "creation_time": "2016-10-21T10:59:33Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 60219, "text": "Applied the less intrusive patch via r1776796, thanks for the work on this!", "id": 195771, "time": "2016-12-31T16:55:51Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2016-12-31T16:55:51Z", "is_private": false, "attachment_id": null}]