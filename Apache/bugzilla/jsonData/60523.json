[{"count": 0, "tags": [], "creator": "iv_kovalyov@mail.ru", "text": "Created attachment 34559\nPatch for WsRemoteEndpointImplBase.java\n\nI am using Tomcat 9 and Spring.\n\nMy web application has a websocket service.\n\nMy application sends binary messages to client using sendMessage of:\n\norg.springframework.web.socket.WebSocketSession.\n\nI collected tcp packets by wireshark. I see that every binary websocket message uses at least 2 TCP packets.\n\nThe first packet is the header, it is small.\n\nThere is patch for WsRemoteEndpointImplBase.java from version 9.0.0.M15 in attachement, it\ncreates one packet from header and tail if it's size not more than 65536 bytes.", "id": 195666, "time": "2016-12-27T11:59:34Z", "bug_id": 60523, "creation_time": "2016-12-27T11:59:34Z", "is_private": false, "attachment_id": 34559}, {"count": 1, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 195824, "time": "2017-01-03T17:22:01Z", "bug_id": 60523, "creation_time": "2017-01-03T17:22:01Z", "is_private": false, "text": "What does this patch do to performance? It adds a couple of copies."}, {"count": 2, "tags": [], "text": "(In reply to Mark Thomas from comment #1)\n> What does this patch do to performance? It adds a couple of copies.\n\nYes, it adds a couple of copies in memory but reduces number of network packets.\nNetwork packet transmission takes more time than operations with memory and we have perfomance benefit sending less network packets.\nIf you wish this perfomance benefit can be checked by test.", "attachment_id": null, "id": 195902, "creator": "iv_kovalyov@mail.ru", "time": "2017-01-09T05:34:54Z", "bug_id": 60523, "creation_time": "2017-01-09T05:34:54Z", "is_private": false}, {"count": 3, "tags": [], "text": "Yes, it adds a couple of copies in memory but reduces number of network packets.\nNetwork packet transmission takes more time than operations with memory and we have perfomance benefit sending less network packets.\nIf you wish this perfomance benefit can be checked by test.", "attachment_id": null, "id": 195977, "creator": "iv_kovalyov@mail.ru", "time": "2017-01-11T11:00:46Z", "bug_id": 60523, "creation_time": "2017-01-11T11:00:46Z", "is_private": false}, {"count": 4, "tags": [], "creator": "iv_kovalyov@mail.ru", "attachment_id": null, "id": 195978, "time": "2017-01-11T11:01:58Z", "bug_id": 60523, "creation_time": "2017-01-11T11:01:58Z", "is_private": false, "text": "Answered in previous comment"}, {"count": 5, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 195983, "time": "2017-01-11T12:26:14Z", "bug_id": 60523, "creation_time": "2017-01-11T12:26:14Z", "is_private": false, "text": "The proposed patch will not be applied because it results in significant performance degradation rather than an improvement.\n\nTesting with the Autobahn WebSocket testsuite showed performance decreased more than 2 orders of magnitude when the proposed patch was applied.\n\nWhether the additional copies, the additional allocations or other factors are responsible for the performance degradation might be an interesting topic to research.\n\nPerformance bottlenecks are notoriously difficult to identify via code inspection in all but the most trivial of cases."}, {"count": 6, "tags": [], "creator": "iv_kovalyov@mail.ru", "text": "Hello, Mark.\nI just installed Autobahn WebSocket testsuite.\nCan you tell me more about your tests?\nI want to reproduce test results.\nWhat web application did you deployed at tomcat for test purposes?\nWhat test did you run?", "id": 196003, "time": "2017-01-12T08:05:43Z", "bug_id": 60523, "creation_time": "2017-01-12T08:05:43Z", "is_private": false, "attachment_id": null}, {"text": "(In reply to Ilgar Kovalyov from comment #6)\n> Hello, Mark.\n> I just installed Autobahn WebSocket testsuite.\n> Can you tell me more about your tests?\n> I want to reproduce test results.\n> What web application did you deployed at tomcat for test purposes?\n\nThe programmatic WebSocket echo example in the Tomcat examples \n\n> What test did you run?\n\nAll of the Autobhan WebSocket server tests.\n\nThere are some very old results that give you an idea of the tests being run here:\nhttp://home.apache.org/~markt/dev/autobahn/\n\nI ran a more recent version of those tests (but not the latest).", "tags": [], "bug_id": 60523, "attachment_id": null, "count": 7, "id": 196008, "time": "2017-01-12T09:06:45Z", "creator": "markt@apache.org", "creation_time": "2017-01-12T09:06:45Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 60523, "attachment_id": null, "text": "I'm experiencing the same behavior. The client library I use to send data to my server over websockets properly bundles the payload length and payload in a single tcp datagram. Data coming from my tomcat server is always sending two datagrams for a single message: one with 2 bytes of payload which is the websocket header + payload length, and the 2nd which is the payload.\n\nFrom what I can see the doWrite(SendHandler, long, ByteBuffer...) sends each provided buffer in a separate frame. We can see inside this method it invokes:\n\nfor (ByteBuffer buffer : buffers) {\n  socketWrapper.write(true, buffer);\n  // Snip\n  socketWrapper.setWriteTimeout(timeout);\n  socketWrapper.flush(true);\n}\n\nThe original patch allocates a new buffer to place both the header and payload in a single buffer before handing it to this method, which resolves the network behavior but results in extra memory copies. Perhaps the more correct solution is to modify WsRemoteEndpointImplServer::doWrite to only do a single socket flush after writing all provided buffers?\n\nThe protocol I'm working on sends numerous very small packets; about 90% of my traffic is TCP header overhead. Doubling the number of packets thus nearly doubles my overall bandwidth usage. This is extremely important to my application.", "id": 199879, "time": "2017-07-19T22:32:13Z", "creator": "josephrdean@gmail.com", "creation_time": "2017-07-19T22:32:13Z", "is_private": false}, {"count": 9, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 199882, "time": "2017-07-20T09:23:11Z", "bug_id": 60523, "creation_time": "2017-07-20T09:23:11Z", "is_private": false, "text": "Re-open to review the most recent comment."}, {"count": 10, "tags": [], "creator": "markt@apache.org", "text": "Fixed in:\n- trunk for 9.0.0.M27 onwards\n- 8.5.x for 8.5.21 onwards\n\nFixing this for 8.0.x and earlier would require significant refactoring - effectively the refactoring that took place for 8.5.x.", "id": 200649, "time": "2017-09-04T16:50:58Z", "bug_id": 60523, "creation_time": "2017-09-04T16:50:58Z", "is_private": false, "attachment_id": null}]