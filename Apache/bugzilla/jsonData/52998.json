[{"count": 0, "tags": [], "text": "javax.el.ExpressionFactory.newInstance() implementation in Tomcat 7 does not cache created instance and performs class name discovery on every invocation.\n\nThe discovery process involves looking for the file named\n\"META-INF/services/javax.el.ExpressionFactory\". So every invocation of the method involves looking for and maybe reading the file.\n\n\nThis issue was reported on the dev list, see thread:\n\n[1] \"Two performance problems (found during myfaces testing)\", starting on 2012-03-08,\n- http://tomcat.markmail.org/thread/7bbvzmkvyvryvn44\n- http://marc.info/?t=133124021200002&r=1&w=2\n\nThe above thread [1] also references this one of myfaces:\n[2] \"EL method invocation performance\", 2010-08-25:\n- http://www.mail-archive.com/dev@myfaces.apache.org/msg48482.html\n\n------------------\nMy evaluation is that\n1. This problem is specific for Tomcat 7. - The ExpressionFactory.newInstance() method was added in EL 2.2 and Tomcat 6 does not have it.\n\n2. It hits javax.el.BeanELResolver#invoke() the most, as ExpressionFactory.newInstance() is called on each invocation.\n\n3. There are 2 places where the factory instance is stored in a static field. This is good for performance, but breaks the discovery process and may cause consequences if implementation is bundled in a web application. It is a bug. The places:\n\n org.apache.jasper.runtime.JspApplicationContextImpl.expressionFactory\n org.apache.jasper.compiler.Validator$ValidateVisitor.EXPRESSION_FACTORY", "attachment_id": null, "id": 155353, "creation_time": "2012-03-28T21:16:03Z", "time": "2012-03-28T21:16:03Z", "creator": "knst.kolinko@gmail.com", "bug_id": 52998, "is_private": false}, {"count": 1, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": 28518, "text": "Created attachment 28518\n2012-03-30_tc8_52998_ExpressionFactory.patch\n\nPatch against trunk that implements caching in ExpressionFactory.\n\nNotes:\n1. r1307310 should be ported to 7.0.x before this patch.\n\nMaybe whitespace cleanup r1187778 shall be ported as well.\n\n2. This patch only implements the caching.\n\nThe issue with static references mentioned in Comment 0 is not addressed.\n\n3. There is no way to clean stale cache entries from stopped webapps,\nbut the cache entry objects are small, so I think we can live with it.\n\nWeak references are used, so the class loaders from undeployed apps should be eligible for garbage collection.", "id": 155388, "time": "2012-03-30T10:15:35Z", "bug_id": 52998, "creation_time": "2012-03-30T10:15:35Z", "is_private": false}, {"count": 2, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "I've taken care of the static references in Jasper. I haven't reviewed the patch for the remaining issues yet.", "id": 155409, "time": "2012-03-30T19:34:35Z", "bug_id": 52998, "creation_time": "2012-03-30T19:34:35Z", "is_private": false}, {"count": 3, "tags": [], "text": "Patch looks good to me. I applied it so I can get on with the pre-release testing.", "attachment_id": null, "bug_id": 52998, "id": 155412, "time": "2012-03-30T20:12:54Z", "creator": "markt@apache.org", "creation_time": "2012-03-30T20:12:54Z", "is_private": false}]