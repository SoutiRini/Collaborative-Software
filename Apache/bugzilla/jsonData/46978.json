[{"count": 0, "tags": [], "bug_id": 46978, "attachment_id": null, "id": 126034, "time": "2009-04-06T18:28:04Z", "creator": "garrisot@otc.edu", "creation_time": "2009-04-06T18:28:04Z", "is_private": false, "text": "If using mod_auth_kerb for authentication and mod_authz_ldap for authorization, a page not found will be displayed if you are authenticated with mod_auth_kerb but denied access with mod_authz_ldap.\n\nhttpd.conf\n    AuthType Kerberos\n    AuthName \"Kerberos Login\"\n    KrbMethodNegotiate On\n    KrbMethodK5Passwd Off\n    KrbAuthRealms DOMAIN.COM\n    KrbAuthoritative on\n    Krb5KeyTab /usr/local/etc/apache22/keytab\n    AuthLDAPBindDN \"user@domain.com\"\n    AuthLDAPBindPassword \"password\"\n    AuthLDAPUrl ldap://ADserver:3268/dc=domain,dc=com?userPrincipalName?sub?(objectClass=*)\n    require ldap-group cn=group,OU=Groups,DC=domain,DC=com\n\nerror log\n[Mon Apr 06 13:27:33 2009] [debug] src/mod_auth_kerb.c(1628): [client 1.2.3.4] kerb_authenticate_user entered with user (NULL) and auth_type Kerberos\n[Mon Apr 06 13:27:41 2009] [debug] src/mod_auth_kerb.c(1628): [client 1.2.3.4] kerb_authenticate_user entered with user (NULL) and auth_type Kerberos\n[Mon Apr 06 13:27:41 2009] [debug] src/mod_auth_kerb.c(1240): [client 1.2.3.4] Acquiring creds for HTTP@server.domain.com\n[Mon Apr 06 13:27:41 2009] [debug] src/mod_auth_kerb.c(1385): [client 1.2.3.4] Verifying client data using KRB5 GSS-API with our SPNEGO lib\n[Mon Apr 06 13:27:41 2009] [debug] src/mod_auth_kerb.c(1401): [client 1.2.3.4] Client didn't delegate us their credential\n[Mon Apr 06 13:27:41 2009] [debug] src/mod_auth_kerb.c(1420): [client 1.2.3.4] GSS-API token of length 129 bytes will be sent back\n[Mon Apr 06 13:27:41 2009] [debug] mod_authnz_ldap.c(582): [client 1.2.3.4] ldap authorize: Creating LDAP req structure\n[Mon Apr 06 13:27:41 2009] [debug] mod_authnz_ldap.c(715): [client 1.2.3.4] [77101] auth_ldap authorise: require group: testing for group membership in \"cn=group,OU=Groups,DC=domain,DC=com\"\n[Mon Apr 06 13:27:41 2009] [debug] mod_authnz_ldap.c(721): [client 1.2.3.4] [77101] auth_ldap authorise: require group: testing for member: CN=user,OU=Accounts,DC=domain,DC=com (cn=group,OU=Groups,DC=domain,DC=com)\n[Mon Apr 06 13:27:41 2009] [debug] mod_authnz_ldap.c(737): [client 1.2.3.4] [77101] auth_ldap authorise: require group \"cn=group,OU=Groups,DC=domain,DC=com\": authorisation failed [Comparison false (adding to cache)][Compare False]\n[Mon Apr 06 13:27:41 2009] [debug] mod_authnz_ldap.c(721): [client 1.2.3.4] [77101] auth_ldap authorise: require group: testing for uniquemember: CN=user,OU=Accounts,DC=domain,DC=com (cn=group,OU=Groups,DC=domain,DC=com)\n[Mon Apr 06 13:27:41 2009] [debug] mod_authnz_ldap.c(737): [client 1.2.3.4] [77101] auth_ldap authorise: require group \"cn=group,OU=Groups,DC=domain,DC=com\": authorisation failed [Comparison no such attribute (adding to cache)][No such attribute]\n[Mon Apr 06 13:27:41 2009] [debug] mod_authnz_ldap.c(852): [client 1.2.3.4] [77101] auth_ldap authorise: authorisation denied"}, {"count": 1, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "id": 126035, "time": "2009-04-06T18:50:01Z", "bug_id": 46978, "creation_time": "2009-04-06T18:50:01Z", "is_private": false, "text": "What's a \"page not found\"?  What does your access log say?  What does a command-line client say the response body is?"}, {"count": 2, "tags": [], "bug_id": 46978, "attachment_id": null, "id": 126037, "time": "2009-04-07T06:06:11Z", "creator": "garrisot@otc.edu", "creation_time": "2009-04-07T06:06:11Z", "is_private": false, "text": "httpd-access.log\n1.2.3.4 - - [07/Apr/2009:08:00:14 -0500] \"GET /viewvc/ HTTP/1.1\" 401 401 \"-\" \"Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 1.1.4322; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30; .NET CLR 3.0.04506.648)\"\n1.2.3.4 - user@DOMAIN.COM [07/Apr/2009:08:00:20 -0500] \"GET /viewvc/ HTTP/1.1\" 401 401 \"-\" \"Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 1.1.4322; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30; .NET CLR 3.0.04506.648)\"\n\nlynx does not understand the negotiate header, so I cant test with it"}, {"count": 3, "attachment_id": null, "bug_id": 46978, "is_private": false, "id": 131170, "time": "2009-10-16T07:18:16Z", "creator": "m.beier@enbw.com", "creation_time": "2009-10-16T07:18:16Z", "tags": [], "text": "I can confirm that behaviour. Internet explorer displays his own \"user friendly message\": The page cannot be displayed. Firefox displays the defined ErrorDocument 401 or the apache default message \"Authorization required\". But in fact apache / mod_authnz_ldap should not send an 401, if the user is authenticated by mod_auth_kerb, but has no access due to missing ldap group membership. I would consider a 403 as the correct http status-code, because the access has to be denied.\nI'm using httpd-2.2.13 with mod_auth_kerb 5.4, the configuration is similar to wolfraider.\n\nAuthType                Kerberos\nKrbAuthoritative        off\nKrbMethodNegotiate      on\nAuthName                \"Kerberos Login\"\nKrb5Keytab              /etc/apache22/kerberos/server.keytab\nKrbAuthRealms           DOMAIN\nKrbServiceName          HTTP/server@DOMAIN\nKrbSaveCredentials      off\nKrbDelegateBasic        off\nKrbLocalUserMapping     on\n\nAuthzLDAPAuthoritative  off\nAuthLDAPURL             ldap://server:389/dc=company,dc=org?sAMAccountName?sub\nAuthLDAPRemoteUserAttribute sAMAccountName\nAuthLDAPBindDN          \"cn=user,ou=sys,dc=company,dc=org\"\nAuthLDAPBindPassword    password\nrequire ldap-group CN=MyGroup,OU=WEB,DC=company,DC=org"}, {"count": 4, "text": "Additional information:\n\nUsing \"AuthzLDAPAuthoritative on\":\n[debug] mod_authnz_ldap.c(852): [client xxx] [31060] auth_ldap authorise: authorisation denied\n\nUsing \"AuthzLDAPAuthoritative off\":\n[debug] mod_authnz_ldap.c(847): [client xxx] [30858] auth_ldap authorise: declining to authorise\n[error] [client xxx] access to /xxx/ failed, reason: require directives present and no Authoritative handler.\n\nIn both cases http-status 401 is returned.", "creator": "m.beier@enbw.com", "attachment_id": null, "id": 131172, "time": "2009-10-16T07:31:13Z", "bug_id": 46978, "creation_time": "2009-10-16T07:31:13Z", "tags": [], "is_private": false}, {"count": 5, "tags": [], "text": "You both are getting a 401 because authorization failed.  401 is consistent with other authz modules, since you can change your userid and retry.", "attachment_id": null, "id": 149428, "creation_time": "2011-09-17T20:12:21Z", "time": "2011-09-17T20:12:21Z", "creator": "covener@gmail.com", "bug_id": 46978, "is_private": false}, {"count": 6, "tags": [], "bug_id": 46978, "attachment_id": null, "is_private": false, "id": 149571, "time": "2011-09-21T08:42:22Z", "creator": "m.beier@enbw.com", "creation_time": "2011-09-21T08:42:22Z", "text": "(In reply to comment #5)\n> You both are getting a 401 because authorization failed.  401 is consistent\n> with other authz modules, since you can change your userid and retry.\n\nIn my interpretation authn modules should reply with 401 and authz modules should reply with 403. In our configuration mod_auth_kerb has the authn role and mod_authnz_ldap only has the authz role and must not send an 401. Any reauthentication (and sending 401s) has to be done by mod_auth_kerb.\n\nPlease take a minute and consider that.\n\nThanks,\nMichael"}, {"count": 7, "tags": [], "bug_id": 46978, "attachment_id": null, "id": 149574, "creation_time": "2011-09-21T11:12:35Z", "time": "2011-09-21T11:12:35Z", "creator": "covener@gmail.com", "text": "LDAP behaves like every other standard authz module, save mod_authz_host which is unique, by returning 401.   This is what lets users try different credentials when the current ones aren't sufficient.\n\nThere is a global switch in trunk (http://httpd.apache.org/docs/trunk/mod/mod_authz_core.html#authzsendforbiddenonfailure) to turn authz 401s into 403s.", "is_private": false}]