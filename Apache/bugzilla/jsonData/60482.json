[{"count": 0, "tags": [], "bug_id": 60482, "text": "I'm using Tomcat 8.5.9. It appears that query strings containing percent encoded ampersand (%26) and percent (%25) characters are not parsed correctly when using the HTTP/2 connector. Using HTTP 1.1, it works fine.\n\nTo reproduce:\n\n1) create ROOT/test.jsp with these contents:\n\nfoo=[<%= request.getParameter(\"foo\") %>]\n\n\n2) Set up an HTTPS connector in server.xml that upgrades to HTTP/2 and start the server:\n<Connector port=\"8443\" scheme=\"https\" secure=\"true\" SSLEnabled=\"true\" compression=\"on\" address=\"0.0.0.0\">\n        <UpgradeProtocol className=\"org.apache.coyote.http2.Http2Protocol\" />\n        <SSLHostConfig protocols=\"TLSv1.1+TLSv1.2\">\n            <Certificate certificateKeyFile=\"conf\\tls\\key.pem\"\n                         certificateFile=\"conf\\cert.crt\"\n                         certificateChainFile=\"conf\\tls\\STAR_credentialsmart_net.ca-bundle\" />\n        </SSLHostConfig>\n</Connector>\n\n\n3) Browse to https://localhost:8443/test.jsp?foo=b%26a\n\nThe result is:\nfoo=[b]\n\n4) Now comment out <UpgradeProtocol ...> in the HTTPS connector in server.xml and restart.\n\n5) Browse to https://localhost:8443/test.jsp?foo=b%26a\n\nThe result is:\nfoo=[b&a]\n\nThe access log also shows the URLs differently:\n0:0:0:0:0:0:0:1 - - [15/Dec/2016:02:12:22 -0500] \"GET /test.jsp?foo=b%26a HTTP/1.1\" 200 14\n0:0:0:0:0:0:0:1 - - [15/Dec/2016:02:12:36 -0500] \"GET /test.jsp?foo=b&a HTTP/2.0\" 200 12\n\nAnd the logs show the message:\n14-Dec-2016 23:48:59.846 FINE [catalina-exec-2] org.apache.tomcat.util.http.Parameters.processParameters Parameter starting at position [10] and ending at position [15] with a value of [10] was not followed by an = character", "id": 195502, "time": "2016-12-15T07:28:37Z", "creator": "adaniels085@gmail.com", "creation_time": "2016-12-15T07:28:37Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 60482, "text": "I don't really understand the reason of the URL decoding here: \nhttps://github.com/apache/tomcat/blob/trunk/java/org/apache/coyote/http2/Stream.java#L264\n\nMost likely Parameters always has to do the decoding since we still live with these query string encoding configuration options.", "id": 195504, "time": "2016-12-15T10:32:34Z", "creator": "remm@apache.org", "creation_time": "2016-12-15T10:32:34Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "text": "Other than me not thinking straight, I don't see a reason for that decoding either. Query string decoding has to be deferred to parameter parsing so that encoding of reserved characters - such as '&' - is handled correctly. Should be a simple fix.", "is_private": false, "bug_id": 60482, "id": 195505, "time": "2016-12-15T11:20:54Z", "creator": "markt@apache.org", "creation_time": "2016-12-15T11:20:54Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 60482, "attachment_id": null, "text": "Tests pass, and I added a test case. This will be in 9M16 and 8.5.10.", "id": 195506, "time": "2016-12-15T12:32:58Z", "creator": "remm@apache.org", "creation_time": "2016-12-15T12:32:58Z", "is_private": false}]