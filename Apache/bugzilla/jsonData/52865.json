[{"count": 0, "tags": [], "bug_id": 52865, "attachment_id": null, "text": "To replay it, set the following configuration entries in the httpd.conf:\n\nLoadModule authn_core_module modules/mod_authn_core.so\n<AuthnProviderAlias file file1>\nAuthName \"dfdf\"\n</AuthnProviderAlias>\n\nStart server and you will see the segmentation fault.\n\nI don't quite understand the problem. \n\nI put some printf() in the invoke_cmd() function. It seems that the segfault occurs when it's executing the AuthName directive. The code reaches \u201creturn cmd->AP_TAKE1(parms, mconfig, w);\u201d but does not reach the handler function of the AuthName directive -- set_authname().\n \nPlease check it. \n\nThanks a lot!!!", "id": 154725, "time": "2012-03-09T10:08:37Z", "creator": "tixu@cs.ucsd.edu", "creation_time": "2012-03-09T10:08:37Z", "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 52865, "text": "Oh, sorry, I missed sth in the previous email.\n\nTo replay it, using the following configurations (have to load both modules):\n\nLoadModule authn_core_module modules/mod_authn_core.so\nLoadModule auth_digest_module modules/mod_auth_digest.so\n<AuthnProviderAlias file file1>\nAuthName \"dfdf\"\n</AuthnProviderAlias>\n\nIt seems the two module has some conflicts?\n\n\n\n(In reply to comment #0)\n> To replay it, set the following configuration entries in the httpd.conf:\n> \n> LoadModule authn_core_module modules/mod_authn_core.so\n> <AuthnProviderAlias file file1>\n> AuthName \"dfdf\"\n> </AuthnProviderAlias>\n> \n> Start server and you will see the segmentation fault.\n> \n> I don't quite understand the problem. \n> \n> I put some printf() in the invoke_cmd() function. It seems that the segfault\n> occurs when it's executing the AuthName directive. The code reaches \u201creturn\n> cmd->AP_TAKE1(parms, mconfig, w);\u201d but does not reach the handler function of\n> the AuthName directive -- set_authname().\n> \n> Please check it. \n> \n> Thanks a lot!!!", "id": 154729, "time": "2012-03-09T10:41:42Z", "creator": "tixu@cs.ucsd.edu", "creation_time": "2012-03-09T10:41:42Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "creator": "sf@sfritsch.de", "text": "It seems AuthnProviderAlias breaks some assumption in create_digest_dir_config(). The crash does not happen if I remove these lines:\n\n--- a/modules/aaa/mod_auth_digest.c\n+++ b/modules/aaa/mod_auth_digest.c\n@@ -454,10 +454,6 @@ static void *create_digest_dir_config(apr_pool_t *p, char *dir)\n {\n     digest_config_rec *conf;\n \n-    if (dir == NULL) {\n-        return NULL;\n-    }\n-\n     conf = (digest_config_rec *) apr_pcalloc(p, sizeof(digest_config_rec));\n     if (conf) {\n         conf->qop_list       = apr_palloc(p, sizeof(char*));\n\n\nI haven't tested if this makes AuthnProviderAlias actually work, though. Can you try it?", "id": 154811, "time": "2012-03-12T01:06:14Z", "bug_id": 52865, "creation_time": "2012-03-12T01:06:14Z", "is_private": false, "attachment_id": null}, {"count": 3, "attachment_id": null, "bug_id": 52865, "text": "(In reply to comment #2)\n> It seems AuthnProviderAlias breaks some assumption in\n> create_digest_dir_config(). The crash does not happen if I remove these lines:\n> \n> --- a/modules/aaa/mod_auth_digest.c\n> +++ b/modules/aaa/mod_auth_digest.c\n> @@ -454,10 +454,6 @@ static void *create_digest_dir_config(apr_pool_t *p, char\n> *dir)\n>  {\n>      digest_config_rec *conf;\n> \n> -    if (dir == NULL) {\n> -        return NULL;\n> -    }\n> -\n>      conf = (digest_config_rec *) apr_pcalloc(p, sizeof(digest_config_rec));\n>      if (conf) {\n>          conf->qop_list       = apr_palloc(p, sizeof(char*));\n> \n> \n> I haven't tested if this makes AuthnProviderAlias actually work, though. Can\n> you try it?\n\n\nYes, I tried. Now there's no segfault any more.\nBut actually directives like AuthName and AuthType has no effect in the <AuthnProviderAlias> block.", "id": 154818, "time": "2012-03-12T09:04:58Z", "creator": "tixu@cs.ucsd.edu", "creation_time": "2012-03-12T09:04:58Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "creator": "tixu@cs.ucsd.edu", "attachment_id": null, "text": "(In reply to comment #2)\n> It seems AuthnProviderAlias breaks some assumption in\n> create_digest_dir_config(). The crash does not happen if I remove these lines:\n> \n> --- a/modules/aaa/mod_auth_digest.c\n> +++ b/modules/aaa/mod_auth_digest.c\n> @@ -454,10 +454,6 @@ static void *create_digest_dir_config(apr_pool_t *p, char\n> *dir)\n>  {\n>      digest_config_rec *conf;\n> \n> -    if (dir == NULL) {\n> -        return NULL;\n> -    }\n> -\n>      conf = (digest_config_rec *) apr_pcalloc(p, sizeof(digest_config_rec));\n>      if (conf) {\n>          conf->qop_list       = apr_palloc(p, sizeof(char*));\n> \n> \n> I haven't tested if this makes AuthnProviderAlias actually work, though. Can\n> you try it?\n\nby the way, could you also explain a little bit about the problem?\nthanks a lot!", "id": 154822, "time": "2012-03-12T10:02:03Z", "bug_id": 52865, "creation_time": "2012-03-12T10:02:03Z", "is_private": false}, {"count": 5, "tags": [], "creator": "sf@sfritsch.de", "attachment_id": null, "id": 154842, "time": "2012-03-12T19:44:30Z", "bug_id": 52865, "creation_time": "2012-03-12T19:44:30Z", "is_private": false, "text": "mod_auth_digest tries to avoid allocating memory for its own config struct in global server context because AuthDigestShmemSize, which is its only directive allowed in that context, doesn't need the struct. This optimization breaks with AuthnProviderAlias.\n\nI don't know yet if the correct fix is to make AuthnProviderAlias simulate per-directory context, or if mod_auth_digest should be changed to either not make that optimization, or to detect global server context in a different way.\n\nAlso, I am not familiar enough with AuthnProviderAlias to say if it should support AuthName and AuthType. If yes, then this is probably a different bug than the segfault. If no, AuthnProviderAlias should log an error if these directives are used. Maybe someone more familiar with AuthnProviderAlias could comment?"}, {"count": 6, "tags": [], "creator": "tixu@cs.ucsd.edu", "attachment_id": null, "id": 154858, "time": "2012-03-13T00:28:50Z", "bug_id": 52865, "creation_time": "2012-03-13T00:28:50Z", "is_private": false, "text": "(In reply to comment #5)\n> mod_auth_digest tries to avoid allocating memory for its own config struct in\n> global server context because AuthDigestShmemSize, which is its only directive\n> allowed in that context, doesn't need the struct. This optimization breaks with\n> AuthnProviderAlias.\n> \n> I don't know yet if the correct fix is to make AuthnProviderAlias simulate\n> per-directory context, or if mod_auth_digest should be changed to either not\n> make that optimization, or to detect global server context in a different way.\n> \n\nVielen Dank, Stefan!\n\nI will take a look at this issue. Your information is helpful.\n\n> Also, I am not familiar enough with AuthnProviderAlias to say if it should\n> support AuthName and AuthType. If yes, then this is probably a different bug\n> than the segfault. If no, AuthnProviderAlias should log an error if these\n> directives are used. Maybe someone more familiar with AuthnProviderAlias could\n> comment?\n\nHmmm... this should not be a big thing. There are already too many silent behavior in current Apache :P"}]