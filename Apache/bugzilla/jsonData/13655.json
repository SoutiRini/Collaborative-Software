[{"count": 0, "tags": [], "bug_id": 13655, "text": "Hi Folks,\n\nI've been working with Ant 1.4.1 and Ant 1.5.1 so far.\n\nIn one project we've used both wrappers the Windows\nwrapper \"ant.bat\" and the Unix wrapper \"ant\" from a\nthird party tool that uses the returncodes of these\nscripts to determine if the build has succeeded.\n\nWhile this works out with the Unix wrapper we have\nhad the problem that the Windows wrapper always\nreturned 0 (which normally indicates success) also\nin case of Ant errors.\n\nTo get around this I've added 6 lines of code to\nthe Windows wrapper ant.bat. Key to this solution\nis the fact that command.exe generates a return code\ndifferent to 0 if the last command executed has\nfailed. So we first need to store the return code\nof the JVM call and execute a command that fails\nlike dir \"!!!not_existent!!!\" which normally\ngenerates return code 1.\n\nI've used the same pattern to overwind the\nsetlocal - endlocal boundary.\n\nI would appreciate if you take a look to my solution\nand tell me your opinion about it.\n\nRegards,\n\nMartin\n\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\nSTART: changes to ant.bat 1.5.1: ('+' marks a line to be inserted)\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\n#####################################################\n### CHANGE 1: introduce variable ANT_ERROR and initialize it to 0\n#####################################################\n*** ant.bat\tWed Oct  2 10:55:10 2002\n--- ant.cmd\tTue Oct 15 17:23:24 2002\n***************\n*** 3,8 ****\n--- 3,10 ----\n  REM   Copyright (c) 2001-2002 The Apache Software Foundation.  All rights\n  REM   reserved.\n  \n+ set ANT_ERROR=0\n+ \n  if exist \"%HOME%\\antrc_pre.bat\" call \"%HOME%\\antrc_pre.bat\"\n  \n  if \"%OS%\"==\"Windows_NT\" @setlocal\n***************\n\n#####################################################\n### CHANGE 2: set ANT_ERROR to 1 if Ant has failed\n#####################################################\n*** 77,86 ****\n--- 79,90 ----\n  \n  :runAnt\n  \"%_JAVACMD%\" -classpath \"%LOCALCLASSPATH%\" \"-Dant.home=%ANT_HOME%\" %ANT_OPTS% \norg.apache.tools.ant.Main %ANT_CMD_LINE_ARGS%\n+ if not \"%ERRORLEVEL%\" == \"0\" set ANT_ERROR=1\n  goto end\n  \n  :runAntWithJikes\n  \"%_JAVACMD%\" -classpath \"%LOCALCLASSPATH%\" \"-Dant.home=%ANT_HOME%\" \"-\nDjikes.class.path=%JIKESPATH%\" %ANT_OPTS% org.apache.tools.ant.Main %\nANT_CMD_LINE_ARGS%\n+ if not \"%ERRORLEVEL%\" == \"0\" set ANT_ERROR=1\n  goto end\n  \n  :end\n***************\n\n#####################################################\n### CHANGE 3: lift ANT_ERROR over the setlocal - endlocal boundary\n#####################################################\n#####################################################\n### CHANGE 4: return an errorcode <> 0 in case of Ant errors\n#####################################################\n*** 88,95 ****\n--- 92,104 ----\n  set _JAVACMD=\n  set ANT_CMD_LINE_ARGS=\n  \n+ if \"%OS%\"==\"Windows_NT\" set ERRORLEVEL=0\n+ if \"%OS%\"==\"Windows_NT\" ( if not \"%ANT_ERROR%\" == \"0\" dir \"!!!\nnot_existent!!!\" >nul 2>&1 )\n  if \"%OS%\"==\"Windows_NT\" @endlocal\n+ if \"%OS%\"==\"Windows_NT\" ( if not \"%ERRORLEVEL%\" == \"0\" set ANT_ERROR=1 )\n  \n  :mainEnd\n  if exist \"%HOME%\\antrc_post.bat\" call \"%HOME%\\antrc_post.bat\"\n+ if not \"%ANT_ERROR%\" == \"0\" dir \"!!!not_existent!!!\" >nul 2>&1\n\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\nEND: changes to ant.bat\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\nthe above has been testet under Windows NT 4 and Windows XP", "id": 24552, "attachment_id": null, "creator": "martin.bluemel@siemens.com", "creation_time": "2002-10-15T15:56:35Z", "time": "2002-10-15T15:56:35Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 13655, "text": "Trouble is we have to support the win9x platform too, and they cant handle\nreturn codes properly, which is why the .bat file doesnt do it. \n\nI always recommend using the perl invoker from things like makefiles as it is\nconsistent with return codes across all boxes (that need perl installed, of course).\n\nSo, your patch looks like it works for you, but I dont think we could pull it in\nto the main codebase. Indeed, the batch and .sh files create such an inordinate\namount of support calls we like to avoid touching them whenever they seem stable.\n", "id": 24586, "attachment_id": null, "creator": "stevel@apache.org", "creation_time": "2002-10-15T19:54:31Z", "time": "2002-10-15T19:54:31Z", "is_private": false}, {"count": 2, "tags": [], "creator": "sfllaw@debian.org", "is_private": false, "id": 31938, "creation_time": "2003-02-25T21:01:15Z", "time": "2003-02-25T21:01:15Z", "bug_id": 13655, "text": "Created attachment 5022\nPortable error handling for ant.bat", "attachment_id": 5022}, {"count": 3, "tags": [], "creator": "sfllaw@debian.org", "attachment_id": null, "is_private": false, "id": 31940, "time": "2003-02-25T21:04:22Z", "bug_id": 13655, "creation_time": "2003-02-25T21:04:22Z", "text": "I have run into the exact same problem.  I also have a patch to\nant/src/script/ant.bat that is more useful.  It applies to\nCVS HEAD (currently 1.18.2.8) and has been tested to work on\nWindows 95, Windows NT 4 SP 6, Windows 2000 and Windows XP.\n\nChangelog:\n\t* src/script/ant.bat: Detects build failures and throws\n\t    errors.  It throws ERRORLEVEL 1, and stores Ant's\n\t    return code in %ANT_ERROR%.\n\n\t* src/script/ant.bat: Removed extraneous label."}, {"count": 4, "tags": [], "bug_id": 13655, "text": "Created attachment 7911\nUpdated portable error handling patch against ant/src/script/ant.bat 1.32", "id": 43073, "time": "2003-08-21T04:41:15Z", "creator": "sfllaw@debian.org", "creation_time": "2003-08-21T04:41:15Z", "is_private": false, "attachment_id": 7911}, {"count": 5, "tags": [], "creator": "sommerlade@gmx.net", "is_private": false, "id": 56160, "creation_time": "2004-04-21T12:31:45Z", "time": "2004-04-21T12:31:45Z", "bug_id": 13655, "text": "This bug makes ant on windows useless in automatic build systems, and this \nbuggy behaviour at least deserves a proper hint/warning somewhere in the \ndocumentation.\n", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 13655, "is_private": false, "text": "Created attachment 13849\nupdated ant.bat with proper errorlevel exit\n\nThe other solutions seem overly complicated and set a random variable\n\"ANT_ERROR\".  The proper way to exit a batch file with an error code is to use\nexit /b #.  This works in win2k but not sure about 98.", "id": 69050, "time": "2004-12-28T23:47:28Z", "creator": "phatVee@gmail.com", "creation_time": "2004-12-28T23:47:28Z", "attachment_id": 13849}, {"count": 7, "tags": [], "creator": "scottstirling@gmail.com", "is_private": false, "id": 77561, "creation_time": "2005-07-22T15:42:03Z", "time": "2005-07-22T15:42:03Z", "bug_id": 13655, "text": "This still seems to be a bug in Ant 1.6.5. The fix is easy. Anthill doesn't work\nwithout it. Not sure what other impact it may have. Vote for this bug.", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 13655, "text": "Vince, the exit command doesn't take any options in Windows 9x nor NT4.  My\nsolution, unfortunately, is the most useful one.\n\nTrust me, I had no desire to write something as ugly as my patch.  But portable\nerror handling across Windows batch scripts is non-trivial.\n\nI no longer have any use for Ant on Windows, so I can't update my patch.  But\nI'm sure that someone can figure out what's going on and port it to the most\nrecent version in CVS.", "id": 77564, "time": "2005-07-22T16:00:58Z", "creator": "sfllaw@debian.org", "creation_time": "2005-07-22T16:00:58Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "text": "*** Bug 36970 has been marked as a duplicate of this bug. ***", "is_private": false, "bug_id": 13655, "id": 85159, "time": "2006-01-28T16:10:52Z", "creator": "bodewig@apache.org", "creation_time": "2006-01-28T16:10:52Z", "attachment_id": null}]