[{"count": 0, "tags": [], "bug_id": 31401, "attachment_id": null, "is_private": false, "id": 64164, "time": "2004-09-24T10:56:50Z", "creator": "artem@bizlink.ru", "creation_time": "2004-09-24T10:56:50Z", "text": "http://xxc.bizlink.ru:8000/bugReport/ - the original page.\nhttp://xxc.bizlink.ru/bugReport/ - proxy.\n\n<VirtualHost 195.96.81.34:80>\n  ServerName xxc.bizlink.ru\n  ProxyPass / http://xxc.bizlink.ru:8000/\n  ProxyPassReverse / http://xxc.bizlink.ru:8000/\n  SetOutputFilter proxy-html\n  ProxyHTMLURLMap http://xxc.bizlink.ru:8000 http://xxc.bizlink.ru\n</VirtualHost>\n\nOriginal page have correct UTF-8 both in the html text\nand in the javascript:\n\n8<------------------------------------------------------------------->8\n# wget -SO- http://xxc.bizlink.ru:8000/bugReport/\n--14:26:30--  http://xxc.bizlink.ru:8000/bugReport/\n           => `-'\nResolving xxc.bizlink.ru... done.\nConnecting to xxc.bizlink.ru[195.96.81.34]:8000... connected.\nHTTP request sent, awaiting response... \n 1 HTTP/1.1 200 unknown\n 2 Date: Fri, 24 Sep 2004 10:26:00 GMT\n 3 Server: WebCRM/0.2\n 4 Set-Cookie: wcForumSession1=1m2lm95koqkco_i4jjnc; domain=.bizlink.ru; \nexpires=Mon, 24 Sep 2007 09:26:10 GMT; path=/\n 5 Pragma: no-cache\n 6 Cache-Control: private\n 7 Expires: Fri, 24 Sep 2004 10:26:00 GMT\n 8 Content-Type: text/html; charset=UTF-8\n 9 Connection: close\n\n    [<=>                                                                 ] 0     \n        --.--K/s             <html><body>\nPlain unicode: \"\u00d0\u00bf\u00d1\u20ac\u00d0\u00be\u00d0\u00b2\u00d0\u00b5\u00d1\u20ac\u00d0\u00ba\u00d0\u00b0\".\n<p>\nJS unicode: \n<script language=JavaScript> document.write( \"\u00d0\u00bf\u00d1\u20ac\u00d0\u00be\u00d0\u00b2\u00d0\u00b5\u00d1\u20ac\u00d0\u00ba\u00d0\u00b0\" ); </script>\n</body></html>\n    [ <=>                                                                ] 163   \n        31.84K/s             \n\n14:26:30 (31.84 KB/s) - `-' saved [163]\n8<------------------------------------------------------------------->8\n\nProxy page had lost UTF-8 in the javascript:\n\n8<------------------------------------------------------------------->8\n# wget -SO- http://xxc.bizlink.ru/bugReport/     \n--14:32:31--  http://xxc.bizlink.ru/bugReport/\n           => `-'\nResolving xxc.bizlink.ru... done.\nConnecting to xxc.bizlink.ru[195.96.81.34]:80... connected.\nHTTP request sent, awaiting response... \n 1 HTTP/1.1 200 unknown\n 2 Date: Fri, 24 Sep 2004 10:32:31 GMT\n 3 Server: WebCRM/0.2\n 4 Pragma: no-cache\n 5 Cache-Control: private\n 6 Expires: Fri, 24 Sep 2004 10:26:00 GMT\n 7 Content-Type: text/html;charset=utf-8\n 8 Set-Cookie: wcForumSession1=1r6g0tunu3fm5_i4jjnc; domain=.bizlink.ru; \nexpires=Mon, 24 Sep 2007 09:26:10 GMT; path=/\n 9 Connection: close\n\n    [<=>                                                                 ] 0     \n        --.--K/s             <html><body><p>\nPlain unicode: &quot;\u00d0\u00bf\u00d1\u20ac\u00d0\u00be\u00d0\u00b2\u00d0\u00b5\u00d1\u20ac\u00d0\u00ba\u00d0\u00b0&quot;.\n</p><p>\nJS unicode: \n<script language=\"JavaScript\"> document.write( \"\u00d0\u00d1\u00d0\u00d0\u00d0\u00d1\u00d0\u00d0\" ); </script>\n    [ <=>                                                                ] 176   \n       171.88K/s             \n\n14:32:31 (171.88 KB/s) - `-' saved [176]\n8<------------------------------------------------------------------->8\n\nApache and mod_proxy are both build from unmodified FreeBSD ports:\n\n# pkg_info | grep apache\napache-2.0.50_3     Version 2 of Apache web server with prefork MPM.\n\n# pkg_info | grep mod_\nmod_proxy_html-2.2  Apache module for rewriting HTML links in proxied content\n\n# httpd -V\nServer version: Apache/2.0.50\nServer built:   Sep 23 2004 17:28:35\nServer's Module Magic Number: 20020903:8\nArchitecture:   32-bit\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_FLOCK_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D HTTPD_ROOT=\"/usr/local\"\n -D SUEXEC_BIN=\"/usr/local/bin/suexec\"\n -D DEFAULT_PIDLOG=\"/var/run/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"/var/run/apache_runtime_status\"\n -D DEFAULT_LOCKFILE=\"/var/run/accept.lock\"\n -D DEFAULT_ERRORLOG=\"/var/log/httpd-error.log\"\n -D AP_TYPES_CONFIG_FILE=\"etc/apache2/mime.types\"\n -D SERVER_CONFIG_FILE=\"etc/apache2/httpd.conf\""}, {"count": 1, "tags": [], "text": "On the face of it, this looks like mod_proxy_html, which is a third-party\nmodule, not Apache as such.  I haven't time now, but I'll try and investigate it\nwithin the next couple of days and confirm this.  Reassigning to me (if I've got\nbugzilla right:-)\n\nThanks for the report.", "attachment_id": null, "bug_id": 31401, "id": 64194, "time": "2004-09-24T17:56:40Z", "creator": "nick@webthing.com", "creation_time": "2004-09-24T17:56:40Z", "is_private": false}, {"count": 2, "tags": [], "text": "OK, further investigation.\n\n(1) mod_proxy_html correctly passes your document to the html parser as UTF-8. \nThat's just a single chunk (being 163 bytes:-)\n(2) The CDATA handler (which outputs the javascript) gets the byte sequence we\nsee at the broken URL.  So that's happening within libxml2.\n(3) Libxml2's native tool \"xmllint --html http://xxc.bizlink.ru:8000/bugReport/\"\nproduces a blank string in the javascript.  This is clearly also not what you want.\n(4) I checked your original ( :8000 ) with iconv, and it complains of\niconv: illegal input sequence at position 30\n\nFrom that, I infer either a bug in iconv, or your original document is not\ncorrect UTF-8.  In either case, it's not really an apache or mod_proxy_html bug.\nAnd the behaviour is consistent across platforms: you reported the issue on\nFreeBSD, whereas I tested on Linux.", "is_private": false, "bug_id": 31401, "id": 64211, "time": "2004-09-25T09:37:26Z", "creator": "nick@webthing.com", "creation_time": "2004-09-25T09:37:26Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "artem@bizlink.ru", "attachment_id": null, "is_private": false, "id": 64213, "time": "2004-09-25T12:25:46Z", "bug_id": 31401, "creation_time": "2004-09-25T12:25:46Z", "text": "Forgive me, Nick,\nbut I vonder how did you obtained such results\n(an illegal input sequence error) with iconv?\nI tried both on cygwin and on my failing FreeBSD server with the following:\n\n8<----------------------------------------------------------------->8\nartem@vg:~/delme/$ wget http://xxc.bizlink.ru:8000/bugReport/\n--16:09:26--  http://xxc.bizlink.ru:8000/bugReport/\n           => `index.html'\nResolving xxc.bizlink.ru... done.\nConnecting to xxc.bizlink.ru[195.96.81.34]:8000... connected.\nHTTP request sent, awaiting response... 200 unknown\nLength: unspecified [text/html]\n\n    [ <=>                                                                ] 163 \n        159.18K/s             \n\n16:09:26 (159.18 KB/s) - `index.html' saved [163]\n\nartem@vg:~/delme/$ iconv -f utf-8 -t utf-8 index.html\n<html><body>\nPlain unicode: \"\u00d0\u00bf\u00d1\u20ac\u00d0\u00be\u00d0\u00b2\u00d0\u00b5\u00d1\u20ac\u00d0\u00ba\u00d0\u00b0\".\n<p>\nJS unicode: \n<script language=JavaScript> document.write( \"\u00d0\u00bf\u00d1\u20ac\u00d0\u00be\u00d0\u00b2\u00d0\u00b5\u00d1\u20ac\u00d0\u00ba\u00d0\u00b0\" ); </script>\n</body></html>\nartem@vg:~/delme/$ iconv -f utf-8 -t windows-1251 index.html           \n<html><body>\nPlain unicode: \"\u00ef\u00f0\u00ee\u00e2\u00e5\u00f0\u00ea\u00e0\".\n<p>\nJS unicode: \n<script language=JavaScript> document.write( \"\u00ef\u00f0\u00ee\u00e2\u00e5\u00f0\u00ea\u00e0\" ); </script>\n</body></html>\n8<----------------------------------------------------------------->8\n\nAs you can see, \"iconv\" seems to handle my input pretty well.\n\nFurthermore, MY input is exactly the same both in the 'plain' part and in the\n'javascript' part, but encoding is lost (without reporting any iconv errors,\nBTW) exactly in 'javascript' part, no matter what UTF-8 input is there.\nThat is, the \"sequence at position 30\" (wich is the first occurence of UTF-8)\nis handled ALL RIGHT by the apache, it is the second sequence,\nwhich is exactly the same but resides at position 115, which is corrupted!\nThis clearly indicates that \"illegal input sequence at position 30\" which you\nobtained is not the case."}, {"count": 4, "tags": [], "bug_id": 31401, "attachment_id": null, "text": "The Apache bugzilla database is only for tracking bugs in Apache projects.", "id": 65072, "time": "2004-10-13T15:11:38Z", "creator": "jorton@redhat.com", "creation_time": "2004-10-13T15:11:38Z", "is_private": false}]