[{"count": 0, "tags": [], "text": "I have latest stable Apache 2.2 and mod_fcgid with the following config:\n\n#################################################################### mod_fcgid begin\nAddHandler fcgid-script .php\n\nFcgidMaxRequestsPerProcess 10000\nFcgidFixPathinfo 1\nFcgidZombieScanInterval 5\nFcgidBusyScanInterval 5\nFcgidBusyTimeout 120\nFcgidIOTimeout 120\nFcgidIdleTimeout 300\nFcgidProcessLifetime 3600\n\nFcgidInitialEnv PHP_FCGI_MAX_REQUESTS 10000\nFcgidInitialEnv PHP_FCGI_CHILDREN 0\n\nFcgidWrapper \"/usr/local/phpw3/bin/php-cgi -c /usr/local/apache/conf/php.ini\" .php\nFcgidMinProcessesPerClass 0\nFcgidMaxProcessesPerClass 20\nFcgidMaxProcesses 20\nFcgidPassHeader Authorization\n#################################################################### mod_fcgid end\n\nI just created the following simple test scripts:\ntest1.php:\n<?\nsleep(60);\necho \"hello delayed world! \".date(\"r\");\n?>\n\ntest2.php:\n<?\necho \"hello world! \".date(\"r\");\n?>\n\n\nthen i call test1.php, then a few seconds later test1.php AGAIN, and then test2.php.\nTest2.php returns immediately, as expected, the other two are \"working\".\nIn the process list I can see two php processes spawned.\n\nThen Test1.php returns after 60 seconds, as expected:\nhello delayed world! Tue, 27 Apr 2010 19:59:05 +0200\nbut 2nd instance of test1.php is not finished a few seconds later as expected, since  is is being started just then after 1st instance of test1.php is ready, since it returns this message:\nhello delayed world! Tue, 27 Apr 2010 20:00:05 +0200\n\nWell, the module might be designed this way, but I dont like it. mod_fcgid did not reach the max processes limit, but it enqueued and waited 60 seconds for the 2nd request. This is not really well.\nWould you add some config options to tweak situations like this? For eg. something like FcgidRatherSpawnThanWaitInterval", "is_private": false, "bug_id": 49203, "id": 136462, "time": "2010-04-27T14:12:18Z", "creator": "erno.kovacs@freemail.hu", "creation_time": "2010-04-27T14:12:18Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 49203, "text": "With LogLevel debug, what messages are logged by mod_fcgid when you run this testcase?\n\nI can't reproduce the problem with mod_fcgid 2.3.5 or with the latest from subversion.\n\n[Tue Apr 27 15:01:04 2010] [debug] fcgid_proc_unix.c(354): mod_fcgid: call /export/home/trawick/myhg/apache/fcgid/apps/test1.php with wrapper /usr/php/5.2/bin/php-cgi\n[Tue Apr 27 15:01:04 2010] [info] mod_fcgid: server twcdns.fastsearch.net:/export/home/trawick/myhg/apache/fcgid/apps/test1.php(5383) started\n[Tue Apr 27 15:01:07 2010] [debug] fcgid_proc_unix.c(354): mod_fcgid: call /export/home/trawick/myhg/apache/fcgid/apps/test1.php with wrapper /usr/php/5.2/bin/php-cgi\n[Tue Apr 27 15:01:07 2010] [info] mod_fcgid: server twcdns.fastsearch.net:/export/home/trawick/myhg/apache/fcgid/apps/test1.php(5387) started\n[Tue Apr 27 15:01:10 2010] [debug] fcgid_proc_unix.c(354): mod_fcgid: call /export/home/trawick/myhg/apache/fcgid/apps/test2.php with wrapper /usr/php/5.2/bin/php-cgi\n[Tue Apr 27 15:01:10 2010] [info] mod_fcgid: server twcdns.fastsearch.net:/export/home/trawick/myhg/apache/fcgid/apps/test2.php(5390) started", "id": 136468, "time": "2010-04-27T15:07:00Z", "creator": "trawick@apache.org", "creation_time": "2010-04-27T15:07:00Z", "is_private": false, "attachment_id": null}, {"count": 2, "attachment_id": null, "bug_id": 49203, "is_private": false, "id": 136516, "time": "2010-04-29T09:17:01Z", "creator": "erno.kovacs@freemail.hu", "creation_time": "2010-04-29T09:17:01Z", "tags": [], "text": "output of test1.php instance #1:\nhello delayed world! Thu, 29 Apr 2010 15:12:46 +0200\n\noutput of test1.php instance #2:\nhello delayed world! Thu, 29 Apr 2010 15:13:46 +0200\n\noutput of test2.php:\nhello world! Thu, 29 Apr 2010 15:11:57 +0200\n\nin error_log:\n\n[Thu Apr 29 15:11:46 2010] [debug] fcgid_proc_unix.c(354): mod_fcgid: call DOCROOT/test1.php with wrapper /usr/local/phpw3/bin/php-cgi -c /usr/local/apache/conf/php.ini\n[Thu Apr 29 15:11:46 2010] [info] mod_fcgid: server :DOCROOT/test1.php(25724) started\n[Thu Apr 29 15:11:57 2010] [debug] fcgid_proc_unix.c(354): mod_fcgid: call DOCROOT/test2.php with wrapper /usr/local/phpw3/bin/php-cgi -c /usr/local/apache/conf/php.ini\n[Thu Apr 29 15:11:57 2010] [info] mod_fcgid: server :DOCROOT/test2.php(25725) started\n\n\nthats all."}, {"count": 3, "attachment_id": null, "bug_id": 49203, "is_private": false, "id": 136517, "time": "2010-04-29T09:21:07Z", "creator": "erno.kovacs@freemail.hu", "creation_time": "2010-04-29T09:21:07Z", "tags": [], "text": "it might be another issue related to mod_fcgid+mod_vhost_cdb combination described in my other bug report here: https://issues.apache.org/bugzilla/show_bug.cgi?id=48981"}, {"count": 4, "tags": [], "bug_id": 49203, "text": "Hi Erno,\n\nAre you able to test your outstanding issues using the latest mod_fcgid from svn?\n\nI just committed a change (revision 939472) that solves a vhost-matching problem I encountered, and based on looking at the sources of mod_vhost_cdb I expect it solves a problem with that module as well.\n\nThe aspect that I fixed is related to the observation you made in PR 48981: \"This means virtualhost is the same string but not on the same memory address.\"  (I had seen that some time ago with VirtualHost containers that didn't include unique ServerName directives.)", "id": 136537, "time": "2010-04-29T16:14:18Z", "creator": "trawick@apache.org", "creation_time": "2010-04-29T16:14:18Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 49203, "text": "I just repeated the test with latest mod fcgid from svn.\n\nStarted test1.php, then test1.php again, and then test2.php with a few seconds delay among them.\n\nOutput of test1.php instance #1:\nhello delayed world! Mon, 03 May 2010 00:20:48 +0200\nOutput of test1.php instance #2:\nhello delayed world! Mon, 03 May 2010 00:21:48 +0200\nOutput of test2.php:\nhello world! Mon, 03 May 2010 00:19:52 +0200\n\nfull error_log:\n\n[Mon May 03 00:19:32 2010] [info] mod_ssl/2.2.15 compiled against Server: Apache/2.2.15, Library: OpenSSL/0.9.8g\n[Mon May 03 00:19:32 2010] [info] mod_fcgid: Process manager 18110 started\n[Mon May 03 00:19:32 2010] [notice] Apache/2.2.15 (Unix) mod_ssl/2.2.15 OpenSSL/0.9.8g mod_fcgid/2.3.6-dev configured -- resuming normal operations\n[Mon May 03 00:19:32 2010] [info] Server built: Apr  6 2010 11:11:49\n[Mon May 03 00:19:32 2010] [debug] worker.c(1757): AcceptMutex: sysvsem (default: sysvsem)\n[Mon May 03 00:19:48 2010] [debug] mod_vhost_cdb.c(170): [client MYIP] set_doc_root: server_hostname: DOCROOT\n[Mon May 03 00:19:48 2010] [info] mod_fcgid: server DOCROOT:/usr/local/phpw3/bin/php-cgi(18173) started\n[Mon May 03 00:19:51 2010] [debug] mod_vhost_cdb.c(170): [client MYIP] set_doc_root: server_hostname: DOCROOT\n[Mon May 03 00:19:52 2010] [info] mod_fcgid: server DOCROOT:/usr/local/phpw3/bin/php-cgi(18177) started", "count": 5, "id": 136597, "time": "2010-05-02T18:24:57Z", "creator": "erno.kovacs@freemail.hu", "creation_time": "2010-05-02T18:24:57Z", "is_private": false}, {"count": 6, "attachment_id": null, "bug_id": 49203, "text": "Since I still have the issue, I did some debugging, let me share my experiences.\nStarting test1.php twice then test2.php results the following debug messages:\n\n[Sun May 16 22:59:14 2010] [error] [client myip] mod_fcgid: handle_request for DOCROOT/test1.php\n[Sun May 16 22:59:14 2010] [error] procmgr_peek_cmd returned a command\n[Sun May 16 22:59:14 2010] [error] mod_fcgid: cmdline: /usr/local/phpw3/bin/php-cgi -c /usr/local/apache/conf/php.ini\n[Sun May 16 22:59:14 2010] [error] mod_fcgid: !current_node, spawn ALLOWED\n\n[Sun May 16 22:59:15 2010] [error] [client myip] mod_fcgid: handle_request for DOCROOT/test2.php\n[Sun May 16 22:59:16 2010] [error] procmgr_peek_cmd returned a command\n[Sun May 16 22:59:16 2010] [error] mod_fcgid: cmdline: /usr/local/phpw3/bin/php-cgi -c /usr/local/apache/conf/php.ini\n[Sun May 16 22:59:16 2010] [error] mod_fcgid: score stuff, spawn ALLOWED\n\n[Sun May 16 23:00:14 2010] [error] [client myip] mod_fcgid: handle_request for DOCROOT/test1.php\n\n\nAs you can see, 2nd request to test2.php was started just after 1st one finished, no is_spawn_stuff was called, neither proc manager was touched.\nDo fastcgi processes have any queues ?", "id": 136898, "time": "2010-05-16T17:04:44Z", "creator": "erno.kovacs@freemail.hu", "creation_time": "2010-05-16T17:04:44Z", "tags": [], "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 49203, "text": "I just added some more debug lines to bridge_request and also fcgid_handler, i can say, fcgid_handler (so the \"entry point\") is called with that 60seconds delay as well, so this must be some Apache related \"problem\".", "count": 7, "id": 136899, "time": "2010-05-16T17:13:09Z", "creator": "erno.kovacs@freemail.hu", "creation_time": "2010-05-16T17:13:09Z", "is_private": false}, {"count": 8, "attachment_id": null, "bug_id": 49203, "text": "So, complete logs:\n\n[Sun May 16 23:08:25 2010] [notice] Apache/2.2.15 (Unix) mod_ssl/2.2.15 OpenSSL/0.9.8g mod_fcgid/2.3.6-dev configured -- resuming normal operations\n[Sun May 16 23:08:29 2010] [error] [client my ip] mod_fcgid: fcgid_handler: DOCROOT/test1.php\n[Sun May 16 23:08:29 2010] [error] [client my ip] mod_fcgid: bridge_request for DOCROOT/test1.php\n[Sun May 16 23:08:29 2010] [error] [client my ip] mod_fcgid: handle_request for DOCROOT/test1.php\n[Sun May 16 23:08:29 2010] [error] procmgr_peek_cmd returned a command\n[Sun May 16 23:08:29 2010] [error] mod_fcgid: cmdline: /usr/local/phpw3/bin/php-cgi -c /usr/local/apache/conf/php.ini\n[Sun May 16 23:08:29 2010] [error] mod_fcgid: !current_node, spawn ALLOWED\n[Sun May 16 23:08:30 2010] [error] [client my ip] mod_fcgid: fcgid_handler: DOCROOT/test2.php\n[Sun May 16 23:08:30 2010] [error] [client my ip] mod_fcgid: bridge_request for DOCROOT/test2.php\n[Sun May 16 23:08:30 2010] [error] [client my ip] mod_fcgid: handle_request for DOCROOT/test2.php\n[Sun May 16 23:08:31 2010] [error] procmgr_peek_cmd returned a command\n[Sun May 16 23:08:31 2010] [error] mod_fcgid: cmdline: /usr/local/phpw3/bin/php-cgi -c /usr/local/apache/conf/php.ini\n[Sun May 16 23:08:31 2010] [error] mod_fcgid: score stuff, spawn ALLOWED\n[Sun May 16 23:09:29 2010] [error] [client my ip] mod_fcgid: fcgid_handler: DOCROOT/test1.php\n[Sun May 16 23:09:29 2010] [error] [client my ip] mod_fcgid: bridge_request for DOCROOT/test1.php\n[Sun May 16 23:09:29 2010] [error] [client my ip] mod_fcgid: handle_request for DOCROOT/test1.php", "id": 136900, "time": "2010-05-16T17:19:59Z", "creator": "erno.kovacs@freemail.hu", "creation_time": "2010-05-16T17:19:59Z", "tags": [], "is_private": false}, {"count": 9, "tags": [], "bug_id": 49203, "text": "I forgot to mention in the original post, I am using mpm_worker, it might be related to the issue. Config is almost default:\n\n  MaxClients 400\n  ServerLimit 16\n  StartServers 2\n  MinSpareThreads 25\n  MaxSpareThreads 75\n  ThreadsPerChild 25\n  ThreadStackSize 131072\n  MaxRequestsPerChild  10000", "id": 136901, "time": "2010-05-16T17:26:51Z", "creator": "erno.kovacs@freemail.hu", "creation_time": "2010-05-16T17:26:51Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 49203, "text": "I just tested, I can reproduce the issue using mpm-prefork as well, so its probably not an mpm related problem.\nIf you need me to do any more tests, just let me know.", "id": 136913, "time": "2010-05-17T06:55:53Z", "creator": "erno.kovacs@freemail.hu", "creation_time": "2010-05-17T06:55:53Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "bug_id": 49203, "is_private": false, "id": 136926, "attachment_id": null, "creator": "erno.kovacs@freemail.hu", "creation_time": "2010-05-18T05:30:09Z", "time": "2010-05-18T05:30:09Z", "text": "This way I am not sure any longer if this is an issue of mod_fcgid but the core itself?"}, {"count": 12, "tags": [], "text": "Any hints how to debug this issue?", "is_private": false, "bug_id": 49203, "id": 137060, "time": "2010-05-24T05:30:57Z", "creator": "erno.kovacs@freemail.hu", "creation_time": "2010-05-24T05:30:57Z", "attachment_id": null}, {"count": 13, "attachment_id": null, "bug_id": 49203, "is_private": false, "id": 137078, "time": "2010-05-24T13:33:01Z", "creator": "trawick@apache.org", "creation_time": "2010-05-24T13:33:01Z", "tags": [], "text": "(In reply to comment #12)\n> Any hints how to debug this issue?\n\nHow are you issuing the requests?\n\nCan you run the requests with a couple of telnet or netcat sessions over loopback and see if the delay entering the handler still exists?\n\nsomething vaguely like this, \n\ntelnet 127.0.0.1 80\n>GET /test2.php HTTP/1.1\n>Host: yyy\n>"}, {"count": 14, "tags": [], "creator": "erno.kovacs@freemail.hu", "is_private": false, "text": "You are right. It was indeed a Firefox feature...\nUsing telnet to send the raw requests the module works as expected.\nThank you.", "id": 137081, "time": "2010-05-24T15:37:56Z", "bug_id": 49203, "creation_time": "2010-05-24T15:37:56Z", "attachment_id": null}]