[{"count": 0, "tags": [], "bug_id": 43289, "attachment_id": null, "id": 107639, "time": "2007-09-02T15:02:54Z", "creator": "hno@squid-cache.org", "creation_time": "2007-09-02T15:02:54Z", "is_private": false, "text": "XBitHack full with group execute bit set to enable If-Modified-Since only works\npartially. While it adds the Last-Modified header correctly, subsequent requests\nusing If-Modified-Since results in an empty response (connection closed, no\nresponse headers at all).\n\nThe access.log indicates a 304 response was sent however.. but none is sent to\nthe client."}, {"count": 1, "tags": [], "creator": "hno@squid-cache.org", "attachment_id": null, "is_private": false, "id": 107640, "time": "2007-09-02T15:04:13Z", "bug_id": 43289, "creation_time": "2007-09-02T15:04:13Z", "text": "strace of an request\n\naccept(3, {sa_family=AF_INET, sin_port=htons(40506),\nsin_addr=inet_addr(\"127.0.0.1\")}, [16]) = 8\nfcntl64(8, F_GETFL)                     = 0x2 (flags O_RDWR)\nfcntl64(8, F_SETFL, O_RDWR|O_NONBLOCK)  = 0\nread(8, \"GET / HTTP/1.0\\r\\nIf-Modified-Sinc\"..., 8000) = 386\ngettimeofday({1188770501, 263022}, NULL) = 0\nstat64(\"/export/www/www.henriknordstrom.net/html/\",\n{st_mode=S_IFDIR|S_ISGID|0775, st_size=4096, ...}) = 0\nopen(\"/.htaccess\", O_RDONLY|O_LARGEFILE) = -1 ENOENT (No such file or directory)\nopen(\"/export/.htaccess\", O_RDONLY|O_LARGEFILE) = -1 ENOENT (No such file or\ndirectory)\nopen(\"/export/www/.htaccess\", O_RDONLY|O_LARGEFILE) = -1 ENOENT (No such file or\ndirectory)\nopen(\"/export/www/www.henriknordstrom.net/.htaccess\", O_RDONLY|O_LARGEFILE) = -1\nENOENT (No such file or directory)\nopen(\"/export/www/www.henriknordstrom.net/html/.htaccess\", O_RDONLY|O_LARGEFILE)\n= -1 ENOENT (No such file or directory)\nstat64(\"/export/www/www.henriknordstrom.net/html/index\", 0xbfd0cd8c) = -1 ENOENT\n(No such file or directory)\nlstat64(\"/export\", {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0\nlstat64(\"/export/www\", {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0\nlstat64(\"/export/www/www.henriknordstrom.net\", {st_mode=S_IFDIR|0755,\nst_size=4096, ...}) = 0\nlstat64(\"/export/www/www.henriknordstrom.net/html\",\n{st_mode=S_IFDIR|S_ISGID|0775, st_size=4096, ...}) = 0\nlstat64(\"/export/www/www.henriknordstrom.net/html/index\", 0xbfd0cd8c) = -1\nENOENT (No such file or directory)\nopen(\"/export/www/www.henriknordstrom.net/html/\",\nO_RDONLY|O_NONBLOCK|O_LARGEFILE|O_DIRECTORY) = 9\nfstat64(9, {st_mode=S_IFDIR|S_ISGID|0775, st_size=4096, ...}) = 0\nfcntl64(9, F_SETFD, FD_CLOEXEC)         = 0\ngetdents64(9, /* 38 entries */, 4096)   = 1440\nstat64(\"/export/www/www.henriknordstrom.net/html/index.html\",\n{st_mode=S_IFREG|0754, st_size=862, ...}) = 0\ngetdents64(9, /* 0 entries */, 4096)    = 0\nclose(9)                                = 0\nopen(\"/export/www/www.henriknordstrom.net/html/index.html\",\nO_RDONLY|O_LARGEFILE) = 9\nclose(9)                                = 0\nread(8, 0x8beeb38, 8000)                = -1 EAGAIN (Resource temporarily\nunavailable)\nwrite(7, \"127.0.0.1 www.henriknordstrom.ne\"..., 96) = 96\nshutdown(8, 1 /* send */)               = 0\npoll([{fd=8, events=POLLIN, revents=POLLIN|POLLHUP}], 1, 2000) = 1\nread(8, \"\", 512)                        = 0\nclose(8)                                = 0\nread(4, 0xbfd0d087, 1)                  = -1 EAGAIN (Resource temporarily\nunavailable)\n"}, {"count": 2, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "text": "Can you reproduce this with 2.2.6?  It seems to work fine with the current\n2.2.7-dev branch.\n\n> GET /modules/include/xbithack/full/test.html HTTP/1.1\n> User-Agent: curl/7.16.2 (x86_64-redhat-linux-gnu) libcurl/7.16.2\nOpenSSL/0.9.8b zlib/1.2.3 libidn/0.6.8\n> Host: localhost:8529\n> Accept: */*\n> If-Modified-Since: Mon, 19 Feb 2007 23:48:28 GMT\n> \n< HTTP/1.1 304 Not Modified\n< Date: Fri, 12 Oct 2007 10:55:39 GMT\n< Server: Apache/2.2.7-dev (Unix) mod_ssl/2.2.7-dev OpenSSL/0.9.8b DAV/2\n", "id": 109298, "time": "2007-10-12T03:56:34Z", "bug_id": 43289, "creation_time": "2007-10-12T03:56:34Z", "is_private": false}, {"count": 3, "tags": [], "creator": "david@fastolfe.net", "attachment_id": null, "text": "I'm seeing this with Debian's 2.2.11 build.  I normally sit behind a squid proxy that auto-retries, so this problem was being masked.  I can reliably reproduce it with a browser hitting the site directly.  Occasionally the requests DO succeed, but most fail.  I've confirmed with tcpdump that the HTTP server is closing the connection without sending a response.\n\nThe failures seem to be correlated only with index files with the XBitHack set.  My strace output looks essentially identical to the other poster's.  Here's a diff between a 'good' request and a 'bad' request:\n\n getdents64(18, /* 0 entries */, 4096)   = 0\n close(18)                               = 0\n open(\"/www/fastolfe.net/htdocs/2009/index.html\", O_RDONLY|O_LARGEFILE) = 18\n-mmap2(NULL, 13, PROT_READ, MAP_SHARED, 18, 0) = 0xb7f6c000\n-writev(15, [{\"HTTP/1.1 200 OK\\r\\nDate: Mon, 22 Ju\"..., 342}, {\"Test content\\n\"..., 13}], 2) = 355\n-munmap(0xb7f6c000, 13)                  = 0\n-write(16, \"216.239.45.4 - - - [22/Jun/2009:0\"..., 188) = 188\n+close(18)                               = 0\n+read(15, 0x82ddec8, 8000)               = -1 EAGAIN (Resource temporarily unavailable)\n+write(16, \"216.239.45.4 - - - [22/Jun/2009:1\"..., 187) = 187\n shutdown(15, 1 /* send */)              = 0\n poll([{fd=15, events=POLLIN}], 1, 2000) = 1 ([{fd=15, revents=POLLIN|POLLHUP}])\n read(15, \"\"..., 512)                    = 0\n close(15)                               = 0\n read(7, 0xbf86fb57, 1)                  = -1 EAGAIN (Resource temporarily unavailable)\n-close(18)                               = 0\n-semop(10059778, 0xb7f195d4, 1)          = 0\n-epoll_wait(13, {{EPOLLIN, {u32=137158752, u64=137158752}}}, 2, -1) = 1\n+semop(10059778, 0xb7f195d4, 1\n\nThe bad request fails to mmap the index.html and fails to write a response before closing the connection.\n\nIf I chmod g-x index.html, the file gets delivered reliably.\n\nNothing is logged to the error log, and the access log always reports a normal 304 response.", "id": 128153, "time": "2009-06-22T10:23:31Z", "bug_id": 43289, "creation_time": "2009-06-22T10:23:31Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 43289, "is_private": false, "text": "Note that I am also using MultiViews, so it might be a multi-way interaction.", "id": 128159, "time": "2009-06-22T15:24:44Z", "creator": "david@fastolfe.net", "creation_time": "2009-06-22T15:24:44Z", "attachment_id": null}, {"count": 5, "tags": [], "creator": "zhangweiwu@realss.com", "attachment_id": null, "is_private": false, "id": 144932, "time": "2011-03-11T01:14:24Z", "bug_id": 43289, "creation_time": "2011-03-11T01:14:24Z", "text": "As I experiment this on 2.2.9, either XBitHack on or XBitHack full would cause empty pages in browser for index pages, presumably due to 0-byte pages. chmod g-x does not cure this. Detail of my trial is recorded in bug 45225 and in bug 50914."}]