[{"count": 0, "tags": [], "bug_id": 45950, "attachment_id": null, "is_private": false, "id": 121193, "time": "2008-10-04T20:23:31Z", "creator": "harada@sysrdc.ns-sol.co.jp", "creation_time": "2008-10-04T20:23:31Z", "text": "Workers shared parameter (ex. route) is invalid after graceful restart.\nFor example, my config is like this:\n\nProxyPass /test balancer://mycluster/test stickysession=abc\n<Proxy balancer://mycluster>\n    BalancerMember http://10.1.1.10 route=r10\n    BalancerMember http://10.1.1.20 route=r20\n</Proxy>\n\nOn balancer-manager:\n\nStickySession Timeout FailoverAttempts Method \nabc           0       1                byrequests \nWorker URL       Route RouteRedir Factor Set Status Elected To From\nhttp://10.1.1.10 r10              1      0   Ok     0       0  0\nhttp://10.1.1.20 r20              1      0   Ok     0       0  0\n\nAnd I change the first worker of my config like this:\n\nProxyPass /test balancer://mycluster/test stickysession=abc\n<Proxy balancer://mycluster>\n    BalancerMember http://10.1.1.99 route=r99\n    BalancerMember http://10.1.1.20 route=r20\n</Proxy>\n\nAfter graceful restart, balancer-manager shows:\n\nStickySession Timeout FailoverAttempts Method \nabc           0       1                byrequests \nWorker URL       Route RouteRedir Factor Set Status Elected To From\nhttp://10.1.1.99 r10              1      0   Ok     0       0  0\nhttp://10.1.1.20 r20              1      0   Ok     0       0  0\n\nThe first worker's route is invalid. r99 is expected.\n\nThis bug is caused by not clearing the shared area (scoreboard) on graceful restart.\nThe shared area is cleared on normal restart in pre_mpm hook.\n\nAttached patch is against 2.2.9 and fixes this bug by clearing the shared area.\nThe patch may fix Bug#39811 and Bug#44736."}, {"count": 1, "tags": [], "text": "Created attachment 22671\nClearing the LB-scoreboard patch", "is_private": false, "id": 121194, "creator": "harada@sysrdc.ns-sol.co.jp", "time": "2008-10-04T20:25:07Z", "bug_id": 45950, "creation_time": "2008-10-04T20:25:07Z", "attachment_id": 22671}, {"count": 2, "tags": [], "bug_id": 45950, "attachment_id": null, "id": 121222, "time": "2008-10-06T04:04:00Z", "creator": "rpluem@apache.org", "creation_time": "2008-10-06T04:04:00Z", "is_private": false, "text": "Thanks for the patch, but I think it has some undesired side effects. The problem is that during a graceful restart other processes still use the *old* data in the scoreboard and we cannot simply delete it beneath them. In order to solve this properly some deeper thoughts need to be made how to manage this shared configuration data in a better way."}, {"text": "Created attachment 24487\nfix graceful restart problem\n\nI think this problem was caused by improper use of worker index.\n\nIn http-2.2.14, worker id (member \"id\" of sturct proxy_worker)\nis used for search key of scoreboard data (struct proxy_worker_stat).\nBut worker id is inappropriate value for search key of scoreboad data\nbecause worker id might be changed after graceful restart\nbecause configured number of workers can be changed. \n(struct proxy_worker is not stored in scoreboard so its id is not saved)\n\nShared parameter broken after graceful restart is caused by\nuse of wrong index for scoreboard data.\n\nAttached patch introduces fixed key for scoreboard data\ngenerated from server's hostname and worker name.\nSince these are never changed after graceful restarts,\nit's suitable for search key of scoreboard data.", "tags": [], "creator": "ebisawa@gmail.com", "attachment_id": 24487, "count": 3, "id": 131722, "time": "2009-11-05T02:28:16Z", "bug_id": 45950, "creation_time": "2009-11-05T02:28:16Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 45950, "attachment_id": null, "is_private": false, "id": 134014, "time": "2010-01-29T03:32:09Z", "creator": "olivier.boel@europarl.europa.eu", "creation_time": "2010-01-29T03:32:09Z", "text": "Compiled and installed Apache 2.2.14 on Sparc Solaris 9.\n\nProblem remains : if you modify the configuration (at least adding or removing one or more virtual hosts) and do a graceful restart, scroreboard appears corrupted and load balancing does not keep routes, which causes problems to applications that are not stateless.\n\nTried patch proposed by Satoshi Ebisawa but I get continuous errors at startup [notice] child pid ... exit signal Segmentation fault (11)\nand the web server never works.\n\nDid anybody experience the same problem... and fixed it?\n\nTIA,\n\n\nOlivier"}, {"count": 5, "attachment_id": null, "bug_id": 45950, "is_private": false, "id": 134022, "time": "2010-01-29T06:15:22Z", "creator": "rpluem@apache.org", "creation_time": "2010-01-29T06:15:22Z", "tags": [], "text": "This is a known issue. Do a hard restart of httpd (aka. stop (or graceful stop) and start) when changing these configuration parameters."}, {"text": "This bug can be reproduced with Apache 2.2.19 on Solaris", "tags": [], "creator": "olivier.boel@europarl.europa.eu", "is_private": false, "count": 6, "id": 147908, "time": "2011-07-14T06:20:32Z", "bug_id": 45950, "creation_time": "2011-07-14T06:20:32Z", "attachment_id": null}, {"count": 7, "attachment_id": null, "bug_id": 45950, "is_private": false, "id": 148385, "time": "2011-08-04T14:50:16Z", "creator": "jim@apache.org", "creation_time": "2011-08-04T14:50:16Z", "tags": [], "text": "WONTFIX - 2.2.x does not guarantee local changes via balancer-manager are kept\n\nThis is a feature in 2.3/2.4"}, {"count": 8, "tags": [], "text": "It appears by the WONTFIX comment that this is another instance of the same bug being misread. This is when you actually change the file on the filesystem and do a graceful, apache comes back with the workers all corrupted.\n\nI believe that this may be a duplicate of 44736. I have recently tested in Oracle Linux 6 with httpd-2.2.15-15.0.1.el6.x86_64 from upstream and am seeing same behavior even on a site with little to no traffic.\n\nThe suggestion to restart the server, esp. on a busy server, is completely broken. It causes a significant perceived downtime.\n\n*** This bug has been marked as a duplicate of bug 44736 ***", "is_private": false, "id": 158838, "creator": "tarun@reddyemail.com", "time": "2012-05-04T23:21:18Z", "bug_id": 45950, "creation_time": "2012-05-04T23:21:18Z", "attachment_id": null}]