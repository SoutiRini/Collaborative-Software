[{"count": 0, "tags": [], "bug_id": 58760, "attachment_id": null, "id": 187083, "time": "2015-12-22T13:02:07Z", "creator": "shahar@datorama.com", "creation_time": "2015-12-22T13:02:07Z", "is_private": false, "text": "This is basically the code i'm running to open the woorkbook:\n\ntry (WriterOutputStream baos = new WriterOutputStream(output)) {\n\n\t\t\ttry (PrintStream ps = new PrintStream(baos)) {\n\n\t\t\t\t// The package open is instantaneous, as it should be.\n\t\t\t\ttry (OPCPackage p = OPCPackage.open(file, PackageAccess.READ)) {\n\nand getting:\n\nException in thread \"main\" org.apache.poi.openxml4j.exceptions.InvalidFormatException: The part /xl/sharedStrings.xml does not have any content type ! Rule: Package require content types when retrieving a part from a package. [M.1.14]\n\tat org.apache.poi.openxml4j.opc.ZipPackage.getPartsImpl(ZipPackage.java:247)\n\tat org.apache.poi.openxml4j.opc.OPCPackage.getParts(OPCPackage.java:684)\n\tat org.apache.poi.openxml4j.opc.OPCPackage.open(OPCPackage.java:254)\n\nThis code and file were working fine with poi version 3.10.1"}, {"count": 1, "tags": [], "text": "Can you please attach a sample problematic file?", "attachment_id": null, "bug_id": 58760, "id": 187084, "time": "2015-12-22T13:03:10Z", "creator": "apache@gagravarr.org", "creation_time": "2015-12-22T13:03:10Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 58760, "attachment_id": null, "text": "The file contains sensitive data which i can't expose, the problem is when i open the file in MS excel and save it after some changes, it will fix the problem (excel save action changes the file inner xml files).\nCan you offer maybe a different way to change the file's content without changing its format?", "id": 187085, "time": "2015-12-22T13:07:52Z", "creator": "shahar@datorama.com", "creation_time": "2015-12-22T13:07:52Z", "is_private": false}, {"count": 3, "tags": [], "text": "(In reply to shahar from comment #2)\n> The file contains sensitive data which i can't expose, the problem is when i\n> open the file in MS excel and save it after some changes, it will fix the\n> problem (excel save action changes the file inner xml files).\n> Can you offer maybe a different way to change the file's content without\n> changing its format?\n\nhttp://poi.apache.org/faq.html#faq-N1016C", "is_private": false, "id": 187086, "creator": "apache@gagravarr.org", "time": "2015-12-22T13:10:07Z", "bug_id": 58760, "creation_time": "2015-12-22T13:10:07Z", "attachment_id": null}, {"count": 4, "tags": [], "creator": "shahar@datorama.com", "text": "Created attachment 33367\nAn empty xlsx file that is working with poi 3.10.1 but not with 3.13", "id": 187087, "time": "2015-12-22T13:23:00Z", "bug_id": 58760, "creation_time": "2015-12-22T13:23:00Z", "is_private": false, "attachment_id": 33367}, {"count": 5, "tags": [], "bug_id": 58760, "attachment_id": null, "id": 187088, "time": "2015-12-22T13:28:07Z", "creator": "shahar@datorama.com", "creation_time": "2015-12-22T13:28:07Z", "is_private": false, "text": "Hi,\nI've attached a file with no content that i can open in java code with poi 3.10.1, but with 3.13 i get the above exception."}, {"attachment_id": null, "tags": [], "bug_id": 58760, "is_private": false, "count": 6, "id": 187101, "time": "2015-12-23T13:25:27Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2015-12-23T13:25:27Z", "text": "The cause of the parsing problem is that the XML-files inside the .xlsx file use a strange namespace\n\nYour file has:\n\n<ns0:Types xmlns:ns0=\"http://schemas.openxmlformats.org/package/2006/content-types\">\n  <ns0:Override ContentType=\"application/vnd.openxmlformats-officedocument.theme+xml\" PartName=\"/xl/theme/theme1.xml\" />\n  <ns0:Override ContentType=\"application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml\" PartName=\"/xl/styles.xml\" />\n\nwhereas usually files use the default namespace as follows:\n\n<Types xmlns=\"http://schemas.openxmlformats.org/package/2006/content-types\">\n\t<Default Extension=\"rels\" ContentType=\"application/vnd.openxmlformats-package.relationships+xml\"/>\n\t<Default Extension=\"xml\" ContentType=\"application/xml\"/>\n\t<Override PartName=\"/xl/workbook.xml\" ContentType=\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml\"/>\n\n\nNote the \"ns0:\" prefixes. It seems the parsing in POI does not take the namespace into account here the way that Excel does."}, {"count": 7, "tags": [], "bug_id": 58760, "attachment_id": null, "text": "The thing is that the old poi (3.10.1) did manage to read this xlsx file (so it's kind of BWC break for us).\nIs there a workaround i can do to make it read this file?\n\nThanks", "id": 187102, "time": "2015-12-23T13:28:31Z", "creator": "shahar@datorama.com", "creation_time": "2015-12-23T13:28:31Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 58760, "is_private": false, "id": 187105, "attachment_id": null, "creator": "apache@gagravarr.org", "creation_time": "2015-12-23T14:46:03Z", "time": "2015-12-23T14:46:03Z", "text": "IIRC we switched away from DOM4j in 3.11 to the JVM built-in XML parser, I wonder if we lost the namespace stuff in the process?"}, {"count": 9, "tags": [], "text": "The only workaround without a code-fix that I can think of is to get the Excel file in a format similar to what POI expects currently, i.e. with default-namespace instead of the ns0: one that you have in your file.", "is_private": false, "id": 187106, "creator": "dominik.stadler@gmx.at", "time": "2015-12-23T15:27:21Z", "bug_id": 58760, "creation_time": "2015-12-23T15:27:21Z", "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 58760, "attachment_id": null, "id": 187107, "time": "2015-12-23T15:32:06Z", "creator": "shahar@datorama.com", "creation_time": "2015-12-23T15:32:06Z", "is_private": false, "text": "We get those files from external source, which is probably generated automatically, we don't have the control of how those files are being generated unfortunately."}, {"count": 11, "tags": [], "bug_id": 58760, "is_private": false, "text": "Thanks for the test file, and for working with us on this\n\nIn r1722244, I've added a disabled unit test that uses your file to show up the problem\n\nNow it just needs someone to work out what we're doing wrong in the new secure XML parsing setup, set the appropriate option to fix it, then enable the test...", "id": 187246, "time": "2015-12-29T22:43:20Z", "creator": "apache@gagravarr.org", "creation_time": "2015-12-29T22:43:20Z", "attachment_id": null}, {"count": 12, "tags": [], "text": "I have a potential patch which I will post here shortly for review, it enables namespaces when parsing some of the files to allow to read this file.", "is_private": false, "id": 187250, "creator": "dominik.stadler@gmx.at", "time": "2015-12-30T07:30:16Z", "bug_id": 58760, "creation_time": "2015-12-30T07:30:16Z", "attachment_id": null}, {"count": 13, "tags": [], "text": "I have hopefully fixed this via r1722433, we now use methods to take namespaces into account when reading XML files from within the .xlsx file and thus should handle such differently built files as well. Please give the upcoming nightly build (https://builds.apache.org/view/POI/job/POI/lastSuccessfulBuild/) a try to make sure it is fixed for you as well.", "is_private": false, "id": 187282, "creator": "dominik.stadler@gmx.at", "time": "2015-12-31T10:01:06Z", "bug_id": 58760, "creation_time": "2015-12-31T10:01:06Z", "attachment_id": null}, {"count": 14, "tags": [], "bug_id": 58760, "is_private": false, "id": 187283, "attachment_id": null, "creator": "shahar@datorama.com", "creation_time": "2015-12-31T10:06:08Z", "time": "2015-12-31T10:06:08Z", "text": "Thank you very much!\nI will test it, in which version it supposed to be released?"}, {"count": 15, "tags": [], "bug_id": 58760, "attachment_id": null, "id": 187294, "time": "2015-12-31T20:28:04Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2015-12-31T20:28:04Z", "is_private": false, "text": "It will be contained in the next release which will be either 3.14-beta2 or 3.14-rc1, whichever comes first. Alternatively you can take the binaries produced by the CI builds at https://builds.apache.org/view/POI/job/POI/lastSuccessfulBuild/"}]