[{"count": 0, "tags": [], "creator": "bp@thinkpink.com", "attachment_id": null, "is_private": false, "id": 55181, "time": "2004-04-02T19:05:39Z", "bug_id": 28167, "creation_time": "2004-04-02T19:05:39Z", "text": "If you're running Apache behind a load balancer, an effective way to stop Apache\ngracefully is to change the listen port to something else (say 81) and\ngracefully restart.  Long-lived downloads will continue (making modem users\nhappy) but new connections will (in theory) be refused, allowing your load\nbalancer to pick another box immediately.  After all connections finish or time\nout, Apache will stop.\n\nThat's the theory.\n\nIn practice, the child processes fail to close the main socket after receiving a\ngraceful restart -- they keep the main socket open as well as the worker sockets\nthat are actually doing the work.\n\nThe fix that I'm trying is to close all the listeners' sockets when the listener\nthread exits.  This seems to work, but I need to do some more testing before\nsubmitting diffs."}, {"count": 1, "tags": [], "text": "Any luck with the testing?", "is_private": false, "id": 58839, "creator": "jorton@redhat.com", "time": "2004-06-07T14:29:38Z", "bug_id": 28167, "creation_time": "2004-06-07T14:29:38Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 28167, "attachment_id": null, "id": 58841, "time": "2004-06-07T15:16:23Z", "creator": "bp@thinkpink.com", "creation_time": "2004-06-07T15:16:23Z", "is_private": false, "text": "Yes -- it worked well.  I'm no longer working for the company, though.  I'll get someone to send me \nthe diffs so I can post them."}, {"count": 3, "tags": [], "creator": "bp@thinkpink.com", "is_private": false, "text": "Here are the diffs from .48.  Very straightforward.  This server is in heavy use and we haven't seen \nany problems with it yet, and graceful restarts close the main socket correctly.\n\n==== //depot/httpd-2.0.48-src/server/listen.c#2 (text) ====\n\n\n@@ -387,6 +387,11 @@\n     return num_open ? 0 : -1;\n }\n\n+void ap_close_listeners()\n+{\n+\t(void) close_listeners_on_exec(0);\n+}\n+\n int ap_setup_listeners(server_rec *s)\n {\n     ap_listen_rec *lr;\n\n\n\n==== //depot/httpd-2.0.48-src/server/mpm/worker/worker.c#2 (text) ====\n\n\n@@ -857,6 +857,9 @@\n         }\n     }\n\n+\t/* bp: stop listening to the main socket(s) */\n+\tap_close_listeners();\n+\t\n     ap_queue_term(worker_queue);\n     dying = 1;\n\n", "id": 58852, "time": "2004-06-07T20:44:37Z", "bug_id": 28167, "creation_time": "2004-06-07T20:44:37Z", "attachment_id": null}, {"count": 4, "tags": [], "creator": "chip@force-elite.com", "attachment_id": null, "is_private": false, "id": 66427, "time": "2004-11-04T03:53:34Z", "bug_id": 28167, "creation_time": "2004-11-04T03:53:34Z", "text": "note to self: Investigate adding this to the Event MPM."}, {"count": 5, "tags": [], "bug_id": 28167, "attachment_id": null, "id": 75895, "time": "2005-06-03T02:10:21Z", "creator": "chip@force-elite.com", "creation_time": "2005-06-03T02:10:21Z", "is_private": false, "text": "close enough to a .patch"}, {"count": 6, "tags": [], "creator": "jorton@redhat.com", "is_private": false, "text": "This has been fixed on the trunk.\n\nhttp://svn.apache.org/viewcvs?rev=239711&view=rev", "id": 78942, "time": "2005-08-24T21:09:31Z", "bug_id": 28167, "creation_time": "2005-08-24T21:09:31Z", "attachment_id": null}, {"count": 7, "tags": [], "text": "And then fixed for worker in;\n\nhttp://svn.apache.org/viewcvs?rev=239740&view=rev", "is_private": false, "bug_id": 28167, "id": 78945, "time": "2005-08-24T21:44:23Z", "creator": "colm@apache.org", "creation_time": "2005-08-24T21:44:23Z", "attachment_id": null}]