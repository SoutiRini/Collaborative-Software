[{"count": 0, "tags": [], "bug_id": 56327, "attachment_id": 31451, "text": "Created attachment 31451\nSource code with the fix\n\nUsing MBeans (org.apache.catalina.mbeans.ServiceMBean) it is possible to add a connector during runtime.\n\nAPI says:\n public void addConnector(String address, int port, boolean isAjp, boolean isSSL) \n\n\nEven adding AJP should be possible. However upon looking at the code, it is creating a Connector with default constructor that would set the protocolHandler to HttpProtocolHandler. In other words, to create an AJP connector, protocol should be available during the construction of the Connector.\n\nIt is a simple fix. \n\n   public void addConnector(String address, int port, boolean isAjp, boolean isSSL) throws MBeanException {\n        \n        Service service; \n        try {\n            service = (Service)getManagedResource();\n        } catch (InstanceNotFoundException e) {\n            throw new MBeanException(e);\n        } catch (RuntimeOperationsException e) {\n            throw new MBeanException(e);\n        } catch (InvalidTargetObjectTypeException e) {\n            throw new MBeanException(e);\n        }\n        String protocol = isAjp ? \"AJP/1.3\" : \"HTTP/1.1\";\n        \n\n        // Pass the protocol here rather than setting it later\n         Connector connector = new Connector(protocol);\n   \n        if ((address!=null) && (address.length()>0)) {\n            connector.setProperty(\"address\", address);\n        }\n        connector.setPort(port);\n        connector.setSecure(isSSL);\n        connector.setScheme(isSSL ? \"https\" : \"http\");\n\n        service.addConnector(connector);       \n\n    }", "id": 174149, "time": "2014-03-27T20:53:59Z", "creator": "kgkiran@gmail.com", "creation_time": "2014-03-27T20:53:59Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 56327, "attachment_id": null, "is_private": false, "id": 174156, "time": "2014-03-27T23:26:29Z", "creator": "kgkiran@gmail.com", "creation_time": "2014-03-27T23:26:29Z", "text": "Original Code\n\n50     public void addConnector(String address, int port, boolean isAjp, boolean isSSL) throws MBeanException {\n51         \n52         Service service; \n53         try {\n54             service = (Service)getManagedResource();\n55         } catch (InstanceNotFoundException e) {\n56             throw new MBeanException(e);\n57         } catch (RuntimeOperationsException e) {\n58             throw new MBeanException(e);\n59         } catch (InvalidTargetObjectTypeException e) {\n60             throw new MBeanException(e);\n61         }\n62         \n63         Connector connector = new Connector();\n64         if ((address!=null) && (address.length()>0)) {\n65             connector.setProperty(\"address\", address);\n66         }\n67         \n68         connector.setPort(port);\n69         connector.setProtocol(isAjp ? \"AJP/1.3\" : \"HTTP/1.1\");\n70         connector.setSecure(isSSL);\n71         connector.setScheme(isSSL ? \"https\" : \"http\");\n72 \n73         service.addConnector(connector); \n\n\nLine 63 is the problem. See the how Connector is created by ConnectorCreateRule vs in the ServiceMBean\n\nAlso interesting is the following code in org.apache.catalina.connector.Connector\n   public Connector() {\n        this(null);\n    }\n\n    public Connector(String protocol) {\n        setProtocol(protocol);\n        // Instantiate protocol handler\n        try {\n            Class<?> clazz = Class.forName(protocolHandlerClassName);\n            this.protocolHandler = (ProtocolHandler) clazz.newInstance();\n        } catch (Exception e) {\n            log.error(sm.getString(\n                    \"coyoteConnector.protocolHandlerInstantiationFailed\"), e);\n        }\n    }\nprotocolHandler is created in the beginning and is immutable and by default is Http1.1."}, {"count": 2, "tags": [], "text": "Thanks for the report and the fix.\n\nPatches should be provided in diff -u format rather than as full files as this makes them easier to review.\n\nThe patch has been applied to 8.0.x and will be included in 8.0.6 onwards.", "attachment_id": null, "bug_id": 56327, "id": 174293, "time": "2014-04-04T21:43:34Z", "creator": "markt@apache.org", "creation_time": "2014-04-04T21:43:34Z", "is_private": false}]