[{"text": "Created attachment 32769\npatch against trunk\n\nIn PersistentValve.invoke(Request, Response) method, The Webapp class loader has been bound to the current thread.\nHowever, the original class loader that had been used before bind isn't restored to the thread.\nThe original class loader should be re-bound to the thread.", "tags": [], "creator": "nakamura.kyohei.lab@gmail.com", "attachment_id": 32769, "count": 0, "id": 183229, "time": "2015-06-01T07:40:43Z", "bug_id": 57977, "creation_time": "2015-06-01T07:40:43Z", "is_private": false}, {"text": "Would it be possible to revert the changes (likely whitespace) that don't affect the code at all? It would make for a much cleaner and readable diff.", "tags": [], "bug_id": 57977, "attachment_id": null, "count": 1, "id": 183235, "time": "2015-06-01T13:49:59Z", "creator": "chris@christopherschultz.net", "creation_time": "2015-06-01T13:49:59Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 57977, "attachment_id": 32776, "text": "Created attachment 32776\npatch(rev.1) against trunk.\n\nThank you for your comment.\nI attached the patch that ignored whitespace changes.", "id": 183272, "time": "2015-06-02T05:20:10Z", "creator": "nakamura.kyohei.lab@gmail.com", "creation_time": "2015-06-02T05:20:10Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 57977, "attachment_id": null, "text": "Great! That's much easier to see what you actually changed (just added a try/finally block)! It looked like you had made many more changes than that.", "id": 183296, "time": "2015-06-02T22:17:27Z", "creator": "chris@christopherschultz.net", "creation_time": "2015-06-02T22:17:27Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 57977, "text": "Actually, the patch looks wrong. If the valve is set at the host level (or below), then nothing is needed, the host valve is the one supposed to be doing the context classloader setting. If somehow the valve is located at the engine level, then this looks rather weird (but maybe it's nice if there are lots of vhosts), and in that case it needs to set the context classloader (and some more - normally any such change is supposed to be done with context.(un)bind now).\n\nSince PersistentValve is not documented anywhere, the its use is questionable (non sticky sessions are not really allowed), I'd add a note in the javadoc saying it should be associated to a Host or Context.", "id": 183364, "time": "2015-06-08T15:42:19Z", "creator": "remm@apache.org", "creation_time": "2015-06-08T15:42:19Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 57977, "text": "At the Host level the context class loaders are set in the StandardHostValve which is the basic Valve - i.e. always the last one in the chain. Therefore the clsss loader switching will be required for Hosts and Engines but not Contexts (or Wrappers although I can't think why this would ever be configued on a Wrapper).", "id": 183388, "time": "2015-06-09T11:17:33Z", "creator": "markt@apache.org", "creation_time": "2015-06-09T11:17:33Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 57977, "attachment_id": null, "text": "Very good point about the host, thanks.", "id": 183389, "time": "2015-06-09T11:44:42Z", "creator": "remm@apache.org", "creation_time": "2015-06-09T11:44:42Z", "is_private": false}, {"count": 7, "attachment_id": null, "bug_id": 57977, "is_private": false, "id": 183390, "time": "2015-06-09T11:58:22Z", "creator": "markt@apache.org", "creation_time": "2015-06-09T11:58:22Z", "tags": [], "text": "Fixed in trunk (for 9.0.x), 8.0.x (for 8.0.24 onwards) and 7.0.x\n(for 7.0.63 onwards)."}]