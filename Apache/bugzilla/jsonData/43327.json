[{"attachment_id": null, "tags": [], "bug_id": 43327, "is_private": false, "count": 0, "id": 107822, "time": "2007-09-07T07:22:31Z", "creator": "erjomo@gmail.com", "creation_time": "2007-09-07T07:22:31Z", "text": "I'm running debian sid, kernel 2.6.22 and use tomcat 6.0.14 together with apr\n1.2.11. no special tomcat configuration (out of the box).\nOn start up of tomcat I get the following error log:\n\nDebugging apr revealed a problem with IPV6:\napr_socket_create() assigns a AF_INET6 socket,\napr_socket_bind tries to bind a AF_INET address which fails.\n\nINFO: Loaded Apache Tomcat Native library 1.1.10.\nSep 7, 2007 6:05:16 PM org.apache.catalina.core.AprLifecycleListener init\nINFO: APR capabilities: IPv6 [true], sendfile [true], accept filters [false],\nrandom [true].\nSep 7, 2007 6:05:16 PM org.apache.coyote.http11.Http11AprProtocol init\nSEVERE: Error initializing endpoint\njava.lang.Exception: Socket bind failed: [22] Invalid argument\n    at org.apache.tomcat.util.net.AprEndpoint.init(AprEndpoint.java:612)\n    at org.apache.coyote.http11.Http11AprProtocol.init(Http11AprProtocol.java:121)\n    at org.apache.catalina.connector.Connector.initialize(Connector.java:1059)\n  \nregards\nerik"}, {"count": 1, "tags": [], "bug_id": 43327, "text": "I am having trouble reproducing this error. It may have already been fixed or it may be an issue with your build environment.\n\nPlease can you re-test with the latest APR, openssl, tomcat-native and 6.0.16 and, if you still see this error, provide the exact version numbers and commands you used to build so I can try and repeat this.", "id": 116080, "time": "2008-04-30T15:39:53Z", "creator": "markt@apache.org", "creation_time": "2008-04-30T15:39:53Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 43327, "is_private": false, "count": 2, "id": 117129, "time": "2008-05-29T08:43:02Z", "creator": "david@davidpashley.com", "creation_time": "2008-05-29T08:43:02Z", "text": "I also get this problem.\n\nUsing: \n\n * Tomcat 6.0.16\n * APR 1.2.11-1 from Ubuntu Hardy\n * OpenSSL 0.9.8g-4ubuntu3.1 from Hardy\n * tcnative 1.1.12\n\nI'm attempting to package this for debian and ubuntu. You can fetch the build from my git repo at svn://femme.catnip.org.uk/tomcat6.git"}, {"count": 3, "tags": [], "bug_id": 43327, "attachment_id": null, "text": "That should be git://femme.catnip.org.uk/tomcat6.git\n", "id": 117130, "time": "2008-05-29T08:44:02Z", "creator": "david@davidpashley.com", "creation_time": "2008-05-29T08:44:02Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 43327, "attachment_id": null, "id": 117131, "time": "2008-05-29T08:45:42Z", "creator": "david@davidpashley.com", "creation_time": "2008-05-29T08:45:42Z", "is_private": false, "text": "Suitable snippet from the strace log:\n\n9749  socket(PF_INET6, SOCK_STREAM, IPPROTO_TCP) = 30\n9749  setsockopt(30, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0\n9749  setsockopt(30, SOL_SOCKET, SO_KEEPALIVE, [1], 4) = 0\n9749  bind(30, {sa_family=AF_INET, sin_port=htons(8180), sin_addr=inet_addr(\"0.0.0.0\")}, 16) = -1 EINVAL (Invalid argument)\n"}, {"count": 5, "tags": [], "bug_id": 43327, "attachment_id": null, "id": 117160, "time": "2008-05-29T16:29:24Z", "creator": "markt@apache.org", "creation_time": "2008-05-29T16:29:24Z", "is_private": false, "text": "I still can't reproduce this. I wonder if the some local changes in the Ubuntu packages are involved.\n\nCan you provide step by step instructions to reproduce this using the distros from an Apache mirror rather than the Ubuntu versions. Also, what is the IP config of the machine you are using?"}, {"count": 6, "tags": [], "bug_id": 43327, "text": "I can attempt to build using the tarballs from upstream. Do you have IPv6 enabled on your box, as that appears to be the problem? If you disable IPv6 there isn't a problem. If you enable it, it attempts to create an IPv6 socket and then attempts to bind to an IPv4 address of '0.0.0.0'. \n\nI've checked the packaging of APR in hardy and there are no patches that would affect sockets. There is nothing in the tomcat packaging. ", "id": 117162, "time": "2008-05-29T22:12:40Z", "creator": "david@davidpashley.com", "creation_time": "2008-05-29T22:12:40Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "creator": "david@davidpashley.com", "text": "beebo david% ip addr\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 16436 qdisc noqueue \n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n    inet6 ::1/128 scope host \n       valid_lft forever preferred_lft forever\n2: eth0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc pfifo_fast qlen 1000\n    link/ether 00:09:6b:42:b2:61 brd ff:ff:ff:ff:ff:ff\n3: wifi0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast qlen 1000\n    link/ieee802.11 00:04:e2:63:83:ee brd ff:ff:ff:ff:ff:ff\n4: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue \n    link/ether 00:04:e2:63:83:ee brd ff:ff:ff:ff:ff:ff\n    inet 10.1.0.6/24 brd 10.1.0.255 scope global eth1\n    inet6 fe80::204:e2ff:fe63:83ee/64 scope link \n       valid_lft forever preferred_lft forever\n\nI've attached a script I've used to replicate this bug and the build log. I'm not entirely sure why configure spits out errors. From a cursory glance at the code, it appears to iterate through the environment attempting to eval them all. It doesn't appear to result in any functional problems:\n\n30-May-2008 05:52:43 org.apache.catalina.core.AprLifecycleListener init\nINFO: The APR based Apache Tomcat Native library which allows optimal performance in production environments was not found on the java.library.path: /usr/lib/jvm/java-6-sun-1.6.0.06/jre/lib/i386/client:/usr/lib/jvm/java-6-sun-1.6.0.06/jre/lib/i386:/usr/lib/jvm/java-6-sun-1.6.0.06/jre/../lib/i386:/usr/java/packages/lib/i386:/lib:/usr/lib\n30-May-2008 05:52:43 org.apache.coyote.http11.Http11Protocol init\nINFO: Initializing Coyote HTTP/1.1 on http-8080\n30-May-2008 05:52:43 org.apache.catalina.startup.Catalina load\nINFO: Initialization processed in 1963 ms\n30-May-2008 05:52:44 org.apache.catalina.core.StandardService start\nINFO: Starting service Catalina\n30-May-2008 05:52:44 org.apache.catalina.core.StandardEngine start\nINFO: Starting Servlet Engine: Apache Tomcat/6.0.16\n30-May-2008 05:52:45 org.apache.catalina.core.StandardContext addApplicationListener\nINFO: The listener \"listeners.ContextListener\" is already configured for this context. The duplicate definition has been ignored.\n30-May-2008 05:52:45 org.apache.catalina.core.StandardContext addApplicationListener\nINFO: The listener \"listeners.SessionListener\" is already configured for this context. The duplicate definition has been ignored.\n30-May-2008 05:52:46 org.apache.coyote.http11.Http11Protocol start\nINFO: Starting Coyote HTTP/1.1 on http-8080\n30-May-2008 05:52:46 org.apache.jk.common.ChannelSocket init\nINFO: JK: ajp13 listening on /0.0.0.0:8009\n30-May-2008 05:52:46 org.apache.jk.server.JkMain start\nINFO: Jk running ID=0 time=0/204  config=null\n30-May-2008 05:52:46 org.apache.catalina.startup.Catalina start\nINFO: Server startup in 2795 ms\n30-May-2008 05:52:52 org.apache.coyote.http11.Http11Protocol pause\nINFO: Pausing Coyote HTTP/1.1 on http-8080\n30-May-2008 05:52:53 org.apache.catalina.core.StandardService stop\nINFO: Stopping service Catalina\n30-May-2008 05:52:53 org.apache.coyote.http11.Http11Protocol destroy\nINFO: Stopping Coyote HTTP/1.1 on http-8080\n30-May-2008 05:52:56 org.apache.catalina.core.AprLifecycleListener init\nINFO: Loaded APR based Apache Tomcat Native library 1.1.12.\n30-May-2008 05:52:56 org.apache.catalina.core.AprLifecycleListener init\nINFO: APR capabilities: IPv6 [true], sendfile [true], accept filters [false], random [true].\n30-May-2008 05:53:04 org.apache.catalina.startup.Catalina stopServer\nSEVERE: Catalina.stop: \njava.net.ConnectException: Connection refused\n\tat java.net.PlainSocketImpl.socketConnect(Native Method)\n\tat java.net.PlainSocketImpl.doConnect(PlainSocketImpl.java:333)\n\tat java.net.PlainSocketImpl.connectToAddress(PlainSocketImpl.java:195)\n\tat java.net.PlainSocketImpl.connect(PlainSocketImpl.java:182)\n\tat java.net.SocksSocketImpl.connect(SocksSocketImpl.java:366)\n\tat java.net.Socket.connect(Socket.java:519)\n\tat java.net.Socket.connect(Socket.java:469)\n\tat java.net.Socket.<init>(Socket.java:366)\n\tat java.net.Socket.<init>(Socket.java:180)\n\tat org.apache.catalina.startup.Catalina.stopServer(Catalina.java:421)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:597)\n\tat org.apache.catalina.startup.Bootstrap.stopServer(Bootstrap.java:337)\n\tat org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:415)", "id": 117164, "time": "2008-05-29T22:57:01Z", "bug_id": 43327, "creation_time": "2008-05-29T22:57:01Z", "is_private": false, "attachment_id": null}, {"attachment_id": 22036, "tags": [], "bug_id": 43327, "is_private": false, "count": 8, "id": 117165, "time": "2008-05-29T22:58:04Z", "creator": "david@davidpashley.com", "creation_time": "2008-05-29T22:58:04Z", "text": "Created attachment 22036\nscript to demonstrate problem"}, {"count": 9, "tags": [], "bug_id": 43327, "attachment_id": 22037, "text": "Created attachment 22037\nlogfile of build using the script", "id": 117166, "time": "2008-05-29T22:59:53Z", "creator": "david@davidpashley.com", "creation_time": "2008-05-29T22:59:53Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 43327, "attachment_id": null, "id": 117275, "time": "2008-06-02T23:02:54Z", "creator": "siegmund.gorr@gmail.com", "creation_time": "2008-06-02T23:02:54Z", "is_private": false, "text": "Hi, I could add another target environment with same problems, except that no SSL is being used.\n\nLinux openSUSE-103-64-minimal 2.6.22.9-0.4-default #1 SMP 2007/10/05 21:32:04 UTC x86_64 x86_64 x86_64 GNU/Linux\nTomcat 6.0.14\n\nIt is pretty frigthening that a server help tool like jsvc prevents this lib from working. It looks that the design and integration of jsvc or APR has some side effects. I could not recommend any furhter production use of this combination.\n"}, {"count": 11, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 117277, "time": "2008-06-03T00:06:13Z", "bug_id": 43327, "creation_time": "2008-06-03T00:06:13Z", "is_private": false, "text": "David,\nIPv6 is enabled. I was using tcnative 1.1.13. It might be worth testing with that. Also, could you provide the contents of /etc/network/interfaces and the connector elements of your server.xml. Finally, are you starting with jsvc? Meanwhile, I'll double check I have IPv6 enabled.\n\nSiegmund,\nWhere does jsvc fit into this? Are you saying you only see this issue when starting via jsvc but not when starting from the scripts?"}, {"count": 12, "tags": [], "text": "I did a diff from what is in tomcat6-6.0.16/bin/tcnative.tar.gz and tcnative-1.1.13 and the only differences were svn commit info in the comments, so there is no code difference what so ever.\n\nI am running via jsvc:\nroot      3966  0.0  0.1   2056   364 ?        Ss   May30   0:00 /usr/bin/jsvc -user tomcat6 -cp /usr/share/java/commons-daemon.jar:/usr/share/tomcat6/bin/bootstrap.jar -outfile /var/lib/tomcat6/logs/catalina.out -errfile /usr/share/tomcat6/logs/catalina.err -pidfile /var/run/tomcat6.pid -Djava.awt.headless=true -Xmx128M -Djava.endorsed.dirs=/usr/share/tomcat6/common/endorsed -Dcatalina.base=/var/lib/tomcat6 -Dcatalina.home=/usr/share/tomcat6 -Djava.io.tmpdir=/var/lib/tomcat6/temp -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djava.util.logging.config.file=/var/lib/tomcat6/conf/logging.properties org.apache.catalina.startup.Bootstrap\ntomcat6   3974  0.0 10.4 282728 27484 ?        Sl   May30   2:40 /usr/bin/jsvc -user tomcat6 -cp /usr/share/java/commons-daemon.jar:/usr/share/tomcat6/bin/bootstrap.jar -outfile /var/lib/tomcat6/logs/catalina.out -errfile /usr/share/tomcat6/logs/catalina.err -pidfile /var/run/tomcat6.pid -Djava.awt.headless=true -Xmx128M -Djava.endorsed.dirs=/usr/share/tomcat6/common/endorsed -Dcatalina.base=/var/lib/tomcat6 -Dcatalina.home=/usr/share/tomcat6 -Djava.io.tmpdir=/var/lib/tomcat6/temp -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djava.util.logging.config.file=/var/lib/tomcat6/conf/logging.properties org.apache.catalina.startup.Bootstrap\n\n\nmy interfaces file is:\n\n# This file describes the network interfaces available on your system\n# and how to activate them. For more information, see interfaces(5).\n\n# The loopback network interface\nauto lo\niface lo inet loopback\n\n# The primary network interface\nauto eth0\niface eth0 inet dhcp\n# post-up ethtool -K eth0 tx off\n\n#\n# The commented out line above will disable TCP checksumming which\n# might resolve problems for some users.  It is disabled by default\n#\n\nresults in:\n\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 16436 qdisc noqueue \n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n    inet6 ::1/128 scope host \n       valid_lft forever preferred_lft forever\n2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast qlen 1000\n    link/ether aa:00:0a:00:02:3b brd ff:ff:ff:ff:ff:ff\n    inet 10.0.2.59/16 brd 10.0.255.255 scope global eth0\n    inet6 fe80::a800:aff:fe00:23b/64 scope link \n       valid_lft forever preferred_lft forever\n\n\n\nMy only enabled connectors are:\n\n    <!-- Define a non-SSL HTTP/1.1 Connector on port 8180 -->\n    <Connector port=\"8180\" maxHttpHeaderSize=\"8192\"\n               maxThreads=\"150\" minSpareThreads=\"25\" maxSpareThreads=\"75\"\n               enableLookups=\"false\" redirectPort=\"8443\" acceptCount=\"100\"\n               connectionTimeout=\"20000\" disableUploadTimeout=\"true\" />\n    <!-- Define an AJP 1.3 Connector on port 8009 -->\n    <Connector port=\"8009\" \n               enableLookups=\"false\" redirectPort=\"8443\" protocol=\"AJP/1.3\" />\n", "is_private": false, "id": 117280, "creation_time": "2008-06-03T00:42:48Z", "time": "2008-06-03T00:42:48Z", "creator": "david@davidpashley.com", "bug_id": 43327, "attachment_id": null}, {"count": 13, "tags": [], "bug_id": 43327, "text": "Update on JSVC and APR\n\nInvolving debugging I found that my problem with JSVC and APR could be drilled down to SSL library access I did not found the reason why it hangs - may be the privileges are not sufficient after switching from root to the www-user. After a time period (on my three servers approx. 6 min. the startup suddenly continues - like a timeout has been reached.\n\nMy problems could be resolved by deactivating ssl in the tomcat apr configuration which might be a hint for other server operators as well. \nWe are handling the ssl separat and do not pass the data via the Apache mod_jk module to the AJP handler (which is been boosted by APR).\nSo configuration in httpd.conf is\n\nJkOptions +ForwardkeySize +ForwardURICompat -ForwardDirectories\nJkExtractSSL off\nJkRequestLogFormat \"%w %V %T\"\n\nAnd whithin server.xml\n<Listener className=\"org.apache.catalina.core.AprLifecycleListener\"\n  SSLEngine=\"off\" />\n \nSorry but I did not find the reason why this problems is not existing when we start tomcat without jsvc.\n\n", "id": 117313, "time": "2008-06-03T12:55:11Z", "creator": "siegmund.gorr@gmail.com", "creation_time": "2008-06-03T12:55:11Z", "is_private": false, "attachment_id": null}, {"count": 14, "tags": [], "creator": "markt@apache.org", "text": "Bingo! I can now reproduce this. Hopefully a fix won't be too far away...", "id": 118300, "time": "2008-07-04T14:06:16Z", "bug_id": 43327, "creation_time": "2008-07-04T14:06:16Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "bug_id": 43327, "text": "OK. There are two issues here.\n\nThe first is that the APR calls eventually called as a result of Address.info() and Socket.create() in o.a.t.util.net.AprEndpoint use slightly different logic to determine whether to create an IPv4 socket or an IPv6 socket. If you have an IPv6 capable interface that does not have an explicit IPv6 address defined these functions will assume different IP families.\n\nThe second issue is that whilst the first issue could be fixed by using Address.getInfo().family to specify that the family of the address should be used to use to create the socket, Address.getInfo() does not convert the APR_INET and APR_INET6 constants back into the ones defined in Socket (the constants are different in the Java code and in APR).\n\nSo, I have two patches. The first converts the constants back to the Java defined values and the second uses the family from the address to create the socket. Patches to follow.", "id": 118306, "time": "2008-07-05T15:40:46Z", "creator": "markt@apache.org", "creation_time": "2008-07-05T15:40:46Z", "is_private": false, "attachment_id": null}, {"count": 16, "tags": [], "bug_id": 43327, "text": "Created attachment 22216\nNative patch\n\n*Health Warning*\n\nI am no C programmer. This patch fixes the problem for me but it needs to be checked by someone who actually knows what they are doing.", "id": 118307, "time": "2008-07-05T15:46:22Z", "creator": "markt@apache.org", "creation_time": "2008-07-05T15:46:22Z", "is_private": false, "attachment_id": 22216}, {"count": 17, "tags": [], "bug_id": 43327, "attachment_id": 22217, "id": 118308, "time": "2008-07-05T15:47:22Z", "creator": "markt@apache.org", "creation_time": "2008-07-05T15:47:22Z", "is_private": false, "text": "Created attachment 22217\nAPR Java connector patch\n\nThis needs the native patch to work."}, {"count": 18, "tags": [], "text": "I (finally) tested it on my development machine which has both a NAT IPv4 and an IPv6 address, and it does not appear to work any better.\n\nNo address attribute -> error 22\naddress=\"127.0.0.1\"-> error 22\naddress=\"myIPv6\"-> no error (and ot correctly)", "attachment_id": null, "bug_id": 43327, "id": 119915, "time": "2008-08-19T06:56:16Z", "creator": "remm@apache.org", "creation_time": "2008-08-19T06:56:16Z", "is_private": false}, {"count": 19, "tags": [], "text": "Ok, so I was testing the old version :(\n\nThe new testing result is:\n- no address attribute -> slow bind (20s at least), and does not bind the IPv6\n- address=\"127.0.0.1\"-> works\n- address=\"myIPv6\"-> works\n\nSo it's a lot better, but not glitch free yet.", "attachment_id": null, "bug_id": 43327, "id": 119922, "time": "2008-08-19T10:26:45Z", "creator": "remm@apache.org", "creation_time": "2008-08-19T10:26:45Z", "is_private": false}, {"count": 20, "tags": [], "bug_id": 43327, "text": "Is this true on Linux, Remy?  Or another OS.  Solaris, for example, is known\nto not tolerate sharing an ipv4+6 listener very well.\n\nEssentially, any OS in which the ipv4 stack is built of different driver\ncomponents than the ipv6 stack gives headaches attempting a single listener.\nFor all of these cases, two listening sockets, one explicitly IPv4 and the\nother IPv6 is preferable.", "id": 119923, "time": "2008-08-19T10:57:47Z", "creator": "wrowe@apache.org", "creation_time": "2008-08-19T10:57:47Z", "is_private": false, "attachment_id": null}, {"count": 21, "tags": [], "bug_id": 43327, "attachment_id": null, "id": 119924, "time": "2008-08-19T11:03:58Z", "creator": "remm@apache.org", "creation_time": "2008-08-19T11:03:58Z", "is_private": false, "text": "I am testing on Linux."}, {"count": 22, "tags": [], "bug_id": 43327, "text": "With the latest changes, this now works :) Really tricky to get right ...", "id": 120012, "time": "2008-08-22T01:46:43Z", "creator": "remm@apache.org", "creation_time": "2008-08-22T01:46:43Z", "is_private": false, "attachment_id": null}, {"count": 23, "tags": [], "creator": "jfclere@gmail.com", "attachment_id": null, "id": 120132, "time": "2008-08-27T00:47:34Z", "bug_id": 43327, "creation_time": "2008-08-27T00:47:34Z", "is_private": false, "text": "Fixed in tc-native and trunk proposed for 6.0.x"}, {"count": 24, "tags": [], "text": "how I can add the patch", "attachment_id": null, "id": 139917, "creator": "solange_sun@hotmail.com", "time": "2010-09-17T00:37:16Z", "bug_id": 43327, "creation_time": "2010-09-17T00:37:16Z", "is_private": false}]