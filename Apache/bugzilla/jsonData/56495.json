[{"count": 0, "tags": [], "creator": "dwgoldfarb@yahoo.com", "attachment_id": null, "text": "According to mod_session documentation:  \n\n| Applications behind mod_proxy\n|     If the SessionHeader directive is used to define an HTTP request header, \n| the session, encoded as a application/x-www-form-urlencoded string, will be \n| made available to the application. \n\nI have an application running behind mod_proxy and found that it was getting the encrypted cookie, but not the SessionHeader header defined in the Apache config.\n\nThis seems to fix the issue, although I am unsure if this is in the correct place.\n\n--- httpd-2.4.9.orig/modules/session/mod_session.c   2014-01-24 07:02:42.000000000 -0600\n+++ httpd-2.4.9/modules/session/mod_session.c   2014-05-06 13:59:09.084183389 -0500\n@@ -385,6 +385,13 @@\n\n     /* decode what we have */\n     encoded = apr_pstrdup(r->pool, z->encoded);\n+\n+    /* Add the Decoded session info into the Input Headers\n+     *  for the application to find */\n+    session_dir_conf *conf = ap_get_module_config(r->per_dir_config,\n+                                                  &session_module);\n+    apr_table_set(r->headers_in, conf->header, encoded);\n+\n     pair = apr_strtok(encoded, sep, &last);\n     while (pair && pair[0]) {\n         char *plast = NULL;\n\n\n\nTo Reproduce my issue here is the relevant part of my config in httpd.conf: \n\nLoadModule proxy_module modules/mod_proxy.so\nLoadModule session_module modules/mod_session.so\nLoadModule session_cookie_module modules/mod_session_cookie.so\nLoadModule session_crypto_module modules/mod_session_crypto.so\n\nProxyPass         /somepath      http://localhost:8080/\nProxyPassReverse  /somepath      http://localhost:8080/\n\nSession On\nSessionCookieName session path=/\nSessionHeader X-Replace-Session\nSessionCryptoPassphrase secret\n\n\n\nExecute a listener on port 8080 using netcat:\n\nnc -l localhost 8080\n\n\n\nFrom a browser:\n\nhttp://server.example.com/somepath\n\nAfter mod_session works on the incoming headers, it is forwarded to port 8080\n\n\nThis is what Netcat will show as input from Apache HTTPD to the PROXY'ed application AFTER the fix above:\n\n\n\nGET /somepath HTTP/1.1\nHost: localhost:8080\nUser-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:24.0) Gecko/20140329 Firefox/24.0 PaleMoon/24.4.2\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\nAccept-Language: en-US,en;q=0.5\nAccept-Encoding: gzip, deflate\nDNT: 1\nCookie: session=O5flpvuPQQC4gx0sv22VwA6nGYF+Zcr1jA8+vg9WzxYpZaopNxm1dnbSsRu3C2bKx9TvsOdT6Amgza9JI4HICEnigBVwqt8FBOMj3qNlktLXAUdIIlXKU8d0bZrKNmJk\nX-Replace-Session: key1=value1&key2=value2&key3=value3\nX-Forwarded-For: 10.109.194.71\nX-Forwarded-Host: server.example.com\nX-Forwarded-Server: server.example.com\nConnection: Keep-Alive\n\n\nThe line above: \n\nX-Replace-Session: key1=value1&key2=value2&key3=value3\n\nis not presented to the application in the official versions of httpd as the documentation suggests should happen.", "id": 175063, "time": "2014-05-06T19:19:29Z", "bug_id": 56495, "creation_time": "2014-05-06T19:19:29Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 56495, "attachment_id": null, "id": 187678, "time": "2016-01-14T14:48:25Z", "creator": "mallinger@init.at", "creation_time": "2016-01-14T14:48:25Z", "is_private": false, "text": "I get exactly the same problem, please apply the patch from the reporter."}, {"attachment_id": null, "tags": [], "creator": "luca@memini.it", "text": "A little improvement for David's patch,\n\nCheck conf->header is set to prevent segfault.\n\nthx all\n\nl.\n\n--- httpd-2.4.9.orig/modules/session/mod_session.c   2014-01-24 07:02:42.000000000 -0600\n+++ httpd-2.4.9/modules/session/mod_session.c   2014-05-06 13:59:09.084183389 -0500\n@@ -385,6 +385,13 @@\n\n     /* decode what we have */\n     encoded = apr_pstrdup(r->pool, z->encoded);\n+\n+    /* Add the Decoded session info into the Input Headers\n+     *  for the application to find */\n+    session_dir_conf *conf = ap_get_module_config(r->per_dir_config,\n+                                                  &session_module);\n+    if (conf->header) {  \n+         apr_table_set(r->headers_in, conf->header, encoded);\n+    }  \n+\n     pair = apr_strtok(encoded, sep, &last);\n     while (pair && pair[0]) {\n         char *plast = NULL;", "count": 2, "id": 202272, "time": "2017-11-20T14:44:25Z", "bug_id": 56495, "creation_time": "2017-11-20T14:44:25Z", "is_private": false}]