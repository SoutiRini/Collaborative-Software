[{"count": 0, "tags": [], "creator": "mashmk02@gmail.com", "attachment_id": 22988, "text": "Created attachment 22988\npatch for jk_lb_worker.c\n\nI am using one lb worker with two sub workers. The name of sub workers are 'ajp13w' and 'ajp13w2'.\nThe format of the request log is as follows:\nJkRequestLogFormat \"%w(%R) %V %T\"\n\nWhen the failover occurred in mod_jk 1.2.22, the real worker name output to the request log was 'ajp13w2'.\nHowever, when the failover occurred in mod_jk 1.2.27, the real worker name was 'ajp13w'.\n\nBecause \"s->route\" is not NULL when the failover occurs, it is not overwrited in a new worker name. \n\njk_lb_worker.c\nL1128\n            if (!s->route)\n                s->route = rec->route;\n\nLog of mod_jk 1.2.22:\n-----\n[Thu Dec 04 13:33:29 2008] [25987:13664] [info]  init_jk::mod_jk.c (2743): mod_jk/1.2.22 initialized\n[Thu Dec 04 13:33:29 2008] [25988:13664] [info]  init_jk::mod_jk.c (2743): mod_jk/1.2.22 initialized\n[Thu Dec 04 13:34:04 2008] [25989:18752] [info] jk_open_socket::jk_connect.c (451): connect to 172.20.140.5:8009 failed (errno=115)\n[Thu Dec 04 13:34:04 2008] [25989:18752] [info] ajp_connect_to_endpoint::jk_ajp_common.c (876): Failed opening socket to (172.20.140.5:8009) (errno=115)\n[Thu Dec 04 13:34:04 2008] [25989:18752] [info] ajp_send_request::jk_ajp_common.c (1273): (ajp13w) error connecting to the backend server (errno=115)\n[Thu Dec 04 13:34:04 2008] [25989:18752] [info] ajp_service::jk_ajp_common.c (1941): (ajp13w) sending request to tomcat failed,  recoverable operation attempt=1\n[Thu Dec 04 13:34:09 2008] [25989:18752] [info] jk_open_socket::jk_connect.c (451): connect to 172.20.140.5:8009 failed (errno=115)\n[Thu Dec 04 13:34:09 2008] [25989:18752] [info] ajp_connect_to_endpoint::jk_ajp_common.c (876): Failed opening socket to (172.20.140.5:8009) (errno=115)\n[Thu Dec 04 13:34:09 2008] [25989:18752] [info] ajp_send_request::jk_ajp_common.c (1273): (ajp13w) error connecting to the backend server (errno=115)\n[Thu Dec 04 13:34:09 2008] [25989:18752] [info] ajp_service::jk_ajp_common.c (1941): (ajp13w) sending request to tomcat failed,  recoverable operation attempt=2\n[Thu Dec 04 13:34:09 2008] [25989:18752] [error] ajp_service::jk_ajp_common.c (1953): (ajp13w) Connecting to tomcat failed. Tomcat is probably not started or is listening on the wrong port\n[Thu Dec 04 13:34:09 2008] [25989:18752] [info] service::jk_lb_worker.c (1098): service failed, worker ajp13w is in error state\n[Thu Dec 04 13:34:09 2008] wlb(ajp13w2) localhost 10.007632\n---\n\nLog of mod_jk 1.2.27:\n-----\n[Thu Dec 04 15:27:22.494 2008] [28187:161211744] [info] init_jk::mod_jk.c (3020): mod_jk/1.2.27 initialized\n[Thu Dec 04 15:27:22.509 2008] [28188:161211744] [info] init_jk::mod_jk.c (3020): mod_jk/1.2.27 initialized\n[Thu Dec 04 15:27:33.773 2008] [28190:1123916096] [info] jk_open_socket::jk_connect.c (593): connect to 172.20.140.5:8009 failed (errno=115)\n[Thu Dec 04 15:27:33.773 2008] [28190:1123916096] [info] ajp_connect_to_endpoint::jk_ajp_common.c (922): Failed opening socket to (172.20.140.5:8009) (errno=115)\n[Thu Dec 04 15:27:33.773 2008] [28190:1123916096] [error] ajp_send_request::jk_ajp_common.c (1467): (ajp13w) connecting to backend failed. Tomcat is probably not started or is listening on the wrong port (errno=115)\n[Thu Dec 04 15:27:33.773 2008] [28190:1123916096] [info] ajp_service::jk_ajp_common.c (2407): (ajp13w) sending request to tomcat failed (recoverable), because of error during request sending (attempt=1)\n[Thu Dec 04 15:27:38.874 2008] [28190:1123916096] [info] jk_open_socket::jk_connect.c (593): connect to 172.20.140.5:8009 failed (errno=115)\n[Thu Dec 04 15:27:38.875 2008] [28190:1123916096] [info] ajp_connect_to_endpoint::jk_ajp_common.c (922): Failed opening socket to (172.20.140.5:8009) (errno=115)\n[Thu Dec 04 15:27:38.875 2008] [28190:1123916096] [error] ajp_send_request::jk_ajp_common.c (1467): (ajp13w) connecting to backend failed. Tomcat is probably not started or is listening on the wrong port (errno=115)\n[Thu Dec 04 15:27:38.875 2008] [28190:1123916096] [info] ajp_service::jk_ajp_common.c (2407): (ajp13w) sending request to tomcat failed (recoverable), because of error during request sending (attempt=2)\n[Thu Dec 04 15:27:38.875 2008] [28190:1123916096] [error] ajp_service::jk_ajp_common.c (2426): (ajp13w) connecting to tomcat failed.\n[Thu Dec 04 15:27:38.875 2008] [28190:1123916096] [info] service::jk_lb_worker.c (1347): service failed, worker ajp13w is in error state\n[Thu Dec 04 15:27:38.878 2008] wlb(ajp13w) localhost 10.106069\n---\n\nregards.", "id": 123076, "time": "2008-12-04T05:00:20Z", "bug_id": 46337, "creation_time": "2008-12-04T05:00:20Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 46337, "is_private": false, "id": 123081, "attachment_id": null, "creator": "rainer.jung@kippdata.de", "creation_time": "2008-12-04T06:39:26Z", "time": "2008-12-04T06:39:26Z", "text": "The route in the service struct is used for two purposes:\n\n1) we send it via ajp12 and ajp13 to the backend\n2) we set it in the load balancer and make it available for logging in Apache httpd\n\nAd 1) Unfortunately route is never initialized before sending via AJP and consistently it is never used in the Tomcat AJP connector. I think it would be nice to actually set it to the route of the worker before sending to a backend, and to allow the route contained in the session id to be injected by the request and not only to be statically determined by jvmRoute in server.xml.\n\nAd 2) Here we need to decide consistently, whether we want to make the route which was requested available, or the one we have actually chosen.\n\n"}, {"count": 2, "tags": [], "creator": "rylach@gmail.com", "attachment_id": null, "is_private": false, "id": 133624, "time": "2010-01-15T04:47:33Z", "bug_id": 46337, "creation_time": "2010-01-15T04:47:33Z", "text": "Hi.\nFirst, thanks for excellent work. I'm using mod_jk for quite a long time...\n\nI've just spent some time testing behaviour of retries directive of LB worker, I was very confused finding in log file (format %w(%R)), that after retry the request was served by the same worker, which's backend whasn't working.\n\nMaybe the %R should be split in two directives, 1st for originally selected worked and 2nd one for that, which finally served the request?\n\nBest regards,\n\nR."}, {"count": 3, "tags": [], "bug_id": 46337, "is_private": false, "id": 133625, "attachment_id": null, "creator": "rainer.jung@kippdata.de", "creation_time": "2010-01-15T05:22:27Z", "time": "2010-01-15T05:22:27Z", "text": "(In reply to comment #2)\nPlease let us not discuss your idea here. It does not belong into this issue and should be discussed on the tomcat users list.\n\nOne remark: mod_jk is able to log that information and much more as part of the usual access log. The request logging inside the mod_jk error log might go away some time, because the data is a much better fit for the access log. The JkLogFile should only be used for error logging.\n\nFor information about how to include the info in the access log, learn about LogFormat in\n\nhttp://httpd.apache.org/docs/2.2/mod/mod_log_config.html\n\nand look for \"notes\" in\n\nhttp://tomcat.apache.org/connectors-doc/reference/apache.html"}, {"count": 4, "tags": [], "creator": "rainer.jung@kippdata.de", "attachment_id": null, "text": "After having again looked at the code I'm closing this as WONTFIX.\nPlease use the more powerful access log logging supported by mod_jk via Apache logging notes. I think you get everything you are lokking for that way.\n\nI have updated the docs to favor access log logging instead of the old-style mod_jk request loging in the mod_jk log file.\n\nRegards,\n\nRainer", "id": 179974, "time": "2014-12-22T19:38:52Z", "bug_id": 46337, "creation_time": "2014-12-22T19:38:52Z", "is_private": false}]