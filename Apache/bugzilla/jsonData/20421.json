[{"count": 0, "tags": [], "creator": "jp@2fast.nl", "text": "On a heavy loaded webserver apache 1.3.27 performs well even better with apache\n2.0.46 but the httpd-processes suddenly get killed by a segfault as seen below\nin the error_log:\n\n[Mon Jun 02 17:10:54 2003] [notice] child pid 17306 exit signal Segmentation\nfault (11)\n[Mon Jun 02 17:10:54 2003] [notice] child pid 17305 exit signal Segmentation\nfault (11)\n[Mon Jun 02 17:10:54 2003] [notice] child pid 17266 exit signal Segmentation\nfault (11)\n[Mon Jun 02 17:10:54 2003] [notice] child pid 16839 exit signal Segmentation\nfault (11)\n[Mon Jun 02 17:10:56 2003] [notice] child pid 17381 exit signal Segmentation\nfault (11)\n[Mon Jun 02 17:11:03 2003] [notice] child pid 17479 exit signal Segmentation\nfault (11)\n[Mon Jun 02 17:11:06 2003] [notice] child pid 17485 exit signal Segmentation\nfault (11)\n[Mon Jun 02 17:11:06 2003] [notice] child pid 17477 exit signal Segmentation\nfault (11)\n\n\nBelow the strace output from a proces died by a sigfault, the \"sigreturn()\" till\nthe \"<... rt_sigsuspend resumed>\" line are repeated very often but i neglected\nto paste the whole log in here:\n\nsigreturn()                             = ? (mask now [INT QUIT USR1 ALRM TERM\nSTKFLT CHLD CONT TSTP TTIN TTOU URG XCPU XFSZ VTALRM PROF WINCH IO PWR RTMIN])\naccept(3, {sa_family=AF_INET, sin_port=htons(2120),\nsin_addr=inet_addr(\"213.46.18.75\")}, [16]) = 18\nkill(7377, SIGRTMIN)                    = 0\nkill(7377, SIGRTMIN)                    = 0\nrt_sigprocmask(SIG_SETMASK, NULL, ~[HUP ILL TRAP ABRT BUS FPE KILL SEGV USR2\nPIPE STOP SYS 33], 8) = 0\nrt_sigsuspend(~[HUP ILL TRAP ABRT BUS FPE KILL SEGV USR2 PIPE STOP SYS RTMIN 33]\n<unfinished ...>\n--- SIGRTMIN (Real-time signal 0) @ 0 (0) ---\n<... rt_sigsuspend resumed> )           = -1 EINTR (Interrupted system call)\nsigreturn()                             = ? (mask now [INT QUIT USR1 ALRM TERM\nSTKFLT CHLD CONT TSTP TTIN TTOU URG XCPU XFSZ VTALRM PROF WINCH IO PWR RTMIN])\naccept(3, {sa_family=AF_INET, sin_port=htons(34311),\nsin_addr=inet_addr(\"80.60.121.216\")}, [16]) = 18\nkill(7377, SIGRTMIN)                    = 0\nkill(7377, SIGRTMIN)                    = 0\nrt_sigprocmask(SIG_SETMASK, NULL, ~[HUP ILL TRAP ABRT BUS FPE KILL SEGV USR2\nPIPE STOP SYS 33], 8) = 0\nrt_sigsuspend(~[HUP ILL TRAP ABRT BUS FPE KILL SEGV USR2 PIPE STOP SYS RTMIN 33]\n<unfinished ...>\n--- SIGRTMIN (Real-time signal 0) @ 0 (0) ---\n<... rt_sigsuspend resumed> )           = -1 EINTR (Interrupted system call)\nsigreturn()                             = ? (mask now [INT QUIT USR1 ALRM TERM\nSTKFLT CHLD CONT TSTP TTIN TTOU URG XCPU XFSZ VTALRM PROF WINCH IO PWR RTMIN])\naccept(3, {sa_family=AF_INET, sin_port=htons(4693),\nsin_addr=inet_addr(\"62.163.33.51\")}, [16]) = 18\nkill(7377, SIGRTMIN)                    = 0\nkill(7377, SIGRTMIN)                    = 0\nrt_sigprocmask(SIG_SETMASK, NULL, ~[HUP ILL TRAP ABRT BUS FPE KILL SEGV USR2\nPIPE STOP SYS 33], 8) = 0\nrt_sigsuspend(~[HUP ILL TRAP ABRT BUS FPE KILL SEGV USR2 PIPE STOP SYS RTMIN 33]\n<unfinished ...>\n--- SIGSEGV (Segmentation fault) @ 0 (0) ---", "id": 38187, "time": "2003-06-02T15:24:30Z", "bug_id": 20421, "creation_time": "2003-06-02T15:24:30Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 20421, "is_private": false, "text": "if you set CoreDumpDirectory to point to a dir that the child processes can\nwrite to, do you get a coredump?\n\nthe first goal with a segfault is to know what code is doing something evil... \nnormally that is learned by getting a coredump and using gdb to get a backtrace\nfrom it\n", "id": 38193, "time": "2003-06-02T16:21:20Z", "creator": "trawick@apache.org", "creation_time": "2003-06-02T16:21:20Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 20421, "text": "I don't get a coredump.", "id": 38205, "time": "2003-06-02T19:05:00Z", "creator": "jp@2fast.nl", "creation_time": "2003-06-02T19:05:00Z", "is_private": false, "attachment_id": null}, {"count": 3, "attachment_id": null, "creator": "jp@2fast.nl", "is_private": false, "id": 38295, "time": "2003-06-03T22:02:01Z", "bug_id": 20421, "creation_time": "2003-06-03T22:02:01Z", "tags": [], "text": "steps i've taken to eliminate hardware failures and other factors:\n\n1. build a new kernel on that machine, previous kernel had a memory mngt. patch:\nsegmentation faults kept coming.\n\n2. build httpd with an other gcc compiler (2.95 instead of 3.3): segmentation\nfaults didn't disappear\n\n3. Compiled it on a whole different machine (AMD Atlhon instead of Intel P4)\nwith the same PHP scripts: It's raining segmentation faults\n\nI use debian and on both machines runs Linux 2.4.20 without any patches. My PHP\nversion is 4.3.2 and is build with apxs2. The MPM on apache is worker.\n\nIt has also come to my attention that if I use the following MPM settings\n(ServerLimit 20, TreadsPerChild 35, MaxClients 700) the webserver has a maximum\noutput of 4 mbit/s while with apache 1.3.27 9 mbit/s could been reached. And\nwith the settings (ServerLimit 50, TreadsPerChild 15, MaxClients 750) my\nwebserver died within a few minutes by a segmentation fault on the parent proccess:\n\n[Mon Jun 02 15:59:31 2003] [notice] child pid 11105 exit signal Segmentation\nfault (11)\n[Mon Jun 02 15:59:32 2003] [notice] child pid 11122 exit signal Segmentation\nfault (11)\n[Mon Jun 02 15:59:32 2003] [notice] child pid 11121 exit signal Segmentation\nfault (11)\n[Mon Jun 02 15:59:32 2003] [notice] child pid 11120 exit signal Segmentation\nfault (11)\n[Mon Jun 02 15:59:32 2003] [notice] child pid 11119 exit signal Segmentation\nfault (11)\n[Mon Jun 02 15:59:32 2003] [notice] child pid 11118 exit signal Segmentation\nfault (11)\n[Mon Jun 02 15:59:32 2003] [notice] child pid 11117 exit signal Segmentation\nfault (11)\n[Mon Jun 02 15:59:32 2003] [notice] child pid 11116 exit signal Segmentation\nfault (11)\n[Mon Jun 02 15:59:32 2003] [notice] child pid 11115 exit signal Segmentation\nfault (11)\n[Mon Jun 02 15:59:33 2003] [notice] seg fault or similar nasty error detected in\nthe parent process\n\nAnd i've never saw a coredump in my /tmp"}, {"attachment_id": null, "tags": [], "creator": "thom@planetarytramp.net", "text": "Do the segfaults continue if you remove PHP? The PHP group at this point are strongly \nrecommending that you don't use PHP with a threaded mpm, so if we could remove this as the \ncause of the problem that would be good.", "count": 4, "id": 38297, "time": "2003-06-03T22:12:24Z", "bug_id": 20421, "creation_time": "2003-06-03T22:12:24Z", "is_private": false}, {"count": 5, "tags": [], "text": "I've commented out the loading of the PHP module and disabled the php-vhosts so\nthe only thing that's left is a vhost with lots of static images. In the 30\nminutes the server ran there weren't any segmentation faults.", "is_private": false, "bug_id": 20421, "id": 38298, "time": "2003-06-03T22:50:52Z", "creator": "jp@2fast.nl", "creation_time": "2003-06-03T22:50:52Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 20421, "attachment_id": null, "text": "as far as getting a coredump...  make sure you have \"ulimit -c unlimited\" in the\nshell used to start Apache and that there is available disk space...  beyond\nthat, and setting CoreDumpDirectory, I don't know of anything else to do on\nLinux...  it very well may be that your kernel won't dump for threaded processes", "id": 38299, "time": "2003-06-03T23:02:39Z", "creator": "trawick@apache.org", "creation_time": "2003-06-03T23:02:39Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 20421, "is_private": false, "count": 7, "id": 38300, "time": "2003-06-03T23:11:31Z", "creator": "thom@planetarytramp.net", "creation_time": "2003-06-03T23:11:31Z", "text": "This is not something we can do anything about, unfortunately. It is a PHP bug and I strongly \nsuggest you should file a bug report in their bug tracking system, at bugs.php.net.\nThanks for using Apache!\n"}, {"count": 8, "tags": [], "creator": "jp@2fast.nl", "text": "I've dropped the bug at bugs.php.net (http://bugs.php.net/bug.php?id=24012) but\nafter some research i've got the following reply:\n\n> [5 Jun 7:38am CDT] sniper@php.net\n> And the crash does seem to happen inside Apache anyway..\n\nMeanwhile i've managed to get a core dump and backtraced it:\n\n(gdb) bt\n#0  0x401e1a54 in read () from /lib/libc.so.6\n#1  0x400e9b50 in __JCR_LIST__ () from /lib/libpthread.so.0\n#2  0x08091424 in ap_mpm_pod_check (pod=0x8130528) at pod.c:96\n#3  0x0808fbee in child_main (child_num_arg=14) at worker.c:1308\n#4  0x0808fd3c in make_child (s=0x80d55f8, slot=14) at worker.c:1391\n#5  0x080900e7 in perform_idle_server_maintenance () at worker.c:1552\n#6  0x080902bb in server_main_loop (remaining_children_to_start=0) at\nworker.c:1645\n#7  0x08090518 in ap_mpm_run (_pconf=0x80d1f30, plog=0x8114038,\ns=0x80d55f8) at worker.c:1743\n#8  0x080961ae in main (argc=3, argv=0xbffffd64) at main.c:660\n(gdb) frame 8\n#8  0x080961ae in main (argc=3, argv=0xbffffd64) at main.c:660\n660             if (ap_mpm_run(pconf, plog, server_conf))", "id": 38423, "time": "2003-06-05T12:53:20Z", "bug_id": 20421, "creation_time": "2003-06-05T12:53:20Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 20421, "is_private": false, "text": "The situation \"And the crash does seem to happen inside Apache anyway..\" is just\nthe normal situation where PHP module for Apache has a problem.\n\nThere may be some confusion because the backtrace you got from gdb is for the\nfirst thread of a worker MPM child process, which always sits in read() until\nshutdown.  That isn't the thread that segfaulted.\n\nSee if more than one core dump was written (some levels of Linux write out one\nfor the main process and one for the thread that puked) or if gdb will display\ninfo for other threads in that coredump.\n", "id": 38425, "time": "2003-06-05T13:00:23Z", "creator": "trawick@apache.org", "creation_time": "2003-06-05T13:00:23Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 20421, "is_private": false, "count": 10, "id": 39443, "time": "2003-06-25T22:25:24Z", "creator": "moonwalker@astro.nu", "creation_time": "2003-06-25T22:25:24Z", "text": "Hi, \n \nI get this same error with apache-2.0.46 but ONLY when try to get a page with the \n.html suffix, all other files as .php, .htm, .shtml etc. loads without problem. Isn't that \nstrange and what possibly can be the cause? \n \n/Joakim "}, {"count": 11, "tags": [], "bug_id": 20421, "attachment_id": null, "is_private": false, "id": 39445, "time": "2003-06-25T22:36:17Z", "creator": "trawick@apache.org", "creation_time": "2003-06-25T22:36:17Z", "text": "The only backtrace you were able to get before was for the main\nthread, which sits in read() for eternity, and is not guilty.\n\nI suggest switching to prefork MPM, which should remove lots\nof Linux-specific hurdles to getting documentation on the problem.\n"}, {"attachment_id": null, "tags": [], "creator": "moonwalker@astro.nu", "is_private": false, "count": 12, "id": 39463, "time": "2003-06-26T07:42:44Z", "bug_id": 20421, "creation_time": "2003-06-26T07:42:44Z", "text": "Ok I have found the the seagmentation fault with .html suffix only to be caused by the \nmod_layout-4.0.1a module, so this don't really belong to this bug but may be useful \ninformation for others running into the same wall. Moving over to mod_layout home to \nchase this out... "}, {"count": 13, "tags": [], "bug_id": 20421, "attachment_id": null, "is_private": false, "id": 53753, "time": "2004-03-09T20:47:08Z", "creator": "alex@primafila.net", "creation_time": "2004-03-09T20:47:08Z", "text": "Also on MacOS X running PHP with the worker MPM childs get killed, and httpd stops accepting \nnew connections (but keeps running). Using the prefork MPM all runs fine."}, {"attachment_id": null, "tags": [], "creator": "jorton@redhat.com", "text": "-> closing old bug lacking useful feedback.\n\nReproduce with 2.0.53 and use \"thread apply backtrace full\" in gdb to get a\nmeaningful backtrace from a coredump of a threaded process.", "count": 14, "id": 70843, "time": "2005-02-11T16:57:59Z", "bug_id": 20421, "creation_time": "2005-02-11T16:57:59Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "taskazan@metu.edu.tr", "is_private": false, "count": 15, "id": 70988, "time": "2005-02-15T10:54:31Z", "bug_id": 20421, "creation_time": "2005-02-15T10:54:31Z", "text": "We have used apache 2.0.50 with php 4.3.10 without any problem. But after the\nannouncement of apache 2.0.53, we tried to run apache 2.0.53 with php 4.3.10,\nbut we get \n[Mon Feb 14 17:14:26 2005] [notice] child pid 16787 exit signal Segmentation\nfault (11)\n[Mon Feb 14 17:14:27 2005] [notice] child pid 16789 exit signal Segmentation\nfault (11)\n[Mon Feb 14 17:14:28 2005] [notice] child pid 16802 exit signal Segmentation\nfault (11)\n.....\n\nWhen we try to debug httpd binary,\n# gdb /usr/local/httpd-2.0.53/bin/httpd\nGNU gdb 2002-04-01-cvs\nCopyright 2002 Free Software Foundation, Inc.\nGDB is free software, covered by the GNU General Public License, and you are\nwelcome to change it and/or distribute copies of it under certain conditions.\nType \"show copying\" to see the conditions.\nThere is absolutely no warranty for GDB.  Type \"show warranty\" for details.\nThis GDB was configured as \"i386-linux\"...\n\n(gdb) run -X\nStarting program: /usr/local/httpd-2.0.53/bin/httpd -X\n[New Thread 1024 (LWP 27979)]\n\nProgram received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 1024 (LWP 27979)]\napr_proc_mutex_child_init (mutex=0x4, fname=0x821dd98 \"\\xef\\xbf\\xbd031\\b\",\npool=0x821dd98)\n    at proc_mutex.c:818\n818     proc_mutex.c: No such file or directory.\n        in proc_mutex.c\n(gdb) bt\n#0  apr_proc_mutex_child_init (mutex=0x4, fname=0x821dd98 \"\\xef\\xbf\\xbd031\\b\",\npool=0x8\n21dd98)\n    at proc_mutex.c:818\n#1  0x4014abd2 in apr_global_mutex_child_init (mutex=0x821dd98,\n    fname=0x821dd98 \"\\xef\\xbf\\xbd031\\b\", pool=0x821dd98) at global_mutex.c:88\n#2  0x0807f986 in util_ldap_child_init (p=0x821dd98, s=0x81d86d0) at\nutil_ldap.c:1615\n#3  0x080bb90d in ap_run_child_init (pchild=0x821dd98, s=0x81d86d0) at config.c:150\n#4  0x080b901f in child_main (child_num_arg=136437144) at worker.c:1104\n#5  0x080b93a6 in make_child (s=0x821dd98, slot=0) at worker.c:1248\n#6  0x080b9439 in startup_children (number_to_start=0) at worker.c:1302\n#7  0x080b9e7a in ap_mpm_run (_pconf=0x819b4f8, plog=0x81d35d8, s=0x0)\n    at worker.c:1617\n#8  0x080c113f in main (argc=2, argv=0xbffffc74) at main.c:618\n(gdb)\n\nWe have used same php versions, but different apache2 versions and get\nsegmentation fault. We think that this may be a bug in apache 2.0.53\n\nYours,\n\n\n\n(In reply to comment #14)\n> -> closing old bug lacking useful feedback.\n> \n> Reproduce with 2.0.53 and use \"thread apply backtrace full\" in gdb to get a\n> meaningful backtrace from a coredump of a threaded process.\n\n"}, {"attachment_id": null, "tags": [], "creator": "jorton@redhat.com", "is_private": false, "count": 16, "id": 70998, "time": "2005-02-15T14:33:23Z", "bug_id": 20421, "creation_time": "2005-02-15T14:33:23Z", "text": "Can you try adding \"LDAPSharedCacheFile /tmp/ldap_cache\" or suchlike, or just\nremove the LDAP modules from the configuration if you're not using them?"}, {"attachment_id": null, "tags": [], "bug_id": 20421, "is_private": false, "count": 17, "id": 71009, "time": "2005-02-15T16:34:31Z", "creator": "taskazan@metu.edu.tr", "creation_time": "2005-02-15T16:34:31Z", "text": "(In reply to comment #16)\n> Can you try adding \"LDAPSharedCacheFile /tmp/ldap_cache\" or suchlike, or just\n> remove the LDAP modules from the configuration if you're not using them?\n\nIn my configuration file: \n\nLDAPSharedCacheSize 0\nLDAPCacheEntries 0\nLDAPCacheTTL 0\nLDAPOpCacheEntries 0\nLDAPOpCacheTTL 0\nLDAPTrustedCA /usr/local/apache/certs/cacert.txt\nLDAPTrustedCAType  BASE64_FILE\n\nThese confgurations are open, I try to add LDAPSharedCacheFile /tmp/ldap_cache,\nand delete LDAPSharedCacheSize line, then my httpd is worked without any problem. \n\nThank you for your interest..\n\n--feyza\n"}, {"count": 18, "tags": [], "text": "The original report here is still lacking useful backtrace information; see this\nlink for instructions on how to obtain a backtrace:\n\n  http://httpd.apache.org/dev/debugging.html#crashes", "is_private": false, "bug_id": 20421, "id": 79552, "time": "2005-09-07T17:27:30Z", "creator": "jorton@redhat.com", "creation_time": "2005-09-07T17:27:30Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 20421, "text": "Closing stale report for old release, lacking backtrace.", "count": 19, "id": 81899, "time": "2005-10-28T17:37:19Z", "creator": "jorton@redhat.com", "creation_time": "2005-10-28T17:37:19Z", "is_private": false}]