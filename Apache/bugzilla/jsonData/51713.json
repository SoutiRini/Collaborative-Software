[{"count": 0, "tags": [], "bug_id": 51713, "is_private": false, "text": "Under the following configuration, an NPE is thrown because _setExecutor() calls con.getProtocolHandler().getClass() when the protocol handler is null.\n\nIt would be nice to report a bad configuration instead of suffering an NPE.\n\nserver.xml:\n\n    <Executor name=\"tomcatThreadPool\" namePrefix=\"catalina-exec-\"\n        maxThreads=\"150\" minSpareThreads=\"4\"/>\n\n    <Connector port=\"12345\"\n               redirectPort=\"443\" protocol=\"HTTP\"\n               secure=\"true\" scheme=\"https\" proxyPort=\"80\"\n               URIEncoding=\"UTF-8\" executor=\"tomcatThreadPool\" />\n\ncatalina.out:\n\nAug 23, 2011 5:18:30 PM org.apache.catalina.connector.Connector <init>\nSEVERE: Protocol handler instantiation failed\nAug 23, 2011 5:18:30 PM org.apache.tomcat.util.digester.Digester startElement\nSEVERE: Begin event threw exception\njava.lang.NullPointerException\n        at org.apache.catalina.startup.ConnectorCreateRule._setExecutor(ConnectorCreateRule.java:69)\n        at org.apache.catalina.startup.ConnectorCreateRule.begin(ConnectorCreateRule.java:63)\n        at org.apache.tomcat.util.digester.Digester.startElement(Digester.java:1276)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.startElement(AbstractSAXParser.java:501)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractXMLDocumentParser.emptyElement(AbstractXMLDocumentParser.java:179)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanStartElement(XMLDocumentFragmentScannerImpl.java:1343)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl$FragmentContentDriver.next(XMLDocumentFragmentScannerImpl.java:2755)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentScannerImpl.next(XMLDocumentScannerImpl.java:648)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanDocument(XMLDocumentFragmentScannerImpl.java:511)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:808)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:737)\n        at com.sun.org.apache.xerces.internal.parsers.XMLParser.parse(XMLParser.java:119)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.parse(AbstractSAXParser.java:1205)\n        at com.sun.org.apache.xerces.internal.jaxp.SAXParserImpl$JAXPSAXParser.parse(SAXParserImpl.java:522)\n        at org.apache.tomcat.util.digester.Digester.parse(Digester.java:1537)\n        at org.apache.catalina.startup.Catalina.load(Catalina.java:555)\n        at org.apache.catalina.startup.Catalina.load(Catalina.java:596)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.catalina.startup.Bootstrap.load(Bootstrap.java:281)\n        at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:449)\n\n\nAug 23, 2011 5:18:30 PM org.apache.catalina.startup.Catalina load\nWARNING: Catalina.start using conf/server.xml: Error at (104, 66) : null\nAug 23, 2011 5:18:30 PM org.apache.catalina.connector.Connector <init>\nSEVERE: Protocol handler instantiation failed\nAug 23, 2011 5:18:30 PM org.apache.tomcat.util.digester.Digester startElement\nSEVERE: Begin event threw exception\njava.lang.NullPointerException\n        at org.apache.catalina.startup.ConnectorCreateRule._setExecutor(ConnectorCreateRule.java:69)\n        at org.apache.catalina.startup.ConnectorCreateRule.begin(ConnectorCreateRule.java:63)\n        at org.apache.tomcat.util.digester.Digester.startElement(Digester.java:1276)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.startElement(AbstractSAXParser.java:501)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractXMLDocumentParser.emptyElement(AbstractXMLDocumentParser.java:179)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanStartElement(XMLDocumentFragmentScannerImpl.java:1343)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl$FragmentContentDriver.next(XMLDocumentFragmentScannerImpl.java:2755)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentScannerImpl.next(XMLDocumentScannerImpl.java:648)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanDocument(XMLDocumentFragmentScannerImpl.java:511)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:808)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:737)\n        at com.sun.org.apache.xerces.internal.parsers.XMLParser.parse(XMLParser.java:119)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.parse(AbstractSAXParser.java:1205)\n        at com.sun.org.apache.xerces.internal.jaxp.SAXParserImpl$JAXPSAXParser.parse(SAXParserImpl.java:522)\n        at org.apache.tomcat.util.digester.Digester.parse(Digester.java:1537)\n        at org.apache.catalina.startup.Catalina.load(Catalina.java:555)\n        at org.apache.catalina.startup.Catalina.start(Catalina.java:609)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.catalina.startup.Bootstrap.start(Bootstrap.java:322)\n        at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:450)\nAug 23, 2011 5:18:31 PM org.apache.catalina.startup.Catalina load\nWARNING: Catalina.start using conf/server.xml: Error at (104, 66) : null\nAug 23, 2011 5:18:31 PM org.apache.catalina.startup.Catalina start\nSEVERE: Cannot start server. Server instance is not configured.", "id": 148795, "time": "2011-08-23T21:44:53Z", "creator": "chris@christopherschultz.net", "creation_time": "2011-08-23T21:44:53Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 51713, "text": "Looking at the code, it seems that the o.a.c.connector.Connector constructor attempts to create the protocol handler and catches any exceptions that occur and merely logs them.\n\nLater, when o.a.c.startup.ConnectorCreateRule calls _setExecutor, there is an assumption that the protocol handler has been correctly set which is not true.\n\nIs there any reason why the Connector's constructor catches that exception instead of allowing it to propagate? That would seem to solve this particular problem.", "id": 148802, "time": "2011-08-24T15:59:04Z", "creator": "chris@christopherschultz.net", "creation_time": "2011-08-24T15:59:04Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 51713, "text": "It also appears that there is an incorrect parens situation going-in in Connector(String):\n\n    public Connector(String protocol) {\n        setProtocol(protocol);\n        // Instantiate protocol handler\n        try {\n            Class<?> clazz = Class.forName(protocolHandlerClassName);\n            this.protocolHandler = (ProtocolHandler) clazz.newInstance();\n        } catch (Exception e) {\n            log.error\n                (sm.getString\n                 (\"coyoteConnector.protocolHandlerInstantiationFailed\", e));\n        }\n    }\n\nI believe the intent was to log the error message and the exception, not to use the exception as a parameter to sm.getString(). This is masking quite a bit of the underlying error.", "id": 148803, "time": "2011-08-24T16:00:21Z", "creator": "chris@christopherschultz.net", "creation_time": "2011-08-24T16:00:21Z", "is_private": false, "attachment_id": null}, {"count": 3, "text": "Fixed the message in Connector constructor in trunk in r1161322.\nBackported to 7.0.x and will be in 7.0.21.\n\n\nRegarding whether or not rethrow the exception from inside of Connector constructor:\n\nOn one hand, such an error is nearly fatal. If I do not configure an Executor, there are a lot of failures that follow. None of webapps is able to start because of NPE in connector.getAttribute() call in ApplicationContext.populateSessionTrackingModes() - stacktrace is below.\n\nOn other hand, Tomcat as a whole does start up and is manageable. There is *.EXIT_ON_INIT_FAILURE system property that one can use to turn this into a fatal failure.\n\nIf the ClassNotFoundException from Connector constructor were rethrown, the startup sequence aborts immediately. It might be not what everyone wants.\n\n\nI think this issue is sufficiently addressed. I do not intend to backport this to 6.0.\n\n\n-----\nNPE in ApplicationContext.populateSessionTrackingModes():\n\nSEVERE: ContainerBase.addChild: start: \norg.apache.catalina.LifecycleException: Failed to start component [StandardEngine[Catalina].StandardHost[localhost].StandardContext[/docs]]\n  (...)\nCaused by: java.lang.NullPointerException\n  at org.apache.tomcat.util.IntrospectionUtils.getProperty(IntrospectionUtils.java:402)\n  at org.apache.catalina.connector.Connector.getProperty(Connector.java:272)\n  at org.apache.catalina.connector.Connector.getAttribute(Connector.java:291)\n  at org.apache.catalina.core.ApplicationContext.populateSessionTrackingModes(ApplicationContext.java:1195)\n  at org.apache.catalina.core.ApplicationContext.<init>(ApplicationContext.java:127)", "bug_id": 51713, "is_private": false, "id": 148811, "time": "2011-08-25T00:33:53Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2011-08-25T00:33:53Z", "tags": [], "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 51713, "text": "Okay, I'm happy with that explanation.\n\nCertainly logging the exception stack trace will improve things as the \"real\" problem will be properly logged (InstantiationException or CNFE with a message) instead of the terse \"Protocol handler instantiation failed\" which tends to get lost among the following exception stack traces.", "id": 148819, "time": "2011-08-25T15:01:38Z", "creator": "chris@christopherschultz.net", "creation_time": "2011-08-25T15:01:38Z", "is_private": false, "attachment_id": null}]