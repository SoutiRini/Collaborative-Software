[{"count": 0, "tags": [], "text": "We use a separate thread to handle large upload files to a servlet on Tomcat.  We start the thread, pass it the httprequest object to handle the upload and write it to disk, and the original thread sends a reply to the client to start an upload monitor.  \n\nThe thread is only able to access the first 8k (thefirst ajp request packet ?) when reading from the input stream.  This packet appears to be recycled as many times as necessary to satisify the content-length.\n\nThe files a generally too large to keep the request in memory.\n\nI am currently running Tomcat 6.0.14", "attachment_id": null, "id": 121067, "creator": "jkienitz@extraview.com", "time": "2008-09-29T15:46:15Z", "bug_id": 45911, "creation_time": "2008-09-29T15:46:15Z", "is_private": false}, {"count": 1, "tags": [], "creator": "jkienitz@extraview.com", "attachment_id": null, "text": "This works with mod_jk and mod_proxy without ajp for the same Apache / Tomcat version.  \n\nmod_proxy_ajp also failed on Apache 2.2.4.\n\n\nA portion of the httpd.conf file that shows the configuration:\n\n#ok:\n\n#JkWorkersFile D:/ApacheGroup/Apache2.2/conf/workers.properties\n#JkLogFile     logs/mod_jk.log\n#JkLogLevel    info\n#JkLogStampFormat \"[%a %b %d %H:%M:%S %Y] \"\n####### JK MOUNT POINT\n#JkMount /*/ExtraView/*   tomcat1\n\n\n#ok:\n\n#ProxyTimeout 3000\n#<Proxy *>\n#  Order deny,allow\n#  Allow from all\n#</Proxy>\n#\n#ProxyPass /johnk/ http://johnk.extraview.net:8080/johnk/\n#ProxyPassReverse /johnk/ http://johnk.extraview.net:8080/johnk/\n\n\n#fails:\n\nProxyPass /johnk/ ajp://localhost:8009/johnk/\n\n\n", "id": 121068, "time": "2008-09-29T15:53:40Z", "bug_id": 45911, "creation_time": "2008-09-29T15:53:40Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 45911, "text": "Sorry for being confused, but which version of Apache exactly failed?\nPlease retry with the latest version and Loglevel set to debug. Afterwards please attach the debug logs here.", "id": 121070, "time": "2008-09-29T23:28:02Z", "creator": "rpluem@apache.org", "creation_time": "2008-09-29T23:28:02Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "text": "Created attachment 22655\nApache error.log at debug level when problem occurs", "attachment_id": 22655, "id": 121097, "creator": "jkienitz@extraview.com", "time": "2008-09-30T10:06:07Z", "bug_id": 45911, "creation_time": "2008-09-30T10:06:07Z", "is_private": false}, {"count": 4, "tags": [], "creator": "jkienitz@extraview.com", "attachment_id": null, "text": "I downloaded and installed Apache 2.2.9 on Sept 29, 2008 to verify that the problem still occurs in the most recent production version.\n\nDebug level log attached.", "id": 121098, "time": "2008-09-30T10:07:51Z", "bug_id": 45911, "creation_time": "2008-09-30T10:07:51Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 45911, "text": "Created attachment 22656\naccess log ffro the same time period as the error log\n\nThis is the access log from the same execution as the error log.", "id": 121099, "time": "2008-09-30T10:17:04Z", "creator": "jkienitz@extraview.com", "creation_time": "2008-09-30T10:17:04Z", "is_private": false, "attachment_id": 22656}, {"count": 6, "tags": [], "bug_id": 45911, "attachment_id": null, "id": 121100, "time": "2008-09-30T10:19:01Z", "creator": "jkienitz@extraview.com", "creation_time": "2008-09-30T10:19:01Z", "is_private": false, "text": "I have also attached the access log for the same time frame as the error log.  The transaction in error in the POST command:\n\n127.0.0.1 - - [30/Sep/2008:10:04:39 -0700] \"POST /johnk/ExtraView/4483?p_option=admin.MetaUpdaterDisplay&class=%25STWV0YWRhdGEgWE1MIEltcG9ydA%3D%3D&p_action=doXMLRead HTTP/1.1\" 200 1851\n\nI shut down Apache after the problem occured.\n"}, {"count": 7, "tags": [], "bug_id": 45911, "attachment_id": null, "id": 121104, "time": "2008-09-30T12:30:57Z", "creator": "rpluem@apache.org", "creation_time": "2008-09-30T12:30:57Z", "is_private": false, "text": "I am sorry, but the access log indicates that everything went alright on httpd side:\n\n[Tue Sep 30 10:04:39 2008] [debug] mod_proxy_ajp.c(45): proxy: AJP: canonicalising URL //localhost:8009/johnk/ExtraView/4483\n[Tue Sep 30 10:04:39 2008] [debug] proxy_util.c(1488): [client 127.0.0.1] proxy: ajp: found worker ajp://localhost:8009/ for ajp://localhost:8009/johnk/ExtraView/4483?p_option=admin.MetaUpdaterDisplay&class=%25STWV0YWRhdGEgWE1MIEltcG9ydA%3D%3D&p_action=doXMLRead, referer: http://johnk.extraview.net/johnk/ExtraView/4483?p_option=admin.MetaUpdaterDisplay&p_action=doDisplay&class=%25STWV0YWRhdGEgWE1MIEltcG9ydA%3D%3D\n[Tue Sep 30 10:04:39 2008] [debug] mod_proxy.c(966): Running scheme ajp handler (attempt 0)\n[Tue Sep 30 10:04:39 2008] [debug] mod_proxy_http.c(1899): proxy: HTTP: declining URL ajp://localhost:8009/johnk/ExtraView/4483?p_option=admin.MetaUpdaterDisplay&class=%25STWV0YWRhdGEgWE1MIEltcG9ydA%3D%3D&p_action=doXMLRead\n[Tue Sep 30 10:04:39 2008] [debug] mod_proxy_ajp.c(579): proxy: AJP: serving URL ajp://localhost:8009/johnk/ExtraView/4483?p_option=admin.MetaUpdaterDisplay&class=%25STWV0YWRhdGEgWE1MIEltcG9ydA%3D%3D&p_action=doXMLRead\n[Tue Sep 30 10:04:39 2008] [debug] proxy_util.c(2044): proxy: AJP: has acquired connection for (localhost)\n[Tue Sep 30 10:04:39 2008] [debug] proxy_util.c(2102): proxy: connecting ajp://localhost:8009/johnk/ExtraView/4483?p_option=admin.MetaUpdaterDisplay&class=%25STWV0YWRhdGEgWE1MIEltcG9ydA%3D%3D&p_action=doXMLRead to localhost:8009\n[Tue Sep 30 10:04:39 2008] [debug] proxy_util.c(2195): proxy: connected /johnk/ExtraView/4483?p_option=admin.MetaUpdaterDisplay&class=%25STWV0YWRhdGEgWE1MIEltcG9ydA%3D%3D&p_action=doXMLRead to localhost:8009\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(224): Into ajp_marshal_into_msgb\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(290): ajp_marshal_into_msgb: Header[0] [Host] = [johnk.extraview.net]\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(290): ajp_marshal_into_msgb: Header[1] [User-Agent] = [Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.9.0.3) Gecko/2008092417 Firefox/3.0.3]\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(290): ajp_marshal_into_msgb: Header[2] [Accept] = [text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8]\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(290): ajp_marshal_into_msgb: Header[3] [Accept-Language] = [en-us,en;q=0.5]\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(290): ajp_marshal_into_msgb: Header[4] [Accept-Encoding] = [gzip,deflate]\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(290): ajp_marshal_into_msgb: Header[5] [Accept-Charset] = [ISO-8859-1,utf-8;q=0.7,*;q=0.7]\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(290): ajp_marshal_into_msgb: Header[6] [Keep-Alive] = [300]\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(290): ajp_marshal_into_msgb: Header[7] [Connection] = [keep-alive]\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(290): ajp_marshal_into_msgb: Header[8] [Referer] = [http://johnk.extraview.net/johnk/ExtraView/4483?p_option=admin.MetaUpdaterDisplay&p_action=doDisplay&class=%25STWV0YWRhdGEgWE1MIEltcG9ydA%3D%3D]\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(290): ajp_marshal_into_msgb: Header[9] [Cookie] = [EV_Test=ExtraView; EV_user=JK; EV_pass=XXlnurNr4fVlk; EV_session=4483; JSESSIONID=46A5FCC62A520FA4C757C5803930187F; Bugzilla_logincookie=tnuWQZSUX9; Bugzilla_login=1; ZP_CAL=%27fdow%27%3Anull%2C%27history%27%3A%222008/09/01/14/30%22%2C%27hsize%27%3A9]\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(290): ajp_marshal_into_msgb: Header[10] [Content-Type] = [multipart/form-data; boundary=---------------------------186512674022044]\n\nThe POST request has a body with a length of 25536 bytes.\n\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(290): ajp_marshal_into_msgb: Header[11] [Content-Length] = [25536]\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(430): ajp_marshal_into_msgb: Done\n[Tue Sep 30 10:04:39 2008] [debug] mod_proxy_ajp.c(244): proxy: data to read (max 8186 at 4)\n\nHere we send the first 6283 bytes\n\n[Tue Sep 30 10:04:39 2008] [debug] mod_proxy_ajp.c(259): proxy: got 6283 bytes of data\n\nNow Tomcat sends us the response headers\n\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(652): ajp_read_header: ajp_ilink_received 04\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(662): ajp_parse_type: got 04\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(491): ajp_unmarshal_response: status = 200\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(502): ajp_unmarshal_response: Number of headers is = 4\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(564): ajp_unmarshal_response: Header[0] [Cache-Control] = [no-cache]\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(564): ajp_unmarshal_response: Header[1] [Pragma] = [no-cache]\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(564): ajp_unmarshal_response: Header[2] [Expires] = [Sun, 06 Nov 1994 08:49:37 GMT]\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(564): ajp_unmarshal_response: Header[3] [Content-Type] = [text/html;charset=UTF-8]\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(574): ajp_unmarshal_response: ap_set_content_type done\n\nNow Tomcat sends us parts of the response body.\n\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(652): ajp_read_header: ajp_ilink_received 03\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(662): ajp_parse_type: got 03\n\nNow Tomcat requests more request body from us.\n\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(652): ajp_read_header: ajp_ilink_received 06\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(662): ajp_parse_type: got 06\n\nNow Tomcat requests more request body from us.\n\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(652): ajp_read_header: ajp_ilink_received 06\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(662): ajp_parse_type: got 06\n\nNow Tomcat requests more request body from us.\n\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(652): ajp_read_header: ajp_ilink_received 06\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(662): ajp_parse_type: got 06\n\nNow Tomcat requests more request body from us.\n\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(652): ajp_read_header: ajp_ilink_received 06\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(662): ajp_parse_type: got 06\n\nNow Tomcat sends us the remaining response body.\n\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(652): ajp_read_header: ajp_ilink_received 03\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(662): ajp_parse_type: got 03\n\nNow Tomcat shuts down the request.\n\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(652): ajp_read_header: ajp_ilink_received 05\n[Tue Sep 30 10:04:39 2008] [debug] ajp_header.c(662): ajp_parse_type: got 05\n[Tue Sep 30 10:04:39 2008] [debug] mod_proxy_ajp.c(498): proxy: got response from 127.0.0.1:8009 (localhost)\n[Tue Sep 30 10:04:39 2008] [debug] proxy_util.c(2062): proxy: AJP: has released connection for (localhost)\n\nAs you can see Tomcat requests request body data 4 times. Provided the data is available (aka was delivered by the client) this data 25536 - 6283 = 19253 bytes fits perfectly in 4 8K pakets that httpd sends as a response to these requests.\nSo all your data should have arrived at the Tomcat side.\n\nCan you please setup a network sniffer to sniff on port 8009 on the loopback interface to finally prove that the data was transmitted to Tomcat?\n"}, {"count": 8, "tags": [], "bug_id": 45911, "attachment_id": null, "id": 121253, "time": "2008-10-06T17:38:34Z", "creator": "jkienitz@extraview.com", "creation_time": "2008-10-06T17:38:34Z", "is_private": false, "text": "Your observations about the packer transfer are in line with what we are seeing.  Unfortunately, the data in the packets seems duplicate the data in the first packet.\n\nThe only change for a working to a bad configuration is the configuration of the connection in Apache between Apache and Tomcat.  Using mod_jk to the same Tomcat Connector works just fine.  Using mod_proxy to the http connector works just fine.\n\nI am working on getting a network trace for you."}, {"count": 9, "tags": [], "bug_id": 45911, "attachment_id": 22683, "id": 121285, "time": "2008-10-07T13:48:30Z", "creator": "jkienitz@extraview.com", "creation_time": "2008-10-07T13:48:30Z", "is_private": false, "text": "Created attachment 22683\nApache error.log at debug level when problem occurs"}, {"count": 10, "tags": [], "creator": "jkienitz@extraview.com", "is_private": false, "text": "Created attachment 22684\nApache access log from the same time period as the error log", "id": 121286, "time": "2008-10-07T13:49:22Z", "bug_id": 45911, "creation_time": "2008-10-07T13:49:22Z", "attachment_id": 22684}, {"count": 11, "attachment_id": 22685, "bug_id": 45911, "text": "Created attachment 22685\ntcpdump whe the problem occurred.\n\nCommand line used:\nwindump -i 2 -n -s 0 -w tcpdump.bin port 8009", "id": 121287, "time": "2008-10-07T13:50:49Z", "creator": "jkienitz@extraview.com", "creation_time": "2008-10-07T13:50:49Z", "tags": [], "is_private": false}, {"count": 12, "attachment_id": 22686, "bug_id": 45911, "text": "Created attachment 22686\nuploaded xml file\n\nthe source XML file that is being uploaded.", "id": 121288, "time": "2008-10-07T13:53:08Z", "creator": "jkienitz@extraview.com", "creation_time": "2008-10-07T13:53:08Z", "tags": [], "is_private": false}, {"count": 13, "tags": [], "bug_id": 45911, "attachment_id": null, "id": 121290, "time": "2008-10-07T13:57:28Z", "creator": "jkienitz@extraview.com", "creation_time": "2008-10-07T13:57:28Z", "is_private": false, "text": "dump file attached with source upload file and corresponding log files.\n\n"}, {"count": 14, "attachment_id": null, "bug_id": 45911, "is_private": false, "id": 121294, "time": "2008-10-07T14:57:10Z", "creator": "rpluem@apache.org", "creation_time": "2008-10-07T14:57:10Z", "tags": [], "text": "Thanks for the information. Two additional things:\n\n1. I just noticed that this all runs on windows. Do you use any local firewall on your box(es)?\n2. Could you please also do a network sniff of the http side of the request (so before the packets reach httpd)?"}, {"count": 15, "tags": [], "text": "Created attachment 22687\nPatch against trunk\n\nCould you please give the attached patch a try and see if it fixes your problem? It is against trunk and applies with some fuzz to 2.2.x.", "attachment_id": 22687, "id": 121295, "creator": "rpluem@apache.org", "time": "2008-10-07T15:39:11Z", "bug_id": 45911, "creation_time": "2008-10-07T15:39:11Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 45911, "attachment_id": null, "id": 121475, "time": "2008-10-13T14:02:08Z", "creator": "rpluem@apache.org", "creation_time": "2008-10-13T14:02:08Z", "is_private": false, "text": "Sorry for being impatient, but did you find any time for testing the patch?"}, {"count": 17, "tags": [], "bug_id": 45911, "text": "When I created the tcpdump for you, I moved the Tomcat server to a Linux system, and kept the same Apache installation on Windows XP.\n\nDo you still want the dump for the http traffic to Apache?\n\nI am not set up to compile C/C++ here.  I could install a test module or a test version of Apache with the fix, but I cannot apply a patch and compile it to retry.  Sorry.\n\n", "id": 121476, "time": "2008-10-13T14:23:33Z", "creator": "jkienitz@extraview.com", "creation_time": "2008-10-13T14:23:33Z", "is_private": false, "attachment_id": null}, {"count": 18, "tags": [], "text": "(In reply to comment #17)\n> When I created the tcpdump for you, I moved the Tomcat server to a Linux\n> system, and kept the same Apache installation on Windows XP.\n> \n> Do you still want the dump for the http traffic to Apache?\n\nNo. I guess this is not needed any longer\n\n> \n> I am not set up to compile C/C++ here.  I could install a test module or a test\n> version of Apache with the fix, but I cannot apply a patch and compile it to\n> retry.  Sorry.\n\nBut can you setup a test version of httpd with the fix (maybe under Linux) and connect it against your Tomcat to see if the problem still occurs?\n\n", "is_private": false, "id": 121478, "creator": "rpluem@apache.org", "time": "2008-10-13T15:04:36Z", "bug_id": 45911, "creation_time": "2008-10-13T15:04:36Z", "attachment_id": null}, {"count": 19, "tags": [], "text": "Any update?", "attachment_id": null, "id": 121547, "creator": "rpluem@apache.org", "time": "2008-10-15T08:18:54Z", "bug_id": 45911, "creation_time": "2008-10-15T08:18:54Z", "is_private": false}, {"count": 20, "attachment_id": null, "bug_id": 45911, "is_private": false, "id": 121554, "time": "2008-10-15T09:12:11Z", "creator": "jkienitz@extraview.com", "creation_time": "2008-10-15T09:12:11Z", "tags": [], "text": "I have downloaded the source version of 2.2.9 and I am in the process of installing it and setting it up.  I hope to get the testing done in the next couple of days.\n"}, {"count": 21, "tags": [], "text": "Any further updates on your tests?", "attachment_id": null, "id": 121717, "creator": "rpluem@apache.org", "time": "2008-10-21T03:10:26Z", "bug_id": 45911, "creation_time": "2008-10-21T03:10:26Z", "is_private": false}, {"count": 22, "tags": [], "creator": "jkienitz@extraview.com", "is_private": false, "text": "we had a reorganization here, and I was unable to get to it last week.  The good news is that I am still here, and will work on it this week.", "id": 121746, "time": "2008-10-21T13:52:46Z", "bug_id": 45911, "creation_time": "2008-10-21T13:52:46Z", "attachment_id": null}, {"count": 23, "tags": [], "creator": "rpluem@apache.org", "is_private": false, "text": "Committed patch to trunk as r709666.", "id": 122084, "time": "2008-11-01T03:24:06Z", "bug_id": 45911, "creation_time": "2008-11-01T03:24:06Z", "attachment_id": null}, {"count": 24, "tags": [], "text": "Proposed for backport as r712001.", "attachment_id": null, "id": 122260, "creator": "rpluem@apache.org", "time": "2008-11-06T14:50:12Z", "bug_id": 45911, "creation_time": "2008-11-06T14:50:12Z", "is_private": false}, {"count": 25, "tags": [], "text": "Backported to 2.2.x as r714273.", "attachment_id": null, "id": 122514, "creator": "rpluem@apache.org", "time": "2008-11-15T06:26:07Z", "bug_id": 45911, "creation_time": "2008-11-15T06:26:07Z", "is_private": false}, {"count": 26, "tags": [], "bug_id": 45911, "attachment_id": null, "is_private": false, "id": 122583, "time": "2008-11-17T15:31:39Z", "creator": "jkienitz@extraview.com", "creation_time": "2008-11-17T15:31:39Z", "text": "I have tested this patch and it corrects the issue.\n\nThank you."}]