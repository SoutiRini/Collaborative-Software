[{"count": 0, "tags": [], "bug_id": 43598, "attachment_id": null, "id": 109239, "time": "2007-10-11T04:48:42Z", "creator": "christian.folini@post.ch", "creation_time": "2007-10-11T04:48:42Z", "is_private": false, "text": "I came accross a timeout issue in a reverse proxy setting and\nafter running multiple tests and asking the httpd-user mailinglist [1][2],\nI believe this is a bug. It could also be a missing functionality\nand a documentation problem, but Josua Slive suggested I submit\na bug report [3].\n\nDetails:\n\n\tclient:\n\t\tnetcat localhost 80 < /tmp/get-request\n\n\t\tfile /tmp/get-request:\n\t\t\tline 1: GET / HTTP/1.1\n\t\t\tline 2: Host: 127.0.0.1\n\t\t\tline 3:\n\n\t\t\tNote the empty line.\n\n\tapache reverse proxy\n\t\tServer version: Apache/2.0.61\n\t\tServer built:   Sep 27 2007 13:36:58\n\t\tCustom compilation of native sourcecode\n\t\tapache config (stripped down test config):\n\t\t  Timeout\t\t10\n\t\t  <VirtualHost *:80>\n\t\t    Timeout\t\t20\n\t\t    ProxyPass\t/\thttp://127.0.0.1:8080/\n\t\t    ProxyTimeout\t30\n\t\t  </Virtualhost>\n\n\tbackend application:\n\t\tnetcat -l -p 8080\n\t\t  -> output:\n\t\t     GET / HTTP/1.1\n\t\t     Host: 127.0.0.1:8080\n\t\t     Max-Forwards: 10\n\t\t     X-Forwarded-For: 127.0.0.1\n\t\t     X-Forwarded-Host: testhost\n\t\t     X-Forwarded-Server: testhost.myhome.net\n\n\t\tNote that the backend does not write a response. It\n\t\tjust accepts the request and waits.\n\t\t\n\terror-log:\n\t[Thu Oct 11 10:35:39 2007] [debug] proxy_http.c(67): proxy: HTTP:\ncanonicalising URL //127.0.0.1:8080/\n\t[Thu Oct 11 10:35:39 2007] [debug] mod_proxy.c(454): Trying to run scheme_handler\n\t[Thu Oct 11 10:35:39 2007] [debug] proxy_http.c(1723): proxy: HTTP: serving URL\nhttp://127.0.0.1:8080/\n\t[Thu Oct 11 10:35:39 2007] [debug] proxy_http.c(186): proxy: HTTP connecting\nhttp://127.0.0.1:8080/ to 127.0.0.1:8080\n\t[Thu Oct 11 10:35:39 2007] [debug] proxy_util.c(1097): proxy: HTTP: fam 2\nsocket created to connect to 127.0.0.1\n\t[Thu Oct 11 10:35:39 2007] [debug] proxy_http.c(336): proxy: socket is connected\n\t[Thu Oct 11 10:35:39 2007] [debug] proxy_http.c(370): proxy: connection\ncomplete to 127.0.0.1:8080 (127.0.0.1)\n\t[Thu Oct 11 10:35:59 2007] [error] [client 127.0.0.1] proxy: error reading\nstatus line from remote server 127.0.0.1\n\t[Thu Oct 11 10:35:59 2007] [error] [client 127.0.0.1] proxy: Error reading from\nremote server returned by /\n\n\ttcpdump:\n\troot@testhost ~>/usr/sbin/tcpdump -i lo -s 0 -A port 80\n\ttcpdump: verbose output suppressed, use -v or -vv for full protocol decode\n\tlistening on lo, link-type EN10MB (Ethernet), capture size 65535 bytes\n\t10:35:39.094093 IP localhost.58354 > localhost.www: S 2639151242:2639151242(0)\nwin 32792 <mss 16396,sackOK,timestamp 2344522 0,nop,wscale 7>\n\tE..<..@.@..............P.N@...............@....\n\n\t\t        .#.J........\n\t10:35:39.094459 IP localhost.www > localhost.58354: S 2632084042:2632084042(0)\nack 2639151243 win 32768 <mss 16396,sackOK,timestamp 2344522 2344522,nop,wscale 7>\n\tE..<..@.@.<..........P....jJ.N@.....9p....@....\n\n\t\t        .#.J.#.J....\n\t10:35:39.094100 IP localhost.58354 > localhost.www: . ack 1 win 257\n<nop,nop,timestamp 2344522 2344522>\n\tE..4..@.@..............P.N@...jK....!......\n\n\t\t        .#.J.#.J\n\t10:35:39.094250 IP localhost.58354 > localhost.www: P 1:33(32) ack 1 win 257\n<nop,nop,timestamp 2344522 2344522>\n\tE..T..@.@..............P.N@...jK.....H.....\n\t\t\t.#.J.#.JGET / HTTP/1.1\n\t\t\tHost: 127.0.0.1\n\n\n\t10:35:39.094258 IP localhost.www > localhost.58354: . ack 33 win 256\n<nop,nop,timestamp 2344522 2344522>\n\tE..4..@.@............P....jK.N@.....!u.....\n\n\t\t\t        .#.J.#.J\n\t10:35:59.096004 IP localhost.www > localhost.58354: P 1:511(510) ack 33 win 256\n<nop,nop,timestamp 2349523 2344522>\n\tE..2..@.@............P....jK.N@......'.....\n\t\t\t.#...#.JHTTP/1.1 502 Proxy Error\n\t\t\tDate: Thu, 11 Oct 2007 08:35:39 GMT\n\t\t\tContent-Length: 379\n\t\t\tContent-Type: text/html; charset=iso-8859-1\n\n\t\t\t<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n\t\t\t<html><head>\n\t\t\t<title>502 Proxy Error</title>\n\t\t\t</head><body>\n\t\t\t<h1>Proxy Error</h1>\n\t\t\t<p>The proxy server received an invalid\n\t\t\tresponse from an upstream server.<br />\n\t\t\tThe proxy server could not handle the request <em><a\nhref=\"/\">GET&nbsp;/</a></em>.<p>\n\t\t\tReason: <strong>Error reading from remote server</strong></p></p>\n\t\t\t</body></html>\n\n\t10:35:59.096015 IP localhost.58354 > localhost.www: . ack 511 win 265\n<nop,nop,timestamp 2349523 2349523>\n\tE..4..@.@..............P.N@...lI...     .[.....\n\n\t\t        .#...#..\n\n\n\tInterpretation:\n\tThe client->RP->backend connection works as expected. As the\n\tbackend is not responding, the RP cuts the connection after a\n\tcertain timeout.\n\t\n\tThe configuration sets three timeouts:\n\t\t- Server Timeout (10)\n\t\t- Virtual Host Timeout (20)\n\t\t- Proxy Timeout (30)\n\n\tAs visible in the tcpdump above, the timeout occurrs after twenty\n\tseconds and not after 30 seconds as defined by the ProxyTimeout\n\tstatement.\n\n\tTimeout documentation says [4]:\n\t\t\t\n\t> The TimeOut directive currently defines the amount of time Apache will wait\nfor three things:\n\t>\n\t>   1. The total amount of time it takes to receive a GET request.\n\t>   2. The amount of time between receipt of TCP packets on a POST or PUT request.\n\t>   3. The amount of time between ACKs on transmissions of TCP packets in\nresponses.\n\n\tIt does not say anything about the proxy timeout, despite affecting that\n\tone as well.\n\n\tThe ProxyTimeout documentation says:\n\t> This directive allows a user to specifiy a timeout on proxy requests. \n\t> This is useful when you have a slow/buggy appserver which hangs, and \n\t> you would rather just return a timeout and fail gracefully instead of \n\t> waiting however long it takes the server to return.\n\n\tAs its names implies, this is the configuration option that should\n\tbe used to affect the proxy connection timeout. But as the test\n\tabove demonstrated, this is not the case.\n\n\tSo this looks like a bug. Either in the documentation or in the\n\tapache (proxy?) code. I would rather have a fixed apache, than\n\tonly a documentation update. The ability to control the proxy timeout\n\tindependently from the client timeout is important in many setups.\n\tI can elaborate on this issue. It has to do with certain DoS/DDoS\n\tattacks where a very low timeout becomes very important.\n\n\n\tI have tested the ProxyTimeout setting on Apache 2.2 as well. It works\n\tas advertised on 2.2.6. The Apache 2.2 is thus not affected from this\n\tbug. However, updating to Apache 2.2 will take time for my\n        organisation.\n\n\n\tReferences:\n\t[1] http://marc.info/?l=apache-httpd-users&m=119088062412991&w=2\n\t[2] http://marc.info/?l=apache-httpd-users&m=119140647214662&w=2\n\t[3] http://marc.info/?l=apache-httpd-users&m=119141830917372&w=2\n\t[4] http://httpd.apache.org/docs/2.0/mod/core.html#timeout\n\t[5] http://httpd.apache.org/docs/2.0/mod/mod_proxy.html#proxytimeout"}, {"count": 1, "tags": [], "bug_id": 43598, "attachment_id": null, "id": 172511, "time": "2014-01-19T20:39:04Z", "creator": "covener@gmail.com", "creation_time": "2014-01-19T20:39:04Z", "is_private": false, "text": "Marking WONTFIX on old report, OP confirmed 2.2 works.  2.0 is end-of-life, if even still affected."}]