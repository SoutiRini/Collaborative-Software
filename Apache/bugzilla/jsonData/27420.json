[{"count": 0, "tags": [], "creator": "drabe@opentext.com", "attachment_id": null, "text": "When I run my unit tests with fork=\"false\", the JVM heap size continually \nincreases. I've duplicated this with a simple test case. In short, I believe \nthere's a bug in the ant junit task because it doesn't clean up its \nclassloaders.\n\nHere's the scenario: I have five identical testcases (each a subclass of an \nabstract test case). The abstract class declares a \"static Integer memoryHog[] \n= new Integer[ 500000 ];\". When each class is loaded, then, it should allocate \na couple megabytes of memory. The test method itself sleeps for five seconds \n(to make it easier to watch what's going on), and then prints out totalMemory().\n\nWhen I run this from ant, I get the following output:\ntest:\n    [junit] Running MyTest\n    [junit] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 5 sec\n\n    [junit] Running MyTest1\n    [junit] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 5 sec\n    [junit] Output:\n    [junit] Max memory: 6828\n\n    [junit] Running MyTest2\n    [junit] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 5 sec\n    [junit] Output:\n    [junit] Max memory: 8144\n\n    [junit] Running MyTest3\n    [junit] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 5 sec\n    [junit] Output:\n    [junit] Max memory: 11640\n\n    [junit] Running MyTest4\n    [junit] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 5.001 sec\n    [junit] Output:\n    [junit] Max memory: 15168\n\n    [junit] Running MyTest5\n    [junit] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 5 sec\n    [junit] Output:\n    [junit] Max memory: 18636\n\nThe debug output confirms what I see in task manager -- heap size increasing by \n2-3Mb for each testcase.\n\nNext, I changed JUnitTask to call cleanup() on the class loader after running \nthe tests. This is the diff (against CVS HEAD):\nRCS \nfile: /home/cvspublic/ant/src/main/org/apache/tools/ant/taskdefs/optional/junit/\nJUnitTask.java,v\nretrieving revision 1.93\ndiff -r1.93 JUnitTask.java\n974a975\n> \t\t\t\tclassLoader.cleanup();\n\nNow when I run the tests, I don't see the increasing memory problem:\ntest:\n    [junit] Running MyTest\n    [junit] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 5 sec\n\n    [junit] Running MyTest1\n    [junit] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 5 sec\n    [junit] Output:\n    [junit] Max memory: 6828\n\n    [junit] Running MyTest2\n    [junit] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 5 sec\n    [junit] Output:\n    [junit] Max memory: 6828\n\n    [junit] Running MyTest3\n    [junit] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 5 sec\n    [junit] Output:\n    [junit] Max memory: 6828\n\n    [junit] Running MyTest4\n    [junit] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 5 sec\n    [junit] Output:\n    [junit] Max memory: 6828\n\n    [junit] Running MyTest5\n    [junit] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 5 sec\n    [junit] Output:\n    [junit] Max memory: 6828\n\nHowever, I don't profess to know enough about classloaders OR ant OR junit to \nknow if this is the right fix. In fact, the ant unit tests fail with my mod, so \nit's probably not right. (DefaultExcludesTest:test1 fails.)\n\nRegards,\n\nDaniel Rabe\nSr. Software Architect\nOpen Text, Inc.\nBoulder, Colorado\nhttp://www.opentext.com", "id": 53408, "time": "2004-03-03T22:02:30Z", "bug_id": 27420, "creation_time": "2004-03-03T22:02:30Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 27420, "attachment_id": 10655, "is_private": false, "id": 53409, "time": "2004-03-03T22:04:05Z", "creator": "drabe@opentext.com", "creation_time": "2004-03-03T22:04:05Z", "text": "Created attachment 10655\nSource files and build.xml"}, {"count": 2, "tags": [], "text": "I think you can work around this by setting the reloading attribute of the task\nto false.  That way all your tests will share a single class loader instance.", "attachment_id": null, "id": 64696, "creator": "bodewig@apache.org", "time": "2004-10-06T15:12:56Z", "bug_id": 27420, "creation_time": "2004-10-06T15:12:56Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 27420, "attachment_id": null, "id": 64699, "time": "2004-10-06T15:42:24Z", "creator": "bodewig@apache.org", "creation_time": "2004-10-06T15:42:24Z", "is_private": false, "text": "fixed in CVS."}]