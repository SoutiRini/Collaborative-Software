[{"count": 0, "tags": [], "creator": "dustin@virtualroadside.com", "attachment_id": 30248, "id": 166984, "time": "2013-05-01T02:07:56Z", "bug_id": 54916, "creation_time": "2013-05-01T02:07:56Z", "is_private": false, "text": "Created attachment 30248\nPatch for bug\n\nI believe this bug may affect all XML-based formats that POI supports, but my specific use case is with pptx files.\n\nFor some reason, a number of pptx files that I was given contain slides with rels that contain relationships to other slides in the ppt/slides/_rels/slideX.xml.rels files. Microsoft Office 2010 is able to deal with these files and open them correctly.\n\nWhen POI encounters such a file, generally it will omit one or more of the slides when you call getSlides() on the XMLSlideShow object. When this occurs, error messages such as \"Slide with r:id 256 was defined, but didn't exist in package, skipping\" will be logged. \n\nI believe what is happening is during building of the parse tree, POI treats all references/relationships as equal, and if there are two or more relationships that occur in the file, then POI uses the first occurrence to set the package relationship field. If the first time that POI runs across it is as a child reference, then the package relationship field is set incorrectly, and later on POI sometimes may not be able to resolve it correctly. \n\nI've determined that the simplest fix is to first parse all elements at a given level, before trying to resolve elements at lower levels. This fixes my problem, and doesn't break any unit tests.\n\nThe attached patch contains the fix, and a sample pptx file that exhibits this behavior with a very simple test case."}, {"count": 1, "tags": [], "bug_id": 54916, "is_private": false, "text": "Created attachment 30249\nUpdated patch with diagnostic warning log messages\n\nSome testing has shown that other element types sometimes get duplicated, particularly slideMaster elements. One of the problems with diagnosing this problem is that POI doesn't try to detect when this problem occurs, which could be useful for trying to figure out why corrupted pptx files aren't working. I've updated my patch with some log messages that can assist when things aren't quite how they should be.", "id": 166991, "time": "2013-05-01T19:04:53Z", "creator": "dustin@virtualroadside.com", "creation_time": "2013-05-01T19:04:53Z", "attachment_id": 30249}, {"count": 2, "tags": [], "text": "I've added a disabled unit test in r1496696, based on your supplied file\n\nPatch still needs a little bit more thinking, and possibly a deeper fix...", "is_private": false, "id": 168059, "creator": "apache@gagravarr.org", "time": "2013-06-26T00:46:34Z", "bug_id": 54916, "creation_time": "2013-06-26T00:46:34Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "kiwiwings@apache.org", "attachment_id": null, "id": 172855, "time": "2014-02-02T02:56:49Z", "bug_id": 54916, "creation_time": "2014-02-02T02:56:49Z", "is_private": false, "text": "That's really a pity ... I've implemented exactly the same patch (apart of the checks in XMLSlideShow ...) and was just before committing it ...\n\nI think, the duplicated relations (but with different parent/ref-id) should be handled through some kind of proxy or delegate, so when the part is called from the outside, it will behave (i.e. return its ref-ids) like it would belong to the embracing part ...\n\nI have a look (and hope) to patch this soon ..."}, {"count": 4, "tags": [], "text": "Created attachment 31296\ndelegate-example to handle parent relations\n\nIn the attached example I'd like to demonstrate what I want to change in those many subclasses of POIXMLDocumentPart.\n\nThe main problem (as stated in the bug thread) is, that the current implementation doesn't track the (incoming or parent) package relations right, i.e. a referenced child has only one package relation, which is definitely not true for shared objects like slide masters/layouts.\n\nThe straightforward implementation would be, to deprecate POIXMLDocumentPart.getPackageRelationship() and introduce a POIXMLDocumentPart.getPackageRelationship(POIXMLDocumentPart parent) method instead, but as the code is already out in the wild, this is probably not the way to go.\n\nSo instead I'd like to introduce a delegate mechanism. When the objects are linked together in POIXMLDocumentPart.read() this would take to care to create the necessary delegates.\n\nThe delegate itself is a simple inner class extending the outer class so instance-of checks stay valid and the delegate can be used the same way the original class was.\n\nInstead of duplicating all method calls in the inner class and maybe forgetting to insert a call when a new method is introduced, I thought it's better to handle it via the following method prefix ...\n\npublic sometype methodname(args ...) {\n   if (isDelegate()) {\n      return getThis().methodname(args ...);\n   }\n   // and now the normal method content\n}\n\nSo what do you think about this?\n(... or maybe I missed a point of how these ooxml classes work ...)", "attachment_id": 31296, "id": 172959, "creator": "kiwiwings@apache.org", "time": "2014-02-08T21:51:37Z", "bug_id": 54916, "creation_time": "2014-02-08T21:51:37Z", "is_private": false}, {"count": 5, "tags": [], "text": "I am observing a related issue when loading one specific PPTX file, that I may not post here, unfortunately.\n\nSome slideMasters cannot be retrieved via XmlSlideShow.getSlideMasters(). The problem is in org.apache.poi.xslf.usermodel.XMLSlideShow.onDocumentRead() where the _masters instance variable is being populated.\n\nIn my case a possible fix would be to replace:\n\n_masters.put(p.getPackageRelationship().getId(), master);\n\nby\n\n_masters.put(getRelationId(p), master);\n\nThis change should fix the problem for slideMasters only.", "attachment_id": null, "bug_id": 54916, "id": 175650, "time": "2014-06-05T08:38:32Z", "creator": "vladk.dev@gmail.com", "creation_time": "2014-06-05T08:38:32Z", "is_private": false}, {"count": 6, "tags": [], "text": "(In reply to vladk from comment #5)\n> I am observing a related issue when loading one specific PPTX file, that I\n> may not post here, unfortunately.\n\nAny chance you could unzip the .pptx file, then zip up just the _rels files and post that? That should let us check if it's the same issue, without sharing any of the actual content.", "is_private": false, "id": 175651, "creator": "apache@gagravarr.org", "time": "2014-06-05T08:52:08Z", "bug_id": 54916, "creation_time": "2014-06-05T08:52:08Z", "attachment_id": null}, {"count": 7, "tags": [], "text": "There are two slide masters:\nslideMaster1.xml / rId8 and slideMaster2.xml / rId9, but they both have the same rId1 when referencing from their slideLayouts.\n\npresentation.xml.rels:\n\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n<Relationships xmlns=\"http://schemas.openxmlformats.org/package/2006/relationships\">\n\t<Relationship Id=\"rId8\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideMaster\" Target=\"slideMasters/slideMaster1.xml\"/>\n\t<Relationship Id=\"rId13\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide4.xml\"/>\n\t<Relationship Id=\"rId18\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide9.xml\"/>\n\t<Relationship Id=\"rId26\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide17.xml\"/>\n\t<Relationship Id=\"rId39\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/tags\" Target=\"tags/tag1.xml\"/>\n\t<Relationship Id=\"rId3\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/customXml\" Target=\"../customXml/item3.xml\"/>\n\t<Relationship Id=\"rId21\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide12.xml\"/>\n\t<Relationship Id=\"rId34\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide25.xml\"/>\n\t<Relationship Id=\"rId42\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/theme\" Target=\"theme/theme1.xml\"/>\n\t<Relationship Id=\"rId7\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/customXml\" Target=\"../customXml/item7.xml\"/>\n\t<Relationship Id=\"rId12\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide3.xml\"/>\n\t<Relationship Id=\"rId17\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide8.xml\"/>\n\t<Relationship Id=\"rId25\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide16.xml\"/>\n\t<Relationship Id=\"rId33\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide24.xml\"/>\n\t<Relationship Id=\"rId38\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/notesMaster\" Target=\"notesMasters/notesMaster1.xml\"/>\n\t<Relationship Id=\"rId2\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/customXml\" Target=\"../customXml/item2.xml\"/>\n\t<Relationship Id=\"rId16\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide7.xml\"/>\n\t<Relationship Id=\"rId20\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide11.xml\"/>\n\t<Relationship Id=\"rId29\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide20.xml\"/>\n\t<Relationship Id=\"rId41\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/viewProps\" Target=\"viewProps.xml\"/>\n\t<Relationship Id=\"rId1\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/customXml\" Target=\"../customXml/item1.xml\"/>\n\t<Relationship Id=\"rId6\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/customXml\" Target=\"../customXml/item6.xml\"/>\n\t<Relationship Id=\"rId11\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide2.xml\"/>\n\t<Relationship Id=\"rId24\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide15.xml\"/>\n\t<Relationship Id=\"rId32\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide23.xml\"/>\n\t<Relationship Id=\"rId37\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide28.xml\"/>\n\t<Relationship Id=\"rId40\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/presProps\" Target=\"presProps.xml\"/>\n\t<Relationship Id=\"rId5\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/customXml\" Target=\"../customXml/item5.xml\"/>\n\t<Relationship Id=\"rId15\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide6.xml\"/>\n\t<Relationship Id=\"rId23\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide14.xml\"/>\n\t<Relationship Id=\"rId28\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide19.xml\"/>\n\t<Relationship Id=\"rId36\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide27.xml\"/>\n\t<Relationship Id=\"rId10\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide1.xml\"/>\n\t<Relationship Id=\"rId19\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide10.xml\"/>\n\t<Relationship Id=\"rId31\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide22.xml\"/>\n\t<Relationship Id=\"rId4\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/customXml\" Target=\"../customXml/item4.xml\"/>\n\t<Relationship Id=\"rId9\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideMaster\" Target=\"slideMasters/slideMaster2.xml\"/>\n\t<Relationship Id=\"rId14\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide5.xml\"/>\n\t<Relationship Id=\"rId22\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide13.xml\"/>\n\t<Relationship Id=\"rId27\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide18.xml\"/>\n\t<Relationship Id=\"rId30\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide21.xml\"/>\n\t<Relationship Id=\"rId35\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide26.xml\"/>\n\t<Relationship Id=\"rId43\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/tableStyles\" Target=\"tableStyles.xml\"/>\n</Relationships>\n\nslideLayout1.xml.rels:\n\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n<Relationships xmlns=\"http://schemas.openxmlformats.org/package/2006/relationships\">\n\t<Relationship Id=\"rId3\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/image\" Target=\"../media/image3.emf\"/>\n\t<Relationship Id=\"rId2\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/image\" Target=\"../media/image2.jpeg\"/>\n\t<Relationship Id=\"rId1\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideMaster\" Target=\"../slideMasters/slideMaster1.xml\"/>\n</Relationships>\n\nslidelayout17.xml.rels:\n\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n<Relationships xmlns=\"http://schemas.openxmlformats.org/package/2006/relationships\">\n\t<Relationship Id=\"rId2\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/image\" Target=\"../media/image3.emf\"/>\n\t<Relationship Id=\"rId1\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideMaster\" Target=\"../slideMasters/slideMaster2.xml\"/>\n</Relationships>", "is_private": false, "bug_id": 54916, "id": 175653, "time": "2014-06-05T09:16:11Z", "creator": "vladk.dev@gmail.com", "creation_time": "2014-06-05T09:16:11Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 54916, "attachment_id": null, "id": 175697, "time": "2014-06-06T13:24:48Z", "creator": "tallison@mitre.org", "creation_time": "2014-06-06T13:24:48Z", "is_private": false, "text": "http://social.msdn.microsoft.com/Forums/office/en-US/8982d0bb-9469-4f9c-985d-57fadcc9a655/apparent-duplicate-id-in-relationship-office-open-xml-elements?forum=oxmlsdk\n\nLooks like we'll need to store relationship ids per \"relationships\" object?  Ugh..."}, {"count": 9, "tags": [], "creator": "arjohn.kampman@gmail.com", "attachment_id": null, "is_private": false, "id": 186458, "time": "2015-11-20T10:00:05Z", "bug_id": 54916, "creation_time": "2015-11-20T10:00:05Z", "text": "I've been running into this bug this week: text extraction from a pptx file is ignoring one sheet entirely. I have debugged the issue and found out that the bug matches this bug report exactly:\n\n/ppt/_rels/presentation.xml.rels has this line:\n   <Relationship Id=\"rId9\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slides/slide5.xml\"/>\n\nbut this mapping of overwritten when a little later this relation is found in /ppt/slides/_rels/slide3.xml:\n   <Relationship Id=\"rId15\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide\" Target=\"slide5.xml\"/>\n\nAs a result of this, the text extractor cannot find slide5 anymore.\n\nAre there any plans to fix this bug?"}, {"count": 10, "tags": [], "bug_id": 54916, "attachment_id": null, "id": 186463, "time": "2015-11-20T15:10:34Z", "creator": "kiwiwings@apache.org", "creation_time": "2015-11-20T15:10:34Z", "is_private": false, "text": "Yes, there a plans to fix this bug - I'll take care of it.\n\nI've used to think, that there should be only a minimum of api change, when an error occur, but regarding this patch, I prefer to remove the misleading methods ...\n\nI'll have a look at it, when 3.14-Beta1 is out.\n\nAndi"}, {"count": 11, "tags": [], "bug_id": 54916, "attachment_id": null, "id": 186923, "creation_time": "2015-12-14T00:02:07Z", "time": "2015-12-14T00:02:07Z", "creator": "kiwiwings@apache.org", "text": "In the relation-patch.zip I've deprecated (hopefully) all calls having a \nPackageRelationship, because (as noted above) there are a few DocumentParts \nwhich have more than one incoming relationship.\n\nAfter this has been applied, the next step would be, to remove all calls having \na parent, which is basically the same as one-incoming-relationship,\nbut I'm not sure if this cause any side-effects and therefore haven't yet \nconsidered it.\n\nThe deprecation is dated for POI 3.16, where I'd like to remove all those calls.\nNot sure if \"deprecated by ...\" is a good phrase, as we haven't had an \nexpiration date on methods yet ... so maybe suggest a different catchy \ntag/phrase.\nMaybe something which can be parsed/handled/validated automatically via the ant \nbuild.", "is_private": false}, {"count": 12, "tags": [], "text": "Created attachment 33343\nPatch for deprecating packagerelationship calls", "is_private": false, "id": 186924, "creator": "kiwiwings@apache.org", "time": "2015-12-14T00:02:10Z", "bug_id": 54916, "creation_time": "2015-12-14T00:02:10Z", "attachment_id": 33343}, {"count": 13, "tags": [], "text": "Created attachment 33392\n2nd version of the relation fix\n\nI've committed already the unrelated changes, i.e.\n- removed @SuppressWarnings(\"deprecation\") because of new the xml schemas\n- JUnit4 conversion + close resources\n\nThis also contains Javens intial comments, i.e.\n- javadoc about RelationPart.getRelationship()\n- renamed the deprecated tags to \"@deprecated in POI 3.14, scheduled for removal in POI 3.16\"", "is_private": false, "id": 187314, "creator": "kiwiwings@apache.org", "time": "2016-01-01T20:44:48Z", "bug_id": 54916, "creation_time": "2016-01-01T20:44:48Z", "attachment_id": 33392}, {"count": 14, "tags": [], "text": "Patch applied via r1723966", "is_private": false, "bug_id": 54916, "id": 187530, "time": "2016-01-10T20:48:28Z", "creator": "kiwiwings@apache.org", "creation_time": "2016-01-10T20:48:28Z", "attachment_id": null}]