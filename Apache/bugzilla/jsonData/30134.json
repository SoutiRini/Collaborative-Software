[{"count": 0, "tags": [], "bug_id": 30134, "attachment_id": null, "id": 60668, "time": "2004-07-15T23:57:41Z", "creator": "lxhankins002@fastmail.fm", "creation_time": "2004-07-15T23:57:41Z", "is_private": false, "text": "Overview Description:\n\nIntermittent segmentation faults occur in char_buffer_read at\nssl_engine_io.c:348 when using a RewriteRule to do reverse proxying to an SSL\norigin server running IIS.\n\n    Steps to Reproduce:\n\n1) Set up an IIS server using SSL and running eRoom 6.\n\n2) Add the following directives to httpd.conf:\n\nListen 47290\nSSLProxyEngine on\nRewriteEngine on\nRewriteRule /(.*) https://some.eroom6.iis.server.com/$1 [P]\n\n3) Visit a URL similar to the following:\n\nhttp://reverse.proxy.com:47290/eRoomASP/CookieTest.asp?facility=facility&URL=%2FeRoom%2FFacility%2FRoom%2F0_4242\n\nIf that doesn't cause the segfault, click around for a while.\n\n(Yes, reverse proxying from non-SSL to SSL is not a good idea, but it keeps the\nexample simpler.)\n\n    Actual Results:\n\nSegmentation fault in error_log:\n[Thu Jul 15 19:38:36 2004] [notice] child pid 42 exit signal Segmentation fault\n(11), possible coredump in /usr/local/httpd-2.0.50\n\n    Build Date & Platform:\n\n2004-07-14 build on SunOS 5.8 SUNW,UltraAX-i2\n\n    Additional Information:\n\nHere is a stack trace from gdb:\n\n#0  0xfef5060c in memcpy ()\n   from /usr/platform/SUNW,UltraAX-i2/lib/libc_psr.so.1\n#1  0xfeafef54 in char_buffer_read (buffer=0x1649ac,\n    in=0x2000 <Address 0x2000 out of bounds>, inl=8192) at ssl_engine_io.c:348\n#2  0xfeaff388 in ssl_io_input_read (inctx=0x164990,\n    buf=0x1649b8 \"Content-Length: 121\\r\\nCort/Martonia/0_2615\\r\\nContent-Length:\n121\\r\\nCent-Length: 121\\r\\nCmeport/Martonia/0_2615\\r\\nContent-Length:\n121\\r\\nCmeport/Martonia/0_2615\\r\\nContent-Length:\n121\\r\\nCrtonia/0_2615\\r\\nContent-Le\"..., len=0xffbea8cc) at ssl_engine_io.c:561\n#3  0xfeaff624 in ssl_io_input_getline (inctx=0x164990,\n    buf=0x1649b8 \"Content-Length: 121\\r\\nCort/Martonia/0_2615\\r\\nContent-Length:\n121\\r\\nCent-Length: 121\\r\\nCmeport/Martonia/0_2615\\r\\nContent-Length:\n121\\r\\nCmeport/Martonia/0_2615\\r\\nContent-Length:\n121\\r\\nCrtonia/0_2615\\r\\nContent-Le\"..., len=0xffbea944) at ssl_engine_io.c:712\n#4  0xfeb00118 in ssl_io_filter_input (f=0x1669c0, bb=0x158f98,\n    mode=4290685252, block=APR_BLOCK_READ, readbytes=0) at ssl_engine_io.c:1226\n#5  0x42978 in ap_get_brigade (next=0x1669c0, bb=0x158f98,\n    mode=AP_MODE_GETLINE, block=APR_BLOCK_READ, readbytes=0)\n    at util_filter.c:474\n#6  0x4aab4 in net_time_filter (f=0x158e20, b=0x158f98, mode=AP_MODE_GETLINE,\n    block=APR_BLOCK_READ, readbytes=0) at core.c:3600\n#7  0x42978 in ap_get_brigade (next=0x158e20, bb=0x158f98,\n    mode=AP_MODE_GETLINE, block=APR_BLOCK_READ, readbytes=0)\n    at util_filter.c:474\n#8  0x43e0c in ap_rgetline_core (s=0xffbeab94, n=8192, read=0xffbeab90,\n    r=0x1671b8, fold=1, bb=0x158f98) at protocol.c:214\n#9  0x441a4 in ap_getline (s=0xffbeccd8 \"Content-Length\", n=8192, r=0x1671b8,\n    fold=1) at protocol.c:478\n#10 0xfe8552d4 in ap_proxy_read_headers (r=0x1821d0, rr=0x1671b8,\n    buffer=0xffbeccd8 \"Content-Length\", size=8192, c=0x1671b8)\n    at proxy_util.c:457\n#11 0xfe833014 in ap_proxy_http_process_response (p=0x157960, r=0x1821d0,\n    p_conn=0x157ee8, origin=0x158168, backend=0x157f00, conf=0xf0268,\n    bb=0x157e98, server_portstr=0xffbeed68 \":47290\") at proxy_http.c:755\n#12 0xfe833ba4 in ap_proxy_http_handler (r=0x1821d0, conf=0xf0268,\n    url=0x158038\n\"/eRoomASP/CookieTest.asp?facility=memeport&URL=%2FeRoom%2Fmemeport%2FMartonia%2F0_2615\",\nproxyname=0x0, proxyport=60776) at proxy_http.c:1121\n#13 0xfe85435c in proxy_run_scheme_handler (r=0x1821d0, conf=0xf0268,\n    url=0x1839ce\n\"https://eroomhost.aaa.bbb.com/eRoomASP/CookieTest.asp?facility=memeport&URL=%2FeRoom%2Fmemeport%2FMartonia%2F0_2615\",\nproxyhost=0x0,\n    proxyport=0) at mod_proxy.c:1113\n#14 0xfe852ed8 in proxy_handler (r=0x1821d0) at mod_proxy.c:418\n#15 0x359a8 in ap_run_handler (r=0x1821d0) at config.c:151\n#16 0x35fa4 in ap_invoke_handler (r=0x1821d0) at config.c:358\n#17 0x32c44 in ap_process_request (r=0x1821d0) at http_request.c:246\n#18 0x2df14 in ap_process_http_connection (c=0x157a70) at http_core.c:250\n#19 0x40090 in ap_run_process_connection (c=0x157a70) at connection.c:42\n#20 0x403a4 in ap_process_connection (c=0x157a70, csd=0x157998)\n    at connection.c:175\n#21 0x3422c in child_main (child_num_arg=5) at prefork.c:609\n#22 0x343ac in make_child (s=0x8edb0, slot=5) at prefork.c:703\n#23 0x345fc in perform_idle_server_maintenance (p=0x8c690) at prefork.c:838\n#24 0x34a34 in ap_mpm_run (_pconf=0x0, plog=0x63400, s=0x83000)\n    at prefork.c:1039\n#25 0x3ad44 in main (argc=3, argv=0xffbef4ac) at main.c:617"}, {"count": 1, "tags": [], "creator": "nick@webthing.com", "attachment_id": null, "text": "Does this still happen if you take mod_rewrite out of the setup and use\nProxyPass instead?", "id": 60671, "time": "2004-07-16T05:12:34Z", "bug_id": 30134, "creation_time": "2004-07-16T05:12:34Z", "is_private": false}, {"count": 2, "tags": [], "creator": "lxhankins002@fastmail.fm", "attachment_id": null, "text": "Yes, I still get what seems to be the same segfault (according to gdb) if I\nreplace these config lines:\n\nRewriteEngine on\nRewriteRule /(.*) https://some.eroom6.iis.server.com/$1 [P]\n\nwith this one:\n\nProxyPass / https://some.eroom6.iis.server.com/", "id": 60880, "time": "2004-07-20T18:11:48Z", "bug_id": 30134, "creation_time": "2004-07-20T18:11:48Z", "is_private": false}, {"count": 3, "text": "This backtrace is a little strange:\n\n#1  0xfeafef54 in char_buffer_read (buffer=0x1649ac,\n    in=0x2000 <Address 0x2000 out of bounds>, inl=8192) at ssl_engine_io.c:348\n\nwhich means either stack corruption by memcpy or in got passed in as a pointer\nto address 8192 somehow.\n\nCan you, from gdb against a core dump, check:\n\nup 2 (into ssl_io_input_read)\nprint *inctx\ninfo locals\nprint buf\nprint len\n\n\n", "creator": "jorton@redhat.com", "attachment_id": null, "id": 61820, "time": "2004-08-11T13:30:29Z", "bug_id": 30134, "creation_time": "2004-08-11T13:30:29Z", "tags": [], "is_private": false}, {"count": 4, "text": "Hi Joe, \n \nI do suffer from the same bug. Attached is the info you requested. If you need \nadditional testing, please say so. I cleared some info from the contents of \nbuffer to not disclose critical information. I hope that's ok and doesn't \nhinder your debugging process. \n \nRegards, Stephan \n \nProgram received signal SIGSEGV, Segmentation fault. \n0xfedf060c in memcpy () from /usr/platform/SUNW,UltraAX-i2/lib/libc_psr.so.1 \n(gdb) where full \n#0  0xfedf060c in memcpy () \n   from /usr/platform/SUNW,UltraAX-i2/lib/libc_psr.so.1 \nNo symbol table info available. \n#1  0x00048060 in char_buffer_read (buffer=0x196d54, \n    in=0x196d60 \"Cet-Cookie: s\"..., \n    at ssl_engine_io.c:348 \nNo locals. \n#2  0x00048448 in ssl_io_input_read (inctx=0x196d38, \n    buf=0x196d60 \"Cet-Cookie: s\"..., \n    len=0xffbeafa4) at ssl_engine_io.c:561 \n        wanted = 8192 \n        bytes = 1533728 \n        rc = 8192 \n#3  0x00048714 in ssl_io_input_getline (inctx=0x196d38, \n    buf=0x196d60 \"Cet-Cookie: s\"..., \n    len=0xffbeafa4) at ssl_engine_io.c:712 \n        pos = 0x173ea0 \"\" \n        status = 1666360 \n        tmplen = 1 \n        offset = 1533728 \n(gdb) up 2 \n#2  0x00048448 in ssl_io_input_read (inctx=0x196d38, \n    buf=0x196d60 \"Cet-Cookie: s\"..., \n    len=0xffbeafa4) at ssl_engine_io.c:561 \n561 \n(gdb) print *inctx \n$1 = {ssl = 0x173db8, bio_out = 0x172210, f = 0x198d68, rc = 0, \n  mode = AP_MODE_GETLINE, block = APR_BLOCK_READ, bb = 0x198d80, cbuf = { \n    length = 1, value = 0xffffffff <Address 0xffffffff out of bounds>}, \n  pool = 0x16fea8, \n  buffer = \"Cet-Cookie: s\"..., \n  filter_ctx = 0x17e058} \n(gdb) info locals \nwanted = 8192 \nbytes = 1533728 \nrc = 8192 \n(gdb) print buf \n$2 = 0x196d60 \"Cet-Cookie: s\"..., \n(gdb) print len \n$3 = (apr_size_t *) 0xffbeafa4 \n \n ", "creator": "s.tesch@science-computing.de", "attachment_id": null, "id": 62033, "time": "2004-08-16T11:54:28Z", "bug_id": 30134, "creation_time": "2004-08-16T11:54:28Z", "tags": [], "is_private": false}, {"count": 5, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "text": "Ah ha, that's crucial info, thanks.\n\nIt looks like the cause is: ssl_io_input_read is called with inctx->mode ==\nSPECULATIVE (this only normally happens in the proxy IIRC); ssl_io_input_read\ncalls char_buffer_read, which executes the case where it does:\n\n        buffer->value = NULL;\n        buffer->length = 0;\n\nand ssl_io_input_read then screws up the inctx->cbuf for good.\n\n            /* We want to rollback this read. */\n            inctx->cbuf.value -= bytes;\n            inctx->cbuf.length += bytes;\n\ncbuf = { length = 1, value = 0xffffffff <Address 0xffffffff out of bounds>}, \n\nper your backtrace.\n\n", "id": 62034, "time": "2004-08-16T12:15:45Z", "bug_id": 30134, "creation_time": "2004-08-16T12:15:45Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 30134, "attachment_id": 12459, "id": 62071, "time": "2004-08-17T12:48:06Z", "creator": "jorton@redhat.com", "creation_time": "2004-08-17T12:48:06Z", "is_private": false, "text": "Created attachment 12459\nproposed fix"}, {"count": 7, "tags": [], "bug_id": 30134, "attachment_id": null, "id": 62072, "time": "2004-08-17T12:49:35Z", "creator": "jorton@redhat.com", "creation_time": "2004-08-17T12:49:35Z", "is_private": false, "text": "The patch attached above should fix the segfaults, I'm not yet sure if this is\nthe cleanest or most correct fix."}, {"count": 8, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "text": "The fix checked in should be equivalent:\n\nhttp://cvs.apache.org/viewcvs.cgi/httpd-2.0/modules/ssl/ssl_engine_io.c?r1=1.125&r2=1.126\n\nThis issue has possible security implications; it's been assigned CVE\nCAN-2004-0751 (cve.mitre.org).  Thanks for the report and for the debugging.", "id": 62089, "time": "2004-08-17T21:03:21Z", "bug_id": 30134, "creation_time": "2004-08-17T21:03:21Z", "is_private": false}]