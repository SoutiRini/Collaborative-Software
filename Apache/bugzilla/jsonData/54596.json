[{"count": 0, "tags": [], "bug_id": 54596, "attachment_id": null, "text": "Hi Team,\n\nFound the below issue on the following environment:\n  Windows Server 2008 R2 Datacentee (64 bit)\n  IIS 7.5 & Tomee 1.5.1\n  isapi_redirect.dll 1.2.37 (64 bit)\n\nIssue:  Utilising relative paths in properties file for the various configuration files (log, workers.properties, uriworkermap.properties) truncates last character of the string value.\n\n############################################################\nISAPI_REDIRECT.PROPERTIES\n# Configuration file for the Jakarta ISAPI Redirector\n\n# The path to the ISAPI Redirector Extension, relative to the website\n# This must be in a virtual directory with execute privileges\nextension_uri=/mywebapp/isapi_redirect.dll\n\n# Full path to the log file for the ISAPI Redirector\nlog_file=jk_iis.log\n\n# Log level (debug, info, warn, error or trace)\nlog_level=debug \n\n# Full path to the workers.properties file\nworker_file=workers.properties\n\n# Full path to the uriworkermap.properties file\nworker_mount_file=uriworkermap.properties\n############################################################\n\n... all files do exist in the same C:\\Tomee\\connectors\\ folder.\n\nIf I specify absolute paths (C:\\Tomee\\connectors\\uriworkermap.properties), everything works fine.\n\nIf I use relative paths with log and config file outside of dll/properties files folder, no log file generated making it difficult to debug.\n\nIf I use relative paths with all files in the same folder, a jk_iis.lo (missing the g) file is created with the following output:\n\n[Fri Feb 22 13:57:32.490 2013] [7920:7680] [debug] jk_set_time_fmt::jk_util.c (461): Pre-processed log time stamp format is '[%a %b %d %H:%M:%S.000 %Y] '\n[Fri Feb 22 13:57:32.490 2013] [7920:7680] [info] init_jk::jk_isapi_plugin.c (2690): Starting Jakarta/ISAPI/isapi_redirector/1.2.37\n[Fri Feb 22 13:57:32.490 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2701): Detected IIS version 7.5\n[Fri Feb 22 13:57:32.505 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2703): Using ini file C:\\Tomee\\connectors\\isapi_redirect.properties.\n[Fri Feb 22 13:57:32.505 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2709): Using log file C:\\Tomee\\connectors\\jk_iis.lo.\n[Fri Feb 22 13:57:32.505 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2710): Using log level 1.\n[Fri Feb 22 13:57:32.505 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2711): Using log rotation time 0 seconds.\n[Fri Feb 22 13:57:32.505 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2712): Using log file size 0 bytes.\n[Fri Feb 22 13:57:32.505 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2714): Using extension uri /mywebapp/isapi_redirect.dll.\n[Fri Feb 22 13:57:32.505 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2715): Using worker file C:\\Tomee\\connectors\\workers.propertie.\n[Fri Feb 22 13:57:32.505 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2716): Using worker mount file C:\\Tomee\\connectors\\uriworkermap.propertie.\n[Fri Feb 22 13:57:32.521 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2718): Using rewrite rule file .\n[Fri Feb 22 13:57:32.521 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2720): Using uri select 3.\n[Fri Feb 22 13:57:32.521 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2721): Using no chunked encoding.\n[Fri Feb 22 13:57:32.521 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2723): Using notification event SF_NOTIFY_AUTH_COMPLETE (0x04000000)\n[Fri Feb 22 13:57:32.521 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2733): Using uri header TOMCATURI0000000180000000:.\n[Fri Feb 22 13:57:32.521 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2734): Using query header TOMCATQUERY0000000180000000:.\n[Fri Feb 22 13:57:32.521 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2735): Using worker header TOMCATWORKER0000000180000000:.\n[Fri Feb 22 13:57:32.521 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2736): Using worker index TOMCATWORKERIDX0000000180000000:.\n[Fri Feb 22 13:57:32.521 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2737): Using translate header TOMCATTRANSLATE0000000180000000:.\n[Fri Feb 22 13:57:32.536 2013] [7920:7680] [debug] init_jk::jk_isapi_plugin.c (2738): Using a default of 250 connections per pool.\n[Fri Feb 22 13:57:32.536 2013] [7920:7680] [error] uri_worker_map_load::jk_uri_worker_map.c (1241): Failed to load uri_worker_map file C:\\Tomee\\connectors\\uriworkermap.propertie (errno=2, err=No such file or directory).\n\nFurthermore... if I use the following configuration:\n\n############################################################\nISAPI_REDIRECT.PROPERTIES\n# Configuration file for the Jakarta ISAPI Redirector\n\n# The path to the ISAPI Redirector Extension, relative to the website\n# This must be in a virtual directory with execute privileges\nextension_uri=/mywebapp/isapi_redirect.dll\n\n# Full path to the log file for the ISAPI Redirector\nlog_file=jk_iis.log\n\n# Log level (debug, info, warn, error or trace)\nlog_level=debug \n\n# Full path to the workers.properties file\nworker_file=..\\conf\\workers.properties\n\n# Full path to the uriworkermap.properties file\nworker_mount_file=..\\conf\\uriworkermap.properties\n############################################################\n  \nI get the output:\n\n[Fri Feb 22 14:06:06.888 2013] [7976:8040] [debug] jk_set_time_fmt::jk_util.c (461): Pre-processed log time stamp format is '[%a %b %d %H:%M:%S.000 %Y] '\n[Fri Feb 22 14:06:06.888 2013] [7976:8040] [info] init_jk::jk_isapi_plugin.c (2690): Starting Jakarta/ISAPI/isapi_redirector/1.2.37\n[Fri Feb 22 14:06:06.903 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2701): Detected IIS version 7.5\n[Fri Feb 22 14:06:06.903 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2703): Using ini file C:\\Tomee\\connectors\\isapi_redirect.properties.\n[Fri Feb 22 14:06:06.903 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2709): Using log file C:\\Tomee\\connectors\\jk_iis.lo.\n[Fri Feb 22 14:06:06.903 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2710): Using log level 1.\n[Fri Feb 22 14:06:06.903 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2711): Using log rotation time 0 seconds.\n[Fri Feb 22 14:06:06.903 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2712): Using log file size 0 bytes.\n[Fri Feb 22 14:06:06.903 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2714): Using extension uri /mywebapp/isapi_redirect.dll.\n[Fri Feb 22 14:06:06.903 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2715): Using worker file C:\\Tomee\\connectors\\conf\\workers.properties.\n[Fri Feb 22 14:06:06.903 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2716): Using worker mount file C:\\Tomee\\connectors\\conf\\uriworkermap.properties.\n[Fri Feb 22 14:06:06.918 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2718): Using rewrite rule file .\n[Fri Feb 22 14:06:06.918 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2720): Using uri select 3.\n[Fri Feb 22 14:06:06.918 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2721): Using no chunked encoding.\n[Fri Feb 22 14:06:06.918 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2723): Using notification event SF_NOTIFY_AUTH_COMPLETE (0x04000000)\n[Fri Feb 22 14:06:06.918 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2733): Using uri header TOMCATURI0000000180000000:.\n[Fri Feb 22 14:06:06.918 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2734): Using query header TOMCATQUERY0000000180000000:.\n[Fri Feb 22 14:06:06.918 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2735): Using worker header TOMCATWORKER0000000180000000:.\n[Fri Feb 22 14:06:06.934 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2736): Using worker index TOMCATWORKERIDX0000000180000000:.\n[Fri Feb 22 14:06:06.934 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2737): Using translate header TOMCATTRANSLATE0000000180000000:.\n[Fri Feb 22 14:06:06.934 2013] [7976:8040] [debug] init_jk::jk_isapi_plugin.c (2738): Using a default of 250 connections per pool.\n[Fri Feb 22 14:06:06.934 2013] [7976:8040] [error] uri_worker_map_load::jk_uri_worker_map.c (1241): Failed to load uri_worker_map file C:\\Tomee\\connectors\\conf\\uriworkermap.properties (errno=2, err=No such file or directory).\n\n... whereas the initial declaration of file location is correct but subsequent uri_worker_map load ignores the \"..\\\" relative declaration. \n  \nWorkaround:  \n  1.  Use absolute paths.\n  2.  Add a superfluous character in your isapi_redirect.properties file so it is truncated instead of the real value.  e.g.  \"uriworkmap.propertiesx\"\n\nI hope this enough information to find the issue.  If I can help with other information or testing, let me know.\nThanks\nBrad", "id": 165433, "time": "2013-02-22T06:14:37Z", "creator": "bradc@rmt.com.au", "creation_time": "2013-02-22T06:14:37Z", "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 54596, "text": "I found the same issue, didn't find this bug, adding comment to help others find it:\non a Windows Server 2008 R2 system with IIS 7.5,\nWhen using the properties FILE rather than Registry entires to configure the connector, and attempting to access a JSP or non-JSP error, the browser gives a HTTP 500 error.\n\nThe System Event shows two relevant entries in the Application Log:\n\nApplication Log\nSource: IIS-W3SVC-WP. Error 2214\nThe HTTP Filter DLL E:\\Program Files\\Apache Software Foundation\\Jakarta\\isapi_redirect.dll failed to load.  The data is the error.\n\nSource: IIS-W3SVC-WP. Error 2268\nCould not load all ISAPI filters for site 'GDSCNOLA'.  Therefore site startup aborted.\n---------------------------\n\nThe root cause appears to be that the code drops the last character of the  file names pulled from the isapi_redirect.properties file, including the log file name generated by this.\nThis is indicated in the log file generated and CONFIRMED using Process Monitor... which showed failure messages attempting to find these files with the missing last character.\nDon't know if this happens for the 32-bit connector or not.\nTried appending a space at the end of those lines with file names, did not help. Nor did enclosing in double-quotes (the parsed file name then started with a double-quote).\nUsing the Registry for these settings worked fine.\n\nisapi_redirect.properties\n---------------------------\nextension_uri=/jakarta/isapi_redirect.dll\nworker_file=workers.properties.minimal \nworker_mount_file=uriworkermap.properties \nlog_level=debug \nlog_file=jakarta.log \n---------------------------", "id": 172829, "time": "2014-01-31T16:44:51Z", "creator": "johnpalmer2@gmail.com", "creation_time": "2014-01-31T16:44:51Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 54596, "is_private": false, "text": "(In reply to John Palmer from comment #1)\n> on a Windows Server 2008 R2 system with IIS 7.5,\n> When using the properties FILE rather than Registry entires to configure the\n> connector, and attempting to access a JSP or non-JSP error, the browser\n> gives a HTTP 500 error.\n\nHave you checked for Windows-compatible line terminators in each line of the properties file?  If they're not CR-LF, something odd might happen.", "id": 172830, "time": "2014-01-31T17:18:14Z", "creator": "chuck.caldarale@unisys.com", "creation_time": "2014-01-31T17:18:14Z", "attachment_id": null}, {"count": 3, "attachment_id": null, "bug_id": 54596, "is_private": false, "id": 174812, "time": "2014-04-23T15:26:40Z", "creator": "Thomas.Hoffmann@speed4trade.com", "creation_time": "2014-04-23T15:26:40Z", "tags": [], "text": "I have also encountered this problem.\nTestet with 1.2.40.0 of isapi_redirect.dll\nThe relative paths are not taken into account. Line-breaks are CR+LF\nNeither \\ nor / are working. \n\nSample Config-File with relevant entries:\nlog_file=iis_redirect.log\nworker_file=..\\..\\conf\\worker.properties\nworker_mount_file=..\\..\\conf\\uriworkermap.properties\n\n\nLogfile is written with the following messages:\n[Wed Apr 23 17:20:34.695 2014] [6716:13964] [debug] jk_set_time_fmt::jk_util.c (480): Pre-processed log time stamp format is '[%a %b %d %H:%M:%S.000 %Y] '\n[Wed Apr 23 17:20:34.699 2014] [6716:13964] [info] init_jk::jk_isapi_plugin.c (2689): Starting Jakarta/ISAPI/isapi_redirector/1.2.40\n[Wed Apr 23 17:20:34.702 2014] [6716:13964] [debug] init_jk::jk_isapi_plugin.c (2700): Detected IIS version 8.0\n[Wed Apr 23 17:20:34.705 2014] [6716:13964] [debug] init_jk::jk_isapi_plugin.c (2702): Using ini file D:\\Programme\\Apache Software Foundation\\Tomcat 7.0.53\\bin\\win32\\isapi_redirect.properties.\n[Wed Apr 23 17:20:34.707 2014] [6716:13964] [debug] init_jk::jk_isapi_plugin.c (2708): Using log file D:\\Programme\\Apache Software Foundation\\Tomcat 7.0.53\\bin\\win32\\iis_redirect.lo.\n...\n[Wed Apr 23 17:20:34.724 2014] [6716:13964] [debug] init_jk::jk_isapi_plugin.c (2714): Using worker file D:\\Programme\\Apache Software Foundation\\Tomcat 7.0.53\\bin\\win32\\conf\\worker.properties.\n[Wed Apr 23 17:20:34.727 2014] [6716:13964] [debug] init_jk::jk_isapi_plugin.c (2715): Using worker mount file D:\\Programme\\Apache Software Foundation\\Tomcat 7.0.53\\bin\\win32\\conf\\uriworkermap.properties.\n...\n[Wed Apr 23 17:20:34.752 2014] [6716:13964] [error] uri_worker_map_load::jk_uri_worker_map.c (1280): Failed to load uri_worker_map file D:\\Programme\\Apache Software Foundation\\Tomcat 7.0.53\\bin\\win32\\conf\\uriworkermap.properties (errno=2, err=No such file or directory).\n\n\nThis shows that the dots for the relative paths are truncated and not taken into account. The conversion from relative path to absolute path seems to fail.\n\n\nTested under Win 8.1 64 Bit, Connector version 1.2.40.0\nHope this informations helps to narrow down the problem."}, {"count": 4, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "is_private": false, "id": 174816, "time": "2014-04-23T19:27:10Z", "bug_id": 54596, "creation_time": "2014-04-23T19:27:10Z", "text": "(In reply to Thomas Hoffmann from comment #3)\n> I have also encountered this problem.\n> Testet with 1.2.40.0 of isapi_redirect.dll\n> The relative paths are not taken into account. Line-breaks are CR+LF\n> Neither \\ nor / are working. \n> \n> Sample Config-File with relevant entries:\n> log_file=iis_redirect.log\n> worker_file=..\\..\\conf\\worker.properties\n> worker_mount_file=..\\..\\conf\\uriworkermap.properties\n\n[snip]\n\n> init_jk::jk_isapi_plugin.c (2702): Using ini file D:\\Programme\\Apache\n> Software Foundation\\Tomcat 7.0.53\\bin\\win32\\isapi_redirect.properties.\n\nThis path appears to be correct.\n\n> [Wed Apr 23 17:20:34.707 2014] [6716:13964] [debug]\n> init_jk::jk_isapi_plugin.c (2708): Using log file D:\\Programme\\Apache\n> Software Foundation\\Tomcat 7.0.53\\bin\\win32\\iis_redirect.lo.\n\nThis one appears to not be correct.\n\nIs this only a problem with the log file specifically? Other examples I see in here all have a correct properties file name and a broken log file name.\n\n> ...\n> [Wed Apr 23 17:20:34.724 2014] [6716:13964] [debug]\n> init_jk::jk_isapi_plugin.c (2714): Using worker file D:\\Programme\\Apache\n> Software Foundation\\Tomcat 7.0.53\\bin\\win32\\conf\\worker.properties.\n> [Wed Apr 23 17:20:34.727 2014] [6716:13964] [debug]\n> init_jk::jk_isapi_plugin.c (2715): Using worker mount file\n> D:\\Programme\\Apache Software Foundation\\Tomcat\n> 7.0.53\\bin\\win32\\conf\\uriworkermap.properties.\n> ...\n> [Wed Apr 23 17:20:34.752 2014] [6716:13964] [error]\n> uri_worker_map_load::jk_uri_worker_map.c (1280): Failed to load\n> uri_worker_map file D:\\Programme\\Apache Software Foundation\\Tomcat\n> 7.0.53\\bin\\win32\\conf\\uriworkermap.properties (errno=2, err=No such file or\n> directory).\n> \n> \n> This shows that the dots for the relative paths are truncated and not taken\n> into account. The conversion from relative path to absolute path seems to\n> fail.\n> \n> \n> Tested under Win 8.1 64 Bit, Connector version 1.2.40.0\n> Hope this informations helps to narrow down the problem.\n\nThis appears to be a different issue: relative paths aren't properly-resolved at all."}, {"count": 5, "tags": [], "creator": "rainer.jung@kippdata.de", "text": "I have fixed the problem with the missing last character in file names in r1647660. It will be part of version 1.2.41.\n\nThe problem only happens, if the configured relativ file path does not contain a \"..\" path component.\n\nI can also confirm the second part of this bug, namely that \"..\" path components are not handled correctly, if they would go up the directory hierarchy further than the start of the file name. \"..\" components which exceed that directory will simply be ignored. So \"a/b/c/../../file\" would work, but \"../file\" would result in the same as \"file\" (except that the other bug with the missing last character would not be triggered).\n\nI will see, whether I can fix this as well.", "id": 180003, "time": "2014-12-23T20:09:30Z", "bug_id": 54596, "creation_time": "2014-12-23T20:09:30Z", "is_private": false, "attachment_id": null}, {"count": 6, "attachment_id": null, "bug_id": 54596, "is_private": false, "id": 180005, "time": "2014-12-23T22:12:03Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2014-12-23T22:12:03Z", "tags": [], "text": "I hope I have fixed the second problem - handling \"..\" path segments - in r1647684. It will be part of version 1.2.41, help with testing welcome."}, {"count": 7, "tags": [], "creator": "knst.kolinko@gmail.com", "text": "Reviewing the code of native/iis/jk_isapi_plugin.c I have the following comments\n\n1). The skip_prefix() utility method can return a non-null value without assigning any values to \"sp\" and \"cp\" pointers. It may result in crash in a caller of that method.\n\nActually the \"cp\" value is never used by the callers of skip_prefix() method. That argument can be removed.\n\nEssentially, the skip_prefix() method returns two values:\n\n1. The return value (path): Pointer to the first character after 'C:' or '//share/' prefix.\n2. sp: \"start pointer\", \"start prefix\"?  Pointer to the first valuable character - the first character of 'C:' or '//share/' prefix, or the same as the main return value if there is no prefix.\n\n\n2). In relative_path():\n\n[[[\n                        while (cp > sp) {\n]]]\n\nTechnically, the minimum value for \"cp\" is not sp, but the return value of skip_prefix() call. If those are different then it means that the value if an absolute path starting with \"C:\" or \"//share/\" prefix.\n\nActually that never happens in practice, because we never deal with an absolute path here. All calls to path_merge() -> relative_path() are guarded by a \"is_path_relative()\" condition.\n\n\n3). In relative_path():\n\nThere is a while(nd > 1) loop. It provides support for n consecutive dots, as supported on Unix.  On Windows the code supports only '.' or '..' dots. As such, the loop can be simplified to a simple if(nd > 1).\n\n(If instead of that one wants to implement support for relative paths with more than 2 dots, then\n (*remain)++;\nhas to be replaced with\n (*remain)+=(nd-1);\n)", "id": 180006, "time": "2014-12-24T03:35:10Z", "bug_id": 54596, "creation_time": "2014-12-24T03:35:10Z", "is_private": false, "attachment_id": null}, {"count": 8, "text": "Created attachment 32328\n2014-12-24_jk_54596_c7.patch\n\nPatch (untested) to address the issues from Comment 7", "bug_id": 54596, "is_private": false, "id": 180007, "time": "2014-12-24T03:38:02Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-12-24T03:38:02Z", "tags": [], "attachment_id": 32328}, {"count": 9, "tags": [], "creator": "rainer.jung@kippdata.de", "text": "Thanks a bunch Konstantin, I committed the patch in r1647746. Looked good to me.\nI plan to do testing next week.\nKeeping this issue open until then as a reminder.", "id": 180010, "time": "2014-12-24T08:48:09Z", "bug_id": 54596, "creation_time": "2014-12-24T08:48:09Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "is_private": false, "id": 180011, "time": "2014-12-24T11:26:06Z", "bug_id": 54596, "creation_time": "2014-12-24T11:26:06Z", "text": "In path_merge()\n\n[[[\n            if (remain > 0) {\n                return \"\";\n            }\n]]]\n\nmaybe\n                SetLastError(ERROR_BAD_PATHNAME);\n                return 0;\n\nlike in other erroneous situations.\n\nCallers of path_merge() check its success with a non-null condition. I think that they are not ready to receive an empty string."}, {"count": 11, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 193660, "time": "2016-09-12T19:24:18Z", "bug_id": 54596, "creation_time": "2016-09-12T19:24:18Z", "text": "Assuming this is fixed in 1.2.41."}]