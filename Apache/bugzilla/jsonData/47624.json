[{"count": 0, "tags": [], "bug_id": 47624, "attachment_id": 24083, "text": "Created attachment 24083\nError throwing file attachment\n\nWhen I try to comment already commented workbook and save->open, throws 'file error: data may have been lost' error.\n\nFYI, I have followed same steps as described at http://poi.apache.org/spreadsheet/quick-guide.html#CellComments (using HSSF library)\n\nRepro steps:\n1. create a brand new workbook and add cell comment as described in quick-guide\n2. write workbook\n3. read already commented workbook\n4. add another cell with comment\n5. write workbook again\n6. now when trying to open workbook using MS Excel 2003, 2007(Windows XP pro) & Mac version of 2008, causes following error: 'File error:data may have been lost'.. (I can still open the document tho!)\n\nPOI version:\n-tried with POI 3.2-FINAL && POI 3.5 beta 6. Same error both times.\n\nI added the error throwing file with defect. (or you can create one by simply following exact (except second time reading existing file) quick-guide guidelines).", "id": 129386, "time": "2009-08-02T12:40:19Z", "creator": "cbenjaram@verical.com", "creation_time": "2009-08-02T12:40:19Z", "is_private": false}, {"count": 1, "tags": [], "creator": "nothize@gmail.com", "attachment_id": null, "id": 135410, "time": "2010-03-18T07:43:34Z", "bug_id": 47624, "creation_time": "2010-03-18T07:43:34Z", "is_private": false, "text": "I've experienced this problem too.\n\nAfter some tracing with the 3.6 stable release source, the problem seems to be rely in...\n\nSheet.java: public int aggregateDrawingRecords(DrawingManager2 drawingManager, boolean createIfMissing).\n\n1491:1499\n\n        EscherAggregate r = EscherAggregate.createAggregate( records, loc, drawingManager );\n        int startloc = loc;\n        while ( loc + 1 < records.size()\n                && records.get( loc ) instanceof DrawingRecord\n                && records.get( loc + 1 ) instanceof ObjRecord )\n        {\n            loc += 2;\n        }\n\n\nwhere a practical DrawingRecord and ObjRecord pair loop looks like the following inside EscherAggregate:\n\n\t\twhile ( loc + 1 < records.size()\n\t\t\t\t&& sid( records, loc ) == DrawingRecord.sid\n\t\t\t\t&& isObjectRecord( records, loc + 1 ) )\n\n.\n\nThus the Sheet's loop for calculating loc will be too early terminated since there could be non-ObjRecord but TextObjRecord that should be taken into consideration too.\n\nI'll try to patch it locally and observe how it goes. The latest development branch seems to refactored alot and renamed Sheet.java to InternalSheet.java, though the code snippet around this issue is still similar."}, {"count": 2, "tags": [], "creator": "nothize@gmail.com", "attachment_id": null, "id": 135412, "time": "2010-03-18T07:47:00Z", "bug_id": 47624, "creation_time": "2010-03-18T07:47:00Z", "is_private": false, "text": "*** Bug 48327 has been marked as a duplicate of this bug. ***"}, {"count": 3, "tags": [], "creator": "nothize@gmail.com", "attachment_id": null, "is_private": false, "id": 135414, "time": "2010-03-18T08:44:26Z", "bug_id": 47624, "creation_time": "2010-03-18T08:44:26Z", "text": "A simple workaround as a PoC is as below.\n\nWhere Invoker is a reflection util to read the private property by force.\n\n-----------------------\n\t    if ( null == drawing ) {\n\t    \tdrawing = sh.createDrawingPatriarch();\n\t    \t// Remove redundant records to avoid error.\n\t    \t\n\t    \tSheet _sh = (Sheet)Invoker.getProperty(sh, \"_sheet\");\n\t    \tList list = _sh.getRecords();\n\t    \tfor ( Iterator it = list.iterator(); it.hasNext(); ) {\n\t    \t\tRecordBase e = (RecordBase)it.next();\n\t\t\t\tif ( e instanceof TextObjectRecord || e instanceof DrawingRecord || e instanceof ObjRecord ) {\n\t\t\t\t\tit.remove();\n\t\t\t\t}\n\t\t\t}\n\t    }\n-----------------------\n\nThe idea is that the Sheet.aggregateDrawingRecords(..) called by HSSFSheet.createDrawingPatriarch() fails to remove and also destroyed the pairing of DrawingRecord and *ObjRecord that causing the Excel open file error prompt.\n\nThe patch to Sheet.java will follow."}, {"count": 4, "tags": [], "creator": "nothize@gmail.com", "attachment_id": null, "is_private": false, "id": 135417, "time": "2010-03-18T09:52:17Z", "bug_id": 47624, "creation_time": "2010-03-18T09:52:17Z", "text": "Further testing reveals that NoteRecord is also a factor of the error prompt.\n\nIf any of the new comments are on in the same location as the old comments, the redundant NoteRecord will cause Excel to report an error upon opening.\n\nRemoving the NoteRecord manually seems to solve this problem."}, {"count": 5, "tags": [], "creator": "nothize@gmail.com", "attachment_id": null, "id": 135424, "time": "2010-03-18T10:41:14Z", "bug_id": 47624, "creation_time": "2010-03-18T10:41:14Z", "is_private": false, "text": "The issues related are out of my knowledge.\n\nI opt to not do the patch but just derive a workaround for my own case.\n\nFor those who want to solve the problem, try removing NoteRecord after Sheet.createDrawingPatriarch(..).\n\nNoteRecord reading and re-writing is not supported in 3.6 either."}, {"count": 6, "tags": [], "text": "It is a limitation of HSSF - comments are graphic objects and HSSF can create drawings from scratch, but cannot\nmodify existing ones. This means that if you add an comment to a sheet that\nalready has graphic objects (comments, shapes, pictures, etc.) then the existing graphic objects are invalidated.  \n\nAs a workaround, try to output in .xlsx format, it should handle comments across re-saves without problems.\n\nYegor\n\n*** This bug has been marked as a duplicate of bug 50696 ***", "is_private": false, "bug_id": 47624, "id": 147498, "time": "2011-06-25T13:51:23Z", "creator": "yegor@dinom.ru", "creation_time": "2011-06-25T13:51:23Z", "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 47624, "attachment_id": null, "text": "This problem should be fixed in trunk.\n\nPlease try with a nightly build - see download links on http://poi.apache.org/\nor build yourself from SVN trunk, see http://poi.apache.org/subversion.html", "id": 161296, "time": "2012-08-12T11:49:57Z", "creator": "superrubiroyd@gmail.com", "creation_time": "2012-08-12T11:49:57Z", "is_private": false}]