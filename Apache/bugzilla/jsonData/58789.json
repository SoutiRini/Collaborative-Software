[{"count": 0, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 187331, "time": "2016-01-03T00:20:17Z", "creator": "gilperon@gmail.com", "creation_time": "2016-01-03T00:20:17Z", "is_private": false, "text": "In my CENTOS 7 server I have Apache 2.4 installed with mod_headers enabled.\n\nI have a site at directory /aaa/bbb/ccc/index.php\n\nI have an htaccess on every directory \"/aaa\", another in \"/aaa/bbb\" and another in \"/aaa/bbb/ccc\".\n\nIn the htaccess located at /aaa I have this\n\nHeader set AAA ZZZ\n\nIn the htaccess located at /aaa/bbb and /aaa/bbb/ccc I have this\n\nHeader set AAA XXXXXXXX\n\nWhen I open the website using my browser the header AAA has the value ZZZ. For some reason the other htaccess files are not overriding the value of AAA. But what is really strange is that if I change the htaccess from /aaa/bbb and /aaa/bbb/ccc to the code below the header gets overrided! Why?\n\n<FilesMatch \"^.*$\">\n\n    Header set AAA XXXXXXXX\n\n</FilesMatch>"}, {"count": 1, "tags": [], "creator": "wrowe@apache.org", "text": "This resource is for reporting defects in the Apache httpd software, not for support questions.\n\nhttps://httpd.apache.org/docs/2.4/sections.html\n\nmay help you better understand the order of operations.\n\nhttp://httpd.apache.org/lists.html#http-users\n\nThe users list may be able to answer your further questions.", "id": 187383, "time": "2016-01-04T23:09:13Z", "bug_id": 58789, "creation_time": "2016-01-04T23:09:13Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 58789, "attachment_id": null, "text": "I think you didnt read what I asked. I am a programmer, I dont want support, I know very well what I am doing. On Apache 2.2 this bug didnt occur, it only occurs on Apache 2.4.\n\nI am trying to help the community, not asking a support. You should be more polite and read the bug instead of complaning.", "id": 187384, "time": "2016-01-04T23:40:01Z", "creator": "gilperon@gmail.com", "creation_time": "2016-01-04T23:40:01Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 58789, "text": "First you are asking a user question;\n\n\"if I change the htaccess from /aaa/bbb and /aaa/bbb/ccc to the code below the header gets overrided! Why?\"\n\nIt has always worked this way, <Files > blocks are and always have been applied last after <Directory > blocks (including .htaccess assignments).\n\nSecondly, it is not clear whether you have the .htaccess directives correctly configured in <Directory > blocks in your httpd.conf (and attaching your httpd.conf is usually a dead giveaway that this is a user question).\n\nhttp://httpd.apache.org/docs/2.4/howto/htaccess.html\n\nexplains the controls.  Deleting the .htaccess file in /aaa could quickly tell you whether the .htaccess files in /aaa/bbb and /aaa/bbb/ccc are entirely ignored.\n\nI expect you will resolve your own question reviewing the documention, but will leave this as NEEDINFO for you to explain precisely what you tried and precisely what the result was.  Thus far it looks like it is behaving as designed.", "id": 187386, "attachment_id": null, "creator": "wrowe@apache.org", "creation_time": "2016-01-05T00:34:27Z", "time": "2016-01-05T00:34:27Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 58789, "attachment_id": null, "text": "Sorry I mis-parsed your question; is the following correct?\n\n/aaa/.htaccess:\n  Header set AAA ZZZ\n  \n/aaa/bbb/.htaccess:\n  Header set AAA XXXXXXXX\n\n/aaa/bbb/ccc/.htaccess:\n  Header set AAA XXXXXXXX\n\n(To clarify, there is no Header set AAA anywhere in your httpd.conf or other config files - and none of the directives above are in <Section > blocks)\n\nRequest:\nGET /aaa/bbb/ccc/index.php\n\nResponse:\nAAA: ZZZ\n\nExpected:\nAAA: XXXXXXXX\n\n\"When I open the website using my browser the header AAA has the value ZZZ. For some reason the other htaccess files are not overriding the value of AAA.\"\n\nGot it...\n\n\"But what is really strange is that if I change the htaccess from /aaa/bbb and /aaa/bbb/ccc to the code below the header gets overrided! Why?\"\n\n/aaa/bbb/ccc/.htaccess:\n  <FilesMatch \"^.*$\">\n    Header set AAA XXXXXXXX\n  </FilesMatch>\n\nRequest:\nGET /aaa/bbb/ccc/index.php\n\nResponse:\nAAA: XXXXXXXX\n\nSo - you have documented that httpd is configured to parse /aaa/bbb/ccc/.htaccess, thank you for the clarity, sorry I misread your question.", "id": 187387, "time": "2016-01-05T00:40:02Z", "creator": "wrowe@apache.org", "creation_time": "2016-01-05T00:40:02Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 187388, "time": "2016-01-05T01:43:38Z", "creator": "gilperon@gmail.com", "creation_time": "2016-01-05T01:43:38Z", "is_private": false, "text": "@William A. Rowe Jr.  maybe I should have been more clear about my question. Your description of what is happening is precise. I am not \"used\" to report bug, actually this is my first time so I had no idea how to do this.\n\nThe entire description that you provided is exactly what I did, and the results are exactly as you pointed.\n\nAll my 3 htaccess files are being \"parsed\" by Apache, I am really sure of that: if I remove 2 htaccess and leave only one, the result (response) is exactly as expected. If I remove any other 2 htaccess and leave another one, the result (response) is exactly as expected.\n\nThe problem I am facing has nothing to do with <Directory> or <Files> blocks, I am not even using them in any of my htaccess files. I am also using the default httpd.conf file, it has no \"Header set AAA\" in any line. I tested this bug on a completely fresh new Apache 2.4 install on my Centos 7.1 server. This bug does not happen with Apache 2.2, I mean: with Apache 2.2 the header \"AAA\" is overrided by the htaccess of the directory /aaa/bbb/ccc/, exactly as expected.\n \nThe lines below, that you kindly described, are also exactly what I am getting (which proves the bug):\n\nRequest:\nGET /aaa/bbb/ccc/index.php\n\nResponse:\nAAA: ZZZ\n\nExpected Response:\nAAA: XXXXXXXX\n\nIf I need to provide any other information I would be glad to help! Hope you can keep me updated what are the next steps I should do to try to make this bug get fixed."}, {"count": 6, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 187403, "creation_time": "2016-01-05T23:20:27Z", "time": "2016-01-05T23:20:27Z", "creator": "wrowe@apache.org", "text": "I don't immediately see the cause.\n\nThe config merge logic is correct, the broader (global/vhost/<Directory />) scopes are added before sub-scopes (nested directories, Files etc).\n\nIt almost sounds like you used setifempty;\n\n  \"The request header is set, but only if there is no previous header with this name. Available in 2.4.7 and later.\"\n\nbecause the first Header set in the list will cause later setifempty assignments to fail even if they are in a more precise scope.  We process the list sequentially.\n\nThe problem would also occur if you used 'early', e.g.\n\nHeader set AAA XXXXXXXX early\n\n  \"Because early directives are processed before the request path's configuration is traversed, early headers can only be set in a main server or virtual host context. Early directives cannot depend on a request path, so they will fail in contexts such as <Directory> or <Location>.\"\n\nYou didn't do either of these things, but they may provide a clue about where the bug may be hiding.", "is_private": false}, {"count": 7, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 187406, "creation_time": "2016-01-06T01:23:36Z", "time": "2016-01-06T01:23:36Z", "creator": "gilperon@gmail.com", "text": "Indeed you are correct, I didnt use setifempty nor early. Unfortunatelly I am not an advanced htaccess user. I dont know how reporting a bug works, but should the person, who report the bug, propose solutions to fix it? Or should the community try to help solving the problem?\n\nThe only clue I have is that if I use <FilesMatch \"^.*$\"> then the logic works fine, I mean, the header gets overrided just fine.", "is_private": false}, {"count": 8, "tags": [], "bug_id": 58789, "attachment_id": null, "text": "Fast question, exactly which version of Apache 2.4?  There has been a lot of activity on mod_headers.\n\nYou may want to obtain the latest source from http://svn.apache.org/repos/asf/httpd/httpd/branches/2.4.x/modules/metadata/mod_headers.c and compile this using apxs.  Simply load the replacement module in place of the old module by stopping and then starting your server instance again, and see if your observed behavior persists.\n\nhttp://svn.apache.org/viewvc/httpd/httpd/branches/2.4.x/modules/metadata/mod_headers.c gives you an idea of what all has changed in that module over the past few years.", "id": 187415, "time": "2016-01-06T13:48:24Z", "creator": "wrowe@apache.org", "creation_time": "2016-01-06T13:48:24Z", "is_private": false}, {"count": 9, "tags": [], "creator": "gilperon@gmail.com", "attachment_id": null, "id": 187421, "time": "2016-01-06T15:29:09Z", "bug_id": 58789, "creation_time": "2016-01-06T15:29:09Z", "is_private": false, "text": "Hi!\n\nServer version: Apache/2.4.6 (CentOS)\n\nI am not used to compile modules, but I am sure I am using the latest version of mod_headers provided by Apache and \"yum update\".\n\nWhat do you advise me? To report the bug in another bug tracker of the mod_headers specifically?"}, {"count": 10, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "id": 187422, "time": "2016-01-06T15:45:47Z", "bug_id": 58789, "creation_time": "2016-01-06T15:45:47Z", "is_private": false, "text": "Does it happen with static files? Do you use Action to run your PHP code? The best way to get help is to be able to demonstrate the simplest self-contained testcase and show it along with the input and output verbatim."}, {"count": 11, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 187423, "time": "2016-01-06T15:55:46Z", "creator": "gilperon@gmail.com", "creation_time": "2016-01-06T15:55:46Z", "is_private": false, "text": "@Eric Covener this problem happens with any file, static, dynamic... I can easily reproduce it on my server with any file. I know you requested me to demonstrate this bug but since it's a server bug I have no idea how to demosntrate it... should I give you my server credentials so you can see it? I am afraid I cannot provide that, for security reasons.\n\nBut as William A. Rowe Jr. said, this bug is easily reproduceable. Install a fresh Apache server and allow htaccess (AllowOverride) on subdiectories to be interpreted by Apache. After that create these files on you public_html directory:\n\n/aaa/.htaccess:\n  Header set AAA ZZZ\n  \n/aaa/bbb/.htaccess:\n  Header set AAA XXXXXXXX\n\n/aaa/bbb/ccc/.htaccess:\n  Header set AAA XXXXXXXX\n\nAfter that request any file on this public_html directory (put an index.php inside of it) using a GET request on your browser. The response will be\n\nAAA: ZZZ\n\nBut it should be:\n\nAAA: XXXXXXXX\n\nI sincerally have no idea how to make this clearer... if you have any other question I will be glad to provide you any information I can get!"}, {"count": 12, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 187428, "time": "2016-01-06T18:34:12Z", "creator": "covener@gmail.com", "creation_time": "2016-01-06T18:34:12Z", "is_private": false, "text": "\n> But as William A. Rowe Jr. said, this bug is easily reproduceable. Install a\n> fresh Apache server and allow htaccess (AllowOverride) on subdiectories to\n> be interpreted by Apache. After that create these files on you public_html\n> directory:\n\nI didn't get that sentiment from Bill's updates.  Any way, it works just fine for me:\n\n$ cat built/htdocs/.htaccess built/htdocs/1/.htaccess built/htdocs/1/2/.htaccess built/htdocs/1/2/3/.htaccess\nHEADER SET FOO ROOT\nHEADER SET FOO SUB1\nHEADER SET FOO SUB2\nHEADER SET FOO SUB3\n\n\n$ wget -S http://localhost/1/2/3/index.html -O- 2>&1 |grep FOO:\n  FOO: SUB3\n$ wget -S http://localhost/1/2/index.html -O- 2>&1 |grep FOO:\n  FOO: SUB2"}, {"count": 13, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 187429, "creation_time": "2016-01-06T18:46:57Z", "time": "2016-01-06T18:46:57Z", "creator": "wrowe@apache.org", "text": "Sorry, \"I am not used to compile modules, but I am sure I am using the latest version of mod_headers provided by Apache and \"yum update\".\"\n\nis anything but the latest we support. 2.4.6 was shipped in July 2013, that's ancient and we simply don't install old packages to work out what had been broken in the past, we invest our efforts in improving the current code (currently 2.4.17).\n\nr1503324 was that 2.4.6 tag, so if you look at all activity since that revision;\n\nhttp://svn.apache.org/viewvc/httpd/httpd/branches/2.4.x/modules/metadata/mod_headers.c\n\nyou will see there were 5 commits to mod_headers.c in these intervening years.\n\nhttps://httpd.apache.org/docs/2.4/programs/apxs.html tells you how to use apxs to compile the latest sources (link in my earlier comment) as a mod_headers.so, you likely need to install some httpd-devel or httpd-tools package to obtain it.\n\nWill look more closely if you can confirm the defect is still present in 2.4.17 mod_headers.c.", "is_private": false}, {"count": 14, "tags": [], "bug_id": 58789, "attachment_id": null, "text": "Thank you for helping. I will do what you say but I need to know how to do this. I executed \"yum updated on my server\" but my mod_headers didnt get \"2.4.17\". Why? Is this version stable? If it is stable, why yum is not installing it?", "id": 187516, "time": "2016-01-08T22:06:53Z", "creator": "gilperon@gmail.com", "creation_time": "2016-01-08T22:06:53Z", "is_private": false}, {"count": 15, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 187665, "creation_time": "2016-01-14T13:01:17Z", "time": "2016-01-14T13:01:17Z", "creator": "gilperon@gmail.com", "text": "I did what you said, I installed the latest apache and the bug still happens. SO WHAT SHOULD I DO???", "is_private": false}, {"count": 16, "tags": [], "bug_id": 58789, "attachment_id": null, "text": "Hi! \n\nMaybe this help:\n\nI can't reproduce this issue on my environment ( freshly installed from source apache2 )\n\n( https://github.com/melezhik/apache-swat is easy way to verify some existed apache2 issues against your environment )\n\n\nvagrant@Debian-jessie-amd64-netboot:~/my/apache-swat$ swat -t 58789/\n/home/vagrant/.swat/.cache/9653/prove/58789/aaa/bbb/data.txt/00.GET.t ......\nok 1 - GET 127.0.0.1/58789/aaa/bbb/data.txt succeeded\n# http headers saved to /home/vagrant/.swat/.cache/9653/prove/wSVzxXCHHO.hdr\n# body saved to /home/vagrant/.swat/.cache/9653/prove/wSVzxXCHHO\nok 2 - output match '200 OK'\nok 3 - output match '[aaa/bbb data]'\nok 4 - output match /^AAA: XXXXXXXX/\n1..4\nok\n/home/vagrant/.swat/.cache/9653/prove/58789/aaa/data.txt/00.GET.t ..........\nok 1 - GET 127.0.0.1/58789/aaa/data.txt succeeded\n# http headers saved to /home/vagrant/.swat/.cache/9653/prove/zx5J0141IJ.hdr\n# body saved to /home/vagrant/.swat/.cache/9653/prove/zx5J0141IJ\nok 2 - output match '200 OK'\nok 3 - output match '[aaa data]'\nok 4 - output match /^AAA: ZZZ/\n1..4\nok\n/home/vagrant/.swat/.cache/9653/prove/58789/aaa/bbb/ccc/data.txt/00.GET.t ..\nok 1 - GET 127.0.0.1/58789/aaa/bbb/ccc/data.txt succeeded\n# http headers saved to /home/vagrant/.swat/.cache/9653/prove/dhejgbs_3_.hdr\n# body saved to /home/vagrant/.swat/.cache/9653/prove/dhejgbs_3_\nok 2 - output match '200 OK'\nok 3 - output match '[aaa/bbb/ccc data]'\nok 4 - output match /^AAA: XXXXXXXX/\n1..4\nok\nAll tests successful.\nFiles=3, Tests=12,  0 wallclock secs ( 0.02 usr  0.01 sys +  0.15 cusr  0.00 csys =  0.18 CPU)\nResult: PASS\n\n\nApache compile info:\n\n\nvagrant@Debian-jessie-amd64-netboot:~/my/apache-swat$ sudo ~/apache/bin/apachectl -V\nServer version: Apache/2.4.18 (Unix)\nServer built:   Jan 30 2016 10:17:37\nServer's Module Magic Number: 20120211:52\nServer loaded:  APR 1.5.1, APR-UTIL 1.5.4\nCompiled using: APR 1.5.1, APR-UTIL 1.5.4\nArchitecture:   64-bit\nServer MPM:     event\n  threaded:     yes (fixed thread count)\n    forked:     yes (variable process count)\nServer compiled with....\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=256\n -D HTTPD_ROOT=\"/home/vagrant/apache/\"\n -D SUEXEC_BIN=\"/home/vagrant/apache//bin/suexec\"\n -D DEFAULT_PIDLOG=\"logs/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"", "id": 188098, "time": "2016-02-01T09:34:51Z", "creator": "melezhik@gmail.com", "creation_time": "2016-02-01T09:34:51Z", "is_private": false}, {"count": 17, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 188107, "time": "2016-02-01T12:00:25Z", "creator": "gilperon@gmail.com", "creation_time": "2016-02-01T12:00:25Z", "is_private": false, "text": "Really strange cause this bug is easily reproduceble in my Centos 6.5 and Centos 7.1 with fresh install. It happens in AWS and also on Linode using their Centos images... Anyone could please check this bug on envieroment like mines?"}, {"count": 18, "tags": [], "creator": "covener@gmail.com", "text": "Not reproducible with the information provided.", "id": 188108, "time": "2016-02-01T12:41:16Z", "bug_id": 58789, "creation_time": "2016-02-01T12:41:16Z", "is_private": false, "attachment_id": null}, {"count": 19, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 188109, "creation_time": "2016-02-01T14:26:14Z", "time": "2016-02-01T14:26:14Z", "creator": "melezhik@gmail.com", "text": "Hi gilperon@gmail.com ( Sorry could not find your name at this issue )\n\nYou could try to repeat the issue on _your_ environment with swat test suite. It's easy to install and setup - follow https://github.com/melezhik/apache-swat\n\nOnce you install and configure tests suite just say:\n\nswat -t 58789 \n\nAnd provide an output , thanks.\n\nAt least this test tries to verify the situation described at this issue ...", "is_private": false}, {"count": 20, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 188111, "creation_time": "2016-02-01T16:32:08Z", "time": "2016-02-01T16:32:08Z", "creator": "gilperon@gmail.com", "text": "Hey I discovered something that you didnt do on your test!!\n\nInside the file \"/aaa/.htaccess\" you cant just do this:\n\nHeader set AAA ZZZ\n\nYou have to do this:\n\n<FilesMatch \".*\">\n\n    Header set AAA ZZZ\n\n</FilesMatch>\n\nAnd in the other htaccess files you dont use FilesMatch you just use\n\nHeader set AAA XXXXXXXX\n\nPlease please try this, I am sure you will be able to reproduce the bug. I am really sure! Could you do this favor, please?", "is_private": false}, {"count": 21, "tags": [], "bug_id": 58789, "text": "Ok, you are a right , after changing to htdocs/58789/aaa/.htaccess\n\n\n<FilesMatch \".*\">\n\n    Header set AAA ZZZ\n\n</FilesMatch>\n\nBug is reproduced ( I have rewrite a checking logic  abit to emphasize the issue ) and look like this:\n\n\nvagrant@Debian-jessie-amd64-netboot:~/my/apache-swat$ swat -t 58789/\n/home/vagrant/.swat/.cache/13389/prove/58789/aaa/data.txt/00.GET.t ..........\nok 1 - GET 127.0.0.1/58789/aaa/data.txt succeeded\n# http headers saved to /home/vagrant/.swat/.cache/13389/prove/HSHCipQEVF.hdr\n# body saved to /home/vagrant/.swat/.cache/13389/prove/HSHCipQEVF\nok 2 - output match '200 OK'\nok 3 - output match '[aaa data]'\nok 4 - output match /^AAA: ZZZ/\n1..4\nok\n/home/vagrant/.swat/.cache/13389/prove/58789/aaa/bbb/ccc/data.txt/00.GET.t ..\nok 1 - GET 127.0.0.1/58789/aaa/bbb/ccc/data.txt succeeded\n# http headers saved to /home/vagrant/.swat/.cache/13389/prove/tpFu_FHhzp.hdr\n# body saved to /home/vagrant/.swat/.cache/13389/prove/tpFu_FHhzp\nok 2 - output match '200 OK'\nok 3 - output match '[aaa/bbb/ccc data]'\nok 4 - output match /^AAA: \\S+/\nnot ok 5 - 'AAA: ZZZ' match 'XXXXXXXX'\n\n#   Failed test ''AAA: ZZZ' match 'XXXXXXXX''\n#   at /usr/local/share/perl/5.20.2/swat.pm line 218.\n1..5\n# Looks like you failed 1 test of 5.\nDubious, test returned 1 (wstat 256, 0x100)\nFailed 1/5 subtests\n/home/vagrant/.swat/.cache/13389/prove/58789/aaa/bbb/data.txt/00.GET.t ......\nok 1 - GET 127.0.0.1/58789/aaa/bbb/data.txt succeeded\n# http headers saved to /home/vagrant/.swat/.cache/13389/prove/yQrvMI3ulJ.hdr\n# body saved to /home/vagrant/.swat/.cache/13389/prove/yQrvMI3ulJ\nok 2 - output match '200 OK'\nok 3 - output match '[aaa/bbb data]'\nok 4 - output match /^AAA: \\S+/\nnot ok 5 - 'AAA: ZZZ' match 'XXXXXXXX'\n\n#   Failed test ''AAA: ZZZ' match 'XXXXXXXX''\n#   at /usr/local/share/perl/5.20.2/swat.pm line 218.\n1..5\n# Looks like you failed 1 test of 5.\nDubious, test returned 1 (wstat 256, 0x100)\nFailed 1/5 subtests\n\nTest Summary Report\n-------------------\n/home/vagrant/.swat/.cache/13389/prove/58789/aaa/bbb/ccc/data.txt/00.GET.t (Wstat: 256 Tests: 5 Failed: 1)\n  Failed test:  5\n  Non-zero exit status: 1\n/home/vagrant/.swat/.cache/13389/prove/58789/aaa/bbb/data.txt/00.GET.t    (Wstat: 256 Tests: 5 Failed: 1)\n  Failed test:  5\n  Non-zero exit status: 1\nFiles=3, Tests=14,  0 wallclock secs ( 0.03 usr  0.00 sys +  0.15 cusr  0.01 csys =  0.19 CPU)\nResult: FAIL\n\n\n\nSo, both aaa/bbb and aaa/bbb/cc now returns unexpected(?) headers.\n\nNow I address this to developers, as I am only acting here as QA automation support guy ... \n\nAll recent changes for test suite are commuted - https://github.com/melezhik/apache-swat/commit/e8e2c810762d5a98d4735ba173f5c774273e6879", "id": 188112, "time": "2016-02-01T16:43:02Z", "creator": "melezhik@gmail.com", "creation_time": "2016-02-01T16:43:02Z", "is_private": false, "attachment_id": null}, {"count": 22, "tags": [], "bug_id": 58789, "text": "You are awesome man! Thank you so much for checking this bug! I was afraid you could not reproduce it for some specific reason that I am not aware, but I am really glad you reproduced it. Thank you so much! I hope now some developer comes with a clever solutino :)", "id": 188114, "attachment_id": null, "creator": "gilperon@gmail.com", "creation_time": "2016-02-01T16:49:13Z", "time": "2016-02-01T16:49:13Z", "is_private": false}, {"count": 23, "tags": [], "bug_id": 58789, "text": "This seems to be working as designed, but the docs could use some elaboration on a few points:\n\nhttps://httpd.apache.org/docs/2.4/sections.html\n\n1) htacess context is equivalent to Directory context.\n2) The implications related to nesting of things like <Files> in Directory and the false assumption that deeper htaccess = higher precedence.\n\n-/-\n\nThe manual clearly states that Files/FilesMatch has precedence. That precedence is not overridden because there is a more closely matched Directory section.\n\nIf you want the matching Directory to have precedence for overlapping directives, use <Files *> to make them all fit into the Files merging precedence\n\n-/-\n\nReclassifying to docs so someone (elukey?) can take a crack at explaining it.", "id": 188115, "time": "2016-02-01T17:19:39Z", "creator": "covener@gmail.com", "creation_time": "2016-02-01T17:19:39Z", "is_private": false, "attachment_id": null}, {"count": 24, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 188116, "time": "2016-02-01T17:40:45Z", "creator": "gilperon@gmail.com", "creation_time": "2016-02-01T17:40:45Z", "is_private": false, "text": "Nice to know that. I also had problems in the past with mod_rewrite cause even placing rules at the top of the file the filesmatch at the bottom was being \"hit\" first!\n\nIs there any docs where I can understand what types of codes inside htaccess are executed first cause in my experience the order that some lines of code appears in the hattcess file are not always executed as expected."}, {"count": 25, "tags": [], "creator": "covener@gmail.com", "text": "(In reply to gilperon from comment #24)\n> Nice to know that. I also had problems in the past with mod_rewrite cause\n> even placing rules at the top of the file the filesmatch at the bottom was\n> being \"hit\" first!\n> \n> Is there any docs where I can understand what types of codes inside htaccess\n> are executed first cause in my experience the order that some lines of code\n> appears in the hattcess file are not always executed as expected.\n\nThe document I linked to in my previous comment talks about how modules' _configuration_ is read and merged.  Execution doesn't happen line by line, it happens after all of the reading and merging is done.", "id": 188117, "time": "2016-02-01T17:41:54Z", "bug_id": 58789, "creation_time": "2016-02-01T17:41:54Z", "is_private": false, "attachment_id": null}, {"count": 26, "tags": [], "creator": "gilperon@gmail.com", "text": "at what line is that?", "id": 188118, "time": "2016-02-01T17:43:39Z", "bug_id": 58789, "creation_time": "2016-02-01T17:43:39Z", "is_private": false, "attachment_id": null}, {"count": 27, "tags": [], "bug_id": 58789, "text": "Ok, guys I hope now it is all getting cleared, I will revert the test suite, so it does not fail.", "id": 188119, "attachment_id": null, "creator": "melezhik@gmail.com", "creation_time": "2016-02-01T18:50:11Z", "time": "2016-02-01T18:50:11Z", "is_private": false}, {"count": 28, "tags": [], "creator": "toscano.luca@gmail.com", "attachment_id": null, "id": 188297, "time": "2016-02-08T22:57:21Z", "bug_id": 58789, "creation_time": "2016-02-08T22:57:21Z", "is_private": false, "text": "I have a question for gilperon@ (sorry didn't see your name anywhere!):\n\nhttps://httpd.apache.org/docs/2.4/sections.html might be improved with examples but I would also be interested in what documentation did you read before creating the bug. It would help us figure out what are the most common places in which the information is needed :)\n\nLuca"}, {"count": 29, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 188337, "time": "2016-02-10T18:27:58Z", "creator": "gilperon@gmail.com", "creation_time": "2016-02-10T18:27:58Z", "is_private": false, "text": "Hi Mr. Luca,\n\nI read only the Apache 2.2 documentation (but I am usinh 2.4, I didnt know 2.4 documentation was already available). I also tried to get help from stackoverflow community and they told me to report this as a bug, so I did!\n\nI think apache should make it a lot clearer what rules from htaccess are processed first and what are later. Maybe apache should say what order the htaccess directives are processed. Mod_rewirte I know are processed way after <filesmatch> even if I put all mod_rewrite rules at the top of htaccess the <filesmatch> rules will be processed first. To me this should be a bug or a misconception of how it works, but Apache should  correct this bug OR make it a lot clearer which order things are executed by Apache cause I manage webserver for about 6 years and never had heard of the order of the apache directives."}, {"count": 30, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 188338, "creation_time": "2016-02-10T18:36:29Z", "time": "2016-02-10T18:36:29Z", "creator": "covener@gmail.com", "text": "(In reply to gilperon from comment #29)\n> Hi Mr. Luca,\n> \n> I read only the Apache 2.2 documentation (but I am usinh 2.4, I didnt know\n> 2.4 documentation was already available). I also tried to get help from\n> stackoverflow community and they told me to report this as a bug, so I did!\n> \n> I think apache should make it a lot clearer what rules from htaccess are\n> processed first and what are later. Maybe apache should say what order the\n> htaccess directives are processed. Mod_rewirte I know are processed way\n> after <filesmatch> even if I put all mod_rewrite rules at the top of\n> htaccess the <filesmatch> rules will be processed first. To me this should\n> be a bug or a misconception of how it works, but Apache should  correct this\n> bug OR make it a lot clearer which order things are executed by Apache cause\n> I manage webserver for about 6 years and never had heard of the order of the\n> apache directives.\n\nThe misconception here, that the sections.html could address is the contrasting of how _configuration_ is merged (sections.html) separately from how modules operate on the net result of the merged configuration.\n\nWe also need an example that emphasizes that the current sections.html info results in a configuration of \"foo2\" for the module to eventually act upon (and to note htaccess/<directory> equivalence.\n\n# foo is merged with foo3, resulting in foo3\n# output of previous merge, foo3 is merged with foo2, resulting in foo2\n<Directory />\nDirectiveWhichIsOverriddenWhenReused foo\n<files *>\nDirectiveWhichIsOverriddenWhenReused foo2\n</files>\n</Directory>\n\n<Directory /var/www>\nDirectiveWhichIsOverriddenWhenReused foo3\n</Directory>", "is_private": false}, {"count": 31, "tags": [], "creator": "toscano.luca@gmail.com", "attachment_id": null, "id": 188352, "time": "2016-02-11T07:40:30Z", "bug_id": 58789, "creation_time": "2016-02-11T07:40:30Z", "is_private": false, "text": "gilperon@: Thank you for the insight about the documentation that you followed!\n\nCovener: Thanks for the example, I am going to try adding a new section/sub-section to the page explaining the concept. I am also convinced that we should build a list of \"essentials\" doc pages to read (if not already present) and link them right beside the httpd download link (and front page maybe) to help people in finding those docs..\n\nAnyhow, I'll start with the sections.html :)\n\nLuca"}, {"count": 32, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 188365, "creation_time": "2016-02-11T16:28:56Z", "time": "2016-02-11T16:28:56Z", "creator": "gilperon@gmail.com", "text": "Yes, your ideia would be great! Grouping only the most important topics at one single page with links to others would be amazing.\n\nThank you so much and I would like to be informed when you finish the sections page cause I would like to learn the correct order apache processes directives inside htaccess :) Thank you!", "is_private": false}, {"count": 33, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 188432, "time": "2016-02-15T13:24:10Z", "creator": "toscano.luca@gmail.com", "creation_time": "2016-02-15T13:24:10Z", "is_private": false, "text": "gilperon@: would http://httpd.apache.org/docs/current/ have helped if linked somewhere? It is a very good example of \"essentials\", but I am not sure where to link it to increase its visibility (download page? front page? etc..).\n\nCovener: I am adding new comments to http://httpd.apache.org/docs/current/sections.html"}, {"count": 34, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 188434, "time": "2016-02-15T13:27:00Z", "creator": "gilperon@gmail.com", "creation_time": "2016-02-15T13:27:00Z", "is_private": false, "text": "http://httpd.apache.org/docs/current/ is a great link I was not aware of its existence... maybe google should index it with higher priority so people come to know this page when they are looking for apache stuff.\n\nHowever I cant find which part of that link explains in which order apache processes rules inside htaccess. Should it be \"Configuration Sections\"? There is nothing related to this doubt I have in there..."}, {"count": 35, "tags": [], "bug_id": 58789, "attachment_id": null, "text": "Yes exactly, sections.html explains how directives like Directory (and .htaccess), File, Location, etc.. are merged together. I'll add an example about your use case, but at the same time I'd like to point more people to the right direction straight away..", "id": 188436, "time": "2016-02-15T13:33:53Z", "creator": "toscano.luca@gmail.com", "creation_time": "2016-02-15T13:33:53Z", "is_private": false}, {"count": 36, "tags": [], "bug_id": 58789, "attachment_id": null, "text": "I appreciate your efforts into this. Sections has a good documentation but I think more examples should be provided, mixing the most common apache modules (like mod_rewrite) with filesmatch, location... apache directives. You could also add a HEADER example (like the \"bug\" I thought I had found) cause it's easier to end user debug the rules using browser tools like F12 on Chrome.", "id": 188437, "time": "2016-02-15T13:47:52Z", "creator": "gilperon@gmail.com", "creation_time": "2016-02-15T13:47:52Z", "is_private": false}, {"count": 37, "tags": [], "bug_id": 58789, "attachment_id": null, "text": "First attempt to address the issue:\n\nhttp://httpd.apache.org/docs/trunk/sections.html#merging\n\nI added an example and more info about how sections are merged.", "id": 188466, "time": "2016-02-16T12:34:59Z", "creator": "toscano.luca@gmail.com", "creation_time": "2016-02-16T12:34:59Z", "is_private": false}, {"count": 38, "tags": [], "bug_id": 58789, "attachment_id": null, "id": 188470, "time": "2016-02-16T14:28:33Z", "creator": "gilperon@gmail.com", "creation_time": "2016-02-16T14:28:33Z", "is_private": false, "text": "Great, really great :) I will surelly use it on future problems I have with htaccess.\n\nAs you didnt explicitly said, I assume mod_rewrite and other Apaache modules are interpreted always after \"5. <If>\", correct?"}, {"count": 39, "tags": [], "creator": "toscano.luca@gmail.com", "attachment_id": null, "id": 188557, "time": "2016-02-18T08:04:16Z", "bug_id": 58789, "creation_time": "2016-02-18T08:04:16Z", "is_private": false, "text": "Hi gilperon@!\n\nAfter a chat with Eric I re-wrote the page adding a dedicated section to it:\n\nhttps://httpd.apache.org/docs/trunk/sections.html#merging\n\nStill under review so it might change a bit, please be patient I am learning with you  :)\n\nThe main gotcha is that configuration directives belonging to httpd's core (from Directory to If) work to create configurations for modules, that in turn use the information to do their work. \n\nSo mod_rewrite's directives are not \"evaluated\" afterwards, but simply mod_rewrite leverages the configuration returned to it by the httpd core for a certain request. In the case that we were discussing, setting Header to the value of the filesmatch block (due to its importance in the merging order).\n\nTo be precise: \n1) each module decides what to do when a configuration merge is requested (directory->filesmatch etc..), the default is to override.\n2) each module decides what to do with the configuration returned by httpd core. The configuration to set the Header AAA to ZZZ is available to mod_headers when it is invoked in the HTTP request processing workflow (like /aaa/bbb/ccc/index.php) and the module can do whatever it want with it. For example, it can discard the directive because deprecated! Usually of course the module does something meaningful with it, it was just to give you the idea :)\n\nThis is my understanding of the powerful configuration/running system of httpd! Let me know if it makes sense!\n\nLuca"}, {"count": 40, "tags": [], "bug_id": 58789, "text": "@Luca\n\nYou are awesome, now that section is great! I totally agree with what you said: those apache directives (Directory, Filesmatch...) are used to \"filter\" modules use cases. Sometimes we want some modules to act only when certain Directories conditions are applied. You are correct. But sometimes not. Check this example:\n\n\n\nRewriteCond %{HTTP_HOST} ^www\\. [NC]\nRewriteRule ^.*$ https://%{HTTP_HOST}?redirected1 [R=301,NE,L]\n\n<If \"%{REQUEST_URI} =~ m#^$#\">\n\n\tRewriteRule ^.*$ https://%{HTTP_HOST}?redirected2 [R=301,NE,L]\n\n</If>\n\n\nIn the case above, if the user requests \"www.xxx.com\" I would like it first to be redirected to \"https://%{HTTP_HOST}?redirected1\" and after that to \"https://%{HTTP_HOST}?redirected2\".\n\nBut the \"bug\" that I reported in this thread makes it differente: Apache will actually first process \"https://%{HTTP_HOST}?redirected2\" and after that \"https://%{HTTP_HOST}?redirected1\".\n\nTo overcome this \"bug\" I have to use a \"hack\" (I know this word is not great here, but that's how I name something that I have to do in order to correct some unexpected or bad programmed feature in a language):\n\n\n<If \"%{REQUEST_URI} =~ m#^.*$#\">\n\nRewriteCond %{HTTP_HOST} ^www\\. [NC]\nRewriteRule ^.*$ https://%{HTTP_HOST}?redirected1 [R=301,NE,L]\n\n</If>\n\n<If \"%{REQUEST_URI} =~ m#^$#\">\n\n\tRewriteRule ^.*$ https://%{HTTP_HOST}?redirected2 [R=301,NE,L]\n\n</If>\n\n\nYou see, I just had to create '<If \"%{REQUEST_URI} =~ m#^.*$#\">' to try to overcome this problem. I know, I really know, I could program this code in a much better and faster way, I know it. It's only an example of how apache's confusing processing rules order is not intuitive and may cause really unexpected results. This \"bug\" took me at least 8 months to try to get it understood/solved. I lived with this \"Header\" \"bug\" for a long time but since it was not too critical I didnt care, but latelly I started using a CDN and I really had to know how to fix this problem.\n\n\n\nBy the way, the section \"Relationship between modules and configuration sections\" is a m a z i n g! It will surelly clarify lots of misconception about apache rules order :)", "id": 188565, "attachment_id": null, "creator": "gilperon@gmail.com", "creation_time": "2016-02-18T12:30:03Z", "time": "2016-02-18T12:30:03Z", "is_private": false}, {"count": 41, "tags": [], "bug_id": 58789, "attachment_id": null, "text": "Glad that you liked it! Credits to Eric Covener for the patience in explaining the concept.\n\nI backported it to:\n\nhttp://httpd.apache.org/docs/2.2/sections.html#merging\nhttp://httpd.apache.org/docs/2.4/sections.html#merging\n\nI believe that his bug can be closed, but please re-open it if anything is missing!\n\nLuca", "id": 188605, "time": "2016-02-19T13:29:15Z", "creator": "toscano.luca@gmail.com", "creation_time": "2016-02-19T13:29:15Z", "is_private": false}]