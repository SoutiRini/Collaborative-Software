[{"count": 0, "tags": [], "bug_id": 47351, "text": "Thanks ahead of time for anything anyone can do to help me!\n\nI am running Apache 2.2 in front of JBoss 4.2.3 that uses Tomcat as its web server. I am using Apache to connect my virtual hosts to JBoss through mod_jk.\n\nI can access most of my pages fine, I type in foo2.com (my test domain) and I receive my pages lightning fast, no problem.\n\nHowever, some pages that have longer requests, such as those that initialize lots of libraries or make calls to another server (in this case, either setting up or verifying a database connection) are intermittently giving me this error:\n\nBad Gateway\n\nThe proxy server received an invalid response from an upstream server.\nApache/2.2.3 (CentOS) Server at www.foo2.com Port 80\n\n\nSo, like I said, almost all requests go through perfectly fine, so I know the mod_jk is working. Here is my mod_jk.log file:\n\nThe first block is my failed request, the second block are successful requests on the same domain:\n\n\n[Wed Jun 10 16:23:02 2009][17806:4090746208] [info] init_jk::mod_jk.c (3183): mod_jk/1.2.28 initialized\n[Wed Jun 10 16:23:02 2009][17808:4090746208] [info] init_jk::mod_jk.c (3183): mod_jk/1.2.28 initialized\n[Wed Jun 10 16:23:19 2009][17810:4090746208] [info] ajp_connection_tcp_get_message::jk_ajp_common.c (1150): (node1) can't receive the response header message from tomcat, network problems or tomcat (127.0.0.1:8009) is down (errno=11)\n[Wed Jun 10 16:23:19 2009][17810:4090746208] [error] ajp_get_reply::jk_ajp_common.c (1962): (node1) Tomcat is down or refused connection. No response has been sent to the client (yet)\n[Wed Jun 10 16:23:19 2009][17810:4090746208] [error] ajp_service::jk_ajp_common.c (2440): (node1) sending request to tomcat failed (unrecoverable),  (attempt=1)\n[Wed Jun 10 16:23:19 2009]node1 www.foo2.com 12.051237\n[Wed Jun 10 16:23:19 2009][17810:4090746208] [info] jk_handler::mod_jk.c (2615): Service error=0 for worker=node1\n\n\n[Wed Jun 10 16:23:39 2009]node1 www.foo2.com 0.027028\n[Wed Jun 10 16:23:39 2009]node1 www.foo2.com 0.035305\n[Wed Jun 10 16:23:40 2009]node1 www.foo2.com 0.024485\n\n\n\n\nThe successful attempts are from trying to access any other page that doesn't take longer. This particular page that gives me the error talks to another server to get database information.\n\n\nSo, I'm not sure what is going on here. I have read online qabout things like keepalive and have put:\n\nworker.node1.socket_keepalive=1\n\nin my workers.properties file, but to no avail. I have also put SetEnv proxy-nokeepalive 1 in my virtual host, also to no avail. Also, I am using AJAX, so I don't want any keepalive configuration to cause problems with AJAX. I'm not sure how all of this works.\n\nSo, I'm wondering how to resolve this issue. One note, when I try to request a page that gives me the gateway upstream error, the code on the page will execute (most of the time) but I still receive the error in my browser. (If I write a file to disk or update a database from within the page, it does write the file and update the database)\n\nI am no expert in this area, so please go easy with the terminology and assumptions that I know how most of this works... I don't :)\n\nThe connection is going to JBoss, and I have the following in my server.xml:\n\n<Engine name=\"jboss.web\" defaultHost=\"localhost\" jvmRoute=\"node1\"\n\n\n\nMy config files are below:\n\n\nFrom my httpd-vhosts.conf:\n\n<VirtualHost *:80>\n    ServerAdmin webmaster@dummy-host.example.com\n    ServerName foo2.com\n    ServerAlias www.foo2.com\n    ErrorLog \"logs/dummy-host.example.com-error_log\"\n    CustomLog \"logs/dummy-host.example.com-access_log\" common\n    DirectoryIndex index.cfm index.htm\n    JkMount /* node1\n</VirtualHost>\n\n\n\nmod-jk.conf:\n\n# Load mod_jk module\n# Specify the filename of the mod_jk lib\nLoadModule jk_module modules/mod_jk.so\n\n# Where to find workers.properties\nJkWorkersFile conf/workers.properties\n\n# Where to put jk logs\nJkLogFile logs/mod_jk.log\n\n# Set the jk log level [debug/error/info]\nJkLogLevel info\n\n# Select the log format\nJkLogStampFormat \"[%a %b %d %H:%M:%S %Y]\"\n\n# JkOptions indicates to send SSK KEY SIZE\n# Notes: \n# 1) Changed from +ForwardURICompat. \n# 2) For mod_rewrite compatibility, use +ForwardURIProxy (default since 1.2.24)\n# See http://tomcat.apache.org/security-jk.html  \nJkOptions +ForwardKeySize +ForwardURICompatUnparsed -ForwardDirectories\n\n# JkRequestLogFormat\nJkRequestLogFormat \"%w %V %T\"\n\n# Mount your applications\nJkMount /__application__/* loadbalancer\n# Let Apache serve the images\nJkUnMount /__application__/images/* loadbalancer\n\n# You can use external file for mount points.\n# It will be checked for updates each 60 seconds.\n# The format of the file is: /url=worker\n# /examples/*=loadbalancer\nJkMountFile conf/uriworkermap.properties\n\n# Add shared memory.\n# This directive is present with 1.2.10 and\n# later versions of mod_jk, and is needed for\n# for load balancing to work properly\n# Note: Replaced JkShmFile logs/jk.shm due to SELinux issues. Refer to \n# https://bugzilla.redhat.com/bugzilla/show_bug.cgi?id=225452\nJkShmFile run/jk.shm\n\n# Add jkstatus for managing runtime data\n<Location /jkstatus>\nJkMount status\nOrder deny,allow\nDeny from all\nAllow from 127.0.0.1\n</Location>\n\n\n\n\nworkers.properties:\n\n# Define list of workers that will be used\n# for mapping requests\n# The configuration directives are valid\n# for the mod_jk version 1.2.18 and later\n#\nworker.list=loadbalancer,status,node1\n\n\n# Define Node1\n# modify the host as your host IP or DNS name.\nworker.node1.port=8009\nworker.node1.host=localhost\nworker.node1.type=ajp13\nworker.node1.lbfactor=1\nworker.node1.socket_timeout=10\nworker.node1.prepost_timeout=10000 #Not required if using ping_mode=A\nworker.node1.connect_timeout=10000 #Not required if using ping_mode=A\nworker.node1.ping_mode=A #As of mod_jk 1.2.27\n# worker.node1.connection_pool_size=10 (1)\n\n# Load-balancing behaviour\nworker.loadbalancer.type=lb\nworker.loadbalancer.balance_workers=node1\n\n# Status worker for managing load balancer\nworker.status.type=status", "id": 127853, "attachment_id": null, "creator": "apache@changethings.org", "creation_time": "2009-06-10T17:17:50Z", "time": "2009-06-10T17:17:50Z", "is_private": false}, {"count": 1, "text": "Looks like your socket_timeout is too low and mod_jk assumes the request has failed before it has had a chance to finish processing. Tomcat/JBoss will continue to process the request to completion.\n\nAsk on the tomcat users list if you need further assistance.", "creator": "markt@apache.org", "attachment_id": null, "id": 127873, "time": "2009-06-11T05:47:42Z", "bug_id": 47351, "creation_time": "2009-06-11T05:47:42Z", "tags": [], "is_private": false}]