[{"count": 0, "tags": [], "creator": "v.thoule@alkaes.fr", "attachment_id": 32538, "text": "Created attachment 32538\nExcel Template with a predefined VBA Function\n\nHi All,\n\nIn my current project, I have to generate an extraction to Excel from an Application.\n\nThe extraction contains Parent Object exported in a 1st Sheet, and Child Objects into some other  Sheets, depending on their type.\n\nIn order to provide to end users an easy way to navigate from Parent to Child Object, I start to implement a HYPERLINK Function.\nIt gives something like :\n=HYPERLINK(\"[MyWorkbook.xls]'Sheet2'!C\"&MATCH(C4,'Sheet2'!C:C,0),\"See Child Details\")\n\nIn order to make it available even if the file is renamed, I had to replace \"MyWorkbook.xls\" by a dynamic filename, deduced from current opened Workbook.\n\nA found a first solution based on =Cell(\"filename\"), but it appears complex to implement since only the FileName is required and not the FullFileName returned by =Cell(\"filename\").\n\nSince I know that I will have to use a Template Workbook for future features, I have decided to create a User-Defined Function in VBA. The function looks like :\n\nPublic Function getWorkbookName() As String\n    getWorkbookName = ActiveWorkbook.Name\nEnd Function\n\nAnd the formula to define for the Cell is like :\n\n=HYPERLINK(\"[\"&getWorkbookName()&\"]'Sheet2'!C\"&MATCH(C4,'Sheet2'!C:C,0),\"See Child Details\")\n\nOn Excel side, It works.\n\nTo generate it from POI HSSF, I have added the getWorkbookName function ...\n\nclass getWorkookName implements FreeRefFunction {\n\t@Override\n\tpublic ValueEval evaluate(ValueEval[] args, OperationEvaluationContext ec) {\n\t\treturn null;\n\t}\n}\n\nand added it in Workbook :\n\nString[] functionNames = { \"getWorkbookName\"};\nFreeRefFunction[] functionImpls = { new getWorkookName() };\nUDFFinder udfs = new DefaultUDFFinder(functionNames, functionImpls);\nUDFFinder udfToolpack = new AggregatingUDFFinder(udfs);\nworkbook.addToolPack(udfToolpack);\n\nThe generated file seems to be generated, but the formula is not assumed as a formula ...\nI have to validated (Edit + Enter) each concerned cells.\n\nTo understand what was wrong without all data to manage, I have just try to use a simple VBA function \n\nPublic Function getTestValue() As Variant\n    getTestValue = 100\nEnd Function\n\nIn Sheet1 of a new Excel file, I have used this new function (see attachment).\n\nAnd when I tried to use this template file with a VBA function used in a cell of Sheet 1, I experienced an Exception on the creation of new Sheet in the Workbook.\n\njava.lang.RuntimeException: Could not find 'internal references' EXTERNALBOOK\n\tat org.apache.poi.hssf.model.LinkTable.checkExternSheet(LinkTable.java:516)\n\tat org.apache.poi.hssf.model.LinkTable.checkExternSheet(LinkTable.java:504)\n\tat org.apache.poi.hssf.model.InternalWorkbook.checkSheets(InternalWorkbook.java:741)\n\tat org.apache.poi.hssf.model.InternalWorkbook.setSheetName(InternalWorkbook.java:579)\n\tat org.apache.poi.hssf.usermodel.HSSFWorkbook.createSheet(HSSFWorkbook.java:732)\n\tat ...\n\nIt appears that the exception occurs only if the function is used.\n\nDo we have a limitation that blocks the usage of VBA Function in Template Workbook ?\nOr is it required to defined such VBA Function differently ? \n\nThe file is created from Excel 2010 (French settings) and savec in Excel 97 format.\n\n\nThanks by advance\nVincent", "id": 181422, "time": "2015-03-01T20:50:02Z", "bug_id": 57651, "creation_time": "2015-03-01T20:50:02Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 57651, "is_private": false, "id": 181429, "creation_time": "2015-03-02T04:56:19Z", "time": "2015-03-02T04:56:19Z", "creator": "apache@gagravarr.org", "text": "What happens if you change your FreeRefFunction to return something sensible looking? The null might be confusing things\n\nAre you opening the HSSFWorkbook with preserve nodes set to true?\n\nDid you try with POI 3.12 beta 1?", "attachment_id": null}, {"count": 2, "attachment_id": null, "bug_id": 57651, "is_private": false, "id": 189964, "time": "2016-04-05T12:22:00Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2016-04-05T12:22:00Z", "tags": [], "text": "No answer on the questions for a long time, thus i am closing this until we get the required information. Feel free to reopen if you can provide more information."}, {"count": 3, "tags": [], "creator": "onealj@apache.org", "attachment_id": null, "is_private": false, "id": 189973, "time": "2016-04-05T16:11:38Z", "bug_id": 57651, "creation_time": "2016-04-05T16:11:38Z", "text": "Test your problem with POI 3.14, which contains a fix for big 58452, which might also fix your problem."}, {"count": 4, "tags": [], "bug_id": 57651, "is_private": false, "id": 189977, "creation_time": "2016-04-05T16:27:07Z", "time": "2016-04-05T16:27:07Z", "creator": "v.thoule@alkaes.fr", "text": "Thanks for your return.\nThe initial need has been aborted due to the initial bug.\nI will have an improvement to develop in few weeks ... I will try to re-test it.\n\nV.", "attachment_id": null}]