[{"count": 0, "tags": [], "creator": "bernie@step.polymtl.ca", "attachment_id": null, "is_private": false, "id": 166035, "time": "2013-03-20T16:09:31Z", "bug_id": 54732, "creation_time": "2013-03-20T16:09:31Z", "text": "ML ref: http://mail-archives.apache.org/mod_mbox/tomcat-users/201303.mbox/browser\n\nWhen using Tomcat's jdbc-pool with the StatementCache interceptor (the default for TomEE 1.5.1), the actual java.sql.Statement.close() method is not called on the Statements. This causes severe memory leaks, at least with the MySQL driver.\n\nI see what could be a bug in StatementCache#closeInvoked() which is called by the above method. Here is the code with my own comments added:\n@Override\npublic void closeInvoked() {\n    boolean shouldClose = true;\n    if (cacheSize.get() < maxCacheSize) {\n        // omitted for brievety\n    }\n    closed = true;\n    // [1] I think \"delegate = null\" is done too soon\n    delegate = null;\n    if (shouldClose) {\n        // check its body below\n        super.closeInvoked();\n    }\n}\n\n// This is super.closeInvoked()\npublic void closeInvoked() {\n    if (getDelegate()!=null) {\n        // never true when coming from\n        // StatementCache#closeInvoked()\n        // because of [1]\n        try {\n            getDelegate().close();\n        }catch (SQLException ignore) {\n        }\n    }\n    closed = true;\n    delegate = null;\n}\n\nTo test this, step into org.apache.tomcat.jdbc.test.TestStatementCache tests testPreparedStatementCache and testPreparedStatementCache2. The calls to Statement.close() are intercepted but never forwarded to the actual Statement. Perhaps some kind of mock could be used to make sure Statement.close() is called on each created Statement."}, {"count": 1, "tags": [], "bug_id": 54732, "attachment_id": null, "text": "Confirmed.\nThe leak happens when the cache is full, so the statement that is being closed cannot be returned to the cache but has to be closed right away.\n\nFixed in trunk with r1459769", "id": 166093, "time": "2013-03-22T13:45:54Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-03-22T13:45:54Z", "is_private": false}, {"count": 2, "text": "*** Bug 54337 has been marked as a duplicate of this bug. ***", "bug_id": 54732, "attachment_id": null, "id": 166100, "time": "2013-03-22T17:34:11Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-03-22T17:34:11Z", "tags": [], "is_private": false}, {"text": "Fixed in Tomcat 7 by r1460006 and will be in 7.0.40.", "tags": [], "bug_id": 54732, "attachment_id": null, "count": 3, "id": 166107, "time": "2013-03-22T21:35:28Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-03-22T21:35:28Z", "is_private": false}]