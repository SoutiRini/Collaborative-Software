[{"count": 0, "attachment_id": null, "creator": "vassilis.touloumtzoglou@gmail.com", "text": "the mode=\"update\" the manifest task is supposed to merge sections of manifest properties including \nthe main section.\nThere seems to be some code to handle the Class-Path attribute separately but guess what, it doesn't \nwork...\n\nThere's discussion that multiple Class-Path attributes should be supported but the utility of this feature \nis questionable. Ideally an attribute should be added to disambiguate the bahaviour of the Manifest \ntask (something like multipleClasspathProps=\"true|false\" should do).\n\nIn the meantime here's my fix for this:\n--- main/org/apache/tools/ant/taskdefs/Manifest.java    2005-06-02 15:19:58.000000000 +0200\n+++ /Volumes/vassilistouloumtzoglou/dev/workspace/apache-ant/src/main/org/apache/tools/ant/\ntaskdefs/Manifest.java       2006-05-15 21:08:35.000000000 +0200\n@@ -430,11 +430,19 @@\n                     if (classpathAttribute == null) {\n                         classpathAttribute = new Attribute();\n                         classpathAttribute.setName(ATTRIBUTE_CLASSPATH);\n+                        if (getAttribute(ATTRIBUTE_CLASSPATH) != null) {\n+                               for (Enumeration attribEnum = getAttribute(ATTRIBUTE_CLASSPATH).getValues(); \nattribEnum.hasMoreElements();) {\n+                                       String value = (String)attribEnum.nextElement();\n+                                       String previousValue = (classpathAttribute.getValue() != null ? \nclasspathAttribute.getValue() : \"\");\n+                                       classpathAttribute.setValue(previousValue + \" \" + value);\n+                               }\n+                        }\n                     }\n                     Enumeration cpe = attribute.getValues();\n                     while (cpe.hasMoreElements()) {\n                         String value = (String) cpe.nextElement();\n-                        classpathAttribute.addValue(value);\n+                        String previousValue = (classpathAttribute.getValue() != null ? \nclasspathAttribute.getValue() : \"\");\n+                        classpathAttribute.setValue(previousValue + \" \" + value);\n                     }\n                 } else {\n                     // the merge file always wins\n@@ -629,7 +637,12 @@\n                 return;\n             }\n             String attributeKey = attribute.getKey();\n-            attributes.put(attributeKey, attribute);\n+            if (attributes.contains(attributeKey)) {\n+               Attribute principalAttribute = (Attribute)attributes.get(attributeKey);\n+               principalAttribute.addValue(attribute.getValue());\n+            } else {\n+               attributes.put(attributeKey, attribute);\n+            }\n             if (!attributeIndex.contains(attributeKey)) {\n                 attributeIndex.addElement(attributeKey);\n             }", "id": 89457, "time": "2006-05-24T20:40:20Z", "bug_id": 39655, "creation_time": "2006-05-24T20:40:20Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 39655, "text": "Created attachment 18349\nmain/org/apache/tools/ant/taskdefs/Manifest.java\n\nmain/org.apache.tools.ant.taskdefs.Manifest.java patch\nIt's a core task so it's in ant.jar", "id": 89458, "time": "2006-05-24T20:43:39Z", "creator": "vassilis.touloumtzoglou@gmail.com", "creation_time": "2006-05-24T20:43:39Z", "is_private": false, "attachment_id": 18349}, {"count": 2, "tags": [], "bug_id": 39655, "text": "The code for Class-Path isn't there to merge Class-Path attributes from different manifests but to merge different Class-Path attributes inside the same section of the same manifest - so it is not really related to merging at all.\n\nSee the warning generated in line 622 of svn revision 802486\n\n                        warnings.addElement(\"Multiple Class-Path attributes \"\n                            + \"are supported but violate the Jar \"\n                            + \"specification and may not be correctly \"\n                            + \"processed in all environments\");\n\nMerging of manifests as done by the tasks update-mode means add new attributes and overwrite existing attributes, including Class-Path and this is what the current code does.\n\nSee the comment in line 487 of said revision\n\n                // the merge file *always* wins, even for Class-Path\n\nI don't recall why Ant supports multiple Class-Path attributes but this really is the only purpose of the existing code.\n\nAs you said, it may be useful to have a separate option to merge Class-Path attributes and your patch contains most of what would be needed to implement it.  Am looking into it.", "id": 129809, "time": "2009-08-20T02:20:54Z", "creator": "bodewig@apache.org", "creation_time": "2009-08-20T02:20:54Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 39655, "text": "svn revision 806174 introduces two separate attributes for the merging and \"flattening\" of Class-Path attributes.", "id": 129816, "time": "2009-08-20T06:52:21Z", "creator": "bodewig@apache.org", "creation_time": "2009-08-20T06:52:21Z", "is_private": false, "attachment_id": null}]