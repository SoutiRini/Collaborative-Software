[{"count": 0, "tags": [], "bug_id": 47797, "text": "Hello!\nI have a critical issue, most likely associated with Tomcat 5.5.X.\n------------------------------\nMy environment:\nOS: RHEL 5 x86 or x86-64;\nJVM: sun-jdk-1.6.0.16 or jrockit-R27.5.0-jdk1.6.0_03;\nAS: Jboss AS 4.2.2.GA (with Tomcat 5.5.X (JBossWeb-2.0.1.GA ) inside)\n------------------------------\nI implemented web-service using apache xml-rpc 3.1.2.\t\nThen I call it from the http client. (apache httpclient 4.0).\nThis my request:\n------------------------------------------\nPOST /cas-services-verimatrix-pull/pull HTTP/1.1\n\nHost: 10.20.2.150:8080\n\nAccept: */*\n\nContent-Type: text/xml\n\nContent-Length: 391\n\n\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n\n<methodCall>\n\n<methodName>EISTMPull.getEntitlement</methodName>\n\n<params>\n\n<param><value><string>00020215B9FE</string></value></param>\n\n<param><value><base64>\n\n\n\n</base64></value></param>\n\n<param><value><array><data>\n\n<value><string>DTV</string></value>\n\n<value><string>PPV</string></value>\n\n</data></array></value></param>\n\n</params>\n\n</methodCall>\n-----------------------------------------------\n\nThis request is almost always handled properly.But sometimes the body of the HTTP request is lost and the server sends a reply, as if the request body is empty:\n-----------------------------------------------\nHTTP/1.1 200 OK\n\nServer: Apache-Coyote/1.1\n\nX-Powered-By: Servlet 2.4; JBoss-4.2.2.GA (build: SVNTag=JBoss_4_2_2_GA date=200710221139)/Tomcat-5.5\n\nContent-Type: text/xml\n\nContent-Length: 312\n\nDate: Fri, 07 Aug 2009 15:16:19 GMT\n\n\n\n<?xml version=\"1.0\"?><methodResponse><fault><value><struct><member><name>faultString</name><value>java.lang.NoSuchMethodException:&#32;ru.cti.oss.cas.verimatrix.pull.Pull.getEntitlement()</value></member><member><name>faultCode</name><value><int>0</int></value></member></struct></value></fault></methodResponse>\n-----------------------------------------------\n\nFirst used xml-rpc version 2, then I updated it to 3.1.2. Accordingly, the error must be at the level of tomcat.\n\nI fulfilled a lot of tests. This error does not depend on the load application server. Fortuitous. But because of this, our clients can not work normally. Therefore, I think this problem critical.\n\nPlease, help with what could be wrong?\n\t\nThanks in advance.", "id": 130196, "time": "2009-09-08T00:25:08Z", "creator": "johnbat26@gmail.com", "creation_time": "2009-09-08T00:25:08Z", "is_private": false, "attachment_id": null}, {"count": 1, "attachment_id": 24223, "creator": "johnbat26@gmail.com", "is_private": false, "id": 130197, "time": "2009-09-08T00:26:17Z", "bug_id": 47797, "creation_time": "2009-09-08T00:26:17Z", "tags": [], "text": "Created attachment 24223\ntcpdump with lost body of post request"}, {"count": 2, "tags": [], "creator": "johnbat26@gmail.com", "is_private": false, "id": 130198, "creation_time": "2009-09-08T00:42:31Z", "time": "2009-09-08T00:42:31Z", "bug_id": 47797, "text": "My Catalina setting:\n\n<Connector port=\"8080\" address=\"${jboss.bind.address}\"    \n         maxThreads=\"250\" maxHttpHeaderSize=\"8192\"\n         emptySessionPath=\"true\" protocol=\"HTTP/1.1\"\n         enableLookups=\"false\" redirectPort=\"8443\" acceptCount=\"100\"\n         connectionTimeout=\"20000\" disableUploadTimeout=\"true\"/>", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 47797, "attachment_id": null, "id": 130223, "time": "2009-09-08T13:41:08Z", "creator": "markt@apache.org", "creation_time": "2009-09-08T13:41:08Z", "is_private": false, "text": "The fact that the NoSuchMethodException is returned and references the method declared in the request body clearly demonstrates that the issue is with the framework or the application not with Tomcat."}, {"count": 4, "attachment_id": null, "creator": "johnbat26@gmail.com", "text": "(In reply to comment #3)\n> The fact that the NoSuchMethodException is returned and references the method\n> declared in the request body clearly demonstrates that the issue is with the\n> framework or the application not with Tomcat.\n\nI assure you that the error at Tomcat.\nBecause after the expansion logging all talking about it. And at the servlet level is already coming InputStream, whose size =- 1!\n\nNoSuchMethodException emerged, when from catalina level receive empty body of POST Request. And parser begin to analyze empty xml !\n\nAfter update xmlrpc up to 3.1.2 I became  receive other error:\n-----------------------\n14:58:37,017 ERROR [XmlRpcErrorLogger] Failed to parse XML-RPC request: Premature end of file.                                              \norg.apache.xmlrpc.XmlRpcException: Failed to parse XML-RPC request: Premature end of file. \n-----------------------\n\t\nThis is not always the case. And from time to time, and says that comes a blank document! That is the request body is empty, even though all the headlines come to normal! Also, the server always send the same request. See attached dump. \n\nError occurred in CoyoteAdapter.service():\n in line:\n----------------\n  connector.getContainer().getPipeline().getFirst().invoke(request, response);\n----------------\nPlease, help me.", "id": 130354, "time": "2009-09-13T23:55:03Z", "bug_id": 47797, "creation_time": "2009-09-13T23:55:03Z", "tags": [], "is_private": false}, {"count": 5, "tags": [], "bug_id": 47797, "text": "There is nothing in this bug report or the attached dump that indicates a problem at the Tomcat level (or JBoss for that matter).\n\nThe attached dump shows 4 requests. Looking at the first request in detail:\n\nThe request body declares the method that the client wishes to call: EISTMPull.getEntitlement\n\nThe response (with an HTTP status of 200 OK) includes the NoSuchMethodException that references the name of the method declared in the body. Clearly, the body was read correctly since the method name has been read *from the body*.\n\nWhilst I understand you are having problems, there is nothing in this report that demonstrates a Tomcat issue. In the absence of a demonstrated Tomcat issue, this bug in INVALID.", "id": 130359, "time": "2009-09-14T01:19:10Z", "creator": "markt@apache.org", "creation_time": "2009-09-14T01:19:10Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 47797, "attachment_id": null, "id": 130409, "time": "2009-09-15T04:17:49Z", "creator": "johnbat26@gmail.com", "creation_time": "2009-09-15T04:17:49Z", "is_private": false, "text": "Periodically, the body disappears POST-request with the same query! \nI wrote a test client. It httpClient sends a test request, and on the server side, the servlet it takes. And trying to read.\nSometimes there is a situation that the titles are coming, but the body is absent. \nThat is, when reading req.getInputStream().read(...) we obtain -1. \nThis error appears periodically. Tested on JBoss-4.2.2.GA with Tomcat 5.5.X. \nPlease, help me!"}, {"count": 7, "attachment_id": 24267, "creator": "johnbat26@gmail.com", "text": "Created attachment 24267\nTestCase with only Servlet\n\ntestcase", "id": 130410, "time": "2009-09-15T04:19:07Z", "bug_id": 47797, "creation_time": "2009-09-15T04:19:07Z", "tags": [], "is_private": false}, {"count": 8, "tags": [], "bug_id": 47797, "is_private": false, "id": 130426, "creation_time": "2009-09-15T13:05:30Z", "time": "2009-09-15T13:05:30Z", "creator": "markt@apache.org", "text": "I ran your test case with 10000 iterations on both trunk and 5.5.x with no failures. Whatever the root cause is of the issue you are seeing, it isn't Tomcat.", "attachment_id": null}, {"count": 9, "tags": [], "creator": "johnbat26@gmail.com", "attachment_id": null, "is_private": false, "id": 130735, "time": "2009-09-28T22:31:54Z", "bug_id": 47797, "creation_time": "2009-09-28T22:31:54Z", "text": "Again rediscovered this bug.\nThe reason is as follows.\n1. This problem occurs not every time, but we have it in a production environment there is very often that annoys customers.\n\n2. This test should be run on version 5.5.21, or that what is included in JBoss. And we need to at least day it worked.\n\n3. The most important thing! I replaced the tomcat in JBoss 4.2.2.GA on Jetty 6.1.18 and the problem disappeared. I think this clearly indicates that the problem is inside Tomcat.\n\n4. The fact that we can not take the latest version of tomcat from the fact that JBoss is tightly integrated. : (\n\n5. I repeat that the titles always come and parsed fine. But it is the body of POST-request is lost. No matter what the parser chooses the remaining data from the stream. Always returns -1!\n\t\nThanks in advance for understanding."}, {"count": 10, "tags": [], "creator": "johnbat26@gmail.com", "is_private": false, "text": "Requests differ only in time of shipment and port of the sender. Headers are always the same!\nMaybe tells where to look? And what place might happen this error? And on what terms, titles, etc. it may depend.", "id": 130736, "time": "2009-09-28T22:38:34Z", "bug_id": 47797, "creation_time": "2009-09-28T22:38:34Z", "attachment_id": null}, {"count": 11, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "If this issue is with 5.5.21 and I can't reproduce it with 5.5.x then it has already been fixed.\n\nTomcat does not provide patches for older versions. Upgrading is your only option. You would be best following this up with the JBoss folks.", "id": 130740, "time": "2009-09-29T05:00:38Z", "bug_id": 47797, "creation_time": "2009-09-29T05:00:38Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 47797, "attachment_id": null, "id": 130790, "time": "2009-10-01T22:20:08Z", "creator": "johnbat26@gmail.com", "creation_time": "2009-10-01T22:20:08Z", "is_private": false, "text": "I embed several count of code in Http11Processor and StandardEngineValve.\nIn Http11Processor,process() I added next after invoke    inputBuffer.parseRequestLine();  :\n------------\n if (request.unparsedURI().equals(\"/lost-post/generic\"))\n        {                    log.error(\"----------------------------------------------------------\");\n   StringBuffer stringBuffer = new StringBuffer();                                    \n                    for (int i = 0; i < inputBuffer.buf.length; i++) {\n                        stringBuffer.append((char) inputBuffer.buf[i]);\n                    }\n                                                                               \n                    log.error(stringBuffer);\n                    log.error(\"LENGTH: \"+ inputBuffer.buf.length);                                      \n                    log.error(\"++++++++++++++++++++++++++++++++++++++++++++++\");                    \n                }\n------------\n\nand in StandardEngineValve.invoke() I added next code:\n-----------------------\n    if (request.getWrapper().getName().equals(\"LostPostGenericServlet\"))\n        {\n            log.error(\"-----------------------------------------------------------------------------\");\n            StringBuffer stringBuffer = new StringBuffer();\n            InputStream input = request.getInputStream();\n            int i=request.getContentLength();\n            int c;\n            while (((c = input. read()) != -1) && (--i > 0)) {\n                stringBuffer.append((char) c);\n            }\n            input.close();\n                            \n            log.error(stringBuffer);\n            PrintWriter out = response.getWriter();\n            if (stringBuffer.length() > 0) {\n                StringBuffer xmlBuffer = new StringBuffer();\n                xmlBuffer.append(\"<?xml version='1.0' encoding='UTF-8'?>\");\n                xmlBuffer.append(\"<methodCall>\");\n                xmlBuffer.append(\"OK\");\n                xmlBuffer.append(\"</methodCall>\");\n                out.print(xmlBuffer);\n                System.out.println(\"OK\");\n            } else {\n                StringBuffer xmlBuffer2 = new StringBuffer();\n                xmlBuffer2.append(\"<?xml version='1.0' encoding='UTF-8'?>\");\n                xmlBuffer2.append(\"<methodCall>\");\n                xmlBuffer2.append(\"FAILED\");\n                xmlBuffer2.append(\"</methodCall>\");\n                out.print(xmlBuffer2);                        \n                System.out.println(\"FAILED\");\n            }\n            out.close();\n            log.error(\"++++++++++++++++++++++++++++++++++++++++++++++\");\n            return;\n        }\n\n-----------------------\nSo added code in Http11Processor print entire buffer, whereas code in StandardEngineValve print content of body from CoyoteInputStream.\nWhen I increase loading at tomcat (with help of Grinder) happen this error,\nand code in Http11Processor print normal request with body, whereas code in StandardEngineValve print empty string:\n**********************\n...\n2009-10-01 20:11:30,588 ERROR [Http11Processor] -----------------------------------------------------------------------------\n2009-10-01 20:11:30,589 ERROR [Http11Processor] POST /lost-post/generic HTTP/1.1\nAccept-Encoding: gzip,deflate\nContent-Type: text/xml;charset=UTF-8\nSOAPAction: \"\"\nUser-Agent: Jakarta Commons-HttpClient/3.1\nHost: 172.20.0.3:8080\nContent-Length: 389\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n\n<methodCall>\n\n<methodName>EISTMPull.getEntitlement</methodName>\n\n<params>\n\n<param><value><string>00020215B9FE</string></value></param>\n\n<param><value><base64>\n\n</base64></value></param>\n\n<param><value><array><data>\n\n<value><string>DTV</string></value>\n\n<value><string>PPV</string></value>\n\n</data></array></value></param>\n\n</params>\n\n</methodCall>e2:$Version=\"1\"\"\n\nntent-type:application/x-www-form-urlencoded; charset=UTF-88\ncontent-length:633\n\nj_username=00%3A02%3A02%3A14%3A47%3A2e&j_password=702007D314410    \n2009-10-01 20:11:30,589 ERROR [Http11Processor] LENGTH: 8192\n2009-10-01 20:11:30,589 ERROR [Http11Processor] ++++++++++++++++++++++++++++++++++++++++++++++\n2009-10-01 20:11:30,589 ERROR [StandardEngineValve] -----------------------------------------------------------------------------\n2009-10-01 20:11:30,589 ERROR [StandardEngineValve] \n2009-10-01 20:11:30,590 ERROR [StandardEngineValve] ++++++++++++++++++++++++++++++++++++++++++++++\n......\n*************************************                                                                                                                       \n                                                                                                    Therefore error happen inside tomcat ! During parsing body of request. Often this happen during increase loading at other applications deployed in tomcat.\n\nI conclude several tomcat classes, which uses in JBossWeb, because don't know, which version of tomcat 5.5 used in JbossWeb 2.0.3.GA\n\t\nMany thanks in advance for any some help."}, {"count": 13, "tags": [], "creator": "johnbat26@gmail.com", "is_private": false, "text": "Created attachment 24330\nMy Http11Processor class", "id": 130791, "time": "2009-10-01T22:21:35Z", "bug_id": 47797, "creation_time": "2009-10-01T22:21:35Z", "attachment_id": 24330}, {"count": 14, "tags": [], "bug_id": 47797, "is_private": false, "id": 130792, "creation_time": "2009-10-01T22:24:07Z", "time": "2009-10-01T22:24:07Z", "creator": "johnbat26@gmail.com", "text": "Created attachment 24331\nMy InputBuffer", "attachment_id": 24331}, {"text": "Created attachment 24332\nMy StandardEngineValve", "tags": [], "bug_id": 47797, "attachment_id": 24332, "count": 15, "id": 130793, "time": "2009-10-01T22:27:48Z", "creator": "johnbat26@gmail.com", "creation_time": "2009-10-01T22:27:48Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 47797, "text": "This is link to svn at JBossWeb with tomcat 5.5.X inside:\nhttp://anonsvn.jboss.org/repos/jbossweb/branches/2.0.x", "id": 130794, "time": "2009-10-01T22:29:09Z", "creator": "johnbat26@gmail.com", "creation_time": "2009-10-01T22:29:09Z", "is_private": false, "attachment_id": null}, {"count": 17, "tags": [], "creator": "johnbat26@gmail.com", "attachment_id": null, "id": 130802, "creation_time": "2009-10-02T00:56:13Z", "time": "2009-10-02T00:56:13Z", "bug_id": 47797, "text": "Amenably table: http://www.jboss.org/community/wiki/VersionOfTomcatInJBossAS\nand post at forum: http://www.jboss.org/index.html?module=bb&op=viewtopic&t=161900\n\nversin tomcat in Jboss-4.2.2.GA >= 6.0.13", "is_private": false}, {"count": 18, "tags": [], "creator": "johnbat26@gmail.com", "attachment_id": null, "is_private": false, "id": 130808, "time": "2009-10-02T03:24:47Z", "bug_id": 47797, "creation_time": "2009-10-02T03:24:47Z", "text": "I changed connector to Http11NioConnector:\n<Connector port=\"8080\" address=\"${jboss.bind.address}\"\n         protocol=\"org.apache.coyote.http11.Http11NioProtocol\"\n          redirectPort=\"8443\"/>\n\nthis problem persist :("}, {"count": 19, "tags": [], "bug_id": 47797, "is_private": false, "id": 130811, "creation_time": "2009-10-02T05:15:44Z", "time": "2009-10-02T05:15:44Z", "creator": "johnbat26@gmail.com", "text": "I patched InputBuffer from  bug  44673, problem persist :(", "attachment_id": null}, {"count": 20, "attachment_id": null, "creator": "johnbat26@gmail.com", "is_private": false, "id": 130817, "time": "2009-10-02T06:20:14Z", "bug_id": 47797, "creation_time": "2009-10-02T06:20:14Z", "tags": [], "text": "I added:\n  public int read(byte[] b, int off, int len) throws IOException {\n        if (closed)\n            throw new IOException(sm.getString(\"inputBuffer.streamClosed\"));\n        return bb.substract(b, off, len);\n    }\n\nnow tomcat throw exception, that streamClosed!!!\nsomeone close stream, and later try read from buffer !\nPlease, give me full patch at 44673 bug? ;)"}, {"count": 21, "tags": [], "creator": "kame@cinemasie.com", "is_private": false, "id": 130824, "creation_time": "2009-10-02T08:38:54Z", "time": "2009-10-02T08:38:54Z", "bug_id": 47797, "text": "Just a quick history note: I opened #44673 because I had a real problem of POST body lost. In my case: a servlet reads the request body directly from request.getInputStream(), and nothing happens. Tracing that call, the VM is stuck in a native call to read0 on the socket. Extremely hard to reproduce in my case. Dumping the network traffic, the cases we found so far were that the POST query was sent as two packets by IE, and the second packet was missing, but not missing as a dropped packet but more like the client didn't bother of sending it. More precisely, the client sent the first packet, which was ACKnowledged by the server... and when the IE browser was killed (in that case, the IE client is frozen) the RST,ACK packet sent by the client matches the TCP sequence number specified by the ACK packet sent by the server.\n\nSo, basically, Tomcat received a POST request with a Content-Length header specifying there were more bytes to read, the Servlet reads from the InputStream, then Tomcat fills its buffer and ends up in blocking IO... unblocked only when the client resets the connection.", "attachment_id": null}, {"count": 22, "tags": [], "bug_id": 47797, "text": "In the original report the response includes data that is only available in the request body. Therefore, in that original example, there is clearly no loss of request body.\n\nThe test case provided in comment #7 did not reproduce the issue with trunk, the latest code 6.0.x or the latest code from 5.5.x.\n\nTomcat as embedded in JBoss != Tomcat as provided by the ASF. Since this issue is occurring with Tomcat embedded in JBoss, the JBoss folks are your best source of help.\n\nAt the moment, this looks like either:\na) an issue with the JBoss integration\nb) an issue in 5.5.21 / 6.0.13  that has since been fixed\n\nIf it is a) then the Tomcat community can't help you.\nIf it is b) then the Tomcat community can only suggest that you upgrade the version of Tomcat you are using. If that isn't possible because you are using JBoss you'll need to seek help from the JBoss community.\n\nPlease do not re-open this bug unless you can provide a test case that reproduces this problem (however infrequently) on a clean installation of the latest stable Apache Tomcat 5.5.x or 6.0.x release. At the time of writing this comment those versions are 5.5.28 and 6.0.20.", "id": 132807, "time": "2009-12-14T10:53:12Z", "creator": "markt@apache.org", "creation_time": "2009-12-14T10:53:12Z", "is_private": false, "attachment_id": null}]