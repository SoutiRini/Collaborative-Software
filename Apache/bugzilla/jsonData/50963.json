[{"count": 0, "attachment_id": null, "bug_id": 50963, "text": "I've googled and can find very little about JMeter and AJP other than the existance of an AJP1.3 sampler; certainly nothing resembling what I am seeing.\n\nI have tomcat running behind IIS over AJP 1.3, with IIS/Windows handling user authentication using the Windows domain authentication.  Rather than load test our domain controller's authentication function, I thought I would test tomcat itself over the AJP connector.  I have the Tomcat AJP connector set to port 8009 with SSL redirect to port 443; any other connector settings are at default.  All of the pages of the web application under test have a security-constraint requiring SSL encryption.  JMeter testing using the tomcat HTTP and HTTPS ports (which will eventually be firewalled off) works fine.  I have used a standalone commandline AJPClient to confirm that I can communicate over our intranet with tomcat using AJP and get a 200 status code.\n\nI create a new JMeter test plan from scratch:\n  - one Thread Group, containing\n  - one AJPSampler \n      - https protocol\n      - port 8009\n      - 60000ms timeouts\n      - my desired hostname and web page \n      - follow redirects (or redirect automatically, same results either way)\n      - use keep-alive \n   - one Response Assertion that checks for a 200 status code\n   - a View Results Tree Listener\nI save and then run the test plan\nFrom the UI standpoint, nothing happens.  The sampler never shows up in the view.\n\nNext, I take an existing test plan and edit the element tag for the sampler to reflect an AjpSampler instead of an HTTPSampler:\n  - change\n    <HTTPSampler guiclass=\"HttpTestSampleGui\" testclass=\"HTTPSampler\" testname=\"Grp1 Calculator web form HTTP Request\" enabled=\"true\">...</HTTPSampler>\n    to\n    <AjpSampler guiclass=\"AjpSamplerGui\" testclass=\"AjpSampler\" testname=\"Grp1 Calculator web form AJP/1.3\" enabled=\"true\">...</AjpSampler>\nI save and then run the test plan\nIn the UI, this sampler fails with a null response.\n\nIn both cases, when I look at the JMeter log file, I see:\n\n2011/03/23 15:16:23 ERROR - jmeter.threads.JMeterThread: Error while processing sampler 'AJP/1.3 Sampler - MSScalculator app' : java.lang.StringIndexOutOfBoundsException: String index out of range: 41099\n\tat java.lang.String.checkBounds(Unknown Source)\n\tat java.lang.String.<init>(Unknown Source)\n\tat org.apache.jmeter.protocol.http.sampler.AjpSampler.getString(AjpSampler.java:499)\n\tat org.apache.jmeter.protocol.http.sampler.AjpSampler.parseHeaders(AjpSampler.java:443)\n\tat org.apache.jmeter.protocol.http.sampler.AjpSampler.handshake(AjpSampler.java:392)\n\tat org.apache.jmeter.protocol.http.sampler.AjpSampler.execute(AjpSampler.java:381)\n\tat org.apache.jmeter.protocol.http.sampler.AjpSampler.sample(AjpSampler.java:112)\n\tat org.apache.jmeter.protocol.http.sampler.HTTPSamplerBase.sample(HTTPSamplerBase.java:965)\n\tat org.apache.jmeter.protocol.http.sampler.HTTPSamplerBase.sample(HTTPSamplerBase.java:951)\n\tat org.apache.jmeter.threads.JMeterThread.process_sampler(JMeterThread.java:348)\n\tat org.apache.jmeter.threads.JMeterThread.run(JMeterThread.java:243)\n\tat java.lang.Thread.run(Unknown Source)\n\nIf I create another AJP sampler in the UI change the protocol from https to http and change the target path to the tomcat manager app, I get the same UI behavior and the same exception with a different out-of-range index value (41086).", "id": 145226, "time": "2011-03-23T19:33:37Z", "creator": "rebeccah.h.prastein@questdiagnostics.com", "creation_time": "2011-03-23T19:33:37Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 50963, "attachment_id": null, "text": "I just realized, the exception I am reporting in AjpSampler is identical to the one reported in Bug 47242 Comment 6, in the AJP commandline client code that Ken Van Camp was asking for (and that I downloaded from that thread to confirm I had AJP access across my Intranet).\n\nIn that thread, chamith buddhika did post a patch for the commandline AJP client last April.  Perhaps it can be incorporated into JMeter?\n\nThanks,\n\nRebeccah", "id": 145227, "time": "2011-03-23T20:36:09Z", "creator": "rebeccah.h.prastein@questdiagnostics.com", "creation_time": "2011-03-23T20:36:09Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 50963, "is_private": false, "text": "I've found one bug, which is that the code fails to skip past the control integer used for header translation, so the value is then used as the length for the next String.\n\nNot sure if that is the same bug as in Bug 47242 - there's rather a lot of code to scan to see if it is.\n\nURL: http://svn.apache.org/viewvc?rev=1084822&view=rev\nLog:\nBug 50963 - AjpSampler throws java.lang.StringIndexOutOfBoundsException\n\nModified:\n   jakarta/jmeter/trunk/src/protocol/http/org/apache/jmeter/protocol/http/sampler/AjpSampler.java\n   jakarta/jmeter/trunk/xdocs/changes.xml\n\n\nThe code is in nightly builds from r1084822.", "id": 145231, "time": "2011-03-23T21:01:10Z", "creator": "sebb@apache.org", "creation_time": "2011-03-23T21:01:10Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 50963, "text": "Thank you very much for jumping on this so quickly.\n\nRebeccah", "id": 145242, "time": "2011-03-24T13:01:24Z", "creator": "rebeccah.h.prastein@questdiagnostics.com", "creation_time": "2011-03-24T13:01:24Z", "is_private": false, "attachment_id": null}]