[{"count": 0, "tags": [], "bug_id": 56536, "text": "Created attachment 31630\nReproduction war (including sources inside)\n\nWe are encountering an issue with the call to the valueUnbound listener of our application. We rely on the SingleSignOn valve (org.apache.catalina.authenticator.SingleSignOn) to invalidate all user sessions for all web applications when the user chooses to logout (session invalidate) on one webapp.\n\nIt seems that the valueUnboud is always called with the WebappClassLoader of the application where the original Session.invalidate was called. In the SingleSignOn scenario this is not always the webappclassloader.\n\nI have added reproduction steps and .wars below.\n\nIt seems that the HttpSessionListener methods _are_ being called with the correct classloader from org.apache.catalina.session.StandardSession.expire(boolean). The expire method holds functionality to set the classloader to the webapp classloader, and restore it after calling. In the patch i have moved the classloader restore code down. This makes that also the valueUnbound calls are now done using the right webappclassloader. But i am not sure if this is valid as also a number of internal calls are being executed in the process. \nI will add the patch in the comments as i can only add a single attachment it seems.\n\n= Reproduction =\nI have created a very small demo project (code to be found in the war).\n\n== Preparation ==\n- Use a Tomcat 7 runtime.\n- Make sure you can login with a user that gets role 'test' by editing <tomcat>/conf/tomcat-users.xml.\n- Make sure SingleSignOn valve is enabled in server.xml\n- Place SingleSignOut.war in <tomcat>/webapps/\n- Make a copy of this <tomcat>/webapps/SingleSignOut.war to <tomcat>/webapps/SingleSignOut2.war\n(now you have two web applications that expect a user with role test, and answer to a request on / and on /logout)\n\n== Running the repro ==\n- Go to http://localhost:8080/SingleSignOut/\n- login: test/test\n- Go to http://localhost:8080/SingleSignOut2/\n- No login needed\n- Go to http://localhost:8080/SingleSignOut2/logout\n- See the following log on stdout:\n<begin stdout snippet>\nCalling session invalidate from /SingleSignOut2 using classloader WebappClassLoader\n  context: /SingleSignOut2\n  delegate: false\n  repositories:\n    /WEB-INF/classes/\n----------> Parent Classloader:\norg.apache.catalina.loader.StandardClassLoader@7a1f0683\n/SingleSignOut VALUE UNBOUND using classloader WebappClassLoader\n  context: /SingleSignOut2\n  delegate: false\n  repositories:\n    /WEB-INF/classes/\n----------> Parent Classloader:\norg.apache.catalina.loader.StandardClassLoader@7a1f0683\n/SingleSignOut2 VALUE UNBOUND using classloader WebappClassLoader\n  context: /SingleSignOut2\n  delegate: false\n  repositories:\n    /WEB-INF/classes/\n----------> Parent Classloader:\norg.apache.catalina.loader.StandardClassLoader@7a1f0683\n</end stdout snippet>\n- Observe that the value unboud for /SingleSignOut is being called with the classloader for /SingleSignOut2!", "id": 175275, "time": "2014-05-16T13:27:30Z", "creator": "maarten@vanhulsentop.nl", "creation_time": "2014-05-16T13:27:30Z", "is_private": false, "attachment_id": 31630}, {"count": 1, "tags": [], "bug_id": 56536, "text": "Created attachment 31631\nPatch where the restoring of the old classloader is deferred.", "id": 175276, "time": "2014-05-16T13:29:29Z", "creator": "maarten@vanhulsentop.nl", "creation_time": "2014-05-16T13:29:29Z", "is_private": false, "attachment_id": 31631}, {"count": 2, "tags": [], "bug_id": 56536, "text": "Hmm. The problem is wider than that. There are a number of places where the application listener is called with the wrong class loader.\n\nSimply extending the use of the webapp class loader will cause container listeners to be fired with the wrong listener. A more fine-grained approach is required. I'm taking a look now.", "id": 175279, "time": "2014-05-16T18:06:59Z", "creator": "markt@apache.org", "creation_time": "2014-05-16T18:06:59Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 56536, "is_private": false, "text": "Scratch that. It isn't that bad. Most of these methods are triggered by web app code so the class loader is already correct. I still think extending the coverage will have undesirable side-effects.", "id": 175281, "time": "2014-05-16T18:20:06Z", "creator": "markt@apache.org", "creation_time": "2014-05-16T18:20:06Z", "attachment_id": null}, {"count": 4, "tags": [], "text": "This has been fixed in trunk for 8.0.8 onwards and in 7.0.x for 7.0.54 onwards.", "is_private": false, "id": 175282, "creator": "markt@apache.org", "time": "2014-05-16T18:32:48Z", "bug_id": 56536, "creation_time": "2014-05-16T18:32:48Z", "attachment_id": null}]