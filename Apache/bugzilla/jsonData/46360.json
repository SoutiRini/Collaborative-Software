[{"count": 0, "tags": [], "bug_id": 46360, "attachment_id": null, "is_private": false, "id": 123151, "time": "2008-12-07T05:55:28Z", "creator": "jeremias@apache.org", "creation_time": "2008-12-07T05:55:28Z", "text": "FOP reuses/caches SVG documents to improve performance. But as we had to learn, this approach is not thread-safe as Batik attaches some facilities (like the CSS engine) to the DOM which are not thread-safe. The detailed discussion of the issue can be found here:\nhttp://markmail.org/message/2dk2ib4e5t6vfsrl\n\nThe safest approach is to clone the SVG DOM prior to passing it to Batik.\n\nObviously that will cost a bit of performance and increase memory usage a bit. If we're careful and have the resources to implement that we can improve performance by caching Batik's GVT tree. Ideas can also be found in the thread indicated above."}, {"count": 1, "tags": [], "bug_id": 46360, "attachment_id": null, "is_private": false, "id": 123153, "time": "2008-12-07T10:04:39Z", "creator": "jeremias@apache.org", "creation_time": "2008-12-07T10:04:39Z", "text": "Issue fixed as discussed on batik-users.\nhttp://svn.apache.org/viewvc?rev=724163&view=rev\nhttp://svn.apache.org/viewvc?rev=724164&view=rev\n\nI'll keep this open for a bit since I'll have to do the same in the IF branch."}, {"count": 2, "tags": [], "text": "One more note to self: Need to introduce a flag to indicate whether we're working off a potentially cached SVG DOM or off a DOM that comes from an fo:instream-foreign-object in which the cloning is unnecessary.", "is_private": false, "id": 123154, "creator": "jeremias@apache.org", "time": "2008-12-07T10:07:08Z", "bug_id": 46360, "creation_time": "2008-12-07T10:07:08Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "mhilpert@gmx.de", "attachment_id": null, "id": 123413, "time": "2008-12-19T02:30:20Z", "bug_id": 46360, "creation_time": "2008-12-19T02:30:20Z", "is_private": false, "text": "I got a NullPointerException during FOP processing while do transformations were processing concurrently. Both include (the same) SVG image files.\n\n-----------------\nThe attribute \"style\" represents an invalid CSS declaration (\"fill:#ef7b00; fill-rule:nonzero; stroke:none; stroke-width:1; stroke-linecap:butt; stroke-linejoin:miter; stroke-dasharray:none;\").\nOriginal message:\njava.lang.NullPointerException\n    org.w3c.dom.DOMException: file:/C:/Programme/ddf/xml/images/V10271.svg:\nThe attribute \"style\" represents an invalid CSS declaration (\"fill:#ef7b00; fill-rule:nonzero; stroke:none; stroke-width:1; stroke-linecap:butt; stroke-linejoin:miter; stroke-dasharray:none;\").\nOriginal message:\njava.lang.NullPointerException\n    \tat org.apache.batik.css.engine.CSSEngine.getCascadedStyleMap(Unknown Source)\n    \tat org.apache.batik.css.engine.CSSEngine.getComputedStyle(Unknown Source)\n    \tat org.apache.batik.bridge.CSSUtilities.getComputedStyle(Unknown Source)\n    \tat org.apache.batik.bridge.CSSUtilities.convertDisplay(Unknown Source)\n    \tat org.apache.batik.bridge.GVTBuilder.buildGraphicsNode(Unknown Source)\n    \tat org.apache.batik.bridge.GVTBuilder.buildComposite(Unknown Source)\n    \tat org.apache.batik.bridge.GVTBuilder.build(Unknown Source)\n    \tat org.apache.fop.render.pdf.PDFSVGHandler.renderSVGDocument(PDFSVGHandler.java:188)\n\n---------------------------------------\n\nsee https://issues.apache.org/bugzilla/show_bug.cgi?id=46418\n\nI guess, there are more threading issues with Batik SVG...\n"}, {"count": 4, "tags": [], "text": "A similar bug has been fixed in FOP Trunk as is noted in this bug. Does this error occur with the current FOP Trunk?\n\n(In reply to comment #3)\n> I got a NullPointerException during FOP processing while do transformations\n> were processing concurrently. Both include (the same) SVG image files.\n> \n> -----------------\n> The attribute \"style\" represents an invalid CSS declaration (\"fill:#ef7b00;\n> fill-rule:nonzero; stroke:none; stroke-width:1; stroke-linecap:butt;\n> stroke-linejoin:miter; stroke-dasharray:none;\").\n> Original message:\n> java.lang.NullPointerException\n>     org.w3c.dom.DOMException: file:/C:/Programme/ddf/xml/images/V10271.svg:\n> The attribute \"style\" represents an invalid CSS declaration (\"fill:#ef7b00;\n> fill-rule:nonzero; stroke:none; stroke-width:1; stroke-linecap:butt;\n> stroke-linejoin:miter; stroke-dasharray:none;\").\n> Original message:\n> java.lang.NullPointerException\n>         at org.apache.batik.css.engine.CSSEngine.getCascadedStyleMap(Unknown\n> Source)\n>         at org.apache.batik.css.engine.CSSEngine.getComputedStyle(Unknown\n> Source)\n>         at org.apache.batik.bridge.CSSUtilities.getComputedStyle(Unknown\n> Source)\n>         at org.apache.batik.bridge.CSSUtilities.convertDisplay(Unknown Source)\n>         at org.apache.batik.bridge.GVTBuilder.buildGraphicsNode(Unknown Source)\n>         at org.apache.batik.bridge.GVTBuilder.buildComposite(Unknown Source)\n>         at org.apache.batik.bridge.GVTBuilder.build(Unknown Source)\n>         at\n> org.apache.fop.render.pdf.PDFSVGHandler.renderSVGDocument(PDFSVGHandler.java:188)\n> \n> ---------------------------------------\n> \n> see https://issues.apache.org/bugzilla/show_bug.cgi?id=46418\n> \n> I guess, there are more threading issues with Batik SVG...\n> \n\n", "is_private": false, "id": 123415, "creator": "jeremias@apache.org", "time": "2008-12-19T02:41:23Z", "bug_id": 46360, "creation_time": "2008-12-19T02:41:23Z", "attachment_id": null}, {"count": 5, "tags": [], "text": "As this is a multi-threading issue, it's hard to reproduce. I throw lots of jobsat the application but wasn't able to reproduce it for now (with FOP 0.95).", "is_private": false, "id": 123425, "creator": "mhilpert@gmx.de", "time": "2008-12-19T06:37:43Z", "bug_id": 46360, "creation_time": "2008-12-19T06:37:43Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 46360, "is_private": false, "text": "I can confirm that this issue is valid for FOP 1.0. A workaround is to use a different instance of FopFactory per thread.", "id": 139613, "time": "2010-09-02T05:01:10Z", "creator": "alex.giotis@gmail.com", "creation_time": "2010-09-02T05:01:10Z", "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 46360, "is_private": false, "text": "Created attachment 25970\nPatch to clone the SVG document inside PDFImageHandlerSVG\n\nThe patch is attached after a short discussion in the fop-dev mailing list. Shortly, in PDFImageHandlerSVG.handleImage() the SVG document is not cloned but in other places it is. Examples of cloning are in ImageConverterSVG2G2D, AbstractGenericSVGHandler, AFPImageHandlerSVG, AFPSVGHandler, Java2DSVGHandler, PSSVGHandler.\n\nBefore the patch, in a multi-threaded environment parsing of the SVG documents was corrupted with a probability close to 80%. After this, the errors can not be reproduced. This patch contains the smallest change I could do, is for a single file and should be safe to apply.\n\nOn a side note, normally I would first try to gather the building of the GraphicsNode in a single place and then avoid the document cloning by serializing only the parsing of the SVG. But that would affect more files / projects and would make the processing of the patch more difficult.", "id": 139619, "time": "2010-09-02T07:52:22Z", "creator": "alex.giotis@gmail.com", "creation_time": "2010-09-02T07:52:22Z", "attachment_id": 25970}, {"count": 8, "attachment_id": null, "creator": "jeremias@apache.org", "text": "Patch applied: http://svn.apache.org/viewvc?rev=997599&view=rev\nThanks, Alexis.\n\nOne more fix here:\nhttp://svn.apache.org/viewvc?rev=997602&view=rev\n\nThat should now be all.", "id": 139890, "time": "2010-09-16T02:31:59Z", "bug_id": 46360, "creation_time": "2010-09-16T02:31:59Z", "tags": [], "is_private": false}]