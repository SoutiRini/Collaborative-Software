[{"count": 0, "tags": [], "text": "While a new file is being received, its mode is set to 0, but its name is already that of the new file. If, for whatever reason, httpd dies during transmission, a zero-mode file under the desired name will remain on the filesystem.\n\nAlso, sites, which mirror FTP-content periodically can occasionally suffer from races -- if the mirroring program (such as rsync) runs, while a file-upload is in progress, it will try, but fail to mirror it.\n\nA possible solution would be to open new files under a different name. For example, if the (new) keyword specifies a prefix:\n\nFTPTemporaryFilePrefix       .in-flight-\n\nthe new file foo/bar can be opened as (using apr_file_mktemp()):\n\nfoo/.in-flight-35CH21bar\n\nThen, upon completion of upload, it can be renamed into foo/bar, if the uploaded was successful, or deleted, if the upload failed. (The renaming is conveniently atomic.)\n\nThe existing files can be similarly-handled, when a complete overwrite is requested:\n\n1. Receive under new (temporary) name.\n2. Rename the existing name into another temporary name.\n3. Rename the temporary name from 1. into the desired name.\n4. Unlink the temporary name from 2.\n\nThis approach will help preserve file-integrity during the (potentially lengthy) uploads and also help tools like rsync, who can be told to skip any file, that matches certain pattern (such as \".in-flight-*\").\n\nIf this is deemed acceptable in principle, I can begin working on a patch.", "is_private": false, "id": 155253, "creator": "mi+apache@aldan.algebra.com", "time": "2012-03-23T00:57:03Z", "bug_id": 52975, "creation_time": "2012-03-23T00:57:03Z", "attachment_id": null}]