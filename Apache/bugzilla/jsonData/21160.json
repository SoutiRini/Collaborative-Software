[{"count": 0, "tags": [], "bug_id": 21160, "attachment_id": null, "is_private": false, "id": 39568, "time": "2003-06-28T03:04:01Z", "creator": "bughunt@gluino.name", "creation_time": "2003-06-28T03:04:01Z", "text": "There is as yet not much information here, I will have to try a few things\nfirst (next week, not today it's about 05:00). But here is what happens:\n\nApache has been configured with three IP-based virtual servers on three\ndifferent IP addresses. On each of these addresses, we have an SSL server, thus\nthree SSL servers in total. \n\nOne with a self-signed root CA certificate   ROOT->C1->SSL virtual host\nTwo with an 'official' CA certificate        ROOT->C1->C2->SSL virtual host\n\nEverything has been configured, Apache has been happily chugging along...\n\nBut then...\n\nAfter a restart, Apache goes through the SSL virtual servers and asks the\npassword for each of the three private keys (good). After this, it fails (bad)\nwith the following error in the error log:\n\n\"Failed to configure CA certificate chain!\"\n\n(Some additional info would have been of use, too)\n\nThe weird thing is that the configuration for SSL had not changed at all. Thus\nthe production server was suddenly dead in the water w/o reason.\n\nAlso, each of the SSL virtual servers work if they are the only ones in the\nconfig file. Certain pairs also work, but not all.\n\nFinally, 'openssl verify' does not find anything amiss with the CA chains.\n\nSo, that's all for now. More to follow (hopefully)\n\nWhat is this server:\n\nApache/2.0.45 + mod_ssl/2.0.45 + OpenSSL/0.9.7b \n\non a RH7.3 OS with gcc-2.96-110 and glibc-2.2.5-39"}, {"count": 1, "tags": [], "text": "As promised, more information (I am actually keeping my word for once, wow!):\n\nI finally got it to work, though why it *does* work is a mystery.\n\nFirst, some info on what does not work:\n\nI tried the three SSL virtual servers pairwise. On each occasion, Apache startup\nfailed. I got the ide of setting the verbosity level to debug ('LogLevel Debug'),\nthus we find the following in the logfile, in case all three SSL virtual servers\nare configured:\n\n[Mon Jun 30 23:03:31 2003] [info] Init: Initializing OpenSSL library\n[Mon Jun 30 23:03:31 2003] [info] Init: Seeding PRNG with 648 bytes of entropy\n[Mon Jun 30 23:03:31 2003] [info] Loading certificate & private key of SSL-aware\nserver\n[Mon Jun 30 23:03:31 2003] [info] Init: Requesting pass phrase via builtin\nterminal dialog\n[Mon Jun 30 23:03:38 2003] [debug] ssl_engine_pphrase.c(499): encrypted RSA\nprivate key - pass phrase requested\n[Mon Jun 30 23:03:38 2003] [info] Loading certificate & private key of SSL-aware\nserver\n[Mon Jun 30 23:03:38 2003] [info] Init: Requesting pass phrase via builtin\nterminal dialog\n[Mon Jun 30 23:03:47 2003] [debug] ssl_engine_pphrase.c(499): encrypted RSA\nprivate key - pass phrase requested\n[Mon Jun 30 23:03:47 2003] [info] Loading certificate & private key of SSL-aware\nserver\n[Mon Jun 30 23:03:47 2003] [info] Init: Requesting pass phrase via builtin\nterminal dialog\n[Mon Jun 30 23:03:54 2003] [debug] ssl_engine_pphrase.c(499): encrypted RSA\nprivate key - pass phrase requested\n[Mon Jun 30 23:03:54 2003] [info] Init: Wiped out the queried pass phrases from\nmemory\n[Mon Jun 30 23:03:54 2003] [info] Init: Generating temporary RSA private keys\n(512/1024 bits)\n[Mon Jun 30 23:03:54 2003] [info] Init: Generating temporary DH parameters\n(512/1024 bits)\n[Mon Jun 30 23:03:54 2003] [debug] ssl_scache_dbm.c(422): Inter-Process Session\nCache (DBM) Expiry: old: 0, new: 0, removed: 0\n[Mon Jun 30 23:03:54 2003] [info] Init: Initializing (virtual) servers for SSL\n[Mon Jun 30 23:03:54 2003] [info] Configuring server for SSL protocol\n[Mon Jun 30 23:03:54 2003] [debug] ssl_engine_init.c(436): Creating new SSL\ncontext (protocols: SSLv2, SSLv3, TLSv1)\n[Mon Jun 30 23:03:54 2003] [debug] ssl_engine_init.c(611): Configuring permitted\nSSL ciphers [ALL:!IDEA:!ADH:EXPORT56:EXPORT40:!NULL:+HIGH:+MEDIUM:+LOW]\n[Mon Jun 30 23:03:54 2003] [error] Failed to configure CA certificate chain!\n\nI will spare you the pairs, it's the same...\n\nI then tried each of the SSL virtual servers alone. In each case, \nstartup was a success:\n\n[Mon Jun 30 23:03:31 2003] [info] Init: Initializing OpenSSL library\n[Mon Jun 30 23:03:31 2003] [info] Init: Seeding PRNG with 648 bytes of entropy\n[Mon Jun 30 23:03:31 2003] [info] Loading certificate & private key of SSL-aware\nserver\n[Mon Jun 30 23:03:31 2003] [info] Init: Requesting pass phrase via builtin\nterminal dialog\n[Mon Jun 30 23:03:38 2003] [debug] ssl_engine_pphrase.c(499): encrypted RSA\nprivate key - pass phrase requested\n[Mon Jun 30 23:03:38 2003] [info] Loading certificate & private key of SSL-aware\nserver\n[Mon Jun 30 23:03:38 2003] [info] Init: Requesting pass phrase via builtin\nterminal dialog\n[Mon Jun 30 23:03:47 2003] [debug] ssl_engine_pphrase.c(499): encrypted RSA\nprivate key - pass phrase requested\n[Mon Jun 30 23:03:47 2003] [info] Loading certificate & private key of SSL-aware\nserver\n[Mon Jun 30 23:03:47 2003] [info] Init: Requesting pass phrase via builtin\nterminal dialog\n[Mon Jun 30 23:03:54 2003] [debug] ssl_engine_pphrase.c(499): encrypted RSA\nprivate key - pass phrase requested\n[Mon Jun 30 23:03:54 2003] [info] Init: Wiped out the queried pass phrases from\nmemory\n[Mon Jun 30 23:03:54 2003] [info] Init: Generating temporary RSA private keys\n(512/1024 bits)\n[Mon Jun 30 23:03:54 2003] [info] Init: Generating temporary DH parameters\n(512/1024 bits)\n[Mon Jun 30 23:03:54 2003] [debug] ssl_scache_dbm.c(422): Inter-Process Session\nCache (DBM) Expiry: old: 0, new: 0, removed: 0\n[Mon Jun 30 23:03:54 2003] [info] Init: Initializing (virtual) servers for SSL\n[Mon Jun 30 23:03:54 2003] [info] Configuring server for SSL protocol\n[Mon Jun 30 23:03:54 2003] [debug] ssl_engine_init.c(436): Creating new SSL\ncontext (protocols: SSLv2, SSLv3, TLSv1)\n[Mon Jun 30 23:03:54 2003] [debug] ssl_engine_init.c(611): Configuring permitted\nSSL ciphers [ALL:!IDEA:!ADH:EXPORT56:EXPORT40:!NULL:+HIGH:+MEDIUM:+LOW]\n[Mon Jun 30 23:03:54 2003] [error] Failed to configure CA certificate chain!\n\nI figured I would continue with a pair of servers and whittle down the\nSSL config file until things began to work. This actually paid off!\n\nIt turns that the presence of this block seems to be confusing:\n\n  <Files ~ \"\\.(cgi|shtml|phtml|php3?)$\">\n      SSLOptions +StdEnvVars\n  </Files>\n  <Directory \"/usr/local/apache2/cgi-bin\">\n      SSLOptions +StdEnvVars\n  </Directory>\n\nI had this block in each of the three SSL virtual servers, taken from the\noriginal file coming with Apache. I commented it out in one (1) of the three.\n\nLo and behold! It works! Now the passphrase dialog spits out an error after\nhaving asked for the 2nd passphrase. This however, does not prevent it from\nreading the third passpharse. It is also a Good Sign, because whenever this\nerror shows up, the webserver will be able to configure itself:\n\n\nServer www.m-plify.com:443 (RSA)\nEnter pass phrase:\n\nServer rei1.m-plify.net:443 (RSA)\nEnter pass phrase:1024:error:0D094068:asn1 encoding routines:d2i_ASN1_SET:bad\ntag:a_set.c:179:\n1024:error:0D0680A8:asn1 encoding routines:ASN1_CHECK_TLEN:wrong tag:tasn_dec.c:939:\n1024:error:0D07803A:asn1 encoding routines:ASN1_ITEM_EX_D2I:nested asn1\nerror:tasn_dec.c:304:Type=RSA\n1024:error:0D09A00D:asn1 encoding routines:d2i_PrivateKey:ASN1 lib:d2i_pr.c:96:\n\n\nI'm completely at a loss to explain a relationship between the configuration\ninstructions above and SSL certificate chain configuration, sorry....but that's\nwhat happened.", "is_private": false, "bug_id": 21160, "id": 39701, "time": "2003-06-30T22:17:52Z", "creator": "bughunt@gluino.name", "creation_time": "2003-06-30T22:17:52Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 21160, "attachment_id": null, "text": "Naah, forget what I said about the workaround. The exact same file that\nearlier worked now fails to work (yeah, its the fscking SAME file). This must\nhave to do with the moon phases! OMG...\n", "id": 39706, "time": "2003-06-30T23:11:09Z", "creator": "bughunt@gluino.name", "creation_time": "2003-06-30T23:11:09Z", "is_private": false}, {"count": 3, "tags": [], "text": "I have tried with Apache 2.0.46. There were 3 successfull starts and 1 \nunsuccessful one. Not too bad. I swear I will give up all this Computer\nCrap and I'm gonna raise sheep in New Zealand!\n\nAnyway, that's it for now. -OO-", "is_private": false, "id": 39715, "creation_time": "2003-07-01T00:41:31Z", "time": "2003-07-01T00:41:31Z", "creator": "bughunt@gluino.name", "bug_id": 21160, "attachment_id": null}, {"count": 4, "tags": [], "text": "Same problem here.  A configuration with a certificate chain and two virtual\nhosts worked on one system (always) but failed on another (always).  On the\nsystem where it failed, removing one of the virtual hosts fixed the problem.\n\nSetup: Apache 2.0.46 + OpenSSL 0.9.6i\nSuccess system: Gentoo Linux\nFailure system: RedHat Advanced Server\n\nI'm not sure whether it is related to the OS vendor.  Will do some more checks\nwhen I get the time.", "is_private": false, "id": 39723, "creation_time": "2003-07-01T06:53:57Z", "time": "2003-07-01T06:53:57Z", "creator": "kris.verbeeck@advalvas.be", "bug_id": 21160, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 21160, "attachment_id": null, "is_private": false, "id": 52002, "time": "2004-02-09T17:45:07Z", "creator": "bughunt@gluino.name", "creation_time": "2004-02-09T17:45:07Z", "text": "I have tried with Apache 2.0.47 and openssl-0.9.7b. Same problem.\n\nAnd the workaround is (tadaa!):\n\nDO NOT ENCRYPT THE SERVER PRIVATE KEYS.\n\nArf!"}, {"count": 6, "tags": [], "text": "There is a bug which means the OpenSSL error stack is not cleared: I thought\nthis was a purely cosmetic issue (it causes the error dumps you see during\npphrase entry), but in fact it may well be the cause of this bug:\n\nCan anyone who can reproduce this try the following patch:\n\nhttp://cvs.apache.org/viewcvs.cgi/httpd-2.0/modules/ssl/ssl_engine_pphrase.c?r1=1.44&r2=1.45\n", "is_private": false, "id": 52017, "creator": "jorton@redhat.com", "time": "2004-02-09T22:26:14Z", "bug_id": 21160, "creation_time": "2004-02-09T22:26:14Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 21160, "text": "I was able to reproduce the 'Failed to configure CA certificate chain' error\nmessage.  I started Apache and entered a wrong passphrase for the private key\nand got \"Error: Pass phrase incorrect (5 more retries permitted).\".  After that\nI entered the correct passphrase and got \"Ok: Pass Phrase Dialog successful.\". \nThen Apache failed to start (the other virtual hosts probably) and the error log\ncontained the certificate chain error.  When I enter the correct passphrase from\nthe beginning everything works allright.\n\nThen I patched the server with the patch given below and retested like above. \nApache now started succesfully.  So it seems that this error stack clearing\nreally is more than only cosmetic :)).", "count": 7, "id": 52044, "time": "2004-02-10T10:59:51Z", "creator": "kris.verbeeck@advalvas.be", "creation_time": "2004-02-10T10:59:51Z", "is_private": false}, {"count": 8, "tags": [], "creator": "jorton@redhat.com", "text": "Wonderful, thanks Kris.  I've proposed the fix for inclusion in the next 2.0\nrelease.  Thanks for the reports.", "id": 52046, "time": "2004-02-10T11:23:17Z", "bug_id": 21160, "creation_time": "2004-02-10T11:23:17Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 21160, "is_private": false, "count": 9, "id": 53832, "time": "2004-03-10T18:16:23Z", "creator": "jorton@redhat.com", "creation_time": "2004-03-10T18:16:23Z", "text": "*** Bug 13585 has been marked as a duplicate of this bug. ***"}, {"count": 10, "tags": [], "text": "*** Bug 29496 has been marked as a duplicate of this bug. ***", "is_private": false, "id": 59023, "creation_time": "2004-06-10T15:09:01Z", "time": "2004-06-10T15:09:01Z", "creator": "jorton@redhat.com", "bug_id": 21160, "attachment_id": null}]