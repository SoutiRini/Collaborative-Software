[{"count": 0, "tags": [], "bug_id": 59739, "is_private": false, "text": "Created attachment 33970\ntriggering file\n\nIn tightening up the codebase based on FindBugs results[0], we're now throwing an IllegalStateException if the FileInformationBlock doesn't match one of 5 patterns.\n\nA test file in Tika's test suite is now getting:\n\nCaused by: java.lang.IllegalStateException: Invalid file format version number: 195\n\tat org.apache.poi.hwpf.model.FileInformationBlock.assertCbRgFcLcb(FileInformationBlock.java:164)\n\tat org.apache.poi.hwpf.model.FileInformationBlock.<init>(FileInformationBlock.java:140)\n\tat org.apache.poi.hwpf.HWPFDocumentCore.<init>(HWPFDocumentCore.java:163)\n\tat org.apache.poi.hwpf.HWPFDocument.<init>(HWPFDocument.java:197)\n\tat org.apache.tika.parser.microsoft.WordExtractor.parse(WordExtractor.java:144)\n\tat org.apache.tika.parser.microsoft.OfficeParser.parse(OfficeParser.java:146)\n\tat org.apache.tika.parser.microsoft.OfficeParser.parse(OfficeParser.java:117)\n\tat org.apache.tika.parser.CompositeParser.parse(CompositeParser.java:280)\n\t... 34 more\n\n[0]http://svn.apache.org/viewvc/poi/trunk/src/scratchpad/src/org/apache/poi/hwpf/model/FileInformationBlock.java?r1=1557290&r2=1738782", "id": 191864, "time": "2016-06-21T14:30:06Z", "creator": "tallison@mitre.org", "creation_time": "2016-06-21T14:30:06Z", "attachment_id": 33970}, {"count": 1, "tags": [], "creator": "tallison@mitre.org", "is_private": false, "text": "I'll run the full corpus regression tests shortly to see if there are other values we need to add.  Or, should we undo this check?", "id": 191865, "time": "2016-06-21T14:40:35Z", "bug_id": 59739, "creation_time": "2016-06-21T14:40:35Z", "attachment_id": null}, {"count": 2, "attachment_id": null, "bug_id": 59739, "text": "Based on the file format specs - https://msdn.microsoft.com/en-us/library/dd949344(v=office.12).aspx and https://msdn.microsoft.com/en-us/library/dd950103(v=office.12).aspx - it looks like we have all the \"official\" cases covered\n\nDo these files start passing again if you do a save-as from word?", "id": 191867, "time": "2016-06-21T15:26:14Z", "creator": "apache@gagravarr.org", "creation_time": "2016-06-21T15:26:14Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 59739, "text": "Y, the problem goes away if I save as.", "id": 191868, "time": "2016-06-21T15:31:12Z", "creator": "tallison@mitre.org", "creation_time": "2016-06-21T15:31:12Z", "is_private": false, "attachment_id": null}, {"count": 4, "attachment_id": null, "bug_id": 59739, "text": "I guess we need to work out what format type these are (maybe by seeing what they contain, or what Word treats them as?), then add a few more \"unofficial\" entries to the check list", "id": 191869, "time": "2016-06-21T15:38:27Z", "creator": "apache@gagravarr.org", "creation_time": "2016-06-21T15:38:27Z", "tags": [], "is_private": false}, {"count": 5, "tags": [], "creator": "onealj@apache.org", "text": "Reverting any deprecated code deletion I did as part of bug 59170 is also an acceptable fix here. I was pretty heavy handed with HWPF.", "id": 191871, "time": "2016-06-21T16:43:24Z", "bug_id": 59739, "creation_time": "2016-06-21T16:43:24Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 59739, "attachment_id": null, "text": "In my regression-run, the following invalid versions are found:\n\nEXCEPTIONTEXT315BETA2\njava.lang.IllegalStateException: Invalid file format version number: 113\njava.lang.IllegalStateException: Invalid file format version number: 191\njava.lang.IllegalStateException: Invalid file format version number: 192\njava.lang.IllegalStateException: Invalid file format version number: 194\njava.lang.IllegalStateException: Invalid file format version number: 195\njava.lang.IllegalStateException: Invalid file format version number: 216\njava.lang.IllegalStateException: Invalid file format version number: 265\njava.lang.IllegalStateException: Invalid file format version number: 267\n\n\nWe can add those as \"undocumented\", but I'd probably go with a POILogger.warning() instead of the throw to not fail on other version-numbers that are not included in our test-files.", "id": 191877, "time": "2016-06-21T19:11:33Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2016-06-21T19:11:33Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 59739, "is_private": false, "text": "Those look like clusters around the valid values (plus an outlier at 113)\n\nI'd be tempted to say we accept any value +- 4 without much/any logging (and +- 113). Could someone check, for a few triggering files, how their cbRgFcLcb values match with what the spec says to expect for the nearest-valid nFib values?", "id": 191879, "time": "2016-06-21T19:19:53Z", "creator": "apache@gagravarr.org", "creation_time": "2016-06-21T19:19:53Z", "attachment_id": null}, {"count": 8, "attachment_id": null, "bug_id": 59739, "text": "I have applied a quick fix in r1750864 so that such documents do not fail until we have decided on a complete solution here. The code now logs out the unknown version number instead of throwing an exception.", "id": 192034, "time": "2016-06-30T21:07:22Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2016-06-30T21:07:22Z", "tags": [], "is_private": false}, {"count": 9, "tags": [], "bug_id": 59739, "text": "In r1750866, I've changed it so that likely \"nearby\" values are subject to the same check as the \"official\" values, and if passed no logging occurs. Hopefully this helps and doesn't trigger any new warnings!", "id": 192035, "time": "2016-06-30T21:22:31Z", "creator": "apache@gagravarr.org", "creation_time": "2016-06-30T21:22:31Z", "is_private": false, "attachment_id": null}, {"count": 10, "attachment_id": null, "bug_id": 59739, "text": "I don't think we currently plan to invest more time on this, so I am closing this as FIXED as all the sample-documents from our commoncrawl-corpus are now handled correctly.", "id": 193087, "time": "2016-08-13T20:51:32Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2016-08-13T20:51:32Z", "tags": [], "is_private": false}]