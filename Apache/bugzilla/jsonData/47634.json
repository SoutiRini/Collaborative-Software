[{"count": 0, "tags": [], "creator": "jagusztinl@freemail.hu", "attachment_id": null, "text": "We found that mod_ldap unable to work through firewalls, because ldap session keepalive not implemented in it. There is not always possible to solve keepalive on the server side, because of operation policies, too far from client etc., but we need it because of ldap connection pooling.\n\nSo mod_ldap client keepalive should be implemented. \nWe patched the code (## line) to implement a workaround for the missing functionality:\n\n   ./modules/ldap/util_ldap.c:\n\n                    static void uldap_connection_close(util_ldap_connection_t *ldc)\n                    {\n\n                        /*\n                        * QUESTION:\n                        *\n                        * Is it safe leaving bound connections floating around between the\n                        * different modules? Keeping the user bound is a performance boost,\n                        * but it is also a potential security problem - maybe.\n                        *\n                        * For now we unbind the user when we finish with a connection, but\n                        * we don't have to...\n                        */\n                        uldap_connection_unbind(ldc);      ## mod by RZS\n\n                        /* mark our connection as available for reuse */\n\n                    #if APR_HAS_THREADS\n                        apr_thread_mutex_unlock(ldc->lock);\n                    #endif\n                    }", "id": 129431, "time": "2009-08-04T02:12:48Z", "bug_id": 47634, "creation_time": "2009-08-04T02:12:48Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 47634, "is_private": false, "text": "Does that just disable the connection pooling?", "id": 129435, "time": "2009-08-04T04:50:59Z", "creator": "covener@gmail.com", "creation_time": "2009-08-04T04:50:59Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 47634, "attachment_id": null, "id": 129452, "time": "2009-08-04T13:05:45Z", "creator": "jagusztinl@freemail.hu", "creation_time": "2009-08-04T13:05:45Z", "is_private": false, "text": "(In reply to comment #1)\n> Does that just disable the connection pooling?\n\nYes. mod_ldap unusable in firewalled environment, so better to disable pooling.\nI know, this is not a full solution, it would be better if the behaviour could be configurable."}, {"count": 3, "tags": [], "bug_id": 47634, "attachment_id": null, "text": "(In reply to comment #2)\n> (In reply to comment #1)\n> > Does that just disable the connection pooling?\n> \n> Yes. mod_ldap unusable in firewalled environment, so better to disable pooling.\n> I know, this is not a full solution, it would be better if the behaviour could\n> be configurable.\n\nWhen the connection is severed by a firewall, what does your LDAP SDK return when Apache goes to use the connection?", "id": 129458, "time": "2009-08-04T18:46:50Z", "creator": "covener@gmail.com", "creation_time": "2009-08-04T18:46:50Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 47634, "attachment_id": null, "is_private": false, "id": 129506, "time": "2009-08-05T14:48:19Z", "creator": "jagusztinl@freemail.hu", "creation_time": "2009-08-05T14:48:19Z", "text": "It tries to use the dropped tcp connection, so it waits a long time (for tcp timeout). It is unacceptable long.\nWhat dou you mean \"your LDAP SDK\"?"}, {"count": 5, "tags": [], "bug_id": 47634, "attachment_id": null, "text": "(In reply to comment #2)\n> (In reply to comment #1)\n> > Does that just disable the connection pooling?\n> \n> Yes. mod_ldap unusable in firewalled environment, so better to disable pooling.\n> I know, this is not a full solution, it would be better if the behaviour could\n> be configurable.\n\nOther options:\n- implement some sort of \"check\" logic when a connection is requested from the pool. If it doesn't return in a reasonable amount of time (re-use the connection time out time or add another parameter) then unbind the connection and rebind\n- implement connection-max-age and/or connection-max-idle parameters so that if a connection is requested from the pool and it has been connected/idle for \"too long\" then unbind/rebind", "id": 132782, "time": "2009-12-11T13:30:58Z", "creator": "tmalaher@netstart.com", "creation_time": "2009-12-11T13:30:58Z", "is_private": false}, {"count": 6, "tags": [], "creator": "sf@sfritsch.de", "attachment_id": null, "text": "The cleanest fix is the ldap library enabling the tcp keepalive option. Recent version of OpenLDAP do this. Under Linux, you can tune the interval between keepalive probes with /proc/sys/net/ipv4/tcp_keepalive_time (default is two hours). Reducing this to a value below the firewall's state timeout should fix the problem.\n\nYou should try to find out if your OS / your ldap library supports this. If it doesn't, you should bug the vendor to implement it.\n\nAnother fix is to configure the firewall to send tcp reset packets instead of silently dropping connections.\n\nApart from that, allowing to set a timeout for ldap searches in Apache httpd would be a good idea.", "id": 132785, "time": "2009-12-12T11:20:24Z", "bug_id": 47634, "creation_time": "2009-12-12T11:20:24Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 47634, "attachment_id": null, "id": 133558, "time": "2010-01-12T15:55:04Z", "creator": "sf@sfritsch.de", "creation_time": "2010-01-12T15:55:04Z", "is_private": false, "text": "(In reply to comment #5)\n> Other options:\n> - implement some sort of \"check\" logic when a connection is requested from the\n> pool. If it doesn't return in a reasonable amount of time (re-use the\n> connection time out time or add another parameter) then unbind the connection\n> and rebind\n\nSomething like this is now implemented in trunk in r898102: There is a new timeout value for search/bind. If the timeout is reached, the operation is retried after unbind/rebind (at least for the initial bind after an old connection is taken from the pool).\n\nNote that at least with openldap, you can influence mod_ldap with /etc/ldap.conf and $HOME/.ldaprc (especially with the TIMEOUT parameter). Httpd 2.2.x will return 500 if TIMEOUT triggers, but this may still be better than the child waiting for > 15 minutes."}, {"count": 8, "tags": [], "bug_id": 47634, "attachment_id": null, "text": "This issue may also occur when the LDAP server is behind a load balancer which does TCP session timeouts.\n\nIn large production environments, a load balancer in front of a pool of LDAP servers is typical.\n\nWhile leaving a connection in the \"bind\" state open for performance seems like a good thing, it isn't practical except in limited environments.\n\nI suggest a directive which would turn off the bound connection pool completely.  I would also suggest that it be the default for the connection pool to be disabled.", "id": 144838, "time": "2011-03-08T16:56:11Z", "creator": "rick-apache-bugzilla@case.net", "creation_time": "2011-03-08T16:56:11Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 47634, "attachment_id": null, "is_private": false, "id": 144956, "time": "2011-03-12T18:16:49Z", "creator": "covener@gmail.com", "creation_time": "2011-03-12T18:16:49Z", "text": "trunk now has a configuration switch LDAPConnectionPoolTTL which can be set to zero to always unbind, or set to a positive # to unbind connections right before they're reused if they're too old.  \n\nThe default behavior is not changed.  Since all we do is unbind, this may be backportable."}, {"count": 10, "tags": [], "bug_id": 47634, "attachment_id": null, "is_private": false, "id": 199016, "time": "2017-06-02T08:17:20Z", "creator": "trandung0101@gmail.com", "creation_time": "2017-06-02T08:17:20Z", "text": "(In reply to R. Gilligan from comment #8)\n> This issue may also occur when the LDAP server is behind a load balancer\n> which does TCP session timeouts.\n\nHi Gilligan\n\nIs it easy to reproduce this issue?\nI don't use apache 2.2.11 but I have apache 2.2.3; 2.2.21; 2.4.6\nI cannot reproduce this issue with these version.\nDoes it happen with every http request?"}, {"count": 11, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "is_private": false, "id": 199022, "time": "2017-06-02T11:16:27Z", "bug_id": 47634, "creation_time": "2017-06-02T11:16:27Z", "text": "There are now search and bind timeouts and LDAPConnectionPoolTTL (including zero)"}]