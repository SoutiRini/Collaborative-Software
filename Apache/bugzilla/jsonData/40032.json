[{"count": 0, "tags": [], "bug_id": 40032, "attachment_id": null, "text": "The following XML is taken from the CanonSubtree sample app, but illustrates an\nissue that I've encountered, which is causing a signature verification interop\nproblem (Keytools and xml-sec).\n\nI've slightly altered the XML from the CanonSubtree sample by adding xmlns=\"\" to\nthe CanonicalizationMethod element. The second chunk of XML is the result of\nApache xml-sec 1.3 subtree (SignedInfo) canonicalization.\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Signature xmlns=\"http://www.w3.org/2000/09/xmldsig#\">\n  <SignedInfo>\n    <CanonicalizationMethod xmlns=\"\"\nAlgorithm=\"http://www.w3.org/TR/2001/REC-xml-c14n-20010315\"></CanonicalizationMethod>\n    <SignatureMethod\nAlgorithm=\"http://www.w3.org/2000/09/xmldsig#rsa-sha1\"></SignatureMethod>\n    <Reference URI=\"http://www.w3.org/TR/xml-stylesheet\">\n      <DigestMethod\nAlgorithm=\"http://www.w3.org/2000/09/xmldsig#sha1\"></DigestMethod>\n      <DigestValue>60NvZvtdTB+7UnlLp/H24p7h4bs=</DigestValue>\n    </Reference>\n  </SignedInfo>\n<Signature>\n\n\n<SignedInfo xmlns=\"http://www.w3.org/2000/09/xmldsig#\">\n    <CanonicalizationMethod\nAlgorithm=\"http://www.w3.org/TR/2001/REC-xml-c14n-20010315\"></CanonicalizationMethod>\n    <SignatureMethod\nAlgorithm=\"http://www.w3.org/2000/09/xmldsig#rsa-sha1\"></SignatureMethod>\n    <Reference URI=\"http://www.w3.org/TR/xml-stylesheet\">\n      <DigestMethod\nAlgorithm=\"http://www.w3.org/2000/09/xmldsig#sha1\"></DigestMethod>\n      <DigestValue>60NvZvtdTB+7UnlLp/H24p7h4bs=</DigestValue>\n    </Reference>\n  </SignedInfo>\n\nNote that xmlns=\"\" has been omitted from the CanonicalizationMethod element.\nThis is correct in the context of the subtree prior to adding doc level\nnamespaces to the subtree root (i.e. <SignedInfo> vs <SignedInfo \nxmlns=\"http://www.w3.org/2000/09/xmldsig#\">), but is incorrect following the\naddition of the doc level namespace.\n\nThe following code reproduces bug:\n\npackage org.apache.xml.security.samples.canonicalization;\n\nimport java.io.ByteArrayInputStream;\nimport javax.xml.parsers.DocumentBuilder;\nimport javax.xml.parsers.DocumentBuilderFactory;\nimport org.apache.xml.security.c14n.Canonicalizer;\nimport org.apache.xml.security.utils.Constants;\nimport org.apache.xml.security.utils.XMLUtils;\nimport org.apache.xpath.XPathAPI;\nimport org.w3c.dom.Document;\nimport org.w3c.dom.Element;\nimport org.w3c.dom.Node;\n\n/**\n *\n *  <at> author Christian Geuer-Pollmann\n */\npublic class CanonSubTree {\n   //J-\n   static String input = \"\"\n      + \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n\"\n      + \"<Signature xmlns=\\\"http://www.w3.org/2000/09/xmldsig#\\\">\\n\"\n      + \"  <SignedInfo><!-- comment inside -->\\n\"\n      + \"    <CanonicalizationMethod xmlns=\\\"\\\"\nAlgorithm=\\\"http://www.w3.org/TR/2001/REC-xml-c14n-20010315\\\" />\\n\"\n      + \"    <SignatureMethod\nAlgorithm=\\\"http://www.w3.org/2000/09/xmldsig#rsa-sha1\\\" />\\n\"\n      + \"    <Reference URI=\\\"http://www.w3.org/TR/xml-stylesheet\\\">\\n\"\n      + \"      <DigestMethod\nAlgorithm=\\\"http://www.w3.org/2000/09/xmldsig#sha1\\\" />\\n\"\n      + \"      <DigestValue>60NvZvtdTB+7UnlLp/H24p7h4bs=</DigestValue>\\n\"\n      + \"    </Reference>\\n\"\n      + \"  </SignedInfo>\\n\"\n      + \"  <SignatureValue>\\n\"\n      + \"    fKMmy9GYF2s8rLFrZdVugTOFuWx19ccX7jh5HqFd4vMOY7LWAj52ykjSdvtW3fNY\\n\"\n      + \"    PPYGC4MFL19oPSId5GEsMtFMpGXB3XaCtoKjMCHQsN3+kom8YnGf7Ge1JNRcGty5\\n\"\n      + \"    0UsoP6Asj47+QR7QECT64uoziha4WRDVyXjDrg24W+U=\\n\"\n      + \"  </SignatureValue>\\n\"\n      + \"  <KeyInfo>\\n\"\n      + \"    <KeyName>Lugh</KeyName>\\n\"\n      + \"  </KeyInfo>\\n\"\n      + \"</Signature>\\n\"\n      ;\n   //J+\n\n   /**\n    * Method main\n    *\n    *  <at> param args\n    *  <at> throws Exception\n    */\n   public static void main(String args[]) throws Exception {\n      org.apache.xml.security.Init.init();\n\n      DocumentBuilderFactory dfactory = DocumentBuilderFactory.newInstance();\n\n      dfactory.setNamespaceAware(true);\n      dfactory.setValidating(true);\n\n      DocumentBuilder documentBuilder = dfactory.newDocumentBuilder();\n\n      // this is to throw away all validation warnings\n      documentBuilder\n         .setErrorHandler(new org.apache.xml.security.utils\n            .IgnoreAllErrorHandler());\n\n      byte inputBytes[] = input.getBytes();\n      Document doc =\n         documentBuilder.parse(new ByteArrayInputStream(inputBytes));\n      Canonicalizer c14n =\n         Canonicalizer\n            .getInstance(\"http://www.w3.org/TR/2001/REC-xml-c14n-20010315\");\n      Element nscontext = XMLUtils.createDSctx(doc, \"ds\",\nConstants.SignatureSpecNS);\n\n      Node signedInfo = XPathAPI.selectSingleNode(doc, \"//ds:SignedInfo\",\n                                                  nscontext);\n      byte outputBytes[] = c14n.canonicalizeSubtree(signedInfo);\n\n      if (outputBytes != null) {\n         System.out.println(new String(outputBytes));\n      }\n   }\n}", "id": 91231, "time": "2006-07-12T20:24:58Z", "creator": "bob@directdocs.com", "creation_time": "2006-07-12T20:24:58Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 40032, "text": "This bug happens only subtree c14n with no xpath transformation.\nAnd the xmlns namespace binding to a non empty value happens before the subtree\nand it is redefined back to empty(\"\").\n\nAdding one line in getUnrenderedNodes fix this bug. It is fixed in SVN head.\n\nThanks for finding it.", "id": 91338, "time": "2006-07-16T10:12:50Z", "creator": "raul-info@r-bg.com", "creation_time": "2006-07-16T10:12:50Z", "is_private": false, "attachment_id": null}, {"count": 2, "attachment_id": null, "creator": "raul-info@r-bg.com", "is_private": false, "id": 91965, "time": "2006-08-06T17:41:35Z", "bug_id": 40032, "creation_time": "2006-08-06T17:41:35Z", "tags": [], "text": "Closing old bugs."}]