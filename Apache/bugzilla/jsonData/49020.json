[{"count": 0, "tags": [], "creator": "paulsp@apache.org", "attachment_id": null, "text": "I am get the exception below thrown when reading in some .xlsm files\ninto POI v3.6 WorkbookFactory.create(fileInputStream). The files open without\nerror in Excel 2007 and OpenOffice 2.3.  I have other .xlsm files that\nwork as expected in POI v3.6.\n\nThe source of the error is in xi/drawings/vmlDrawing1.vml. A user created button has a 2 line title.  The lines are separated by a <BR>, thus the reason for the exception.  Below is an excerpt from vmlDrawing1.vml\n\n<v:shape id=\"_x0000_s2060\" type=\"#_x0000_t201\" style='position:absolute;\nmargin-left:554.25pt;margin-top:78.75pt;width:205.5pt;height:50.25pt;\nz-index:1;mso-wrap-style:tight' o:button=\"t\" fillcolor=\"buttonFace [67]\"\nstrokecolor=\"windowText [64]\" o:insetmode=\"auto\">\n<v:fill color2=\"buttonFace [67]\" o:detectmouseclick=\"t\"/>\n<o:lock v:ext=\"edit\" rotation=\"t\"/>\n<v:textbox o:singleclick=\"f\">\n <div style='text-align:center'><font face=\"Arial\" size=\"280\" color=\"10\"><b>Print\n Entire <br>\n    Data Set</b></font></div>\n</v:textbox>\n<x:ClientData ObjectType=\"Button\">\n <x:Anchor>\n  10, 8, 5, 1, 13, 66, 7, 36</x:Anchor>\n <x:PrintObject>False</x:PrintObject>\n <x:AutoFill>False</x:AutoFill>\n <x:FmlaMacro>[0]!Module1.print_entire_data_set</x:FmlaMacro>\n <x:TextHAlign>Center</x:TextHAlign>\n <x:TextVAlign>Center</x:TextVAlign>\n</x:ClientData>\n</v:shape>\n\n\nFYI: I downgrades POI to 3.5-FINAL and the workbook loaded without errors.", "id": 135776, "time": "2010-03-29T21:10:28Z", "bug_id": 49020, "creation_time": "2010-03-29T21:10:28Z", "is_private": false}, {"count": 1, "tags": [], "creator": "paulsp@apache.org", "attachment_id": 25214, "text": "Created attachment 25214\nSpreadsheet contains one button with a multi-line title", "id": 135791, "time": "2010-03-30T18:00:42Z", "bug_id": 49020, "creation_time": "2010-03-30T18:00:42Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 49020, "text": "I updated the priority to P1 since the bug is preventing the use of version 3.6 and since the bug is related to the normal use of non-XML compliant HTML tags in the workbook.", "id": 135792, "time": "2010-03-30T18:05:46Z", "creator": "paulsp@apache.org", "creation_time": "2010-03-30T18:05:46Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 49020, "attachment_id": null, "id": 135812, "time": "2010-03-31T11:14:53Z", "creator": "apache@gagravarr.org", "creation_time": "2010-03-31T11:14:53Z", "is_private": false, "text": "The bug is really with Excel here - it has generated a file with invalid XML. The xlsx file is defined as being made up of XML subparts, and the XML spec is very very strict on matching tags.\n\nFor the long term, you should report a bug to Microsoft about this. They either need to sanitise the user input and sort out the tags (eg <br> becomes <br />), or they need to give up and escape the whole tag contents for the bits where iffy data could get added (eg put this textbox within a CDATA section)\n\nShort term, you could just comment out the code that reads in the vmlDrawing section of the file, and ensure that you don't touch the drawing records\n\nMedium term, we should get a list of the problem bits that Excel does wrong, such as <br> (but perhaps others). Then, we need to write a XML Input Wrapper that cleans these up before they get passed to the XML Processor for loading. Something like this is quite nasty, though it's possible some other project out there has already done it, and we can just re-use what they do."}, {"count": 4, "tags": [], "bug_id": 49020, "attachment_id": null, "id": 136669, "time": "2010-05-05T13:51:23Z", "creator": "apache@gagravarr.org", "creation_time": "2010-05-05T13:51:23Z", "is_private": false, "text": "EvilUnclosedBRFixingInputStream added in r941399.\n\nIt's a terrifying sick workaround.... But does allow your file to be loaded\n\nProper fix is to get Microsoft to make Excel output valid xml though!"}]