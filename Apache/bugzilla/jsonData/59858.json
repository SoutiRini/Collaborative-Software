[{"count": 0, "tags": [], "bug_id": 59858, "is_private": false, "text": "I am getting a NullPointerException when trying to extract the macro VBA from a particular Excel file.\n\nI am using org.apache.poi.poifs.macros.VBAMacroReader\n\nThe following code consistently reproduces the NullPointerException:\n\nFile file = new File(\"npe_example.xls\");\nVBAMacroReader reader = new VBAMacroReader(file);\nMap<String, String> macros = reader.readMacros();\n\nI have attached the file which causes the error.", "id": 192378, "time": "2016-07-14T15:23:56Z", "creator": "brooke@usinternet.com", "creation_time": "2016-07-14T15:23:56Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 59858, "attachment_id": 34038, "text": "Created attachment 34038\nExample xls that causes readMacros() to throw a NullPointerException", "id": 192379, "time": "2016-07-14T15:27:40Z", "creator": "brooke@usinternet.com", "creation_time": "2016-07-14T15:27:40Z", "is_private": false}, {"count": 2, "tags": [], "creator": "brooke@usinternet.com", "attachment_id": 34039, "text": "Created attachment 34039\nThe results of running org.apache.poi.poifs.dev.POIFSDump.main on the problem document.", "id": 192380, "time": "2016-07-14T15:28:21Z", "bug_id": 59858, "creation_time": "2016-07-14T15:28:21Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 59858, "attachment_id": null, "id": 192381, "time": "2016-07-14T15:29:37Z", "creator": "onealj@apache.org", "creation_time": "2016-07-14T15:29:37Z", "is_private": false, "text": "Could you provide a stack trace?"}, {"count": 4, "tags": [], "bug_id": 59858, "attachment_id": null, "id": 192382, "time": "2016-07-14T15:31:49Z", "creator": "brooke@usinternet.com", "creation_time": "2016-07-14T15:31:49Z", "is_private": false, "text": "Here is the stack trace:\n\nException in thread \"main\" java.lang.NullPointerException\n\tat org.apache.poi.poifs.macros.VBAMacroReader.readMacros(VBAMacroReader.java:258)\n\tat org.apache.poi.poifs.macros.VBAMacroReader.findMacros(VBAMacroReader.java:148)\n\tat org.apache.poi.poifs.macros.VBAMacroReader.findMacros(VBAMacroReader.java:153)\n\tat org.apache.poi.poifs.macros.VBAMacroReader.findMacros(VBAMacroReader.java:153)\n\tat org.apache.poi.poifs.macros.VBAMacroReader.findMacros(VBAMacroReader.java:153)\n\tat org.apache.poi.poifs.macros.VBAMacroReader.readMacros(VBAMacroReader.java:115)\n\tat poitester.POITester.main(POITester.java:39)"}, {"count": 5, "tags": [], "bug_id": 59858, "attachment_id": null, "id": 192383, "time": "2016-07-14T15:46:11Z", "creator": "onealj@apache.org", "creation_time": "2016-07-14T15:46:11Z", "is_private": false, "text": "A module offset was not set before trying to read the stream.\nhttps://svn.apache.org/viewvc/poi/trunk/src/java/org/apache/poi/poifs/macros/VBAMacroReader.java?revision=1738674&view=markup#l258"}, {"count": 6, "tags": [], "bug_id": 59858, "is_private": false, "text": "Added unit test that reproduces the problem in r1752776.", "id": 192389, "time": "2016-07-15T05:29:13Z", "creator": "onealj@apache.org", "creation_time": "2016-07-15T05:29:13Z", "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 59858, "text": "Replaced NullPointerException with IOException with an error message of the name of the module that the VBAMacroReader failed to read in r1752778.", "id": 192391, "time": "2016-07-15T06:13:36Z", "creator": "onealj@apache.org", "creation_time": "2016-07-15T06:13:36Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "tallison@mitre.org", "is_private": false, "text": "This file has two _VBA_PROJECT_CUR directories; both have Sheet1, Sheet2 and Sheet3 and thisWorkbook.  The _VBA_PROJECT_CUR under MDB00082648 has only empty (zero-byte) Sheet1, etc.; whereas the _VBA_PROJECT_CUR under root has meaningful content.\n\nWe are keying only off the name of the stream (e.g. \"Sheet2\") in our module map.  This means that we're overwriting (or skipping) the other \"Sheet2\".\n\nFor now, I propose checking if the module.buf is null.  If it is, then we expect an offset and we can read go about reading it.\n\nLonger term, we might consider a way to prevent overwriting/skipping of streams with the same module name?\n\nPerhaps this is what is meant by \"TODO Refactor this to fetch dir then do the rest\"?", "id": 194503, "time": "2016-10-18T16:31:33Z", "bug_id": 59858, "creation_time": "2016-10-18T16:31:33Z", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 59858, "attachment_id": null, "is_private": false, "id": 194507, "time": "2016-10-18T16:44:30Z", "creator": "tallison@mitre.org", "creation_time": "2016-10-18T16:44:30Z", "text": "r1765479\n\nFor now, I've added a check to see if we've already read the module with that name."}]