[{"count": 0, "tags": [], "creator": "yonyang@cisco.com", "attachment_id": null, "is_private": false, "id": 151617, "time": "2011-11-18T08:16:47Z", "bug_id": 52207, "creation_time": "2011-11-18T08:16:47Z", "text": "URL: http://aaa.bbb.com under Load Balance, apache is running both 80 and 1701 ports.\nWe have the redirect rule: RedirectMatch ^/[\\/]?$ /redirect/redirect? and we expect to get: http://aaa.bbb.com/redirect/redirect?\nHowever it actually gives back: http://aaa.bbb.com:1701/redirect/redirect?\n1701 is the real server port and it should not show up here.\n\nAfter workaround in different apache version, we found the issue can be replicated in 2.2.12 and above versions. We also found the issue is in modules/mapper/mod_alias.c and we located at the following codes:\n            if (ret[0] == '/') {\n\n                ret = ap_construct_url(r->pool, ret, r);\n                ap_log_rerror(APLOG_MARK, APLOG_DEBUG, 0, r,\n                              \"incomplete redirection target of '%s' for \"\n                              \"URI '%s' modified to '%s'\",\n                              orig_target, r->uri, ret);\n            }\n\nIf we remove this code and recompile apache, apache 2.2.12 or above versions will work in our environment.\nI don't know why others do not report the issue, but we are using Cisco ACE as a load balancer, and we know current version 2.0.59 works well. \n\nHere is the list we tested:\n\nWorks                   2.0.59 (in use) \nWorks                   2.0.64 \nWorks                   2.2.3\nWorks                   2.2.11\nIssue                     2.2.12 (need mod_alias.c update, verified)\nIssue                     2.2.13 (need mod_alias.c update)\nIssue                     2.2.15 (need mod_alias.c update)\nIssue                     2.2.19 (need mod_alias.c update)\nIssue                     2.2.21 (need mod_alias.c update, verified)\nIssue                     2.3.15 (need mod_alias.c update)\n\nPlease help on this special case and we want to know:\n1.) what the exactly reason we have these pieces of code? what use case?\n2.) is it an apache redirection issue or ACE has issue in forwarding?\n3.) if it is actually a bug, can we fix it in next release?\n\nThanks a lot!\n\n--Vincent"}, {"count": 1, "tags": [], "creator": "nick@webthing.com", "attachment_id": null, "is_private": false, "id": 151618, "time": "2011-11-18T09:14:28Z", "bug_id": 52207, "creation_time": "2011-11-18T09:14:28Z", "text": "Since you've discovered which version changed, you can look in CHANGES to see exactly what changed.  In this case it's a bug fix, from earlier behaviour that was in violation of HTTP.\n\nYou appear to have a configuration problem, possibly concerning your canonical hostname.  If you have trouble fixing it, the users list (and other support channels) are there to help.  A bug report might arise out of that process, but this isn't it."}, {"count": 2, "tags": [], "text": "Hi\n\nCHANGES only show:\n  *) mod_alias: check sanity in Redirect arguments.\n     PR 44729 [S\u00c3\u00b6nke Tesch <st kino-fahrplan.de>, Jim Jagielski]\nhttps://issues.apache.org/bugzilla/show_bug.cgi?id=44729\n\n  *) mod_alias: Ensure Redirect emits HTTP-compliant URLs.\n     PR 44020\nhttps://issues.apache.org/bugzilla/show_bug.cgi?id=44020 \n\nHowever this does not help us, we don't know why a normal vip:80/443 to realip:1701 and also a normal redirectmatch \"RedirectMatch ^/[\\/]?$ /dispatcher/dispatcher.do?\" can cause problem after version 2.2.12\n\nTo make the issue more clear, I attached a document to present the logic flow and our issue \"fix\" by comment out one of the function in the source code of mod_alias.c\n\nThanks\nVincent", "is_private": false, "bug_id": 52207, "id": 151641, "time": "2011-11-18T23:38:26Z", "creator": "yonyang@cisco.com", "creation_time": "2011-11-18T23:38:26Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 52207, "attachment_id": 27971, "text": "Created attachment 27971\nLogic flow\n\nThe logic flow document and the issue fix.", "id": 151642, "time": "2011-11-18T23:39:10Z", "creator": "yonyang@cisco.com", "creation_time": "2011-11-18T23:39:10Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 52207, "attachment_id": null, "id": 151644, "time": "2011-11-19T00:23:56Z", "creator": "covener@gmail.com", "creation_time": "2011-11-19T00:23:56Z", "is_private": false, "text": "What's the value of usecanonicalphysicalport?\n\nWhat does the vhost serving this request look like?\n\nWhat's the host header on the request (log %{host}i)"}, {"count": 5, "tags": [], "creator": "wrowe@apache.org", "attachment_id": null, "id": 151646, "time": "2011-11-19T01:47:33Z", "bug_id": 52207, "creation_time": "2011-11-19T01:47:33Z", "is_private": false, "text": "Also, what is the ServerName of the host?  That is its canonical name."}, {"count": 6, "tags": [], "bug_id": 52207, "attachment_id": null, "text": "Here is the vHost information:\nNameVirtualHost *:1701\n<VirtualHost *:1701>\n WebLogicHost [tomcat-ip]\n WebLogicPort 80\n ConnectTimeoutSecs 10\n ConnectRetrySecs 5\n #FileCaching OFF \n MatchExpression *.do\n MatchExpression *.jsp\n MatchExpression *.php\n MatchExpression *.asp\n MatchExpression *.wbx\n MatchExpression *Servlet*\n MatchExpression *Servlet/*\n MatchExpression sendmail\n MatchExpression TestService\n ErrorLog \"|/usr/sbin/rotatelogs /var/httplogs/errorlog_xxx_port1701 86400\"\n CustomLog \"|/usr/sbin/rotatelogs /var/httplogs/accesslog_xxx_port1701 86400\" combined\n Include /www/conf/rewrite.httpd\n</VirtualHost>\n\n\nHere is the ServerName and part of httpd.conf configuration:\nServerName is comment out.\n\n#ServerName new.host.name:80\nServerRoot \"/etc/httpd\"\nDocumentRoot \"/www/htdocs\"\nListen 80\nListen 1701\nUser apache\nGroup apache\n\nServerAdmin root@localhost", "id": 151647, "time": "2011-11-19T02:30:51Z", "creator": "yonyang@cisco.com", "creation_time": "2011-11-19T02:30:51Z", "is_private": false}, {"count": 7, "tags": [], "creator": "wrowe@apache.org", "attachment_id": null, "is_private": false, "id": 151648, "time": "2011-11-19T02:52:38Z", "bug_id": 52207, "creation_time": "2011-11-19T02:52:38Z", "text": "\"ServerName is comment out.\"\n\nWell, duh.\n\nNext time pay attention when a bug is closed on you as INVALID and follow\nthe advise they offer.  C.f. Nick's gracious reply in comment #2."}, {"count": 8, "tags": [], "text": "We added ServerName and it does not have any affect on the issue.\nServerName web-apache.corp.com:80 and tried ServerName web-apache's ip\n\nThe weird thing is it works in prior to 2.2.12 version, we tested it on 2.2.11, 2.2.3, 2.0.64 and 2.0.59 and all works with same configuration file.\n\nThanks.", "is_private": false, "bug_id": 52207, "id": 151649, "time": "2011-11-19T03:17:27Z", "creator": "yonyang@cisco.com", "creation_time": "2011-11-19T03:17:27Z", "attachment_id": null}, {"count": 9, "tags": [], "text": "If you want the port in the ServerName to override the port in the host header, set UseCanonicalName to On.", "is_private": false, "bug_id": 52207, "id": 151650, "time": "2011-11-19T03:51:21Z", "creator": "covener@gmail.com", "creation_time": "2011-11-19T03:51:21Z", "attachment_id": null}, {"count": 10, "tags": [], "creator": "yonyang@cisco.com", "attachment_id": null, "is_private": false, "id": 151651, "time": "2011-11-19T04:57:26Z", "bug_id": 52207, "creation_time": "2011-11-19T04:57:26Z", "text": "Actually we don't want to use ServerName override the port defined in vhost.\n\nWe have 20 ports listening on apache from 1701 - 1720.\nWe use different VIPs configured in load balance to point different apache ports.\nThese different VIPs are for different customers.\n\nAs I am not a system architecture of our service, I may not exactly present the whole architecture level, but here is an example:\n\ncust.corp.com \n    -CNAME- {LoadBalance 64.xx.xx.8} \n    -LB- {VIP- 64.xx.xx.34:80, 64.xx.xx.34:443} \n    -LB-WS- {Apache- 64.xx.xx.181:1701, 64.xx.xx.181:1702} \n    -vhost- {Tomcat- 64.xx.xx.185:2001, 64.xx.xx.185:2003}\n\nThanks,"}, {"count": 11, "tags": [], "creator": "wrowe@apache.org", "attachment_id": null, "is_private": false, "id": 151652, "time": "2011-11-19T05:23:22Z", "bug_id": 52207, "creation_time": "2011-11-19T05:23:22Z", "text": "If you set ServerName web-apache.corp.com:80, and had not set CanonicalName off,\nand the redirect resulted in http://web-apache.corp.com:1701/redirect/redirect\nthen this is indeed a bug."}, {"count": 12, "tags": [], "text": "Thanks all for your posts.\nAfter setting the ServerName and enable UseCanonicalName.\nServerName webserver.corp.com:80\nUseCanonicalName On\n\nthe url will have this redirection:\nhttp://cust.corp.com --> http://websvr.corp.com:1701/dispatcher/dispatcher.do?\n\nthis is not what we want, we don't want to present the actual websvr ip or domain name in the url as it should be hidden inside of load balance. I mean we want this kind of redirection:\nhttp://cust.corp.com --> http://cust.corp.com/dispatcher/dispatcher.do?\nand this is exactly what version before 2.2.12 does and works.", "is_private": false, "bug_id": 52207, "id": 151653, "time": "2011-11-19T05:27:33Z", "creator": "yonyang@cisco.com", "creation_time": "2011-11-19T05:27:33Z", "attachment_id": null}, {"count": 13, "tags": [], "bug_id": 52207, "attachment_id": null, "id": 151656, "creation_time": "2011-11-19T20:15:38Z", "time": "2011-11-19T20:15:38Z", "creator": "wrowe@apache.org", "text": "Stupid question, but if you move the statement\n  ServerName webserver.corp.com:80\ninto your <VirtualHost > block (as all documentation and tutorials insist\nthat you)... does this correct the behavior?", "is_private": false}]