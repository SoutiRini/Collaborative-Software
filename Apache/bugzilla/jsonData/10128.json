[{"count": 0, "tags": [], "bug_id": 10128, "attachment_id": null, "text": "Reported to the old bug database for 1.3.23 this bug is happily alive and has\nbeen ignored with the usual Apache arrogance as all other bugs I did report\n(/dev/null is definitely more responsive):\n\nWhen using mod_proxy and a cache try the following:\n\n1. Empty the cache of mod_proxy\n2. Retrieve http://alles.quoka.de/ with some client via the proxy, e.g. use\n   curl -i -x <apache-proxy-address-and-port> http://alles.quoka.de/\n3. Repeat 2 as long as you wish. You will get an empty document.\n\nThe prerequisite for this to happen is that the remote server sets a\n\"Cache-Control: no-cache\" header. When mod_proxy then does validate\nthe cache contents on a subsequent request the remote server sends a 304\nreponse with a content length of 0 to mod_proxy which in turn happily stores\nthe \"new and improved\" body information to the cache\n\nFor those not understanding what's going on here's the (truncated) output\nof the first page retrieval:\n\nast@castor:~ > curl -i -x zeus.lan.domdv.de:8080 http://alles.quoka.de/\nHTTP/1.1 200 OK\nDate: Fri, 21 Jun 2002 11:31:45 GMT\nServer: Microsoft-IIS/4.0\nCache-Control: no-cache\nExpires: Fri, 21 Jun 2002 11:19:40 GMT\nContent-Location: http://alles.quoka.de/index.html\nContent-Type: text/html\nAccept-Ranges: bytes\nLast-Modified: Tue, 28 May 2002 14:34:31 GMT\nETag: \"822c9dc7546c21:1d495\"\nContent-Length: 19143\nX-Cache: MISS from host001-server-1.lan.domdv.de\n\n<HTML>\n<head>\n[snip]\n\nNow we do a subsequent request for the same page (not truncated, mod_proxy\ndoes this for us):\n\nast@castor:~ > curl -i -x zeus.lan.domdv.de:8080 http://alles.quoka.de/\nHTTP/1.1 200 OK\nDate: Fri, 21 Jun 2002 11:31:53 GMT\nServer: Microsoft-IIS/4.0\nContent-Type: text/html\nAccept-Ranges: bytes\nLast-Modified: Tue, 28 May 2002 14:34:31 GMT\nCache-Control: no-cache\nExpires: Fri, 21 Jun 2002 11:19:48 GMT\nContent-Location: http://alles.quoka.de/index.html\nETag: \"822c9dc7546c21:1d495\"\nContent-Length: 0\nX-Cache: HIT from host001-server-1.lan.domdv.de (with revalidation)\n\nast@castor:~ >\n\n\nCute, isn't it. So to DoS an Apache mod_proxy installation you only need\nto include \"Cache-Control: no-cache\" in the headers and you won't be bothered\nby these itty gritty installations anymore.\n\nNow for these preferring to read network traces here's a dump (truncated)\nof the same story:\n\n0x0000   4500 0102 0569 4000 4006 d85c 5084 73b4        E....i@.@..\\P.s.\n0x0010   d9ed be0a 09a1 0050 73a1 2311 1339 a2b6        .......Ps.#..9..\n0x0020   5018 16b0 26ee 0000 4745 5420 2f20 4854        P...&...GET./.HT\n0x0030   5450 2f31 2e31 0d0a 486f 7374 3a20 616c        TP/1.1..Host:.al\n0x0040   6c65 732e 7175 6f6b 612e 6465 0d0a 4163        les.quoka.de..Ac\n0x0050   6365 7074 3a20 696d 6167 652f 6769 662c        cept:.image/gif,\n0x0060   2069 6d61 6765 2f78 2d78 6269 746d 6170        .image/x-xbitmap\n0x0070   2c20 696d 6167 652f 6a70 6567 2c20 696d        ,.image/jpeg,.im\n0x0080   6167 652f 706a 7065 672c 202a 2f2a 0d0a        age/pjpeg,.*/*..\n0x0090   5072 6167 6d61 3a20 6e6f 2d63 6163 6865        Pragma:.no-cache\n0x00a0   0d0a 5573 6572 2d41 6765 6e74 3a20 6375        ..User-Agent:.cu\n0x00b0   726c 2f37 2e39 2e35 2028 6936 3836 2d70        rl/7.9.5.(i686-p\n0x00c0   632d 6c69 6e75 782d 676e 7529 206c 6962        c-linux-gnu).lib\n0x00d0   6375 726c 2037 2e39 2e35 2028 4f70 656e        curl.7.9.5.(Open\n0x00e0   5353 4c20 302e 392e 3662 290d 0a43 6f6e        SSL.0.9.6b)..Con\n0x00f0   6e65 6374 696f 6e3a 2063 6c6f 7365 0d0a        nection:.close..\n\n\n0x0000   4500 05d4 c02e 4000 7b06 ddc4 d9ed be0a        E.....@.{.......\n0x0010   5084 73b4 0050 09a1 1339 a2b6 73a1 23eb        P.s..P...9..s.#.\n0x0020   5010 212e a598 0000 4854 5450 2f31 2e31        P.!.....HTTP/1.1\n0x0030   2032 3030 204f 4b0d 0a53 6572 7665 723a        .200.OK..Server:\n0x0040   204d 6963 726f 736f 6674 2d49 4953 2f34        .Microsoft-IIS/4\n0x0050   2e30 0d0a 4361 6368 652d 436f 6e74 726f        .0..Cache-Contro\n0x0060   6c3a 206e 6f2d 6361 6368 650d 0a45 7870        l:.no-cache..Exp\n0x0070   6972 6573 3a20 4672 692c 2032 3120 4a75        ires:.Fri,.21.Ju\n0x0080   6e20 3230 3032 2031 313a 3533 3a32 3220        n.2002.11:53:22.\n0x0090   474d 540d 0a43 6f6e 6e65 6374 696f 6e3a        GMT..Connection:\n0x00a0   2063 6c6f 7365 0d0a 436f 6e74 656e 742d        .close..Content-\n0x00b0   4c6f 6361 7469 6f6e 3a20 6874 7470 3a2f        Location:.http:/\n0x00c0   2f61 6c6c 6573 2e71 756f 6b61 2e64 652f        /alles.quoka.de/\n0x00d0   696e 6465 782e 6874 6d6c 0d0a 4461 7465        index.html..Date\n0x00e0   3a20 4672 692c 2032 3120 4a75 6e20 3230        :.Fri,.21.Jun.20\n0x00f0   3032 2031 313a 3533 3a32 3220 474d 540d        02.11:53:22.GMT.\n0x0100   0a43 6f6e 7465 6e74 2d54 7970 653a 2074        .Content-Type:.t\n0x0110   6578 742f 6874 6d6c 0d0a 4163 6365 7074        ext/html..Accept\n0x0120   2d52 616e 6765 733a 2062 7974 6573 0d0a        -Ranges:.bytes..\n0x0130   4c61 7374 2d4d 6f64 6966 6965 643a 2054        Last-Modified:.T\n0x0140   7565 2c20 3238 204d 6179 2032 3030 3220        ue,.28.May.2002.\n0x0150   3134 3a33 343a 3331 2047 4d54 0d0a 4554        14:34:31.GMT..ET\n0x0160   6167 3a20 2238 3232 6339 6463 3735 3436        ag:.\"822c9dc7546\n0x0170   6332 313a 3164 3439 3522 0d0a 436f 6e74        c21:1d495\"..Cont\n0x0180   656e 742d 4c65 6e67 7468 3a20 3139 3134        ent-Length:.1914\n0x0190   330d 0a0d 0a3c 4854 4d4c 3e0a 3c68 6561        3....<HTML>.<hea\n0x01a0   643e 0a3c 212d 2d20 456e 7477 6963 6b6c        d>.<!--.Entwickl\n\nAnd the subsequent request...\n\n0x0000   4500 015b 81ea 4000 4006 5b82 5084 73b4        E..[..@.@.[.P.s.\n0x0010   d9ed be0a 09a2 0050 7b65 d25b 134b 5aaa        .......P{e.[.KZ.\n0x0020   5018 16b0 6b05 0000 4745 5420 2f20 4854        P...k...GET./.HT\n0x0030   5450 2f31 2e31 0d0a 486f 7374 3a20 616c        TP/1.1..Host:.al\n0x0040   6c65 732e 7175 6f6b 612e 6465 0d0a 4163        les.quoka.de..Ac\n0x0050   6365 7074 3a20 696d 6167 652f 6769 662c        cept:.image/gif,\n0x0060   2069 6d61 6765 2f78 2d78 6269 746d 6170        .image/x-xbitmap\n0x0070   2c20 696d 6167 652f 6a70 6567 2c20 696d        ,.image/jpeg,.im\n0x0080   6167 652f 706a 7065 672c 202a 2f2a 0d0a        age/pjpeg,.*/*..\n0x0090   5072 6167 6d61 3a20 6e6f 2d63 6163 6865        Pragma:.no-cache\n0x00a0   0d0a 5573 6572 2d41 6765 6e74 3a20 6375        ..User-Agent:.cu\n0x00b0   726c 2f37 2e39 2e35 2028 6936 3836 2d70        rl/7.9.5.(i686-p\n0x00c0   632d 6c69 6e75 782d 676e 7529 206c 6962        c-linux-gnu).lib\n0x00d0   6375 726c 2037 2e39 2e35 2028 4f70 656e        curl.7.9.5.(Open\n0x00e0   5353 4c20 302e 392e 3662 290d 0a49 662d        SSL.0.9.6b)..If-\n0x00f0   4d6f 6469 6669 6564 2d53 696e 6365 3a20        Modified-Since:.\n0x0100   5475 652c 2032 3820 4d61 7920 3230 3032        Tue,.28.May.2002\n0x0110   2031 343a 3334 3a33 3120 474d 540d 0a49        .14:34:31.GMT..I\n0x0120   662d 4e6f 6e65 2d4d 6174 6368 3a20 2238        f-None-Match:.\"8\n0x0130   3232 6339 6463 3735 3436 6332 313a 3164        22c9dc7546c21:1d\n0x0140   3439 3522 0d0a 436f 6e6e 6563 7469 6f6e        495\"..Connection\n0x0150   3a20 636c 6f73 650d 0a0d 0a                    :.close....\n\n\n0x0000   4500 013e 3579 4000 7b06 6d10 d9ed be0a        E..>5y@.{.m.....\n0x0010   5084 73b4 0050 09a2 134b 5aaa 7b65 d38e        P.s..P...KZ.{e..\n0x0020   5018 20d5 d9a9 0000 4854 5450 2f31 2e31        P.......HTTP/1.1\n0x0030   2033 3034 204e 6f74 204d 6f64 6966 6965        .304.Not.Modifie\n0x0040   640d 0a53 6572 7665 723a 204d 6963 726f        d..Server:.Micro\n0x0050   736f 6674 2d49 4953 2f34 2e30 0d0a 4461        soft-IIS/4.0..Da\n0x0060   7465 3a20 4672 692c 2032 3120 4a75 6e20        te:.Fri,.21.Jun.\n0x0070   3230 3032 2031 313a 3535 3a31 3820 474d        2002.11:55:18.GM\n0x0080   540d 0a43 6163 6865 2d43 6f6e 7472 6f6c        T..Cache-Control\n0x0090   3a20 6e6f 2d63 6163 6865 0d0a 4578 7069        :.no-cache..Expi\n0x00a0   7265 733a 2046 7269 2c20 3231 204a 756e        res:.Fri,.21.Jun\n0x00b0   2032 3030 3220 3131 3a35 353a 3138 2047        .2002.11:55:18.G\n0x00c0   4d54 0d0a 436f 6e6e 6563 7469 6f6e 3a20        MT..Connection:.\n0x00d0   636c 6f73 650d 0a43 6f6e 7465 6e74 2d4c        close..Content-L\n0x00e0   6f63 6174 696f 6e3a 2068 7474 703a 2f2f        ocation:.http://\n0x00f0   616c 6c65 732e 7175 6f6b 612e 6465 2f69        alles.quoka.de/i\n0x0100   6e64 6578 2e68 746d 6c0d 0a45 5461 673a        ndex.html..ETag:\n0x0110   2022 3832 3263 3964 6337 3534 3663 3231        .\"822c9dc7546c21\n0x0120   3a31 6434 3935 220d 0a43 6f6e 7465 6e74        :1d495\"..Content\n0x0130   2d4c 656e 6774 683a 2030 0d0a 0d0a             -Length:.0....\n\n\nWell, this is a sooo difficult to understand problem that no Apache developer\nwas able to handle it since 1.3.23. Unfortunately there's a security problem\nso user's cannot use the working 1.3.22 anymore.\n\nI just don't understand the ignorance and arrogance of the Apache team. It\ntook \"little me\" about 4 hours to come up with some solution and this required\ncode analysis from scratch. The \"mighty and glory\" apache team did come up\nwith nothing but /dev/null for months. I wonder...\n\nOh, \"little me\" has a job to do and doesn't usually have the time for\ncode analysis, this was just an emergency reaction due to /dev/null a.k.a.\nbugzilla.\n\nNevertheless, for all those who are bitten by the same problem here's a\nworking fix. Not beautiful, not glory Apache style, possibly not portable\nbut at least working on Linux/IA32 which is better than hot air by the\napache team:\n\n--- apache_1.3.26/src/modules/proxy/proxy_http.c        Tue Jun 18 02:59:59\n2002+++ apache_1.3.26-fixed/src/modules/proxy/proxy_http.c  Fri Jun 21 16:00:37\n2002@@ -517,7 +517,19 @@\n\n         content_length = ap_table_get(resp_hdrs, \"Content-Length\");\n         if (content_length != NULL) {\n+#if 1\n+            off_t tmp = ap_strtol(content_length, NULL, 10);\n+            if (r->status == HTTP_NOT_MODIFIED && tmp == 0 && c->len != -1) {\n+                unsigned char clen[32];\n+                sprintf(clen,\"%ld\",c->len);\n+                ap_table_unset(resp_hdrs, \"Content-Length\");\n+                ap_table_add(resp_hdrs, \"Content-Length\", clen);\n+            }\n+            else\n+               c->len = tmp;\n+#else\n             c->len = ap_strtol(content_length, NULL, 10);\n+#endif\n         }\n\n         /* Now add out bound headers set by other modules */", "id": 18330, "time": "2002-06-21T15:34:28Z", "creator": "ast@domdv.de", "creation_time": "2002-06-21T15:34:28Z", "is_private": false}, {"count": 1, "tags": [], "creator": "trawick@apache.org", "is_private": false, "text": "Thanks for your report, especially for the patch.  I hope the code issue is \nresolved shortly.\n\nI'm really sorry about the hard feelings you have regarding Apache developers\nand the Apache development process, particularly with regard to problem \nreports.  I suspect that you may have unrealistic expectations about how Apache \nis developed.  We are all volunteers here, doing the best we can.  It is \nfrustrating to follow these bug reports, many of which are for build problems \non machines that have screwy tool setups that we could never hope to \nduplicate.  Still more are from people who never respond to requests to test \npatches or submit more information for diagnosis.  And yet many PRs are \nresolved on a regular basis.  I'm quite sure that the delay\nin handling your PR was due to a lack of appropriate knowledge among those \npeople who volunteer to follow the PRs and attempt to help the user community \nthrough this channel.  In many instances, the person encountering the problem \nknows much more about it than we humble souls following the PRs.  In cases like \nthis, the best way for the person encountering the problem to make progress is \nto discuss the issue on one of the mailing lists or newsgroups and try to find \nsomeone with the right skills to get involved.\n\nAlternatively, there are various companies and perhaps individuals who are \nwilling to provide more tangible support for Apache or web servers based \ndirectly on Apache.  In case it is important to you, part of what you get when \nyou mail them the check is the ability to berate them until they fix whatever \nproblem you are encountering.  \n\nAnd as you have discovered, you are certainly empowered to work out a problem \nyourself without involving any third parties.  No Apache developer would deny \nthe fact that a great number of issues are resolved, with fixes contributed, by \nthe end users themselves.  The important \"product\" we produce, extending beyond \na particular piece of downloadable software, is a framework for people to \ncontribute towards its continual improvement.  Such contributions are well-\ndocumented in the CHANGES files and are what makes Apache a reasonable solution \nfor many people.\n", "id": 18340, "time": "2002-06-21T16:13:10Z", "bug_id": 10128, "creation_time": "2002-06-21T16:13:10Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 10128, "attachment_id": 2687, "text": "Created attachment 2687\nAnother patch", "id": 20931, "time": "2002-08-12T20:09:34Z", "creator": "paul.terry@gmx.net", "creation_time": "2002-08-12T20:09:34Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 10128, "text": "*** Bug 12223 has been marked as a duplicate of this bug. ***", "id": 22127, "time": "2002-09-02T15:27:00Z", "creator": "slive@apache.org", "creation_time": "2002-09-02T15:27:00Z", "is_private": false, "attachment_id": null}]