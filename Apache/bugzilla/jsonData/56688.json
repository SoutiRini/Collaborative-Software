[{"count": 0, "attachment_id": null, "creator": "kirill.frolov77@gmail.com", "is_private": false, "id": 176130, "time": "2014-07-01T11:38:14Z", "bug_id": 56688, "creation_time": "2014-07-01T11:38:14Z", "tags": [], "text": "It is obviously missing check for named reference before cast in EDate.java.\n\n\nHere is the stacktrace\n\nCaused by: java.lang.ClassCastException: org.apache.poi.ss.formula.LazyRefEval cannot be cast to org.apache.poi.ss.formula.eval.NumberEval\n\tat org.apache.poi.ss.formula.functions.EDate.evaluate(EDate.java:39)\n\tat org.apache.poi.ss.formula.UserDefinedFunction.evaluate(UserDefinedFunction.java:64)\n\tat org.apache.poi.ss.formula.OperationEvaluatorFactory.evaluate(OperationEvaluatorFactory.java:129)\n\tat org.apache.poi.ss.formula.WorkbookEvaluator.evaluateFormula(WorkbookEvaluator.java:525)\n\tat org.apache.poi.ss.formula.WorkbookEvaluator.evaluateAny(WorkbookEvaluator.java:288)\n\tat org.apache.poi.ss.formula.WorkbookEvaluator.evaluate(WorkbookEvaluator.java:230)\n\tat org.apache.poi.xssf.usermodel.XSSFFormulaEvaluator.evaluateFormulaCellValue(XSSFFormulaEvaluator.java:264)\n\tat org.apache.poi.xssf.usermodel.XSSFFormulaEvaluator.evaluateFormulaCell(XSSFFormulaEvaluator.java:151)\n\tat org.apache.poi.hssf.usermodel.HSSFFormulaEvaluator.evaluateAllFormulaCells(HSSFFormulaEvaluator.java:324)\n\tat org.apache.poi.hssf.usermodel.HSSFFormulaEvaluator.evaluateAllFormulaCells(HSSFFormulaEvaluator.java:315)\n\tat org.apache.poi.xssf.usermodel.XSSFFormulaEvaluator.evaluateAll(XSSFFormulaEvaluator.java:252)\n<< omitted >>\n\nI believe that substituting \n\n\t\t\tNumberEval offsetInYearsValue = (NumberEval) args[1];\n\nwith\n\n\t\t\tif (args[1] instanceof RefEval) {\n\t\t\t\targs[1] = ((RefEval) args[1]).getInnerValueEval();\n\t\t\t}\n\t\t\tNumberEval offsetInYearsValue = (NumberEval) args[1];\n\n\nresolves the issue"}, {"count": 1, "text": "Any chance of a small unit test that demonstrates the problem? We can then use that to test the fix, and to ensure it stays fixed into the future!", "bug_id": 56688, "attachment_id": null, "id": 176133, "time": "2014-07-01T14:12:05Z", "creator": "apache@gagravarr.org", "creation_time": "2014-07-01T14:12:05Z", "tags": [], "is_private": false}, {"count": 2, "text": "Created attachment 31784\nEDate type test 1\n\nEDate should return 0", "bug_id": 56688, "is_private": false, "id": 176195, "time": "2014-07-03T15:22:02Z", "creator": "kirill.frolov77@gmail.com", "creation_time": "2014-07-03T15:22:02Z", "tags": [], "attachment_id": 31784}, {"count": 3, "attachment_id": 31785, "creator": "kirill.frolov77@gmail.com", "is_private": false, "id": 176196, "time": "2014-07-03T15:22:54Z", "bug_id": 56688, "creation_time": "2014-07-03T15:22:54Z", "tags": [], "text": "Created attachment 31785\nEDate type test 2\n\nEDate should return #VALUE"}, {"count": 4, "attachment_id": 31786, "creator": "kirill.frolov77@gmail.com", "is_private": false, "id": 176197, "time": "2014-07-03T15:23:26Z", "bug_id": 56688, "creation_time": "2014-07-03T15:23:26Z", "tags": [], "text": "Created attachment 31786\nEDate type test 3\n\nEDate should return #VALUE"}, {"count": 5, "attachment_id": 31787, "creator": "kirill.frolov77@gmail.com", "is_private": false, "id": 176198, "time": "2014-07-03T15:24:23Z", "bug_id": 56688, "creation_time": "2014-07-03T15:24:23Z", "tags": [], "text": "Created attachment 31787\nEDate type test 4\n\nEDate should return today() + 1 month but now it throws an exception"}, {"count": 6, "text": "Code to reproduce exceptions:\npublic class Test {\n\n\tpublic static void main(String[] args) {\n\t\ttry {\n\t\t\tFileInputStream is = new FileInputStream(\"edate_test1.xlsx\");\n\t\t\tXSSFWorkbook excel = new XSSFWorkbook(is);\n\t\t\tis.close();\n\t\t\tXSSFFormulaEvaluator evaluator = new XSSFFormulaEvaluator(excel);\n\t\t\tevaluator.evaluateAll();\n\t\t\tSystem.out.println(\"OK\");\n\t\t} catch (Exception e) {\n\t\t\te.printStackTrace();\n\t\t}\n\t}\n}", "bug_id": 56688, "is_private": false, "id": 176199, "time": "2014-07-03T15:25:10Z", "creator": "kirill.frolov77@gmail.com", "creation_time": "2014-07-03T15:25:10Z", "tags": [], "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 56688, "attachment_id": null, "id": 176591, "time": "2014-07-22T12:33:58Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2014-07-22T12:33:58Z", "is_private": false, "text": "I have fixed this as far as possible in r1612557, however the case with blank cells does not work in POI currently because of the way dates below \"1\" are handled. \n\nCurrently POI sees these dates as invalid and thus always returns -1.0 as value from DateUtil methods, so this is what the emtpy-case results in. \n\nChanging this would have side-effects in other places, so I kept it this way for now."}]