[{"count": 0, "attachment_id": 28707, "bug_id": 53176, "text": "Created attachment 28707\nThe attachment have the auto shape that is not coming properly after rending using the pptx2png tool\n\nI am converting the few PPTX slides to images. few of the slides having the multiple auto shapes (some are custom drawing shapes). all the shapes are not rendering properly.\nI have attached one image for understanding the problem.\nhttp://apache-poi.1045710.n5.nabble.com/file/n5679512/problem.png\n\nIs there any limitation on auto shapes rendering. \nBased on the feed back I am raising the bug, please review and let me know what could be the issue?\n\nI am using the poi-3.8-beta5 version jar files.", "id": 158735, "time": "2012-05-02T10:52:40Z", "creator": "mdbhaskar@gmail.com", "creation_time": "2012-05-02T10:52:40Z", "tags": [], "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 53176, "text": "Please attach the .pptx file.", "id": 158736, "time": "2012-05-02T11:10:45Z", "creator": "yegor@dinom.ru", "creation_time": "2012-05-02T11:10:45Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "creator": "mdbhaskar@gmail.com", "is_private": false, "text": "Created attachment 28716\nSample pptx file\n\nPlease find attached problematic pptx file. Please let me know what could be the issue?", "id": 158786, "time": "2012-05-03T14:17:35Z", "bug_id": 53176, "creation_time": "2012-05-03T14:17:35Z", "attachment_id": 28716}, {"count": 3, "tags": [], "bug_id": 53176, "attachment_id": null, "text": "I have attached requested sample problematic file. It is one of the severe blocker in my current development project. Could you please provide us the solution, it is very much helpful to development?", "id": 158868, "time": "2012-05-07T04:06:53Z", "creator": "mdbhaskar@gmail.com", "creation_time": "2012-05-07T04:06:53Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 53176, "text": "(In reply to comment #3)\n> It is one of the severe blocker in my current development project. Could you please provide us the solution, it is very much helpful to development?\n\nApache POI is, like all Apache projects, a volunteer project. We do try to fix all the bugs we can do, but the priorities are set by the people willing to put the time in to do the work!\n\nIf this bug is important to you, there are two main options. \n\nThe first is to work on it yourself! If you want to go down this round, please join the dev list, and people will do their best to guide you and give advice on the general area. The second option is pay someone (either via a support contract, or some consultancy) to work on the problem urgently. Otherwise, it will be fixed when volunteer time permits, which depending on the complexity of the issue and how it affects those who are willing to work on it, may be some time...", "id": 158934, "time": "2012-05-09T17:40:19Z", "creator": "apache@gagravarr.org", "creation_time": "2012-05-09T17:40:19Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 53176, "attachment_id": 30902, "text": "Created attachment 30902\n[patch] Bug 53176 - scale to bounding box after/in XSLFShape.applyTransform\n\nWhen shapes are rotated their bounding box wasn't resized to the specified anchor.\nI have to admit, that it seems to be a bit clumsy to use the graphics-transform to calculate the scaling, but at least it eventually worked ...\nI haven't added a test-case, as I don't know how to check for that certain geometrical feature.", "id": 170398, "time": "2013-10-02T22:01:33Z", "creator": "kiwiwings@apache.org", "creation_time": "2013-10-02T22:01:33Z", "is_private": false}, {"count": 6, "tags": [], "creator": "kiwiwings@apache.org", "is_private": false, "text": "Comment on attachment 30902\n[patch] Bug 53176 - scale to bounding box after/in XSLFShape.applyTransform\n\nThis patch doesn't work as intended. The transformation is applied twice and it only works for the bug example, because its rotated 90\u00b0. When you use other values for the rotation, the rendering differs between libre office and office viewer. In LO its somehow skewed whereas in office viewer, the scaling depends on the quadrant of the circle, i.e. for degrees 0-45\u00b0 it won't be scaled, for deg. 46-135\u00b0 the height of the bounding box will be scaled to the width and vice versa ...\nI hopefully supply a different patch soon ...", "id": 170459, "time": "2013-10-06T23:26:40Z", "bug_id": 53176, "creation_time": "2013-10-06T23:26:40Z", "attachment_id": 30902}, {"count": 7, "tags": [], "creator": "kiwiwings@apache.org", "text": "Comment on attachment 30902\n[patch] Bug 53176 - scale to bounding box after/in XSLFShape.applyTransform\n\nIndex: src/ooxml/java/org/apache/poi/xslf/usermodel/XSLFShape.java\n===================================================================\n--- src/ooxml/java/org/apache/poi/xslf/usermodel/XSLFShape.java\t(revision 1529677)\n+++ src/ooxml/java/org/apache/poi/xslf/usermodel/XSLFShape.java\t(working copy)\n@@ -141,11 +141,42 @@\n         double rotation = getRotation();\n         if (rotation != 0.) {\n             // PowerPoint rotates shapes relative to the geometric center\n-            double centerX = anchor.getX() + anchor.getWidth() / 2;\n-            double centerY = anchor.getY() + anchor.getHeight() / 2;\n+            double centerX = anchor.getCenterX();\n+            double centerY = anchor.getCenterY();\n \n+            // normalize rotation\n+            rotation = (360.+(rotation%360.))%360.;\n+            int quadrant = (((int)rotation+45)/90)%4;\n+            double scaleX = 1.0, scaleY = 1.0;\n+\n+            // scale to bounding box (bug #53176)\n+            if (quadrant == 1 || quadrant == 3) {\n+                // In quadrant 1 and 3, which is basically a shape in a more or less portrait orientation (45\u00b0-135\u00b0 and 225\u00b0-315\u00b0),\n+                // we need to first rotate the shape by a multiple of 90\u00b0 and then resize the bounding box  \n+                // to its original bbox. After that we can rotate the shape to the exact rotation amount.\n+                // It's strange that you'll need to rotate the shape back and forth again, but you can\n+                // think of it, as if you paint the shape on a canvas. First you rotate the canvas, which might\n+                // be already (differently) scaled, so you can paint the shape in its default orientation\n+                // and later on, turn it around again to compare it with its original size ...\n+                AffineTransform txg = new AffineTransform(); // graphics coordinate space\n+                AffineTransform txs = new AffineTransform(tx); // shape coordinate space\n+                txg.translate(centerX, centerY);\n+                txg.rotate(Math.toRadians(quadrant*90));\n+                txg.translate(-centerX, -centerY);\n+                txs.translate(centerX, centerY);\n+                txs.rotate(Math.toRadians(-quadrant*90));\n+                txs.translate(-centerX, -centerY);\n+                txg.concatenate(txs);\n+                Rectangle2D anchor2 = txg.createTransformedShape(getAnchor()).getBounds2D();\n+                scaleX = anchor.getWidth() == 0. ? 1.0 : anchor.getWidth() / anchor2.getWidth();\n+                scaleY = anchor.getHeight() == 0. ? 1.0 : anchor.getHeight() / anchor2.getHeight();\n+            }\n+\n+            // transformation is applied reversed ...\n             graphics.translate(centerX, centerY);\n-            graphics.rotate(Math.toRadians(rotation));\n+            graphics.rotate(Math.toRadians(rotation-(double)(quadrant*90)));\n+            graphics.scale(scaleX, scaleY);\n+            graphics.rotate(Math.toRadians(quadrant*90));\n             graphics.translate(-centerX, -centerY);\n         }", "id": 170554, "time": "2013-10-10T20:15:28Z", "bug_id": 53176, "creation_time": "2013-10-10T20:15:28Z", "is_private": false, "attachment_id": 30902}, {"count": 8, "tags": [], "bug_id": 53176, "attachment_id": 30919, "text": "Created attachment 30919\n[patch] Bug 53176 - scale to bounding box after/in XSLFShape.applyTransform II\n\nfixed version ... sorry for the double posting (see above), but for a moment it looked like I could edit the existing attachment ..", "id": 170555, "time": "2013-10-10T20:19:16Z", "creator": "kiwiwings@apache.org", "creation_time": "2013-10-10T20:19:16Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 53176, "is_private": false, "text": "A very good patch, Andreas! Applied in r1540290. \n\nI suspect there may be similar rendering issues in the future when we will need to tweak the transformation matrix. When I was writing the pptx rendering engine I tried to cover *most* of the base cases such as rotation and flipping but you never know it for sure with graphics :) \n\nRegards,\nYegor", "id": 171156, "time": "2013-11-09T11:46:08Z", "creator": "yegor@dinom.ru", "creation_time": "2013-11-09T11:46:08Z", "attachment_id": null}]