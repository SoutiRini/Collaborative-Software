[{"count": 0, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": 25070, "is_private": false, "id": 134962, "time": "2010-03-01T09:01:25Z", "bug_id": 48831, "creation_time": "2010-03-01T09:01:25Z", "text": "Created attachment 25070\n2010-03-01_tc7_logging_testing.patch\n\nThis is a result of testing that I performed for our current trunk to evaluate r910974 that is currently proposed for TC6.\n\nI will first describe my environment. Results and findings will follow below.\n\nSteps to reproduce:\n1. With current trunk as of revision 917296 apply the patch that I am attaching to this issue, and build it. The patch:\n- adds logging to FileHandler#close().\nThe logging statement checks that this.writer != null, to do not try logging on a closed handler (thus reopening it).\n- sets bufferSize for catalina and localhost handlers\n- marks ClassLoaderLogManager#useShutdownHook as volatile\n\n2. Clear the logs folder.\n3. Run \"catalina.bat start\", wait a while and run \"catalina.bat stop\".\n\nLogs that I'll attach are the result of the above steps.\n\nOS: WindowsXP/SP3, JRE: Sun JRE 6u18"}, {"count": 1, "tags": [], "text": "Created attachment 25071\ncatalina.2010-03-01.log", "is_private": false, "bug_id": 48831, "id": 134963, "time": "2010-03-01T09:03:26Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2010-03-01T09:03:26Z", "attachment_id": 25071}, {"count": 2, "tags": [], "bug_id": 48831, "text": "Created attachment 25072\nlocalhost.2010-03-01.log", "id": 134964, "time": "2010-03-01T09:04:14Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2010-03-01T09:04:14Z", "is_private": false, "attachment_id": 25072}, {"count": 3, "tags": [], "text": "1. The two first \"Closing FileHandler\" messages in catalina.log apparently originate from \"catalina.bat stop\" run.\n\nI added thread.hashCode() to the messages to catch that, but I now see that it can be demonstrated clearly by running the shutdown command with a different logging configuration (e.g. from a separate CATALINA_BASE).\n\n\n2. The same instance of FileHandler is attached to several Loggers.  When calling ClassLoaderLogManager#resetLogger() or LogManager#resetLogger() we have a loop on loggers, each of them closes all handlers that it is attached to. Thus the same handler is closed many times in a row. \n\nThere may be several consequences to that, but one is a clear bug:\n- when undeploying a web application\norg.apache.catalina.loader.WebappClassLoader.clearReferences\ncloses not only web application loggers, but through them also the handler that write to catalina.log and localhost.log and are shared between applications.\n\nThe above issue can be seen from attached localhost.log. The logger is closed twice (note that an instance of PrintWriter is different each time).\n\nIt still works because JULI FileHandler#closeWriter() sets FileHandler#date = \"\", and subsequent call to FileHandler#publish() will check the date value and reopen the logger.  There is a certain time span in FileHandler#closeWriter() between nulling this.writer and resetting this.date and thus some messages might be lost in-between.\n\n\n3. In proposed r910974:\nnote, that Catalina#stop() calls getRuntime().removeShutdownHook(..)\nIn that case I suppose we should call\nClassLoaderLogManager.setUseShutdownHook(true);\nto re-enable ClassLoaderLogManager.shutdown(),  or call shutdown() explicitly.\n\nI was not able to observe side effects from this issue, because, as seen from the logs, LogManager.Cleaner still runs at shutdown and closes the LogHandler for \"catalina.log\". Thus, no data loss occurred. But I think there will be circumstances when it'll be observed.\n\nIt can be seen that in case of \"catalina.bat stop\" LogManager.Cleaner and ClassLoaderLogManager.Cleaner run in parallel (the first two messages in \"catalina.log\"). \n\n4. I think that ClassLoaderLogManager#useShutdownHook has to be volatile. Otherwise I think ClassLoaderLogManager.Cleaner thread is likely not to see changes to its value. Though there is no proof. (ClassLoaderLogManager.shutdown() mentioned in the logs is from \"catalina.bat stop\" run).", "is_private": false, "bug_id": 48831, "id": 134966, "time": "2010-03-01T09:56:24Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2010-03-01T09:56:24Z", "attachment_id": null}, {"count": 4, "tags": [], "creator": "markt@apache.org", "is_private": false, "id": 135022, "attachment_id": null, "bug_id": 48831, "creation_time": "2010-03-03T17:28:18Z", "time": "2010-03-03T17:28:18Z", "text": "Issues fixed in trunk."}, {"attachment_id": null, "tags": [], "creator": "knst.kolinko@gmail.com", "text": "All issues listed in Comment 3 were fixed in 6.0.x in revision 919742.\nWill be in 6.0.26 onwards.\nChanging 'Product' from Tomcat 7 to Tomcat 6.", "count": 5, "id": 135101, "time": "2010-03-06T11:21:26Z", "bug_id": 48831, "creation_time": "2010-03-06T11:21:26Z", "is_private": false}]