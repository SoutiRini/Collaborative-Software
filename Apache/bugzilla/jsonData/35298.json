[{"attachment_id": null, "tags": [], "creator": "Tim.Whittington@orionhealth.com", "text": "The current JK/ISAPI redirector uses 4 special headers to pass redirector\ninformation from the FilterProc to the ExtensionProc.\n\nThese are cleared in the FilterProc prior to attempting a match on the incoming URL.\nSince IIS passes requests through all the filters, any JK/ISAPI redirector in\nthe ISAPI Filters stack that is below the matching redirector will cause the\nheaders to be cleared and the request to fail.\n\nA common deployment scenario for our products is to use a single web customer\nwebsite (running on port 80) with multiple virtual directories and ISAPI\nredirectors - one for each product in the deployed solution.\nI'm aware that the mod_jk config is geared towards a single redirectory with a\nsingle config file, but even our Apache sites use multiple virtual hosts with\nseparate mod_jk configs.\n\nIt's not immediately obvious if there's actually a benefit in clearing the headers.\nIf someone wanted to spoof these, then they could talk directly to the\nExtensionProc anyway, and you can ensure they're set correctly just by being\ncareful in the FilterProc.\n\nThe offending lines in jk_isapi_plugin.c r1.49, lines 749..755\n\n        /*\n         * Just in case somebody set these headers in the request!\n         */\n        SetHeader(pfc, URI_HEADER_NAME, NULL);\n        SetHeader(pfc, QUERY_HEADER_NAME, NULL);\n        SetHeader(pfc, WORKER_HEADER_NAME, NULL);\n        SetHeader(pfc, TOMCAT_TRANSLATE_HEADER_NAME, NULL);\n\nWe've used two solutions to this successfully in internal builds:\n 1. Don't clear the headers\n 2. Unique URI_HEADER_NAME et al during the redirector load i.e. using the\nextension_uri or the DLL process ID.", "count": 0, "id": 76235, "time": "2005-06-09T23:01:44Z", "bug_id": 35298, "creation_time": "2005-06-09T23:01:44Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 35298, "text": "Isapi filter is supposed to have a Highest level and be the first filter\nin the ISAPI filter chain.", "id": 76938, "time": "2005-07-03T10:47:54Z", "creator": "mturk@apache.org", "creation_time": "2005-07-03T10:47:54Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 35298, "attachment_id": null, "is_private": false, "id": 76956, "time": "2005-07-03T23:31:17Z", "creator": "Tim.Whittington@orionhealth.com", "creation_time": "2005-07-03T23:31:17Z", "text": "The problem I've noted is that you can't have multiple Tomcat ISAPI redirectors\non a single IIS site, not the order or priority.\n\nThis is a practice that we use a lot, to avoid having to merge multiple\nredirector configs when installing multiple products on a single server.\nThis isn't an issue for mod_jk, as it's a simple include, but IIS as usual\nrequires you to do a lot of the work yourself.\n\nThis is a fairly minor thing to work around in the redirector, and I'd be happy\nto contribute a patch to do it.\n\nIf it's absolutely not a possibility for the main branch, then we can maintain\nour own, but I think it's a feature worthy of inclusion in the core Jakarta tree."}, {"count": 3, "tags": [], "bug_id": 35298, "attachment_id": 15583, "is_private": false, "id": 76958, "time": "2005-07-04T00:48:42Z", "creator": "Tim.Whittington@orionhealth.com", "creation_time": "2005-07-04T00:48:42Z", "text": "Created attachment 15583\nMultiple redirectors per IIS Website\n\nThis patch uniques the headers used by the redirector to pass information\nbetween FilterProc and ExtensionProc by mixing in the DLL handle."}, {"attachment_id": null, "tags": [], "creator": "mturk@apache.org", "text": "Commited. Thanks!", "count": 4, "id": 79803, "time": "2005-09-12T15:46:28Z", "bug_id": 35298, "creation_time": "2005-09-12T15:46:28Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 35298, "is_private": false, "text": "I've reviewed this again, and there's still a problem or two.\n\nThe main one is that there's a magic tmp += 6 in init_ws_service which is meant\nto skip the TOMCAT bit of the header name to leave TRANSLATE in the buffer to be\nused as the HTTP header name. Generating the headers as we do now will break\nthis. I've reworked it to make it obvious what is happening.\n\nIn the process of fixing this, I also tidied a bit of the header handling and\nrejigged the HTTP_ header generation to share a prefix with the code in\ninit_ws_service.", "id": 80245, "time": "2005-09-21T04:01:34Z", "creator": "Tim.Whittington@orionhealth.com", "creation_time": "2005-09-21T04:01:34Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 35298, "is_private": false, "text": "Created attachment 16478\nFixes for Tomcat Header Handling\n\nPatch against jk_isapi_redirect.c r1.53 to fix problems introduced by uniquing\nTOMCAT headers + a few tidies of the header handling code.", "id": 80246, "time": "2005-09-21T04:03:19Z", "creator": "Tim.Whittington@orionhealth.com", "creation_time": "2005-09-21T04:03:19Z", "attachment_id": 16478}, {"count": 7, "tags": [], "bug_id": 35298, "attachment_id": null, "is_private": false, "id": 80251, "time": "2005-09-21T07:57:50Z", "creator": "mturk@apache.org", "creation_time": "2005-09-21T07:57:50Z", "text": "Hi,\n\nCan you create a patch that fixes the problem with Translate only.\nAlthough I agree that your changes make sense the number of changes\nis big and unrelated to the problem itself.\nYou might then create a second patch that will have fixed sizes\ninstead strlen, etc...\n\n"}, {"count": 8, "tags": [], "bug_id": 35298, "is_private": false, "text": "Created attachment 16484\nFixes for Tomcat Header Handling (Minimal)\n\nRedone patch to fix only the TRANSLATE header handling bug.", "id": 80285, "time": "2005-09-21T23:25:59Z", "creator": "Tim.Whittington@orionhealth.com", "creation_time": "2005-09-21T23:25:59Z", "attachment_id": 16484}, {"attachment_id": null, "tags": [], "creator": "mturk@apache.org", "text": "Commited a second patch. Thanks.\nThe full patch is syntatic sugar, so we'll keep that for the future.", "count": 9, "id": 80354, "time": "2005-09-23T08:57:03Z", "bug_id": 35298, "creation_time": "2005-09-23T08:57:03Z", "is_private": false}]