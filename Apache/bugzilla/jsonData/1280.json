[{"count": 0, "tags": [], "bug_id": 1280, "is_private": false, "text": "There is a serious threading bug in Jasper which causes\nit to violate the Servlet spec for JSP page servlets.\nThe bug is that a JSP page servlet can have its service\nmethod called before its init method has completed.\nThis bug is more likely to appear if the init method\ntakes a long time or the given page is getting a lot\nof hits. The bug is present in Tomcat 3.2.2b2 (seen in\npractise) and Tomcat 3.2.2b3 (by code inspection).\n\nConsider that a page which is unloaded gets two hits\nin rapid succession.  The first thread gets to\nJspServlet.load(116), then is switched out.  The second\nthread also gets to JspServlet.load(116), then is\nswitched out.  These threads are inside the\nsame JspServletWrapper.\n\nThe first thread runs again, allocates the servlet, and\ncalls init. During the init, the second thread runs,\nand replaces the theServlet member variable inside\nthe JspServletWrapper with a new servlet.\n\nBUG: when the first thread returns from the init() call,\nit will fall out to JspServlet.service(117) and call\nservice *on the second servlet*, which is not inited.\n\nTo patch, some synchronization is necessary to assure\nthat the theServlet member is not replaced while an\ninit() is in process.  I think it may be sufficient to\nmake JspServletWrapper.load() synchronized.\n\nLine numbers are relative to 3.2.2b3.", "id": 1813, "time": "2001-04-09T21:40:28Z", "creator": "pogo_tomcat@yahoo.com", "creation_time": "2001-04-09T21:40:28Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "pogo_tomcat@yahoo.com", "text": "My suggested fix won't work.  A safer fix that should do the trick is to ensure \nthat no Servlet is placed into the theServlet member variable of \nJspServletWrapper until it is inited.  This is easily achieved by using a local \nvariable and only assigning to theServlet at the end of the function \nJspServletWrapper.load().", "id": 1828, "time": "2001-04-10T10:01:37Z", "bug_id": 1280, "creation_time": "2001-04-10T10:01:37Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 1280, "attachment_id": null, "id": 2104, "time": "2001-04-25T16:33:41Z", "creator": "marc.saegesser@apropos.com", "creation_time": "2001-04-25T16:33:41Z", "is_private": false, "text": "This is fixed in 3.2.2 and will appear in 3.2.2 beta 4.  The fix still needs to\nbe applied to Tomcat 3.3 and 4.0.\n"}, {"attachment_id": null, "tags": [], "bug_id": 1280, "text": "Reopen to change resolution", "count": 3, "id": 6616, "time": "2001-10-12T06:33:54Z", "creator": "Larry.Isaacs@sas.com", "creation_time": "2001-10-12T06:33:54Z", "is_private": false}, {"count": 4, "tags": [], "text": "The changes have been ported to the JspServlet in Tomcat 3.3.  Note however,\nthat Tomcat 3.3 doesn't use JspServlet by default.  Instead JspInterceptor\nuses Jasper to translate the JSP page and then compiles the Java file into\na servlet.  This servlet is handled just like all other servlets without\nusing JspServlet as a wrapper.", "is_private": false, "bug_id": 1280, "id": 6617, "time": "2001-10-12T06:37:57Z", "creator": "Larry.Isaacs@sas.com", "creation_time": "2001-10-12T06:37:57Z", "attachment_id": null}]