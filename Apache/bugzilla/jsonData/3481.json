[{"count": 0, "tags": [], "creator": "fred@stsci.edu", "text": "I discovered that Tomcat was leaking 15 sockets per 1000 requests when using\nthe webapp connector.  I found the following error in the catalina log file:\n\n2001-09-06 23:02:06 [org.apache.catalina.connector.warp.WarpConnection] Exceptio\nn on socket\njava.io.IOException: Premature packet header end\n        at org.apache.catalina.connector.warp.WarpConnection.recv(WarpConnection\n.java:237)\n        at org.apache.catalina.connector.warp.WarpRequestHandler.handle(WarpRequ\nestHandler.java:110)\n        at org.apache.catalina.connector.warp.WarpConnection.run(WarpConnection.\njava:194)\n        at java.lang.Thread.run(Thread.java:539)\n\nLooking at the code and the process start times, I found that on each\nrun of 1000 requests, 15 of the apache processes had been restarted and\nwas causing this exception to appear in the tomcat log file.  The socket\nleak is caused by the WarpConnection.run() not calling stop() when the\nexception occurs.  Here is a context diff from what is currently in cvs\nthat appears to fix the problem:\n\n*** WarpConnection.java 2001/07/22 20:25:08     1.10\n--- WarpConnection.java 2001/09/07 03:29:05\n***************\n*** 192,200 ****\n              }\n              WarpRequestHandler requestHandler=new WarpRequestHandler();\n              while (requestHandler.handle(this,packet));\n-             this.stop();\n          } catch (IOException e) {\n              logger.log(\"Exception on socket\",e);\n          }\n  \n          if (Constants.DEBUG) logger.debug(\"Connection terminated\");\n--- 192,201 ----\n              }\n              WarpRequestHandler requestHandler=new WarpRequestHandler();\n              while (requestHandler.handle(this,packet));\n          } catch (IOException e) {\n              logger.log(\"Exception on socket\",e);\n+         } finally {\n+             this.stop();\n          }\n  \n          if (Constants.DEBUG) logger.debug(\"Connection terminated\");", "id": 5189, "time": "2001-09-06T20:34:03Z", "bug_id": 3481, "creation_time": "2001-09-06T20:34:03Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 3481, "attachment_id": null, "is_private": false, "id": 5236, "time": "2001-09-07T21:17:09Z", "creator": "pier@betaversion.org", "creation_time": "2001-09-07T21:17:09Z", "text": "Thank you Fred very much for the patch, it will be applied tomorrow (when \nI wake up)."}, {"count": 2, "tags": [], "bug_id": 3481, "attachment_id": null, "is_private": false, "id": 5421, "time": "2001-09-12T09:26:23Z", "creator": "pier@betaversion.org", "creation_time": "2001-09-12T09:26:23Z", "text": "Thank you for your patch... It has been committed to CVS."}]