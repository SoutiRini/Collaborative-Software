[{"count": 0, "tags": [], "bug_id": 50851, "text": "mod_proxy_fcgi in trunk currently sets PATH_INFO, SCRIPT_NAME, and PATH_TRANSLATED incorrectly per RFC 3875 (CGI 1.1).\n\nI am running httpd 2.3.10 with the following mod_proxy_fcgi configuration:\n\nProxyPass /test/ fcgi://127.0.0.1:9000/www/php-ssl/\n\nThe file /www/php-ssl/test.php contains an HTML page with the single PHP statement: echo \"Hello, World!\\n\"\n\n\nWhen an end user requests\n\nhttps://f14dev1.catseye.org/test/hello.php/some/info?foo=bar&rod=moby\n\nmod_proxy_fcgi sends the following environment variables via the FastCGI protocol to php-fpm (built from PHP 5.3.5):\n\nHTTPS=on\nSSL_TLS_SNI=f14dev1.catseye.org\nHTTP_HOST=f14dev1.catseye.org\nHTTP_USER_AGENT=Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.6; en-US; rv:1.9.2.13) Gecko/20101203 Firefox/3.6.13\nHTTP_ACCEPT=text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\nHTTP_ACCEPT_LANGUAGE=en-us,en;q=0.7,ja;q=0.3\nHTTP_ACCEPT_ENCODING=gzip,deflate\nHTTP_ACCEPT_CHARSET=ISO-8859-1,utf-8;q=0.7,*;q=0.7\nHTTP_KEEP_ALIVE=115\nHTTP_CONNECTION=keep-alive\nPATH=/sbin:/usr/sbin:/bin:/usr/bin\nSERVER_SIGNATURE=<address>Apache/2.3.10 (Fedora) Server at <a href=\"mailto:webmaster@catseye.org\">f14dev1.catseye.org</a> Port 443</address>#012\nSERVER_SOFTWARE=Apache/2.3.10 (Fedora)\nSERVER_NAME=f14dev1.catseye.org\nSERVER_ADDR=172.16.168.128\nSERVER_PORT=443\nREMOTE_ADDR=172.16.168.1\nDOCUMENT_ROOT=/www/html-ssl\nSERVER_ADMIN=webmaster@catseye.org\nSCRIPT_FILENAME=proxy:fcgi://127.0.0.1:9000/www/php-ssl/hello.php/some/info\nREMOTE_PORT=50634\nGATEWAY_INTERFACE=CGI/1.1\nSERVER_PROTOCOL=HTTP/1.1\nREQUEST_METHOD=GET\nQUERY_STRING=foo=bar&rod=moby\nREQUEST_URI=/test/hello.php/some/info?foo=bar&rod=moby\nSCRIPT_NAME=/test\nPATH_INFO=/www/php-ssl/hello.php/some/info\nPATH_TRANSLATED=/www/html-ssl/www/php-ssl/hello.php/some/info\n\n\nBut RFC 3875 section 3.3 states:\n\n> From the meta-variables thus generated, a URI, the 'Script-URI', can\n> be constructed.  This MUST have the property that if the client had\n> accessed this URI instead, then the script would have been executed\n> with the same values for the SCRIPT_NAME, PATH_INFO and QUERY_STRING\n> meta-variables. [...]\n>\n> script-URI = <scheme> \"://\" <server-name> \":\" <server-port>\n>              <script-path> <extra-path> \"?\" <query-string>\n>\n> where <scheme> is found from SERVER_PROTOCOL, <server-name>,\n> <server-port> and <query-string> are the values of the respective\n> meta-variables.  The SCRIPT_NAME and PATH_INFO values, URL-encoded\n> with \";\", \"=\" and \"?\"  reserved, give <script-path> and <extra-path>.\n\nApplying this formula to the environment variables, above, yields a script-URI of:\n\nhttps://f14dev1.catseye.org:443/test/www/php-ssl/hello.php/some/info?foo=bar&rod=moby\n\n...which is not correct and will fail to execute the same script with the same values for SCRIPT_NAME and PATH_INFO as required by the RFC.  Instead, it should be:\n\nhttps://f14dev1.catseye.org:443/test/hello.php/some/info?foo=bar&rod=moby\n\nThe current (not RFC compliant) behavior is part of a larger problem that prevents php-fpm's status and ping pages from working when php-fpm is used with mod_proxy_fcgi.  I'd like to address the problem on the httpd side first to make it easier to justify patches to php-fpm (\"httpd does things the way RFC 3875 says, now php-fpm should be fixed to work with it\").\n\n\nAdditional background information:\n\n# /usr/sbin/httpd -V\nServer version: Apache/2.3.10 (Unix)\nServer built:   Mar  1 2011 12:26:00\nServer's Module Magic Number: 20101204:0\nServer loaded:  APR 1.4.2, APR-UTIL 1.3.10\nCompiled using: APR 1.4.2, APR-UTIL 1.3.10\nArchitecture:   64-bit\nServer MPM:     prefork\n  threaded:     no\n    forked:     yes (variable process count)\nServer compiled with....\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"/etc/httpd\"\n -D SUEXEC_BIN=\"/usr/sbin/suexec\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"\n\nphp-fpm from PHP 5.3.5\nFedora 14 (fully patched)\ngcc 4.5.1\n\nhttpd custom built with:\n\n./configure --prefix=/etc/httpd --exec-prefix=/usr --bindir=/usr/bin\n--sbindir=/usr/sbin --mandir=/usr/share/man --libdir=/usr/lib64\n--sysconfdir=/etc/httpd/conf --includedir=/usr/include/httpd\n--libexecdir=/usr/lib64/httpd/modules --datadir=/var/www\n--with-installbuilddir=/usr/lib64/httpd/build --with-mpm=prefork\n--with-apr=/usr --with-apr-util=/usr --enable-suexec --with-suexec\n--with-suexec-caller=apache --with-suexec-docroot=/var/www\n--with-suexec-logfile=/var/log/httpd/suexec.log\n--with-suexec-bin=/usr/sbin/suexec --with-suexec-uidmin=500\n--with-suexec-gidmin=100 --enable-pie --with-pcre --enable-mods-shared=all\n--enable-ssl --with-ssl --enable-distcache --enable-proxy --enable-cache\n--enable-disk-cache --enable-socache-dc --enable-ldap --enable-authnz-ldap\n--enable-cgid --enable-authn-anon --enable-authn-alias --enable-session\n--enable-session-cookie --enable-session-dbd --enable-lua --enable-dav-lock\n--disable-imagemap", "id": 144635, "time": "2011-03-01T15:30:01Z", "creator": "mark@catseye.org", "creation_time": "2011-03-01T15:30:01Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 50851, "attachment_id": 26700, "text": "Created attachment 26700\nPrevent mod_proxy_fcgi from setting PATH_INFO\n\nThe attached patch fixes the problem by removing the code from modules/proxy/mod_proxy_fcgi.c that sets PATH_INFO.  With PATH_INFO not set, server/util_script.c:ap_add_cgi_vars() no longer sets SCRIPT_NAME incorrectly, and it no longer sets PATH_TRANSLATED at all.\n\nThis patch results in the following changes to the environment variables in the original problem description (changes are in a unified diff like format):\n\n-PATH_INFO=/www/php-ssl/hello.php/some/info\n-PATH_TRANSLATED=/www/html-ssl/www/php-ssl/hello.php/some/info\n-SCRIPT_NAME=/test\n+SCRIPT_NAME=/test/hello.php/some/info\n\nThe script-URI constructed according to the instructions in RFC 3875 then becomes:\n\nhttps://f14dev1.catseye.org:443/test/hello.php/some/info?foo=bar&rod=moby\n\n...which is correct.\n\nI believe this to be an acceptable solution to the problem because section 4.1.5 of RFC 3875 says that PATH INFO \"identifies the resource or sub-resource to be returned by the CGI script, and is derived from the portion of the URI path hierarchy following the part that identifies the script itself\".  Since the proxy cannot know what portion of the URI path represents the script, not setting PATH_INFO seems better than setting it to a value that does not meet this definition, especially since \"the server MAY impose restrictions and limitations on what values it permits for PATH_INFO\".\n\n\nThe complete list of environment variables generated after the patch is applied when the user requests\n\nhttps://f14dev1.catseye.org/test/hello.php/some/info?foo=bar&rod=moby\n\nis:\n\nHTTPS=on\nSSL_TLS_SNI=f14dev1.catseye.org\nHTTP_HOST=f14dev1.catseye.org\nHTTP_USER_AGENT=Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.6; en-US; rv:1.9.2.13) Gecko/20101203 Firefox/3.6.13\nHTTP_ACCEPT=text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\nHTTP_ACCEPT_LANGUAGE=en-us,en;q=0.7,ja;q=0.3\nHTTP_ACCEPT_ENCODING=gzip,deflate\nHTTP_ACCEPT_CHARSET=ISO-8859-1,utf-8;q=0.7,*;q=0.7\nHTTP_KEEP_ALIVE=115\nHTTP_CONNECTION=keep-alive\nPATH=/sbin:/usr/sbin:/bin:/usr/bin\nSERVER_SIGNATURE=<address>Apache/2.3.10 (Fedora) Server at <a href=\"mailto:webmaster@catseye.org\">f14dev1.catseye.org</a> Port 443</address>#012\nSERVER_SOFTWARE=Apache/2.3.10 (Fedora)\nSERVER_NAME=f14dev1.catseye.org\nSERVER_ADDR=172.16.168.128\nSERVER_PORT=443\nREMOTE_ADDR=172.16.168.1\nDOCUMENT_ROOT=/www/html-ssl\nSERVER_ADMIN=webmaster@catseye.org\nSCRIPT_FILENAME=proxy:fcgi://127.0.0.1:9000/www/php-ssl/hello.php/some/info\nREMOTE_PORT=50630\nGATEWAY_INTERFACE=CGI/1.1\nSERVER_PROTOCOL=HTTP/1.1\nREQUEST_METHOD=GET\nQUERY_STRING=foo=bar&rod=moby\nREQUEST_URI=/test/hello.php/some/info?foo=bar&rod=moby\nSCRIPT_NAME=/test/hello.php/some/info", "id": 144636, "time": "2011-03-01T15:33:29Z", "creator": "mark@catseye.org", "creation_time": "2011-03-01T15:33:29Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 50851, "text": "Thx for the bug report and the patch. Will review and, if correct, will fold in for 2.3.12...", "id": 144712, "time": "2011-03-03T14:18:31Z", "creator": "jim@apache.org", "creation_time": "2011-03-03T14:18:31Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 50851, "attachment_id": null, "is_private": false, "id": 144713, "time": "2011-03-03T14:23:21Z", "creator": "mark@catseye.org", "creation_time": "2011-03-03T14:23:21Z", "text": "> The current (not RFC compliant) behavior is part\n> of a larger problem that prevents php-fpm's status\n> and ping pages from working when php-fpm is used\n> with mod_proxy_fcgi.\n\nA fix for the larger problem has now been submitted to the PHP developers:\n\nhttp://bugs.php.net/bug.php?id=54152\n\nThe patch to PHP, if accepted, will also resolve\n\nhttps://issues.apache.org/bugzilla/show_bug.cgi?id=48273"}, {"text": "Mark,\n\nWhat happens if proxy-nocanon is set?", "tags": [], "bug_id": 50851, "is_private": false, "count": 4, "id": 144714, "time": "2011-03-03T14:37:58Z", "creator": "jim@apache.org", "creation_time": "2011-03-03T14:37:58Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 50851, "text": "\nThanks for the reply, Jim!  I had indeed overlooked and failed to investigate the ProxyPass nocanon option, so your question was helpful.  The short answer is: \"the requirements of RFC 3875 are still not met\".  Here is the long version of the answer:\n\nWithout the patch applied (stock httpd 2.3.10), and with nocanon set:\n\nProxyPass /test/ fcgi://127.0.0.1:9000/www/php-ssl/ nocanon\n\nthe following changes to the environment variables happen compared to the same situation without nocanon set (changes are in a unified diff like format):\n\n-SCRIPT_FILENAME=proxy:fcgi://127.0.0.1:9000/www/php-ssl/hello.php/some/info\n+SCRIPT_FILENAME=proxy:fcgi://127.0.0.1:9000/www/php-ssl/hello.php/some/info?foo=bar&rod=moby\n-SCRIPT_NAME=/test\n+SCRIPT_NAME=/test/hello.php/some/info\n-PATH_INFO=/www/php-ssl/hello.php/some/info\n+PATH_INFO=/www/php-ssl/hello.php/some/info?foo=bar&rod=moby\n-PATH_TRANSLATED=/www/html-ssl/www/php-ssl/hello.php/some/info\n+PATH_TRANSLATED=/www/html-ssl/www/php-ssl/hello.php/some/info?foo=bar&rod=moby\n\nApplying these changes to the script-URI formula in RFC 3875 gives:\n\nhttps://f14dev1.catseye.org:443/test/hello.php/some/info/www/php-ssl/hello.php/some/info?foo=bar&rod=moby?foo=bar&rod=moby\n\nThis result is better in some ways and worse in other ways than when the \"nocanon\" option is omitted, but it still fails to meet the requirement of the RFC in that if that URL were requested, the script would execute with a different value of PATH_INFO.\n\nAlso, despite these changes, the php-fpm status and ping pages still fail to work.  Let me know if you'd like information about what php-fpm is doing internally with the environment variables in the non-working (stock httpd) versus working (patched httpd) cases; for the sake of this bug report, I've been only including information about RFC 3875 compliance issues.\n\nHere is the complete set of environment variables that result with stock httpd 2.3.10 and the ProxyPass nocanon option set:\n\nHTTPS=on\nSSL_TLS_SNI=f14dev1.catseye.org\nHTTP_HOST=f14dev1.catseye.org\nHTTP_USER_AGENT=Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.6; en-US; rv:1.9.2.\n14) Gecko/20110218 Firefox/3.6.14\nHTTP_ACCEPT=text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\nHTTP_ACCEPT_LANGUAGE=en-us,en;q=0.7,ja;q=0.3\nHTTP_ACCEPT_ENCODING=gzip,deflate\nHTTP_ACCEPT_CHARSET=ISO-8859-1,utf-8;q=0.7,*;q=0.7\nHTTP_KEEP_ALIVE=115\nHTTP_CONNECTION=keep-alive\nPATH=/sbin:/usr/sbin:/bin:/usr/bin\nSERVER_SIGNATURE=<address>Apache/2.3.10 (Fedora) Server at <a href=\"mailto:webma\nster@catseye.org\">f14dev1.catseye.org</a> Port 443</address>#012\nSERVER_SOFTWARE=Apache/2.3.10 (Fedora)\nSERVER_NAME=f14dev1.catseye.org\nSERVER_ADDR=172.16.168.128\nSERVER_PORT=443\nREMOTE_ADDR=172.16.168.1\nDOCUMENT_ROOT=/www/html-ssl\nSERVER_ADMIN=webmaster@catseye.org\nSCRIPT_FILENAME=proxy:fcgi://127.0.0.1:9000/www/php-ssl/hello.php/some/info?foo=\nbar&rod=moby\nREMOTE_PORT=51108\nGATEWAY_INTERFACE=CGI/1.1\nSERVER_PROTOCOL=HTTP/1.1\nREQUEST_METHOD=GET\nQUERY_STRING=foo=bar&rod=moby\nREQUEST_URI=/test/hello.php/some/info?foo=bar&rod=moby\nSCRIPT_NAME=/test/hello.php/some/info\nPATH_INFO=/www/php-ssl/hello.php/some/info?foo=bar&rod=moby\nPATH_TRANSLATED=/www/html-ssl/www/php-ssl/hello.php/some/info?foo=bar&rod=moby\n\n\nI also tested with my patch applied together with the ProxyPass nocanon option turned on.  In this case, the requirements of the RFC are met and the php-fpm status (and presumably ping) page works.  Here is the complete set of environment variables with the patch and nocanon option specified (turning nocanon on and off when the patch is applied affects only whether SCRIPT_FILENAME includes the query string):\n\nHTTPS=on\nSSL_TLS_SNI=f14dev1.catseye.org\nHTTP_HOST=f14dev1.catseye.org\nHTTP_USER_AGENT=Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.6; en-US; rv:1.9.2.\n14) Gecko/20110218 Firefox/3.6.14\nHTTP_ACCEPT=text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\nHTTP_ACCEPT_LANGUAGE=en-us,en;q=0.7,ja;q=0.3\nHTTP_ACCEPT_ENCODING=gzip,deflate\nHTTP_ACCEPT_CHARSET=ISO-8859-1,utf-8;q=0.7,*;q=0.7\nHTTP_KEEP_ALIVE=115\nHTTP_CONNECTION=keep-alive\nPATH=/sbin:/usr/sbin:/bin:/usr/bin\nSERVER_SIGNATURE=<address>Apache/2.3.10 (Fedora) Server at <a href=\"mailto:webma\nster@catseye.org\">f14dev1.catseye.org</a> Port 443</address>#012\nSERVER_SOFTWARE=Apache/2.3.10 (Fedora)\nSERVER_NAME=f14dev1.catseye.org\nSERVER_ADDR=172.16.168.128\nSERVER_PORT=443\nREMOTE_ADDR=172.16.168.1\nDOCUMENT_ROOT=/www/html-ssl\nSERVER_ADMIN=webmaster@catseye.org\nSCRIPT_FILENAME=proxy:fcgi://127.0.0.1:9000/www/php-ssl/hello.php/some/info?foo=\nbar&rod=moby\nREMOTE_PORT=51184\nGATEWAY_INTERFACE=CGI/1.1\nSERVER_PROTOCOL=HTTP/1.1\nREQUEST_METHOD=GET\nQUERY_STRING=foo=bar&rod=moby\nREQUEST_URI=/test/hello.php/some/info?foo=bar&rod=moby\nSCRIPT_NAME=/test/hello.php/some/info\n\n...giving the correct script-URI::\n\nhttps://f14dev1.catseye.org:443/test/hello.php/some/info?foo=bar&rod=moby\n\n\nI apologize for the length of this reply, but I wanted to show that I was thorough, expose any mistakes I may have made for everyone to see, and allow others to compare their results to mine.", "id": 144717, "time": "2011-03-03T15:50:15Z", "creator": "mark@catseye.org", "creation_time": "2011-03-03T15:50:15Z", "is_private": false, "attachment_id": null}, {"text": "Instead of always disabling path_info for the fcgi submodule, it is likely better to make it runtime configurable, ala nocanon.\n\nThe alternative would be to see if mod_fcgid sets it (and its partners) \"correctly\" and emulate that. If you have the time to test that, that would be helpful. In the meantime, I'll work on the 'nopathinfo' patch.", "tags": [], "bug_id": 50851, "is_private": false, "count": 6, "id": 144734, "time": "2011-03-04T10:04:40Z", "creator": "jim@apache.org", "creation_time": "2011-03-04T10:04:40Z", "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 50851, "attachment_id": null, "text": "Hi, Jim,\n\nI just tested mod_fcgid 2.3.6 under httpd 2.3.10:\n\n- with the foo.pl example from the mod_fcgid manual, with FcgidFixPathinfo both on and off\n\n- with the phpinfo.php example form the mod_fcgid manual, running under php-cgi (from PHP 5.3.6RC2), with FcgidFixPathinfo both on and off\n\nIn all four cases, constructing script-URI according to the formula in RFC 3875 gives the correct result.\n\nI also studied the mod_fcgid source code, in particular fcgid_add_cgi_vars() and fcgid_handler().  mod_fcgid creates the SCRIPT_NAME, PATH_INFO, and PATH_TRANSLATED environment variables in the exact same way mod_proxy_fcgi does in an unmodified httpd 2.3.10, by calling:\n\n    ap_add_common_vars(r);\n    ap_add_cgi_vars(r);\n\nThe reason this yields correct results in the case of mod_fcgid and mod_fcgi is because those modules are executing scripts that reside in the filesystem and URI namespace that httpd has access to, and the script name can be determined during the location, directory, and file walks; the PATH_INFO is then the part of the URI immediately after the script name.\n\nHowever, a proxy server that is trying to \"emulate\" a CGI environment (mod_proxy_fcgi, mod_proxy_sapi) is not able to determine what part of the URI is the script name unless it has some insight into the origin server's URI namespace.\n\nWhat about having the PATH_INFO CGI environment off by default for mod_proxy_fcgi, unless the administrator asks httpd to put *something* there, even if it might be wrong?  That is, a \"addpathinfo\" patch as opposed to a \"nopathinfo\" patch?\n\nThanks for all the time you've been spending on this, and I apologize for unexpectedly taking so much of your time.  Please let me know if there is anything else I can research, test, or write.", "id": 144746, "time": "2011-03-04T12:55:27Z", "creator": "mark@catseye.org", "creation_time": "2011-03-04T12:55:27Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 50851, "attachment_id": null, "id": 144747, "time": "2011-03-04T13:32:33Z", "creator": "jim@apache.org", "creation_time": "2011-03-04T13:32:33Z", "is_private": false, "text": "Fixed in Committed r1078089.\n\nNew mod_proxy_fcgi env-var, proxy-fcgi-pathinfo, allows for PATH_INFO to be exposed. Otherwise, it's not."}, {"count": 9, "tags": [], "bug_id": 50851, "text": "Fixed in Committed r1078089.\n\nNew mod_proxy_fcgi env-var, proxy-fcgi-pathinfo, allows for PATH_INFO to be exposed. Otherwise, it's not.", "id": 144749, "time": "2011-03-04T13:33:40Z", "creator": "jim@apache.org", "creation_time": "2011-03-04T13:33:40Z", "is_private": false, "attachment_id": null}, {"text": "Examined the committed diffs, checked out the latest svn trunk, built it, tested.  Everything looks good.  Thanks again for all the help!", "tags": [], "creator": "mark@catseye.org", "attachment_id": null, "count": 10, "id": 144755, "time": "2011-03-04T17:40:23Z", "bug_id": 50851, "creation_time": "2011-03-04T17:40:23Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 50851, "attachment_id": null, "text": "*** Bug 48273 has been marked as a duplicate of this bug. ***", "id": 144878, "time": "2011-03-09T13:24:49Z", "creator": "jim@apache.org", "creation_time": "2011-03-09T13:24:49Z", "is_private": false}]