[{"count": 0, "tags": [], "text": "Since update to Tomcat 8.0.29 we noticed problems in our Struts based application. Some actions in random moments returned 404 errors without any log. The same problem appeared in 8.0.30-33. We analyzed changes made between versions 8.0.28 and 8.0.29 and by adding them one by one we found that the problem is caused by org.apache.catalina.mapper.Mapper and new properties in Context: mapperContextRootRedirectEnabled and mapperDirectoryRedirectEnabled. mappingData.context.getMapper...RedirectEnabled() throws in some situations null pointer exception because mappingData.context in null. \n\nAfter changing code of Mapper.java in Tomcat 8.0.33 and recompiling we confirmed that\nchanges:879c879,883\n<         if(mappingData.wrapper == null && noServletPath) {\n---\n>       if (mappingData.wrapper == null && noServletPath && mappingData.context == null){\n>               log.error(\"Kaboom:  \" + mappingData.toString());\n>       } else {\n>         if(mappingData.wrapper == null && noServletPath &&\n>                 mappingData.context.getMapperContextRootRedirectEnabled()) {\n887a892\n>       }\n1006c1011,1015\n<                 if (file != null && file.isDirectory()) {\n---\n>               if (file != null && file.isDirectory() && mappingData.context == null){\n>                       log.error(\"Kaboom:   \" + mappingData.toString());\n>               } else {\n>                 if (file != null && file.isDirectory() &&\n>                         mappingData.context.getMapperDirectoryRedirectEnabled()) {\n1017a1027\n>               }\n\nlogs in catalina.out:\n31-Mar-2016 10:23:28.633 SEVERE [ajp-nio-0.0.0.0-8009-exec-1] org.apache.catalina.mapper.Mapper.internalMapWrapper Kaboom:   org.apache.catalina.mapper.MappingData@6443d97d\n31-Mar-2016 10:24:40.946 SEVERE [ajp-nio-0.0.0.0-8009-exec-1] org.apache.catalina.mapper.Mapper.internalMapWrapper Kaboom:   org.apache.catalina.mapper.MappingData@6443d97d\n31-Mar-2016 10:25:26.272 SEVERE [ajp-nio-0.0.0.0-8009-exec-3] org.apache.catalina.mapper.Mapper.internalMapWrapper Kaboom:   org.apache.catalina.mapper.MappingData@14a421a8\n\nIf there is anything that we can do to help you solve this problem please send us information how we can help.", "is_private": false, "bug_id": 59255, "id": 189856, "time": "2016-03-31T11:11:06Z", "creator": "mmikolajczyk@xtm-intl.com", "creation_time": "2016-03-31T11:11:06Z", "attachment_id": null}, {"count": 1, "attachment_id": null, "creator": "remm@apache.org", "text": "Certainly this sort of occurrence is not going to be logged. Besides concurrent recycling, I don't really see what could cause it as mappingData.context is set right before calling internalMapWrapper, so it's really something that is up to you to debug.\n\nIMO this should be INVALID until you demonstrate some reasonably legitimate course of action that leads to the NPE.", "id": 189859, "time": "2016-03-31T14:55:37Z", "bug_id": 59255, "creation_time": "2016-03-31T14:55:37Z", "tags": [], "is_private": false}, {"attachment_id": null, "tags": [], "creator": "knst.kolinko@gmail.com", "text": "1. Sample configuration / steps to reproduce the issue = ?\n\n2. Diffs are preferred in Unified Diff format\nhttp://tomcat.apache.org/bugreport.html#How_to_submit_patches_and_enhancement_requests", "count": 2, "id": 189862, "time": "2016-03-31T15:36:14Z", "bug_id": 59255, "creation_time": "2016-03-31T15:36:14Z", "is_private": false}, {"count": 3, "tags": [], "text": "Looking at 8.0.x Mapper.java, I think that in both mentioned places\n\nmappingData.context.getMapperContextRootRedirectEnabled()\n\nhas be replaced with obtaining the context from ContextVersion object. Both places have it, so I see no reason why context is retrieved from mappingData.\n\nA test case is TBD.", "attachment_id": null, "bug_id": 59255, "id": 189863, "time": "2016-03-31T15:45:02Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2016-03-31T15:45:02Z", "is_private": false}, {"count": 4, "tags": [], "text": "Ok, so mappingData.context -> contextVersion.object. No problem.\n\nSince I don't see how mappingData.context becomes null, mappingData.wrapper probably also gets reset as well which will randomly mess up the mapping algorithm.", "is_private": false, "bug_id": 59255, "id": 189864, "time": "2016-03-31T16:00:03Z", "creator": "remm@apache.org", "creation_time": "2016-03-31T16:00:03Z", "attachment_id": null}, {"count": 5, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "id": 189867, "time": "2016-03-31T19:25:38Z", "bug_id": 59255, "creation_time": "2016-03-31T19:25:38Z", "is_private": false, "text": "Ok, I applied this for 9M5, 8.5.1, 8.0.34."}]