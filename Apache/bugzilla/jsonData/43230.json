[{"count": 0, "tags": [], "bug_id": 43230, "attachment_id": null, "id": 107345, "time": "2007-08-28T08:36:49Z", "creator": "sean.mullan@oracle.com", "creation_time": "2007-08-28T08:36:49Z", "is_private": false, "text": "There is a very subtle bug in the inclusive C14N implementation that sometimes\ncauses xml:space and xml:lang attributes to be handled incorrectly.\n\nGiven the following input:\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<ietf:Xmllang xmlns:ietf=\"http://www.ietf.org\" \nxmlns:w3c=\"http://www.w3.org\">\n   <ietf:e1 xml:lang=\"EN\">\n      <ietf:e11>\n         <ietf:e111 />\n      </ietf:e11>\n      <ietf:e12 at=\"2\">\n         <ietf:e121 />\n      </ietf:e12>\n   </ietf:e1>\n   <ietf:e2 >\n      <ietf:e21 />\n   </ietf:e2>\n</ietf:Xmllang>\n\nand an XPath expression of \"ancestor-or-self::ietf:e1\", the c14n representation\nshould be:\n\n<ietf:e1 xmlns:ietf=\"http://www.ietf.org\" xmlns:w3c=\"http://www.w3.org\"\nxml:lang=\"EN\">\n      <ietf:e11>\n         <ietf:e111></ietf:e111>\n      </ietf:e11>\n      <ietf:e12 at=\"2\">\n         <ietf:e121></ietf:e121>\n      </ietf:e12>\n   </ietf:e1>\n\nHowever, the current behavior is:\n\n<ietf:e1 xmlns:ietf=\"http://www.ietf.org\" xmlns:w3c=\"http://www.w3.org\"\nxml:lang=\"EN\">\n      <ietf:e11>\n         <ietf:e111></ietf:e111>\n      </ietf:e11>\n      <ietf:e12 at=\"2\" xml:lang=\"EN\">\n         <ietf:e121></ietf:e121>\n      </ietf:e12>\n   </ietf:e1>\n\nNotice the xml:lang attribute in the \"ietf:e12\" element, which was incorrectly\ncopied from the parent.\n\nThe bug is in Canonicalizer20010315.java, in the XmlAttrStack.push() method:\n\n--- Canonicalizer20010315.java  (revision 548379)\n+++ Canonicalizer20010315.java  (working copy)\n@@ -72,7 +72,7 @@\n                if (currentLevel==-1)\n                        return;\n                cur=null;\n-               while (lastlevel>currentLevel) {\n+               while (lastlevel>=currentLevel) {\n                        levels.remove(levels.size()-1);\n                        if (levels.size()==0) {\n                                lastlevel=0;\n\nThe bug is that the implementation was taking the previous sibling's attribute\ncontext into account, which is not an ancestor, and thus the\nattributes were being inherited incorrectly in some cases. The simple \nchange above fixes that."}]