[{"count": 0, "tags": [], "bug_id": 55897, "attachment_id": 31124, "text": "Created attachment 31124\n[PATCH]prefork_mpm patch with SO_REUSEPORT support\n\nIssues we have found:\nOur analysis of Apache httpd 2.4.7 prefork mpm, on 32 and 64 thread Intel Xeon 2600 series systems, using an open source three tier social networking web server workload, revealed performance scaling issues.  In current software single listen statement (listen 80) provides better scalability due to un-serialized accept. However, when system is under very high load, this can lead to big number of child processes stuck in D state. On the other hand, the serialized accept approach cannot scale with the high load either.  In our analysis, a 32-thread system, with 2 listen statements specified, could scale to just 70% utilization, and a 64-thread system, with signal listen statement specified (listen 80, 4 network interfaces), could scale to only 60% utilization. \n\nWhat we have changed:\nBased on those findings, we created a prototype patch for prefork mpm which extends performance and thread utilization. In Linux kernel newer than 3.9, SO_REUSEPORT is enabled. This feature allows multiple sockets listen to the same IP:port and automatically round robins connections. We use this feature to create 4 duplicated listener records of the original one and partition the child processes into 4 buckets. Each bucket listens to 1 IP:port. A mutex is being used to guard only 1 child wakes up when there is a request comes in. In case of old kernel which does not have the SO_REUSEPORT enabled, we modified the \"multiple listen statement case\" by creating 1 listen record for each listen statement and partitioning the child processes into different buckets. Each bucket listens to 1 IP:port. \n\nIn the current work, we added the SO_REUSEPORT enablement into APR 1.5.0 and filed a small patch with bugzilla ID 55894 (patch for SO_REUSEPORT) for this. To review the patch, please use the APR patch as well. \n\nTesting results:\nQuick tests of the patch, running the same workload, demonstrated a 22% throughput increase with 32-threads and 2 listen statements (Linux kernel 3.10.4). With the older kernel (Linux Kernel 3.8.8, without SO_REUSEPORT), 10% performance gain was measured. With 64 threads, a 60% throughput increase was achieved with just 1 listen statement (listen 80) and 1 active IP1 (Linux Kernel 3.12.5). We also observed big reduction in response time, in addition to the throughput improvement gained1 in our tests.\n\nThis is our first patch to the Apache community(besides the small APR change). Please help us review it and let us know if there is anything we might revise to improve it. Your feedback is very much appreciated.\n\nConfiguration:\n<IfModule prefork.c>\n    ListenBacklog 105384\n    ServerLimit 105000\n    MaxClients 1024\n    MaxRequestsPerChild 0\n    StartServers 64\n    MinSpareServers 8\n    MaxSpareServers 16\n</IfModule>\n\n1. Software and workloads used in performance tests may have been optimized for performance only on Intel microprocessors. Performance tests, such as SYSmark and MobileMark, are measured using specific computer systems, components, software, operations and functions. Any change to any of those factors may cause the results to vary. You should consult other information and performance tests to assist you in fully evaluating your contemplated purchases, including the performance of that product when combined with other products.  Configurations: Xeon 2-socket 2680 server with 16x8GB DDR3-1333 and 4-socket Xeon 4650 server with 48x4GB DDR3-1066 (running at 1.3GHz), shown with workload as tested by Intel November 2013.", "id": 171795, "time": "2013-12-17T16:01:25Z", "creator": "Yingqi.Lu@intel.com", "creation_time": "2013-12-17T16:01:25Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 55897, "attachment_id": 31125, "text": "Created attachment 31125\n[PATCH]prefork_mpm patch with SO_REUSEPORT support", "id": 171796, "time": "2013-12-17T16:42:40Z", "creator": "Yingqi.Lu@intel.com", "creation_time": "2013-12-17T16:42:40Z", "is_private": false}, {"count": 2, "tags": [], "text": "Created attachment 31126\n[PATCH]prefork_mpm patch with SO_REUSEPORT support\n\nThe patch file is updated as this version.", "attachment_id": 31126, "id": 171798, "creation_time": "2013-12-17T17:39:55Z", "time": "2013-12-17T17:39:55Z", "creator": "Yingqi.Lu@intel.com", "bug_id": 55897, "is_private": false}, {"count": 3, "tags": [], "text": "Created attachment 31127\nAPR patch for SO_REUSEPORT support\n\nThis is the APR patch adding SO_REUSEPORT to apr_socket_opt_set(). It can also be found at Bug 55894. \n\nThanks!", "attachment_id": 31127, "id": 171799, "creation_time": "2013-12-17T17:43:29Z", "time": "2013-12-17T17:43:29Z", "creator": "Yingqi.Lu@intel.com", "bug_id": 55897, "is_private": false}, {"count": 4, "tags": [], "bug_id": 55897, "attachment_id": 31171, "id": 172101, "time": "2014-01-06T09:59:11Z", "creator": "Yingqi.Lu@intel.com", "creation_time": "2014-01-06T09:59:11Z", "is_private": false, "text": "Created attachment 31171\n[PATCH]prefork_mpm patch with SO_REUSEPORT support\n\nThis is the most recent version of the patch.\n\nIn order to use the httpd patch, please apply the apr patch first.\n\nThanks!"}, {"count": 5, "tags": [], "bug_id": 55897, "attachment_id": null, "text": "Was this change tested with event or worker MPMs?  Is the prefork MPM desirable in this scenario due to the use of mod_php or some other third-party module, or is there an issue with bundled modules that necessitates the use of prefork, or is there some other reason for prefork?\n\nFWIW, you don't actually need an APR change to make the desired setsockopt call.  Call apr_os_sock_get() to get the file descriptor and call setsockopt directly.  That would make it easier for others to use the patch with existing builds of APR.", "id": 172103, "time": "2014-01-06T12:18:53Z", "creator": "trawick@apache.org", "creation_time": "2014-01-06T12:18:53Z", "is_private": false}, {"count": 6, "tags": [], "creator": "Yingqi.Lu@intel.com", "text": "Hi Jeff,\n\nThanks very much for your response! \n\nYes, we chose to use prefork mpm due to the use of libphp5.so (non-zts). We tested the zts version as well, but it showed some performance issues before. then, we decided to try the patch on prefork mpm first. \n\nWe can surely extend this patch to worker and event mpm. We will use fcgi instead of libphp5.so for testing. Also, We will follow your suggestion to call apr_os_sock_get() in the follow up version of the patch.\n\nWe will update this thread soon.\n\nThanks!\n\nYingqi\n\n\n\n(In reply to Jeff Trawick from comment #5)\n> Was this change tested with event or worker MPMs?  Is the prefork MPM\n> desirable in this scenario due to the use of mod_php or some other\n> third-party module, or is there an issue with bundled modules that\n> necessitates the use of prefork, or is there some other reason for prefork?\n> \n> FWIW, you don't actually need an APR change to make the desired setsockopt\n> call.  Call apr_os_sock_get() to get the file descriptor and call setsockopt\n> directly.  That would make it easier for others to use the patch with\n> existing builds of APR.", "id": 172116, "time": "2014-01-06T17:14:48Z", "bug_id": 55897, "creation_time": "2014-01-06T17:14:48Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "creator": "Yingqi.Lu@intel.com", "text": "Created attachment 31253\n[PATCH]prefork_mpm patch with SO_REUSEPORT support", "id": 172688, "time": "2014-01-24T22:03:56Z", "bug_id": 55897, "creation_time": "2014-01-24T22:03:56Z", "is_private": false, "attachment_id": 31253}, {"count": 8, "tags": [], "text": "In this newer version of the patch, we removed dependency of APR change by using apr_os_sock_get() and setsockopt() directly from listen.c file. Now, you only need this attached httpd patch file to test the patch. Jeff, thanks very much for your suggestion!\n\nAfter last update, we also spent some time testing this prefork patch and we observed over 2X performance improvements on Intel modern dual socket platforms.\n\nWe are still actively working on extending this patch to worker and event mpms. Meanwhile, we would like to gather your feedback and comments on the current prefork patch. Please take some time test it and let us know how it works in your environment.\n\nOur configurations are:\nConfiguration:\n<IfModule prefork.c>\n    ListenBacklog 105384\n    ServerLimit 105000\n    MaxClients 1024\n    MaxRequestsPerChild 0\n    StartServers 64\n    MinSpareServers 8\n    MaxSpareServers 16\n</IfModule>\n\n1. Software and workloads used in performance tests may have been optimized for performance only on Intel microprocessors. Performance tests, such as SYSmark and MobileMark, are measured using specific computer systems, components, software, operations and functions. Any change to any of those factors may cause the results to vary. You should consult other information and performance tests to assist you in fully evaluating your contemplated purchases, including the performance of that product when combined with other products.\n\nThanks,\nYingqi\n\n(In reply to Yingqi.Lu from comment #6)\n> Hi Jeff,\n> \n> Thanks very much for your response! \n> \n> Yes, we chose to use prefork mpm due to the use of libphp5.so (non-zts). We\n> tested the zts version as well, but it showed some performance issues\n> before. then, we decided to try the patch on prefork mpm first. \n> \n> We can surely extend this patch to worker and event mpm. We will use fcgi\n> instead of libphp5.so for testing. Also, We will follow your suggestion to\n> call apr_os_sock_get() in the follow up version of the patch.\n> \n> We will update this thread soon.\n> \n> Thanks!\n> \n> Yingqi\n> \n> \n> \n> (In reply to Jeff Trawick from comment #5)\n> > Was this change tested with event or worker MPMs?  Is the prefork MPM\n> > desirable in this scenario due to the use of mod_php or some other\n> > third-party module, or is there an issue with bundled modules that\n> > necessitates the use of prefork, or is there some other reason for prefork?\n> > \n> > FWIW, you don't actually need an APR change to make the desired setsockopt\n> > call.  Call apr_os_sock_get() to get the file descriptor and call setsockopt\n> > directly.  That would make it easier for others to use the patch with\n> > existing builds of APR.", "attachment_id": null, "id": 172689, "creator": "Yingqi.Lu@intel.com", "time": "2014-01-24T22:11:06Z", "bug_id": 55897, "creation_time": "2014-01-24T22:11:06Z", "is_private": false}, {"count": 9, "tags": [], "text": "Dear all,\n\nBased on the feedback we received, we modified this patch. Here is the most recent version. \n\nBelow are the changes we made into this new version:\n\n1. We separate the original patch between with and without SO_REUSEPORT into two separated patches. The SO_REUSEPORT (current patch) patch does not change the original listen sockets, it just duplicate the original one into multiple ones. Since the listen sockets are identical, there is no need to change the idle_server_maintenance. The bucket patch (without SO_REUSEPORT, bugzilla #56279), on the other hand, it breaks down the original listen record (if there are multiple listen socks) to multiple listen record linked lists. In this case, idle_server_maintenance is implemented at bucket level to address the situation that imbalanced traffic occurs among different listen sockets/children buckets. In the bucket patch, the polling in the child process is removed since each child only listens to 1 sock. \n\n2. We make the \u201cdetection of SO_REUSEPORT\u201d at run time. \n\n3. The current patch is generated against the httpd-trunk.\n\nAgain, thanks very much for all the comments and feedback. Please let us know if there are more changes we need to complete to make them accepted.\n\nThanks,\nYingqi Lu", "attachment_id": null, "bug_id": 55897, "id": 173885, "time": "2014-03-17T20:25:39Z", "creator": "Yingqi.Lu@intel.com", "creation_time": "2014-03-17T20:25:39Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 55897, "attachment_id": 31397, "id": 173886, "time": "2014-03-17T20:26:44Z", "creator": "Yingqi.Lu@intel.com", "creation_time": "2014-03-17T20:26:44Z", "is_private": false, "text": "Created attachment 31397\n[PATCH]prefork_mpm patch with SO_REUSEPORT support"}, {"count": 11, "tags": [], "creator": "Yingqi.Lu@intel.com", "attachment_id": 31616, "id": 175186, "time": "2014-05-13T19:50:21Z", "bug_id": 55897, "creation_time": "2014-05-13T19:50:21Z", "is_private": false, "text": "Created attachment 31616\npatch with SO_REUSEPORT support\n\nThis newer version of the patch extends from original prefork mpm to all three mpms for Linux OS (prefork, worker and event)"}, {"count": 12, "tags": [], "text": "Created attachment 31632\npatch with SO_REUSEPORT support\n\nBased on the feedback from the developer community, this version of the patch checks if sysconf(_SC_NPROCESSORS_ONLN) is supported on the system.", "attachment_id": 31632, "bug_id": 55897, "id": 175283, "time": "2014-05-16T18:47:43Z", "creator": "Yingqi.Lu@intel.com", "creation_time": "2014-05-16T18:47:43Z", "is_private": false}, {"count": 13, "tags": [], "creator": "Yingqi.Lu@intel.com", "attachment_id": 31681, "id": 175588, "time": "2014-06-02T08:17:18Z", "bug_id": 55897, "creation_time": "2014-06-02T08:17:18Z", "is_private": false, "text": "Created attachment 31681\n[PATCH]patch with SO_REUSEPORT support (committed 2014-06-03, see comment 14)\n\nBased on the feedback received from the developer community, I keep the ap_mpm_pod_signal() and ap_mpm_pod_killpg() exactly the same as the original ones. I modify dummy_connection() instead."}, {"count": 14, "tags": [], "text": "Attachment 31681 was committed to trunk with minor tweaks as r1599531 (in early June 2014, see https://mail-archives.apache.org/mod_mbox/httpd-dev/201406.mbox/<D8167D13-996A-40FA-8EF7-281E71507118@jaguNET.com>).", "attachment_id": null, "id": 178289, "creation_time": "2014-10-05T05:40:35Z", "time": "2014-10-05T05:40:35Z", "creator": "asfbugz@velox.ch", "bug_id": 55897, "is_private": false}, {"count": 15, "tags": [], "bug_id": 55897, "attachment_id": 32079, "text": "Created attachment 32079\n[PATCH]patch with SO_REUSEPORT support\n\nAttached patch is the fix to address the restart/graceful restart issues. Thanks very much for Kaspar Brand's feedback!\n\nThe patch is based on httpd trunk r1629441. The changes are:\n\n1. Fix the graceful restart issue for prefork/worker/event MPM. \n2. Fix the \"server seems busy\" and \"scoreboard is full\" issue on restart for both worker and event MPM. Prefork does not have this issue.\n3. Guard the ap_daemons_to_start >= num_buckets. \n4. Change CPU thread count check from _SC_NPROCESSORS_ONLN to _SC_NPROCESSORS_CONF. This makes sure num_buckets to be a constant as long as the system is running. This change addresses the use case like: A user offline some of the CPU threads and then restart httpd. In this case, I think we need to make sure num_buckets does not change during the restart. \n\nCan some please review the patch and help add it into trunk?\n\nThanks,\nYingqi Lu", "id": 178290, "time": "2014-10-05T06:02:38Z", "creator": "Yingqi.Lu@intel.com", "creation_time": "2014-10-05T06:02:38Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 55897, "attachment_id": 32081, "text": "Created attachment 32081\n[PATCH]patch with SO_REUSEPORT support\n\nThis is the most recent version of the fix. It fixes a small issue for event mpm in the version I sent out yesterday. Please use this one as the final fix.\n\nThanks,\nYingqi", "id": 178292, "time": "2014-10-05T18:13:22Z", "creator": "Yingqi.Lu@intel.com", "creation_time": "2014-10-05T18:13:22Z", "is_private": false}, {"count": 17, "tags": [], "creator": "Yingqi.Lu@intel.com", "text": "Created attachment 32082\n[PATCH]incremental patch with SO_REUSEPORT support (to be applied on top of attachment 31681)\n\nAddressed the comments from Yann Ylavic, here is another update on the code based on trunk version 1629441.\n\nThanks, \nYingqi", "id": 178296, "time": "2014-10-05T21:40:27Z", "bug_id": 55897, "creation_time": "2014-10-05T21:40:27Z", "is_private": false, "attachment_id": 32082}, {"count": 18, "tags": [], "text": "Comment on attachment 31681\n[PATCH]patch with SO_REUSEPORT support (committed 2014-06-03, see comment 14)\n\nRemoving obsolete flag from the patch committed in early June (see comment 14).", "attachment_id": 31681, "id": 178297, "creator": "asfbugz@velox.ch", "time": "2014-10-06T04:51:12Z", "bug_id": 55897, "creation_time": "2014-10-06T04:51:12Z", "is_private": false}, {"count": 19, "tags": [], "bug_id": 55897, "attachment_id": 32082, "text": "Comment on attachment 32082\n[PATCH]incremental patch with SO_REUSEPORT support (to be applied on top of attachment 31681)\n\nClarifying patch description.", "id": 178298, "time": "2014-10-06T04:54:30Z", "creator": "asfbugz@velox.ch", "creation_time": "2014-10-06T04:54:30Z", "is_private": false}, {"count": 20, "tags": [], "creator": "Yingqi.Lu@intel.com", "attachment_id": null, "id": 178299, "time": "2014-10-06T04:57:17Z", "bug_id": 55897, "creation_time": "2014-10-06T04:57:17Z", "is_private": false, "text": "Hi Kaspar,\n\nThank you very much for your help here!\n\nYingqi"}, {"count": 21, "tags": [], "bug_id": 55897, "attachment_id": 32082, "id": 178387, "time": "2014-10-11T09:31:26Z", "creator": "asfbugz@velox.ch", "creation_time": "2014-10-11T09:31:26Z", "is_private": false, "text": "Comment on attachment 32082\n[PATCH]incremental patch with SO_REUSEPORT support (to be applied on top of attachment 31681)\n\nThis incremental patch seems to have been committed with r1629909 (and followups), at least partly. Marking as obsolete.\n\nFor further discussion see:\n\nhttps://mail-archives.apache.org/mod_mbox/httpd-dev/201410.mbox/%3CCAKQ1sVP6uSaMJw7%3Dj0893w24w%3D1%3DRmTSXexRDDLGNnt5Y-%3DiTA%40mail.gmail.com%3E\n\nTo reduce duplication/confusion, I suggest to no longer attach patches here and instead post and discuss new code/patches on the dev mailing list only (as was done with https://mail-archives.apache.org/mod_mbox/httpd-dev/201410.mbox/%3C9ACD5B67AAC5594CB6268234CF29CF9AA37D3409@ORSMSX113.amr.corp.intel.com%3E yesterday)."}, {"count": 22, "tags": [], "bug_id": 55897, "attachment_id": null, "text": "*** Bug 56279 has been marked as a duplicate of this bug. ***", "id": 180527, "time": "2015-01-23T10:27:02Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2015-01-23T10:27:02Z", "is_private": false}, {"count": 23, "tags": [], "creator": "ylavic.dev@gmail.com", "text": "Backport to 2.4.x proposed in r1651967.", "id": 180528, "time": "2015-01-23T10:28:37Z", "bug_id": 55897, "creation_time": "2015-01-23T10:28:37Z", "is_private": false, "attachment_id": null}, {"count": 24, "tags": [], "text": "Backported to 2.4.17 in r1705492.", "attachment_id": null, "id": 185507, "creator": "ylavic.dev@gmail.com", "time": "2015-09-28T08:27:48Z", "bug_id": 55897, "creation_time": "2015-09-28T08:27:48Z", "is_private": false}]