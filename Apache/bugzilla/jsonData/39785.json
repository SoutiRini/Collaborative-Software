[{"count": 0, "tags": [], "bug_id": 39785, "attachment_id": null, "is_private": false, "id": 90096, "time": "2006-06-12T10:34:10Z", "creator": "nobutaka@nobutaka.org", "creation_time": "2006-06-12T10:34:10Z", "text": "With Apache 1.3.x, status code 408 is logged to access log when an HTTP request\nisn't sent within a timeout period. But this function is lost in Apache 2.x.\n\nThis function is useful for detecting connection flood attack and identifying\nthe attacker's IP address. The following patch for Apache 2.2.2 enables it (also\napplicable to 2.0.58).\n\n--- server/protocol.c.orig\tWed Jun  7 15:41:12 2006\n+++ server/protocol.c\tWed Jun  7 20:45:40 2006\n@@ -899,6 +899,13 @@\n             return r;\n         }\n \n+        if (r->status == HTTP_REQUEST_TIME_OUT) {\n+            ap_update_child_status(conn->sbh, SERVER_BUSY_LOG, r);\n+            ap_run_log_transaction(r);\n+            apr_brigade_destroy(tmp_bb);\n+            return r;\n+        }\n+\n         apr_brigade_destroy(tmp_bb);\n         return NULL;\n     }"}, {"count": 1, "tags": [], "creator": "poirier@pobox.com", "text": "Fix committed to trunk as r820760\n\nThe fix includes the original patch (slightly modified for current trunk code), and a contribution from Stefan Fritsch to make sure a timeout reading the request gets treated as a 408 and not a 400.", "id": 130780, "time": "2009-10-01T12:33:16Z", "bug_id": 39785, "creation_time": "2009-10-01T12:33:16Z", "is_private": false, "attachment_id": null}, {"count": 2, "attachment_id": 25086, "bug_id": 39785, "text": "Created attachment 25086\nPrevent excessive 408 log entries when KeepAlive is on\n\nWhen KeepAlive is on, the original patch results in a log entry for every connection, reporting when the keepalive times out.  This results in a large number of 408 status codes in the logs, one for each legitimate connection.  The attached patch (also included below) prevents keepalive-related 408 status codes from being logged while still logging 408 status codes for non-keepalive connections, header timeouts (regardless of whether keepalive is enabled), and so on.\n\ndiff -up httpd-2.3.5-alpha/server/protocol.c.keepalivequiet httpd-2.3.5-alpha/server/protocol.c\n--- httpd-2.3.5-alpha/server/protocol.c.keepalivequiet  2010-03-04 19:50:04.321471001 -0500\n+++ httpd-2.3.5-alpha/server/protocol.c 2010-03-04 21:33:52.657724234 -0500\n@@ -923,7 +923,12 @@ request_rec *ap_read_request(conn_rec *c\n         }\n         else if (r->status == HTTP_REQUEST_TIME_OUT) {\n             ap_update_child_status(conn->sbh, SERVER_BUSY_LOG, r);\n-            ap_run_log_transaction(r);\n+            csd = ap_get_module_config(conn->conn_config, &core_module);\n+            apr_socket_timeout_get(csd, &cur_timeout);\n+            if (conn->keepalive != AP_CONN_KEEPALIVE \n+                || cur_timeout != conn->base_server->keep_alive_timeout) {\n+                ap_run_log_transaction(r);\n+            }\n             apr_brigade_destroy(tmp_bb);\n             goto traceout;\n         }", "id": 135069, "time": "2010-03-05T03:57:21Z", "creator": "mark@catseye.org", "creation_time": "2010-03-05T03:57:21Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "creator": "rpluem@apache.org", "text": "(In reply to comment #2)\n> Created an attachment (id=25086) [details]\n> Prevent excessive 408 log entries when KeepAlive is on\n\nThanks for the observation. Fixed slightly different in r919323.", "id": 135071, "time": "2010-03-05T07:38:40Z", "bug_id": 39785, "creation_time": "2010-03-05T07:38:40Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "text": ">> Created an attachment (id=25086) [details]\n>> Prevent excessive 408 log entries when KeepAlive is on\n\n> Thanks for the observation. Fixed slightly different in r919323.\n\nr919323 is still leaving a lot of 408 errors in Apache logs when Apache is running behind an Amazon Elastic Load Balancer: see https://forums.aws.amazon.com/thread.jspa?messageID=292085&#292085\n\nPatch of r919323 for reference:\n\n--- httpd/httpd/trunk/server/protocol.c\t2010/03/05 07:30:17\t919322\n+++ httpd/httpd/trunk/server/protocol.c\t2010/03/05 07:37:15\t919323\n@@ -923,7 +923,9 @@\n         }\n         else if (r->status == HTTP_REQUEST_TIME_OUT) {\n             ap_update_child_status(conn->sbh, SERVER_BUSY_LOG, r);\n-            ap_run_log_transaction(r);\n+            if (!r->connection->keepalives) {\n+                ap_run_log_transaction(r);\n+            }\n             apr_brigade_destroy(tmp_bb);\n             goto traceout;\n         }\n\n\nI believe !r->connection->keepalives is failing to filter out load balancer connections.", "is_private": false, "id": 151388, "creator": "graham.poulter@gmail.com", "time": "2011-11-11T06:22:26Z", "bug_id": 39785, "creation_time": "2011-11-11T06:22:26Z", "attachment_id": null}, {"count": 5, "tags": [], "text": "This is definitely still an issue behind Amazon ELB's...   I'm getting lots of 408 status codes in my logs.", "is_private": false, "id": 151498, "creator": "jonathan.sabo@audaxhealth.com", "time": "2011-11-15T00:43:28Z", "bug_id": 39785, "creation_time": "2011-11-15T00:43:28Z", "attachment_id": null}, {"count": 6, "attachment_id": null, "bug_id": 39785, "text": "What exactly?", "id": 151500, "time": "2011-11-15T01:16:33Z", "creator": "covener@gmail.com", "creation_time": "2011-11-15T01:16:33Z", "tags": [], "is_private": false}]