[{"count": 0, "tags": [], "creator": "toni.helenius@syncrontech.com", "attachment_id": null, "is_private": false, "id": 160726, "time": "2012-07-19T05:49:28Z", "bug_id": 53568, "creation_time": "2012-07-19T05:49:28Z", "text": "Hello,\n\nI'm converting some HSSF specific code to use the generic SS one. I keep getting NPEs from XSSFPicture functions (using the Interface, Picture) since they don't contain anchors. Anchors are null. This generic code works just fine on HSSF.\n\nI also need the locations of the images, so the getAllImages() just doesn't cut it.\n\nFileInputStream file = new FileInputStream(new File(\"c:\\\\temp\\\\test.xlsx\"));\nWorkbook wb = WorkbookFactory.create(file);\nSheet sheet = wb.getSheetAt(0);\n\nXSSFDrawing drawing = ((XSSFSheet)sheet).createDrawingPatriarch();\n\n// Get the shapes\nfor (XSSFShape shape : drawing.getShapes()) {\n\tif (shape instanceof Picture) {\n\t\tClientAnchor anchor = picture.getPreferredSize(); //Fails on XSSF, NPE\n\t\t}\n\t}"}, {"count": 1, "tags": [], "creator": "toni.helenius@syncrontech.com", "attachment_id": 29077, "id": 160727, "time": "2012-07-19T06:02:00Z", "bug_id": 53568, "creation_time": "2012-07-19T06:02:00Z", "is_private": false, "text": "Created attachment 29077\nTest Excel file\n\nIt contains 2 pictures of a cute walrus (our swamp soccer team logo :) ). Both PNG & JPEG. Both result in null anchors."}, {"count": 2, "tags": [], "creator": "onionhead0708@gmail.com", "attachment_id": 29440, "id": 162541, "time": "2012-10-03T13:08:41Z", "bug_id": 53568, "creation_time": "2012-10-03T13:08:41Z", "is_private": false, "text": "Created attachment 29440\nTemporary fix\n\n\nAs I've also encounter the same problem, I've tried to fix and seems work in my case. \n\nAttached please find the temporary fix for the mentioned problem.\n\nPlease replace the XSSFDrawing.class and XSSFPicture.class in the poi-ooxml-3.8-20120326.jar\n\nFollowings are the changes I've made (Code changes are based on version: poi-ooxml-3.8-20120326.jar)\n\nIn folder src\\ooxml\\java\\org\\apache\\poi\\xssf\\usermodel:\n\nFile: XSSFPicture.java\nAdd new Constructor: protected XSSFPicture(final XSSFDrawing drawing, final CTPicture ctPicture, final CTTwoCellAnchor anchor)\nDescription: assign also the anchor to the protected class variable\n\nUpdate function: public XSSFPictureData getPictureData()\nChanges: Before looping to find the part in the drawing.relations collection, use getDrawing().getRelationById(blipId) to find the docPart. \nDoing this because seems sometimes the part.getPackageRelationship().getId() return a wrong relation Id.\n\nFile: XSSFDrawing.java\nUpdate function: public List<XSSFShape>  getShapes()\nChanges: If the obj is CTPicture and the parent XML object is CTTwoCellAnchor, call add a new XSSFPicture using the anchor info"}, {"count": 3, "tags": [], "bug_id": 53568, "attachment_id": null, "text": "Thanks for this, I applied your patch in r1393992 with some tweaks. The problem with null anchors was generic - when reading from a existing drawing all shapes had null anchor: pictures, text boxes, lines, etc. So the fix should apply to all shapes, not only to pictures.\n\n\n> Update function: public XSSFPictureData getPictureData()\n> Changes: Before looping to find the part in the drawing.relations\n> collection, use getDrawing().getRelationById(blipId) to find the docPart. \n> Doing this because seems sometimes the part.getPackageRelationship().getId()\n> return a wrong relation Id.\n> \n\n\nCan you upload a unit test demonstrating that part.getPackageRelationship().getId() can be wrong ? \n\nYegor", "id": 162553, "time": "2012-10-04T11:28:09Z", "creator": "yegor@dinom.ru", "creation_time": "2012-10-04T11:28:09Z", "is_private": false}, {"count": 4, "tags": [], "creator": "onionhead0708@gmail.com", "attachment_id": 29447, "is_private": false, "id": 162573, "time": "2012-10-04T17:55:27Z", "bug_id": 53568, "creation_time": "2012-10-04T17:55:27Z", "text": "Created attachment 29447\nExample for wrong part.getPackageRelationship().getId()\n\nHi, Yegor,\n\nThanks for applying the fix.\n\nAttached please find the testing case (sample-image.xlsx) that I found wrong on the part.getPackageRelationship().getId() \n\nI use my testing class TestReadExcelImage to manually check the problem.\n\nPlease check the worksheet: IMAGE4\nThere are 3 pictures inside which reference to 2 images.\nWhen getting the pictureData of the first picture using picture.getPictureData(), a null value is return:\n\n>>output: picture.getPictureData() is null, try finding in relations\n\nThen I loop the picture.getDrawing().getRelations() to output and check the part.getPackageRelationship().getId():\n\n>>output: part.getPackageRelationship().getId()=rId2\n>>output: part.getPackageRelationship().getId()=rId3\n\nI then extract the excel file and check the XML file: \\xl\\drawings\\_rels\\drawing3.xml.rels\n\nThe id of relationship are: rId2, rId1 which doesn't match with the one using part.getPackageRelationship().getId()\n\nSo, I think that the part.getPackageRelationship().getId() must be wrong.\n\nI then use the picture.getDrawing().getRelationById(embedId) to get the corresponding picutureData. This time, the information returned is correct:\n\n>>output: pictureName=/xl/media/image2.jpeg\n>>output: Fm position = [20, 3]\n>>output: To position = [22, 3]\n\nAfterward, I get the pictureData of the 2nd and 3rd picture using the picture.getPictureData(). Again, the information returned is incorrect:\n\n>>output: pictureName=/xl/media/image2.jpeg\n>>output: Fm position = [2, 4]\n>>output: To position = [12, 7]\n>>output: pictureName=/xl/media/image2.jpeg\n>>output: Fm position = [15, 5]\n>>output: To position = [25, 8]\n\nThe name of the image should be image3.jpg instead of image2.jpeg\n\nAfter I applied the fix to the picture.getPictureData(), there seems to be no problem then. \nI still don't know why the part.getPackageRelationship().getId() return a wrong value but fixing picture.getPictureData() using the getDrawing().getRelationById(blipId) seems to be a quick fix.\n\nHope this help. Thanks."}, {"count": 5, "tags": [], "creator": "yegor@dinom.ru", "attachment_id": null, "is_private": false, "id": 162660, "time": "2012-10-10T10:50:21Z", "bug_id": 53568, "creation_time": "2012-10-10T10:50:21Z", "text": "Thanks for the good catch, applied in svn in r1396539\n\nRegards,\nYegor\n\n> \n> Attached please find the testing case (sample-image.xlsx) that I found wrong\n> on the part.getPackageRelationship().getId() \n> \n> I use my testing class TestReadExcelImage to manually check the problem.\n> \n> Please check the worksheet: IMAGE4\n> There are 3 pictures inside which reference to 2 images.\n> When getting the pictureData of the first picture using\n> picture.getPictureData(), a null value is return:\n> \n> >>output: picture.getPictureData() is null, try finding in relations\n> \n> Then I loop the picture.getDrawing().getRelations() to output and check the\n> part.getPackageRelationship().getId():\n> \n> >>output: part.getPackageRelationship().getId()=rId2\n> >>output: part.getPackageRelationship().getId()=rId3\n> \n> I then extract the excel file and check the XML file:\n> \\xl\\drawings\\_rels\\drawing3.xml.rels\n> \n> The id of relationship are: rId2, rId1 which doesn't match with the one\n> using part.getPackageRelationship().getId()\n> \n> So, I think that the part.getPackageRelationship().getId() must be wrong.\n> \n> I then use the picture.getDrawing().getRelationById(embedId) to get the\n> corresponding picutureData. This time, the information returned is correct:\n> \n> >>output: pictureName=/xl/media/image2.jpeg\n> >>output: Fm position = [20, 3]\n> >>output: To position = [22, 3]\n> \n> Afterward, I get the pictureData of the 2nd and 3rd picture using the\n> picture.getPictureData(). Again, the information returned is incorrect:\n> \n> >>output: pictureName=/xl/media/image2.jpeg\n> >>output: Fm position = [2, 4]\n> >>output: To position = [12, 7]\n> >>output: pictureName=/xl/media/image2.jpeg\n> >>output: Fm position = [15, 5]\n> >>output: To position = [25, 8]\n> \n> The name of the image should be image3.jpg instead of image2.jpeg\n> \n> After I applied the fix to the picture.getPictureData(), there seems to be\n> no problem then. \n> I still don't know why the part.getPackageRelationship().getId() return a\n> wrong value but fixing picture.getPictureData() using the\n> getDrawing().getRelationById(blipId) seems to be a quick fix.\n> \n> Hope this help. Thanks."}]