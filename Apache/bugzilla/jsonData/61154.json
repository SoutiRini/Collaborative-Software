[{"count": 0, "tags": [], "bug_id": 61154, "is_private": false, "id": 199051, "attachment_id": null, "creator": "csutherl@apache.org", "creation_time": "2017-06-04T14:17:31Z", "time": "2017-06-04T14:17:31Z", "text": "With a vanilla install the admin applications fail to deploy if you start using the Security Manager. To resolve the issue you can move the context.xml from the webapps into the conf/[Engine]/[Host] directory renaming them to match the webapp. Is there some reason we don't inherently trust the manager webapps? Is this behavior on purpose?\n\nTo reproduce:\n\n1) Download, unzip, and start Tomcat\n\n$ wget http://apache.mesi.com.ar/tomcat/tomcat-8/v8.5.15/bin/apache-tomcat-8.5.15.tar.gz\n$ tar xvf apache-tomcat-8.5.15.tar.gz\n$ pushd apache-tomcat-8.5.15\n$ bin/catalina.sh start -security\n\n2) Check the log for the following exception (stacks shortened for brevity and excludes host-manager exception):\n\n~~~\n04-Jun-2017 10:15:30.344 SEVERE [localhost-startStop-1] org.apache.catalina.startup.HostConfig.deployDirectory The web application with context path [/manager] was not deployed because it contained a deployment descriptor [/apache-tomcat-8.5.15/webapps/manager/META-INF/context.xml] which may include configuration necessary for the secure deployment of the application but processing of deployment descriptors is prevented by the deployXML setting of this host. An appropriate descriptor should be created at [/apache-tomcat-8.5.15/conf/Catalina/localhost/manager.xml] to deploy this application.\n04-Jun-2017 10:15:30.376 SEVERE [localhost-startStop-1] org.apache.catalina.core.ContainerBase.addChildInternal ContainerBase.addChild: start: \n org.apache.catalina.LifecycleException: Failed to start component [/manager]\n    at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:167)\n    ....\nCaused by: org.apache.catalina.LifecycleException: Failed to process either the global, per-host or context-specific context.xml file therefore the [/manager] Context cannot be started.\n    at org.apache.catalina.startup.FailedContext.startInternal(FailedContext.java:199)\n    at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:150)\n    ... 14 more\n\n04-Jun-2017 10:15:30.377 SEVERE [localhost-startStop-1] org.apache.catalina.startup.HostConfig.deployDirectory Error deploying web application directory [/apache-tomcat-8.5.15/webapps/manager]\n java.lang.IllegalStateException: ContainerBase.addChild: start: org.apache.catalina.LifecycleException: Failed to start component [/manager]\n    at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:756)\n    ....\n~~~"}, {"count": 1, "tags": [], "bug_id": 61154, "text": "The RemoteAddrVale we can replace with the equivalent filter. The privileged attribute is trickier. Still thinking about that.", "id": 199110, "time": "2017-06-08T20:20:32Z", "creator": "markt@apache.org", "creation_time": "2017-06-08T20:20:32Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 61154, "text": "Two ideas:\n\nA. Move manager and host-manager out of webapps,\nand deploy them via a context file?\n\n- It was like that in Tomcat 5.5\n\n- I use this configuration when running with separate CATALINA_BASE and CATALINA_HOME, and documented the recipe in RUNNING.txt\n\nhttps://svn.apache.org/viewvc/tomcat/tc8.5.x/trunk/RUNNING.txt?revision=1735559&view=markup#l293\n\n\nB. Implement some permission that whitelists the use of context.xml in manager, host-manager?\n\nThe default catalina.policy already has special permissions for manager,\nthus this web application already has special configuration there.\n\nhttps://svn.apache.org/viewvc/tomcat/tc8.5.x/trunk/conf/catalina.policy?revision=1763403&view=markup#l199", "count": 2, "id": 199111, "time": "2017-06-08T22:30:31Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2017-06-08T22:30:31Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 61154, "attachment_id": null, "text": "I was heading in the direction of B. However, I don't see a simple solution that works equally well with and without a SecurityManager.\n\nMy thinking so far has reached the point of wondering if the privileged flag on the context makes any sense at all when not running under a SecuirtyManager.", "id": 199113, "time": "2017-06-09T08:49:02Z", "creator": "markt@apache.org", "creation_time": "2017-06-09T08:49:02Z", "is_private": false}, {"count": 4, "tags": [], "text": "(In reply to Mark Thomas from comment #3)\n> \n> My thinking so far has reached the point of wondering if the privileged flag\n> on the context makes any sense at all when not running under a\n> SecurityManager.\n\n[1] http://tomcat.apache.org/tomcat-8.5-doc/config/context.html#Common_Attributes\n\nAFAIK, the \"privileged\" flag on Context has two effects [1]:\n\na) allow this context to use container servlets\n\nb) change the context's parent class loader to be the Server class loader rather than the Shared class loader\n\nAnything else?\n\n\nI think that the permission to use servlets (\"a)\") does not make sense when running without SecurityManager.\n\nAn idea: replace it with an explicit Permission to access specific container servlets? Manager web application needs only a subset of those servlets.\n\n\nThe classloader hierarchy effect (\"b)\") is important regardless of SecurityManager, but there is no actual need for it.", "is_private": false, "id": 199122, "creator": "knst.kolinko@gmail.com", "time": "2017-06-09T14:56:03Z", "bug_id": 61154, "creation_time": "2017-06-09T14:56:03Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 61154, "is_private": false, "count": 5, "id": 199125, "time": "2017-06-09T16:30:21Z", "creator": "markt@apache.org", "creation_time": "2017-06-09T16:30:21Z", "text": "b) is required if the class loader hierarchy is expanded to the 5.5.x structure where common, shared and catalina class loaders are all separate."}, {"count": 6, "tags": [], "bug_id": 61154, "is_private": false, "id": 199147, "attachment_id": null, "creator": "markt@apache.org", "creation_time": "2017-06-11T15:51:57Z", "time": "2017-06-11T15:51:57Z", "text": "Having explored lots of different options, the cleanest solution I could find was using a custom permission to override deployXML for a specific Context when running under a security manager.\n\nFixed in:\n- trunk for 9.0.0.M22 onwards\n- 8.5.x for 8.5.16 onwards\n- 8.0.x for 8.0.45 onwards\n- 7.0.x for 7.0.79 onwards"}]