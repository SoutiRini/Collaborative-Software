[{"count": 0, "tags": [], "creator": "stefan.labich@fiducia.de", "is_private": false, "text": "In our infrastructure a https request is handled in this way:  \n  \nhttps request(port 443) ->   \nSSL-accelerator (Nortel/Alteon) ->  \ndecrypted request port 50443 ->   \nApache-2.0.53 listening on 80, 55443 using virtual hosts ->  \nmod_jk 1.2.12, AJP13 port 8200 ->  \nTomcat 4.1.31 with application  \n  \nThe application checks wether a request hit the Apache2 on port 55443 or 80. If  \nthe port was 80, a warning message is sent back to the client about unencrypted  \ntraffic.  \n  \nNow we got the warning message also with a request on port 55443.  \nmod_jk logs in debug mode:  \n  \n[Fri Sep 09 11:28:20 2005] [22238:0006] [debug] init_ws_service::mod_jk.c  \n(510): Service pro  \ntocol=HTTP/1.1 method=GET host=(null) addrr=192.168.70.130  \nname=jportal1-riat-p.bap.fiducia.  \nde port=80 auth=(null) user=(null) laddr=10.253.52.65 raddr=192.168.70.130  \n  \nSo there is a wrong port number sent to Tomcat/application.  \n  \nI have traced the problem down to  \njakarta-tomcat-connectors-1.2.12-src/jk/native/apache-2.0/mod_jk.c where I've  \nfound the following:  \n  \n    /* get the real port (otherwise redirect failed) */  \n    /* XXX: use apache API for getting server port  \n     *  \n     * Pre 1.2.7 versions used:  \n     * s->server_port = r->connection->local_addr->port;  \n     */  \n    s->server_port  = ap_get_server_port(r);  \n  \nSo I uncommented the old code and commented the new line: \n \n    /* get the real port (otherwise redirect failed) */ \n    /* XXX: use apache API for getting server port \n     * \n     * Pre 1.2.7 versions used: */ \n     s->server_port = r->connection->local_addr->port; \n \n/*    s->server_port  = ap_get_server_port(r); */ \n \nNow the mod_jk log says: \n \n[Fri Sep 09 13:15:10 2005] [22238:0006] [debug] init_ws_service::mod_jk.c  \n(510): Service pro  \ntocol=HTTP/1.1 method=GET host=(null) addrr=192.168.70.130  \nname=jportal1-riat-p.bap.fiducia.  \nde port=55443 auth=(null) user=(null) laddr=10.253.52.65 raddr=192.168.70.130  \n \nThe port is now sent correctly to Tomcat/application.", "id": 79943, "time": "2005-09-14T13:51:12Z", "bug_id": 36655, "creation_time": "2005-09-14T13:51:12Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 36655, "text": "Hi,\n\nYou should supply the port with ServerName.\n\nThis is from ap_get_server_port:\n\n        /* With UseCanonicalName on (and in all versions prior to 1.3)\n         * Apache will use the hostname and port specified in the\n         * ServerName directive to construct a canonical name for the\n         * server. (If no port was specified in the ServerName\n         * directive, Apache uses the port supplied by the client if\n         * any is supplied, and finally the default port for the protocol\n         * used.\n\nSo, since probably nothing matched, the 80 (as default) was used.\n", "id": 79944, "time": "2005-09-14T14:17:40Z", "creator": "mturk@apache.org", "creation_time": "2005-09-14T14:17:40Z", "is_private": false, "attachment_id": null}]