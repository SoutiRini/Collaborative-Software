[{"count": 0, "attachment_id": null, "bug_id": 44683, "text": "DBCP should keep connections alive while idle. On my development machine I am using Tomcat 6.0.14 and everything works fine. When I set (for test purposes) timeBetweenEvictionRunsMillis=\"1000\" (1 second), I see a list of 'select 1' queries in the mysql-general-log, just as one would expect. The connections are being kept alive, as they should. \n\nThis, however, is not the case using Tomcat 6.0.16. The 'select 1' statements do not appear, and the connections fails after eight hours of no traffic as one would expect. \n\nThe site is otherwise functioning normal with fast database access.\n\nBoring fragment of mysql-general.log using tomcat 6.0.14:\n---------------------------------------------------------\n                    320 Query       select 1\n080326 22:20:56     319 Query       select 1\n                    320 Query       select 1\n080326 22:20:57     319 Query       select 1\n                    320 Query       select 1\n080326 22:20:58     319 Query       select 1\n                    320 Query       select 1\n080326 22:20:59     319 Query       select 1\n                    320 Query       select 1\n080326 22:21:00     319 Query       select 1\n                    320 Query       select 1\n080326 22:21:01     319 Query       select 1\n                    320 Query       select 1\n----------------------------------------------\n\n\ncontext.xml in use\n------------------\n(changed username and password)\n\n<Context path=\"/aom2\" reloadable=\"true\" docBase=\"aom2\">\n   <Resource name=\"jdbc/artomatic001\" \n   auth=\"Container\" \n   driverClassName=\"com.mysql.jdbc.Driver\" \n   type=\"javax.sql.DataSource\" \n   url=\"jdbc:mysql://localhost:3308/artomatic001?autoReconnect=true\" \n   maxActive=\"100\" \n   maxIdle=\"30\" \n   maxWait=\"10000\" \n   username=\"myusername\" \n   password=\"mypassword\" \n   validationQuery=\"select 1\" \n   testOnBorrow=\"true\" \n   testWhileIdle=\"true\"  \n   timeBetweenEvictionRunsMillis=\"1000\" \n   minEvictableIdleTimeMillis=\"3000000\" \n   removeAbandoned=\"true\" \n   removeAbandonedTimeout=\"300\" \n   logAbandoned=\"true\" />\n-----------------------------------------------\n\nVersions:\n---------\nOS: Open Suse Linux 10.1 X86-64\nMySql: 5.0.51a-log\nMySql connector: 5.1.6. placed in tomcat/lib\nNo other db-connectors in application space.\nTomcat 6.0.14 (works fine) and Tomcat 6.0.16 (works not)\n\nOnly other activity on same database, even on db server is PHPmyadmin\n\n\nRegards,\n\nJan-Willem Arnold", "id": 114995, "time": "2008-03-26T14:31:03Z", "creator": "jwar@xs4all.nl", "creation_time": "2008-03-26T14:31:03Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "creator": "markt@apache.org", "is_private": false, "text": "This works for me with Tomcat 6.0.16 and the 5.1.6 connector.\n\nThere must be something else wrong with your configuration. The best place to get help figuring out what the problem might be is the users list.", "id": 115052, "time": "2008-03-27T15:47:22Z", "bug_id": 44683, "creation_time": "2008-03-27T15:47:22Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "marco@boniardi.org", "attachment_id": null, "text": "We have the very similar problem in our production environment.\nApache Tomcat/6.0.16\nJdk 1.6.0_05-b13 Sun Microsystems Inc.\nLinux  \t2.6.18-53.1.4.el5 amd64\nmysql-connector-java-5.0.8-bin.jar\n\nThis is one of our 6 pool:\n    <Resource\n      name=\"jdbc/bestprices\"\n      type=\"javax.sql.DataSource\"\n      initialSize=\"5\"\n      maxActive=\"15\"\n      maxIdle=\"15\"\n      minIdle=\"5\"\n      maxWait=\"5000\"\n      testOnBorrow=\"false\"\n      testWhileIdle=\"true\"\n      timeBetweenEvictionRunsMillis=\"40000\"\n      minEvictableIdleTimeMillis=\"240000\"\n      validationQuery=\"SELECT 1\"\n      username=\"bestprices_user\"\n      password=\"Abdftrf44\"\n      driverClassName=\"com.mysql.jdbc.Driver\"\nurl=\"jdbc:mysql://vgdb05:3306/bestprices?zeroDateTime-Behavior=convertToNull\"\n    />\n\nproblems:\n1) totally random the connection pool collapses, no errors, just hunged.\nYou can not retrive it from context with a lookup, we can not have connections.\nAll requests hunged. We think it's closely related to db idle connection management, with idle connection closed server side due to timeout while the connection pool can't see it.\n2) We see validation query running, but very often twice than in timeBetweenEvictionRunsMillis. We wrote 40 seconds, it runs every 80 seconds.\nFor some reason, in some machine of the cluster (older tomcat restart?) we see validation query running 4 times (160 seconds) the time we defined, and it's stable, always 160 sec., even if I don't know if tomorrow it goes to 320sec. or it stays to 160. In our idea there is something wrong with the Timer that manage query validation for idle connection. Problably timeBetweenEvictionRunsMillis grows over server timeout period causing connections pool collape.\n\nTill 3 weeks ago we had Tom 5.0.x and everything was perfect, lower performance but perfect. In these days we have to restart 1-2 servers /day in a 10 serves cluster due to hunged connection pool. The problem is not related to traffic because it happends night time too.\n\nI hope this can help to figure out the problem.\n\nRegards\n\nMarco Boniardi", "id": 115717, "time": "2008-04-19T06:21:24Z", "bug_id": 44683, "creation_time": "2008-04-19T06:21:24Z", "is_private": false}, {"count": 3, "attachment_id": null, "bug_id": 44683, "text": "Please don't hijack bugs if they look 'similar' to yours.\n\nIf you have the same bug, then please add your comments. If there are differences, open a new one.\n\nComment #2 looks like a DBCP issue so you will probably have more luck reporting the issue to the DBCP folks.", "id": 115718, "time": "2008-04-19T10:00:47Z", "creator": "markt@apache.org", "creation_time": "2008-04-19T10:00:47Z", "tags": [], "is_private": false}]