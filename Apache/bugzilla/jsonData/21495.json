[{"count": 0, "tags": [], "bug_id": 21495, "attachment_id": null, "text": "After installaing 2.0.47 ab doesn't work any more: it blocks after connecting to\nremote machine:\n\n> This is ApacheBench, Version 2.0.40-dev <$Revision: 1.121.2.1 $> apache-2.0\n> Copyright (c) 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/\n> Copyright (c) 1998-2002 The Apache Software Foundation, http://www.apache.org/\n\n> Benchmarking www.XXXX.com (be patient)...\n\nuntil getting a: \n\n> Benchmarking www.XXXX.com (be patient)...apr_poll: The timeout specified has\nexpired (70007)\n\nStracing ab says:\n\n> connect(3, {sin_family=AF_INET, sin_port=htons(80),\nsin_addr=inet_addr(\"217.9.XXX.XXX\")}}, 16) = -1 EINPROGRESS (Operation now in\nprogress)\n> gettimeofday({1057921957, 161482}, NULL) = 0\n> poll( <unfinished ...>\n\nI \"Ctrl-C\"ed here.\n\nI assume it's not a matter of ab but a problem in one of the apr-shared libs ab\nis using: libaprutil-0.so.0 or libapr-0.so.0. If I use the libs from 2.0.46 the\nab from 2.0.47 works fine.\n\nHoping this is a real bug and not just a problem of my system. I tested it with\nSuSE 8.1 and Debian 2.0.\n\nGreetings from Germany,\nKai Seidler", "id": 40440, "time": "2003-07-11T11:20:07Z", "creator": "oswald@apachefriends.org", "creation_time": "2003-07-11T11:20:07Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 21495, "text": "I can verify this problem with ab from Apache 2.1-dev on RedHat 8. \nInterestingly, apr_poll() hasn't changed in some time.  And yet ab hasn't\nchanged its use of socket I/O in some time either.  Go figure :)\n\nApparently the use of poll in ab is broken, as polling only for POLLIN is only\ngoing to catch failures to connect.\n\nGive this a spin (it works for me).\n\nIndex: ab.c\n===================================================================\nRCS file: /home/cvs/httpd-2.0/support/ab.c,v\nretrieving revision 1.126\ndiff -u -r1.126 ab.c\n--- ab.c        10 Jul 2003 19:16:35 -0000      1.126\n+++ ab.c        11 Jul 2003 11:32:52 -0000\n@@ -1268,7 +1268,7 @@\n            c->state = STATE_CONNECTING;\n            c->rwrite = 0;\n             new_pollfd.desc_type = APR_POLL_SOCKET;\n-            new_pollfd.reqevents = APR_POLLIN;\n+            new_pollfd.reqevents = APR_POLLIN | APR_POLLOUT;\n             new_pollfd.desc.s = c->aprsock;\n             new_pollfd.client_data = c;\n            apr_pollset_add(readbits, &new_pollfd);\n\nI rarely use ab myself, and the only testing of it that I did personally over\nthe last few releases has been over loopback, where I assume the connect\ncompleted synchronously and we didn't need to poll() until it completed.\n", "id": 40444, "time": "2003-07-11T11:40:38Z", "creator": "trawick@apache.org", "creation_time": "2003-07-11T11:40:38Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 21495, "is_private": false, "text": "Yes, it works for me as well. Thanks a lot, Jeff!", "id": 40456, "time": "2003-07-11T12:45:18Z", "creator": "oswald@apachefriends.org", "creation_time": "2003-07-11T12:45:18Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "trawick@apache.org", "attachment_id": null, "text": "For the record:\n\nWhile the patch I posted apparently makes it work, it is something of a kludge.\n\nab in 2.0.46 worked because of the way that apr_connect() was broken for purely\nnon-blocking sockets.\n\nOne would think that the poll condition between the initial connect call and\nwhen we know we've successfully found a partner would be simply POLLOUT, but it\ndoesn't work unless you have POLLOUT|POLLIN because the connect state is used\nfor more than just getting connected to the desired remote part.  Another issue\nis that we don't reissue the connect to find out whether or not it worked.  But\nthat isn't so easy because connect state is overloaded with some SSL setup.\n\nMaybe the kludge isn't so bad, since it may be some time before somebody feels\nlike cleaning house in ab and potentially breaking something else :)\n", "id": 40526, "time": "2003-07-12T00:35:48Z", "bug_id": 21495, "creation_time": "2003-07-12T00:35:48Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 21495, "is_private": false, "text": "*** Bug 22686 has been marked as a duplicate of this bug. ***", "id": 43261, "time": "2003-08-25T18:47:20Z", "creator": "trawick@apache.org", "creation_time": "2003-08-25T18:47:20Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 21495, "is_private": false, "text": "A fix for this will be in 2.0.48.\n", "id": 44874, "time": "2003-09-30T09:25:52Z", "creator": "trawick@apache.org", "creation_time": "2003-09-30T09:25:52Z", "attachment_id": null}]