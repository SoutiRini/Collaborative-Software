[{"count": 0, "tags": [], "bug_id": 47378, "is_private": false, "text": "Web applications that use a servlet mapping for their welcome-file are ignored\nand the server returns either a directory listing or a 404 if the listing is\ndisabled.\nI have JSF servlet defined and a servlet-mapping for *.jsf to go to the\nFacesServlet.\nI have \"index.jsf\" listed as by welcome-file and I get a 404 with directory\nlisting disabled.\nI also have a custom servlet defined with its mapping and set the welcome-file\nto its mapping and get a 404 as well.", "id": 127991, "time": "2009-06-16T12:52:31Z", "creator": "robertl@jlab.org", "creation_time": "2009-06-16T12:52:31Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "funkman@apache.org", "attachment_id": null, "id": 128010, "time": "2009-06-17T04:05:38Z", "bug_id": 47378, "creation_time": "2009-06-17T04:05:38Z", "is_private": false, "text": "You'll need a physical file called index.jspf as a \"placeholder\" for the action to occur. The file placeholder can be 0 bytes if you want. Or you can write a filter to detect a directory is requested and forward to index.jspf.\n\nThe reason for needing a physical file is the servlet container is to allow for multiple welcome file types. \n\nImagine I had welcome files of index.jsp, then index.html, then index.htm.\n\nImagine I have a directory that is missing index.jsp, but has an index.html. If I always tried to invoke index.jsp like the welcome file list says, then the JSP servlet will return a 404 since there is no mechanism in the servlet api to defer that decision. \n\nIIRC - there are more discussions of this in the archives, but those talks are REALLY old."}, {"count": 2, "tags": [], "bug_id": 47378, "attachment_id": null, "text": "In the scenario that you described (the multiple welcome files index.jsp, index.html, etc), I would think that the container should try each in succession until it finds one that is valid.  The mechanism for \"defering that decision\" would have to be built into the DefaultServlet.  \nThis means that if a developer wanted to forward a user to some random servlet, \"/dosomething\", or to a Struts action, or to a JSF page, I would have to create some dummy file in which all it did was forward the request?\nThis has been an issue with other jsp/servlet containers in the past and the developer community fixed it.  I was hoping that the Tomcat community would provide a fix for this.  Instead it looks like if I want to run my apps on Tomcat, I will have to modify them all...", "id": 128020, "time": "2009-06-17T06:29:25Z", "creator": "robertl@jlab.org", "creation_time": "2009-06-17T06:29:25Z", "is_private": false}, {"count": 3, "tags": [], "text": "The \"other\" jsp/servlet containers that I was referring to is Jetty.\nWeblogic already handles this now.  But since the Tomcat catalina core is used in so many other containers (Geronimo, Glassfish), this has become an issue on those containers as well.", "attachment_id": null, "bug_id": 47378, "id": 128021, "time": "2009-06-17T06:32:04Z", "creator": "robertl@jlab.org", "creation_time": "2009-06-17T06:32:04Z", "is_private": false}, {"count": 4, "tags": [], "creator": "rwonly@gmail.com", "attachment_id": null, "id": 128778, "time": "2009-07-13T01:22:32Z", "bug_id": 47378, "creation_time": "2009-07-13T01:22:32Z", "is_private": false, "text": "Hi, Dear devs, \nHas this bug been resolved? I am instreseting in it, where can I get a snapshot build to have a try? Was that committed to 7.0 trunk or 6.0 trunk?\n\n-Rex"}, {"count": 5, "tags": [], "bug_id": 47378, "is_private": false, "text": "From my point of view, I don't like the work around to create a dummy file to help  request the servlet. The logic I prefer is:\n1. scan welcome list from actual files. If one is found, use it.\n2. If none are found, try servlet mappings, for example:\nif there is a /Hello in weclome list:\n  <welcome-file-list>\n    <welcome-file>/Hello</welcome-file>\n  </welcome-file-list>\nwe should find in the wel.xml to look if there is a <servlet-mapping> hold a <url-pattern> that can match \"/Hello\", such as \n<url-pattern>/Hello</url-pattern> or <url-pattern>/*</url-pattern>\n\nAny thoughts?\n\n-Rex\n\n(In reply to comment #1)\n> You'll need a physical file called index.jspf as a \"placeholder\" for the action\n> to occur. The file placeholder can be 0 bytes if you want. Or you can write a\n> filter to detect a directory is requested and forward to index.jspf.\n> \n> The reason for needing a physical file is the servlet container is to allow for\n> multiple welcome file types. \n> \n> Imagine I had welcome files of index.jsp, then index.html, then index.htm.\n> \n> Imagine I have a directory that is missing index.jsp, but has an index.html. If\n> I always tried to invoke index.jsp like the welcome file list says, then the\n> JSP servlet will return a 404 since there is no mechanism in the servlet api to\n> defer that decision. \n> \n> IIRC - there are more discussions of this in the archives, but those talks are\n> REALLY old.", "id": 128779, "time": "2009-07-13T01:57:23Z", "creator": "rwonly@gmail.com", "creation_time": "2009-07-13T01:57:23Z", "attachment_id": null}, {"count": 6, "tags": [], "text": "This wasn't fixed.\n\nSRV.9.10 makes it clear the servlet mappings in web.xml should be supported. Until this gets fixed, you can use the workaround Tim describes.\n\nPatches are always welcome.", "is_private": false, "bug_id": 47378, "id": 128780, "time": "2009-07-13T02:26:45Z", "creator": "markt@apache.org", "creation_time": "2009-07-13T02:26:45Z", "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 47378, "attachment_id": null, "text": "This issue came up in jetty recently and it became clear in e.g. discussions that the spec wording interpreted literally implies a non-workable solution.  The wording may be clarified in servlet 3.0, meanwhile see\n\nhttp://jira.codehaus.org/browse/JETTY-936\n\nfor the apparent consensus on what is intended.", "id": 128808, "time": "2009-07-13T14:18:53Z", "creator": "djencks@apache.org", "creation_time": "2009-07-13T14:18:53Z", "is_private": false}, {"count": 8, "tags": [], "creator": "funkman@apache.org", "attachment_id": null, "id": 128976, "time": "2009-07-18T18:26:49Z", "bug_id": 47378, "creation_time": "2009-07-18T18:26:49Z", "is_private": false, "text": "This might work as a patch to org.apache.tomcat.util.http.mapper.Mapper - add it before // Rule 7 -- Default servlet and after          // Rule 4 -- Welcome resources processing for servlets\n\n        // DAMMIT - welcome file processing - take 2\n        // take first matching welcome match\n        // its a copy of rule 4 since it needs to do less\n        if (mappingData.wrapper == null) {\n            boolean checkWelcomeFiles = checkJspWelcomeFiles;\n            if (!checkWelcomeFiles) {\n                char[] buf = path.getBuffer();\n                checkWelcomeFiles = (buf[pathEnd - 1] == '/');\n            }\n            if (checkWelcomeFiles) {\n                for (int i = 0; (i < context.welcomeResources.length)\n                         && (mappingData.wrapper == null); i++) {\n                    path.setOffset(pathOffset);\n                    path.setEnd(pathEnd);\n                    path.append(context.welcomeResources[i], 0,\n                                context.welcomeResources[i].length());\n                    path.setOffset(servletPath);\n\n                    internalMapExtensionWrapper(extensionWrappers,\n                                                path, mappingData);\n                    if (mappingData.wrapper == null\n                        && context.defaultWrapper != null) {\n                        mappingData.wrapper =\n                            context.defaultWrapper.object;\n                        mappingData.requestPath.setChars\n                            (path.getBuffer(), path.getStart(),\n                             path.getLength());\n                        mappingData.wrapperPath.setChars\n                            (path.getBuffer(), path.getStart(),\n                             path.getLength());\n                        mappingData.requestPath.setString(pathStr);\n                        mappingData.wrapperPath.setString(pathStr);\n                    }\n                }\n\n                path.setOffset(servletPath);\n                path.setEnd(pathEnd);\n            }\n\n        }"}, {"count": 9, "tags": [], "bug_id": 47378, "attachment_id": null, "text": "hi Tim, I tried adding this, but it does not work...\nbtw, I added one line: String pathStr = path.toString(); to pass compiling.\n-Rex\n\n(In reply to comment #8)\n> This might work as a patch to org.apache.tomcat.util.http.mapper.Mapper - add\n> it before // Rule 7 -- Default servlet and after          // Rule 4 -- Welcome\n> resources processing for servlets\n> \n>         // DAMMIT - welcome file processing - take 2\n>         // take first matching welcome match\n>         // its a copy of rule 4 since it needs to do less\n>         if (mappingData.wrapper == null) {\n>             boolean checkWelcomeFiles = checkJspWelcomeFiles;\n>             if (!checkWelcomeFiles) {\n>                 char[] buf = path.getBuffer();\n>                 checkWelcomeFiles = (buf[pathEnd - 1] == '/');\n>             }\n>             if (checkWelcomeFiles) {\n>                 for (int i = 0; (i < context.welcomeResources.length)\n>                          && (mappingData.wrapper == null); i++) {\n>                     path.setOffset(pathOffset);\n>                     path.setEnd(pathEnd);\n>                     path.append(context.welcomeResources[i], 0,\n>                                 context.welcomeResources[i].length());\n>                     path.setOffset(servletPath);\n> \n>                     internalMapExtensionWrapper(extensionWrappers,\n>                                                 path, mappingData);\n>                     if (mappingData.wrapper == null\n>                         && context.defaultWrapper != null) {\n>                         mappingData.wrapper =\n>                             context.defaultWrapper.object;\n>                         mappingData.requestPath.setChars\n>                             (path.getBuffer(), path.getStart(),\n>                              path.getLength());\n>                         mappingData.wrapperPath.setChars\n>                             (path.getBuffer(), path.getStart(),\n>                              path.getLength());\n>                         mappingData.requestPath.setString(pathStr);\n>                         mappingData.wrapperPath.setString(pathStr);\n>                     }\n>                 }\n> \n>                 path.setOffset(servletPath);\n>                 path.setEnd(pathEnd);\n>             }\n> \n>         }", "id": 129236, "time": "2009-07-29T01:56:26Z", "creator": "rwonly@gmail.com", "creation_time": "2009-07-29T01:56:26Z", "is_private": false}, {"count": 10, "tags": [], "creator": "funkman@apache.org", "attachment_id": 24065, "id": 129294, "time": "2009-07-30T08:01:55Z", "bug_id": 47378, "creation_time": "2009-07-30T08:01:55Z", "is_private": false, "text": "Created attachment 24065\nPatch against tomcat 6.0\n\nHere is a working patch. (At least in a simple test case) Previous attempt was wrong on soooo many levels."}, {"count": 11, "tags": [], "text": "\nHi Tim, I tried again.. but still not work. I am not sure if we are on the same page, this is my web.xml:\n<web-app xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" ...>\n  <welcome-file-list>\n    <welcome-file>/Hello</welcome-file>\n  </welcome-file-list>\n  <servlet>\n    <servlet-name>HelloServlet</servlet-name>\n    <servlet-class>com.abc.HelloServlet</servlet-class>\n  </servlet>\n  <servlet-mapping>\n    <servlet-name>HelloServlet</servlet-name>\n    <url-pattern>/Hello</url-pattern>\n  </servlet-mapping>\n</web-app>\n\n(In reply to comment #10)\n> Created an attachment (id=24065) [details]\n> Patch against tomcat 6.0\n> \n> Here is a working patch. (At least in a simple test case) Previous attempt was\n> wrong on soooo many levels.", "attachment_id": null, "bug_id": 47378, "id": 129388, "time": "2009-08-02T19:41:08Z", "creator": "rwonly@gmail.com", "creation_time": "2009-08-02T19:41:08Z", "is_private": false}, {"count": 12, "tags": [], "text": "and I did not create a \"placeholder\". \n\n-Rex", "is_private": false, "bug_id": 47378, "id": 129389, "time": "2009-08-02T19:43:07Z", "creator": "rwonly@gmail.com", "creation_time": "2009-08-02T19:43:07Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "rwonly@gmail.com", "is_private": false, "count": 13, "id": 129391, "time": "2009-08-02T22:40:08Z", "bug_id": 47378, "creation_time": "2009-08-02T22:40:08Z", "text": "Hi, Tim\n\nif I set \n  <welcome-file-list>\n    <welcome-file>Hello</welcome-file>      ## not \"/Hello\" here\n  </welcome-file-list>\nit seems work correctly.\n\nI tried tracking the code, and if use \"Hello\", the mappingData.wrapper != null\nBut, if use \"/Hello\", the mappingData.wrapper = = null. Then will run into the new logic, why not don't allow \"/Hello\", which is actually a servlet mapping here?\n\n-Rex"}, {"count": 14, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 129398, "time": "2009-08-03T02:18:58Z", "bug_id": 47378, "creation_time": "2009-08-03T02:18:58Z", "text": "Because welcome files define file names not servlet mappings. It needs to be Hello to be consistent."}, {"count": 15, "tags": [], "bug_id": 47378, "attachment_id": null, "text": "Ahhh ... I see the issue. My patch was to handle the case for file extension matches. For example: index.jsf (which is what was for the original report).\n\nComment 5 could be considered a \"different bug\". But in this case:\n- Welcome file is /Hello\n- Servlet exists mapped to /Hello\n- So when calculating welcome files - /Hello (while not existing as a file) is an exact match - so that should be used.\n\ntime permitting - I'll take a look later today.", "id": 129402, "time": "2009-08-03T03:59:03Z", "creator": "funkman@apache.org", "creation_time": "2009-08-03T03:59:03Z", "is_private": false}, {"count": 16, "tags": [], "text": "Given welcome files are defined without the leading / - ie 'index.html' rather than '/index.html' - I still think to match a servlet mapping of '/Hello' the welcome file setting should be 'Hello'. This would also be consistent with the current workaround of creating a dummy file.", "attachment_id": null, "bug_id": 47378, "id": 129404, "time": "2009-08-03T04:13:26Z", "creator": "markt@apache.org", "creation_time": "2009-08-03T04:13:26Z", "is_private": false}, {"count": 17, "tags": [], "text": "Created attachment 24088\nWar file demonstrating exact mappings\n\nExact mappings dont need a physical file. (At least with the way the mapper works right now)\n\nAttached is example working on tomcat 6\n\n\nas a timesaver ... here is the web.xml\n  <servlet>\n    <servlet-name>fooo</servlet-name>\n    <jsp-file>/foo.jsp</jsp-file>\n  </servlet>\n  <servlet-mapping>\n     <servlet-name>fooo</servlet-name>\n     <url-pattern>/TIMMAY</url-pattern>\n   </servlet-mapping>\n   <welcome-file-list>\n     <welcome-file>TIMMAY</welcome-file>\n   </welcome-file-list>\n\n\n\nIf / is requested - then the servlet named fooo (path=/TIMMAY) will be used. All this is without the patch I supplied. \n\nFor   Rex Wang (comments 5,11,12) - I think you have a config issue which needs moved to the user list so they can help you.", "attachment_id": 24088, "bug_id": 47378, "id": 129405, "time": "2009-08-03T04:45:22Z", "creator": "funkman@apache.org", "creation_time": "2009-08-03T04:45:22Z", "is_private": false}, {"count": 18, "tags": [], "bug_id": 47378, "is_private": false, "text": "All right, many thanks, Tim and Mark!\n\n-Rex", "id": 129411, "time": "2009-08-03T09:37:45Z", "creator": "rwonly@gmail.com", "creation_time": "2009-08-03T09:37:45Z", "attachment_id": null}, {"count": 19, "tags": [], "text": "Applied this to trunk - so it should make its way into tomcat7\nhttp://svn.apache.org/viewvc?rev=809596&view=rev\n\nI am not proposing this for backport to tomcat 6. But wouldn't be against it if it were proposed. So I'm moving this to enhancement.", "attachment_id": null, "bug_id": 47378, "id": 130067, "time": "2009-08-31T07:02:01Z", "creator": "funkman@apache.org", "creation_time": "2009-08-31T07:02:01Z", "is_private": false}, {"count": 20, "tags": [], "text": "Backporting this to 6.0.x is going to cause some nasty surprises for users such as bug 49422. Therefore, I think this should be fixed only in Tomcat 7.\n\nI am therefore moving this to Tomcat 7 and marking it as fixed.", "attachment_id": null, "bug_id": 47378, "id": 137634, "time": "2010-06-14T14:50:54Z", "creator": "markt@apache.org", "creation_time": "2010-06-14T14:50:54Z", "is_private": false}]