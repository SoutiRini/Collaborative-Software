[{"text": "When apache is running for a long time a systematics segfault appear on log_io mod. \n\nThis behaviour appear on several severs and seem systematics. \n\nAn apachectl graceful can't block this issue, I must perfom an apache restart in order to avoid this bug. \n\nHere is the error message displayed in kernel logs : \nkernel: httpd[50551]: segfault at 7fc0b9b51b60 ip 00007fc0b9b51b60 sp 00007fc0af7fda38 error 7 in mod_logio.so[7fc0b9b50000+2000]\n\nThe at and ip value are already the same on all occurences. \n\nServer version: Apache/2.4.6 (Red Hat Enterprise Linux)\nServer built:   Mar  8 2017 05:09:47\nArchitecture:   64-bit\nServer MPM:     event\n  threaded:     yes (fixed thread count)\n    forked:     yes (variable process count)", "tags": [], "bug_id": 61485, "attachment_id": null, "count": 0, "id": 200640, "time": "2017-09-04T10:30:45Z", "creator": "sgiraud@jouve.com", "creation_time": "2017-09-04T10:30:45Z", "is_private": false}, {"count": 1, "tags": [], "text": "Thanks for the report. I'd ask you a couple of questions:\n\n1) Is https://httpd.apache.org/docs/current/mod/mpm_common.html#coredumpdirectory configured? If so, would it be possible to generate a coredump to analyze?\n\n2) Is there a way for us to reproduce the issue? Specific httpd configuration, etc..\n\n3) Have you tried with more recent versions of httpd?\n\nNumber 1) is surely the most important one :)", "is_private": false, "id": 200664, "creator": "toscano.luca@gmail.com", "time": "2017-09-05T09:05:17Z", "bug_id": 61485, "creation_time": "2017-09-05T09:05:17Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 61485, "attachment_id": null, "id": 200692, "creation_time": "2017-09-06T10:08:25Z", "time": "2017-09-06T10:08:25Z", "creator": "sgiraud@jouve.com", "text": "Thanks for your answers. \n\n1) Core dump directory isn't activated in production context, we will activate it in an other environment and try to reproduce the behaviour. \n\n2) Here is the apache configuration :\n- Vhost : \n<VirtualHost *:80>\n  ServerName sante-espaceparticuliers-lppj.site.com\n  DocumentRoot \"/projet/drupal/extranet\"\n  <Directory \"/projet/drupal/extranet\">\n    AllowOverride All\n    Require all granted\n  </Directory>\n  ErrorLog \"/var/log/httpd/sante-espaceparticuliers-lppj_site_com_error.log\"\n  ServerSignature Off\n  CustomLog \"/var/log/httpd/sante-espaceparticuliers-lppj_site_com_access.log\" \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" \\\"%D\\\"\"\n  ServerAlias sante-espaceparticuliers-lppj.site.com\n  <FilesMatch \"\\.php$\">\n    SetHandler \"proxy:fcgi://127.0.0.1:9000\"\n  </FilesMatch>\n  <Directory /usr/share/fpm>\n    AllowOverride None\n    Require all granted\n  </Directory>\n   Alias /status /usr/share/fpm/status.html\n</VirtualHost>\n\n- apache configuration : \nServerTokens OS\nServerSignature On\nTraceEnable On\nServerName \"server.pub-pp.site-hds.may.jv-ig\"\nServerRoot \"/etc/httpd\"\nPidFile run/httpd.pid\nTimeout 120\nKeepAlive Off\nMaxKeepAliveRequests 100\nKeepAliveTimeout 15\nLimitRequestFieldSize 8190\nUser apache\nGroup apache\nAccessFileName .htaccess\n<FilesMatch \"^\\.ht\">\n    Require all denied\n</FilesMatch>\n<Directory />\n  Options FollowSymLinks\n  AllowOverride None\n</Directory>\nHostnameLookups Off\nErrorLog \"/var/log/httpd/error_log\"\nLogLevel warn\nEnableSendfile On\nInclude \"/etc/httpd/conf.modules.d/*.load\"\nInclude \"/etc/httpd/conf.modules.d/*.conf\"\nInclude \"/etc/httpd/conf/ports.conf\"\nLogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\" combined\nLogFormat \"%h %l %u %t \\\"%r\\\" %>s %b\" common\nLogFormat \"%{Referer}i -> %U\" referer\nLogFormat \"%{User-agent}i\" agent\nLogFormat \"%{X-Forwarded-For}i %l %u %t \\\"%r\\\" %s %b \\\"%{Referer}i\\\" \\\"%{User-agent}i\\\"\" forwarded\nIncludeOptional \"/etc/httpd/conf.d/*.conf\"\nListen 80\n\n- modules\n<IfModule alias_module>\nAlias /icons/ \"/usr/share/httpd/icons/\"\n<Directory \"/usr/share/httpd/icons\">\n    Options Indexes MultiViews\n    AllowOverride None\n    Require all granted\n</Directory>\n</IfModule>\nIndexOptions FancyIndexing VersionSort HTMLTable NameWidth=* DescriptionWidth=* Charset=UTF-8\nAddIconByEncoding (CMP,/icons/compressed.gif) x-compress x-gzip x-bzip2\nAddIconByType (TXT,/icons/text.gif) text/*\nAddIconByType (IMG,/icons/image2.gif) image/*\nAddIconByType (SND,/icons/sound2.gif) audio/*\nAddIconByType (VID,/icons/movie.gif) video/*\nAddIcon /icons/binary.gif .bin .exe\nAddIcon /icons/binhex.gif .hqx\nAddIcon /icons/tar.gif .tar\nAddIcon /icons/world2.gif .wrl .wrl.gz .vrml .vrm .iv\nAddIcon /icons/compressed.gif .Z .z .tgz .gz .zip\nAddIcon /icons/a.gif .ps .ai .eps\nAddIcon /icons/layout.gif .html .shtml .htm .pdf\nAddIcon /icons/text.gif .txt\nAddIcon /icons/c.gif .c\nAddIcon /icons/p.gif .pl .py\nAddIcon /icons/f.gif .for\nAddIcon /icons/dvi.gif .dvi\nAddIcon /icons/uuencoded.gif .uu\nAddIcon /icons/script.gif .conf .sh .shar .csh .ksh .tcl\nAddIcon /icons/tex.gif .tex\nAddIcon /icons/bomb.gif /core\nAddIcon (SND,/icons/sound2.gif) .ogg\nAddIcon (VID,/icons/movie.gif) .ogm\nAddIcon /icons/back.gif ..\nAddIcon /icons/hand.right.gif README\nAddIcon /icons/folder.gif ^^DIRECTORY^^\nAddIcon /icons/blank.gif ^^BLANKICON^^\nAddIcon /icons/odf6odt-20x22.png .odt\nAddIcon /icons/odf6ods-20x22.png .ods\nAddIcon /icons/odf6odp-20x22.png .odp\nAddIcon /icons/odf6odg-20x22.png .odg\nAddIcon /icons/odf6odc-20x22.png .odc\nAddIcon /icons/odf6odf-20x22.png .odf\nAddIcon /icons/odf6odb-20x22.png .odb\nAddIcon /icons/odf6odi-20x22.png .odi\nAddIcon /icons/odf6odm-20x22.png .odm\nAddIcon /icons/odf6ott-20x22.png .ott\nAddIcon /icons/odf6ots-20x22.png .ots\nAddIcon /icons/odf6otp-20x22.png .otp\nAddIcon /icons/odf6otg-20x22.png .otg\nAddIcon /icons/odf6otc-20x22.png .otc\nAddIcon /icons/odf6otf-20x22.png .otf\nAddIcon /icons/odf6oti-20x22.png .oti\nAddIcon /icons/odf6oth-20x22.png .oth\nDefaultIcon /icons/unknown.gif\nReadmeName README.html\nHeaderName HEADER.html\nIndexIgnore .??* *~ *# HEADER* README* RCS CVS *,v *,t\nDAVLockDB \"/var/lib/dav/lockdb\"\nAddOutputFilterByType DEFLATE application/json\nAddOutputFilterByType DEFLATE application/rss+xml\nAddOutputFilterByType DEFLATE application/x-javascript application/javascript application/ecmascript\nAddOutputFilterByType DEFLATE text/css\nAddOutputFilterByType DEFLATE text/html text/plain text/xml\nDeflateFilterNote Input instream\nDeflateFilterNote Output outstream\nDeflateFilterNote Ratio ratio\nDirectoryIndex index.html index.html.var index.cgi index.pl index.php index.xhtml\n<IfModule mpm_event_module>\n  ServerLimit            64\n  StartServers           2\n  MaxClients             350\n  MinSpareThreads        25\n  MaxSpareThreads        75\n  ThreadsPerChild        25\n  MaxRequestsPerChild    0\n  ThreadLimit            64\n  ListenBacklog          1511\n</IfModule>\n<Location /server-info>\n    SetHandler server-info\n    Require ip IP_VALUES_SUPPRESSED\n</Location>\nTypesConfig /etc/mime.types\nAddType application/x-compress .Z\nAddType application/x-gzip .gz .tgz\nAddType application/x-bzip2 .bz2\nAddLanguage ca .ca\nAddLanguage cs .cz .cs\nAddLanguage da .dk\nAddLanguage de .de\nAddLanguage el .el\nAddLanguage en .en\nAddLanguage eo .eo\nAddLanguage es .es\nAddLanguage et .et\nAddLanguage fr .fr\nAddLanguage he .he\nAddLanguage hr .hr\nAddLanguage it .it\nAddLanguage ja .ja\nAddLanguage ko .ko\nAddLanguage ltz .ltz\nAddLanguage nl .nl\nAddLanguage nn .nn\nAddLanguage no .no\nAddLanguage pl .po\nAddLanguage pt .pt\nAddLanguage pt-BR .pt-br\nAddLanguage ru .ru\nAddLanguage sv .sv\nAddLanguage zh-CN .zh-cn\nAddLanguage zh-TW .zh-tw\nAddHandler type-map var\nAddOutputFilter INCLUDES .shtml\nAddType text/html .shtml\nMIMEMagicFile \"/etc/httpd/conf/magic\"\nLanguagePriority en ca cs da de el eo es et fr he hr it ja ko ltz nl nn no pl pt pt-BR ru sv zh-CN zh-TW\nForceLanguagePriority Prefer Fallback\n<IfModule mod_proxy.c>\n  ProxyRequests Off\n    <Proxy *>\n    Require ip IP_VALUES_SUPPRESSED\n  </Proxy>\n  ProxyVia On\n</IfModule>\nBrowserMatch \"Mozilla/2\" nokeepalive\nBrowserMatch \"MSIE 4\\.0b2;\" nokeepalive downgrade-1.0 force-response-1.0\nBrowserMatch \"RealPlayer 4\\.0\" force-response-1.0\nBrowserMatch \"Java/1\\.0\" force-response-1.0\nBrowserMatch \"JDK/1\\.0\" force-response-1.0\nBrowserMatch \"Microsoft Data Access Internet Publishing Provider\" redirect-carefully\nBrowserMatch \"MS FrontPage\" redirect-carefully\nBrowserMatch \"^WebDrive\" redirect-carefully\nBrowserMatch \"^WebDAVFS/1.[0123]\" redirect-carefully\nBrowserMatch \"^gnome-vfs/1.0\" redirect-carefully\nBrowserMatch \"^gvfs/1\" redirect-carefully\nBrowserMatch \"^XML Spy\" redirect-carefully\nBrowserMatch \"^Dreamweaver-WebDAV-SCM1\" redirect-carefully\nBrowserMatch \" Konqueror/4\" redirect-carefully\n<IfModule mod_ssl.c>\n  BrowserMatch \"MSIE [2-6]\" \\\n    nokeepalive ssl-unclean-shutdown \\\n    downgrade-1.0 force-response-1.0\n  # MSIE 7 and newer should be able to use keepalive\n  BrowserMatch \"MSIE [17-9]\" ssl-unclean-shutdown\n</IfModule>\n<Location /server-status>\n    SetHandler server-status\n    Require ip IP_VALUES_SUPPRESSED\n</Location>\nExtendedStatus On\n<IfModule mod_proxy.c>\n    # Show Proxy LoadBalancer status in mod_status\n    ProxyStatus On\n</IfModule>\n<IfModule mod_fcgid.c>\n  AddHandler fcgid-script fcg fcgi fpl\n  FcgidIPCDir /run/mod_fcgid\n  FcgidProcessTableFile /run/mod_fcgid/fcgid_shm\n</IfModule>\n\n\n3) We could'nt tried to use a most rcent version of httpd, this version was imposed by the customer (owner of the drupal application). \n\nI stay available for any complementary informations. \n\nThanks in advance.", "is_private": false}, {"count": 3, "tags": [], "bug_id": 61485, "attachment_id": null, "id": 200693, "time": "2017-09-06T10:26:56Z", "creator": "toscano.luca@gmail.com", "creation_time": "2017-09-06T10:26:56Z", "is_private": false, "text": "Thanks a lot, the coredump will be vital to figure out what's happening.\n\nI am a bit ignorant about https://httpd.apache.org/docs/2.4/mod/mod_logio.html but I didn't find any trace of its configuration in your httpd config. Are you using it? Can you point me where?"}, {"count": 4, "tags": [], "text": "We are doing our best in order to have a core dump. \n\nThe logio module is load with log_config.load and logio.load\n\nOur log configuration is \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" \\\"%D\\\"\" but logio seems used only with %I %O %S %^FB. So I'm not sure using it. In fact this module was introduced in our configuration form puppet apache module. logio.load is include by default on Redhat and on Freebsd systems, and log_config is include for all systems, and seem usefull. For example it's the only one module default module loaded for suse' systems. \n\nAfter looking the detailled options of logio the FB option seems really useful, and be used in future on our infrastructure. We already log the time taken to serve the request, in microseconds (%D).\n\nI can't remove loading of this module without major changes in puppet apache module. According puppet module documentation, this module isn't configureable at this time. \n  # These are modules required to run the default configuration.\n  # They are not configurable at this time, so we just include\n  # them to make sure it works.\n\n\nIs it a revelant test to remove loading this module in order to check if segfault already appear ?", "attachment_id": null, "bug_id": 61485, "id": 200700, "time": "2017-09-06T11:48:01Z", "creator": "sgiraud@jouve.com", "creation_time": "2017-09-06T11:48:01Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 61485, "is_private": false, "id": 200701, "creation_time": "2017-09-06T12:05:20Z", "time": "2017-09-06T12:05:20Z", "creator": "toscano.luca@gmail.com", "text": "The module register basic info about every request when it is loaded, and then it displays them when requested by CustomLog, so it makes sense that it could lead to a segfault even if not explicitly used with some directive.\n\nLet's see if we manage to get a coredump, I have some suspicions but I'd need to reproduce first. Your httpd version is very old (2.4.6 vs 2.4.26 now) so it might as well be that it is an old bug from the past (need to verify).", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 61485, "attachment_id": null, "id": 200703, "creation_time": "2017-09-06T12:09:57Z", "time": "2017-09-06T12:09:57Z", "creator": "toscano.luca@gmail.com", "text": "Have you noticed, by any chance, if the segfault is triggered by a particular set of requests? It might be easy to track using error/access logs comparing them with when the segfault happens.", "is_private": false}, {"count": 7, "tags": [], "text": "Maybe I may add the FB option in order to use completely this module, this may solve this bug. What is your point of view about this ? \n\nAbout the core it will need somme time to reproduce the behaviour. \nIn produciton context, this bug is reproduced only every 2 month without apache restart. Another team will build a test environnement in order to reproduce the behaviour as quickly as possible. \n\nAbout the behaviour, I haven't noticed a particular request making this segfault. It is reproduced on several differents website (3 drupal websites). \n\nWe have a distributed infrastructure composed of 3 apache. When a segfault appear on a first apache, approximately 24h after, the two other apache have the same behaviour. When the segfault appear some static webpages are already served (GET /). But when the first segfault appear all child are exit on segfault signal.", "attachment_id": null, "bug_id": 61485, "id": 200705, "time": "2017-09-06T12:40:57Z", "creator": "sgiraud@jouve.com", "creation_time": "2017-09-06T12:40:57Z", "is_private": false}, {"count": 8, "attachment_id": null, "bug_id": 61485, "is_private": false, "id": 200721, "time": "2017-09-07T10:18:47Z", "creator": "toscano.luca@gmail.com", "creation_time": "2017-09-07T10:18:47Z", "tags": [], "text": "(In reply to sgiraud from comment #7)\n> Maybe I may add the FB option in order to use completely this module, this\n> may solve this bug. What is your point of view about this ? \n\nI think that it will not solve the issue, mod_logio collects the data anyway, I think that you are hitting a corner case in which the module dereference a null pointer or something similar (but for the moment it is only a speculation). I checked https://github.com/apache/httpd/commits/trunk/modules/loggers/mod_logio.c and I don't see any recent fix for any segfault report, so it might still be an issue with 2.4.x recent versions.\n\n> \n> About the core it will need somme time to reproduce the behaviour. \n> In produciton context, this bug is reproduced only every 2 month without\n> apache restart. Another team will build a test environnement in order to\n> reproduce the behaviour as quickly as possible. \n> \n> About the behaviour, I haven't noticed a particular request making this\n> segfault. It is reproduced on several differents website (3 drupal\n> websites). \n> \n> We have a distributed infrastructure composed of 3 apache. When a segfault\n> appear on a first apache, approximately 24h after, the two other apache have\n> the same behaviour. When the segfault appear some static webpages are\n> already served (GET /). But when the first segfault appear all child are\n> exit on segfault signal.\n\nThanks, let's wait the coredump then :)"}, {"count": 9, "tags": [], "creator": "toscano.luca@gmail.com", "attachment_id": null, "is_private": false, "id": 202416, "time": "2017-11-26T12:11:39Z", "bug_id": 61485, "creation_time": "2017-11-26T12:11:39Z", "text": "Hi there, any chance that you got a core-dump?"}]