[{"count": 0, "tags": [], "bug_id": 56351, "attachment_id": 31478, "text": "Created attachment 31478\nerror_log.txt\n\nUsing mod_auth_form in httpd.conf causes segmentation fault when accessing the server.\n\nI tested this in a fresh ubuntu virtual machine. This bug is easily reproducible. This happens every time when httpd is started and the site is accessed.\n\nI tested this with httpd.conf configuration that is simplified and not fully functional.\n\nOriginally I found this bug when trying to use mod_auth_form and session_dbd with AuthBasicProvider ldap in Ubuntu Trusty. Changing AuthBasicProvider from ldap to file worked in that machine, the site was working correctly after that.\n\n\n\nError log:\n[core:notice] [pid 11321:tid 140385410832256] AH00051: child pid 11322 exit signal Segmentation fault (11), possible coredump in /debug\n\nFull log in attachment error_log.txt\n\n\nGDB:\n#2  ap_mpm_podx_check (pod=<optimized out>) at mpm_unix.c:535\n\nSee attachment gdb.txt for more information.\n\n\nconf/httpd.conf (added this after default configuration):\n\nLoadModule auth_form_module modules/mod_auth_form.so\n\nCoreDumpDirectory /debug\nMaxClients 1\nThreadsPerChild 1\n\nServerName testserver\nDocumentRoot /var/www/html\nLogLevel debug\n<Location />\n  #AuthBasicProvider ldap\n  AuthBasicProvider file\n  AuthType form\n  AuthName test\n  Require valid-user\n</Location>\n\n\nBuild process and configuration is documented in attachment build.txt\n\n\nServer version: Apache/2.4.10-dev (Unix)\nServer loaded:  APR 2.0.0-dev\n\n# uname -a\nLinux test3 3.13.0-19-generic #40-Ubuntu SMP Mon Mar 24 02:36:06 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux\n\n\nSee attachment info.txt for more information about versions.", "id": 174297, "time": "2014-04-05T10:01:48Z", "creator": "bitaround@gmail.com", "creation_time": "2014-04-05T10:01:48Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 56351, "attachment_id": 31479, "text": "Created attachment 31479\ngdb.txt", "id": 174298, "time": "2014-04-05T10:02:15Z", "creator": "bitaround@gmail.com", "creation_time": "2014-04-05T10:02:15Z", "is_private": false}, {"count": 2, "tags": [], "creator": "bitaround@gmail.com", "attachment_id": 31480, "id": 174299, "time": "2014-04-05T10:02:42Z", "bug_id": 56351, "creation_time": "2014-04-05T10:02:42Z", "is_private": false, "text": "Created attachment 31480\nbuild.txt"}, {"count": 3, "tags": [], "creator": "bitaround@gmail.com", "attachment_id": 31481, "id": 174300, "time": "2014-04-05T10:02:58Z", "bug_id": 56351, "creation_time": "2014-04-05T10:02:58Z", "is_private": false, "text": "Created attachment 31481\ninfo.txt"}, {"count": 4, "tags": [], "bug_id": 56351, "attachment_id": null, "text": "(In reply to bitaround from comment #1)\n> Created attachment 31479 [details]\n> gdb.txt\n\nCould you please provide gdb's output of \"thread appy all bt\" so that we can see the failing thread's backtrace?", "id": 174301, "time": "2014-04-05T10:33:44Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-04-05T10:33:44Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 56351, "attachment_id": 31482, "id": 174302, "creation_time": "2014-04-05T10:37:38Z", "time": "2014-04-05T10:37:38Z", "creator": "bitaround@gmail.com", "text": "Created attachment 31482\ngdb2.txt\n\nthread appy all bt", "is_private": false}, {"count": 6, "tags": [], "creator": "ylavic.dev@gmail.com", "text": "You probably need to also load mod_session and mod_request with :\nLoadModule session_module modules/mod_session.so\nLoadModule request_module modules/mod_request.so", "id": 174303, "time": "2014-04-05T11:00:25Z", "bug_id": 56351, "creation_time": "2014-04-05T11:00:25Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "creator": "bitaround@gmail.com", "attachment_id": 31483, "id": 174304, "time": "2014-04-05T11:11:13Z", "bug_id": 56351, "creation_time": "2014-04-05T11:11:13Z", "is_private": false, "text": "Created attachment 31483\ngdb3.txt\n\n(gdb) thread apply all bt\n\nhttpd.conf with:\nLoadModule session_module modules/mod_session.so\nLoadModule request_module modules/mod_request.so"}, {"count": 8, "tags": [], "creator": "ylavic.dev@gmail.com", "attachment_id": null, "id": 174313, "time": "2014-04-06T19:40:30Z", "bug_id": 56351, "creation_time": "2014-04-06T19:40:30Z", "is_private": false, "text": "I didn't figure out your configuration does not include all the needed Authentication and Authorization modules.\n\nYour configuration should load several modules like :\n\nLoadModule authn_core_module modules/mod_authn_core.so\nLoadModule authn_file_module modules/mod_authn_file.so\nLoadModule authz_core_module modules/mod_authz_core.so\nLoadModule authz_user_module modules/mod_authz_user.so\nLoadModule auth_form_module modules/mod_auth_form.so\nLoadModule session_module modules/mod_session.so\nLoadModule request_module modules/mod_request.so\n\nAnd then use :\n   AuthFormProvider file\ninstead of :\n   AuthBasicProvider file\n\nYou should refer to mod_auth_form documentation (http://httpd.apache.org/docs/2.4/mod/mod_auth_form.html), or more generally to the documentation for Authentication and Authorization (http://httpd.apache.org/docs/2.4/howto/auth.html)."}, {"count": 9, "tags": [], "creator": "ylavic.dev@gmail.com", "text": "The crash when AuthFormProvider is missing has been addressed by r1531672 and proposed for backport.", "id": 174317, "time": "2014-04-07T09:32:25Z", "bug_id": 56351, "creation_time": "2014-04-07T09:32:25Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 56351, "attachment_id": null, "text": "Changing \"AuthBasicProvider ldap\" to \"AuthFormProvider ldap\" or \"AuthBasicProvider file\" to \"AuthFormProvider file\" fixes the problem in that Ubuntu installation and this test configuration.\n\nSo this is a duplicate of #r1531672.", "id": 174318, "time": "2014-04-07T09:39:56Z", "creator": "bitaround@gmail.com", "creation_time": "2014-04-07T09:39:56Z", "is_private": false}, {"count": 11, "tags": [], "creator": "bitaround@gmail.com", "attachment_id": null, "id": 174320, "time": "2014-04-07T09:44:51Z", "bug_id": 56351, "creation_time": "2014-04-07T09:44:51Z", "is_private": false, "text": "I correct: that r1531672 was not a bug."}, {"count": 12, "tags": [], "creator": "ylavic.dev@gmail.com", "attachment_id": null, "id": 174427, "time": "2014-04-09T20:19:46Z", "bug_id": 56351, "creation_time": "2014-04-09T20:19:46Z", "is_private": false, "text": "Thanks; will be fixed in next 2.4.10."}, {"count": 13, "tags": [], "creator": "michael@loot.co.za", "attachment_id": null, "id": 174723, "time": "2014-04-19T10:28:17Z", "bug_id": 56351, "creation_time": "2014-04-19T10:28:17Z", "is_private": false, "text": "We're not using mod_auth_form, but are getting a SEGV in the same location, only for us it's on graceful restart after log rotate:  \n\n(gdb) bt\n#0  0x00a72410 in __kernel_vsyscall ()\n#1  0x00d37b8b in read () from /lib/libpthread.so.0\n#2  0x08095884 in ap_mpm_podx_check (pod=0x9b79208) at mpm_unix.c:535\n#3  0x080a5cbe in child_main (child_num_arg=3) at worker.c:1341\n#4  0x080a6acb in make_child (s=0x9b64ee8, slot=3) at worker.c:1427\n#5  0x080a6b97 in startup_children (number_to_start=4) at worker.c:1452\n#6  0x080a744a in server_main_loop (_pconf=0x9b400a8, plog=0x9b669b0,   s=0x9b64ee8) at worker.c:1752\n\nPrior to that, the httpd runs fine.  We've just upgraded to 2.4.9 from 2.2.x and started getting this after the first log rotation.\n\nIs it possible that the impact of this could be wider, and if so, will the anticipated 2.4.10 change fix it, and are there any workarounds?\n\nApart from standard Apache modules, we do use an in-house developed module that's designed to be thread safe, and has run in 2.x servers for 10+ years without any issues. Thanks!"}, {"count": 14, "tags": [], "bug_id": 56351, "attachment_id": null, "text": "(In reply to Michael van Rooyen from comment #13)\n> We're not using mod_auth_form, but are getting a SEGV in the same location,\n> only for us it's on graceful restart after log rotate:  \n> \n> (gdb) bt\n> #0  0x00a72410 in __kernel_vsyscall ()\n> #1  0x00d37b8b in read () from /lib/libpthread.so.0\n> #2  0x08095884 in ap_mpm_podx_check (pod=0x9b79208) at mpm_unix.c:535\n> #3  0x080a5cbe in child_main (child_num_arg=3) at worker.c:1341\n> #4  0x080a6acb in make_child (s=0x9b64ee8, slot=3) at worker.c:1427\n> #5  0x080a6b97 in startup_children (number_to_start=4) at worker.c:1452\n> #6  0x080a744a in server_main_loop (_pconf=0x9b400a8, plog=0x9b669b0,  \n> s=0x9b64ee8) at worker.c:1752\n> \n> Prior to that, the httpd runs fine.  We've just upgraded to 2.4.9 from 2.2.x\n> and started getting this after the first log rotation.\n> \n> Is it possible that the impact of this could be wider, and if so, will the\n> anticipated 2.4.10 change fix it, and are there any workarounds?\n> \n> Apart from standard Apache modules, we do use an in-house developed module\n> that's designed to be thread safe, and has run in 2.x servers for 10+ years\n> without any issues. Thanks!\n\nOpen a new bug and get a backtrace of the thread that crashed, not the first thread.", "id": 174724, "time": "2014-04-19T11:22:50Z", "creator": "covener@gmail.com", "creation_time": "2014-04-19T11:22:50Z", "is_private": false}, {"count": 15, "tags": [], "bug_id": 56351, "attachment_id": null, "text": "Same sort of SEGV seen on Solaris 10 Sparc ( 64-bit ) with 2.4.10 thus : \n\ntrend-dev $ su -\nPassword: \nOracle Corporation      SunOS 5.10      Generic Patch   January 2005\n# dbx /usr/local/bin/httpd /var/crash/trend-dev/coredump/node_trend-dev-host_sun4v-zone_z_004-time_1413532243-pid_7566-uid_80-gid_80-fid_httpd.core \nReading httpd\ncore file header read successfully\nReading ld.so.1\nReading libpcre.so.1.0.1\nReading libaprutil-1.so.0.5.3\nReading libexpat.so.1.6.0\nReading libapr-1.so.0.5.1\nReading libuuid.so.1\nReading libsendfile.so.1\nReading librt.so.1\nReading libsocket.so.1\nReading libnsl.so.1\nReading libpthread.so.1\nReading libc.so.1\nReading libaio.so.1\nReading libmd.so.1\nReading libc_psr.so.1\nReading libmp.so.2\nReading libscf.so.1\nReading libdoor.so.1\nReading libuutil.so.1\nReading libgen.so.1\nReading libresolv.so.2\nReading libm.so.2\nReading libldap.so.5\nReading libthread.so.1\nReading libdl.so.1\nReading libsasl.so.1\nReading libmd_psr.so.1\nReading libplc4.so\nReading libnspr4.so\nReading libssl3.so\nReading libnss3.so\nReading libnssutil3.so\nReading libplds4.so\nReading mod_authn_file.so\nReading mod_authn_anon.so\nReading mod_authn_core.so\nReading mod_authz_host.so\nReading mod_authz_groupfile.so\nReading mod_authz_user.so\nReading mod_authz_core.so\nReading mod_access_compat.so\nReading mod_auth_basic.so\nReading mod_auth_digest.so\nReading mod_file_cache.so\nReading mod_cache.so\nReading mod_socache_shmcb.so\nReading mod_reqtimeout.so\nReading mod_ext_filter.so\nReading mod_include.so\nReading mod_filter.so\nReading mod_deflate.so\nReading libz.so.1.2.7\nReading mod_mime.so\nReading mod_log_config.so\nReading mod_logio.so\nReading mod_env.so\nReading mod_expires.so\nReading mod_headers.so\nReading mod_usertrack.so\nReading mod_unique_id.so\nReading mod_setenvif.so\nReading mod_version.so\nReading mod_proxy.so\nReading mod_proxy_connect.so\nReading mod_proxy_ftp.so\nReading mod_proxy_http.so\nReading mod_unixd.so\nReading mod_dav.so\nReading mod_status.so\nReading mod_autoindex.so\nReading mod_info.so\nReading mod_suexec.so\nReading mod_cgid.so\nReading mod_dav_fs.so\nReading mod_vhost_alias.so\nReading mod_negotiation.so\nReading mod_dir.so\nReading mod_actions.so\nReading mod_speling.so\nReading mod_userdir.so\nReading mod_alias.so\nReading mod_rewrite.so\nReading libphp5.so\nReading libmysqlclient.so.18.0.0\nReading libgmp.so.10.2.0\nReading libintl.so.8.1.1\nReading libX11.so.4\nReading libXpm.so.4\nReading libpng15.so.15.14.0\nReading libjpeg.so.9.0.0\nReading libssl.so.1.0.0\nReading libcrypto.so.1.0.0\nReading libcurl.so.4.3.0\nReading libidn.so.11.6.9\nReading libssh2.so.1.0.1\nReading libfreetype.so.6.10.0\nReading libxml2.so.2.9.0\nReading libiconv.so.2.5.1\nReading libgcc_s.so.1\nReading liblzma.so.5.0.5\nReading mod_ssl.so\nReading en_US.UTF-8.so.3\nReading methods_unicode.so.3\nt@1 (l@1) terminated by signal SEGV (Segmentation Fault)\n0xffffffff7dddc858: _read+0x000c:       bcc,pt   %icc,_read+0x20        ! 0xffffffff7dddc86c\nCurrent function is ap_mpm_podx_check\ndbx: warning: can't find file \"/usr/local/build/httpd-2.4.10_SunOS5.10_sparcv9.002/server/mpm_unix.c\"\ndbx: warning: see `help finding-files'\n(dbx) where                                                                  \ncurrent thread: t@1\n  [1] _read(0x4, 0xffffffff7ffff273, 0x1, 0x100082a5c, 0x0, 0x1), at 0xffffffff7dddc858 \n  [2] read(0x6, 0xffffffff7ffff273, 0x1, 0x0, 0xffffffff7df00200, 0x0), at 0xffffffff7ddca240 \n=>[3] ap_mpm_podx_check(pod = 0x1002a8e20), line 535 in \"mpm_unix.c\"\n  [4] child_main(child_num_arg = 2), line 2272 in \"event.c\"\n  [5] make_child(s = 0x100201158, slot = 2), line 2359 in \"event.c\"\n  [6] perform_idle_server_maintenance(), line 2556 in \"event.c\"\n  [7] server_main_loop(remaining_children_to_start = 0), line 2684 in \"event.c\"\n  [8] event_run(_pconf = 0x1001d6cb8, plog = 0x100204ea8, s = 0x100201158), line 2743 in \"event.c\"\n  [9] ap_run_mpm(0x1001d6cb8, 0x100204ea8, 0x100201158, 0x100201158, 0x0, 0x0), at 0x10003b540 \n  [10] main(argc = 3, argv = 0xffffffff7ffffb48), line 777 in \"main.c\"\n(dbx) quit\ntrend-dev #\n\nThat is the thread the SEGV'd and that back trace looks correct. \n\nWhat other data is needed ?", "id": 178555, "time": "2014-10-17T15:43:26Z", "creator": "dclarke@blastwave.org", "creation_time": "2014-10-17T15:43:26Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 56351, "attachment_id": null, "id": 178560, "creation_time": "2014-10-17T17:10:59Z", "time": "2014-10-17T17:10:59Z", "creator": "trawick@apache.org", "text": "These backtraces that you'll see which show a crash in read() are not valid.  (You can't crash there.)  They're backtraces of the main thread in a child, not a backtrace of the thread that crashed.  Just use pstack against the core on Solaris.", "is_private": false}, {"count": 17, "tags": [], "creator": "dclarke@blastwave.org", "attachment_id": 32125, "id": 178589, "time": "2014-10-18T17:46:34Z", "bug_id": 56351, "creation_time": "2014-10-18T17:46:34Z", "is_private": false, "text": "Created attachment 32125\noutput from pstack on Solaris 10\n\noutput from \n\n  $ pstack time_1413532243-pid_7566-uid_80-gid_80-fid_httpd.core"}, {"count": 18, "tags": [], "creator": "dclarke@blastwave.org", "attachment_id": null, "id": 178590, "time": "2014-10-18T17:57:43Z", "bug_id": 56351, "creation_time": "2014-10-18T17:57:43Z", "is_private": false, "text": "Not sure if this helps : \n\n(dbx) regs                       \ncurrent thread: t@1\ncurrent frame:  [3]\ng0-g1    0x0000000000000000 0x0000000000000003\ng2-g3    0x0000000000000000 0x0000000000000000\ng4-g5    0x0000000000001c00 0xffffffffff7fffff\ng6-g7    0x0000000000000000 0xffffffff7df00200\no0-o1    0x0000000000000006 0xffffffff7ffff273\no2-o3    0x0000000000000001 0x0000000000000000\no4-o5    0xffffffff7df00200 0x0000000000000000\no6-o7    0xffffffff7fffe9b1 0x0000000100082a5c\nl0-l1    0xffffffff7ffff273 0x0000000000000006\nl2-l3    0xffffffff7ffff248 0x0000000100291d30\nl4-l5    0x0000000100291d58 0x0000000000000000\nl6-l7    0x0000000000000000 0xffffffff7eb45358\ni0-i1    0x00000001002a8e20 0x000000010009fc78\ni2-i3    0x00000001000a29d0 0x0000000100291d08\ni4-i5    0x00000001002914f8 0x0000000000000000\ni6-i7    0xffffffff7fffea81 0x00000001000a3eec\ny        0x0000000000000000\nccr      0x0000000000000045\npc       0x0000000100082a5c:ap_mpm_podx_check+0x34    call     read [PLT]       ! 0x1001c0100\nnpc      0xffffffff7dddc85c:_readlink    mov      90, %g1\n\n\nMay be worth looking at the memory contents if needed. The joy of having a \nfull core file means we can do that. \n\nLooking at lwp#1 in thread 1 I see : \n\n ffffffff7dddc858 _read (6, ffffffff7ffff273, 1, 0, ffffffff7df00200, 0) + c\n 0000000100082a5c ap_mpm_podx_check (1002a8e20, 10009fc78, 1000a29d0, 100291d08, 1002914f8, 0) + 34\n\n\nSo we could, if we wanted, look at contents of memory on the heap or \nwhere ever : \n\n(dbx) x 0xffffffff7ffff273\n0xffffffff7ffff273:  0x010009fc\n(dbx) x 0xffffffff7ffff273 / LX\n0xffffffff7ffff273:  0x010009fc78000000\n(dbx) x 0xffffffff7ffff273 / 16 x  \n0xffffffff7ffff273:  0x0100 0x09fc 0x7800 0x0000 0x0100 0x2a8e 0x2000 0x0000\n0xffffffff7ffff283:  0x0100 0x2a8e 0x2000 0x0000 0x0100 0x1c78 0x8000 0x0000\n\nNot sure what we are looking for however. If anything."}, {"count": 19, "tags": [], "bug_id": 56351, "attachment_id": null, "text": "AFAICT every thread but the one in mod_php was blocked, so it's probably the crasher. I don't see any relationship to this bug, and mod_php is not something we take bug reports for in this bugzilla.", "id": 178591, "time": "2014-10-18T18:06:07Z", "creator": "covener@gmail.com", "creation_time": "2014-10-18T18:06:07Z", "is_private": false}, {"count": 20, "tags": [], "creator": "dclarke@blastwave.org", "attachment_id": null, "id": 178592, "time": "2014-10-18T18:08:12Z", "bug_id": 56351, "creation_time": "2014-10-18T18:08:12Z", "is_private": false, "text": "Based on my experience dealing with the PHP people regarding this will be futile.\nTherefore there is little that can be done."}, {"count": 21, "tags": [], "creator": "dclarke@blastwave.org", "text": "Taking a quick glance at int ap_mpm_podx_check ( ap_pod_t *pod ) at :\n\nhttp://ci.apache.org/projects/httpd/trunk/doxygen/group__APACHE__MPM.html\n\nThat function serves to \"Check the extended pipe to determine if the process has been signalled to die.\"\n\n\nI also see : \n\nhttp://ci.apache.org/projects/httpd/trunk/doxygen/structap__pod__t.html\n\n\nSo whereever the problem is that toses thirty core files a day it is deep \nin the belly of the beast and possibly non-trivial to track down.", "id": 178593, "time": "2014-10-18T18:15:14Z", "bug_id": 56351, "creation_time": "2014-10-18T18:15:14Z", "is_private": false, "attachment_id": null}, {"count": 22, "tags": [], "bug_id": 56351, "attachment_id": null, "id": 178988, "creation_time": "2014-11-05T23:13:31Z", "time": "2014-11-05T23:13:31Z", "creator": "ylavic.dev@gmail.com", "text": "Backported to 2.4.10 with r1588247.", "is_private": false}]