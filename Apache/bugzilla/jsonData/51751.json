[{"count": 0, "tags": [], "bug_id": 51751, "attachment_id": null, "id": 148947, "creation_time": "2011-09-01T11:50:39Z", "time": "2011-09-01T11:50:39Z", "creator": "martin@inetsolutions.de", "text": "if we use webdav all is fine, but if we add \"ChrootDir /apache2/\" to httpd.conf webdav will crash with:\n\n[notice] child pid 28707 exit signal Segmentation fault (11)\n\nloglevel debug will not add any more information\n\n\n\nhttpd.conf\n\n.\n.\n.\nChrootDir /apache2/\n.\n.\n.\nDavLockDB \"var/DavLock\"\n\nAlias /webdav /web/webdav\n<Location /webdav>\n            DAV On\n</Location>\n\n\nLinux version 2.6.26-2-amd64 (Debian 2.6.26-24lenny1)\n\nwe copied all libs from /lib /lib64 to the jail, same issue", "is_private": false}, {"count": 1, "tags": [], "bug_id": 51751, "attachment_id": null, "text": "Please provide a backtrace (http://httpd.apache.org/dev/debugging.html).", "id": 148950, "time": "2011-09-01T12:44:03Z", "creator": "rpluem@apache.org", "creation_time": "2011-09-01T12:44:03Z", "is_private": false}, {"count": 2, "attachment_id": null, "creator": "martin@inetsolutions.de", "text": "gladly\n\ngdb /lamp/apache2/bin/httpd\n\n\nGNU gdb 6.8-debian\nCopyright (C) 2008 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"x86_64-linux-gnu\"...\n(gdb) run -X -d /lamp/apache2/\nStarting program: /lamp/apache2/bin/httpd -X -d /lamp/apache2/\n[Thread debugging using libthread_db enabled]\n[New Thread 0x7f5a01ad46e0 (LWP 3343)]\n\nProgram received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0x7f5a01ad46e0 (LWP 3343)]\napr_dbm_fetch (dbm=0x17437b8, key={dptr = 0x501b67 \"METADATA\", dsize = 8}, pvalue=0x7fff14da2730) at dbm/apr_dbm.c:221\n221         return (*dbm->type->fetch)(dbm, key, pvalue);", "id": 148953, "time": "2011-09-01T13:08:24Z", "bug_id": 51751, "creation_time": "2011-09-01T13:08:24Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "is_private": false, "id": 148958, "time": "2011-09-01T16:15:13Z", "bug_id": 51751, "creation_time": "2011-09-01T16:15:13Z", "text": "Please provide the whole stacktrace of all threads.\nIs there a directory /apache2/var/DavLock?\nIf yes can you please try with\n\nDavLockDB /var/DavLock"}, {"count": 4, "tags": [], "bug_id": 51751, "attachment_id": null, "id": 148959, "creation_time": "2011-09-01T16:25:15Z", "time": "2011-09-01T16:25:15Z", "creator": "martin@inetsolutions.de", "text": "DavLock is the file not dir, or am i wrong ?\n\nthere is a 0777 dir : /apache2/var/\n\nif we #chrootDir the file will be there, but with chroot there is no such file\n\n\n\nhow do i get the whole trace?", "is_private": false}, {"text": "Please try DavLockDB /var/DavLock\n(mind the leading /).\nSee http://httpd.apache.org/dev/debugging.html regarding backtraces.", "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "count": 5, "id": 148960, "time": "2011-09-01T16:33:53Z", "bug_id": 51751, "creation_time": "2011-09-01T16:33:53Z", "is_private": false}, {"count": 6, "tags": [], "creator": "martin@inetsolutions.de", "attachment_id": null, "is_private": false, "id": 148961, "time": "2011-09-01T17:11:30Z", "bug_id": 51751, "creation_time": "2011-09-01T17:11:30Z", "text": "we changed to DavLockDB /var/DavLock\n\nthere is a /var dir and a /apache2/var with 0777 ... same issue \"segmentation fault\"\n\n\n\nbacktrace:\n\n\n#0  apr_dbm_fetch (dbm=0x94b7d8, key={dptr = 0x501b67 \"METADATA\", dsize = 8}, pvalue=0x7fff944e7450) at dbm/apr_dbm.c:221\n#1  0x00000000004ba5fa in dav_dbm_fetch (db=0x94bad8, key={dptr = 0x501b67 \"METADATA\", dsize = 8}, pvalue=0x7fff944e7450) at dbm.c:190\n#2  0x00000000004bab61 in dav_propdb_open (pool=0x94b7d8, resource=<value optimized out>, ro=<value optimized out>, pdb=0x952a70)\n    at dbm.c:400\n#3  0x00000000004aa151 in dav_really_open_db (propdb=0x952a50, ro=0) at props.c:499\n#4  0x00000000004aa9a7 in dav_get_props (propdb=0x952a50, doc=<value optimized out>) at props.c:805\n#5  0x00000000004a55f6 in dav_propfind_walker (wres=0x7fff944e7768, calltype=<value optimized out>) at mod_dav.c:1938\n#6  0x00000000004b786d in dav_fs_walker (fsctx=0x7fff944e7760, depth=0) at repos.c:1423\n#7  0x00000000004b80d2 in dav_fs_internal_walk (params=0x7fff944e79f0, depth=0, is_move=0, root_dst=0x0, response=0x7fff944e7a88)\n    at repos.c:1764\n#8  0x00000000004a5123 in dav_method_propfind (r=0x94d860) at mod_dav.c:2076\n#9  0x00000000004a898d in dav_handler (r=0x94d860) at mod_dav.c:4661\n#10 0x0000000000446d23 in ap_run_handler (r=0x94d860) at config.c:158\n#11 0x000000000044a25e in ap_invoke_handler (r=0x94d860) at config.c:376\n#12 0x000000000049e26e in ap_process_request (r=0x94d860) at http_request.c:282\n#13 0x000000000049b158 in ap_process_http_connection (c=0x93b9c0) at http_core.c:190\n#14 0x000000000044e2a3 in ap_run_process_connection (c=0x93b9c0) at connection.c:43\n#15 0x00000000004ce620 in child_main (child_num_arg=<value optimized out>) at prefork.c:667\n#16 0x00000000004ce8b8 in make_child (s=0x7f3c58, slot=0) at prefork.c:712\n#17 0x00000000004ceed0 in ap_mpm_run (_pconf=<value optimized out>, plog=<value optimized out>, s=<value optimized out>) at prefork.c:988\n#18 0x00000000004334e5 in main (argc=2, argv=0x7fff944e80a8) at main.c:739\n\n\nlive backtrace with \"gdb httpd PID\" does not work. i hope this information is what you need"}, {"count": 7, "tags": [], "bug_id": 51751, "attachment_id": null, "id": 148962, "creation_time": "2011-09-01T17:21:03Z", "time": "2011-09-01T17:21:03Z", "creator": "martin@inetsolutions.de", "text": "Attaching to process 4945\nReading symbols from /lamp/apache2/bin/httpd...done.\nReading symbols from /usr/lib/libz.so.1...done.\nLoaded symbols for /usr/lib/libz.so.1\nReading symbols from /usr/lib/libssl.so.0.9.8...done.\nLoaded symbols for /usr/lib/libssl.so.0.9.8\nReading symbols from /usr/lib/libcrypto.so.0.9.8...done.\nLoaded symbols for /usr/lib/libcrypto.so.0.9.8\nReading symbols from /lamp/apache2/lib/libm.so.6...done.\nLoaded symbols for /lamp/apache2/lib/libm.so.6\nReading symbols from /lamp/apache2/lib/libaprutil-1.so.0...done.\nLoaded symbols for /lamp/apache2/lib/libaprutil-1.so.0\nReading symbols from /lamp/berkeleydb.4.5/lib/libdb-4.5.so...done.\nLoaded symbols for /lamp/berkeleydb.4.5/lib/libdb-4.5.so\nReading symbols from /usr/lib/libexpat.so.1...done.\nLoaded symbols for /usr/lib/libexpat.so.1\nReading symbols from /lamp/apache2/lib/libapr-1.so.0...done.\nLoaded symbols for /lamp/apache2/lib/libapr-1.so.0\nReading symbols from /lamp/apache2/lib/librt.so.1...done.\nLoaded symbols for /lamp/apache2/lib/librt.so.1\nReading symbols from /lamp/apache2/lib/libcrypt.so.1...done.\nLoaded symbols for /lamp/apache2/lib/libcrypt.so.1\nReading symbols from /lamp/apache2/lib/libpthread.so.0...done.\n[Thread debugging using libthread_db enabled]\n[New Thread 0x7f5b0065b6e0 (LWP 4945)]\nLoaded symbols for /lamp/apache2/lib/libpthread.so.0\nReading symbols from /lamp/apache2/lib/libdl.so.2...done.\nLoaded symbols for /lamp/apache2/lib/libdl.so.2\nReading symbols from /lamp/apache2/lib/libc.so.6...done.\nLoaded symbols for /lamp/apache2/lib/libc.so.6\nReading symbols from /lib/ld-linux-x86-64.so.2...done.\nLoaded symbols for /lib64/ld-linux-x86-64.so.2\nReading symbols from /lamp/apache2/lib/libnss_compat.so.2...done.\nLoaded symbols for /lamp/apache2/lib/libnss_compat.so.2\nReading symbols from /lamp/apache2/lib/libnsl.so.1...done.\nLoaded symbols for /lamp/apache2/lib/libnsl.so.1\nReading symbols from /lamp/apache2/lib/libnss_nis.so.2...done.\nLoaded symbols for /lamp/apache2/lib/libnss_nis.so.2\nReading symbols from /lamp/apache2/lib/libnss_files.so.2...done.\nLoaded symbols for /lamp/apache2/lib/libnss_files.so.2\n0x00007f5afe552d47 in semop () from /lamp/apache2/lib/libc.so.6\n(gdb) where\n#0  0x00007f5afe552d47 in semop () from /lamp/apache2/lib/libc.so.6\n#1  0x00007f5aff04f030 in proc_mutex_sysv_acquire (mutex=0x21f8cb0)\n    at locks/unix/proc_mutex.c:254\n#2  0x00000000004ce4f2 in child_main (child_num_arg=<value optimized out>) at prefork.c:205\n#3  0x00000000004ce8f4 in make_child (s=0x21a8c58, slot=3) at prefork.c:768\n#4  0x00000000004cf53e in ap_mpm_run (_pconf=<value optimized out>,\n    plog=<value optimized out>, s=<value optimized out>) at prefork.c:903\n#5  0x00000000004334e5 in main (argc=5, argv=0x7fff35df4fc8) at main.c:739", "is_private": false}, {"count": 8, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "is_private": false, "id": 148971, "time": "2011-09-02T08:04:33Z", "bug_id": 51751, "creation_time": "2011-09-02T08:04:33Z", "text": "(In reply to comment #6)\n> we changed to DavLockDB /var/DavLock\n> \n> there is a /var dir and a /apache2/var with 0777 ... same issue \"segmentation\n> fault\"\n> \n> \n> \n> backtrace:\n> \n> \n> #0  apr_dbm_fetch (dbm=0x94b7d8, key={dptr = 0x501b67 \"METADATA\", dsize = 8},\n> pvalue=0x7fff944e7450) at dbm/apr_dbm.c:221\n> #1  0x00000000004ba5fa in dav_dbm_fetch (db=0x94bad8, key={dptr = 0x501b67\n> \"METADATA\", dsize = 8}, pvalue=0x7fff944e7450) at dbm.c:190\n> #2  0x00000000004bab61 in dav_propdb_open (pool=0x94b7d8, resource=<value\n> optimized out>, ro=<value optimized out>, pdb=0x952a70)\n>     at dbm.c:400\n> #3  0x00000000004aa151 in dav_really_open_db (propdb=0x952a50, ro=0) at\n> props.c:499\n> #4  0x00000000004aa9a7 in dav_get_props (propdb=0x952a50, doc=<value optimized\n> out>) at props.c:805\n> #5  0x00000000004a55f6 in dav_propfind_walker (wres=0x7fff944e7768,\n> calltype=<value optimized out>) at mod_dav.c:1938\n> #6  0x00000000004b786d in dav_fs_walker (fsctx=0x7fff944e7760, depth=0) at\n> repos.c:1423\n> #7  0x00000000004b80d2 in dav_fs_internal_walk (params=0x7fff944e79f0, depth=0,\n> is_move=0, root_dst=0x0, response=0x7fff944e7a88)\n>     at repos.c:1764\n> #8  0x00000000004a5123 in dav_method_propfind (r=0x94d860) at mod_dav.c:2076\n> #9  0x00000000004a898d in dav_handler (r=0x94d860) at mod_dav.c:4661\n> #10 0x0000000000446d23 in ap_run_handler (r=0x94d860) at config.c:158\n> #11 0x000000000044a25e in ap_invoke_handler (r=0x94d860) at config.c:376\n> #12 0x000000000049e26e in ap_process_request (r=0x94d860) at http_request.c:282\n> #13 0x000000000049b158 in ap_process_http_connection (c=0x93b9c0) at\n> http_core.c:190\n> #14 0x000000000044e2a3 in ap_run_process_connection (c=0x93b9c0) at\n> connection.c:43\n> #15 0x00000000004ce620 in child_main (child_num_arg=<value optimized out>) at\n> prefork.c:667\n> #16 0x00000000004ce8b8 in make_child (s=0x7f3c58, slot=0) at prefork.c:712\n> #17 0x00000000004ceed0 in ap_mpm_run (_pconf=<value optimized out>, plog=<value\n> optimized out>, s=<value optimized out>) at prefork.c:988\n> #18 0x00000000004334e5 in main (argc=2, argv=0x7fff944e80a8) at main.c:739\n> \n> \n> live backtrace with \"gdb httpd PID\" does not work. i hope this information is\n> what you need\n\nThanks. That helps. Can you please do a\n\nprint *dbm\nprint *dbm->type"}, {"count": 9, "tags": [], "creator": "martin@inetsolutions.de", "text": "sure\n\n(gdb) print *dbm\n$2 = {pool = 0xe437d8, file = 0x0, errcode = 14940088,\n  errmsg = 0xe437e0 \"\\b\\230\u00e4\", type = 0x0}\n(gdb) print *dbm->type\nCannot access memory at address 0x0", "id": 148973, "time": "2011-09-02T09:01:27Z", "bug_id": 51751, "creation_time": "2011-09-02T09:01:27Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "creator": "sf@sfritsch.de", "attachment_id": null, "is_private": false, "id": 149003, "time": "2011-09-02T18:54:29Z", "bug_id": 51751, "creation_time": "2011-09-02T18:54:29Z", "text": "Can you try if this patch fixes the segfault:\n\nhttp://svn.apache.org/viewvc/httpd/httpd/trunk/modules/dav/fs/dbm.c?r1=1133152&r2=1133151&pathrev=1133152"}, {"count": 11, "tags": [], "bug_id": 51751, "is_private": false, "id": 149004, "creation_time": "2011-09-02T19:39:05Z", "time": "2011-09-02T19:39:05Z", "creator": "martin@inetsolutions.de", "text": "great !!!\nit works\n\nwith chroot no seg fault :)\n\nthanks a lot", "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 51751, "attachment_id": null, "id": 149005, "creation_time": "2011-09-02T19:47:44Z", "time": "2011-09-02T19:47:44Z", "creator": "martin@inetsolutions.de", "text": "but now we get a lock error, the lock file will not be created\n\nThe locks could not be queried for verification against a possible \"If:\" header.\nCould not open the lock database.  [500, #400]\n(2)No such file or directory: Could not open property database.  [500, #1]\n\ntested:\n\nDavLockDB /lamp/apache2/var/DavLock\nDavLockDB /var/DavLock\n\n\n/lamp/apache2/var/ exists\n/lamp/apache2/lamp/apache2/var/ exists\n/var/ exists\n\nwithout chroot only DavLockDB /lamp/apache2/var/DavLock is acceped, with DavLockDB /var/DavLock we get the same error", "is_private": false}, {"count": 13, "tags": [], "bug_id": 51751, "is_private": false, "text": "we strace and solved the problem\n\nopen(\"/lamp/apache2/lib/apr_dbm_db-1.so\", O_RDONLY) = -1 ENOENT (No such file or directory)\nopen(\"/lamp/apache2/lib/apr-util-1/apr_dbm_db-1.so\", O_RDONLY) = -1 ENOENT (No such file or directory)\nopen(\"/lamp/apache2/lib/apr-util-1/apr_dbm_db-1.so\", O_RDONLY) = -1 ENOENT (No such file or directory)\nopen(\"/lamp/apache2/lib/apr_dbm_db-1.so\", O_RDONLY) = -1 ENOENT (No such file or directory)\nopen(\"/lamp/apache2/lib/apr-util-1/apr_dbm_db-1.so\", O_RDONLY) = -1 ENOENT (No such file or directory)\nopen(\"/lamp/apache2/lib/apr-util-1/apr_dbm_db-1.so\", O_RDONLY) = -1 ENOENT (No such file or directory)\n\nsolution:\ncopy /lamp/apache2/lib/apr-util-1/* to /lamp/apache2/lamp/apache2/lib/apr-util-1/*\n\nnow the /lamp/apache2/var/DavLock was created\n\n\nhttpd.conf:\n\nDavLockDB /var/DavLock", "id": 149011, "time": "2011-09-03T00:55:22Z", "creator": "martin@inetsolutions.de", "creation_time": "2011-09-03T00:55:22Z", "attachment_id": null}, {"count": 14, "tags": [], "bug_id": 51751, "attachment_id": null, "text": "fixed in r1133152 / r1133158 in trunk and in r1165381 in 2.2.21", "id": 149381, "time": "2011-09-17T15:24:31Z", "creator": "sf@sfritsch.de", "creation_time": "2011-09-17T15:24:31Z", "is_private": false}]