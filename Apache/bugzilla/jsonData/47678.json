[{"count": 0, "tags": [], "bug_id": 47678, "is_private": false, "id": 129625, "attachment_id": 24128, "creator": "bprucha@gmail.com", "creation_time": "2009-08-11T12:21:00Z", "time": "2009-08-11T12:21:00Z", "text": "Created attachment 24128\nAdded shm_id parameter to fix memory allocation on Win 2k and IIS 5\n\nIn Windows 2000 Server with IIS 5.0 when you load the dll as an extension and a\nfilter, you will get the following error in the connector logs:\n\n[error] jk_isapi_plugin.c (2540): Initializing shm:(null) errno=-1. Load\nbalancing workers will not function properly.\n\nThis error occurs becuse the call to CreateFileMapping fails when trying to\nopen a file with the same name.  This error does not occur on Windows 2003 and\nIIS 6 (I assume due to the way application pools are allocated).\n\nTo resolve this issue I added a shm_id parameter which is added to the end of\nthe shm_name to make the name unique.  If their is a way to have a global\ncounter that gets updated each time the dll is loaded, that would work also."}, {"count": 1, "tags": [], "bug_id": 47678, "attachment_id": null, "id": 130451, "time": "2009-09-16T08:52:36Z", "creator": "eric.smith@mckesson.com", "creation_time": "2009-09-16T08:52:36Z", "is_private": false, "text": "I am seeing the same error message using the 32-bit v1.2.28 dll under Windows 2008 Server 64bit, IIS 7.0, with app pools setting [Enable 32-bit Applications] to true.  The same system worked fine with v1.2.26 prior to upgrading to v1.2.28 and after reverting to v1.2.26.\n\nI did not try the proposed patch.\n\n[Wed Sep 16 08:20:57.762 2009] [4312:4360] [info] jk_isapi_plugin.c (2572): Jakarta/ISAPI/isapi_redirector/1.2.28 initialized\n[Wed Sep 16 08:20:59.512 2009] [4860:5032] [info] jk_isapi_plugin.c (2405): Starting Jakarta/ISAPI/isapi_redirector/1.2.28\n[Wed Sep 16 08:20:59.512 2009] [4860:5032] [error] jk_isapi_plugin.c (2538): Initializing shm:(null) errno=-1. Load balancing workers will not function properly.\n\nMy worker.properties file:\nworker.nodehbi.port=8009\nworker.nodehbi.host=localhost\nworker.nodehbi.type=ajp13\nworker.nodehbi.lbfactor=1 \n\nworker.nodeportal.port=8109\nworker.nodeportal.host=localhost\nworker.nodeportal.type=ajp13\nworker.nodeportal.lbfactor=1 \n\n# List all workers\nworker.list=nodehbi, nodeportal\n\n# Status worker for managing load balancer\nworker.status.type=status"}, {"count": 2, "tags": [], "creator": "eric.smith@mckesson.com", "is_private": false, "text": "I've just pulled down v1.2.30 32-bit and I'm seeing the same problem I reported last year under Windows 2008 Server 64bit, IIS 7.0.  \nI have just observed that upon starting IIS, for a default web site having this ISAPI filter on it, that 2 threads are being started and that appears to be the reason the second shm init is failing.  In this INFO level logging there is process #2784 starting first and successfully initialized, but also started was process #3552 which throws an error during the jk_shm_open call.\n\n[Wed Sep 08 13:52:20.319 2010] [2784:3892] [info] jk_isapi_plugin.c (2403): Starting Jakarta/ISAPI/isapi_redirector/1.2.30\n[Wed Sep 08 13:52:20.334 2010] [2784:3892] [info] jk_isapi_plugin.c (2573): Jakarta/ISAPI/isapi_redirector/1.2.30 initialized\n[Wed Sep 08 13:52:21.647 2010] [3552:3176] [info] jk_isapi_plugin.c (2403): Starting Jakarta/ISAPI/isapi_redirector/1.2.30\n[Wed Sep 08 13:52:21.647 2010] [3552:3176] [error] jk_isapi_plugin.c (2539): Initializing shm:(null) errno=-1. Load balancing workers will not function properly.\n[Wed Sep 08 13:52:21.663 2010] [3552:3176] [info] jk_isapi_plugin.c (2573): Jakarta/ISAPI/isapi_redirector/1.2.30 initialized\n[Wed Sep 08 13:58:08.881 2010] [2784:2252] [info] jk_isapi_plugin.c (2245): Jakarta/ISAPI/isapi_redirector/1.2.30 stopping\n[Wed Sep 08 13:58:08.881 2010] [3552:816] [info] jk_isapi_plugin.c (2245): Jakarta/ISAPI/isapi_redirector/1.2.30 stopping\n\nI see both processes in the task manager as running w3wp.exe*32 described as IIS Worker Process.\n\nWhen DEBUG logging enabled, the first process gets the shm:\n[Wed Sep 08 14:01:26.559 2010] [3664:2648] [debug] jk_shm.c (132): shared memory will contain 2 ajp workers of size 320 and 0 lb workers of size 320 with 0 members of size 384+320\n[Wed Sep 08 14:01:26.559 2010] [3664:2648] [debug] jk_shm.c (254): Initialized shared memory JKISAPISHMEM_LOCALHOST_1 size=768 free=640 addr=0x520000\n\nThe 2nd process reports an error getting the shm:\n[Wed Sep 08 14:04:53.677 2010] [2764:3516] [debug] jk_shm.c (132): shared memory will contain 2 ajp workers of size 320 and 0 lb workers of size 320 with 0 members of size 384+320\n[Wed Sep 08 14:04:53.677 2010] [2764:3516] [error] jk_isapi_plugin.c (2539): Initializing shm:(null) errno=-1. Load balancing workers will not function properly.\n\nAs more requests come in, more of these threads are launched and they fail too.", "id": 139770, "time": "2010-09-08T14:49:30Z", "bug_id": 47678, "creation_time": "2010-09-08T14:49:30Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 47678, "attachment_id": null, "id": 139791, "time": "2010-09-09T12:11:19Z", "creator": "eric.smith@mckesson.com", "creation_time": "2010-09-09T12:11:19Z", "is_private": false, "text": "I've created a patch that seems to work.  The problem seems to arise from IIS 7 having more rigorous security, in particular the default ACLs are now restricted when create mappings and mutexes.  \nThe changes to jk_shm.c are to \n(1) add a SECURITY_ATTRIBUTES structure having KEY_ALL_ACCESS (I granted to Everyone (SECURITY_WORLD_RID) in test, but this should probably be more restricted) as the 2nd argument in the CreateFileMapping call and \n(2) add a SECURITY_ATTRIBUTES structure having MUTEX_ALL_ACCESS as the 1st argument in the CreateMutex call.\n\n[Thu Sep 09 12:06:06.862 2010] [4920:2456] [info] init_jk::jk_isapi_plugin.c (2403): Starting Jakarta/ISAPI/isapi_redirector/1.2.31\n[Thu Sep 09 12:06:06.878 2010] [4920:2456] [info] jk_shm_open::jk_shm.c (174): About to map JKISAPISHMEM_LOCALHOST_1 size 640\n[Thu Sep 09 12:06:06.878 2010] [4920:2456] [info] jk_shm_open::jk_shm.c (182):   CreateFileMapping returned: 0\n[Thu Sep 09 12:06:06.878 2010] [4920:2456] [info] jk_shm_open::jk_shm.c (197):   mutex name: Global\\JKISAPISHMEM_LOCALHOST_1_MUTEX\n[Thu Sep 09 12:06:06.878 2010] [4920:2456] [info] jk_shm_open::jk_shm.c (207):   CreateMutex returned: 0\n[Thu Sep 09 12:06:06.878 2010] [4920:2456] [info] jk_shm_open::jk_shm.c (209):   jk_shm_hlock: 668\n[Thu Sep 09 12:06:06.893 2010] [4920:2456] [info] init_jk::jk_isapi_plugin.c (2573): Jakarta/ISAPI/isapi_redirector/1.2.31 initialized\n[Thu Sep 09 12:06:08.768 2010] [4388:3792] [info] init_jk::jk_isapi_plugin.c (2403): Starting Jakarta/ISAPI/isapi_redirector/1.2.31\n[Thu Sep 09 12:06:08.768 2010] [4388:3792] [info] jk_shm_open::jk_shm.c (174): About to map JKISAPISHMEM_LOCALHOST_1 size 640\n[Thu Sep 09 12:06:08.768 2010] [4388:3792] [info] jk_shm_open::jk_shm.c (182):   CreateFileMapping returned: 183\n[Thu Sep 09 12:06:08.784 2010] [4388:3792] [info] jk_shm_open::jk_shm.c (184):   Attached, map: 660\n[Thu Sep 09 12:06:08.784 2010] [4388:3792] [info] jk_shm_open::jk_shm.c (197):   mutex name: Global\\JKISAPISHMEM_LOCALHOST_1_MUTEX\n[Thu Sep 09 12:06:08.784 2010] [4388:3792] [info] jk_shm_open::jk_shm.c (201):   OpenMutex returned: 183\n[Thu Sep 09 12:06:08.784 2010] [4388:3792] [info] jk_shm_open::jk_shm.c (209):   jk_shm_hlock: 664\n[Thu Sep 09 12:06:08.800 2010] [4388:3792] [info] init_jk::jk_isapi_plugin.c (2573): Jakarta/ISAPI/isapi_redirector/1.2.31 initialized"}, {"count": 4, "tags": [], "bug_id": 47678, "attachment_id": 26218, "is_private": false, "id": 141097, "time": "2010-10-27T10:48:41Z", "creator": "eric.smith@mckesson.com", "creation_time": "2010-10-27T10:48:41Z", "text": "Created attachment 26218\nIIS7 draft patch file 1 of 2\n\nDraft patch for security issues under IIS7 / Windows 2008.  Has verbose INFO log activity."}, {"count": 5, "tags": [], "creator": "eric.smith@mckesson.com", "is_private": false, "text": "Created attachment 26219\nIIS7 draft patch file 2 of 2\n\nDraft patch for security issues under IIS7 / Windows 2008.  Has verbose INFO log activity.", "id": 141098, "time": "2010-10-27T10:50:30Z", "bug_id": 47678, "creation_time": "2010-10-27T10:50:30Z", "attachment_id": 26219}, {"count": 6, "tags": [], "text": "I can't reproduce the double init with the current code.\n\nA review of the svn history suggests this was fixed in r1297439.", "attachment_id": null, "id": 193956, "creator": "markt@apache.org", "time": "2016-09-23T14:34:04Z", "bug_id": 47678, "creation_time": "2016-09-23T14:34:04Z", "is_private": false}]