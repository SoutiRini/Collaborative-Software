[{"count": 0, "attachment_id": null, "bug_id": 57259, "is_private": false, "id": 179274, "time": "2014-11-25T14:39:33Z", "creator": "slawomir.kluz@assaabloy.com", "creation_time": "2014-11-25T14:39:33Z", "tags": [], "text": "1. Extract httpd-2.4.10-win64-VC11.zip from apachelounge or apachehaus\n2. Extract tomcat (ie. apache-tomcat-7.0.57-windows-x64.zip)\n3. Configure httpd:\n   - enable mod_proxy\n   - enable mod_proxy_ajp\n   - configure connection to tomcat:\n     ProxyPass / ajp://127.0.0.1:8009/\n     ProxyPassReverse / ajp://127.0.0.1:8009/ \n4. Start tomcat.\n5. Start httpd.\n6. Open http://localhost/ by browser.\n7. Observe number of TCP connections using: netstat -an when refreshing the page.\n\nEach new connection from httpd to tomcat creates new TCP connection (ie. 127.0.0.1:56233->127.0.0.1:8009). All of them have TIME_WAIT status and are destroyed by OS after 4 minutes (default value of TcpTimedWaitDelay on windows). In extreme, number of TCP connection will exceed windows limit (by default it's ~14K). I confirmed that by sending lots of request to apache one by one.\n\nI have check the same scenario using apache 2.2 on windows, and apache 2.4 on linux. It works it different way. Httpd creates few\nconnections to tomcat and reuse them. They have ESTABLISHED status.\n\nOccurs on Windows 7 64bit, Windows Server 2008 R2 64bit."}, {"count": 1, "tags": [], "text": "trace?", "is_private": false, "id": 179276, "creator": "covener@gmail.com", "time": "2014-11-25T14:41:02Z", "bug_id": 57259, "creation_time": "2014-11-25T14:41:02Z", "attachment_id": null}, {"count": 2, "tags": [], "text": "Created attachment 32227\ntrace8 log\n\ntrace8 log file url attached.\n\nThe log contains:\n- service startup\n- opening http://localhost/ by browser (9 connections was created)\n- pause\n- page refresh (F5), (9 new connections created)\n- shutdown", "is_private": false, "id": 179278, "creator": "slawomir.kluz@assaabloy.com", "time": "2014-11-25T15:25:19Z", "bug_id": 57259, "creation_time": "2014-11-25T15:25:19Z", "attachment_id": 32227}, {"count": 3, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "id": 179282, "creation_time": "2014-11-25T15:32:13Z", "time": "2014-11-25T15:32:13Z", "bug_id": 57259, "text": "It seems like your proxy is hitting the \"default worker\" which is not reusable. It is kind of an internal concept to mod_proxy that bleeds out when you use anything more than the most basic ProxyPass (e.g. rewriterule [P])\n\n[Tue Nov 25 16:22:49.359276 2014] [proxy:trace2] [pid 3336:tid 504] proxy_util.c(1937): [client ::1:51140] *: found reverse proxy worker for ajp://127.0.0.1/\n\nhttp://httpd.apache.org/docs/2.4/mod/mod_proxy.html#workers\n\nAre you sure the failing ones are mapped just by ProxyPass?", "is_private": false}, {"count": 4, "tags": [], "creator": "slawomir.kluz@assaabloy.com", "attachment_id": 32228, "text": "Created attachment 32228\nhttpd.conf\n\nMy problem came up with a more complicated configuration, but as you can see is also present when using almost default one.\n\nI have attached my httpd.conf to not have doubts.\n\nFor comparison, I used httpd-2.2.29-win64.zip from apachelounge. Same configuration but no problem.", "id": 179287, "time": "2014-11-25T18:52:44Z", "bug_id": 57259, "creation_time": "2014-11-25T18:52:44Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 57259, "attachment_id": null, "id": 179649, "time": "2014-12-09T07:05:58Z", "creator": "slawomir.kluz@assaabloy.com", "creation_time": "2014-12-09T07:05:58Z", "is_private": false, "text": "Do you need any additional information, or we can treat this problem as a bug?"}, {"count": 6, "tags": [], "creator": "ylavic.dev@gmail.com", "is_private": false, "text": "Created attachment 32277\nDon't add default port (of any known scheme) to the name of proxy workers\n\nSince 8089 is default port for the AJP scheme, the canonicalization removes it from the URL, but the proxy worker name (URL) still contains it.\n\nHence the failure to match the requested URL with the worker, and the use of the default worker (reverse proxy).\n\nCan you please try the attached patch?\n\nA workaround would be to not specify the port 8009 in the ProxyPass declaration:\n  ProxyPass / ajp://127.0.0.1/\nor\n  ProxyPass / ajp://[::1]/", "id": 179659, "time": "2014-12-09T12:08:06Z", "bug_id": 57259, "creation_time": "2014-12-09T12:08:06Z", "attachment_id": 32277}, {"count": 7, "tags": [], "bug_id": 57259, "attachment_id": null, "id": 179686, "time": "2014-12-10T09:00:09Z", "creator": "JBlond@gmail.com", "creation_time": "2014-12-10T09:00:09Z", "is_private": false, "text": "Not adding a standard port or adding a not-standard port works."}, {"count": 8, "tags": [], "creator": "ylavic.dev@gmail.com", "attachment_id": null, "id": 179687, "creation_time": "2014-12-10T09:18:38Z", "time": "2014-12-10T09:18:38Z", "bug_id": 57259, "text": "(In reply to Mario from comment #7)\n> Not adding a standard port or adding a not-standard port works.\n\nWith (or without) the patch applied?\n\n(please don't change the status if you are are not the OP, it might work for you with the patch applied but nothing is commited in httpd yet).", "is_private": false}, {"count": 9, "tags": [], "creator": "slawomir.kluz@assaabloy.com", "attachment_id": null, "id": 179688, "creation_time": "2014-12-10T09:23:22Z", "time": "2014-12-10T09:23:22Z", "bug_id": 57259, "text": "Workaround works also for me (without default port of with not-standard).\n\nIt will be hard to verify the patch for me, since this requires compiling apache on windows. I'll ask apachelounge for support.", "is_private": false}, {"count": 10, "tags": [], "text": "Proposed for backport in r1644506.", "attachment_id": null, "id": 179702, "creator": "ylavic.dev@gmail.com", "time": "2014-12-10T18:49:22Z", "bug_id": 57259, "creation_time": "2014-12-10T18:49:22Z", "is_private": false}, {"count": 11, "attachment_id": null, "bug_id": 57259, "is_private": false, "id": 180247, "time": "2015-01-09T20:39:09Z", "creator": "christophe.jaillet@wanadoo.fr", "creation_time": "2015-01-09T20:39:09Z", "tags": [], "text": "Backported in 2.4.x in r1650655\n\nWill be part of 2.4.11"}]