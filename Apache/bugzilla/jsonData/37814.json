[{"attachment_id": null, "tags": [], "bug_id": 37814, "is_private": false, "count": 0, "id": 83337, "time": "2005-12-06T23:36:15Z", "creator": "dopey@moonteeth.com", "creation_time": "2005-12-06T23:36:15Z", "text": "OpenLDAP 2.2.x strictly enforces the sizelimit on a search.  The size limit in\nthe LDAP RFC is limited to a maximum of (2^31)-1 (i.e. a signed int).  The max\nsizelimit with Microsoft's SDK is (2^32) -1  which is out of spec and openldap\n2.2.x will error out when an unlimited search request comes in.\nThe size limit for MS's LDAP library is documented here:\nhttp://msdn.microsoft.com/library/default.asp?url=/library/en-us/ldap/ldap/session_options.asp\n\nI tried to modify util_ldap to do a ldap_set_option to set the sizelimit on\nwindows to a more sane value and unfortunately it doesn't work.  The reason is\nthat the util_ldap code uses ldap_search_ext_s and it accepts a SizeLimit\nargument which overrides the session options.  This is documented at:\nhttp://msdn.microsoft.com/library/default.asp?url=/library/en-us/ldap/ldap/ldap_search_ext_s.asp\n\nI can only theorize that Microsoft is defaulting to some library default rather\nthan the session value (which openldap defaults to).\n\nI have a couple of ideas to solve the problem programmatically (rather than\nrebuilding with the iplanet SDK, which may have distribution restrictions, or\nthe openldap sdk, which may have other complexities involed as i don't know that\nit was ever intended for windows deployment).\n\nAll of apache's usage of ldap_search_ext_s passes in NULL's for the arguments\nthat above and beyond ldap_search_s' arguments.  Why not just use ldap_search_s?\n This will use the session limit.  The other option is to use a wrapper search\nfunction which uses #if clauses to pass in a sane SizeLimit on windows, and keep\nthe normal behavior with other SDKs."}, {"count": 1, "text": "This also happens with Apache 2.2.0... running slapd -d 3 indicates the same\n\"invalid size limit\" problem.  Has your programmatic approach worked for you?", "bug_id": 37814, "attachment_id": null, "id": 84045, "time": "2005-12-29T00:27:00Z", "creator": "jpetrakis@rcn.com", "creation_time": "2005-12-29T00:27:00Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 37814, "text": "Created attachment 17574\npatch to force 2147483647 size limit when microsoft LDAPSDK is used\n\nPatch to force 2147483647 size limit on ldap_search_ext_s calls in util_ldap.c\nwhen microsoft LDAPSDK is used.\n\nThis allowed apache on windows to authenticate against an openldap 2.2.x\nserver.", "id": 85371, "time": "2006-02-02T21:52:17Z", "creator": "dopey@moonteeth.com", "creation_time": "2006-02-02T21:52:17Z", "is_private": false, "attachment_id": 17574}, {"count": 3, "tags": [], "creator": "dopey@moonteeth.com", "attachment_id": null, "text": "I've gotten a number of pings on this offline.  Is there anyway I can convince\nan Apache dev to look at this bug and consider a real fix for this?  My patch\nisn't the most elegant, but it's functional (I haven't done real C code in years\nnow), so I'm thinking that an Apache dev might have come up with something prettier.", "id": 110527, "time": "2007-11-14T10:11:39Z", "bug_id": 37814, "creation_time": "2007-11-14T10:11:39Z", "is_private": false}, {"count": 4, "tags": [], "creator": "elifestyle@vestant.com", "attachment_id": null, "is_private": false, "id": 110528, "time": "2007-11-14T10:14:52Z", "bug_id": 37814, "creation_time": "2007-11-14T10:14:52Z", "text": "I have encountered this problem with httpd 2.2.6, so it has never been resolved\nby Apache or by Microsoft.  Can this patch or something similar be integrated?"}, {"count": 5, "tags": [], "creator": "davi@apache.org", "attachment_id": null, "text": "FWIW, It seems that this issue has already been fixed on trunk:\n\nhttp://svn.apache.org/viewvc?view=rev&revision=517788\nhttp://svn.apache.org/viewvc?view=rev&revision=586077\nhttp://svn.apache.org/viewvc?view=rev&revision=509237\n", "id": 110531, "time": "2007-11-14T10:41:57Z", "bug_id": 37814, "creation_time": "2007-11-14T10:41:57Z", "is_private": false}, {"count": 6, "tags": [], "creator": "davi@apache.org", "attachment_id": null, "id": 110532, "time": "2007-11-14T10:51:11Z", "bug_id": 37814, "creation_time": "2007-11-14T10:51:11Z", "is_private": false, "text": "A committer needs to propose these modifications for backport."}, {"count": 7, "tags": [], "creator": "davi@apache.org", "attachment_id": null, "id": 110534, "time": "2007-11-14T10:58:16Z", "bug_id": 37814, "creation_time": "2007-11-14T10:58:16Z", "is_private": false, "text": "Also already fixed in the 2.2.x branch of httpd:\n\nhttp://svn.apache.org/viewvc?view=rev&revision=527105\n\nThis is a apr-util bug now, revision r586077 needs to be backported.\n"}, {"count": 8, "text": "Thank you for pointing out the pending fix in trunk.", "bug_id": 37814, "attachment_id": null, "id": 110535, "time": "2007-11-14T11:10:09Z", "creator": "elifestyle@vestant.com", "creation_time": "2007-11-14T11:10:09Z", "tags": [], "is_private": false}, {"count": 9, "tags": [], "creator": "dopey@moonteeth.com", "attachment_id": null, "id": 110536, "time": "2007-11-14T11:26:00Z", "bug_id": 37814, "creation_time": "2007-11-14T11:26:00Z", "is_private": false, "text": "Davi, thanks for the thorough explanation.  I noticed the change to\nAPR_LDAP_SIZELIMIT but didn't see that defined anywhere in the APR bundled with\nApache 2.2.x, so I was confused.  Now this makes alot more sense.  Once again,\nthanks much for clearing it up.  Should I file a new bug against Apache 2.2.x to\nrequest the APR fix backported, or is someone already on it?  Personally, I\ndon't care if this doesn't get fixed in 2.0, and I really don't expect you guys\nto fix it in 2.0 either."}, {"attachment_id": null, "tags": [], "bug_id": 37814, "is_private": false, "count": 10, "id": 110537, "time": "2007-11-14T11:29:32Z", "creator": "davi@apache.org", "creation_time": "2007-11-14T11:29:32Z", "text": "If no one beats me to it, I will backport the apr-util bits later today."}, {"count": 11, "tags": [], "bug_id": 37814, "is_private": false, "text": "Please do; I'll move forward with apr/apr-iconv packages and watch for this\nto be wrapped up.", "id": 110538, "time": "2007-11-14T11:57:42Z", "creator": "wrowe@apache.org", "creation_time": "2007-11-14T11:57:42Z", "attachment_id": null}, {"count": 12, "tags": [], "creator": "davi@apache.org", "attachment_id": null, "is_private": false, "id": 110540, "time": "2007-11-14T12:11:02Z", "bug_id": 37814, "creation_time": "2007-11-14T12:11:02Z", "text": "Will, please backport it if  you can. I am busy for a few hours now."}, {"count": 13, "tags": [], "creator": "davi@apache.org", "attachment_id": null, "id": 110574, "time": "2007-11-15T03:35:14Z", "bug_id": 37814, "creation_time": "2007-11-15T03:35:14Z", "is_private": false, "text": "Backported to apr-util 1.2.x in r595268 and r595271.\n\nhttp://svn.apache.org/viewvc?view=rev&revision=595268\nhttp://svn.apache.org/viewvc?view=rev&revision=595271\n\nTesting is appreciated and any feedback welcome.\n\nThanks for using the Apache HTTP Server.\n"}, {"count": 14, "tags": [], "bug_id": 37814, "attachment_id": null, "text": "(In reply to comment #7)\n> Also already fixed in the 2.2.x branch of httpd:\n> http://svn.apache.org/viewvc?view=rev&revision=527105\n> This is a apr-util bug now, revision r586077 needs to be backported.\n\nI'm running Apache 2.2.6 (from a binary distribution on Windows) and I'm still \nseeing this error. The following is the translated LDAP searchRequest from the \npacket sniffer I used to view the traffic to and from my LDAP server during \ndebugging:\n\n-----------------------------------------------------------------\nLightweight-Directory-Access-Protocol\n\tLDAPMessage searchRequest(2) \"ou=System\" wholeSubtree\n\t\tmessageID: 2\n\t\tprotocolOp: searchRequest (3)\n\t\t\tsearchRequest\n\t\t\t\tbaseObject: ou=System\n\t\t\t\tscope: wholeSubtree (2)\n\t\t\t\tderefAliases: derefAlways (3)\n\t\t\t\tsizeLimit: 4294967295\n\t\t\t\ttimeLimit: 0\n\t\t\t\ttypesOnly: False\n\t\t\t\tFilter: (&(objectclass=*)(uid=test))\n\t\t\t\tattributes: 0 items\n-----------------------------------------------------------------\n\nNote that the offending sizeLimit value is still there. This is causing a \nfailure with both OpenLDAP, as well as likely being a problem with ApacheDS. I \ncan't tell for sure that this is the case, since the error message returned \nfrom ApacheDS 1.0.2 is the cryptic \"The server will disconnect!\", rather than \nthe informative \"invalid size limit\" returned by OpenLDAP. However, given this \nis a known issue with other LDAP servers and the fact that the rest of the \nrequest looks good, it's likely the cause. ApacheDS 1.5.1 reacts quit badly, \nas well. However, instead of returning an error it doesn't return at all, \nhanging the request that initiated the LDAP call, and causing Apache and \nApacheDS to simply ping each other back and forth with TCP PSH and ACK \nrequests.\n\nThe above LDAP search request came from an install of the binary distribution \nof Apache 2.2.6 from the apache_2.2.6-win32-x86-openssl-0.9.8e.msi. It's \nrunning on Windows XP Professional 2002 SP 2. I see the following entry in the \nchange logs which came with the distribution:\n\n     *) mod_ldap: Remove the hardcoded size limit parameter for\n          ldap_search_ext_s and replace it with an APR_ defined\n          value that is set according to the LDAP SDK being used.\n          [David Jones ]\n\nNevertheless, it doesn't seem to have resolve the size limit problem on \nWindows. Shouldn't this have been included in the 2.2.6 release? I see there \nare some comments in the thread here about the \"pending\" change, but based on \nthe entry for the change logs with the 2.2.6 release it appears to me that \nthis issue shouldn't be reoccurring in that version. Any feedback on why this \nis still occuring would be appreciated.", "id": 111469, "time": "2007-12-05T16:19:33Z", "creator": "rycarpenter@deloitte.com", "creation_time": "2007-12-05T16:19:33Z", "is_private": false}, {"count": 15, "tags": [], "bug_id": 37814, "is_private": false, "text": "The fix for not passing -1 for the sizelimit to MSSDK requires the recently\nreleased apr-util 1.2.12.  \n\nhttpd 2.2.6 was released before apr-util 1.2.12; the next httpd release will\npick up this apr-util version (or later).\n\nThe quoted change from David Jones is not the fix for this issue, this addressed\nother SDKS that didn't accept -1.", "id": 111477, "time": "2007-12-05T17:58:52Z", "creator": "covener@gmail.com", "creation_time": "2007-12-05T17:58:52Z", "attachment_id": null}]