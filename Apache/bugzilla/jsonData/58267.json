[{"count": 0, "tags": [], "text": "Created attachment 33021\nhttpd.conf that will trigger the error\n\nSince the release of apache 2.2.31 our error log has been flooded with the following \n\n[Wed Aug 12 08:30:16 2015] [error] proxy: ap_proxy_set_scoreboard_lb(74) failed in child 19010 for worker ajp://hostname02:8071\n[Wed Aug 12 08:30:16 2015] [error] proxy: ap_proxy_set_scoreboard_lb(76) failed in child 19010 for worker ajp://hostname01:8071\n[Wed Aug 12 08:30:16 2015] [error] proxy: ap_proxy_set_scoreboard_lb(78) failed in child 19010 for worker ajp://hostname02:8071\n[Wed Aug 12 08:30:16 2015] [error] proxy: ap_proxy_set_scoreboard_lb(80) failed in child 19010 for worker ajp://hostname03:8071 \n\nWe actually found it in httpd-2.2.15-45.el6.x86_64 but we can confirm the same behavior is present in 2.2.31 and in 2.2.x branch (2.2.32) too.\n\nAttached a basic httpd.conf that will trigger the error. \n\nIn my test for triggering the error I had to satisfy the following conditions:\n- BalanceMember > 16 \n- VirtualHost > 2\n- \"StandAlone\" ProxyPass > 2  # Not a Balancer ProxyPass\n\nFor example with 17 BalanceMember and 5 childProcess, 5 lines were written in the error log. \nWith 18 BM, 10 lines ; 19BM, 15 lines and so on. \n\nWhen I tried to activate more VHost the increment was not linear, for example with 17 BalancerMember and 5 childProcess I had :\n2 vhost 5 lines\n3 vhost 90 lines \n4 vhost 175 lines \n\nThe error is triggered at startup, during restart and in some others conditions (maybe when a child is spawned ? Not sure couldn't replicate in test ).", "attachment_id": 33021, "id": 184692, "creator": "thomas.schettino@gmail.com", "time": "2015-08-21T22:43:53Z", "bug_id": 58267, "creation_time": "2015-08-21T22:43:53Z", "is_private": false}, {"count": 1, "tags": [], "creator": "rpluem@apache.org", "attachment_id": 33038, "id": 184744, "time": "2015-08-25T12:56:13Z", "bug_id": 58267, "creation_time": "2015-08-25T12:56:13Z", "is_private": false, "text": "Created attachment 33038\nUse the same scoreboard slots for inherited workers\n\nCan you please test if the attached patch fixes your issue?"}, {"count": 2, "tags": [], "bug_id": 58267, "is_private": false, "text": "Created attachment 33039\nerror_log of patch pr58267.diff\n\nThanks, tried patch but it doesn't fix it. \n\nI applied patch to both 2.2.31 and 2.2.32-dev (rev 1697759) and with it applied child repeatedly segfault.\n \nAttached error_log in debug", "id": 184753, "time": "2015-08-25T20:47:11Z", "creator": "thomas.schettino@gmail.com", "creation_time": "2015-08-25T20:47:11Z", "attachment_id": 33039}, {"count": 3, "tags": [], "text": "(In reply to Thomas Schettino from comment #2)\n> Created attachment 33039 [details]\n> error_log of patch pr58267.diff\n> \n> Thanks, tried patch but it doesn't fix it. \n> \n> I applied patch to both 2.2.31 and 2.2.32-dev (rev 1697759) and with it\n> applied child repeatedly segfault.\n>  \n\nDid you do a\n\nmake extraclean\n./buildconf\n<your configure call here> or ./config.nice\nmake\nmake install\n\nor at least\n\nmake clean\n<your configure call here> or ./config.nice\nmake\nmake install\n\n?\n\nDue to the changes to the header file mod_proxy.h you need to do a clean rebuild. Otherwise you get the segfaults.\nApart from the segfaults I don't see the error messages any longer in the logfile.", "is_private": false, "bug_id": 58267, "id": 184756, "time": "2015-08-26T07:06:31Z", "creator": "rpluem@apache.org", "creation_time": "2015-08-26T07:06:31Z", "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 58267, "attachment_id": null, "text": "> or at least\n> \n> make clean\n> <your configure call here> or ./config.nice\n> make\n> make install\n> \n> ?\n> \n> Due to the changes to the header file mod_proxy.h you need to do a clean\n> rebuild. Otherwise you get the segfaults.\n\nGood catch. Yesterday I did a \nmake clean all\nbefore configuring/compiling/installing. \nDidn't know it was enough.\n\nNow with the attached conf is not throwing any error but it still appear when I use my production configuration.\nMaybe it depends on the quantity of vhost and/or proxypass ? Or some interactions with other proxy_modules ? \nWill try to update later today or tomorrow.\n\nThanks for you help so far", "id": 184765, "time": "2015-08-26T16:32:52Z", "creator": "thomas.schettino@gmail.com", "creation_time": "2015-08-26T16:32:52Z", "is_private": false}, {"count": 5, "tags": [], "text": "s/was enough/was not enough/", "attachment_id": null, "bug_id": 58267, "id": 184766, "time": "2015-08-26T16:34:20Z", "creator": "thomas.schettino@gmail.com", "creation_time": "2015-08-26T16:34:20Z", "is_private": false}, {"count": 6, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "id": 184771, "time": "2015-08-26T18:32:43Z", "bug_id": 58267, "creation_time": "2015-08-26T18:32:43Z", "is_private": false, "text": "\n> \n> Now with the attached conf is not throwing any error but it still appear\n> when I use my production configuration.\n> Maybe it depends on the quantity of vhost and/or proxypass ? Or some\n> interactions with other proxy_modules ? \n\nMind to share a simplified / anonymised version of your production configuration that still shows the error?"}, {"count": 7, "tags": [], "text": "Sorry didn't really have time to do some more test, neither to prepare you a \"miniprod.conf\" .\n\nWill attach it to ticket, I hope, before weekend.", "attachment_id": null, "id": 184801, "creator": "thomas.schettino@gmail.com", "time": "2015-08-27T21:33:30Z", "bug_id": 58267, "creation_time": "2015-08-27T21:33:30Z", "is_private": false}, {"count": 8, "tags": [], "text": "Finally found a minimal configuration of our prod conf that triggers the error.\n\nWill clean it up a little and then attach it.", "attachment_id": null, "bug_id": 58267, "id": 184862, "time": "2015-08-31T00:35:50Z", "creator": "thomas.schettino@gmail.com", "creation_time": "2015-08-31T00:35:50Z", "is_private": false}, {"count": 9, "attachment_id": null, "creator": "thomas.schettino@gmail.com", "text": "Sorry, my bad. \nI didn't notice until now, when I started to anonymize the miniprod.conf, that we have \n\nServerRoot \"/etc/httpd\"\n\nthat means the modules were loaded from /etc/httpd/modules/ (old version) instead of /usr/local/apache2/modules/ (patched).\n\nChanged the above to \n\nServerRoot \"/usr/local/apache2\"\n\nand now the error is gone with our production configuration too .\n\nMany thanks for your help :)", "id": 184890, "time": "2015-08-31T19:17:58Z", "bug_id": 58267, "creation_time": "2015-08-31T19:17:58Z", "tags": [], "is_private": false}, {"count": 10, "tags": [], "text": "Thanks for confirming. Backported to 2.2.x as r1700408. Will be part of the next 2.2.x release.", "is_private": false, "id": 184891, "creator": "rpluem@apache.org", "time": "2015-09-01T07:36:33Z", "bug_id": 58267, "creation_time": "2015-09-01T07:36:33Z", "attachment_id": null}]