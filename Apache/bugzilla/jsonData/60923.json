[{"count": 0, "attachment_id": null, "bug_id": 60923, "is_private": false, "id": 198012, "time": "2017-03-27T15:42:03Z", "creator": "guido.wischrop@mgm-tp.com", "creation_time": "2017-03-27T15:42:03Z", "tags": [], "text": "Observations:\n-------------\nWe see Server Error 500 response codes on our reverse proxy for an SVN server. Those errors occur randomly and may cause wrong checkout, because the SVN client silently ignores the 500 error.\n\nPlease note this error in the logs below:\n\nAH01695: auth_ldap authenticate: user svnuser1 authentication failed; ... [ldap_search_ext_s() for user failed][Administrative limit exceeded]\n\nThis causes a Server Error 500 response even if the authentication was successful on the next try.\n\n\nPossible cause:\n---------------\nOur initial configuration did not have LDAPConnectionPoolTTL set, but the LDAP server has a 180s keepalive for client connections. So the LDAP server will disconnect an unused connection, while the connection may be still in the apache LDAP connection pool.\n\n\nSuggested Fix:\n--------------\n1) Please log those errors AH01695 at least at level WARN, otherwise this problem is very hard to find.\n2) It seems the module already handles the problem with the broken connection because it logs \"AH01626: authorization result of <RequireAny>: granted\" at the end. So instead of returning the Server Error 500 it should continue the request.\n\n\n\napache reverse proxy config:\n----------------------------\n\nLDAPSharedCacheSize 8000000\nLDAPOpCacheEntries 16384\nLDAPOpCacheTTL 900\nLDAPCacheEntries 16384\nLDAPCacheTTL 900\n\n##########################################\n# this fixes the problem for us, because our LDAP server has a 180s keepalive\n#\n# LDAPConnectionPoolTTL 150\n##########################################\n\nAuthLDAPURL ldaps://ldap.myserver.net:1234/dc=com?loginName,uid?sub\nAuthLDAPBindDN uid=ldapuser1,ou=people,dc=mydomain,dc=com\n\nAuthLDAPBindPassword PASSWORD\n\nAuthType basic\nAuthName \"Secured by LDAP\"\nAuthBasicProvider ldap\nRequire ldap-attribute permissionRole=USE_SVN\n\n\n\n\napache reverse proxy access log:\n--------------------------------\n10.10.10.56 svn.myserver.net - [28/Feb/2017:12:54:36 +0100] \"OPTIONS /svn/asc091/Components/System_Tests/trunk HTTP/1.1\" 401 - \"-\" \"SVN/1.6.17 (r1128011) neon/0.29.6\"\n10.10.10.56 svn.myserver.net svnuser1 [28/Feb/2017:12:54:36 +0100] \"OPTIONS /svn/asc091/Components/System_Tests/trunk HTTP/1.1\" 500 1177 \"-\" \"SVN/1.6.17 (r1128011) neon/0.29.6\"\n\n\napache reverse proxy error log:\n-------------------------------\n[Tue Feb 28 12:54:36.336309 2017] [ssl:info] [pid 38022:tid 139731039868672] [client 10.10.10.56:38730] AH01964: Connection to child 150 established (server svn.myserver.net:443)\n[Tue Feb 28 12:54:36.336628 2017] [ssl:debug] [pid 38022:tid 139731039868672] ssl_engine_kernel.c(2101): [client 10.10.10.56:38730] AH02043: SSL virtual host for servername svn.myserver.net found\n[Tue Feb 28 12:54:36.389053 2017] [socache_shmcb:debug] [pid 38022:tid 139731039868672] mod_socache_shmcb.c(495): AH00831: socache_shmcb_store (0x49 -> subcache 9)\n[Tue Feb 28 12:54:36.389073 2017] [socache_shmcb:debug] [pid 38022:tid 139731039868672] mod_socache_shmcb.c(786): AH00845: about to force-expire, subcache: idx_used=68, data_used=13982\n[Tue Feb 28 12:54:36.389077 2017] [socache_shmcb:debug] [pid 38022:tid 139731039868672] mod_socache_shmcb.c(813): AH00846: finished force-expire, subcache: idx_used=67, data_used=13776\n[Tue Feb 28 12:54:36.389081 2017] [socache_shmcb:debug] [pid 38022:tid 139731039868672] mod_socache_shmcb.c(849): AH00847: insert happened at idx=8, data=(10722:10754)\n[Tue Feb 28 12:54:36.389084 2017] [socache_shmcb:debug] [pid 38022:tid 139731039868672] mod_socache_shmcb.c(854): AH00848: finished insert, subcache: idx_pos/idx_used=32/68, data_pos/data_used=11122/13982\n[Tue Feb 28 12:54:36.389097 2017] [socache_shmcb:debug] [pid 38022:tid 139731039868672] mod_socache_shmcb.c(516): AH00834: leaving socache_shmcb_store successfully\n[Tue Feb 28 12:54:36.389109 2017] [ssl:debug] [pid 38022:tid 139731039868672] ssl_engine_kernel.c(2028): [client 10.10.10.56:38730] AH02041: Protocol: TLSv1.2, Cipher: DHE-RSA-AES256-SHA256 (256/256 bits)\n[Tue Feb 28 12:54:36.442749 2017] [ssl:debug] [pid 38022:tid 139731039868672] ssl_engine_kernel.c(366): [client 10.10.10.56:38730] AH02034: Initial (No.1) HTTPS request received for child 150 (server svn.myserver.net:443)\n[Tue Feb 28 12:54:36.442786 2017] [authz_core:debug] [pid 38022:tid 139731039868672] mod_authz_core.c(809): [client 10.10.10.56:38730] AH01626: authorization result of Require ldap-attribute permissionRole=USE_SVN: denied (no authenticated user yet)\n[Tue Feb 28 12:54:36.442793 2017] [authz_core:debug] [pid 38022:tid 139731039868672] mod_authz_core.c(809): [client 10.10.10.56:38730] AH01626: authorization result of <RequireAny>: denied (no authenticated user yet)\n[Tue Feb 28 12:54:36.442866 2017] [authz_core:debug] [pid 38022:tid 139731039868672] mod_authz_core.c(809): [client 10.10.10.56:38730] AH01626: authorization result of Require ldap-attribute permissionRole=USE_SVN: denied (no authenticated user yet)\n[Tue Feb 28 12:54:36.442871 2017] [authz_core:debug] [pid 38022:tid 139731039868672] mod_authz_core.c(809): [client 10.10.10.56:38730] AH01626: authorization result of <RequireAny>: denied (no authenticated user yet)\n[Tue Feb 28 12:54:36.457405 2017] [ssl:debug] [pid 38022:tid 139731039868672] ssl_engine_kernel.c(366): [client 10.10.10.56:38730] AH02034: Subsequent (No.2) HTTPS request received for child 150 (server svn.myserver.net:443)\n[Tue Feb 28 12:54:36.457449 2017] [authz_core:debug] [pid 38022:tid 139731039868672] mod_authz_core.c(809): [client 10.10.10.56:38730] AH01626: authorization result of Require ldap-attribute permissionRole=USE_SVN: denied (no authenticated user yet)\n[Tue Feb 28 12:54:36.457456 2017] [authz_core:debug] [pid 38022:tid 139731039868672] mod_authz_core.c(809): [client 10.10.10.56:38730] AH01626: authorization result of <RequireAny>: denied (no authenticated user yet)\n[Tue Feb 28 12:54:36.457469 2017] [authnz_ldap:debug] [pid 38022:tid 139731039868672] mod_authnz_ldap.c(516): [client 10.10.10.56:38730] AH01691: auth_ldap authenticate: using URL ldaps://ldap.myserver.net:1234/dc=com?loginName,uid?sub\n[Tue Feb 28 12:54:36.457546 2017] [authnz_ldap:info] [pid 38022:tid 139731039868672] [client 10.10.10.56:38730] AH01695: auth_ldap authenticate: user svnuser1 authentication failed; URI /svn/asc091/Components/System_Tests/trunk [ldap_search_ext_s() for user failed][Administrative limit exceeded]\n[Tue Feb 28 12:54:36.457626 2017] [authz_core:debug] [pid 38022:tid 139731039868672] mod_authz_core.c(809): [client 10.10.10.56:38730] AH01626: authorization result of Require ldap-attribute permissionRole=USE_SVN: denied (no authenticated user yet)\n[Tue Feb 28 12:54:36.457632 2017] [authz_core:debug] [pid 38022:tid 139731039868672] mod_authz_core.c(809): [client 10.10.10.56:38730] AH01626: authorization result of <RequireAny>: denied (no authenticated user yet)\n[Tue Feb 28 12:54:36.457637 2017] [authnz_ldap:debug] [pid 38022:tid 139731039868672] mod_authnz_ldap.c(516): [client 10.10.10.56:38730] AH01691: auth_ldap authenticate: using URL ldaps://ldap.myserver.net:1234/dc=com?loginName,uid?sub\n[Tue Feb 28 12:54:36.475358 2017] [authnz_ldap:debug] [pid 38022:tid 139731039868672] mod_authnz_ldap.c(613): [client 10.10.10.56:38730] AH01697: auth_ldap authenticate: accepting svnuser1\n[Tue Feb 28 12:54:36.475384 2017] [authnz_ldap:debug] [pid 38022:tid 139731039868672] mod_authnz_ldap.c(1217): [client 10.10.10.56:38730] AH01734: auth_ldap authorize: checking attribute permissionRole has value USE_SVN\n[Tue Feb 28 12:54:36.477798 2017] [authnz_ldap:debug] [pid 38022:tid 139731039868672] mod_authnz_ldap.c(1223): [client 10.10.10.56:38730] AH01735: auth_ldap authorize: require attribute: authorization successful\n[Tue Feb 28 12:54:36.477826 2017] [authz_core:debug] [pid 38022:tid 139731039868672] mod_authz_core.c(809): [client 10.10.10.56:38730] AH01626: authorization result of Require ldap-attribute permissionRole=USE_SVN: granted\n[Tue Feb 28 12:54:36.477831 2017] [authz_core:debug] [pid 38022:tid 139731039868672] mod_authz_core.c(809): [client 10.10.10.56:38730] AH01626: authorization result of <RequireAny>: granted\n[Tue Feb 28 12:54:36.480561 2017] [ssl:debug] [pid 38022:tid 139731039868672] ssl_engine_io.c(1033): [client 10.10.10.56:38730] AH02001: Connection closed to child 150 with standard shutdown (server svn.myserver.net:443)\n\n\n\nldap server log:\n----------------\n[2017-02-28 12:54:36.424 +0100] CONNECT conn=50284005 from=192.168.1.23:57034 to=192.168.1.24:1234 protocol=LDAPS\n[2017-02-28 12:54:36.424 +0100] BIND conn=50284005 op=0 msgID=1 version=3 type=SIMPLE dn=\"uid=ldapuser1,ou=people,dc=mydomain,dc=com\" result=0 authDN=\"uid=ldapuser1,ou=people,dc=mydomain,dc=com\" etime=107275\n[2017-02-28 12:54:36.424 +0100] SEARCH conn=50284005 op=1 msgID=2 base=\"dc=com\" scope=sub filter=\"(&(objectclass=*)(loginName=svnuser1))\" attrs=\"loginName,uid\" result=0 nentries=1 etime=302872\n[2017-02-28 12:54:36.424 +0100] BIND conn=50284005 op=2 msgID=3 version=3 type=SIMPLE dn=\"uid=svnuser1,ou=people,dc=mydomain,dc=com\" result=0 authDN=\"uid=svnuser1,ou=people,dc=mydomain,dc=com\" etime=113956\n[2017-02-28 12:54:36.424 +0100] BIND conn=50284005 op=3 msgID=4 version=3 type=SIMPLE dn=\"uid=ldapuser1,ou=people,dc=mydomain,dc=com\" result=0 authDN=\"uid=ldapuser1,ou=people,dc=mydomain,dc=com\" etime=112638\n[2017-02-28 12:54:36.424 +0100] COMPARE conn=50284005 op=4 msgID=5 dn=\"uid=svnuser1,ou=people,dc=mydomain,dc=com\" attr=permissionRole result=6 etime=132232\n\n\nsvn access log:\n---------------\nNO ENTRY"}, {"count": 1, "tags": [], "creator": "guido.wischrop@mgm-tp.com", "attachment_id": null, "text": "Addendum\n\n\nSuggested Fix:\n--------------\n3) Please don't use the error message \"Administrative limit exceeded\", because it is misleading in this case.", "id": 198013, "time": "2017-03-27T15:56:59Z", "bug_id": 60923, "creation_time": "2017-03-27T15:56:59Z", "is_private": false}, {"count": 2, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "text": "(In reply to Guido W. from comment #1)\n> Addendum\n> \n> \n> Suggested Fix:\n> --------------\n> 3) Please don't use the error message \"Administrative limit exceeded\",\n> because it is misleading in this case.\n\nUnless something unique is happening here, this generally come from the SDK. In what cases should it be second-guessed?", "id": 198017, "time": "2017-03-27T16:41:57Z", "bug_id": 60923, "creation_time": "2017-03-27T16:41:57Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 60923, "text": "(In reply to Eric Covener from comment #2)\n> (In reply to Guido W. from comment #1)\n> > Addendum\n> > \n> > \n> > Suggested Fix:\n> > --------------\n> > 3) Please don't use the error message \"Administrative limit exceeded\",\n> > because it is misleading in this case.\n> \n> Unless something unique is happening here, this generally come from the SDK.\n> In what cases should it be second-guessed?\n\nThat would imply that the response actually came from the LDAP server, but I don't think that is the case here, because the failed request is not logged at the LDAP server (not even at debug level).", "id": 198018, "time": "2017-03-27T16:47:52Z", "creator": "guido.wischrop@mgm-tp.com", "creation_time": "2017-03-27T16:47:52Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 60923, "text": "(In reply to Guido W. from comment #3)\n> (In reply to Eric Covener from comment #2)\n> > (In reply to Guido W. from comment #1)\n> > > Addendum\n> > > \n> > > \n> > > Suggested Fix:\n> > > --------------\n> > > 3) Please don't use the error message \"Administrative limit exceeded\",\n> > > because it is misleading in this case.\n> > \n> > Unless something unique is happening here, this generally come from the SDK.\n> > In what cases should it be second-guessed?\n> \n> That would imply that the response actually came from the LDAP server, but I\n> don't think that is the case here, because the failed request is not logged\n> at the LDAP server (not even at debug level).\n\nPerhaps you could log in the client SDK itself?  Everything mod_ldap knows about the backend LDAP server is via the calls to the LDAP SDK.", "id": 198102, "time": "2017-03-31T13:58:02Z", "creator": "covener@gmail.com", "creation_time": "2017-03-31T13:58:02Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 60923, "is_private": false, "id": 198103, "creation_time": "2017-03-31T14:35:35Z", "time": "2017-03-31T14:35:35Z", "creator": "guido.wischrop@mgm-tp.com", "text": "(In reply to Eric Covener from comment #4)\n\n> Perhaps you could log in the client SDK itself?\nI'm sorry, I won't be able to do that.\n\nSo you are saying the ldap module logs\n\n[Tue Feb 28 12:54:36.457546 2017] [authnz_ldap:info] [pid 38022:tid 139731039868672] [client 10.10.10.56:38730] AH01695: auth_ldap authenticate: user svnuser1 authentication failed; URI /svn/asc091/Components/System_Tests/trunk [ldap_search_ext_s() for user failed][Administrative limit exceeded]\n\nbecause it got exactly that from the SDK: \"Administrative limit exceeded\"?\n\nIf that is so, then maybe it's possible to check the connection state at that moment and if it's closed log that information too?\n\nThanks,\nGuido\n\n> (In reply to Guido W. from comment #3)\n> > (In reply to Eric Covener from comment #2)\n> > > (In reply to Guido W. from comment #1)\n> > > > Addendum\n> > > > \n> > > > \n> > > > Suggested Fix:\n> > > > --------------\n> > > > 3) Please don't use the error message \"Administrative limit exceeded\",\n> > > > because it is misleading in this case.\n> > > \n> > > Unless something unique is happening here, this generally come from the SDK.\n> > > In what cases should it be second-guessed?\n> > \n> > That would imply that the response actually came from the LDAP server, but I\n> > don't think that is the case here, because the failed request is not logged\n> > at the LDAP server (not even at debug level).\n> \n> Perhaps you could log in the client SDK itself?  Everything mod_ldap knows\n> about the backend LDAP server is via the calls to the LDAP SDK.", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 60923, "text": "\n> So you are saying the ldap module logs\n> \n> [Tue Feb 28 12:54:36.457546 2017] [authnz_ldap:info] [pid 38022:tid\n> 139731039868672] [client 10.10.10.56:38730] AH01695: auth_ldap authenticate:\n> user svnuser1 authentication failed; URI\n> /svn/asc091/Components/System_Tests/trunk [ldap_search_ext_s() for user\n> failed][Administrative limit exceeded]\n> \n> because it got exactly that from the SDK: \"Administrative limit exceeded\"?\n\nYes, nearly.   ldap_serch_ext_s() returned a numeric error code. We passed the numeric code into ldap_err2string() and it returned that string.\n\nWe don't even have an underlying socket for the LDAP server. It's encapsulated by the LDAP client SDK -- we can just open, bind, search and look at LDAP-specific return codes.\n\nIn this case, we get what looks like a pretty vague/generic error back from the SDK.", "id": 198104, "time": "2017-03-31T14:44:02Z", "creator": "covener@gmail.com", "creation_time": "2017-03-31T14:44:02Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 60923, "is_private": false, "text": "(In reply to Eric Covener from comment #6)\n\nHmm - in the documentation here\n\nhttps://httpd.apache.org/docs/2.4/mod/mod_ldap.html#pool\n\nit sound like the ldap module / apache server handles the connection pool.\n\nIf the ldap module is not the right point to fix this can you please point me to the correct place?\n\n> > So you are saying the ldap module logs\n> > \n> > [Tue Feb 28 12:54:36.457546 2017] [authnz_ldap:info] [pid 38022:tid\n> > 139731039868672] [client 10.10.10.56:38730] AH01695: auth_ldap authenticate:\n> > user svnuser1 authentication failed; URI\n> > /svn/asc091/Components/System_Tests/trunk [ldap_search_ext_s() for user\n> > failed][Administrative limit exceeded]\n> > \n> > because it got exactly that from the SDK: \"Administrative limit exceeded\"?\n> \n> Yes, nearly.   ldap_serch_ext_s() returned a numeric error code. We passed\n> the numeric code into ldap_err2string() and it returned that string.\n> \n> We don't even have an underlying socket for the LDAP server. It's\n> encapsulated by the LDAP client SDK -- we can just open, bind, search and\n> look at LDAP-specific return codes.\n> \n> In this case, we get what looks like a pretty vague/generic error back from\n> the SDK.", "id": 198105, "time": "2017-03-31T14:51:18Z", "creator": "guido.wischrop@mgm-tp.com", "creation_time": "2017-03-31T14:51:18Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 60923, "text": "(In reply to Guido W. from comment #7)\n> (In reply to Eric Covener from comment #6)\n> \n> Hmm - in the documentation here\n> \n> https://httpd.apache.org/docs/2.4/mod/mod_ldap.html#pool\n> \n> it sound like the ldap module / apache server handles the connection pool.\n> \n> If the ldap module is not the right point to fix this can you please point\n> me to the correct place?\n\nIt's a pool of objects from the LDAP client SDK that represent connections to the server. \n\nThere are several issues in the bug report. We are usually careful about raising severity of messages.  I am not sure if you're misinterpreting some logs here, but the real culprit may be that no retry occurred where you expected one.\n\nA stronger case would be needed to raise the severity of the message. Having a connection go south like this does not seem extraordinary.  \n\ne.g. Maybe mod_ldap doesn't think the error is retryable.\n\nThe only thing to take up externally is if you wanted to understand precisely why this error code is and is not returned and make some kind of case for special handling of it.", "id": 198107, "time": "2017-03-31T15:05:24Z", "creator": "covener@gmail.com", "creation_time": "2017-03-31T15:05:24Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "creator": "guido.wischrop@mgm-tp.com", "text": "(In reply to Eric Covener from comment #8)\n\nOk, to avoid misunderstandings here, if 2) get's fixed, then there might no need for the change 1) and 3). But otherwise the (proxy-) server returns error 500 with no indication what has gone wrong, which seems to be a problem (at least for me).", "id": 198108, "time": "2017-03-31T15:18:03Z", "bug_id": 60923, "creation_time": "2017-03-31T15:18:03Z", "is_private": false, "attachment_id": null}]