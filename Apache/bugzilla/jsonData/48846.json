[{"count": 0, "tags": [], "bug_id": 48846, "attachment_id": null, "id": 135010, "creation_time": "2010-03-03T03:00:48Z", "time": "2010-03-03T03:00:48Z", "creator": "benbrand@mac.com", "text": "In findCellComment(Sheet, int, int) method of org.apache.poi.hssf.usermodel.HSSFCell, TextObjectRecord sometimes become null.\n\n-- original code --\n        for (Iterator<RecordBase> it = sheet.getRecords().iterator(); it.hasNext();) {\n            RecordBase rec = it.next();\n            if (rec instanceof NoteRecord) {\n                NoteRecord note = (NoteRecord) rec;\n                if (note.getRow() == row && note.getColumn() == column) {\n                    if(i < noteTxo.size()) {\n                        TextObjectRecord txo = noteTxo.get(note.getShapeId());\n                        comment = new HSSFComment(note, txo);\n                        comment.setRow(note.getRow());\n                        comment.setColumn((short) note.getColumn());\n                        comment.setAuthor(note.getAuthor());\n                        comment.setVisible(note.getFlags() == NoteRecord.NOTE_VISIBLE);\n                        comment.setString(txo.getStr());\n                    } else {\n                        log.log(POILogger.WARN, \"Failed to match NoteRecord and TextObjectRecord, row: \" + row + \", column: \" + column);\n                    }\n                    break;\n                }\n                i++;\n            } else if (rec instanceof ObjRecord) {\n --- end ------------\n\nWith this code, my program crashed with NullPointerException on line of 'comment.setString(txo.getStr());', because a local variable 'txo' is null.\nI changed the code like bellow, then the program works correctly.\n\n--- changed code ---\n        for (Iterator<RecordBase> it = sheet.getRecords().iterator(); it.hasNext();) {\n            RecordBase rec = it.next();\n            if (rec instanceof NoteRecord) {\n                NoteRecord note = (NoteRecord) rec;\n                if (note.getRow() == row && note.getColumn() == column) {\n                    if(i < noteTxo.size()) {\n                        TextObjectRecord txo = noteTxo.get(note.getShapeId());\n                        \n                        //NEXT LINE IS ADDED\n                        if(txo != null) { // <-- MUST CHECK txo IS NOT NULL.\n                            comment = new HSSFComment(note, txo);\n                            comment.setRow(note.getRow());\n                            comment.setColumn((short) note.getColumn());\n                            comment.setAuthor(note.getAuthor());\n                            comment.setVisible(note.getFlags() == NoteRecord.NOTE_VISIBLE);\n                            comment.setString(txo.getStr());\n                        } else {\n                            log.log(POILogger.WARN, \"Failed to match NoteRecord and TextObjectRecord, row: \" + row + \", column: \" + column);\n                        }\n\n                    } else {\n                        log.log(POILogger.WARN, \"Failed to match NoteRecord and TextObjectRecord, row: \" + row + \", column: \" + column);\n                    }\n                    break;\n                }\n                i++;\n            } else if (rec instanceof ObjRecord) {\n--- end ------------\n\nThanks.", "is_private": false}, {"count": 1, "tags": [], "creator": "yegor@dinom.ru", "text": "The suggested fix looks OK, but can you upload a sample file that demonstrates the \"null  TextObjectRecord\"  issue? I would like to have a junit test case for this fix.\n\nYegor", "id": 135343, "time": "2010-03-15T06:35:09Z", "bug_id": 48846, "creation_time": "2010-03-15T06:35:09Z", "is_private": false, "attachment_id": null}, {"count": 2, "attachment_id": null, "bug_id": 48846, "is_private": false, "id": 135413, "time": "2010-03-18T07:57:16Z", "creator": "nothize@gmail.com", "creation_time": "2010-03-18T07:57:16Z", "tags": [], "text": "This issue seems to be related with 47624.\n\nThe TextObjectRecord was not removed properly after an EscherAggregate record has came into play. It was supposed to be part of a paired DrawingRecord and TextObjectRecord for a cell comment."}, {"attachment_id": null, "tags": [], "bug_id": 48846, "is_private": false, "count": 3, "id": 137031, "time": "2010-05-22T12:24:47Z", "creator": "yegor@dinom.ru", "creation_time": "2010-05-22T12:24:47Z", "text": "Fixed in r947315\n\nThanks,\nYegor"}]