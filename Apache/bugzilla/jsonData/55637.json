[{"count": 0, "tags": [], "bug_id": 55637, "text": "RemoteIPInternalProxy RemoteIPInternalProxyList directives are processed incorrectly\nIf you check remoteip_modify_request function you can see that\nthe \"internal\" flag are shifted left for \"IP\" in RemoteIPHeader.\n\nTo reproduce this bug, you have to setup mod_remoteip with these directives:\n\nLogFormat \"%h %a %{c}a %{X-Forwarded-For}i %l %u %t \\\"%m\\\" \\\"%r&\\\" \\\"%q&\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" pid=%{pid}P tid=%{tid}P time_ms=%D\" combined\n\nCustomLog \"|/import/home/ivan.voronin/tmp/tmp/apache_project/distrib/apache2/bin/rotatelogs logs/access_log.%Y.%m.%d 86400\" combined\n\n<Location /test>\n\tOrder Deny,Allow\n\tDeny from all\n\tAllow from localhost 127.0.0.1 1.1.1.1\n</Location>\n\nRemoteIPHeader X-Forwarded-For\nRemoteIPInternalProxy 127.0.0.1\nRemoteIPInternalProxy 172.20.106.70\nRemoteIPTrustedProxy 87.250.250.203\n\n\n\nGET http://srv2-x64rh6-01:1280/test/1.xml\n\n[no cookies]\n\nRequest Headers:\nConnection: keep-alive\nX-Forwarded-For: 1.1.1.2, 1.1.1.1, 127.0.0.1, 87.250.250.203\nAccept: */*\nX-Forwarded-By: 87.250.250.203\nHost: srv2-x64rh6-01:1280\nUser-Agent: Apache-HttpClient/4.1.2 (java 1.5)\n\nI expected, that mod_remoteip would override client IP with 1.1.1.1 \nbecause 87.250.250.203 is trusted and 127.0.0.1 is internal trusted.\nActually, client IP was overridden with 87.250.250.203.\n\naccess_log:\nivoronin.net.billing.ru 87.250.250.203 172.20.106.70 1.1.1.2, 1.1.1.1, 127.0.0.1 - - [07/Oct/2013:13:16:28 +0400] \"GET\" \"GET /test/1.xml HTTP/1.1&\" \"&\" 403 212 \"-\" \"Apache-HttpClient/4.1.2 (java 1.5)\" pid=5425 tid=140701266933504 time_ms=2264\n\nerror_log:\n[Mon Oct 07 13:16:28.739087 2013] [remoteip:debug] [pid 5425:tid 140701266933504] mod_remoteip.c(343): [client 172.20.106.70:58848] AH01569: RemoteIP: Header X-Forwarded-For value of 127.0.0.1 appears to be a private IP or nonsensical.  Ignored\n[Mon Oct 07 13:16:28.740823 2013] [access_compat:error] [pid 5425:tid 140701266933504] [client 87.250.250.203:58848] AH01797: client denied by server configuration: /import/home/ivan.voronin/tmp/tmp/apache_project/distrib/apache2/htdocs/test/1.xml", "id": 170463, "time": "2013-10-07T09:40:37Z", "creator": "vivanv@mail.ru", "creation_time": "2013-10-07T09:40:37Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 55637, "text": "Hello Ivan,\n\nIt appears to me that your results are as they should be according to the documentation at the following link:\n- http://httpd.apache.org/docs/trunk/mod/mod_remoteip.html \n\nI will try to give an explanation similar to one I gave in comment 3 of related bug 55635.\nThe difference from that bug involves the difference between RemoteIPInternalProxy and RemoteIPTrustedProxy.\nBoth of these directives identify a proxy that can be trusted to trust the right-most value in the X-Forwarded-For header as a trusted useragent IP address.\nThe difference is that any intranet or private IP address is not trusted as the useragent IP address for RemoteIPTrustedProxy proxies.\nBut all IP addresses are trusted for RemoteIPInternalProxy proxies.\n\nLet's walk though your results.\n\nmod_remoteip processes the contents of X-Forwarded-For from right to left in cycles of a while loop after your RemoteIPInternalProxy and RemoteIPTrustedProxy proxies are added to a proxy match list.\n\nCycle 1:\nThe code begins with X-Forwarded-For equal to \"1.1.1.2, 1.1.1.1, 127.0.0.1, 87.250.250.203\" and the client IP is equal to \"172.20.106.70\".\nThe client IP is compared against the proxy match list.\n172.20.106.70 is listed as an internal proxy.\nSo its view of the X-Forwarded-For list is trusted.\nSo 87.250.250.203 is interpreted as a valid useragent IP address.\nSo 87.250.250.203 becomes the client IP and is removed from the X-Forwarded-For list.\n\nCycle 2:\nX-Forwarded-For is equal to \"1.1.1.2, 1.1.1.1, 127.0.0.1\" and the client IP is equal to \"87.250.250.203\".\n87.250.250.203 is listed as a trusted proxy.\nSo its view of the X-Forwarded-For list is trusted.\nBut RemoteIPTrustedProxy proxies do not trust private network addresses.\n127.0.0.1 is counted as a private network address.\nSo 127.0.0.1 is not accepted as a valid useragent IP address.\nThis can be seen in your error log.\nSo the cycles stop.\n\nFinal mod_remoteip result\":\nX-Forwarded-For is equal to \"1.1.1.2, 1.1.1.1, 127.0.0.1\" and the client IP is equal to \"87.250.250.203\".\n\nAnd this is the result that you are seeing.\n\nIf you change \"RemoteIPTrustedProxy 87.250.250.203\" to \"RemoteIPInternalProxy 87.250.250.203\", then you should get the results that you were expecting.\n\nPlease, try this and let us know your results.\n\nTake care,\n\nMike Rumph", "id": 171553, "time": "2013-12-03T23:55:55Z", "creator": "mike.rumph@oracle.com", "creation_time": "2013-12-03T23:55:55Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "wrowe@apache.org", "is_private": false, "text": "\"I expected, that mod_remoteip would override client IP with 1.1.1.1 \nbecause 87.250.250.203 is trusted and 127.0.0.1 is internal trusted.\"\n\nThat would not happen on the fact that it's logically inconsistent.\n\nOnce you have left the domain of InternalProxy processing, and moved on to\nTrustedProxy processing, it will still never let you return to Internal processing because of the fact that you have left those machines within your control and are now trusting machines outside of the realm of your control.\n\nSecondly, 87.250.250.203 is not an InternalProxy under your trust domain for\nintranet addresses, so it is not allowed to point the apparent origin IP of \nthis request towards an intranet address, only towards an extranet address.\n\nTherefore, the X-F-F value presented by 87.250.250.203 is invalid and the\norigin IP address of this request is stuck at the offending proxy, rather than\nfollowing the chain further into the list of X-F-F values.", "id": 171697, "time": "2013-12-11T22:13:07Z", "bug_id": 55637, "creation_time": "2013-12-11T22:13:07Z", "attachment_id": null}]