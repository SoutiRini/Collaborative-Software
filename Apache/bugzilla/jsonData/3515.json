[{"count": 0, "text": "After stopping Tomcat 4.0 rc1 with the shutdown.sh command,\nit has problems terminating my webapp (located under the /pkit prefix).\n\nThe error message in the localhost_log reads\n\n2001-09-10 10:44:48 StandardHost[localhost]: Removing web application at context \n path /examples\n2001-09-10 10:44:48 StandardHost[localhost]: Removing web application at context\n path /webdav\n2001-09-10 10:44:48 StandardHost[localhost]: Removing web application at context\n path /tomcat-docs\n2001-09-10 10:44:48 StandardHost[localhost]: Removing web application at context\n path /pkit\n2001-09-10 10:44:48 download: destroy\n2001-09-10 10:44:48 serviceinit: destroy\n2001-09-10 10:44:48 config: destroy\n2001-09-10 10:44:48 StandardWrapper[/pkit:action]: Waiting for 1 instance(s) to \nbe deallocated\n\nTomcat locks up at this stage and does not terminate.", "creator": "Erich.Meier@methodpark.de", "attachment_id": null, "id": 5281, "time": "2001-09-10T02:16:39Z", "bug_id": 3515, "creation_time": "2001-09-10T02:16:39Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 3515, "attachment_id": null, "id": 5299, "time": "2001-09-10T10:01:43Z", "creator": "remm@apache.org", "creation_time": "2001-09-10T10:01:43Z", "is_private": false, "text": "Is your webapp doing anything special during shutdown ?\nLike, in the destroy method of one of your servlets ?"}, {"count": 2, "tags": [], "creator": "craig.mcclanahan@sun.com", "attachment_id": null, "id": 5674, "time": "2001-09-17T10:55:50Z", "bug_id": 3515, "creation_time": "2001-09-17T10:55:50Z", "is_private": false, "text": "Resolving with WORKSFORME.  Can be reopened later if we have a reproducible\nfailure case to test with.\n\nNote that one possible cause for this would be if your web app had processed a\nrequest but never completed it.  The checking at shutdown time is to ensure that\nthere are no requests currently being processed before destroy() is called on a\nservlet instance -- which is required by the specification.\n"}, {"count": 3, "tags": [], "text": "It is very likely, that my webapp crashed with an internal error and threw an \nexception. Could this trigger the bug?", "attachment_id": null, "id": 5676, "creator": "Erich.Meier@methodpark.de", "time": "2001-09-17T11:05:24Z", "bug_id": 3515, "creation_time": "2001-09-17T11:05:24Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 3515, "is_private": false, "id": 5677, "attachment_id": null, "creator": "craig.mcclanahan@sun.com", "creation_time": "2001-09-17T11:09:17Z", "time": "2001-09-17T11:09:17Z", "text": "Yep.  If the internal error caused the service() method not to return, the\nservlet instance would have remained allocated.  If the exception was actually\nreturned from the service() method, that would be a bug in Tomcat (because it\nshould have released the instance).\n"}, {"count": 5, "tags": [], "creator": "Erich.Meier@methodpark.de", "attachment_id": null, "id": 5678, "time": "2001-09-17T11:22:28Z", "bug_id": 3515, "creation_time": "2001-09-17T11:22:28Z", "is_private": false, "text": "I can imagine two potential \"problem areas\":\n\n- a webapp throws an exception/error during init() (very unlikely, because it \nshould not serve any requests at that stage)\n\n- a webapp throws an error in service()\n\nIf I understand the tomcat code correctly, an error in service() goes through \nunhandled.\n\nCould this be the reason for the lockup?"}, {"count": 6, "tags": [], "text": "If an exception is thrown in init(), this servlet instance will never be used\nfor request processing, so the shutdown problem cannot occur.\n\nIf an exception is thown from service() -- either because it is a\nRuntimeException or because you wrapped it in an IOException or a\nServletException, the allocated servlet instance will still be released by\nvirtue of the exception handling code inside Catalina.  This is done in the\ninvoke() method of org.apache.catalina.core.StandardWrapperValve, under the\ncomment line \"// Deallocate the allocated servlet instance\".  Note that this\nlogic is executed even if your servlet throws an exception.\n", "attachment_id": null, "id": 5679, "creator": "craig.mcclanahan@sun.com", "time": "2001-09-17T11:28:51Z", "bug_id": 3515, "creation_time": "2001-09-17T11:28:51Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 3515, "attachment_id": null, "id": 11559, "time": "2002-03-08T04:43:20Z", "creator": "mpetres@netcom.ca", "creation_time": "2002-03-08T04:43:20Z", "is_private": false, "text": "If a webapp had processed a request but never completed it, i.e. it is hung, \nthe shutdown will never complete.\n\nThis may not be to the servlet spec but ... is there a possibility to force a \nshuthdown anyways (perhaps a timeout)?\n\n "}, {"count": 8, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "id": 13345, "time": "2002-04-12T10:21:11Z", "bug_id": 3515, "creation_time": "2002-04-12T10:21:11Z", "is_private": false, "text": "This shutdown problem will not happen in normal operation.\nThere is also no known bug with the shutdown algorithm (they have been fixed \nalready). If anything, the algorithm may not be robust enough (in which case, \nit is an enhancement)."}, {"count": 9, "tags": [], "creator": "shinya@kbmj.com", "attachment_id": null, "id": 21014, "time": "2002-08-14T09:40:16Z", "bug_id": 3515, "creation_time": "2002-08-14T09:40:16Z", "is_private": false, "text": "It seems that there is a race condition in StandardWrapper.java.\nIncrementing / decrementing countAllocated is not synchronized.\n\nI reproduced this bug in the following way:\n\n1. Startup tomcat with default startup.sh.\n\n2. Run a stress test to http://localhost:8080/ \n\nI used siege (http://www.joedog.org/siege/index.shtml) like this:\nsiege -c 20 -u http://localhost:8080/\n\n3. Try to shutdown tomcat with shutdown.sh\n\n4. The log says like \"Waiting for 21 instance(s) to be deallocated\"\n   and tomcat locks up\n\nI tested it with RedHat Linux 7.3 (2.4.18-3smp) with Dual Xeon 1.8GHz\n(which looks like 4 cpus because of hyperthreading)\nand JDK 1.3.1_02 hotspot client vm.\n"}, {"count": 10, "tags": [], "text": "Created attachment 2707\nA patch to fix race condition", "attachment_id": 2707, "id": 21015, "creator": "shinya@kbmj.com", "time": "2002-08-14T09:41:28Z", "bug_id": 3515, "creation_time": "2002-08-14T09:41:28Z", "is_private": false}, {"count": 11, "tags": [], "creator": "shinya@kbmj.com", "attachment_id": null, "id": 21068, "time": "2002-08-15T01:15:59Z", "bug_id": 3515, "creation_time": "2002-08-15T01:15:59Z", "is_private": false, "text": "The patch is against tomcat_40_branch.\nI haven't tested 4.1.\n"}, {"count": 12, "tags": [], "bug_id": 3515, "attachment_id": null, "id": 21584, "time": "2002-08-23T11:09:05Z", "creator": "shinya@kbmj.com", "creation_time": "2002-08-23T11:09:05Z", "is_private": false, "text": "Sorry, that patch will cause a deadlock\nwhen StandardWrapper waits on unload().\nI will submit a fixed version.\n"}, {"count": 13, "tags": [], "text": "Created attachment 2812\nPatch to fix race condition (tomcat_40_branch)", "is_private": false, "id": 21586, "creation_time": "2002-08-23T11:14:42Z", "time": "2002-08-23T11:14:42Z", "creator": "shinya@kbmj.com", "bug_id": 3515, "attachment_id": 2812}, {"count": 14, "tags": [], "bug_id": 3515, "attachment_id": null, "is_private": false, "id": 35204, "time": "2003-04-15T15:43:20Z", "creator": "remm@apache.org", "creation_time": "2003-04-15T15:43:20Z", "text": "This bug should not exist in 4.1.x. However, it is very possible that some user \ncode causes a deadlock on shutdown (Tomcat sets al threads as daemons, cleans \nup its stuff, and then waits for the VM to shutdown gracefully). If the VM \ndoesn't shutdown, it will have to be killed. Note that a PID file is created on \nUnix so that it can be scripted."}]