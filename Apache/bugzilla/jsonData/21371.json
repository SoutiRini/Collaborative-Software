[{"count": 0, "tags": [], "text": "I have been working on a site that enforces mutually authenticated SSL\nusing apache 2.0.46. I have compiled it from source using the following\ncommands passed to the ./configure script:\n\n./configure --enable-so --enable-ssl --with-ssl=/usr/local/ssl\n\n/usr/local/ssl contains openssl version 0.9.7b which I compiled from\nsource using the default build configuration.\nI have tried both servlets and cgi and all I can get is the user\ncertificate, not the certificate chain.  I have tried looking at the\nmod_ssl code, and cannot figure out why the +ExportCertData directive\nwill only tell apache to forward on the user certificate, not the chain.", "attachment_id": null, "bug_id": 21371, "id": 40064, "time": "2003-07-07T13:28:15Z", "creator": "mark@dolphtech.com", "creation_time": "2003-07-07T13:28:15Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 21371, "attachment_id": null, "text": "This is all Greek to me (i.e., it would take me a long time to figure out how to\ntest), but it looks like there is an off-by-one error in ssl_engine_vars.c that\nmesses up\nthe lookup of the cert chain info.  I'll attach a patch to test in just a sec.\n\nThe latest mod_ssl for Apache 1.3 has this change too.  I'd wager that\nbacktracking that line of code in prior releases of the original mod_ssl\nwould show that it got fixed after we imported it into Apache 2.0.\n", "id": 40369, "time": "2003-07-10T20:39:21Z", "creator": "trawick@apache.org", "creation_time": "2003-07-10T20:39:21Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 21371, "attachment_id": 7231, "text": "Created attachment 7231\nproposed fix for cert chain variable problem", "id": 40370, "time": "2003-07-10T20:40:35Z", "creator": "trawick@apache.org", "creation_time": "2003-07-10T20:40:35Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 21371, "text": "The patch posted previously has been committed to Apache 2.1-dev and proposed\nfor merge to 2.0.48-dev.\n", "id": 40658, "time": "2003-07-14T17:34:24Z", "creator": "trawick@apache.org", "creation_time": "2003-07-14T17:34:24Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "text": "I tried the patch and got the same results.  I do not think that the patch fixed\nthe problem.", "attachment_id": null, "id": 40766, "creation_time": "2003-07-15T20:32:34Z", "time": "2003-07-15T20:32:34Z", "creator": "mark@dolphtech.com", "bug_id": 21371, "is_private": false}, {"count": 5, "tags": [], "bug_id": 21371, "text": "Then I suppose more changes are required :(  The change in the patch corrected a\nblatant error which has also been fixed in the mod_ssl project for 1.3.\n\nDo you have any setup hints for testing this scenario?  Perhaps you can point to\nsome documentation?\n", "id": 40805, "time": "2003-07-16T11:11:34Z", "creator": "trawick@apache.org", "creation_time": "2003-07-16T11:11:34Z", "is_private": false, "attachment_id": null}, {"count": 6, "attachment_id": null, "creator": "mark@dolphtech.com", "text": "This is what I do...\n\nto compile apache(2.0.47).  I am using openSSL 0.9.7b, compiled from source, and\ninstalled in /usr/local/ssl.\n./configure --enable-so --enable-ssl --with-ssl=/usr/local/ssl\ngmake \ngmake install\n\nto configure apache\ncreate a test cert for apache, set up ssl.conf properly.\nopen browser, point to test-cgi.\nobserve that certificate chain is not listed in the output.\n\nThis proves to me that the certificate chain is not being passed to the CGI, and\ntherefore would not be passed to a servlet either.  I am most interested in\ngetting apache to pass the entire certificate chain to a servlet, but am using\ncgi's to test with right now.  This is because it is easier to test, and takes\nthe tomcat connector stuff out of the equation.\n\nPlease let me know what more help I may be.", "id": 40815, "time": "2003-07-16T12:23:16Z", "bug_id": 21371, "creation_time": "2003-07-16T12:23:16Z", "tags": [], "is_private": false}, {"count": 7, "attachment_id": null, "creator": "trawick@apache.org", "text": "I'm stuck at the point of getting a certificate chain passed from the client. \n(No idea how to do that yet :) ).  I see SSL_CLIENT_CERT being set but with the\nfollowing patch to one of the mod_ssl files I see that OpenSSL is telling\nmod_ssl that there are zero certificates in the chain.\n\nTry testing with this patch to see if OpenSSL has provided mod_ssl with a chain.\nIf it hasn't, you'll see something like I did:\n\n[debug] ssl_engine_kernel.c(1064): [client 9.65.78.133] got peer certificate\nchain (0/8245458/8252f50)\n\nwhere the 0 after \"chain (\" is the number of certificates in the chain returned\nby OpenSSL...\n\nIndex: modules/ssl/ssl_engine_kernel.c\n===================================================================\nRCS file: /home/cvs/httpd-2.0/modules/ssl/ssl_engine_kernel.c,v\nretrieving revision 1.82.2.6\ndiff -u -r1.82.2.6 ssl_engine_kernel.c\n--- modules/ssl/ssl_engine_kernel.c     16 May 2003 18:12:18 -0000      1.82.2.6\n+++ modules/ssl/ssl_engine_kernel.c     16 Jul 2003 17:28:03 -0000\n@@ -1059,6 +1061,9 @@\n         apr_table_setn(env, \"SSL_CLIENT_CERT\", val);\n\n         if ((peer_certs = (STACK_OF(X509) *)SSL_get_peer_cert_chain(ssl))) {\n+            ap_log_rerror(APLOG_MARK, APLOG_DEBUG, 0, r,\n+                          \"got peer certificate chain (%d/%pp/%pp)\",\n+                          sk_X509_num(peer_certs), peer_certs, ssl);\n             for (i = 0; i < sk_X509_num(peer_certs); i++) {\n                 var = apr_psprintf(r->pool, \"SSL_CLIENT_CERT_CHAIN_%d\", i);\n                 val = ssl_var_lookup(r->pool, r->server, r->connection,\n@@ -1067,6 +1072,10 @@\n                     apr_table_setn(env, var, val);\n                 }\n             }\n+        }\n+        else {\n+            ap_log_rerror(APLOG_MARK, APLOG_DEBUG, 0, r,\n+                          \"SSL library returned no peer certificate chain\");\n         }\n     }\n\n", "id": 40854, "time": "2003-07-16T17:50:48Z", "bug_id": 21371, "creation_time": "2003-07-16T17:50:48Z", "tags": [], "is_private": false}, {"count": 8, "attachment_id": null, "bug_id": 21371, "text": "Confirmed fixed in 2.0.46 + Jeff's off-by-one patch.\n\nMark, you did have \"SSLOptions +ExportCertData\" set in the right context?\n\n(Mozilla doesn't seem to send the CA certs included in an imported PKCS#12 ccert\nfor me, neither will \"openssl s_client\"; maybe MSIE does it, I had to hack my\nown code to reproduce this)", "id": 44236, "time": "2003-09-16T12:43:49Z", "creator": "jorton@redhat.com", "creation_time": "2003-09-16T12:43:49Z", "tags": [], "is_private": false}]