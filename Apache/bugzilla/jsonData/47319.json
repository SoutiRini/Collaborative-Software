[{"count": 0, "tags": [], "text": "Hello,\n\nI posted this info to the tomcat users mailing list and am following Mark Thomas' advice to open a bug report:\n\nMy setup is a RedHat 5 server (32 bit) running Tomcat 6.0.20 with Tomcat Native 1.1.16 libraries and Sun JDK 1.6.0_14.  I've built and installed Tomcat Native as described in http://tomcat.apache.org/native-doc/\n\nThe server.xml file has been modified to add enableLookups=\"true\" to the HTTP Connector entry:\n\n    <Connector port=\"8080\" protocol=\"HTTP/1.1\"\n               connectionTimeout=\"20000\"\n               enableLookups=\"true\"\n               redirectPort=\"8443\" />\n\nNow, when the client exists in the DNS, reverse lookups via HttpServletRequest.getRemoteHost() work fine whether or not I'm using APR.\n\nThe problem is, when attempting a reverse lookup for a client that is not found in the naming service, the behaviour of getRemoteHost() depends on whether or not APR is being used.  Specifically, without APR, the method returns the dotted-string form of the IP address (consistent with the doc http://java.sun.com/webservices/docs/1.6/api/javax/servlet/ServletRequest.html#getRemoteHost() ).  However, when APR is enabled, the method returns NULL.\n\nI can reproduce the problem using a simple test servlet:\n\n# cat GetAddress.java\nimport java.io.*;\nimport java.util.*;\nimport javax.servlet.*;\nimport javax.servlet.http.*;\n\npublic class GetAddress extends HttpServlet {\n  public void doGet(HttpServletRequest request,HttpServletResponse response)\n    throws IOException, ServletException{\n    response.setContentType(\"text/html\");\n    PrintWriter out = response.getWriter();   \n    out.println(\"<b><font color='red'>Hostname of request : </font></b>\"\n        +request.getRemoteHost()+\"<p>\");\n    out.println(\"<b><font color='blue'>IP Address of request : </font></b>\"\n        +request.getRemoteAddr());\n  }\n}\n\nIf LD_LIBRARY_PATH is set to $CATALINA_HOME/lib, catalina.out confirms APR is enabled:\n\n05-Jun-2009 11:09:01 org.apache.catalina.core.AprLifecycleListener init\nINFO: Loaded APR based Apache Tomcat Native library 1.1.16.\n05-Jun-2009 11:09:01 org.apache.catalina.core.AprLifecycleListener init\nINFO: APR capabilities: IPv6 [true], sendfile [true], accept filters [false], random [true].\n05-Jun-2009 11:09:02 org.apache.coyote.http11.Http11AprProtocol init\n\nFrom my client unknown to the DNS, the web page shows \"Hostname of request: null ... IP Address of request: <client IP address>\"\n\nNow, after simply unsetting LD_LIBRARY_PATH and restarting Tomcat (catalina.out confirms APR is not used), a request from the same client correctly shows \"Hostname of request: <client IP address>... IP Address of request: <client IP address>\"\n\n\nThis behaviour with APR is causing problems for a third-party application that relies on identifying the client IP/host for authentication - as the code does not expect NULL from getRemoteHost() it denies access to the client (coming from another company via LAN-to-LAN VPN).\n\nAny ideas on how to debug this further?  Nothing is logged to catalina.out when the error occurs.  I also had a quick look in the APR source but couldn't find any reference to getRemoteHost or enableLookups so I'm not sure where this side effect is coming from.\n\nThanks in advance for any feedback,\n\nBest regards\n\n\n- Paul.", "attachment_id": null, "bug_id": 47319, "id": 127672, "time": "2009-06-05T05:11:52Z", "creator": "paulseed@yahoo.com", "creation_time": "2009-06-05T05:11:52Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 47319, "text": "In fact that needs to be fixed in java/org/apache/coyote/http11/Http11AprProcessor.java", "id": 143119, "time": "2011-01-06T09:01:16Z", "creator": "jfclere@gmail.com", "creation_time": "2011-01-06T09:01:16Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "Fixed in 7.0.x and will be included in 7.0.6 onwards.\n\nProposed for 6.0.x", "id": 143127, "time": "2011-01-06T12:07:03Z", "bug_id": 47319, "creation_time": "2011-01-06T12:07:03Z", "is_private": false}, {"count": 3, "tags": [], "text": "This has been fixed in 6.0.x and will be included in 6.0.30 onwards.", "attachment_id": null, "bug_id": 47319, "id": 143180, "time": "2011-01-07T12:49:33Z", "creator": "markt@apache.org", "creation_time": "2011-01-07T12:49:33Z", "is_private": false}, {"count": 4, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "id": 143190, "time": "2011-01-07T17:33:10Z", "bug_id": 47319, "creation_time": "2011-01-07T17:33:10Z", "is_private": false, "text": "Proposed for 5.5.x as well."}, {"count": 5, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 143508, "time": "2011-01-20T12:14:11Z", "bug_id": 47319, "creation_time": "2011-01-20T12:14:11Z", "is_private": false, "text": "Fixed in 5.5.x and will be in 5.5.32 onwards."}]