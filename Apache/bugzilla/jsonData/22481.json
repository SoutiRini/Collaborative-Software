[{"count": 0, "tags": [], "bug_id": 22481, "attachment_id": null, "id": 42845, "time": "2003-08-16T10:00:11Z", "creator": "amorrow@nouveausystems.com", "creation_time": "2003-08-16T10:00:11Z", "is_private": false, "text": "MSVC 7 (.NET) compiler no longer links against MSVCRT.DLL .\nIt will only link against MSVCR71.DLL !\nThis applies to Windows NT, 2K, XP and all forseeable future Windows releases.\n(Note that the .NET IDE is also knows as Visual Studio 2003.)\n\nThis is best documented here:\nhttp://msdn.microsoft.com/library/default.asp?url=/library/en-\nus/vclib/html/_crt_c_run.2d.time_libraries.asp\n\nThe critical lines are:\n\"Any application built with Visual C++ .NET using the /MD switch will \nnecessarily use msvcr71.dll.\"\n\"If your DLLs pass CRT resources across the msvcrt.dll and msvcr71.dll \nboundary, you will encounter issues with mismatched CRTs and need to recompile \nyour project with Visual C++ .NET.\"\n\n\nThis has a major implication:\n\nModule developers working with pre-built binaries (currently built with MSVC 6, \nas far as I can tell) and building their module with the MSVC 7 compiler, the \nmodule cannot share any C RTL resources used in the module with the APR!\n\nBackground: I recently examined a problem with mod_filter on Windows.  I was \nusing a pre-built version of Apache, but I built the module with the latest \nMSVC compiler, Version 7, the .NET version.\n\nhttp://cvs.tangent.org/cgi/viewcvs.cgi/*checkout*/mod_filter/mod_filter.c\n\nThe problem was found in lines like:\n\n if ((temp_fd = ap_popenf(plp, filename, O_RDONLY, ...)) < 0) {\n   /* Handle error ... */\n }\n (void)fstat(temp_fd, &sbuf);\n\nAgain, I am using the MSVC 7 compiler to build this module and the pre-built \nApache binaries for Windows.\n\nThis now fails because the temp_fd is created via Apache.exe's MSVCRT.DLL but \nthe module will get an EBADF (Bad file descriptor) on the fstat() call because \nit will be calling MSVCR71.DLL, which has a separate set of integer file \ndescriptors (and all other C RTL static data).\n\nThe immediate workaround is to abandon the APR (at least for files) on Windows \nand switch back to an open() (or fopen() insteads of ap_pfopen(), perhaps \nfollowed by fileno()).\n\nEven if the typical Windows software engineer is somewhat informed of this \nissue in general, s/he will have to recognize that the program is crossing a \nDLL (or EXE) boundary and getting a different instance of the C RTL if they \nencounter this problem.  This could be a nasty time-sink for anyone trying to \nwork with pre-built versions of Apache.\n\nI think that there is serious motivation for apache.org to publish two Windows \nbinary releases of Apache: pre- and post- .NET , both as a service to users and \nto raise awareness of the issue.\n\nThe easiest way to demonstrate to yourself that this is a major discontinuity \nin the Windows platform for extensible programs, you can use \nthe \"dumpbin.exe /imports\" command on any *.exe or *.dll file.  Almost all \nexisitng file will link to MSVCRT.DLL, but all binaries produced by MSVC 7 \ncompielr will point to MSVCR7.DLL .\n\nIf apache.org cannot distribute multiple binary releases, then the Windows \nrelease notes should have a major heads-up about this issue throughout the \nWindows release notes.\n\nOther major projects also have to deal with this issue. For instance, Python:\n\nAnnouncement from Guido van Rossum\nhttp://mail.python.org/pipermail/python-dev/2003-May/035375.html"}, {"count": 1, "tags": [], "creator": "amorrow@nouveausystems.com", "attachment_id": null, "id": 42846, "time": "2003-08-16T10:20:41Z", "bug_id": 22481, "creation_time": "2003-08-16T10:20:41Z", "is_private": false, "text": "\nNote: I have confirmed this in httpd-1.3 and, based on the dumpbin results, I \nassume that it also will occur in httpd-2.0.\n"}, {"count": 2, "tags": [], "text": "Why not compile Apache2 with VS.NET yourself?\n\nhttp://www.devside.net/web/server/win32", "is_private": false, "bug_id": 22481, "id": 54341, "time": "2004-03-21T18:07:49Z", "creator": "towerofpower@operamail.com", "creation_time": "2004-03-21T18:07:49Z", "attachment_id": null}, {"count": 3, "attachment_id": null, "creator": "towerofpower@operamail.com", "is_private": false, "id": 54504, "time": "2004-03-23T20:42:49Z", "bug_id": 22481, "creation_time": "2004-03-23T20:42:49Z", "tags": [], "text": "E:\\www\\Apache2\\bin>dumpbin /imports Apache.exe\nMicrosoft (R) COFF/PE Dumper Version 7.00.9466\nCopyright (C) Microsoft Corporation.  All rights reserved.\n\n\nDump of file Apache.exe\n\nFile Type: EXECUTABLE IMAGE\n\n  Section contains the following imports:\n\n    libapr.dll\n                402060 Import Address Table\n                402C90 Import Name Table\n                     0 time date stamp\n                     0 Index of first forwarder reference\n\n                    F _apr_app_initialize@12\n                   14 _apr_array_make@12\n                   74 _apr_getopt_init@16\n                   73 _apr_getopt@16\n                   17 _apr_array_push@4\n                   FE _apr_pstrdup@8\n                   CC _apr_pool_clear@4\n                   CE _apr_pool_create_ex@16\n                   D9 _apr_pool_tag@8\n                   B1 _apr_palloc@8\n                   60 _apr_filename_of_pathname@4\n                   D0 _apr_pool_destroy@4\n                  193 apr_terminate\n\n    libaprutil.dll\n                402098 Import Address Table\n                402CC8 Import Name Table\n                     0 time date stamp\n                     0 Index of first forwarder reference\n\n                   3F _apr_hook_deregister_all@0\n                   40 _apr_hook_sort_all@0\n                   3D _apr_dynamic_fn_retrieve@4\n\n    libhttpd.dll\n                4020A8 Import Address Table\n                402CD8 Import Name Table\n                     0 time date stamp\n                     0 Index of first forwarder reference\n\n                  184 ap_server_post_read_config\n                  185 ap_server_pre_read_config\n                  139 _ap_setup_prelinked_modules@4\n                  182 ap_server_argv0\n                  161 ap_conftree\n                  11D _ap_run_pre_config@12\n                  13C _ap_show_modules@0\n                  13B _ap_show_directives@0\n                   E0 _ap_process_config_tree@16\n                   45 _ap_fixup_virtual_hosts@8\n                  183 ap_server_config_defines\n                  119 _ap_run_open_logs@16\n                  11B _ap_run_post_config@16\n                  17A ap_prelinked_modules\n                   EC _ap_register_hooks@8\n                  11A _ap_run_optional_fn_retrieve@0\n                   CB _ap_mpm_run@12\n                  172 ap_log_error\n                   D1 _ap_open_stderr_log@4\n                  193 real_exit_code\n                   5A _ap_get_server_version@0\n                   57 _ap_get_server_built@0\n                  122 _ap_run_rewrite_args@4\n                  167 ap_default_loglevel\n                  186 ap_server_root\n                   44 _ap_fini_vhost_config@8\n                  100 _ap_replace_stderr_log@8\n                   E6 _ap_read_config@16\n\n    MSVCR70.dll\n                402008 Import Address Table\n                402C38 Import Name Table\n                     0 time date stamp\n                     0 Index of first forwarder reference\n\n                   CD _c_exit\n                   FE _exit\n                   4F _XcptFilter\n                   D0 _cexit\n                   7F __p___initenv\n                   C5 _amsg_exit\n                  299 exit\n                  142 _initterm\n                   A2 __setusermatherr\n                   BE _adjust_fdiv\n                   85 __p__commode\n                   8A __p__fmode\n                  204 _strnicmp\n                   71 __getmainargs\n                  200 _stricmp\n                   F5 _except_handler3\n                   DE _controlfp\n                  1BB _onexit\n                   6E __dllonexit\n                   9F __set_app_type\n                  2EE printf\n\n    KERNEL32.dll\n                402000 Import Address Table\n                402C30 Import Name Table\n                     0 time date stamp\n                     0 Index of first forwarder reference\n\n                  167 GetModuleHandleA\n\n  Summary\n\n        1000 .data\n        2000 .rdata\n        1000 .rsrc\n        1000 .text"}, {"count": 4, "tags": [], "text": "\nYes, if you are simply building from source, this will not be an issue.\n\nMy points are:\n - you have to coordinate all third-party custom modules\n   (e.g. all prorietary modules must be built on either all pre-.NET or \nall .NET _if_ they share CRTL resources)\n  - It is not so easy to recognize this problem if you have not heard about it \nbefore\n\n", "is_private": false, "id": 54664, "creator": "amorrow@nouveausystems.com", "time": "2004-03-25T16:07:51Z", "bug_id": 22481, "creation_time": "2004-03-25T16:07:51Z", "attachment_id": null}]