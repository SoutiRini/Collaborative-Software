[{"count": 0, "attachment_id": null, "creator": "thad.humphries@gmail.com", "is_private": false, "id": 191034, "time": "2016-05-17T17:11:10Z", "bug_id": 59564, "creation_time": "2016-05-17T17:11:10Z", "tags": [], "text": "If I enable HTTP/2 via UpgradeProtocol, HttpServletRequest.getPart() always returns null. This occurs in my own code as well as in org.apache.catalina.manager.HTMLManagerServlet (so, a *.WAR cannot be deployed if HTTP/2 is enabled). When <UpgradeProtocol...> is commented out, upload works.\n\nMy connector is\n\n<!-- NIO connector with OpenSSL -->\n<Connector port=\"8443\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\"\n           maxThreads=\"200\" SSLEnabled=\"true\" compression=\"on\"\n           scheme=\"https\" secure=\"true\">\n  <UpgradeProtocol className=\"org.apache.coyote.http2.Http2Protocol\" />\n  <SSLHostConfig honorCipherOrder=\"false\">\n    <Certificate certificateKeyFile=\"conf/foo-nopp.pem\"\n                 certificateFile=\"conf/foo.pem\"\n                 type=\"RSA\" />\n  </SSLHostConfig>\n</Connector>\n\nThe failure occurs with either Http11NioProtocol or Http11Nio2Protocol.\n\nI'm am running Tomcat 8.5, Java 1.8.0_91, MacOS 10.10.5, and both Chrome 50 and Firefox 46."}, {"count": 1, "tags": [], "bug_id": 59564, "is_private": false, "id": 191142, "attachment_id": null, "creator": "remm@apache.org", "creation_time": "2016-05-20T13:27:04Z", "time": "2016-05-20T13:27:04Z", "text": "This works for me (can't sat anything else really)."}, {"count": 2, "tags": [], "bug_id": 59564, "attachment_id": null, "text": "Rats. I was afraid that's what I'd be told. Is something wrong with my connector? The cert is self-signed. Does that matter?", "id": 191150, "time": "2016-05-21T02:28:48Z", "creator": "thad.humphries@gmail.com", "creation_time": "2016-05-21T02:28:48Z", "is_private": false}, {"count": 3, "tags": [], "creator": "remm@apache.org", "is_private": false, "text": "No idea at this point. I guess it will be explained eventually.", "id": 191183, "time": "2016-05-23T14:24:06Z", "bug_id": 59564, "creation_time": "2016-05-23T14:24:06Z", "attachment_id": null}, {"count": 4, "tags": [], "creator": "violetagg@apache.org", "text": "Hi,\n\nI was able to reproduce this issue.\n\nI think that we should invoke 'data.arrayOffset() + data.position()' when we fill the data:\n\n\nIndex: Http2Parser.java\n===================================================================\n--- Http2Parser.java\t(revision 1745545)\n+++ Http2Parser.java\t(working copy)\n@@ -561,7 +561,7 @@\n         }\n \n         default boolean fill(boolean block, ByteBuffer data, int len) throws IOException {\n-            boolean result = fill(block, data.array(), data.arrayOffset(), len);\n+            boolean result = fill(block, data.array(), data.arrayOffset() + data.position(), len);\n             if (result) {\n                 data.position(data.position() + len);\n             }\n\nWhat do you think?\n\nRegards,\nVioleta", "id": 191261, "time": "2016-05-25T21:54:45Z", "bug_id": 59564, "creation_time": "2016-05-25T21:54:45Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 59564, "attachment_id": null, "id": 191266, "time": "2016-05-26T08:46:36Z", "creator": "markt@apache.org", "creation_time": "2016-05-26T08:46:36Z", "is_private": false, "text": "Reproducible with:\n- Clean 9.0.x build\n- NIO + OpenSSL + HTTP/2\n- ~40MB WAR (Spring Pet Clinic)\n\nVioleta's patch fixes this so I have applied it to 9.0.x for 9.0.0.M7 onwards and 8.5.x for 8.5.3 onwards."}]