[{"count": 0, "tags": [], "bug_id": 31633, "attachment_id": null, "text": "I use httpd-2.0.52 (but same effect with .51)\nWhen I try to authenticate my proxy server (mod_proxy) to a remote server with \na certificate using the SSLProxyMachineCertificateFile, my httpd child process \nexits with a segmentation fault (both in prefork and worker mode). Following \nmessage in error_log (on proxy server):\n[Mon Oct 11 07:42:39 2004] [notice] child pid 18156 exit signal Segmentation \nfault (11)\n\nRemark: if the remote server has to authenticate itself to the proxy with a \ncertificate, it works without any problem.\n\nHere is the proxy configuration:\n--------------------------------\n<VirtualHost 159.29.24.152:443>\n\tServerName uws0064.rtc.ch\n\tServerAdmin root@uws0064.rtc.ch\n\tDocumentRoot /export/home/apache2/htdocs\n\tErrorLog /var/apache/logs/uws0064-error_log\n\tCustomLog /var/apache/logs/uws0064-access_log common\n\tCustomLog /var/apache/logs/ssl_request_log \\\n\t  \"%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \\\"%r\\\" %b\"\n# SSL directives:\n\tSSLEngine On\n\t<Directory />\n\t\tSSLRequireSSL\n\t</Directory>\n\tSSLProtocol -All +SSLv3 +TLSv1\n\tSSLVerifyClient none\n\tSSLVerifyDepth\t 10\n\tSSLCertificateKeyFile /etc/apache/ssl.key/uws0064.rtc.ch.key\n\tSSLCertificateFile /etc/apache/ssl.crt/uws0064.rtc.ch.crt\n# Configuration for the proxy:\n\tProxyRequests On\n\tSSLProxyEngine On\n\tProxyVia On\n\tSSLProxyProtocol -All +SSLv3 +TLSv1\n# Remote server has to provide a valid certificate:\n#\tSSLProxyVerify require\n#\tSSLProxyCACertificateFile /etc/apache/ssl.crt/uws0068.rtc.ch.crt\n# This server must deliver the remote server a valid certificate:\n\tSSLProxyMachineCertificateFile /etc/apache/ssl.crt/uws0064.rtc.ch.crt\n# Other proxy directives:\n\t<Proxy *>\n                Order deny,allow\n\t\tDeny from all\n\t\tAllow from 159.29.0.0/16\n\t\tExtFilterOptions DebugLevel=1\n\t\tSetOutputFilter ebppfilter\n\t</Proxy>\n\tProxyPass /foo https://uws0068.rtc.ch:443\n\tProxyPassReverse /foo https://uws0068.rtc.ch:443\n</VirtualHost>\n\nHere is the remote server configuration:\n---------------------------------------\n<VirtualHost 159.29.24.104:443>\n\tServerAdmin root@uws0068.rtc.ch\n\tDocumentRoot /export/home/apache2/htdocs\n\tServerName uws0068.rtc.ch\n\tErrorLog /var/apache/logs/uws0068-error_log\n\tCustomLog /var/apache/logs/uws0068-access_log common\n\tSSLEngine On\n\tSSLProtocol SSLv3 +TLSv1\n\tSSLCertificateKeyFile /etc/apache/ssl.key/uws0068.rtc.ch.key\n\tSSLCertificateFile /etc/apache/ssl.crt/uws0068.rtc.ch.crt\n# Client must authenticate himself:\n#\tSSLVerifyClient none\n#\tSSLVerifyClient optional\n\tSSLVerifyClient require\n# if SSLVerifyClient require => apache process crashes \n(see /var/opt/apache/logs/error_log)\n\tSSLVerifyDepth\t 10\n\tSSLCACertificateFile /etc/apache/ssl.crt/uws0064.rtc.ch.crt\n</VirtualHost>\n\nuws0068-error_log on the remote server:\n--------------------------------------\n[Mon Oct 11 07:42:39 2004] [debug] ssl_engine_io.c(1517): OpenSSL: I/O error, \n5 bytes expected to read on BIO#263980 [mem: 2b0028]\n[Mon Oct 11 07:42:39 2004] [debug] ssl_engine_kernel.c(1793): OpenSSL: Exit: \nerror in SSLv3 read client certificate A\n[Mon Oct 11 07:42:39 2004] [debug] ssl_engine_kernel.c(1793): OpenSSL: Exit: \nerror in SSLv3 read client certificate A\n[Mon Oct 11 07:42:39 2004] [info] (70014)End of file found: SSL handshake \ninterrupted by system [Hint: Stop button pressed in browser?!]\n[Mon Oct 11 07:42:39 2004] [info] Connection to child 2 closed with abortive \nshutdown(server uws0068.rtc.ch:443, client 159.29.24.152)", "id": 64912, "time": "2004-10-11T06:48:40Z", "creator": "Jean-Louis.Morard@rtc.ch", "creation_time": "2004-10-11T06:48:40Z", "is_private": false}, {"count": 1, "text": "Can you firstly eliminate the ExtFilter defintion in the Proxy block, to\nsimplify the reproduction case?\n\n                ExtFilterOptions DebugLevel=1\n                SetOutputFilter ebppfilter\n\nand then, can you try to obtain a core dump and a backtrace? (from a\nprefork-based server is best).\n\nYou may need to use coreadm to enable core dumps on Solaris:\n\nhttp://httpd.apache.org/dev/debugging.html#sol27\n\n", "bug_id": 31633, "is_private": false, "id": 64916, "time": "2004-10-11T09:35:23Z", "creator": "jorton@redhat.com", "creation_time": "2004-10-11T09:35:23Z", "tags": [], "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 31633, "is_private": false, "text": "Created attachment 13023\ntar file + gzip", "id": 64924, "time": "2004-10-11T11:41:57Z", "creator": "Jean-Louis.Morard@rtc.ch", "creation_time": "2004-10-11T11:41:57Z", "attachment_id": 13023}, {"count": 3, "tags": [], "bug_id": 31633, "attachment_id": null, "text": "\nHallo,\n\nFollowing your proposition, I recompiled the httpd server with the -g flag and \ninstalled it. Then I used the 3 following tools:\n\na] gcore:\n    # for pid in `ps -eaf | fgrep httpd | cut -d' ' -f4`\n    do\n      truss -f -l -t\\!all -S SIGSEGV -p $pid 2>&1 | egrep SIGSEGV &\n    done\n\tgcore <pid>\nb] pstack <pid>\nc] gdb httpd <pid>\n\nThe results of these commands as well as the logs are in the tar file.\nThanks 1000000000 times for your support! It's great!\n\nCheers,\nJean-Louis\n", "id": 64925, "time": "2004-10-11T11:43:25Z", "creator": "Jean-Louis.Morard@rtc.ch", "creation_time": "2004-10-11T11:43:25Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 31633, "attachment_id": null, "id": 64926, "time": "2004-10-11T11:45:00Z", "creator": "Jean-Louis.Morard@rtc.ch", "creation_time": "2004-10-11T11:45:00Z", "is_private": false, "text": "\nSorry, another comment: I also removed the filter function from the httpd.conf \nfile."}, {"count": 5, "tags": [], "bug_id": 31633, "is_private": false, "id": 64928, "creation_time": "2004-10-11T12:07:53Z", "time": "2004-10-11T12:07:53Z", "creator": "jorton@redhat.com", "text": "The client certificate you configured: /etc/apache/ssl.crt/uws0064.rtc.ch.crt  -\nis it encrypted?  There is a known bug where you can get segfaults if you\nconfigure an encrypted client cert.\n", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 31633, "attachment_id": 13027, "is_private": false, "id": 64929, "time": "2004-10-11T13:53:55Z", "creator": "Jean-Louis.Morard@rtc.ch", "creation_time": "2004-10-11T13:53:55Z", "text": "Created attachment 13027\nSSL certificate for the proxy client"}, {"count": 7, "tags": [], "bug_id": 31633, "attachment_id": null, "id": 64930, "time": "2004-10-11T13:56:00Z", "creator": "Jean-Louis.Morard@rtc.ch", "creation_time": "2004-10-11T13:56:00Z", "is_private": false, "text": "\n\nHere is the certificate. Tell me if it dosen't work.\nFor the production time, the remote server is not in our enterprise. Is it in \nthis case possible to use an uncrypted certificate?\nI compiled on a redhat server. Same effect...\n"}, {"count": 8, "text": "There is no private key in that file - you must put *both* the client\ncertificate and the unencrypted private key file in the file referenced by\nSSLProxyMachineCertificateFile, per the documentation:\n\nhttp://httpd.apache.org/docs-2.0/mod/mod_ssl.html#sslproxymachinecertificatefile\n\nThe server should not crash, of course: that is filed as bug 24030.\n\n\n\n\n\n\n*** This bug has been marked as a duplicate of 24030 ***", "bug_id": 31633, "is_private": false, "id": 64939, "time": "2004-10-11T15:56:46Z", "creator": "jorton@redhat.com", "creation_time": "2004-10-11T15:56:46Z", "tags": [], "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 31633, "attachment_id": null, "text": "Hy,\nI tried it and it works well. This is now the occasion for me to thank you for \nyour support. This is really GREAT! Freeware support for such a quality and \nrapidity, wouahhh! Thanks again!\nWhen do you think you have a patch or a new release for the bug 24030?", "id": 65127, "time": "2004-10-14T15:21:16Z", "creator": "Jean-Louis.Morard@rtc.ch", "creation_time": "2004-10-14T15:21:16Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 31633, "is_private": false, "id": 65129, "creation_time": "2004-10-14T15:32:47Z", "time": "2004-10-14T15:32:47Z", "creator": "jorton@redhat.com", "text": "It's proposed for inclusion in 2.0.53.", "attachment_id": null}]