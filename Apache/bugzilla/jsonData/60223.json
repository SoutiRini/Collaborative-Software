[{"count": 0, "tags": [], "bug_id": 60223, "attachment_id": 34335, "id": 194217, "time": "2016-10-07T22:26:52Z", "creator": "paul.spangler@ni.com", "creation_time": "2016-10-07T22:26:52Z", "is_private": false, "text": "Created attachment 34335\nTrunk patch to clear the error queue when SSL_get_error is needed\n\nmod_ssl doesn't clear the OpenSSL error queue prior to calling SSL_read, SSL_write, or SSL_accept. It then relies on SSL_get_error to be notified of errors such as SSL_ERROR_WANT_READ. Modules such as mod_websocket that perform non-blocking IO may receive errors if some other OpenSSL error is already queued.\n\nOne specific series of events where I run into errors:\n\n1. The server is configured to use mod_session_crypto with the OpenSSL APR crypto provider.\n2. The client connects over TLS and requests a WebSocket upgrade.\n3. The client's session data is either corrupt or encrypted using an old key.\n4. mod_session_crypto attempts to decrypt the session, which results in a call to the OpenSSL function EVP_EncryptFinal_ex.\n5. The decryption fails, and the EVP function queues an error to the thread's OpenSSL error queue. The session is discarded, but APR never retrieves the error.\n6. The WebSocket upgrade is accepted, and mod_websocket begins a non-blocking read on the input brigade.\n7. mod_ssl calls SSL_read and the bio_filter_in_read reports no data is available by calling BIO_set_retry_read and returning -1.\n8. mod_ssl then calls SSL_get_error, but instead of getting SSL_ERROR_WANT_READ, it gets the SSL_ERROR_SSL that was queued in step 5.\n9. mod_websocket closes the connection due to the error returned by ap_get_brigade.\n\n\nThe attached patch to mod_ssl simply calls ERR_clear_error() prior to calling those three SSL_* functions. Patch was tested with a 2.4.16 64-bit Windows build according to the sequence of events noted previously.\n\nSee https://www.openssl.org/docs/manmaster/ssl/SSL_get_error.html#DESCRIPTION for reference."}, {"count": 1, "text": "Committed in r1769332 (plus a couple explanatory comments), and proposed for backport to 2.4.x.", "creator": "jchampion@apache.org", "attachment_id": null, "id": 194930, "time": "2016-11-11T19:53:11Z", "bug_id": 60223, "creation_time": "2016-11-11T19:53:11Z", "tags": [], "is_private": false}, {"count": 2, "text": "Fixed in 2.4.25", "creator": "covener@gmail.com", "attachment_id": null, "id": 195744, "time": "2016-12-31T00:24:03Z", "bug_id": 60223, "creation_time": "2016-12-31T00:24:03Z", "tags": [], "is_private": false}]