[{"count": 0, "tags": [], "creator": "ken.avery@hp.com", "attachment_id": null, "id": 54169, "time": "2004-03-17T17:26:38Z", "bug_id": 27751, "creation_time": "2004-03-17T17:26:38Z", "is_private": false, "text": "Here is the backtrace:\n\nProgram ran under gdb with set args -X -f conf/leakd.conf\n\nThread 17 Stack Trace:\n\n*** Begin Stack Frame\n\n#0  0x403079a7 in memcpy () from /lib/libc.so.6\n#1  0x40404661 in shmcb_cyclic_cton_memcpy (buf_size=7190,\n    dest=0xbdbfcd2c \"0\\201\\221\\002\\001\\001\\002\\002\\003\\001\\004\\002\",\n    data=0x4048ebea \"\\0040\u00e8\u00cb\u00b4\u00ebR\\222\u00c13\u00ff\u00d3\\001\u00e0M\u00af\\236\u00f0g\\222\u00eb[\u00f9%\u00b7\u00fd\u00c6-f3z\u00a0)\n\u00f7\\023J\u00cc\u00e1\\233=\", \n    src_offset=6402, src_len=10240) at ssl_scache_shmcb.c:915\n#2  0x404052cb in shmcb_remove_session_id (s=0x80e2a98, \n    queue=0xbdbff58c,\n    cache=0xbdbff57c,\n    id=0x82708f8 \"\\177\u00c9\u00c1vL|\\0066=<{w%BQ.\u00f8\u00baI\u00c9n\u00dd7\u00fc\\001&\\017sI)\\224\\002 \",\n    idlen=32) at ssl_scache_shmcb.c:1338\n#3  0x40404527 in shmcb_remove_session (s=0x80e2a98, \n    shm_segment=0x40452000,\n    id=0x82708f8 \"\\177\u00c9\u00c1vL|\\0066=<{w%BQ.\u00f8\u00baI\u00c9n\u00dd7\u00fc\\001&\\017sI)\\224\\002 \",\n    idlen=32) at ssl_scache_shmcb.c:819\n#4  0x40403a2b in ssl_scache_shmcb_remove (s=0x80e2a98,\n    id=0x82708f8 \"\\177\u00c9\u00c1vL|\\0066=<{w%BQ.\u00f8\u00baI\u00c9n\u00dd7\u00fc\\001&\\017sI)\\224\\002 \",\n    idlen=32) at ssl_scache_shmcb.c:477\n#5  0x4040291c in ssl_scache_remove (s=0x80e2a98,\n    id=0x82708f8 \"\\177\u00c9\u00c1vL|\\0066=<{w%BQ.\u00f8\u00baI\u00c9n\u00dd7\u00fc\\001&\\017sI)\\224\\002 \",\n    idlen=32) at ssl_scache.c:158\n#6  0x403fcfc3 in ssl_callback_DelSessionCacheEntry (ctx=0x80de048,\n    session=0x82708b0) at ssl_engine_kernel.c:1742\n#7  0x40042f1b in timeout () from /lib/libssl.so.2\n#8  0x400b1d60 in lh_doall_arg () from /lib/libcrypto.so.2\n#9  0x40042fa0 in SSL_CTX_flush_sessions () from /lib/libssl.so.2\n#10 0x40040691 in ssl_update_cache () from /lib/libssl.so.2\n#11 0x4003270f in ssl3_accept () from /lib/libssl.so.2\n#12 0x4003f340 in SSL_accept () from /lib/libssl.so.2\n#13 0x4003bfe8 in ssl23_get_client_hello () from /lib/libssl.so.2\n#14 0x4003b7f5 in ssl23_accept () from /lib/libssl.so.2\n#15 0x4003f340 in SSL_accept () from /lib/libssl.so.2\n#16 0x403fa2f9 in ssl_io_filter_connect (filter_ctx=0x82313d8)\n    at ssl_engine_io.c:1070\n#17 0x403fa664 in ssl_io_filter_input (f=0x82b82d0, bb=0x82a8f28,\n    mode=AP_MODE_GETLINE, block=APR_BLOCK_READ, readbytes=0)\n    at ssl_engine_io.c:1239\n#18 0x0807218e in ap_get_brigade (next=0x82b82d0, bb=0x82a8f28,\n    mode=AP_MODE_GETLINE, block=APR_BLOCK_READ, readbytes=0)\n    at util_filter.c:514\n#19 0x0807218e in ap_get_brigade (next=0x82a8ec8, bb=0x82a8f28,\n    mode=AP_MODE_GETLINE, block=APR_BLOCK_READ, readbytes=0)\n    at util_filter.c:514\n#20 0x08072f93 in ap_rgetline_core (s=0x82a82b8, n=8192, read=0xbdbff9d8,\n    r=0x82a82a0, fold=0, bb=0x82a8f28) at protocol.c:256\n#21 0x08073455 in read_request_line (r=0x82a82a0, bb=0x82a8f28)\n    at protocol.c:623\n#22 0x080739d7 in ap_read_request (conn=0x8231060) at protocol.c:900\n#23 0x080608db in ap_process_http_connection (c=0x8231060) at \n    http_core.c:312\n#24 0x0807060a in ap_run_process_connection (c=0x8231060) at \n    connection.c:85\n#25 0x08065916 in process_socket (p=0x8230f38, sock=0x8230f70, \n    my_child_num=0,\n    my_thread_num=13, bucket_alloc=0x825d100) at worker.c:632\n#26 0x08065f0a in worker_thread (thd=0x80fde88, dummy=0x812bc88)\n    at worker.c:946\n#27 0x401f5090 in dummy_worker (opaque=0x80fde88) at thread.c:127\n#28 0x40205f77 in pthread_start_thread () from /lib/libpthread.so.0\n\n***End of Stack Frame\n\nInfo Threads:\n\n  29 Thread 27676 (LWP 1526)  0x40360b60 in poll () from /lib/libc.so.6\n  18 - 28 in sigsuspend () from /lib/libc.so.6\n* 17 Thread 15376 (LWP 1514)  0x403079a7 in memcpy () from /lib/libc.so.6\n  3 - 16 in sigsuspend () from /lib/libc.so.6\n  2 Thread 2049 (LWP 1499)  0x40360b60 in poll () from /lib/libc.so.6\n  1 Thread 1024 (LWP 1492)  0x402b4136 in sigsuspend () from /lib/libc.so.6\n\nCPU Registers:\n\neax            0x24ec   9452\necx            0x36     54\nedx            0xbdbfd040       -1111502784\nebx            0x4041089c       1078003868\nesp            0xbdbfcc9c       0xbdbfcc9c\nebp            0xbdbfccd4       0xbdbfccd4\nesi            0x40490ffe       1078530046\nedi            0xbdbff454       -1111493548\neip            0x40404661       0x40404661\neflags         0x202    514\ncs             0x23     35\nss             0x2b     43\nds             0x2b     43\nes             0x2b     43\nfs             0x0      0\ngs             0x0      0\nfctrl          0x37f    895\nfstat          0x20     32\nftag           0xffff   65535\nfiseg          0x23     35\nfioff          0x400b2af8       1074473720\nfoseg          0x2b     43\nfooff          0x40101950       1074796880\nfop            0x5d8    1496\nxmm0           {f = {0x0, 0x0, 0x0, 0x0}}       {f = {-nan(0x7fffff),\n    -nan(0x7fffff), -nan(0x7fffff), -nan(0x7fffff)}}\n\nxmm1-xmm7 the same as xmm0\n\nmxcsr          0x1f80   8064\norig_eax       0xffffffff       -1\n\nfunction where issue is located:\n\n901     static void shmcb_cyclic_cton_memcpy(\n902         unsigned int buf_size,\n903         unsigned char *dest,\n904         unsigned char *data,\n905         unsigned int src_offset,\n906         unsigned int src_len)\n907     {\n908         /* Can it be copied all in one go? */\n909         if (src_offset + src_len < buf_size)\n910             /* yes */\n911             memcpy(dest, data + src_offset, src_len);\n912         else {\n913             /* no */\n914             memcpy(dest, data + src_offset, buf_size - src_offset);\n*915             memcpy(dest + buf_size - src_offset, data,\n916                    src_len + src_offset - buf_size);\n\n(gdb) print dest + buf_size - src_offset\n$57 = (unsigned char *) 0xfffff4ee <Address 0xfffff4ee out of bounds>\n(gdb) print src_len + src_offset - buf_size\n$58 = 2071963774\n(gdb)\n\n917         }\n918         return;\n919     }\n\nFrame Information [frame 1]:\n\n#1  0x40404661 in shmcb_cyclic_cton_memcpy (\nbuf_size=7190,\ndest=0xbdbfcd2c \"0\\201\\221\\002\\001\\001\\002\\002\\003\\001\\004\\002\",\ndata=0x4048ebea \"\\0040\u00e8\u00cb\u00b4\u00ebR\\222\u00c13\u00ff\u00d3\\001\u00e0M\u00af\\236\u00f0g\\222\u00eb[\u00f9%\u00b7\u00fd\u00c6-f3z\u00a0)\n\u00f7\\023J\u00cc\u00e1\\233=\", \nsrc_offset=6402, \nsrc_len=10240\n) at ssl_scache_shmcb.c:915\n\n915             memcpy(dest + buf_size - src_offset, data, \n916                           src_len + src_offset - buf_size);\n\nVariables in the Frame context:\n\n(gdb) print buf_size\n$49 = 7190\n(gdb) print dest\n$51 = (unsigned char *) 0xbdbfcd2c \"0\\201\\221\\002\\001\\001\\002\\002\\003\\001\\004\n\\002\"\n(gdb) print data\n$53 = (unsigned char *) 0x4048ebea \"\\0040\u00e8\u00cb\u00b4\u00ebR\\222\u00c13\u00ff\u00d3\\001\u00e0M\u00af\\236\u00f0g\\222\u00eb[\u00f9%\u00b7\u00fd\u00c6-\nf3z\u00a0)\u00f7\\023J\u00cc\u00e1\\233=\"\n(gdb) print src_offset\n$55 = 3183473748  \n(gdb) print &src_offset\nAddress requested for identifier \"src_offset\" which is in register $edi\n(gdb) print src_len\n$56 = 3183464512\n(gdb) print &src_len\nAddress requested for identifier \"src_len\" which is in register $edx\n\n(gdb) info register edi edx\nedi            0xbdbff454       -1111493548\nedx            0xbdbfd040       -1111502784\n\nThese variable values do appear to be valid based on the stack trace?\n   \nsrc_offset = 3183473748  location register edi=0xbdbff454  -1111493548\nsrc_len    = 3183464512  location register edx=0xbdbfd040  -1111502784\n\nThe stack trace shows these are supposed to be:\n\nsrc_offset=6402 \nsrc_len=10240\n\nHere is the conf file:\n\n# Custom config file for memory leak test\nServerRoot \"/usr/webserver\"\nPidFile logs/httpd.pid\nTimeout 300\nKeepAlive On\nMaxKeepAliveRequests 100\nKeepAliveTimeout 15\n<IfModule worker.c>\nStartServers         1\nMaxClients          25\nMinSpareThreads     25\nMaxSpareThreads     25\nThreadsPerChild     25\nServerLimit          1\nMaxRequestsPerChild  0\n</IfModule>\n<IfModule perchild.c>\nNumServers           5\nStartThreads         5\nMinSpareThreads      5\nMaxSpareThreads     10\nMaxThreadsPerChild  20\nMaxRequestsPerChild  0\n</IfModule>\n<IfModule mpm_winnt.c>\nThreadsPerChild 250\nMaxRequestsPerChild  0\n</IfModule>\nLoadModule access_module modules/mod_access.so\nLoadModule actions_module modules/mod_actions.so\nLoadModule alias_module modules/mod_alias.so\nLoadModule cgi_module modules/mod_cgi.so\nLoadModule dir_module modules/mod_dir.so\nLoadModule env_module modules/mod_env.so\nLoadModule imap_module modules/mod_imap.so\nLoadModule log_config_module modules/mod_log_config.so\nLoadModule mime_module modules/mod_mime.so\nLoadModule proxy_module modules/mod_proxy.so\nLoadModule proxy_connect_module modules/mod_proxy_connect.so\nLoadModule proxy_http_module modules/mod_proxy_http.so\nLoadModule negotiation_module modules/mod_negotiation.so\nLoadModule rewrite_module modules/mod_rewrite.so\nLoadModule setenvif_module modules/mod_setenvif.so\nLoadModule headers_module modules/mod_headers.so\nLoadModule ssl_module modules/mod_ssl.so\nLoadModule status_module modules/mod_status.so\n<IfModule !mpm_winnt.c>\n#\n# If you wish httpd to run as a different user or group, you must run\n# httpd as root initially and it will switch.\n#\nUser leakd\nGroup leakd\n</IfModule>\nUseCanonicalName Off\n<Directory />\n    Options FollowSymLinks\n    AllowOverride None\n#IP_RESTRICTION_BLOCK\n</Directory>\nDirectoryIndex index.html index.htm index.php\n<Files ~ \"^\\.ht\">\n    Order allow,deny\n    Deny from all\n</Files>\nTypesConfig conf/mime.types\nDefaultType text/plain\n<IfModule mod_mime_magic.c>\n    MIMEMagicFile conf/magic\n</IfModule>\nHostnameLookups Off\nErrorLog /usr/webserver/logs/error_log\nLogLevel error\nLogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\" \ncombined\nLogFormat \"%h %l %u %t \\\"%r\\\" %>s %b\" common\nLogFormat \"%{Referer}i -> %U\" referer\nLogFormat \"%{User-agent}i\" agent\nCustomLog /usr/webserver/logs/access_log common\nServerTokens min\nServerSignature Off\nScriptAlias /cgi-bin/ \"/usr/webserver/cgi-bin/\"\nAddEncoding x-compress Z\nAddEncoding x-gzip gz tgz\nAddLanguage da .dk\nAddLanguage nl .nl\nAddLanguage en .en\nAddLanguage et .et\nAddLanguage fr .fr\nAddLanguage de .de\nAddLanguage he .he\nAddLanguage el .el\nAddLanguage it .it\nAddLanguage ja .ja\nAddLanguage pl .po\nAddLanguage ko .ko\nAddLanguage pt .pt\nAddLanguage nn .nn\nAddLanguage no .no\nAddLanguage pt-br .pt-br\nAddLanguage ltz .ltz\nAddLanguage ca .ca\nAddLanguage es .es\nAddLanguage sv .sv\nAddLanguage cz .cz\nAddLanguage ru .ru\nAddLanguage tw .tw\nAddLanguage zh-tw .tw\nAddLanguage hr .hr\nLanguagePriority en da nl et fr de el it ja ko no pl pt pt-br ltz ca es sv tw\nForceLanguagePriority Prefer Fallback\nAddDefaultCharset ISO-8859-1\nAddCharset ISO-8859-1  .iso8859-1  .latin1\nAddCharset ISO-8859-2  .iso8859-2  .latin2 .cen\nAddCharset ISO-8859-3  .iso8859-3  .latin3\nAddCharset ISO-8859-4  .iso8859-4  .latin4\nAddCharset ISO-8859-5  .iso8859-5  .latin5 .cyr .iso-ru\nAddCharset ISO-8859-6  .iso8859-6  .latin6 .arb\nAddCharset ISO-8859-7  .iso8859-7  .latin7 .grk\nAddCharset ISO-8859-8  .iso8859-8  .latin8 .heb\nAddCharset ISO-8859-9  .iso8859-9  .latin9 .trk\nAddCharset ISO-2022-JP .iso2022-jp .jis\nAddCharset ISO-2022-KR .iso2022-kr .kis\nAddCharset ISO-2022-CN .iso2022-cn .cis\nAddCharset Big5        .Big5       .big5\n# For russian, more than one charset is used (depends on client, mostly):\nAddCharset WINDOWS-1251 .cp-1251   .win-1251\nAddCharset CP866       .cp866\nAddCharset KOI8-r      .koi8-r .koi8-ru\nAddCharset KOI8-ru     .koi8-uk .ua\nAddCharset ISO-10646-UCS-2 .ucs2\nAddCharset ISO-10646-UCS-4 .ucs4\nAddCharset UTF-8       .utf8\nAddCharset GB2312      .gb2312 .gb\nAddCharset utf-7       .utf7\nAddCharset utf-8       .utf8\nAddCharset big5        .big5 .b5\nAddCharset EUC-TW      .euc-tw\nAddCharset EUC-JP      .euc-jp\nAddCharset EUC-KR      .euc-kr\nAddCharset shift_jis   .sjis\nAddType application/x-tar .tgz\nAddType image/x-icon .ico\nAddType application/x-httpd-php .php\nAddType text/html .tpl\nAddHandler cgi-script cgi exe jpq\nBrowserMatch \"Mozilla/2\" nokeepalive\nBrowserMatch \"MSIE 4\\.0b2;\" nokeepalive downgrade-1.0 force-response-1.0\nBrowserMatch \"RealPlayer 4\\.0\" force-response-1.0\nBrowserMatch \"Java/1\\.0\" force-response-1.0\nBrowserMatch \"JDK/1\\.0\" force-response-1.0\nBrowserMatch \"Microsoft Data Access Internet Publishing Provider\" redirect-\ncarefully\nBrowserMatch \"^WebDrive\" redirect-carefully\nBrowserMatch \"^WebDAVFS/1.[012]\" redirect-carefully\nBrowserMatch \"^gnome-vfs\" redirect-carefully\n<IfModule mod_proxy.c>\nProxyRequests Off\n<Proxy *>\n    Order deny,allow\n    Deny from all\n    Allow from all\n</Proxy>\nProxyVia On\n</IfModule>\n<IfModule mod_rewrite.c>\nRewriteEngine On\n</IfModule>\nlisten 127.0.0.1:9200\n<VirtualHost 127.0.0.1:9200>\nServerName 127.0.0.1:9200\nDocumentRoot \"/usr/webserver/isdocs\"\n<Directory \"/usr/webserver/isdocs\">\n    Options MultiViews\n    Options +FollowSymLinks\n    AllowOverride None\n</Directory>\nRewriteEngine On\nRewriteRule ^/login.htm /red9200.html\nRewriteMap map1 txt:/usr/webserver/conf/musiclist.map\nRewriteCond %{REQUEST_URI} ^/([^/]+).*\nRewriteCond ${map1:%1|NONE} ^(http.*) [NC]\nRewriteRule ^(/.*) %1$1 [P]\nRewriteCond %{REQUEST_URI} ^/Music/LookupTag/(.*)\nRewriteCond ${map1:%1|NONE} ^(http.*) [NC]\nRewriteRule ^(/.*) %1$1 [P]\nRewriteCond %{REQUEST_URI} ^/Music/MusicTag/(.*)RewriteCond ${map1:%1|NONE} ^\n(http.*) [NC]\nRewriteRule ^(/.*) %1$1 [P]\nProxyPreserveHost on\nHeader set Server: JKPHTTPServer/9.9\n<Location /statusreport>\nSetHandler server-status\n</Location>\n</VirtualHost>\nlisten 172.25.54.114:9200\n<VirtualHost 172.25.54.114:9200>\nServerName 172.25.54.114:9200\nDocumentRoot \"/usr/webserver/isdocs\"\n<Directory \"/usr/webserver/isdocs\">\n    Options MultiViews\n    Options +FollowSymLinks\n    AllowOverride None\n</Directory>\nRewriteEngine On\nRewriteRule ^/login.htm /red9200.html\nRewriteMap map1 txt:/usr/webserver/conf/musiclist.map\nRewriteCond %{REQUEST_URI} ^/([^/]+).*\nRewriteCond ${map1:%1|NONE} ^(http.*) [NC]\nRewriteRule ^(/.*) %1$1 [P]\nRewriteCond %{REQUEST_URI} ^/Music/LookupTag/(.*)\nRewriteCond ${map1:%1|NONE} ^(http.*) [NC]\nRewriteRule ^(/.*) %1$1 [P]\nRewriteCond %{REQUEST_URI} ^/Music/MusicTag/(.*)\nRewriteCond ${map1:%1|NONE} ^(http.*) [NC]\nRewriteRule ^(/.*) %1$1 [P]\nProxyPreserveHost on\nHeader set Server: HTTPServer/9.9\n<Location /statusreport>\n SetHandler server-status\n</Location>\n</VirtualHost>\nAddType application/x-x509-ca-cert .crt\nAddType application/x-pkcs7-crl    .crl\nSSLPassPhraseDialog  builtin\n#SSLSessionCache         dbm:logs/ssl_scache\n#SSLSessionCache        none\nSSLSessionCache         shmcb:logs/scache(256000)\nSSLMutex  file:logs/ssl_mutex\nSSLSessionCacheTimeout  300\nSSLRandomSeed startup builtin\nSSLRandomSeed connect builtin\nlisten 127.0.0.1:9201\n<VirtualHost 127.0.0.1:9201>\nServerName 127.0.0.1:9201\nDocumentRoot \"/usr/webserver/htdocs\"\n<Directory \"/usr/webserver/htdocs\">\n    Options +MultiViews\n    AllowOverride None\n</Directory>\n<Directory \"/usr/webserver/cgi-bin\">\n    Options +MultiViews\n    AllowOverride None\n</Directory>\n<Location /statusreport>\nSetHandler server-status\n</Location>\nRewriteEngine On\nRewriteMap map1 txt:/usr/webserver/conf/musiclist.map\nRewriteCond %{REQUEST_URI} ^/([^/]+).*\nRewriteCond ${map1:%1|NONE} ^(http.*) [NC]\nRewriteRule ^(/.*) %1$1 [P]\nRewriteCond %{REQUEST_URI} ^/Music/LookupTag/(.*)\nRewriteCond ${map1:%1|NONE} ^(http.*) [NC]\nRewriteRule ^(/.*) %1$1 [P]\nRewriteCond %{REQUEST_URI} ^/Music/MusicTag/(.*)\nRewriteCond ${map1:%1|NONE} ^(http.*) [NC]\nRewriteRule ^(/.*) %1$1 [P]\nProxyPreserveHost on\nSSLEngine on\nSSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL\nSSLCertificateFile /usr/webserver/conf/cert.pem\nSSLCertificateKeyFile /usr/webserver/conf/file.pem\n<Files ~ \"\\.(jpq|exe|cgi|shtml|phtml|php3?)$\">\n    SSLOptions +StdEnvVars\n</Files>\n<Directory \"/usr/webserver/cgi-bin\">\n    SSLOptions +StdEnvVars\n</Directory>\nAlias /myhelp \"/usr/webserver/help\"\n<Directory \"/usr/webserver/help\">\n     Options ExecCGI MultiViews\n     AllowOverride None\n     Order allow,deny\n     Allow from all\n     SSLOptions +StdEnvVars\n</Directory>\nSetEnvIf User-Agent \".*MSIE.*\" \\\n         nokeepalive ssl-unclean-shutdown \\\n         downgrade-1.0 force-response-1.0\n</VirtualHost>\nlisten 172.25.54.114:9201\n<VirtualHost 172.25.54.114:9201>\nServerName 172.25.54.114:9201\nDocumentRoot \"/usr/webserver/htdocs\"\n<Directory \"/usr/webserver/htdocs\">\n    Options +MultiViews\n    AllowOverride None\n</Directory>\n<Directory \"/usr/webserver/cgi-bin\">\n    Options +MultiViews\n    AllowOverride None\n</Directory>\n<Location /statusreport>\nSetHandler server-status\n</Location>\nRewriteEngine On\nRewriteMap map1 txt:/usr/webserver/conf/musiclist.map\nRewriteCond %{REQUEST_URI} ^/([^/]+).*\nRewriteCond ${map1:%1|NONE} ^(http.*) [NC]\nRewriteRule ^(/.*) %1$1 [P]\nRewriteCond %{REQUEST_URI} ^/Music/LookupTag/(.*)\nRewriteCond ${map1:%1|NONE} ^(http.*) [NC]\nRewriteRule ^(/.*) %1$1 [P]\nRewriteCond %{REQUEST_URI} ^/Music/MusicTag/(.*)\nRewriteCond ${map1:%1|NONE} ^(http.*) [NC]\nRewriteRule ^(/.*) %1$1 [P]\nProxyPreserveHost on\nSSLEngine on\nSSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL\nSSLCertificateFile /usr/webserver/conf/cert.pem\nSSLCertificateKeyFile /usr/webserver/conf/file.pem\n<Files ~ \"\\.(jpq|exe|cgi|shtml|phtml|php3?)$\">\n    SSLOptions +StdEnvVars\n</Files>\n<Directory \"/usr/webserver/cgi-bin\">\n    SSLOptions +StdEnvVars\n</Directory>\nAlias /myhelp \"/usr/webserver/help\"\n<Directory \"/usr/webserver/help\">\n     Options ExecCGI MultiViews\n     AllowOverride None\n     Order allow,deny\n     Allow from all\n     SSLOptions +StdEnvVars\n</Directory>\nSetEnvIf User-Agent \".*MSIE.*\" \\\n         nokeepalive ssl-unclean-shutdown \\\n         downgrade-1.0 force-response-1.0\n</VirtualHost>"}, {"count": 1, "tags": [], "bug_id": 27751, "attachment_id": null, "id": 54170, "time": "2004-03-17T17:27:40Z", "creator": "ken.avery@hp.com", "creation_time": "2004-03-17T17:27:40Z", "is_private": false, "text": "Here is inforamtion from one of our developers:\n\nWhile attempting to locate the cause for what appears to be a memory \nconsumption problem in the SSL code, the server segmentation faults. The first \nworker child & all of its child threads continue to consume memory while the \nparent stays the same or gets a little smaller.  The child threads never give \nthe memory back unless restarted.  Please advise if this is an expected \nbehavior.\n\nRunning with 'SSLSessionCache none' doesn't consume memory (and doesn't seg \nfault), but it performs poorly when using 2048 bit keys.\n\nI observed the segmentation fault issue in mod_ssl while running the small \nscript listed below.  Based on the stack information the issue appears to be \nin shmcb_cton_memcpy() during an attempt to remove a session id.  The server \nkeeps on reponding, but all the child threads die and are restarted. I am not \nsure what is happening, but the following variables seem to get corrupted:\n\nThe stack trace shows these are supposed to be:\n\nsrc_offset=6402 \nsrc_len=10240\n\nInside the frame they have these values:\n\n(gdb) print src_offset (in edi register)\n$55 = 3183473748  \n(gdb) print src_len    (in edx register) \n$56 = 3183464512\n\nThe configuration file, and my initial debug session are attached.\n\nApache error_log\n...\n[Mon Mar 15 11:21:33 2004] [notice] Apache/2.0.48 configured -- resuming \nnormal operations [Mon Mar 15 11:25:28 2004] [error] server reached MaxClients \nsetting, consider raising the MaxClients setting [Mon Mar 15 11:38:29 2004] \n[notice] child pid 1065 exit signal Segmentation fault (11) [Mon Mar 15 \n12:06:28 2004] [notice] child pid 1154 exit signal Segmentation fault (11) \n[Mon Mar 15 12:44:49 2004] [notice] child pid 1258 exit signal Segmentation \nfault (11) [Mon Mar 15 13:04:40 2004] [notice] child pid 1315 exit signal \nSegmentation fault (11) [Mon Mar 15 13:17:29 2004] [notice] child pid 1363 \nexit signal Segmentation fault (11) [Mon Mar 15 13:45:12 2004] [notice] child \npid 1401 exit signal Segmentation fault (11) ...\n\nOS RedHat 7.3 \n\ngcc-2.96-113\nglibc-2.2.5-43\nopenssl-0.9.6b-35.7\n\nApache 2.0.48 Build Script:\n\n./configure  --with-program-name=leakd --with-port=9200 --with-mpm=worker --\nenable-ssl=shared --enable-maintainer-mode \\ --enable-proxy=shared --enable-\ncgi=shared --enable-setenvif=shared --enable-cgi=shared --enable-access=shared \n\\ --enable-rewrite=shared --enable-dir=shared --enable-actions=shared --enable-\nmime=shared --enable-proxy_connect=shared \\ --enable-proxy_http=shared --\nenable-negotiation=shared --enable-alias=shared --enable-env=shared --enable-\ndir=shared \\ --enable-mod-actions=shared --enable-log-config=shared --enable-\nimap=shared --enable-headers=shared \\ --enable-layout=webserver --disable-\nautoindex --disable-userdir --disable-usertrack --disable-cgid \\ --disable-\nasis --disable-auth --disable-auth_digest --disable-auth_dbm --disable-\nauth_anon --disable-dav \\ --disable-dav_fs --disable-vhost_alias --disable-\nunique_id --disable-speling --disable-cern_meta --disable-include \\ --disable-\nexpires --enable-status=shared --enable-info=shared\n\nldd leakd:\n\n        libssl.so.2 => /lib/libssl.so.2 (0x40024000)\n        libcrypto.so.2 => /lib/libcrypto.so.2 (0x40052000)\n        libaprutil-0.so.0 => /usr/webserver/lib/libaprutil-0.so.0 (0x40119000)\n        libgdbm.so.2 => /usr/lib/libgdbm.so.2 (0x4012d000)\n        libdb-3.3.so => /lib/libdb-3.3.so (0x40133000)\n        libexpat.so.0 => /usr/lib/libexpat.so.0 (0x401c2000)\n        libapr-0.so.0 => /usr/webserver/lib/libapr-0.so.0 (0x401e1000)\n        libpthread.so.0 => /lib/libpthread.so.0 (0x40200000)\n        librt.so.1 => /lib/librt.so.1 (0x40215000)\n        libm.so.6 => /lib/libm.so.6 (0x40226000)\n        libcrypt.so.1 => /lib/libcrypt.so.1 (0x40247000)\n        libnsl.so.1 => /lib/libnsl.so.1 (0x40274000)\n        libdl.so.2 => /lib/libdl.so.2 (0x40288000)\n        libc.so.6 => /lib/libc.so.6 (0x4028c000)\n        /lib/ld-linux.so.2 => /lib/ld-linux.so.2 (0x40000000)\n\n\nSimple script on external machine downloads copies of the stock Apache \nindex.html.en page under both unsecure & secure sites:\n\n#!/bin/sh\ncounter=0\nlimit=32000\nwhile [ \"$counter\" -lt \"$limit\" ]\ndo\n  wget -O - http://myboxaddr:9200\n  wget -O - https://myboxaddr:9201\n  counter=`expr $counter + 1`\n  echo \"Count=> $counter\"\ndone\n"}, {"count": 2, "tags": [], "creator": "jeff.potter@hp.com", "text": "I added some log messages to the code, and turned on debugging.  I attempted to \nusing either SSLMutex  file:logs/ssl_mutex  or  SSLMutex  default.  It takes \nlonger with SSLMutex default to seg fault, but the stack trace is basically the \nsame.  The debug error_log traces are available for both test runs if you want \nthem. \n\nFinally the src_offest & src_len variables are not changing.  GDB just doesn't \nreset the registers when you move back in the stack frame.", "id": 54196, "time": "2004-03-17T23:47:56Z", "bug_id": 27751, "creation_time": "2004-03-17T23:47:56Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 27751, "text": "It seems to me that src_offset and src_len are getting corrupted somehow, but it's not \nobvious to me where or how this is happening. The versions you're using of redhat, \nglibc, gcc (etc) are a little dated. and though I'm reluctant to dismiss the issue as \nbeing old tools, it would certainly be something to consider - if you're able to build \nusing a different gcc or mess with the optimisation levels, that might hint as to whether \nthis is compiler sensitive or something more macabre. \n \nAlso, is it possible to insert some debugging lines in the last two frames around the \nproblem area to dump the exact values being passed around? I'm curious how and \nwhere those values are getting mangled. As/when you hit a segfault, it would be useful \nto have something to help pinpoint where the corruption was introduced. (Another \npossible hint: could those \"corrupt\" values actually be some unsigned representation \nof a negative - indicating a possible bug in the \"cyclic\" logic?) I've added myself to the \nCC line for this ticket, please let me know how you get on with this. \n ", "id": 54283, "time": "2004-03-19T18:55:55Z", "creator": "geoff@geoffthorpe.net", "creation_time": "2004-03-19T18:55:55Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 27751, "text": "Logging messages were added into the function to print out the values for \nsrc_len and src_offset, and they were actually not changing.  The seg fault is \nin memcpy() frame #0. When you move back to frame #1 to examine things, gdb 5.2-\n2 does not reload the registers.  Local variables were created inside the \nfunction, and assigned the values src_offset & src_len upon entry. The end \nresult was the same (seg fault).  It could be the tools, but everything is fine \nfor 15-20 minutes.  The function is called 305 times before a failure with the \nlast three calls shown below: \n\nCALLER == shmcb_remove_session_id()\nCALLED == shmcb_cyclic_cton_memcpy()\n\n[Wed Mar 17 17:13:20 2004] [info] CALLER: header->cache_data_size=7190  \nsrc_offset=3972 src_len=10240\n[Wed Mar 17 17:13:20 2004] [info] CALLED: buff_size=7190 src_offset=3972, \nsrc_len=10240\n[Wed Mar 17 17:13:20 2004] [info] CALLER: header->cache_data_size=7190  \nsrc_offset=7166 src_len=10240\n[Wed Mar 17 17:13:20 2004] [info] CALLED: buff_size=7190 src_offset=7166, \nsrc_len=10240\n\n\nI have two debug traces.", "id": 54396, "time": "2004-03-22T16:21:02Z", "creator": "jeff.potter@hp.com", "creation_time": "2004-03-22T16:21:02Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "creator": "geoff@geoffthorpe.net", "text": "Ouch, ok - I have this gloomy sense that I'm about to dive back into apache code ... \n \nI notice you're on apache 2.0.48 ... I could try to help track the problem in that version \nand worry about migrating it (if applicable) to cvs after, but to avoid the potential for \nlogjams with other issues already fixed, are you able to move to 2.0.49, or better still, \nCVS (head or 2.0.**-stable)? At the least, have you diffed the ssl module source \nagainst later releases or CVS to check if any fixes have already been made that might \ncover this? \n \nWhatever you do w.r.t. apache versions - please email me a copy of the first few \npages of a *trace* log during startup (this should give me all the shmcb geometry \nsettings), and then the last few pages leading up to your first crash. I noticed from the \ninfo you've already provided that you are caching sessions around ~10Kb, which \nwould indicate that you're using client-authentication and probably with some biggish \ncerts (or longish cert-chains). My hunch is that this is triggering some wrap-around \nissue, either in the cyclic logic itself or in the use of variables of insufficient size. \n \nPlease mail me the details privately, no point drowning the bugzilla database. As/when \nI have potential suggestions/fixes, how should we handle that? Can I send you diffs to \ntry? Can I shell to a box where this can be reproduced? Thanks again for the detailed \nreport. ", "id": 54495, "time": "2004-03-23T17:27:49Z", "bug_id": 27751, "creation_time": "2004-03-23T17:27:49Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "creator": "jorton@redhat.com", "text": "Geoff's fix for this is now committed to HEAD and the 2.0 branch - thanks for\nthe report, and thanks to Geoff for tracking it down.", "id": 58507, "time": "2004-06-01T21:15:59Z", "bug_id": 27751, "creation_time": "2004-06-01T21:15:59Z", "is_private": false, "attachment_id": null}]