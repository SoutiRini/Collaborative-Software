[{"count": 0, "tags": [], "text": "I have a scenario where my appBase looks something like this - \n\n/xyz/tomcat/webapps\n\nand I have a ROOT.war file and a pre-exploded war both as symlinks, something like -\n\n/xyz/tomcat/webapps/ROOT -> /abc/ROOT/\n/xyz/tomcat/webapps/ROOT.war -> /abc/ROOT.war\n\nThis means that in ContextConfig.fixDocBase():578, I see docBase = ROOT.war\n\nThis then expands to docBase = /xyz/tomcat/webapps/ROOT.war at line:591. \n\nStepping forward, at line:609, docBaseInAppBase gets set to true as my docBase indeed starts with the appBase string.\n\nConsidering that the docBase value as of now ends in .war and it is not a directory and I have unpackWARS set to true, at line 614, docBase is set to '/xyz/tomcat/webapps/ROOT' (as that's what ExpandWars.expand returns).\n\nAnd then at line 616, docBase is set to the canonicalPath of /xyz/tomcat/webapps/ROOT which in my case is /abc/ROOT/\n\nNote that my docBaseInAppBase is still set to true, which is now incorrect.\n\nThis means that at line:656, either docBase.substring() throws an exception if my docBase was shorter than appBase, or, if not, context.setDocBase gets set to an invalid truncated value of the canonical path at line:665 which causes problems down the line.\n\nSpecifically for longer canonical paths of the exploded war I get -  \n\nCaused by: java.lang.IllegalArgumentException: The main resource set specified [<invalid-truncated-path>] is not valid\n    239   at org.apache.catalina.webresources.StandardRoot.createMainResourceSet(StandardRoot.java:729) ~[catalina.jar:8.5.4]\n    240   at org.apache.catalina.webresources.StandardRoot.startInternal(StandardRoot.java:686) ~[catalina.jar:8.5.4]\n    241   at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:152) ~[catalina.jar:8.5.4]\n    242   at org.apache.catalina.core.StandardContext.resourcesStart(StandardContext.java:4831) ~[catalina.jar:8.5.4]\n    243   at org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:4963) ~[catalina.jar:8.5.4]\n    244   at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:152) ~[catalina.jar:8.5.4]\n\nIn my tests, refreshing the docBaseInAppBase value by calling again -\ndocBaseInAppBase = docBase.startsWith(appBase.getPath() + File.separatorChar); \n\njust before line:655 (which checks the docBaseInAppBase value) solves the problem, but I'm not sure if I'm missing any other edge conditions.\n\nI'll really appreciate a formal fix for the issue. Thanks!", "is_private": false, "id": 193208, "creation_time": "2016-08-19T02:16:24Z", "time": "2016-08-19T02:16:24Z", "creator": "mohitchugh@yahoo.com", "bug_id": 60022, "attachment_id": null}, {"count": 1, "text": "To summarize, ContextConfig.fixDocBase() is not correctly revalidating the fact that it thought docBase was inside appBase after it sets docBase to its canonical path.", "bug_id": 60022, "attachment_id": null, "id": 193209, "time": "2016-08-19T02:25:30Z", "creator": "mohitchugh@yahoo.com", "creation_time": "2016-08-19T02:25:30Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "creator": "markt@apache.org", "is_private": false, "text": "This has been fixed in the following branches:\n- 9.0.x for 9.0.0.M10 onwards\n- 8.5.x for 8.5.5 onwards\n- 8.0.x for 8.0.37 onwards\n\n7.0.x and earlier are not affected.", "id": 193288, "time": "2016-08-23T19:43:22Z", "bug_id": 60022, "creation_time": "2016-08-23T19:43:22Z", "attachment_id": null}]