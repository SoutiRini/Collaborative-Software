[{"count": 0, "tags": [], "bug_id": 43240, "attachment_id": null, "id": 107402, "creation_time": "2007-08-29T09:05:11Z", "time": "2007-08-29T09:05:11Z", "creator": "andreas@apache.org", "text": "It is very likely that we have a memory leak in the trunk.\n\nLoad test:\n- Tomcat: Xms64m, Xmx512m\n- 10 threads\n- each creating 50 documents\n\nThe heap usage is continuously increasing. After approx. 800 requests, 400 MB of\nheap are allocated. The garbage collector can't push it below 300 MB anymore. A\nfirst glance at the heap snapshot indicates a very large number of\nTraxTransformer instances.", "is_private": false}, {"count": 1, "tags": [], "creator": "andreas@apache.org", "attachment_id": null, "text": "When Tomcat doesn't receive any requests for some time (I guess because JMeter\nis swapped to the disk due to RAM shortage), the heap usage decreases to 254 MB.", "id": 107404, "time": "2007-08-29T09:43:39Z", "bug_id": 43240, "creation_time": "2007-08-29T09:43:39Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 43240, "attachment_id": null, "text": "After the 1020 requests are completed, the heap usage stays at approx. 300 MB.", "id": 107405, "time": "2007-08-29T09:44:36Z", "creator": "andreas@apache.org", "creation_time": "2007-08-29T09:44:36Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 43240, "text": "After a forced garbage collection it's at 200 MB.", "id": 107406, "time": "2007-08-29T09:47:27Z", "creator": "andreas@apache.org", "creation_time": "2007-08-29T09:47:27Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 43240, "text": "Phew ... the snapshot (after completion) indicates *lots* of Lenya objects.\nThere's definitely something wrong.\n\nSessiomImpl:     402 objects (72 MB retained size)\nSiteTreeImpl:    325 objects (75 MB retained size)\nSiteTreeLink: 84'993 objects\nDocumentImpl: 76'578 objects\n", "id": 107407, "time": "2007-08-29T10:03:59Z", "creator": "andreas@apache.org", "creation_time": "2007-08-29T10:03:59Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "creator": "andreas@apache.org", "text": "There are 152 continuation objects, retained size 32 MB.", "id": 107408, "time": "2007-08-29T10:08:59Z", "bug_id": 43240, "creation_time": "2007-08-29T10:08:59Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "text": "The session is attached to SourceWrapper.lockedUris:\n\norg.apache.lenya.cms.repository.SessionImpl\nsession of  org.apache.lenya.cms.repository.SourceNode\nnode of  org.apache.lenya.cms.repository.ContentSourceWrapper\nvalue of  java.util.WeakHashMap$Entry\n[37] of  java.util.WeakHashMap$Entry[1025]\ntable of  java.util.WeakHashMap\nlockedUris of  org.apache.lenya.cms.repository.SourceWrapper\n[2584] of  java.lang.Object[5121]\nelementData of  java.util.Vector\nclasses of  org.apache.catalina.loader.WebappClassLoader\ncontextClassLoader of  java.lang.Thread [Stack Local, Thread]", "attachment_id": null, "id": 107409, "creator": "andreas@apache.org", "time": "2007-08-29T10:12:19Z", "bug_id": 43240, "creation_time": "2007-08-29T10:12:19Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 43240, "text": "(In reply to comment #6)\n> The session is attached to SourceWrapper.lockedUris:\n\nThis is fixed in revision 570920, but I guess there's more.", "count": 7, "id": 107427, "time": "2007-08-29T13:24:42Z", "creator": "andreas@apache.org", "creation_time": "2007-08-29T13:24:42Z", "is_private": false}, {"count": 8, "tags": [], "creator": "andreas@apache.org", "text": "Now the heap usage after the forced garbage collection (after running the test)\nis at 138 MB.", "id": 107428, "time": "2007-08-29T13:25:53Z", "bug_id": 43240, "creation_time": "2007-08-29T13:25:53Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "text": "BTW, I increased the xslt transformer pool size to 64 which makes the test run a\nlot faster, but will certainly influence the memory usage. I'll keep this\nsetting for further test.", "attachment_id": null, "bug_id": 43240, "id": 107429, "time": "2007-08-29T13:28:20Z", "creator": "andreas@apache.org", "creation_time": "2007-08-29T13:28:20Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 43240, "attachment_id": null, "text": "Now the largest object is the ContinuationsManagerImpl with a retained size of\n34 MB, followed by the DefaultTransientStore with 17 MB.", "id": 107430, "time": "2007-08-29T13:37:51Z", "creator": "andreas@apache.org", "creation_time": "2007-08-29T13:37:51Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 43240, "attachment_id": null, "id": 107431, "time": "2007-08-29T13:51:50Z", "creator": "andreas@apache.org", "creation_time": "2007-08-29T13:51:50Z", "is_private": false, "text": "There are still more than 800 SessionImpl objects, connected via publication\nobjects as listeners of the ObservationManager."}, {"count": 12, "tags": [], "creator": "andreas@apache.org", "attachment_id": null, "id": 107432, "creation_time": "2007-08-29T13:54:26Z", "time": "2007-08-29T13:54:26Z", "bug_id": 43240, "text": "org.apache.lenya.cms.repository.SessionImpl\nsession of  org.apache.lenya.cms.publication.DocumentFactoryImpl\nfactory of  org.apache.lenya.cms.publication.PublicationImpl\npublication of  org.apache.lenya.cms.publication.DocumentIdentifier\nkey of  java.util.HashMap$Entry\n[254] of  java.util.HashMap$Entry[257]\ntable of  java.util.HashMap\nidentifier2listeners of org.apache.lenya.cms.observation.ObservationManager", "is_private": false}, {"count": 13, "tags": [], "creator": "andreas@apache.org", "attachment_id": null, "id": 107433, "time": "2007-08-29T14:03:40Z", "bug_id": 43240, "creation_time": "2007-08-29T14:03:40Z", "is_private": false, "text": "(In reply to comment #12)\n> org.apache.lenya.cms.repository.SessionImpl\n> session of  org.apache.lenya.cms.publication.DocumentFactoryImpl\n> factory of  org.apache.lenya.cms.publication.PublicationImpl\n> publication of  org.apache.lenya.cms.publication.DocumentIdentifier\n\nDocumentIdentifier shouldn't keep a reference to the publication, but only to\nthe publication ID.\n\n> key of  java.util.HashMap$Entry\n> [254] of  java.util.HashMap$Entry[257]\n> table of  java.util.HashMap\n> identifier2listeners of org.apache.lenya.cms.observation.ObservationManager\n\n"}, {"count": 14, "tags": [], "bug_id": 43240, "attachment_id": null, "id": 107438, "time": "2007-08-29T15:51:07Z", "creator": "andreas@apache.org", "creation_time": "2007-08-29T15:51:07Z", "is_private": false, "text": "(In reply to comment #13)\n> (In reply to comment #12)\n> > org.apache.lenya.cms.repository.SessionImpl\n> > session of  org.apache.lenya.cms.publication.DocumentFactoryImpl\n> > factory of  org.apache.lenya.cms.publication.PublicationImpl\n> > publication of  org.apache.lenya.cms.publication.DocumentIdentifier\n> \n> DocumentIdentifier shouldn't keep a reference to the publication, but only to\n> the publication ID.\n\nThis is changed in revision 570957."}, {"count": 15, "tags": [], "bug_id": 43240, "attachment_id": null, "id": 107439, "time": "2007-08-29T15:53:26Z", "creator": "andreas@apache.org", "creation_time": "2007-08-29T15:53:26Z", "is_private": false, "text": "Now the heap usage after the final GC is 245 MB. Maybe this is because I didn't\nclean the content before re-running the test."}, {"count": 16, "tags": [], "bug_id": 43240, "text": "Now there are 444 SessionImpl objects, attached via the continuation:\n\norg.apache.lenya.cms.repository.SessionImpl\nvalue of  java.util.HashMap$Entry\n[57] of  java.util.HashMap$Entry[65]\ntable of  java.util.HashMap\nparameters of  org.apache.lenya.cms.usecase.impl.UsecaseProxy\njavaObject of  org.mozilla.javascript.NativeJavaObject\n[1] of  java.lang.Object[9]\nstack of  org.mozilla.javascript.Interpreter$CallFrame\nimplementation of  org.mozilla.javascript.continuations.Continuation\ncontinuation of  org.apache.cocoon.components.flow.WebContinuation", "id": 107440, "time": "2007-08-29T16:10:47Z", "creator": "andreas@apache.org", "creation_time": "2007-08-29T16:10:47Z", "is_private": false, "attachment_id": null}, {"count": 17, "tags": [], "creator": "andreas@apache.org", "attachment_id": null, "text": "After another half hour, a GC pushes the heap usage down to 184 MB. I guess some\nof the continuations have been removed.", "id": 107441, "time": "2007-08-29T16:17:22Z", "bug_id": 43240, "creation_time": "2007-08-29T16:17:22Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 43240, "text": "But why did 444 sessions create 82.456 DocumentImpl objects? I can't imagine\nthat all of them have been requested by the Create usecase. Does the sitetree\nacquire DocumentImpl objects unnecessarily?", "count": 18, "id": 107442, "time": "2007-08-29T16:21:58Z", "creator": "andreas@apache.org", "creation_time": "2007-08-29T16:21:58Z", "is_private": false}, {"count": 19, "tags": [], "bug_id": 43240, "text": "It looks like the remaining objects are hold by continuations. That's a\ndifferent issue.", "id": 107460, "time": "2007-08-30T01:42:20Z", "creator": "andreas@apache.org", "creation_time": "2007-08-30T01:42:20Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 43240, "text": "I just ran the test with 20 threads, each creating 50 documents. It finished\nwithout an OOME.", "count": 20, "id": 107463, "time": "2007-08-30T04:19:45Z", "creator": "andreas@apache.org", "creation_time": "2007-08-30T04:19:45Z", "is_private": false}, {"count": 21, "tags": [], "bug_id": 43240, "text": "I'm running at least r580365 from 2007-09-28, so after this bug was closed.\nLenya has been up for 13 days with max heap of 3096M. I am now getting:\n\njava.lang.OutOfMemoryError: Requested array size exceeds VM limit\n\nI know my ehcach.xml file is not set to eternal true. I'm not sure if I'm\nmissing other caches or if we have a leak. After a restart and initializing all\nof my publications, my memory usage is about 515M.\n\n\nIt is something that needs to be tested again before release. ", "id": 111232, "time": "2007-11-28T20:51:28Z", "creator": "rfrovarp@apache.org", "creation_time": "2007-11-28T20:51:28Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "rfrovarp@apache.org", "text": "Here's what jmap -histo gives me after a day of running Lenya under some amount\nof use. 130MB in int[] seems kind of big. Not sure how to force a gc. Need to\ntrack down better methods of looking at usage on a production system.\nSuggestions welcome.\n\nObject Histogram:\n\nSize    Count   Class description\n-------------------------------------------------------\n130975912       31216   int[]\n61591232        552353  char[]\n46645952        16659   byte[]\n19199392        81286   * ConstMethodKlass\n13899816        579159  java.lang.String\n11170056        118103  java.lang.Object[]\n9067280 93071   java.util.HashMap$Entry[]\n7277952 303248  java.util.HashMap$Entry\n6134720 188     org.apache.xpath.objects.XObject[]\n5857880 81286   * MethodKlass\n5047000 125054  * SymbolKlass\n4679792 8576    * ConstantPoolKlass\n3652968 8576    * InstanceKlassKlass\n3646400 91160   java.util.HashMap\n2850960 7585    * ConstantPoolCacheKlass\n2384904 99371   java.util.ArrayList\n1868704 6773    * MethodDataKlass\n1498040 12528   java.lang.String[]\n1032600 25815   org.apache.lenya.cms.site.tree2.TreeNodeImpl\n1029760 32180   java.util.TreeMap$Entry\n941088  29409   java.util.LinkedHashMap$Entry\n940800  16800   org.apache.lenya.cms.publication.DocumentImpl\n843784  11705   short[]\n809072  9194    java.lang.Class\n778824  32451   java.util.Date\n752136  31339   java.util.Hashtable$Entry\n680496  3565    int[][]\n630480  7881    java.lang.reflect.Method\n613536  25564   org.apache.lenya.cms.site.tree2.SiteTreeLink\n580352  36272   org.apache.cocoon.xml.SaxBuffer$Characters\n568272  13175   java.lang.Object[]\n502256  31391   org.apache.cocoon.xml.ParamSaxBuffer\n460656  28791   java.util.HashMap$KeySet\n454720  11368   org.apache.lenya.cms.rc.CheckInEntry\n", "count": 22, "id": 111314, "time": "2007-11-30T15:00:06Z", "bug_id": 43240, "creation_time": "2007-11-30T15:00:06Z", "is_private": false}, {"count": 23, "tags": [], "bug_id": 43240, "text": "I've been watching usage via jconsole. Perm gen sites at 52 MB or 65 MB\nallocated. We may want to increase the permgen value to something a little\nbigger. I need to do further testing, but exceptions seem to eat up massive\namounts of memory. I've been running for a week and \"PS Old Gen\" is pretty\nstable at between 200 and 250 MB.", "id": 111606, "time": "2007-12-10T07:40:51Z", "creator": "rfrovarp@apache.org", "creation_time": "2007-12-10T07:40:51Z", "is_private": false, "attachment_id": null}, {"count": 24, "tags": [], "bug_id": 43240, "attachment_id": null, "text": "I did some memory profiling with the MultiWorkflow usecase and noticed two problems:\n\n1. Continuations aren't invalidated and eat up memory.\n2. The MultiWorkflow usecase creates a continuation but doesn't need one.\n\nI have added some code to invalidate the continuation to usecases.js and added the createContinuation=\"false\" attribute to the MultiWorkflow view declaration. We should be very careful to add this attribute to all view declarations which don't need a continuation.", "id": 114032, "time": "2008-02-26T16:02:30Z", "creator": "andreas@apache.org", "creation_time": "2008-02-26T16:02:30Z", "is_private": false}, {"count": 25, "tags": [], "creator": "rfrovarp@apache.org", "text": "Fixed. Problems have gone away.", "id": 138325, "time": "2010-07-10T05:33:24Z", "bug_id": 43240, "creation_time": "2010-07-10T05:33:24Z", "is_private": false, "attachment_id": null}]