[{"count": 0, "tags": [], "creator": "lovetide@qq.com", "text": "Created attachment 32888\nApache Tomcat_7.0.61 - Error report.html\n\nI forgot to delete the last return \"\" statement, and JSP compile point error to line number #8 which is same as the last return statement.\n\nCode:\n----------------------------------------------------------------------------------------------------\n<%@ page pageEncoding='UTF-8' contentType='text/html'%>\n<%@ page import = 'java.util.*' %>\n<%!\nString test ()\n{\n\tList<Object> listObjectClasses = null;\n\tif (listObjectClasses==null || listObjectClasses.size()==0)\n\t\treturn \"\";\n\n\tString sImageIconFile = null;\n\tfor (Object objectClass : listObjectClasses)\n\t{\n\t\t//sImageIconFile = \"active-directory-objectClass-\" + (String)objectClass + \".png\";\n\t}\n\tboolean isImageIconFileExist = false;\n\tif (! (sImageIconFile==null || sImageIconFile.isEmpty()))\n\t{\n\t\tsImageIconFile = \"images/\" + sImageIconFile;\n\t\t//File fileImageIcon = new File (application.getRealPath (sImageIconFile));\n\t\t//isImageIconFileExist = fileImageIcon.exists ();\n\t}\n\treturn (sImageIconFile==null || sImageIconFile.isEmpty()) ? \"\" : \"<img src='\" + sImageIconFile + \"'/>\";\n\treturn \"\";\n\t\t// This statement above will cause tomcat JDT compiler point error to line #8\u3002 But if move this line into the above line, then compiler will point error to the right line number #23\n}\n%>\n----------------------------------------------------------------------------------------------------\n\nJSP compile exception\n----------------------------------------------------------------------------------------------------\norg.apache.jasper.JasperException: Unable to compile class for JSP: \n\nAn error occurred at line: 8 in the jsp file: /test.jsp\nUnreachable code\n5: {\n6: \tList<Object> listObjectClasses = null;\n7: \tif (listObjectClasses==null || listObjectClasses.size()==0)\n8: \t\treturn \"1\";\n9: \n10: \tString sImageIconFile = null;\n11: \tfor (Object objectClass : listObjectClasses)\n\n\nStacktrace:\n\torg.apache.jasper.compiler.DefaultErrorHandler.javacError(DefaultErrorHandler.java:103)\n\torg.apache.jasper.compiler.ErrorDispatcher.javacError(ErrorDispatcher.java:366)\n\torg.apache.jasper.compiler.JDTCompiler.generateClass(JDTCompiler.java:485)\n\torg.apache.jasper.compiler.Compiler.compile(Compiler.java:379)\n\torg.apache.jasper.compiler.Compiler.compile(Compiler.java:354)\n\torg.apache.jasper.compiler.Compiler.compile(Compiler.java:341)\n\torg.apache.jasper.JspCompilationContext.compile(JspCompilationContext.java:657)\n\torg.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:357)\n\torg.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:395)\n\torg.apache.jasper.servlet.JspServlet.service(JspServlet.java:339)\n\tjavax.servlet.http.HttpServlet.service(HttpServlet.java:731)\n\torg.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)\n\torg.apache.catalina.filters.SetCharacterEncodingFilter.doFilter(SetCharacterEncodingFilter.java:108)\n----------------------------------------------------------------------------------------------------\n\nIf I put the test() function into a .java file and use javac to compile it, javac will point error to right line number.\n----------------------------------------------------------------------------------------------------\n$ javac Test.java \nPicked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=lcd\nTest.java:24: \u9519\u8bef: \u65e0\u6cd5\u8bbf\u95ee\u7684\u8bed\u53e5\n\t\treturn \"\";\n\t\t^\n1 \u4e2a\u9519\u8bef\n----------------------------------------------------------------------------------------------------", "id": 183929, "time": "2015-07-07T10:30:54Z", "bug_id": 58110, "creation_time": "2015-07-07T10:30:54Z", "is_private": false, "attachment_id": 32888}, {"attachment_id": null, "tags": [], "bug_id": 58110, "is_private": false, "count": 1, "id": 183932, "time": "2015-07-07T11:26:30Z", "creator": "markt@apache.org", "creation_time": "2015-07-07T11:26:30Z", "text": "I've confirmed this error doesn't occur if you do something similar directly in Eclipse and I've been able to repeat this with trunk (9.0.x). I just need to check if JDT is returning the wrong line number or if Tomcat is making some invalid assumptions."}, {"attachment_id": null, "tags": [], "bug_id": 58110, "is_private": false, "count": 2, "id": 183933, "time": "2015-07-07T11:48:38Z", "creator": "markt@apache.org", "creation_time": "2015-07-07T11:48:38Z", "text": "I can confirm that this is a Tomcat bug in o.a.jasper.compiler.JavacErrorDetail\n\nI'll investigate a fix..."}, {"count": 3, "tags": [], "creator": "markt@apache.org", "text": "Fixed in trunk (for 9.0.x), 8.0.x (for 8.0.25) and 7.0.x (for 7.0.64).\n\nThanks for the report.", "id": 183936, "time": "2015-07-07T13:22:39Z", "bug_id": 58110, "creation_time": "2015-07-07T13:22:39Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 58110, "is_private": false, "count": 4, "id": 183940, "time": "2015-07-07T17:02:16Z", "creator": "lovetide@qq.com", "creation_time": "2015-07-07T17:02:16Z", "text": "Just downloaded https://svn.apache.org/repos/asf/tomcat/tc7.0.x/trunk/java/org/apache/jasper/compiler/ErrorDispatcher.java, compiled, put it into jasper.jar, restart tomcat 7.0.63, it works! \n\nThanks for fixing!"}, {"count": 5, "tags": [], "creator": "markt@apache.org", "text": "Great. Thanks for confirming the fix.\n\nFor future reference there is an easier way to apply this sort of patch than unpacking and repacking the JAR.\n\nJust put the class into the right structure under $CATALINA_BASE/lib. In this case that would be $CATALINA_BASE/lib/org/apache/jasper/compiler/ErrorDispatcher.class\n\nJust like WEB-INF/classes takes priority over WEB-INF/lib, classes in $CATALINA_BASE/lib take priority over JAR files.", "id": 183941, "time": "2015-07-07T17:47:39Z", "bug_id": 58110, "creation_time": "2015-07-07T17:47:39Z", "is_private": false, "attachment_id": null}]