[{"count": 0, "tags": [], "bug_id": 53337, "attachment_id": null, "id": 159569, "time": "2012-05-31T17:06:36Z", "creator": "rstoyanchev@yahoo.com", "creation_time": "2012-05-31T17:06:36Z", "is_private": false, "text": "The scenario involves:\n\n1. ServletA forwards to Servlet B\n2. ServletB calls request.startAsync and starts thread\n3. New thread attempts to render a JSP\n\nI've tried JSP rendering via asyncContext.dispatch(\"\") and via request.getRequestDispatcher(\"\") plus forward or include.\n\nWhen using a RequestDispatcher, calling ServletA fails while calling ServletB directly succeeds. \n\nWhen using AsyncContext.dispatch, both ServletA and ServletB fail.\n\nThe exception is always the same (while attempting to render the JSP):\n\njava.lang.IllegalStateException: Cannot create a session after the response has been committed\n\nI've created a project at:\nhttps://github.com/rstoyanchev/dispatch-test\n\nThe project page contains instructions and attached is a .war although you might want to check the source out in order to try a couple of variations.\n\nBeyond the specifics of the bug, the more general question is whether it is ok to use request.getRequestDispatcher from an async thread? That seems to be the case in Tomcat, aside from this bug, but in other containers (Jetty in particular) it's clearly not recommended. \n\nServlet Spec discussion on this question: \nhttp://java.net/projects/servlet-spec/lists/users/archive/2012-05/message/10."}, {"count": 1, "tags": [], "text": "Created attachment 28866\n.war demonstrating the issue", "is_private": false, "id": 159570, "creator": "rstoyanchev@yahoo.com", "time": "2012-05-31T17:07:59Z", "bug_id": 53337, "creation_time": "2012-05-31T17:07:59Z", "attachment_id": 28866}, {"attachment_id": null, "tags": [], "bug_id": 53337, "is_private": false, "count": 2, "id": 159579, "time": "2012-06-01T00:19:32Z", "creator": "rstoyanchev@yahoo.com", "creation_time": "2012-06-01T00:19:32Z", "text": "By the way, in the description above I only meant to refer to the methods asyncContext.dispatch and request.getRequestDispatcher. I am not actually passing \"\". See the link to the source code for full details."}, {"count": 3, "tags": [], "bug_id": 53337, "attachment_id": 28873, "id": 159604, "time": "2012-06-01T14:44:05Z", "creator": "rstoyanchev@yahoo.com", "creation_time": "2012-06-01T14:44:05Z", "is_private": false, "text": "Created attachment 28873\nUpdated .war file"}, {"count": 4, "tags": [], "bug_id": 53337, "attachment_id": 28874, "is_private": false, "id": 159605, "time": "2012-06-01T14:44:40Z", "creator": "rstoyanchev@yahoo.com", "creation_time": "2012-06-01T14:44:40Z", "text": "Created attachment 28874\nUpdated .war file"}, {"count": 5, "tags": [], "bug_id": 53337, "attachment_id": null, "id": 159606, "time": "2012-06-01T14:46:41Z", "creator": "rstoyanchev@yahoo.com", "creation_time": "2012-06-01T14:46:41Z", "is_private": false, "text": "I corrected one issue with the sample. Calling ServletB succeeds in all cases. Calling ServletA doesn't. I updated the instructions at the project page and updated the .war attachment."}, {"count": 6, "tags": [], "text": "The bug (forwarding to an async servlet always failed) has been fixed in trunk and 7.0.x and will be included in 7.0.28 onwards.\n\nRe-reading the spec, it appears that the intention was that dispatches from an async thread should always be via the AsyncContext. No mention is made of dispatching via a RequestDispatcher. This is going to be one of those grey areas that different containers do different ways. I believe - but haven't tested to check all the edge cases - that in Tomcat the two would be equivalent based on which objects Tomcat uses internally. Other containers may well be different.\n\nMy personal recommendation would be to stick with dispatching via the AsyncContext.", "attachment_id": null, "bug_id": 53337, "id": 159648, "time": "2012-06-03T15:58:09Z", "creator": "markt@apache.org", "creation_time": "2012-06-03T15:58:09Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 53337, "attachment_id": null, "is_private": false, "id": 159682, "time": "2012-06-04T19:58:49Z", "creator": "rstoyanchev@yahoo.com", "creation_time": "2012-06-04T19:58:49Z", "text": "Thanks for the suggestions, Mark.\n\nIn the discussion on the servlet-spec user list, even wider implications were mentioned including avoiding reliance on the requestURI or even the session from an async thread. It's quite a surprise that none of it is mentioned in the spec."}]