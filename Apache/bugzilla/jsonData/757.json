[{"count": 0, "tags": [], "bug_id": 757, "text": "environment:\nsolaris 2.6\napache 1.3.14\ntomcat 3.2\n\nthe socket code in jk won't accept 0 as a valid socket descriptor, even though\nit is perfectly valid.  this leads to intermittent bogus \"internal server\nerrors\".\n\nthe fix is fairly simple.  there are a bunch of places where checks on a socket\ndescriptor are done like this:\n\nif (sd > 0) {\n    // ok\n} else {\n    // not ok.\n}\n\nthis check should look like this:\n\nif (sd >= 0) {\n    // ok\n} else {\n    // not ok.\n}\n\nbelow are some diffs that should help fix this bug:\n-------------------------------------------------------------------------\n===================================================================\nRCS file:\n/export/home/cvsroot/foreign/jakarta/jakarta-tomcat/src/native/jk/jk_sockbuf.c,v\nretrieving revision 1.2\ndiff -c -w -r1.2 jk_sockbuf.c\n*** jk_sockbuf.c\t2001/01/18 00:50:40\t1.2\n--- jk_sockbuf.c\t2001/02/28 20:49:37\n***************\n*** 67,73 ****\n  int jk_sb_open(jk_sockbuf_t *sb,\n                 int sd)\n  {\n!     if(sb && sd > 0) {\n          sb->end   = 0;\n          sb->start = 0;\n          sb->sd    = sd;\n--- 67,73 ----\n  int jk_sb_open(jk_sockbuf_t *sb,\n                 int sd)\n  {\n!     if(sb && sd >= 0) {\n          sb->end   = 0;\n          sb->start = 0;\n          sb->sd    = sd;\n===================================================================\nRCS file:\n/export/home/cvsroot/foreign/jakarta/jakarta-tomcat/src/native/jk/jk_ajp12_worker.c,v\nretrieving revision 1.2.2.1\ndiff -c -w -r1.2.2.1 jk_ajp12_worker.c\n*** jk_ajp12_worker.c\t2001/01/26 17:13:17\t1.2.2.1\n--- jk_ajp12_worker.c\t2001/02/28 20:51:09\n***************\n*** 151,157 ****\n               * have is probably unrecoverable\n               */\n              *is_recoverable_error = JK_FALSE;\n!             jk_sb_open(&p->sb, p->sd);\n  \t\t\tif(s->ajpsecretkey) {\n  \t\t\t\tif(!ajpv12_handle_auth(p ,s , l)) {\t\t\t\t\t\n  \t\t\t\t\tjk_log(l , JK_LOG_ERROR, \"In jk_endpoint_t::service, Authentication\nerror\\n\");\n--- 151,161 ----\n               * have is probably unrecoverable\n               */\n              *is_recoverable_error = JK_FALSE;\n!             if (jk_sb_open(&p->sb, p->sd) != JK_TRUE) {\n! \t\tjk_log(l, JK_LOG_ERROR, \"In jk_endpoint_t::service, Error opening socket\nbuffer, sd = %d\\n\", p->sd);\n! \t\treturn JK_FALSE;\n! \t    }\n! \n  \t    if(s->ajpsecretkey) {\n  \t\tif(!ajpv12_handle_auth(p ,s , l)) {\t\t\t\t\t\n  \t\t    jk_log(l , JK_LOG_ERROR, \"In jk_endpoint_t::service, Authentication\nerror\\n\");\n***************\n*** 184,190 ****\n      jk_log(l, JK_LOG_DEBUG, \"Into jk_endpoint_t::done\\n\");\n      if(e && *e && (*e)->endpoint_private) {\n          ajp12_endpoint_t *p = (*e)->endpoint_private;\n!         if(p->sd > 0) {\n              jk_close_socket(p->sd);\n          }\n          free(p);\n--- 188,194 ----\n      jk_log(l, JK_LOG_DEBUG, \"Into jk_endpoint_t::done\\n\");\n      if(e && *e && (*e)->endpoint_private) {\n          ajp12_endpoint_t *p = (*e)->endpoint_private;\n!         if(p->sd >= 0) {\n              jk_close_socket(p->sd);\n          }\n          free(p);\nRCS file:\n/export/home/cvsroot/foreign/jakarta/jakarta-tomcat/src/native/jk/jk_connect.c,v\nretrieving revision 1.1.1.1\ndiff -c -r1.1.1.1 jk_connect.c\n*** jk_connect.c\t2000/11/06 14:41:06\t1.1.1.1\n--- jk_connect.c\t2001/02/28 20:52:49\n***************\n*** 57,63 ****\n   * Description: Socket/Naming manipulation functions                       *\n   * Author:      Gal Shachor <shachor@il.ibm.com>                           *\n   * Based on:    Various Jserv files                                        *\n!  * Version:     $Revision: 1.1.1.1\n$                                               *\n   ***************************************************************************/\n  \n  \n--- 57,63 ----\n   * Description: Socket/Naming manipulation functions                       *\n   * Author:      Gal Shachor <shachor@il.ibm.com>                           *\n   * Based on:    Various Jserv files                                        *\n!  * Version:     $Revision: 1.1.1.1.2.1\n$                                               *\n   ***************************************************************************/\n  \n  \n***************\n*** 108,114 ****\n      jk_log(l, JK_LOG_DEBUG, \"Into jk_open_socket\\n\");\n  \n      sock = socket(AF_INET, SOCK_STREAM, 0);\n!     if(sock > 0) {\n          int ret;\n          /* Tries to connect to JServ (continues trying while error is EINTR)\n*/\n          do {\n--- 108,114 ----\n      jk_log(l, JK_LOG_DEBUG, \"Into jk_open_socket\\n\");\n  \n      sock = socket(AF_INET, SOCK_STREAM, 0);\n!     if(sock >= 0) {\n          int ret;\n          /* Tries to connect to JServ (continues trying while error is EINTR)\n*/\n          do {", "id": 911, "time": "2001-02-28T12:55:59Z", "creator": "seguin@motive.com", "creation_time": "2001-02-28T12:55:59Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 757, "attachment_id": null, "text": "this is a problem in jk_ajp13_worker.c too.  here is a diff:\n\nIndex: jk_ajp13_worker.c\n===================================================================\nRCS file: /export/home/cvsroot/foreign/jakarta/jakarta-\ntomcat/src/native/jk/jk_ajp13_worker.c,v\nretrieving revision 1.2\nretrieving revision 1.1\ndiff -r1.2 -r1.1\n60c60\n<  * Version:     $Revision: 1.2 $                                           *\n---\n>  * Version:     $Revision: 1.1 $                                           *\n123c123\n<     if(ep->sd >= 0) {\n---\n>     if(ep->sd > 0) {\n558c558\n<         while((p->sd >= 0) && !connection_tcp_send_message(p, msg, l)) {\n---\n>         while((p->sd > 0) && !connection_tcp_send_message(p, msg, l)) {\n", "id": 975, "time": "2001-03-05T06:36:00Z", "creator": "seguin@motive.com", "creation_time": "2001-03-05T06:36:00Z", "is_private": false}, {"count": 2, "tags": [], "creator": "marc.saegesser@apropos.com", "attachment_id": null, "text": "Not in 3.2.2, but maybe 3.3 can pick this up.", "id": 1385, "time": "2001-03-19T14:17:14Z", "bug_id": 757, "creation_time": "2001-03-19T14:17:14Z", "is_private": false}]