[{"count": 0, "tags": [], "text": "Created attachment 34892\nadded new hcconnectiontimeout parameter\n\nUsing latest patched mod_proxy_hcheck (with patch from bug 60071) I encountered a problematic situation. \nIf a node goes down due to a complete failure and is not reachable via tcp/ip anymore, the long solaris tcp/ip timeout causes mod_proxy_hcheck to DISABLE the node very late. \nmod_proxy_hcheck does not provide a connection-timeout parameter to shorten this.\nOn top, the threadpool defined via ProxyHCTPsize quickly fills up and uses all available threads waiting for the timeout. The workaround is to increase ProxyHCTPsize to e.g. 500. But the problem remains, that once the node goes down it is not DISABLED until the first timeout has been reached. Solaris has a timeout of about 120s, therefore the problematic node will still get requests during this time. These requests will run into the \"connectiontimeout\", but this is still not a good situation as it slows down many requests.\n\nI have patched (well, more copy/paste) the mod_proxy_hcheck.c and added a new parameter called \"hcconnectiontimeout\". With this new parameter my tests look good now.\nExample configuration would look like this:\n\n   SSLProxyEngine On\n   SSLProxyVerify none\n   SSLProxyCheckPeerCN off\n   SSLProxyCheckPeerName off\n   SSLProxyCheckPeerExpire off\n\n   ProxyHCTPsize 400\n   ProxyHCExpr get {hc('body') =~ /OK/}\n   ProxyHCTemplate server hcmethod=GET hcexpr=get hcfails=1 hcinterval=2 hcpasses=1 hcuri=/tester\n   <Proxy balancer://group>\n      BalancerMember https://192.168.0.2:8080 connectiontimeout=1 hcconnectiontimeout=1 hctemplate=server\n      BalancerMember https://192.168.0.3:8080 connectiontimeout=1 hcconnectiontimeout=1 hctemplate=server\n   </Proxy>\n<VirtualHost *:80>\n\n   ProxyPass \"/\" \"balancer://group/\" failontimeout=On timeout=2\n   ProxyPassReverse \"/\" \"balancer://group/\"\n\n</VirtualHost>\n\nI hope this helps anyone.", "is_private": false, "id": 198106, "creator": "michael@fsphost.com", "time": "2017-03-31T14:59:41Z", "bug_id": 60948, "creation_time": "2017-03-31T14:59:41Z", "attachment_id": 34892}, {"count": 1, "tags": [], "bug_id": 60948, "attachment_id": 34893, "is_private": false, "id": 198125, "time": "2017-04-03T13:19:15Z", "creator": "michael@fsphost.com", "creation_time": "2017-04-03T13:19:15Z", "text": "Created attachment 34893\nI forgot to allow it in ProxyHCTemplate and the parameter is now optional\n\nI forgot to allow it in ProxyHCTemplate and the parameter is now optional"}]