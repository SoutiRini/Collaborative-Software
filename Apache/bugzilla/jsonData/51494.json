[{"count": 0, "tags": [], "bug_id": 51494, "attachment_id": null, "id": 147853, "time": "2011-07-10T01:56:23Z", "creator": "kpreisser@apache.org", "creation_time": "2011-07-10T01:56:23Z", "is_private": false, "text": "Hi,\n\nThe following applies to Tomcat 7.0.18, but I couldn't select that version.\n\nWhen a request to a Servlet takes a long time to process, and the webapp is redeployed in that time (e.g. by replacing the .war file), the following NPE is thrown in org.apache.catalina.core.StandardContextValve.invoke():\n\n10.07.2011 03:27:05 org.apache.catalina.connector.CoyoteAdapter service\nSCHWERWIEGEND: An exception or error occurred in the container during the request processing\njava.lang.NullPointerException\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:183)\n\tat org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:462)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:164)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:100)\n\tat org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:754)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:404)\n\tat org.apache.coyote.http11.Http11AprProcessor.process(Http11AprProcessor.java:274)\n\tat org.apache.coyote.http11.Http11AprProtocol$Http11ConnectionHandler.process(Http11AprProtocol.java:237)\n\tat org.apache.tomcat.util.net.AprEndpoint$SocketProcessor.run(AprEndpoint.java:1731)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\tat java.lang.Thread.run(Thread.java:662)\n\nThis is because \"context\" attribute in StandardContextValve is null at that time.\n\nI could reproduce this behaviour on Windows 7 (32 bit) with Sun/Oracle Java 1.6.0_26, using the Windows x86 binaries of Tomcat 7.0.18 (from http://people.apache.org/~markt/dev/tomcat-7/v7.0.18/) with the included Tomcat Native 1.1.20.\n\n\nTo reproduce:\n\n0) Download and install Tomcat 7.0.18 (I used the windows x86 zip binaries).\n\n1) Create a simple webapp with a servlet, that takes a long time to process requests, e.g. by calling Thread.sleep(). For example, I used:\n\n@WebServlet(\"/LongRequest\")\npublic class LongRequest extends HttpServlet {\n\t   \n    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {\n        PrintWriter out = response.getWriter();\n        out.println(\"Start...\");\n    \tout.flush();\n        \n        try {\n            Thread.sleep(20000);\n        } catch (InterruptedException ex) {\n            out.println(ex.toString());\n        }\n        \n        out.println(\"Finished.\");\n        out.close();\n    }\n}\n\n2) Package the webapp as \".war\" file, and make two versions of that file.\n\n3) Deploy the first version to Tomcat by copying the .war file into the \"webapps\" directory.\n\n4) Open a browser and make a GET request to the above servlet.\n\n5) Now immediately replace the .war file in the webapp directory with the second version, so that Tomcat will undeploy the old version and deploy the new one.\n\n5) After the request finishes, the NPE is thrown.\n\n\nI originally observed a NPE in StandardWrapperValve.invoke() with Tomcat 7.0.16 that I reported on the users list [1], which occured when the webapp was redeployed while a servlet was still processing a request. However, I couldn't reproduce the NPE in StandardWrapperValve.invoke(), but in StandardContextValve.invoke().\n\n\n[1] http://markmail.org/message/2tumlfipaotkshst"}, {"count": 1, "tags": [], "text": "7.0.18 hasn't been released so set version to trunk.", "attachment_id": null, "id": 147855, "creator": "markt@apache.org", "time": "2011-07-10T10:46:54Z", "bug_id": 51494, "creation_time": "2011-07-10T10:46:54Z", "is_private": false}, {"count": 2, "tags": [], "text": "Fixed in trunk and will be included in 7.0.19 onwards.", "is_private": false, "bug_id": 51494, "id": 147880, "time": "2011-07-12T08:48:26Z", "creator": "markt@apache.org", "creation_time": "2011-07-12T08:48:26Z", "attachment_id": null}]