[{"count": 0, "tags": [], "creator": "drees76@gmail.com", "is_private": false, "id": 175553, "creation_time": "2014-05-30T01:24:18Z", "time": "2014-05-30T01:24:18Z", "bug_id": 56578, "text": "session invalidate does not work in 7.0.54 when Tomcat is clustered. 7.0.53 is OK.\n\nSteps to reproduce:\n\n1. Use Clustered Tomcat, with the following added to the <Host/> in server.xml:\n\n<Cluster className=\"org.apache.catalina.ha.tcp.SimpleTcpCluster\"/>\n\n2. Drop session.jsp and invalidate.jsp from attachments into a directory.\n\n3. Open session.jsp in a browser. Note creation time.\n\n4. Refresh page and note creation time stays the same.\n\n5. Click on Invalidate and note that creation time is updated.\n\nOn Tomcat 7.0.53 all steps above succeed.\nOn Tomcat 7.0.54 step 5 fails.", "attachment_id": null}, {"count": 1, "attachment_id": 31678, "bug_id": 56578, "text": "Created attachment 31678\nsession.jsp", "id": 175554, "time": "2014-05-30T01:24:52Z", "creator": "drees76@gmail.com", "creation_time": "2014-05-30T01:24:52Z", "tags": [], "is_private": false}, {"count": 2, "attachment_id": 31679, "bug_id": 56578, "is_private": false, "id": 175555, "time": "2014-05-30T01:25:04Z", "creator": "drees76@gmail.com", "creation_time": "2014-05-30T01:25:04Z", "tags": [], "text": "Created attachment 31679\ninvalidate.jsp"}, {"attachment_id": null, "tags": [], "bug_id": 56578, "is_private": false, "count": 3, "id": 175564, "time": "2014-05-30T13:11:08Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-05-30T13:11:08Z", "text": "For reference: the thread on users@,\n\"Tomcat 7.0.54 - Session invalidate broken in some apps\"\nhttp://tomcat.markmail.org/thread/3zjrbavcxgrnw3ga"}, {"count": 4, "tags": [], "text": "WORKSFORME:\n\nI placed both files into webapps/examples/\nI added the following line to session.jsp to display current session id:\n<tr><td>Session ID:</td><td><%= session.getId() %></td></tr>\n\nI am using a single Tomcat instance, with default configuration.\nI added the following line added to server.xml.\n<Cluster className=\"org.apache.catalina.ha.tcp.SimpleTcpCluster\"/>\n\nI do not see any error. The session creation time is updated on invalidation, and session id is changed as well.\n\nTested with current 7.0.x (JDK 6u45) and 8.0.x (JDK 7u55),\non Win7, Firefox 29.0.1,\n\n\nA fragment of catalina.date.log of Tomcat 7 (at start time):\n\n31.05.2014 0:02:35 org.apache.catalina.ha.tcp.SimpleTcpCluster startInternal\nINFO: Cluster is about to start\n31.05.2014 0:02:35 org.apache.catalina.tribes.transport.ReceiverBase bind\nINFO: Receiver Server Socket bound to:/xxx.yyy.z.www:4000\n31.05.2014 0:02:35 org.apache.catalina.tribes.membership.McastServiceImpl setupSocket\nINFO: Setting cluster mcast soTimeout to 500\n31.05.2014 0:02:35 org.apache.catalina.tribes.membership.McastServiceImpl waitForMembers\nINFO: Sleeping for 1000 milliseconds to establish cluster membership, start level:4\n31.05.2014 0:02:36 org.apache.catalina.tribes.membership.McastServiceImpl waitForMembers\nINFO: Done sleeping, membership established, start level:4\n31.05.2014 0:02:36 org.apache.catalina.tribes.membership.McastServiceImpl waitForMembers\nINFO: Sleeping for 1000 milliseconds to establish cluster membership, start level:8\n31.05.2014 0:02:37 org.apache.catalina.tribes.membership.McastServiceImpl waitForMembers\nINFO: Done sleeping, membership established, start level:8\n31.05.2014 0:02:37 org.apache.catalina.ha.session.JvmRouteBinderValve startInternal\nINFO: JvmRouteBinderValve started\n\n\nDid you use a single Tomcat instance in your reproduction scenario, or I need something more complex?\n\nDid your cluster startup log looked like the above?\n\nDoes your configuration have other differences from the default one (besides the added line in server.xml)?\n\nCan you try debugging? (As mentioned in the e-mail thread).", "is_private": false, "id": 175568, "creator": "knst.kolinko@gmail.com", "time": "2014-05-30T23:19:08Z", "bug_id": 56578, "creation_time": "2014-05-30T23:19:08Z", "attachment_id": null}, {"count": 5, "tags": [], "creator": "drees76@gmail.com", "text": "On a hunch, I tested a webapp with and without the <distributable/> element.\n\nThe webapp also needs to have that element in the web.xml to reproduce the issue and the examples webapp does not have it.\n\nFWIW environment is CentOS 6.5, Java 7u55 and Chrome 35, but I don't think any of those factors matter.", "id": 175569, "time": "2014-05-31T00:22:29Z", "bug_id": 56578, "creation_time": "2014-05-31T00:22:29Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "creator": "knst.kolinko@gmail.com", "is_private": false, "id": 175571, "creation_time": "2014-05-31T12:21:15Z", "time": "2014-05-31T12:21:15Z", "bug_id": 56578, "text": "Ack. Thank you!\nIt is reproducible with 8.0 if I add <distributable/> to examples/WEB-INF/web.xml.\n\nThis regression is caused by StandardSession change in r1584915\n(a fix to bug 56339)\n\nThe session object is DeltaSession.\nThe sequence of events is:\n\n1. session.invalidate() = StandardSession.invalidate() -> calls expire()\n2. expire() is implemented as expire(notify=true)\n3. DeltaSession.expire(notify) is implemented as expire(notify=true, notifyCluster=true).\n\n4. DeltaSession.expire(boolean notify, boolean notifyCluster)\n- sets \"expiring = true\"\n- does cluster.send(msg);\n- calls super.expire(notify);\n\nHere the things go wrong. Because of the change in r1584915 the StandardSession.expire(notify) checks the \"expiring\" flag and exits immediately. Effectively that call became a NOOP.\n\nThus the actual expiration does not happen.", "attachment_id": null}, {"count": 7, "tags": [], "text": "Thank you for tracking it down. That was one of the possible suspects I had looked at while reviewing the changelog for possible regressions.", "is_private": false, "id": 175573, "creator": "drees76@gmail.com", "time": "2014-05-31T16:37:11Z", "bug_id": 56578, "creation_time": "2014-05-31T16:37:11Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 56578, "text": "This has been fixed in 8.0.x for 8.0.9 onwards and in 7.0.x for 7.0.55 onwards.", "id": 175695, "time": "2014-06-06T10:34:13Z", "creator": "markt@apache.org", "creation_time": "2014-06-06T10:34:13Z", "is_private": false, "attachment_id": null}]