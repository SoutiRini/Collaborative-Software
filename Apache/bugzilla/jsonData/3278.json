[{"count": 0, "tags": [], "bug_id": 3278, "is_private": false, "text": "Sometimes Tomcat 4.0-b7 shuts down instantly, and sometimes it take 5 seconds \nto shutdown after displaying the \"Stopping service\" message. It's always one or \nthe other: very quick shutdown, or 5 second delay - no more, no less. The slow \nshutdown seems to happen most frequently if the server is stopped within about \n10-30 seconds of being started, but it is not limited to this.\n\nThe default logging shows that the delay occurs between the\n\"HttpConnector[80] Stopping background thread\"\nmessage in the Catalina log file and the first\n\"StandardHost[localhost]: Removing web application\"\nmessage in the localhost log file. The timestamps are either the same, or are \nexactly 5 seconds apart.\n\nThis might not be much of an issue under normal usage, but I am frequently \nstarting and stopping Tomcat programmatically from a Windows application (using \nshell). Also, while Tomcat is stopping, an attempt to restart it results in a \nBindException, so it would be very nice not to have this delay, especially \nsince it is about twice as long as the startup time.\n\nI am running Windows 2000 with J2SE 1.3.1. I was previously using Tomcat 3.2 \nwhich always shutdown quickly.", "id": 4893, "time": "2001-08-27T04:32:34Z", "creator": "newman@mindless.com", "creation_time": "2001-08-27T04:32:34Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "remm@apache.org", "text": "Yes, there's apparently a race condition in the code which shuts down the \nserver socket.", "count": 1, "id": 4894, "time": "2001-08-27T04:46:23Z", "bug_id": 3278, "creation_time": "2001-08-27T04:46:23Z", "is_private": false}, {"count": 2, "tags": [], "creator": "newman@mindless.com", "text": "I didn't look at all of HttpConnector, but there seem to be at least two race \nconditions in the interactions between run(), stop(), and threadStop().\n\nFile version:\nPackage: org.apache.catalina.connector.http\nClass: HttpConnector\nRevision: 1.21\nDate: 2001/07/22 22:36:09\n\nRace 1:\nserverSocket is closed in stop()\nserverSocket is reopened in run()\nrun() loops to serverSocket.accept()\nstopped is set to true in threadStop()\nthreadStop() waits\n\nRace 2:\nserverSocket is closed in stop()\nstopped is set to true in threadStop()\nrun() returns\nthreadStop() waits\n\nSetting stopped inside the threadSync block in threadStop() would eliminate \nRace 2, but not Race 1.\n\nProposed fix:\n\n1. The serverSocket close() in stop() should be combined with the call to \nthreadStop() into one block synchronized on threadSync. The synchronization \nwithin threadStop() can then be removed.\n\n2. The serverSocket reopen in run() should also be synchronized on threadSync.\n\nI will attach a version of HttpConnector with these patches applied. They seem \nto fix the problem on my machine, without any side affects.\n\n- Michael Newman\n", "id": 4922, "time": "2001-08-27T11:45:26Z", "bug_id": 3278, "creation_time": "2001-08-27T11:45:26Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "newman@mindless.com", "text": "Created attachment 464\nProposed Fix", "id": 4923, "time": "2001-08-27T11:47:36Z", "bug_id": 3278, "creation_time": "2001-08-27T11:47:36Z", "is_private": false, "attachment_id": 464}, {"attachment_id": null, "tags": [], "creator": "newman@mindless.com", "is_private": false, "count": 4, "id": 4939, "time": "2001-08-28T01:10:01Z", "bug_id": 3278, "creation_time": "2001-08-28T01:10:01Z", "text": "I'm not using it, but I figured I'd take a glance at the HTTP 1.0 connector \n(Revision 1.10). It is affected similarly."}, {"count": 5, "tags": [], "text": "Thanks a lot for the patch !\nThe change is especially useful when Tomcat is run as a daemon (like under NT \nas a NT service), because the long shutdown time may cause the process to be \nkilled by the OS. I think that change fix the problem in all situations.", "is_private": false, "bug_id": 3278, "id": 4974, "time": "2001-08-28T19:53:11Z", "creator": "remm@apache.org", "creation_time": "2001-08-28T19:53:11Z", "attachment_id": null}]