[{"count": 0, "tags": [], "bug_id": 56777, "attachment_id": null, "id": 176712, "time": "2014-07-28T09:27:20Z", "creator": "awilkinson@pivotal.io", "creation_time": "2014-07-28T09:27:20Z", "is_private": false, "text": "We're using embedded Tomcat in Spring Boot (https://github.com/spring-projects/spring-boot). Spring Boot allows a user to create an executable jar file that contains Tomcat and their application. The idea is that an application can, if so desired, be entirely contained within the jar with no external dependencies.\n\nCurrently, this breaks down if a key store or trust store is required for SSL configuration as Tomcat requires them to be readable directly from the filesystem rather than from within a jar file. I'd like to propose an enhancement to Tomcat that introduces a resource abstraction, allowing configuration resources to be loaded from within an archive and perhaps even broader than that. (Jetty, for example, allows a resource to be loaded from a URL)."}, {"count": 1, "tags": [], "bug_id": 56777, "is_private": false, "id": 180302, "creation_time": "2015-01-14T20:15:28Z", "time": "2015-01-14T20:15:28Z", "creator": "markt@apache.org", "text": "*** Bug 57444 has been marked as a duplicate of this bug. ***", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 56777, "attachment_id": null, "is_private": false, "id": 185522, "time": "2015-09-29T07:45:12Z", "creator": "markt@apache.org", "creation_time": "2015-09-29T07:45:12Z", "text": "Coming back to this having been prompted about it at $work. It doesn't look to be as big a task as I first thought. Some questions.\n\n1. In an ideal world, which Tomcat versions would you like this in? 8.0.x obviously. What about 7.0.x and 6.0.x? (a back-port to 6.0.x is unlikely without a very strong reason)\n\nI'm imagining that the implementation will look for some specific prefix / prefixes for specified configuration settings (keystore locations, memory user database, any others I spot reviewing the config docs) and if one of those prefixes is found use an appropriate mechanism to locate the resource. No prefix means assume a file path. Relative paths relative to CATALINA_BASE.\n\n2. What prefixes would you like to see supported and how do you expect each prefix to behave?"}, {"count": 3, "tags": [], "text": "(In reply to Mark Thomas from comment #2)\n\n> 1. In an ideal world, which Tomcat versions would you like this in? 8.0.x\n> obviously. What about 7.0.x and 6.0.x? (a back-port to 6.0.x is unlikely\n> without a very strong reason)\n\nWe definitely don't need it in 6.0.x. Spring IO Platform 1.1.x uses Tomcat 7.0.x so support for it there would be nice to have, although not essential. Boot 1.2 and 1.3 are both on Tomcat 8.\n\n> I'm imagining that the implementation will look for some specific prefix /\n> prefixes for specified configuration settings (keystore locations, memory\n> user database, any others I spot reviewing the config docs) and if one of\n> those prefixes is found use an appropriate mechanism to locate the resource.\n> No prefix means assume a file path. Relative paths relative to CATALINA_BASE.\n> \n> 2. What prefixes would you like to see supported and how do you expect each\n> prefix to behave?\n\nWould it be possible to use a URL to provide a resource and then use URL.openStream to read it? That's what Jetty does, I believe.", "attachment_id": null, "id": 185527, "creator": "awilkinson@pivotal.io", "time": "2015-09-29T09:08:50Z", "bug_id": 56777, "creation_time": "2015-09-29T09:08:50Z", "is_private": false}, {"count": 4, "tags": [], "text": "I've done some quick tests and it looks like URL support is doable without breaking backwards compatability. I'm going to add support for \"classpath:\" URLs at the same time since a number of examples I've seen of this feature in other containers use class path URLs.\n\nI should have something ready for you to test later today or early tomorrow. Am I correct in assuming you'll want a 8.0.x snapshot published to test with?", "is_private": false, "id": 185531, "creation_time": "2015-09-29T11:36:35Z", "time": "2015-09-29T11:36:35Z", "creator": "markt@apache.org", "bug_id": 56777, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 56777, "text": "(In reply to Mark Thomas from comment #4)\n> I've done some quick tests and it looks like URL support is doable without\n> breaking backwards compatability.\n\nExcellent \n\n> I'm going to add support for \"classpath:\" URLs at the same time since a\n> number of examples I've seen of this feature in other containers use class\n> path URLs.\n\nFWIW, if you do add support for classpath: URLs, we probably won't use it in Spring Boot. For consistency with other resource loading, and what we've done for Jetty and Undertow, I expect we'll use Spring Framework's ResourceUtils to get a URL and then pass that to Tomcat.\n\n> I should have something ready for you to test later today or early tomorrow.\n\nGreat stuff. Thank you.\n\n> Am I correct in assuming you'll want a 8.0.x snapshot published to test with?\n\nA snapshot would be handy, but I'm also happy to build from source.", "count": 5, "id": 185532, "time": "2015-09-29T12:02:44Z", "creator": "awilkinson@pivotal.io", "creation_time": "2015-09-29T12:02:44Z", "is_private": false}, {"count": 6, "attachment_id": null, "bug_id": 56777, "is_private": false, "id": 185538, "time": "2015-09-29T14:06:12Z", "creator": "markt@apache.org", "creation_time": "2015-09-29T14:06:12Z", "tags": [], "text": "This has now been implemented in trunk. It will be back-ported to 8.0.x but that is not a simple svn merge because of the TLS refactoring that took place between 8.0.x and trunk. Still on track to have that done by early tomorrow at the latest."}, {"count": 7, "tags": [], "bug_id": 56777, "is_private": false, "id": 185547, "creation_time": "2015-09-29T18:45:16Z", "time": "2015-09-29T18:45:16Z", "creator": "markt@apache.org", "text": "Back-ported to 8.0.x and will be included in 8.0.28 onwards.", "attachment_id": null}, {"count": 8, "attachment_id": null, "bug_id": 56777, "is_private": false, "id": 185815, "time": "2015-10-20T14:53:29Z", "creator": "awilkinson@pivotal.io", "creation_time": "2015-10-20T14:53:29Z", "tags": [], "text": "Reopening for consideration of a backport to 7.0.x"}, {"count": 9, "tags": [], "text": "Hi folks, I will try to do the back-port to tomcat 7.x.", "attachment_id": null, "id": 185826, "creator": "huxing.zhang@gmail.com", "time": "2015-10-21T15:52:36Z", "bug_id": 56777, "creation_time": "2015-10-21T15:52:36Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 56777, "text": "Created attachment 33192\nback port fix of bug 56777 to tomcat 7.0.x\n\nback port fix of bug 56777 to tomcat 7.0.x.\nAllow trust stores, keystores, CRLs and the tomcat-users.xml file to be loaded from URLs as well as the file system.", "id": 185838, "time": "2015-10-22T05:39:56Z", "creator": "huxing.zhang@gmail.com", "creation_time": "2015-10-22T05:39:56Z", "is_private": false, "attachment_id": 33192}, {"count": 11, "tags": [], "bug_id": 56777, "attachment_id": 33193, "is_private": false, "id": 185839, "time": "2015-10-22T05:47:02Z", "creator": "huxing.zhang@gmail.com", "creation_time": "2015-10-22T05:47:02Z", "text": "Created attachment 33193\nback port fix of bug 56777 to tomcat 7.0.x\n\nupdate patch, the previous patch is not correct, because webapps/docs/changelog.xml.orig is added by mistake."}, {"count": 12, "tags": [], "text": "Hi,\n\nYou may want to see this issue 58518 which seems to be connected with this feature.\n\nBest Regards,\nVioleta Georgieva", "attachment_id": null, "id": 185843, "creator": "violetagg@apache.org", "time": "2015-10-22T10:22:45Z", "bug_id": 56777, "creation_time": "2015-10-22T10:22:45Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 56777, "attachment_id": null, "id": 185860, "time": "2015-10-23T02:30:38Z", "creator": "huxing.zhang@gmail.com", "creation_time": "2015-10-23T02:30:38Z", "is_private": false, "text": "Okay, just give me some time to look into this issue."}, {"count": 14, "tags": [], "bug_id": 56777, "attachment_id": 33220, "is_private": false, "id": 185963, "time": "2015-10-26T07:50:34Z", "creator": "huxing.zhang@gmail.com", "creation_time": "2015-10-26T07:50:34Z", "text": "Created attachment 33220\npatch that also avoid bug 58518\n\nWell, since Mark has already fixed bug 58518, I have also back ported this fix into tomcat 7.0.x.\nPlease refer to the patches I provided.\nIn addition, I have also added a unit test case to cover bug 58518."}, {"count": 15, "tags": [], "text": "(In reply to Huxing Zhang from comment #14)\n> Created attachment 33220 [details]\n> patch that also avoid bug 58518\n> \n> Well, since Mark has already fixed bug 58518, I have also back ported this\n> fix into tomcat 7.0.x.\n\nPlease check the following discussion\nhttp://marc.info/?t=144578052500001&r=1&w=2", "is_private": false, "id": 185967, "creator": "violetagg@apache.org", "time": "2015-10-26T08:29:17Z", "bug_id": 56777, "creation_time": "2015-10-26T08:29:17Z", "attachment_id": null}, {"count": 16, "tags": [], "text": "(In reply to Violeta Georgieva from comment #15)\n> (In reply to Huxing Zhang from comment #14)\n> > Created attachment 33220 [details]\n> > patch that also avoid bug 58518\n> > \n> > Well, since Mark has already fixed bug 58518, I have also back ported this\n> > fix into tomcat 7.0.x.\n> \n> Please check the following discussion\n> http://marc.info/?t=144578052500001&r=1&w=2\n\nThanks for your information, How about the following implementation ConfigFileLoader, which I think it can avoid:\n1) twice hard disk access.\n2) resolving file paths that contains space.\n\npublic static InputStream getInputStream(String location) throws IOException {\n        // Absolute URIs will be left alone\n        // Relative files will be resolved relative to catalina base\n        // Absolute files will be converted to URIs\n\n        // Location was originally always a file before URI support was added so\n        // try file first.\n\n        // First guess, an absolute file path\n        File file = new File(location);\n\n        if (!file.isAbsolute()) {\n            // Second guess, a file path relative to CATALINA_BASE\n            file = new File(CATALINA_BASE_FILE, location);\n        }\n\n        if (file.isFile()) {\n            return new FileInputStream(file);\n        }\n\n        // Third and final guess, a URI\n        URI uri = CATALINA_BASE_URI.resolve(location);\n        return uri.toURL().openStream();\n    }", "is_private": false, "id": 185976, "creator": "huxing.zhang@gmail.com", "time": "2015-10-26T13:33:47Z", "bug_id": 56777, "creation_time": "2015-10-26T13:33:47Z", "attachment_id": null}, {"count": 17, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "Yep, that is pretty much the solution I came up with.", "id": 186037, "time": "2015-10-28T02:07:16Z", "bug_id": 56777, "creation_time": "2015-10-28T02:07:16Z", "is_private": false}, {"count": 18, "tags": [], "creator": "huxing.zhang@gmail.com", "attachment_id": 33230, "text": "Created attachment 33230\npatch including latest ConfigFileLoader enhancement.", "id": 186041, "time": "2015-10-28T03:03:28Z", "bug_id": 56777, "creation_time": "2015-10-28T03:03:28Z", "is_private": false}, {"count": 19, "tags": [], "creator": "violetagg@apache.org", "attachment_id": null, "id": 186272, "time": "2015-11-05T17:08:40Z", "bug_id": 56777, "creation_time": "2015-11-05T17:08:40Z", "is_private": false, "text": "(In reply to Huxing Zhang from comment #18)\n> Created attachment 33230 [details]\n> patch including latest ConfigFileLoader enhancement.\n\nHi,\n\nPlease do not remove DirContextURLStreamHandlerFactory, users can use it to provide additional stream handlers.\n\nRegards,\nVioleta"}, {"count": 20, "tags": [], "bug_id": 56777, "attachment_id": null, "is_private": false, "id": 186345, "time": "2015-11-10T10:36:32Z", "creator": "huxing.zhang@gmail.com", "creation_time": "2015-11-10T10:36:32Z", "text": "I just renamed  DirContextURLStreamHandlerFactory to TomcatURLStreamHandlerFactory, which might not be good for backward compatibility.\nI will restore DirContextURLStreamHandlerFactory in my next patch."}, {"count": 21, "attachment_id": 33268, "bug_id": 56777, "is_private": false, "id": 186346, "time": "2015-11-10T11:44:33Z", "creator": "huxing.zhang@gmail.com", "creation_time": "2015-11-10T11:44:33Z", "tags": [], "text": "Created attachment 33268\nPatch to restore DirContextUrlStreamHandlerFactory"}, {"count": 22, "tags": [], "bug_id": 56777, "text": "Hi,\n\nThanks for the back-port.\nI back-ported the changes in the documentation also.\nThe fix will be available in Tomcat 7.0.66 onwards.\n\nRegards,\nVioleta", "id": 186354, "time": "2015-11-11T09:58:56Z", "creator": "violetagg@apache.org", "creation_time": "2015-11-11T09:58:56Z", "is_private": false, "attachment_id": null}]