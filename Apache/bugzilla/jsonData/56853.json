[{"count": 0, "tags": [], "bug_id": 56853, "attachment_id": null, "text": "When I call Struts Action with Tomcat 8.*, Broken pipe Exception occur.\n\n\u30fbIf use Tomcat BIO protocol, Exception does not occur.\n\u30fbIf use Tomcat 7.* + NIO protocol, Exception does not occur.\n\u30fbIf read HttpResponse, Exception does not occur.\n\u30fbIf OS is Windows, Exception does not occur.\n\n\u25a0 StackTrace\norg.apache.catalina.connector.ClientAbortException: java.io.IOException: Broken pipe    \n    at org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:389)\n    at org.apache.tomcat.util.buf.ByteChunk.flushBuffer(ByteChunk.java:426)\n    at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:338)\n    at org.apache.catalina.connector.OutputBuffer.close(OutputBuffer.java:291)\n    at org.apache.catalina.connector.CoyoteOutputStream.close(CoyoteOutputStream.java:151)\n    at org.apache.struts2.dispatcher.StreamResult.doExecute(StreamResult.java:305)\n    at org.apache.struts2.dispatcher.StrutsResultSupport.execute(StrutsResultSupport.java:186)\n    at com.opensymphony.xwork2.DefaultActionInvocation.executeResult(DefaultActionInvocation.java:371)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:275)\n    at org.apache.struts2.interceptor.DeprecationInterceptor.intercept(DeprecationInterceptor.java:41)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at org.apache.struts2.interceptor.debugging.DebuggingInterceptor.intercept(DebuggingInterceptor.java:256)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at com.opensymphony.xwork2.interceptor.DefaultWorkflowInterceptor.doIntercept(DefaultWorkflowInterceptor.java:167)\n    at com.opensymphony.xwork2.interceptor.MethodFilterInterceptor.intercept(MethodFilterInterceptor.java:98)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at com.opensymphony.xwork2.validator.ValidationInterceptor.doIntercept(ValidationInterceptor.java:265)\n    at org.apache.struts2.interceptor.validation.AnnotationValidationInterceptor.doIntercept(AnnotationValidationInterceptor.java:68)\n    at com.opensymphony.xwork2.interceptor.MethodFilterInterceptor.intercept(MethodFilterInterceptor.java:98)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at com.opensymphony.xwork2.interceptor.ConversionErrorInterceptor.intercept(ConversionErrorInterceptor.java:138)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at com.opensymphony.xwork2.interceptor.ParametersInterceptor.doIntercept(ParametersInterceptor.java:254)\n    at com.opensymphony.xwork2.interceptor.MethodFilterInterceptor.intercept(MethodFilterInterceptor.java:98)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at com.opensymphony.xwork2.interceptor.ParametersInterceptor.doIntercept(ParametersInterceptor.java:254)\n    at com.opensymphony.xwork2.interceptor.MethodFilterInterceptor.intercept(MethodFilterInterceptor.java:98)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at com.opensymphony.xwork2.interceptor.StaticParametersInterceptor.intercept(StaticParametersInterceptor.java:191)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at org.apache.struts2.interceptor.MultiselectInterceptor.intercept(MultiselectInterceptor.java:73)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at org.apache.struts2.interceptor.CheckboxInterceptor.intercept(CheckboxInterceptor.java:91)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at org.apache.struts2.interceptor.FileUploadInterceptor.intercept(FileUploadInterceptor.java:252)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at com.opensymphony.xwork2.interceptor.ModelDrivenInterceptor.intercept(ModelDrivenInterceptor.java:100)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at com.opensymphony.xwork2.interceptor.ScopedModelDrivenInterceptor.intercept(ScopedModelDrivenInterceptor.java:141)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at com.opensymphony.xwork2.interceptor.ChainingInterceptor.intercept(ChainingInterceptor.java:145)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at com.opensymphony.xwork2.interceptor.PrepareInterceptor.doIntercept(PrepareInterceptor.java:171)\n    at com.opensymphony.xwork2.interceptor.MethodFilterInterceptor.intercept(MethodFilterInterceptor.java:98)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at com.opensymphony.xwork2.interceptor.I18nInterceptor.intercept(I18nInterceptor.java:139)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at org.apache.struts2.interceptor.ServletConfigInterceptor.intercept(ServletConfigInterceptor.java:164)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at com.opensymphony.xwork2.interceptor.AliasInterceptor.intercept(AliasInterceptor.java:193)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at com.opensymphony.xwork2.interceptor.ExceptionMappingInterceptor.intercept(ExceptionMappingInterceptor.java:189)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:246)\n    at org.apache.struts2.impl.StrutsActionProxy.execute(StrutsActionProxy.java:54)\n    at com.opensymphony.xwork2.ActionChainResult.execute(ActionChainResult.java:233)\n    at com.opensymphony.xwork2.DefaultActionInvocation.executeResult(DefaultActionInvocation.java:371)\n    at com.opensymphony.xwork2.DefaultActionInvocation.invoke(DefaultActionInvocation.java:275)\nCaused by: java.io.IOException: Broken pipe \n    at sun.nio.ch.FileDispatcherImpl.write0(Native Method)\n    at sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:47)\n    at sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:89)\n    at sun.nio.ch.IOUtil.write(IOUtil.java:60)\n    at sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:450)\n    at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:127)\n    at org.apache.tomcat.util.net.NioBlockingSelector.write(NioBlockingSelector.java:101)\n    at org.apache.tomcat.util.net.NioSelectorPool.write(NioSelectorPool.java:173)\n    at org.apache.coyote.http11.InternalNioOutputBuffer.writeToSocket(InternalNioOutputBuffer.java:139)\n    at org.apache.coyote.http11.InternalNioOutputBuffer.flushBuffer(InternalNioOutputBuffer.java:244)\n    at org.apache.coyote.http11.InternalNioOutputBuffer.addToBB(InternalNioOutputBuffer.java:189)\n    at org.apache.coyote.http11.InternalNioOutputBuffer.access$000(InternalNioOutputBuffer.java:41)\n    at org.apache.coyote.http11.InternalNioOutputBuffer$SocketOutputBuffer.doWrite(InternalNioOutputBuffer.java:320)\n    at org.apache.coyote.http11.filters.ChunkedOutputFilter.doWrite(ChunkedOutputFilter.java:116)\n    at org.apache.coyote.http11.AbstractOutputBuffer.doWrite(AbstractOutputBuffer.java:257)\n    at org.apache.coyote.Response.doWrite(Response.java:492)\n    at org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:384)\n    ... 164 more\n\n\n\u25a0 TestAction.java\npackage sample.action;\n\nimport java.io.ByteArrayInputStream;\nimport java.io.InputStream;\n\nimport org.apache.commons.logging.Log;\nimport org.apache.commons.logging.LogFactory;\nimport org.apache.struts2.convention.annotation.Action;\nimport org.apache.struts2.convention.annotation.InterceptorRef;\nimport org.apache.struts2.convention.annotation.ParentPackage;\nimport org.apache.struts2.convention.annotation.Result;\n\nimport com.opensymphony.xwork2.ActionSupport;\n\n@ParentPackage(value = \"default\")\n@InterceptorRef(\"first\")\npublic class TestAction extends ActionSupport {\n\n    public InputStream inputStream;\n\n    private static final Log log = LogFactory.getLog(TestAction.class);\n\n    @Action(value = \"test\", results = {\n            @Result(name = \"error\", type = \"stream\", location = \"inputStream\", params = {\"contentType\", \"text/xml; charset=UTF-8\" }),\n            @Result(name = \"success\", type = \"stream\", location = \"inputStream\", params = {\"contentType\", \"text/xml; charset=UTF-8\" })\n    })\n\n    public String execute() throws Exception {\n        try {\n            log.info(\"Start\");\n            inputStream = new ByteArrayInputStream(\"<result>test</result>\".getBytes());\n            log.info(\"End\");\n            return \"success\";\n        } catch (Exception e) {\n            log.error(e.getMessage());\n            return \"error\";\n        }\n    }\n}\n\n\n\u25a0 FirstInterceptor.java\npackage sample.interceptor;\n\nimport org.apache.commons.logging.Log;\nimport org.apache.commons.logging.LogFactory;\n\nimport com.opensymphony.xwork2.ActionInvocation;\nimport com.opensymphony.xwork2.interceptor.AbstractInterceptor;\n\npublic class FirstInterceptor extends AbstractInterceptor {\n\n    private static final Log log = LogFactory.getLog(FirstInterceptor.class);\n\n    @Override\n    public void init() {\n        super.init();\n    }\n\n    @Override\n    public String intercept(ActionInvocation invocation) throws Exception {\n\n        log.info(\"Start\");\n\n        String result = \"\";\n        try {\n            result = invocation.invoke();\n        } catch (Exception e) {\n            log.fatal(e.getMessage(), e);\n            return \"error\";\n        }\n\n        log.info(\"End\");\n        return result;\n    }\n\n}\n\n\n\u25a0 ClientMain.java\npackage sample.client;\n\nimport java.io.IOException;\nimport java.util.ArrayList;\nimport java.util.List;\n\nimport org.apache.http.HttpResponse;\nimport org.apache.http.NameValuePair;\nimport org.apache.http.client.entity.UrlEncodedFormEntity;\nimport org.apache.http.client.methods.HttpPost;\nimport org.apache.http.impl.client.DefaultHttpClient;\nimport org.apache.http.message.BasicNameValuePair;\n\npublic class ClientMain {\n\n    public static void main(String[] args) {\n\n        try {\n            for(int i = 0 ; i < 10 ; i++) {\n                sendHttpRequest(\"http://<Host>/<context>/test\");\n            }\n            System.out.println(\"finish\");\n        } catch(Exception e) {\n            e.printStackTrace();\n        }\n    }\n\n    private static void sendHttpRequest(final String url) throws IOException {\n\n        HttpPost httpPost = null;\n        try {\n            httpPost = new HttpPost(url);\n            DefaultHttpClient httpclient = new DefaultHttpClient();\n\n            List<NameValuePair> params = new ArrayList<NameValuePair>();\n            params.add(new BasicNameValuePair(\"client_type\", \"\"));\n            httpPost.setEntity(new UrlEncodedFormEntity(params, \"UTF-8\"));\n\n            HttpResponse response = httpclient.execute(httpPost);\n\n            if (response.getStatusLine().toString().indexOf(\" 200 \") == -1) {\n                // do something\n            }\n\n        } finally {\n            if (httpPost != null) {\n                httpPost.abort();\n            }\n        }\n    }\n}", "id": 177155, "time": "2014-08-14T07:59:43Z", "creator": "mougenko@gmail.com", "creation_time": "2014-08-14T07:59:43Z", "is_private": false}, {"count": 1, "tags": [], "creator": "markt@apache.org", "text": "The client is dropping the connection so the Exception is not unexpected.\n\nThat the server only sees it in some circumstances is a result of the differences in behaviour between operating systems and between Java IO implementations.", "id": 177159, "time": "2014-08-14T08:47:23Z", "bug_id": 56853, "creation_time": "2014-08-14T08:47:23Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 56853, "is_private": false, "count": 2, "id": 177216, "time": "2014-08-18T03:12:35Z", "creator": "mougenko@gmail.com", "creation_time": "2014-08-18T03:12:35Z", "text": "Thank you for your comment.\n\nIf I was calling asynchronously, then I can agree with your answer.\n\nBut, I have a synchronous call from the client,\nAnd problem does not occur every time.\n\nIs it a problem on the server side?"}]