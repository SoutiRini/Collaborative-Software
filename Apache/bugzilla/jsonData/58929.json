[{"count": 0, "tags": [], "bug_id": 58929, "is_private": false, "text": "Created attachment 33501\nminimal httpd config to reproduce the issue\n\nWhile playing around with httpd-2.4.18, I sent an (invalid) HTTP CONNECT request with a URL instead of a host:port to the httpd (\"CONNECT /index.html HTTP/1.1\") what resulted in immediate drop of the connection. After investigation I found that the httpd process actually crashed (segfault). \nThe core reveals that the r->protocol pointer is 0x0, which is used without check in an strcmp() call in ap_add_cgi_vars().\n\n\nProgram terminated with signal SIGSEGV, Segmentation fault.\n#0  0x000055fdfff85243 in ap_add_cgi_vars (r=0x7f2f98003eb0) at util_script.c:382\n382         if (!strcmp(r->protocol, \"INCLUDED\")) {\n[Current thread is 1 (Thread 0x7f2fa537d700 (LWP 31095))]\n(gdb) bt\n#0  0x000055fdfff85243 in ap_add_cgi_vars (r=0x7f2f98003eb0) at util_script.c:382\n#1  0x00007f2fa5b84314 in includes_filter (f=<optimized out>, b=<optimized out>) at mod_include.c:3887\n#2  0x000055fdfff6b762 in default_handler (r=0x7f2f98003eb0) at core.c:4517\n#3  0x000055fdfff7d1b0 in ap_run_handler (r=r@entry=0x7f2f98003eb0) at config.c:169\n#4  0x000055fdfff7d6f9 in ap_invoke_handler (r=r@entry=0x7f2f98003eb0) at config.c:433\n#5  0x000055fdfff94a4c in ap_internal_redirect (new_uri=<optimized out>, r=<optimized out>) at http_request.c:730\n#6  0x000055fdfff67fbb in ap_read_request (conn=conn@entry=0x7f2fa000bfb8) at protocol.c:985\n#7  0x000055fdfff91a09 in ap_process_http_async_connection (c=0x7f2fa000bfb8) at http_core.c:146\n#8  ap_process_http_connection (c=0x7f2fa000bfb8) at http_core.c:248\n#9  0x000055fdfff86ff0 in ap_run_process_connection (c=c@entry=0x7f2fa000bfb8) at connection.c:41\n#10 0x00007f2fa5d9357d in process_socket (my_thread_num=<optimized out>, my_child_num=0, cs=0x7f2fa000bf28, \n    sock=<optimized out>, p=<optimized out>, thd=<optimized out>) at event.c:1101\n#11 worker_thread (thd=<optimized out>, dummy=<optimized out>) at event.c:1960\n#12 0x00007f2fa653f314 in start_thread () from /lib/libpthread.so.0\n#13 0x00007f2fa608283d in clone () from /lib/libc.so.6\n\n\nI tried to create a simple httpd.conf to reproduce the problem, and found that mod_include has to be active and an \"ErrorDocument 400\" directive pointing to an actual document has to exist.\n\nsince the actual NULL pointer dereference happens in the function\nap_add_cgi_vars() which is called from some other points in the code, it is quite\npossible that other ways to trigger this issue exists.\n\nThe issue still exists in the 2.4 HEAD but was not reproducible with 2.4.17.\n\n\nto reproduce:\n- start apache with given httpd.conf. 400.html has to exist\n- send \"CONNECT /index.html HTTP/1.1\" -> server crashes", "id": 188008, "time": "2016-01-28T12:54:31Z", "creator": "frank.meier@ergon.ch", "creation_time": "2016-01-28T12:54:31Z", "attachment_id": 33501}, {"count": 1, "tags": [], "bug_id": 58929, "text": "I suspect that the bug is this \"early return\" in protocol.c / read_request_line():\n\nif (r->status != HTTP_OK) {\n    return 0;\n}\n\nr->proto_num and r->protocol are not initialized in this case.\n\nThis change has been introduced in r1710095.", "id": 188014, "time": "2016-01-28T15:58:08Z", "creator": "apache-bugzilla@michael-kaufmann.ch", "creation_time": "2016-01-28T15:58:08Z", "is_private": false, "attachment_id": null}, {"count": 2, "attachment_id": null, "bug_id": 58929, "is_private": false, "id": 188026, "time": "2016-01-29T09:50:06Z", "creator": "rpluem@apache.org", "creation_time": "2016-01-29T09:50:06Z", "tags": [], "text": "(In reply to Michael Kaufmann from comment #1)\n> I suspect that the bug is this \"early return\" in protocol.c /\n> read_request_line():\n> \n> if (r->status != HTTP_OK) {\n>     return 0;\n> }\n> \n> r->proto_num and r->protocol are not initialized in this case.\n> \n> This change has been introduced in r1710095.\n\nGood analysis. Can you please try if the following patch fixes your issue:\n\nIndex: server/protocol.c\n===================================================================\n--- server/protocol.c   (revision 1727166)\n+++ server/protocol.c   (working copy)\n@@ -638,6 +638,8 @@\n\n     ap_parse_uri(r, uri);\n     if (r->status != HTTP_OK) {\n+        r->proto_num = HTTP_VERSION(1,0);\n+        r->protocol  = apr_pstrdup(r->pool, \"HTTP/1.0\");\n         return 0;\n     }"}, {"count": 3, "tags": [], "creator": "apache-bugzilla@michael-kaufmann.ch", "attachment_id": null, "text": "(In reply to Ruediger Pluem from comment #2)\n\nYes, this patch works for me.", "id": 188027, "time": "2016-01-29T10:12:43Z", "bug_id": 58929, "creation_time": "2016-01-29T10:12:43Z", "is_private": false}, {"count": 4, "text": "I like the patch, it solves the bug where it was introduced.\n\nI'd additionally suggest to fix the ap_add_cgi_vars() function, to make it more robust. See patch bellow:\n\n\n--- a/server/util_script.c\n+++ b/server/util_script.c\n@@ -379,7 +379,7 @@ AP_DECLARE(void) ap_add_cgi_vars(request_rec *r)\n      * come with the script URI in the include command.  Ugh.\n      */\n \n-    if (!strcmp(r->protocol, \"INCLUDED\")) {\n+    if ( r->protocol && !strcmp(r->protocol, \"INCLUDED\")) {\n         apr_table_setn(e, \"SCRIPT_NAME\", r->uri);\n         if (r->path_info && *r->path_info) {\n             apr_table_setn(e, \"PATH_INFO\", r->path_info);", "bug_id": 58929, "is_private": false, "id": 188028, "time": "2016-01-29T10:20:04Z", "creator": "frank.meier@ergon.ch", "creation_time": "2016-01-29T10:20:04Z", "tags": [], "attachment_id": null}, {"count": 5, "tags": [], "creator": "rpluem@apache.org", "text": "Committed to trunk as r1727544", "id": 188029, "time": "2016-01-29T11:37:21Z", "bug_id": 58929, "creation_time": "2016-01-29T11:37:21Z", "is_private": false, "attachment_id": null}, {"count": 6, "attachment_id": null, "bug_id": 58929, "text": "(In reply to Ruediger Pluem from comment #5)\n> Committed to trunk as r1727544\n\nThank you! Can you please propose this bugfix for the 2.4.x branch?", "id": 188040, "time": "2016-01-29T17:38:21Z", "creator": "apache-bugzilla@michael-kaufmann.ch", "creation_time": "2016-01-29T17:38:21Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "creator": "rpluem@apache.org", "is_private": false, "id": 188199, "attachment_id": null, "bug_id": 58929, "creation_time": "2016-02-03T19:46:46Z", "time": "2016-02-03T19:46:46Z", "text": "(In reply to Michael Kaufmann from comment #6)\n> (In reply to Ruediger Pluem from comment #5)\n> > Committed to trunk as r1727544\n> \n> Thank you! Can you please propose this bugfix for the 2.4.x branch?\n\nProposed for backport as r1728354"}, {"attachment_id": null, "tags": [], "bug_id": 58929, "is_private": false, "count": 8, "id": 190359, "time": "2016-04-18T19:31:43Z", "creator": "apache-bugzilla@michael-kaufmann.ch", "creation_time": "2016-04-18T19:31:43Z", "text": "Thank you Ruediger!\n\nThis bug is fixed in Apache httpd 2.4.20 (backported in r1729875)."}]