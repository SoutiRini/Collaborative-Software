[{"count": 0, "attachment_id": null, "creator": "pb@bieringer.de", "is_private": false, "id": 138995, "time": "2010-08-09T10:05:07Z", "bug_id": 49728, "creation_time": "2010-08-09T10:05:07Z", "tags": [], "text": "the PID file handling was changed in 6.0.24 in catalina.sh, which avoid the use of an initscript to start tomcat proper (e.g. on CentOS/RHEL5). catalina.sh is currently too strict regarding existing PID file and has imho a too lightweight check.\n\nBelow is a patch which improves the PID file handling.\n\nIt fixes 2 issues.\n\nIssue 1: tomcat won't start, if initscript has already created as root a PID file and changed permissions, that user tomcat would able to write it's PID into this file.\n\nFix: check existing PID file whether it's non-empty and if yes, check, whether PID is stale\n\nIssue 2: catalina.sh unconditionally tries to remove the given PID file, not testing the case that it has no write access to the directory (e.g. /var/run).\n\nFix: check before removing a PID file (because this needs write access to pid file directory, which is e.g. /var/run, were user tomcat has no write access)\n\nPls. include this fix into upstream, thank you.\n\n  Peter\n\n--- catalina.sh 2010-07-19 12:59:45.000000000 +0000\n+++ catalina.sh 2010-08-09 13:00:56.000000000 +0000\n@@ -311,9 +311,15 @@\nelif [ \"$1\" = \"start\" ] ; then\n\n  if [ ! -z \"$CATALINA_PID\" ]; then\n-    if [ -f \"$CATALINA_PID\" ]; then\n-      echo \"PID file ($CATALINA_PID) found. Is Tomcat still running? Start aborted.\"\n-      exit 1\n+    if [ -f \"$CATALINA_PID\" -a -s \"$CATALINA_PID\" ]; then\n+      echo \"Non-empty PID file ($CATALINA_PID) found. Is Tomcat still running?\"\n+      pid=\"`cat \"$CATALINA_PID\"`\"\n+      if ps -p $pid >/dev/null; then\n+        echo \"Tomcat is probably still running with PID $pid! Start aborted.\"\n+        exit 1\n+      else\n+        echo \"Tomcat is no longer running (stale PID file).\"\n+      fi\n    fi\n  fi\n\n@@ -393,7 +399,11 @@\n      while [ $SLEEP -ge 0 ]; do\n        kill -0 `cat $CATALINA_PID` >/dev/null 2>&1\n        if [ $? -gt 0 ]; then\n-          rm $CATALINA_PID\n+          if [ -w `dirname \"$CATALINA_PID\"` ]; then\n+            rm $CATALINA_PID\n+          else\n+            echo \"Non-removable PID file found ($CATALINA_PID).\"\n+          fi\n          break\n        fi\n        if [ $SLEEP -gt 0 ]; then\n@@ -416,7 +426,11 @@\n      if [ -f \"$CATALINA_PID\" ]; then\n        echo \"Killing: `cat $CATALINA_PID`\"\n        kill -9 `cat $CATALINA_PID`\n-        rm $CATALINA_PID\n+        if [ -w `dirname \"$CATALINA_PID\"` ]; then\n+          rm $CATALINA_PID\n+        else\n+          echo \"Non-removable PID file found ($CATALINA_PID).\"\n+        fi\n      fi\n    fi\n  fi"}, {"count": 1, "attachment_id": null, "creator": "markt@apache.org", "text": "This has been fixed in 6.0.x and will be included in 6.0.30 onwards.", "id": 140327, "time": "2010-09-30T12:26:51Z", "bug_id": 49728, "creation_time": "2010-09-30T12:26:51Z", "tags": [], "is_private": false}]