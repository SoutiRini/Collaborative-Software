[{"count": 0, "tags": [], "creator": "philip@rsuk.com", "attachment_id": null, "text": "If a client makes a POST request through Apache mod_jk and ajp13, submits the \nheaders but aborts the connection before sending the number of characters \nspecified by the Content-Length header, a POST request with garbage characters \nas input will be passed to the target servlet on the input stream.  This can be \nseen by calling the getInputStream() method of HttpRequest.  The garbage \ncharacters appear to come from the headers of the request (see below for an \nexample).\n\nThis bug affects Tomcat versions 3.2.3 and 3.2.4, running on Windows and Linux.\n\nThe bug only affects ajp13 with mod_jk.  It does not affect ajp12 or Tomcat's \nHTTP connector.  \n\nThe bug can be reproduced with the following servlet (downloadable from \nhttp://sonic.rsuk.com/~psr/tomcatbug/Servlet1.java):\n\n------\n\npackage testwebapp;\n\nimport javax.servlet.*;\nimport javax.servlet.http.*;\nimport java.io.*;\nimport java.util.*;\n\npublic class Servlet1 extends HttpServlet\n{\n    private static final String CONTENT_TYPE = \"text/html\";\n\n    public void doGet(HttpServletRequest request,\n    \t\t\t\t  HttpServletResponse response)\n    \t\t\t\t  throws ServletException, IOException\n    {\n        response.setContentType(CONTENT_TYPE);\n        PrintWriter out = response.getWriter();\n        out.println(\"<html><body>Test</body></html>\");\n    }\n\n    public void doPost(HttpServletRequest request,\n    \t\t\t\t   HttpServletResponse response)\n    \t\t\t\t   throws ServletException, IOException\n    {\n        System.out.println(\"Begin Post Request: \" \n        \t\t\t\t   + request.getRemoteAddr() \n        \t\t\t\t   + \" \" \n        \t\t\t\t   + request.getRequestURI());\n        response.setContentType(CONTENT_TYPE);\n        PrintWriter out = response.getWriter();\n\n        ServletInputStream is = request.getInputStream();\n        byte[] buffer = new byte[64000];\n        int res;\n        StringBuffer sb = new StringBuffer();\n\n        while ((res = is.readLine(buffer, 0, buffer.length)) > 0)\n        {\n            String s = new String(buffer, 0, res, \"ISO8859-1\");\n            sb.append(s);\n        }\n\n        out.print(sb.toString());\n        System.out.println(sb.toString());\n        System.out.println(\"End Post Request\");\n    }\n}\n\n------ \n\nOn receiving a POST request, this servlet reads from the ServletInputStream and \noutputs the characters read to both the ServletOutputStream and System.out.\n\nTo test, Servlet1 can be deployed as part of a webapp (I deployed with the url \npattern /servlet 1 in a webapp called testapp).  An already built webapp \ncontaining Servlet1 can be downloaded from \nhttp://sonic.rsuk.com/~psr/tomcatbug/testapp.war. \n\nTo test, Tomcat 3.2.3 or 3.2.4 needs to be setup with the ajp13 connection \nhandler and then Apache (I used version 1.3.20 on Windows and 1.3.23 on Linux) \nneeds to be setup with mod_jk.  I used the version of mod_jk that came with \nTomcat 3.2.3 and 3.2.4 for tests with the respective Tomcat versions.  I used \nthe following Apache configuration:\n\nLoadModule jk_module modules/mod_jk.dll\nAddModule mod_jk.c\nJkWorkersFile c:/apache/conf/workers.properties\nJkLogFile  logs/jk.log\nJkLogLevel error\nJkMount /testapp/* ajp13\n\nWith Tomcat and Apache started, the standard UNIX telnet program can be used to \nshow the error.  Telnet into the Apache web server port, and make a post \nrequest like the following, making sure you enter at least one carriage return \nafter the last line of the post request:\n\nPOST /testapp/servlet1 HTTP/1.1\nCookie: JSESSIONID=ldh3f9z3s1\nAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, \napplication/msword, */*\nCache-Control: no-cache\nAccept-Language: en-gb\nUser-Agent: Test\nContent-type: application/x-www-form-urlencoded\nContent-length: 221\nHost: localhost\n\n\nThe key to causing the error seems to be making the Content-length header \nlarger than the actual length of posted data.\n\nAfter entering the post headers and moving to the start of a new blank row, \npress Ctrl+] and type quit to close the connection.  The test servlet will \nprint output like the following on standard output:\n\nBegin Post Request: xxx.xxx.xxx.xxx /testapp/servlet1\nHTTP/1.1  &#9668;/testapp/servlet1  &#9835;62.254.201.100           localhost  Q\u00e1&#9786; \nLimage/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/msword, */* &#9830; \n&#9827;en-gb cache-control no-cache  &#9829;221 \u00e1 !application/x-www-form-u\nEnd Post Request\n\nThe text printed between the begin and end post request lines is what was read \nfrom the ServletInputStream.\n\nWhen making the request using the ajp12 connector, the request is not forwarded \nto the servlet.  When making the request through Tomcat's HTTP connector, \nTomcat shows an IOException on the console and does not forward the request to \nthe servlet.\n\nIf a non-empty, but under-length request is made, the valid part of the request \ncan be read from the input stream, followed by garbage data.\n\nThe behaviour of Tomcat 3.3a is similar to 3.2.3 and 3.2.4.  Tomcat's ajp12 and \nHTTP connectors behave the same \u2013 ignoring invalid POST requests.  Tomcat \n3.3a's ajp13 connector places all input sent on the ServletInputStream.", "id": 10484, "time": "2002-02-08T10:06:37Z", "bug_id": 6324, "creation_time": "2002-02-08T10:06:37Z", "is_private": false}, {"count": 1, "tags": [], "creator": "philip@rsuk.com", "attachment_id": 1148, "id": 10485, "creation_time": "2002-02-08T10:08:12Z", "time": "2002-02-08T10:08:12Z", "bug_id": 6324, "text": "Created attachment 1148\nServlet that can be used to reproduce the bug.", "is_private": false}, {"count": 2, "tags": [], "creator": "philip@rsuk.com", "attachment_id": 1149, "text": "Created attachment 1149\nWebapp that can be used to reproduce the bug.", "id": 10486, "time": "2002-02-08T10:08:35Z", "bug_id": 6324, "creation_time": "2002-02-08T10:08:35Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 6324, "attachment_id": null, "id": 17785, "time": "2002-06-14T10:42:52Z", "creator": "hgomez@slib.fr", "creation_time": "2002-06-14T10:42:52Z", "is_private": false, "text": "Tested with latest mod_jk 1.2.0 from JTC against\napache 1.3.24+mod_ssl 2.8.8 and apache 2.0.36 \nand the behaviour is correct, ie the servlet didn't\nget the request.\n\n"}]