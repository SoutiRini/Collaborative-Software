[{"count": 0, "tags": [], "creator": "stefan.schumacher@ids-scheer.com", "text": "Hello,\n\nwithin my action code I try to transfer my png files to browser using getResponse().getOutputStream()). \n\nprotected ActionForward executeInternal() throws Exception {\n\n        FileInputStream in = null;\n        ServletOutputStream out = null;\n        try {\n            String sFileName = getRequest().getParameter(\"img\");\n            long length = new File(sFileName).length();\n            getResponse().setContentType(\"image/png\");\n            getResponse().setContentLength((int) length);\n\n            in = new FileInputStream(sFileName);\n            out = getResponse().getOutputStream();\n\n            if (length > Integer.MAX_VALUE) {\n                ABPLogger.getErrorLogger().severe(\"**File is too large\");\n                byte[] buf = new byte[4096];\n                int len;\n                while( (len = in.read(buf)) > 0 ) {\n                    out.write(buf, 0, len);\n                }\n            }\n            else {\n                //Read/Write out in one block!!!!\n                byte[] bytes = new byte[(int) length];\n                in.read(bytes);\n                out.write(bytes);\n            }\n        } catch (Exception ex) {\n           getErrorLogger().severe(\"**TomCat streaming problem!!!!!\");\n           ex.printStackTrace();\n        } finally {\n            ABPResourceHelper.close(in);\n        }\n        return null;\n    }\n\n\nBut very often following excpetion occurs.\n\njIT_121c9dc019d_SEVERE 2009-06-10T14:09:47,293 java.lang.System.arraycopy\nVersion 7.1.0.${p4.changelist}\nStruts Action.execute() returns no ActionForward.\nQuery: /modelgraphic.do?IDSConversationID=ID_5&img=NSN%20approvedffffffffd623bca8409/c967fee0-46be-11de-27ff-001e0b6f107a_100.png\n\njava.lang.ArrayIndexOutOfBoundsException\n        at java.lang.System.arraycopy(Native Method)\n\tat org.apache.tomcat.util.buf.ByteChunk.append(ByteChunk.java:346)\n\tat org.apache.catalina.connector.OutputBuffer.writeBytes(OutputBuffer.java:381)\n\tat org.apache.catalina.connector.OutputBuffer.write(OutputBuffer.java:370)\n\tat org.apache.catalina.connector.CoyoteOutputStream.write(CoyoteOutputStream.java:89)\n\nWithin a second try it works well. What can I do to prevent this effect?\n\nThanks\nStefan", "id": 131567, "time": "2009-11-02T05:36:17Z", "bug_id": 48105, "creation_time": "2009-11-02T05:36:17Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 48105, "is_private": false, "count": 1, "id": 131582, "time": "2009-11-02T10:45:50Z", "creator": "bugzilla@pidster.com", "creation_time": "2009-11-02T10:45:50Z", "text": "You seem to be having a problem with your code - I don't think you're reporting an actual bug with Tomcat.\n\nThe Tomcat Users mailing list is the proper place to get help, please ask there."}, {"attachment_id": null, "tags": [], "bug_id": 48105, "is_private": false, "count": 2, "id": 131606, "time": "2009-11-02T17:06:06Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2009-11-02T17:06:06Z", "text": "(In reply to comment #0)\n> java.lang.ArrayIndexOutOfBoundsException\n>         at java.lang.System.arraycopy(Native Method)\n>     at org.apache.tomcat.util.buf.ByteChunk.append(ByteChunk.java:346)\n>     at\n> org.apache.catalina.connector.OutputBuffer.writeBytes(OutputBuffer.java:381)\n>     at org.apache.catalina.connector.OutputBuffer.write(OutputBuffer.java:370)\n>     at\n> org.apache.catalina.connector.CoyoteOutputStream.write(CoyoteOutputStream.java:89)\n> \n\nWhat Tomcat version are you using?\nThe line numbers in your stack trace do not match Tomcat 5.5.28 sources.\n\nI think that TC version that you are using is 5.5.20 or earlier. There were a lot of changes since then."}, {"count": 3, "tags": [], "bug_id": 48105, "attachment_id": null, "text": "Thanks you very much for your reply. Similar effect is also reproducable with TomCat 6.0.18 (20). But I will check this.\n\nThanks\nStefan", "id": 131609, "time": "2009-11-02T22:26:37Z", "creator": "stefan.schumacher@ids-scheer.com", "creation_time": "2009-11-02T22:26:37Z", "is_private": false}, {"count": 4, "tags": [], "creator": "stefan.schumacher@ids-scheer.com", "attachment_id": null, "id": 131666, "time": "2009-11-03T22:53:43Z", "bug_id": 48105, "creation_time": "2009-11-03T22:53:43Z", "is_private": false, "text": "Can it be that the effect has something to do with mod_jk?\n\nThanks\nStefan"}, {"count": 5, "tags": [], "text": "> Can it be that the effect has something to do with mod_jk?\n\nDo not know. At least, I know that the following exists in the code:\nin o.a.catalina.connector.Response#setConnector() of tc5.5.z:\n\n133:        if (\"AJP/1.3\".equals(connector.getProtocol())) {\n134:            // default size to size of one ajp-packet\n135:            // Reduce HSIZE and Command = 6 Bytes\n136:            outputBuffer = new OutputBuffer(8184);\n137:        } else {\n138:            outputBuffer = new OutputBuffer();\n139:        }\n\nThe default limit on size of OutputBuffer is 8*1024 = 8192 bytes. With AJP it is 8184 bytes.\n\nStill, I would like to see a stacktrace from a more recent version of Tomcat 5.5 or 6.0.\n\nKnowing the size of that c967fee0-46be-11de-27ff-001e0b6f107a_100.png or other files that fail might also be a hint.", "attachment_id": null, "bug_id": 48105, "id": 131667, "time": "2009-11-03T23:55:26Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2009-11-03T23:55:26Z", "is_private": false}, {"count": 6, "tags": [], "creator": "stefan.schumacher@ids-scheer.com", "attachment_id": null, "is_private": false, "id": 131668, "time": "2009-11-04T00:26:51Z", "bug_id": 48105, "creation_time": "2009-11-04T00:26:51Z", "text": "Enclosed a call stack using mod_jk...additional stacktrace using Tomcat 6.* will be delivered today.\n\nT_1223033e029_SEVERE 2009-06-30T11:07:01,929 java.lang.System.arraycopy\n  Version 7.1.0.${p4.changelist}\nAdditional information: \nServletOutputStream.write\n\n  Exception class: class java.lang.ArrayIndexOutOfBoundsException\n  HttpServletResponse getBufferSize: 8184\n  HttpServletResponse getCharacterEncoding: UTF-8\n  HttpServletResponse getContentType: image/png;charset=UTF-8\n  HttpServletResponse getLocale: en_US\n  FileInputStream class: class java.io.FileInputStream\n  FileInputStream toString: java.io.FileInputStream@1bf446e\n  FileInputStream available: 21302\n  ServletOutputStream class: class org.apache.catalina.connector.CoyoteOutputStream\n  ServletOutputStream toString: org.apache.catalina.connector.CoyoteOutputStream@25a311\n  len: 4096\nQuery: /businesspublisher/modelgraphic.do?IDSConversationID=ID_1&img=NSN%20approvedffffffffe82360d3409/dd0cecf1-2fed-11de-27ff-001e0b6f107a_100.png\njava.lang.ArrayIndexOutOfBoundsException\n\tat java.lang.System.arraycopy(Native Method)\n\tat org.apache.jk.common.MsgAjp.cpBytes(MsgAjp.java:199)\n\tat org.apache.jk.common.MsgAjp.appendBytes(MsgAjp.java:187)\n\tat org.apache.jk.common.JkInputStream.doWrite(JkInputStream.java:154)\n\tat org.apache.coyote.Response.doWrite(Response.java:560)\n\tat org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:353)\n\tat org.apache.tomcat.util.buf.ByteChunk.flushBuffer(ByteChunk.java:434)\n\tat org.apache.tomcat.util.buf.ByteChunk.append(ByteChunk.java:349)\n\tat org.apache.catalina.connector.OutputBuffer.writeBytes(OutputBuffer.java:381)\n\tat org.apache.catalina.connector.OutputBuffer.write(OutputBuffer.java:370)\n\tat org.apache.catalina.connector.CoyoteOutputStream.write(CoyoteOutputStream.java:89)\n\tat com.idsscheer.aris.businesspublisher.actions.AClusterModelGraphicAction.executeInternal(AClusterModelGraphicAction.java:44)\n\tat com.idsscheer.aris.businesspublisher.actions.ABPLayoutBaseAction.executeImpl(ABPLayoutBaseAction.java:36)\n\tat com.idsscheer.aris.businesspublisher.actions.BaseAction.execute(BaseAction.java:273)\n\tat org.apache.struts.action.RequestProcessor.processActionPerform(RequestProcessor.java:431)\n\tat org.apache.struts.action.RequestProcessor.process(RequestProcessor.java:236)\n\tat org.apache.struts.action.ActionServlet.process(ActionServlet.java:1196)\n\tat org.apache.struts.action.ActionServlet.doGet(ActionServlet.java:414)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:617)\n\n\nthanks\nStefan"}, {"count": 7, "tags": [], "text": "com.idsscheer.aris.businesspublisher.actions.AClusterModelGraphicAction.executeInternal(AClusterModelGraphicAction.java:44)\n\nWhat is at line 44 in your code?", "is_private": false, "id": 132289, "creator": "bugzilla@pidster.com", "time": "2009-11-24T15:33:53Z", "bug_id": 48105, "creation_time": "2009-11-24T15:33:53Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 48105, "attachment_id": null, "text": "A reproducible test case would help considerably with investigating this issue. Please ensure that the test case displays the error with the latest versions of Tomcat and mod_jk\n\nOne thing to try that may shed some light is enabling trace level logging for org.apache.jk.common.JkInputStream", "id": 134144, "time": "2010-02-02T08:32:52Z", "creator": "markt@apache.org", "creation_time": "2010-02-02T08:32:52Z", "is_private": false}, {"count": 9, "tags": [], "text": "Ping. Any updates? Bugs we can't reproduce that show no sign of activity will eventually get closed as invalid or wontfix.", "attachment_id": null, "id": 135649, "creator": "markt@apache.org", "time": "2010-03-25T22:53:23Z", "bug_id": 48105, "creation_time": "2010-03-25T22:53:23Z", "is_private": false}, {"count": 10, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 135729, "time": "2010-03-28T19:45:51Z", "bug_id": 48105, "creation_time": "2010-03-28T19:45:51Z", "text": "Analysis received off-list from Jonathan Leech:\n\nThe issue is in the following block:\n            else {\n                //Read/Write out in one block!!!!\n                byte[] bytes = new byte[(int) length];\n                in.read(bytes);\n                out.write(bytes);\n            } \nread() returns the actual number of bytes read, which can be less than\nthe length of the byte array.\nThe content length is set to the full length, and there aren't as many\nbytes as that in the actual response.\nThe actual error produced is downstream, caused by the above invalid\ncondition.\n\n\nJonathan's analysis looks good to me."}]