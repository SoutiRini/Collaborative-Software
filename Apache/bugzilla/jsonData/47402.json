[{"count": 0, "tags": [], "bug_id": 47402, "attachment_id": null, "id": 128149, "time": "2009-06-22T09:20:56Z", "creator": "fpires82@gmail.com", "creation_time": "2009-06-22T09:20:56Z", "is_private": false, "text": "Hi, I'm trying to setup a cluster. I followed the official how-to. It works fine, the sessions are replicated and if I take a node out of the cluster using jk_mod, I can still browse the site logged in without problems. Further more, If I kill -9 the tomcat, the session doesn't expire and I can still use the other node without having to authenticate again. The problem is If I shutdown the tomcat server, I don't know this is the expected behavior, but giving that there is a \"expireSessionsOnShutdown\" option, I assume it's not. I tried looking everywhere in google, and couldn't find what I'm doing wrong. The cluster is at the engine level. This is my server.xml:\n\n <Cluster className=\"org.apache.catalina.ha.tcp.SimpleTcpCluster\"\n                 channelSendOptions=\"6\">\n\n          <Manager className=\"org.apache.catalina.ha.session.DeltaManager\"\n                   expireSessionsOnShutdown=\"false\"\n                   notifyListenersOnReplication=\"true\"/>\n\n          <Channel className=\"org.apache.catalina.tribes.group.GroupChannel\">\n            <Membership className=\"org.apache.catalina.tribes.membership.McastService\"\n                        address=\"228.0.0.4\"\n                        port=\"45564\"\n                        frequency=\"500\"\n                        dropTime=\"3000\"/>\n            <Receiver className=\"org.apache.catalina.tribes.transport.nio.NioReceiver\"\n                      address=\"10.220.0.65\"\n                      port=\"5000\"\n                      selectorTimeout=\"100\"\n                      maxThreads=\"6\"/>\n\n            <Sender className=\"org.apache.catalina.tribes.transport.ReplicationTransmitter\">\n              <Transport className=\"org.apache.catalina.tribes.transport.nio.PooledParallelSender\"/>\n            </Sender>\n            <Interceptor className=\"org.apache.catalina.tribes.group.interceptors.TcpFailureDetector\"/>\n            <Interceptor className=\"org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor\"/>\n            <Interceptor className=\"org.apache.catalina.tribes.group.interceptors.ThroughputInterceptor\"/>\n          </Channel>\n\n          <Valve className=\"org.apache.catalina.ha.tcp.ReplicationValve\"\n                 filter=\".*\\.gif;.*\\.js;.*\\.jsp;.*\\.jpg;.*\\.png;.*\\.htm;.*\\.html;.*\\.css;.*\\.txt;\"/>\n<!--\n          <Deployer className=\"org.apache.catalina.ha.deploy.FarmWarDeployer\"\n                    tempDir=\"/tmp/war-temp/\"\n                    deployDir=\"/tmp/war-deploy/\"\n                    watchDir=\"/tmp/war-listen/\"\n                    watchEnabled=\"false\"/>\n-->\n        <Valve className=\"org.apache.catalina.ha.session.JvmRouteBinderValve\"/>\n\n          <ClusterListener className=\"org.apache.catalina.ha.session.JvmRouteSessionIDBinderListener\"/>\n          <ClusterListener className=\"org.apache.catalina.ha.session.ClusterSessionListener\"/>\n        </Cluster>\n\n\nAnd this is what happens when I shutdown the server:\n\nJun 22, 2009 4:11:44 PM org.apache.catalina.ha.session.DeltaManager stop\nINFO: Manager [localhost#] expiring sessions upon shutdown\n\n\nAnd that happens with every webapp."}, {"count": 1, "tags": [], "bug_id": 47402, "attachment_id": null, "text": "hi Federico,\nthis is intended behavior. The code looks like\n\n        // Expire all active sessions\n        if (log.isInfoEnabled()) log.info(sm.getString(\"deltaManager.expireSessions\", getName()));\n        Session sessions[] = findSessions();\n        for (int i = 0; i < sessions.length; i++) {\n            DeltaSession session = (DeltaSession) sessions[i];\n            if (!session.isValid())\n                continue;\n            try {\n                session.expire(true, isExpireSessionsOnShutdown());\n            } catch (Throwable ignore) {\n                // Ignore\n            } \n        }\n\nThat flag means it wont propagate the \"expire\" to the other nodes in the cluster\nBut local sessions will always expire upon a graceful shutdown\n\nbest\nFilip", "id": 128150, "time": "2009-06-22T09:46:54Z", "creator": "fhanik@apache.org", "creation_time": "2009-06-22T09:46:54Z", "is_private": false}, {"count": 2, "tags": [], "creator": "fpires82@gmail.com", "attachment_id": null, "is_private": false, "id": 128152, "time": "2009-06-22T10:02:33Z", "bug_id": 47402, "creation_time": "2009-06-22T10:02:33Z", "text": "(In reply to comment #1)\n> hi Federico,\n> this is intended behavior. The code looks like\n> \n>         // Expire all active sessions\n>         if (log.isInfoEnabled())\n> log.info(sm.getString(\"deltaManager.expireSessions\", getName()));\n>         Session sessions[] = findSessions();\n>         for (int i = 0; i < sessions.length; i++) {\n>             DeltaSession session = (DeltaSession) sessions[i];\n>             if (!session.isValid())\n>                 continue;\n>             try {\n>                 session.expire(true, isExpireSessionsOnShutdown());\n>             } catch (Throwable ignore) {\n>                 // Ignore\n>             } \n>         }\n> \n> That flag means it wont propagate the \"expire\" to the other nodes in the\n> cluster\n> But local sessions will always expire upon a graceful shutdown\n> \n> best\n> Filip\n\nThanks Filip. Really sorry for this bug then. I will check why is the session being expired in the other nodes.\n\nRegards,"}]