[{"count": 0, "tags": [], "creator": "omenelle@gmail.com", "attachment_id": null, "text": "Get IndexOutOfBoundsException while creating Excel with data grouping\n\n\nHello!\nI'm trying to create Excel with data grouping.\nCould you please clarify why I get IndexOutOfBoundsException?\n\nThere is a simple test attached to create Excel with data grouping.\nWhen it groups rows in reverse order (starting from the last row) it works\nok\nWhen I change it to natural order (starting from the first row) - it throws\nIndexOutOfBoundsException.\n\nStacktrace:Exception in thread \"main\" java.lang.IndexOutOfBoundsException\n    at org.apache.xmlbeans.impl.store.Xobj.remove_attribute(Xobj.java:2287)\n    at\norg.openxmlformats.schemas.spreadsheetml.x2006.main.impl.CTRowImpl.unsetCollapsed(Unknown\nSource)\n    at\norg.apache.poi.xssf.usermodel.XSSFSheet.expandRow(XSSFSheet.java:1870)\n    at\norg.apache.poi.xssf.usermodel.XSSFSheet.setRowGroupCollapsed(XSSFSheet.java:1780)\n    at CreateExcel.fillData(CreateExcel.java:49)\n    at CreateExcel.create(CreateExcel.java:22)\n\n\n\t\nI'm using:\njdk1.6.0_25, 32 bit\npoi 3.5 final (but I tried the latest release too)\nxmlbeans-2.3.0\n\n\n\n\n\n\n\nSee test below. There are several lines marked with 'natural order' or\n'reverse order', you can switch grouping order by commenting/uncommenting\nthem\n\n\n\nimport java.io.FileNotFoundException;\nimport java.io.FileOutputStream;\nimport java.io.IOException;\n\nimport org.apache.poi.xssf.usermodel.*;\nimport org.apache.poi.ss.usermodel.*;\n\npublic class CreateExcel {\n    private static final int ROWS_NUMBER = 200;\n    private static final int GROUP_SIZE = 5;\n\n    private final String o_filename;\n    private int o_groupsNumber = 0;\n\n    public CreateExcel(String p_filename) {\n        o_filename = p_filename;\n    }\n\n    public void create() {\n        long startTime = System.currentTimeMillis();\n        Workbook wb = new XSSFWorkbook();\n        fillData(wb);\n        writeToFile(wb);\n\n        System.out.println(\"Number of groups: \" + o_groupsNumber);\n        System.out.println(\"Execution time: \" +\n(System.currentTimeMillis()-startTime) + \" ms\");\n    }\n\n\n    private void fillData(Workbook p_wb) {\n        Sheet sheet = p_wb.createSheet(\"sheet123\");\n        sheet.setRowSumsBelow(false);\n\n        for (int i = 0; i < ROWS_NUMBER; i++) {\n            Row row = sheet.createRow(i);\n            Cell cell = row.createCell(0);\n            cell.setCellValue(i+1);\n        }\n\n        int i = 1;\n        while (i < ROWS_NUMBER) {\n            int end = i+(GROUP_SIZE-2);\n            int start = i;                    // natural order\n//            int start = end - 1;                // reverse order\n            while (start < end) {             // natural order\n//                while (start >= i) {            // reverse order\n                sheet.groupRow(start, end);\n                o_groupsNumber++;\n                sheet.setRowGroupCollapsed(start, isCollapsed());\n                start++;                      // natural order\n//                start--;                        // reverse order\n            }\n            i += GROUP_SIZE;\n        }\n    }\n\n    private boolean isCollapsed() {\n        return Math.random() > 0.05d;\n    }\n\n    private void writeToFile(Workbook p_wb) {\n        FileOutputStream fileOut = null;\n        try {\n            fileOut = new FileOutputStream(o_filename);\n        } catch (FileNotFoundException e) {\n            e.printStackTrace();\n        }\n        try {\n            p_wb.write(fileOut);\n        } catch (IOException e) {\n            e.printStackTrace();\n        }\n        try {\n            if (fileOut != null) {\n                fileOut.close();\n            }\n        } catch (IOException e) {\n            e.printStackTrace();\n        }\n    }\n\n\n    public static void main(String[] args) {\n        CreateExcel createExcel = new CreateExcel(\"K://workbook.xlsx\");\n        createExcel.create();\n    }\n}", "id": 170482, "time": "2013-10-08T09:12:01Z", "bug_id": 55640, "creation_time": "2013-10-08T09:12:01Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 55640, "text": "I tried to work on this and found one smaller issue in XSSFSheet.writeHidden(), it will start at row 0 instead of skipping to the start of the group, however this does not fix all broken cases, the issue seems to be that we write to the additional row multiple times if there are nested groups with the same end-row used and unsetting the collapsed state on the internal structures twice is not possible.\n\nI think we need to take another look at how the spec defines how groups are stored, there seems to be some difference between what POI writes and what other applications write, at least some sample files did behave strange in LibreOffice (no MS Office available right now...).", "id": 171404, "time": "2013-11-22T22:11:42Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2013-11-22T22:11:42Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 55640, "text": "Thank you for reply. \nCould you please make estimations on how long may it take?\nIs it possible to speed up the process by sponsoring from our side? We use the library in our project and fixing data grouping is critical for us at the moment.", "id": 171439, "time": "2013-11-25T13:13:38Z", "creator": "omenelle@gmail.com", "creation_time": "2013-11-25T13:13:38Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "dominik.stadler@gmx.at", "is_private": false, "text": "I have committed two things in r1547153:\n* Fix invalid calculation of start-row when setting rows hidden\n* Avoid IndexOutOfBoundsException when nested groups which end on the same row are all set to collapsed\n\nThis at least makes your test run without throwing Exceptions. \n\nI fear there might be additional cases where the resulting Excel file is not completely correct with collapsed/hidden state, but I just could not get my head around the spec far enough to fix it, especially as LibreOffice seems to behave a bit different to POI and Excel so I am not sure what the best way to handle things are.\n\nI have at least added unit tests to record the current behavior and to allow us to see which cases are affected by future fixes. \n\nPlease report separate bugs with description how to create them or sample Excel files and the expected results so we can continue to work on this.", "id": 171535, "time": "2013-12-02T19:19:21Z", "bug_id": 55640, "creation_time": "2013-12-02T19:19:21Z", "attachment_id": null}]