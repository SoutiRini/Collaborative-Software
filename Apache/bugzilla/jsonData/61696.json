[{"count": 0, "tags": [], "bug_id": 61696, "attachment_id": 35475, "id": 201782, "time": "2017-10-30T09:02:06Z", "creator": "robert.gherlan@museglobal.ro", "creation_time": "2017-10-30T09:02:06Z", "is_private": false, "text": "Created attachment 35475\nProject used to reproduce the security violation error.\n\nWhen run Tomcat 8.5.23 with SecurityManager and a servlet or a JSP page try to initialize a ScriptManager, then a security violation message is thrown on catalina log:\norg.apache.catalina.loader.WebappClassLoaderBase.loadClass Security Violation, attempt to use Restricted Class: jdk.internal.dynalink.support.messages\n java.security.AccessControlException: access denied (\"java.lang.RuntimePermission\" \"accessClassInPackage.jdk.internal.dynalink.support\")\n \n${catalina.home}/conf/catalina.policy file contains:\ngrant {\n  permission java.lang.RuntimePermission \"accessClassInPackage.jdk.internal.dynalink.support\";\n}; \nSame error is thrown if the following lines are present:\ngrant {\n  permission java.security.AllPermission;\n};\n\n\nSame error is reproducible in Tomcat 7, 8, 9, but is not present in Tomcat 6.\n\nThe test was made using JDK 1.8.0_144.\n\nIn order to reproduce this error, we build a short example(see ScriptManager.war in attachment) containing a simple servlet with the following source code:\n\npackage servlet;\n\nimport java.io.IOException;\nimport java.io.PrintWriter;\n\nimport javax.script.ScriptEngine;\nimport javax.script.ScriptEngineManager;\nimport javax.script.ScriptException;\nimport javax.servlet.ServletException;\nimport javax.servlet.annotation.WebServlet;\nimport javax.servlet.http.HttpServlet;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\n\n@WebServlet(\"/\")\npublic class MyServlet extends HttpServlet {\n\n  private static final long serialVersionUID = -1647039991464261998L;\n\n  @Override\n  protected void doGet(HttpServletRequest reqest, HttpServletResponse response) throws ServletException, IOException {\n    ScriptEngineManager scriptMgr = new ScriptEngineManager();\n    ScriptEngine scriptEngine = scriptMgr.getEngineByName(\"JavaScript\");\n    PrintWriter out = response.getWriter();\n    String name = \"Print function is called.\";\n    try {\n      scriptEngine.eval(\"print('\" + name + \"')\");\n    } catch (ScriptException e) {\n      out.println(\"Error executing script: \" + e.getMessage());\n    }\n    out.println(\"Successfully loaded.\");\n  }\n}\n\nSteps to reproduce:\n1) Deploy the provided ScriptManager.war web project (which also includes in the archive the source code) in ${catalina.home}/webapps folder.\n\n2) You can add in ${catalina.home}/conf/catalina.policy file the following lines:\n\ngrant {\n  permission java.security.AllPermission;\n};\n\nbut it will not work in this case either.\n\n3) Start server with SecurityManager:\ncatalina.bat run -security\n\n4) Access the following page: http://localhost:8080/ScriptManager/\n\nNow the following stacktrace is thrown on catalina log:\n\n30-Oct-2017 09:55:31.808 INFO [http-nio-8000-exec-2] org.apache.catalina.loader.WebappClassLoaderBase.loadClass Security Violation, attempt to use Restricted Class: jdk.internal.dynalink.support.messages\n java.security.AccessControlException: access denied (\"java.lang.RuntimePermission\" \"accessClassInPackage.jdk.internal.dynalink.support\")\n\tat java.security.AccessControlContext.checkPermission(AccessControlContext.java:472)\n\tat java.security.AccessController.checkPermission(AccessController.java:884)\n\tat java.lang.SecurityManager.checkPermission(SecurityManager.java:549)\n\tat java.lang.SecurityManager.checkPackageAccess(SecurityManager.java:1564)\n\tat org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1226)\n\tat org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1119)\n\tat java.util.ResourceBundle$Control.newBundle(ResourceBundle.java:2640)\n\tat java.util.ResourceBundle.loadBundle(ResourceBundle.java:1501)\n\tat java.util.ResourceBundle.findBundle(ResourceBundle.java:1465)\n\tat java.util.ResourceBundle.findBundle(ResourceBundle.java:1419)\n\tat java.util.ResourceBundle.findBundle(ResourceBundle.java:1419)\n\tat java.util.ResourceBundle.getBundleImpl(ResourceBundle.java:1361)\n\tat java.util.ResourceBundle.getBundle(ResourceBundle.java:1082)\n\tat java.util.logging.Logger.findResourceBundle(Logger.java:1880)\n\tat java.util.logging.Logger.setupResourceInfo(Logger.java:1941)\n\tat java.util.logging.Logger.<init>(Logger.java:380)\n\tat java.util.logging.LogManager.demandLogger(LogManager.java:554)\n\tat java.util.logging.Logger.demandLogger(Logger.java:455)\n\tat java.util.logging.Logger.getLogger(Logger.java:553)\n\tat jdk.internal.dynalink.support.Guards.<clinit>(Guards.java:101)\n\tat jdk.nashorn.internal.runtime.Undefined.<clinit>(Undefined.java:51)\n\tat jdk.nashorn.internal.runtime.ScriptRuntime.<clinit>(ScriptRuntime.java:72)\n\tat jdk.nashorn.internal.objects.Global.<clinit>(Global.java:193)\n\tat jdk.nashorn.internal.runtime.Context.newGlobal(Context.java:1111)\n\tat jdk.nashorn.api.scripting.NashornScriptEngine$2.run(NashornScriptEngine.java:350)\n\tat jdk.nashorn.api.scripting.NashornScriptEngine$2.run(NashornScriptEngine.java:346)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat jdk.nashorn.api.scripting.NashornScriptEngine.createNashornGlobal(NashornScriptEngine.java:346)\n\tat jdk.nashorn.api.scripting.NashornScriptEngine.<init>(NashornScriptEngine.java:143)\n\tat jdk.nashorn.api.scripting.NashornScriptEngineFactory.getScriptEngine(NashornScriptEngineFactory.java:148)\n\tat javax.script.ScriptEngineManager.getEngineByName(ScriptEngineManager.java:238)\n\tat servlet.MyServlet.doGet(MyServlet.java:26)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:635)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:742)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:282)\n\tat org.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:279)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAsPrivileged(Subject.java:549)\n\tat org.apache.catalina.security.SecurityUtil.execute(SecurityUtil.java:314)\n\tat org.apache.catalina.security.SecurityUtil.doAsPrivilege(SecurityUtil.java:170)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:225)\n\tat org.apache.catalina.core.ApplicationFilterChain.access$000(ApplicationFilterChain.java:47)\n\tat org.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:149)\n\tat org.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:145)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)\n\tat org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:282)\n\tat org.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:279)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAsPrivileged(Subject.java:549)\n\tat org.apache.catalina.security.SecurityUtil.execute(SecurityUtil.java:314)\n\tat org.apache.catalina.security.SecurityUtil.doAsPrivilege(SecurityUtil.java:253)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:191)\n\tat org.apache.catalina.core.ApplicationFilterChain.access$000(ApplicationFilterChain.java:47)\n\tat org.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:149)\n\tat org.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:145)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:199)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:96)\n\tat org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:478)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:140)\n\tat com.edulib.muse.tomcat.valves.ErrorReportValve.invoke(ErrorReportValve.java:115)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:87)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:342)\n\tat org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:803)\n\tat org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66)\n\tat org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:868)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1459)\n\tat org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\tat org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n\tat java.lang.Thread.run(Thread.java:748)\n\n30-Oct-2017 09:55:31.809 INFO [http-nio-8000-exec-2] org.apache.catalina.loader.WebappClassLoaderBase.loadClass Security Violation, attempt to use Restricted Class: jdk.internal.dynalink.support.messages_en\n java.security.AccessControlException: access denied (\"java.lang.RuntimePermission\" \"accessClassInPackage.jdk.internal.dynalink.support\")\n\tat java.security.AccessControlContext.checkPermission(AccessControlContext.java:472)\n\tat java.security.AccessController.checkPermission(AccessController.java:884)\n\tat java.lang.SecurityManager.checkPermission(SecurityManager.java:549)\n\tat java.lang.SecurityManager.checkPackageAccess(SecurityManager.java:1564)\n\tat org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1226)\n\tat org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1119)\n\tat java.util.ResourceBundle$Control.newBundle(ResourceBundle.java:2640)\n\tat java.util.ResourceBundle.loadBundle(ResourceBundle.java:1501)\n\tat java.util.ResourceBundle.findBundle(ResourceBundle.java:1465)\n\tat java.util.ResourceBundle.findBundle(ResourceBundle.java:1419)\n\tat java.util.ResourceBundle.getBundleImpl(ResourceBundle.java:1361)\n\tat java.util.ResourceBundle.getBundle(ResourceBundle.java:1082)\n\tat java.util.logging.Logger.findResourceBundle(Logger.java:1880)\n\tat java.util.logging.Logger.setupResourceInfo(Logger.java:1941)\n\tat java.util.logging.Logger.<init>(Logger.java:380)\n\tat java.util.logging.LogManager.demandLogger(LogManager.java:554)\n\tat java.util.logging.Logger.demandLogger(Logger.java:455)\n\tat java.util.logging.Logger.getLogger(Logger.java:553)\n\tat jdk.internal.dynalink.support.Guards.<clinit>(Guards.java:101)\n\tat jdk.nashorn.internal.runtime.Undefined.<clinit>(Undefined.java:51)\n\tat jdk.nashorn.internal.runtime.ScriptRuntime.<clinit>(ScriptRuntime.java:72)\n\tat jdk.nashorn.internal.objects.Global.<clinit>(Global.java:193)\n\tat jdk.nashorn.internal.runtime.Context.newGlobal(Context.java:1111)\n\tat jdk.nashorn.api.scripting.NashornScriptEngine$2.run(NashornScriptEngine.java:350)\n\tat jdk.nashorn.api.scripting.NashornScriptEngine$2.run(NashornScriptEngine.java:346)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat jdk.nashorn.api.scripting.NashornScriptEngine.createNashornGlobal(NashornScriptEngine.java:346)\n\tat jdk.nashorn.api.scripting.NashornScriptEngine.<init>(NashornScriptEngine.java:143)\n\tat jdk.nashorn.api.scripting.NashornScriptEngineFactory.getScriptEngine(NashornScriptEngineFactory.java:148)\n\tat javax.script.ScriptEngineManager.getEngineByName(ScriptEngineManager.java:238)\n\tat servlet.MyServlet.doGet(MyServlet.java:26)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:635)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:742)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:282)\n\tat org.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:279)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAsPrivileged(Subject.java:549)\n\tat org.apache.catalina.security.SecurityUtil.execute(SecurityUtil.java:314)\n\tat org.apache.catalina.security.SecurityUtil.doAsPrivilege(SecurityUtil.java:170)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:225)\n\tat org.apache.catalina.core.ApplicationFilterChain.access$000(ApplicationFilterChain.java:47)\n\tat org.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:149)\n\tat org.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:145)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)\n\tat org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:282)\n\tat org.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:279)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAsPrivileged(Subject.java:549)\n\tat org.apache.catalina.security.SecurityUtil.execute(SecurityUtil.java:314)\n\tat org.apache.catalina.security.SecurityUtil.doAsPrivilege(SecurityUtil.java:253)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:191)\n\tat org.apache.catalina.core.ApplicationFilterChain.access$000(ApplicationFilterChain.java:47)\n\tat org.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:149)\n\tat org.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:145)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:199)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:96)\n\tat org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:478)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:140)\n\tat com.edulib.muse.tomcat.valves.ErrorReportValve.invoke(ErrorReportValve.java:115)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:87)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:342)\n\tat org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:803)\n\tat org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66)\n\tat org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:868)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1459)\n\tat org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\tat org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n\tat java.lang.Thread.run(Thread.java:748)\n\n30-Oct-2017 09:55:31.810 INFO [http-nio-8000-exec-2] org.apache.catalina.loader.WebappClassLoaderBase.loadClass Security Violation, attempt to use Restricted Class: jdk.internal.dynalink.support.messages_en_US\n java.security.AccessControlException: access denied (\"java.lang.RuntimePermission\" \"accessClassInPackage.jdk.internal.dynalink.support\")\n\tat java.security.AccessControlContext.checkPermission(AccessControlContext.java:472)\n\tat java.security.AccessController.checkPermission(AccessController.java:884)\n\tat java.lang.SecurityManager.checkPermission(SecurityManager.java:549)\n\tat java.lang.SecurityManager.checkPackageAccess(SecurityManager.java:1564)\n\tat org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1226)\n\tat org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1119)\n\tat java.util.ResourceBundle$Control.newBundle(ResourceBundle.java:2640)\n\tat java.util.ResourceBundle.loadBundle(ResourceBundle.java:1501)\n\tat java.util.ResourceBundle.findBundle(ResourceBundle.java:1465)\n\tat java.util.ResourceBundle.getBundleImpl(ResourceBundle.java:1361)\n\tat java.util.ResourceBundle.getBundle(ResourceBundle.java:1082)\n\tat java.util.logging.Logger.findResourceBundle(Logger.java:1880)\n\tat java.util.logging.Logger.setupResourceInfo(Logger.java:1941)\n\tat java.util.logging.Logger.<init>(Logger.java:380)\n\tat java.util.logging.LogManager.demandLogger(LogManager.java:554)\n\tat java.util.logging.Logger.demandLogger(Logger.java:455)\n\tat java.util.logging.Logger.getLogger(Logger.java:553)\n\tat jdk.internal.dynalink.support.Guards.<clinit>(Guards.java:101)\n\tat jdk.nashorn.internal.runtime.Undefined.<clinit>(Undefined.java:51)\n\tat jdk.nashorn.internal.runtime.ScriptRuntime.<clinit>(ScriptRuntime.java:72)\n\tat jdk.nashorn.internal.objects.Global.<clinit>(Global.java:193)\n\tat jdk.nashorn.internal.runtime.Context.newGlobal(Context.java:1111)\n\tat jdk.nashorn.api.scripting.NashornScriptEngine$2.run(NashornScriptEngine.java:350)\n\tat jdk.nashorn.api.scripting.NashornScriptEngine$2.run(NashornScriptEngine.java:346)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat jdk.nashorn.api.scripting.NashornScriptEngine.createNashornGlobal(NashornScriptEngine.java:346)\n\tat jdk.nashorn.api.scripting.NashornScriptEngine.<init>(NashornScriptEngine.java:143)\n\tat jdk.nashorn.api.scripting.NashornScriptEngineFactory.getScriptEngine(NashornScriptEngineFactory.java:148)\n\tat javax.script.ScriptEngineManager.getEngineByName(ScriptEngineManager.java:238)\n\tat servlet.MyServlet.doGet(MyServlet.java:26)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:635)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:742)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:282)\n\tat org.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:279)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAsPrivileged(Subject.java:549)\n\tat org.apache.catalina.security.SecurityUtil.execute(SecurityUtil.java:314)\n\tat org.apache.catalina.security.SecurityUtil.doAsPrivilege(SecurityUtil.java:170)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:225)\n\tat org.apache.catalina.core.ApplicationFilterChain.access$000(ApplicationFilterChain.java:47)\n\tat org.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:149)\n\tat org.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:145)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)\n\tat org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:282)\n\tat org.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:279)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAsPrivileged(Subject.java:549)\n\tat org.apache.catalina.security.SecurityUtil.execute(SecurityUtil.java:314)\n\tat org.apache.catalina.security.SecurityUtil.doAsPrivilege(SecurityUtil.java:253)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:191)\n\tat org.apache.catalina.core.ApplicationFilterChain.access$000(ApplicationFilterChain.java:47)\n\tat org.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:149)\n\tat org.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:145)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:199)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:96)\n\tat org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:478)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:140)\n\tat com.edulib.muse.tomcat.valves.ErrorReportValve.invoke(ErrorReportValve.java:115)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:87)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:342)\n\tat org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:803)\n\tat org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66)\n\tat org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:868)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1459)\n\tat org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\tat org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n\tat java.lang.Thread.run(Thread.java:748)"}, {"count": 1, "tags": [], "bug_id": 61696, "attachment_id": null, "text": "Thanks for the test case. It really helped make progress on this one quickly.\n\nI as sure as I can be that this is a Nashorn bug. The creation of the static Logger in jdk.internal.dynalink.support.Guards needs to be in a privileged block.\n\nEverything in the Nashorn environment runs in a sandbox with limited privileges. Stepping through the code I see that, at the point the code tries to create the logger, a ProtectionDomain in place with very minimal privileges.\n\nAs a work-around, try pre-loading the Guards class. You can use the memory leak prevention listener to do this:\n\n<Listener className=\"org.apache.catalina.core.JreMemoryLeakPreventionListener\"\n          classesToInitialize=\"jdk.internal.dynalink.support.Guards\" />\n\n\nI'm marking this as invalid as I believe the root cause lies outside of Tomcat", "id": 201990, "time": "2017-11-08T14:15:00Z", "creator": "markt@apache.org", "creation_time": "2017-11-08T14:15:00Z", "is_private": false}]