[{"count": 0, "tags": [], "bug_id": 55760, "attachment_id": null, "text": "Hi\n\nOur company has a use case in which our domain is a tomcat process. In our code, we support a parallel protocol which uses In memory based jaas configuration - \n\npublic class OurLoginConfiguration extends Configuration\n\nIn IBM JDK 7, we need to initiate using keytab which needs the system property javax.security.auth.useSubjectCredsOnly to be set to true for it to work. However Tomcat sets it in  \n\nInside SpnegoAuthenticator:-\n\n protected void initInternal() throws LifecycleException {\n        super.initInternal();\n\n        // Kerberos configuration file location\n        String krb5Conf = System.getProperty(Constants.KRB5_CONF_PROPERTY);\n        if (krb5Conf == null) {\n            // System property not set, use the Tomcat default\n            File krb5ConfFile = new File(Bootstrap.getCatalinaBase(),\n                    Constants.DEFAULT_KRB5_CONF);\n            System.setProperty(Constants.KRB5_CONF_PROPERTY,\n                    krb5ConfFile.getAbsolutePath());\n        }\n\n        // JAAS configuration file location\n        String jaasConf = System.getProperty(Constants.JAAS_CONF_PROPERTY);\n        if (jaasConf == null) {\n            // System property not set, use the Tomcat default\n            File jaasConfFile = new File(Bootstrap.getCatalinaBase(),\n                    Constants.DEFAULT_JAAS_CONF);\n            System.setProperty(Constants.JAAS_CONF_PROPERTY,\n                    jaasConfFile.getAbsolutePath());\n        }\n        \n        // This property must be false for SPNEGO to work\n        System.setProperty(Constants.USE_SUBJECT_CREDS_ONLY_PROPERTY, \"false\");\n    }\n\nas false in the last line which causes havoc in the code. A multithreaded startup causes a breakdown in further authentication for keytab based logging.\n\n\nNow a little more investigation revealed that tomcat acts only as an acceptor. Now this property need not necessarily be set to false for it to work(in both IBM and SUN JDK). \n\nSource of claim - http://cr.openjdk.java.net/~weijun/special/krb5winguide-2/raw_files/new/kwin\n\nExcerpt:-\n 2. Direct JGSS:\n\n      /* JGSS-API calls... */\n\n       In this case, the JAAS config file's entry name MUST be the\n       standard entry name (com.sun.security.jgss.krb5.initiate), and you\n       must set -Djavax.security.auth.useSubjectCredsOnly=false on the\n       Java command line. Read\n       [26]http://java.sun.com/javase/6/docs/technotes/guides/security/jgs\n       s/tutorials/BasicClientServer.html for details.\nWhich means only initiate based auth needs the system property.\n\nThis is also confirmed in IBM with a sample program.\n\nPROPOSED FIX: COMMENT LAST LINE OF initInternal WHICH SETS THE SYSTEM PROPERTY IN THE FIRST PLACE AS FALSE.", "id": 171142, "time": "2013-11-08T11:48:18Z", "creator": "arunav.sanyal91@gmail.com", "creation_time": "2013-11-08T11:48:18Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 55760, "text": "Hi I am adding an attached fix for complete removal of dependency.", "id": 171154, "time": "2013-11-09T10:11:07Z", "creator": "arunav.sanyal91@gmail.com", "creation_time": "2013-11-09T10:11:07Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "arunav.sanyal91@gmail.com", "attachment_id": 31028, "is_private": false, "id": 171158, "time": "2013-11-09T12:01:01Z", "bug_id": 55760, "creation_time": "2013-11-09T12:01:01Z", "text": "Created attachment 31028\nNew source code"}, {"count": 3, "tags": [], "text": "Proposed patches should be in diff -u format.", "attachment_id": null, "bug_id": 55760, "id": 171168, "time": "2013-11-10T20:29:59Z", "creator": "markt@apache.org", "creation_time": "2013-11-10T20:29:59Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 55760, "attachment_id": null, "is_private": false, "id": 171170, "time": "2013-11-11T06:42:07Z", "creator": "arunav.sanyal91@gmail.com", "creation_time": "2013-11-11T06:42:07Z", "text": "Hi\n\nI am giving the fix in the diff -u format"}, {"count": 5, "tags": [], "bug_id": 55760, "is_private": false, "text": "Created attachment 31030\nProper format of fix\n\ncommand run:- diff -u SpnegoAuthenticator.java SpnegoAuthenticatorModified.java", "id": 171171, "time": "2013-11-11T06:43:11Z", "creator": "arunav.sanyal91@gmail.com", "creation_time": "2013-11-11T06:43:11Z", "attachment_id": 31030}, {"count": 6, "tags": [], "bug_id": 55760, "attachment_id": null, "is_private": false, "id": 171174, "time": "2013-11-11T09:50:47Z", "creator": "markt@apache.org", "creation_time": "2013-11-11T09:50:47Z", "text": "Thanks for the updated patch.\n\nI have confirmed in my test environment that removing this line does not break SPNEGO authentication so I have applied the patch to trunk and 7.0.x. It will be included in 8.0.0-RC6 and 7.0.48 onwards."}]