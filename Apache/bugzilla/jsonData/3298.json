[{"count": 0, "tags": [], "creator": "rstupp@pironet.com", "attachment_id": null, "is_private": false, "id": 4942, "time": "2001-08-28T01:28:54Z", "bug_id": 3298, "creation_time": "2001-08-28T01:28:54Z", "text": "If the client sends large amount of data to the web server \n(EXTENSION_CONTROL_BLOCK.cbTotalBytes > EXTENSION_CONTROL_BLOCK.cbAvailable), \nthe read() method in jk_isapi_plugin.c may unneccessarily call \nEXTENSION_CONTROL_BLOCK.ReadClient, which in turn may lock for seconds against \nWin2000/IIS5.1.\n\nThe following two code changes fix this issue.\n\n\njk_jnicb.c:130 - change if statement to\n    switch(ps->read(ps, nbuf + nfrom, ncnt, &acc)) {\n\tcase 0:\n        jk_log(pl, JK_LOG_ERROR, \n               \"In JNIConnectionHandler::read, failed to read from web \nserver\\n\");\n\t\tbreak;\n    case 1:\n        rc = (jint)acc;\n\t\tbreak;\n\tcase 2:\n\t\tbreak;\n    }\n\n\njk_isapi_plugin:278: change method read to\nstatic int JK_METHOD read(jk_ws_service_t *s,\n                          void *b,\n                          unsigned l,\n                          unsigned *a)\n{\n    jk_log(logger, JK_LOG_DEBUG, \n           \"Into jk_ws_service_t::read\\n\");\n\n    if(s && s->ws_private && b && a) {\n        isapi_private_data_t *p = s->ws_private;\n\n        *a = 0;\n        if(l) {\n            char *buf = b;\n            long already_read = p->lpEcb->cbAvailable - p->bytes_read_so_far;\n\n            if(already_read >= (int)l) {\n                memcpy(buf, p->lpEcb->lpbData + p->bytes_read_so_far, l);\n                p->bytes_read_so_far += l;\n                *a = l;\n            } else {\n                /*\n                 * Try to copy what we already have \n                 */\n                if(already_read > 0) {\n                    memcpy(buf, p->lpEcb->lpbData + p->bytes_read_so_far, \nalready_read);\n                    buf += already_read;\n                    l   -= already_read;\n                    p->bytes_read_so_far = p->lpEcb->cbAvailable;\n                    \n                    *a = already_read;\n\t\t\t\t\treturn 1;\n                }\n\n                /*\n                 * Now try to read from the client ...\n                 */\n\t\t\t\tif(p->lpEcb->cbTotalBytes<=p-\n>bytes_read_so_far) {\n\t\t\t\t\treturn 2;\n\t\t\t\t}\n\t\t\t\tif (l>p->lpEcb->cbTotalBytes-p-\n>bytes_read_so_far)\n\t\t\t\t\tl=p->lpEcb->cbTotalBytes-p-\n>bytes_read_so_far;\n\t\t\t\tif(p->lpEcb->ReadClient(p->lpEcb->ConnID, buf, \n&l)) {\n                    *a += l;\n\t\t\t\t\tp->bytes_read_so_far+=l;\n                } else {\n                    jk_log(logger, JK_LOG_ERROR, \n                           \"jk_ws_service_t::read, ReadClient failed\\n\");\n                    return 0;\n                }                   \n            }\n        }\n        return 1;\n    }\n\n    jk_log(logger, JK_LOG_ERROR, \n           \"jk_ws_service_t::read, NULL parameters\\n\");\n    return 0;\n}"}, {"count": 1, "tags": [], "creator": "rstupp@pironet.com", "attachment_id": null, "text": "Note: IIS-Redirector w/ JNI.", "id": 4943, "time": "2001-08-28T01:32:43Z", "bug_id": 3298, "creation_time": "2001-08-28T01:32:43Z", "is_private": false}, {"count": 2, "tags": [], "creator": "cmanolache@yahoo.com", "text": "Seems like a delicate change - how will it affect other connectors ? We could do\nit in j-t-c, for the next release of mod_jk, but for now seems to dangerous. \nPlease include diffs in future.", "id": 4985, "time": "2001-08-28T22:48:00Z", "bug_id": 3298, "creation_time": "2001-08-28T22:48:00Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 3298, "text": "Reopen to change resolution", "id": 6625, "time": "2001-10-12T08:13:17Z", "creator": "Larry.Isaacs@sas.com", "creation_time": "2001-10-12T08:13:17Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "Larry.Isaacs@sas.com", "text": "Resolving as LATER.  It can be addressed in jakarta-tomcat-connectors, and\nperhaps Tomcat 3.3.1", "id": 6626, "time": "2001-10-12T08:14:52Z", "bug_id": 3298, "creation_time": "2001-10-12T08:14:52Z", "is_private": false, "attachment_id": null}]