[{"count": 0, "tags": [], "bug_id": 46449, "attachment_id": null, "text": "With the following files:\n$ cat test.shtml \n<p>first</p>\n<!--#include virtual=\"test.php\"-->\n$ cat test.php \n<?php\necho \"<p>second</p>\";\n?>\n\nA request for http://host/test.shtml produces the following erroneous result:\nGET /test.shtml HTTP/1.1\nHost: www.xxxxxxx.org\n\nHTTP/1.1 200 OK\nDate: Tue, 30 Dec 2008 11:21:00 GMT\nServer: Apache DAV/2 mod_python/3.3.1 Python/2.5.2\nAccept-Ranges: bytes\nTransfer-Encoding: chunked\nContent-Type: text/html\n\nd\n<p>second</p>\ne\n<p>first</p>\n\n\n0\nAn on the browser:\n\nsecond\n\nfirst\n\n\nOur configuration:\n /usr/sbin/apache2 -V\nServer version: Apache/2.2.9 (Debian)\nServer built:   Oct  1 2008 14:34:07\nServer's Module Magic Number: 20051115:15\nServer loaded:  APR 1.2.12, APR-Util 1.2.12\nCompiled using: APR 1.2.12, APR-Util 1.2.12\nArchitecture:   64-bit\nServer MPM:     Worker\n  threaded:     yes (fixed thread count)\n    forked:     yes (variable process count)\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/worker\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"\"\n -D SUEXEC_BIN=\"/usr/lib/apache2/suexec\"\n -D DEFAULT_PIDLOG=\"/var/run/apache2.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"/etc/apache2/mime.types\"\n -D SERVER_CONFIG_FILE=\"/etc/apache2/apache2.conf\"", "id": 123626, "time": "2008-12-30T03:36:52Z", "creator": "leandro@pangea.org", "creation_time": "2008-12-30T03:36:52Z", "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 46449, "text": "It works correctly with mpm-prefork and mod_php.\n\nIn what way do you call the php interpreter? Do you have any special output filters configured? What is the output of apache2ctl -M?", "id": 123639, "time": "2008-12-30T10:09:50Z", "creator": "sf@sfritsch.de", "creation_time": "2008-12-30T10:09:50Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "creator": "leandro@pangea.org", "text": "(In reply to comment #1)\n> It works correctly with mpm-prefork and mod_php.\n> \n> In what way do you call the php interpreter?\nFast-cgi, with suexec.\n\nAddType application/x-httpd-php .php3 .phtml .php .phps\nSuexecUserGroup user group\nAction php-fcgi /fcgi-bin/php-fcgi-wrapper\nAlias /fcgi-bin/ /home/httpd/fcgi-bin.d/php5-user/\n\n/home/httpd/fcgi-bin.d/php5-user$ more php-fcgi-wrapper \n#!/bin/sh\nexport PHPRC=/etc/php5/cgi\nexec /usr/bin/php5-cgi\n\n> Do you have any special output filters configured? \nOnly includes:\nmods-enabled/mime.conf:AddOutputFilter INCLUDES .shtml\n\n> What is the output of apache2ctl -M?\n\n/usr/sbin/apache2ctl -M\n[Tue Dec 30 19:38:35 2008] [warn] worker http://xxx.yyyyyyy.org already used by another worker\n[Tue Dec 30 19:38:36 2008] [warn] worker http://www.xxxxxxxx.org/~zzzz already used by another worker\nLoaded Modules:\n core_module (static)\n log_config_module (static)\n logio_module (static)\n mpm_worker_module (static)\n http_module (static)\n so_module (static)\n actions_module (shared)\n alias_module (shared)\n auth_basic_module (shared)\n auth_pam_module (shared)\n authn_file_module (shared)\n authz_default_module (shared)\n authz_groupfile_module (shared)\n authz_host_module (shared)\n authz_user_module (shared)\n autoindex_module (shared)\n cgid_module (shared)\n dav_module (shared)\n dir_module (shared)\n env_module (shared)\n fcgid_module (shared)\n headers_module (shared)\n include_module (shared)\n mime_module (shared)\n security2_module (shared)\n negotiation_module (shared)\n proxy_module (shared)\n proxy_http_module (shared)\n python_module (shared)\n rewrite_module (shared)\n setenvif_module (shared)\n ssl_module (shared)\n status_module (shared)\n suexec_module (shared)\n unique_id_module (shared)\n userdir_module (shared)\nSyntax OK\n\n", "id": 123644, "time": "2008-12-30T11:16:50Z", "bug_id": 46449, "creation_time": "2008-12-30T11:16:50Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 46449, "text": "Looking at the code for mod_include, I think that the problem seems to be with ap_sub_req_lookup_uri(), that the output is not flushed before this call is invoked and therefore the output is garbled.\n\nI found this mail related:\nhttp://mail-archives.apache.org/mod_mbox/httpd-dev/200009.mbox/raw/%3C20000913192658.L23617@lyra.org%3E/\n\nIf that is the source of the problem, how can I modify mod_include to flush the output before a sub_req is invoked? The code is not that readable to see clearly how to modify.\n\nAny suggestion?\n\nBest regards, Leandro.(In reply to comment #2)\n", "id": 124446, "time": "2009-01-28T13:14:45Z", "creator": "leandro@pangea.org", "creation_time": "2009-01-28T13:14:45Z", "is_private": false, "attachment_id": null}]