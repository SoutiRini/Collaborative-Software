[{"count": 0, "tags": [], "creator": "matthew.knl@gmail.com", "attachment_id": 22863, "id": 122451, "time": "2008-11-13T19:37:48Z", "bug_id": 46207, "creation_time": "2008-11-13T19:37:48Z", "is_private": false, "text": "Created attachment 22863\nExcel 2007 prompts error\n\nI have an Excel 2007 file (attachment: TestPOI1.xlsm), after it is opened and saved by following codes, it prompts errors in Excel 2007 when I open it (attachment: 2008-11-14_103611.jpg):\n\n--\nWorkbook wb = new XSSFWorkbook(source);\nFileOutputStream outStream = new FileOutputStream(target);\nwb.write(outStream);\n--\n\nThe result file is attached: TestPOI1_error.xlsm\n\nProblems\n========\nI checked the file structure and I have following findings:\n\n1. In the content of /xl/workbook.xml, it is referencing an externalReference element with id:rId4, but /xl/_rels/workbook.xml.rels doesn't contains that relationship. externalLinks relationships are missing (which can be found inside TestPOI1.xlsm)\n\n2. In the content of /xl/worksheets/sheet1.xml, it is referencing an pageSetup element with id:rId1, but /xl/worksheets/_rels/sheet1.xml.rels rId1 is a vmlDrawing and printerSetting relationships are missing (which can be found inside TestPOI1.xlsm)\n\nSolutions\n=========\n\nI have made a patch to solve above problem (attachment: fix_printer_setup_drawing_named_range.patch), which the result saved file (attachment: TestPOI1_fix.xlsm) can be opened in Excel 2007 successfully with errors.\n\nI made following changes:\n\n1. Load the external links and printer settings when opening the workbook\n\n2. Since the external link relationship type the target URI is an external file, I made some changes on XSSFRelation to support external target mode so that it won't find the target package part (it doesn't exist in the package).\n\n3. Save the external links and printer settings when opening the workbook\n\n4. Other problem I found is the relationship id problem: while saving a workbook, existing codes will generate the relationship id for drawings and activex controls of a worksheet. Since the drawings and activex controls are placed inside common folder /xl/drawings/, /xl/activeX/ which are shared by different sheets, there is a chance of id conflicts, so I modified part of XSSFWorkbook.save(...)\n\n5. Although I load and save the external links and printer settings elements, but the relationship id will be changed, so I changed XSSFSheet to enabled set the page setup id and printer setting id.\n\n--\n\nPlease review my patch since it maybe hardcoded and doesn't following your model design concept correctly, since it is \"result oriented\" :P Hope it can help the POI-OOXML development."}, {"count": 1, "text": "Created attachment 22864\nOriginal file", "bug_id": 46207, "is_private": false, "id": 122452, "time": "2008-11-13T19:39:17Z", "creator": "matthew.knl@gmail.com", "creation_time": "2008-11-13T19:39:17Z", "tags": [], "attachment_id": 22864}, {"attachment_id": 22865, "tags": [], "creator": "matthew.knl@gmail.com", "is_private": false, "count": 2, "id": 122453, "time": "2008-11-13T19:39:37Z", "bug_id": 46207, "creation_time": "2008-11-13T19:39:37Z", "text": "Created attachment 22865\nResult error file"}, {"count": 3, "tags": [], "text": "Created attachment 22866\nPatch to fix", "attachment_id": 22866, "id": 122454, "creation_time": "2008-11-13T19:39:59Z", "time": "2008-11-13T19:39:59Z", "creator": "matthew.knl@gmail.com", "bug_id": 46207, "is_private": false}, {"attachment_id": 22867, "tags": [], "creator": "matthew.knl@gmail.com", "is_private": false, "count": 4, "id": 122455, "time": "2008-11-13T19:40:17Z", "bug_id": 46207, "creation_time": "2008-11-13T19:40:17Z", "text": "Created attachment 22867\nResult fixed file"}, {"count": 5, "tags": [], "creator": "yegor@dinom.ru", "attachment_id": null, "is_private": false, "id": 122458, "time": "2008-11-13T22:50:29Z", "bug_id": 46207, "creation_time": "2008-11-13T22:50:29Z", "text": "Try the latest svn build. It works OK for me.\nRead-write round trip was significantly  improved since 3.5-beta3. \n\ndaily builds can be downloaded from http://encore.torchbox.com/poi-svn-build/\n\nYegor"}]