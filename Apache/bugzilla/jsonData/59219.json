[{"count": 0, "tags": [], "creator": "niscomar@googlemail.com", "attachment_id": null, "text": "There are a couple of problems relating to error handling during exception\nprocessing. Basically, Tomcat should ensure that the AsyncListener onError\nand onComplete methods are correctly called if an exception occurs during\nasync processing in order to allow the listener code to release resources\nand do clean-up. This does not seem to happen.\n\nA sample servlet demonstrating the problem, AsyncDebugListener, is provided \nat the following location:\n\nhttps://github.com/msnicklous/AsyncDebug\n\nBuild the AsyncDebugListener module using 'mvn install' and deploy it on Tomcat.\n\nThe service method and each of the AsyncListener methods logs output to the\nAsyncListener.log file. You can follow execution by looking at the logs.\n\nAssuming Tomcat is installed locally, you can use the following URLs:\n\n1) No error - works correctly:\n\nhttp://localhost:8080/AsyncDebugListener/ltest?reps=3\n\n2) Exception during service method\n\nhttp://localhost:8080/AsyncDebugListener/ltest?err\n\nIf async processing is started and an exception is thrown before the end of\nthe service method, AsyncListener#onError is not called, however onTimeout\nfollowed by onComplete are both called. \n\nThis is incorrect, as onError followed by onComplete should be called. \n\n3) Exception during processing of AsyncContext#dispatch() target\n\nhttp://localhost:8080/AsyncDebugListener/ltest?reps=3&err\n\nPrecondition: Async processing is started and the request is dispatched using \nAsyncContext#dispatch(). The service method returns to the container.\n\nIf the container performs the resulting async dispatch and an exception is \nthrown, Tomcat drops the connection to the browser and no AsyncListener method\nis called.\n\nThis is incorrect. Tomcat should flush the contents of the buffer to the \nbrowser and call the AsyncListener onError followed by the onComplete methods.\n\nThanks for having a look at this!", "id": 189667, "time": "2016-03-23T13:15:48Z", "bug_id": 59219, "creation_time": "2016-03-23T13:15:48Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 59219, "attachment_id": null, "id": 190360, "time": "2016-04-18T19:59:23Z", "creator": "markt@apache.org", "creation_time": "2016-04-18T19:59:23Z", "is_private": false, "text": "I've made some changes in 9.0.x to address point 2. The provided test case (thanks for that it makes life a lot easier) now passes. I want to look at point 3 before thinking about back-porting."}, {"count": 2, "tags": [], "bug_id": 59219, "attachment_id": null, "id": 190363, "time": "2016-04-18T20:36:05Z", "creator": "markt@apache.org", "creation_time": "2016-04-18T20:36:05Z", "is_private": false, "text": "Point 3 is fixed as well in 9.0.x for 9.0.0.M5 onwards.\n\nI'll look at back-porting this next."}, {"count": 3, "tags": [], "text": "Backports complete.\n- 8.5.x for 8.5.1 onwards\n- 8.0.x for 8.0.34 onwards\n- 7.0.x for 7.0.70 onwards\n- 6.0.x for 6.0.46 onwards", "attachment_id": null, "id": 190364, "creator": "markt@apache.org", "time": "2016-04-18T21:08:07Z", "bug_id": 59219, "creation_time": "2016-04-18T21:08:07Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 59219, "attachment_id": null, "id": 190368, "time": "2016-04-18T21:44:34Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2016-04-18T21:44:34Z", "is_private": false, "text": "(In reply to Mark Thomas from comment #3)\n> - 6.0.x for 6.0.46 onwards\n\nScratch the above one.\nTomcat 6 was not affected by this fix.\n\nAsyncListener is a feature of Servlet 3.0 API / Tomcat 7 onwards."}, {"count": 5, "tags": [], "bug_id": 59219, "attachment_id": 33782, "id": 190411, "time": "2016-04-20T12:51:34Z", "creator": "lavloz@hotmail.fr", "creation_time": "2016-04-20T12:51:34Z", "is_private": false, "text": "Created attachment 33782\nUnit test of bug 59219\n\nUnit test patch of the bug 59219 (point 2)."}, {"count": 6, "tags": [], "bug_id": 59219, "attachment_id": 33783, "id": 190430, "time": "2016-04-21T10:09:52Z", "creator": "lavloz@hotmail.fr", "creation_time": "2016-04-21T10:09:52Z", "is_private": false, "text": "Created attachment 33783\nUnit test of bug 59219\n\nThis unit test checks 2 and 3 points."}, {"count": 7, "tags": [], "text": "Created attachment 33784\nUnit test of bug 59219\n\nUnit test which checks point 2 and 3.", "is_private": false, "id": 190431, "creator": "lavloz@hotmail.fr", "time": "2016-04-21T10:15:13Z", "bug_id": 59219, "creation_time": "2016-04-21T10:15:13Z", "attachment_id": 33784}, {"count": 8, "tags": [], "text": "Thanks for the patch. It is being looked at. Currently I'm seeing odd behaviour on Windows so I want to test it on another platform.\n\nI do have some basic feedback at this point. Expect some more when once I have test test working:\n1. Use separate methods for separate tests. It makes it easier to determine which tests are failing.\n2. We aim to keep the code warning free. If you use Eclipse, checkout the configuration settings we use under res/ide-support/eclipse\n3. It looks like you should be able to re-use the existing tracking listener.", "attachment_id": null, "id": 190465, "creator": "markt@apache.org", "time": "2016-04-21T18:08:15Z", "bug_id": 59219, "creation_time": "2016-04-21T18:08:15Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 59219, "attachment_id": null, "id": 190467, "time": "2016-04-21T19:25:20Z", "creator": "markt@apache.org", "creation_time": "2016-04-21T19:25:20Z", "is_private": false, "text": "And some more:\n4. The wait loop logic is wrong.\n   - It will always wait 5s even if the output is correct\n   - If output in incorrect it will enter an infinite loop\n5. It is clearer to define an explicit Wrapper insatnce and then call\n   setAsyncSupported(true) on that.\n6. The test doesn't pass. This actually highlights a bug in the fix (regression\n   in the fix for point 2 when the fix for point 3 was made) which just goes to\n   demonstrate the usefulness of test cases.\n\nI have all this fixed locally but I think it would be useful for you to try and fix these issues yourself."}, {"count": 10, "tags": [], "bug_id": 59219, "attachment_id": null, "id": 190482, "time": "2016-04-22T13:04:01Z", "creator": "markt@apache.org", "creation_time": "2016-04-22T13:04:01Z", "is_private": false, "text": "I've fixed the regression. I held back on committing the test case to give you a chance to update your proposed patch."}, {"count": 11, "tags": [], "creator": "lavloz@hotmail.fr", "attachment_id": 33796, "is_private": false, "id": 190495, "time": "2016-04-23T01:39:40Z", "bug_id": 59219, "creation_time": "2016-04-23T01:39:40Z", "text": "Created attachment 33796\nUnit test of bug 59219\n\nThank you for your useful feedback and especialy your patience and your time :), i use IntelliJ IDEA Community edition because i'm more familiar with its debugger and its features, i run ant to convert the project to eclipse project then import it inside IDEA as eclipse project (ant buildfile doesn't offer support for IDEA and IDEA supports importing eclipse projects).\n\nThe test case pass for point 2, but it doesn't for point 3, i noticed that when an exception occurs without a dispatch the onError run once, but if the exception occurs with no matter numbder of dispatch the onError run twice, i think it a bug in the fix as onError should run only once or the same as the dispatch has been called (i didn't read the servlet spec)."}, {"count": 12, "tags": [], "bug_id": 59219, "attachment_id": 33796, "id": 190521, "time": "2016-04-24T16:13:26Z", "creator": "markt@apache.org", "creation_time": "2016-04-24T16:13:26Z", "is_private": false, "text": "Comment on attachment 33796\nUnit test of bug 59219\n\nNice. That is very, very close to what I have. The differences are:\n- refactoring to remove duplicate code\n- setting the timeout on the async context to speed up some failure modes\n- different logic around loop tracking\n\nI'll get this committed shortly so you can see the differences. You'll get a credit in the commit message."}, {"count": 13, "tags": [], "creator": "lavloz@hotmail.fr", "attachment_id": 33802, "is_private": false, "id": 190537, "time": "2016-04-25T12:58:06Z", "bug_id": 59219, "creation_time": "2016-04-25T12:58:06Z", "text": "Created attachment 33802\nUnit test of bug 59219\n\nInserting timeout.\n\nAbout refactoring, of course there's some duplicate code as the servlets, ServletB can do what ServletA do, but i think like its better, because its more clear and more explicit for point 2, or not?? :)"}]