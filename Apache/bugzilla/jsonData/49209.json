[{"count": 0, "tags": [], "bug_id": 49209, "text": "When running Tomcat with a SecurityManager, an AccessControlException is thrown during undeployment.\n\nStack trace:\n\nCaused by: java.security.AccessControlException: access denied (java.lang.RuntimePermission getClassLoader)\n\tat java.security.AccessControlContext.checkPermission(AccessControlContext.java:323)\n\tat java.security.AccessController.checkPermission(AccessController.java:546)\n\tat java.lang.SecurityManager.checkPermission(SecurityManager.java:532)\n\tat java.lang.Class.getClassLoader(Class.java:594)\n\tat org.apache.catalina.loader.JdbcLeakPrevention.clearJdbcDriverRegistrations(JdbcLeakPrevention.java:49)\n\nI assume the default catalina.policy should be updated, to take this case into account.", "id": 136479, "time": "2010-04-28T07:30:12Z", "creator": "stephan.bublava@s-itsolutions.at", "creation_time": "2010-04-28T07:30:12Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "knst.kolinko@gmail.com", "is_private": false, "text": "Please provide the full stacktrace. The JdbcLeakPrevention class should already have the necessary permissions, so there must be something odd in the call chain.\n\nIs this issue reproducible? What steps are needed to reproduce it?", "id": 136480, "time": "2010-04-28T07:55:43Z", "bug_id": 49209, "creation_time": "2010-04-28T07:55:43Z", "attachment_id": null}, {"count": 2, "tags": [], "text": "Here is the full stack trace.\n\nMay 5, 2010 5:15:16 AM org.apache.catalina.loader.WebappClassLoader clearReferencesJdbc\nWARNING: JDBC driver de-registration failed\njava.lang.reflect.InvocationTargetException\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.catalina.loader.WebappClassLoader.clearReferencesJdbc(WebappClassLoader.java:1820)\n        at org.apache.catalina.loader.WebappClassLoader.clearReferences(WebappClassLoader.java:1740)\n        at org.apache.catalina.loader.WebappClassLoader.stop(WebappClassLoader.java:1658)\n        at org.apache.catalina.loader.WebappLoader.stop(WebappLoader.java:710)\n        at org.apache.catalina.core.StandardContext.stop(StandardContext.java:4649)\n        at org.apache.catalina.core.ContainerBase.removeChild(ContainerBase.java:924)\n        at org.apache.catalina.startup.HostConfig.undeployApps(HostConfig.java:1319)\n        at org.apache.catalina.startup.HostConfig.stop(HostConfig.java:1290)\n        at org.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java:323)\n        at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:119)\n        at org.apache.catalina.core.ContainerBase.stop(ContainerBase.java:1086)\n        at org.apache.catalina.core.ContainerBase.stop(ContainerBase.java:1098)\n        at org.apache.catalina.core.StandardEngine.stop(StandardEngine.java:448)\n        at org.apache.catalina.core.StandardService.stop(StandardService.java:587)\n        at org.apache.catalina.core.StandardServer.stop(StandardServer.java:744)\n        at org.apache.catalina.startup.Catalina.stop(Catalina.java:648)\n        at org.apache.catalina.startup.Catalina.start(Catalina.java:615)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.catalina.startup.Bootstrap.start(Bootstrap.java:289)\n        at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:414)\nCaused by: java.security.AccessControlException: access denied (java.lang.RuntimePermission getClassLoader)\n        at java.security.AccessControlContext.checkPermission(AccessControlContext.java:323)\n        at java.security.AccessController.checkPermission(AccessController.java:546)\n        at java.lang.SecurityManager.checkPermission(SecurityManager.java:532)\n        at java.lang.Class.getClassLoader(Class.java:594)\n        at org.apache.catalina.loader.JdbcLeakPrevention.clearJdbcDriverRegistrations(JdbcLeakPrevention.java:49)\n        ... 27 more\n\nI see an AllPermission grant in the default catalina.policy that I would have expected to prevent this problem, but haven't given much thought as to why it doesn't.\n\nIt is reproducible here, simply by shutting down Tomcat with a still-registered JDBC driver (and with a security manager in place, obviously).  If you'd like any additional information, just let me know.", "is_private": false, "id": 136655, "creator": "nc1500@yahoo.com", "time": "2010-05-05T11:13:38Z", "bug_id": 49209, "creation_time": "2010-05-05T11:13:38Z", "attachment_id": null}, {"count": 3, "tags": [], "text": "This works for me with the latest 6.0.x code. I don't recall any relevant changes since 6.0.26.\n\nIf you still see this issue, please feel free to re-open but you'll need to provide the simplest complete set of steps to reproduce this from a clean 6.0.26 install.", "is_private": false, "id": 137625, "creator": "markt@apache.org", "time": "2010-06-14T12:55:19Z", "bug_id": 49209, "creation_time": "2010-06-14T12:55:19Z", "attachment_id": null}, {"count": 4, "tags": [], "text": "The problem still exists on Tomcat 6.0.29\n\nSteps: to reproduce \nRun  MySQL DBCP Example from\n   http://tomcat.apache.org/tomcat-6.0-doc/jndi-datasource-examples-howto.html\non Tomcat with enabled security.\n./catalina.sh run -security\n\nI will  add demo application and Context confiuration as attachment.\nTo reproduce you need copy my-webapp.war to /webapps,my-webapp.xml to Catalina/localhost, also you  need to add JDBC driver to /lib.\nException will occur only if security is enabled.", "is_private": false, "id": 139928, "creator": "ksmster@gmail.com", "time": "2010-09-17T09:03:08Z", "bug_id": 49209, "creation_time": "2010-09-17T09:03:08Z", "attachment_id": null}, {"attachment_id": 26042, "tags": [], "bug_id": 49209, "is_private": false, "count": 5, "id": 139929, "time": "2010-09-17T09:05:21Z", "creator": "ksmster@gmail.com", "creation_time": "2010-09-17T09:05:21Z", "text": "Created attachment 26042\nMySQL DBCP Example APP"}, {"attachment_id": 26043, "tags": [], "bug_id": 49209, "is_private": false, "count": 6, "id": 139930, "time": "2010-09-17T09:07:15Z", "creator": "ksmster@gmail.com", "creation_time": "2010-09-17T09:07:15Z", "text": "Created attachment 26043\nContext configuration"}, {"count": 7, "tags": [], "bug_id": 49209, "text": "Created attachment 26049\nPatch for tomcat 6.0.29\n\nI managed to reproduce the problem.\nThe thing is that the JdbcLeakPrevention class called by WebappClassLoader.clearReferencesJdbc() is not loaded by the same ClassLoader as the other parts of catalina. It is loaded by the classloader of the webapp, but without any ProtectionDomain defined. \n\nMy patch just calls defineClass passing the current ProtectionDomain of the WebappClassLoader class so that from a security policy point of view, the loaded JdbcLeakPrevention class has the same privileges as the rest of catalina as it would have if it had been loaded normally.\n\nI tested my patch with java 1.6.0_20 on OSX 10.6. I suppose the issue also applies to tomcat 7 but did not check.", "id": 139950, "time": "2010-09-18T18:08:06Z", "creator": "slaurent@apache.org", "creation_time": "2010-09-18T18:08:06Z", "is_private": false, "attachment_id": 26049}, {"count": 8, "tags": [], "bug_id": 49209, "text": "Thanks for the patch. Fixed in trunk and proposed for 6.0.x", "id": 140246, "time": "2010-09-27T19:08:18Z", "creator": "markt@apache.org", "creation_time": "2010-09-27T19:08:18Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 49209, "attachment_id": null, "text": "Fixed in 6.0.x and will be in 6.0.30 onwards.\n\nThanks again for the patch.", "id": 140696, "time": "2010-10-12T09:03:12Z", "creator": "markt@apache.org", "creation_time": "2010-10-12T09:03:12Z", "is_private": false}]