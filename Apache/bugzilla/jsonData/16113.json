[{"count": 0, "tags": [], "bug_id": 16113, "attachment_id": null, "text": "Hi guys. I've got what appears to be a bona fide error in tomcat's jsp servlet\nor one of its friends. The steps to reproduce the problem are:\n\n1. start tomcat-4.1.18 with a webapp containing a foo.jsp page\n2. hit the foo.jsp url and see the page\n3. remove foo.jsp from the webapp\n4. reload the foo.jsp url until you finally get a 404 (why does this take\nseveral tries?)\n5. replace the foo.jsp file in the webapp\n6. note that hitting the foo.jsp url will forever give you a 404 until you\nrestart tomcat", "id": 29406, "time": "2003-01-15T16:44:00Z", "creator": "dball@rhoworld.com", "creation_time": "2003-01-15T16:44:00Z", "is_private": false}, {"count": 1, "tags": [], "creator": "remm@apache.org", "text": "I can reproduce it. It doesn't happen with non-JSPs, such as images, so it\nshouldn't be a cache bug.\nBTW, the (small) delay is there because there's a cache.", "id": 29412, "time": "2003-01-15T16:54:40Z", "bug_id": 16113, "creation_time": "2003-01-15T16:54:40Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 16113, "is_private": false, "count": 2, "id": 30373, "time": "2003-01-30T20:10:44Z", "creator": "dball@rhoworld.com", "creation_time": "2003-01-30T20:10:44Z", "text": "FWIW, this problem does not occur with tomcat-4.0.6. The problem is serious\nenough in our context that we have been forced to downgrade."}, {"count": 3, "attachment_id": null, "bug_id": 16113, "text": "We're seeing it too. Very nasty.", "id": 40472, "time": "2003-07-11T14:40:23Z", "creator": "obsidian@panix.com", "creation_time": "2003-07-11T14:40:23Z", "tags": [], "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 16113, "text": "I have a working patch for this bug; I'd appreciate help/advice from anyone \nmore familiar with creating and submitting patches to the Tomcat team.", "count": 4, "id": 40492, "time": "2003-07-11T17:36:41Z", "creator": "obsidian@panix.com", "creation_time": "2003-07-11T17:36:41Z", "is_private": false}, {"count": 5, "tags": [], "text": "Any word on this bug? Very surprised to see the 4.0.x series disappear from the\njakarta mirrors with serious bugs like this outstanding in the 4.1 branch.", "attachment_id": null, "id": 44210, "creation_time": "2003-09-15T16:19:32Z", "time": "2003-09-15T16:19:32Z", "creator": "dball@rhoworld.com", "bug_id": 16113, "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 16113, "text": "What I wrote (patch against 4.1.24 source archive) never got in. \n\nI was building a patch file; as a sanity check, I had checked out the public CVS\ncode labeled \"TOMCAT_4_1_24\", and I saw that it didn't match their \"4.1.24\"\nsource archives. When I asked about this, Remy basically told me \"learn CVS\",\nand that was the only response I got. \n\nI did notice that the dev code in CVS had progressed pretty far from 4.1.24\nalready at the time, and I recall seeing some significant changes in and around\nthe relevant code... I guessed that this bug had already been fixed, and just\nforgotten in the DB. \n\nDoes this still happen in 4.1.27? ", "count": 6, "id": 44226, "time": "2003-09-15T22:41:07Z", "creator": "obsidian@panix.com", "creation_time": "2003-09-15T22:41:07Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 16113, "text": "I have verified that it is still a bug in 4.1.29. David, would it be possible\nfor you to mail me a copy of your patch?", "count": 7, "id": 46801, "time": "2003-11-04T18:19:12Z", "creator": "dball@rhoworld.com", "creation_time": "2003-11-04T18:19:12Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 16113, "attachment_id": null, "text": "If you have a patch, preferably against 5.0.19, please post it so we can \nevaluate how risky it is.", "id": 53424, "time": "2004-03-04T13:53:08Z", "creator": "yoavs@computer.org", "creation_time": "2004-03-04T13:53:08Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 16113, "text": "Simply compare JspRuntimeContext.checkCompile(), this calls \nctxt.incrementRemoved() if a FileNotFoundException occur. JspServletWrapper \nonly set a 404 if a FileNotFoundException occur and finish. \n \nCode from JspRuntineContext: \n            synchronized(jsw) { \n                try { \n                    ctxt.compile(); \n                } catch (FileNotFoundException ex) { \n                    ctxt.incrementRemoved(); \n                } catch (Throwable t) { \n                    jsw.getServletContext().log(\"Background compile failed\", \n                                                t); \n                } \n            } \n \nCode from JspServletWrapper: \n \n       } catch (FileNotFoundException ex) { \n            String includeRequestUri = (String) \n                request.getAttribute(\"javax.servlet.include.request_uri\"); \n            if (includeRequestUri != null) { \n                // This file was included. Throw an exception as \n                // a response.sendError() will be ignored by the \n                // servlet engine. \n                throw new ServletException(ex); \n            } else { \n                try { \n                    response.sendError(HttpServletResponse.SC_NOT_FOUND, \n                                      ex.getMessage()); \n                } catch (IllegalStateException ise) { \n                    log.error(Localizer.getMessage(\"jsp.error.file.not.found\", \n                                                   ex.getMessage()), \n                              ex); \n                } \n \n \nadd a simple ctxt.incrementRemoved in catch block and test case works. ", "id": 53507, "time": "2004-03-05T13:26:17Z", "creator": "tfohrer@t-online.de", "creation_time": "2004-03-05T13:26:17Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "creator": "q.bordeaux@laposte.net", "attachment_id": null, "id": 53508, "time": "2004-03-05T13:39:02Z", "bug_id": 16113, "creation_time": "2004-03-05T13:39:02Z", "is_private": false, "text": "Another solution : in JspServletWrapper, line 343, before sending\nHttpServletResponse.SC_NOT_FOUND, remove wrapper from collection of previously\ncreated wrapper : \n\nCode from JspServletWrapper: \n\n       } catch (FileNotFoundException ex) { \n            String includeRequestUri = (String) \n                request.getAttribute(\"javax.servlet.include.request_uri\"); \n            if (includeRequestUri != null) { \n                // This file was included. Throw an exception as \n                // a response.sendError() will be ignored by the \n                // servlet engine. \n                throw new ServletException(ex); \n            } else { \n                try { \n                    // BELOW 1 LINE PROPOSED FOR THIS BUG\n                    ctxt.getRuntimeContext().removeWrapper(jspUri);\n                    response.sendError(HttpServletResponse.SC_NOT_FOUND, \n                                      ex.getMessage()); \n                } catch (IllegalStateException ise) { \n                    log.error(Localizer.getMessage(\"jsp.error.file.not.found\", \n                                                   ex.getMessage()), \n                              ex); \n                } "}, {"count": 11, "tags": [], "creator": "tfohrer@t-online.de", "text": "using incrementRemoved() is cleaner, it removes wrapper and java-/class-file. \n \nCode from JspCompilationContext: \n \n    // ==================== Removal ==================== \n \n    public void incrementRemoved() { \n        if (removed > 1) { \n            jspCompiler.removeGeneratedFiles(); \n            if( rctxt != null ) \n                rctxt.removeWrapper(jspUri); \n        } \n        removed++; \n    } \n ", "id": 53509, "time": "2004-03-05T13:44:33Z", "bug_id": 16113, "creation_time": "2004-03-05T13:44:33Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "text": "OK, I agree.\n\nWhat's happen now? I suppose this patch must be validated and voted by Tomcat\ncommiters.", "attachment_id": null, "id": 53510, "creation_time": "2004-03-05T13:50:37Z", "time": "2004-03-05T13:50:37Z", "creator": "q.bordeaux@laposte.net", "bug_id": 16113, "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 16113, "text": "Example for fixed code \n \nJspServletWrapper: \n       } catch (FileNotFoundException ex) {  \n            String includeRequestUri = (String)  \n                request.getAttribute(\"javax.servlet.include.request_uri\");  \n            ctxt.incrementRemoved() \n            if (includeRequestUri != null) {  \n                // This file was included. Throw an exception as  \n                // a response.sendError() will be ignored by the  \n                // servlet engine.  \n                throw new ServletException(ex);  \n            } else {  \n                try {  \n                    response.sendError(HttpServletResponse.SC_NOT_FOUND,  \n                                      ex.getMessage());  \n                } catch (IllegalStateException ise) {  \n                    log.error(Localizer.getMessage(\"jsp.error.file.not.found\",  \n                                                   ex.getMessage()),  \n                              ex);  \n                }  \n  ", "count": 13, "id": 53511, "time": "2004-03-05T13:56:28Z", "creator": "tfohrer@t-online.de", "creation_time": "2004-03-05T13:56:28Z", "is_private": false}, {"count": 14, "tags": [], "text": "oh, you reminder JspServletWrapper/JspCompilationContext in your reminder, \nread the discussion on tomcat-user currently. \n \ni agree with Q. Bordeaux. \n \nsome live-enviroment requires jasper background compilation or development \nenabled. \nsome not, use precompile instead. \n ", "is_private": false, "bug_id": 16113, "id": 53513, "time": "2004-03-05T14:19:43Z", "creator": "tfohrer@t-online.de", "creation_time": "2004-03-05T14:19:43Z", "attachment_id": null}, {"count": 15, "tags": [], "creator": "tfohrer@t-online.de", "attachment_id": 10692, "id": 53598, "time": "2004-03-07T08:56:37Z", "bug_id": 16113, "creation_time": "2004-03-07T08:56:37Z", "is_private": false, "text": "Created attachment 10692\npoproposed patch"}, {"count": 16, "tags": [], "text": "Patch applied.  Thanks.", "is_private": false, "bug_id": 16113, "id": 53693, "time": "2004-03-09T00:48:04Z", "creator": "kin-man.chung@sun.com", "creation_time": "2004-03-09T00:48:04Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 16113, "text": "Does this patch is applied to both Tomcat 5.x and Tomcat 4.1.x or only to Tomcat\n5.x?", "count": 17, "id": 53719, "time": "2004-03-09T13:58:05Z", "creator": "q.bordeaux@laposte.net", "creation_time": "2004-03-09T13:58:05Z", "is_private": false}, {"count": 18, "attachment_id": null, "bug_id": 16113, "text": "I just applied the patch to 4.1.x also.", "id": 53738, "time": "2004-03-09T17:55:18Z", "creator": "kin-man.chung@sun.com", "creation_time": "2004-03-09T17:55:18Z", "tags": [], "is_private": false}, {"count": 19, "tags": [], "creator": "markt@apache.org", "text": "*** Bug 35650 has been marked as a duplicate of this bug. ***", "id": 77088, "time": "2005-07-08T00:07:11Z", "bug_id": 16113, "creation_time": "2005-07-08T00:07:11Z", "is_private": false, "attachment_id": null}]