[{"count": 0, "tags": [], "creator": "admin.apache@moparisthebest.com", "is_private": false, "text": "Created attachment 34967\n0001-Fix-incorrect-use-of-short-when-unsigned-short-was-r.patch\n\nA large spreadsheet (my guess is > 32k rows) crashes in the FormulaEvaluator.evaluate(Cell) function with this error:\n\n\njava.lang.ArrayIndexOutOfBoundsException: -32760\n\tat java.util.ArrayList.elementData(ArrayList.java:418) ~[na:1.8.0_121]\n\tat java.util.ArrayList.get(ArrayList.java:431) ~[na:1.8.0_121]\n\tat org.apache.poi.hssf.model.LinkTable.getNameRecord(LinkTable.java:321) ~[poi-3.16.jar:3.16]\n\tat org.apache.poi.hssf.model.InternalWorkbook.getNameRecord(InternalWorkbook.java:1660) ~[poi-3.16.jar:3.16]\n\tat org.apache.poi.hssf.usermodel.HSSFEvaluationWorkbook.getName(HSSFEvaluationWorkbook.java:220) ~[poi-3.16.jar:3.16]\n\tat org.apache.poi.ss.formula.WorkbookEvaluator.getEvalForPtg(WorkbookEvaluator.java:616) ~[poi-3.16.jar:3.16]\n\tat org.apache.poi.ss.formula.WorkbookEvaluator.evaluateFormula(WorkbookEvaluator.java:525) ~[poi-3.16.jar:3.16]\n\tat org.apache.poi.ss.formula.WorkbookEvaluator.evaluateAny(WorkbookEvaluator.java:290) ~[poi-3.16.jar:3.16]\n\tat org.apache.poi.ss.formula.WorkbookEvaluator.evaluate(WorkbookEvaluator.java:232) ~[poi-3.16.jar:3.16]\n\tat org.apache.poi.hssf.usermodel.HSSFFormulaEvaluator.evaluateFormulaCellValue(HSSFFormulaEvaluator.java:200) ~[poi-3.16.jar:3.16]\n\tat org.apache.poi.ss.formula.BaseFormulaEvaluator.evaluate(BaseFormulaEvaluator.java:101) ~[poi-3.16.jar:3.16]\n\nI tracked down the bug in org.apache.poi.ss.formula.ptg.NamePtg line 47:\n\nfield_1_label_index = in.readShort();\n\nChanging that to\n\nfield_1_label_index = in.readUShort();\n\nFixes the problem.  I *think* that is the *right* fix, but you guys might know better.", "id": 198615, "time": "2017-05-01T20:06:39Z", "bug_id": 61059, "creation_time": "2017-05-01T20:06:39Z", "attachment_id": 34967}, {"count": 1, "tags": [], "creator": "onealj@apache.org", "attachment_id": null, "is_private": false, "id": 198617, "time": "2017-05-01T21:23:16Z", "bug_id": 61059, "creation_time": "2017-05-01T21:23:16Z", "text": "Does this value need to be written out as a ushort as well?"}, {"count": 2, "tags": [], "bug_id": 61059, "attachment_id": null, "text": "Are you able to share the problematic workbook for inclusion in our unit test suite? Otherwise we could write some unit test code to generate a workbook and check for this AIOOBE. Are you able to figure out what formula string triggered this exception? Does your workbook have greater than 32767 names in the NameManager?", "id": 198618, "time": "2017-05-01T21:50:28Z", "creator": "onealj@apache.org", "creation_time": "2017-05-01T21:50:28Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 61059, "attachment_id": null, "is_private": false, "id": 198619, "time": "2017-05-01T21:54:46Z", "creator": "onealj@apache.org", "creation_time": "2017-05-01T21:54:46Z", "text": "(In reply to Javen O'Neal from comment #1)\n> Does this value need to be written out as a ushort as well?\n\nDisregard this question. It looks like the signed/unsigned differentiation is only made when reading the value. Signed and unsigned shorts have the same binary representation."}, {"count": 4, "text": "Applied in r1796466 without a unit test.\n\nThese changes will be available in POI 3.17 beta 1.\n\nIf anyone can provide a supporting document or unit test to make sure this stays fixed in the future, please reopen this bug and attach the info.", "bug_id": 61059, "is_private": false, "id": 198929, "time": "2017-05-28T01:19:44Z", "creator": "onealj@apache.org", "creation_time": "2017-05-28T01:19:44Z", "tags": [], "attachment_id": null}]