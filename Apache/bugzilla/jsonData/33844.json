[{"count": 0, "tags": [], "creator": "sunlover@anduin.net", "attachment_id": null, "text": "Actually bug is in APR:\n/apr/branches/1.1.x/file_io/os2/open.c\n\nProblem is that when a PUT is made with Content_Range: to a existing DAV\nresource, the file is truncated.\n\nHere are explanation why this happen and how to fix it:\n\nDAV module (dav_fs_open_stream called with DAV_MODE_WRITE_SEEKABLE)\ncalls APR without the APR_TRUNCATE flag:\n    switch (mode) {\n    default:\n        flags = APR_READ | APR_BINARY;\n        break;\n\n    case DAV_MODE_WRITE_TRUNC:\n        flags = APR_WRITE | APR_CREATE | APR_TRUNCATE | APR_BINARY;\n        break;\n    case DAV_MODE_WRITE_SEEKABLE:\n        flags = APR_WRITE | APR_CREATE | APR_BINARY;\n        break;\n    }\n\nbut APR sets OPEN_ACTION_REPLACE_IF_EXISTS for the given APR flags:\n    if (flag & APR_CREATE) {\n        oflags |= OPEN_ACTION_CREATE_IF_NEW;\n        if (!(flag & APR_EXCL)) {\n            if (flag & APR_APPEND)\n                oflags |= OPEN_ACTION_OPEN_IF_EXISTS;\n            else\n                oflags |= OPEN_ACTION_REPLACE_IF_EXISTS;\n        }\n    }\n\nSo the fix is to remove 'if (flag & APR_APPEND)' statement:\n    if (flag & APR_CREATE) {\n        oflags |= OPEN_ACTION_CREATE_IF_NEW;\n        if (!(flag & APR_EXCL)) {\n            oflags |= OPEN_ACTION_OPEN_IF_EXISTS;\n        }\n    }\n\n\nNote that the OPEN_ACTION_REPLACE_IF_EXISTS is explicitly set later\nin the function if APR_TRUNCATE is specified.\n\nI checked Win32 code and file is not truncated there if\nAPR_WRITE | APR_CREATE | APR_BINARY flags are set.\nWhich is a right behaviour.", "id": 71825, "time": "2005-03-04T14:34:30Z", "bug_id": 33844, "creation_time": "2005-03-04T14:34:30Z", "is_private": false}, {"count": 1, "tags": [], "text": "I suggest to assign this defect to Brian Havard a faithful supporter of Apache\non OS/2 and he has a committer role to fix this problem.", "is_private": false, "bug_id": 33844, "id": 76794, "time": "2005-06-29T10:34:57Z", "creator": "lkishalmi@ovi.com", "creation_time": "2005-06-29T10:34:57Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 33844, "is_private": false, "text": "It looks like this should be fixed in 1.2.1 and will be in 0.9.7;\n\nhttp://svn.apache.org/viewcvs?rev=209047&view=rev", "id": 78915, "time": "2005-08-24T13:48:57Z", "creator": "jorton@redhat.com", "creation_time": "2005-08-24T13:48:57Z", "attachment_id": null}]