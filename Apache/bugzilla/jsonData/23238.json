[{"count": 0, "tags": [], "bug_id": 23238, "attachment_id": null, "text": "Apache::Test kills httpd when all the tests were completed with 'kill TERM\n$pid'. Everything is fine unless one of the cleanup handlers is still running.\nIf that's the case apr_pool_clear segfaults with the following trace:\n\n#0  allocator_free (allocator=0x885c110, node=0x0) at apr_pools.c:361\n361             next = node->next;\n(gdb) where\n#0  allocator_free (allocator=0x885c110, node=0x0) at apr_pools.c:361\n#1  0x402675f4 in apr_pool_clear (pool=0x8aa86a0) at apr_pools.c:738\n#2  0x080c1549 in child_main (child_num_arg=142983440) at prefork.c:613\n#3  0x080c1821 in make_child (s=0x811ca60, slot=0) at prefork.c:788\n#4  0x080c189e in startup_children (number_to_start=1) at prefork.c:806\n#5  0x080c1f0d in ap_mpm_run (_pconf=0x8117a78, plog=0x815db90, s=0x0)\n    at prefork.c:1022\n#6  0x080c712a in main (argc=7, argv=0xbffff3a4) at main.c:660\n#7  0x4034dc57 in __libc_start_main () from /lib/i686/libc.so.6\n\nfirst of all it shouldn't segfault. \n\nsecond, shouldn't it wait for the cleanup handler to finish? Consider that the\ncleanup handler is doing some critical job? I've noticed this problem with\nApache::Test but it doesn't go away if you run the normal server...", "id": 44287, "time": "2003-09-18T08:43:37Z", "creator": "stas@stason.org", "creation_time": "2003-09-18T08:43:37Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 23238, "text": "The problem is simply that the SIGTERM handler invokes apr_pool_clear via\nchild_main_exit, and apr_pool_clear is not async-signal-safe by any means.  So\nif the child was already doing some pool operation when the signal handler was\ninvoked, all bets are off.\n\n(1.3 ignored alarms during pool operations to avoid this)\n", "id": 51150, "time": "2004-01-25T17:56:15Z", "creator": "jorton@redhat.com", "creation_time": "2004-01-25T17:56:15Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "text": "I see the same problem running a 2.0.49 server + openssl-0.9.6m. \n \nHere is a complete backtrace of the segfault after sending the http process a \nHUP signal (after serving a SSL page): \n \n#0  0x401dde81 in allocator_free (allocator=0x81aee20, node=0x0) \nat /usr/src/redhat/BUILD/httpd-2.0.49/srclib/apr/memory/unix/apr_pools.c:323 \n#1  0x401dcd3d in apr_pool_clear (pool=0x81fbae0) \nat /usr/src/redhat/BUILD/httpd-2.0.49/srclib/apr/memory/unix/apr_pools.c:713 \n#2  0x0807e8e4 in core_output_filter (f=0x81b9dc0, b=0x81fbb18) \nat /usr/src/redhat/BUILD/httpd-2.0.49/server/core.c:4163 \n#3  0x0807474e in ap_pass_brigade (next=0x81b9dc0, bb=0x81bcd40) \nat /usr/src/redhat/BUILD/httpd-2.0.49/server/util_filter.c:511 \n#4  0x4095c358 in bio_filter_out_flush (bio=0x815f6c0) \nat /usr/src/redhat/BUILD/httpd-2.0.49/modules/ssl/ssl_engine_io.c:154 \n#5  0x4095c4f4 in bio_filter_out_write (bio=0x815f6c0, in=0x81c8cd0 \n\"\\025\\003\", inl=23) \n    at /usr/src/redhat/BUILD/httpd-2.0.49/modules/ssl/ssl_engine_io.c:220 \n#6  0x400c59e5 in BIO_write (b=0x0, in=0x0, inl=1074122364) at bio_lib.c:200 \n#7  0x40040918 in ssl3_write_pending (s=0x81d7a20, type=136052968, \nbuf=0x4005ce7c \"\\210m\\003\", len=1074006047) at s3_pkt.c:740 \n#8  0x4004081f in do_ssl3_write (s=0x81c8cd5, type=136088789, buf=0x4005ce7c \n\"\\210m\\003\", len=1074010422, create_empty_fragment=136052424) at s3_pkt.c:713 \n#9  0x40041936 in ssl3_dispatch_alert (s=0xbfffee8c) at s3_pkt.c:1272 \n#10 0x400418e6 in ssl3_send_alert (s=0x403485a4, level=1077178560, \ndesc=1074122364) at s3_pkt.c:1261 \n#11 0x4003dd23 in ssl3_shutdown (s=0x10000) at s3_lib.c:1240 \n#12 0x40048053 in SSL_shutdown (s=0x81d6e60) at ssl_lib.c:789 \n#13 0x4096caa9 in SSL_smart_shutdown (ssl=0x81bfec8) \nat /usr/src/redhat/BUILD/httpd-2.0.49/modules/ssl/ssl_util_ssl.c:188 \n#14 0x4095d3f4 in ssl_filter_io_shutdown (filter_ctx=0x81b1378, c=0x81b0f98, \nabortive=0) \n    at /usr/src/redhat/BUILD/httpd-2.0.49/modules/ssl/ssl_engine_io.c:955 \n#15 0x4095d513 in ssl_io_filter_cleanup (data=0x81b1378) \nat /usr/src/redhat/BUILD/httpd-2.0.49/modules/ssl/ssl_engine_io.c:996 \n#16 0x401dd779 in run_cleanups (cref=0x81b0eb8) \nat /usr/src/redhat/BUILD/httpd-2.0.49/srclib/apr/memory/unix/apr_pools.c:1951 \n#17 0x401dcd97 in apr_pool_destroy (pool=0x81b0ea8) \nat /usr/src/redhat/BUILD/httpd-2.0.49/srclib/apr/memory/unix/apr_pools.c:730 \n#18 0x401dcd83 in apr_pool_destroy (pool=0x81aeea0) \nat /usr/src/redhat/BUILD/httpd-2.0.49/srclib/apr/memory/unix/apr_pools.c:727 \n#19 0x08064b13 in clean_child_exit (code=0) \nat /usr/src/redhat/BUILD/httpd-2.0.49/server/mpm/prefork/prefork.c:192 \n#20 0x08064d7f in just_die (sig=1) \nat /usr/src/redhat/BUILD/httpd-2.0.49/server/mpm/prefork/prefork.c:324 \n#21 <signal handler called> \n#22 0x40303f40 in __poll (fds=0xbffff260, nfds=1, timeout=15000) \nat ../sysdeps/unix/sysv/linux/poll.c:45 \n#23 0x401de566 in apr_poll (aprset=0xbffff2f0, num=1, nsds=0xbffff2e8, \ntimeout=15000) \nat /usr/src/redhat/BUILD/httpd-2.0.49/srclib/apr/poll/unix/poll.c:129 \n#24 0x401deade in apr_wait_for_io_or_timeout (f=0x0, s=0x81b0ee0, for_read=1) \nat /usr/src/redhat/BUILD/httpd-2.0.49/srclib/apr/support/unix/waitio.c:53 \n#25 0x401d4802 in apr_socket_recv (sock=0x81b0ee0, \n    buf=0x81bdd88 \"HTTP/1.1 304 Not Modified\\r\\nDate: Mon, 05 Apr 2004 \n17:29:19 GMT\\r\\nServer: Apache/2.0.49 (Unix) PHP/4.3.4 mod_ssl/2.0.49 \nOpenSSL/0.9.6m\\r\\nConnection: Keep-Alive\\r\\nKeep-Alive: timeout=15, \nmax=99\\r\\nETag: \\\"5ee\"..., len=0xbffff3dc) \n    at /usr/src/redhat/BUILD/httpd-2.0.49/srclib/apr/network_io/unix/sendrecv.c:86 \n#26 0x40153546 in socket_bucket_read (a=0x81b57d0, str=0xbffff3e0, \nlen=0xbffff3dc, block=APR_BLOCK_READ) \n    at /usr/src/redhat/BUILD/httpd-2.0.49/srclib/apr-util/buckets/apr_buckets_socket.c:35 \n#27 0x0807daf2 in core_input_filter (f=0x81b9da8, b=0x81b9d68, \nmode=AP_MODE_READBYTES, block=APR_BLOCK_READ, readbytes=5) \n    at /usr/src/redhat/BUILD/httpd-2.0.49/server/core.c:3729 \n#28 0x080746aa in ap_get_brigade (next=0x81b9da8, bb=0x81b9d68, \nmode=AP_MODE_READBYTES, block=APR_BLOCK_READ, readbytes=5) \n    at /usr/src/redhat/BUILD/httpd-2.0.49/server/util_filter.c:474 \n#29 0x4095ca42 in bio_filter_in_read (bio=0x81bdd18, in=0x81c04c0 \"\\027\\003\", \ninlen=5) \n    at /usr/src/redhat/BUILD/httpd-2.0.49/modules/ssl/ssl_engine_io.c:485 \n#30 0x400c588f in BIO_read (b=0x0, out=0x40978d1c, outl=1074122364) at \nbio_lib.c:165 \n#31 0x4003fa8e in ssl3_read_n (s=0x0, n=136311980, max=1074122364, \nextend=1074003031) at s3_pkt.c:196 \n#32 0x4003fc57 in ssl3_get_record (s=0x0) at s3_pkt.c:264 \n#33 0x40040c30 in ssl3_read_bytes (s=0x4005ce7c, type=1073786496, \nbuf=0xbffffb34 \"2\u00fc\u00ff\u00bf\", len=1073995636, peek=136052424) at s3_pkt.c:853 \n#34 0x4003df74 in ssl3_read_internal (s=0x0, buf=0x4005ce7c, len=-1073744232, \npeek=1073995556) at s3_lib.c:1325 \n#35 0x4003dff3 in ssl3_read (s=0x81bffa0, buf=0x0, len=135991192) at \ns3_lib.c:1345 \n#36 0x40047e88 in SSL_read (s=0x0, buf=0x40978d1c, num=1083673884) at \nssl_lib.c:739 \n#37 0x4095cc79 in ssl_io_input_read (inctx=0x81b7d20, \n    buf=0x81b7d48 \"\\r\\nst: intratest.net.local\\r\\n\\r\\n: \nintratest.net.local\\r\\n\\r\\npt-Language: en, de\\r\\nHost: \nintratest.net.local\\r\\n\\r\\nept-Language: en, de\\r\\nHost: \nintratest.net.local\\r\\n\\r\\n *;q=0.5\\r\\nAccept-Language: en, de\\r\\nHost: \nintr\"..., len=0xbffff6c8) \n    at /usr/src/redhat/BUILD/httpd-2.0.49/modules/ssl/ssl_engine_io.c:597 \n#38 0x4095ced2 in ssl_io_input_getline (inctx=0x81b7d20, \n    buf=0x81b7d48 \"\\r\\nst: intratest.net.local\\r\\n\\r\\n: \nintratest.net.local\\r\\n\\r\\npt-Language: en, de\\r\\nHost: \nintratest.net.local\\r\\n\\r\\nept-Language: en, de\\r\\nHost: \nintratest.net.local\\r\\n\\r\\n *;q=0.5\\r\\nAccept-Language: en, de\\r\\nHost: \nintr\"..., len=0xbffff708) \n    at /usr/src/redhat/BUILD/httpd-2.0.49/modules/ssl/ssl_engine_io.c:712 \n#39 0x4095dbc5 in ssl_io_filter_input (f=0x81b9d50, bb=0x81fe7b0, \nmode=AP_MODE_GETLINE, block=APR_BLOCK_READ, readbytes=0) \n    at /usr/src/redhat/BUILD/httpd-2.0.49/modules/ssl/ssl_engine_io.c:1228 \n#40 0x080746aa in ap_get_brigade (next=0x81b9d50, bb=0x81fe7b0, \nmode=AP_MODE_GETLINE, block=APR_BLOCK_READ, readbytes=0) \n---Type <return> to continue, or q <return> to quit--- \n    at /usr/src/redhat/BUILD/httpd-2.0.49/server/util_filter.c:474 \n#41 0x0807d6cc in net_time_filter (f=0x81fe750, b=0x81fe7b0, \nmode=AP_MODE_GETLINE, block=APR_BLOCK_READ, readbytes=0) \n    at /usr/src/redhat/BUILD/httpd-2.0.49/server/core.c:3564 \n#42 0x080746aa in ap_get_brigade (next=0x81fe750, bb=0x81fe7b0, \nmode=AP_MODE_GETLINE, block=APR_BLOCK_READ, readbytes=0) \n    at /usr/src/redhat/BUILD/httpd-2.0.49/server/util_filter.c:474 \n#43 0x080759e2 in ap_rgetline_core (s=0x81fdb38, n=8192, read=0xbffff87c, \nr=0x81fdb20, fold=0, bb=0x81fe7b0) \n    at /usr/src/redhat/BUILD/httpd-2.0.49/server/protocol.c:214 \n#44 0x08076028 in read_request_line (r=0x81fdb20, bb=0x81fe7b0) \nat /usr/src/redhat/BUILD/httpd-2.0.49/server/protocol.c:581 \n#45 0x08076841 in ap_read_request (conn=0x81b0f98) \nat /usr/src/redhat/BUILD/httpd-2.0.49/server/protocol.c:858 \n#46 0x0805e2ff in ap_process_http_connection (c=0x81b0f98) \nat /usr/src/redhat/BUILD/httpd-2.0.49/modules/http/http_core.c:243 \n#47 0x08071d12 in ap_run_process_connection (c=0x81b0f98) \nat /usr/src/redhat/BUILD/httpd-2.0.49/server/connection.c:42 \n#48 0x08072100 in ap_process_connection (c=0x81b0f98, csd=0x81b0ee0) \nat /usr/src/redhat/BUILD/httpd-2.0.49/server/connection.c:175 \n#49 0x08065534 in child_main (child_num_arg=1) \nat /usr/src/redhat/BUILD/httpd-2.0.49/server/mpm/prefork/prefork.c:609 \n#50 0x080656be in make_child (s=0x80a5dc8, slot=1) \nat /usr/src/redhat/BUILD/httpd-2.0.49/server/mpm/prefork/prefork.c:703 \n#51 0x08065733 in startup_children (number_to_start=4) \nat /usr/src/redhat/BUILD/httpd-2.0.49/server/mpm/prefork/prefork.c:721 \n#52 0x08065b3c in ap_mpm_run (_pconf=0x80a4028, plog=0x80ce0d0, s=0x80a5dc8) \nat /usr/src/redhat/BUILD/httpd-2.0.49/server/mpm/prefork/prefork.c:940 \n#53 0x0806c721 in main (argc=1, argv=0xbffffb34) \nat /usr/src/redhat/BUILD/httpd-2.0.49/server/main.c:617 \n ", "attachment_id": null, "id": 55339, "creator": "thomas.jarosch@intra2net.com", "time": "2004-04-05T17:40:30Z", "bug_id": 23238, "creation_time": "2004-04-05T17:40:30Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 23238, "attachment_id": null, "id": 55340, "time": "2004-04-05T17:51:34Z", "creator": "jorton@redhat.com", "creation_time": "2004-04-05T17:51:34Z", "is_private": false, "text": "That's a different issue Thomas, bug 27945 has the fix."}, {"count": 4, "tags": [], "bug_id": 23238, "attachment_id": null, "text": "Thank you -very- much for the quick response :-) \n ", "id": 55343, "time": "2004-04-05T18:33:38Z", "creator": "thomas.jarosch@intra2net.com", "creation_time": "2004-04-05T18:33:38Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 23238, "attachment_id": null, "id": 58755, "time": "2004-06-04T13:36:29Z", "creator": "jorton@redhat.com", "creation_time": "2004-06-04T13:36:29Z", "is_private": false, "text": "The bug here remains that the prefork MPM calls async-signal-unsafe pool \nfunctions from a signal handler; so really, the only place to solve this in the\nMPM, maybe using Colm's \"graceful shutdown\" plan.  (applies to worker too, I guess)"}, {"count": 6, "tags": [], "text": "Graceful stop doesn't solve this unfortunately, since it still uses\nnon-async-signal-safe operations from the signal handler :(", "attachment_id": null, "id": 96269, "creator": "jorton@redhat.com", "time": "2006-11-28T06:21:43Z", "bug_id": 23238, "creation_time": "2006-11-28T06:21:43Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 23238, "attachment_id": null, "text": "*** Bug 50702 has been marked as a duplicate of this bug. ***", "id": 143903, "time": "2011-02-02T08:50:44Z", "creator": "jorton@redhat.com", "creation_time": "2011-02-02T08:50:44Z", "is_private": false}]