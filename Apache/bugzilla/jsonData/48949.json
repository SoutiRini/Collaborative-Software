[{"count": 0, "tags": [], "creator": "zlygis@gmail.com", "text": "Any fcgid processes that were active/sleeping before executing graceful apache httpd restart, never gets killed after such restart. They get killed only after hard apache restart. This problem causes fcgid processes to \u201epile up\u201cafter each graceful restart, therefore consuming memory and eventually making the whole system unusable.\n\nerror_log:\n\n[Wed Mar 17 14:02:57 2010] [notice] Graceful restart requested, doing restart\n[Wed Mar 17 14:02:57 2010] [emerg] [client 82.135.207.33] (43)Identifier removed: mod_fcgid: can't get pipe mutex, referer: h$\n[Wed Mar 17 14:02:57 2010] [emerg] [client 78.61.82.52] (43)Identifier removed: mod_fcgid: can't get pipe mutex, referer: htt$\n[Wed Mar 17 14:02:57 2010] [emerg] [client 91.121.87.87] (22)Invalid argument: mod_fcgid: can't lock process table in pid 170$\n[Wed Mar 17 14:02:57 2010] [emerg] [client 91.121.88.99] (22)Invalid argument: mod_fcgid: can't lock process table in pid 160$\n[Wed Mar 17 14:02:57 2010] [emerg] mod_fcgid: server is restarted, pid 27466 must exit\n[Wed Mar 17 14:02:57 2010] [emerg] (22)Invalid argument: mod_fcgid: can't lock process table in PM, pid 27466\n\n\nServer Version: Apache/2.2.15 (Unix) mod_ssl/2.2.15 OpenSSL/0.9.8e-fips-rhel5 mod_bwlimited/1.4 mod_fcgid/2.3.5\nServer Built: Mar 11 2010 13:51:44\nServer loaded APR Version: 1.4.2\nCompiled with APR Version: 1.4.2\nServer loaded APU Version: 1.3.9\nCompiled with APU Version: 1.3.9\nModule Magic Number: 20051115:24\nHostname/port: xxxxxxx:80\nTimeouts: connection: 30    keep-alive: 1\nMPM Name: Prefork\nMPM Information: Max Daemons: 300 Threaded: no Forked: yes\nServer Architecture: 64-bit\nServer Root: /usr/local/apache\nConfig File: /usr/local/apache/conf/includes/pre_main_global.conf\nServer Built With:  -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D HTTPD_ROOT=\"/usr/local/apache\"\n -D SUEXEC_BIN=\"/usr/local/apache/bin/suexec\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"", "id": 135483, "time": "2010-03-20T12:47:33Z", "bug_id": 48949, "creation_time": "2010-03-20T12:47:33Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "piotr.kloc@poszkole.pl", "attachment_id": null, "id": 137178, "time": "2010-05-27T13:08:39Z", "bug_id": 48949, "creation_time": "2010-05-27T13:08:39Z", "is_private": false, "text": "Hello !\n\nPlease try using worker instead of prefork\nI am using that  MPM and process  gets killed normally after graceful\n\nPiotr"}, {"count": 2, "tags": [], "creator": "l.declercq@nuxwin.com", "text": "I can confirm this issue with worker:\n\n[Mon Aug 23 23:29:44 2010] [notice] SIGUSR1 received.  Doing graceful restart\n[Mon Aug 23 23:29:46 2010] [emerg] [client 192.168.0.130] (22)Invalid argument: mod_fcgid: can't lock process table in pid 2302, referer: http://admin.nuxwin.com/reseller/users.php\n[Mon Aug 23 23:29:46 2010] [emerg] [client 192.168.0.130] (22)Invalid argument: mod_fcgid: can't lock process table in pid 2303, referer: http://admin.nuxwin.com/reseller/users.php\n[Mon Aug 23 23:29:47 2010] [notice] Apache/2.2.16 (Debian) mod_fcgid/2.3.5 configured -- resuming normal operations\n\n\nroot@ispcp:~# apache2ctl -V\nServer version: Apache/2.2.16 (Debian)\nServer built:   Jul 24 2010 20:24:16\nServer's Module Magic Number: 20051115:24\nServer loaded:  APR 1.4.2, APR-Util 1.3.9\nCompiled using: APR 1.4.2, APR-Util 1.3.9\nArchitecture:   32-bit\nServer MPM:     Worker\n  threaded:     yes (fixed thread count)\n    forked:     yes (variable process count)\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/worker\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"/etc/apache2\"\n -D SUEXEC_BIN=\"/usr/lib/apache2/suexec\"\n -D DEFAULT_PIDLOG=\"/var/run/apache2.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"mime.types\"\n -D SERVER_CONFIG_FILE=\"apache2.conf\"", "id": 139398, "time": "2010-08-23T20:43:08Z", "bug_id": 48949, "creation_time": "2010-08-23T20:43:08Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "l.declercq@nuxwin.com", "attachment_id": null, "id": 139399, "time": "2010-08-23T20:43:41Z", "bug_id": 48949, "creation_time": "2010-08-23T20:43:41Z", "is_private": false, "text": "Updated to 2.2.16"}, {"count": 4, "tags": [], "bug_id": 48949, "attachment_id": 25933, "is_private": false, "id": 139428, "time": "2010-08-24T19:00:46Z", "creator": "gls@gknw.net", "creation_time": "2010-08-24T19:00:46Z", "text": "Created attachment 25933\nPatch to fix graceful restart/stop bug in Windows"}, {"attachment_id": null, "tags": [], "bug_id": 48949, "is_private": false, "count": 5, "id": 139429, "time": "2010-08-24T19:07:37Z", "creator": "gls@gknw.net", "creation_time": "2010-08-24T19:07:37Z", "text": "Confirmed on Windows XP\n\nLong standing bug going back to Apache/2.2.8 and mod_fcgid/2.2. \nHas as bad of an effect on Windows just Apache's death is a little more sudden.\n\nIf you start at console, use php via mod_fcgid and then restart with a ctrl+ScrLk, you get this;\n\nEvent Type:\tInformation\nEvent Source:\tDrWatson\n\nDescription:\nThe application, H:\\Apache23\\bin\\httpd.exe, generated an application error The error occurred on 08/24/2010 @ 15:13:13.046 The exception generated was c0000005 at address 46434CB2 (mod_fcgid!wakeup_thread)\n\nOpening up Task Manager and looking in the processes you see a long httpd process hanging around. It has a lock on port 80 and the logs so you see nothing in the error log. Apache still is answering at this point but shows stopped and has released the console.\n\nIf Apache is running as a service on your production server, and you restart the service you see this in rapid succession in the event log in order of appearance;\n\nThe Apache service named reported the following error:\n>>> (OS 10048)Only one usage of each socket address (protocol/network address/port) is normally permitted. : make_sock: could not bind to address 0.0.0.0:80 .\n\nThe Apache service named reported the following error:\n>>> no listening sockets available, shutting down .\n\nThe Apache service named reported the following error:\n>>> Unable to open logs\n\nApples and Oranges to some degree since the first event log is running Apache 2.3.8-rc and the following event log entries are from I think Apache 2.2.15 at the time.\n\nIn all cases a Stop/Shutdown does not kill the lone wolf.\n\nThis cause mod_fcgid to become useless cause if mod_fcgid happens to crash, Apache shutsdowns, the lone wolf continues to answer requests till such time as it possibly gets old and dies a good death or fcgid crashes again later down the road and kills the lone wolf. Now your server is not answering requests, and it usually happens 10 minutes after going to bed (Murphy's Law) and you do not notice it till noon the next day.\n\nIIRC this was in the Issue Tracker at Sourceforge and included patches to deal with this on Windows. Why it did not get picked up I do not know. The old tracker seems to have jumped off a cliff into extinction. However, there are still breadcrumbs to be found. The attached patch against trunk is based on one of these breadcrumbs.\n\nGreetings and all credit to Tom.\n\nI believe the caller to procmgr_child_init expects a return or odd things happen later down the road but will not swear to it. I can't see it hurting cause after the patch the function literally does nothing but return APR_SUCCESS. Good explanation of why the bug exists and original patches are in the thread.\n\nhttp://www.mail-archive.com/mod-fcgid-users@lists.sourceforge.net/msg00223.html"}, {"count": 6, "tags": [], "bug_id": 48949, "attachment_id": null, "text": "track the Windows crash with bug 50309, recently opened", "id": 141895, "time": "2010-11-21T19:12:42Z", "creator": "trawick@apache.org", "creation_time": "2010-11-21T19:12:42Z", "is_private": false}, {"count": 7, "tags": [], "creator": "lefty@multihost.cz", "text": "I faced similar problems. On gracefull stop, apache should release logs and close ports and then let the workers finish (or at least I hope so). However worker + fcgi combination blocks the server, until all children quit.\n\nGracefull reload works for me, but spawning scores rise quite high (lots of terminated fcgi apps), so that fcgi refuses to start new workers for quite a long time, because of FcgidSpawnScoreUpLimit.", "id": 141947, "time": "2010-11-23T10:39:00Z", "bug_id": 48949, "creation_time": "2010-11-23T10:39:00Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "wrowe@apache.org", "text": "Apache cannot close/release logs until things have been logged.\n\nThe solution is a mutex that needs again to be refactored between httpd and apr.", "id": 142165, "time": "2010-11-29T23:05:25Z", "bug_id": 48949, "creation_time": "2010-11-29T23:05:25Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 48949, "text": "Getting the bug here as well on:\n\napache2-mpm-worker                  2.2.16-6+squeeze1\nlibapache2-mod-fcgid                1:2.3.6-1", "count": 9, "id": 145749, "time": "2011-04-13T10:39:48Z", "creator": "e065c8515d206cb0e190@gmail.com", "creation_time": "2011-04-13T10:39:48Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 48949, "attachment_id": null, "text": "try setting\n\nGracefulShutdownTimeout 4", "id": 149763, "time": "2011-09-26T12:42:39Z", "creator": "lazy@iq.pl", "creation_time": "2011-09-26T12:42:39Z", "is_private": false}, {"count": 11, "tags": [], "creator": "gls@gknw.net", "text": "Comment on attachment 25933\nPatch to fix graceful restart/stop bug in Windows\n\npatch obsolete, current form of similar patch by Mario Brandt in PR 50309", "id": 151848, "time": "2011-11-28T20:07:30Z", "bug_id": 48949, "creation_time": "2011-11-28T20:07:30Z", "is_private": false, "attachment_id": 25933}, {"count": 12, "tags": [], "creator": "JBlond@gmail.com", "text": "Hasn't this been fixed in PR 50309 ??", "id": 165517, "time": "2013-02-27T20:13:47Z", "bug_id": 48949, "creation_time": "2013-02-27T20:13:47Z", "is_private": false, "attachment_id": null}]