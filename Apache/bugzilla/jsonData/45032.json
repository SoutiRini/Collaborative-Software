[{"count": 0, "tags": [], "creator": "friedrich@disy.net", "attachment_id": null, "is_private": false, "id": 116791, "time": "2008-05-19T01:19:15Z", "bug_id": 45032, "creation_time": "2008-05-19T01:19:15Z", "text": "Tomcat 6.0.16 sometimes throws a ConcurrentModificationException when trying to stop a context. Here is the stack trace:\n\njava.util.ConcurrentModificationException\n\tat java.util.HashMap$HashIterator.nextEntry(HashMap.java:793)\n\tat java.util.HashMap$EntryIterator.next(HashMap.java:834)\n\tat java.util.HashMap$EntryIterator.next(HashMap.java:832)\n\tat java.util.HashMap.putAllForCreate(HashMap.java:435)\n\tat java.util.HashMap.clone(HashMap.java:669)\n\tat org.apache.catalina.loader.WebappClassLoader.clearReferences(WebappClassLoader.java:1594)\n\tat org.apache.catalina.loader.WebappClassLoader.stop(WebappClassLoader.java:1497)\n\tat org.apache.catalina.loader.WebappLoader.stop(WebappLoader.java:707)\n\tat org.apache.catalina.core.StandardContext.stop(StandardContext.java:4550)\n\tat org.apache.catalina.core.ContainerBase.removeChild(ContainerBase.java:924)\n\tat de.disy.vcc.service.TomcatContextService.stopContext(TomcatContextService.java:174)\n\tat de.disy.vcc.service.AdminService.stopMandant(AdminService.java:224)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:597)\n\tat org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:310)\n\tat org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:198)\n\tat $Proxy186.stopMandant(Unknown Source)\n\tat de.disy.vcc.web.admin.MandantOverviewController.handleStop(MandantOverviewController.java:99)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:597)\n\tat org.springframework.web.servlet.mvc.multiaction.MultiActionController.invokeNamedMethod(MultiActionController.java:473)\n\tat org.springframework.web.servlet.mvc.multiaction.MultiActionController.handleRequestInternal(MultiActionController.java:410)\n\tat org.springframework.web.servlet.mvc.AbstractController.handleRequest(AbstractController.java:153)\n\tat org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter.handle(SimpleControllerHandlerAdapter.java:48)\n\tat org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:874)\n\tat org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:808)\n\tat org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:523)\n\tat org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:463)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:710)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:803)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n\tat net.disy.commons.servlet.filter.IECacheSSLBugWorkaroundFilter.doFilter(IECacheSSLBugWorkaroundFilter.java:51)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n\tat org.displaytag.filter.ResponseOverrideFilter.doFilter(ResponseOverrideFilter.java:125)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n\tat org.springframework.orm.hibernate3.support.OpenSessionInViewFilter.doFilterInternal(OpenSessionInViewFilter.java:198)\n\tat org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:75)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:175)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:128)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:286)\n\tat org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:844)\n\tat org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:583)\n\tat org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:447)\n\tat java.lang.Thread.run(Thread.java:619)"}, {"count": 1, "tags": [], "bug_id": 45032, "text": "To quote from the new system props doc that will be in 6.0.17 onwards...\n\n<quote>\norg.apache.catalina.loader.WebappClassLoader.ENABLE_CLEAR_REFERENCES\t\n\nIf true, Tomcat attempts to null out any static or final fields from loaded classes when a web application is stopped as a work around for apparent garbage collection bugs and application coding errors.\nThere have been some issues reported with log4j when this option is true.\nApplications without memory leaks using recent JVMs should operate correctly with this option set to false.\nIf not specified, the default value of true will be used.\n</quote>\n\nThe bug you are seeing is a result of this system property defaulting to true. If your application and any libraries it uses clean up correctly after themselves on context stop you should be safe to set this system property to false and the error should go away.\n\nChanging the default to false would fix this error. However, this property has fixed a number of other issue so on balance a default of true is probably the right way to go for now.", "id": 116829, "time": "2008-05-19T13:20:38Z", "creator": "markt@apache.org", "creation_time": "2008-05-19T13:20:38Z", "is_private": false, "attachment_id": null}]