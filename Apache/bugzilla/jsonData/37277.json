[{"count": 0, "tags": [], "bug_id": 37277, "attachment_id": null, "text": "I'm using Tomcat 5.5.9, but I see from\nhttp://forum.java.sun.com/thread.jspa?messageID=3951945 that it's still an issue\nin 5.5.12. JDK1.5\n\nWhen Tomcat starts without webapps, it starts quickly: within a few seconds I\ncan type http://localhost/manager/html/list in a browser and get a response.\nBut when I put webapps in (either with a <Context> in server.xml or by dropping\nthem in the webapps folder), Tomcat can take 14 min, 24 min, or even longer to\nstart up. During that time, browser requests are met with an endlessly circling\nthrobber.\nThe webapp I'm using is Cocoon, but others (see above link) have reported the\nsame problem with other webapps. The problem has been intermittent for us, but\nright now on our production server, it is happening every time.\n\nThere are no errors in the Cocoon logs.\nAn excerpt from the Tomcat stderr log shows where it took over 24 minutes to get\nfrom\n   Oct 27, 2005 10:21:59 AM org.apache.catalina.core.StandardHost start\n   INFO: XML validation disabled\nto \n   Oct 27, 2005 10:46:06 AM org.apache.coyote.http11.Http11Protocol start\n   INFO: Starting Coyote HTTP/1.1 on http-8080\n\nOct 27, 2005 10:21:58 AM org.apache.coyote.http11.Http11Protocol init\nINFO: Initializing Coyote HTTP/1.1 on http-8080\nOct 27, 2005 10:21:58 AM org.apache.catalina.startup.Catalina load\nINFO: Initialization processed in 1031 ms\nOct 27, 2005 10:21:59 AM org.apache.catalina.core.StandardService start\nINFO: Starting service Catalina\nOct 27, 2005 10:21:59 AM org.apache.catalina.core.StandardEngine start\nINFO: Starting Servlet Engine: Apache Tomcat/5.5.9\nOct 27, 2005 10:21:59 AM org.apache.catalina.core.StandardHost start\nINFO: XML validation disabled\nOct 27, 2005 10:46:06 AM org.apache.coyote.http11.Http11Protocol start\nINFO: Starting Coyote HTTP/1.1 on http-8080\nOct 27, 2005 10:46:06 AM org.apache.jk.common.ChannelSocket init\nINFO: JK: ajp13 listening on /0.0.0.0:8009\nOct 27, 2005 10:46:06 AM org.apache.jk.server.JkMain start\nINFO: Jk running ID=0 time=0/46  config=null\nOct 27, 2005 10:46:06 AM org.apache.catalina.storeconfig.StoreLoader load\nINFO: Find registry server-registry.xml at classpath resource\nOct 27, 2005 10:46:06 AM org.apache.catalina.startup.Catalina start\nINFO: Server startup in 1448022 ms\n\nThinking the delay might be caused by the XML parser trying to chase down DTD\nurls in XML config files, I removed such DOCTYPE declarations where I could find\nthem. But it didn't help.\nI really don't know if this is a Tomcat bug, but it's a serious problem.\n\nIncidentally, we upped our Java memory settings to 512MB (init) and 1024MB\n(max), but that didn't help.", "id": 81845, "time": "2005-10-27T19:37:12Z", "creator": "lars@huttar.net", "creation_time": "2005-10-27T19:37:12Z", "is_private": false}, {"text": "P.S. Interesting correlation...\nWhen I had Tomcat configured to run one instance of a Cocoon webapp, it took 24\nminutes to start. When there were two instances of Cocoon, it took 48 minutes. Hmm!", "tags": [], "bug_id": 37277, "attachment_id": null, "count": 1, "id": 81846, "time": "2005-10-27T19:39:49Z", "creator": "lars@huttar.net", "creation_time": "2005-10-27T19:39:49Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 37277, "text": "Get thread dumps while the startup is in progress.", "id": 81848, "attachment_id": null, "creator": "remm@apache.org", "creation_time": "2005-10-27T19:54:21Z", "time": "2005-10-27T19:54:21Z", "is_private": false}, {"count": 3, "tags": [], "creator": "funkman@joedog.org", "attachment_id": null, "id": 81853, "time": "2005-10-27T20:24:47Z", "bug_id": 37277, "creation_time": "2005-10-27T20:24:47Z", "is_private": false, "text": "The slow startup is probably due to tomcat looking for tld files (that have\nlisteners) inside of jar files and in the file system (as required by the spec).\n\nIf all your listeners are in web.xml - you can bypass this via \nprocessTlds=false.\n\nhttp://tomcat.apache.org/tomcat-5.5-doc/config/context.html\n\n"}, {"count": 4, "tags": [], "creator": "lars@huttar.net", "attachment_id": null, "id": 81856, "time": "2005-10-27T21:15:54Z", "bug_id": 37277, "creation_time": "2005-10-27T21:15:54Z", "is_private": false, "text": "(In reply to comment #2)\nThanks for your quick response.\n> Get thread dumps while the startup is in progress.\nCan you tell me how or give me a pointer to instructions?\n\n> If all your listeners are in web.xml - you can bypass this via\n> processTlds=false.\n> http://tomcat.apache.org/tomcat-5.5-doc/config/context.html\n\nI don't know about listeners being in web.xml.\nI have my <Context> elements in server.xml. I added processTlds=\"false\" to both\n<Context> elements. This did not fix the problem (no discernable change)."}, {"count": 5, "tags": [], "creator": "lars@huttar.net", "attachment_id": null, "id": 81857, "time": "2005-10-27T21:19:43Z", "bug_id": 37277, "creation_time": "2005-10-27T21:19:43Z", "is_private": false, "text": "A couple of other details in case they should help...\n1) The server where this problem occurs is in the DMZ.\n2) We did not see this problem happening under Tomcat 5.0.27 on this server\n(though I couldn't guarantee that we had things configured the same way as we do\nunder Tomcat 5.5.9)."}, {"text": "Created attachment 16823\nPatch for tc5.5.x/container/webapps/docs/config/context.xml\n\nMinor addition to the docs for processTlds based on Tim's comment #3.", "tags": [], "bug_id": 37277, "attachment_id": 16823, "count": 6, "id": 81867, "time": "2005-10-27T22:34:51Z", "creator": "wsmoak@apache.org", "creation_time": "2005-10-27T22:34:51Z", "is_private": false}, {"count": 7, "tags": [], "creator": "kakvicky@yahoo.co.in", "attachment_id": null, "id": 82389, "time": "2005-11-11T10:30:32Z", "bug_id": 37277, "creation_time": "2005-11-11T10:30:32Z", "is_private": false, "text": "Thread dump on the windows system can be achieved by typing Control+Break."}, {"count": 8, "tags": [], "bug_id": 37277, "attachment_id": null, "text": "(In reply to comment #7)\n> Thread dump on the windows system can be achieved by typing Control+Break.\n\nI started Tomcat using Tomcat5.exe in a command window, so that it would be\navailable for Ctrl+Break.\nWhen I press Ctrl+Break, nothing happens.\nWhen I press Ctrl+C, I get the following stack trace:\n\nNov 16, 2005 2:15:33 PM org.apache.catalina.startup.Catalina stopServer\nSEVERE: Catalina.stop:\njava.net.ConnectException: Connection refused: connect\n        at java.net.PlainSocketImpl.socketConnect(Native Method)\n        at java.net.PlainSocketImpl.doConnect(Unknown Source)\n        at java.net.PlainSocketImpl.connectToAddress(Unknown Source)\n        at java.net.PlainSocketImpl.connect(Unknown Source)\n        at java.net.SocksSocketImpl.connect(Unknown Source)\n        at java.net.Socket.connect(Unknown Source)\n        at java.net.Socket.connect(Unknown Source)\n        at java.net.Socket.<init>(Unknown Source)\n        at java.net.Socket.<init>(Unknown Source)\n        at org.apache.catalina.startup.Catalina.stopServer(Catalina.java:394)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)\n        at java.lang.reflect.Method.invoke(Unknown Source)\n        at org.apache.catalina.startup.Bootstrap.stopServer(Bootstrap.java:320)\n        at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:411)\n- VM shutting down with the disk store for cocoon-ehcache-1 still active. The di\nsk store is persistent. Calling dispose...\n\nFWIW, the output of tomcat5.exe up to where it hung ended with:\n\n- Ignored element 'init-param' as child of 'servlet'.\n- Ignored element 'display-name' as child of 'servlet'.\n- Ignored element 'init-param' as child of 'servlet'.\n- ServletContext 'd:\\Apache Software Foundation\\Tomcat 5.5\\webapps\\..\\..\\cocoon-\n2.1.7\\' initialized.\n- The database 'db' root directory has been set to D:\\Apache Software Foundation\n\\cocoon-2.1.7\\WEB-INF\\db. Keep in mind that if a war upgrade will take place the\n database will be lost.\n- Database points to D:\\Apache Software Foundation\\cocoon-2.1.7\\WEB-INF\\db\n- Database 'db' successfully opened\n- Xindice server successfully started\ntrying to register database\ntrying to register database\n- RAMJobStore initialized.\n- Quartz scheduler 'Cocoon\n- Quartz scheduler version: 1.4.5\n- Scheduler Cocoon_$_Wed_Nov_16_14:14:32_CST_2005 started.\n\nThe log file catalina.2005-11-16.log contained:\n\nNov 16, 2005 2:14:21 PM org.apache.coyote.http11.Http11Protocol init\nINFO: Initializing Coyote HTTP/1.1 on http-80\nNov 16, 2005 2:14:21 PM org.apache.catalina.startup.Catalina load\nINFO: Initialization processed in 1047 ms\nNov 16, 2005 2:14:21 PM org.apache.catalina.core.StandardService start\nINFO: Starting service Catalina\nNov 16, 2005 2:14:21 PM org.apache.catalina.core.StandardEngine start\nINFO: Starting Servlet Engine: Apache Tomcat/5.5.9\nNov 16, 2005 2:14:21 PM org.apache.catalina.core.StandardHost start\nINFO: XML validation disabled\n(this is where Tomcat hung)\n\nAnyone have ideas as to why it's waiting for so long?\nIt sounds like it's waiting on a SocketConnect, but to where, and why?\n\nThanks for any help...", "id": 82595, "time": "2005-11-16T21:32:53Z", "creator": "lars@huttar.net", "creation_time": "2005-11-16T21:32:53Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 37277, "text": "Another datapoint to consider: reloading the Cocoon webapp without restarting\nTomcat takes much less time (maybe a minute). So the problem appears to be in\nTomcat, not Cocoon.\n\nAgain, this problem occurs in our production environment but not in our test or\ndevelopment environments (except when the dev envt is a laptop at home). The\nproduction environment is in a DMZ. So could this indicate that somehow Tomcat\nis trying to open a connection to a machine that it doesn't have access to, and\nkeeps waiting for the connection to time out?", "id": 82600, "attachment_id": null, "creator": "lars@huttar.net", "creation_time": "2005-11-16T22:58:09Z", "time": "2005-11-16T22:58:09Z", "is_private": false}, {"count": 10, "tags": [], "creator": "yoavs@computer.org", "attachment_id": null, "id": 87972, "time": "2006-04-13T19:51:54Z", "bug_id": 37277, "creation_time": "2006-04-13T19:51:54Z", "is_private": false, "text": "By the same token, the fact that Tomcat by itself out of the box starts quickly\nwould mean it's a webapp-specific issue.  For me, Tomcat out of the box starts\nin ~1.2sec on average, and the Cocoon samples from\nhttp://cocoon.apache.org/2.1/howto/howto-explore-samples.html only add a couple\nof seconds to startup time.  Maybe it's a function of your production CMS DB size?\n\nThe Socket Connect theory is a decent one, too.  If a file needed by a tag\nlibrary (TLD) or other specifications (e.g. the Servlet Spec web.xml DTD or XSD)\nis not locally available, the server will try to go get it.  Those files should\nbe locally available, though -- I'd check that the server account has read\npermissions on everything locally under the server root."}, {"count": 11, "tags": [], "creator": "markt@apache.org", "text": "Based on Yoav's test of the Cocoon sample application I am resolving this as\nWORKSFORME.\n\nAnother point to consider is that it appears at least some (all?) of the users\nexperiencing problems are running Tomcat as a Windows service. It is worth\nseeing if you see the same issue running from the command line.\n\nIf there is an issue here, and I am not yet convinced there is, we need a\nrepeatable text case we can use to investigate further.", "id": 95093, "time": "2006-10-25T20:06:33Z", "bug_id": 37277, "creation_time": "2006-10-25T20:06:33Z", "is_private": false, "attachment_id": null}]