[{"count": 0, "tags": [], "creator": "tadanori2007@yahoo.com", "attachment_id": null, "is_private": false, "id": 160095, "time": "2012-06-19T12:31:18Z", "bug_id": 53435, "creation_time": "2012-06-19T12:31:18Z", "text": "Hello,\n\nI installed httpd 2.4.2 on CentOS6.2(64bit).\nIt seems like httpd leaks memory when mod_ssl is used.\nWhen I start up httpd with mod_ssl, and when I issue \"apachectl graceful\",\nit seems like httpd leaks memory.\n\nIf I issue \"apachectl graceful\" 1000 times, ps command shows\nthe memory usage gets bigger like below:\n\n====Before 1000 times graceful restart====\n# ps -elfy | head -1\nS UID        PID  PPID  C PRI  NI   RSS    SZ WCHAN  STIME TTY          TIME CMD\n# ps -elfy | grep httpd | grep -v grep\nS root      3816     1  0  80   0  4136 25683 poll_s 15:00 ?        00:00:00 /opt/testhttpd/bin/httpd\nS daemon    3818  3816  0  80   0  5216 111748 pipe_w 15:00 ?       00:00:00 /opt/testhttpd/bin/httpd\nS daemon    3819  3816  0  80   0  5220 111748 pipe_w 15:00 ?       00:00:00 /opt/testhttpd/bin/httpd\nS daemon    3820  3816  0  80   0  5220 111748 pipe_w 15:00 ?       00:00:00 /opt/testhttpd/bin/httpd\n#\n\n====After 1000 times graceful restart====\n# ps -elfy | head -1\nS UID        PID  PPID  C PRI  NI   RSS    SZ WCHAN  STIME TTY          TIME CMD\n# ps -elfy | grep httpd | grep -v grep\nS root      3816     1  6  80   0 97320 48673 poll_s 15:00 ?        00:01:23 /opt/testhttpd/bin/httpd\nS daemon   28584  3816  0  80   0 97448 134738 pipe_w 15:19 ?       00:00:00 /opt/testhttpd/bin/httpd\nS daemon   28585  3816  0  80   0 95416 134738 pipe_w 15:19 ?       00:00:00 /opt/testhttpd/bin/httpd\nS daemon   28588  3816  0  80   0 97460 134738 pipe_w 15:19 ?       00:00:00 /opt/testhttpd/bin/httpd\n#\n\n\nYou can reproduce this by:\n1. start httpd with mod_ssl loaded.\n2. issue \"apachectl graceful\" 1000 times.\n\nI configured my httpd with following:\n  # ./configure --prefix=/opt/testhttpd --with-included-apr\n\n\n\nIf I start up httpd without mod_ssl, memory usage does not get bigger\neven after 1000 times graceful restart.\nThe evidence is below:\n====Before 1000 times graceful restart====\n# ps -elfy | head -1\nS UID        PID  PPID  C PRI  NI   RSS    SZ WCHAN  STIME TTY          TIME CMD\n# ps -elfy | grep httpd | grep -v grep\nS root     25061     1  0  80   0  2632 18365 poll_s 15:43 ?        00:00:00 /opt/testhttpd/bin/httpd\nS daemon   25063 25061  0  80   0  4504 104430 pipe_w 15:43 ?       00:00:00 /opt/testhttpd/bin/httpd\nS daemon   25064 25061  0  80   0  4504 104430 pipe_w 15:43 ?       00:00:00 /opt/testhttpd/bin/httpd\nS daemon   25065 25061  0  80   0  4508 104430 pipe_w 15:43 ?       00:00:00 /opt/testhttpd/bin/httpd\n#\n====After 1000 times graceful restart====\n# ps -elfy | head -1\nS UID        PID  PPID  C PRI  NI   RSS    SZ WCHAN  STIME TTY          TIME CMD\n# ps -elfy | grep httpd | grep -v grep\nS daemon   17566 25061  0  80   0  4784 104430 pipe_w 16:01 ?       00:00:00 /opt/testhttpd/bin/httpd\nS daemon   17567 25061  0  80   0  4788 104430 pipe_w 16:01 ?       00:00:00 /opt/testhttpd/bin/httpd\nS daemon   17568 25061  0  80   0  4792 104430 pipe_w 16:01 ?       00:00:00 /opt/testhttpd/bin/httpd\nS root     25061     1  0  80   0  3264 18365 poll_s 15:43 ?        00:00:06 /opt/testhttpd/bin/httpd\n#\n\n\nAre there memory leaks in mod_ssl module?\n\n\nThanks,\nTadanori"}, {"count": 1, "tags": [], "text": "This was also brought up on httpd-dev in October 2008 (with no final conclusion, though):\n\nhttp://mail-archives.apache.org/mod_mbox/httpd-dev/200810.mbox/%3C48F91F01.4010802@force-elite.com%3E\n\n(For the sake of reference: a link to your original post to the users list - http://mail-archives.apache.org/mod_mbox/httpd-users/201206.mbox/%3C1339507051.6642.YahooMailClassic%40web140201.mail.bf1.yahoo.com%3E - would have been appreciated.)", "is_private": false, "id": 160497, "creator": "asfbugz@velox.ch", "time": "2012-07-08T09:53:35Z", "bug_id": 53435, "creation_time": "2012-07-08T09:53:35Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 53435, "text": "Hi,\n\ni believe to have run into the same issue.\nGraceful restarts every 5 minutes fill up about 400mb of ram in a day.\n\nWith mdb and ::findleaks i've tracked it down to stacktraces like this:\n\n            ADDR          BUFADDR        TIMESTAMP           THREAD\n                            CACHE          LASTLOG         CONTENTS\n          811e40           80fd20   40b3df2f559484                1\n                           4bd668                0                0\n                 libumem.so.1`umem_cache_alloc_debug+0xfd\n                 libumem.so.1`umem_cache_alloc+0xb3\n                 libumem.so.1`umem_alloc+0x64\n                 libumem.so.1`umem_malloc+0x3f\n                 libcrypto.so.1.0.0`CRYPTO_malloc+0x5d\n                 libcrypto.so.1.0.0`lh_insert+0x1fe\n                 libcrypto.so.1.0.0`int_err_set_item+0x4f\n                 libcrypto.so.1.0.0`ERR_load_strings+0x41\n                 libssl.so.1.0.0`ERR_load_SSL_strings+0x2e\n                 mod_ssl.so`ssl_hook_pre_config+0x30\n                 ap_run_pre_config+0x60\n                 main+0x905\n                 _start+0x6c\n\n\nWhich sent me looking for ERR_free_strings().\nIt turns out that this was removed over 10 years ago in the following commit: https://github.com/apache/httpd/commit/e2ee089fd414675144e347fc4624b1a665aac671\n\nI have build 2.4.10 with this change reverted and it absolutly fixes the issue for us.\n\nAll tests were done with 2.4.10 on SmartOS (Illumos) from pkgsrc and openssl-1.0.1h.\n\nI'm not sure if the reason for the removal is still valid (maybe something changed in openssl).\nNeither am I sure that reverting that commit won't break the error strings (don't know how to test).\nOf course I'm also wondering why this is not a bigger problem for other users, but maybe they don't do graceful restarts that often ;-)\n\nSo maybe someone who knows a bit more on that topic can help here...", "id": 178612, "time": "2014-10-19T22:16:39Z", "creator": "wiedi@frubar.net", "creation_time": "2014-10-19T22:16:39Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 53435, "attachment_id": null, "text": "Thanks Sebastian. I've committed the fix based on your debugging in r1638772.", "id": 179059, "time": "2014-11-12T12:29:11Z", "creator": "jkaluza@redhat.com", "creation_time": "2014-11-12T12:29:11Z", "is_private": false}, {"count": 4, "tags": [], "text": "Proposed to 2.4.x.", "is_private": false, "id": 179076, "creator": "jkaluza@redhat.com", "time": "2014-11-13T08:59:19Z", "bug_id": 53435, "creation_time": "2014-11-13T08:59:19Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 53435, "attachment_id": null, "id": 180517, "time": "2015-01-23T09:47:09Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2015-01-23T09:47:09Z", "is_private": false, "text": "Backported to 2.4.11 in r1642404."}]