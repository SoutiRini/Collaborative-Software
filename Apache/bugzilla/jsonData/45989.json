[{"count": 0, "attachment_id": null, "bug_id": 45989, "text": "The tomcat deployer apparently does not check the integrity of a war before undeploying the existing application and deploying the new version.\n\nTo re-create this, start tomcat and deploy a war by copying, over the network, a large war directly into the webapps directory.   I get the following output:\n\nINFO: Deploying web application archive some.war\nOct 10, 2008 11:40:05 AM org.apache.catalina.startup.ContextConfig init\nSEVERE: Exception fixing docBase: {0}\njava.util.zip.ZipException: Could not find End Of Central Directory\n        at java.util.zip.ZipFile.open(Native Method)\n        at java.util.zip.ZipFile.<init>(ZipFile.java:117)\n        at java.util.jar.JarFile.<init>(JarFile.java:133)\n        at java.util.jar.JarFile.<init>(JarFile.java:70)\n        at sun.net.www.protocol.jar.URLJarFile.<init>(URLJarFile.java:72)\n        at sun.net.www.protocol.jar.URLJarFile.getJarFile(URLJarFile.java:48)\n        at sun.net.www.protocol.jar.JarFileFactory.get(JarFileFactory.java:68)\n        at sun.net.www.protocol.jar.JarURLConnection.connect(JarURLConnection.java:104)\n        at sun.net.www.protocol.jar.JarURLConnection.getJarFile(JarURLConnection.java:71)\n        at org.apache.catalina.startup.ExpandWar.expand(ExpandWar.java:141)\n        at org.apache.catalina.startup.ContextConfig.fixDocBase(ContextConfig.java:883)\n        at org.apache.catalina.startup.ContextConfig.init(ContextConfig.java:1012)\n        at org.apache.catalina.startup.ContextConfig.lifecycleEvent(ContextConfig.java:279)\n        at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:117)\n        at org.apache.catalina.core.StandardContext.init(StandardContext.java:5341)\n        at org.apache.catalina.core.StandardContext.start(StandardContext.java:4086)\n        at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:792)\n        at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:771)\n        at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:527)\n        at org.apache.catalina.startup.HostConfig.deployWAR(HostConfig.java:830)\n        at org.apache.catalina.startup.HostConfig.deployWARs(HostConfig.java:719)\n        at org.apache.catalina.startup.HostConfig.deployApps(HostConfig.java:492)\n        at org.apache.catalina.startup.HostConfig.check(HostConfig.java:1217)\n        at org.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java:293)\n        at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:117)\n        at org.apache.catalina.core.ContainerBase.backgroundProcess(ContainerBase.java:1338)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1601)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1610)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run(ContainerBase.java:1590)\n        at java.lang.Thread.run(Thread.java:619)\nOct 10, 2008 11:40:05 AM org.apache.catalina.core.StandardContext resourcesStart\nSEVERE: Error starting static Resources\njava.lang.IllegalArgumentException: Invalid or unreadable WAR file : Could not find End Of Central Directory\n        at org.apache.naming.resources.WARDirContext.setDocBase(WARDirContext.java:135)\n        at org.apache.catalina.core.StandardContext.resourcesStart(StandardContext.java:3957)\n        at org.apache.catalina.core.StandardContext.start(StandardContext.java:4126)\n        at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:791)\n        at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:771)\n        at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:525)\n        at org.apache.catalina.startup.HostConfig.deployWAR(HostConfig.java:830)\n        at org.apache.catalina.startup.HostConfig.deployWARs(HostConfig.java:719)\n        at org.apache.catalina.startup.HostConfig.deployApps(HostConfig.java:490)\n        at org.apache.catalina.startup.HostConfig.check(HostConfig.java:1217)\n        at org.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java:293)\n        at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:117)\n        at org.apache.catalina.core.ContainerBase.backgroundProcess(ContainerBase.java:1337)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1601)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1610)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run(ContainerBase.java:1590)\n        at java.lang.Thread.run(Thread.java:619)\nOct 10, 2008 11:40:05 AM org.apache.catalina.core.StandardContext start\nSEVERE: Error in resourceStart() \nOct 10, 2008 11:40:05 AM org.apache.catalina.core.StandardContext start\nSEVERE: Error getConfigured\nOct 10, 2008 11:40:05 AM org.apache.catalina.core.StandardContext start\nSEVERE: Context [/some] startup failed due to previous errors\nOct 10, 2008 11:40:05 AM org.apache.catalina.core.StandardContext stop\nINFO: Container org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/some] has not been started\nOct 10, 2008 11:40:15 AM org.apache.catalina.startup.HostConfig checkResources\nINFO: Undeploying context [/some] \nOct 10, 2008 11:40:15 AM org.apache.catalina.startup.HostConfig deployWAR\nINFO: Deploying web application archive some.war\nOct 10, 2008 11:40:15 AM org.apache.catalina.startup.ContextConfig init\nSEVERE: Exception fixing docBase: {0}\njava.util.zip.ZipException: Could not find End Of Central Directory\n        at java.util.zip.ZipFile.open(Native Method)\n        at java.util.zip.ZipFile.<init>(ZipFile.java:117)\n        at java.util.jar.JarFile.<init>(JarFile.java:133)\n        at java.util.jar.JarFile.<init>(JarFile.java:70)\n        at sun.net.www.protocol.jar.URLJarFile.<init>(URLJarFile.java:72)\n        at sun.net.www.protocol.jar.URLJarFile.getJarFile(URLJarFile.java:48)\n        at sun.net.www.protocol.jar.JarFileFactory.get(JarFileFactory.java:68)\n        at sun.net.www.protocol.jar.JarURLConnection.connect(JarURLConnection.java:104)\n        at sun.net.www.protocol.jar.JarURLConnection.getJarFile(JarURLConnection.java:71)\n        at org.apache.catalina.startup.ExpandWar.expand(ExpandWar.java:141)\n        at org.apache.catalina.startup.ContextConfig.fixDocBase(ContextConfig.java:883)\n        at org.apache.catalina.startup.ContextConfig.init(ContextConfig.java:1012)\n        at org.apache.catalina.startup.ContextConfig.lifecycleEvent(ContextConfig.java:279)\n        at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:117)\n        at org.apache.catalina.core.StandardContext.init(StandardContext.java:5341)\n        at org.apache.catalina.core.StandardContext.start(StandardContext.java:4086)\n        at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:792)\n        at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:771)\n        at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:527)\n        at org.apache.catalina.startup.HostConfig.deployWAR(HostConfig.java:830)\n        at org.apache.catalina.startup.HostConfig.deployWARs(HostConfig.java:719)\n        at org.apache.catalina.startup.HostConfig.deployApps(HostConfig.java:492)\n        at org.apache.catalina.startup.HostConfig.check(HostConfig.java:1217)\n        at org.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java:293)\n        at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:117)\n        at org.apache.catalina.core.ContainerBase.backgroundProcess(ContainerBase.java:1338)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1601)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1610)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run(ContainerBase.java:1590)\n        at java.lang.Thread.run(Thread.java:619)\nOct 10, 2008 11:40:15 AM org.apache.catalina.core.StandardContext resourcesStart\nSEVERE: Error starting static Resources\njava.lang.IllegalArgumentException: Invalid or unreadable WAR file : Could not find End Of Central Directory\n        at org.apache.naming.resources.WARDirContext.setDocBase(WARDirContext.java:135)\n        at org.apache.catalina.core.StandardContext.resourcesStart(StandardContext.java:3957)\n        at org.apache.catalina.core.StandardContext.start(StandardContext.java:4126)\n        at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:791)\n        at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:771)\n        at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:525)\n        at org.apache.catalina.startup.HostConfig.deployWAR(HostConfig.java:830)\n        at org.apache.catalina.startup.HostConfig.deployWARs(HostConfig.java:719)\n        at org.apache.catalina.startup.HostConfig.deployApps(HostConfig.java:490)\n        at org.apache.catalina.startup.HostConfig.check(HostConfig.java:1217)\n        at org.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java:293)\n        at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:117)\n        at org.apache.catalina.core.ContainerBase.backgroundProcess(ContainerBase.java:1337)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1601)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1610)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run(ContainerBase.java:1590)\n        at java.lang.Thread.run(Thread.java:619)\nOct 10, 2008 11:40:05 AM org.apache.catalina.core.StandardContext start\nSEVERE: Error in resourceStart() \nOct 10, 2008 11:40:05 AM org.apache.catalina.core.StandardContext start\nSEVERE: Error getConfigured\nOct 10, 2008 11:40:05 AM org.apache.catalina.core.StandardContext start\nSEVERE: Context [/some] startup failed due to previous errors\nOct 10, 2008 11:40:05 AM org.apache.catalina.core.StandardContext stop\nINFO: Container org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/some] has not been started\nOct 10, 2008 11:40:15 AM org.apache.catalina.startup.HostConfig checkResources\nINFO: Undeploying context [/some] \nOct 10, 2008 11:40:15 AM org.apache.catalina.startup.HostConfig deployWAR\nINFO: Deploying web application archive some.war\nOct 10, 2008 11:40:15 AM org.apache.catalina.startup.ContextConfig init\nSEVERE: Exception fixing docBase: {0}\njava.util.zip.ZipException: Could not find End Of Central Directory\n        at java.util.zip.ZipFile.open(Native Method)\n        at java.util.zip.ZipFile.<init>(ZipFile.java:117)\n        at java.util.jar.JarFile.<init>(JarFile.java:133)\n        at java.util.jar.JarFile.<init>(JarFile.java:70)\n        at sun.net.www.protocol.jar.URLJarFile.<init>(URLJarFile.java:72)\n        at sun.net.www.protocol.jar.URLJarFile.getJarFile(URLJarFile.java:48)\n        at sun.net.www.protocol.jar.JarFileFactory.get(JarFileFactory.java:68)\n        at sun.net.www.protocol.jar.JarURLConnection.connect(JarURLConnection.java:104)\n        at sun.net.www.protocol.jar.JarURLConnection.getJarFile(JarURLConnection.java:71)\n        at org.apache.catalina.startup.ExpandWar.expand(ExpandWar.java:141)\n        at org.apache.catalina.startup.ContextConfig.fixDocBase(ContextConfig.java:883)\n        at org.apache.catalina.startup.ContextConfig.init(ContextConfig.java:1012)\n        at org.apache.catalina.startup.ContextConfig.lifecycleEvent(ContextConfig.java:279)\n        at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:117)\n        at org.apache.catalina.core.StandardContext.init(StandardContext.java:5341)\n        at org.apache.catalina.core.StandardContext.start(StandardContext.java:4086)\n        at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:792)\n        at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:771)\n        at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:527)\n        at org.apache.catalina.startup.HostConfig.deployWAR(HostConfig.java:830)\n        at org.apache.catalina.startup.HostConfig.deployWARs(HostConfig.java:719)\n        at org.apache.catalina.startup.HostConfig.deployApps(HostConfig.java:492)\n        at org.apache.catalina.startup.HostConfig.check(HostConfig.java:1217)\n        at org.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java:293)\n        at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:117)\n        at org.apache.catalina.core.ContainerBase.backgroundProcess(ContainerBase.java:1338)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1601)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1610)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run(ContainerBase.java:1590)\n        at java.lang.Thread.run(Thread.java:619)\nOct 10, 2008 11:40:15 AM org.apache.catalina.core.StandardContext resourcesStart\nSEVERE: Error starting static Resources\n\nIf I copy some.war into a temporary location on the local disk and then copy it into the webapps/ directory it deploys.  If I try to redeploy the already deployed webapps by copying it from the network again, I get the following output:\n\nOct 10, 2008 11:41:46 AM org.apache.catalina.startup.HostConfig checkResources\nINFO: Undeploying context [/some]\nOct 10, 2008 11:41:46 AM org.apache.catalina.startup.HostConfig deployWAR\nINFO: Deploying web application archive some.war\nOct 10, 2008 11:41:56 AM org.apache.catalina.startup.HostConfig checkResources\nINFO: Undeploying context [/some]\nOct 10, 2008 11:41:56 AM org.apache.catalina.startup.HostConfig deployWAR\nINFO: Deploying web application archive some.war\nOct 10, 2008 11:42:06 AM org.apache.catalina.startup.HostConfig checkResources\nINFO: Undeploying context [/some]\nOct 10, 2008 11:42:06 AM org.apache.catalina.startup.HostConfig deployWAR\nINFO: Deploying web application archive some.war\nOct 10, 2008 11:42:16 AM org.apache.catalina.startup.HostConfig checkResources\nINFO: Undeploying context [/some]\nOct 10, 2008 11:42:16 AM org.apache.catalina.startup.HostConfig deployWAR\nINFO: Deploying web application archive some.war\nOct 10, 2008 11:42:26 AM org.apache.catalina.startup.HostConfig checkResources\nINFO: Undeploying context [/some]\nOct 10, 2008 11:42:26 AM org.apache.catalina.startup.HostConfig deployWAR\nINFO: Deploying web application archive some.war\nOct 10, 2008 11:42:36 AM org.apache.catalina.startup.HostConfig checkResources\nINFO: Undeploying context [/some]\nOct 10, 2008 11:42:36 AM org.apache.catalina.startup.HostConfig deployWAR\nINFO: Deploying web application archive some.war\nOct 10, 2008 11:42:46 AM org.apache.catalina.startup.HostConfig checkResources\nINFO: Undeploying context [/some]\nOct 10, 2008 11:42:46 AM org.apache.catalina.startup.HostConfig deployWAR\nINFO: Deploying web application archive some.war\n\nThe end result is that final deployment of the application is corrupted.  Classes in jars in the WEB-INF/lib directory are unavailable to the application, etc.   Is there anyway to get tomcat to check the integrity of new wars copied into webapps/ and have it not undeploy the existing application, or deploy the new application if the integrity check fails?  If the deployer retests the war whenever inotify or whatever strategy tells tomcat the file has changed, and does not deploy it until the war passes the check, I think that will solve this problem.\n\nI realize I could just use the management app, or a temporary directory, but that would break rsync style code release to load balanced clusters, etc.", "id": 121421, "time": "2008-10-10T11:59:01Z", "creator": "johnha@ccbill.com", "creation_time": "2008-10-10T11:59:01Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "creator": "johnha@ccbill.com", "text": "I have only tested/re-created this condition on Linux. Other OSes might be similarly affected.", "id": 121422, "time": "2008-10-10T12:05:53Z", "bug_id": 45989, "creation_time": "2008-10-10T12:05:53Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "fhanik@apache.org", "text": "The farm deployer is broken in 6 (and 5.5) It was broken in 5.5 when the system started downloading the WAR file to webapps instead of an outside directory.\nso what happens is that the deployment happens before the download is complete.\n\nThis is still on the todo list, but given the low usage of the farmdeployer it has not been a priority item", "id": 121424, "time": "2008-10-10T12:39:45Z", "bug_id": 45989, "creation_time": "2008-10-10T12:39:45Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "The farm deployer should be fixed - see bug45851.\n\nThe issue here is one of timing between the network copy and the deployer thread.\n\nWe could check that the file isn't changing in size but that is no guarantee.\n\nA work around that would reduce, but not eliminate the chances of this happening is:\n- upload the war to a different directory\n- copy the war locally which should be a lot faster\n\nApproaches that would work:\n- use the manager app - the context is marked as serviced which prevents the background process trying to deploy it\n- use JMX to mark the context as serviced before you start the copy and unmark after the copy completes\n- use a simple cluster and take each node down for upgrade\n- use the (now fixed) farm deployer with a cluster\n\nI can't see a reliable way to make this work and given that there are a number of methods provided that would allow this to work I am going to mark this one as won't fix.\n\n", "id": 122116, "time": "2008-11-01T17:56:32Z", "bug_id": 45989, "creation_time": "2008-11-01T17:56:32Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 45989, "text": "(In reply to comment #3)\n> A work around that would reduce, but not eliminate the chances of this\n> happening is:\n> - upload the war to a different directory\n> - copy the war locally which should be a lot faster\n\nSurely a rename (rather than a copy) would eliminate the timing window entirely?\n\nIf the file already exists then a delete (or rename and later delete) of the original file would be needed. This would leave a brief window where the file did not exist, but that should be easier to deal with.", "id": 122128, "time": "2008-11-03T01:49:05Z", "creator": "sebb@apache.org", "creation_time": "2008-11-03T01:49:05Z", "is_private": false, "attachment_id": null}]