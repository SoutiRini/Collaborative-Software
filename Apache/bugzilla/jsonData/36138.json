[{"count": 0, "tags": [], "bug_id": 36138, "is_private": false, "text": "This is the mod_jk patch I mentioned on the tomcat-dev mailing list on August \n6.\n\nThe patch adds a new lb.method option 'B' for 'Busyness'.  The algorithm picks \nthe lbworker with the lowest current load, based on how many requests the \nworker is currently serving (the \"Busy\" column in the jkstatus page).  This \nnumber is divided by the worker's lbfactor, and the lowest value (least busy) \nworker is picked.  \n\nWe tested about 25-30 threads against 6 load-balanced tomcats with requests \nthat take about 250ms each to complete.  Using the \"Busyness\" algorithm \nimproved our throughput from 12-16 requests per second to 60+ requests per \nsecond, and watching the jkstatus page showed that all servers were \nkept \"evenly\" busy.  If one particular server started lagging, its Busy value \nincreased, so it received fewer requests.  If a request is received when none \nof the workers are busy, this algorithm is effectively an evenly-weighted \nround-robin.\n\nNote that we found some race conditions with the code that updates the various \nlb status values, especially the lbworker \"busy\" value, which our algorithm \nrequires to be accurate.  To fix this, we had to refactor some of the shared \nmemory and critical-section locking code, by moving the lock into \nget_most_suitable_worker() (jk_lb_worker.c).  We also found some problems that \nwould cause the 'busy' value to be set to less than zero (displaying MAX_INT - \n1, for example, in jkstatus).\n\nWe fixed this by setting the busy value to 0 if it is ever less than 0.  See \njk_lb_worker.c lines 389-400.\n\nFinally, we added a new column to the jkstatus page.  The \"Ssc\" column now \nreports the number of times the worker was reused from sticky session.  See \njk_shm.c line 89, and jk_lb_worker.c line 584.  \n\nWe have load-tested this patch under apache 2.0.50, and we've also been \nrunning it in a busy production site for almost a week.  \n\nThis patch is donated by Andrew Hudson and Chris Lamprecht.", "id": 78396, "time": "2005-08-11T06:11:44Z", "creator": "clamprecht@gmail.com", "creation_time": "2005-08-11T06:11:44Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "clamprecht@gmail.com", "is_private": false, "id": 78397, "attachment_id": 16009, "bug_id": 36138, "creation_time": "2005-08-11T06:12:45Z", "time": "2005-08-11T06:12:45Z", "text": "Created attachment 16009\nNew load balancing algorithm for mod_jk"}, {"count": 2, "tags": [], "creator": "shankarunni@netscape.net", "attachment_id": null, "text": "fixed summary back - someone (mohan@...) accidentally munged it.\n", "id": 86283, "time": "2006-02-27T22:50:22Z", "bug_id": 36138, "creation_time": "2006-02-27T22:50:22Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 36138, "text": "Commited to the trunk.\nI have modified couple of things, mostly removing extra stuff added to shm.\nThanks.", "id": 86900, "time": "2006-03-16T07:55:29Z", "creator": "mturk@apache.org", "creation_time": "2006-03-16T07:55:29Z", "is_private": false, "attachment_id": null}]