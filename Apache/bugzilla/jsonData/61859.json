[{"count": 0, "attachment_id": 35587, "creator": "mkirsten@gmail.com", "text": "Created attachment 35587\nSimple file to reproduce the bug\n\nPOI does not correctly support array operands and collapses e.g., the\nexpression inside the INDEX function in INDEX(($B$2:$B$11=F2)*$A$2:$A$11) into a number. The formula INDEX expects an array, and instead of evaluating\n\nINDEX({1,2,2,3,0,0,0,4,0,0}, 0)\n\nPOI evaluates it as\n\nINDEX(1, 0)\n\nSTEPS TO REPRODUCE:\n1. Evaluate all cells in the attached file (or even just G4) with Apache POI\n2. The following exception is thrown WARNING: Incomplete code - cannot handle first arg of type (org.apache.poi.ss.formula.eval.NumberEval) for cell G4\n\nSee original description of the problem below. Identification that this had to do with how POI handles arguments that are arrays was kindly provided by Yegor Kozlov.\n\n\n======\nFor a spreadsheet I am trying to update and evaluate with POI I am having some difficulties. The problem I am trying to solve in its simplest form is the following; From a data sheet with two columns - one with a numeric value, and one with a group, I would like to find the maximum value for each group. So from the table below, I\u2019d like to calculate that max for A is 4, max for B is 10 and max for C is 20.\n\nValue\tGroup\n1\tA\n2\tA\n2\tA\n3\tA\n5\tB\n3\tB\n10\tB\n4\tA\n10\tC\n20\tC\n\nOne way to do this would be to create the following table, where the column max value is to;\n\n=MAX(INDEX(($B$2:$B$11=F2)*$A$2:$A$11;0))\n\nThe logic is basically; find where column B (the group) matches the specified group. This is an array with 0/1s. Multiply that array with the value array. Now we have an array with either 0s or the values from the specified group. Take max of that.\n\nGroup\tMax value\nA\t4\nB\t10\nC\t20\n\nHowever, when evaluating the formula above, I get the following error. I have uploaded a minimal test file on https://ufile.io/z6qg4 The 3 red cells are the only ones with formulas and it is when I evaluate them that I get this error.\n\nWARNING: Incomplete code - cannot handle first arg of type (org.apache.poi.ss.formula.eval.NumberEval) for cell G4\njava.lang.RuntimeException: Incomplete code - cannot handle first arg of type (org.apache.poi.ss.formula.eval.NumberEval)\n\tat org.apache.poi.ss.formula.functions.Index.convertFirstArg(Index.java:106)\n\tat org.apache.poi.ss.formula.functions.Index.evaluate(Index.java:50)\n\tat org.apache.poi.ss.formula.functions.Index.evaluate(Index.java:114)\n\tat org.apache.poi.ss.formula.OperationEvaluatorFactory.evaluate(OperationEvaluatorFactory.java:132)\n\tat org.apache.poi.ss.formula.WorkbookEvaluator.evaluateFormula(WorkbookEvaluator.java:523)\n\tat org.apache.poi.ss.formula.WorkbookEvaluator.evaluateAny(WorkbookEvaluator.java:290)\n\tat org.apache.poi.ss.formula.WorkbookEvaluator.evaluate(WorkbookEvaluator.java:232)\n\tat org.apache.poi.xssf.usermodel.BaseXSSFFormulaEvaluator.evaluateFormulaCellValue(BaseXSSFFormulaEvaluator.java:65)\n\tat org.apache.poi.ss.formula.BaseFormulaEvaluator.evaluateFormulaCellEnum(BaseFormulaEvaluator.java:192)\n\tat org.apache.poi.ss.usermodel.DataFormatter.formatCellValue(DataFormatter.java:887)", "id": 202578, "time": "2017-12-05T15:03:41Z", "bug_id": 61859, "creation_time": "2017-12-05T15:03:41Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 61859, "is_private": false, "text": "Should be fixed in r1818587\n\nThe fix includes two important changes:\n\n1. Support for evaluating relational operators in array mode. Before this fix POI always de-referenced the first value  and $B$2:$B$11=F2 evaluated as $B$2=F2 . Now it should correctly evaluate it to an array of {TRUE, FALSE, ..... }. \n\n2. Recognize 'array' evaluation mode from the formula context. Normally, array arithmetic is used in array formulas (those saved with Ctrl-Shift-Enter).  The INDEX function seems to be a special case: if row_num or column_num are omitted or set to 0, INDEX returns an array of the entire column or row. I had to tweak the evaluator to recognize it.", "id": 202831, "time": "2017-12-18T16:13:28Z", "creator": "yegor@dinom.ru", "creation_time": "2017-12-18T16:13:28Z", "attachment_id": null}]