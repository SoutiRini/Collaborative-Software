[{"count": 0, "attachment_id": null, "bug_id": 55334, "text": "In a Test Plan, add a Thread Group which has Include Controllers in it. Each Include controller has a valid Test Fragment file path specified. The Test Plan as a whole is Valid.\nRun the Test Plan to completion. Now add another Include Controller to this Test Plan using Add -> Logic Controller -> Include Controller.\nAdd a valid file path of a Test Fragment (This could be a duplicate of one of the other Include Controllers already in the Test Plan)\nNow run the Test Plan. The following exception is encountered in the logs. \n\nERROR - jmeter.threads.JMeterThread: Test failed! java.lang.ClassCastException: org.apache.jmeter.gui.tree.JMeterTreeNode cannot be cast to org.apache.jmeter.testelement.TestElement\n\tat org.apache.jmeter.threads.TestCompiler.addNode(TestCompiler.java:140)\n\tat org.apache.jorphan.collections.HashTree.traverseInto(HashTree.java:1001)\n\tat org.apache.jorphan.collections.HashTree.traverse(HashTree.java:986)\n\tat org.apache.jmeter.threads.JMeterThread.initRun(JMeterThread.java:532)\n\tat org.apache.jmeter.threads.JMeterThread.run(JMeterThread.java:252)\n\tat java.lang.Thread.run(Unknown Source)", "id": 168985, "time": "2013-07-31T23:54:26Z", "creator": "aviswana@buffalo.edu", "creation_time": "2013-07-31T23:54:26Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 55334, "text": "On Investigation it was found that when traversing the testTree in the initRun() method in JMeterThread.java class the newly added Include Controller is passed as a JMeterTreeNode instead of an IncludeController type.  \n\nFollowing is the code flow : \nJMeterThread.run() --> JMeterThread.initRun() --> Traverses the testTree using the HashTreeTraverser 'compiler'. --> HashTree.traverse() called where the data.keySet() function returns all the keys. The definition of 'data'  says : \n\n****\n// N.B. The keys can be either JMeterTreeNode or TestElement\n    protected final Map<Object, HashTree> data;\n****\n\nTestCompiler.addNode() called which tries to cast the JMeterTreeNode received to TestElement and a ClassCastException is thrown.\n\nNeed to investigate why the data.keySet returns a JMeterTreeNode. If it is acceptable then a code should be in place to extract the TestElement from the JMeterTreeNode to avoid the ClassCastException.", "id": 168986, "time": "2013-08-01T00:03:29Z", "creator": "aviswana@buffalo.edu", "creation_time": "2013-08-01T00:03:29Z", "is_private": false, "attachment_id": null}, {"count": 2, "attachment_id": null, "creator": "aviswana@buffalo.edu", "is_private": false, "id": 169018, "time": "2013-08-01T14:54:35Z", "bug_id": 55334, "creation_time": "2013-08-01T14:54:35Z", "tags": [], "text": "Found a fix that works well. Don't know if this is the exact fix but it does nothing too radical. \nChecking for the instance type of the 'node' received. If it is a JMeterTreeNode then extract the TestElement and set it to 'node' and then move ahead. \nThe TestCompiler.addNode() method now looks like this : \n\n /** {@inheritDoc} */\n    @Override\n    public void addNode(Object node, HashTree subTree) {\n    \tif(node instanceof JMeterTreeNode){\n    \t\tstack.addLast(((JMeterTreeNode)node).getTestElement());\n    \t}else{\n        stack.addLast((TestElement) node);\n    \t}\n    }"}, {"count": 3, "tags": [], "creator": "aviswana@buffalo.edu", "text": "Created attachment 30661\nproposed patch containing the fix for the issue.\n\nThe patch should be applied to the src/core directory in the source code. It contains the fix for the reported issue. The patch modifies the code in the org.apache.jmeter.threads.TestCompiler.addNode() method. \n\nThe method should look like this after adding the patch.\n\n/** {@inheritDoc} */\n    @Override\n    public void addNode(Object node, HashTree subTree) {\n    \tif(node instanceof JMeterTreeNode){\n    \t\tstack.addLast(((JMeterTreeNode)node).getTestElement());\n    \t}else{\n        stack.addLast((TestElement) node);\n    \t}\n    }", "id": 169027, "time": "2013-08-01T23:46:41Z", "bug_id": 55334, "creation_time": "2013-08-01T23:46:41Z", "is_private": false, "attachment_id": 30661}, {"count": 4, "tags": [], "bug_id": 55334, "text": "Date: Fri Aug  2 12:02:03 2013\nNew Revision: 1509647\n\nURL: http://svn.apache.org/r1509647\nLog:\nBug 55334 - Adding Include Controller to test plan (made of Include Controllers) without saving TestPlan leads to included code not being taken into account until save\nBugzilla Id: 55334\n\nModified:\n    jmeter/trunk/src/core/org/apache/jmeter/JMeter.java\n    jmeter/trunk/xdocs/changes.xml", "id": 169034, "attachment_id": null, "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2013-08-02T12:03:36Z", "time": "2013-08-02T12:03:36Z", "is_private": false}, {"count": 5, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": null, "is_private": false, "id": 169035, "time": "2013-08-02T12:07:52Z", "bug_id": 55334, "creation_time": "2013-08-02T12:07:52Z", "text": "Thanks for patch, but in fact it was not fixing root cause which was due to ReplaceableController not being loaded when in GUI mode and before saving Test Tree.\n\nThis should be fixed now.\nAlso removed invalid code in o instanceof TestElement branch code:\n------------------------------------------------------------\nelse { // null subTree\n    convertSubTree(tree.getTree(item));\n}\n------------------------------------------------------------\nin this branch, tree.getTree(item) can only be null, so calling convertSubTree would lead to NPE.\n\n\n\nThanks for reporting issue."}]