[{"count": 0, "tags": [], "text": "When a servlet sets its response code to a 2xx code other than 200 or 204, the\ncode in ErrorReportValve.java changes the content-type header and replaces the\nbody to an error message.\n\nAttached is a test case which shows the problem with the latest nightly build,\njakarta-tomcat-4.0-20020508.  This problem exists at least as far back as\nversion 4.0.1.  The test case is a servlet which sets content-type to text/xml,\nresponse code to 207, and writes an XML body.\n  \nYou have to run the test case twice - the first time the test servlet writes to\nthe output by calling HttpServletResponse.getOutputStream() and wrapping its own\nPrintWriter around it, and the second time the application just calls\nHttpServletResponse.getWriter(). \n\n\nHere is the first result.  Notice how ErrorReportValve.java has changed the\ncontent type header from text/xml to text/html, and replaced it with the\nstandard \"notify\" text:\n \nGET /davtest/dt HTTP/1.0\n\nHTTP/1.1 207 Multi-Status\nContent-Type: text/html\nX-useWriter: false\nDate: Wed, 08 May 2002 19:25:50 GMT\nServer: Apache Coyote HTTP/1.1 Connector [1.0]\nConnection: close\n\n<html><head><title>Apache Tomcat/4.1 - Error\nreport</title><STYLE><!--H1{font-family : sans-serif,Arial,Tahoma;color :\nwhite;background-color : #0086b2;} H3{font-family :\nsans-serif,Arial,Tahoma;color : white;background-color : #0086b2;}\nBODY{font-family : sans-serif,Arial,Tahoma;color : black;background-color :\nwhite;} B{color : white;background-color : #0086b2;} HR{color : #0086b2;}\n--></STYLE> </head><body><h1>HTTP Status 207 - </h1><HR size=\"1\"\nnoshade><p><b>type</b> Status report</p><p><b>message</b>\n<u></u></p><p><b>description</b> <u>Multiple status values have been returned\n().</u></p><HR size=\"1\" noshade><h3>Apache Tomcat/4.1</h3></body></html>\n\n\nHere is the second case where my application calls getWriter().  While the\nresults are correct, internally ErrorReportValve.java *still considered 207 to\nbe an error*, but didn't trash the output only because it appeared to be \"hard\ncommitted\" (from source comment). \n\nI believe that ErrorReportValve should not make any changes to the output if the\nresponse code is 2xx, which are by definition, not errors.\n\n  GET /davtest/dt HTTP/1.0\n\nHTTP/1.1 207 Multi-Status\nContent-Type: text/xml\nX-useWriter: true\nContent-Length: 1178\nDate: Wed, 08 May 2002 19:25:56 GMT\nServer: Apache Coyote HTTP/1.1 Connector [1.0]\nConnection: close\n\n<?xml version=\"1.0\"?><a:multistatus\nxmlns:b=\"urn:uuid:c2f41010-65b3-11d1-a29f-00aa00c14882/\"\nxmlns:e=\"urn:schemas:mailheader:\" xmlns:c=\"xml:\"\nxmlns:f=\"urn:schemas-microsoft-com:office:office\"\nxmlns:d=\"urn:schemas:calendar:\"\nxmlns:a=\"DAV:\"><a:response><a:href>http://demo.123office.com/exchange/test/Calendar/{21DCEBCB-846B-4EDA-9BCE-F11C1179D424}-80.EML</a:href><a:propstat><a:status>HTTP/1.1\n200 OK</a:status><a:prop><d:dtstart\nb:dt=\"dateTime.tz\">2002-05-07T17:00:00.000Z</d:dtstart><d:alldayevent\nb:dt=\"boolean\">0</d:alldayevent><e:subject>Fun</e:subject><a:contentclass>urn:content-classes:appointment</a:contentclass><a:uid>AQEAAAAAAJSiAAAAAAAAAAAAAAAA</a:uid></a:prop></a:propstat></a:response><a:response><a:href>http://demo.123office.com/exchange/test/Calendar/{06B08A66-46E3-4228-8C28-FA9844D6E07A}-80.EML</a:href><a:propstat><a:status>HTTP/1.1\n200 OK</a:status><a:prop><d:dtstart\nb:dt=\"dateTime.tz\">2002-05-07T19:30:00.000Z</d:dtstart><d:alldayevent\nb:dt=\"boolean\">0</d:alldayevent><e:subject>Lunch</e:subject><a:contentclass>urn:content-classes:appointment</a:contentclass><a:uid>AQEAAAAAAJSLAAAAAAAAAAAAAAAA</a:uid></a:prop></a:propstat></a:response></a:multistatus>\n  \n\nSee also bug 8831.", "is_private": false, "bug_id": 8916, "id": 15732, "time": "2002-05-08T19:49:05Z", "creator": "sjm@teamon.com", "creation_time": "2002-05-08T19:49:05Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "sjm@teamon.com", "text": "Created attachment 1815\nServlet which sets text/xml and writes XML output", "id": 15733, "time": "2002-05-08T19:50:00Z", "bug_id": 8916, "creation_time": "2002-05-08T19:50:00Z", "is_private": false, "attachment_id": 1815}, {"count": 2, "tags": [], "bug_id": 8916, "text": "No, in your first case, you have to flush your writer. Otherwise, because of\ntiming problems, the bytes will not get written, even if the report valve is\ndisabled.\n\nIf you don't like it, you can:\n- disable it\n- write an alternate report valve\n- write normal servlets (use the writer / output stream provided by the\ncontainer, as they can be a lot more efficient; doing what you're doing may also\nlead to problems when using the request dispatcher)", "id": 15735, "time": "2002-05-08T20:33:40Z", "creator": "remm@apache.org", "creation_time": "2002-05-08T20:33:40Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 8916, "attachment_id": null, "text": "To address your points:\n1. \"you have to flush your writer\"\n   \n    No you don't.  Servlet spec does not say that you have to flush your writer.\n Here, the one and only reason why flush() has to be called is to work around\nthe logic in ErrorReportValve.\n\n    Please cite the chapter in Servlet spec that says so.  \n\n2.  \"because of timing problems, the bytes will not get written\"  \n\n    Huh? If there is a race contition in the container, then it needs to be\nbugged and fixed, not forcing standards-compliant servlets to be rewritten.\n\n3. \"If you don't like it, you can disable it [or] write an alternate report valve\"\n\n    <sigh>Yes, of course, this is always an option.  However, the compelling\nvalue of Tomcat is to be able to install the container independently from the\ndeployed webapps, without having to introduce special conifiguration or coupling. \n\n4. \"write normal servlets (use the writer / output stream provided by the container\"\n\n   I am doing this.  \n\n\nC'mon, Remy.  How much evidence do you need?  \n\n[By the way, I am willing to do the fix, but I want to be sure that it will get\na fair hearing before I embark on it.]\n\n", "id": 15744, "time": "2002-05-08T22:08:58Z", "creator": "sjm@teamon.com", "creation_time": "2002-05-08T22:08:58Z", "is_private": false}, {"count": 4, "tags": [], "text": "1) No it is not. The bytes will never get written to the actual stream, but\nbuffered in your writer. The valve has nothing to do with that.\n\n3) Your application is not valid.\n\n4) I have explained this enough, so I will ignore this report from now on.", "is_private": false, "bug_id": 8916, "id": 15814, "time": "2002-05-09T16:46:31Z", "creator": "remm@apache.org", "creation_time": "2002-05-09T16:46:31Z", "attachment_id": null}]