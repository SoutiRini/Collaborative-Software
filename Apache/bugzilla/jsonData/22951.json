[{"count": 0, "attachment_id": null, "creator": "scaglione@starnetone.de", "is_private": false, "id": 43771, "time": "2003-09-05T20:12:47Z", "bug_id": 22951, "creation_time": "2003-09-05T20:12:47Z", "tags": [], "text": "SHORT: \nmod_proxy with ProxyErrorOverride On in a reverse-proxy configuration attaches \na body to the 302 response and a wrong Content-Length header. This appears to \nwork with IE6 but triggers a bug in (at least) squid 2.4. I had no time to try \nto find the problem in the sources but ProxyErrorOverride is certaily broken.\n\nLONG:\n\nWe are using a apache 2.0.47 with a reverse proxy on a apache 1.3.27 to serve \nphp content, and sometimes peoples accessing our website behind a squid proxy \nsee a white page with some headers and after a reload see the full page. The \npage tey see looks like this:\n\nApache Server at yyyy Port 80\nHTTP/1.0 200 OK Date: Wed, 03 Sep 2003 11:05:36 GMT Server: Apache Expires: \nThu, 19 Nov 1981\n08:52:00 GMT Last-Modified: Wed, 03 Sep 2003 11:07:30 GMT Cache-Control: no-\nstore, no-cache,\nmust-revalidate Pragma: no-cache Content-Type: text/html;\ncharset=ISO-8859-1 Via: 1.0 yyyy (Apache/2.0.47) X-Cache: MISS from xxxx\nX-Cache-Lookup: MISS from xxxx:3128 Proxy-Connection: close\n\n\nI tried to track down the problem (it never happened using apache 1.3.x as \nreverse-proxy frontend) and this is what I found:\n\nThis is the answer directly from the backend (apache 1.3.27 sent through \nmod_php) with the 302 response, there is no body (no errordoc) and no Content-\nLength header.\n\n# telnet  localhost 80\nGET http://yyyy HTTP/1.0\n\nHTTP/1.1 302 Found\nDate: Fri, 05 Sep 2003 19:39:22 GMT\nServer: Apache\nLast-Modified: Fri, 05 Sep 2003 19:39:23 GMT\nCache-Control: no-store, no-cache, must-revalidate\nExpires: Thu, 19 Nov 1981 08:52:00 GMT\nPragma: no-cache\nStatus: 302 Found\nLocation: http://yyyy/index.php?var=val\nConnection: close\nContent-Type: text/html\n\nConnection closed by foreign host.\n\nThis is the answer from the frontend (apache 2.0.47 mod_proxy with ProxyPass \nand ProxypassReverse) with ProxyErrorOverride On, the same 302 response but \nthis time there is a body (a standard errordoc probably from apache 2.0.47) and \na obviously wrong Content-Length=0 header.\n\n\n# telnet localhost 80\n\nGET http://yyyy HTTP/1.0\n\nHTTP/1.1 302 Found\nDate: Fri, 05 Sep 2003 19:35:44 GMT\nServer: Apache\nLast-Modified: Fri, 05 Sep 2003 19:35:45 GMT\nCache-Control: no-store, no-cache, must-revalidate\nExpires: Thu, 19 Nov 1981 08:52:00 GMT\nPragma: no-cache\nStatus: 302 Found\nLocation: http://yyyy/index.php?var=val\nContent-Type: text/html; charset=ISO-8859-1\nVia: 1.0 yyyy (Apache/2.0.47)\nContent-Length: 0\nConnection: close\n\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>302 Found</title>\n</head><body>\n<h1>Found</h1>\n<p>The document has moved <a href=\"http://yyyy/index.php?var=val\">here</a>.</p>\n<hr />\n<address>Apache Server at <a href=\"mailto:webmaster@yyyy\">yyyy</a> Port \n80</address>\n</body></html>\nConnection closed by foreign host.\n\nThis is the answer from the frontend (same apache 2.0.47) with \nProxyErrorOverride Off, always the same 302 response but this time it \nreproduces exactly the original, there is no body and the Content-Length=0 \nheader is this time rigth and the page works even behind a squid cache.\n\n\n# telnet localhost 80\n\nGET http://yyyy HTTP/1.0\n\nHTTP/1.1 302 Found\nDate: Fri, 05 Sep 2003 19:37:27 GMT\nServer: Apache\nLast-Modified: Fri, 05 Sep 2003 19:37:27 GMT\nCache-Control: no-store, no-cache, must-revalidate\nExpires: Thu, 19 Nov 1981 08:52:00 GMT\nPragma: no-cache\nStatus: 302 Found\nLocation: http://yyyy/index.php?var=val\nContent-Type: text/html; charset=ISO-8859-1\nVia: 1.0 yyyy (Apache/2.0.47)\nContent-Length: 0\nConnection: close\n\nConnection closed by foreign host."}, {"count": 1, "tags": [], "bug_id": 22951, "attachment_id": null, "text": "mod_proxy_html will probably serve wrong documents for EVERY status<400!\n\nIt looks like the problem is in modules/proxy/proxy_http.c line 924:\n\n   920              /*\n   921               * if we are overriding the errors, we can't put the content\n   922               * of the page into the brigade\n   923               */\n   924              if ( (conf->error_override ==0) || r->status < 400 ) {\n\nI changed this to:\n\n   924              if ( (conf->error_override ==0) && r->status < 400 ) {\n\nI didn't tested it extensively but now it works:\n\n# telnet localhost 90\n\nGET http://yyyy HTTP/1.0\n\nHTTP/1.1 302 Found\nDate: Fri, 05 Sep 2003 21:42:08 GMT\nServer: Apache\nLocation: http://yyyy/index.php?var=val\nContent-Length: 369\nConnection: close\nContent-Type: text/html; charset=iso-8859-1\n\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>302 Found</title>\n</head><body>\n<h1>Found</h1>\n<p>The document has moved <a href=\"http://yyyy/index.php?var=val\">here</a>.</p>\n<hr />\n<address>Apache Server at <a href=\"mailto:webmaster@yyyy\">yyyy</a> Port \n80</address>\n</body></html>\nConnection closed by foreign host.\n\n\n\n\n", "id": 43774, "time": "2003-09-05T21:53:56Z", "creator": "scaglione@starnetone.de", "creation_time": "2003-09-05T21:53:56Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 22951, "text": "Sorry for correcting this again, but my previous comment was incorrect.\nChanging in modules/proxy/proxy_http.c line 924:\n\n   924              if ( (conf->error_override ==0) || r->status < 400 ) {\nin:\n   924              if ( (conf->error_override ==0) || r->status < 300 ) {\n\neverything works.\n", "id": 43781, "time": "2003-09-05T23:26:51Z", "creator": "scaglione@starnetone.de", "creation_time": "2003-09-05T23:26:51Z", "is_private": false, "attachment_id": null}, {"count": 3, "attachment_id": null, "creator": "ianh@apache.org", "is_private": false, "id": 49163, "time": "2003-12-15T23:06:38Z", "bug_id": 22951, "creation_time": "2003-12-15T23:06:38Z", "tags": [], "text": "This patch has been submitted into the HTTP 2.1 development tree.\nawaiting some votes to get it into 2.0.49 (hopefully).\n\nThanks for the patch."}, {"count": 4, "attachment_id": null, "bug_id": 22951, "text": "Current status from STATUS:\n\n  although this patch works as-is, it doesn't really handle cookies being passed\nwith the\n  redirect (which isn't RFC, but is widely implemented) so removing from the\nbackport list\n  until this is resolved\n", "id": 57874, "time": "2004-05-21T21:25:41Z", "creator": "minfrin@sharp.fm", "creation_time": "2004-05-21T21:25:41Z", "tags": [], "is_private": false}, {"count": 5, "attachment_id": null, "bug_id": 22951, "is_private": false, "id": 78808, "time": "2005-08-22T12:44:58Z", "creator": "bugzilla@sioban.net", "creation_time": "2005-08-22T12:44:58Z", "tags": [], "text": "is this bug fixed in 2.0.54 ?\n\nI would like to use proxyerroroverride for masking several iis servers\nbut it looks like it doesn't work.\n\nThe behaviour is that each first 302 error, I see the html source code but not\nthe browser interpreted page.\n\nIt looks like it happens only with firefox and not with IE.\n\nMaybe, a good behaviour would be to not override 302 errors ?"}, {"count": 6, "tags": [], "bug_id": 22951, "attachment_id": null, "is_private": false, "id": 80075, "time": "2005-09-17T21:47:36Z", "creator": "nick@aevum.de", "creation_time": "2005-09-17T21:47:36Z", "text": "3xx responses aren't errors and are not seen by the user. So mod_proxy simply\nshouldn't override them just like sioban mentioned.\n\nThe correct fix seems to be to change line 963 in proxy_http.c from\n        if ( r->status == HTTP_OK )\nto\n        if ( r->status < 400 )\n\nThe current behavior is completely broken, so I'd suggest a big fat warning in\nthe manual for ProxyErrorOverride. This would have saved me hours of debugging.\n"}, {"count": 7, "tags": [], "creator": "nick@aevum.de", "attachment_id": null, "is_private": false, "id": 80076, "time": "2005-09-17T22:01:29Z", "bug_id": 22951, "creation_time": "2005-09-17T22:01:29Z", "text": "\nRegarding Comment #4 From Graham Leggett:\n\nHow can you remove this bug from the backport list just because of the cookie\nissue? At the moment "}, {"count": 8, "attachment_id": null, "creator": "nick@webthing.com", "is_private": false, "id": 80079, "time": "2005-09-18T00:06:28Z", "bug_id": 22951, "creation_time": "2005-09-18T00:06:28Z", "tags": [], "text": "2.0 simply doesn't support cookies in a reverse proxy.  2.1 does, and I've \ntried proposing a backport in STATUS, but it needs sufficient +1s. \n \nI don't think a broken content-length is linked to cookies.  Neither do I see \nhow your proposed fix helps: 3xx isn't an error, but redirects _do_ typically \nhave errordocuments attached.  Simply unsetting content-length in \nerrordocuments should fix that, shouldn't it? \n \nAnyone tested this with 2.1.x? "}, {"count": 9, "tags": [], "bug_id": 22951, "is_private": false, "id": 80082, "creation_time": "2005-09-18T01:36:09Z", "time": "2005-09-18T01:36:09Z", "creator": "nick@aevum.de", "text": "Sorry for the incomplete post. What I wanted to say: For 3xx responses the\ncurrent code in proxy_http.c sends the message body a second time, so the\nContent-Length header is wrong and keep-alive connections get out-of-sync. This\nis a much bigger problem than any cookie issues. So either the originally\nproposed fix which discards the original message body, or my fix which discards\nthe message body of the proxy's error document should definitely be applied.", "attachment_id": null}, {"count": 10, "tags": [], "creator": "nick@aevum.de", "text": "\nOK, after reading the original 2 year old bug report carefully, I think I found\nthe source of the confusion: There must have been changes in the error document\nhandling that affect this bug or I simply have a different setup.\n\nIn the original report a proxied 3xx response with ProxyErrorOverride On\ngenerated a (single) message body but a Content-Length of 0.\n\nMy Apache 2.0.54 setup generates two consecutive message bodies (one of the\nproxied response and another one of the proxy server itself) with a wrong\nContent-Length of one of them.\n", "id": 80083, "time": "2005-09-18T01:52:50Z", "bug_id": 22951, "creation_time": "2005-09-18T01:52:50Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "bug_id": 22951, "text": "Thinking even more about the whole thing, it's that easy: Apache just adds its\nown 3xx message body to a proxied response if ProxyErrorOverride is On and keeps\nthe Content-Length of the response. The original poster happened to proxy a\nrequest to a server that sends no message body in a 3xx response, while I proxy\nrequests to another Apache server that does, thus the double message body.", "id": 80085, "time": "2005-09-18T02:04:54Z", "creator": "nick@aevum.de", "creation_time": "2005-09-18T02:04:54Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "creator": "sebastiaan@kantoor.nederhost.nl", "is_private": false, "id": 84408, "attachment_id": null, "bug_id": 22951, "creation_time": "2006-01-09T19:44:23Z", "time": "2006-01-09T19:44:23Z", "text": "We just ran into this bug on an Apache 2.0.55 combination of proxy and backend server. Our backend \nserver does not provide any content on a 302, resulting in the proxy server returning a 302 with \ncontent but content-length set to 0. \n\nI do not see what this has to do with cookie support. To me, sending a content-length header that \nindicates a wrong content length is clearly broken, regardless of whether a 3xx error should be handled \nby ProxyErrorOverride. This broken response confuses some browsers while using keepalive, such as \nthe antique but still widely used Firefox 1.0.7.\n\nThe invalid response also occurs if an ErrorDocument is defined. Specifying an ErrorDocument of 0 \nbytes results in the ErrorDocument being ignored (which is probably the sane way to handle that). Being \nno workaround available, could this problem be fixed so that 302 at least works? Our system \nadministrator is not too wild about custom patches, so we've turned ProxyErrorOverride off for now."}, {"count": 13, "tags": [], "bug_id": 22951, "is_private": false, "text": "We run a reverse proxy with apache 2.0.49 and Proxy-ErrorOverride on.\nEverythings fine exept when using Firefox instead of Internet-Explorer. If we\nturn of Erroroverride everything\u00b4s fine again. What I understand is that this\nissue is solved in 2.1, anyway we already tested Apache 2.2.2, the problem persits.", "id": 90384, "time": "2006-06-20T07:52:29Z", "creator": "cb@schweickert.de", "creation_time": "2006-06-20T07:52:29Z", "attachment_id": null}, {"count": 14, "tags": [], "bug_id": 22951, "text": "Had cause to look at this old PR today, simple testcase below.  The backport to\n2.0 was pulled based on some cookie architecture differences in trunk but might\nnot be relevant.\n\n<virtualhost *:80>\nProxyPass / http://localhost:81/proxy-nossl.html\nProxyErrorOverride on\nErrorDocument 302 \"Proxy Server ProxyErrorOverride ErrorDocument\"\n</virtualHost>\n<virtualhost *:81>\nRedirect /proxy-nossl.html http://httpd.apache.org\nErrorDocument 302 \"Origin Server ErrorDocument\"\n                                        # ^ 27 bytes\n</virtualHost>\n\n\n$ echo -e \"GET / HTTP/1.1\\r\\nHost: localhost\\r\\n\\r\\n\" | nc localhost 80\nHTTP/1.1 302 Found\nDate: Mon, 28 Aug 2006 14:53:39 GMT\nServer: Apache/2.0.59 (Unix) DAV/2\nLocation: http://httpd.apache.org\nContent-Length: 27\nContent-Type: text/html; charset=iso-8859-1\n\nOrigin Server ErrorDocumentProxy Server ProxyErrorOverride ErrorDocument\n\nAs you can see the ErrorDocument in the proxy is tacked onto the response body\nfrom the origin server and C-L isn't right -- confusing keepalive clients.\n\nproxy_http.c has the following disconnect:  When the ProxyErrorOverride is on\nand the status code of the response is less than 400, the response body is read\nand passed along the filter chain.\n\nHowever, in a non-200 + ProxyErrorOverride on  case we will then later try to\nap_discard_request_body() (after having pulled the response off the wire)\nbecause we want to send our own ErrorDocument.\n\nIt looks like the intention is that we know we're overriding errors, so we only\nread successful responses off the wire and discard the others.    \n\n-            if ( (conf->error_override ==0) || r->status < 400 ) {\n+            if ( (conf->error_override ==0) || ap_is_HTTP_SUCCESS(r->status)  ) {\n               \n                 /* read the body, pass it to the output filters */\n\nThis is the same conditional present in 2.2.3", "id": 92634, "time": "2006-08-28T15:23:45Z", "creator": "covener@gmail.com", "creation_time": "2006-08-28T15:23:45Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "text": "Created attachment 18763\n2.0.x patch to skip reading the response body", "is_private": false, "id": 92635, "creator": "covener@gmail.com", "time": "2006-08-28T15:26:47Z", "bug_id": 22951, "creation_time": "2006-08-28T15:26:47Z", "attachment_id": 18763}, {"count": 16, "tags": [], "bug_id": 22951, "is_private": false, "id": 92661, "creation_time": "2006-08-29T11:40:31Z", "time": "2006-08-29T11:40:31Z", "creator": "jorton@redhat.com", "text": "This is the same root-cause (though a different symptom) as bug 20183, I think.\n\nThe one-liner alone doesn't quite make the two r->status checks exactly match\nfor 2.0.x.\n\nhttp://svn.apache.org/viewvc?view=rev&revision=102935 should be a complete fix.", "attachment_id": null}, {"count": 17, "tags": [], "bug_id": 22951, "text": "Unfortunately this bug is still present in 2.0.59. When using ProxyErrorOverride On on the front-end, \nand redirecting from the backend, the front-end server sends:\n\n- A 302 Moved with a content, but with the content-length header set to 0. This is clearly broken.\n- A 200 OK response from the backend, that was the result of the redirect.\n\nE.g., if I try to fetch /blah, which results in the backend redirecting me to /meuk. I then see the \nfollowing in Firefox:\n\n167\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>302 Moved</title>\n</head><body>\n<h1>Moved</h1>\n<p>The document has moved <a href=\"http://mydomain.invalid/meuk\">here</a>.</p>\n<hr>\n<address>Apache/2.0.59 (Unix) mod_ssl/2.0.59 OpenSSL/0.9.7j PHP/5.1.6 Server at mydomain.invalid \nPort 443</address>\n</body></html>\n\n0\n\nHTTP/1.1 200 OK\nDate: Fri, 29 Dec 2006 23:14:16 GMT\nServer: Apache/2.0.59 (Unix) mod_perl/2.0.3 Perl/v5.8.8\nContent-Type: text/html; charset=ISO-8859-1\nTransfer-Encoding: chunked\n\n478\n<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.w3.org/TR/html4/\nloose.dtd\">\n<html>\n  <head>\netc.\n\nThe 200 OK request header being shown in Firefox is obviously the result of using keepalive. The \nresponse in which content is provided for the request but content-length is 0 is wrong, regardless of \nwhich status code is being used. The response itself is perfectly fine, but since the content-length is set \nto 0 this confuses Firefox; it will follow up on the redirect and then read the next request, which \nincludes the content of the 302 that was not yet read. The obvious fix would be to include a content-\nlength header that is, well, actually specifying the length of the content that is sent to the client.\n\nIMHO (but I do not know very much of Apache's internals) this has little to do with deciding which \nstatus codes are an error or not, or even the use of cookie or other headers. The content-length is \nsimply not set to a valid value for this specific request in these specific conditions only.", "id": 97458, "time": "2006-12-29T15:26:44Z", "creator": "sebastiaan@kantoor.nederhost.nl", "creation_time": "2006-12-29T15:26:44Z", "is_private": false, "attachment_id": null}, {"count": 18, "tags": [], "bug_id": 22951, "is_private": false, "text": "From what I can tell the fix Joe mentions in comment#16 never got backported to\n2.0.x. It is contained in 2.2.x and trunk only.", "id": 97462, "time": "2006-12-29T16:16:52Z", "creator": "rpluem@apache.org", "creation_time": "2006-12-29T16:16:52Z", "attachment_id": null}, {"count": 19, "attachment_id": null, "bug_id": 22951, "text": "That would seem unfortunate due to the fact that 2.0 is still widely used as well as the nature of this bug \n(it is hardly a missing feature). Could backporting this get priority?", "id": 97467, "time": "2006-12-29T17:03:26Z", "creator": "sebastiaan@kantoor.nederhost.nl", "creation_time": "2006-12-29T17:03:26Z", "tags": [], "is_private": false}, {"count": 20, "attachment_id": null, "creator": "nick@webthing.com", "text": "Marking this a duplicate rather than vice versa, as 41646 is both broader and\nmore detailed.\n\n*** This bug has been marked as a duplicate of 41646 ***", "id": 107868, "time": "2007-09-08T11:33:46Z", "bug_id": 22951, "creation_time": "2007-09-08T11:33:46Z", "tags": [], "is_private": false}]