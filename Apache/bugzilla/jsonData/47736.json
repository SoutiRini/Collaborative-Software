[{"count": 0, "tags": [], "creator": "neng1998@yahoo.com", "attachment_id": null, "is_private": false, "id": 129929, "time": "2009-08-25T11:38:07Z", "bug_id": 47736, "creation_time": "2009-08-25T11:38:07Z", "text": "Following is two test cases. One was tested when concurrent access is over 75% maxthreads. One was tested when concurrent access is lower than 75% maxthreads. The former test case showed that Tomcat does not return correct HTTP header which does not contain Content-Length (response message body is one big text message). Client complains such response. \n\nI am using Tomct 6.0.18 code, BIO HTTP Connector\nHere is the connector configuration. \n\n     <Connector port=\"6351\" protocol=\"HTTP/1.1\"\n       allowTrace=\"false\"\n       enableLookups=\"false\"\n       maxPostSize=\"5000000\"\n       acceptCount=\"100\"\n       connectionTimeout=\"60000\"\n       keepAliveTimeout=\"172800000\"\n       disableUploadTimeout=\"false\"\n       maxKeepAliveRequests=\"10000000\"\n       maxThreads=\"50\"/>\n\nEd Xu From WellsFargo. \n\nTest 1 (Problem)\nCondition.The concurrent access is over 75% maxthreads. Tomcat refuse the keepAlive.\n\nRequest HTTP Header\nPOST /axis/ecbswebsrvc/ecpr/account/accountInformation/2007/11 HTTP/1.1\nSOAPAction: \"getAccountInformation\"\nConnection: keep-alive\nUser-Agent: Jakarta Commons-HttpClient/3.1\nHost: ecprsit.wellsfargo.com:8001\nContent-Length: 2841\nContent-Type: text/xml; charset=utf-8 \n\nResponse\nHTTP/1.1 200 OK\nServer: Apache-Coyote/1.1\nContent-Type: text/xml;charset=utf-8\nDate: Tue, 25 Aug 2009 17:46:41 GMT\nConnection: close\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<soapenv:Envelope> \n.......\n.......\n</soapenv:Body>\n\nTest 2 (OK)\nCondition: The concurrent access is lower thant 75% maxthreads. Tomcat allow keepAlive.\n\nRequest HTTP Header\nPOST /axis/ecbswebsrvc/ecpr/account/accountInformation/2007/11 HTTP/1.1\nSOAPAction: \"getAccountInformation\"\nConnection: keep-alive\nUser-Agent: Jakarta Commons-HttpClient/3.1\nHost: ecprsit.wellsfargo.com:8001\nContent-Length: 2841\nContent-Type: text/xml; charset=utf-8\n\nResponse\nHTTP/1.1 200 OK\nServer: Apache-Coyote/1.1\nContent-Type: text/xml;charset=utf-8\nTransfer-Encoding: chunked\nDate: Tue, 25 Aug 2009 14:23:32 GMT\n\n2000\n<?xml version=\"1.0\" encoding=\"UTF-8\"?><soapenv:Envelope>\n..........\n15ac\n.....</getAccountInformationResponse></soapenv:Body></soapenv:Envelope>\n.......\n0"}, {"count": 1, "tags": [], "bug_id": 47736, "attachment_id": null, "id": 129931, "time": "2009-08-25T14:14:47Z", "creator": "neng1998@yahoo.com", "creation_time": "2009-08-25T14:14:47Z", "is_private": false, "text": "The bugs is at 1538\n\nHttp11Processor: line 1531 \u2013 1547\n\n       long contentLength = response.getContentLengthLong();\n        if (contentLength != -1) {\n            headers.setValue(\"Content-Length\").setLong(contentLength);\n            outputBuffer.addActiveFilter\n                (outputFilters[Constants.IDENTITY_FILTER]);\n            contentDelimitation = true;\n        } else {\nLine 1538            if (entityBody && http11 && keepAlive) {\n                outputBuffer.addActiveFilter\n                    (outputFilters[Constants.CHUNKED_FILTER]);\n                contentDelimitation = true;\n                headers.addValue(Constants.TRANSFERENCODING).setString(Constants.CHUNKED);\n            } else {\n                outputBuffer.addActiveFilter\n                    (outputFilters[Constants.IDENTITY_FILTER]);\n            }\n        }\n\nWhen using HTTP 1.1 protocol, based on HTTP 1.1 spec 3.6. Server will use Chunked Transfer Coding. Line 1538 works well when keepAlive is true. \nEither client does not want keepAlive or Server refuse keepAlive, line 1538 condition become false, Server will not use \u201cChunked Transfer Coding\u201d. This is wrong. Using Chunked Transfer Coding should NOT be impacted by whether keepAlive is true or not because they are unrelated HTTP feature. \n\nWorse, it does not return content-length unless Application code calls response.setContentLength() method. This is not right. For HTTP 1.1, either Content-Length or Chunked Transfer Coding should present. If Application code does not explicitly call response.setContentLenght(), Server should still figure out content length itself if not using Chunked Transfer Coding.\n\nNote: HTTP 1.0 does not support Chunked Transfer Coding and does not require Content-Length neither. \n\nI think we should remove keepAlive in line 1638."}, {"count": 2, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "text": "Nice try. Actually, closing the connection is a perfectly legitimate way to end the response body, it does not need a TE or a content-length in that case.", "id": 129933, "time": "2009-08-25T14:48:46Z", "bug_id": 47736, "creation_time": "2009-08-25T14:48:46Z", "is_private": false}, {"count": 3, "tags": [], "creator": "neng1998@yahoo.com", "attachment_id": null, "is_private": false, "id": 129950, "time": "2009-08-26T06:26:48Z", "bug_id": 47736, "creation_time": "2009-08-26T06:26:48Z", "text": "Ramy Hi\n\nWe currently migrate from WebLogic to Tomcat. IBM CICS Web Service require the response contains either transfer-encoding or content-length\"  Both WebLogic and WebSphere always return transfer-encoding if using HTTP 1.1 protocol. Tomcat does not. \n\nDoes your argument is based on HTTP 1.1 RFC 2616  4.4 Message Length #5\n\"5.By the server closing the connection. (Closing the connection cannot be used to indicate the end of a request body, since that would leave no possibility for the server to send back a response.) \n\n....\"\n\nI need some information to deal with IBM. Thanks."}, {"count": 4, "tags": [], "bug_id": 47736, "attachment_id": null, "id": 129954, "creation_time": "2009-08-26T08:05:30Z", "time": "2009-08-26T08:05:30Z", "creator": "fhanik@apache.org", "text": "This would be a discussion for the mailing list. Bugzilla is not a support forum.", "is_private": false}, {"count": 5, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "is_private": false, "id": 129955, "time": "2009-08-26T08:08:58Z", "bug_id": 47736, "creation_time": "2009-08-26T08:08:58Z", "text": "Bugzilla interactions are less friendly when Mark is on vacation :D"}, {"count": 6, "tags": [], "bug_id": 47736, "text": "https://issues.apache.org/bugzilla/show_bug.cgi?id=47197#c3\n\n:D", "id": 129956, "time": "2009-08-26T08:26:05Z", "creator": "fhanik@apache.org", "creation_time": "2009-08-26T08:26:05Z", "is_private": false, "attachment_id": null}]