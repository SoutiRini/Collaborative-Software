[{"text": "Created attachment 23853\nPatch to XSSFWorkbook.java from poi 3.5-beta6\n\nWhen I create a spreadsheet using XSSFWorkbook with date values in them, and open the file on Mac Excel 2008, all of the date values are off by exactly 4 years.  I have done some investigation, and I believe the issue is due to differing defaults when the workbook.xml file has a missing <workbookPr> tag (which seems to happen with all xlsx files created via XSSFWorkbook).  According to the ECMA-376 docs, on page 2292, it talks about \"1900\" vs \"1904 backward compatibility\" for dates in xlsx files, and I believe the \"lack\" of a <workbookPr> tag showing the different defaults for Windows Excel 2007 and Mac Excel 2008.\n\nIf I simply add the following code after workbook creation, the <workbookPr> tag is added to the workbook.xml file, and the dates show properly on Mac Excel 2008, and Windows Excel 2007.\n\nimport org.openxmlformats.schemas.spreadsheetml.x2006.main.CTWorkbookPr;\nimport org.apache.poi.xssf.usermodel.XSSFWorkbook;\n\nXSSFWorkbook workbook = new XSSFWorkbook();\nif (workbook.getCTWorkbook().getWorkbookPr() == null) {\n  // this code causes a <workbookpr> element to be written to the workbook.xml \n  // file.  If this mode isn't set, then Mac\n  // Excel 2008 defaults to date1904 mode whereas Windows Excel 2007  \n  // defaults to date1900 mode.\n  CTWorkbookPr workbookPr = CTWorkbookPr.Factory.newInstance();\n  workbookPr.setDate1904(false);\n  workbook.getCTWorkbook().setWorkbookPr(workbookPr);\n}\n\n\nI will attach some screenshots and example code showing the differences between display of dates on Excel 2007/Excel 2008.  Also, I believe the patch to this is simply adding extra initialization to onWorkbookCreate() in XSSFWorkbook.java.  I will also attach a patch showing this addition.\n\nThanks much!\n--Leif", "tags": [], "bug_id": 47411, "is_private": false, "count": 0, "id": 128197, "time": "2009-06-23T08:58:13Z", "creator": "lnelson@llnl.gov", "creation_time": "2009-06-23T08:58:13Z", "attachment_id": 23853}, {"count": 1, "attachment_id": 23854, "bug_id": 47411, "is_private": false, "id": 128198, "time": "2009-06-23T09:00:10Z", "creator": "lnelson@llnl.gov", "creation_time": "2009-06-23T09:00:10Z", "tags": [], "text": "Created attachment 23854\nTestPoiDate.java - sample code exhibiting behavior"}, {"count": 2, "tags": [], "bug_id": 47411, "is_private": false, "text": "Created attachment 23855\nExcel 2008 without the workbookPrTag in workbook.xml (this is showing the issue)", "id": 128199, "time": "2009-06-23T09:06:08Z", "creator": "lnelson@llnl.gov", "creation_time": "2009-06-23T09:06:08Z", "attachment_id": 23855}, {"count": 3, "tags": [], "bug_id": 47411, "text": "Created attachment 23856\nExcel 2008 with added workbookPrTag in workbook.xml (this is showing the fix)", "id": 128200, "time": "2009-06-23T09:06:50Z", "creator": "lnelson@llnl.gov", "creation_time": "2009-06-23T09:06:50Z", "is_private": false, "attachment_id": 23856}, {"text": "Created attachment 23857\nExcel 2007 with workbookPrTag - This is showing that Excel 2007 works the same either way.", "tags": [], "bug_id": 47411, "is_private": false, "count": 4, "id": 128201, "time": "2009-06-23T09:07:51Z", "creator": "lnelson@llnl.gov", "creation_time": "2009-06-23T09:07:51Z", "attachment_id": 23857}, {"text": "Created attachment 23858\nExcel 2007 without workbookPrTag - This is showing that Excel 2007 defaults to 1900 date formatting even with the workbookPr tag missing.", "tags": [], "bug_id": 47411, "is_private": false, "count": 5, "id": 128202, "time": "2009-06-23T09:08:45Z", "creator": "lnelson@llnl.gov", "creation_time": "2009-06-23T09:08:45Z", "attachment_id": 23858}, {"count": 6, "tags": [], "bug_id": 47411, "text": "Leif,\n\nYou are absolutely correct. The date1904 flag indicates whether the date system starts in 1904. If this flag is missing then the default Excel setting is used which is different in Win Excel 2007 and Mac Excel 2008. \n\nThe suggested fix is fine, I applied in r788956.\n\nRegards,\nYegor", "id": 128338, "time": "2009-06-27T04:27:51Z", "creator": "yegor@dinom.ru", "creation_time": "2009-06-27T04:27:51Z", "is_private": false, "attachment_id": null}, {"count": 7, "attachment_id": null, "bug_id": 47411, "is_private": false, "id": 128390, "time": "2009-06-29T07:53:38Z", "creator": "lnelson@llnl.gov", "creation_time": "2009-06-29T07:53:38Z", "tags": [], "text": "Yegor,\n\nThanks so much!\n\n--Leif"}]