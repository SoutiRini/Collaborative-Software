[{"count": 0, "tags": [], "bug_id": 52316, "is_private": false, "id": 152110, "creation_time": "2011-12-09T22:23:47Z", "time": "2011-12-09T22:23:47Z", "creator": "knst.kolinko@gmail.com", "text": "Confirming a problem reported on the users@ list.\n\nThis affects both NIO and APR protocols when file is delivered with sendfile. Note, that the file have to be >48kb to trigger use of sendfile.\n\nSteps to reproduce:\n1) Configure three connectors:\n    <Connector port=\"8081\" protocol=\"org.apache.coyote.http11.Http11Protocol\"\n               connectionTimeout=\"20000\"\n               redirectPort=\"8443\" />\n    <Connector port=\"8082\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\"\n               connectionTimeout=\"20000\"\n               redirectPort=\"8443\" />\n    <Connector port=\"8083\" protocol=\"org.apache.coyote.http11.Http11AprProtocol\"\n               connectionTimeout=\"20000\"\n               redirectPort=\"8443\" />\n\nand configure AccessLogValve in a <Host>:\n\n        <Valve className=\"org.apache.catalina.valves.AccessLogValve\"\n               directory=\"logs\"\n               prefix=\"localhost_access_log.\" suffix=\".txt\"\n               pattern=\"%h %l %u %t &quot;%r&quot; %s %b (%D ms)\" />\n\nThe difference from common pattern is that I added \"(%D ms)\" at the end.\n \n2) Put some big file (>48k) as webapps/ROOT/file\n3) Download it 3 times:\nhttp://localhost:8081/file?8081\nhttp://localhost:8082/file?8082\nhttp://localhost:8083/file?8083\n4) Access Log:\n\n127.0.0.1 - - [10/Dec/2011:01:05:08 +0300] \"GET /file?8081 HTTP/1.1\" 200 15027784 (4766 ms)\n127.0.0.1 - - [10/Dec/2011:01:05:23 +0300] \"GET /file?8082 HTTP/1.1\" 200 - (31 ms)\n127.0.0.1 - - [10/Dec/2011:01:05:48 +0300] \"GET /file?8083 HTTP/1.1\" 200 - (16 ms)\n\nNote that '-' is printed instead of file size for Nio and Apr connectors.\n\nWorkarounds:\n------------\nA). Disable sendfile with useSendfile=\"false\" on a connector\n\nB). Add the following pattern to AccessLogValve:\n\n\"%{org.apache.tomcat.sendfile.start}r %{org.apache.tomcat.sendfile.end}r\"\n\nThat will log the range of bytes sent by sendfile.\nE.g.:\n\n127.0.0.1 - - [10/Dec/2011:01:05:08 +0300] \"GET /file?8081 HTTP/1.1\" 200 15027784 (4766 ms) - - \n127.0.0.1 - - [10/Dec/2011:01:05:23 +0300] \"GET /file?8082 HTTP/1.1\" 200 - (31 ms) 0 15027784 \n127.0.0.1 - - [10/Dec/2011:01:05:48 +0300] \"GET /file?8083 HTTP/1.1\" 200 - (16 ms) 0 15027784 \n--------------\n\nOverall, looking at the timing value printed by %D I would say that logging occurs before data are sent. So the value of 0 bytes is correct.\n\nIt could be possible to log file size from request attributes set by sendfile, but that cannot account for aborted downloads. Though I think that would be better than the current logging of '0'.\n\nAt least this limitation can be mentioned in documentation for %b and %B patterns in AccessLogValve section in valve.html and in Javadoc.", "attachment_id": null}, {"count": 1, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "Since sendfile sends the data asynchronously on a separate thread, the access log can never know exactly how many bytes are sent without destroying the benefits of sendfile.\n\nI lean towards logging the bytes intended to be sent (calculated from the request attributes).", "id": 152428, "time": "2011-12-27T20:29:08Z", "bug_id": 52316, "creation_time": "2011-12-27T20:29:08Z", "is_private": false}, {"count": 2, "attachment_id": null, "bug_id": 52316, "is_private": false, "id": 152451, "time": "2011-12-28T21:29:13Z", "creator": "markt@apache.org", "creation_time": "2011-12-28T21:29:13Z", "tags": [], "text": "Fixed in trunk and 7.0.x and will be included in 7.0.24 onwards."}]