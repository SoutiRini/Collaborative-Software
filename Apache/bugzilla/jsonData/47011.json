[{"count": 0, "tags": [], "creator": "mwhiteley@materialogic.com", "text": "After upgrading from Apache 2.2.6 to Apache 2.2.8 or greater, when gracefully shutting down one of our Embedded Tomcats on our application server, we notice a temporary outage (503) from our proxy balancer before the hot-standby (status=+H) takes over.\n\nLayout:\n- Application proxy server (Apache 2.2.8)\n   - Proxies requests via mod_proxy/mod_proxy_balancer/mod_proxy_ajp to application server\n- Application server (Java)\n   - Runs master Java application server with Embedded Tomcat (Tomcat/5.5.17) on port 8009\n   - Runs slave Java application server with Embedded Tomcat (Tomcat/5.5.17) on port 8008\n\nWhen the application proxy server was Apache 2.2.6, we were able to gracefully shutdown the master Tomcat server (calling embedded.stop()), and the Hot Standby (status=+H) BalancerMember would immediately start serving requests.  After the upgrade to 2.2.8, we see \"HTTP/1.1 503 This application is not currently available\" while the active BalancerMember is shutting down before the hot-standby takes over (~1 second). These errors appear in both the Tomcat access log and the Apache access log.\n\nI have recompiled and tested Apache versions 2.2.6, 2.2.8, 2.2.9 and 2.2.11 to verify that this problem exists after version 2.2.6.  I still had the problem when switching the BalancerMember protocol from ajp:// to http://, so I think this rules out AJP-specific issues.  I was unable to reproduce the problem using Apache servers as the BalancerMembers, so I'm speculating this has something to do with the interaction with Tomcat.\n\nProxy conf:\n=================================\nProxyPassMatch /(.+/)?application.server$\tbalancer://production_server\n\n<Proxy balancer://production_server/>\n\tBalancerMember ajp://server.domain.tld:8009/\tlbset=1\tretry=10 loadfactor=100\n\tBalancerMember ajp://server.domain.tld:8008/\tlbset=2\tretry=10 status=+H\n\n\tProxySet lbmethod=bytraffic\n</Proxy>\n=================================", "id": 126178, "time": "2009-04-09T13:32:33Z", "bug_id": 47011, "creation_time": "2009-04-09T13:32:33Z", "is_private": false, "attachment_id": null}, {"text": "Can you please check if the following patch fixes your issue (:http://svn.apache.org/viewvc/httpd/httpd/branches/2.2.x/modules/proxy/mod_proxy.c?r1=713145&r2=739610&view=patch):\n\n--- httpd/httpd/branches/2.2.x/modules/proxy/mod_proxy.c\t2008/11/11 20:01:59\t713145\n+++ httpd/httpd/branches/2.2.x/modules/proxy/mod_proxy.c\t2009/01/31 20:58:07\t739610\n@@ -1002,8 +1002,10 @@\n              * We can not failover to another worker.\n              * Mark the worker as unusable if member of load balancer\n              */\n-            if (balancer)\n+            if (balancer) {\n                 worker->s->status |= PROXY_WORKER_IN_ERROR;\n+                worker->s->error_time = apr_time_now();\n+            }\n             break;\n         }\n         else if (access_status == HTTP_SERVICE_UNAVAILABLE) {\n@@ -1013,6 +1015,7 @@\n              */\n             if (balancer) {\n                 worker->s->status |= PROXY_WORKER_IN_ERROR;\n+                worker->s->error_time = apr_time_now();\n             }\n         }\n         else {", "tags": [], "bug_id": 47011, "attachment_id": null, "count": 1, "id": 126179, "time": "2009-04-09T13:40:10Z", "creator": "rpluem@apache.org", "creation_time": "2009-04-09T13:40:10Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 47011, "attachment_id": null, "text": "i have tried the patch you sent in a clean httpd-2.2.8 and also tried patching  mod_proxy, mod_proxy_http, and mod_proxy_balancer in httpd-2.2.11 up to revision 763402 with the same results.", "id": 126180, "time": "2009-04-09T14:25:17Z", "creator": "mwhiteley@materialogic.com", "creation_time": "2009-04-09T14:25:17Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 47011, "text": "After further research, i've traced this to proxy_util.c r582620 (which references PR 43472). Reverting just this change in 2.2.11 resolves the issue described in this report.", "count": 3, "id": 126448, "time": "2009-04-22T12:30:27Z", "creator": "mwhiteley@materialogic.com", "creation_time": "2009-04-22T12:30:27Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 47011, "attachment_id": null, "text": "Which connector are you using in Tomcat? The APR connector or the classic blocking connector?\n\nDoes it help when you add\n\nping=1\n\nto the other BalancerMember parameters?", "id": 126449, "time": "2009-04-22T13:35:51Z", "creator": "rpluem@apache.org", "creation_time": "2009-04-22T13:35:51Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 47011, "attachment_id": null, "text": "i'm not exactly sure if this is the answer you need but, we're using an  Embedded tomcat, and setting up the AJP connector as follows:\n         Connector ajpConnector  = embedded.createConnector((java.net.InetAddress) null, this.ajpPort, \"ajp\");\n         embedded.addConnector(ajpConnector);\n\nResults of adding \"ping=1\" to the BalancerMembers:\n\nApache 2.2.11:\n- Wouldn't start, output the following:\nBalancerMember Ping/Pong timeout has wrong format\n\nApache 2.2.9:\n- During graceful shutdown outlined previously, balancer returned:\nHTTP/1.1 500 Internal Server Error\n- Logged:\n[Wed Apr 22 16:05:53 2009] [error] (70014)End of file found: ajp_ilink_receive() can't receive header\n\nApache 2.2.8:\n- Balancer always returned:\nHTTP/1.1 503 Service Temporarily Unavailable\n- Logged:\n[Wed Apr 22 16:00:50 2009] [error] ajp_msg_append_uint8(): BufferOverflowException 4 4\n[Wed Apr 22 16:00:50 2009] [error] ajp_handle_cping_cpong: ajp_marshal_into_msgb failed\n[Wed Apr 22 16:00:50 2009] [error] (120001)APR does not understand this error code: proxy: AJP: cping/cpong failed to (null) (xxx.xxxxxxxxxx.com)", "id": 126450, "time": "2009-04-22T14:22:14Z", "creator": "mwhiteley@materialogic.com", "creation_time": "2009-04-22T14:22:14Z", "is_private": false}, {"count": 6, "attachment_id": null, "creator": "rpluem@apache.org", "text": "Ah, my bad. To get this working with 2.2.11 you should apply\n\nhttp://svn.apache.org/viewvc/apr/apr/branches/1.3.x/strings/apr_strings.c?r1=727605&r2=727604&pathrev=727605&view=patch\n\nfirst (its from http://svn.apache.org/viewvc?view=rev&revision=727605).\nPlease try again afterwards with 2.2.11.", "id": 126455, "time": "2009-04-22T23:16:11Z", "bug_id": 47011, "creation_time": "2009-04-22T23:16:11Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "creator": "mwhiteley@materialogic.com", "text": "After applying the apr_strings.c patch on 2.2.11, when gracefully shutting down the primary tomcat, Apache logs the following once:\n\n[Thu Apr 23 12:07:59 2009] [error] (111)Connection refused: proxy: AJP: attempt to connect to xxx.xxx.xxx.xxx:8009 (xxxxxxx.xxxxxxx.com) failed\n[Thu Apr 23 12:07:59 2009] [error] ap_proxy_connect_backend disabling worker for (xxxxxxx.xxxxxxx.com)\n[Thu Apr 23 12:07:59 2009] [error] proxy: AJP: failed to make connection to backend: xxxxxxx.xxxxxxx.com\n\nAnd the hot-standby takes the request as expected without an outage on the front-end.\n\nThe above worked with and without \"ping=1\".", "id": 126464, "time": "2009-04-23T10:30:19Z", "bug_id": 47011, "creation_time": "2009-04-23T10:30:19Z", "is_private": false, "attachment_id": null}]