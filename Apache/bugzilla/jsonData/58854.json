[{"count": 0, "tags": [], "creator": "kurt.newman@cpanel.net", "is_private": false, "text": "Note\n Some of the examples below may be \"expected\", but the results seem incorrect in a couple of the cases.\n\nSynopsis:\n 1. Apache 2.2 used to treat \"RewriteRule .* goodbye.txt\" and \"RewriteRule .* /goodbye.txt\" identically by treating goodbye.txt as a file in the docroot (even beginning / was missing).\n 2. Apache 2.2 used to correctly forbid access to a goodbye.txt when a directive above it prevented access (e.g. Order deny,allow\\nDeny from all)\n 3. This no longer works in Apache 2.4\n\nExample of Apache 2.4.18 working correctly:\n 1. Create /home/cgihw/public_html/.htaccess:\n    Require all denied\n    RewriteEngine on\n    RewriteRule .* /goodbye.txt [L]\n 2. Remove file: rm -f /home/cgihw/public_html/403.shtml\n 3. Remove file: rm -f /home/cgihw/public_html/missing.txt\n 4. Create file: echo \"goodbye world\" > /home/cgihw/public_html/goodbye.txt\n 5. Navigate to http://cgihw.loc/missing.txt\n 6. Observe that Apache 2.4.18 gives a 403 Forbidden response\n 7. Observe the default LimitInternalRecursion limit of 10 is hit\n 8. Observe that no Internal server error is presented to user user\n\nExample of Apache 2.4.18 working incorrectly:\n 1. Create /home/cgihw/public_html/.htaccess:\n    Require all denied\n    RewriteEngine on\n    RewriteRule .* goodbye.txt [L]\n 2. Remove file: rm -f /home/cgihw/public_html/403.shtml\n 3. Remove file: rm -f /home/cgihw/public_html/missing.txt\n 4. Create file: echo \"goodbye world\" > /home/cgihw/public_html/goodbye.txt\n 5. Navigate to http://cgihw.loc/missing.txt\n 6. Observe that you are incorrectly presented with the contents of goodbye.txt\n 7. Observe that the LimitInternalRecursion limit is never compared against\n 8. Observe that no Internal server error is presented to the user\n\nExample of Apache 2.4.18 erroneously present Internal server error\n 1. Create /home/cgihw/public_html/.htaccess:\n    Require all granted\n    RewriteEngine on\n    RewriteRule .* /goodbye.txt [L]\n 2. Remove file: rm -f /home/cgihw/public_html/403.shtml\n 3. Remove file: rm -f /home/cgihw/public_html/missing.txt\n 4. Create file: echo \"goodbye world\" > /home/cgihw/public_html/goodbye.txt\n 5. Navigate to http://cgihw.loc/missing.txt\n 6. Observe that you are now presented with an Internal server error, instead\n    of a forbidden message\n 7. Observe the default LimitInternalRecursion limit of 10 is hit\n\nBackground Notes\n - This seems to be a problem within mod_rewrite not setting the redirect-handler correctly for the generated sub request when the 403 ErrorDocument is missing.  The log indicates that the request is denied, yet the web server still presents the user with content.\n - This used to work in Apache 2.2, but no longer works in Apache 2.4.18.  The difference being, Apache 2.2 used the 'Order' directive, and not 'Require' directive.\n\nI've attached the following files:\n - Example httpd.conf (file: broken.conf)\n - Configure line used to compile Apache 2.4.18\n - Log output for success\n - Log output for regression\n\nPlease see logs, configure line, and example Apache configuration for more detailed information.", "id": 187643, "time": "2016-01-13T23:58:26Z", "bug_id": 58854, "creation_time": "2016-01-13T23:58:26Z", "attachment_id": null}, {"attachment_id": 33436, "tags": [], "creator": "kurt.newman@cpanel.net", "is_private": false, "count": 1, "id": 187644, "time": "2016-01-13T23:58:56Z", "bug_id": 58854, "creation_time": "2016-01-13T23:58:56Z", "text": "Created attachment 33436\nApache configuration file"}, {"count": 2, "tags": [], "text": "Created attachment 33437\nLogging output when RewriteRule ignores Require directive", "is_private": false, "id": 187645, "creator": "kurt.newman@cpanel.net", "time": "2016-01-13T23:59:27Z", "bug_id": 58854, "creation_time": "2016-01-13T23:59:27Z", "attachment_id": 33437}, {"count": 3, "tags": [], "bug_id": 58854, "text": "Created attachment 33438\nLogging output when RewriteRule obeys Require directive", "id": 187646, "time": "2016-01-13T23:59:43Z", "creator": "kurt.newman@cpanel.net", "creation_time": "2016-01-13T23:59:43Z", "is_private": false, "attachment_id": 33438}, {"attachment_id": null, "tags": [], "bug_id": 58854, "is_private": false, "count": 4, "id": 187647, "time": "2016-01-14T00:00:38Z", "creator": "kurt.newman@cpanel.net", "creation_time": "2016-01-14T00:00:38Z", "text": "Configure Line:\n./configure --enable-info=static --disable-v4-mapped --enable-access-compat=static --enable-actions=static --enable-alias=static --enable-asis=static --enable-auth_basic=static --enable-authn_core=static --enable-authn_file=static --enable-authz_core=static --enable-authz_groupfile=static --enable-authz_host=static --enable-authz_user=static --enable-autoindex=static --enable-cgi=static --enable-deflate=static --enable-dir=static --enable-env=static --enable-expires=static --enable-filter=static --enable-headers=static --enable-include=static --enable-log_config=static --enable-logio=static --enable-maintainer-mode --enable-mime=static --enable-modules=none --enable-negotiation=static --enable-proxy=static --enable-proxy-connect=static --enable-proxy-http=static --enable-rewrite=static --enable-setenvif=static --enable-slotmem_shm=static --enable-socache_dbm=static --enable-socache_shmcb=static --enable-ssl=static --enable-status=static --enable-suexec=static --enable-unique-id=static --enable-unixd=static --enable-userdir=static --enable-version=static --prefix=/usr/local/apache --with-crypto --with-included-apr --with-mpm=prefork --with-pcre=/opt/pcre --with-ssl=/usr --with-suexec-caller=nobody --with-suexec-docroot=/ --with-suexec-gidmin=100 --with-suexec-logfile=/usr/local/apache/logs/suexec_log --with-suexec-uidmin=100 --with-suexec-userdir=public_html"}, {"count": 5, "text": "Are you able to rebuild mod_rewrite?\n\nhttp://people.apache.org/~covener/patches/rewrite-deadloop.diff\n\nThis should resolve a difference between the relative and absolute substitutions and detecting the looping.", "creator": "covener@gmail.com", "is_private": false, "id": 187667, "time": "2016-01-14T13:21:35Z", "bug_id": 58854, "creation_time": "2016-01-14T13:21:35Z", "tags": [], "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 58854, "attachment_id": null, "text": "Hi Eric,\n\nYour patch corrects the issue and lets relative and absolute paths work identically.\n\nThanks for the response!\n\nKurt", "id": 187682, "time": "2016-01-14T15:55:38Z", "creator": "kurt.newman@cpanel.net", "creation_time": "2016-01-14T15:55:38Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 58854, "is_private": false, "count": 7, "id": 188097, "time": "2016-02-01T09:23:38Z", "creator": "melezhik@gmail.com", "creation_time": "2016-02-01T09:23:38Z", "text": "Hi!\n\n( https://github.com/melezhik/apache-swat - easy way to verify existed apache issues  against your environment  )\n\nConfirming this issue is resolved against my environment:\n\nvagrant@Debian-jessie-vagrant@Debian-jessie-amd64-netboot:~/my/apache-swat$ swat -t 58854/\n/home/vagrant/.swat/.cache/9277/prove/58854/granted2/missing.txt/00.GET.t ..\nok 1 - GET 127.0.0.1/58854/granted2/missing.txt succeeded\n# http headers saved to /home/vagrant/.swat/.cache/9277/prove/zCQKWtpYir.hdr\n# body saved to /home/vagrant/.swat/.cache/9277/prove/zCQKWtpYir\nok 2 - output match '200 OK'\nok 3 - output match 'goodbye world from root'\n1..3\nok\n/home/vagrant/.swat/.cache/9277/prove/58854/denied/missing.txt/00.GET.t ....\nok 1 - GET 127.0.0.1/58854/denied/missing.txt succeeded\n# http headers saved to /home/vagrant/.swat/.cache/9277/prove/tj_HdkKgk5.hdr\n# body saved to /home/vagrant/.swat/.cache/9277/prove/tj_HdkKgk5\nok 2 - output match '403 Forbidden'\n1..2\nok\n/home/vagrant/.swat/.cache/9277/prove/58854/granted/missing.txt/00.GET.t ...\nok 1 - GET 127.0.0.1/58854/granted/missing.txt succeeded\n# http headers saved to /home/vagrant/.swat/.cache/9277/prove/Cmkh6umQP9.hdr\n# body saved to /home/vagrant/.swat/.cache/9277/prove/Cmkh6umQP9\nok 2 - output match '200 OK'\nok 3 - output match 'goodbye world from 58854/granted'\n1..3\nok\nAll tests successful.\nFiles=3, Tests=8,  1 wallclock secs ( 0.03 usr  0.00 sys +  0.14 cusr  0.01 csys =  0.18 CPU)\nResult: PASS\n\n\n\namd64-netboot:~/my/apache-swat$ sudo ~/apache/bin/apachectl -V\nServer version: Apache/2.4.18 (Unix)\nServer built:   Jan 30 2016 10:17:37\nServer's Module Magic Number: 20120211:52\nServer loaded:  APR 1.5.1, APR-UTIL 1.5.4\nCompiled using: APR 1.5.1, APR-UTIL 1.5.4\nArchitecture:   64-bit\nServer MPM:     event\n  threaded:     yes (fixed thread count)\n    forked:     yes (variable process count)\nServer compiled with....\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=256\n -D HTTPD_ROOT=\"/home/vagrant/apache/\"\n -D SUEXEC_BIN=\"/home/vagrant/apache//bin/suexec\"\n -D DEFAULT_PIDLOG=\"logs/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"\n\n\nAlexey Melezhik"}, {"attachment_id": null, "tags": [], "bug_id": 58854, "is_private": false, "count": 8, "id": 188844, "time": "2016-02-26T14:40:18Z", "creator": "jacob.perkins@cpanel.net", "creation_time": "2016-02-26T14:40:18Z", "text": "Hi Eric,\n\nWe've noticed a spike in tickets about RewriteRules no longer working after this patch. Granted, these rewrite rules look conspicuous, as in, they shouldn't work, or will result in looping, however we have enough reports of them that we think this might be a regression in behavior. We've verified these rewrites work before this patch, and now results in a ISE 500 / Max10Redirects after the patch.\n\nExample of some rewrites that are now dead looping when they didn't previously:\n\n==================================================\n\n<IfModule mod_rewrite.c>\n\tRewriteEngine Off\n\tRewriteBase /blogg/\n \n\tRewriteCond %{REQUEST_FILENAME} -f [OR]\n\tRewriteCond %{REQUEST_FILENAME} -d\n\tRewriteRule ^(.+) - [PT,L]\n \n\tRewriteCond %{REQUEST_URI} !=/favicon.ico\n\tRewriteRule ^(.*) index.php\n \n\tRewriteCond %{HTTP:Authorization}  !^$\n\tRewriteRule .* - [E=REMOTE_USER:%{HTTP:Authorization}]\n</IfModule>\n \n \n==================================================\n \n<IfModule mod_rewrite.c>\n    RewriteEngine On\n    RewriteRule ^.*$ htaccess_tester.php\n</IfModule>\n \n==================================================\n \nRewriteRule ^$ ?lang=IT        [L]\n \n==================================================\n \nRewriteRule ^public public.php [L]\nRewriteRule ^js.php js.php [L]\n \n==================================================\n\nRewriteRule ^(.+) - [PT,L]\n\n==================================================\n\nRewriteRule ^(.*) index.php\n\n==================================================\n\nAny thoughts on this?"}, {"attachment_id": null, "tags": [], "bug_id": 58854, "is_private": false, "count": 9, "id": 188846, "time": "2016-02-26T16:01:18Z", "creator": "covener@gmail.com", "creation_time": "2016-02-26T16:01:18Z", "text": "(In reply to Jacob P from comment #8)\n> We've noticed a spike in tickets about RewriteRules no longer working after\n> this patch. Granted, these rewrite rules look conspicuous, as in, they\n> shouldn't work, or will result in looping, however we have enough reports of\n> them that we think this might be a regression in behavior. We've verified\n> these rewrites work before this patch, and now results in a ISE 500 /\n> Max10Redirects after the patch.\n\nSorry and thanks for the report. I think I now see what went wrong in the patch -- all different permutations of URLs, paths, and converted paths are handled in this block.\n\nHere is a followup that restores the original check and uses a slightly different check at the last moment:\n\nhttp://people.apache.org/~covener/patches/trunk-rewrite-deadloop2.diff\n\nI am hoping you can try some of those failing ones."}, {"count": 10, "tags": [], "text": "(In reply to Alexey Melezhik from comment #7)\n> Hi!\n> \n> ( https://github.com/melezhik/apache-swat - easy way to verify existed\n> apache issues  against your environment  )\n> \n> Confirming this issue is resolved against my environment:\n> \n> vagrant@Debian-jessie-vagrant@Debian-jessie-amd64-netboot:~/my/apache-swat$\n> swat -t 58854/\n> /home/vagrant/.swat/.cache/9277/prove/58854/granted2/missing.txt/00.GET.t ..\n> ok 1 - GET 127.0.0.1/58854/granted2/missing.txt succeeded\n> # http headers saved to /home/vagrant/.swat/.cache/9277/prove/zCQKWtpYir.hdr\n> # body saved to /home/vagrant/.swat/.cache/9277/prove/zCQKWtpYir\n> ok 2 - output match '200 OK'\n> ok 3 - output match 'goodbye world from root'\n> 1..3\n> ok\n> /home/vagrant/.swat/.cache/9277/prove/58854/denied/missing.txt/00.GET.t ....\n> ok 1 - GET 127.0.0.1/58854/denied/missing.txt succeeded\n> # http headers saved to /home/vagrant/.swat/.cache/9277/prove/tj_HdkKgk5.hdr\n> # body saved to /home/vagrant/.swat/.cache/9277/prove/tj_HdkKgk5\n> ok 2 - output match '403 Forbidden'\n> 1..2\n> ok\n> /home/vagrant/.swat/.cache/9277/prove/58854/granted/missing.txt/00.GET.t ...\n> ok 1 - GET 127.0.0.1/58854/granted/missing.txt succeeded\n> # http headers saved to /home/vagrant/.swat/.cache/9277/prove/Cmkh6umQP9.hdr\n> # body saved to /home/vagrant/.swat/.cache/9277/prove/Cmkh6umQP9\n> ok 2 - output match '200 OK'\n> ok 3 - output match 'goodbye world from 58854/granted'\n> 1..3\n> ok\n> All tests successful.\n> Files=3, Tests=8,  1 wallclock secs ( 0.03 usr  0.00 sys +  0.14 cusr  0.01\n> csys =  0.18 CPU)\n> Result: PASS\n> \n> \n> \n> amd64-netboot:~/my/apache-swat$ sudo ~/apache/bin/apachectl -V\n> Server version: Apache/2.4.18 (Unix)\n> Server built:   Jan 30 2016 10:17:37\n> Server's Module Magic Number: 20120211:52\n> Server loaded:  APR 1.5.1, APR-UTIL 1.5.4\n> Compiled using: APR 1.5.1, APR-UTIL 1.5.4\n> Architecture:   64-bit\n> Server MPM:     event\n>   threaded:     yes (fixed thread count)\n>     forked:     yes (variable process count)\n> Server compiled with....\n>  -D APR_HAS_SENDFILE\n>  -D APR_HAS_MMAP\n>  -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n>  -D APR_USE_SYSVSEM_SERIALIZE\n>  -D APR_USE_PTHREAD_SERIALIZE\n>  -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n>  -D APR_HAS_OTHER_CHILD\n>  -D AP_HAVE_RELIABLE_PIPED_LOGS\n>  -D DYNAMIC_MODULE_LIMIT=256\n>  -D HTTPD_ROOT=\"/home/vagrant/apache/\"\n>  -D SUEXEC_BIN=\"/home/vagrant/apache//bin/suexec\"\n>  -D DEFAULT_PIDLOG=\"logs/httpd.pid\"\n>  -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n>  -D DEFAULT_ERRORLOG=\"logs/error_log\"\n>  -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n>  -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"\n> \n> \n> Alexey Melezhik\n\nI think this particular test might be questionable. It doesn't fail when I revert the fix.", "attachment_id": null, "id": 188965, "creator": "covener@gmail.com", "time": "2016-02-29T14:00:03Z", "bug_id": 58854, "creation_time": "2016-02-29T14:00:03Z", "is_private": false}, {"count": 11, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "text": "(In reply to Eric Covener from comment #10)\n> (In reply to Alexey Melezhik from comment #7)\n> > Hi!\n> > \n> > ( https://github.com/melezhik/apache-swat - easy way to verify existed\n> > apache issues  against your environment  )\n> > \n> > Confirming this issue is resolved against my environment:\n> > \n> > vagrant@Debian-jessie-vagrant@Debian-jessie-amd64-netboot:~/my/apache-swat$\n> > swat -t 58854/\n> > /home/vagrant/.swat/.cache/9277/prove/58854/granted2/missing.txt/00.GET.t ..\n> > ok 1 - GET 127.0.0.1/58854/granted2/missing.txt succeeded\n> > # http headers saved to /home/vagrant/.swat/.cache/9277/prove/zCQKWtpYir.hdr\n> > # body saved to /home/vagrant/.swat/.cache/9277/prove/zCQKWtpYir\n> > ok 2 - output match '200 OK'\n> > ok 3 - output match 'goodbye world from root'\n> > 1..3\n> > ok\n> > /home/vagrant/.swat/.cache/9277/prove/58854/denied/missing.txt/00.GET.t ....\n> > ok 1 - GET 127.0.0.1/58854/denied/missing.txt succeeded\n> > # http headers saved to /home/vagrant/.swat/.cache/9277/prove/tj_HdkKgk5.hdr\n> > # body saved to /home/vagrant/.swat/.cache/9277/prove/tj_HdkKgk5\n> > ok 2 - output match '403 Forbidden'\n> > 1..2\n> > ok\n> > /home/vagrant/.swat/.cache/9277/prove/58854/granted/missing.txt/00.GET.t ...\n> > ok 1 - GET 127.0.0.1/58854/granted/missing.txt succeeded\n> > # http headers saved to /home/vagrant/.swat/.cache/9277/prove/Cmkh6umQP9.hdr\n> > # body saved to /home/vagrant/.swat/.cache/9277/prove/Cmkh6umQP9\n> > ok 2 - output match '200 OK'\n> > ok 3 - output match 'goodbye world from 58854/granted'\n> > 1..3\n> > ok\n> > All tests successful.\n> > Files=3, Tests=8,  1 wallclock secs ( 0.03 usr  0.00 sys +  0.14 cusr  0.01\n> > csys =  0.18 CPU)\n> > Result: PASS\n> > \n> > \n> > \n> > amd64-netboot:~/my/apache-swat$ sudo ~/apache/bin/apachectl -V\n> > Server version: Apache/2.4.18 (Unix)\n> > Server built:   Jan 30 2016 10:17:37\n> > Server's Module Magic Number: 20120211:52\n> > Server loaded:  APR 1.5.1, APR-UTIL 1.5.4\n> > Compiled using: APR 1.5.1, APR-UTIL 1.5.4\n> > Architecture:   64-bit\n> > Server MPM:     event\n> >   threaded:     yes (fixed thread count)\n> >     forked:     yes (variable process count)\n> > Server compiled with....\n> >  -D APR_HAS_SENDFILE\n> >  -D APR_HAS_MMAP\n> >  -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n> >  -D APR_USE_SYSVSEM_SERIALIZE\n> >  -D APR_USE_PTHREAD_SERIALIZE\n> >  -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n> >  -D APR_HAS_OTHER_CHILD\n> >  -D AP_HAVE_RELIABLE_PIPED_LOGS\n> >  -D DYNAMIC_MODULE_LIMIT=256\n> >  -D HTTPD_ROOT=\"/home/vagrant/apache/\"\n> >  -D SUEXEC_BIN=\"/home/vagrant/apache//bin/suexec\"\n> >  -D DEFAULT_PIDLOG=\"logs/httpd.pid\"\n> >  -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n> >  -D DEFAULT_ERRORLOG=\"logs/error_log\"\n> >  -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n> >  -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"\n> > \n> > \n> > Alexey Melezhik\n> \n> I think this particular test might be questionable. It doesn't fail when I\n> revert the fix.\n\nI think the problem is likely the \"absolute\" paths, which are / in the PR, need to be /58854/granted/...", "id": 188967, "time": "2016-02-29T14:22:55Z", "bug_id": 58854, "creation_time": "2016-02-29T14:22:55Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 58854, "attachment_id": null, "text": "(In reply to Eric Covener from comment #9)\n> (In reply to Jacob P from comment #8)\n> > We've noticed a spike in tickets about RewriteRules no longer working after\n> > this patch. Granted, these rewrite rules look conspicuous, as in, they\n> > shouldn't work, or will result in looping, however we have enough reports of\n> > them that we think this might be a regression in behavior. We've verified\n> > these rewrites work before this patch, and now results in a ISE 500 /\n> > Max10Redirects after the patch.\n> \n> Sorry and thanks for the report. I think I now see what went wrong in the\n> patch -- all different permutations of URLs, paths, and converted paths are\n> handled in this block.\n> \n> Here is a followup that restores the original check and uses a slightly\n> different check at the last moment:\n> \n> http://people.apache.org/~covener/patches/trunk-rewrite-deadloop2.diff\n> \n> I am hoping you can try some of those failing ones.\n\n\nOur initial testing advises that the fix for rewrites looping works, but the original issue persists, that the RewriteRule ignores any Requires.", "id": 188969, "time": "2016-02-29T14:55:46Z", "creator": "jacob.perkins@cpanel.net", "creation_time": "2016-02-29T14:55:46Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 58854, "attachment_id": null, "text": "\n> Our initial testing advises that the fix for rewrites looping works, but the\n> original issue persists, that the RewriteRule ignores any Requires.\n\nI'm fairly sure I originally tested that case, with the regressing patch, but I can no longer get it to fail even with a vanilla 2.4.18.  But I am now questioning whether I really did.\n\nmod_rewrite specified in htaccess doesn't even run in the 'require all denied' case.  Must be missing something.", "id": 188972, "time": "2016-02-29T15:54:54Z", "creator": "covener@gmail.com", "creation_time": "2016-02-29T15:54:54Z", "is_private": false}, {"count": 14, "tags": [], "text": "(In reply to Eric Covener from comment #13)\n> > Our initial testing advises that the fix for rewrites looping works, but the\n> > original issue persists, that the RewriteRule ignores any Requires.\n> \n> I'm fairly sure I originally tested that case, with the regressing patch,\n> but I can no longer get it to fail even with a vanilla 2.4.18.  But I am now\n> questioning whether I really did.\n> \n> mod_rewrite specified in htaccess doesn't even run in the 'require all\n> denied' case.  Must be missing something.\n\nSomething that fuels my doubts is how I worded the fix, wrt looping only.  Can anyone share trace8 output for  this failure on 2418:\n\nExample of Apache 2.4.18 working incorrectly:\n 1. Create /home/cgihw/public_html/.htaccess:\n    Require all denied\n    RewriteEngine on\n    RewriteRule .* goodbye.txt [L]\n 2. Remove file: rm -f /home/cgihw/public_html/403.shtml\n 3. Remove file: rm -f /home/cgihw/public_html/missing.txt\n 4. Create file: echo \"goodbye world\" > /home/cgihw/public_html/goodbye.txt\n 5. Navigate to http://cgihw.loc/missing.txt\n 6. Observe that you are incorrectly presented with the contents of goodbye.txt\n 7. Observe that the LimitInternalRecursion limit is never compared against\n 8. Observe that no Internal server error is presented to the user", "is_private": false, "id": 188973, "creator": "covener@gmail.com", "time": "2016-02-29T15:57:31Z", "bug_id": 58854, "creation_time": "2016-02-29T15:57:31Z", "attachment_id": null}, {"count": 15, "tags": [], "bug_id": 58854, "attachment_id": null, "text": "(In reply to Eric Covener from comment #14)\n> (In reply to Eric Covener from comment #13)\n> > > Our initial testing advises that the fix for rewrites looping works, but the\n> > > original issue persists, that the RewriteRule ignores any Requires.\n> > \n> > I'm fairly sure I originally tested that case, with the regressing patch,\n> > but I can no longer get it to fail even with a vanilla 2.4.18.  But I am now\n> > questioning whether I really did.\n> > \n> > mod_rewrite specified in htaccess doesn't even run in the 'require all\n> > denied' case.  Must be missing something.\n> \n> Something that fuels my doubts is how I worded the fix, wrt looping only. \n> Can anyone share trace8 output for  this failure on 2418:\n> \n> Example of Apache 2.4.18 working incorrectly:\n>  1. Create /home/cgihw/public_html/.htaccess:\n>     Require all denied\n>     RewriteEngine on\n>     RewriteRule .* goodbye.txt [L]\n>  2. Remove file: rm -f /home/cgihw/public_html/403.shtml\n>  3. Remove file: rm -f /home/cgihw/public_html/missing.txt\n>  4. Create file: echo \"goodbye world\" > /home/cgihw/public_html/goodbye.txt\n>  5. Navigate to http://cgihw.loc/missing.txt\n>  6. Observe that you are incorrectly presented with the contents of\n> goodbye.txt\n>  7. Observe that the LimitInternalRecursion limit is never compared against\n>  8. Observe that no Internal server error is presented to the user\n\nHere's trace8 with a patched 2.4.18 (original patch provided by Eric, not the second):\n\n[Mon Feb 29 16:09:18.805864 2016] [core:trace5] [pid 8692] protocol.c(616): [client 192.168.122.236:42428] Request received from client: GET /missing.txt HTTP/1.1\n[Mon Feb 29 16:09:18.806118 2016] [http:trace4] [pid 8692] http_request.c(394): [client 192.168.122.236:42428] Headers received from client:\n[Mon Feb 29 16:09:18.806135 2016] [http:trace4] [pid 8692] http_request.c(398): [client 192.168.122.236:42428]   User-Agent: curl/7.29.0\n[Mon Feb 29 16:09:18.806143 2016] [http:trace4] [pid 8692] http_request.c(398): [client 192.168.122.236:42428]   Host: cgihw.tld\n[Mon Feb 29 16:09:18.806150 2016] [http:trace4] [pid 8692] http_request.c(398): [client 192.168.122.236:42428]   Accept: */*\n[Mon Feb 29 16:09:18.806422 2016] [authz_core:debug] [pid 8692] mod_authz_core.c(809): [client 192.168.122.236:42428] AH01626: authorization result of Require all denied: denied\n[Mon Feb 29 16:09:18.806447 2016] [authz_core:debug] [pid 8692] mod_authz_core.c(809): [client 192.168.122.236:42428] AH01626: authorization result of <RequireAny>: denied\n[Mon Feb 29 16:09:18.806457 2016] [authz_core:error] [pid 8692] [client 192.168.122.236:42428] AH01630: client denied by server configuration: /home/cgihw/public_html/missing.txt\n[Mon Feb 29 16:09:18.806478 2016] [core:trace3] [pid 8692] request.c(119): [client 192.168.122.236:42428] auth phase 'check access' gave status 403: /missing.txt\n[Mon Feb 29 16:09:18.806560 2016] [rewrite:trace3] [pid 8692] mod_rewrite.c(476): [client 192.168.122.236:42428] 192.168.122.236 - - [cgihw.tld/sid#d9f9b8][rid#e570d8/initial/redir#1] [perdir /home/cgihw/public_html/] strip per-dir prefix: /home/cgihw/public_html/403.shtm\nl -> 403.shtml\n[Mon Feb 29 16:09:18.806578 2016] [rewrite:trace3] [pid 8692] mod_rewrite.c(476): [client 192.168.122.236:42428] 192.168.122.236 - - [cgihw.tld/sid#d9f9b8][rid#e570d8/initial/redir#1] [perdir /home/cgihw/public_html/] applying pattern '.*' to uri '403.shtml'\n[Mon Feb 29 16:09:18.806599 2016] [rewrite:trace2] [pid 8692] mod_rewrite.c(476): [client 192.168.122.236:42428] 192.168.122.236 - - [cgihw.tld/sid#d9f9b8][rid#e570d8/initial/redir#1] [perdir /home/cgihw/public_html/] rewrite '403.shtml' -> 'goodbye.txt'\n[Mon Feb 29 16:09:18.806626 2016] [rewrite:trace3] [pid 8692] mod_rewrite.c(476): [client 192.168.122.236:42428] 192.168.122.236 - - [cgihw.tld/sid#d9f9b8][rid#e570d8/initial/redir#1] [perdir /home/cgihw/public_html/] add per-dir prefix: goodbye.txt -> /home/cgihw/public_\nhtml/goodbye.txt\n[Mon Feb 29 16:09:18.806642 2016] [rewrite:trace2] [pid 8692] mod_rewrite.c(476): [client 192.168.122.236:42428] 192.168.122.236 - - [cgihw.tld/sid#d9f9b8][rid#e570d8/initial/redir#1] [perdir /home/cgihw/public_html/] strip document_root prefix: /home/cgihw/public_html/go\nodbye.txt -> /goodbye.txt\n[Mon Feb 29 16:09:18.806654 2016] [rewrite:trace1] [pid 8692] mod_rewrite.c(476): [client 192.168.122.236:42428] 192.168.122.236 - - [cgihw.tld/sid#d9f9b8][rid#e570d8/initial/redir#1] [perdir /home/cgihw/public_html/] internal redirect with /goodbye.txt [INTERNAL REDIRECT\n]\n[Mon Feb 29 16:09:18.806742 2016] [rewrite:trace3] [pid 8692] mod_rewrite.c(476): [client 192.168.122.236:42428] 192.168.122.236 - - [cgihw.tld/sid#d9f9b8][rid#e5ac30/initial/redir#2] [perdir /home/cgihw/public_html/] strip per-dir prefix: /home/cgihw/public_html/goodbye.\ntxt -> goodbye.txt\n[Mon Feb 29 16:09:18.806757 2016] [rewrite:trace3] [pid 8692] mod_rewrite.c(476): [client 192.168.122.236:42428] 192.168.122.236 - - [cgihw.tld/sid#d9f9b8][rid#e5ac30/initial/redir#2] [perdir /home/cgihw/public_html/] applying pattern '.*' to uri 'goodbye.txt'\n[Mon Feb 29 16:09:18.806770 2016] [rewrite:trace2] [pid 8692] mod_rewrite.c(476): [client 192.168.122.236:42428] 192.168.122.236 - - [cgihw.tld/sid#d9f9b8][rid#e5ac30/initial/redir#2] [perdir /home/cgihw/public_html/] rewrite 'goodbye.txt' -> 'goodbye.txt'\n[Mon Feb 29 16:09:18.806781 2016] [rewrite:trace3] [pid 8692] mod_rewrite.c(476): [client 192.168.122.236:42428] 192.168.122.236 - - [cgihw.tld/sid#d9f9b8][rid#e5ac30/initial/redir#2] [perdir /home/cgihw/public_html/] add per-dir prefix: goodbye.txt -> /home/cgihw/public_\nhtml/goodbye.txt\n[Mon Feb 29 16:09:18.806795 2016] [rewrite:trace1] [pid 8692] mod_rewrite.c(476): [client 192.168.122.236:42428] 192.168.122.236 - - [cgihw.tld/sid#d9f9b8][rid#e5ac30/initial/redir#2] [perdir /home/cgihw/public_html/] initial URL equal rewritten URL: /home/cgihw/public_ht\nml/goodbye.txt [IGNORING REWRITE]\n[Mon Feb 29 16:09:18.806885 2016] [http:trace3] [pid 8692] http_filters.c(1006): [client 192.168.122.236:42428] Response sent with status 403, headers:\n[Mon Feb 29 16:09:18.806898 2016] [http:trace5] [pid 8692] http_filters.c(1013): [client 192.168.122.236:42428]   Date: Mon, 29 Feb 2016 16:09:18 GMT\n[Mon Feb 29 16:09:18.806908 2016] [http:trace5] [pid 8692] http_filters.c(1016): [client 192.168.122.236:42428]   Server: Apache\n[Mon Feb 29 16:09:18.806917 2016] [http:trace4] [pid 8692] http_filters.c(835): [client 192.168.122.236:42428]   Last-Modified: Mon, 29 Feb 2016 16:06:33 GMT\n[Mon Feb 29 16:09:18.806925 2016] [http:trace4] [pid 8692] http_filters.c(835): [client 192.168.122.236:42428]   Accept-Ranges: bytes\n[Mon Feb 29 16:09:18.806931 2016] [http:trace4] [pid 8692] http_filters.c(835): [client 192.168.122.236:42428]   Content-Length: 14\n[Mon Feb 29 16:09:18.806938 2016] [http:trace4] [pid 8692] http_filters.c(835): [client 192.168.122.236:42428]   Connection: close\n[Mon Feb 29 16:09:18.806944 2016] [http:trace4] [pid 8692] http_filters.c(835): [client 192.168.122.236:42428]   Content-Type: text/plain\n[Mon Feb 29 16:09:18.806979 2016] [core:trace6] [pid 8692] core_filters.c(525): [client 192.168.122.236:42428] core_output_filter: flushing because of FLUSH bucket\n[Mon Feb 29 16:09:18.807233 2016] [core:trace6] [pid 8692] core_filters.c(525): [client 192.168.122.236:42428] core_output_filter: flushing because of FLUSH bucket", "id": 188974, "time": "2016-02-29T16:10:56Z", "creator": "jacob.perkins@cpanel.net", "creation_time": "2016-02-29T16:10:56Z", "is_private": false}, {"count": 16, "tags": [], "text": "Trace8 after new patch:\n\n[Mon Feb 29 16:27:48.520428 2016] [core:trace5] [pid 18816] protocol.c(616): [client 192.168.122.236:42816] Request received from client: GET /missing.txt HTTP/1.1\n[Mon Feb 29 16:27:48.520744 2016] [http:trace4] [pid 18816] http_request.c(394): [client 192.168.122.236:42816] Headers received from client:\n[Mon Feb 29 16:27:48.520764 2016] [http:trace4] [pid 18816] http_request.c(398): [client 192.168.122.236:42816]   User-Agent: curl/7.29.0\n[Mon Feb 29 16:27:48.520773 2016] [http:trace4] [pid 18816] http_request.c(398): [client 192.168.122.236:42816]   Host: cgihw.tld\n[Mon Feb 29 16:27:48.520781 2016] [http:trace4] [pid 18816] http_request.c(398): [client 192.168.122.236:42816]   Accept: */*\n[Mon Feb 29 16:27:48.521090 2016] [authz_core:debug] [pid 18816] mod_authz_core.c(809): [client 192.168.122.236:42816] AH01626: authorization result of Require all denied: denied\n[Mon Feb 29 16:27:48.521110 2016] [authz_core:debug] [pid 18816] mod_authz_core.c(809): [client 192.168.122.236:42816] AH01626: authorization result of <RequireAny>: denied\n[Mon Feb 29 16:27:48.521118 2016] [authz_core:error] [pid 18816] [client 192.168.122.236:42816] AH01630: client denied by server configuration: /home/cgihw/public_html/missing.txt\n[Mon Feb 29 16:27:48.521127 2016] [core:trace3] [pid 18816] request.c(119): [client 192.168.122.236:42816] auth phase 'check access' gave status 403: /missing.txt\n[Mon Feb 29 16:27:48.521212 2016] [rewrite:trace3] [pid 18816] mod_rewrite.c(476): [client 192.168.122.236:42816] 192.168.122.236 - - [cgihw.tld/sid#1c22af8][rid#1c3f058/initial/redir#1] [perdir /home/cgihw/public_html/] strip per-dir prefix: /home/cgihw/public_html/403.shtml -> 403.shtml\n[Mon Feb 29 16:27:48.521240 2016] [rewrite:trace3] [pid 18816] mod_rewrite.c(476): [client 192.168.122.236:42816] 192.168.122.236 - - [cgihw.tld/sid#1c22af8][rid#1c3f058/initial/redir#1] [perdir /home/cgihw/public_html/] applying pattern '.*' to uri '403.shtml'\n[Mon Feb 29 16:27:48.521264 2016] [rewrite:trace2] [pid 18816] mod_rewrite.c(476): [client 192.168.122.236:42816] 192.168.122.236 - - [cgihw.tld/sid#1c22af8][rid#1c3f058/initial/redir#1] [perdir /home/cgihw/public_html/] rewrite '403.shtml' -> 'goodbye.txt'\n[Mon Feb 29 16:27:48.521279 2016] [rewrite:trace3] [pid 18816] mod_rewrite.c(476): [client 192.168.122.236:42816] 192.168.122.236 - - [cgihw.tld/sid#1c22af8][rid#1c3f058/initial/redir#1] [perdir /home/cgihw/public_html/] add per-dir prefix: goodbye.txt -> /home/cgihw/public_html/goodbye.txt\n[Mon Feb 29 16:27:48.521296 2016] [rewrite:trace2] [pid 18816] mod_rewrite.c(476): [client 192.168.122.236:42816] 192.168.122.236 - - [cgihw.tld/sid#1c22af8][rid#1c3f058/initial/redir#1] [perdir /home/cgihw/public_html/] strip document_root prefix: /home/cgihw/public_html/goodbye.txt -> /goodbye.txt\n[Mon Feb 29 16:27:48.521310 2016] [rewrite:trace1] [pid 18816] mod_rewrite.c(476): [client 192.168.122.236:42816] 192.168.122.236 - - [cgihw.tld/sid#1c22af8][rid#1c3f058/initial/redir#1] [perdir /home/cgihw/public_html/] internal redirect with /goodbye.txt [INTERNAL REDIRECT]\n[Mon Feb 29 16:27:48.521420 2016] [rewrite:trace3] [pid 18816] mod_rewrite.c(476): [client 192.168.122.236:42816] 192.168.122.236 - - [cgihw.tld/sid#1c22af8][rid#1c42bb0/initial/redir#2] [perdir /home/cgihw/public_html/] strip per-dir prefix: /home/cgihw/public_html/goodbye.txt -> goodbye.txt\n[Mon Feb 29 16:27:48.521437 2016] [rewrite:trace3] [pid 18816] mod_rewrite.c(476): [client 192.168.122.236:42816] 192.168.122.236 - - [cgihw.tld/sid#1c22af8][rid#1c42bb0/initial/redir#2] [perdir /home/cgihw/public_html/] applying pattern '.*' to uri 'goodbye.txt'\n[Mon Feb 29 16:27:48.521451 2016] [rewrite:trace2] [pid 18816] mod_rewrite.c(476): [client 192.168.122.236:42816] 192.168.122.236 - - [cgihw.tld/sid#1c22af8][rid#1c42bb0/initial/redir#2] [perdir /home/cgihw/public_html/] rewrite 'goodbye.txt' -> 'goodbye.txt'\n[Mon Feb 29 16:27:48.521464 2016] [rewrite:trace3] [pid 18816] mod_rewrite.c(476): [client 192.168.122.236:42816] 192.168.122.236 - - [cgihw.tld/sid#1c22af8][rid#1c42bb0/initial/redir#2] [perdir /home/cgihw/public_html/] add per-dir prefix: goodbye.txt -> /home/cgihw/public_html/goodbye.txt\n[Mon Feb 29 16:27:48.521479 2016] [rewrite:trace1] [pid 18816] mod_rewrite.c(476): [client 192.168.122.236:42816] 192.168.122.236 - - [cgihw.tld/sid#1c22af8][rid#1c42bb0/initial/redir#2] [perdir /home/cgihw/public_html/] initial URL equal rewritten URL: /home/cgihw/public_html/goodbye.txt [IGNORING REWRITE]\n[Mon Feb 29 16:27:48.521561 2016] [http:trace3] [pid 18816] http_filters.c(1006): [client 192.168.122.236:42816] Response sent with status 403, headers:\n[Mon Feb 29 16:27:48.521572 2016] [http:trace5] [pid 18816] http_filters.c(1013): [client 192.168.122.236:42816]   Date: Mon, 29 Feb 2016 16:27:48 GMT\n[Mon Feb 29 16:27:48.521581 2016] [http:trace5] [pid 18816] http_filters.c(1016): [client 192.168.122.236:42816]   Server: Apache\n[Mon Feb 29 16:27:48.521590 2016] [http:trace4] [pid 18816] http_filters.c(835): [client 192.168.122.236:42816]   Last-Modified: Mon, 29 Feb 2016 16:06:33 GMT\n[Mon Feb 29 16:27:48.521600 2016] [http:trace4] [pid 18816] http_filters.c(835): [client 192.168.122.236:42816]   Accept-Ranges: bytes\n[Mon Feb 29 16:27:48.521608 2016] [http:trace4] [pid 18816] http_filters.c(835): [client 192.168.122.236:42816]   Content-Length: 14\n[Mon Feb 29 16:27:48.521615 2016] [http:trace4] [pid 18816] http_filters.c(835): [client 192.168.122.236:42816]   Connection: close\n[Mon Feb 29 16:27:48.521622 2016] [http:trace4] [pid 18816] http_filters.c(835): [client 192.168.122.236:42816]   Content-Type: text/plain\n[Mon Feb 29 16:27:48.521662 2016] [core:trace6] [pid 18816] core_filters.c(525): [client 192.168.122.236:42816] core_output_filter: flushing because of FLUSH bucket\n[Mon Feb 29 16:27:48.521934 2016] [core:trace6] [pid 18816] core_filters.c(525): [client 192.168.122.236:42816] core_output_filter: flushing because of FLUSH bucket", "is_private": false, "id": 188976, "creator": "jacob.perkins@cpanel.net", "time": "2016-02-29T16:28:29Z", "bug_id": 58854, "creation_time": "2016-02-29T16:28:29Z", "attachment_id": null}, {"count": 17, "tags": [], "bug_id": 58854, "attachment_id": null, "text": "Since we're having a difficult time duplicating the secondary issues, I am closing this bug.\n\nThanks for your help Eric", "id": 189510, "time": "2016-03-16T15:26:12Z", "creator": "kurt.newman@cpanel.net", "creation_time": "2016-03-16T15:26:12Z", "is_private": false}]