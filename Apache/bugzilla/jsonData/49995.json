[{"count": 0, "tags": [], "creator": "pawel@szafka.net", "attachment_id": null, "text": "Summary:\nWe have http with wildcard ssl. We're creating few vhost, one main and one for each user.\nOne of our users wants to have a ssl vhost on different port with his own certs.\nApparently, when ServerName's are duplicated among vhosts, strange results happends.\nApache2 is sending one cert amongs duplicated vhosts, ignoring the fact that vhosts are\nconfigured on different ports and with different SSLCertificateFile.\n\nIs reproducible: Yes, always.\n\nHow to reproduce:\nStep 1: Compile httpd2.2:\n./configure --with-mpm=worker --enable-suexec --enable-ssl --prefix=/usr/local/apache2-2.2.16\nmake\nmake install\n\nStep 2: generate two SSL certs:\ncd /usr/local/apache2-2.2.16/conf\nopenssl req -new -x509 -days 3650 -newkey rsa:2048 -nodes \\\n-subj '/O=MAIN-CERT/CN=*.local.net' -keyout wildcard.local.net.key \\\n-out wildcard.local.net.crt\n\nopenssl req -new -x509 -days 3650 -newkey rsa:2048 -nodes \\   \n-subj '/O=User3-CERT/CN=user3.local.net' -keyout user3.local.net.key \\\n-out user3.local.net.crt\n\n\nStep 3: patch httpd.conf\n--- ./conf-original/httpd.conf\t2010-09-24 15:49:12.000000000 +0200\n+++ ./conf/httpd.conf\t2010-09-24 17:13:24.000000000 +0200\n@@ -39,3 +39,5 @@\n #Listen 12.34.56.78:80\n-Listen 80\n+Listen 127.0.0.1:80\n+Listen 127.0.0.1:443\n+Listen 127.0.0.1:3443\n \n@@ -409 +411,73 @@\n </IfModule>\n+\n+\n+\n+NameVirtualHost 127.0.0.1:80\n+NameVirtualHost 127.0.0.1:443\n+NameVirtualHost 127.0.0.1:3443\n+\n+<VirtualHost 127.0.0.1:80>\n+\tServerName \"main.local.net\"\n+\tDocumentRoot \"/usr/local/apache2-2.2.16/htdocs\"\n+</VirtualHost>\n+\n+<VirtualHost 127.0.0.1:80>\n+\tServerName \"user1.local.net\"\n+\tDocumentRoot \"/usr/local/apache2-2.2.16/htdocs/u1\"\n+</VirtualHost>\n+\n+<VirtualHost 127.0.0.1:80>\n+\tServerName \"user2.local.net\"\n+\tDocumentRoot \"/usr/local/apache2-2.2.16/htdocs/u2\"\n+</VirtualHost>\n+\n+<VirtualHost 127.0.0.1:80>\n+\tServerName \"user3.local.net\"\n+\tDocumentRoot \"/usr/local/apache2-2.2.16/htdocs/u3\"\n+</VirtualHost>\n+\n+\n+# SSL VHOSTS (wildcard *.local.net)\n+<VirtualHost 127.0.0.1:443>\n+\tSSLEngine on\n+\tSSLCertificateFile\t/usr/local/apache2-2.2.16/conf/wildcard.local.net.crt\n+\tSSLCertificateKeyFile\t/usr/local/apache2-2.2.16/conf/wildcard.local.net.key\n+\tServerName \"main.local.net\"\n+\tDocumentRoot \"/usr/local/apache2-2.2.16/htdocs\"\n+</VirtualHost>\n+\n+<VirtualHost 127.0.0.1:443>\n+\tSSLEngine on\n+\tSSLCertificateFile\t/usr/local/apache2-2.2.16/conf/wildcard.local.net.crt\n+\tSSLCertificateKeyFile\t/usr/local/apache2-2.2.16/conf/wildcard.local.net.key\n+\tServerName \"user1.local.net\"\n+\tDocumentRoot \"/usr/local/apache2-2.2.16/htdocs/u1\"\n+</VirtualHost>\n+\n+<VirtualHost 127.0.0.1:443>\n+\tSSLEngine on\n+\tSSLCertificateFile\t/usr/local/apache2-2.2.16/conf/wildcard.local.net.crt\n+\tSSLCertificateKeyFile\t/usr/local/apache2-2.2.16/conf/wildcard.local.net.key\n+\tServerName \"user2.local.net\"\n+\tDocumentRoot \"/usr/local/apache2-2.2.16/htdocs/u2\"\n+</VirtualHost>\n+\n+# BASE SSL VHOST for user3 with static pages. application will be on port 3443 and will\n+# have other cert for that.\n+<VirtualHost 127.0.0.1:443>\n+\tSSLEngine on\n+\tSSLCertificateFile\t/usr/local/apache2-2.2.16/conf/wildcard.local.net.crt\n+\tSSLCertificateKeyFile\t/usr/local/apache2-2.2.16/conf/wildcard.local.net.key\n+\tServerName \"user3.local.net\"\n+\tDocumentRoot \"/usr/local/apache2-2.2.16/htdocs/u3\"\n+</VirtualHost>\n+\n+# SOME OTHER VHOST on DIFFERENT PORT, different CRT but THE SAME ServerName as previous.\n+# SO bassicaly: https://user3.local.net:3443/ can be proxied thru AJP13 etc.\n+<VirtualHost 127.0.0.1:3443>\n+\tSSLEngine on\n+\tSSLCertificateFile\t/usr/local/apache2-2.2.16/conf/user3.local.net.crt\n+\tSSLCertificateKeyFile\t/usr/local/apache2-2.2.16/conf/user3.local.net.key\n+\tServerName \"user3.local.net\"\n+\tDocumentRoot \"/usr/local/apache2-2.2.16/htdocs/u3\"\n+</VirtualHost>\n\nStep 4: httpd -S:\nVirtualHost configuration:\n127.0.0.1:80           is a NameVirtualHost\n         default server main.local.net (/usr/local/apache2-2.2.16/conf/httpd.conf:419)\n         port 80 namevhost main.local.net (/usr/local/apache2-2.2.16/conf/httpd.conf:419)\n         port 80 namevhost user1.local.net (/usr/local/apache2-2.2.16/conf/httpd.conf:424)\n         port 80 namevhost user2.local.net (/usr/local/apache2-2.2.16/conf/httpd.conf:429)\n         port 80 namevhost user3.local.net (/usr/local/apache2-2.2.16/conf/httpd.conf:434)\n127.0.0.1:443          is a NameVirtualHost\n         default server main.local.net (/usr/local/apache2-2.2.16/conf/httpd.conf:441)\n         port 443 namevhost main.local.net (/usr/local/apache2-2.2.16/conf/httpd.conf:441)\n         port 443 namevhost user1.local.net (/usr/local/apache2-2.2.16/conf/httpd.conf:449)\n         port 443 namevhost user2.local.net (/usr/local/apache2-2.2.16/conf/httpd.conf:457)\n         port 443 namevhost user3.local.net (/usr/local/apache2-2.2.16/conf/httpd.conf:467)\n127.0.0.1:3443         is a NameVirtualHost\n         default server user3.local.net (/usr/local/apache2-2.2.16/conf/httpd.conf:477)\n         port 3443 namevhost user3.local.net (/usr/local/apache2-2.2.16/conf/httpd.conf:477)\nSyntax OK\n\nStep 5: Check the results:\nopenssl s_client -connect 127.0.0.1:443\nopenssl s_client -connect 127.0.0.1:3443\n\nResult: Apache2 sends the same cert on different ports, but serving requests\ncorrectly (from correct DocumentRoot, as stated in httpd.conf).\n\nExpected result: Apache2 should return different cert on different ports based on httpd.conf.\n\n\nPossible Workaround:\nChange ServerName in last vhost :3443 to some other string, ex. \"whatever.local.net\".\nIf ServerName's are not duplicated among different virtualhosts, apache\nserve correct certs. Sometimes this is not an option.  When using\nproxy, ex. mod_jk for proxying user3.local.net:3443 thru AJP13 to tomcat ->\napache2 then sends ServerName thru AJP13 to tomcat and it must match with\nthe one in tomcat config file. If we change ServerName from user3.local.net\nto whatever.local.net, it would require to change tomcat vhost in config as well.\nAnd it would be messy.\n\nBug can be reproduced with:\nhttpd-2.2.16.tar.bz2 (sha1: ef92f5b3124fe5e9ba6121ea7f4bab8c014068f9)\napache2-2.2.9 from Debian 5.0\napache2-2.2.3 from Debian 4.0\nPossibly others.\nmpm: worker, others mpm: not tested.\n\nCompiled and tested without SNI support.", "id": 140140, "time": "2010-09-24T11:50:08Z", "bug_id": 49995, "creation_time": "2010-09-24T11:50:08Z", "is_private": false}, {"count": 1, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "text": "\n\n*** This bug has been marked as a duplicate of bug 43218 ***", "id": 172496, "time": "2014-01-19T19:23:50Z", "bug_id": 49995, "creation_time": "2014-01-19T19:23:50Z", "is_private": false}]