[{"count": 0, "tags": [], "text": "I'm receiving a buffer overrun when writing a workbook to a byte steam and I believe I've found the issue. Unfortunately I can't share the spreadsheet so I'll explain the problem as best as possible.\n\nUsing revision 1099313 from SVN.\n\nOriginal stack trace which indicates that the buffer isn't big enough for the serialised data:\n\nException in thread \"main\" java.lang.RuntimeException: Buffer overrun\nat org.apache.poi.util.LittleEndianByteArrayOutputStream.checkPosition(LittleEndianByteArrayOutputStream.java:56)\nat org.apache.poi.util.LittleEndianByteArrayOutputStream.write(LittleEndianByteArrayOutputStream.java:100)\nat org.apache.poi.hssf.record.SubRecord$UnknownSubRecord.serialize(SubRecord.java:117)\nat org.apache.poi.hssf.record.ObjRecord.serialize(ObjRecord.java:205)\nat org.apache.poi.hssf.usermodel.HSSFWorkbook$SheetRecordCollector.serialize(HSSFWorkbook.java:1248)\nat org.apache.poi.hssf.usermodel.HSSFWorkbook.getBytes(HSSFWorkbook.java:1296)\nat org.apache.poi.hssf.usermodel.HSSFWorkbook.write(HSSFWorkbook.java:1191)\n\nProblem is in the file: trunk/src/java/org/apache/poi/hssf/record/LbsDataSubRecord.java:387 in the method getDataSize() where it goes \"size += _unused;\". For my spreadsheet the variable _unused can be -62 which results in the record's size being reported as negative and the allocated buffer ends up too small.\n\nProposed fix:\n\npublic int getDataSize() {\n    int size = 6;\n    size += StringUtil.getEncodedSize(_str);\n    if (_unused != null) {\n      size++;\n    }\n    return size;\n}", "is_private": false, "bug_id": 51153, "id": 146131, "time": "2011-05-05T04:13:23Z", "creator": "chris-dev@infovet.co.nz", "creation_time": "2011-05-05T04:13:23Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "apache@gagravarr.org", "attachment_id": null, "text": "I agree with your fix, it makes perfect sense\n\nCommitted in r1100017, thanks!", "id": 146149, "time": "2011-05-06T01:28:28Z", "bug_id": 51153, "creation_time": "2011-05-06T01:28:28Z", "is_private": false}]