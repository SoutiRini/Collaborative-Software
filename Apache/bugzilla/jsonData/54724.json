[{"count": 0, "tags": [], "creator": "nicholas@nicholaswilliams.net", "attachment_id": null, "id": 165990, "time": "2013-03-19T13:22:56Z", "bug_id": 54724, "creation_time": "2013-03-19T13:22:56Z", "is_private": false, "text": "Spec JavaDoc says:\n\n\"Once the session is closed, it is no longer valid for use by applications. Calling any of its methods once the session has been closed will result in an IllegalStateException being thrown. Developers should retrieve any information from the session during the Endpoint.onClose(Session, CloseReason) method.\"\n\nOf course, the rules of Closeable also apply here, and calling Session#close(...) more than once should have no effect subsequent times.\n\nThere are actually three problems here:\n\n1) None of the methods throw IllegalStateException if the session is closed. Instead, they return things (like the basic remote, for example), and some methods in the endpoint implementation will not notice concurrent exceptions from the socket and then block forever waiting four the Countdown to clear.\n\n2) The Session#state is never actually changed to State.CLOSED unless Session#onClose is called. However, Session#onClose is never actually called that I can find (though I will look harder before I make changes).\n\n3) Even in Session#onClose, the state is incorrectly changed to State.CLOSED BEFORE Endpoint#onClose is called, when it should be changed AFTER.\n\nI'm working on a patch for this."}, {"count": 1, "tags": [], "bug_id": 54724, "attachment_id": null, "text": "1) Agreed.\n\n2) It is called when a close frame is received.\n\n3) WsSession.state was not implemented with 1) in mind. Its main role was making sure the socket was closed at the right point. Some additional states / variables may be required.", "id": 165995, "time": "2013-03-19T14:35:48Z", "creator": "markt@apache.org", "creation_time": "2013-03-19T14:35:48Z", "is_private": false}, {"count": 2, "attachment_id": null, "bug_id": 54724, "text": "Want to make sure we agree on approach, which is slightly more detailed than the JavaDoc spec:\n\n1. ALL WsSession methods specified by the Session interface will throw IllegalStateException if the session is closed EXCEPT:\n    - close() is a no-op if the session is already closed and will not throw an exception\n    - close(CloseReason) is a no-op if the session is already closed and will not throw an exception\n    - getId() returns an informational String that may not otherwise be acted upon, but may be useful for logging/troubleshooting/tracking after session close.\n    - isOpen() tests whether the socket is open or not and should never throw an exception, but instead return true or false.\n\n2. ALL public, protected, and private WsSession methods NOT specified in the Session interface will NOT throw an IllegalStateException if the session is closed.", "id": 166000, "time": "2013-03-19T15:47:49Z", "creator": "nicholas@nicholaswilliams.net", "creation_time": "2013-03-19T15:47:49Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "creator": "nicholas@nicholaswilliams.net", "attachment_id": null, "id": 166001, "time": "2013-03-19T16:11:17Z", "bug_id": 54724, "creation_time": "2013-03-19T16:11:17Z", "is_private": false, "text": "This may need more clarification at the spec level. Created a spec bug:\n\nhttp://java.net/jira/browse/WEBSOCKET_SPEC-174"}, {"count": 4, "tags": [], "bug_id": 54724, "attachment_id": null, "id": 166002, "creation_time": "2013-03-19T16:54:20Z", "time": "2013-03-19T16:54:20Z", "creator": "markt@apache.org", "text": "I have a patch that does pretty much exactly that but there are some unit test failures I need to resolve before I commit it.", "is_private": false}, {"count": 5, "tags": [], "bug_id": 54724, "attachment_id": null, "id": 166003, "creation_time": "2013-03-19T16:56:38Z", "time": "2013-03-19T16:56:38Z", "creator": "nicholas@nicholaswilliams.net", "text": "Okay. I won't work on a patch then.", "is_private": false}, {"count": 6, "tags": [], "creator": "markt@apache.org", "text": "Fixed in trunk.", "id": 166006, "time": "2013-03-19T19:50:10Z", "bug_id": 54724, "creation_time": "2013-03-19T19:50:10Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 54724, "attachment_id": null, "id": 166009, "time": "2013-03-19T20:24:43Z", "creator": "nicholas@nicholaswilliams.net", "creation_time": "2013-03-19T20:24:43Z", "is_private": false, "text": "Looks good. The only potential problem I can see is that it allows calls to addMessageHandler(MessageHandler), removeMessageHandler(MessageHandler), any set* methods, getAsyncRemote(), and getBasicRemote() from onClose, but (my opinion) is that should not be permitted, hence my filing of WEBSOCKET_SPEC-174. Depending on the resolution of that issue, this may need to be revisited slightly."}]