[{"count": 0, "tags": [], "creator": "uzl6iz702@sneakemail.com", "attachment_id": null, "text": "When a client uses a Host: HTTP header containing a port number in a proxied ftp\nGET request, the ftp proxy incorrectly attempts to connect to the FTP server on\nthat port.  For example, if the apache proxy runs on port 1234 the \"yum\" client\nwill send the following request to the proxy:\n\n-----\nGET ftp://server.otherdomain.com/path/to/file.txt HTTP/1.1\nHost: proxy.mydomain.com:1234\nAccept-Encoding: identity\nUser-agent: Yum/2.X\n-----\n\nThe proxy then tries to connect to server.otherdomain.com on port 1234 rather\nthan the default of port 21.  If the log level is cranked up, the following\nlines appear in the error_log:\n\n-----\n[debug] proxy_ftp.c(150): proxy: FTP: canonicalising URL\n//server.otherdomain.com/path/to/file.txt\n[debug] proxy_http.c(1038): proxy: HTTP: declining URL\nftp://server.otherdomain.com/path/to/file.txt\n[debug] proxy_connect.c(102): proxy: CONNECT: declining URL\nftp://server.otherdomain.com/path/to/file.txt\n[debug] proxy_ftp.c(782): proxy: FTP: serving URL\nftp://server.otherdomain.com/path/to/file.txt\n[debug] proxy_ftp.c(885): proxy: FTP: connecting\nftp://server.otherdomain.com/path/to/file.txt to server.otherdomain.com:1234\n[debug] proxy_ftp.c(963): proxy: FTP: fam 2 socket created, trying to connect to\n1.2.3.4:1234 (server.otherdomain.com)...\n(times out since port 1234 is firewalled)\n-----\n\nThanks to the detailed debug info provided, it's simple to see the code that's\nnot working as expected:\n\n----- proxy_ftp.c ----\n    /* We break the URL into host, port, path-search */\n    connectname = r->parsed_uri.hostname;\n    connectport = (r->parsed_uri.port != 0)\n        ? r->parsed_uri.port\n        : apr_uri_port_of_scheme(\"ftp\");\n-----\n\nFor some reason the HOST: header included is providing a port via the parsed_uri\nstructure.  When I send the following to the proxy via a telnet connection it\nworks fine:\n\n-----\nGET ftp://server.otherdomain.com/path/to/file.txt HTTP/1.1\nHost: proxy.mydomain.com\n-----\n\nI suspect something is wrong in how the parsed_uri gets built, but I haven't\ntraced it yet.\n\n  -- Steve", "id": 59814, "time": "2004-06-24T01:21:21Z", "bug_id": 29773, "creation_time": "2004-06-24T01:21:21Z", "is_private": false}, {"count": 1, "text": "The bug does not seem to exist in 2.0-HEAD. (checked.)\n", "bug_id": 29773, "attachment_id": null, "id": 99187, "time": "2007-02-09T09:53:56Z", "creator": "rahul.g.nair@gmail.com", "creation_time": "2007-02-09T09:53:56Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "creator": "rahul.g.nair@gmail.com", "attachment_id": null, "is_private": false, "id": 99191, "time": "2007-02-09T11:30:54Z", "bug_id": 29773, "creation_time": "2007-02-09T11:30:54Z", "text": "(correcting comment #1)\nThe bug does not seem to exist in 2.3-HEAD. (checked.)\n\n\n"}, {"count": 3, "text": "Unable to reproduce this in current 2.2; assuming fixed.", "bug_id": 29773, "is_private": false, "id": 107913, "time": "2007-09-09T15:25:27Z", "creator": "nick@webthing.com", "creation_time": "2007-09-09T15:25:27Z", "tags": [], "attachment_id": null}]