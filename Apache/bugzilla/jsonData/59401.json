[{"count": 0, "tags": [], "bug_id": 59401, "text": "Steps:\n1. use latest JMeter night build[3.0 svn 1741803]\n2. create a http sample[http://www.apache.org] with HTTP Header Manager config element.\n3. add \"Accept-Encoding = gzip, deflate\" into HTTP Header Manager.\n4. use HttpClient4 implementation in HTTP Request Sampler.\n5. Check the sampler result with View Results Tree.\n\n\nExpect results:\nThe String \"Content-Encoding: gzip\" should be included Response headers.\nThe body size is less than the content size because it should be compressed.\nThe behavior is same as JMeter 2.13.\n\n\nCurrent results:\nThere is no Content-Encoding parameter in response headers.\nThe body size is bigger than HttpClient3.1 implementation result.", "id": 190656, "time": "2016-05-01T12:59:51Z", "creator": "liu.xp2003@gmail.com", "creation_time": "2016-05-01T12:59:51Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 59401, "attachment_id": null, "is_private": false, "id": 190657, "time": "2016-05-01T13:26:04Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2016-05-01T13:26:04Z", "text": "Thanks for report.\nThe response is zipped but indeed Content-Encoding is missing.\n\nThe size difference is due to differences in computation between HC4 and HC3.1"}, {"count": 2, "tags": [], "bug_id": 59401, "attachment_id": null, "id": 190658, "time": "2016-05-01T13:40:43Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2016-05-01T13:40:43Z", "is_private": false, "text": "Hi,\nIssue is due to HttpClient 4.5.X behaviour:\n- https://github.com/apache/httpclient/blob/4.5.x/httpclient/src/main/java/org/apache/http/client/protocol/ResponseContentEncoding.java#L142\n\n\nWhen uncompressing HttpClient removes 3 headers:\n- Content-Length                        \n- Content-Encoding\n- Content-MD5"}, {"count": 3, "tags": [], "text": "Created attachment 33817\nPatch for issue\n\nHello,\nHere's a first proposal for a fix:\n- Register a ResponseInterceptor at first position that will backup the headers in localContext as JMETER_RESPONSE_HEADERS attribute\n- Use this backup when computing response headers in SampleResult", "is_private": false, "id": 190660, "creator": "p.mouawad@ubik-ingenierie.com", "time": "2016-05-01T15:01:15Z", "bug_id": 59401, "creation_time": "2016-05-01T15:01:15Z", "attachment_id": 33817}, {"count": 4, "tags": [], "creator": "milamber@apache.org", "attachment_id": null, "text": "\nThis fix works for me. \n@philippe You want find another patch? (better patch?)", "id": 190661, "time": "2016-05-01T15:46:53Z", "bug_id": 59401, "creation_time": "2016-05-01T15:46:53Z", "is_private": false}, {"count": 5, "attachment_id": null, "creator": "p.mouawad@ubik-ingenierie.com", "is_private": false, "id": 190662, "time": "2016-05-01T16:01:46Z", "bug_id": 59401, "creation_time": "2016-05-01T16:01:46Z", "tags": [], "text": "There is a potential other fix that does is a copy paste of ResponseContentEncoding but that does not remove the 3 headers.\n\n\nWas discussing on HttpClient mailing list , subject : ResponseContentEncoding behaviour in HttpClient 4.5.2 and 5.0"}, {"attachment_id": null, "tags": [], "bug_id": 59401, "is_private": false, "count": 6, "id": 190663, "time": "2016-05-01T19:12:15Z", "creator": "sebb@apache.org", "creation_time": "2016-05-01T19:12:15Z", "text": "Seems to me that the HttpClient behaviour is correct; if it is asked to decompress the content it must remove the headers.\n\nIf we want the original headers and content, then JMeter needs (as Oleg stated) to stop HC from decompressing the response.\n\nHowever JMeter will need to do the decompression itself. There's already code to do this as I recall.\n\nI think that is a better fix than intercepting the response.\nIt also offers the possibility of keeping the response as compressed."}, {"count": 7, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "is_private": false, "text": "Hello sebb,\nMy current attached patch gets original headers without touching HC decompression.\n\nYes there was in JMeter code to decompress, but :\n- it only handles GZIP\n- Not sure it correctly handles cases like 304 or 204\n\nIn what case would be need to keep the response compressed ? \n\nDo you intend to implement what you propose for 3.0 or for next 3.1 ?\nThanks", "id": 190664, "time": "2016-05-01T19:24:28Z", "bug_id": 59401, "creation_time": "2016-05-01T19:24:28Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 59401, "attachment_id": 33818, "is_private": false, "id": 190689, "time": "2016-05-02T12:38:18Z", "creator": "sebb@apache.org", "creation_time": "2016-05-02T12:38:18Z", "text": "Created attachment 33818\nAlternative patch using temporary headers"}, {"count": 9, "attachment_id": 33819, "bug_id": 59401, "is_private": false, "id": 190690, "time": "2016-05-02T12:40:19Z", "creator": "sebb@apache.org", "creation_time": "2016-05-02T12:40:19Z", "tags": [], "text": "Created attachment 33819\nTest plan with different Accept-Encoding headers"}, {"count": 10, "tags": [], "bug_id": 59401, "text": "Created attachment 33821\nAlternative patch using temporary headers, v2", "id": 190698, "time": "2016-05-02T22:00:53Z", "creator": "sebb@apache.org", "creation_time": "2016-05-02T22:00:53Z", "is_private": false, "attachment_id": 33821}, {"count": 11, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "is_private": false, "text": "Created attachment 33822\nPatch that saves only 3 headers in Context", "id": 190706, "time": "2016-05-03T19:42:37Z", "bug_id": 59401, "creation_time": "2016-05-03T19:42:37Z", "attachment_id": 33822}, {"count": 12, "tags": [], "bug_id": 59401, "text": "Created attachment 33823\nAlternative patch using Context\n\nThis avoids the Set and lowercasing.\n\nIt also allows for the headers not being deleted: the HC code actually has another check before uncompressing and removing them; also if the decompress fails presumably HC won't drop the headers.\n\nWe should not store them twice.", "id": 190707, "time": "2016-05-03T20:37:23Z", "creator": "sebb@apache.org", "creation_time": "2016-05-03T20:37:23Z", "is_private": false, "attachment_id": 33823}, {"count": 13, "tags": [], "bug_id": 59401, "attachment_id": null, "id": 190711, "time": "2016-05-03T21:02:46Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2016-05-03T21:02:46Z", "is_private": false, "text": "(In reply to Sebb from comment #12)\n> Created attachment 33823 [details]\n> Alternative patch using Context\n> \n> This avoids the Set and lowercasing.\n> \n> It also allows for the headers not being deleted: the HC code actually has\n> another check before uncompressing and removing them; also if the decompress\n> fails presumably HC won't drop the headers.\n> \n> We should not store them twice.\n\nOk for me"}, {"count": 14, "tags": [], "bug_id": 59401, "attachment_id": null, "id": 190716, "time": "2016-05-04T06:55:34Z", "creator": "milamber@apache.org", "creation_time": "2016-05-04T06:55:34Z", "is_private": false, "text": "\nThat(In reply to Philippe Mouawad from comment #13)\n> (In reply to Sebb from comment #12)\n> > Created attachment 33823 [details]\n> > Alternative patch using Context\n> > \n> > This avoids the Set and lowercasing.\n> > \n> > It also allows for the headers not being deleted: the HC code actually has\n> > another check before uncompressing and removing them; also if the decompress\n> > fails presumably HC won't drop the headers.\n> > \n> > We should not store them twice.\n> \n> Ok for me\n\n@Sebb @Philippe : That means we have a consensus with the last patch of Sebb? If yes, Sebb can you commit on the trunk, please.\nNo blocker now to 3.0 RC4?"}, {"count": 15, "tags": [], "bug_id": 59401, "text": "Authors: sebb & pmouawad\nDate: Wed May  4 19:49:51 2016\nNew Revision: 1742324\n\nURL: http://svn.apache.org/viewvc?rev=1742324&view=rev\nLog:\nBug 59401 - The HttpClient4 implementation uncompresses the compressed response but removes Content-Encoding response header when request has header \"Accept-Encoding = gzip, deflate\"\nBugzilla Id: 59401\n\nModified:\n    jmeter/trunk/src/protocol/http/org/apache/jmeter/protocol/http/sampler/HTTPHC4Impl.java", "id": 190731, "time": "2016-05-04T19:50:24Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2016-05-04T19:50:24Z", "is_private": false, "attachment_id": null}, {"count": 16, "tags": [], "bug_id": 59401, "attachment_id": null, "id": 190732, "time": "2016-05-04T20:02:50Z", "creator": "sebb@apache.org", "creation_time": "2016-05-04T20:02:50Z", "is_private": false, "text": "(In reply to Milamber from comment #14)\n> That(In reply to Philippe Mouawad from comment #13)\n> > (In reply to Sebb from comment #12)\n> > > Created attachment 33823 [details]\n> > > Alternative patch using Context\n> > > \n> > > This avoids the Set and lowercasing.\n> > > \n> > > It also allows for the headers not being deleted: the HC code actually has\n> > > another check before uncompressing and removing them; also if the decompress\n> > > fails presumably HC won't drop the headers.\n> > > \n> > > We should not store them twice.\n> > \n> > Ok for me\n> \n> @Sebb @Philippe : That means we have a consensus with the last patch of\n> Sebb? If yes, Sebb can you commit on the trunk, please.\n> No blocker now to 3.0 RC4?\n\nNot quite; I think we need to fix 59152 first (and perhaps 59429)"}]