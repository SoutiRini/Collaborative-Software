[{"count": 0, "tags": [], "bug_id": 48843, "text": "Hi,\n\nI believe I've found a race condition in Tomcat that causes the http port to\nbe non-responsive. It exists in 6.0 and also in 5.5 (although the code has\nbeen refactored).\nI could not find any reference to it in the Bug database or the mailing list\narchives.\n\nConsider a tomcat instance with maxThreads set to 2, i.e. you have 2 tomcat\nthreads to service incoming requests.\nThe sequence of events is as follows:\n1. Thread 1 and Thread 2 are both servicing a request each.\n2. A third request comes in.\n3. In class JIOEndpoint.java, the acceptor thread calls methods\nprocessSocket() which then calls getWorkerThread() which then calls\ncreateWorkerThread().\n4. createWorkerThread() returns null since both threads are busy processing\nthe two requests.\n5. Here is the race condition in method getWorkerThread() in the code shown\nbelow\n\nprotected Worker getWorkerThread(){\n...\nWorker workerThread = createWorkerThread();\n        while (workerThread == null) {\n            try {\n                synchronized (workers) {\n                    workers.wait();\n                 }\n            }\n...\n}\n\nThe acceptor thread executes the \"while(workerThread == null)\" statement and\nis then switched out by the CPU.\nThe two threads executing the two requests complete and go into\nWorker.await() waiting for the next job after executing method\nrecycleWorkerThread().\nThe acceptor thread is switched back into CPU and executes the synchronized\nblock and goes into the wait().\n\nAt this point, there aren't any Worker threads out there processing requests\nand therefore there isn't any thread to wake up the acceptor thread.\nThe application is non-responsive after this.\n\nA simple solution would be to check if curThreadsBusy > 0 in the\nsynchronized block before going into wait() in method getWorkerThread()\nOR increase the scope of the critical section to include the while loop.\n\nThanks,\nHarshad\n\nStack Traces below:\n\n\"bda19102143\" id=1578 in WAITING on\nlock=org.apache.tomcat.util.net.jioendpoint$wor...@13aa4ee3^m\n    at java.lang.Object.wait(Native Method)^M\n    at java.lang.Object.wait(Object.java:485)^M\n    at\norg.apache.tomcat.util.net.JIoEndpoint$Worker.await(JIoEndpoint.java:416)^M\n    at\norg.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:442)^M\n    at java.lang.Thread.run(Thread.java:619)^M\n\n\"http-8091-Acceptor-0\" id=43 in WAITING on\nlock=org.apache.tomcat.util.net.jioendpoint$workerst...@13bd7b6a^m\n    at java.lang.Object.wait(Native Method)^M\n    at java.lang.Object.wait(Object.java:485)^M\n    at\norg.apache.tomcat.util.net.JIoEndpoint.getWorkerThread(JIoEndpoint.java:700)^M\n    at\norg.apache.tomcat.util.net.JIoEndpoint.processSocket(JIoEndpoint.java:731)^M\n    at\norg.apache.tomcat.util.net.JIoEndpoint$Acceptor.run(JIoEndpoint.java:313)^M\n    at java.lang.Thread.run(Thread.java:619)^M", "id": 135006, "time": "2010-03-02T17:43:49Z", "creator": "hnkamat@gmail.com", "creation_time": "2010-03-02T17:43:49Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 48843, "is_private": false, "text": "Thanks for the report and the associated analysis.\n\nThis issue appears to only affect 6.0.x.\n\nThe issue had already been fixed in the NIO connector so I have proposed the same fox for the BIO and APR connectors.", "id": 135749, "time": "2010-03-29T12:43:04Z", "creator": "markt@apache.org", "creation_time": "2010-03-29T12:43:04Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 48843, "text": "> This issue appears to only affect 6.0.x.\nThe above phrase means only that it does not affect trunk. That is because Workers are not used there anymore. This issue does affect TC 5.5.x", "id": 135854, "time": "2010-04-02T13:59:46Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2010-04-02T13:59:46Z", "is_private": false, "attachment_id": null}, {"count": 3, "text": "Created attachment 25225\n2010-04-02_tc6_bug48843.patch", "creator": "knst.kolinko@gmail.com", "is_private": false, "id": 135856, "time": "2010-04-02T15:41:21Z", "bug_id": 48843, "creation_time": "2010-04-02T15:41:21Z", "tags": [], "attachment_id": 25225}, {"count": 4, "tags": [], "bug_id": 48843, "attachment_id": 25226, "id": 135857, "time": "2010-04-02T15:51:29Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2010-04-02T15:51:29Z", "is_private": false, "text": "Created attachment 25226\n2010-04-02_tc55_bug48843.patch"}, {"count": 5, "tags": [], "creator": "knst.kolinko@gmail.com", "text": "The above patches were proposed for 6.0 and 5.5.", "id": 135858, "time": "2010-04-02T15:58:04Z", "bug_id": 48843, "creation_time": "2010-04-02T15:58:04Z", "is_private": false, "attachment_id": null}, {"count": 6, "text": "The patch was applied to 5.5 in r934922, will be in 5.5.30 onwards.", "creator": "knst.kolinko@gmail.com", "attachment_id": null, "id": 136201, "time": "2010-04-16T10:39:19Z", "bug_id": 48843, "creation_time": "2010-04-16T10:39:19Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "bug_id": 48843, "attachment_id": null, "id": 137268, "time": "2010-06-01T22:41:29Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2010-06-01T22:41:29Z", "is_private": false, "text": "The patch was applied to 6.0 in r950341, will be in 6.0.27 onwards."}, {"count": 8, "tags": [], "bug_id": 48843, "text": "Fixed a similar issue with AprEndpoint.Poller, AprEndpoint.Sendfile in trunk in r950851\n\nBackport proposed for 6.0.\n\nThe 5.5 code is similar, but I have not prepared the patch for it yet.\nReopening the issue to track this additional fix for AprEndpoint.", "id": 137290, "time": "2010-06-02T21:54:15Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2010-06-02T21:54:15Z", "is_private": false, "attachment_id": null}, {"count": 9, "text": "Created attachment 25529\n2010-06-04_tc55_bug48843_c8.patch\n\nThis patch is a backport of r950851 to tc5.5.x. It will be proposed for 5.5.", "creator": "knst.kolinko@gmail.com", "attachment_id": 25529, "id": 137366, "time": "2010-06-04T16:26:23Z", "bug_id": 48843, "creation_time": "2010-06-04T16:26:23Z", "tags": [], "is_private": false}, {"count": 10, "tags": [], "bug_id": 48843, "attachment_id": null, "id": 137412, "time": "2010-06-07T12:20:24Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2010-06-07T12:20:24Z", "is_private": false, "text": "Regarding AprEndpoint.Poller, AprEndpoint.Sendfile fix (comment 8 and below, r950851 and attachment 25529):\n\nIt is not a deadlock there. It is a missed wakeup in add queue in AprEndpoint.Poller.add() and AprEndpoint.Sendfile.add(). Tomcat does not stop processing requests and the next request will wake up the queue.\n\nThe fix also changes handling of unexpected errors when processing the add queue in AprEndpoint.Poller.run() and AprEndpoint.Sendfile.run(), by zeroing the addCount variable."}, {"count": 11, "tags": [], "bug_id": 48843, "text": "The AprEndpoint.Poller & Sendfile fix applied to 6.0 in r953010 and will be in 6.0.27 onwards.", "id": 137493, "time": "2010-06-09T10:09:20Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2010-06-09T10:09:20Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 48843, "text": "The second issue has been fixed in 5.5.x and will also be included in 5.5.30 onwards.", "id": 137797, "time": "2010-06-22T04:55:08Z", "creator": "markt@apache.org", "creation_time": "2010-06-22T04:55:08Z", "is_private": false, "attachment_id": null}]