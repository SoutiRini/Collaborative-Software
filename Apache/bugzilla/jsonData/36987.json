[{"count": 0, "tags": [], "creator": "timo.viipuri@f-secure.com", "attachment_id": null, "text": "Sites listed in the ProxyBlock list should be blocked based on all IP addresses\nfound in the DNS. Now they are blocked only based on the first IP address found\nin the DNS. For example, site:\n\nName:    x.com\nAddresses:  64.4.241.33, 216.113.188.33, 216.113.188.64, 64.4.241.16\n\nshould be blocked if it is tried to access with any one of the above IPs.\nCurrently, it is only blocked with 64.4.241.33\n\nThe problem is easy to see in the code in function\nproxy_util.c:ap_proxy_checkproxyblock():\n\n--------------------BEGIN CODE-------------------\n968:   while (conf_addr) {\n969:        while (uri_addr) {\n970:            char *conf_ip;\n971:            char *uri_ip;\n972:            apr_sockaddr_ip_get(&conf_ip, conf_addr);\n973:            apr_sockaddr_ip_get(&uri_ip, uri_addr);\n974:            ap_log_error(APLOG_MARK, APLOG_DEBUG, 0, r->server,\n975:                         \"proxy: ProxyBlock comparing %s and %s\", conf_ip,\nuri_ip);\n976:            if (!apr_strnatcasecmp(conf_ip, uri_ip)) {\n977:                ap_log_error(APLOG_MARK, APLOG_WARNING, 0, r->server,\n978:                    \"proxy: connect to remote machine %s blocked: IP %s\nmatched\", uri_addr->hostname, conf_ip);\n979:                return HTTP_FORBIDDEN;\n980:            }\n981:            uri_addr = uri_addr->next;\n982:        }\n983:        conf_addr = conf_addr->next;\n984:    }\n--------------------END CODE-------------------\n\nThe inner loop is exited when uri_addr == NULL. However, uri_addr is not reseted\nafter the loop is exited for the first time so it is not entered again on the\nnext runs of the outer loop.\n\nThe following patch will solve the problem:\n\n--------------------BEGIN PATCH-------------------\n--- proxy_util_ORIG.c   Mon Aug 22 12:22:53 2005\n+++ proxy_util.c        Mon Oct 10 14:18:12 2005\n@@ -966,6 +966,7 @@\n             return HTTP_FORBIDDEN;\n         }\n         while (conf_addr) {\n+            uri_addr = src_uri_addr;\n             while (uri_addr) {\n                 char *conf_ip;\n                 char *uri_ip;\n--------------------END PATCH-------------------\n\nTo demonstrate the error behaviour, here's a clip of error.log when ProxyBlock\nhas been set to \"x.com\" and someone tries to access it with IP address\n216.113.188.64:\n\n-----------BEGIN ORIGINAL ERROR.LOG------------\n[Mon Oct 10 13:46:14 2005] [debug] proxy_util.c(975): proxy: checking remote\nmachine [216.113.188.64] against [x.com]\n[Mon Oct 10 13:46:14 2005] [debug] proxy_util.c(991): proxy: ProxyBlock\ncomparing 64.4.241.33 and 216.113.188.64\n-----------END ORIGINAL ERROR.LOG--------------\n\nAnd here's how it looks after the patch has been applied:\n\n-----------BEGIN PATCHED ERROR.LOG------------\n[Mon Oct 10 13:50:48 2005] [debug] proxy_util.c(975): proxy: checking remote\nmachine [216.113.188.64] against [x.com]\n[Mon Oct 10 13:50:48 2005] [debug] proxy_util.c(991): proxy: ProxyBlock\ncomparing 64.4.241.33 and 216.113.188.64\n[Mon Oct 10 13:50:48 2005] [debug] proxy_util.c(991): proxy: ProxyBlock\ncomparing 216.113.188.33 and 216.113.188.64\n[Mon Oct 10 13:50:48 2005] [debug] proxy_util.c(991): proxy: ProxyBlock\ncomparing 216.113.188.64 and 216.113.188.64\n[Mon Oct 10 13:50:48 2005] [warn] proxy: connect to remote machine\n216.113.188.64 blocked: IP 216.113.188.64 matched\n-----------END PATCHED ERROR.LOG--------------", "id": 80949, "time": "2005-10-10T13:42:02Z", "bug_id": 36987, "creation_time": "2005-10-10T13:42:02Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 36987, "text": "Created attachment 16634\nSet uri_addr correctly before running the inner loop in ap_proxy_checkproxyblock()", "id": 80950, "time": "2005-10-10T13:44:43Z", "creator": "timo.viipuri@f-secure.com", "creation_time": "2005-10-10T13:44:43Z", "is_private": false, "attachment_id": 16634}, {"count": 2, "text": "Fixed in trunk in r573911.", "creator": "nick@webthing.com", "attachment_id": null, "id": 107876, "time": "2007-09-08T14:45:40Z", "bug_id": 36987, "creation_time": "2007-09-08T14:45:40Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 36987, "attachment_id": null, "is_private": false, "id": 108069, "time": "2007-09-12T06:29:43Z", "creator": "nick@webthing.com", "creation_time": "2007-09-12T06:29:43Z", "text": "Backported to 2.2 in r574942."}]