[{"count": 0, "tags": [], "creator": "ishi.spam@gmail.com", "is_private": false, "text": "I get a NullPointerException (stacktrace follows) when I call getNext().invoke(...) in my Valve, when in the valve chain exists the AccessLogValve.\n\nMy valve creates a 'wrapper' for the Response using a class like this:\n\npublic class CountingResponse extends ResponseDecorator {\n\tfinal private transient AtomicInteger counter;\n\tprivate CountingResponseWrapper wrapper;\n\n\tpublic CountingResponse(final Response target) {\n\t\tsuper(target);\n\t\twrapper = null;\n\t\tcounter = new AtomicInteger(0);\n\t}\n\n\t@Override\n\tpublic synchronized HttpServletResponse getResponse() {\n\t\tif (wrapper == null) {\n\t\t\tfinal HttpServletResponse supResponse = super.getResponse();\n\t\t\tif (supResponse == null) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\twrapper = new CountingResponseWrapper(supResponse, counter);\n\t\t}\n\t\treturn wrapper;\n\t}\n\n\t@Override\n\tpublic ServletOutputStream getOutputStream() throws IOException {\n\t\tfinal ServletOutputStream stream = super.getOutputStream();\n\t\tif (stream instanceof CountingOutputStream) {\n\t\t\treturn stream;\n\t\t}\n\t\treturn new CountingOutputStream(stream, counter);\n\t}\n\n\t@Override\n\tpublic PrintWriter getWriter() throws IOException {\n\t\tfinal PrintWriter writer = super.getWriter();\n\t\tif (writer instanceof CountingWriter) {\n\t\t\treturn writer;\n\t\t}\n\t\treturn new CountingWriter(writer, counter);\n\t}\n\n\tpublic int getCounter() {\n\t\treturn counter.get();\n\t}\n}\n\nThe ResponseDecorator is a a class that extends org.apache.catalina.connector.Response, its constructor takes Response (target) as argument and all public and protected calls are redirected to target (a simple decorator).\n\nThe stacktrace:\n\njava.lang.NullPointerException\n\tat org.apache.catalina.connector.Response.getContentCountLong(Response.java:313)\n\tat org.apache.catalina.valves.AccessLogValve$ByteSentElement.addElement(AccessLogValve.java:1102)\n\tat org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:582)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:128)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n\tat org.apache.catalina.ha.session.JvmRouteBinderValve.invoke(JvmRouteBinderValve.java:209)\n\tat org.apache.catalina.ha.tcp.ReplicationValve.invoke(ReplicationValve.java:347)\n\tat pl.avantis.tomcat.valves.RemoteCLValve.invoke(RemoteCLValve.java:77)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:286)\n\tat org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:845)\n\tat org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:583)\n\tat org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:447)\n\tat java.lang.Thread.run(Thread.java:619)", "id": 123202, "time": "2008-12-09T10:04:15Z", "bug_id": 46370, "creation_time": "2008-12-09T10:04:15Z", "attachment_id": null}, {"count": 1, "tags": [], "text": "Looks like a problem with your wrapper. The line of the NPE indicates that the outputBuffer is null. The users list is the place to get help with this in the first instance.", "is_private": false, "id": 123543, "creator": "markt@apache.org", "time": "2008-12-26T15:33:11Z", "bug_id": 46370, "creation_time": "2008-12-26T15:33:11Z", "attachment_id": null}]