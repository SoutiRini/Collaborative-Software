[{"count": 0, "tags": [], "bug_id": 60437, "attachment_id": 34494, "text": "Created attachment 34494\nsample program\n\nThis defect is related to an issue reported previously (https://bz.apache.org/bugzilla/show_bug.cgi?id=54997) .\nWith the above fix, although BUFFER_UNDERFLOW is being handled, there is still an issue with BUFFER_OVERFLOW. \n\nIssue is reproduced by using WebSocketContainer to connect to a server which requires clientcert authentication (  SSLEnabled=\"true\" clientAuth=\"true\" )\n\n\nIn this case, during the SSL handshake, when AsyncChannelWrapperSecure gets a handshakeStatus of NEED_UNWRAP, it needs to dynamically resize the DUMMY buffer, before invoking sslEngine.unwrap(socketReadBuffer, DUMMY), as recommended by http://docs.oracle.com/javase/7/docs/api/javax/net/ssl/SSLEngine.html . \n\n\nThe handshake fails with the following error :\njavax.websocket.DeploymentException: The HTTP request to initiate the WebSocket connection failed\n\tat org.apache.tomcat.websocket.WsWebSocketContainer.connectToServer(WsWebSocketContainer.java:423)\n\tat com.wss.WSSCLientUsingTomcatWSContainer.main(WSSCLientUsingTomcatWSContainer.java:27)\nCaused by: java.util.concurrent.ExecutionException: javax.net.ssl.SSLException: TODO\n\tat org.apache.tomcat.websocket.AsyncChannelWrapperSecure$WrapperFuture.get(AsyncChannelWrapperSecure.java:508)\n\tat org.apache.tomcat.websocket.WsWebSocketContainer.connectToServer(WsWebSocketContainer.java:367)\n\t... 1 more\nCaused by: javax.net.ssl.SSLException: TODO\n\tat org.apache.tomcat.websocket.AsyncChannelWrapperSecure$WebSocketSslHandshakeThread.checkResult(AsyncChannelWrapperSecure.java:427)\n\tat org.apache.tomcat.websocket.AsyncChannelWrapperSecure$WebSocketSslHandshakeThread.run(AsyncChannelWrapperSecure.java:391)", "id": 195314, "time": "2016-12-01T12:08:46Z", "creator": "dpatel@amdocs.com", "creation_time": "2016-12-01T12:08:46Z", "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 60437, "text": "Please don't add developers individually, thanks.\nThat DUMMY buffer is 8KB. This is probably not right and it could be either sslEngine.getSession().getPacketBufferSize() or 16921. I don't see why dynamic resize would be needed.", "id": 195315, "time": "2016-12-01T13:08:40Z", "creator": "remm@apache.org", "creation_time": "2016-12-01T13:08:40Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "text": "Yes, resizing  to sslEngine.getSession().getPacketBufferSize() or 16921 would work, since socketReadBuffer is set similarly.", "attachment_id": null, "bug_id": 60437, "id": 195316, "time": "2016-12-01T13:12:38Z", "creator": "dpatel@amdocs.com", "creation_time": "2016-12-01T13:12:38Z", "is_private": false}, {"count": 3, "tags": [], "text": "I'll try the simplest solution first then, the default buffer size will be 16921. The change will be in 9M14, 8.5.9, 8.0.40 and 7.0.74.", "is_private": false, "bug_id": 60437, "id": 195320, "time": "2016-12-01T15:10:22Z", "creator": "remm@apache.org", "creation_time": "2016-12-01T15:10:22Z", "attachment_id": null}]