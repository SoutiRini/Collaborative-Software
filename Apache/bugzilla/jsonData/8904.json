[{"count": 0, "tags": [], "bug_id": 8904, "attachment_id": null, "id": 15708, "time": "2002-05-08T11:01:20Z", "creator": "foobar@web.de", "creation_time": "2002-05-08T11:01:20Z", "is_private": false, "text": "i compile the apache with\n\n./configure --enable-info --enable-vhost-alias --enable-so --enable-rewrite\n--with-mpm=perchild\n\napache i don't work with perchild-mpm ;(\n\ni use the default conf/httpd.conf\nonly change Listen from 80 to 8080 ;)\n\ncat logs/error_log\n...\n...\n[Wed May 08 12:55:09 2002] [emerg] (13)Permission denied: apr_proc_mutex_lock\nfailed. Attempting to shutdown process gracefully.\n[Wed May 08 12:55:09 2002] [emerg] (13)Permission denied: apr_proc_mutex_unlock\nfailed. Attempting to shutdown process gracefully.\n[Wed May 08 12:55:09 2002] [emerg] (13)Permission denied: apr_proc_mutex_lock\nfailed. Attempting to shutdown process gracefully.\n[Wed May 08 12:55:09 2002] [emerg] (13)Permission denied: apr_proc_mutex_unlock\nfailed. Attempting to shutdown process gracefully.\n...\n...\n\nany ideas ???"}, {"count": 1, "tags": [], "bug_id": 8904, "attachment_id": null, "id": 15709, "time": "2002-05-08T11:02:17Z", "creator": "foobar@web.de", "creation_time": "2002-05-08T11:02:17Z", "is_private": false, "text": "change Platform and OS, sorry ;)"}, {"count": 2, "tags": [], "bug_id": 8904, "attachment_id": null, "id": 15771, "time": "2002-05-09T06:16:21Z", "creator": "jwoolley@apache.org", "creation_time": "2002-05-09T06:16:21Z", "is_private": false, "text": "Do you get the same thing if you run it as non-root, just out of curiosity?  If \nnot, I'm 99% sure I know what the trouble is."}, {"count": 3, "tags": [], "bug_id": 8904, "attachment_id": null, "is_private": false, "id": 15900, "time": "2002-05-10T15:54:50Z", "creator": "foobar@web.de", "creation_time": "2002-05-10T15:54:50Z", "text": "chown -R testuser.testgroup /usr/local/apache2/*\nsu - testuser\n/usr/local/apache2/bin/apachectl start\n\nall httpd processes running under uid testuser\n\nchildperuserid directive don't work, all child's terminate by sig11\n\n???"}, {"count": 4, "text": "Cliff,\nI have the situation that you describe.\nWhen I run apache as a root I have those messages in error.log\nAnd if I run apache as a www-data user, the apache is working all right.\nBut all proccesses are, of course, owned by www-data.\nSo please feed my curiousity and tell me what the trouble is :)\n\nMy system is Linux Debian Potato, kernel 2.4.4\nApache 2.0.36, ./configure --enable-so --with-mpm=perchild", "bug_id": 8904, "attachment_id": null, "id": 16780, "time": "2002-05-27T17:43:13Z", "creator": "admin@3in1hosting.com", "creation_time": "2002-05-27T17:43:13Z", "tags": [], "is_private": false}, {"count": 5, "tags": [], "bug_id": 8904, "is_private": false, "text": "The problem when you run as root is that the mutex is created as root and the \npermissions don't get set right, so the child processes can't access the \nmutex.  We've seen the same problem in mod_ssl, mod_rewrite, etc.", "id": 16781, "time": "2002-05-27T18:00:20Z", "creator": "jwoolley@apache.org", "creation_time": "2002-05-27T18:00:20Z", "attachment_id": null}, {"count": 6, "tags": [], "creator": "foobar@web.de", "attachment_id": null, "is_private": false, "id": 16982, "time": "2002-05-31T07:33:54Z", "bug_id": 8904, "creation_time": "2002-05-31T07:33:54Z", "text": "exactly, that's it\n\napache run as root, create mutex with root-perm (0600) ...\nvirtual host assignd to user xxx = no aceccess to the mutex or shm-segment\n"}, {"count": 7, "tags": [], "bug_id": 8904, "is_private": false, "text": "This bug still exists in 2.0.39", "id": 18376, "time": "2002-06-22T10:23:21Z", "creator": "admin@3in1hosting.com", "creation_time": "2002-06-22T10:23:21Z", "attachment_id": null}, {"count": 8, "tags": [], "creator": "rbb@apache.org", "attachment_id": null, "is_private": false, "id": 18894, "time": "2002-07-02T21:53:28Z", "bug_id": 8904, "creation_time": "2002-07-02T21:53:28Z", "text": "Dup of 7921\n\n*** This bug has been marked as a duplicate of 7921 ***"}, {"count": 9, "tags": [], "bug_id": 8904, "attachment_id": null, "id": 34125, "time": "2003-03-30T12:53:41Z", "creator": "st.muehlebach@gmx.ch", "creation_time": "2003-03-30T12:53:41Z", "is_private": false, "text": "I found out an alternative solution to the 'permission denied' problem of 'perchild'-servers. The only restriction is, that ALL processes (the main process and the worker processes) must run unter the same GID ('nogroup' or '#-1' in this example).  a) Change in file srclib/apr/locks/unix/proc_mutex.c, line 217:    new_mutex->interproc->filedes = semget(IPC_PRIVATE, 1, IPC_CREAT | 0660);                                                                      ^^^^ b) When you start the server you must make sure that the GID of the calling shell is 'nogroup'. This can be done either with 'newgrp' or 'sg':    sg nogroup -c \"/usr/local/apache2/bin/httpd -k start\"  The main process starts under 'root':'nogroup', creates the semaphore and forks off several worker processes which may change their UID (but NOT their GID!).  I personally don't see any security problems caused by the 'all servers under same GID'-rule. "}]