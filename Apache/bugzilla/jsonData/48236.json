[{"count": 0, "tags": [], "bug_id": 48236, "text": "Since Revision 881774 of org/apache/tomcat/util/net/jsse/JSSESocketFactory.java\nSSL renegotiation can be disabled.\n\nThat is achieved by a HandshakeCompletedListener. The drawback is, that in the\nJSSE from SUN any HandshakeCompletedListener will be invoked by with an own \nthread. (See com.sun.net.ssl.internal.ssl.SSLSocketImpl or the fragment below)\n\nAnother way of disabling a SSL renegotiation is to set an empty cipher\nlist after the initial handshake:\n\norg.apache.tomcat.util.net.jsse.JSSESocketFactory\n...\n...\npublic void handshake(Socket sock) throws IOException {\n \n       ((SSLSocket)sock).startHandshake();\n         \n        if(!allowUnsafeLegacyRenegotiation) {\n            // disable all ciphers, avoiding any subsequent handshake \n            ((SSLSocket)sock).setEnabledCipherSuites(new String[0]);\n        }\n}\n\n\n\nRegards \nHartmut\n\n\n\ncom.sun.net.ssl.internal.ssl.SSLSocketImpl code fragment:\n\nif (handshaker.isDone()) {\n                        sess = handshaker.getSession();\n                        handshaker = null;\n                        connectionState = cs_DATA;\n\n                        //\n                        // Tell folk about handshake completion, but do\n                        // it in a separate thread.\n                        //\n                        if (handshakeListeners != null) {\n                            HandshakeCompletedEvent event =\n                                new HandshakeCompletedEvent(this, sess);\n\n                            Thread t = new NotifyHandshakeThread(\n                                handshakeListeners.entrySet(), event);\n                            t.start();\n                        }\n                    }", "id": 132135, "time": "2009-11-19T04:51:14Z", "creator": "hartmut.keil@gmx.ch", "creation_time": "2009-11-19T04:51:14Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 48236, "attachment_id": null, "text": "Thanks for the alternative suggestion. I'll do some testign and if all looks OK, change the way we disable the handshake.", "id": 132136, "time": "2009-11-19T05:44:36Z", "creator": "markt@apache.org", "creation_time": "2009-11-19T05:44:36Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 48236, "attachment_id": null, "id": 132149, "time": "2009-11-19T13:38:59Z", "creator": "markt@apache.org", "creation_time": "2009-11-19T13:38:59Z", "is_private": false, "text": "*** Bug 48158 has been marked as a duplicate of this bug. ***"}, {"count": 3, "tags": [], "text": "Testing has been positive. I ended up keeping the listener from the original patch to log the handshake attempts. I'm not so concerned about the logging being in a separate thread and it was the easiest (only?) way to hook into the client triggered handshakes.\n\nPatch to trunk will follow shortly.", "attachment_id": null, "id": 132150, "creator": "markt@apache.org", "time": "2009-11-19T13:41:24Z", "bug_id": 48236, "creation_time": "2009-11-19T13:41:24Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 48236, "text": "Are there any junit or rather httpclient/httpunit tests for this?\nOr at least a detailed test script (e.g. documented in a wiki)?\n\nLooking forward to the new patch.", "id": 132158, "time": "2009-11-19T22:00:46Z", "creator": "hauser@acm.org", "creation_time": "2009-11-19T22:00:46Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 48236, "text": "Nothing formal, and the nature of the tests is such it might take a little longer than usual to set up something with the Tomcat JUnit tests.\n\nMy testing uses a simple webapp that uses CLIENT-CERT and has one JSP that is protected by a security constraint.\n\nTo test client renegotiation, I use openssl s_client and the R command\nTo test server renegotiation, I use Firefox or IE and browse between the Tomcat homepage and the protected page.", "id": 132160, "time": "2009-11-20T01:48:50Z", "creator": "markt@apache.org", "creation_time": "2009-11-20T01:48:50Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 48236, "attachment_id": null, "id": 132221, "time": "2009-11-22T15:26:22Z", "creator": "markt@apache.org", "creation_time": "2009-11-22T15:26:22Z", "is_private": false, "text": "There is also org.apache.catalina.startup.TestTomcatSSL although a couple of tests are failing at the moment and I need to figure out why. I suspect it is because of some recent refactoring."}, {"count": 7, "tags": [], "bug_id": 48236, "attachment_id": null, "id": 133512, "creation_time": "2010-01-11T09:49:32Z", "time": "2010-01-11T09:49:32Z", "creator": "markt@apache.org", "text": "The alternative patch has been applied to 6.0.x and will be included in  6.0.21 onwards.", "is_private": false}, {"count": 8, "tags": [], "bug_id": 48236, "attachment_id": null, "text": "The new patch has been applied to 5.5.x and will be included in 5.5.29 onwards.", "id": 134041, "time": "2010-01-30T11:18:54Z", "creator": "markt@apache.org", "creation_time": "2010-01-30T11:18:54Z", "is_private": false}]