[{"count": 0, "tags": [], "bug_id": 61968, "attachment_id": null, "is_private": false, "id": 203109, "time": "2018-01-05T15:33:28Z", "creator": "yuri.kanivetsky@gmail.com", "creation_time": "2018-01-05T15:33:28Z", "text": "The following command fails:\n\n$ ab -n 1 localhost:8000/\n...\nBenchmarking localhost (be patient)...apr_socket_recv: Connection refused (111)\n\nBut this one succeeds:\n\n$ ab -n 1 127.0.0.1:8000/\n\nIn /etc/hosts I have:\n\n127.0.0.1   localhost.localdomain   localhost\n::1     localhost.localdomain   localhost\n\nThe issue here is caused by ab taking the first result returned by apr_sockaddr_info_get:\n\nhttps://github.com/apache/httpd/blob/2.4.29/support/ab.c#L1835-L1837\n\nBut apr_sockaddr_info_get returns a list. If it were to try the second sockaddr structure, it would connect. This way it works:\n\n\n    rv = apr_sockaddr_info_get(&sa, REMOTE_HOST, APR_UNSPEC, REMOTE_PORT, 0, mp);\n    if (rv != APR_SUCCESS) {\n        return rv;\n    }\n    \n    for ( ; sa; sa = sa->next) {\n        rv = apr_socket_create(&s, sa->family, SOCK_STREAM, APR_PROTO_TCP, mp);\n        if (rv != APR_SUCCESS) {\n            return rv;\n        }\n\n        apr_socket_opt_set(s, APR_SO_NONBLOCK, 1);\n        apr_socket_timeout_set(s, SOCK_TIMEOUT);\n\n        rv = apr_socket_connect(s, sa);\n        if (rv == ECONNREFUSED) {\n            continue;\n        } else if (rv == APR_SUCCESS) {\n            break;\n        } else {\n            return rv;\n        }\n    }\n\n    apr_socket_opt_set(s, APR_SO_NONBLOCK, 0);\n    apr_socket_timeout_set(s, SOCK_TIMEOUT);\n\n\nOther tools (like, curl, wget, w3m) deal with it just fine.\n\nP.S. A couple of links just in case\n\nhttps://gist.github.com/x-yuri/5ad28ac0a22ca19a7c3073ce0de5abf0\nhttps://gist.github.com/x-yuri/95fd4776fb9bf8f1eaae7eb2e7ed6bd4"}, {"count": 1, "tags": [], "bug_id": 61968, "attachment_id": null, "text": "apr_socket_{opt_set,timeout_set} are taken from this tutorial: http://dev.ariel-networks.com/apr/apr-tutorial/html/apr-tutorial-13.html", "id": 203110, "time": "2018-01-05T15:36:28Z", "creator": "yuri.kanivetsky@gmail.com", "creation_time": "2018-01-05T15:36:28Z", "is_private": false}]