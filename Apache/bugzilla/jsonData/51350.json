[{"count": 0, "attachment_id": null, "creator": "apache@tibit.com", "text": "When my web application returns a response with an empty body and Content-Type: text/plain or text/html, mod_deflate replaces the body with 20 bytes that can't be decompressed.  I'm guessing this is a gzip header created when trying to deflate 0 bytes of data.\n\nWireshark reports \"Error: Decompression Failed\" on those 20 bytes, and I believe some browsers choke on them as well.\n\nUnfortunately, since various web frameworks default to a text Content-Type for empty responses, this means the bad body is pretty common on things like OPTIONS responses.\n\nI have verified that the Content-Type header field triggers the problem by writing special-case code to intercept it on 0-byte responses.  Removing that header field or using an alternative type (e.g. 'application/json') makes the invalid 20-byte body disappear.\n\nI'm using a stock Ubuntu build of Apache.", "id": 147007, "time": "2011-06-09T20:42:22Z", "bug_id": 51350, "creation_time": "2011-06-09T20:42:22Z", "tags": [], "is_private": false}, {"count": 1, "attachment_id": null, "creator": "sf@sfritsch.de", "text": "For me (on trunk and 2.2.19), httpd sends \"Content-Length: 20\" but no body at all. Is that what you see or do you see those 20 bytes of body data?\n\nIn any case, fixed in trunk in r1146418.", "id": 147904, "time": "2011-07-13T20:39:24Z", "bug_id": 51350, "creation_time": "2011-07-13T20:39:24Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "creator": "sf@sfritsch.de", "text": "(In reply to comment #1)\n> For me (on trunk and 2.2.19), httpd sends \"Content-Length: 20\" but no body at\n> all. Is that what you see or do you see those 20 bytes of body data?\n\nNever mind. I just didn't look correctly.\n\nBut skipping compression for zero length files is a valid optimization, anyway.", "id": 147905, "time": "2011-07-13T21:11:37Z", "bug_id": 51350, "creation_time": "2011-07-13T21:11:37Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "text": "fixed in 2.4.1", "is_private": false, "id": 154251, "creator": "sf@sfritsch.de", "time": "2012-02-26T17:11:27Z", "bug_id": 51350, "creation_time": "2012-02-26T17:11:27Z", "attachment_id": null}, {"count": 4, "attachment_id": null, "bug_id": 51350, "text": "Still occurs.\n\nWhen apache returns a gzip compressed response with 204 response code and empty body server returns invalid header Content-Length: 20 instead of Content-Length: 0.\n\nWithout gzip compression (without Accept-Encoding header in request) server returns valid header Content-Length: 0.\n\nRequest and response with compression:\n\n0 % curl -v http://mta.dev/api/wtf/\\?id\\=09102 --compressed\n* Hostname was NOT found in DNS cache\n*   Trying 172.17.0.2...\n* Connected to mta.dev (172.17.0.2) port 80 (#0)\n> GET /api/wtf/?id=09102 HTTP/1.1\n> User-Agent: curl/7.38.0\n> Host: mta.dev\n> Accept: */*\n> Accept-Encoding: deflate, gzip\n> \n< HTTP/1.1 204 No Content\n< Date: Thu, 09 Jun 2016 15:44:53 GMT\n* Server Apache/2.4.7 (Ubuntu) is not blacklisted\n< Server: Apache/2.4.7 (Ubuntu)\n< X-Powered-By: PHP/5.5.9-1ubuntu4.17\n< P3P: policyref=\"/bitrix/p3p.xml\", CP=\"NON DSP COR CUR ADM DEV PSA PSD OUR UNR BUS UNI COM NAV INT DEM STA\"\n< X-Powered-CMS: Bitrix Site Manager (d04cd2b3dbab106e7537af3767043172)\n< Set-Cookie: PHPSESSID=8arlnd14t1k97bri56clb2qhh1; path=/; HttpOnly\n< Expires: Thu, 19 Nov 1981 08:52:00 GMT\n< Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0\n< Pragma: no-cache\n< Set-Cookie: BITRIX_SM_GUEST_ID=2328047; expires=Sun, 04-Jun-2017 15:44:53 GMT; Max-Age=31104000; path=/\n< Set-Cookie: BITRIX_SM_LAST_VISIT=09.06.2016+18%3A44%3A53; expires=Sun, 04-Jun-2017 15:44:53 GMT; Max-Age=31104000; path=/\n< Content-Encoding: gzip\n< Content-Length: 20\n< Content-Type: application/json\n< \n* Excess found in a non pipelined read: excess = 20 url = /api/wtf/?id=09102 (zero-length body)\n* Connection #0 to host mta.dev left intact\n\n\nRequest and response without compression:\n\n0 % curl -v http://mta.dev/api/wtf/\\?id\\=09102\n* Hostname was NOT found in DNS cache\n*   Trying 172.17.0.2...\n* Connected to mta.dev (172.17.0.2) port 80 (#0)\n> GET /api/wtf/?id=09102 HTTP/1.1\n> User-Agent: curl/7.38.0\n> Host: mta.dev\n> Accept: */*\n> \n< HTTP/1.1 204 No Content\n< Date: Thu, 09 Jun 2016 15:38:43 GMT\n* Server Apache/2.4.7 (Ubuntu) is not blacklisted\n< Server: Apache/2.4.7 (Ubuntu)\n< X-Powered-By: PHP/5.5.9-1ubuntu4.17\n< P3P: policyref=\"/bitrix/p3p.xml\", CP=\"NON DSP COR CUR ADM DEV PSA PSD OUR UNR BUS UNI COM NAV INT DEM STA\"\n< X-Powered-CMS: Bitrix Site Manager (d04cd2b3dbab106e7537af3767043172)\n< Set-Cookie: PHPSESSID=ceqsuv4ie3fkq497uvk6e2gki1; path=/; HttpOnly\n< Expires: Thu, 19 Nov 1981 08:52:00 GMT\n< Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0\n< Pragma: no-cache\n< Set-Cookie: BITRIX_SM_GUEST_ID=2328047; expires=Sun, 04-Jun-2017 15:38:43 GMT; Max-Age=31104000; path=/\n< Set-Cookie: BITRIX_SM_LAST_VISIT=09.06.2016+18%3A38%3A43; expires=Sun, 04-Jun-2017 15:38:43 GMT; Max-Age=31104000; path=/\n< Content-Length: 0\n< Content-Type: application/json\n< \n* Connection #0 to host mta.dev left intact\n\nApache version - 2.4.7", "id": 191521, "time": "2016-06-10T09:10:39Z", "creator": "dm.gres@gmail.com", "creation_time": "2016-06-10T09:10:39Z", "tags": [], "is_private": false}, {"count": 5, "attachment_id": null, "creator": "nickdnk@hotmail.com", "text": "I am observing this on 2.4.23 still\n\nAlso, I am wondering why we're returning a Content-Length header at all, when the HTTP spec says:\n\n\"A server MUST NOT send a Content-Length header field in any response\n   with a status code of 1xx (Informational) or 204 (No Content).\"", "id": 195114, "time": "2016-11-21T14:13:35Z", "bug_id": 51350, "creation_time": "2016-11-21T14:13:35Z", "tags": [], "is_private": false}, {"count": 6, "tags": [], "bug_id": 51350, "text": "(In reply to Dmitry Gres from comment #4)\n> Still occurs.\n> \n\nI think the reason the small response optimization doesn't work for some dynamic responses is that httpd only checks the length when the end of the stream is visible as soon as the response is first committed/flushed.\n\n(This does not apply to bailing on a 204 which is always known before the headers are flushed)\n\nI am assuming a simple CGI that flushes reproduces the issues w/ php.", "id": 195115, "time": "2016-11-21T14:32:56Z", "creator": "covener@gmail.com", "creation_time": "2016-11-21T14:32:56Z", "is_private": false, "attachment_id": null}, {"count": 7, "attachment_id": null, "bug_id": 51350, "text": "Does anybody have a simple repro that people can check to test this bug?", "id": 195221, "time": "2016-11-25T22:59:57Z", "creator": "toscano.luca@gmail.com", "creation_time": "2016-11-25T22:59:57Z", "tags": [], "is_private": false}, {"text": "For the moment the only pseudo weird thing that I was able to reproduce is:\n\ntest.php\n---------------------------\n<?php\nheader(\"HTTP/1.1 204 No Content\");\nflush();\nob_flush();\n?>\n--------------------------\n\ncurl localhost/test.php -i --compressed\nHTTP/1.1 204 No Content\nDate: Mon, 28 Nov 2016 19:43:10 GMT\nServer: Apache/2.5.0-dev (Unix)\nContent-Length: 0    <<============\nContent-Type: text/html; charset=UTF-8\n\nBut this one does not trigger any compression, mod_deflate (output filter) is not used as far as I can see. Still working on finding a repro for the 204 use case.", "tags": [], "bug_id": 51350, "is_private": false, "count": 8, "id": 195275, "time": "2016-11-28T19:45:35Z", "creator": "toscano.luca@gmail.com", "creation_time": "2016-11-28T19:45:35Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 51350, "is_private": false, "count": 9, "id": 195277, "time": "2016-11-28T22:12:28Z", "creator": "toscano.luca@gmail.com", "creation_time": "2016-11-28T22:12:28Z", "text": "The motivation for the C-L: 0 header is the following snippet of code in protocol.c:\n\n        if (!(r->header_only\n              && !r->bytes_sent\n              && (r->sent_bodyct\n                  || conf->http_cl_head_zero != AP_HTTP_CL_HEAD_ZERO_ENABLE\n                  || apr_table_get(r->headers_out, \"Content-Length\")))) {\n            ap_log_rerror(APLOG_MARK, APLOG_TRACE1, 0, r, \"Setting CLEN: %d\", r->bytes_sent);\n            ap_set_content_length(r, r->bytes_sent);\n        }"}, {"count": 10, "tags": [], "bug_id": 51350, "text": "(In reply to nickdnk from comment #5)\n> I am observing this on 2.4.23 still\n\nI got in touch with nickdnk@ and he'll follow up in this bugzilla ticket as soon as possible, but it seems that he is not able to reproduce the issue anymore.\n\n> Also, I am wondering why we're returning a Content-Length header at all,\n> when the HTTP spec says:\n> \n> \"A server MUST NOT send a Content-Length header field in any response\n>    with a status code of 1xx (Informational) or 204 (No Content).\"\n\nThis seems to be a bug (the only remaining one to discuss). I tried to bypass mod-proxy-fcgi with this simple Perl CGI:\n\n#!/usr/bin/perl\nprint \"Status: 204\\n\";\nprint \"Content-length: 1000\\n\";\nprint \"Content-type: text/html\\n\\n\";\nprint \"Hello, World.\";\n\nResponse with curl --compressed and without it:\n\nHTTP/1.1 204 No Content\nDate: Mon, 05 Dec 2016 11:51:33 GMT\nServer: Apache/2.5.0-dev (Unix)\nContent-length: 1000\nContent-Type: text/html\n\nIn this case I can get the C-L greater than zero emitted. The body is dropped by httpd as expected.", "id": 195359, "attachment_id": null, "creator": "toscano.luca@gmail.com", "creation_time": "2016-12-05T11:56:51Z", "time": "2016-12-05T11:56:51Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 51350, "text": "(In reply to Luca Toscano from comment #10)\n\n> In this case I can get the C-L greater than zero emitted. The body is\n> dropped by httpd as expected.\n\nThis seems to be true only if I use Curl, but telnet reveals another story. I am following up in the dev@ mailing list to find a permanent solution.", "count": 11, "id": 195377, "time": "2016-12-06T17:37:47Z", "creator": "toscano.luca@gmail.com", "creation_time": "2016-12-06T17:37:47Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 51350, "is_private": false, "text": "committed http://svn.apache.org/r1773346 to trunk", "id": 195422, "time": "2016-12-09T10:18:56Z", "creator": "toscano.luca@gmail.com", "creation_time": "2016-12-09T10:18:56Z", "attachment_id": null}, {"count": 13, "tags": [], "text": "I tried very hard to reproduce the Content-Length: 20 + Content-Encoding:gzip issue (mod_deflate compressing an empty body) for 204 responses (and others too) without any luck. I keep hitting, correctly, the following mod_deflate statues (LogLevel trace8 enabled):\n\n- \"Not compressing very small response of 0 bytes\"\n- \"Not compressing (no content)\"\n\nIf anybody has a way to easily repro the Content-Length: 20 please let us know :)", "is_private": false, "bug_id": 51350, "id": 195435, "time": "2016-12-10T10:54:30Z", "creator": "toscano.luca@gmail.com", "creation_time": "2016-12-10T10:54:30Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 51350, "is_private": false, "count": 14, "id": 195480, "time": "2016-12-13T20:13:55Z", "creator": "toscano.luca@gmail.com", "creation_time": "2016-12-13T20:13:55Z", "text": "The 204 message-body and C-L header drop change was merged in 2.4.x, it should be part of the next release (2.4.24 atm).\n\nThe solution is not addressing the mod_deflate issue, so please report any useful data that could lead to find the bug if you encounter it (CGI repro scripts, httpd config, error logs, etc..).\n\nThanks!"}, {"count": 15, "tags": [], "bug_id": 51350, "text": "Closing this bug as fixed (in 2.4.25+), please reopen if you are still seeing the problem.", "id": 196706, "attachment_id": null, "creator": "toscano.luca@gmail.com", "creation_time": "2017-02-04T12:37:32Z", "time": "2017-02-04T12:37:32Z", "is_private": false}]