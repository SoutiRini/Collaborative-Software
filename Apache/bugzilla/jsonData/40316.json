[{"count": 0, "attachment_id": null, "bug_id": 40316, "text": "hello\n\nWe are facing a problem that \"apachectl -k graceful\" causes segmentation faults \nwhen requests are processed, and these requests sometimes fail.\nCould you give us any idea to solve(avoid) this problem?\n(This problem is similar to Bug#: 39834)\n\nWe are using mod_jk 1.2.6(we tried 1.2.18 but has the same problem) with Apache \n2.0.58 in RHELv3.\nJkLogLevel is set to \"error\"(debug,info,warn also reproduce more frequent).\nIt may occur only when apache is writing to mod_jk.log, because it doesn't \noccur when \"JkLogFile\" configuration is commented our or when no requests are \nnot processed.\n\n\n- Reproduction steps\n 1. making a rush with 10 multiple users\n 2. # apachectl -k graceful\n\n\n- Configration of jk in httpd.conf\nLoadModule jk_module modules/mod_jk.so\n<IfModule mod_jk.c>\n        JkWorkersFile /opt/****/apache2/conf/workers.properties\n        JkLogFile /opt/****/apache2/logs/mod_jk.log\n        JkLogLevel error\n</IfModule>\n\n- error_log\n[Fri Aug 25 14:47:16 2006] [notice] Graceful restart requested, doing restart\nhttpd: Could not determine the server's fully qualified domain name, using 127.0\n.0.1 for ServerName\n[Fri Aug 25 14:47:16 2006] [notice] Apache configured -- resuming normal operati\nons\n[Fri Aug 25 14:47:16 2006] [error] (43)Identifier removed: apr_global_mutex_lock\n(jk_log_lock) failed\n[Fri Aug 25 14:47:17 2006] [notice] child pid 1867 exit signal Segmentation faul\nt (11)\n[Fri Aug 25 14:47:17 2006] [error] (43)Identifier removed: apr_global_mutex_lock\n(jk_log_lock) failed\n[Fri Aug 25 14:47:18 2006] [error] (43)Identifier removed: apr_global_mutex_lock\n(jk_log_lock) failed\n[Fri Aug 25 14:47:18 2006] [error] (43)Identifier removed: apr_global_mutex_lock\n(jk_log_lock) failed\n[Fri Aug 25 14:47:18 2006] [notice] child pid 1865 exit signal Segmentation faul\nt (11)\n[Fri Aug 25 14:47:18 2006] [notice] child pid 1866 exit signal Segmentation faul\nt (11)\n[Fri Aug 25 14:47:18 2006] [notice] child pid 1868 exit signal Segmentation faul\nt (11)                            \n\n\n- mod_jk.log\n[Fri Aug 25 14:47:16 2006]  [jk_ajp_common.c (1462)]: ERROR: Client connection a\nborted or network problems\n[Fri Aug 25 14:47:17 2006]  [jk_ajp_common.c (1462)]: ERROR: Client connection a\nborted or network problems\n[Fri Aug 25 14:47:18 2006]  [jk_ajp_common.c (1462)]: ERROR: Client connection a\nborted or network problems\n[Fri Aug 25 14:47:18 2006]  [jk_ajp_common.c (1462)]: ERROR: Client connection a\nborted or network problems", "id": 92522, "time": "2006-08-25T07:30:42Z", "creator": "y3-tanaka@nri.co.jp", "creation_time": "2006-08-25T07:30:42Z", "tags": [], "is_private": false}, {"text": "I have reproduced this problem with 1.2.15 by followings.\n\n1) set reply_timeout like 30(seconds)\n2) post a request that Tomcat will sleep longer time than reply_timeout by browser\n3) restart Apache with graceful option while Tomcat sleeping\n\nI read apache-2.0/mod_jk.c.\nIf graceful is called while mod_jk is processing, apr_global_mutex_unlock will fail.\nThen, ap_log_rerror will be called. But this method is typo.\nSo, Segmentation fault will occur around DSO.\n\nThis typo has been fixed at 1.2.16.", "tags": [], "creator": "kanekotky@yahoo.co.jp", "is_private": false, "count": 1, "id": 93591, "time": "2006-09-14T14:25:56Z", "bug_id": 40316, "creation_time": "2006-09-14T14:25:56Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 40316, "text": "Takayuki,\n\nThank you for your reply.\nI have also confirmed Segmentation Fault had been fixed with 1.2.18(1.2.16 is \nnot released).\n\n> Fri Aug 25 14:47:17 2006] [error] (43)Identifier removed: \napr_global_mutex_lock\n> (jk_log_lock) failed\n\nI am confusing if this is a bug, or specification.\nPlease teach me there is a problem for an application when this error is \noccured.\nIf there is a problem(if request fails), let me know how to avoid or solve it.\n\nthank you\n\n\n", "id": 93986, "time": "2006-09-22T06:13:36Z", "creator": "y3-tanaka@nri.co.jp", "creation_time": "2006-09-22T06:13:36Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 40316, "attachment_id": null, "is_private": false, "id": 93988, "time": "2006-09-22T07:43:18Z", "creator": "takayoshi@gmail.com", "creation_time": "2006-09-22T07:43:18Z", "text": "(In reply to comment #2)\n> I have also confirmed Segmentation Fault had been fixed with 1.2.18(1.2.16 is \n> not released).\n\nYour first post says it's still occurred with 1.2.18, which is correct?\nIs it reproducible with 1.2.18 ?"}, {"count": 4, "attachment_id": null, "bug_id": 40316, "text": "I'm sorry for confusing you.\n\n\"(jk_log_lock) failed\" error in error_log still occur with 1.2.18.\n\"Segmentation Fault\" error in mod_jk.log is solved with 1.2.18.\n\nBoth errors occur with 1.2.6.\n", "id": 93990, "time": "2006-09-22T08:46:19Z", "creator": "y3-tanaka@nri.co.jp", "creation_time": "2006-09-22T08:46:19Z", "tags": [], "is_private": false}, {"count": 5, "tags": [], "bug_id": 40316, "text": "Could any of the commenters please give some information, if one of the problems\nstill exists with 1.2.19 or the coming version 1.2.20?\n\nOtherwise we will close this case.\n", "id": 95970, "time": "2006-11-18T20:27:55Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2006-11-18T20:27:55Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 40316, "attachment_id": null, "text": "Hi everyone,\n\nI'm experiencing this issue on Solaris 10 with mod_jk 1.2.23 in Apache 2.0.53\nwith different log levels.\nUnfortunately I only have dbx available, whose output sometimes puzzles me a\nbit, but it looks like jk_log() itself triggers a second call of jk_log().\n\nt@1 (l@1) signal SEGV (no mapping at the fault address) in (unknown) at 0x820fe6c\n0x0820fe6c:     outl     (%dx)\nCurrent function is jk_log\n  581           l->log(l, level, buf);\n(dbx) where\ncurrent thread: t@1\n  [1] 0x820fe6c(0x0, 0x0, 0x0, 0x0), at 0x820fe6c\n=>[2] jk_log(l = 0x820fe58, file = 0x1 \"<bad address 0x1>\", line = 134497984,\nfuncname = 0x80466f8 \"\\xbe^F\", level = 1633643370, fmt = 0x62 \"<bad address\n0x62>\", ...), line 581 in \"jk_util.c\"\n  [3] jk_log(l = 0x820fe58, file = 0x81032e4 \"mod_jk.c\", line = 452, funcname =\n0x81032ac \"ws_write\", level = 1, fmt = 0x81032ed \"written %d out of %d\", ...),\nline 581 in \"jk_util.c\"\n  [4] ws_write(s = 0x8047900, b = 0x824598b, l = 1726U), line 452 in \"mod_jk.c\"\n  [5] ajp_process_callback(msg = 0x8224df4, pmsg = 0x8224e0c, ae = 0x8224dc0, r\n= 0x8047900, l = 0x8170a10), line 1447 in \"jk_ajp_common.c\"\n  [6] ajp_get_reply(e = 0x8226de8, s = 0x8047900, l = 0x8170a10, p = 0x8224dc0,\nop = 0x80467f0), line 1647 in \"jk_ajp_common.c\"\n  [7] ajp_service(e = 0x8226de8, s = 0x8047900, l = 0x8170a10, is_error =\n0x804688c), line 1828 in \"jk_ajp_common.c\"\n  [8] service(e = 0x8217d3c, s = 0x8047900, l = 0x8170a10, is_error =\n0x80479ec), line 1007 in \"jk_lb_worker.c\"\n  [9] jk_handler(r = 0x82379a8), line 2174 in \"mod_jk.c\"\n  [10] ap_run_handler(r = 0x82379a8), line 152 in \"config.c\"\n  [11] ap_invoke_handler(r = 0x82379a8), line 364 in \"config.c\"\n  [12] ap_process_request(r = 0x82379a8), line 249 in \"http_request.c\"\n  [13] ap_process_http_connection(c = 0x8231a68), line 253 in \"http_core.c\"\n  [14] ap_run_process_connection(c = 0x8231a68), line 43 in \"connection.c\"\n  [15] ap_process_connection(c = 0x8231a68, csd = 0x8231990), line 176 in\n\"connection.c\"\n  [16] child_main(child_num_arg = 36), line 610 in \"prefork.c\"\n  [17] make_child(s = 0x814b890, slot = 36), line 704 in \"prefork.c\"\n  [18] perform_idle_server_maintenance(p = 0x8146770), line 839 in \"prefork.c\"\n  [19] ap_mpm_run(_pconf = 0x8146770, plog = 0x817c848, s = 0x814b890), line\n1040 in \"prefork.c\"\n  [20] main(argc = 4, argv = 0x8047d88), line 623 in \"main.c\"\n(dbx) dump\nf = (nil)\nused = 0\nargs = (nil)\nbuf = \"\"\nrc = 24\nl = 0x820fe58\nusable_size = 8191\nfile = 0x1 \"<bad address 0x1>\"\nfmt = 0x62 \"<bad address 0x62>\"\nfuncname = 0x80466f8 \"\\xbe^F\"\nlevel = 1633643370\nline = 134497984\n(dbx) up\nCurrent function is jk_log\n  581           l->log(l, level, buf);\n(dbx) print buf\nbuf = \"[Wed Dec 12 13:04:44 2007] [15364:0000] [debug] ws_write::mod_jk.c (452):\nwritten 1726 out of 1726\"\n\nSunOS 5.10 Generic_118855-36 i86pc i386 i86pc\nApache/2.0.59 (Unix) mod_ssl/2.0.59 OpenSSL/0.9.8e mod_jk/1.2.23\n\nCheers, Daniel", "id": 111710, "time": "2007-12-12T08:25:58Z", "creator": "daniel@lbers.com", "creation_time": "2007-12-12T08:25:58Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 40316, "text": "Can you easily reproduce it?\n\nIf so: it would be very helpful, if you could compile and use the sources\navaiable at http://people.apache.org/~rjung/mod_jk-dev/\n\nThose are from a 1.2.26 development snapshot.\n", "id": 111713, "time": "2007-12-12T08:53:59Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2007-12-12T08:53:59Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 40316, "attachment_id": null, "is_private": false, "id": 111741, "time": "2007-12-13T03:28:59Z", "creator": "daniel@lbers.com", "creation_time": "2007-12-13T03:28:59Z", "text": "(In reply to comment #7)\n\nNo, unfortunately I haven't yet found out how to reproduce it. After reading the\nbug reports I was quite sure that it was caused by apachectl graceful, as the\nproblem only showed up when logadm had run. Executing logadm or manually issuing\napachectl graceful and/or truncating the log files doesn't trigger the error\nthough. This may even be a totally different issue to what the reporter described.\n\nI installed the dev snapshot and hope to see the error come up again soon."}, {"count": 9, "tags": [], "text": "(In reply to comment #8)\n\n> I installed the dev snapshot and hope to see the error come up again soon.\n\nThe error never occured again since. I tried to make sure that no changes were\nintroduced in the compile process, so I guess the problem was already fixed by\nanother code change.", "attachment_id": null, "id": 112571, "creator": "daniel@lbers.com", "time": "2008-01-07T02:51:50Z", "bug_id": 40316, "creation_time": "2008-01-07T02:51:50Z", "is_private": false}, {"count": 10, "attachment_id": null, "bug_id": 40316, "is_private": false, "id": 112572, "time": "2008-01-07T03:53:02Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2008-01-07T03:53:02Z", "tags": [], "text": "Closing now, since at the moment we have no more observations of this for recent\nversions."}]