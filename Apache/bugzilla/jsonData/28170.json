[{"count": 0, "tags": [], "bug_id": 28170, "attachment_id": null, "is_private": false, "id": 55186, "time": "2004-04-02T20:41:54Z", "creator": "dfisher@jmlafferty.com", "creation_time": "2004-04-02T20:41:54Z", "text": "Here is the situation.\n\nWe have been reading PDF content through a JSP using Tomcat 4.0.3 for a couple of years. No real \nproblems until I upgraded our website to Tomcat 4.1.30. After that users of Windows IE (5.01, 5.5, 6.0) \nand Acrobat Reader 6.0.1 (but not Reader 6.0) started having trouble displaying the PDF in the browser \nwindow.\n\nI am including two files in my test case. The PDF (sample.pdf) which works fine when accessed directly \nand a cut down version of my open pdf jsp (badpdf.jsp)\n\nI looked at bugid=24970, but the patch to Response.class is already in 4.1.30.\n\nThanks!"}, {"count": 1, "tags": [], "bug_id": 28170, "attachment_id": 11107, "id": 55187, "time": "2004-04-02T20:44:53Z", "creator": "dfisher@jmlafferty.com", "creation_time": "2004-04-02T20:44:53Z", "is_private": false, "text": "Created attachment 11107\nTest Case for Bug"}, {"count": 2, "tags": [], "bug_id": 28170, "attachment_id": null, "id": 55188, "time": "2004-04-02T20:53:09Z", "creator": "remm@apache.org", "creation_time": "2004-04-02T20:53:09Z", "is_private": false, "text": "This is actually normal. JSP is textual data, so a charset will be sent to the\nclient. Acrobat is broken and doesn't like that (and this is the end of the\nstory). You should either:\n- use a servlet to generate the PDF (this seems a better match)\n- hack Jasper a little bit"}, {"count": 3, "tags": [], "creator": "dfisher@jmlafferty.com", "attachment_id": null, "id": 55190, "time": "2004-04-02T21:09:42Z", "bug_id": 28170, "creation_time": "2004-04-02T21:09:42Z", "is_private": false, "text": "I read  this supposedly fixed bug 24970: charset appended to content-type even if not text/*\n\nDo you care to comment on this? This is the problem. Some comment about how you guys fixed the \nextra characters for images (but not application mimetypes?) I have not generated any text up to that \npoint in my jsp and would have thought that setting the content type would cause your connectors to \nbehave appropriately.\n\nIf I am not following the standards then please point me to the document that proves it. I \"thought\" that \nTomcat was a Reference Implementation.\n\nAlso my test case works with everyone else and I know that MS IE is a bad actor with its 2X or 3X \nrequest mimetype snooping, but you guys certainly have had to deal with that for years."}, {"count": 4, "tags": [], "bug_id": 28170, "attachment_id": null, "text": "Well, it's what I said. Bug 24970 is about the connector always setting the\ncharset every time.\nOTOH, JSPs, since they are text, always append the charset in the application\nlayer (here, it's the default HTTP encoding).", "id": 55193, "time": "2004-04-02T21:13:53Z", "creator": "remm@apache.org", "creation_time": "2004-04-02T21:13:53Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 28170, "text": "I'll get back yo you if the servlet doesn't work, but I'd hate to have my developers change things if it \nwon't.\n\nRegards,\nDave", "id": 55194, "time": "2004-04-02T21:16:18Z", "creator": "dfisher@jmlafferty.com", "creation_time": "2004-04-02T21:16:18Z", "is_private": false, "attachment_id": null}, {"count": 6, "text": "Write a trivial servlet to test, without the actual PDF body generation to test\nit (and use a telnet to see the headers).", "bug_id": 28170, "attachment_id": null, "id": 55196, "time": "2004-04-02T21:22:53Z", "creator": "remm@apache.org", "creation_time": "2004-04-02T21:22:53Z", "tags": [], "is_private": false}, {"count": 7, "attachment_id": null, "creator": "jessh@ptc.com", "text": "In other words, there is a bug/gap/\"feature\" in the JSP spec itself that one\nreally cannot return anything but text of some variety or another from a JSP page.\n\nEssentially prior to filters you had to use a servlet for anything other than\ntext -- including images, PDFs (which really should not be treated as text for\nvarious reasons), etc.  Even with filters you JSP page must pass something to\nthe filter which is not the end-binary response whereupon the filter produces\nthe binary responses -- which is not always convenient...\n\nThis is unfortunate (and something I debated with the spec authors -- especially\nsince no filters existed at the time), but essentially the notions of having to\neither require any non-text page authors to strictly watch out for or\n\"auto-discard\" whitespace produced by JSP source formatting, etc, were both\nconsidered untenable.\n\nAt this point, I have to agree the spec authors to *some* degree, though it\nwould still be nice to just use the familiar JSP page mechanism for binary\noutput as well, e.g. by setting the page to \"binary\" prior to the output writer\nbeing flushed and then being able to get a hold of the output *stream* instead\nof writer.\n\nAnyway, to make a long story short -- you'll have deal with the spec implications.", "id": 55198, "time": "2004-04-02T21:37:59Z", "bug_id": 28170, "creation_time": "2004-04-02T21:37:59Z", "tags": [], "is_private": false}, {"count": 8, "tags": [], "bug_id": 28170, "attachment_id": null, "is_private": false, "id": 55205, "time": "2004-04-02T23:27:01Z", "creator": "dfisher@jmlafferty.com", "creation_time": "2004-04-02T23:27:01Z", "text": "Thanks, I did the telnet trick to see everything:\n\nGET /badpdf.jsp HTTP/1.0\n\nReturns:\nHTTP/1.1 200 OK\nSet-Cookie: JSESSIONID=FACB1957A5D101E32866F2466D16D929; Path=/\nContent-disposition: inline; filename=sample.pdf\nContent-Type: application/pdf;charset=ISO-8859-1\nContent-Length: 32111\nDate: Fri, 02 Apr 2004 23:08:46 GMT\nServer: Apache-Coyote/1.1\nConnection: close\n\nWhile \nGET /sample.pdf HTTP/1.0\n\nReturns:\nHTTP/1.1 200 OK\nETag: W/\"32111-1080931122000\"\nLast-Modified: Fri, 02 Apr 2004 18:38:42 GMT\nContent-Type: application/pdf\nContent-Length: 32111\nDate: Fri, 02 Apr 2004 23:11:06 GMT\nServer: Apache-Coyote/1.1\nConnection: close\n\nSo it looks like servlet time.\n\nAbout PDFs as Text - As someone who beta tested Acrobat 1.0 and has followed it ever since \nalthough not as closely since 4.0. Done all kinds of things like Java applets launched from a 3.0 \nplugin, etc. - Since PDF-1.2 (or so) and linearized/zipped content streams PDFs are no longer 7-\nbit ASCII. So, I can see where a character set choice might confuse any of the applications \nupstream of the web server!\n\nAlso, Jess's point about worrying about linefeeds is something I'm always checking - particularly \nthe one(s) which easily can get tacked on after the last %> - PDFs (unless linearized) need the end \nof the file to find everything - all the objects are found from the end.\n\nHere we are the little guys and upstream we have Sun, MSFT and Adobe doing what they will.\n\nPeace."}, {"count": 9, "tags": [], "bug_id": 28170, "text": "Thanks guys.\n\nThe servlet checks out:\n\nGET /sample.pdf HTTP/1.0\n\nHTTP/1.1 200 OK\nLast-Modified: Fri, 02 Apr 2004 18:38:42 GMT\nContent-disposition: inline; filename=sample.pdf\nContent-Type: application/pdf\nContent-Length: 32111\nDate: Mon, 05 Apr 2004 14:28:36 GMT\nServer: Apache-Coyote/1.1\nConnection: close\n\nI can understand all the motivations behind all of this. Ours is that JSPs are a lot more convenient to \ndevelop than servlets, but so it goes.\n\nPeace,\nDave", "id": 55321, "time": "2004-04-05T14:31:48Z", "creator": "dfisher@jmlafferty.com", "creation_time": "2004-04-05T14:31:48Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 28170, "attachment_id": 11139, "id": 55342, "time": "2004-04-05T18:30:35Z", "creator": "dfisher@jmlafferty.com", "creation_time": "2004-04-05T18:30:35Z", "is_private": false, "text": "Created attachment 11139\nWEB-INF directory for PDF serving servlet test"}, {"count": 11, "tags": [], "bug_id": 28170, "is_private": false, "text": "We serve our PDFs with a servlet which had worked for a long time with all \nTomcat4 versions and Acrobat versions 4/5 and also Acrobat 6.0.0 but not Tomcat \n4.1.29 and Acrobat 6.0.1.\n\nWith Tomcat 4.1.30 it works again.\n\nThis report is only valid for IE of course (tested only with IE6).", "id": 56791, "time": "2004-05-04T10:32:52Z", "creator": "docware@hotmail.com", "creation_time": "2004-05-04T10:32:52Z", "attachment_id": null}]