[{"count": 0, "tags": [], "text": "Created attachment 32162\nError when opening exported xlsm file\n\nHi,\n\nI am using poi3.11beta2 version to write a macro enabled .xlsm file.There is no error/exception during writing the  while. After successful exception when I try to open the exported xlsm file It is is giving below error.\n\nIt was working fine with poi3.9 version.The issue is occurring after upgrading it to poi3.11beta2 version.\n\nThanks in advance.\n\nRegards,\nRanjay Mishra", "attachment_id": 32162, "bug_id": 57162, "id": 178817, "time": "2014-10-29T10:15:20Z", "creator": "rmishra@ptc.com", "creation_time": "2014-10-29T10:15:20Z", "is_private": false}, {"count": 1, "tags": [], "text": "How do the files differ when written from the two versions of POI?", "attachment_id": null, "bug_id": 57162, "id": 178818, "time": "2014-10-29T10:31:37Z", "creator": "apache@gagravarr.org", "creation_time": "2014-10-29T10:31:37Z", "is_private": false}, {"count": 2, "attachment_id": null, "bug_id": 57162, "text": "There is no changes in file. Using the same xlsm file in both the cases  and  code is also same.Here is the xlsm  related code for  creating workbook.\n\nString filePath=\"c:\\\\test\\\\bomTableTemplate.xlsm\"\nOPCPackage pkg = OPCPackage.open(new File(filePath));\nXSSFWorkbook wbTemplate = new XSSFWorkbook(pkg);\n\t\t\t\t\t\t\t\t\nSXSSFWorkbook sxWb = new SXSSFWorkbook(wbTemplate);\nsxWb.setCompressTempFiles(true);\nWorkbook wb=sxWb;\n\nNote: there is no issue with xls and xlsx file export.", "id": 178819, "time": "2014-10-29T10:55:16Z", "creator": "rmishra@ptc.com", "creation_time": "2014-10-29T10:55:16Z", "tags": [], "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 57162, "is_private": false, "count": 3, "id": 178820, "time": "2014-10-29T11:02:11Z", "creator": "apache@gagravarr.org", "creation_time": "2014-10-29T11:02:11Z", "text": "There clearly is a difference in the written files, otherwise Excel wouldn't have started complaining!\n\nYou'll need to unzip the two .xlsx files, and compare files present and the xml in them"}, {"count": 4, "tags": [], "bug_id": 57162, "attachment_id": 32166, "text": "Created attachment 32166\n[Content_type].xml of not working xlsm file", "id": 178844, "time": "2014-10-30T10:12:51Z", "creator": "rmishra@ptc.com", "creation_time": "2014-10-30T10:12:51Z", "is_private": false}, {"count": 5, "tags": [], "creator": "rmishra@ptc.com", "text": "Created attachment 32167\n[Content_type].xml of  working xlsm file", "id": 178845, "time": "2014-10-30T10:13:25Z", "bug_id": 57162, "creation_time": "2014-10-30T10:13:25Z", "is_private": false, "attachment_id": 32167}, {"count": 6, "tags": [], "creator": "rmishra@ptc.com", "attachment_id": null, "is_private": false, "id": 178846, "time": "2014-10-30T10:16:26Z", "bug_id": 57162, "creation_time": "2014-10-30T10:16:26Z", "text": "Hi Nick,\nI compared both working and not working xlsm file and found that contents are same , workbook.xml is same.\n\nOnly different I saw if [Content_Type].xml\nI have attached both the content type. Could you please have a look and let me know what  making  content_type.xml to be different and the solution for the same.\n\nThanks, \nRanjay Mishra"}, {"count": 7, "tags": [], "creator": "kiwiwings@apache.org", "attachment_id": null, "id": 178876, "time": "2014-10-31T21:42:53Z", "bug_id": 57162, "creation_time": "2014-10-31T21:42:53Z", "is_private": false, "text": "I can't reproduce it with the trunk, an arbitrary .xlsx and your sample code.\nPlease add your .xlsx and the exact code.\nI guess this happens because of the marshalling changes in StreamHelper.saveXmlInStream."}, {"count": 8, "tags": [], "text": "Created attachment 32178\nSample xlsm file", "attachment_id": 32178, "bug_id": 57162, "id": 178893, "time": "2014-11-02T13:04:40Z", "creator": "rmishra@ptc.com", "creation_time": "2014-11-02T13:04:40Z", "is_private": false}, {"count": 9, "tags": [], "creator": "rmishra@ptc.com", "attachment_id": null, "id": 178894, "time": "2014-11-02T13:15:58Z", "bug_id": 57162, "creation_time": "2014-11-02T13:15:58Z", "is_private": false, "text": "Hi,\nI have attached sample xlsm file(before export). Please see below  for exact code.\nThe same piece of code is working if I use only below 4  jars  along with jre1.7\npoi.jar, poi-ooxml.jar, poi-ooxlm-schema.jar and  xmlbean2.6.0.jar for standalone project.\n\nBut when I use the same code with all above 4 jars along with other jar in build path which ever was earlier , then it stop working.\nAfter  comparing the generated xlsm file I found content-type is corrupt.\n\nPlease note that same xlsm file , same code was working with same jars in build path  with poi3.9. \n\nIf this is  happens because of the marshalling changes in StreamHelper.saveXmlInStream could you please let me know the work around or fix for that. I am also attaching the generated xlsm file(the corrupt file).\n\nCODE Used\n----------\n\n Workbook wb;\n OPCPackage pkg = OPCPackage.open(\"D:\\\\Users\\\\rmishra\\\\Desktop\\\\sample_template.xlsm\");\n XSSFWorkbook workbook=new XSSFWorkbook(pkg);\n SXSSFWorkbook sxWb = new SXSSFWorkbook(workbook);\n sxWb.setCompressTempFiles(false);\n FileOutputStream out = new FileOutputStream(\"D:\\\\DescribeLink\\\\sample_template.xlsm\");\n wb = sxWb;\n sxWb.write(out);\n out.close();"}, {"count": 10, "attachment_id": 32179, "creator": "rmishra@ptc.com", "is_private": false, "id": 178895, "time": "2014-11-02T13:17:38Z", "bug_id": 57162, "creation_time": "2014-11-02T13:17:38Z", "tags": [], "text": "Created attachment 32179\nExported xlsm file , which is not working"}, {"count": 11, "attachment_id": null, "bug_id": 57162, "is_private": false, "id": 178896, "time": "2014-11-02T15:11:47Z", "creator": "uwe@thetaphi.de", "creation_time": "2014-11-02T15:11:47Z", "tags": [], "text": "> I guess this happens because of the marshalling changes in StreamHelper.saveXmlInStream.\n\nI don't think this is the case. The difference in the Content-Types files is caused by a broken namespace in the elements contained in the root element. The DOM tree that is serialized is missing the correct namespace, so it get overwritten with \"\" (empty namespace).\n\nIt looks like the code that creates the DOM tree for the content-types file is missing to attach the correct namespace to some elements.\n\nCould it be that this is fixed already in trunk?"}, {"count": 12, "attachment_id": 32180, "bug_id": 57162, "is_private": false, "id": 178897, "time": "2014-11-02T15:36:40Z", "creator": "uwe@thetaphi.de", "creation_time": "2014-11-02T15:36:40Z", "tags": [], "text": "Created attachment 32180\nPatch that fixes (hoepfully) all missing namespaces\n\nThis patch should fix the problem with the ContentTypes file. I also found another problem with relationships.\n\nThe main issue was: The parant element was correctly created with createElementNS(), but the childs where created without namespace using createElement().\n\nI fixed this, can somebody verify this (I have no time at the moment).\n\nIf POI would use the forbidden-apis Maven/ant plugin, we could forbid to use createElement (without * NS). I will later look into the remaining code of OOXML to find other violations (just search for calls to Document#createElement)."}, {"count": 13, "tags": [], "bug_id": 57162, "is_private": false, "text": "This was caused by #56814. Unfortunately, no test is failing because of this (the reason for this is that POI can read the file also with wrong namespaces, because the parser is very lenient...).", "id": 178898, "time": "2014-11-02T15:46:00Z", "creator": "uwe@thetaphi.de", "creation_time": "2014-11-02T15:46:00Z", "attachment_id": null}, {"count": 14, "tags": [], "text": "I verified, the relationships file \".rels\" was also broken in your provided file. So the issue that is fixed by my patch is also fixed there.\n\nCan you apply the patch to the source package of POI, compile the JARs and try again?\n\nUwe", "attachment_id": null, "bug_id": 57162, "id": 178899, "time": "2014-11-02T16:59:42Z", "creator": "uwe@thetaphi.de", "creation_time": "2014-11-02T16:59:42Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "uwe@thetaphi.de", "text": "I verified the example, works now. I checked Content_Types.xml and .rels file, both have correct namespaces (and same content as provided file).\n\nSo I think the attached patch fixes the bug. I will commit it later today.", "count": 15, "id": 178900, "time": "2014-11-02T17:13:43Z", "bug_id": 57162, "creation_time": "2014-11-02T17:13:43Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 57162, "is_private": false, "text": "File also opens with Excel after applying the fix.", "id": 178901, "time": "2014-11-02T17:15:06Z", "creator": "uwe@thetaphi.de", "creation_time": "2014-11-02T17:15:06Z", "attachment_id": null}, {"count": 17, "tags": [], "creator": "uwe@thetaphi.de", "attachment_id": null, "id": 178905, "time": "2014-11-02T20:57:05Z", "bug_id": 57162, "creation_time": "2014-11-02T20:57:05Z", "is_private": false, "text": "I fixed this in http://svn.apache.org/r1636188\n\nIf you want to try out the fix, you may use a nightly snapshot, once it is built: https://builds.apache.org/job/POI/lastSuccessfulBuild/artifact/build/dist/"}, {"count": 18, "attachment_id": null, "creator": "rmishra@ptc.com", "is_private": false, "id": 178906, "time": "2014-11-03T05:59:02Z", "bug_id": 57162, "creation_time": "2014-11-03T05:59:02Z", "tags": [], "text": "Thanks a lot!! I verifier with the latest jar distribution.\nIssue is resolved now."}]