[{"count": 0, "tags": [], "text": "I have two identical servers (2 cpus, pIII @ 1000MHz, 1 GB each) running SuSE \nLinux 9.1 (kernel 2.4) with 2.0.52 apache installed and php 4.3.11 (apache \nmodule).\nThe computers are used as web servers with no other software running (like \ndatabase servers, etc). At rush hour the two machines serve about 300,000 \nrequests both (the load is balanced equally).\nAt rush hour the load average of each computer reaches a maximum of 0.5-0.6.\nAr random time one of the two computers stops serving pages, all opened httpd \nprocesses are busy (running) trying to consume cpu. The load average increases \nquickly and in few seconds it approaches the number of the maximum server \nprocesses (500 processes). At this conditions the machine responds very \nslowly, you can hardly type commands in the shell, and no respond at all to \nweb requests. When this happens I reboot the computer and everything is coming \nback to normal.\nI checked the logs both apache's and system's but there is nothing suspicious, \njust normal messages ending at the time of the stuck.\nThis can happen at any time, and at any of the two computers. It has occur \nafter a few hours of uptime or after 20 days since the last reboot. Anyway, as \nan average we can accept that it happens once in a week.\nI discussed this in the apache web server user's forums and many people said \nthat have the same problem, even when using apache without any modules (like \nphp). The do not have a decent explanation and the only thing they suggest is \nto downgrade to apache 1.3 (where the problem exists no more).\nI looked at the changelog of 2.0.53 but I can't see something relevant.\nThe symptoms make me think that all of the httpd processes fall into an cpu \nconsuming infinite-loop.", "is_private": false, "bug_id": 34221, "id": 72962, "time": "2005-03-29T14:03:00Z", "creator": "gtsakiris@dolnet.gr", "creation_time": "2005-03-29T14:03:00Z", "attachment_id": null}, {"count": 1, "tags": [], "text": "To diagnose this further you need to get a backtrace out of one of the httpd\nprocesses which is consuming CPU, by picking a pid (e.g. out of top) and running:\n\n  $ gdb /path/to/httpd <pid>\n\nthen enter \"backtrace\" at the gdb prompt; then attach the output to this bug report.\n", "attachment_id": null, "id": 72963, "creator": "jorton@redhat.com", "time": "2005-03-29T14:08:12Z", "bug_id": 34221, "creation_time": "2005-03-29T14:08:12Z", "is_private": false}, {"count": 2, "tags": [], "text": "Ping. Looking for feedback from the reporter.", "is_private": false, "id": 73360, "creator": "chip@force-elite.com", "time": "2005-04-06T22:59:59Z", "bug_id": 34221, "creation_time": "2005-04-06T22:59:59Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 34221, "is_private": false, "text": "This is the output from the backtrace, I was this helps.\n\n\n(gdb) backtrace\n#0  0x4023ab36 in poll () from /lib/i686/libc.so.6\n#1  0x4008f4c4 in apr_poll (aprset=0xbffff880, num=1, nsds=0xbffff87c, \ntimeout=10000) at poll.c:129\n#2  0x4008fb9f in apr_wait_for_io_or_timeout (f=0x2710, s=0x1, for_read=1) at \nwaitio.c:53\n#3  0x40085831 in apr_socket_recv (sock=0x81eb1a8, \n    buf=0x82386a0 \"GET /assets/diakopes_st_winter_prosfores.gif HTTP/1.1\n\\r\\nAccept: */*\\r\\nReferer: http://ads.in.gr/custom/topbanners.php\\r\\nAccept-\nLanguage: el\\r\\nAccept-Encoding: gzip, deflate\\r\\nUser-Agent: Mozilla/4.0 \n(compa\"..., \n    len=0xbffff958) at sendrecv.c:86\n#4  0x4001f65e in socket_bucket_read (a=0x81ed450, str=0xbffff954, \nlen=0xbffff958, block=APR_BLOCK_READ)\n    at apr_buckets_socket.c:35\n#5  0x40020275 in apr_brigade_split_line (bbOut=0x81f3f30, bbIn=0x81eb630, \nblock=APR_BLOCK_READ, maxbytes=8192)\n    at apr_brigade.c:288\n#6  0x080920b8 in core_input_filter (f=0x81eb5f8, b=0x81f3f30, \nmode=AP_MODE_GETLINE, block=APR_BLOCK_READ, readbytes=0)\n    at core.c:3741\n#7  0x0808a92a in ap_get_brigade (next=0x2710, bb=0x81f3f30, \nmode=AP_MODE_GETLINE, block=APR_BLOCK_READ, readbytes=0)\n    at util_filter.c:474\n#8  0x0808a92a in ap_get_brigade (next=0x2710, bb=0x81f3f30, \nmode=AP_MODE_GETLINE, block=APR_BLOCK_READ, readbytes=0)\n    at util_filter.c:474\n#9  0x0808b87a in ap_rgetline_core (s=0x81f32b8, n=8192, read=0xbffffaac, \nr=0x81f32a0, fold=0, bb=0x81f3f30)\n    at protocol.c:214\n#10 0x0808bdde in read_request_line (r=0x81f32a0, bb=0x81f3f30) at \nprotocol.c:592\n#11 0x0808c4ca in ap_read_request (conn=0x81eb280) at protocol.c:886\n#12 0x0806916a in ap_process_http_connection (c=0x81eb280) at http_core.c:268\n#13 0x0808860b in ap_run_process_connection (c=0x81eb280) at connection.c:42\n#14 0x0807d31d in child_main (child_num_arg=-4) at prefork.c:609\n#15 0x0807d461 in make_child (s=0x80f6808, slot=252) at prefork.c:703\n#16 0x0807d65c in perform_idle_server_maintenance (p=0x80b9ff0) at \nprefork.c:838\n#17 0x0807db73 in ap_mpm_run (_pconf=0x120, plog=0x80f20d0, s=0x0) at \nprefork.c:1039\n#18 0x08082fba in main (argc=3, argv=0xbffffd84) at main.c:617\n\n", "id": 73403, "time": "2005-04-07T17:17:43Z", "creator": "gtsakiris@dolnet.gr", "creation_time": "2005-04-07T17:17:43Z", "attachment_id": null}, {"count": 4, "tags": [], "text": "If all the HTTPD Processes are waiting in Poll, it sounds like a Denial of\nService Attack that is sending requests very slowly.", "is_private": false, "id": 75824, "creator": "chip@force-elite.com", "time": "2005-06-02T23:46:24Z", "bug_id": 34221, "creation_time": "2005-06-02T23:46:24Z", "attachment_id": null}, {"count": 5, "tags": [], "text": "Probable DoS attack.", "attachment_id": null, "id": 83443, "creator": "slive@apache.org", "time": "2005-12-08T19:50:11Z", "bug_id": 34221, "creation_time": "2005-12-08T19:50:11Z", "is_private": false}]