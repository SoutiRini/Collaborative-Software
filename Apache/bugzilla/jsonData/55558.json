[{"count": 0, "tags": [], "bug_id": 55558, "is_private": false, "text": "Created attachment 30840\nDo not pass empty brigades to output filters in mod_proxy_fcgi.\n\nOK...this one took me forever to track down. We are using mod_proxy_fcgi to proxy to Wordpress instances processed via php-fpm. There are certain pages on three of our sites that return gzip-encoded data without a Content-Encoding header. I hadn't been able to track down the issue, so I just disabled gzip for those URLs. On the new site we are setting up now, almost every URL on the site was displaying this behavior. After spending much time stepping through the code in gdb, I finally found the issue:\n\nIf the first fcgi response (STDOUT) stream record contains all of the headers and ONLY the headers (no response data), the call to ap_scan_script_header_err_brigade_ex() on lines 744-745 empties the brigade. The subsequent call to ap_pass_brigade() on line 775 passes an empty brigade to the output filters. When mod_deflate receives an empty brigade, it skips processing, so the Vary and Content-Encoding headers are not set, and the existing headers are passed through in the response.\n\nWhen subsequent fcgi response stream records are received, the brigades are not empty, and are properly passed to the output filters. Mod_deflate processes/compresses the brigades, and the Vary and Content-Encoding headers are set in r->headers_out; however, the headers have already been buffered or sent down the line, so the client does not see them.\n\nThe result is that the client receives a gzip-encoded response without the necessary Content-Encoding header set.\n\nThe extremely simple attached patch simply bypasses the ap_pass_brigade() call on the first stream record if the output brigade has been emptied by ap_scan_script_header_err_brigade_ex(). Apparently this is a fairly common occurrence...at least with php-fpm.", "id": 170103, "time": "2013-09-14T20:03:22Z", "creator": "jim@riggs.me", "creation_time": "2013-09-14T20:03:22Z", "attachment_id": 30840}, {"count": 1, "tags": [], "bug_id": 55558, "text": "Committed to trunk as r1585824...  Thanks!", "id": 174380, "time": "2014-04-08T20:07:44Z", "creator": "trawick@apache.org", "creation_time": "2014-04-08T20:07:44Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 55558, "attachment_id": null, "is_private": false, "id": 174381, "time": "2014-04-08T20:15:37Z", "creator": "trawick@apache.org", "creation_time": "2014-04-08T20:15:37Z", "text": "proposed for backport to 2.4.x branch..."}, {"count": 3, "tags": [], "bug_id": 55558, "text": "This was released in 2.4.10.", "id": 179533, "time": "2014-12-05T12:24:07Z", "creator": "trawick@apache.org", "creation_time": "2014-12-05T12:24:07Z", "is_private": false, "attachment_id": null}]