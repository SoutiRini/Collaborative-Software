[{"count": 0, "tags": [], "bug_id": 44606, "attachment_id": 21666, "is_private": false, "id": 114629, "time": "2008-03-14T08:49:45Z", "creator": "antonio.chirizzi@gmail.com", "creation_time": "2008-03-14T08:49:45Z", "text": "Created attachment 21666\nThe java file to compile, and the xls file. Run the java file using the xls file as argument to get the error.\n\nHello,\n\nPOI Version: poi-3.0.2-FINAL, jdk1.6.0_05\nRun by: java -classpath poi-scratchpad-3.0.2-FINAL-20080204.jar;poi-3.0.2-FINAL-20080204.jar;.  MyExample\nError: Exception in thread \"main\" java.lang.ClassCastException: org.apache.poi.hssf.record.aggregates.FormulaRecordAggregate cannot be cast to org.apache.poi.hssf.record.LabelSSTRecord\n        at org.apache.poi.hssf.usermodel.HSSFCell.setCellValue(HSSFCell.java:625)\n        at org.apache.poi.hssf.usermodel.HSSFFormulaEvaluator.evaluateFormulaCell(HSSFFormulaEvaluator.java:253)\n        at MyExample.main(MyExample.java:42)\n\nThe problem is that I am using in a cell a string and a formula like: '\"Sold by Company, TOT = \"&SUM(D52:D55)'\n\nThis type of formula is stopping the program with the error.\n\nProgram:\n\n        for (int sheetNum = 0; sheetNum < wb.getNumberOfSheets(); sheetNum++) {\n            HSSFSheet sheet = wb.getSheetAt(sheetNum);\n            HSSFFormulaEvaluator evaluator = new HSSFFormulaEvaluator(sheet, wb);\n\n            for (Iterator rit = sheet.rowIterator(); rit.hasNext();) {\n                HSSFRow r = (HSSFRow)rit.next();\n                evaluator.setCurrentRow(r);\n\n                for (Iterator cit = r.cellIterator(); cit.hasNext();) {\n                    HSSFCell c = (HSSFCell)cit.next();\n                    if (c.getCellType() == HSSFCell.CELL_TYPE_FORMULA) {\n                        System.out.println(c);\n                        evaluator.evaluateFormulaCell(c); // <--- LINE 42 ----\n                    }\n                }\n            }\n        }"}, {"count": 1, "tags": [], "bug_id": 44606, "attachment_id": null, "is_private": false, "id": 114630, "time": "2008-03-14T09:07:24Z", "creator": "antonio.chirizzi@gmail.com", "creation_time": "2008-03-14T09:07:24Z", "text": "Please note also that if I modify one cell, the other cells are not recalculated. So when I open the saved workbook, all the cells shows the \"#VALUE\" value.\n\nThis looks like another bug.\n\nSo I tried to recalculate all the formulas in the sheet, added the for statement and got the ClassCastException error, I think because of a cell containg a string and a formula in the same cell.\n\n-Antonio"}, {"count": 2, "tags": [], "creator": "josh@apache.org", "attachment_id": null, "id": 114638, "time": "2008-03-14T11:09:04Z", "bug_id": 44606, "creation_time": "2008-03-14T11:09:04Z", "is_private": false, "text": "I took a look at the code+spreadsheet you attached.  The latest POI fails well before the ClassCastException.  This is because since 3.0, support for parsing percent formula token was added, but percent evaluation has not been done yet.  From what I recall, in 3.0 the formula parser would just *stop* upon finding any unknown char.  That's why you don't *crash* on '%'. If you check the evaluated values, you should find that they're out by a factor of 100.\n\nAfter I hacked a quick fix for PercentPtg, I could see your ClassCastException error.  I have attached a patch to fix just this error.  (The percent evaluation stuff will come a bit later).\n\nIf you don't care about the actual results from HSSFFormulaEvaluator, you can just apply this patch to your 3.0 version of the code to get up and running.  Otherwise you'll have to wait for PercentEval to be added to the svn trunk before you'll have a version of POI that can handle your supplied example code.\n"}, {"count": 3, "tags": [], "bug_id": 44606, "attachment_id": 21668, "id": 114639, "time": "2008-03-14T11:10:10Z", "creator": "josh@apache.org", "creation_time": "2008-03-14T11:10:10Z", "is_private": false, "text": "Created attachment 21668\nsvn diff of changes to HSSFCell and TestHSSFCell"}, {"count": 4, "tags": [], "bug_id": 44606, "attachment_id": null, "id": 114659, "time": "2008-03-16T08:28:37Z", "creator": "apache@gagravarr.org", "creation_time": "2008-03-16T08:28:37Z", "is_private": false, "text": "Thanks for the patch Josh, applied to svn trunk"}, {"count": 5, "tags": [], "bug_id": 44606, "attachment_id": null, "is_private": false, "id": 114678, "time": "2008-03-17T03:16:45Z", "creator": "antonio.chirizzi@gmail.com", "creation_time": "2008-03-17T03:16:45Z", "text": "(In reply to comment #2)\n> I took a look at the code+spreadsheet you attached.  The latest POI fails well\n> before the ClassCastException.  This is because since 3.0, support for parsing\n> percent formula token was added, but percent evaluation has not been done yet. \n> From what I recall, in 3.0 the formula parser would just *stop* upon finding\n> any unknown char.  That's why you don't *crash* on '%'. If you check the\n> evaluated values, you should find that they're out by a factor of 100.\n> After I hacked a quick fix for PercentPtg, I could see your ClassCastException\n> error.  I have attached a patch to fix just this error.  (The percent\n> evaluation stuff will come a bit later).\n> If you don't care about the actual results from HSSFFormulaEvaluator, you can\n> just apply this patch to your 3.0 version of the code to get up and running. \n> Otherwise you'll have to wait for PercentEval to be added to the svn trunk\n> before you'll have a version of POI that can handle your supplied example code.\n\nThanks a lot Josh, I was able to patch the source and rebuild the jars.\nThe Exception does not show anymore, the sheet gets saved, the values are recalculated correctly, but I still have a problem:\nEven if the value are recalculated, if I modify a value in the rewritten sheet or set in the first example program I attached:\n\nsheet.setForceFormulaRecalculation(true);\n\nwhen I open the workbook all the formulas like \"=$D52/$D$47*$H$47*E11/100\" show the \"#VALUE\" value.\nI deleted the % sign as you suggested, and replaced it with the operation \"*cell/100\", but I still have problems.\nIs the formula too complex?\n\n-Antonio "}, {"count": 6, "tags": [], "text": "*** Bug 44861 has been marked as a duplicate of this bug. ***", "attachment_id": null, "id": 115985, "creator": "josh@apache.org", "time": "2008-04-28T12:00:17Z", "bug_id": 44606, "creation_time": "2008-04-28T12:00:17Z", "is_private": false}]