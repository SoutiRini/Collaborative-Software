[{"count": 0, "tags": [], "creator": "zyulyaev@devexperts.com", "attachment_id": null, "id": 179710, "time": "2014-12-11T11:20:44Z", "bug_id": 57340, "creation_time": "2014-12-11T11:20:44Z", "is_private": false, "text": "Configuration:\nTomcat 7.0.47 NioConnector, nginx 1.6.2, atmosphere 2.2.3.\n\nIt happens when nginx and atmosphere close the same comet connection concurrently.\n\nIn NioEndpoint.Poller thread(A) the SocketChannel becomes ready for read when nginx closes it. Poller unregisters the channel for read and forks another thread(B) to handle close event. (see NioEndpoint:1239)\nThen atmosphere calls close on the connection in thread(C) and Tomcat receives internal action with code ActionCode.COMET_CLOSE and adds the channel to the Poller, which registers it for read again. (see Http11NioProcessor.java:462).\nThe SocketChannel is still readable in case thread(B) hasn\u2019t invalidated the SelectionKey yet, so Poller in thread(A) initiates the closing process again and forks thread(D).\nThread(B) completes the closing process and puts NioChannel and AttachmentKey into the corresponding caches. \nThen Thread(D) tries to close the channel again and realizes that it has already been closed (see AbstractProtocol.java:564) and puts the same NioChannel and AttachmentKey into caches. \nCaches become corrupted because they contain 2 references to the same object. Then any 2 subsequent requests may get the same NioChannel and AttachmentKey and some crazy stuff may happen (mixed up responses, etc)."}, {"count": 1, "tags": [], "bug_id": 57340, "attachment_id": null, "id": 179735, "time": "2014-12-12T16:22:18Z", "creator": "cl@open.ch", "creation_time": "2014-12-12T16:22:18Z", "is_private": false, "text": "We can confirm this and were able to reproduce it as well.\nA fix would be highly appreciated because we also run into cases where actual responses were mixed up.\nWe consider this to be very serious in certain environments."}, {"count": 2, "tags": [], "bug_id": 57340, "attachment_id": null, "text": "Please make sure this is reproducible on Tomcat 7.0.57, the most recent release of the 7.0.x branch. What you describe probably hasn't changed since 7.0.47, but please double-check.", "id": 179737, "time": "2014-12-12T17:14:11Z", "creator": "chris@christopherschultz.net", "creation_time": "2014-12-12T17:14:11Z", "is_private": false}, {"count": 3, "tags": [], "text": "(In reply to Christopher Schultz from comment #2)\n> Please make sure this is reproducible on Tomcat 7.0.57, the most recent\n> release of the 7.0.x branch. What you describe probably hasn't changed since\n> 7.0.47, but please double-check.\n\nYes, the issue can be reproduced on either 7.0.47, 7.0.55 or 7.0.57 versions of Tomcat.", "is_private": false, "id": 179738, "creation_time": "2014-12-12T17:31:05Z", "time": "2014-12-12T17:31:05Z", "creator": "zyulyaev@devexperts.com", "bug_id": 57340, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 57340, "attachment_id": null, "is_private": false, "id": 179739, "time": "2014-12-12T17:35:43Z", "creator": "zyulyaev@devexperts.com", "creation_time": "2014-12-12T17:35:43Z", "text": "(In reply to cl from comment #1)\n> We can confirm this and were able to reproduce it as well.\n> A fix would be highly appreciated because we also run into cases where\n> actual responses were mixed up.\n> We consider this to be very serious in certain environments.\n\nIf you are interested in a quick workaround, you can disable bufferPool and keyCache by adding socket.bufferPool=\"0\" and socket.keyCache=\"0\" to the Connector tag in your server.xml. This will fix the symptoms."}, {"count": 5, "tags": [], "text": "I have committed a fix for this to trunk (Tomcat 9.0.x). Are you able to check out trunk from svn, build it and comfirm whether or not this fixes the issue for you?", "is_private": false, "id": 179830, "creation_time": "2014-12-17T18:20:33Z", "time": "2014-12-17T18:20:33Z", "creator": "markt@apache.org", "bug_id": 57340, "attachment_id": null}, {"count": 6, "tags": [], "text": "(In reply to Mark Thomas from comment #5)\n> I have committed a fix for this to trunk (Tomcat 9.0.x). Are you able to\n> check out trunk from svn, build it and comfirm whether or not this fixes the\n> issue for you?\n\nI'm afraid we are not able to run our application on Tomcat 9.0.x. Please port your changes to 7.0.x branch.", "is_private": false, "id": 179835, "creation_time": "2014-12-18T13:21:00Z", "time": "2014-12-18T13:21:00Z", "creator": "zyulyaev@devexperts.com", "bug_id": 57340, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 57340, "text": "Are you able to build 7.0.x from svn and test against that?", "count": 7, "id": 179836, "time": "2014-12-18T13:22:25Z", "creator": "markt@apache.org", "creation_time": "2014-12-18T13:22:25Z", "is_private": false}, {"count": 8, "text": "(In reply to Mark Thomas from comment #7)\n> Are you able to build 7.0.x from svn and test against that?\n\nOf course.", "bug_id": 57340, "attachment_id": null, "id": 179838, "time": "2014-12-18T13:24:39Z", "creator": "zyulyaev@devexperts.com", "creation_time": "2014-12-18T13:24:39Z", "tags": [], "is_private": false}, {"count": 9, "tags": [], "bug_id": 57340, "attachment_id": null, "id": 179839, "time": "2014-12-18T13:26:11Z", "creator": "markt@apache.org", "creation_time": "2014-12-18T13:26:11Z", "is_private": false, "text": "Great - not all users are able/willing to do that. I'll get the back-ports done now."}, {"count": 10, "tags": [], "bug_id": 57340, "is_private": false, "text": "Fix applied to 8.0.x for 8.0.16 onwards and to 7.0.x for 7.0.58 onwards.\n\nYou should be good to build 7.0.x from svn trunk and test now.", "id": 179844, "time": "2014-12-18T14:33:08Z", "creator": "markt@apache.org", "creation_time": "2014-12-18T14:33:08Z", "attachment_id": null}, {"count": 11, "attachment_id": null, "bug_id": 57340, "is_private": false, "id": 179845, "time": "2014-12-18T16:04:31Z", "creator": "zyulyaev@devexperts.com", "creation_time": "2014-12-18T16:04:31Z", "tags": [], "text": "(In reply to Mark Thomas from comment #10)\n> Fix applied to 8.0.x for 8.0.16 onwards and to 7.0.x for 7.0.58 onwards.\n> \n> You should be good to build 7.0.x from svn trunk and test now.\n\nI faced a very odd problem running 7.0.58. org/apache/tomcat/util/http/ValuesEnumerator was not included in the tomcat-coyote.jar during ant build.\nBut I applied your changes to the 7.0.47 and they worked successfully."}, {"count": 12, "tags": [], "bug_id": 57340, "attachment_id": null, "id": 179846, "time": "2014-12-18T16:36:18Z", "creator": "markt@apache.org", "creation_time": "2014-12-18T16:36:18Z", "is_private": false, "text": "Not sure what was going on with ValuesEnumerator. Thanks for going the extra mile and working around it.\n\nGreat to hear that the proposed fix did indeed work. It will be in the next release."}, {"count": 13, "tags": [], "bug_id": 57340, "is_private": false, "text": "(In reply to Nikita Zyulyaev from comment #11)\n> (In reply to Mark Thomas from comment #10)\n> > Fix applied to 8.0.x for 8.0.16 onwards and to 7.0.x for 7.0.58 onwards.\n> > \n> > You should be good to build 7.0.x from svn trunk and test now.\n> \n> I faced a very odd problem running 7.0.58.\n> org/apache/tomcat/util/http/ValuesEnumerator was not included in the\n> tomcat-coyote.jar during ant build.\n> But I applied your changes to the 7.0.47 and they worked successfully.\n\nIt works for me. I did a clean build and that class was successfully compiled and packed into tomcat-coyote.jar.\n\nI expected to find ValuesEnumerator.java, but that package-accessible class is actually defined in MimeHeaders.java. That code is old: the last change to MimeHeaders.java was 2,5 years ago.", "id": 179849, "time": "2014-12-18T18:44:40Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-12-18T18:44:40Z", "attachment_id": null}, {"count": 14, "tags": [], "text": "(In reply to Mark Thomas from comment #10)\n> Fix applied to 8.0.x for 8.0.16 onwards and to 7.0.x for 7.0.58 onwards.\n\nFixed in Tomcat 6 as part of bug 57943 and will be in 6.0.45 onwards. (r1710473)", "attachment_id": null, "id": 185932, "creator": "knst.kolinko@gmail.com", "time": "2015-10-25T18:40:12Z", "bug_id": 57340, "creation_time": "2015-10-25T18:40:12Z", "is_private": false}]