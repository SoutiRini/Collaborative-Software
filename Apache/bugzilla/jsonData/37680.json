[{"count": 0, "tags": [], "creator": "darius-abz@free-range.com.au", "attachment_id": null, "text": "Apache httpd consumes 100% CPU and does not respond to requests if at some stage\nof execution it has more than one listening socket configured, then it is\nsubsequently reconfigured by \"apachectl restart\" or \"apachectl graceful\" to have\nonly one listening socket, where that socket corresponds to one of the\npreviously existing sockets.  The problem is that the O_NONBLOCK option has been\nset on the reused socket in the previous initialisation, and a later part of the\ncode expects to make a blocking \"accept\" call on that socket (e.g.\nserver/mpm/prefork/prefork.c:591).  The call returns EWOULDBLOCK/EAGAIN where\nthat case is not specifically handled, causing a loop in the MPM (e.g. at\nserver/mpm/prefork/prefork.c:522) with full CPU utilisation.\n\nThe fix is to clear the O_NONBLOCK option on the reused socket if there is only\nthe one listening socket.  A patch to server/listen.c will be attached shortly.\n\n\nSteps to reproduce:\n\n$ tar xjf httpd-2.0.55.tar.bz2\n$ cd httpd-2.0.55/\n$ ./configure --prefix=/home/username/apache2-test\n$ make\n$ make install\n$ cd /home/username/apache2-test\n$ vi conf/httpd.conf\n\nChange \"Listen 80\" to \"Listen 10080\" (on the assumption that we're using an\nunprivileged account; this does not affect the reproducabililty of the bug).\n\n$ bin/apachectl start\n\nBrowse to localhost:10080, and verify that the server is working (receive the\ndefault installation page).\n\n$ vi conf/httpd.conf\n\nAdd \"Listen 10081\" on a new line after the existing line \"Listen 10080\"\n\n$ bin/apachectl restart\n\nBrowse to localhost:10081, and verify that the server is working. \nlocalhost:10080 is still working too.\n\n$ vi conf/httpd.conf\n\nDelete the line \"Listen 10081\".\n\n$ bin/apachectl restart\n$ top\n\nBrowse to localhost:10080.\n\n\nExpected results:\n\nNormal CPU utilisation.  Apache should serve the default installation page on\nlocalhost:10080.\n\n\nActual results:\n\n100% CPU utilisation, shared amongst the five httpd child processes.  Apache\ndoes not serve anything on any port.\n\n\nProblem reproduced on:\n\nApache 2.0.54 and 2.0.55 on i686 Fedora Core 3 Linux kernel 2.6.12-1.1378_FC3\nApache 2.0.55 on Linux kernel 2.4.20, PowerPC MPC8555 CPU.\n\nCompletely reproducible.  Only the \"prefork\" MPM has been tested, but I would\nexpect that similar results (or other failures) may occur with other MPMs.", "id": 82948, "time": "2005-11-29T03:16:43Z", "bug_id": 37680, "creation_time": "2005-11-29T03:16:43Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 37680, "text": "Created attachment 17072\nProposed patch to clear O_NONBLOCK on reused sockets when there is only one listening socket.\n\nHere is a small patch that I've tested briefly on the same platforms as those\nused to reproduce the bug.  I would appreciate any further comment and/or\ntesting by those more knowledgeable in the way of Apache and listening sockets.\n;-)", "id": 82949, "time": "2005-11-29T03:20:01Z", "creator": "darius-abz@free-range.com.au", "creation_time": "2005-11-29T03:20:01Z", "is_private": false, "attachment_id": 17072}, {"count": 2, "attachment_id": null, "creator": "darius-abz@free-range.com.au", "text": "Setting PatchAvailable.", "id": 82950, "time": "2005-11-29T03:24:46Z", "bug_id": 37680, "creation_time": "2005-11-29T03:24:46Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 37680, "text": "\n> Problem reproduced on:\n> \n> Apache 2.0.54 and 2.0.55 on i686 Fedora Core 3 Linux kernel 2.6.12-1.1378_FC3\n> Apache 2.0.55 on Linux kernel 2.4.20, PowerPC MPC8555 CPU.\n> \n> Completely reproducible.  Only the \"prefork\" MPM has been tested, but I would\n> expect that similar results (or other failures) may occur with other MPMs.\n\nProblem reproduced on:\nRed Hat Enterprise 3,  2.4.21-37.EL\nWith apache 2.0.55 and 2.0.58 compiled from source tarballs with MPM \"worker\"\n\nconfigure options:\n        --with-mpm=worker \\\n\t--with-perl \\\n\t--prefix=/usr/local/apache2.0.55 \\\n\t--enable-mods-shared=\"most info proxy proxy-http proxy-connect ssl\" \\\n\t--enable-so\n\nThe server was configured with several virtual hosts for both HTTP and HTTPS sites.\nCommenting out VirtualHosts definitions and Listen directives for SSL (i.e. let\nthe server listen only on port 80 and not on both 80 and 443) and restarting or\nmaking a graceful (with apachectl) causes CPU *and* disk usage to increase.\nA hard reset/shutdown is needed because of the very high load caused.\n\nIs the attached patch known to resolve the problem? why it's not been included\nin the main sources yet?", "id": 89387, "time": "2006-05-23T12:50:27Z", "creator": "moray@oltrelinux.com", "creation_time": "2006-05-23T12:50:27Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "darius-abz@free-range.com.au", "attachment_id": null, "is_private": false, "id": 89403, "time": "2006-05-23T18:30:16Z", "bug_id": 37680, "creation_time": "2006-05-23T18:30:16Z", "text": "(In reply to comment #3)\n> Problem reproduced on:\n> Red Hat Enterprise 3,  2.4.21-37.EL\n> With apache 2.0.55 and 2.0.58 compiled from source tarballs with MPM \"worker\"\n[...]\n> A hard reset/shutdown is needed because of the very high load caused.\n\nThanks for the feedback.  I thought I was the only one in the world that had\nencountered this issue ;-)\n\nMoving the bug version to 2.0.58 based on this feedback.\n\n> Is the attached patch known to resolve the problem? why it's not been included\n> in the main sources yet?\n\nIt resolved the problem on all of the platforms I've tested, and I believe it\nwould be a good general solution.  Could you please test the patch on your\nplatform and report the results?  That might help get this fixed in the main\nsources.  I guess it's not a problem that many users will encounter...\n\nI can't seem to reproduce this bug with httpd-2.2.2, but it doesn't look like\nthe code has been changed in the area of my patch -- maybe there's another\nchange somewhere in 2.2 that makes this bug go away... (?)"}, {"count": 5, "tags": [], "creator": "oneill@oinc.net", "attachment_id": null, "text": "I can confirm that this bug still exists as of 2.0.59, and the patch appears to\nstill correct the problem. I need to dynamically reconfigure Apache for a\ncluster solution, and this was killing me.\n\nThe bug takes a different form in 2.2.3 - instead of the processes spinning in\nthe CPU (with endless EAGAIN results to accept() calls), the child processes die\n(same accept() failures) and get constantly respawned. This is actually worse,\nbecause now it won't serve content. The 2.0.X issue it could still serve data.\n\nI tried the patch in 2.2.3, and it seems to work as well.", "id": 92668, "time": "2006-08-29T12:24:35Z", "bug_id": 37680, "creation_time": "2006-08-29T12:24:35Z", "is_private": false}, {"count": 6, "tags": [], "creator": "darius-abz@free-range.com.au", "attachment_id": null, "text": "I can reproduce this on httpd-2.2.3, but only if I use the \"worker\" MPM.  The\ndefault \"prefork\" MPM seems unaffected by the bug in 2.2.x -- I haven't yet\nlooked into why that's the case.  Brian: Were you using \"worker\"?\n\nIt certainly is nasty with 2.2.3 and \"worker\" -- I had to hard-reset my system\nfor the first time since... well, since the last time I accidentally set off a\nfork-bomb ;-)\n\nNudging the priority and changing the bug title in accordance with the severity\nof the symptoms as originally reported by Ciro in Comment #3 back in May. \nUpdating the version to 2.2.2 (it seems 2.2.3 isn't selectable at the moment???)", "id": 92892, "time": "2006-09-01T13:54:06Z", "bug_id": 37680, "creation_time": "2006-09-01T13:54:06Z", "is_private": false}, {"count": 7, "tags": [], "creator": "darius-abz@free-range.com.au", "attachment_id": 18801, "text": "Created attachment 18801\nhttpd-2.2.3: Patch for correcting the NONBLOCK state of listening sockets on graceful/restart\n\nThis patch is against httpd-2.2.3, and appears to fix the problem for the\n\"worker\" MPM at least -- others are untested, but could reasonably be expected\nto benefit from this change if they are affected by the bug.", "id": 92893, "time": "2006-09-01T13:57:08Z", "bug_id": 37680, "creation_time": "2006-09-01T13:57:08Z", "is_private": false}, {"count": 8, "tags": [], "creator": "darius-abz@free-range.com.au", "attachment_id": 18801, "is_private": false, "id": 92894, "time": "2006-09-01T13:58:37Z", "bug_id": 37680, "creation_time": "2006-09-01T13:58:37Z", "text": "Comment on attachment 18801\nhttpd-2.2.3: Patch for correcting the NONBLOCK state of listening sockets on graceful/restart\n\nJust including the httpd version in the patch attachment comment..."}, {"count": 9, "tags": [], "creator": "darius-abz@free-range.com.au", "attachment_id": 18802, "text": "Created attachment 18802\nhttpd-2.0.59: Patch for correcting the NONBLOCK state of listening sockets on graceful/restart\n\nUpdated the patch for 2.0.x to apply cleanly against 2.0.59 and cleaned it up a\nbit.", "id": 92895, "time": "2006-09-01T14:13:42Z", "bug_id": 37680, "creation_time": "2006-09-01T14:13:42Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 37680, "attachment_id": null, "id": 92918, "time": "2006-09-01T23:26:00Z", "creator": "oneill@oinc.net", "creation_time": "2006-09-01T23:26:00Z", "is_private": false, "text": "(In reply to comment #6)\n> I can reproduce this on httpd-2.2.3, but only if I use the \"worker\" MPM.  The\n> default \"prefork\" MPM seems unaffected by the bug in 2.2.x -- I haven't yet\n> looked into why that's the case.  Brian: Were you using \"worker\"?\n> \n\nI was using prefork, but for some reason I can't reproduce the exiting process\nproblem now...it's spinning in the CPU with EAGAINs like with 2.0.59 this time\n(I rebuilt from pristine source). I must have done something else that time and\ndon't remember what.\n\nI didn't encounter a fork-bomb, but in 2.0.55/worker at least (where I first\nstarted investigating this) it ate all the memory of the system, which hung it\npretty quick. Fortunately it was a test Xen instance."}, {"count": 11, "tags": [], "bug_id": 37680, "text": "Patch committed to /trunk/\n\nWhen a bug goes unfixed, it's probably because no committer noticed it.  You\nsometimes have to bug us on dev@httpd.", "id": 96985, "time": "2006-12-16T13:43:53Z", "creator": "nick@webthing.com", "creation_time": "2006-12-16T13:43:53Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 37680, "attachment_id": null, "id": 105798, "creation_time": "2007-07-20T01:54:35Z", "time": "2007-07-20T01:54:35Z", "creator": "nick@webthing.com", "text": "http://svn.apache.org/viewvc?view=rev&revision=488883", "is_private": false}, {"count": 13, "tags": [], "bug_id": 37680, "attachment_id": null, "id": 111333, "time": "2007-12-02T13:48:32Z", "creator": "sf@sfritsch.de", "creation_time": "2007-12-02T13:48:32Z", "is_private": false, "text": "*** Bug 40292 has been marked as a duplicate of this bug. ***"}]