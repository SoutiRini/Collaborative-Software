[{"count": 0, "tags": [], "creator": "kpreisser@apache.org", "attachment_id": 31055, "id": 171333, "time": "2013-11-20T00:01:34Z", "bug_id": 55799, "creation_time": "2013-11-20T00:01:34Z", "is_private": false, "text": "Created attachment 31055\nTest case (modifications to the Chat example)\n\nHi,\n\na thread on the Users List [1] described that problems can occur when sending large messages over a WebSocket connection using getBasicRemote().sendText(String).\n\nThe ChatAnnotation class does not synchronize when using this method, which means that multiple threads could call RemoteEndpoint.Basic#sendText() concurrently.\n\nThe JavaDoc of RemoteEndpoint.Basic says:\n\n\"If the websocket connection underlying this RemoteEndpoint is busy sending a message when a call is made to send another one, for example if two threads attempt to call a send method concurrently, or if a developer attempts to send a new message while in the middle of sending an existing one, the send method called while the connection is already busy may throw an IllegalStateException.\"\n\n(I thought I had read earlier that the implementation should synchronize calls to methods of RemoteEndpoint.Basic instead of throwing an ISE, but maybe that has changed).\n\n\nWhen sending large Messages over Websocket using RemoteEndpoint.Basic from different threads without or with synchronization, some problems happen like:\na) The WebSocket connection is suddenly closed (I guess the browser\n   actually aborts the connections due to data corruption or Timeout errors,\n   but I have not examined the raw data sent over TCP)\nb) Various Exceptions occur (see below)\nc) Sometimes when I open the chat.xhtml example in my browser, it shows what\n   seems to be a raw WebSocket response instead of the .xhtml file (see\n   added screenshots)\n\nThese issues also happen after synchronizing calls to RemoteEndpoint.Basic#sendText(), but are then harder to reproduce.\n\n\n\nTo reproduce: \n1) Checkout Tomcat 8 trunk (r1543467) and apply the attached patch. It applies some modifications to the Chat Websocket Example, so that the Javascript sends messages in a regular interval (50 ms), and the ChatAnnotation modifies the message to be 256 times as large as the original message, and sends it back using session.getBasicRemote()#sendText(msg). \n\n2) Build Tomcat and run it on a Windows machine (I used Windows 8.1 x64, Java 1.7.0_45 x64), using the NIO HTTP connector (default configuration).\n\n3) Open Firefox and IE 11. With both browsers, open the Chat example (http://localhost:8080/examples/websocket/chat.xhtml).\n\n4) Repeat the following actions in a regular interval:\n   a) Wait several seconds (it might be that Tomcat already closes one of\n      the two WebSocket connections in that time).\n   b) On one of the browsers (e.g. IE), press F5 several times.\n\n5) After some time, you can see that in one of the browsers, the WebSocket connection is suddenly closed. Tomcat will show one or more of the following exceptions (I think the IOException and ClosedChannelException are expected if the browser aborts the connection):\n\n\n19-Nov-2013 23:18:39.809 SEVERE [http-nio-8080-ClientPoller-0] org.apache.tomcat.util.net.NioEndpoint.processSocket Error allocating socket processor\n java.lang.NullPointerException\n\tat org.apache.tomcat.util.net.NioEndpoint.processSocket(NioEndpoint.java:624)\n\tat org.apache.tomcat.util.net.NioEndpoint$Poller.processKey(NioEndpoint.java:1165)\n\tat org.apache.tomcat.util.net.NioEndpoint$Poller.run(NioEndpoint.java:1122)\n\tat java.lang.Thread.run(Thread.java:744)\n\n\n19-Nov-2013 23:32:16.601 SEVERE [http-nio-8080-exec-3] websocket.chat.ChatAnnotation.onError Chat Error: java.nio.channels.ClosedChannelException\n java.nio.channels.ClosedChannelException\n\tat sun.nio.ch.SocketChannelImpl.ensureReadOpen(SocketChannelImpl.java:252)\n\tat sun.nio.ch.SocketChannelImpl.read(SocketChannelImpl.java:295)\n\tat org.apache.tomcat.util.net.NioChannel.read(NioChannel.java:136)\n\tat org.apache.coyote.http11.upgrade.NioServletInputStream.fillReadBuffer(NioServletInputStream.java:136)\n\tat org.apache.coyote.http11.upgrade.NioServletInputStream.doIsReady(NioServletInputStream.java:49)\n\tat org.apache.coyote.http11.upgrade.AbstractServletInputStream.isReady(AbstractServletInputStream.java:62)\n\tat org.apache.tomcat.websocket.server.WsFrameServer.onDataAvailable(WsFrameServer.java:44)\n\tat org.apache.tomcat.websocket.server.WsHttpUpgradeHandler$WsReadListener.onDataAvailable(WsHttpUpgradeHandler.java:192)\n\tat org.apache.coyote.http11.upgrade.AbstractServletInputStream.onDataAvailable(AbstractServletInputStream.java:180)\n\tat org.apache.coyote.http11.upgrade.AbstractProcessor.upgradeDispatch(AbstractProcessor.java:95)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:640)\n\tat org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1597)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1555)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:744)\n\n\n19-Nov-2013 23:32:19.658 SEVERE [http-nio-8080-exec-2] websocket.chat.ChatAnnotation.onError Chat Error: java.lang.IllegalArgumentException: java.lang.reflect.InvocationTargetException\n java.lang.IllegalArgumentException: java.lang.reflect.InvocationTargetException\n\tat org.apache.tomcat.websocket.pojo.PojoMessageHandlerWholeBase.onMessage(PojoMessageHandlerWholeBase.java:82)\n\tat org.apache.tomcat.websocket.WsFrameBase.sendMessageText(WsFrameBase.java:369)\n\tat org.apache.tomcat.websocket.WsFrameBase.processDataText(WsFrameBase.java:468)\n\tat org.apache.tomcat.websocket.WsFrameBase.processData(WsFrameBase.java:272)\n\tat org.apache.tomcat.websocket.WsFrameBase.processInputBuffer(WsFrameBase.java:116)\n\tat org.apache.tomcat.websocket.server.WsFrameServer.onDataAvailable(WsFrameServer.java:55)\n\tat org.apache.tomcat.websocket.server.WsHttpUpgradeHandler$WsReadListener.onDataAvailable(WsHttpUpgradeHandler.java:192)\n\tat org.apache.coyote.http11.upgrade.AbstractServletInputStream.onDataAvailable(AbstractServletInputStream.java:180)\n\tat org.apache.coyote.http11.upgrade.AbstractProcessor.upgradeDispatch(AbstractProcessor.java:95)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:640)\n\tat org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1597)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1555)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:744)\nCaused by: java.lang.reflect.InvocationTargetException\n\tat sun.reflect.GeneratedMethodAccessor38.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:606)\n\tat org.apache.tomcat.websocket.pojo.PojoMessageHandlerWholeBase.onMessage(PojoMessageHandlerWholeBase.java:80)\n\t... 15 more\nCaused by: java.nio.charset.CoderMalfunctionError: java.nio.BufferOverflowException\n\tat java.nio.charset.CharsetEncoder.encode(CharsetEncoder.java:565)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase$TextMessageSendHandler.write(WsRemoteEndpointImplBase.java:624)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.sendPartialString(WsRemoteEndpointImplBase.java:197)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.sendString(WsRemoteEndpointImplBase.java:154)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointBasic.sendText(WsRemoteEndpointBasic.java:37)\n\tat websocket.chat.ChatAnnotation.broadcast(ChatAnnotation.java:96)\n\tat websocket.chat.ChatAnnotation.incoming(ChatAnnotation.java:83)\n\t... 19 more\nCaused by: java.nio.BufferOverflowException\n\tat java.nio.Buffer.nextPutIndex(Buffer.java:513)\n\tat java.nio.HeapByteBuffer.put(HeapByteBuffer.java:163)\n\tat org.apache.tomcat.util.buf.Utf8Encoder.encodeNotHasArray(Utf8Encoder.java:177)\n\tat org.apache.tomcat.util.buf.Utf8Encoder.encodeLoop(Utf8Encoder.java:40)\n\tat java.nio.charset.CharsetEncoder.encode(CharsetEncoder.java:561)\n\t... 25 more\n\n\n19-Nov-2013 23:32:23.353 SEVERE [http-nio-8080-exec-10] websocket.chat.ChatAnnotation.onError Chat Error: java.io.IOException: Eine vorhandene Verbindung wurde vom Remotehost geschlossen\n java.io.IOException: Eine vorhandene Verbindung wurde vom Remotehost geschlossen\n\tat sun.nio.ch.SocketDispatcher.read0(Native Method)\n\tat sun.nio.ch.SocketDispatcher.read(SocketDispatcher.java:43)\n\tat sun.nio.ch.IOUtil.readIntoNativeBuffer(IOUtil.java:223)\n\tat sun.nio.ch.IOUtil.read(IOUtil.java:197)\n\tat sun.nio.ch.SocketChannelImpl.read(SocketChannelImpl.java:379)\n\tat org.apache.tomcat.util.net.NioChannel.read(NioChannel.java:136)\n\tat org.apache.coyote.http11.upgrade.NioServletInputStream.fillReadBuffer(NioServletInputStream.java:136)\n\tat org.apache.coyote.http11.upgrade.NioServletInputStream.doRead(NioServletInputStream.java:80)\n\tat org.apache.coyote.http11.upgrade.AbstractServletInputStream.read(AbstractServletInputStream.java:124)\n\tat org.apache.tomcat.websocket.server.WsFrameServer.onDataAvailable(WsFrameServer.java:46)\n\tat org.apache.tomcat.websocket.server.WsHttpUpgradeHandler$WsReadListener.onDataAvailable(WsHttpUpgradeHandler.java:192)\n\tat org.apache.coyote.http11.upgrade.AbstractServletInputStream.onDataAvailable(AbstractServletInputStream.java:180)\n\tat org.apache.coyote.http11.upgrade.AbstractProcessor.upgradeDispatch(AbstractProcessor.java:95)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:640)\n\tat org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1597)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1555)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:744)\n\n\nIf you try to press F5, then it might be that the Websocket connection is closed as soon as it was opened, or that the browser doesn't get a response for the request to chat.xhtml.\n\n\n\nNow, add synchronization by modifying ChatAnnotation's broadcast() method:\n\n    private static void broadcast(String msg) {\n        for (ChatAnnotation client : connections) {\n            synchronized (client) {\n                try {\n                    client.session.getBasicRemote().sendText(msg);\n                } catch (Exception e) {\n    \n                }\n            }\n        }\n    }\n\nand repeat the above steps.\n\nNow, if you open chat.xhtml with both IE and Firefox and do nothing, the WebSocket connection will not be closed. Even if you start to repeatedly press F5, most of the time everything will appear normal (besides getting IOExceptions and ClosedChannelExceptions).\n\nHowever, after I tried this several minutes, I still got the problems that the WebSocket connections are closed just after opening it (or after some time), or that the browser didn't get a response to its HTTP request, or that the browser got a raw WebSocket reply instead of the XHTML page reply (see added screenshots).\n\nI also got these exceptions:\n\n20-Nov-2013 00:18:20.037 SEVERE [http-nio-8080-exec-9] websocket.chat.ChatAnnotation.onError Chat Error: java.io.IOException: java.util.concurrent.ExecutionException: java.io.IOException: Key must be cancelled\n java.io.IOException: java.util.concurrent.ExecutionException: java.io.IOException: Key must be cancelled\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessageBlock(WsRemoteEndpointImplBase.java:226)\n\tat org.apache.tomcat.websocket.WsSession.sendCloseMessage(WsSession.java:476)\n\tat org.apache.tomcat.websocket.WsSession.onClose(WsSession.java:439)\n\tat org.apache.tomcat.websocket.server.WsHttpUpgradeHandler.close(WsHttpUpgradeHandler.java:172)\n\tat org.apache.tomcat.websocket.server.WsHttpUpgradeHandler.access$200(WsHttpUpgradeHandler.java:45)\n\tat org.apache.tomcat.websocket.server.WsHttpUpgradeHandler$WsReadListener.onDataAvailable(WsHttpUpgradeHandler.java:194)\n\tat org.apache.coyote.http11.upgrade.AbstractServletInputStream.onDataAvailable(AbstractServletInputStream.java:180)\n\tat org.apache.coyote.http11.upgrade.AbstractProcessor.upgradeDispatch(AbstractProcessor.java:95)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:640)\n\tat org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1597)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1555)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:744)\nCaused by: java.util.concurrent.ExecutionException: java.io.IOException: Key must be cancelled\n\tat org.apache.tomcat.websocket.FutureToSendHandler.get(FutureToSendHandler.java:102)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessageBlock(WsRemoteEndpointImplBase.java:222)\n\t... 14 more\nCaused by: java.io.IOException: Key must be cancelled\n\tat org.apache.coyote.http11.upgrade.NioServletOutputStream.doWriteInternal(NioServletOutputStream.java:83)\n\tat org.apache.coyote.http11.upgrade.NioServletOutputStream.doWrite(NioServletOutputStream.java:60)\n\tat org.apache.coyote.http11.upgrade.AbstractServletOutputStream.writeInternal(AbstractServletOutputStream.java:118)\n\tat org.apache.coyote.http11.upgrade.AbstractServletOutputStream.write(AbstractServletOutputStream.java:85)\n\tat org.apache.tomcat.websocket.server.WsRemoteEndpointImplServer.onWritePossible(WsRemoteEndpointImplServer.java:94)\n\tat org.apache.tomcat.websocket.server.WsRemoteEndpointImplServer.doWrite(WsRemoteEndpointImplServer.java:81)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.writeMessagePart(WsRemoteEndpointImplBase.java:362)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessage(WsRemoteEndpointImplBase.java:259)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessageBlock(WsRemoteEndpointImplBase.java:217)\n\t... 14 more\n\n\n20-Nov-2013 00:32:53.483 SEVERE [http-nio-8080-exec-3] org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun \n java.lang.NullPointerException\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:593)\n\tat org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1597)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1555)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:744)\n\n\n20-Nov-2013 00:35:19.333 SEVERE [http-nio-8080-exec-15] org.apache.tomcat.websocket.server.WsHttpUpgradeHandler.destroy Failed to close WebConnection while destroying the WebSocket HttpUpgradeHandler\n java.lang.NullPointerException\n\tat org.apache.tomcat.websocket.server.WsHttpUpgradeHandler.destroy(WsHttpUpgradeHandler.java:143)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:715)\n\tat org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1597)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1555)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:744)\n\n\n20-Nov-2013 00:35:19.327 SEVERE [http-nio-8080-exec-15] org.apache.coyote.http11.AbstractHttp11Processor.process Error processing request\n java.lang.IllegalArgumentException\n\tat java.nio.Buffer.position(Buffer.java:236)\n\tat sun.nio.ch.IOUtil.write(IOUtil.java:68)\n\tat sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:487)\n\tat org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:123)\n\tat org.apache.tomcat.util.net.NioBlockingSelector.write(NioBlockingSelector.java:101)\n\tat org.apache.tomcat.util.net.NioSelectorPool.write(NioSelectorPool.java:174)\n\tat org.apache.coyote.http11.InternalNioOutputBuffer.writeToSocket(InternalNioOutputBuffer.java:140)\n\tat org.apache.coyote.http11.InternalNioOutputBuffer.addToBB(InternalNioOutputBuffer.java:198)\n\tat org.apache.coyote.http11.InternalNioOutputBuffer.commit(InternalNioOutputBuffer.java:178)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.action(AbstractHttp11Processor.java:739)\n\tat org.apache.coyote.Response.action(Response.java:180)\n\tat org.apache.coyote.Response.sendHeaders(Response.java:368)\n\tat org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:335)\n\tat org.apache.catalina.connector.OutputBuffer.close(OutputBuffer.java:290)\n\tat org.apache.catalina.connector.Response.finishResponse(Response.java:411)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:560)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1015)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:642)\n\tat org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1597)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1555)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:744)\n\n\n\n\n[1] http://markmail.org/message/ee3jch4zj2orltzs"}, {"text": "Created attachment 31056\nScreenshot of FF getting a raw websocket respone (1)", "tags": [], "bug_id": 55799, "attachment_id": 31056, "count": 1, "id": 171334, "time": "2013-11-20T00:02:40Z", "creator": "kpreisser@apache.org", "creation_time": "2013-11-20T00:02:40Z", "is_private": false}, {"count": 2, "tags": [], "creator": "kpreisser@apache.org", "attachment_id": 31057, "text": "Created attachment 31057\nScreenshot of FF getting a raw websocket respone (2)", "id": 171335, "time": "2013-11-20T00:03:03Z", "bug_id": 55799, "creation_time": "2013-11-20T00:03:03Z", "is_private": false}, {"text": "Note: When using Google Chrome and when the WebSocket connection fails, Chrome reports one of the following errors in the console:\n\nWebSocket connection to 'ws://localhost:8080/examples/websocket/chat' failed: Status line contains embedded null\n\nWebSocket connection to 'ws://localhost:8080/examples/websocket/chat' failed: Received unexpected continuation frame.", "tags": [], "bug_id": 55799, "attachment_id": null, "count": 3, "id": 171336, "time": "2013-11-20T00:22:31Z", "creator": "kpreisser@apache.org", "creation_time": "2013-11-20T00:22:31Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 55799, "text": "I can see one problem immediately. While the code does check for concurrent messages (which will trigger an IllegalStateException) text messages are converted to bytes before that check in a single buffer. Therefore, multiple threads could access that buffer and that will cause corruption. I'll take a look.", "id": 171344, "time": "2013-11-20T10:20:07Z", "creator": "markt@apache.org", "creation_time": "2013-11-20T10:20:07Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "I've hopefully fixed this in trunk. If you can provide some feedback on the fix that would be great.\n\nI'm leaving this open as I have a little clean-up still to do in trunk for this fix and I also want to back-port the changes to 7.0.x.", "id": 171349, "time": "2013-11-20T14:04:38Z", "bug_id": 55799, "creation_time": "2013-11-20T14:04:38Z", "is_private": false}, {"count": 6, "tags": [], "creator": "kpreisser@apache.org", "attachment_id": 31060, "id": 171350, "time": "2013-11-20T14:48:16Z", "bug_id": 55799, "creation_time": "2013-11-20T14:48:16Z", "is_private": false, "text": "Created attachment 31060\nUpdated Test case (modifications to the Chat example)\n\nHi Mark,\n\nI updated my working copy of Tomcat 8 trunk to r1543817 and have the changes applied from the attached patch. It modifies the Chat example in the same way as the previous test case (and it changes the catch (IOException e) to catch (Exception e) to also catch ISE, and do not remove a client in this catch block - instead wait for the onClose method to be called).\n\nUnfortunately, even with the fix and the added synchronized() block in the Chat's broadcast() method, I still see the same problems as before (WebSocket connection is closed soon after it is opened, Chrome displays \"Unexpected continuation frame\" error, browser receives raw websocket response instead of the requested chat.xhtml file).\n\nI also got following exceptions (Note: One of the NPEs is probably the same that I once observed with the DrawBoard example and the NIO connector when repeatedly pressing F5):\n\n\nException in thread \"WebSocketServer-localhost-/examples-1\" java.lang.IllegalStateException: Unexpected state. Please report a bug. Message will not be sent because the WebSocket session is currently sending another message\n        at org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessage(WsRemoteEndpointImplBase.java:272)\n        at org.apache.tomcat.websocket.WsRemoteEndpointImplBase$TextMessageSendHandler.write(WsRemoteEndpointImplBase.java:643)\n        at org.apache.tomcat.websocket.WsRemoteEndpointImplBase$TextMessageSendHandler.onResult(WsRemoteEndpointImplBase.java:653)\n        at org.apache.tomcat.websocket.WsRemoteEndpointImplBase.endMessage(WsRemoteEndpointImplBase.java:305)\n        at org.apache.tomcat.websocket.WsRemoteEndpointImplBase$EndMessageHandler.onResult(WsRemoteEndpointImplBase.java:453)\n        at org.apache.tomcat.websocket.server.WsRemoteEndpointImplServer$OnResultRunnable.run(WsRemoteEndpointImplServer.java:234)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:744)\n\n\n20-Nov-2013 15:25:04.759 SEVERE [http-nio-8080-exec-4] websocket.chat.ChatAnnotation.onError Chat Error: java.lang.NullPointerException\n java.lang.NullPointerException\n\tat org.apache.coyote.http11.upgrade.AbstractServletOutputStream.onWritePossible(AbstractServletOutputStream.java:134)\n\tat org.apache.coyote.http11.upgrade.AbstractProcessor.upgradeDispatch(AbstractProcessor.java:97)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:640)\n\tat org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1597)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1551)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:744)\n\n\n20-Nov-2013 15:30:49.345 SEVERE [http-nio-8080-ClientPoller-1] org.apache.tomcat.util.net.NioEndpoint.processSocket Error allocating socket processor\n java.lang.NullPointerException\n\tat org.apache.tomcat.util.net.NioEndpoint.processSocket(NioEndpoint.java:624)\n\tat org.apache.tomcat.util.net.NioEndpoint$Poller.processKey(NioEndpoint.java:1165)\n\tat org.apache.tomcat.util.net.NioEndpoint$Poller.run(NioEndpoint.java:1122)\n\tat java.lang.Thread.run(Thread.java:744)\n\n\n20-Nov-2013 15:32:33.070 SEVERE [http-nio-8080-exec-5] org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun \n java.lang.NullPointerException\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:593)\n\tat org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1597)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1555)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:744)\n\n\n20-Nov-2013 15:32:53.378 SEVERE [http-nio-8080-exec-23] org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process Error reading request, ignored\n java.lang.IllegalStateException: Unexpected state. Please report a bug. Message will not be sent because the WebSocket session is currently sending another message\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessage(WsRemoteEndpointImplBase.java:272)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase$TextMessageSendHandler.write(WsRemoteEndpointImplBase.java:643)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase$TextMessageSendHandler.onResult(WsRemoteEndpointImplBase.java:653)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.endMessage(WsRemoteEndpointImplBase.java:305)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase$EndMessageHandler.onResult(WsRemoteEndpointImplBase.java:453)\n\tat org.apache.tomcat.websocket.server.WsRemoteEndpointImplServer.clearHandler(WsRemoteEndpointImplServer.java:206)\n\tat org.apache.tomcat.websocket.server.WsRemoteEndpointImplServer.onWritePossible(WsRemoteEndpointImplServer.java:102)\n\tat org.apache.tomcat.websocket.server.WsHttpUpgradeHandler$WsWriteListener.onWritePossible(WsHttpUpgradeHandler.java:238)\n\tat org.apache.coyote.http11.upgrade.AbstractServletOutputStream.onWritePossible(AbstractServletOutputStream.java:167)\n\tat org.apache.coyote.http11.upgrade.AbstractProcessor.upgradeDispatch(AbstractProcessor.java:97)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:640)\n\tat org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1597)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1551)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:744)\n\n\n20-Nov-2013 15:24:55.951 SEVERE [http-nio-8080-exec-9] websocket.chat.ChatAnnotation.onError Chat Error: java.io.IOException: java.util.concurrent.ExecutionException: java.io.IOException: Key must be cancelled\n java.io.IOException: java.util.concurrent.ExecutionException: java.io.IOException: Key must be cancelled\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessageBlock(WsRemoteEndpointImplBase.java:245)\n\tat org.apache.tomcat.websocket.WsSession.sendCloseMessage(WsSession.java:476)\n\tat org.apache.tomcat.websocket.WsSession.onClose(WsSession.java:439)\n\tat org.apache.tomcat.websocket.WsFrameBase.processDataControl(WsFrameBase.java:316)\n\tat org.apache.tomcat.websocket.WsFrameBase.processData(WsFrameBase.java:270)\n\tat org.apache.tomcat.websocket.WsFrameBase.processInputBuffer(WsFrameBase.java:116)\n\tat org.apache.tomcat.websocket.server.WsFrameServer.onDataAvailable(WsFrameServer.java:55)\n\tat org.apache.tomcat.websocket.server.WsHttpUpgradeHandler$WsReadListener.onDataAvailable(WsHttpUpgradeHandler.java:192)\n\tat org.apache.coyote.http11.upgrade.AbstractServletInputStream.onDataAvailable(AbstractServletInputStream.java:180)\n\tat org.apache.coyote.http11.upgrade.AbstractProcessor.upgradeDispatch(AbstractProcessor.java:95)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:640)\n\tat org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1597)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1555)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:744)\nCaused by: java.util.concurrent.ExecutionException: java.io.IOException: Key must be cancelled\n\tat org.apache.tomcat.websocket.FutureToSendHandler.get(FutureToSendHandler.java:102)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessageBlock(WsRemoteEndpointImplBase.java:241)\n\t... 16 more\nCaused by: java.io.IOException: Key must be cancelled\n\tat org.apache.coyote.http11.upgrade.NioServletOutputStream.doWriteInternal(NioServletOutputStream.java:83)\n\tat org.apache.coyote.http11.upgrade.NioServletOutputStream.doWrite(NioServletOutputStream.java:60)\n\tat org.apache.coyote.http11.upgrade.AbstractServletOutputStream.writeInternal(AbstractServletOutputStream.java:118)\n\tat org.apache.coyote.http11.upgrade.AbstractServletOutputStream.write(AbstractServletOutputStream.java:85)\n\tat org.apache.tomcat.websocket.server.WsRemoteEndpointImplServer.onWritePossible(WsRemoteEndpointImplServer.java:94)\n\tat org.apache.tomcat.websocket.server.WsRemoteEndpointImplServer.doWrite(WsRemoteEndpointImplServer.java:81)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.writeMessagePart(WsRemoteEndpointImplBase.java:378)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessage(WsRemoteEndpointImplBase.java:279)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessageBlock(WsRemoteEndpointImplBase.java:236)\n\t... 16 more\n\n\t\n[Probably expected, when the browser aborts the connection:]\n20-Nov-2013 15:25:24.777 SEVERE [http-nio-8080-exec-8] websocket.chat.ChatAnnotation.onError Chat Error: java.io.IOException: java.util.concurrent.ExecutionException: java.nio.channels.ClosedChannelException\n java.io.IOException: java.util.concurrent.ExecutionException: java.nio.channels.ClosedChannelException\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessageBlock(WsRemoteEndpointImplBase.java:245)\n\tat org.apache.tomcat.websocket.WsSession.sendCloseMessage(WsSession.java:476)\n\tat org.apache.tomcat.websocket.WsSession.onClose(WsSession.java:439)\n\tat org.apache.tomcat.websocket.server.WsHttpUpgradeHandler.close(WsHttpUpgradeHandler.java:172)\n\tat org.apache.tomcat.websocket.server.WsHttpUpgradeHandler.access$200(WsHttpUpgradeHandler.java:45)\n\tat org.apache.tomcat.websocket.server.WsHttpUpgradeHandler$WsReadListener.onDataAvailable(WsHttpUpgradeHandler.java:194)\n\tat org.apache.coyote.http11.upgrade.AbstractServletInputStream.onDataAvailable(AbstractServletInputStream.java:180)\n\tat org.apache.coyote.http11.upgrade.AbstractProcessor.upgradeDispatch(AbstractProcessor.java:95)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:640)\n\tat org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1597)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1555)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:744)\nCaused by: java.util.concurrent.ExecutionException: java.nio.channels.ClosedChannelException\n\tat org.apache.tomcat.websocket.FutureToSendHandler.get(FutureToSendHandler.java:102)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessageBlock(WsRemoteEndpointImplBase.java:241)\n\t... 14 more\nCaused by: java.nio.channels.ClosedChannelException\n\tat sun.nio.ch.SocketChannelImpl.ensureWriteOpen(SocketChannelImpl.java:265)\n\tat sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:474)\n\tat org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:123)\n\tat org.apache.tomcat.util.net.NioSelectorPool.write(NioSelectorPool.java:185)\n\tat org.apache.coyote.http11.upgrade.NioServletOutputStream.doWriteInternal(NioServletOutputStream.java:93)\n\tat org.apache.coyote.http11.upgrade.NioServletOutputStream.doWrite(NioServletOutputStream.java:60)\n\tat org.apache.coyote.http11.upgrade.AbstractServletOutputStream.writeInternal(AbstractServletOutputStream.java:118)\n\tat org.apache.coyote.http11.upgrade.AbstractServletOutputStream.write(AbstractServletOutputStream.java:85)\n\tat org.apache.tomcat.websocket.server.WsRemoteEndpointImplServer.onWritePossible(WsRemoteEndpointImplServer.java:94)\n\tat org.apache.tomcat.websocket.server.WsRemoteEndpointImplServer.doWrite(WsRemoteEndpointImplServer.java:81)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.writeMessagePart(WsRemoteEndpointImplBase.java:378)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessage(WsRemoteEndpointImplBase.java:279)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessageBlock(WsRemoteEndpointImplBase.java:236)\n\t... 14 more"}, {"count": 7, "tags": [], "bug_id": 55799, "text": "I'm not seeing the errors you are seeing but I did spot a possible failure mode which I have now fixed. Could you re-test 8.0.x please.", "id": 171357, "time": "2013-11-20T20:58:49Z", "creator": "markt@apache.org", "creation_time": "2013-11-20T20:58:49Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "kpreisser@apache.org", "attachment_id": null, "id": 171358, "time": "2013-11-20T21:47:22Z", "bug_id": 55799, "creation_time": "2013-11-20T21:47:22Z", "is_private": false, "text": "Hi Mark,\n\n(In reply to Mark Thomas from comment #7)\n> I'm not seeing the errors you are seeing but I did spot a possible failure\n> mode which I have now fixed. Could you re-test 8.0.x please.\n\nThanks a lot. I updated to r1543948 and cannot reproduce the main problems any more (like websocket connection suddenly closes, wrong response sent to the browser). I think it is fixed now.\n\nI also don't get NPEs or IllegalArgumentExceptions any more. I still do see IOExceptions (\"Software caused connection abort\" / \"Key must be cancelled\") and ClosedChannelExceptions reported through the ChatAnnotation's onError method, but these are probably expected due to the browser aborting the connection when repeatedly pressing F5.\n\nI also still see the following exception:\n\nException in thread \"WebSocketServer-localhost-/examples-14\"\njava.lang.IllegalStateException: Message will not be sent because the WebSocket session has been closed\n        at org.apache.tomcat.websocket.WsRemoteEndpointImplBase.writeMessagePart(WsRemoteEndpointImplBase.java:306)\n        at org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessage(WsRemoteEndpointImplBase.java:273)\n        at org.apache.tomcat.websocket.WsRemoteEndpointImplBase$TextMessageSendHandler.write(WsRemoteEndpointImplBase.java:637)\n        at org.apache.tomcat.websocket.WsRemoteEndpointImplBase$TextMessageSendHandler.onResult(WsRemoteEndpointImplBase.java:649)\n        at org.apache.tomcat.websocket.WsRemoteEndpointImplBase.endMessage(WsRemoteEndpointImplBase.java:299)\n        at org.apache.tomcat.websocket.WsRemoteEndpointImplBase$EndMessageHandler.onResult(WsRemoteEndpointImplBase.java:447)\n        at org.apache.tomcat.websocket.server.WsRemoteEndpointImplServer$OnResultRunnable.run(WsRemoteEndpointImplServer.java:234)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:744)"}, {"count": 9, "tags": [], "bug_id": 55799, "attachment_id": null, "id": 171359, "time": "2013-11-20T21:58:02Z", "creator": "kpreisser@apache.org", "creation_time": "2013-11-20T21:58:02Z", "is_private": false, "text": "(In reply to Konstantin Prei\u00dfer from comment #8)\n> I also still see the following exception:\n\nActually I meant the following exception here (but the other one also occurs):\n\nException in thread \"WebSocketServer-localhost-/examples-1\" java.lang.IllegalStateException: Unexpected state. Please report a bug. Message will not be sent because the WebSocket session is currently sending another message\n        at org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessage(WsRemoteEndpointImplBase.java:266)\n        at org.apache.tomcat.websocket.WsRemoteEndpointImplBase$TextMessageSendHandler.write(WsRemoteEndpointImplBase.java:637)\n        at org.apache.tomcat.websocket.WsRemoteEndpointImplBase$TextMessageSendHandler.onResult(WsRemoteEndpointImplBase.java:649)\n        at org.apache.tomcat.websocket.WsRemoteEndpointImplBase.endMessage(WsRemoteEndpointImplBase.java:299)\n        at org.apache.tomcat.websocket.WsRemoteEndpointImplBase$EndMessageHandler.onResult(WsRemoteEndpointImplBase.java:447)\n        at org.apache.tomcat.websocket.server.WsRemoteEndpointImplServer$OnResultRunnable.run(WsRemoteEndpointImplServer.java:234)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:744)"}, {"count": 10, "tags": [], "creator": "kpreisser@apache.org", "attachment_id": null, "id": 171360, "time": "2013-11-20T22:18:02Z", "bug_id": 55799, "creation_time": "2013-11-20T22:18:02Z", "is_private": false, "text": "(In reply to Konstantin Prei\u00dfer from comment #8)\n> Thanks a lot. I updated to r1543948 and cannot reproduce the main problems\n> any more (like websocket connection suddenly closes, wrong response sent to\n> the browser). I think it is fixed now.\n\nAfter some additional testing, the problem that the browser could not establish a WebSocket connection / Websocket connection is closed a few seconds after opening it happened again on Google Chrome, the console displayed the following:\n\nWebSocket connection to 'ws://localhost:8080/examples/websocket/chat' failed: Received new data frame but previous continuous frame is unfinished."}, {"count": 11, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 171361, "time": "2013-11-20T23:51:43Z", "bug_id": 55799, "creation_time": "2013-11-20T23:51:43Z", "is_private": false, "text": "OK. Getting better but maybe not quite there yet. Because WebSocket has the potential for multiple threads to be working with a socket concurrently (one read, one write) there is a world of opportunity for weird and wonderful failure modes. It is possible that that is what we are seeing here but I'd like to at least understand each class of exceptions you are seeing.\n\nThe IOExceptions and ClosedChannelExceptions are expected when the client drops the connection. I'm not worried about these.\n\nThe IllegalStateException (closed) might be OK but I need to confirm.\n\nThe IllegalStateException (report a bug) shouldn't happen so I want to look at this some more.\n\nThe \"Received new data frame but previous continuous frame is unfinished.\" definitely shouldn't happen. Need to look into that as well."}, {"count": 12, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 171368, "time": "2013-11-21T09:38:21Z", "bug_id": 55799, "creation_time": "2013-11-21T09:38:21Z", "is_private": false, "text": "(In reply to Mark Thomas from comment #11)\n> The IllegalStateException (closed) might be OK but I need to confirm.\n\nIt is OK but could be handled better so I have improved the handling of this.\n\n> The IllegalStateException (report a bug) shouldn't happen so I want to look\n> at this some more.\n\nThe logic was wrong here so it has been fixed.\n\n> The \"Received new data frame but previous continuous frame is unfinished.\"\n> definitely shouldn't happen. Need to look into that as well.\n\nI suspect that these were a result of the logic errors.\n\n8.0.x has been updated. As I still can't reproduce this I'd again appreciate your help with testing."}, {"count": 13, "tags": [], "creator": "kpreisser@apache.org", "attachment_id": null, "text": "Hi Mark,\n\n(In reply to Mark Thomas from comment #12)\n> 8.0.x has been updated. As I still can't reproduce this I'd again appreciate\n> your help with testing.\n\nI updated to r1544165 and I'm now unable to reproduce the Exceptions (besides the expected IOException) and the frame error that Google Chrome's console had shown, so I think it is now fixed. Thanks!\n\n(The only problem I got was that it took several minutes for Tomcat to shutdown after testing - it did not close the Websocket Connections and even after closing all browsers it took some minutes for Tomcat to complete shutdown.)", "id": 171377, "time": "2013-11-21T15:09:09Z", "bug_id": 55799, "creation_time": "2013-11-21T15:09:09Z", "is_private": false}, {"count": 14, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "Thanks for the testing.\n\nThe slow shutdown could be caused by not correctly handling an IOException. That is something to follow-up in a separate BZ issue.", "id": 171379, "time": "2013-11-21T15:32:55Z", "bug_id": 55799, "creation_time": "2013-11-21T15:32:55Z", "is_private": false}, {"count": 15, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "id": 171443, "time": "2013-11-26T04:51:05Z", "bug_id": 55799, "creation_time": "2013-11-26T04:51:05Z", "is_private": false, "text": "REOPENING, there is a regression\n\nSee thread on users@,\n\"IllegalStateException sending WebSocket message that worked a few months ago\"\nhttp://tomcat.markmail.org/thread/75uisvwve2l2u3n2\n\nApparently using an OutputStream obtained via WsRemoteEndpointImplBase.getSendStream() is broken.\n\n\nThere is a test case for a writer, TestWsRemoteEndpoint.doTestWriter(..). It seems that there is no test case for a stream.\n\nThere is a small difference in implementation between doWrite() methods of WsRemoteEndpointImplBase$WsWriter and WsRemoteEndpointImplBase$WsOutputStream:\n\nThe writer calls a package-visible method that does not perform a state check.\nThe stream calls a public method that performs a state check and fails."}, {"count": 16, "tags": [], "bug_id": 55799, "text": "I've fixed the regression and added a test case for Stream messages to trunk and 7.0.x.", "id": 171447, "time": "2013-11-26T11:32:13Z", "creator": "markt@apache.org", "creation_time": "2013-11-26T11:32:13Z", "is_private": false, "attachment_id": null}, {"count": 17, "tags": [], "text": "Created attachment 31078\nSample project to replicate regression\n\nSomething still isn't quite right. I've attached a sample project. It's silly-looking, I know, but it's simple and it demonstrates the problem reliably every time. Steps:\n\n1. Compile it and deploy to /cluster.\n2. Go to http://localhost:8080/cluster/clusterNode1. The browser should display \"OK\" and there should be some diagnostic output in stdout.\n3. Go to http://localhost:8080/cluster/clusterNode2. The browser should display \"OK\" and there should be a lot more diagnostic output in stdout.\n\n-- Step 3 is where it failed two days ok. You never saw \"OK\" and the diagnostic output. You just got the exception in the browser. After Mark's changes last night / this morning, step 3 succeeds.\n\n4. Go back to http://localhost:8080/cluster/clusterNode1. The exception is back.\n5. Go back to http://localhost:8080/cluster/clusterNode2. The exception is back there, tee.", "attachment_id": 31078, "id": 171453, "creator": "nicholas@nicholaswilliams.net", "time": "2013-11-26T23:38:12Z", "bug_id": 55799, "creation_time": "2013-11-26T23:38:12Z", "is_private": false}, {"count": 18, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "Should be fixed now. Test case appears to work. (No errors reported)", "id": 171485, "time": "2013-11-28T14:56:23Z", "bug_id": 55799, "creation_time": "2013-11-28T14:56:23Z", "is_private": false}, {"count": 19, "tags": [], "bug_id": 55799, "attachment_id": null, "id": 171498, "time": "2013-11-29T02:01:59Z", "creator": "nicholas@nicholaswilliams.net", "creation_time": "2013-11-29T02:01:59Z", "is_private": false, "text": "Confirmed. Looks like it is working now. Thanks!"}]