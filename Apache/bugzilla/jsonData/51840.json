[{"count": 0, "tags": [], "bug_id": 51840, "text": "Hello,\nI noticed this issue while testing JMS Subscriber and Publisher.\nMethode close of InitialContextFactory is never called.\nThis has the following impacts:\n1) Open JMX, run script, close it => When you reopen the old one is used\n2) When you rerun a Test, the InitialContext is not reloaded\nThere is also another biggest issue:\n- If you use the same initialContextFactory and providerUrl but one with User /Pwd , the other one without, as these 2 infos are used as a key, this will provoke an issue for one of the samplers depending on which one is initialized first.\n\nRegards\nPhilippe", "id": 149429, "time": "2011-09-17T20:16:49Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-09-17T20:16:49Z", "is_private": false, "attachment_id": null}, {"text": "(In reply to comment #0)\n> Hello,\n> I noticed this issue while testing JMS Subscriber and Publisher.\n> Methode close of InitialContextFactory is never called.\n> This has the following impacts:\n> 1) Open JMX, run script, close it => When you reopen the old one is used\n> 2) When you rerun a Test, the InitialContext is not reloaded\n> There is also another biggest issue:\n> - If you use the same initialContextFactory and providerUrl but one with User\n> /Pwd , the other one without, as these 2 infos are used as a key, this will\n> provoke an issue for one of the samplers depending on which one is initialized\n> first.\n> \n> Regards\n> Philippe\n\nPlease ignore this part:\n> There is also another biggest issue:\n> - If you use the same initialContextFactory and providerUrl but one with User\n> /Pwd , the other one without, as these 2 infos are used as a key, this will\n> provoke an issue for one of the samplers depending on which one is initialized\n> first.\n\nI fixed it in issue patch to issue 51691 where it has its part.\nRegards\nPhilippe", "tags": [], "bug_id": 51840, "attachment_id": null, "count": 1, "id": 149437, "time": "2011-09-17T21:22:00Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-09-17T21:22:00Z", "is_private": false}, {"count": 2, "attachment_id": 27525, "creator": "p.mouawad@ubik-ingenierie.com", "text": "Created attachment 27525\nFix to the issue\n\nHello Sebb,\nI implemented the TestListener in SubscriberSampler and added in PublisherSampler a call to unregister in testEnded.\n\nBy the way I also changed InitialContextFactory synchronization because it seems to me too COARSE grained, due to static synchronized.\nI replaced these by a ConcurrentHashMap. \n\nRegards\nPhilippe", "id": 149453, "time": "2011-09-18T10:17:51Z", "bug_id": 51840, "creation_time": "2011-09-18T10:17:51Z", "tags": [], "is_private": false}, {"text": "Just wondering if it would not be better just to call InitialContextFactory.close() in testEnded() ?\n\nIs there any need to unregister the contexts individually?", "tags": [], "bug_id": 51840, "is_private": false, "count": 3, "id": 149454, "time": "2011-09-18T10:47:13Z", "creator": "sebb@apache.org", "creation_time": "2011-09-18T10:47:13Z", "attachment_id": null}, {"count": 4, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": null, "is_private": false, "id": 149456, "time": "2011-09-18T12:59:25Z", "bug_id": 51840, "creation_time": "2011-09-18T12:59:25Z", "text": "I prefer to make each sampler clean its own Contexts so that if some day we have an evolution that requires some Contexts not to be cleared then it will work.\nThe other thing that bothers me a little is that we will have listener call many times close but only the first one does something.\n\nBut I can change it if you think it's better.\nRegards\nPhilippe"}, {"count": 5, "tags": [], "bug_id": 51840, "is_private": false, "text": "There cannot be any reason to retain any contexts after the end of a test.\n\nAlso, what if two samplers use the same context? If contexts are to be individually released, then there would need to be a separate key, or a usage count. That's all more complicated, and unnecessary at present.", "id": 149458, "time": "2011-09-18T13:44:49Z", "creator": "sebb@apache.org", "creation_time": "2011-09-18T13:44:49Z", "attachment_id": null}, {"count": 6, "attachment_id": 27527, "creator": "p.mouawad@ubik-ingenierie.com", "text": "Created attachment 27527\nFix to issue\n\nHello Sebb,\nI changed to call close instead of unregister.\nRegards\nPhilippen,", "id": 149461, "time": "2011-09-18T17:27:56Z", "bug_id": 51840, "creation_time": "2011-09-18T17:27:56Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "creator": "sebb@apache.org", "attachment_id": null, "is_private": false, "id": 149468, "time": "2011-09-19T00:58:45Z", "bug_id": 51840, "creation_time": "2011-09-19T00:58:45Z", "text": "Thanks for finding the bug and the patch.\n\nI made two changes to InitialContextFactory.java:\n* when the context is added to the map using putIfAbsent, this might return an existing context, in which case we need to return that, rather than the one we just created, or the Map does no correspond with what we have issued.\n* simplified the close method - no need to iterate over the map entries when we only want the values.\n\nURL: http://svn.apache.org/viewvc?rev=1172403&view=rev\nLog:\nBug 51840 - JMS : Cache of InitialContext has some issues\n\nModified:\n   jakarta/jmeter/trunk/src/protocol/jms/org/apache/jmeter/protocol/jms/client/InitialContextFactory.java\n   jakarta/jmeter/trunk/src/protocol/jms/org/apache/jmeter/protocol/jms/sampler/PublisherSampler.java\n   jakarta/jmeter/trunk/src/protocol/jms/org/apache/jmeter/protocol/jms/sampler/SubscriberSampler.java\n   jakarta/jmeter/trunk/xdocs/changes.xml"}]