[{"count": 0, "tags": [], "bug_id": 53131, "attachment_id": null, "text": "In most cases, developers assume that when apr_file_write() returns APR_SUCCESS, everything went well, and move on.\nIn reality, apr_file_write() returns APR_SUCCESS if *some* bytes got written successfully. One of the many cases when this could happen is when the server receive a signal in the middle of the write() system call. The kernel will not return -EINTR, but the number of bytes that have been written so far. The caller needs to check that all the bytes to write have been successfully written. This is more or less implemented by apr_file_write_full().\n\nI wrote a fix for mod_log_config because log file corruption is sad.\nPatch is here: https://github.com/nviennot/apache-httpd/commit/fcbc7ed94\nNote: flush_log() returns void, albeit apr_file_write_full() may fail.\n\n\nThis issue is present in different part of the code base. Following a list of highly suspicious calls:\nhttps://github.com/apache/httpd/blob/62db628c/modules/slotmem/mod_slotmem_shm.c#L169\nhttps://github.com/apache/httpd/blob/62db628c/modules/mappers/mod_rewrite.c#L1404\nhttps://github.com/apache/httpd/blob/62db628c/modules/mappers/mod_rewrite.c#L1414\nhttps://github.com/apache/httpd/blob/62db628c/modules/generators/mod_cgid.c#L1158\nhttps://github.com/apache/httpd/blob/62db628c/modules/generators/mod_cgi.c#L298\nhttps://github.com/apache/httpd/blob/62db628c/modules/cache/mod_cache_disk.c#L742\nhttps://github.com/apache/httpd/blob/62db628c/modules/cache/mod_cache_disk.c#L752\nhttps://github.com/apache/httpd/blob/62db628c/modules/cache/mod_cache_disk.c#L901\nhttps://github.com/apache/httpd/blob/62db628c/modules/cache/mod_cache_disk.c#L910\nhttps://github.com/apache/httpd/blob/62db628c/modules/cache/mod_cache_disk.c#L977\nhttps://github.com/apache/httpd/blob/62db628c/modules/cache/mod_cache_disk.c#L988\nhttps://github.com/apache/httpd/blob/62db628c/modules/cache/mod_cache_disk.c#L1054", "id": 158292, "time": "2012-04-23T04:46:25Z", "creator": "apache@viennot.biz", "creation_time": "2012-04-23T04:46:25Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 53131, "text": "replaced apr_file_write{,v} with apr_file_write{,v}_full in r1331110\nsome error checking is still missing.", "id": 158459, "time": "2012-04-26T21:46:36Z", "creator": "sf@sfritsch.de", "creation_time": "2012-04-26T21:46:36Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "apache@viennot.biz", "text": "LGTM", "count": 2, "id": 158460, "time": "2012-04-26T21:55:38Z", "bug_id": 53131, "creation_time": "2012-04-26T21:55:38Z", "is_private": false}]