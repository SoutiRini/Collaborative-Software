[{"count": 0, "tags": [], "creator": "wollman+apache@csail.mit.edu", "attachment_id": null, "text": "These logs show a connection to a FastCGI server in a directory which requires\nSSL renegotiation.  mod_fastcgi uses the deprecated ap_get_client_block() family\n to read POST data from the client, but rewriting it to use the underlying\nApache 2 APIs shows identical results.  I've deleted a few lines that aren't\nrelevant to this analysis...\n\n[Tue Oct 30 16:41:47 2007] [info] [client 128.30.28.20] Connection to child 9\nestablished (server courses.csail.mit.edu:443)\n...\n[Tue Oct 30 16:41:47 2007] [debug] ssl_engine_io.c(1478): [client 128.30.28.20]\nfilling buffer\n[Tue Oct 30 16:41:47 2007] [debug] ssl_engine_io.c(1529): [client 128.30.28.20]\ntotal of 525 bytes in buffer, eos=1\n...my analysis concentrates here...\n[Tue Oct 30 16:42:21 2007] [error] [client 128.30.28.20] FastCGI: comm with\nserver \"/usr/bin/php5-cgi\" aborted: idle timeout (30 sec), referer: [URI deleted]\n[Tue Oct 30 16:42:21 2007] [debug] ssl_engine_io.c(1561): [client 128.30.28.20]\nread from buffered SSL brigade, mode 0, 8192 bytes\n[Tue Oct 30 16:42:21 2007] [debug] ssl_engine_io.c(1623): [client 128.30.28.20]\nbuffered SSL brigade now exhausted; removing filter\n\nThe reason for the timeout is that the FastCGI server is waiting to read POST\ndata from the server which never arrives.  In fact, the server thinks it should\nbe passing client data, but when ap_get_client_block() attempts to read the\nclient data, it gets an EOS.  More interestingly, an examination of the\ninput_filter chain at that point shows \"http_in\" followed by \"ssl/tls filter\"; I\nbelieve the second (or maybe the first) filter here should be \"ssl/tls buffer\"\ninstead.  (We know from the two previous lines that the POST content has been\nsuccessfully buffered.)  The buffer does eventually get read, as the following\nlog entries show -- but not by mod_fastcgi.  The very last thing that\nssl_io_buffer_fill() does is add the \"ssl/tls buffer\" filter, so I don't\nunderstand why it doesn't appear at the head of the input filter list when\nap_get_client_block() is running, nor why it does get read (and presumably is in\nthe filter chain) after the request is aborted.", "id": 109982, "time": "2007-10-30T14:57:53Z", "bug_id": 43738, "creation_time": "2007-10-30T14:57:53Z", "is_private": false}, {"count": 1, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "text": "Curious.  Can you get a dump of the r->input_filters in gdb at the point where\nap_get_client_block() is called in mod_fastcgi?\n\nsource /path/to/httpd-source/.gdbinit\ndump_filters r->input_filters\n", "id": 110067, "time": "2007-10-31T10:02:14Z", "bug_id": 43738, "creation_time": "2007-10-31T10:02:14Z", "is_private": false}, {"count": 2, "attachment_id": null, "bug_id": 43738, "text": "Here's what GDB thinks\n(gdb) b ap_get_client_block\nBreakpoint 1 at 0x441f60\n(gdb) cont\nContinuing.\n\nBreakpoint 1, 0x0000000000441f60 in ap_get_client_block ()\n(gdb) up\n#1  0x00002b952d63a703 in do_work (r=0x819238, fr=0x84d0c0)\n    at mod_fastcgi.c:868\n868             if ((countRead = ap_get_client_block(fr->r, end, count)) < 0)\n(gdb) source /afs/csail.mit.edu/u/w/wollman/public/apache2/apache2-2.2.3/.gdbinit \n(gdb) dump_filters fr->r->input_filters\nhttp_in(0x826c98): ctx=0x83e990, r=0x819238, c=0x810248\nssl/tls filter(0x81e098): ctx=0x81c048, r=0x0, c=0x810248\nlog_input_output(0x8109f0): ctx=0x0, r=0x0, c=0x810248\ncore_in(0x81e140): ctx=0x81e120, r=0x0, c=0x810248\n(gdb) p *r\n$1 = {pool = 0x825088, connection = 0x810248, server = 0x6d0478, next = 0x0, \n  prev = 0x8250f8, main = 0x0, \n  the_request = 0x8266b0 \"POST /16.410/wiki/index.php?title=Special:Preferences\nHTTP/1.1\", assbackwards = 0, proxyreq = 0, header_only = 0, \n  protocol = 0x8267b0 \"HTTP/1.1\", proto_num = 1001, \n  hostname = 0x826c78 \"more-courses.csail.mit.edu\", \n  request_time = 1193866479991696, status_line = 0x0, status = 200, \n  method = 0x826700 \"POST\", method_number = 2, allowed = 0, \n  allowed_xmethods = 0x0, allowed_methods = 0x84b828, sent_bodyct = 0, \n  bytes_sent = 0, mtime = 0, chunked = 0, range = 0x0, clength = 0, \n  remaining = 525, read_length = 0, read_body = 1, read_chunked = 0, \n  expecting_100 = 0, headers_in = 0x8253d8, headers_out = 0x819af0, \n  err_headers_out = 0x825d20, subprocess_env = 0x819d38, notes = 0x84b688, \n  content_type = 0x84a308 \"application/x-httpd-fastphp5\", \n  handler = 0x2b952d6428c8 \"fastcgi-script\", content_encoding = 0x0, \n  content_languages = 0x0, vlist_validator = 0x0, \n  user = 0x84d028 \"wollman@MIT.EDU\", ap_auth_type = 0x0, no_cache = 0, \n  no_local_copy = 0, \n  unparsed_uri = 0x819518\n\"/.php5-cgi/16.410/wiki/index.php?title=Special:Preferences\", uri = 0x819558\n\"/.php5-cgi/16.410/wiki/index.php\", \n  filename = 0x84c418 \"/usr/bin/php5-cgi\", \n  canonical_filename = 0x84c418 \"/usr/bin/php5-cgi\", \n  path_info = 0x84c2f9 \"/16.410/wiki/index.php\", \n---Type <return> to continue, or q <return> to quit--- \n  args = 0x819580 \"title=Special:Preferences\", finfo = {pool = 0x825088, \n    valid = 7598448, protection = 1877, filetype = APR_REG, user = 0, \n    group = 0, inode = 283762, device = 2049, nlink = 1, size = 5483216, \n    csize = 8540296, atime = 1193866145000000, mtime = 1183409032000000, \n    ctime = 1193860247000000, fname = 0x84c418 \"/usr/bin/php5-cgi\", \n    name = 0x6bb731 \"/.php5-cgi\", filehand = 0x7fff808d1370}, parsed_uri = {\n    scheme = 0x0, hostinfo = 0x0, user = 0x0, password = 0x0, hostname = 0x0, \n    port_str = 0x0, path = 0x819558 \"/.php5-cgi/16.410/wiki/index.php\", \n    query = 0x819580 \"title=Special:Preferences\", fragment = 0x0, \n    hostent = 0x0, port = 0, is_initialized = 1, dns_looked_up = 0, \n    dns_resolved = 0}, used_path_info = 0, per_dir_config = 0x819e60, \n  request_config = 0x8195a0, htaccess = 0x83cdb0, output_filters = 0x8265d0, \n  input_filters = 0x826c98, proto_output_filters = 0x8265d0, \n  proto_input_filters = 0x826c98, eos_sent = 0}\n", "id": 110078, "time": "2007-10-31T14:40:46Z", "creator": "wollman+apache@csail.mit.edu", "creation_time": "2007-10-31T14:40:46Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "text": "That all looks correct.  The filter chain is correct; r->remaining is 525 which\nmatches the number of bytes the SSL buffer captured.\n\nI can't see why this would fail, and I can't think what else to suggest here\nother than stepping through the code to see what is happening, or adding a lot\nof ap_log_rerror() debugging calls in ap_get_client_block()/ap_http_filter().  \n\n- is this ap_get_client_block() call happening *before* the timeout?\n- does ap_get_client_block() fail?\n- the topmost filter is ap_http_filter - breakpoint on that; does it get\ninvoked?  step through; what does it do?\n\n", "id": 110096, "time": "2007-11-01T01:43:50Z", "bug_id": 43738, "creation_time": "2007-11-01T01:43:50Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 43738, "text": "What makes you say that the filter chain is correct?  I would expect the\n\"ssl/tls buffer\" filter to be at the head to the chain, since that's where all\nthe data is being buffered.  There's no chance that reading from \"ssl/tls\nfilter\" will give me any data since its data has already been read and stored in\nthe buffer.\n\nTo answer your questions:\n>- is this ap_get_client_block() call happening *before* the timeout?\n\nYes, I thought I made that clear in my analysis.\n\n>- does ap_get_client_block() fail?\n\nNo, as I said before, it returns end-of-stream (0).\n\nI haven't traced through ap_http_filter; however, in the course of instrumenting\nap_get_client_block() before I filed this bug, I made it skip over \"http_in\" and\nread directly from \"ssl/tls filter\".  Same result: end of stream.\n", "count": 4, "id": 110123, "time": "2007-11-01T08:30:35Z", "creator": "wollman+apache@csail.mit.edu", "creation_time": "2007-11-01T08:30:35Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 43738, "attachment_id": null, "id": 110125, "time": "2007-11-01T09:16:12Z", "creator": "rpluem@apache.org", "creation_time": "2007-11-01T09:16:12Z", "is_private": false, "text": "(In reply to comment #4)\n> What makes you say that the filter chain is correct?  I would expect the\n> \"ssl/tls buffer\" filter to be at the head to the chain, since that's where all\n> the data is being buffered.  There's no chance that reading from \"ssl/tls\n> filter\" will give me any data since its data has already been read and stored in\n> the buffer.\n\nIt is correct. You have to read the whole thing as a stack:\n\n\nhttp_in(0x826c98):          HTTP filter: Does dechunking if transfer-encoding of \n                            the body is chunked or reads up to Content-length\n                            bytes from the body.\nssl/tls filter(0x81e098):   Does decryption of the input stream and deals with\n                            client certificates. Sometimes this filter buffers\n                            data.\nlog_input_output(0x8109f0): Counts bytes that came in.\ncore_in(0x81e140):          Core network connection to the raw socket.\n"}, {"attachment_id": null, "tags": [], "bug_id": 43738, "text": ">ssl/tls filter(0x81e098):   Does decryption of the input stream and deals with\n>                            client certificates. Sometimes this filter buffers\n>                            data.\n\nThat's not what the code claims.  See the end of ssl_io_buffer_fill() in\nssl_engine_io.c:\n\n    /* Insert the filter which will supply the buffered data. */\n    ap_add_input_filter(ssl_io_buffer, ctx, r, c);\n\n    return 0;\n\nThe buffered data can only come from the \"ssl/tls buffer\" filter, not the\n\"ssl/tls filter\" filter.  As I noted in my original report, we know from the\ndebug logs that the \"ssl/tls buffer\" filter's read routine\n(ssl_io_filter_buffer) is in fact being called, but not until after the\n30-second timeout.", "count": 6, "id": 110126, "time": "2007-11-01T09:34:21Z", "creator": "wollman+apache@csail.mit.edu", "creation_time": "2007-11-01T09:34:21Z", "is_private": false}, {"count": 7, "tags": [], "creator": "jorton@redhat.com", "attachment_id": 21077, "text": "Created attachment 21077\ntest fix\n\nSorry, I read the filter stack wrong; I was only looking to check that http_in\nwas at the top; the second filter down should be the buffering filter not the\nnormal SSL filter (they are separate filters).\n\nI note that r->prev is set here so an internal redirect will have happened. \nAnd that will filters < AP_FTYPE_PROTOCOL, which includes this one... oops. \nCan you try this fix?", "id": 110127, "time": "2007-11-01T09:38:16Z", "bug_id": 43738, "creation_time": "2007-11-01T09:38:16Z", "is_private": false}, {"count": 8, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "text": "should read: ^And that will kill filters < AP_FTYPE_PROTOCOL", "id": 110128, "time": "2007-11-01T09:40:27Z", "bug_id": 43738, "creation_time": "2007-11-01T09:40:27Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 43738, "attachment_id": null, "id": 110130, "time": "2007-11-01T09:51:57Z", "creator": "jorton@redhat.com", "creation_time": "2007-11-01T09:51:57Z", "is_private": false, "text": "Ah, no, that won't work at all.  The buffering filter is AP_FTYPE_PROTOCOL - 1\nexactly because it the fill_buffer reads from r->proto_input_filters.  Ick.  I\ncan't see any obvious fix here.\n\nTo confirm the diagnosis can you reproduce without whatever triggered the\ninternal redirect?"}, {"count": 10, "tags": [], "creator": "wollman+apache@csail.mit.edu", "attachment_id": null, "text": "> To confirm the diagnosis can you reproduce without whatever triggered the\n> internal redirect?\n\nCan you suggest how I might figure out what that was?\n\nFor what it's worth, ssl_io_filter_buffer() is eventually called from\nap_discard_request_body() after mod_fastcgi gives up.\n", "id": 110131, "time": "2007-11-01T10:41:26Z", "bug_id": 43738, "creation_time": "2007-11-01T10:41:26Z", "is_private": false}, {"count": 11, "tags": [], "creator": "wollman+apache@csail.mit.edu", "attachment_id": null, "text": "> To confirm the diagnosis can you reproduce without whatever triggered the\n> internal redirect?\n\nI think I figured it out.  This problem is not seen by mod_php4 applications,\nnor by regular CGI applications.  The internal redirect is caused by mod_action,\nwhich is used to implement PHP5 under FastCGI.  The configuration looks like this:\n\nFastCgiServer /usr/bin/php5-cgi -processes 5\nScriptAlias /.php5-cgi /usr/bin/php5-cgi\n<Directory /usr/bin>\n  Order deny,allow\n  Deny from all\n  <Files php5-cgi>\n    Options ExecCGI\n    SetHandler fastcgi-script\n    Order allow,deny\n    Allow from all\n  </Files>\n</Directory>\nAction php5-script /.php5-cgi\nAction application/x-httpd-fastphp5 /.php5-cgi\n\nThen in .htaccess, users who want php5 instead of php4 specify:\n\nAddHandler php5-script .php\n", "id": 110133, "time": "2007-11-01T10:48:52Z", "bug_id": 43738, "creation_time": "2007-11-01T10:48:52Z", "is_private": false}, {"count": 12, "attachment_id": null, "bug_id": 43738, "text": "I don't see how your conf is triggering an internal redirect?\n\nCan you differentiate if this is a fast-internal redirect or a straight\nredirect?  Is this because the client requests /app/Login instead of\nrequesting /app/Login.php ?\n", "id": 110135, "time": "2007-11-01T12:23:35Z", "creator": "wrowe@apache.org", "creation_time": "2007-11-01T12:23:35Z", "tags": [], "is_private": false}, {"count": 13, "tags": [], "creator": "wollman+apache@csail.mit.edu", "attachment_id": null, "text": "> Can you differentiate if this is a fast-internal redirect or a straight\n> redirect?\n\nNot sure I know what that means.  Here is what the two request_rec structures\nlook like.  Note that the first one is generated in mod_actions by calling\nap_internal_redirect_handler() and the second one is the original request:\n\n(gdb) p *r\n$2 = {pool = 0x839398, connection = 0x80ba98, server = 0x6ce468, next = 0x0, \n  prev = 0x839408, main = 0x0, \n  the_request = 0x83a9c0 \"GET /16.410/wiki/index.php?title=Special:Preferences\nHTTP/1.1\", assbackwards = 0, proxyreq = 0, header_only = 0, \n  protocol = 0x83aac0 \"HTTP/1.1\", proto_num = 1001, \n  hostname = 0x83aeb8 \"more-courses.csail.mit.edu\", \n  request_time = 1193938941817986, status_line = 0x44efd3 \"200 OK\", \n  status = 200, method = 0x83aa10 \"GET\", method_number = 0, allowed = 0, \n  allowed_xmethods = 0x0, allowed_methods = 0x81d928, sent_bodyct = 1, \n  bytes_sent = 8192, mtime = 0, chunked = 1, range = 0x0, clength = 0, \n  remaining = 0, read_length = 0, read_body = 1, read_chunked = 0, \n  expecting_100 = 0, headers_in = 0x8396e8, headers_out = 0x861668, \n  err_headers_out = 0x83a030, subprocess_env = 0x85af28, notes = 0x81d788, \n  content_type = 0x861450 \"text/html; charset=utf-8\", \n  handler = 0x2b7546f648c8 \"fastcgi-script\", content_encoding = 0x0, \n  content_languages = 0x0, vlist_validator = 0x0, \n  user = 0x840608 \"wollman@MIT.EDU\", ap_auth_type = 0x0, no_cache = 0, \n  no_local_copy = 0, \n  unparsed_uri = 0x85a708\n\"/.php5-cgi/16.410/wiki/index.php?title=Special:Preferences\", uri = 0x85a748\n\"/.php5-cgi/16.410/wiki/index.php\", \n  filename = 0x81e518 \"/usr/bin/php5-cgi\", \n  canonical_filename = 0x81e518 \"/usr/bin/php5-cgi\", \n  path_info = 0x81e3f9 \"/16.410/wiki/index.php\", \n---Type <return> to continue, or q <return> to quit--- \n  args = 0x85a770 \"title=Special:Preferences\", finfo = {pool = 0x839398, \n    valid = 7598448, protection = 1877, filetype = APR_REG, user = 0, \n    group = 0, inode = 283762, device = 2049, nlink = 1, size = 5483216, \n    csize = 8623000, atime = 1193936766000000, mtime = 1183409032000000, \n    ctime = 1193860247000000, fname = 0x81e518 \"/usr/bin/php5-cgi\", \n    name = 0x6b9721 \"/.php5-cgi\", filehand = 0x7fff66fafa30}, parsed_uri = {\n    scheme = 0x0, hostinfo = 0x0, user = 0x0, password = 0x0, hostname = 0x0, \n    port_str = 0x0, path = 0x85a748 \"/.php5-cgi/16.410/wiki/index.php\", \n    query = 0x85a770 \"title=Special:Preferences\", fragment = 0x0, \n    hostent = 0x0, port = 0, is_initialized = 1, dns_looked_up = 0, \n    dns_resolved = 0}, used_path_info = 0, per_dir_config = 0x85b050, \n  request_config = 0x85a790, htaccess = 0x817f00, output_filters = 0x83a908, \n  input_filters = 0x83aed8, proto_output_filters = 0x83a908, \n  proto_input_filters = 0x83aed8, eos_sent = 0}\n(gdb) p r->prev\n$3 = (request_rec *) 0x839408\n(gdb) p *r->prev\n$4 = {pool = 0x839398, connection = 0x80ba98, server = 0x6ce468, \n  next = 0x85a428, prev = 0x0, main = 0x0, \n  the_request = 0x83a9c0 \"GET /16.410/wiki/index.php?title=Special:Preferences\nHTTP/1.1\", assbackwards = 0, proxyreq = 0, header_only = 0, \n  protocol = 0x83aac0 \"HTTP/1.1\", proto_num = 1001, \n  hostname = 0x83aeb8 \"more-courses.csail.mit.edu\", \n  request_time = 1193938941817986, status_line = 0x0, status = 200, \n  method = 0x83aa10 \"GET\", method_number = 0, allowed = 0, \n  allowed_xmethods = 0x0, allowed_methods = 0x8396a8, sent_bodyct = 0, \n  bytes_sent = 0, mtime = 0, chunked = 0, range = 0x0, clength = 0, \n  remaining = 0, read_length = 0, read_body = 0, read_chunked = 0, \n  expecting_100 = 0, headers_in = 0x8396e8, headers_out = 0x839de8, \n  err_headers_out = 0x83a030, subprocess_env = 0x839a68, notes = 0x83a1d0, \n  content_type = 0x83daf8 \"application/x-httpd-fastphp5\", \n  handler = 0x83d980 \"php5-script\", content_encoding = 0x0, \n  content_languages = 0x0, vlist_validator = 0x0, \n  user = 0x819ac0 \"wollman@MIT.EDU\", ap_auth_type = 0x0, no_cache = 0, \n  no_local_copy = 0, \n  unparsed_uri = 0x83aa50 \"/16.410/wiki/index.php?title=Special:Preferences\", \n  uri = 0x83aa88 \"/16.410/wiki/index.php\", \n  filename = 0x83b108 \"/afs/csail.mit.edu/proj/courses/data/16.410/wiki/index.php\", \n  canonical_filename = 0x83b108\n\"/afs/csail.mit.edu/proj/courses/data/16.410/wik---Type <return> to continue, or\nq <return> to quit---\ni/index.php\", path_info = 0x83b03a \"\", \n  args = 0x83aaa0 \"title=Special:Preferences\", finfo = {pool = 0x839398, \n    valid = 7598448, protection = 1604, filetype = APR_REG, user = 12369, \n    group = 12369, inode = 831797006, device = 18, nlink = 1, size = 3218, \n    csize = 0, atime = 1183079954000000, mtime = 1183079954000000, \n    ctime = 1183079954000000, \n    fname = 0x83b000\n\"/afs/csail.mit.edu/proj/courses/data/16.410/wiki/index.php\", name = 0x0,\nfilehand = 0x0}, parsed_uri = {scheme = 0x0, hostinfo = 0x0, \n    user = 0x0, password = 0x0, hostname = 0x0, port_str = 0x0, \n    path = 0x83aa88 \"/16.410/wiki/index.php\", \n    query = 0x83aaa0 \"title=Special:Preferences\", fragment = 0x0, \n    hostent = 0x0, port = 0, is_initialized = 1, dns_looked_up = 0, \n    dns_resolved = 0}, used_path_info = 2, per_dir_config = 0x817f58, \n  request_config = 0x83a370, htaccess = 0x817f00, output_filters = 0x83a8e0, \n  input_filters = 0x83aed8, proto_output_filters = 0x83a8e0, \n  proto_input_filters = 0x83aed8, eos_sent = 0}\n", "id": 110139, "time": "2007-11-01T12:54:07Z", "bug_id": 43738, "creation_time": "2007-11-01T12:54:07Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 43738, "text": "Oops, I should have noticed that that was a GET request that I tripped over\nwhile debugging, rather than the POST requests that are the problem.  I'll try\nto grab another dump from the right request.", "count": 14, "id": 110140, "time": "2007-11-01T12:56:36Z", "creator": "wollman+apache@csail.mit.edu", "creation_time": "2007-11-01T12:56:36Z", "is_private": false}, {"count": 15, "tags": [], "bug_id": 43738, "text": "Here's a better example:\n\n(gdb) p *r\n$3 = {pool = 0x817ca8, connection = 0x80ba98, server = 0x6ce468, next = 0x0, \n  prev = 0x817d18, main = 0x0, \n  the_request = 0x8192d0 \"POST /16.410/wiki/index.php?title=Special:Preferences\nHTTP/1.1\", assbackwards = 0, proxyreq = 0, header_only = 0, \n  protocol = 0x8193d0 \"HTTP/1.1\", proto_num = 1001, \n  hostname = 0x819898 \"more-courses.csail.mit.edu\", \n  request_time = 1193947551567157, status_line = 0x0, status = 200, \n  method = 0x819320 \"POST\", method_number = 2, allowed = 0, \n  allowed_xmethods = 0x0, allowed_methods = 0x84a5b8, sent_bodyct = 0, \n  bytes_sent = 0, mtime = 0, chunked = 0, range = 0x0, clength = 0, \n  remaining = 528, read_length = 0, read_body = 1, read_chunked = 0, \n  expecting_100 = 0, headers_in = 0x817ff8, headers_out = 0x843ea0, \n  err_headers_out = 0x818940, subprocess_env = 0x8440e8, notes = 0x84a418, \n  content_type = 0x83daf8 \"application/x-httpd-fastphp5\", \n  handler = 0x2b7546f648c8 \"fastcgi-script\", content_encoding = 0x0, \n  content_languages = 0x0, vlist_validator = 0x0, \n  user = 0x840608 \"wollman@MIT.EDU\", ap_auth_type = 0x0, no_cache = 0, \n  no_local_copy = 0, \n  unparsed_uri = 0x8438c8\n\"/.php5-cgi/16.410/wiki/index.php?title=Special:Preferences\", uri = 0x843908\n\"/.php5-cgi/16.410/wiki/index.php\", \n  filename = 0x84b1a8 \"/usr/bin/php5-cgi\", \n  canonical_filename = 0x84b1a8 \"/usr/bin/php5-cgi\", \n  path_info = 0x84b089 \"/16.410/wiki/index.php\", \n---Type <return> to continue, or q <return> to quit--- \n  args = 0x843930 \"title=Special:Preferences\", finfo = {pool = 0x817ca8, \n    valid = 7598448, protection = 1877, filetype = APR_REG, user = 0, \n    group = 0, inode = 283762, device = 2049, nlink = 1, size = 5483216, \n    csize = 8486056, atime = 1193936766000000, mtime = 1183409032000000, \n    ctime = 1193860247000000, fname = 0x84b1a8 \"/usr/bin/php5-cgi\", \n    name = 0x6b9721 \"/.php5-cgi\", filehand = 0x7fff66fafa30}, parsed_uri = {\n    scheme = 0x0, hostinfo = 0x0, user = 0x0, password = 0x0, hostname = 0x0, \n    port_str = 0x0, path = 0x843908 \"/.php5-cgi/16.410/wiki/index.php\", \n    query = 0x843930 \"title=Special:Preferences\", fragment = 0x0, \n    hostent = 0x0, port = 0, is_initialized = 1, dns_looked_up = 0, \n    dns_resolved = 0}, used_path_info = 0, per_dir_config = 0x844210, \n  request_config = 0x843950, htaccess = 0x82c5a0, output_filters = 0x8191f0, \n  input_filters = 0x8198b8, proto_output_filters = 0x8191f0, \n  proto_input_filters = 0x8198b8, eos_sent = 0}\n(gdb) p *r->prev\n$4 = {pool = 0x817ca8, connection = 0x80ba98, server = 0x6ce468, \n  next = 0x8435e8, prev = 0x0, main = 0x0, \n  the_request = 0x8192d0 \"POST /16.410/wiki/index.php?title=Special:Preferences\nHTTP/1.1\", assbackwards = 0, proxyreq = 0, header_only = 0, \n  protocol = 0x8193d0 \"HTTP/1.1\", proto_num = 1001, \n  hostname = 0x819898 \"more-courses.csail.mit.edu\", \n  request_time = 1193947551567157, status_line = 0x0, status = 200, \n  method = 0x819320 \"POST\", method_number = 2, allowed = 0, \n  allowed_xmethods = 0x0, allowed_methods = 0x817fb8, sent_bodyct = 0, \n  bytes_sent = 0, mtime = 0, chunked = 0, range = 0x0, clength = 0, \n  remaining = 0, read_length = 0, read_body = 0, read_chunked = 0, \n  expecting_100 = 0, headers_in = 0x817ff8, headers_out = 0x8186f8, \n  err_headers_out = 0x818940, subprocess_env = 0x818378, notes = 0x818ae0, \n  content_type = 0x83daf8 \"application/x-httpd-fastphp5\", \n  handler = 0x83d980 \"php5-script\", content_encoding = 0x0, \n  content_languages = 0x0, vlist_validator = 0x0, \n  user = 0x82e1d8 \"wollman@MIT.EDU\", ap_auth_type = 0x0, no_cache = 0, \n  no_local_copy = 0, \n  unparsed_uri = 0x819360 \"/16.410/wiki/index.php?title=Special:Preferences\", \n  uri = 0x819398 \"/16.410/wiki/index.php\", \n  filename = 0x819ae8 \"/afs/csail.mit.edu/proj/courses/data/16.410/wiki/index.php\", \n  canonical_filename = 0x819ae8\n\"/afs/csail.mit.edu/proj/courses/data/16.410/wik---Type <return> to continue, or\nq <return> to quit--- \ni/index.php\", path_info = 0x819a1a \"\", \n  args = 0x8193b0 \"title=Special:Preferences\", finfo = {pool = 0x817ca8, \n    valid = 7598448, protection = 1604, filetype = APR_REG, user = 12369, \n    group = 12369, inode = 831797006, device = 18, nlink = 1, size = 3218, \n    csize = 0, atime = 1183079954000000, mtime = 1183079954000000, \n    ctime = 1183079954000000, \n    fname = 0x8199e0\n\"/afs/csail.mit.edu/proj/courses/data/16.410/wiki/index.php\", name = 0x0,\nfilehand = 0x0}, parsed_uri = {scheme = 0x0, hostinfo = 0x0, \n    user = 0x0, password = 0x0, hostname = 0x0, port_str = 0x0, \n    path = 0x819398 \"/16.410/wiki/index.php\", \n    query = 0x8193b0 \"title=Special:Preferences\", fragment = 0x0, \n    hostent = 0x0, port = 0, is_initialized = 1, dns_looked_up = 0, \n    dns_resolved = 0}, used_path_info = 2, per_dir_config = 0x82c5f8, \n  request_config = 0x818c80, htaccess = 0x82c5a0, output_filters = 0x8191f0, \n  input_filters = 0x82e1a0, proto_output_filters = 0x8191f0, \n  proto_input_filters = 0x8198b8, eos_sent = 0}\n", "id": 110142, "time": "2007-11-01T13:07:02Z", "creator": "wollman+apache@csail.mit.edu", "creation_time": "2007-11-01T13:07:02Z", "is_private": false, "attachment_id": null}, {"count": 16, "tags": [], "bug_id": 43738, "text": "And I can now confirm that the head of the input filter chain for the original\nrequest is \"ssl/tls buffer\":\n\n(gdb) p *r->prev->input_filters\n$7 = {frec = 0x6333b8, ctx = 0x84b760, next = 0x858e18, r = 0x857278, \n  c = 0x80ba98}\n(gdb) p *r->prev->input_filters->frec\n$8 = {name = 0x628a18 \"ssl/tls buffer\", filter_func = {\n    out_func = 0x2b7547f58370 <ssl_io_filter_buffer>, \n    in_func = 0x2b7547f58370 <ssl_io_filter_buffer>}, filter_init_func = 0, \n  ftype = 29, next = 0x0, providers = 0x0, debug = 0, proto_flags = 0}\n", "id": 110143, "time": "2007-11-01T13:16:40Z", "creator": "wollman+apache@csail.mit.edu", "creation_time": "2007-11-01T13:16:40Z", "is_private": false, "attachment_id": null}, {"count": 17, "attachment_id": null, "bug_id": 43738, "text": "Here's the full filter chain for both requests:\n\n(gdb) dump_filters r->input_filters\nhttp_in(0x81e8d8): ctx=0x85b050, r=0x818eb8, c=0x80ba98\nssl/tls filter(0x816ce8): ctx=0x814c98, r=0x0, c=0x80ba98\nlog_input_output(0x80c240): ctx=0x0, r=0x0, c=0x80ba98\ncore_in(0x816d90): ctx=0x816d70, r=0x0, c=0x80ba98\n(gdb) dump_filters r->prev->input_filters\nssl/tls buffer(0x85b070): ctx=0x85b020, r=0x81cd38, c=0x80ba98\nhttp_in(0x81e8d8): ctx=0x85b050, r=0x818eb8, c=0x80ba98\nssl/tls filter(0x816ce8): ctx=0x814c98, r=0x0, c=0x80ba98\nlog_input_output(0x80c240): ctx=0x0, r=0x0, c=0x80ba98\ncore_in(0x816d90): ctx=0x816d70, r=0x0, c=0x80ba98\n", "id": 110144, "time": "2007-11-01T13:18:42Z", "creator": "wollman+apache@csail.mit.edu", "creation_time": "2007-11-01T13:18:42Z", "tags": [], "is_private": false}, {"attachment_id": 21080, "tags": [], "bug_id": 43738, "text": "Created attachment 21080\nworking fix\n\nHere's a tested fix.  Moving the filter to AP_FTYPE_PROTOCOL is the right thing\nto do; there were a few tricks needed to getting this working though.\n\nFurther testing welcome!", "count": 18, "id": 110165, "time": "2007-11-02T06:33:54Z", "creator": "jorton@redhat.com", "creation_time": "2007-11-02T06:33:54Z", "is_private": false}, {"count": 19, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "text": "Fixed on trunk as per attached patch with only comment tweaks:\n\nhttp://svn.apache.org/viewvc?rev=591393&view=rev\n\nResults from testing still desirable!\n\n", "id": 110183, "time": "2007-11-02T09:51:15Z", "bug_id": 43738, "creation_time": "2007-11-02T09:51:15Z", "is_private": false}, {"count": 20, "tags": [], "creator": "wollman+apache@csail.mit.edu", "attachment_id": null, "text": "It appears to work on my test server.\n", "id": 110186, "time": "2007-11-02T13:02:00Z", "bug_id": 43738, "creation_time": "2007-11-02T13:02:00Z", "is_private": false}, {"count": 21, "tags": [], "bug_id": 43738, "text": "Great, thanks a lot for the testing and debugging work.", "id": 110239, "time": "2007-11-05T03:20:17Z", "creator": "jorton@redhat.com", "creation_time": "2007-11-05T03:20:17Z", "is_private": false, "attachment_id": null}, {"count": 22, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "text": "Proposed for backport in r608076.", "id": 112434, "time": "2008-01-02T03:00:15Z", "bug_id": 43738, "creation_time": "2008-01-02T03:00:15Z", "is_private": false}, {"count": 23, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "text": "Merged for 2.2.x: http://svn.apache.org/viewvc?view=rev&revision=608787", "id": 112482, "time": "2008-01-04T02:04:45Z", "bug_id": 43738, "creation_time": "2008-01-04T02:04:45Z", "is_private": false}, {"count": 24, "tags": [], "bug_id": 43738, "text": "*** Bug 46809 has been marked as a duplicate of this bug. ***", "id": 125376, "time": "2009-03-06T02:41:24Z", "creator": "jorton@redhat.com", "creation_time": "2009-03-06T02:41:24Z", "is_private": false, "attachment_id": null}]