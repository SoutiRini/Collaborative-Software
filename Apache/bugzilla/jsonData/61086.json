[{"count": 0, "tags": [], "bug_id": 61086, "attachment_id": 34992, "text": "Created attachment 34992\nExemple standalone servlet to give out HTTP 205 response\n\nWhen a servlet running on Tomcat sends a response over HTTP with status 205 Reset Content, some clients hang with this response and just wait for it to \"complete\" after Tomcat considers it fully done.\n\nSo far I've identified two clients:\n- command line program curl, version 7.52.1,\n- Jersey client, version 1.19.1.\n\nUsing Tomcat 8.5.15 (latest release), but the issue was here for as long as I went back and it seems still here in Tomcat 9.\n\nDebugging the HTTP communication shows it has to do with the fact that the response has no body (which is correct, as mandated by RFC for status 205), and no indication of content length to explicitly say that there is no body. That last part is incorrect behavior according to RFC 7231 section 6.3.6:\n\n   \" Since the 205 status code implies that no additional content will be provided, a server MUST NOT generate a payload in a 205 response.  In other words, a server MUST do one of the following for a 205 response: a) indicate a zero-length body for the response by including a Content-Length header field with a value of 0; b) indicate a zero-length payload for the response by including a Transfer-Encoding header field with a value of chunked and a message body consisting of a single chunk of zero-length; or, c) close the connection immediately after sending the blank line terminating the header section. \"\n\nIt seems the HTTP clients I've identified, do rely on this requirement stated by RFC. Testing with servers that do add a Content-Length: 0 header or a Transfer-encoding chunked with a zero-length chunk with a status 205, these clients behave as expected. Also note, that Tomcat will typically eventually reach its keep-alive timeout and close the connection. Which is actually a valid way to end the response, and these clients do accept it when they don't reach their own timeouts. It's just the response takes by default 20 seconds to be finished, and is done with closing a perfectly re-usable connection.\n\nSteps to reproduce:\n\n (1) Have a clean Tomcat install version 8.5.15\n\n (2) Deploy on it a root webapp that responds to requests with\n     HTTP status 205.\n\n     You can use the standalone servlet class I put in attachment.\n     As can be seen, it responds to all requests with status 205,\n     and it adds a custom header just to be sure the response comes\n     from this servlet.\n\n (3) Make an HTTP request to it with curl.\n\n     Response looks like:\n\n$ curl -v http://localhost:8080\n* STATE: INIT => CONNECT handle 0x6000578f0; line 1413 (connection #-5000)\n* Rebuilt URL to: http://localhost:8080/\n* Added connection 0. The cache now contains 1 members\n*   Trying 127.0.0.1...\n* TCP_NODELAY set\n* STATE: CONNECT => WAITCONNECT handle 0x6000578f0; line 1466 (connection #0)\n* Connected to localhost (127.0.0.1) port 8080 (#0)\n* STATE: WAITCONNECT => SENDPROTOCONNECT handle 0x6000578f0; line 1583 (connection #0)\n* Marked for [keep alive]: HTTP default\n* STATE: SENDPROTOCONNECT => DO handle 0x6000578f0; line 1601 (connection #0)\n> GET / HTTP/1.1\n> Host: localhost:8080\n> User-Agent: curl/7.52.1\n> Accept: */*\n>\n* STATE: DO => DO_DONE handle 0x6000578f0; line 1680 (connection #0)\n* STATE: DO_DONE => WAITPERFORM handle 0x6000578f0; line 1807 (connection #0)\n* STATE: WAITPERFORM => PERFORM handle 0x6000578f0; line 1817 (connection #0)\n* HTTP 1.1 or later with persistent connection, pipelining supported\n< HTTP/1.1 205\n< x-mmar-servletname: return205\n< Date: Thu, 11 May 2017 15:43:26 GMT\n* no chunk, no close, no size. Assume close to signal end\n* Marked for [closure]: HTTP: No end-of-message indicator\n<\n* STATE: PERFORM => DONE handle 0x6000578f0; line 1981 (connection #0)\n* multi_done\n* Curl_http_done: called premature == 0\n* Closing connection 0\n* The cache now contains 0 members\n\n     curl hangs for a while after \"Marked for [closure]: HTTP: No end-of-message indicator\".\n     Then after 20 seconds Tomcat reaches connection\n     keep-alive timeout, closes the connection and curl\n     accepts it as a valid way to finish the response.\n\nProposed (naive) patch:\n\nI have located the cause for this behavior, in class\norg.apache.coyote.http11.Http11Processor\nin line 1144.\nStatus 205 is treated the same way as 204 and 304,\nthat is to say no body as mandated by RFC,\nbut also no content length information.\n\nThe naive patch attached just removes 205 from those,\nwhich solves the issue with the problematic clients.\nHowever it makes it possible to add a body to a\n205 response, and it becomes the webapp's author's\nresponsibility to not do that.\n\nAnother, possibly better, approach, could be to\nhave a special case for 205 only, where it\nwould ignore any attempt to put a content,\nbut it would add the header Content-Length: 0.", "id": 198765, "time": "2017-05-11T20:29:50Z", "creator": "mayeul.marguet@synchronoss.com", "creation_time": "2017-05-11T20:29:50Z", "is_private": false}, {"count": 1, "attachment_id": 34993, "creator": "mayeul.marguet@synchronoss.com", "text": "Created attachment 34993\nNaive patch to remove 205 from the status without content", "id": 198766, "time": "2017-05-11T20:31:42Z", "bug_id": 61086, "creation_time": "2017-05-11T20:31:42Z", "tags": [], "is_private": false}, {"count": 2, "attachment_id": null, "creator": "markt@apache.org", "text": "Thanks for the report.\n\nThis has been fixed by explicitly setting content length to zero for 205 responses.\n\nThis has been fixed in:\n- 9.0.x for 9.0.0.M22 onwards\n- 8.5.x for 8.5.16 onwards\n- 8.0.x for 8.0.45 onwards\n- 7.0.x for 7.0.79 onwards", "id": 198800, "time": "2017-05-16T11:12:31Z", "bug_id": 61086, "creation_time": "2017-05-16T11:12:31Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 61086, "attachment_id": null, "text": "Still reproducable on 8.5.16-19.\n\norg.apache.coyote.http11.Http11Processor\n...\n1129 entityBody = false;\n1130 contentDelimitation = true;\n1131 if (statusCode == 205) {\n1132    // RFC 7231 requires the server to explicitly signal an empty\n1133    // response in this case\n1134    response.setContentLength(0);\n1135 }\n...\n1166 if (!entityBody) {\n1167    response.setContentLength(-1);\n1168 }\n \nExplicitly setting contentLength(0) in 1134 overrides by 1167, so response doesn't contain Content-Length header.", "id": 200040, "time": "2017-07-26T09:35:57Z", "creator": "mthur@yandex.ru", "creation_time": "2017-07-26T09:35:57Z", "is_private": false}, {"count": 4, "tags": [], "creator": "mthur@yandex.ru", "text": "Created attachment 35175\nPatch 0-length content for 205 status", "id": 200042, "time": "2017-07-26T09:50:12Z", "bug_id": 61086, "creation_time": "2017-07-26T09:50:12Z", "is_private": false, "attachment_id": 35175}, {"count": 5, "tags": [], "creator": "violetagg@apache.org", "text": "Hi,\n\n(In reply to Alexandr Saperov from comment #4)\n> Created attachment 35175 [details]\n> Patch 0-length content for 205 status\n\nWould you mind to add a test case also?\n\nThanks,\nVioleta", "id": 200043, "time": "2017-07-26T09:52:06Z", "bug_id": 61086, "creation_time": "2017-07-26T09:52:06Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 61086, "attachment_id": 35179, "text": "Created attachment 35179\nstandalone application with embedded tomcat\n\nBuilding standalone application with embedded tomcat:\nmvn clean package\n\nrunning application:\njava -jar target/tomcat-61086-1.0-SNAPSHOT.jar\n\nMaking request with curl:\ncurl -v \"localhost:8080/\"\n\ncurl hangs for 1 minute (default timeout)", "id": 200050, "time": "2017-07-26T11:57:48Z", "creator": "mthur@yandex.ru", "creation_time": "2017-07-26T11:57:48Z", "is_private": false}, {"count": 7, "tags": [], "creator": "violetagg@apache.org", "attachment_id": null, "id": 200129, "time": "2017-08-01T07:59:47Z", "bug_id": 61086, "creation_time": "2017-08-01T07:59:47Z", "is_private": false, "text": "Hi,\n\nThanks for the patch and the test - see r1803616.\n\nThis has been fixed in:\n- 9.0.x for 9.0.0.M26 onwards\n- 8.5.x for 8.5.20 onwards\n- 8.0.x for 8.0.46 onwards\n- 7.0.x for 7.0.80 onwards\n\nRegards,\nVioleta"}]