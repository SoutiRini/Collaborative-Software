[{"count": 0, "tags": [], "bug_id": 27985, "is_private": false, "id": 54743, "attachment_id": null, "creator": "haegar@sdinet.de", "creation_time": "2004-03-26T14:50:18Z", "time": "2004-03-26T14:50:18Z", "text": "When using Apache 2.0.49 mod_rewrite with rewrite-maps on proxied requests,\napache applies a false per-dir prefix and garbles the url.\n\nApache 2.0.48 was working as expected.\n\n\nI have the following statements in my httpd.conf (simplified):\n\nRewriteMap      proxy-map       prg:/usr/local/bin/proxy-map\nRewriteMap      local-map       prg:/usr/local/bin/proxy-local-map\n\n<Proxy *>\n        RewriteEngine On\n        RewriteCond %{SERVER_ADDR} ^127\\.0\\.0\n        RewriteRule ^proxy:http://id/$ http://localhost/cgi-bin/id [R,L]\n        RewriteRule ^(.*)$ ${proxy-map:$1|$1}\n        RewriteCond %{SERVER_ADDR} ^127\\.0\\.0\n        RewriteRule ^(.*)$ ${local-map:$1|$1}\n</Proxy>\n\nThe output of RewriteLog on Level 9:\n\n(3) [per-dir */] applying pattern '^proxy:http://id/$' to uri\n'proxy:http://www.apache.org/'\n(3) [per-dir */] applying pattern '^(.*)$' to uri 'proxy:http://www.apache.org/'\n(5) map lookup OK: map=proxy-map key=proxy:http://www.apache.org/ ->\nval=proxy:http://www.apache.org/\n(2) [per-dir */] rewrite proxy:http://www.apache.org/ ->\nproxy:http://www.apache.org/\n(3) [per-dir */] add per-dir prefix: proxy:http://www.apache.org/ ->\n*/proxy:http://www.apache.org/\n(3) [per-dir */] strip per-dir prefix: */proxy:http://www.apache.org/ ->\nproxy:http://www.apache.org/\n(3) [per-dir */] applying pattern '^(.*)$' to uri 'proxy:http://www.apache.org/'\n(4) RewriteCond: input='127.0.0.1' pattern='^127\\.0\\.0' => matched\n(5) map lookup OK: map=local-map key=proxy:http://www.apache.org/ ->\nval=proxy:http://www.apache.org/\n(2) [per-dir */] rewrite proxy:http://www.apache.org/ ->\nproxy:http://www.apache.org/\n(3) [per-dir */] add per-dir prefix: proxy:http://www.apache.org/ ->\n*/proxy:http://www.apache.org/\n\nNothing in the error-log, and only the following in the access-log:\n\n127.0.0.1 - - [26/Mar/2004:15:02:58 +0100] \"GET http://www.apache.org/ HTTP/1.1\"\n400 - \"-\" \"Mozilla/5.0 (X11; U; Linux i686; de-AT; rv:1.6) Gecko/20040312\" 0 \"-\""}, {"count": 1, "tags": [], "bug_id": 27985, "attachment_id": null, "is_private": false, "id": 54764, "time": "2004-03-27T00:03:58Z", "creator": "nd@perlig.de", "creation_time": "2004-03-27T00:03:58Z", "text": "Hrm. That is a problem. mod_rewrite now treats the result string\n'proxy:http://www.apache.org/' as a relative path, which was a bug fix in 2.0.49\n(for some other example, but ...).\n\nFrankly speaking, your rules depend on unsupported API internals, so you cannot\nexpect that they work forever.\n\nAnyway: Can you try what happens if you just take the rules out of the <Proxy>\ncontainer? (That's even the next problem, mod_rewrite was never designed for use\nwithin <Proxy>)."}, {"count": 2, "tags": [], "creator": "haegar@sdinet.de", "attachment_id": null, "id": 54766, "time": "2004-03-27T00:34:48Z", "bug_id": 27985, "creation_time": "2004-03-27T00:34:48Z", "is_private": false, "text": "> Frankly speaking, your rules depend on unsupported API internals\n\nI didn't even know that this setup was unsupported ;)\n\nIt worked with only minor changes (<Location proxy:*> changed to <Proxy *>) from\na  very old apache 1.3 through 2.0.48 without problems.\n\nI will try your suggestion on monday, when I can reach my test-box again.\n"}, {"count": 3, "tags": [], "bug_id": 27985, "attachment_id": null, "is_private": false, "id": 54813, "time": "2004-03-29T13:53:12Z", "creator": "haegar@sdinet.de", "creation_time": "2004-03-29T13:53:12Z", "text": "I just tried your suggestion of placing the RewriteRules outside of <Proxy>:\n\nThe Rules are tested only for local connections, not for connections proxied\nthrough the apache. Thus they are called exactly when I don't need any rewriting.\n\nI'm back to apache 2.0.48 for now.\n"}, {"count": 4, "tags": [], "bug_id": 27985, "attachment_id": null, "text": "Well, thanks. I'm investigating how to fix it somehow.", "id": 54828, "time": "2004-03-29T18:38:18Z", "creator": "nd@perlig.de", "creation_time": "2004-03-29T18:38:18Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 27985, "attachment_id": null, "text": "I've nailed the problem in 2.1 and proposed it for backport into the 2.0 branch.\n\nIf you want to to try it out, here's a patch against 2.0:\n<http://cvs.apache.org/~nd/mod_rewrite.c.patch>", "id": 54840, "time": "2004-03-29T22:06:57Z", "creator": "nd@perlig.de", "creation_time": "2004-03-29T22:06:57Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 27985, "is_private": false, "id": 54973, "attachment_id": null, "creator": "haegar@sdinet.de", "creation_time": "2004-03-31T16:15:15Z", "time": "2004-03-31T16:15:15Z", "text": "Just a small follow-up:\n\nYour patch fixes my problems with 2.0.49, the rewrite/filter rules are working\nagain.\n\nThanks a lot.\n"}, {"count": 7, "tags": [], "creator": "nd@perlig.de", "text": "Thanks for the feedback :-)", "id": 55092, "time": "2004-04-01T18:53:15Z", "bug_id": 27985, "creation_time": "2004-04-01T18:53:15Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "haegar@sdinet.de", "text": "This bug is in 2.0.50 too, and the same patch as for 2.0.49 still fixes it.\n", "id": 60537, "time": "2004-07-13T10:19:00Z", "bug_id": 27985, "creation_time": "2004-07-13T10:19:00Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "text": "Well, the fix was finally reviewed and will be in 2.0.51.", "is_private": false, "bug_id": 27985, "id": 62569, "time": "2004-08-27T07:42:24Z", "creator": "nd@perlig.de", "creation_time": "2004-08-27T07:42:24Z", "attachment_id": null}]