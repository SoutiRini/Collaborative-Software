[{"count": 0, "tags": [], "bug_id": 56727, "attachment_id": null, "text": "I have one Custom Linux board on which I want to run apache web server (httpd) to test HTML and other web based pages.\n\nI have configured, cross compiled and installed httpd (2.2.24, 2.4.1, 2.4.4 and 2.4.9 packages) on my Linux PC (Ubuntu 12.04 LTS) as well as\non my own custom Linux board. Then I have added support of SSL Module (mod_ssl) to test HTTP as well as HTTPS request.\n\nBoth HTTP and HTTPS request works fine without any issue on my Linux PC (Ubuntu 12.04 LTS). But when I tried to execute same HTTP request\non my Linux Board using httpd (2.4.4 and 2.4.9 with SSL Module Enabled) at that time browser page goes into loading state and can not be came out from that situation.\nAlso I have seen that HTTPS request works fine at that time.\n\nI have also did some debugging task through wire-shark tool and found that connection is established successfully after sending request through HTTP\nbut can not get response of that request. I have also found that response of that HTTP request received on wire-shark after closing that HTTP\nrequested page from browser.\n\nAlso, I can run HTTP and HTTPS requests successfully using httpd (2.2.24 and 2.2.27 with SSL Module enabled) on my Linux Board as well but failed to execute same request\nusing httpd (2.4.X with SSL Module enabled) package.\n\nI have also changed some configurations by creating different virtual host for HTTP (Port 80) and HTTPS (Port 443) but still failed to\nexecute that HTTP request.\n\nI have also tried to listen on different ports like (Listen 80 and Listen 8000) without SSL module (using httpd 2.4.4. and 2.4.9 ) at that\ntime HTTP request goes into loading state.\n\nDoes anyone has idea about this issue or help me to solve this type of issue?", "id": 176415, "time": "2014-07-16T11:00:59Z", "creator": "ritesh.prajapati@slscorp.com", "creation_time": "2014-07-16T11:00:59Z", "is_private": false}, {"count": 1, "tags": [], "creator": "ritesh.prajapati@slscorp.com", "attachment_id": null, "is_private": false, "id": 176527, "time": "2014-07-19T05:49:45Z", "bug_id": 56727, "creation_time": "2014-07-19T05:49:45Z", "text": "I have also added following flags in configuration script of httpd to solve that issue but still failed to execute HTTP request.\n\nac_cv_file__dev_zero=yes ac_cv_func_setpgrp_void=yes\napr_cv_process_shared_works=yes apr_cv_mutex_robust_shared=no\napr_cv_tcp_nodelay_with_cork=yes apr_cv_mutex_recursive=yes\nap_cv_void_ptr_lt_long=no ac_cv_sizeof_struct_iovec=8 ac_cv_struct_rlimit=yes \\\nac_cv_o_nonblock_inherited=no\n\n\n\nI have also debug httpd process using starce and found that read system call goe into blocking state which never returns.\n\n$ ./strace -p 1811\nProcess 1811 attached\nrestart_syscall(<... resuming interrupted call ...>) = 0\npoll([{fd=6, events=POLLIN}, {fd=4, events=POLLIN}], 2, 10000) = 0 (Timeout)\npoll([{fd=6, events=POLLIN}, {fd=4, events=POLLIN}], 2, 10000) = 0 (Timeout)\npoll([{fd=6, events=POLLIN}, {fd=4, events=POLLIN}], 2, 10000) = 1 ([{fd=4, revents=POLLIN}])\naccept(4, {sa_family=AF_INET6, sin6_port=htons(40827), inet_pton(AF_INET6, \"::ffff:192.168.0.45\", &sin6_addr), sin6_flowinfo=0, sin6_scope_id=0}, [28]) = 11\nfcntl64(11, F_GETFD)                    = 0\nfcntl64(11, F_SETFD, FD_CLOEXEC)        = 0\nsemop(950296, {{0, 1, SEM_UNDO}}, 1)    = 0\ngettimeofday({1405747420, 372062}, NULL) = 0\ngetsockname(11, {sa_family=AF_INET6, sin6_port=htons(80), inet_pton(AF_INET6, \"::ffff:192.168.0.183\", &sin6_addr), sin6_flowinfo=0, sin6_scope_id=0}, [28]) = 0\ngettimeofday({1405747420, 374162}, NULL) = 0\ngettimeofday({1405747420, 374976}, NULL) = 0\nread(11, \"GET / HTTP/1.1\\r\\nHost: 192.168.0.\"..., 8000) = 289\ngettimeofday({1405747420, 377850}, NULL) = 0\ngettimeofday({1405747420, 380080}, NULL) = 0\ngettimeofday({1405747420, 382529}, NULL) = 0\ngettimeofday({1405747420, 384638}, NULL) = 0\ngettimeofday({1405747420, 386798}, NULL) = 0\ngettimeofday({1405747420, 388903}, NULL) = 0\ngettimeofday({1405747420, 390971}, NULL) = 0\ngettimeofday({1405747420, 393006}, NULL) = 0\ngettimeofday({1405747420, 395390}, NULL) = 0\ngettimeofday({1405747420, 397474}, NULL) = 0\nstat64(\"/usr/local/apache2/htdocs/\", {st_mode=S_IFDIR|0777, st_size=4096, ...}) = 0\nstat64(\"/usr/local/apache2/htdocs/index.html\", {st_mode=S_IFREG|0777, st_size=45, ...}) = 0\nopen(\"/usr/local/apache2/htdocs/index.html\", O_RDONLY|O_CLOEXEC) = 12\nopen(\"/etc/localtime\", O_RDONLY)        = 13\nfstat64(13, {st_mode=S_IFREG|0644, st_size=127, ...}) = 0\nfstat64(13, {st_mode=S_IFREG|0644, st_size=127, ...}) = 0\nold_mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x2a01d000\nread(13, \"TZif2\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\1\\0\\0\\0\\1\\0\\0\\0\\0\"..., 4096) = 127\n_llseek(13, -11, [116], SEEK_CUR)       = 0\nread(13, \"\\n<GMT-8>-8\\n\", 4096)         = 11\nclose(13)                               = 0\nmunmap(0x2a01d000, 4096)                = 0\ngettimeofday({1405747420, 441452}, NULL) = 0\nread(11, \n\nPlease let me know if anyone has idea about this issue or any work arounds for that."}, {"count": 2, "tags": [], "creator": "mike.rumph@oracle.com", "attachment_id": null, "is_private": false, "id": 176541, "time": "2014-07-20T15:23:28Z", "bug_id": 56727, "creation_time": "2014-07-20T15:23:28Z", "text": "This bug appears to be related to bug 51689."}, {"count": 3, "text": "I have already tried with all possible compilation flags as well as some other configurations in httpd compilation process to send HTTP request on multiple ports listen directive but still failed to send HTTP request.\n\nThen I have started debugging task from httpd source code and found that request is stuck in check_pipeline() function of http_request.c file.\n\nThere is one function call \n\"ap_get_brigade(c->input_filters, bb, AP_MODE_SPECULATIVE,APR_NONBLOCK_READ, 1)\" \nin check_pipeline() function which never returns after sending HTTP request with multiple ports Listen directive.\n\nap_get_brigade() function defined in server/util_filter.c file\n\nAP_DECLARE(apr_status_t) ap_get_brigade(ap_filter_t *next,\n                                        apr_bucket_brigade *bb,\n                                        ap_input_mode_t mode,\n                                        apr_read_type_e block,\n                                        apr_off_t readbytes)\n{\n    if (next) {\n        return next->frec->filter_func.in_func(next, bb, mode, block,\n                                               readbytes);\n    }\n    return AP_NOBODY_READ;\n}\n\nSo, This above function call never returns from check_pipeline() function call after sending HTTP request on multiple port Listen.\n\nPlease let me know if any one has idea about this problem.", "bug_id": 56727, "is_private": false, "id": 176552, "time": "2014-07-21T04:54:36Z", "creator": "ritesh.prajapati@slscorp.com", "creation_time": "2014-07-21T04:54:36Z", "tags": [], "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 56727, "attachment_id": null, "is_private": false, "id": 176556, "time": "2014-07-21T07:24:52Z", "creator": "ritesh.prajapati@slscorp.com", "creation_time": "2014-07-21T07:24:52Z", "text": "I have debugged ap_get_brigade() function in details from httpd source code and found that it executes ap_core_input_filter() function from core_filters.c file.\n\nThen, I have looked into ap_core_input_filter() function definition and found that HTTP request execution with multiple listen ports stuck after calling apr_input_read() function which is called from ap_core_input_filter() API.\n\nAfter that, I have looked for apr_read_bucket() function definition which is defined as read() system call in apr_buckets.h file of Apr-Util Package.\n\n#define apr_bucket_read(e,str,len,block) (e)->type->read(e, str, len, block)\n\nI have also downgraded and tested Apr and Apr-Util packages from 1.5.X to 1.4.X but still failed to execute HTTP request on multiple listen ports.\n\nPlease let me know if any one knows about this issue."}, {"count": 5, "tags": [], "creator": "ritesh.prajapati@slscorp.com", "attachment_id": null, "is_private": false, "id": 176563, "time": "2014-07-21T13:49:15Z", "bug_id": 56727, "creation_time": "2014-07-21T13:49:15Z", "text": "I have also found while debugging apr_bucket_read() function that read() system call executed from apr_socket_recv() function (network_io/unix/sendrecv.c file of Apr Package) blocks HTTP request after listening on multiple ports. \n\n\napr_status_t apr_socket_recv(apr_socket_t *sock, char *buf, apr_size_t *len)\n{\n    apr_ssize_t rv;\n    apr_status_t arv;\n\n    if (sock->options & APR_INCOMPLETE_READ) {\n        sock->options &= ~APR_INCOMPLETE_READ;\n        goto do_select;\n    }\n\n    do {\n        rv = read(sock->socketdes, buf, (*len));  ---> Never return from Here\n    } while (rv == -1 && errno == EINTR);\n\n\nThat apr_socket_recv() function is called from socket_bucket_read() function of Apr-Util source package (buckets/apr_buckets_socket.c file).\n\nAnd that socket_bucket_read() function is called from ap_get_brigade() API (util_filters.c file) of http source package to read data from bucket.\n\nSo, this issue is caused while reading data from bucket from httpd->Apr-Util->Apr when sending HTTP request on multiple Listen Ports.\n\nWe have also checked NON_Block Mode using apr_is_option_set() function and it gives that APR mode is set as NON_Block Mode but still HTTP request never returns from that read() system call of apr_socket_recv() function.\n\nPlease let me know if any one has idea about this."}, {"count": 6, "tags": [], "bug_id": 56727, "attachment_id": null, "is_private": false, "id": 176590, "time": "2014-07-22T12:26:12Z", "creator": "ritesh.prajapati@slscorp.com", "creation_time": "2014-07-22T12:26:12Z", "text": "We have debugged code of APR and found that there is one macro defined \n#define APR_O_NONBLOCK_INHERITED 1\nwhich creates problem to create inherited socket as non block from listener socket while requesting HTTP page in multiple Listen Ports.\n\nSo, We have set ac_cv_o_nonblock_inherited=no in configuration options of APR Package and tested HTTP request on multiple Listen ports as well as enabling SSL Modules which works fine without any issue."}, {"count": 7, "text": "APR should have some hints for cross-compiling.  Let's leave this open for now and assign to APR.", "bug_id": 56727, "is_private": false, "id": 176620, "time": "2014-07-23T11:57:26Z", "creator": "trawick@apache.org", "creation_time": "2014-07-23T11:57:26Z", "tags": [], "attachment_id": null}]