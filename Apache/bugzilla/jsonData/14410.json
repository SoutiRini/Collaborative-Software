[{"count": 0, "tags": [], "creator": "detlev.vendt@brillit.de", "attachment_id": null, "is_private": false, "id": 26003, "time": "2002-11-09T15:34:26Z", "bug_id": 14410, "creation_time": "2002-11-09T15:34:26Z", "text": "Following the calls thru mod_isapi.c for HSE_REQ_SEND_RESPONSE_HEADER shows, \nthat the call to ap_scan_script_header_err_strs() (what itself calls \nap_scan_script_header_err_core) will _always_ cause that cid->r->status gets \nthe value of 500. The resulting output give 'OK' with an additional Internal \nserver error message'\n\nThe reason for that is the last parameter given to \nap_scan_script_header_err_strs() as NULL. ap_scan_script_header_err_core() \nchecks all the parameters for zero and returns an internal server error (with \nlog 'Premature end of script headers' if one is NULL.\n\nInserting a 'fake' parameter \"\\r\\n\" will cause a normal behaviour w/o \ngenerating err 500. Please refer to the code snippet below.\n\n    /* Seems IIS does not enforce the requirement for \\r\\n termination \n     * on HSE_REQ_SEND_RESPONSE_HEADER, but we won't panic... \n     * ap_scan_script_header_err_strs handles this aspect for us.\n     *\n     * Parse them out, or die trying \n     */\n    if (stat) {\n        cid->r->status = ap_scan_script_header_err_strs(cid->r, NULL, \n            &termch, &termarg, stat, head, \"\\r\\n\", NULL);\n        cid->ecb->dwHttpStatusCode = cid->r->status;\n    }\n    else {\n        cid->r->status = ap_scan_script_header_err_strs(cid->r, NULL, \n            &termch, &termarg, head, \"\\r\\n\", NULL);"}, {"count": 1, "tags": [], "bug_id": 14410, "attachment_id": null, "text": "I have played around a bit more with that, and now I'm absolutely confused...\n\n1) I found a situation in debugger, where ap_scan_script_header_err_core() will \nreturn zero (not causing an error 500 (in cid->r->status )...)\n\n2) I found some strange behaviour on using TransmitFile(), what looks like 1). \nHere the first request is served well (my picture appears :), any subsequent \nrequest hangs or gives the knows status 'OK' with an internal server error. \nTransmitFile-Call is called this way:\n\nDWORD dwLength = GetFileSize(hFile, NULL);\nDWORD dwFlags  = HSE_IO_DISCONNECT_AFTER_SEND | HSE_IO_SEND_HEADERS; \nstrHeader.Format( \n   _T(\"HTTP/1.1 200 OK\\r\\nContent-Type: %s\\r\\nContent-Length: %d\\r\\n\"), \n   pstrContentType, dwLength); \n\nbResult = pCtxt->TransmitFile(hFile, dwFlags, \n   (LPVOID)(LPCTSTR) strHeader); \n", "id": 26018, "time": "2002-11-09T22:00:25Z", "creator": "detlev.vendt@brillit.de", "creation_time": "2002-11-09T22:00:25Z", "is_private": false}, {"count": 2, "tags": [], "creator": "wrowe@apache.org", "attachment_id": null, "is_private": false, "id": 26022, "time": "2002-11-10T04:53:05Z", "bug_id": 14410, "creation_time": "2002-11-10T04:53:05Z", "text": "\n  Outch, you can't do this : HSE_IO_DISCONNECT_AFTER_SEND \n\n  That's how you've busted it.  Try removing that flag.\n\n  If removing that flag clears the bug, I'll be filtering out that flag\n  if it's hung around all the way into TransmitFile.\n\n  You also have to open the file for overlapped I/O.  If you didn't do so,\n  I know of no way to detect and correct the problem."}, {"count": 3, "attachment_id": null, "creator": "detlev.vendt@brillit.de", "is_private": false, "id": 26026, "time": "2002-11-10T09:26:55Z", "bug_id": 14410, "creation_time": "2002-11-10T09:26:55Z", "tags": [], "text": "Thanks for advise, but it didn't help. \n- I have removed HSE_IO_DISCONNECT_AFTER_SEND (no effect at all)\n- I have checked the CreateFile-Call, FILE_FLAG_OVERLAPPED is in use."}, {"count": 4, "attachment_id": null, "creator": "detlev.vendt@brillit.de", "text": "The problem regarding ap_scan_script_header_err_strs() in mod_isapi still \nremains. I'm not able to get senseful response w/o a patch.\n\nSome new informations regarding behaviour of TransmitFile(): the MS ISAPI will \nset HSE_STATUS_PENDING even if HSE_IO_ASYNC is _not_ included to Transmitfile\n(). Setting this to HSE_STATUS_SUCCESS after the call to TramsmitFile() will \nsolve the problem.\n\n", "id": 26031, "time": "2002-11-10T12:00:39Z", "bug_id": 14410, "creation_time": "2002-11-10T12:00:39Z", "tags": [], "is_private": false}, {"count": 5, "tags": [], "bug_id": 14410, "attachment_id": null, "text": "Now I got it: the MFC ISAPI requires the following stuff to build a correct \nheader:\n\n// define standard header with correct CR/LF sequence and title\n#define  STARTCONTENT(a)    StartContent(a); \\\n                            AddHeader   (a, _T(\"\\r\\n\")); \\\n                            WriteTitle  (a)\n\nStartContent alone will only create \"content-type ...\\r\\n\".\n\n", "id": 26039, "time": "2002-11-10T21:12:11Z", "creator": "detlev.vendt@brillit.de", "creation_time": "2002-11-10T21:12:11Z", "is_private": false}]