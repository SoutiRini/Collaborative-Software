[{"count": 0, "tags": [], "bug_id": 61604, "is_private": false, "text": "We use a JSP that is included at several points to inject data into pages. At the moment the whole content is commented out.\n\nTomcat 8.5 (production environment) ignores that page, respectively generates no output as expected. Tomcat 9.0.1 (development environment) throws an IllegalstateException. This is caused by a change in SmapStratum, which previously returned null on getString() if lineData was null, now it throws an unhandled exception.\n\nReproduction:\n\nCreate an \"empty\" JSP or one containing only JSP comments and using trimDirectiveWhitespaces=\"true\":\n\n<%@ page pageEncoding=\"UTF-8\" contentType=\"text/html; charset=utf-8\" language=\"java\" import=\"java.util.Vector\" errorPage=\"\" trimDirectiveWhitespaces=\"true\" %>\n<%-- This is a comment --%>\n\nResult:\n\njava.lang.IllegalStateException\n        at org.apache.jasper.compiler.SmapStratum.getSmapStringInternal(SmapStratum.java:318)\n        at org.apache.jasper.compiler.SmapStratum.getSmapString(SmapStratum.java:304)\n        at org.apache.jasper.compiler.SmapUtil.installSmap(SmapUtil.java:145)\n        at org.apache.jasper.compiler.JDTCompiler.generateClass(JDTCompiler.java:473)\n[...]\n\nExpected result:\n\nan empty page", "id": 201387, "time": "2017-10-10T14:34:37Z", "creator": "apache@stefan-sielaff.de", "creation_time": "2017-10-10T14:34:37Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 61604, "is_private": false, "text": "Sorry, of course lineData is not null at that point, it is the empty array causing the exception being thrown.\n\n// print our StratumSection, FileSection, and LineSections\nif (fileNameList.size() == 0 || lineData.size() == 0) {\n  throw new IllegalStateException();\n}", "id": 201388, "time": "2017-10-10T14:57:06Z", "creator": "apache@stefan-sielaff.de", "creation_time": "2017-10-10T14:57:06Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "remm@apache.org", "text": "So this was done during the (major) 49176 enhancement in r1800201.\nSwitching back to returning null will likely cause some NPEs in some cases, but this used to be the case before from what I can see.", "id": 201389, "time": "2017-10-10T15:25:44Z", "bug_id": 61604, "creation_time": "2017-10-10T15:25:44Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "text": "Going back to the SMAP spec, it is legal for there to be zero LineInfo lines so the lineData.size() == 0 test can be removed.\n\nI'll double-check the rest of the spec while I am at it.", "is_private": false, "id": 201398, "creator": "markt@apache.org", "time": "2017-10-10T19:01:01Z", "bug_id": 61604, "creation_time": "2017-10-10T19:01:01Z", "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 61604, "is_private": false, "text": "Thanks for the report. This has been fixed for 9.0.2 onwards.", "id": 201399, "time": "2017-10-10T19:26:59Z", "creator": "markt@apache.org", "creation_time": "2017-10-10T19:26:59Z", "attachment_id": null}]