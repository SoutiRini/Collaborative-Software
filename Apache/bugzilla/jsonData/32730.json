[{"count": 0, "tags": [], "creator": "rd9@donkin.org", "attachment_id": null, "id": 68611, "time": "2004-12-16T12:57:14Z", "bug_id": 32730, "creation_time": "2004-12-16T12:57:14Z", "is_private": false, "text": "Any PATH_INFO string that contains URL-encoded bytes that are not part of a\nvalid UTF-8 sequence causes Apache 2.0.52 on Windows to give an Internal Server\nError 500, and put the following message in the error.log:\n\n   (22)Invalid argument: utf8 to ucs2 conversion failed on this string:\nPATH_INFO=/Main/FromageD\\xe9rap\\xe9\n\nThe URL that generated this was as follows ('view' being the CGI script, no\nmod_perl):\n\n   http://localhost:8080/cgi-bin/view/Main/FromageD%E9rap%E9\n\nBug 9223 is similar to this bug, but not a dupe - it covered the QUERY_STRING\nwhich is mostly not used by the web application (TWiki, http://twiki.org).  As\nyou'd expect, the following URL works fine:\n\n   http://localhost:8080/cgi-bin/view?topic=Main.FromageD%E9rap%E9\n\nMost Mozilla-derived browsers including Firefox 1.0 generate URLs in the native\ncharacter encoding (e.g. ISO-8859-1) by default. In any case, Apache should not\nbe generating an internal server error, but a less serious error (e.g. file not\nfound), allowing mod_fileiri or the web application to interpret the encoding\ncorrectly (which TWiki can do as long as it sees the PATH_INFO).\n\nThis appears to be Windows specific since TWiki has users of\ninternationalisation on Apache 2 and Linux - no doubt due to the Unicode on\nWindows support.\n\nI realise that such non-UTF-8 URLs are not standards conformant, but if the web\napplication is willing to handle them specially, I think that Apache should at\nleast pass them on without trying to convert them (a configuration option to\nturn off this conversion would be very useful.)\n\nThis bug also prevents use of mod_fileiri, which enables such undesirable URLs\nto be redirected to conformant UTF-8 encoded URLs.  As Martin Duerst has\nconfirmed, this runs in the Apache 'fixup' phase.\n\nFor more information and workarounds from a TWiki perspective, see\nhttp://twiki.org/cgi-bin/view/Codev/ApacheTwoBreaksNonUTF8EncodedURLsOnWindows"}, {"text": "Some extra information:\n\n- this is completely reproducible, any URL using ISO-8859-1 encoded characters\nin PATH_INFO will do\n\n- the server build is from XAMPP for Windows 1.4.9 - Apache 2.0.52 -\nhttp://www.apachefriends.org/en/xampp-windows.html\n\n- server error page is as follows (mod_perl not active on CGI directory):\n\nInternal Server Error\n\nThe server encountered an internal error or misconfiguration and was unable to\ncomplete your request.\n\nPlease contact the server administrator, admin@localhost and inform them of the\ntime the error occurred, and anything you might have done that may have caused\nthe error.\n\nMore information about this error may be available in the server error log.\nApache/2.0.52 (Win32) mod_perl/1.99_16 Perl/v5.8.4 PHP/5.0.2 Server at localhost\nPort 8080\n", "tags": [], "bug_id": 32730, "is_private": false, "count": 1, "id": 68612, "time": "2004-12-16T13:08:44Z", "creator": "rd9@donkin.org", "creation_time": "2004-12-16T13:08:44Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "duerst@w3.org", "attachment_id": null, "id": 68638, "time": "2004-12-17T00:49:41Z", "bug_id": 32730, "creation_time": "2004-12-17T00:49:41Z", "is_private": false, "text": "Apache on Windows definitely needs to give back at least a\n404 rather than a 500 for something like FromageD%E9rap%E9.\nThis is a perfectly acceptable URI (although not one that\nthe server should resolve, it should continue to only resolve\nwith UTF-8), and so having the server blow up with a 500\nis totally inappropriate. Just check for UTF-8 before\ndoing the conversion or catch the error, and things\nshould be fine.\n(if anybody tells me where in the code the conversion\nfunction is called, I'll try to help come up with a patch)"}, {"count": 3, "tags": [], "creator": "rd9@donkin.org", "attachment_id": null, "id": 68719, "time": "2004-12-20T11:08:28Z", "bug_id": 32730, "creation_time": "2004-12-20T11:08:28Z", "is_private": false, "text": "The Firefox 1.0 bug at http://bugzilla.mozilla.org/show_bug.cgi?id=261934 means\nthat users can't persistently set Firefox to do UTF-8 encoding of URLs - there\nis a fix in place for future releases but no workaround for 1.0.  So the\n'configure Firefox' workaround is not very convenient for users. \n"}, {"attachment_id": null, "tags": [], "creator": "rd9@donkin.org", "is_private": false, "count": 4, "id": 68723, "time": "2004-12-20T12:04:49Z", "bug_id": 32730, "creation_time": "2004-12-20T12:04:49Z", "text": "I've had a look at the 2.0.52 code and the immediate issue appears to be in\nsrclib/apr/threadproc/win32/proc.c at lines 473 to 502, or line 480 onwards in\nCVS (see\nhttp://lxr.webperf.org/source.cgi/srclib/apr/threadproc/win32/proc.c#480 ) -\nthis is getting ready to create a Unicode environment block via the\nCreateProcess API in Win32.  It is based on a compile time option,\nAPR_HAS_UNICODE_FS.\n\nAn immediate patch may be quite easy, using the APR_HAS_ANSI_FS code to build an\nANSI environment block - or perhaps just recompiling with APR_HAS_ANSI_FS.\n\nA better fix might be to allow APR_HAS_ANSI_FS vs APR_HAS_UNICODE_FS to be\nselected through a run-time configuration directive.  This would enable\nsites/applications that want environment variables to be completely untouched by\nthe UTF8 to UCS2 conversion to run in 'no environment conversion' mode - the web\napplication can then do its own conversion without having to catch 404 errors. \n\nSince there's no guarantee the environment passed to Apache will really be\nUTF-8, it seems that this 'no conversion' mode is important for some\napplications at least.  Many web applications are portable between *nix and\nWindows, and have their own UTF8 URI handling code that works fine on both, so\nit's a pain if they have special code to handle the way Apache does things\ndifferently on Windows.\n\nIf the 'no environment conversion' option is too sweeping, all that's needed is\nto add PATH_INFO to the list of environment variables not converted (as in Bug\n9223) (Not sure where that code is, can someone point me to it?).  However, I\nthink that will cause future issues with other environment variables that may\neven be application-specific. \n\nRe-assigned to Will Rowe based on similarity to Bug 9223, hope that's OK."}, {"count": 5, "text": "No, that's no ok. Then he's the only one getting mail on updates. I'm adding him\nto CC instead.\n\nAnyway I'm wondering, what the FS type has to do with environment conversion.\n(But I have no much win32 fu).", "bug_id": 32730, "attachment_id": null, "id": 68724, "time": "2004-12-20T12:19:00Z", "creator": "nd@perlig.de", "creation_time": "2004-12-20T12:19:00Z", "tags": [], "is_private": false}, {"count": 6, "text": "Created attachment 13812\nSimple patch to prevent converting PATH_INFO to UCS-2\n\nThis is a very simple patch to modules/arch/win32/mod_win32.c that should\nprevent the PATH_INFO environment variable being converted from UTF-8 to UCS-2,\nas with QUERY_STRING (Bug 9223).  I have not been able to test this yet - I\ndownloaded various free Microsoft compilers and am almost ready, but missing\nMSDEV (any pointers to free versions, please email me).\n\nI'm on vacation until near end of the year, but if someone with a Windows build\nenvironment can test it with the above URL (omit the bin/view part if\nnecessary) that would be great.\n\nI still think a wider patch would be better but this may fix the immediate\nissue.", "bug_id": 32730, "attachment_id": 13812, "id": 68754, "time": "2004-12-21T09:51:56Z", "creator": "rd9@donkin.org", "creation_time": "2004-12-21T09:51:56Z", "tags": [], "is_private": false}, {"text": "Hi,\nI'm not using Twiki and I've run into the same problems:\n\nWhen using PHP's URL encoding function to access files with international\ncharacters a 404 file not found is returned. When first UTF-8 encoding the url\nand then URL encoding it - it works fine. Note the encoding differences in the\nURL: R%EAve and R%C3%AAve.\n\nExamples from log file:\n\nxxx.xxx.xxx.xxx - - [01/Jan/2005:18:23:03 +0100] \"GET\n/Idir/Deux%20Rives%2C%20un%20R%EAve/01%20-%20Pourquoi%20cette%20pluie%20%20.mp3\nHTTP/1.0\" 404 260 \"-\" \"WinampMPEG/2.9\" \"-\"\n\nxxx.xxx.xxx.xxx - - [01/Jan/2005:21:12:16 +0100] \"GET\n/Idir/Deux%20Rives%2C%20un%20R%C3%AAve/01%20-%20Pourquoi%20cette%20pluie%20%20.mp3\nHTTP/1.0\" 200 8164000 \"-\" \"WinampMPEG/5.0\" \"-\" ", "tags": [], "bug_id": 32730, "is_private": false, "count": 7, "id": 69267, "time": "2005-01-06T13:21:34Z", "creator": "francis@atlanten.se", "creation_time": "2005-01-06T13:21:34Z", "attachment_id": null}, {"count": 8, "tags": [], "creator": "rd9@donkin.org", "attachment_id": null, "id": 69354, "time": "2005-01-07T14:49:50Z", "bug_id": 32730, "creation_time": "2005-01-07T14:49:50Z", "is_private": false, "text": "Can someone with an Apache for Windows development environment please consider\ntesting my one-line patch (see attachment)?   The test case is very simple so\nthis should not take too long...\n\nI can't justify paying for a copy of Visual Studio just to get this tested, and\nwithout MSDEV the free version of Visual C++ doesn't work for Apache builds. \n\nAlternatively, if anyone has pointers to using Cygwin + mingw to do a Win32\nbuild of Apache, that would be great, as I'm quite familiar with Cygwin already\nand it won't cost anything to test this."}, {"count": 9, "tags": [], "text": "This is a sane proposal.  I'll attach a replacement libhttpd.dll (2.0.53-dev)\nto the incident once I have a chance to commit the fix to 2.1-dev.\n", "is_private": false, "bug_id": 32730, "id": 69369, "time": "2005-01-07T17:46:06Z", "creator": "wrowe@apache.org", "creation_time": "2005-01-07T17:46:06Z", "attachment_id": null}, {"count": 10, "tags": [], "creator": "wrowe@apache.org", "attachment_id": null, "id": 69370, "time": "2005-01-07T17:48:53Z", "bug_id": 32730, "creation_time": "2005-01-07T17:48:53Z", "is_private": false, "text": "Francis, \"When using PHP's URL encoding function to access files\"\nis unrelated to this incident (presuming you are using mod_php4\nal la php4apache2handler module.)\n"}, {"count": 11, "attachment_id": 13929, "bug_id": 32730, "is_private": false, "id": 69385, "time": "2005-01-07T19:48:59Z", "creator": "wrowe@apache.org", "creation_time": "2005-01-07T19:48:59Z", "tags": [], "text": "Created attachment 13929\nlibhttpd.dll 2.0.53-dev svn rev 124556\n\nTo test this patch, replace in the httpd-2.0.44 or later httpd-2.0\nApache/bin directory."}, {"count": 12, "tags": [], "text": "Hi,\nMaybe this comment does not belong here, but I'll try to explain more clearly. \nI used PHP to read the contents of a directory and to output the URL. When URL \nencoding the result there was a resulting 404 not found. When UTF8 encoding \nand then URL encoding the file was found. \n\nIt might not be related - but then again - it might be.", "attachment_id": null, "bug_id": 32730, "id": 69425, "time": "2005-01-08T11:01:12Z", "creator": "francis@atlanten.se", "creation_time": "2005-01-08T11:01:12Z", "is_private": false}, {"count": 13, "tags": [], "text": "I tried the new libhttpd.dll under my Apache setup and I got a somewhat\ndifferent conversion error:\n\n(22)I(22)Invalid argument: utf8 to ucs2 conversion failed on this string:\nPATH_TRANSLATED=C:\\\\apachefriends\\\\xampp\\\\htdocs\\\\Main\\\\FromageD\\xe9rap\\xe9\n\nThis is happening later in the process as you can see, on the file not the URL\nas in the original bug.   The URL used was\nhttp://localhost:8080/cgi-bin/view/Main/FromageD%E9rap%E9 as in the bug report.\n\nI know this is not a server or application config issue because\nhttp://localhost:8080/cgi-bin/view/Main/WebHome works fine even though\nC:\\\\apachefriends\\\\xampp\\\\htdocs\\\\Main\\\\WebHome does not exist as a file either.\n So it seems there is a file-existence check somewhere that is also requiring a\ntranslation of PATH_INFO even though the file doesn't have to exist. ", "attachment_id": null, "bug_id": 32730, "id": 69453, "time": "2005-01-09T09:41:41Z", "creator": "rd9@donkin.org", "creation_time": "2005-01-09T09:41:41Z", "is_private": false}, {"count": 14, "tags": [], "text": "Created attachment 13952\nRevised patch to avoid PATH_INFO and PATH_TRANSLATED conversions\n\nNew patch that should work better...  The analysis I submitted earlier today\nwas wrong - it is the same issue as before with slightly different error\nmessage.  This revised patch adds PATH_TRANSLATED to the list of environment\nvariables not converted to UCS2 (note that REQUEST_URI also includes PATH_INFO\ndata but is already covered by current code).", "is_private": false, "bug_id": 32730, "id": 69454, "time": "2005-01-09T12:30:03Z", "creator": "rd9@donkin.org", "creation_time": "2005-01-09T12:30:03Z", "attachment_id": 13952}, {"count": 15, "tags": [], "text": "Thanks Richard, the patch is now in the httpd-2.1 tree and should soon be\nbackported (provided we get the votes) to 2.0.\n", "is_private": false, "bug_id": 32730, "id": 70532, "time": "2005-02-05T02:46:03Z", "creator": "wrowe@apache.org", "creation_time": "2005-02-05T02:46:03Z", "attachment_id": null}, {"count": 16, "tags": [], "text": "*** Bug 33055 has been marked as a duplicate of this bug. ***", "is_private": false, "bug_id": 32730, "id": 73003, "time": "2005-03-29T17:46:50Z", "creator": "jorton@redhat.com", "creation_time": "2005-03-29T17:46:50Z", "attachment_id": null}, {"count": 17, "text": "This bug also occurs with REDIRECT_URL, which seem to have gone unnoticed in the\n2.0.54 release!\n", "bug_id": 32730, "attachment_id": null, "id": 74915, "time": "2005-05-16T04:09:08Z", "creator": "rescator@emsai.net", "creation_time": "2005-05-16T04:09:08Z", "tags": [], "is_private": false}, {"count": 18, "attachment_id": null, "bug_id": 32730, "text": "Bug 34985 is another variant of this, have commented there.", "id": 95420, "time": "2006-11-04T02:27:21Z", "creator": "rd9@donkin.org", "creation_time": "2006-11-04T02:27:21Z", "tags": [], "is_private": false}, {"count": 19, "tags": [], "creator": "wrowe@apache.org", "attachment_id": null, "is_private": false, "id": 112113, "time": "2007-12-22T13:07:29Z", "bug_id": 32730, "creation_time": "2007-12-22T13:07:29Z", "text": "\n\n*** This bug has been marked as a duplicate of 13029 ***"}]