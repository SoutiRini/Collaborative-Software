[{"count": 0, "tags": [], "creator": "bjoern@syltonline.de", "is_private": false, "id": 88266, "attachment_id": null, "bug_id": 39350, "creation_time": "2006-04-19T12:50:29Z", "time": "2006-04-19T12:50:29Z", "text": "Hi,\n\nwe use JK1 in IIS6 to connect to Tomcats. The IIS does the authentication.\nOur Organisation has grown and so has the group memberships of the users. The \nmemberships are listed in the kerberos tickets needed for internal windows \nauthentication in IIS. Now we already had to increase the max kerberos ticket \nsize on our servers from 11k to 64k because of that.\n\nProblem: lately we recognized that internal authentication doesn't work any \nmore on some accounts, if the web has a JK-component. The JK debug-log shows \nthis:\n\n[Wed Apr 19 14:24:14 2006] [5976:3224] [debug] jk_isapi_plugin.c (845): check \nif [/nwm/menuaction.do] is points to the web-inf directory\n[Wed Apr 19 14:24:14 2006] [5976:3224] [debug] jk_isapi_plugin.c (863): \n[/nwm/menuaction.do] is a servlet url - should redirect to lb_ptomx\n[Wed Apr 19 14:24:14 2006] [5976:3224] [debug] jk_worker.c (301): Maintaining \nworker lb_ptomx\n[Wed Apr 19 14:24:14 2006] [5976:3224] [debug] jk_ajp_common.c (2203): \nrecycled 0 sockets in 0 seconds\n[Wed Apr 19 14:24:14 2006] [5976:3224] [debug] jk_ajp_common.c (2203): \nrecycled 0 sockets in 0 seconds\n[Wed Apr 19 14:24:14 2006] [5976:3224] [debug] jk_ajp_common.c (2203): \nrecycled 0 sockets in 0 seconds\n[Wed Apr 19 14:24:14 2006] [5976:3224] [debug] jk_ajp_common.c (2203): \nrecycled 0 sockets in 0 seconds\n[Wed Apr 19 14:24:14 2006] [5976:3224] [debug] jk_ajp_common.c (2203): \nrecycled 0 sockets in 0 seconds\n[Wed Apr 19 14:24:14 2006] [5976:3224] [debug] jk_ajp_common.c (2203): \nrecycled 0 sockets in 0 seconds\n[Wed Apr 19 14:24:14 2006] [5976:3224] [debug] jk_worker.c (111): found a \nworker lb_ptomx\n[Wed Apr 19 14:24:14 2006] [5976:3224] [debug] jk_isapi_plugin.c (1018): got a \nworker for name lb_ptomx\n[Wed Apr 19 14:24:14 2006] [5976:3224] [debug] jk_lb_worker.c (592): service \nsticky_session=1\n[Wed Apr 19 14:24:14 2006] [5976:3224] [debug] jk_lb_worker.c (564): found \nbest worker (p-hh-ptom1_I2) using by request method\n[Wed Apr 19 14:24:14 2006] [5976:3224] [debug] jk_ajp_common.c (2131): \nacquired connection cache slot=0\n[Wed Apr 19 14:24:14 2006] [5976:3224] [debug] jk_lb_worker.c (612): service \nworker=p-hh-ptom1_I2 jvm_route=p-hh-ptom1_I2\n[Wed Apr 19 14:24:14 2006] [5976:3224] [error] jk_ajp_common.c (430): failed \nappending the header value\n[Wed Apr 19 14:24:14 2006] [5976:3224] [info]  jk_ajp_common.c (1662): \nCreating AJP message failed, without recovery\n[Wed Apr 19 14:24:14 2006] [5976:3224] [debug] jk_ajp_common.c (2074): \nrecycling connection cache slot=0 for worker p-hh-ptom1_I2\n[Wed Apr 19 14:24:14 2006] [5976:3224] [info]  jk_lb_worker.c (711): \nunrecoverable error 413, request failed. Client failed in the middle of \nrequest, we can't recover to another instance.\n[Wed Apr 19 14:24:14 2006] [5976:3224] [debug] jk_isapi_plugin.c (1031): \nservice() returned OK\n\nThe \"failed appending the header value\" took the analysis into the jk-code. It \nseems to be related to the buffersize, but i'm not an expert in you code.\nThe error occours here...\n \n   if (msg->len + len + 2 > msg->maxlen) {\n     return JK_ERR;\n     ...\n\n...and before you set...\n\n   msg->maxlen = buffSize;\n\n...and before that...\n\n   buffSize = DEF_BUFFER_SZ;\n\n...refering to the defrined static...\n\n   #define DEF_BUFFER_SZ (8 * 1024)\n\nI think that means that you have a 8k buffer for the JK-Message. the Kerberos \nticket is in the header so jk tries to add it to the message (allthough the \nauth is configured to take place on the IIS-side). And so the big header busts \nthe buffer, we think.\n\nHopefully you can find a way to cure this problem for us. Increasing the \nbuffer would be a quick workaround (If our analysis is right). But maybe a \ndynamic buffer or an intelligent handling of header data (i.e. stripping of \ninfo the TC doesn't use anyway) would be a more complete solution."}, {"count": 1, "tags": [], "bug_id": 39350, "text": "What mod_jk and Tomcat versions are you using?", "id": 88270, "time": "2006-04-19T13:21:37Z", "creator": "yoavs@computer.org", "creation_time": "2006-04-19T13:21:37Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "bjoern@syltonline.de", "attachment_id": null, "is_private": false, "id": 88272, "time": "2006-04-19T13:57:04Z", "bug_id": 39350, "creation_time": "2006-04-19T13:57:04Z", "text": "JK the latest binary build for windows, 1.2.15\nTomcat still the latesat stable in the 5.0 branch, 5.0.28"}, {"count": 3, "tags": [], "creator": "bjoern@syltonline.de", "text": "Ah, I forgot to mention: \nThe same error occours when we try digest authentication auth as auto-auth for \niis. But wfetch or etherreal show that in this case the same big tickets are \nsend with the headers to the iis.\nWhen we disable intergated + digest auth in IIS, so that auth falls back to \nBASIC AUTH (PlainText Auth), all works fine. Thats why we suspected kerberos \nin the first place.\nBut in this mode, you have to type in your credentials agin even if you are a \ndomain user. And our internal users are used to single-signon. So we would \nlike to keep it that way.\n", "id": 88290, "attachment_id": null, "bug_id": 39350, "creation_time": "2006-04-19T16:37:37Z", "time": "2006-04-19T16:37:37Z", "is_private": false}, {"count": 4, "tags": [], "creator": "mturk@apache.org", "attachment_id": null, "is_private": false, "id": 91028, "time": "2006-07-09T09:20:11Z", "bug_id": 39350, "creation_time": "2006-07-09T09:20:11Z", "text": "The promlem is related to the nature of the AJP1.3 protocol\nwhere the absolute header size is lower then 8K.\nThis will be fixed in the upcomming AJP protocol fixes that will\nhappen probably this summer."}]