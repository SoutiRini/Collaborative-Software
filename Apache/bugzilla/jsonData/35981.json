[{"count": 0, "tags": [], "bug_id": 35981, "attachment_id": null, "is_private": false, "id": 77971, "time": "2005-08-02T21:06:02Z", "creator": "mrinfret@pvnetsolutions.com", "creation_time": "2005-08-02T21:06:02Z", "text": "mod_dav discards the error status returned from dav_open_stream() during a \nfailed PUT request. We have modified repos.c to reject certain filename \nextensions. Upon receipt of an invalid extension, our dav_fs_open_stream \nreturns thus:\n    return dav_new_error(resource->pool, HTTP_UNSUPPORTED_MEDIA_TYPE, 0,\n                         message);\n\nHowever, dav_method_put (mod_dav.c) overrides this response. (The author even \nindicates that this probably isn't the right thing to do.)\n    if ((err = (*resource->hooks->open_stream)(resource, mode,\n                                               &stream)) != NULL) {\n        /* ### assuming FORBIDDEN is probably not quite right... */\n        err = dav_push_error(r->pool, HTTP_FORBIDDEN, 0,\n                             apr_psprintf(r->pool,\n                                          \"Unable to PUT new contents for %s.\",\n                                          ap_escape_html(r->pool, r->uri)),\n                             err);\n    }\nThus, we are getting FORBIDDEN at the client when we want \nHTTP_UNSUPPORTED_MEDIA_TYPE."}, {"count": 1, "tags": [], "text": "RFC 2518\nhttp://asg.web.cmu.edu/rfc/rfc2518.html\ndoesn't state that PUT must return HTTP_UNSUPPORTED_MEDIA_TYPE (415).\n(HTTP/1.1 rfc 2068 states that PUT can return HTTP_UNSUPPORTED_MEDIA_TYPE but it\nis not mandatory for dav rfc)\n\n415 is returned by MKCOL though.\n\nI agree that dav_method_put ignores that status code of error returned by\nopen_stream.\n", "attachment_id": null, "id": 100155, "creator": "basant.kukreja@sun.com", "time": "2007-03-07T09:48:15Z", "bug_id": 35981, "creation_time": "2007-03-07T09:48:15Z", "is_private": false}, {"count": 2, "tags": [], "text": "Suggested fix :\n\nIndex: modules/dav/main/mod_dav.c\n===================================================================\n--- modules/dav/main/mod_dav.c\t(revision 512953)\n+++ modules/dav/main/mod_dav.c\t(working copy)\n@@ -959,7 +959,8 @@\n     if ((err = (*resource->hooks->open_stream)(resource, mode,\n                                                &stream)) != NULL) {\n         /* ### assuming FORBIDDEN is probably not quite right... */\n-        err = dav_push_error(r->pool, HTTP_FORBIDDEN, 0,\n+        int status = err->status ? err->status : HTTP_FORBIDDEN;\n+        err = dav_push_error(r->pool, status, 0,\n                              apr_psprintf(r->pool,\n                                           \"Unable to PUT new contents for %s.\",\n                                           ap_escape_html(r->pool, r->uri)),\n\nI am not confident of this fix because it may cause unexpected error \ncodes from PUT method.", "attachment_id": null, "id": 100156, "creator": "basant.kukreja@sun.com", "time": "2007-03-07T09:59:58Z", "bug_id": 35981, "creation_time": "2007-03-07T09:59:58Z", "is_private": false}, {"count": 3, "tags": [], "creator": "alejandro.alvarez.ayllon@cern.ch", "attachment_id": null, "id": 146614, "time": "2011-05-25T07:35:03Z", "bug_id": 35981, "creation_time": "2011-05-25T07:35:03Z", "is_private": false, "text": "Hello,\n\nIt has been a long time since this was reported, and now I am hitting the same problem as Mark.\nIn our case, the return code we want to submit is 301, which is explicitly defined in the HTTP RFC for PUT methods. If WebDAV extends, shouldn't mod_dav support it?\n\nPatching this is trivial, but distributing our own patched version is not ideal, though.\n\nhttp://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.6"}, {"count": 4, "tags": [], "bug_id": 35981, "attachment_id": null, "id": 146623, "time": "2011-05-25T12:51:28Z", "creator": "wrowe@apache.org", "creation_time": "2011-05-25T12:51:28Z", "is_private": false, "text": "Basant's patch looks right, although is it necessary to avoid 200 responses in that logic?"}, {"count": 5, "tags": [], "text": "Probably yes, as other calls need to be called in that case (seek, write, close), and 20x statuses are already managed by mod_dav.\n\nI suppose just a condition like this would do:\n\nif ((err = (*resource->hooks->open_stream)(resource, mode,\n                                                &stream)) != NULL) {\n        int status = err->status ? err->status : HTTP_FORBIDDEN;\n        if (status > 299)\n            err = dav_push_error(r->pool, status, 0,\n                                   apr_psprintf(r->pool,\n                                          \"Unable to PUT new contents for %s.\",\n                                           ap_escape_html(r->pool, r->uri)),\n        else\n            err = NULL\n}\n\nTrue unexpected return codes may result. But I would say that's the developer's problem, not mod_dav's\n\nAny hope of this being fixed?", "attachment_id": null, "id": 146762, "creator": "alejandro.alvarez.ayllon@cern.ch", "time": "2011-05-31T12:18:20Z", "bug_id": 35981, "creation_time": "2011-05-31T12:18:20Z", "is_private": false}, {"count": 6, "tags": [], "text": "Hi.\n\nAny news on this one?\n\nIt would be great to get this in, Alejandro's suggestion looks ok?\n\nWe also need to return 301, and are currently shipping a patched mod_dav for this.\n\nThanks,\n  Ricardo", "attachment_id": null, "id": 150827, "creator": "rocha.porto@gmail.com", "time": "2011-10-21T16:08:19Z", "bug_id": 35981, "creation_time": "2011-10-21T16:08:19Z", "is_private": false}, {"text": "Hello,\n\nAny news on this?\n\nRegards.", "tags": [], "bug_id": 35981, "is_private": false, "count": 7, "id": 165568, "time": "2013-03-01T14:40:45Z", "creator": "alejandro.alvarez.ayllon@cern.ch", "creation_time": "2013-03-01T14:40:45Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 35981, "text": "Fix committed to trunk in r1477687.\n\nCan you verify that this fix works for you? If so, it can be backported to v2.4.", "id": 166971, "time": "2013-04-30T15:29:55Z", "creator": "minfrin@sharp.fm", "creation_time": "2013-04-30T15:29:55Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 35981, "text": "Hi,\n\nI confirm the fix works. Any change of it being backported to 2.2? Currently we support RHEL5 and 6, where the version is 2.2.\n\nRegards.", "id": 167058, "time": "2013-05-06T12:25:08Z", "creator": "alejandro.alvarez.ayllon@cern.ch", "creation_time": "2013-05-06T12:25:08Z", "is_private": false, "attachment_id": null}]