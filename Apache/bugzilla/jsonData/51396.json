[{"attachment_id": null, "tags": [], "bug_id": 51396, "is_private": false, "count": 0, "id": 147283, "time": "2011-06-20T17:02:09Z", "creator": "bimargulies@gmail.com", "creation_time": "2011-06-20T17:02:09Z", "text": "https://github.com/bimargulies/Tomcat-Solr-Test-Case is a test case. It creates an instance of Tomcat and then adds a webapp from Apache Solr. This webapp has 'jsp' servlets.\n\nThe code crashes, because the implicit default web.xml used in this case does not include a servlet named jsp, resulting in the following backtrace.\n\n\n\n2011-06-20 12:56:24,598 [Embedded Tomcat] INFO org.apache.catalina.startup.ContextConfig - No global web.xml found\nException in thread \"Embedded Tomcat\" java.lang.NullPointerException\n\tat org.apache.catalina.startup.ContextConfig.convertJsp(ContextConfig.java:1379)\n\tat org.apache.catalina.startup.ContextConfig.convertJsps(ContextConfig.java:1358)\n\tat org.apache.catalina.startup.ContextConfig.webConfig(ContextConfig.java:1349)\n\tat org.apache.catalina.startup.ContextConfig.configureStart(ContextConfig.java:881)\n\tat org.apache.catalina.startup.ContextConfig.lifecycleEvent(ContextConfig.java:316)\n\tat org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:119)\n\tat org.apache.catalina.util.LifecycleBase.fireLifecycleEvent(LifecycleBase.java:89)\n\tat org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:5103)\n\tat org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:145)\n\tat org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:812)\n\tat org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:787)\n\tat org.apache.catalina.core.StandardHost.addChild(StandardHost.java:607)\n\tat org.apache.catalina.startup.Tomcat.addWebapp(Tomcat.java:509)\n\tat org.apache.catalina.startup.Tomcat.addWebapp(Tomcat.java:483)\n\tat org.apache.catalina.startup.Tomcat.addWebapp(Tomcat.java:171)\n\tat org.apache.tomcat.tc.solrWebapp.LaunchWithSolr.tryToAddSolr(LaunchWithSolr.java:111)\n\tat org.apache.tomcat.tc.solrWebapp.LaunchWithSolr.access$1(LaunchWithSolr.java:106)\n\tat org.apache.tomcat.tc.solrWebapp.LaunchWithSolr$1.run(LaunchWithSolr.java:91)"}, {"attachment_id": null, "tags": [], "bug_id": 51396, "is_private": false, "count": 1, "id": 147284, "time": "2011-06-20T17:04:32Z", "creator": "markt@apache.org", "creation_time": "2011-06-20T17:04:32Z", "text": "Look at the test cases for examples of how to do this."}, {"count": 2, "tags": [], "bug_id": 51396, "text": " It stuns me that you would close this without apparently taking 2 minutes to read the one Java class, which I wrote by reading the available doc and examples. Further, I spend several hours debugging into tomcat here, and there were a number of suspicious aspects that led me to think that a bugzilla was appropriate.\n\nFurther, this is code that worked with tomcat 6 embedded and only failed when I moved to tomcat 7.\n\nMy code was written from the available examples, it works fine for a webapp that jsp pages but not jsp servlets, and the webapp with jsp servlets works fine with unembedded tomcat.", "id": 147286, "time": "2011-06-20T17:10:06Z", "creator": "bimargulies@gmail.com", "creation_time": "2011-06-20T17:10:06Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 51396, "is_private": false, "count": 3, "id": 147290, "time": "2011-06-20T19:36:14Z", "creator": "bimargulies@gmail.com", "creation_time": "2011-06-20T19:36:14Z", "text": "Since bz won't let me edit, I will improve on my description down here.\n\n1) I've written a class that uses the embedded API:\n\n  org.apache.catalina.startup.Tomcat\n\n2) My class calls Tomcat.addWebapp.\n\n3) My class works fine on a webapp that contains JSP pages.\n\n4) My class does NOT work for webapps that have <servlet> declarations that name jsp pages.\n\n5) The reason, which I have diagnosed, is the lack of the following servlet declaration from the default web.xml:\n\n <servlet>\n        <servlet-name>jsp</servlet-name>\n        <servlet-class>org.apache.jasper.servlet.JspServlet</servlet-class>\n        <init-param>\n            <param-name>fork</param-name>\n            <param-value>false</param-value>\n        </init-param>\n        <init-param>\n            <param-name>xpoweredBy</param-name>\n            <param-value>false</param-value>\n        </init-param>\n        <load-on-startup>3</load-on-startup>\n    </servlet>\n\n6) Tomcat.addWebapp does extra work to prevent the use of the default web.xml.\n\n7) I can't find any test case in the tomcat hierarchy that looks like this overall model, and in particular which supplies default web.xml content when using the embedded Tomcat class. Though I may of course be missing something."}, {"count": 4, "tags": [], "bug_id": 51396, "text": "In short, if there is a defect here, it is that:\n\norg.apache.catalina.startup.Tomcat.initWebappDefaults(Context)\n\ndoes not set up the servlet named 'jsp' which is set up in the default web.xml, and that the modularity of the Tomcat class does not offer a straightforward way to change that, since the function is static and so cannot be trivially @overridden.", "id": 147291, "time": "2011-06-20T19:51:00Z", "creator": "bimargulies@gmail.com", "creation_time": "2011-06-20T19:51:00Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 51396, "attachment_id": 27182, "text": "Created attachment 27182\ntest case in a patch\n\nHere is a minimal test case as a patch. Proposed fix to follow.", "id": 147294, "time": "2011-06-20T22:09:07Z", "creator": "bimargulies@gmail.com", "creation_time": "2011-06-20T22:09:07Z", "is_private": false}, {"count": 6, "tags": [], "text": "Bugs opened shortly after almost identical reports on the users list and containing statements that are clearly wrong (the jsp servlet is defined) do tend to get closed as invalid quickly to keep the noise down.\n\nThere is a bug here but a simpler test case would have made tracking it down a lot easier.\n\norg.apache.catalina.startup.Tomcat.initWebappDefaults(Context) is a red herring. That code is fine. The problem is around where the NPE occurs. Because the JSP has been set up programmatically, the definition of the init parameters isn't where it would be if read from the default web.xml and that triggers the NPE.\n\nI have a fix and the test case gets to the point where the app starts but I get 500 errors and the message java.lang.RuntimeException: Can't find resource 'solrconfig.xml' in classpath or 'D:\\solr_webapp\\.\\conf/. I don't see a file with that name in testcase.\n\nI'll commit that fix shortly and I'm going to assume that the 500 error is a problem with the webapp rather than another bug.", "is_private": false, "bug_id": 51396, "id": 147295, "time": "2011-06-20T22:11:25Z", "creator": "markt@apache.org", "creation_time": "2011-06-20T22:11:25Z", "attachment_id": null}, {"count": 7, "tags": [], "text": "Fixed in 7.0.x and will be included in 7.0.17 onwards.", "is_private": false, "id": 147296, "creator": "markt@apache.org", "time": "2011-06-20T22:38:25Z", "bug_id": 51396, "creation_time": "2011-06-20T22:38:25Z", "attachment_id": null}, {"attachment_id": 27183, "tags": [], "bug_id": 51396, "text": "Created attachment 27183\nPatch including fix to the problem.\n\nHere we have the missing if statement to fix the problem, too.", "count": 8, "id": 147297, "time": "2011-06-20T22:40:22Z", "creator": "bimargulies@gmail.com", "creation_time": "2011-06-20T22:40:22Z", "is_private": false}, {"count": 9, "tags": [], "text": "Well, now we've completed the whole story in parallel. \n\nDebugging the functions in ContextConfig, I think it is semi-fair to say that the jsp servlet is not, in fact, defined -- in web.xml-space, where the code is looking for it.\n\nPerhaps my JUnit test would find a home.", "attachment_id": null, "bug_id": 51396, "id": 147298, "time": "2011-06-20T22:42:30Z", "creator": "bimargulies@gmail.com", "creation_time": "2011-06-20T22:42:30Z", "is_private": false}, {"count": 10, "tags": [], "text": "Comment on attachment 27183\nPatch including fix to the problem.\n\nThe patch fixes the symptom, not the cause.", "is_private": false, "bug_id": 51396, "id": 147299, "time": "2011-06-20T22:45:16Z", "creator": "markt@apache.org", "creation_time": "2011-06-20T22:45:16Z", "attachment_id": 27183}, {"count": 11, "tags": [], "bug_id": 51396, "attachment_id": null, "is_private": false, "id": 147300, "time": "2011-06-20T22:51:14Z", "creator": "bimargulies@gmail.com", "creation_time": "2011-06-20T22:51:14Z", "text": "Just for the record, it's not that I didn't see the importance of fishing the init params out of where they were, it's that I couldn't work out for myself where to find them. That doesn't make it the right patch, of course."}]