[{"count": 0, "tags": [], "creator": "dohardgopro@gmail.com", "attachment_id": 28470, "text": "Created attachment 28470\npatch\n\nSystem:\nLinux 3.0.0-1-amd64 #1 SMP Sat Aug 27 16:21:11 UTC 2011 x86_64 GNU/Linux\nApache version\nServer version: Apache/2.2.22 (Debian)\n\nBut I sure that at 2.4.1 the same issue\n\nAfter turning set next options:\nKeepAlive On\nMaxKeepAliveRequests 5\nKeepAliveTimeout 1\n\nAfter some time (at last iteration about 2 minutes) some of apache workers eat 60-100% CPU, while must 0-2% CPU (without keep-alive - so)\n\nGdb:\n(gdb) bt\n#0  0x00007f61b5bb0cad in apr_table_setn () from /usr/lib/libapr-1.so.0\n#1  0x00007f61af75eaca in reqtimeout_filter (f=0x7f61b6275b40, bb=0x7f61b6266170, mode=<optimized out>, block=<optimized out>, readbytes=<optimized out>) at mod_reqtimeout.c:309\n#2  0x00007f61b3146322 in dumpio_input_filter (f=0x7f61b6275a68, bb=0x7f61b6266170, mode=AP_MODE_READBYTES, block=APR_BLOCK_READ, readbytes=6440) at mod_dumpio.c:120\n#3  0x00007f61b64b0161 in ap_http_filter (f=0x7f61b6263b10, b=0x7f61b6266170, mode=AP_MODE_READBYTES, block=<optimized out>, readbytes=6440) at http_filters.c:525\n#4  0x00007f61b64b1914 in ap_discard_request_body (r=0x7f61b6261758) at http_filters.c:1366\n#5  0x00007f61b6491349 in ap_finalize_request_protocol (r=0x7f61b6261758) at protocol.c:1168\n#6  0x00007f61af552a05 in handler_redirect (r=0x7f61b62620a0) at mod_rewrite.c:4860\n#7  0x00007f61b649f668 in ap_run_handler (r=0x7f61b62620a0) at config.c:159\n#8  0x00007f61b649fade in ap_invoke_handler (r=0x7f61b62620a0) at config.c:377\n#9  0x00007f61b64af6b0 in ap_process_request (r=0x7f61b62620a0) at http_request.c:282\n#10 0x00007f61b64ac4f8 in ap_process_http_connection (c=0x7f61b6275290) at http_core.c:190\n#11 0x00007f61b64a60e8 in ap_run_process_connection (c=0x7f61b6275290) at connection.c:43\n#12 0x00007f61b64b42c0 in child_main (child_num_arg=<optimized out>) at prefork.c:667\n#13 0x00007f61b64b4a2a in make_child (slot=6, s=0x7f61b64407f8) at prefork.c:768\n#14 make_child (s=0x7f61b64407f8, slot=6) at prefork.c:696\n#15 0x00007f61b64b55df in perform_idle_server_maintenance (p=<optimized out>) at prefork.c:903\n#16 ap_mpm_run (_pconf=<optimized out>, plog=<optimized out>, s=<optimized out>) at prefork.c:1107\n#17 0x00007f61b648a6a4 in main (argc=3, argv=0x7fff67bcc5e8) at main.c:755\n(gdb) quit\nA debugging session is active.\n\n        Inferior 1 [process 11587] will be detached.\n\nQuit anyway? (y or n) EOF [assumed Y]\nDetaching from program: /usr/lib/apache2/mpm-prefork/apache2, process 11587\nroot@:/work1/azat/apache_high_percents/cores# ps u 11587\nUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nwww-data 11587 59.0  0.0 381148 14968 ?        R    14:33   0:42 /usr/sbin/apache2 -k start\nroot@:/work1/azat/apache_high_percents/cores# ps u 11587\nUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nwww-data 11587 60.0  0.0 381148 14968 ?        R    14:33   0:45 /usr/sbin/apache2 -k start\nroot@:/work1/azat/apache_high_percents/cores# ps u 11587\nUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nwww-data 11587 60.4  0.0 381148 14968 ?        R    14:33   0:45 /usr/sbin/apache2 -k start\nroot@:/work1/azat/apache_high_percents/cores# ps u 11587\nUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nwww-data 11587 61.5  0.0 381148 14968 ?        R    14:33   0:46 /usr/sbin/apache2 -k start\n \n(gdb) bt\n#0  0x00007f61b64a980c in ap_get_brigade (next=0x7f61b6263b10, bb=0x7f61b6266170, mode=AP_MODE_READBYTES, block=APR_BLOCK_READ, readbytes=8192) at util_filter.c:489\n#1  0x00007f61b64b1914 in ap_discard_request_body (r=0x7f61b6261758) at http_filters.c:1366\n#2  0x00007f61b6491349 in ap_finalize_request_protocol (r=0x7f61b6261758) at protocol.c:1168\n#3  0x00007f61af552a05 in handler_redirect (r=0x7f61b62620a0) at mod_rewrite.c:4860\n#4  0x00007f61b649f668 in ap_run_handler (r=0x7f61b62620a0) at config.c:159\n#5  0x00007f61b649fade in ap_invoke_handler (r=0x7f61b62620a0) at config.c:377\n#6  0x00007f61b64af6b0 in ap_process_request (r=0x7f61b62620a0) at http_request.c:282\n#7  0x00007f61b64ac4f8 in ap_process_http_connection (c=0x7f61b6275290) at http_core.c:190\n#8  0x00007f61b64a60e8 in ap_run_process_connection (c=0x7f61b6275290) at connection.c:43\n#9  0x00007f61b64b42c0 in child_main (child_num_arg=<optimized out>) at prefork.c:667\n#10 0x00007f61b64b4a2a in make_child (slot=6, s=0x7f61b64407f8) at prefork.c:768\n#11 make_child (s=0x7f61b64407f8, slot=6) at prefork.c:696\n#12 0x00007f61b64b55df in perform_idle_server_maintenance (p=<optimized out>) at prefork.c:903\n#13 ap_mpm_run (_pconf=<optimized out>, plog=<optimized out>, s=<optimized out>) at prefork.c:1107\n#14 0x00007f61b648a6a4 in main (argc=3, argv=0x7fff67bcc5e8) at main.c:755\n(gdb) quit\nA debugging session is active.\n\n        Inferior 1 [process 11587] will be detached.\n\nQuit anyway? (y or n) EOF [assumed Y]\nDetaching from program: /usr/lib/apache2/mpm-prefork/apache2, process 11587\nroot@:/work1/azat/apache_high_percents/cores# ps u 11587\nUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nwww-data 11587 71.9  0.0 381148 14968 ?        R    14:33   2:11 /usr/sbin/apache2 -k start\n\nServer-status\nSrv PID Acc M CPU SS Req Conn Child Slot Client VHost Request\n6-0 11587 0/2/17 W 0.03 194 0 0.0 0.00 0.00 {CLIENT_IP} {SERVER_HOST} POST {URL} HTTP/1.1\n\nWhile here CPU = 0.03\n\nI also think that my patch can fix this problem\nThere I write verbose comment", "id": 154925, "time": "2012-03-15T08:28:15Z", "bug_id": 52914, "creation_time": "2012-03-15T08:28:15Z", "is_private": false}, {"count": 1, "tags": [], "creator": "sf@sfritsch.de", "attachment_id": 28474, "text": "Created attachment 28474\ndon't clobber input filter return value in mod_dump_io\n\nI don't think your patch is correct. Can you try if my patch helps, too?", "id": 154946, "time": "2012-03-15T17:24:08Z", "bug_id": 52914, "creation_time": "2012-03-15T17:24:08Z", "is_private": false}, {"count": 2, "tags": [], "creator": "sf@sfritsch.de", "attachment_id": null, "text": "(In reply to comment #1)\n> Created attachment 28474 [details]\n> don't clobber input filter return value in mod_dump_io\n> \n> I don't think your patch is correct. Can you try if my patch helps, too?\n\nFWIW, this would mean that not loading mod_dump_io should also fix the issue.", "id": 154947, "time": "2012-03-15T17:39:42Z", "bug_id": 52914, "creation_time": "2012-03-15T17:39:42Z", "is_private": false}, {"count": 3, "attachment_id": null, "bug_id": 52914, "text": "I could reproduce the 100% CPU with POST requests if mod_reqtimeout is enabled for bodies and DumpIOInput is on. This is fixed by my patch\n\nTrunk: r1301111\n2.4: r1301686\nproposed for 2.2", "id": 154989, "time": "2012-03-16T18:54:06Z", "creator": "sf@sfritsch.de", "creation_time": "2012-03-16T18:54:06Z", "tags": [], "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 52914, "text": "Thanks, I'll see you commit, and seems that it can fix my problem.\nI'll try later, and comment here about what I have", "count": 4, "id": 155038, "time": "2012-03-19T08:22:50Z", "creator": "dohardgopro@gmail.com", "creation_time": "2012-03-19T08:22:50Z", "is_private": false}, {"count": 5, "tags": [], "text": "(In reply to comment #3)\n> I could reproduce the 100% CPU with POST requests if mod_reqtimeout is enabled\n> for bodies and DumpIOInput is on. This is fixed by my patch\n> \n> Trunk: r1301111\n> 2.4: r1301686\n> proposed for 2.2\n\nI try reproduce this bug, on another machine\nOn both are debian, same version\nApache, have the same version (2.2.22)\n\nBut this bug, not reproduced (DumpIOInput on, mod_reqtimeout enabled, keepalive on)\nTrying using siege\n\nCan you write here how you reproduce this bug?\nThanks.", "is_private": false, "bug_id": 52914, "id": 155044, "time": "2012-03-19T13:30:43Z", "creator": "dohardgopro@gmail.com", "creation_time": "2012-03-19T13:30:43Z", "attachment_id": null}, {"count": 6, "tags": [], "creator": "sf@sfritsch.de", "attachment_id": null, "id": 155065, "time": "2012-03-19T19:53:17Z", "bug_id": 52914, "creation_time": "2012-03-19T19:53:17Z", "is_private": false, "text": "(In reply to comment #5)\n> Can you write here how you reproduce this bug?\n> Thanks.\n\nI did a POST request with a Content-Length header, sent part (but not all) of the request body, and then waited for mod_reqtimeout's body timeout to kick in. Then the child would loop with 100% CPU.\n\nDo you know if you had DumpIOInput enabled when you reported this issue? If you are sure that you didn't have it enabled, you probably have hit a different issue."}, {"count": 7, "tags": [], "text": "(In reply to comment #6)\n> Do you know if you had DumpIOInput enabled when you reported this issue? If you\n> are sure that you didn't have it enabled, you probably have hit a different\n> issue.\n\nIgnore that, that was a stupid question. Your stack trace shows that you had DumpIOInput enabled.", "attachment_id": null, "bug_id": 52914, "id": 155067, "time": "2012-03-19T20:02:11Z", "creator": "sf@sfritsch.de", "creation_time": "2012-03-19T20:02:11Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 52914, "text": "(In reply to comment #6)\n> (In reply to comment #5)\n> > Can you write here how you reproduce this bug?\n> > Thanks.\n> \n> I did a POST request with a Content-Length header, sent part (but not all) of\n> the request body, and then waited for mod_reqtimeout's body timeout to kick in.\n> Then the child would loop with 100% CPU.\n> \n> Do you know if you had DumpIOInput enabled when you reported this issue? If you\n> are sure that you didn't have it enabled, you probably have hit a different\n> issue.\n\nThanks.\nYou patch fix problem with huge process load, for me.", "count": 8, "id": 155091, "time": "2012-03-20T09:56:11Z", "creator": "dohardgopro@gmail.com", "creation_time": "2012-03-20T09:56:11Z", "is_private": false}, {"count": 9, "tags": [], "text": "The fix is in 2.4.2 and proposed for 2.2.x", "is_private": false, "bug_id": 52914, "id": 158856, "time": "2012-05-06T07:27:59Z", "creator": "sf@sfritsch.de", "creation_time": "2012-05-06T07:27:59Z", "attachment_id": null}]