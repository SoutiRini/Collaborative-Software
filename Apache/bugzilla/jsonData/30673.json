[{"count": 0, "tags": [], "creator": "mattmurphy@kc.rr.com", "text": "When configuring PHP 4.3.x as a CGI using the ScriptAlias, AddType, Action\nmethod, I discovered a bug in Apache 1.3.31 that appears to have emerged since\nApache 1.3.27 (the last version deployed on my site).\n\nIn the 404 case (e.g, http://www.example.com/should_cause_a_404.php), Apache\ndoes *not* trigger a 404.  Instead, the request is incorrectly aborted with a\n500 (Internal Server Error).  Checking the error log reveals a \"Premature end of\nscript headers\" error.  I've confirmed that my ErrorDocuments are correct, as\nstatic 4xx codes work correctly (the ErrorDocuments are Apache default). \nSetting the error log LogLevel to 'debug' reveals that Apache is invoking PHP\nwith PATH_INFO set to the URI of the script.  Each request generates debug\nactivity similar to the following:\n\n[Sat Aug 14 19:09:28 2004] [info] Invoking CGI Command 'c:\\\\php\\\\php.exe '\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[0] =\n'COMSPEC=C:\\\\WINDOWS\\\\system32\\\\cmd.exe'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[1] =\n'DOCUMENT_ROOT=c:/foxserv/www'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[2] =\n'HTTP_ACCEPT=text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,video/x-mng,image/png,image/jpeg,image/gif;q=0.2,*/*;q=0.1'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[3] =\n'HTTP_ACCEPT_CHARSET=ISO-8859-1,utf-8;q=0.7,*;q=0.7'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[4] =\n'HTTP_ACCEPT_ENCODING=gzip,deflate'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[5] =\n'HTTP_ACCEPT_LANGUAGE=en-us,en;q=0.5'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[6] =\n'HTTP_CONNECTION=keep-alive'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[7] =\n'HTTP_HOST=localhost'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[8] =\n'HTTP_KEEP_ALIVE=300'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[9] =\n'HTTP_REFERER=http://localhost/'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[10] =\n'HTTP_USER_AGENT=Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.4)\nGecko/20030624 Netscape/7.1 (ax)'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[11] =\n'PATH=C:\\\\Perl56\\\\bin\\\\;C:\\\\WINDOWS\\\\system32;C:\\\\GPG;C:\\\\Perl\\\\bin\\\\;C:\\\\WINDOWS;C:\\\\WINDOWS\\\\COMMAND;C:\\\\PROGRA~1\\\\MICROS~5\\\\VC98\\\\INCLUDE;C:\\\\PROGRA~1\\\\RATIONAL\\\\COMMON;C:\\\\EXPLORER.4L;C:\\\\PHP;C:\\\\HTTPD\\\\PHP;\"C:\\\\Program\nFiles\\\\PKWARE\\\\PKZIPC\\\\\";C:\\\\PROGRA~1\\\\SSHCOM~1\\\\SSHSEC~1;C:\\\\WINDOWS\\\\system32\\\\WBEM;C:\\\\Program\nFiles\\\\cvsnt;C:\\\\PROGRA~1\\\\Gupta'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[12] =\n'REDIRECT_STATUS=200'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[13] =\n'REDIRECT_URL=/index2.php'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[14] =\n'REMOTE_ADDR=127.0.0.1'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[15] =\n'REMOTE_PORT=4336'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[16] =\n'SCRIPT_FILENAME=c:/php/php.exe'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[17] =\n'SERVER_ADDR=127.0.0.1'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[18] =\n'SERVER_ADMIN=mattmurphy@kc.rr.com'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[19] =\n'SERVER_NAME=techie.hopto.org'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[20] =\n'SERVER_PORT=80'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[21] =\n'SERVER_SIGNATURE=<ADDRESS>Apache/1.3.31 Server at techie.hopto.org Port\n80</ADDRESS>\\n'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[22] =\n'SERVER_SOFTWARE=Apache/1.3.31 (Win32) mod_gzip/1.3.26.1a'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[23] =\n'SystemRoot=C:\\\\WINDOWS'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[24] =\n'WINDIR=C:\\\\WINDOWS'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[25] =\n'GATEWAY_INTERFACE=CGI/1.1'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[26] =\n'SERVER_PROTOCOL=HTTP/1.1'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[27] =\n'REQUEST_METHOD=GET'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[28] =\n'QUERY_STRING='\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[29] =\n'REQUEST_URI=/index2.php'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[30] =\n'SCRIPT_NAME=/php/php.exe'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[31] =\n'PATH_INFO=/index2.php'\n[Sat Aug 14 19:09:28 2004] [debug] .\\main\\util_script.c(1101):   CGI env[32] =\n'PATH_TRANSLATED=c:\\\\foxserv\\\\www\\\\index2.php'\n\nThe only problem is that the file listed *does not* exist, and never has.  In\nPATH_TRANSLATED is the path to a non-existant file.  Handling of this should\nrevert to the previous behavior of returning the (accurate) 404 status code,\nrather than a Server Error (500).", "id": 61991, "time": "2004-08-15T00:53:45Z", "bug_id": 30673, "creation_time": "2004-08-15T00:53:45Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "nd@perlig.de", "text": "This behaviour is the case since 1.3.10 or so. Did you change your PHP\ninstallation? It's quite possible, that something in PHP causes the failure.", "id": 61992, "time": "2004-08-15T01:03:23Z", "bug_id": 30673, "creation_time": "2004-08-15T01:03:23Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 30673, "attachment_id": null, "text": "Hmm...\n\nThe only thing w.r.t the web site that has changed recently was the upgrade of\nthe httpd from 1.3.27 -> 1.3.31.  I don't recall seeing 500s previously on (what\nshould be) a 404 case, but maybe I simply didn't *run into* such a case previously.\n\nThe version of PHP in place was 4.3.1.  It needed upgrading anyway, so I\ndownloaded PHP 4.3.8 (Win32) as a ZIP package.  It now appears that this\nbehavior constitutes a security vulnerability.  I say this because PHP 4.3.8\naborts with \"No input file specified\", which is a classic sign that PHP's\nredirection logic is failing.\n\nThe one thing that I would expect to be trouble here is PHP's cgi.force_redirect\nconfiguration option.  I checked it, and it *is* set to on, as is recommended by\nthe PHP group.\n\nIt appears that correct behavior can be achieved by simply passing .php files\noff to mod_cgi, and using the \"shebang line\" to invoke the (web-inaccessible)\nPHP interpreter.  I'll recommend the new install tips to the PHP team.  I'm also\ndowngrading the priority of this to \"Minor\".  It's not an \"Enhancement\",\nbecause, AFAICT, the current behavior is simply wrong, but it's not a showstopper.\n\nThanks, and keep up the fantastic work on the server.", "id": 61993, "time": "2004-08-15T02:39:34Z", "creator": "mattmurphy@kc.rr.com", "creation_time": "2004-08-15T02:39:34Z", "is_private": false}, {"count": 3, "tags": [], "creator": "nd@perlig.de", "text": "Well it will be changed in 2.x.", "id": 63626, "time": "2004-09-15T20:38:43Z", "bug_id": 30673, "creation_time": "2004-09-15T20:38:43Z", "is_private": false, "attachment_id": null}]