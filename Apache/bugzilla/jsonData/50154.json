[{"count": 0, "tags": [], "bug_id": 50154, "is_private": false, "id": 141013, "creation_time": "2010-10-25T17:42:50Z", "time": "2010-10-25T17:42:50Z", "creator": "thyde@centraldesktop.com", "text": "I sent this to the POI-users mailing list a few weeks ago and was advised to open a bug here.\n\n\nI've been injecting custom document properties with POI in both OOXML and OLE files for about 4 months now covering a very large number of documents.    I do have one customer complaining when they open my meta-data injected version of their file that Excel complains about a missing drawing part.\n\nThe recovery log is:\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\" ?> \n- <recoveryLog xmlns=\"http://schemas.openxmlformats.org/spreadsheetml/2006/main\"> \n<logFileName>error027960_01.xml</logFileName> \n<summary>Errors were detected in file 'Z:\\Downloads\\bad.xlsx'</summary> \n- <removedParts summary=\"Following is a list of removed parts:\"> \n<removedPart>Removed Part: /xl/drawings/drawing1.xml part. (Drawing shape)</removedPart> \n</removedParts> \n</recoveryLog>\n\n\n\nExtracting the original file and the one I modified (only the custom document properties) and diff I get the attached diff.\n\n\n\nLargely the differences are just formatting changes ... POI making the XML pretty print.\n\nPOI drops the standalone=\"yes\" attribute in the XML declaration ... that shouldn't be a big deal.\n\nThe thing that jumps out at me is that in xl/drawings/_rels/drawing1.xml.rels, I'm losing relationship rId1 (<Relationship Id=\"rId1\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/hyperlink\" Target=\"#'Instructions (Text)'!B21\"/></Relationships>) in version that POI saves to disk.\n\nDoes anyone have any suggestions or seen anything like this before?  I started this project back at the beginning of the year with an early 3.7 snapshot, migrated to beta2 and now to beta3 which all exhibit the same issues.\n\n\n\n\n\n\nOn Wed, 13 Oct 2010, Trey Hyde wrote:\nThe drawings all seem intact but only tangible difference I see is the missing hyperlink rel in drawing1.  I just modified the code to not actually make any changes and I see the same thing.\n\nOK, looks like a more general bug then, not related to properties modifications. Could you create a bug in bugzilla, and upload a file that demonstrates the problem along with some code that shows it?\n\nThanks\nNick", "attachment_id": null}, {"count": 1, "attachment_id": null, "bug_id": 50154, "text": "I ran it again after turning on logging in poi... here are the VERY relevant warnings.\n\n\n\n[org.apache.poi.openxml4j.opc.PackageRelationshipCollection] Cannot convert #'Instructions (Text)'!B21 in a valid relationship URI-> ignored\njava.net.URISyntaxException: Illegal character in fragment at index 14: #'Instructions (Text)'!B21\n  at java.net.URI$Parser.fail(URI.java:2809)\n  at java.net.URI$Parser.checkChars(URI.java:2982)\n  at java.net.URI$Parser.parse(URI.java:3028)\n  at java.net.URI.<init>(URI.java:578)\n  at org.apache.poi.openxml4j.opc.PackageRelationshipCollection.parseRelationshipsPart(PackageRelationshipCollection.java:363)\n  at org.apache.poi.openxml4j.opc.PackageRelationshipCollection.<init>(PackageRelationshipCollection.java:156)\n  at org.apache.poi.openxml4j.opc.PackageRelationshipCollection.<init>(PackageRelationshipCollection.java:124)\n  at org.apache.poi.openxml4j.opc.PackagePart.loadRelationships(PackagePart.java:527)\n  at org.apache.poi.openxml4j.opc.PackagePart.<init>(PackagePart.java:112)\n  at org.apache.poi.openxml4j.opc.PackagePart.<init>(PackagePart.java:83)\n  at org.apache.poi.openxml4j.opc.PackagePart.<init>(PackagePart.java:128)\n  at org.apache.poi.openxml4j.opc.ZipPackagePart.<init>(ZipPackagePart.java:78)\n  at org.apache.poi.openxml4j.opc.ZipPackage.getPartsImpl(ZipPackage.java:187)\n  at org.apache.poi.openxml4j.opc.OPCPackage.getParts(OPCPackage.java:592)\n  at org.apache.poi.openxml4j.opc.OPCPackage.open(OPCPackage.java:201)\n  at org.apache.poi.openxml4j.opc.OPCPackage.open(OPCPackage.java:178)\n  at org.apache.poi.openxml4j.opc.OPCPackage.openOrCreate(OPCPackage.java:240)\n  at com.centraldesktop.office.metadata.OpenXMLMDReader.isOutdated(OpenXMLMDReader.java:35)\n  at com.centraldesktop.office.metadata.Main.main(Main.java:128)\n  at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n  at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n  at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n  at java.lang.reflect.Method.invoke(Method.java:597)\n  at com.simontuffs.onejar.Boot.run(Boot.java:340)\n  at com.simontuffs.onejar.Boot.main(Boot.java:166)\n[org.apache.poi.openxml4j.opc.PackageRelationshipCollection] Cannot convert #'Instructions (Text)'!B21 in a valid relationship URI-> ignored\njava.net.URISyntaxException: Illegal character in fragment at index 14: #'Instructions (Text)'!B21\n  at java.net.URI$Parser.fail(URI.java:2809)\n  at java.net.URI$Parser.checkChars(URI.java:2982)\n  at java.net.URI$Parser.parse(URI.java:3028)\n  at java.net.URI.<init>(URI.java:578)\n  at org.apache.poi.openxml4j.opc.PackageRelationshipCollection.parseRelationshipsPart(PackageRelationshipCollection.java:363)\n  at org.apache.poi.openxml4j.opc.PackageRelationshipCollection.<init>(PackageRelationshipCollection.java:156)\n  at org.apache.poi.openxml4j.opc.PackageRelationshipCollection.<init>(PackageRelationshipCollection.java:124)\n  at org.apache.poi.openxml4j.opc.PackagePart.loadRelationships(PackagePart.java:527)\n  at org.apache.poi.openxml4j.opc.PackagePart.<init>(PackagePart.java:112)\n  at org.apache.poi.openxml4j.opc.PackagePart.<init>(PackagePart.java:83)\n  at org.apache.poi.openxml4j.opc.PackagePart.<init>(PackagePart.java:128)\n  at org.apache.poi.openxml4j.opc.ZipPackagePart.<init>(ZipPackagePart.java:78)\n  at org.apache.poi.openxml4j.opc.ZipPackage.getPartsImpl(ZipPackage.java:187)\n  at org.apache.poi.openxml4j.opc.OPCPackage.getParts(OPCPackage.java:592)\n  at org.apache.poi.openxml4j.opc.OPCPackage.open(OPCPackage.java:201)\n  at org.apache.poi.openxml4j.opc.OPCPackage.open(OPCPackage.java:178)\n  at org.apache.poi.openxml4j.opc.OPCPackage.openOrCreate(OPCPackage.java:240)\n  at com.centraldesktop.office.metadata.OpenXMLMDWriter.save(OpenXMLMDWriter.java:33)\n  at com.centraldesktop.office.metadata.Main.main(Main.java:130)\n  at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n  at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n  at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n  at java.lang.reflect.Method.invoke(Method.java:597)\n  at com.simontuffs.onejar.Boot.run(Boot.java:340)\n  at com.simontuffs.onejar.Boot.main(Boot.java:166)", "id": 141014, "time": "2010-10-25T17:44:16Z", "creator": "thyde@centraldesktop.com", "creation_time": "2010-10-25T17:44:16Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 50154, "is_private": false, "id": 141452, "attachment_id": null, "creator": "thyde@centraldesktop.com", "creation_time": "2010-11-04T21:05:48Z", "time": "2010-11-04T21:05:48Z", "text": "Just found another document that has the same issue where the hyperlink relation is not in a format that is compatible with java.Uri\n\n\n[org.apache.poi.openxml4j.opc.PackageRelationshipCollection] Cannot convert Macintosh%20HD:Users:marienl:Desktop:##20Lisa%20work:CC_PowerPoint:CC_S.jpg in a valid relationship URI-> ignored\njava.net.URISyntaxException: Illegal character in scheme name at index 9: Macintosh%20HD:Users:marienl:Desktop:##20Lisa%20work:CC_PowerPoint:CC_S.jpg\n  at java.net.URI$Parser.fail(URI.java:2809)\n  at java.net.URI$Parser.checkChars(URI.java:2982)\n  at java.net.URI$Parser.parse(URI.java:3009)\n  at java.net.URI.<init>(URI.java:578)\n  at org.apache.poi.openxml4j.opc.PackageRelationshipCollection.parseRelationshipsPart(PackageRelationshipCollection.java:363)\n  at org.apache.poi.openxml4j.opc.PackageRelationshipCollection.<init>(PackageRelationshipCollection.java:156)\n  at org.apache.poi.openxml4j.opc.PackageRelationshipCollection.<init>(PackageRelationshipCollection.java:124)\n  at org.apache.poi.openxml4j.opc.PackagePart.loadRelationships(PackagePart.java:527)\n  at org.apache.poi.openxml4j.opc.PackagePart.<init>(PackagePart.java:112)\n  at org.apache.poi.openxml4j.opc.PackagePart.<init>(PackagePart.java:83)\n  at org.apache.poi.openxml4j.opc.PackagePart.<init>(PackagePart.java:128)\n  at org.apache.poi.openxml4j.opc.ZipPackagePart.<init>(ZipPackagePart.java:78)\n  at org.apache.poi.openxml4j.opc.ZipPackage.getPartsImpl(ZipPackage.java:187)\n  at org.apache.poi.openxml4j.opc.OPCPackage.getParts(OPCPackage.java:592)\n  at org.apache.poi.openxml4j.opc.OPCPackage.open(OPCPackage.java:201)\n..."}, {"count": 3, "tags": [], "bug_id": 50154, "is_private": false, "id": 141510, "creation_time": "2010-11-05T18:13:54Z", "time": "2010-11-05T18:13:54Z", "creator": "thyde@centraldesktop.com", "text": "Created attachment 26263\nWill corrupt if you open with POI and save a new copy.\n\nWill corrupt if you open with POI and save a new copy.", "attachment_id": 26263}, {"count": 4, "tags": [], "bug_id": 50154, "text": "The file attached will cause this.   To recreate this file.  Open a new sheet, add an image.   Create a second sheet.  Right click on the image in the first sheet and add a hyperlink.   Make it a link to an \"Document\" -> \"Anchor\" and select the other sheet.\n\n[org.apache.poi.openxml4j.opc.PackageRelationshipCollection] Cannot convert #'Another Sheet'!A1 in a valid relationship URI-> ignored\njava.net.URISyntaxException: Illegal character in fragment at index 9: #'Another Sheet'!A1\n        at java.net.URI$Parser.fail(URI.java:2809)\n        at java.net.URI$Parser.checkChars(URI.java:2982)\n        at java.net.URI$Parser.parse(URI.java:3028)\n        at java.net.URI.<init>(URI.java:578)\n        at org.apache.poi.openxml4j.opc.PackageRelationshipCollection.parseRelationshipsPart(PackageRelationshipCollection.java:363)\n        at org.apache.poi.openxml4j.opc.PackageRelationshipCollection.<init>(PackageRelationshipCollection.java:156)\n        at org.apache.poi.openxml4j.opc.PackageRelationshipCollection.<init>(PackageRelationshipCollection.java:124)\n        at org.apache.poi.openxml4j.opc.PackagePart.loadRelationships(PackagePart.java:527)\n        at org.apache.poi.openxml4j.opc.PackagePart.<init>(PackagePart.java:112)\n        at org.apache.poi.openxml4j.opc.PackagePart.<init>(PackagePart.java:83)\n        at org.apache.poi.openxml4j.opc.PackagePart.<init>(PackagePart.java:128)\n        at org.apache.poi.openxml4j.opc.ZipPackagePart.<init>(ZipPackagePart.java:78)\n        at org.apache.poi.openxml4j.opc.ZipPackage.getPartsImpl(ZipPackage.java:187)\n        at org.apache.poi.openxml4j.opc.OPCPackage.getParts(OPCPackage.java:592)\n        at org.apache.poi.openxml4j.opc.OPCPackage.open(OPCPackage.java:201)\n        at org.apache.poi.openxml4j.opc.OPCPackage.open(OPCPackage.java:178)\n        at org.apache.poi.openxml4j.opc.OPCPackage.openOrCreate(OPCPackage.java:240)\n        at com.centraldesktop.office.metadata.OpenXMLMDWriter.save(OpenXMLMDWriter.java:33)\n        at com.centraldesktop.office.metadata.Main.main(Main.java:130)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at com.simontuffs.onejar.Boot.run(Boot.java:340)\n        at com.simontuffs.onejar.Boot.main(Boot.java:166)", "id": 141511, "time": "2010-11-05T18:16:12Z", "creator": "thyde@centraldesktop.com", "creation_time": "2010-11-05T18:16:12Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 50154, "text": "The problem is in the OpenXml4J module. It doesn't support white spaces in target URIs. \n\nCompare two targets:\n\n  <Relationship Id=\"rId3\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/hyperlink\" Target=\"#ThirdSheet!A1\"/>\n  <Relationship Id=\"rId1\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/hyperlink\" Target=\"#'Another Sheet'!A1\"/>\n\nThe first one is handled OK and survives across read-write. \nThe second one issues a warning and causes troubles. \n\nThe fix seems easy - we should percent-encode white spaces (and perhaps any other non-uri characters) when reading OPC packages and un-percent-encode them when saving. \n\nThe fix is coming soon.\n\nYegor", "id": 141656, "time": "2010-11-12T07:51:33Z", "creator": "yegor@dinom.ru", "creation_time": "2010-11-12T07:51:33Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 50154, "attachment_id": null, "text": "Fixed in r1036215. \n\nYegor", "id": 141779, "time": "2010-11-17T16:11:34Z", "creator": "yegor@dinom.ru", "creation_time": "2010-11-17T16:11:34Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "thyde@centraldesktop.com", "text": "Fantastic, I'll give trunk a good run through in the next few days and eagerly await the fix to hit a stable build in the maven repository.", "count": 7, "id": 141780, "time": "2010-11-17T16:16:05Z", "bug_id": 50154, "creation_time": "2010-11-17T16:16:05Z", "is_private": false}]