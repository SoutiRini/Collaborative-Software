[{"count": 0, "attachment_id": null, "bug_id": 36494, "is_private": false, "id": 79380, "time": "2005-09-05T04:10:00Z", "creator": "renaud.richardet@gmail.com", "creation_time": "2005-09-05T04:10:00Z", "tags": [], "text": "I get a NPO when trying to log into the default pub (/default/authoring/)\n\n\n\njava.lang.NullPointerException\n\norg.apache.lenya.ac.AccessControlException: java.lang.NullPointerException\n\ncause: java.lang.NullPointerException\n\nfull exception chain stacktrace[Hide]\n\norg.apache.lenya.ac.AccessControlException: java.lang.NullPointerException\n\tat\norg.apache.lenya.cms.ac.DocumentPolicyManagerWrapper.getPolicyURL(DocumentPolicyManagerWrapper.java:99)\n\tat\norg.apache.lenya.cms.ac.DocumentPolicyManagerWrapper.getPolicy(DocumentPolicyManagerWrapper.java:212)\n\tat\norg.apache.lenya.ac.impl.PolicyAuthorizer.authorizePolicy(PolicyAuthorizer.java:109)\n\tat org.apache.lenya.ac.impl.PolicyAuthorizer.authorize(PolicyAuthorizer.java:170)\n\tat org.apache.lenya.ac.impl.PolicyAuthorizer.authorize(PolicyAuthorizer.java:92)\n\tat\norg.apache.lenya.ac.impl.DefaultAccessController.authorize(DefaultAccessController.java:116)\n\tat\norg.apache.lenya.ac.impl.BypassableAccessController.authorize(BypassableAccessController.java:155)\n\tat\norg.apache.lenya.cms.cocoon.acting.DelegatingAuthorizerAction.doAct(DelegatingAuthorizerAction.java:68)\n\tat\norg.apache.lenya.cms.cocoon.acting.AccessControlAction.act(AccessControlAction.java:86)\n\tat\norg.apache.lenya.cms.cocoon.acting.DelegatingAuthorizerAction.act(DelegatingAuthorizerAction.java:50)\n\tat\norg.apache.cocoon.components.treeprocessor.sitemap.ActTypeNode.invoke(ActTypeNode.java:124)\n\tat\norg.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode.invokeNodes(AbstractParentProcessingNode.java:68)\n\tat\norg.apache.cocoon.components.treeprocessor.sitemap.SelectNode.invoke(SelectNode.java:102)\n\tat\norg.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode.invokeNodes(AbstractParentProcessingNode.java:46)\n\tat\norg.apache.cocoon.components.treeprocessor.sitemap.PreparableMatchNode.invoke(PreparableMatchNode.java:130)\n\tat\norg.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode.invokeNodes(AbstractParentProcessingNode.java:68)\n\tat\norg.apache.cocoon.components.treeprocessor.sitemap.PipelineNode.invoke(PipelineNode.java:142)\n\tat\norg.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode.invokeNodes(AbstractParentProcessingNode.java:68)\n\tat\norg.apache.cocoon.components.treeprocessor.sitemap.PipelinesNode.invoke(PipelinesNode.java:92)\n\tat\norg.apache.cocoon.components.treeprocessor.ConcreteTreeProcessor.process(ConcreteTreeProcessor.java:234)\n\tat\norg.apache.cocoon.components.treeprocessor.ConcreteTreeProcessor.process(ConcreteTreeProcessor.java:176)\n\tat\norg.apache.cocoon.components.treeprocessor.TreeProcessor.process(TreeProcessor.java:248)\n\tat org.apache.cocoon.Cocoon.process(Cocoon.java:626)\n\tat org.apache.cocoon.servlet.CocoonServlet.service(CocoonServlet.java:1154)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:802)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:237)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:157)\n\tat\norg.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:214)\n\tat\norg.apache.catalina.core.StandardValveContext.invokeNext(StandardValveContext.java:104)\n\tat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:520)\n\tat\norg.apache.catalina.core.StandardContextValve.invokeInternal(StandardContextValve.java:198)\n\tat\norg.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:152)\n\tat\norg.apache.catalina.core.StandardValveContext.invokeNext(StandardValveContext.java:104)\n\tat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:520)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:137)\n\tat\norg.apache.catalina.core.StandardValveContext.invokeNext(StandardValveContext.java:104)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:118)\n\tat\norg.apache.catalina.core.StandardValveContext.invokeNext(StandardValveContext.java:102)\n\tat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:520)\n\tat\norg.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n\tat\norg.apache.catalina.core.StandardValveContext.invokeNext(StandardValveContext.java:104)\n\tat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:520)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:929)\n\tat org.apache.coyote.tomcat5.CoyoteAdapter.service(CoyoteAdapter.java:160)\n\tat org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:799)\n\tat\norg.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.processConnection(Http11Protocol.java:705)\n\tat org.apache.tomcat.util.net.TcpWorkerThread.runIt(PoolTcpEndpoint.java:577)\n\tat\norg.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:683)\n\tat java.lang.Thread.run(Thread.java:534)\nCaused by: java.lang.NullPointerException\n\tat\norg.apache.lenya.cms.repository.RepositoryUtil.getSession(RepositoryUtil.java:30)\n\tat\norg.apache.lenya.cms.ac.DocumentPolicyManagerWrapper.getPolicyURL(DocumentPolicyManagerWrapper.java:84)\n\t... 48 more\n\nstacktrace[Hide]\n\njava.lang.NullPointerException\n\tat\norg.apache.lenya.cms.repository.RepositoryUtil.getSession(RepositoryUtil.java:30)\n\tat\norg.apache.lenya.cms.ac.DocumentPolicyManagerWrapper.getPolicyURL(DocumentPolicyManagerWrapper.java:84)\n\tat\norg.apache.lenya.cms.ac.DocumentPolicyManagerWrapper.getPolicy(DocumentPolicyManagerWrapper.java:212)\n\tat\norg.apache.lenya.ac.impl.PolicyAuthorizer.authorizePolicy(PolicyAuthorizer.java:109)\n\tat org.apache.lenya.ac.impl.PolicyAuthorizer.authorize(PolicyAuthorizer.java:170)\n\tat org.apache.lenya.ac.impl.PolicyAuthorizer.authorize(PolicyAuthorizer.java:92)\n\tat\norg.apache.lenya.ac.impl.DefaultAccessController.authorize(DefaultAccessController.java:116)\n\tat\norg.apache.lenya.ac.impl.BypassableAccessController.authorize(BypassableAccessController.java:155)\n\tat\norg.apache.lenya.cms.cocoon.acting.DelegatingAuthorizerAction.doAct(DelegatingAuthorizerAction.java:68)\n\tat\norg.apache.lenya.cms.cocoon.acting.AccessControlAction.act(AccessControlAction.java:86)\n\tat\norg.apache.lenya.cms.cocoon.acting.DelegatingAuthorizerAction.act(DelegatingAuthorizerAction.java:50)\n\tat\norg.apache.cocoon.components.treeprocessor.sitemap.ActTypeNode.invoke(ActTypeNode.java:124)\n\tat\norg.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode.invokeNodes(AbstractParentProcessingNode.java:68)\n\tat\norg.apache.cocoon.components.treeprocessor.sitemap.SelectNode.invoke(SelectNode.java:102)\n\tat\norg.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode.invokeNodes(AbstractParentProcessingNode.java:46)\n\tat\norg.apache.cocoon.components.treeprocessor.sitemap.PreparableMatchNode.invoke(PreparableMatchNode.java:130)\n\tat\norg.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode.invokeNodes(AbstractParentProcessingNode.java:68)\n\tat\norg.apache.cocoon.components.treeprocessor.sitemap.PipelineNode.invoke(PipelineNode.java:142)\n\tat\norg.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode.invokeNodes(AbstractParentProcessingNode.java:68)\n\tat\norg.apache.cocoon.components.treeprocessor.sitemap.PipelinesNode.invoke(PipelinesNode.java:92)\n\tat\norg.apache.cocoon.components.treeprocessor.ConcreteTreeProcessor.process(ConcreteTreeProcessor.java:234)\n\tat\norg.apache.cocoon.components.treeprocessor.ConcreteTreeProcessor.process(ConcreteTreeProcessor.java:176)\n\tat\norg.apache.cocoon.components.treeprocessor.TreeProcessor.process(TreeProcessor.java:248)\n\tat org.apache.cocoon.Cocoon.process(Cocoon.java:626)\n\tat org.apache.cocoon.servlet.CocoonServlet.service(CocoonServlet.java:1154)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:802)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:237)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:157)\n\tat\norg.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:214)\n\tat\norg.apache.catalina.core.StandardValveContext.invokeNext(StandardValveContext.java:104)\n\tat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:520)\n\tat\norg.apache.catalina.core.StandardContextValve.invokeInternal(StandardContextValve.java:198)\n\tat\norg.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:152)\n\tat\norg.apache.catalina.core.StandardValveContext.invokeNext(StandardValveContext.java:104)\n\tat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:520)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:137)\n\tat\norg.apache.catalina.core.StandardValveContext.invokeNext(StandardValveContext.java:104)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:118)\n\tat\norg.apache.catalina.core.StandardValveContext.invokeNext(StandardValveContext.java:102)\n\tat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:520)\n\tat\norg.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n\tat\norg.apache.catalina.core.StandardValveContext.invokeNext(StandardValveContext.java:104)\n\tat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:520)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:929)\n\tat org.apache.coyote.tomcat5.CoyoteAdapter.service(CoyoteAdapter.java:160)\n\tat org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:799)\n\tat\norg.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.processConnection(Http11Protocol.java:705)\n\tat org.apache.tomcat.util.net.TcpWorkerThread.runIt(PoolTcpEndpoint.java:577)\n\tat\norg.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:683)\n\tat java.lang.Thread.run(Thread.java:534)"}, {"count": 1, "tags": [], "creator": "andreas@apache.org", "text": "- Can this bug be reproduced?\n\n- Does it occur regularily?", "id": 79383, "time": "2005-09-05T09:37:38Z", "bug_id": 36494, "creation_time": "2005-09-05T09:37:38Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "A.D.Savin@bath.ac.uk", "attachment_id": null, "text": "(In reply to comment #1)\n> - Can this bug be reproduced?\n> \n> - Does it occur regularily?\n\nI'm getting the same error.  It started happening after I got the lastest build\nfrom svn on Thursday (1st sept).  For me it occurs regularily first when going\nto the login page.  This can be reached after a few reloads of the page.  Once\nthe login button has been pressed the error returns and it then requires a few\nmore reloads until the the authouring page is reached.  The error aslo occurs\nafter a exiting kupu and adding a new document.\n\n", "id": 79385, "time": "2005-09-05T10:55:21Z", "bug_id": 36494, "creation_time": "2005-09-05T10:55:21Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 36494, "attachment_id": null, "id": 79418, "time": "2005-09-05T20:11:24Z", "creator": "renaud.richardet@gmail.com", "creation_time": "2005-09-05T20:11:24Z", "is_private": false, "text": "(In reply to comment #1)\n \n> - Does it occur regularily?\n\nYes\n\nCould that be related to the fact that I keep switching between different\nLenyas. That is: my local ones and some demo servers?\n\nThanks,\nRenaud"}, {"count": 4, "attachment_id": 16401, "bug_id": 36494, "text": "Created attachment 16401\nlog file\n\nI can reproduce this problem, but only with Tomcat, not with Jetty.\nAnd it does not seem to occur always, only sometimes.\n\nAttached is an excerpt of the log file.", "id": 79926, "time": "2005-09-14T10:40:24Z", "creator": "josias.thoeny@wyona.org", "creation_time": "2005-09-14T10:40:24Z", "tags": [], "is_private": false}, {"count": 5, "tags": [], "creator": "josias.thoeny@wyona.org", "text": "The problem seems to be that the DocumentPolicyManagerWrapper uses an \"old\"\nRequest object to get the repository session.\n\nTo get a policy url, it uses\n\nSession session = RepositoryUtil.getSession(this.request, getLogger());\n\nThe request is assigned when the DPMWrapper is instantiated.\n\nBecause the DPMWrapper is being cached within AbstractAccessControllerResolver\n(via the AccessController), the same Request instance is used all the time in\nthe DPMWrapper, which should not happen.\n\nThe question is where DPMWrapper should get the current repo session from. \n \n\n", "id": 80194, "time": "2005-09-20T17:36:35Z", "bug_id": 36494, "creation_time": "2005-09-20T17:36:35Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "text": "*** Bug 37224 has been marked as a duplicate of this bug. ***", "attachment_id": null, "id": 82086, "creation_time": "2005-11-03T11:13:04Z", "time": "2005-11-03T11:13:04Z", "creator": "felix.roethenbacher@wyona.com", "bug_id": 36494, "is_private": false}, {"count": 7, "attachment_id": null, "bug_id": 36494, "is_private": false, "id": 82121, "time": "2005-11-04T10:46:51Z", "creator": "manos_lists@geekologue.com", "creation_time": "2005-11-04T10:46:51Z", "tags": [], "text": "Based on what Greg Wilkins (via Felix) says in #37224 and      \nJosias' comment below:      \n      \n* The org.apache.cocoon.environment.Request implementation of      \no.a.l.cms.ac.DocumentPolicyManagerWrapper.request actually wraps a      \njavax.servlet.http.HttpServletRequest       \n      \n* The lifetime of a DocumentPolicyManagerWrapper is actually beyond the scope   \nof      \nan HttpServletRequest      \n      \n* Which results in a reference of the HttpServletRequest living outside it's     \nnatural scope of HttpServlet.service/other HTTP method, which is wrong.     \n    \nIf the above is true and the scope of a DocumentPolicyManagerWrapper is beyond    \nthe scope of an HTTP request, then it should not have such a request as a    \n(members' ) member.    \n    \nAfter a bit more digging and my very poor understanding of the architecture  \nhere, this request member of the DocumentPolicyManagerWrapper is there to  \noptimize (a o.a.l.cms.repository)sessions by calling RepositoryUtil right? But  \na datastore session sounds like something that should be lightweight (and is  \nsupposed to cover a single unit of work) so i dont see the need for that...   \nIf i'm wrong or alternatively, this needs another pattern to optimize things  \nlike a threadlocal or something to store a session per HTTP request.    \n    \nSorry for bubbling or if all this is not accurate, i just *really* need someone    \nmore experienced with the codebase to solve this one, it's a major showstopper    \nfor me right now; i'm really stuck :-(     \n "}, {"count": 8, "tags": [], "creator": "felix.roethenbacher@wyona.com", "text": "I increase the severity of this bug to blocker as the\nDocumentPolicyManagerWrapper uses a stale Request object which leads eventually\nto NullPointerExceptions.\n\nDocumentPolicyManagerWrapper implements the Contextualize interface. Usually,\ncontextualize() is called when the component is retrieved. Because of the\ncaching behaviour of AbstractAccessControllerResolver this is never done,\nleaving the DocumentPolicyManagerWrapper with a stale Request object. Either the\nDocumentPolicyManagerWrapper should not be cached or the Request object has to\nbe retrieved in another way than through the Context object.\n\nThe patch ensures the correct retrieval of the Request object.", "id": 82183, "time": "2005-11-07T14:47:45Z", "bug_id": 36494, "creation_time": "2005-11-07T14:47:45Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "creator": "felix.roethenbacher@wyona.com", "attachment_id": 16893, "text": "Created attachment 16893\nPatch for src/java/org/apache/lenya/cms/ac/DocumentPolicyManagerWrapper.java", "id": 82184, "time": "2005-11-07T14:48:34Z", "bug_id": 36494, "creation_time": "2005-11-07T14:48:34Z", "is_private": false}, {"count": 10, "attachment_id": 16894, "bug_id": 36494, "is_private": false, "id": 82189, "time": "2005-11-07T16:08:43Z", "creator": "felix.roethenbacher@wyona.com", "creation_time": "2005-11-07T16:08:43Z", "tags": [], "text": "Created attachment 16894\nAdds a ContextUtility component for retrieval of request, response, context and object model of a request.\n\nThe use of a Contextualizable component is more future proof than the first\napproach which used the internal CocoonComponentManager.\n\nThe ContextUtility is a component that can be used to get the context, request,\nresponse object or the object model of the current request."}, {"count": 11, "tags": [], "creator": "andreas@apache.org", "attachment_id": null, "is_private": false, "id": 82440, "time": "2005-11-14T10:09:56Z", "bug_id": 36494, "creation_time": "2005-11-14T10:09:56Z", "text": "I applied the patch. Thanks a lot!"}, {"count": 12, "tags": [], "creator": "thorsten@apache.org", "is_private": false, "text": "Renaming Lenya 1.4 to 2.0", "id": 105458, "time": "2007-07-16T01:58:37Z", "bug_id": 36494, "creation_time": "2007-07-16T01:58:37Z", "attachment_id": null}]