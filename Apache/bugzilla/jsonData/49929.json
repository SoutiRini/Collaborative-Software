[{"count": 0, "tags": [], "text": "Hi,\n\nEnvironment:\nOS: RHEL 5.5 (fully patched)\nApache HTTPD: 2.2.3 (from OS vendor)\nmod_jk: 1.2.30 (downloaded from Tomcat site and compiled locally)\nTomcat: 6.0.29 (binary distribution from apache.org)\nJVM: 1.6.0_21 (Sun, 64-bit).\n\nWhen running httpd/mod_jk in trace mode we are seeing one or two\nSEND_BODY_CHUNK messages of length 4 (referred to as a 'flush' message\nfrom now on) just before the END_RESPONSE message.  I see this even when\nquerying the Tomcat Manager (manager/html) home page so this is not our\napplication specifically.\n\nOur problem is that in a servlet that retrieves a file that is then sent\nto the client we are receiving a 'flush' message _after_ the\nEND_RESPONSE message. On the next request, mod_jk sees this a breach in\nthe protocol, closes the socket and results in poor performance and\nmissed requests.  The files are significantly bigger than the standard\n8k buffers (~500kb).\n\nThe relevant servlet is a Spring Controller (some details omitted) that\ndoes the following:\n\npublic ModelAndView handle(HttpServletRequest request,\nHttpServletResponse response, Object command, BindException errors)\nthrows Exception {\n        ...\n        ... image is a byte buffer containing an image ...\n        response.setContentType(image.getMimeType());\n        response.setContentLength(image.getImage().length);\n        FileCopyUtils.copy( image.getImage(), response.getOutputStream();\n\n        return null;\n}\n\nWe were using a manual explicit flush() and close() on the output stream\ninstead of using FileCopyUtils. When we did that, we got two 'flush'\nmessages but one was still after the END_RESPONSE.\n\nFileCopyUtils closes the OutputStream automatically but doesn't flush it\nas we were doing previously doing manually.\n\nFor example:\nFull trace level logs available at: http://pastebin.com/KsHeXT58\n\nhome page requests (/), result in a 301 to /home.action.  This produces\na double 'flush' before the END_REQUEST message (only debug level\nshown):\n\n[Mon Sep 13 11:47:37.460 2010] [31725:1144342848] [debug]\najp_unmarshal_response::jk_ajp_common.c (660): status = 301\n[Mon Sep 13 11:47:37.460 2010] [31725:1144342848] [debug]\najp_unmarshal_response::jk_ajp_common.c (667): Number of headers is = 5\n[Mon Sep 13 11:47:37.460 2010] [31725:1144342848] [debug]\najp_unmarshal_response::jk_ajp_common.c (723): Header[0] [Set-Cookie] =\n[JSESSIONID=FA47238C8C9976E37793701F10A2D923.jvm1; Path=/]\n[Mon Sep 13 11:47:37.460 2010] [31725:1144342848] [debug]\najp_unmarshal_response::jk_ajp_common.c (723): Header[1] [Location] =\n[home.action]\n[Mon Sep 13 11:47:37.460 2010] [31725:1144342848] [debug]\najp_unmarshal_response::jk_ajp_common.c (723): Header[2] [Connection] =\n[close]\n[Mon Sep 13 11:47:37.460 2010] [31725:1144342848] [debug]\najp_unmarshal_response::jk_ajp_common.c (723): Header[3] [Content-Type]\n= [text/html]\n[Mon Sep 13 11:47:37.460 2010] [31725:1144342848] [debug]\najp_unmarshal_response::jk_ajp_common.c (723): Header[4]\n[Content-Length] = [4]\n\nThen comes the body content:\n[Mon Sep 13 11:47:37.460 2010] [31725:1144342848] [debug]\najp_connection_tcp_get_message::jk_ajp_common.c (1336): received from\najp13 pos=0 len=8 max=8192\n[Mon Sep 13 11:47:37.460 2010] [31725:1144342848] [debug]\najp_connection_tcp_get_message::jk_ajp_common.c (1336): 0000    03 00 04\n0D 0A 0D 0A 00 00 00 00 00 00 00 00 00  - ................\n[Mon Sep 13 11:47:37.460 2010] [31725:1144342848] [debug]\nws_write::mod_jk.c (507): written 4 out of 4\n\n1st flush message\n\n[Mon Sep 13 11:47:37.460 2010] [31725:1144342848] [debug]\najp_connection_tcp_get_message::jk_ajp_common.c (1336): received from\najp13 pos=0 len=4 max=8192\n[Mon Sep 13 11:47:37.460 2010] [31725:1144342848] [debug]\najp_connection_tcp_get_message::jk_ajp_common.c (1336): 0000    03 00 00\n00 00 00 00 00 00 00 00 00 00 00 00 00  - ................\n\n2nd flush message\n\n[Mon Sep 13 11:47:37.460 2010] [31725:1144342848] [debug]\najp_connection_tcp_get_message::jk_ajp_common.c (1336): received from\najp13 pos=0 len=4 max=8192\n[Mon Sep 13 11:47:37.460 2010] [31725:1144342848] [debug]\najp_connection_tcp_get_message::jk_ajp_common.c (1336): 0000    03 00 00\n00 00 00 00 00 00 00 00 00 00 00 00 00  - ................\n\nNormal END_MESSAGE\n\n[Mon Sep 13 11:47:37.460 2010] [31725:1144342848] [debug]\najp_connection_tcp_get_message::jk_ajp_common.c (1336): received from\najp13 pos=0 len=2 max=8192\n[Mon Sep 13 11:47:37.460 2010] [31725:1144342848] [debug]\najp_connection_tcp_get_message::jk_ajp_common.c (1336): 0000    05 01 00\n00 00 00 00 00 00 00 00 00 00 00 00 00  - ................\n\nThe home page retrieval proceeds in exactly the same manner (including\nthe two 'flush' messages.\n\nHowever when we try this against the file retrieval servlet above\n(remember files are ~500k) we get the following behaviour instead:\n\nHeaders received by mod_jk from the request:\n[Mon Sep 13 11:47:38.118 2010] [31728:1147218240] [debug]\najp_unmarshal_response::jk_ajp_common.c (660): status = 200\n[Mon Sep 13 11:47:38.118 2010] [31728:1147218240] [debug]\najp_unmarshal_response::jk_ajp_common.c (667): Number of headers is = 2\n[Mon Sep 13 11:47:38.118 2010] [31728:1147218240] [debug]\najp_unmarshal_response::jk_ajp_common.c (723): Header[0] [Content-Type]\n= [image/jpeg]\n[Mon Sep 13 11:47:38.118 2010] [31728:1147218240] [debug]\najp_unmarshal_response::jk_ajp_common.c (723): Header[1]\n[Content-Length] = [532874]\n\nNow the data ...\n[Mon Sep 13 11:47:38.118 2010] [31728:1147218240] [debug]\najp_connection_tcp_get_message::jk_ajp_common.c (1336): received from\najp13 pos=0 len=8188 max=8192\n[Mon Sep 13 11:47:38.118 2010] [31728:1147218240] [debug]\najp_connection_tcp_get_message::jk_ajp_common.c (1336): 0000    03 1F F8\nFF D8 FF E0 00 10 4A 46 49 46 00 01 01  - .........JFIF...\n\n... lots of messages like that above ...\n\nFinally once complete (last data write shown):\n\n[Mon Sep 13 11:47:38.533 2010] [31728:1147218240] [debug]\najp_connection_tcp_get_message::jk_ajp_common.c (1336): 0390    A5 29 4A\nFF D9 00 00 00 00 00 00 00 00 00 00 00  - .)J.............\n[Mon Sep 13 11:47:38.533 2010] [31728:1147218240] [debug]\nws_write::mod_jk.c (507): written 914 out of 914\n\nThe end of the request (note - no flush message at all)\n\n[Mon Sep 13 11:47:38.533 2010] [31728:1147218240] [debug]\najp_connection_tcp_get_message::jk_ajp_common.c (1336): received from\najp13 pos=0 len=2 max=8192\n[Mon Sep 13 11:47:38.533 2010] [31728:1147218240] [debug]\najp_connection_tcp_get_message::jk_ajp_common.c (1336): 0000    05 01 00\n00 00 00 00 00 00 00 00 00 00 00 00 00  - ................\n\nConnection now supposedly reset for reuse:\n\n[Mon Sep 13 11:47:38.533 2010] [31728:1147218240] [debug]\najp_process_callback::jk_ajp_common.c (1940): AJP13 protocol: Reuse is\nOK\n[Mon Sep 13 11:47:38.533 2010] [31728:1147218240] [debug]\najp_reset_endpoint::jk_ajp_common.c (757): (jvm1) resetting endpoint\nwith sd = 17 \n[Mon Sep 13 11:47:38.533 2010] [31728:1147218240] [debug]\najp_done::jk_ajp_common.c (3010): recycling connection pool slot=0 for\nworker jvm1\n[Mon Sep 13 11:47:38.534 2010] [31728:1147218240] [debug]\njk_handler::mod_jk.c (2602): Service finished with status=200 for\nworker=balancer\n\nThe problem occurs the next time that connection is used:\n\n[Mon Sep 13 11:47:38.535 2010] [31728:1147218240] [debug]\nmap_uri_to_worker_ext::jk_uri_worker_map.c (1036): Attempting to map URI\n'/scripts/css/jquery-ui-1.8.2.custom.css' from 4 maps\n[Mon Sep 13 11:47:38.535 2010] [31728:1147218240] [debug]\nfind_match::jk_uri_worker_map.c (850): Attempting to map context URI\n'/*=balancer' source 'JkMount'\n[Mon Sep 13 11:47:38.535 2010] [31728:1147218240] [debug]\nfind_match::jk_uri_worker_map.c (863): Found a wildchar match\n'/*=balancer'\n[Mon Sep 13 11:47:38.535 2010] [31728:1147218240] [debug]\njk_handler::mod_jk.c (2462): Into handler jakarta-servlet\nworker=balancer r->proxyreq=0\n[Mon Sep 13 11:47:38.535 2010] [31728:1147218240] [debug]\nwc_get_worker_for_name::jk_worker.c (116): found a worker balancer\n[Mon Sep 13 11:47:38.535 2010] [31728:1147218240] [debug]\nwc_get_name_for_type::jk_worker.c (293): Found worker type 'lb'\n[Mon Sep 13 11:47:38.535 2010] [31728:1147218240] [debug]\ninit_ws_service::mod_jk.c (978): Service protocol=HTTP/1.1 method=GET\nssl=false host=(null) addr=10.16.0.71 name=10.16.0.40 port=80\nauth=(null) user=(null) laddr=10.16.0.40 raddr=10.16.0.71\nuri=/scripts/css/jquery-ui-1.8.2.custom.css\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [debug]\nservice::jk_lb_worker.c (1118): service sticky_session=1\nid='FA47238C8C9976E37793701F10A2D923.jvm1'\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [debug]\nget_most_suitable_worker::jk_lb_worker.c (946): searching worker for\npartial sessionid FA47238C8C9976E37793701F10A2D923.jvm1\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [debug]\nget_most_suitable_worker::jk_lb_worker.c (954): searching worker for\nsession route jvm1\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [debug]\nget_most_suitable_worker::jk_lb_worker.c (968): found worker jvm1 (jvm1)\nfor route jvm1 and partial sessionid\nFA47238C8C9976E37793701F10A2D923.jvm1\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [debug]\nservice::jk_lb_worker.c (1161): service worker=jvm1 route=jvm1\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [debug]\najp_get_endpoint::jk_ajp_common.c (3093): acquired connection pool\nslot=0 after 0 retries\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [debug]\najp_marshal_into_msgb::jk_ajp_common.c (605): ajp marshaling done\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [debug]\najp_service::jk_ajp_common.c (2376): processing jvm1 with 2 retries\n\nbegin by sending 'cping', we expect 'cpong'\n\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [debug]\najp_connection_tcp_send_message::jk_ajp_common.c (1152): sending to\najp13 pos=4 len=5 max=16\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [debug]\najp_connection_tcp_send_message::jk_ajp_common.c (1152): 0000    12 34\n00 01 0A 00 00 00 00 00 00 00 00 00 00 00  - .4..............\n\nBut we receive ... SEND_BODY_CHUNK of leght 4, i.e. client flush (!)\n\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [debug]\najp_connection_tcp_get_message::jk_ajp_common.c (1336): received from\najp13 pos=0 len=4 max=16\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [debug]\najp_connection_tcp_get_message::jk_ajp_common.c (1336): 0000    03 00 00\n00 00 00 00 00 00 00 00 00 00 00 00 00  - ................\n\nOops - better close stuff etc. From here things just shutdown\n\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [warn]\najp_handle_cping_cpong::jk_ajp_common.c (906): awaited reply cpong,\nreceived 3 (0 / 5) instead. Closing connection\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [debug]\njk_shutdown_socket::jk_connect.c (722): About to shutdown socket 17\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [debug]\njk_shutdown_socket::jk_connect.c (803): shutting down the read side of\nsocket 17\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [debug]\njk_shutdown_socket::jk_connect.c (813): Shutdown socket 17 and read 5\nlingering bytes in 0 sec.\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [info]\najp_send_request::jk_ajp_common.c (1518): (jvm1) failed sending request,\nsocket -1 prepost cping/cpong failure (errno=0)\n[Mon Sep 13 11:47:38.536 2010] [31728:1147218240] [info]\najp_send_request::jk_ajp_common.c (1574): (jvm1) all endpoints are\ndisconnected, detected by connect check (0), cping (1), send (0)\n\nThus resulting in broken behaviour because left-over flush method was\npresent in queue.\n\nHas anyone seen this before? Can anyone help?\n\nThanks,\n\nAdditional information:\n\nworkers.properties:\nworker.list=jk-status\nworker.jk-status.type=status\nworker.jk-status.read_only=true\nworker.list=jk-manager\nworker.jk-manager.type=status\nworker.list=balancer\nworker.balancer.type=lb\nworker.balancer.error_escalation_time=0\nworker.balancer.max_reply_timeouts=10\nworker.balancer.balance_workers=jvm1\nworker.balancer.balance_workers=jvm2\nworker.jvm2.reference=worker.template\nworker.jvm2.host=fmp-dun-tapp2\nworker.jvm2.port=10303\nworker.jvm2.activation=A\n\n# Used for jkmanager / status\nworker.list=jvm1\nworker.jvm1.reference=worker.template\nworker.jvm1.host=localhost\nworker.jvm1.port=10303\nworker.jvm1.activation=A\n\nworker.template.type=ajp13\nworker.template.socket_connect_timeout=5000\nworker.template.socket_keepalive=true\nworker.template.ping_mode=A\nworker.template.ping_timeout=10000\nworker.template.connection_pool_minsize=0\nworker.template.connection_pool_timeout=600\nworker.template.reply_timeout=300000\nworker.template.recovery_options=3\n\nmod_jk.conf:\nLoadModule jk_module modules/mod_jk.so\n\n<IfModule jk_module>\n    JkWorkersFile components/workers.properties\n    JkLogFile \"|/usr/sbin/rotatelogs /var/log/httpd/mod_jk_log 86400\"\n    JkLogLevel info\n    JkShmFile logs/mod_jk.shm\n    LogFormat \"%v %h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\"\n\\\"%{User-Agent}i\\\" \\\"%{Cookie}i\\\" \\\"%{Set-Cookie}o\\\" %{pid}P %{tid}P\n%{JK_LB_FIRST_NAME}n %{JK_LB_LAST_NAME}n ACC %{JK_LB_LAST_ACCESSED}n ERR\n%{JK_LB_LAST_ERRORS}n BSY %{JK_LB_LAST_BUSY}n %{JK_LB_LAST_STATE}n %D\"\nextended_jk\n    JkStripSession On\n    JkWatchdogInterval 60\n</IfModule>\n\nRelevant httpd.conf global entries:\nTimeout 120\nKeepAlive On\nMaxKeepAliveRequests 0\nKeepAliveTimeout 15\n\n#Worker MPM\nStartServers         2\nMaxClients         150\nMinSpareThreads     25\nMaxSpareThreads     75 \nThreadsPerChild     25\nMaxRequestsPerChild  0\n\nRelevant vhost entry:\n<Directory \"/var/www/files/\" >\n        Options FollowSymLinks\n        AllowOverride None\n        Order allow,deny\n        Allow from all\n</Directory>\n\n<Directory \"/var/www/www.example.com/\" >\n        Options FollowSymLinks\n        AllowOverride None\n        Order allow,deny\n        Allow from all\n</Directory>\n\n<VirtualHost _default_:80>\n        ServerName www.example.com\n        DocumentRoot \"/var/www/www.example.com\"\n        \n        ErrorDocument 404 /404.jsp\n        \n        CacheEnable mem /\n        CacheIgnoreHeaders Set-Cookie\n        # Not available: CacheIgnoreURLSessionIdentifiers jsessionid\n\n        # These files should be made part of the static build structure.\n        Alias /files/ \"/var/www/files/\"\n        \n        JkMount /|* balancer\n        JkUnMount /manager/* balancer\n        JkUnMount /files/* balancer\n        JkStripSession on\n</VirtualHost>\n\n<VirtualHost _default_:443>\n        ServerName www.example.com\n        DocumentRoot \"/var/www/www.example.com\"\n        \n        ErrorDocument 404 /404.jsp\n\n        CacheEnable mem /\n        CacheIgnoreHeaders Set-Cookie\n        # Not available: CacheIgnoreURLSessionIdentifiers jsessionid\n\n        Alias /files/ \"/var/www/files/\"\n                \n        SSLEngine on\n        \n        SSLProtocol All -SSLv2\n        SSLCipherSuite ALL:!aNULL:!ADH:!eNULL:!LOW:!EXP:RC4+RSA:+HIGH:\n+MEDIUM\n        SSLOptions +OptRenegotiate\n        \n        SSLCertificateFile /etc/pki/tls/certs/server.crt\n        SSLCertificateKeyFile /etc/pki/tls/key/server.key\n        SSLCertificateChainFile /etc/pki/tls/certs/server-chain.crt\n        SSLCACertificateFile /etc/pki/tls/certs/ca-bundle.crt \n        \n        SSLVerifyClient none\n        \n        SSLOptions +FakeBasicAuth +ExportCertData +StrictRequire\n        <Files ~ \"\\.(cgi|shtml|phtml|php3?)$\">\n            SSLOptions +StdEnvVars\n        </Files>\n        <Directory \"/var/www/cgi-bin\">\n            SSLOptions +StdEnvVars\n        </Directory>\n        \n        SetEnvIf User-Agent \".*MSIE.*\" \\\n                 nokeepalive ssl-unclean-shutdown \\\n                 downgrade-1.0 force-response-1.0\n\n        JkMount /|* balancer\n        \n        JkUnMount /manager/* balancer\n        JkUnMount /files/* balancer\n        JkStripSession on\n</VirtualHost>\n\nTomcat server.xml\n\n<?xml version='1.0' encoding='utf-8'?>\n<Server port=\"10300\" shutdown=\"SHUTDOWN\">\n\n        <Listener\nclassName=\"org.apache.catalina.core.AprLifecycleListener\"\n                SSLEngine=\"on\" />\n        <Listener className=\"org.apache.catalina.core.JasperListener\" />\n        <Listener\nclassName=\"org.apache.catalina.core.JreMemoryLeakPreventionListener\" />\n        <Listener\nclassName=\"org.apache.catalina.mbeans.ServerLifecycleListener\" />\n        <Listener\nclassName=\"org.apache.catalina.mbeans.JmxRemoteLifecycleListener\"\n                rmiRegistryPortPlatform=\"10301\"\n                rmiServerPortPlatform=\"10302\"\n                useLocalPorts=\"true\" />\n        <Listener\nclassName=\"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener\" />\n\n        <GlobalNamingResources>\n                <Resource name=\"UserDatabase\" auth=\"Container\"\n                        type=\"org.apache.catalina.UserDatabase\"\ndescription=\"User database\nthat can be updated and saved\"\n                        factory=\"org.apache.catalina.users.MemoryUserDatabaseFactory\"\n                        pathname=\"conf/tomcat-users.xml\" />\n\n        </GlobalNamingResources>\n\n        <Service name=\"Catalina\">\n\n                <Executor name=\"ajpThreadPool\" namePrefix=\"tc-ajp-exec-\"\n                        maxThreads=\"200\" minSpareThreads=\"4\" />\n                <Executor name=\"httpThreadPool\" namePrefix=\"tc-http-exec-\"\n                        maxThreads=\"50\" minSpareThreads=\"4\" />\n                <Connector executor=\"ajpThreadPool\"\nenableLookups=\"false\"\n                        port=\"10303\"\nprotocol=\"org.apache.coyote.ajp.AjpAprProtocol\"\n                        redirectPort=\"443\" />\n\n                <Connector executor=\"httpThreadPool\"\nenableLookups=\"false\"\n                        port=\"10304\"\nprotocol=\"org.apache.coyote.http11.Http11NioProtocol\"\n                        connectionTimeout=\"20000\"\nredirectPort=\"10305\" />\n                <Connector executor=\"httpThreadPool\"\nenableLookups=\"false\"\n                        port=\"10305\"\nprotocol=\"org.apache.coyote.http11.Http11AprProtocol\"\n                        SSLEnabled=\"true\" scheme=\"https\" secure=\"true\"\nconnectionTimeout=\"20000\"\n                        SSLCACertificateFile=\"${tomcat.directconn.SSLCACertificateFile}\"\n\nSSLCertificateChainFile=\"${tomcat.directconn.SSLCertificateChainFile}\"\n                        SSLCertificateFile=\"${tomcat.directconn.SSLCertificateFile}\"\n                        SSLCertificateKeyFile=\"${tomcat.directconn.SSLCertificateKeyFile}\"\n                        SSLProtocol=\"TLSv1\" />\n\n                <Engine name=\"Catalina\" defaultHost=\"localhost\"\n                        jvmRoute=\"jvm${tomcat.clusterid}\">\n\n                        <Cluster\nclassName=\"org.apache.catalina.ha.tcp.SimpleTcpCluster\"\n                                channelSendOptions=\"6\">\n\n                                <Manager\nclassName=\"org.apache.catalina.ha.session.BackupManager\"\n                                        expireSessionsOnShutdown=\"false\"\nnotifyListenersOnReplication=\"true\"\n                                        mapSendOptions=\"6\" />\n                                <Channel\nclassName=\"org.apache.catalina.tribes.group.GroupChannel\">\n                                        <Membership\nclassName=\"org.apache.catalina.tribes.membership.McastService\"\n                                                address=\"228.0.0.4\"\nport=\"45564\" frequency=\"500\"\ndropTime=\"3000\" />\n                                        <Receiver\nclassName=\"org.apache.catalina.tribes.transport.nio.NioReceiver\"\n                                                address=\"auto\"\nport=\"5000\" selectorTimeout=\"100\" maxThreads=\"6\" />\n\n                                        <Sender\n\nclassName=\"org.apache.catalina.tribes.transport.ReplicationTransmitter\">\n                                                <Transport\n\nclassName=\"org.apache.catalina.tribes.transport.nio.PooledParallelSender\" />\n                                        </Sender>\n                                        <Interceptor\n\nclassName=\"org.apache.catalina.tribes.group.interceptors.TcpFailureDetector\" />\n                                        <Interceptor\n\nclassName=\"org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor\" />\n                                        <Interceptor\n\nclassName=\"org.apache.catalina.tribes.group.interceptors.ThroughputInterceptor\" />\n                                </Channel>\n\n                                <Valve\nclassName=\"org.apache.catalina.ha.tcp.ReplicationValve\"\n                                        filter=\".*\\.gif;.*\\.js;.*\n\\.jpg;.*\\.png;.*\\.htm;.*\\.html;.*\\.css;.*\n\\.txt;\"\n                                        statistics=\"true\" />\n\n                                <Valve\nclassName=\"org.apache.catalina.ha.session.JvmRouteBinderValve\" />\n\n                                <ClusterListener\n\nclassName=\"org.apache.catalina.ha.session.JvmRouteSessionIDBinderListener\" />\n                                <ClusterListener\n\nclassName=\"org.apache.catalina.ha.session.ClusterSessionListener\" />\n                        </Cluster>\n\n                        <Realm\nclassName=\"org.apache.catalina.realm.UserDatabaseRealm\"\n                                resourceName=\"UserDatabase\" />\n\n                        <Host name=\"localhost\" appBase=\"webapps\"\nunpackWARs=\"false\"\n                                autoDeploy=\"false\" xmlValidation=\"false\"\nxmlNamespaceAware=\"false\">\n                        </Host>\n                        <Host name=\"aob\" appBase=\"aob\"\n                                unpackWARs=\"false\" autoDeploy=\"false\"\nxmlValidation=\"false\"\n                                xmlNamespaceAware=\"false\">\n                                <Alias>example2.com</Alias>\n                        </Host>\n                </Engine>\n        </Service>\n</Server>", "is_private": false, "bug_id": 49929, "id": 139867, "time": "2010-09-14T11:52:20Z", "creator": "brett.dellegrazie@intact-is.com", "creation_time": "2010-09-14T11:52:20Z", "attachment_id": null}, {"count": 1, "tags": [], "text": "There was a patch supplied by Rainer Jung which we used to get more information out of mod_jk.  It was how we realised there were out-of order messages in the queue on the Tomcat side.\n\nPatch:\n--- jk_ajp_common.c     2010-02-23 08:26:02.000000000 +0100\n+++ jk_ajp_common.c.debug       2010-09-02 18:24:41.429730000 +0200\n@@ -904,9 +904,9 @@\n                        cmd < JK_AJP13_SEND_BODY_CHUNK ||\n                        cmd > AJP13_CPONG_REPLY) {\n                    jk_log(l, JK_LOG_WARNING,\n-                       \"awaited reply cpong, received %d instead. \"\n+                       \"awaited reply cpong, received %d (%d / %d) \n instead. \"\n                        \"Closing connection\",\n-                       cmd);\n+                       cmd, i, ae->last_op);\n                   /* We can't trust this connection any more. */\n                   ajp_abort_endpoint(ae, JK_TRUE, l);\n                   JK_TRACE_EXIT(l);", "attachment_id": null, "bug_id": 49929, "id": 139868, "time": "2010-09-14T11:56:10Z", "creator": "brett.dellegrazie@intact-is.com", "creation_time": "2010-09-14T11:56:10Z", "is_private": false}, {"count": 2, "tags": [], "creator": "brett.dellegrazie@intact-is.com", "attachment_id": null, "is_private": false, "id": 139869, "time": "2010-09-14T11:59:23Z", "bug_id": 49929, "creation_time": "2010-09-14T11:59:23Z", "text": "Mladen Turk wrote in email on tomcat-users list [Tue, 14 Sep 2010 07:50:55 +0200]:\n\nFor AJP APR connector 'if (actionCode == ActionCode.ACTION_CLIENT_FLUSH)'\ndoesn't check if the socket was already virtually closed\nso I guess that would be a first thing to look at.\nWe cannot just check for finished flag thought, cause recycle() would reset that.\nInstead if there was getOutputSteam() we would need to directly\ninvalidate that stream. This means we would need to remember that stream\nsomewhere.\n\nFurther more the wrapped socket is 'long' pointing to the\nnative pointer, so we don't have object notification on\nphysical socket close (that's another problem that manifests\nin JVM core for detached sockets)."}, {"attachment_id": null, "tags": [], "creator": "mturk@apache.org", "is_private": false, "count": 3, "id": 139870, "time": "2010-09-14T12:25:33Z", "bug_id": 49929, "creation_time": "2010-09-14T12:25:33Z", "text": "Thanks for filing that. I'll take a look into that.\nIt would be nice if you could provide a simple jsp or\nservlet test case (without third party packages)\nto speed up the hacking."}, {"attachment_id": 26055, "tags": [], "creator": "brett.dellegrazie@intact-is.com", "is_private": false, "count": 4, "id": 139975, "time": "2010-09-20T09:07:58Z", "bug_id": 49929, "creation_time": "2010-09-20T09:07:58Z", "text": "Created attachment 26055\ntestcase: Servlet for writing directly to output stream\n\nThis is a test servlet for writing simple data directly to the output stream. It should trigger the issue in this bug"}, {"count": 5, "tags": [], "text": "I have tried your test servlet, but I cannot see anything suspicious.\nThere is no additional packets following the lorem ipsum.\nTested on Tomcat 6.0.29, 6.0.x trunk and Tomcat 7.\nBoth APR and JIO endpoints behave the same.", "attachment_id": null, "bug_id": 49929, "id": 140027, "time": "2010-09-21T13:00:11Z", "creator": "mturk@apache.org", "creation_time": "2010-09-21T13:00:11Z", "is_private": false}, {"count": 6, "tags": [], "creator": "brett.dellegrazie@intact-is.com", "attachment_id": null, "is_private": false, "id": 140028, "time": "2010-09-21T13:19:54Z", "bug_id": 49929, "creation_time": "2010-09-21T13:19:54Z", "text": "Hi,\n\nWhen using the test servlet the problem appears on the next request when its on the same socket so its a good idea to have a static file around to request immediately after executing the test servlet.  The way we did this was to use Jmeter with only 1 thread but executing the two requests in sequence with no wait time.\n\nWith Apache HTTPD you should see mod_jk (in debug mode) detect an explicit flush packet and reset the socket instead of the usual CPONG expected response as reported originally.\n\nThanks,\n\nBrett"}, {"count": 7, "tags": [], "creator": "mturk@apache.org", "attachment_id": null, "id": 140134, "time": "2010-09-24T02:51:11Z", "bug_id": 49929, "creation_time": "2010-09-24T02:51:11Z", "is_private": false, "text": "I'm still not been able to reproduce the stuff.\nI don't use jmeter but rather a simple ab which can only hit a\nsingle uri, so this might be the reason why its not manifested there.\n\nBTW, does it happen only with APR connector, or with JIO as well?"}, {"count": 8, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 140412, "time": "2010-10-03T16:28:07Z", "bug_id": 49929, "creation_time": "2010-10-03T16:28:07Z", "is_private": false, "text": "I can't reproduce this with the latest Tomcat 6 code with either the BIO AJP connector or the APR AJP connector. A check of the mod_jk debug log confirms that that cping/cpong works as expected.\n\nI have been using the supplied Servlet and a 46k static file.\n\nWithout a test case to reproduce this issue, this bug is heading towards being closed as \"works for me\" ."}, {"count": 9, "tags": [], "creator": "brett.dellegrazie@intact-is.com", "attachment_id": null, "id": 140436, "time": "2010-10-04T08:06:20Z", "bug_id": 49929, "creation_time": "2010-10-04T08:06:20Z", "is_private": false, "text": "(In reply to comment #8)\n> I can't reproduce this with the latest Tomcat 6 code with either the BIO AJP\n> connector or the APR AJP connector. A check of the mod_jk debug log confirms\n> that that cping/cpong works as expected.\n> \n> I have been using the supplied Servlet and a 46k static file.\n> \n> Without a test case to reproduce this issue, this bug is heading towards being\n> closed as \"works for me\" .\n\nHi,\n\nI've tried to reproduce this in a test application as well and the problem just doesn't occur.  At present, we can only generate it using our application, sorry.\n\nDon't know how to progress this further now. :(\n\nRegards,\n\nBrett"}, {"count": 10, "attachment_id": null, "creator": "mturk@apache.org", "is_private": false, "id": 140438, "time": "2010-10-04T08:37:44Z", "bug_id": 49929, "creation_time": "2010-10-04T08:37:44Z", "tags": [], "text": "The test solution would have to use the same sort of writer\n(image in your case I suppose)\nWe know that image classes can crash the APR connector because\nthey try to manage the socket by themselves so double close\ncan occur. This might also cause the SBC to been send after\nthe EOR since with AJP the physical socket is not closed.\n\nAgain without a workable test case it's just a guess."}, {"count": 11, "tags": [], "text": "Without a reproducible test case this is eventually going to get closed as WONTFIX.", "attachment_id": null, "bug_id": 49929, "id": 143090, "time": "2011-01-05T10:10:23Z", "creator": "markt@apache.org", "creation_time": "2011-01-05T10:10:23Z", "is_private": false}, {"count": 12, "tags": [], "text": "Can you check if r1066772 fixes the issue?\nIt's for trunk, but applying it for 6.0.x should be trivial", "attachment_id": null, "bug_id": 49929, "id": 143950, "time": "2011-02-03T05:25:24Z", "creator": "mturk@apache.org", "creation_time": "2011-02-03T05:25:24Z", "is_private": false}, {"count": 13, "tags": [], "creator": "brett.dellegrazie@intact-is.com", "attachment_id": null, "is_private": false, "id": 143951, "time": "2011-02-03T05:32:12Z", "bug_id": 49929, "creation_time": "2011-02-03T05:32:12Z", "text": "Hi Mladen,\n\nWe switched from using Apache HTTPD to HAproxy late last year because of this issue... therefore it might take me quite a while to verify this.\nI'll try, but no guarantees.\n\nBest Regards,\n\nBrett"}, {"count": 14, "tags": [], "creator": "michael.ballantyne@gmail.com", "attachment_id": null, "id": 145246, "time": "2011-03-24T22:44:27Z", "bug_id": 49929, "creation_time": "2011-03-24T22:44:27Z", "is_private": false, "text": "Hey - we just ran into this issue this week, and I finally managed to track it down to this bug after a good two days of work. Gotta get this fixed. I will attempt to both come up with a simple test case and try the provided patch next week."}, {"count": 15, "attachment_id": null, "creator": "markt@apache.org", "is_private": false, "id": 147605, "time": "2011-06-29T13:31:48Z", "bug_id": 49929, "creation_time": "2011-06-29T13:31:48Z", "tags": [], "text": "I've proposed r1066772 for 6.0.x since it is the right thing to do and it may help fix this issue. Confirmation that it does fix it would still be helpful."}, {"count": 16, "tags": [], "text": "The fix has been back-ported and absent any reports to the contrary, the assumption is that the issue is fixed.", "is_private": false, "id": 148609, "creation_time": "2011-08-15T10:42:50Z", "time": "2011-08-15T10:42:50Z", "creator": "markt@apache.org", "bug_id": 49929, "attachment_id": null}]