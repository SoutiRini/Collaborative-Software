[{"count": 0, "tags": [], "text": "Created attachment 28863\nTest web application\n\nHi,\n\nI have a web application (attached) that specifies env-entry in the web.xml. The env-entry does not specify env-entry-type, but specifies injection-target. When deploying that web application, the exception below is thrown:\n\n\nCaused by: java.lang.NullPointerException\n\tat java.util.Hashtable.put(Hashtable.java:394)\n\tat org.apache.catalina.deploy.NamingResources.addEnvironment(NamingResources.java:254)\n\tat org.apache.catalina.deploy.WebXml.configureContext(WebXml.java:1195)\n\tat org.apache.catalina.startup.ContextConfig.webConfig(ContextConfig.java:1294)\n\tat org.apache.catalina.startup.ContextConfig.configureStart(ContextConfig.java:855)\n\tat org.apache.catalina.startup.ContextConfig.lifecycleEvent(ContextConfig.java:345)\n\tat org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:119)\n\tat org.apache.catalina.util.LifecycleBase.fireLifecycleEvent(LifecycleBase.java:90)\n\tat org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:5161)\n\tat org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:150)\n\n\nServlet Specification, 14.4 Deployment Descriptor Diagram, describes that use case and how it should be handled:\n\"\nenv-entry element\nIf an injection-target is specified for the environment entry, the enventry-\ntype may be ommitted or MUST match the type of the injection target. If\nno injection-target is specified, the env-entry-type is required.\n\"\n\n\nI would like to propose a patch (attached) that solves this issue.\n\nI'm looking forward for your comments.\n\nThanks\nVioleta\n\n\nSteps to reproduce the problem:\n1. Deploy the attached application\n2. Request http://localhost:8080/test/TestServlet\n3. NPE is thrown\n4. Apply the provided patch\n5. Request http://localhost:8080/test/TestServlet\n6. The following response should be generated:\nenvEntry_1: 1 \nenvEntry_2: 2 \ndataSource: org.apache.tomcat.dbcp.dbcp.BasicDataSource@506dd108", "is_private": false, "id": 159541, "creator": "violetagg@apache.org", "time": "2012-05-30T19:28:00Z", "bug_id": 53333, "creation_time": "2012-05-30T19:28:00Z", "attachment_id": 28863}, {"count": 1, "attachment_id": 28864, "bug_id": 53333, "is_private": false, "id": 159542, "time": "2012-05-30T19:41:54Z", "creator": "violetagg@apache.org", "creation_time": "2012-05-30T19:41:54Z", "tags": [], "text": "Created attachment 28864\nPatch proposal"}, {"count": 2, "tags": [], "bug_id": 53333, "attachment_id": null, "id": 159624, "time": "2012-06-01T20:05:03Z", "creator": "markt@apache.org", "creation_time": "2012-06-01T20:05:03Z", "is_private": false, "text": "Thanks for pointing this out. It is definitely a bug.\n\nAs I started to look at this I found some clean-up that could be done. It changes the failure point although I think the patch is currently trying to identify the type at the correct point. However, I'm not sure that NamingResources is the best home for the actual functionality. I think some refactoring may be in order. I'm looking at the now.\n\nI also think that the specification wording is ambiguous. There is\n<quote>\ntype may be ommitted or MUST match the type of the injection target\n</quote>\nand\n<quote>\ntype MUST be assignment compatible with the type of the injection target\n</quote>\n\nClearly the wording is different but I am not convinced that the meaning is. It depends what is meant by \"match\". I am leaning towards implementing the more flexible \"assignment compatible\" in all cases."}, {"count": 3, "tags": [], "bug_id": 53333, "attachment_id": null, "is_private": false, "id": 159643, "time": "2012-06-02T21:31:45Z", "creator": "markt@apache.org", "creation_time": "2012-06-02T21:31:45Z", "text": "Thanks for the suggested patch. I used it as a basis for the committed solution although I tweaked the code a little and made it more relaxed regarding inputs. Generally, as long as the types are compatible - it will work.\n\nThe change has been applied to trunk and 7.0.x and will be included in 7.0.28 onwards."}, {"count": 4, "tags": [], "text": "Thanks", "is_private": false, "id": 159647, "creator": "violetagg@apache.org", "time": "2012-06-03T15:21:16Z", "bug_id": 53333, "creation_time": "2012-06-03T15:21:16Z", "attachment_id": null}]