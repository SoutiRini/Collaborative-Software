[{"count": 0, "tags": [], "bug_id": 38864, "is_private": false, "text": "I want to proxy (loadbalance) all jsp and frm requests to tomcat through the\nproxy and LB modules, and I cannot.\n\n  I have the proxying/LBing working correctly for the following:\n\n<LocationMatch \"/myproject\">\n  ProxyPass balancer://myCluster/myproject stickysession=JSESSIONID\n  ProxyPassReverse balancer://myCluster/bpsproject\n  Order Deny,Allow\n  Allow from all\n</LocationMatch>\n\nNow, when I try to use a regular expression to proxy .jsp and .frm requests,\nthere is no proxying done all.  This is what I use:\n\n<LocationMatch \"^/myproject/.+\\.(jsp|frm)$\">\n  ProxyPass        balancer://myCluster/myproject stickysession=JSESSIONID\n  ProxyPassReverse balancer://myCluster/bpsproject\n  Order Deny,Allow\n  Allow from all\n</LocationMatch>\n\nIn the error log I get a 404 error:\n[Mon Mar 06 10:45:41 2006] [error] [client 10.0.0.152] File does not exist:\nC:/dwfa/runtime/apache/httpd/html/myproject/login.jsp\n\nI have tried this with win32 (got binary) and linux (built) with the same results.", "id": 86526, "time": "2006-03-06T16:00:19Z", "creator": "douglas.acheson@bpsserver.com", "creation_time": "2006-03-06T16:00:19Z", "attachment_id": null}, {"count": 1, "tags": [], "text": "*** Bug 38865 has been marked as a duplicate of this bug. ***", "attachment_id": null, "id": 86543, "creation_time": "2006-03-06T20:20:49Z", "time": "2006-03-06T20:20:49Z", "creator": "kess@kess-net.de", "bug_id": 38864, "is_private": false}, {"count": 2, "tags": [], "text": "The configuration snipit is really\n<LocationMatch \"^/myproject/.+\\.(jsp|frm)$\">\n  ProxyPass        balancer://myCluster/myproject stickysession=JSESSIONID\n  ProxyPassReverse balancer://myCluster/myproject\n  Order Deny,Allow\n  Allow from all\n</LocationMatch>\n\nI had a typo in the one originally posted.  Still have tht same issue", "attachment_id": null, "id": 86545, "creation_time": "2006-03-06T20:49:37Z", "time": "2006-03-06T20:49:37Z", "creator": "douglas.acheson@bpsserver.com", "bug_id": 38864, "is_private": false}, {"count": 3, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "id": 86546, "time": "2006-03-06T21:24:32Z", "bug_id": 38864, "creation_time": "2006-03-06T21:24:32Z", "is_private": false, "text": "ProxyPass does not work with regular expressions. Thus it does not work inside\nLocationMatch. Apart from the discussion if this is a bug and if yes if it is a\nbug in the documentation or in the code you can use mod_rewrite to solve your\nproblem:\n\nRewriteEngine on\nRewriteRule (^/myproject/.+\\.(jsp|frm)$) balancer://myCluster$1\n\n<Proxy balancer://myCluster>\nBalancerMember http://127.0.0.1:8080\nBalancerMember http://127.0.0.1:8081 \nProxySet stickysession=JSESSIONID\n</Proxy>\n\nProxyPassReverse /myproject http://127.0.0.1:8080/myproject\nProxyPassReverse /myproject http://127.0.0.1:8081/myproject\n\nPlease keep in mind that you MUST use ProxySet AFTER the BalancerMember directives.\n\n"}, {"count": 4, "tags": [], "text": "Thx your for your reply.  A couple of things:\n\n1. I could not find, but does not mean it does not exist, documentation about\nproxy and REs.  But, if it does not work, so be it.\n\n2.  Not sure why LocationMatch and proxy work to tightly.  Here is my simple\nview of how I thought it should work:\n  if the incoming URL matches the grammar supplied by the RE in LocationMatch\n    do the work (in this case proxy the request)\nI do not understand why proxy needs to know about RE as, IMHO, only\nLocationMatch needs to do the patching.\n\n3. I really appreciate an alternate solution.  I have tried that and it does not\nwork (as I expect).  If I take what you supplied I get tomcat serving up\neverything (jsp, gif, etc).  So I went and read up on RewriteRule and found out\nthat I should use the [p] token at the end of the \"rule\".  When I tried this,\nnothing works.  So I am really confused now.\n\n4.  I do not understand why the ProxyPassReverse is written in that manor.  Why\ndoes it use http as the protocol and why must I specify every member?  Should I\nnot be able to use balancer as the protocol.\n\n4.  Since my original defect report,t in all honestly has been resolved, I\nunderstand if you want to close this ticket.\n\nHere is my new snippet I used:\n\n<IfDefine rewrite>\n  RewriteEngine On\n \n  <Proxy balancer://myCluster>\n    BalancerMember ajp://10.0.0.152:8009 loadfactor=100 route=152\n    BalancerMember ajp://10.0.0.153:8009 loadfactor=100 route=153\n    ProxySet stickysession=JSESSIONID\n    Order Deny,Allow\n    Allow from all\n  </Proxy>\n\n  RewriteRule (^/myproject/.+\\.(jsp|html|form))  balancer://myCluster$0\n  #RewriteRule (^/myproject/.+\\.(jsp|html|form)) balancer://myCluster$0 [p]\n\n  ProxyPassReverse /myproject http://10.0.0.152:8080/myproject\n  ProxyPassReverse /myproject http://10.0.0.153:8080/myproject\n\n  <Location /balancer-manager>\n    SetHandler balancer-manager\n    Order Deny,Allow\n    Allow from all\n  </Location>\n\n</IfDefine>", "attachment_id": null, "bug_id": 38864, "id": 86612, "time": "2006-03-08T19:36:39Z", "creator": "douglas.acheson@bpsserver.com", "creation_time": "2006-03-08T19:36:39Z", "is_private": false}, {"count": 5, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "id": 86614, "time": "2006-03-08T20:37:00Z", "bug_id": 38864, "creation_time": "2006-03-08T20:37:00Z", "is_private": false, "text": "(In reply to comment #4)\n\n> \n> 2.  Not sure why LocationMatch and proxy work to tightly.  Here is my simple\n> view of how I thought it should work:\n>   if the incoming URL matches the grammar supplied by the RE in LocationMatch\n>     do the work (in this case proxy the request)\n> I do not understand why proxy needs to know about RE as, IMHO, only\n> LocationMatch needs to do the patching.\n\nThat is due to how the internal processing works. I admit that this is not\nlogical from a users perspective view. Basicly a ProxyPass inside a Location or\nLocationMatch container is transformed to ProxyPass <string of\nLocationcontainer> <proxytarget> during the parsing of the configuration. So in\nyour example this gets transformed to\nProxyPass ^/myproject/.+\\.(jsp|frm)$ balancer://myCluster/myproject\nStickysession=JSESSIONID\n\nAs ProxyPass does not know anything about RE it tries to match the URL plain\nagainst ^/myproject/.+\\.(jsp|frm)$ which cannot work for obvious reasons.\n\n> \n> 3. I really appreciate an alternate solution.  I have tried that and it does not\n> work (as I expect).  If I take what you supplied I get tomcat serving up\n> everything (jsp, gif, etc).  So I went and read up on RewriteRule and found \nout\n> that I should use the [p] token at the end of the \"rule\".  When I tried this,\n\nAh, sorry a copy and paste error from my side. It should have been\n\nRewriteRule (^/myproject/.+\\.(jsp|frm)$) balancer://myCluster$1 [P]\n\nAstonishing that this worked at all without the [P] flag.\n\n> nothing works.  So I am really confused now.\n\nIt should work. I tested it in my environment. You have an error in your config\n(see below)\n\n> \n> 4.  I do not understand why the ProxyPassReverse is written in that manor.  Why\n> does it use http as the protocol and why must I specify every member?  Should I\n> not be able to use balancer as the protocol.\n\nNo. ProxyPassReverse works like a lookup table. It checks possible Location\nheaders of the HTTP responses from the backend and transforms them into the\ncorrect ones (by using the lookup table) to make redirects work. But the backend\nservers do know nothing about the balancer scheme. So they put in their local\nname (http://127.0.0.1:8080 and http://127.0.0.1:8081 in your case) in their\nLocation headers.\n\n\n> \n>   RewriteRule (^/myproject/.+\\.(jsp|html|form))  balancer://myCluster$0\n>   #RewriteRule (^/myproject/.+\\.(jsp|html|form)) balancer://myCluster$0 [p]\n\nThe error is $0 at the end. It must be $1. Please use the line with the [P] flag\nat the end.\n\n"}, {"count": 6, "tags": [], "text": "Thanks I got it working.  Appreciate all your help ...", "attachment_id": null, "bug_id": 38864, "id": 86642, "time": "2006-03-09T15:33:08Z", "creator": "douglas.acheson@bpsserver.com", "creation_time": "2006-03-09T15:33:08Z", "is_private": false}, {"count": 7, "tags": [], "creator": "steve@lightyearsoftware.com", "attachment_id": null, "is_private": false, "id": 124871, "time": "2009-02-16T08:59:32Z", "bug_id": 38864, "creation_time": "2009-02-16T08:59:32Z", "text": "This bug is marked resolved and fixed, but it doesn't work in the current 2.2.11 release. ProxyPassReverse, in particular, still does not function inside LocationMatch as an end-user expects it to after reading the 2.2 documentation.\n\nI'm trying to account for case sensitivity on a proxied prefix, e.g.:\n\n<LocationMatch ^(?i)/foo/>\n    ProxyPassReverse http://foo.backend.server/\n</LocationMatch>\n\nPer http://www.apachetutor.org/admin/reverseproxies, ProxyPassReverse should be set up like this to account for broken applications that issue a redirect using only the path instead of a full URL.\n\nMainly I'm interested in clarification on this bug. Should it work? If so, there is a regression in the current stable release.\n\nIf it is known not to work and there is no intention to fix it, I think the documentation should be updated to explicitly state that the directives do not work inside Location using the ~ syntax or in LocationMatch."}, {"count": 8, "tags": [], "creator": "nick@webthing.com", "text": "(In reply to comment #7)\n> This bug is marked resolved and fixed, but it doesn't work in the current\n> 2.2.11 release. ProxyPassReverse, in particular, still does not function inside\n> LocationMatch as an end-user expects it to after reading the 2.2 documentation.\n\nYou have indeed found a rather serious regression.\n\nIt's actually in mod_proxy, and can be worked around by replacing your\nProxyPassReverse /\nwith\nProxyPassReverse balancer:///\n(note three slashes are not a typo)!  It doesn't matter that you're not using the balancer - this is just a failure in the parsing of the URL in the response header.\n\nNot sure when this happened, but it appears to go back quite some time.\nGuess I need to fix both the code and the tutorial!", "id": 133103, "time": "2009-12-23T16:36:54Z", "bug_id": 38864, "creation_time": "2009-12-23T16:36:54Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "creator": "nick@webthing.com", "attachment_id": null, "is_private": false, "id": 133112, "time": "2009-12-25T07:28:31Z", "bug_id": 38864, "creation_time": "2009-12-25T07:28:31Z", "text": "Just fixed in trunk in r893871\nWill upload patch in a moment."}, {"count": 10, "tags": [], "bug_id": 38864, "attachment_id": 24757, "id": 133113, "time": "2009-12-25T07:31:18Z", "creator": "nick@webthing.com", "creation_time": "2009-12-25T07:31:18Z", "is_private": false, "text": "Created attachment 24757\npatch\n\ntrunk patch, works with 2.2.x versions."}, {"count": 11, "tags": [], "bug_id": 38864, "attachment_id": null, "text": "(In reply to comment #8)\n> (In reply to comment #7)\n> > This bug is marked resolved and fixed, but it doesn't work in the current\n> > 2.2.11 release. ProxyPassReverse, in particular, still does not function inside\n> > LocationMatch as an end-user expects it to after reading the 2.2 documentation.\n> \n> You have indeed found a rather serious regression.\n\n... which is not the problem you were asking about - sorry for the distraction, and thanks to rpluem for pointing it out.  I might look at that too, but supporting regexps is new code, and more likely to happen in 2.3/2.4 (which alreasy supports regexps in related areas like ProxyPass).", "id": 133119, "time": "2009-12-25T14:17:21Z", "creator": "nick@webthing.com", "creation_time": "2009-12-25T14:17:21Z", "is_private": false}, {"count": 12, "tags": [], "creator": "calestyo@scientia.net", "attachment_id": null, "id": 163975, "time": "2012-12-08T23:58:37Z", "bug_id": 38864, "creation_time": "2012-12-08T23:58:37Z", "is_private": false, "text": "Quite some time old...\n\nCould someone tell me whether this is still an issue?"}, {"count": 13, "tags": [], "bug_id": 38864, "is_private": false, "id": 165251, "creation_time": "2013-02-14T22:22:28Z", "time": "2013-02-14T22:22:28Z", "creator": "a.pantani@gmail.com", "text": "the directive ProxyPassReverse works correctly also in the form \n\"ProxyPassReverse /\" inside <Location>. Just tested with Location containing full URL. I couldn't reproduce the buggy case with just path in location header.\nThe Apache version used is 2.4.3\n\nAs regard the error got with ProxyPassReverse inside <LocationMatch>, it is not correct to set it as bug, because, as stated in the offcial documentation, the RE is not treated as such by ProxyPassReverse \n\n\".... When used inside a <Location> section, the first argument is omitted and the local directory is obtained from the <Location>. The same occurs inside a <LocationMatch> section, but will probably not work as intended, as ProxyPassReverse will interpret the regexp literally as a path;....\"\n\nSo I find correct to set this item as enhancement. It should be closed when a sort of ProxyPassReverseMatch will be implemented.", "attachment_id": null}]