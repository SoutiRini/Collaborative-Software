[{"count": 0, "tags": [], "bug_id": 51444, "attachment_id": 27221, "id": 147549, "time": "2011-06-28T09:51:50Z", "creator": "milan.chudik@mapflow.com", "creation_time": "2011-06-28T09:51:50Z", "is_private": false, "text": "Created attachment 27221\nJunit test file, workbook.xls,workbook.xlsx\n\nhi,\n\nI just experience strange fact that is similar to bug 51158, but not really the same.\n\nWhen I create workbook \"by hand\" via new operator, I can store XSSFWorkbook to a file(outputstream), that works ok(I don't need to store it twice-though it yields error too)\nBut when I read a workbook from a stream, let's say file, and store it to another file, virtually creating a copy, then the result file is unreadable.\n\nUse case is, that I want to report only one sheet(current) I'm working on, then I create a XSSFWorkbook from InputStream, remove unnecessary sheets and then store it via write method to a new OutStream and passes that stream further for processing. BUT this stream is unreadable, if I want to read from this stream I get this exception:\n\nava.lang.NullPointerException\n        at org.apache.poi.POIXMLDocumentPart.read(POIXMLDocumentPart.java:256)\n        at org.apache.poi.POIXMLDocument.load(POIXMLDocument.java:186)\n        at org.apache.poi.xssf.usermodel.XSSFWorkbook.<init>(XSSFWorkbook.java:182)\n        at org.apache.poi.ss.usermodel.WorkbookFactory.create(WorkbookFactory.java:63)\n\nIf I write it to a file, file is unreadable.\nI debugged it it I find out, that writing fails on \"Dublicate entry: docProps/core.xml\" in I think DefaultMarshaller(exception is caught in org.apache.poi.openxml4j.opc.ZipPackage.saveImpl)\n\nI attach test file that demonstrates issues and example excel files.\n\nI experience this error both in 3.7 and 3.8-beta3\nRegards,\n\nMilan"}, {"count": 1, "attachment_id": null, "bug_id": 51444, "is_private": false, "id": 147558, "time": "2011-06-28T13:36:36Z", "creator": "yegor@dinom.ru", "creation_time": "2011-06-28T13:36:36Z", "tags": [], "text": "The problem occurs only with attached workbook.xlsx. If I create this file with the testCreateXLSXFile() method and pass the result to testReadXLSXFileByeArray() then the test succeeds. \n\nHow did you create workbook.xlsx ? Did you re-save it in Excel after creation? \n\nYegor"}, {"count": 2, "tags": [], "bug_id": 51444, "attachment_id": null, "id": 147559, "time": "2011-06-28T14:14:38Z", "creator": "milan.chudik@mapflow.com", "creation_time": "2011-06-28T14:14:38Z", "is_private": false, "text": "both files are created in libraoffice(former openoffice)\n\nyes I just saved it again as OpenXML file.\n\nHmm, maybe there is a problem with OpenOffice implementation?\n\nStill how can I ensure I will not receive such a file from a third party?\n(we try to process XLS and XLSX files sent from external sources, so we have no control over these files, how they are populated, etc)\nAnd that file can be reopened in OpenOffice as a valid file. So it looks good.\n\nI wrote a workaround that copies XSSFworkbook, sheet by sheet, cell by cell, so I can manage so far, but it would be nice to have same solution both for XSL and XLSX files"}, {"count": 3, "tags": [], "text": "\n(In reply to comment #2)\n> both files are created in libraoffice(former openoffice)\n> \n> yes I just saved it again as OpenXML file.\n> \n> Hmm, maybe there is a problem with OpenOffice implementation?\n> \n> Still how can I ensure I will not receive such a file from a third party?\n> (we try to process XLS and XLSX files sent from external sources, so we have no\n> control over these files, how they are populated, etc)\n> And that file can be reopened in OpenOffice as a valid file. So it looks good.\n> \n> I wrote a workaround that copies XSSFworkbook, sheet by sheet, cell by cell, so\n> I can manage so far, but it would be nice to have same solution both for XSL\n> and XLSX files\n\nIt looks like POI has a problem re-saving files from LibreOffice.\n\nI suspect that the following differences in [Content_Types].xml cause it:\n\nLibreOffice:\n<Types xmlns=\"http://schemas.openxmlformats.org/package/2006/content-types\">\n  <Override PartName=\"/_rels/.rels\" ContentType=\"application/vnd.openxmlformats-package.relationships+xml\"/>\n  <Override PartName=\"/docProps/core.xml\" ContentType=\"application/vnd.openxmlformats-package.core-properties+xml\"/>\n\n\nPOI:\n<Types xmlns=\"http://schemas.openxmlformats.org/package/2006/content-types\">\n  <Default Extension=\"rels\" ContentType=\"application/vnd.openxmlformats-package.relationships+xml\"/>\n  <Default Extension=\"xml\" ContentType=\"application/xml\"/>\n\nIt might be that LibreOffice is correct and POI does not handle a specific OOXML case. \n\nI'm going to install LO and research it.\n\nYegor", "attachment_id": null, "id": 147561, "creator": "yegor@dinom.ru", "time": "2011-06-28T15:22:44Z", "bug_id": 51444, "creation_time": "2011-06-28T15:22:44Z", "is_private": false}, {"count": 4, "tags": [], "text": "thanks, appreciate", "is_private": false, "id": 147563, "creation_time": "2011-06-28T16:19:07Z", "time": "2011-06-28T16:19:07Z", "creator": "milan.chudik@mapflow.com", "bug_id": 51444, "attachment_id": null}, {"count": 5, "tags": [], "text": "Fixed in r1141576, junit added\n\nYegor", "attachment_id": null, "id": 147649, "creator": "yegor@dinom.ru", "time": "2011-06-30T15:40:55Z", "bug_id": 51444, "creation_time": "2011-06-30T15:40:55Z", "is_private": false}, {"count": 6, "tags": [], "text": "so when do you think this fix will be available in any official release(besides from checkout from repository)? \nmaybe in 3.8-beta4?", "is_private": false, "id": 147656, "creator": "milan.chudik@mapflow.com", "time": "2011-06-30T16:25:26Z", "bug_id": 51444, "creation_time": "2011-06-30T16:25:26Z", "attachment_id": null}]