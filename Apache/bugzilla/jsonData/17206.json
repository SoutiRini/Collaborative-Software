[{"count": 0, "tags": [], "text": "We updated one of our servers from apache-2.0.39 to \napache-2.0.44 and noticed that 2.0.44 fails to close \nthe file handles of the logfiles before executing cgi \nscripts.\n\nWe test by running a php script via the cgi interface and \nusing lsof to list the open file handles. (See below)\n\nThis enables cgi's to access the logs of other virtual hosts.\n\nWe can reproduce this under FreeBSD 4-STBALE and 5.0 RELEASE\nusing the preforked mpm and apache-2.0.40, 2.0.43 and 2.0.44.\nThe problem does not occur on apache-2.0.39.  \n\nWe think this bug might be related to Bug 12774 which was closed\ndue to lack of response from the original poster.  This was also \noing from 2.0.39 to 2.0.40.\n\nThis could also be related to the changes in apr/file_io/src/unix/file_dup.c\nfrom 1.48 to 1.49 and the introduction of apr_file_setaside().   \nThese changes were after 2.0.39 and before 2.0.40.\n\nGreetings\nChristian Kratzer\nCK Software GmbH\n\n--snipp--\nCOMMAND  PID    USER   FD   TYPE     DEVICE SIZE/OFF    NODE NAME\nphp     3308 webmail  cwd   VDIR 151,131079      512 1474242\n/u1/jails/jail-webmail/www/servers/webmail/htdocs\nphp     3308 webmail  rtd   VDIR 151,131079      512 1291924 /u1/jails/jail-webmail\nphp     3308 webmail  txt   VREG 151,131079  1343042 1473554\n/u1/jails/jail-webmail/www/cgi-php/php\nphp     3308 webmail  txt   VREG 151,131079    80080 1293805\n/u1/jails/jail-webmail/usr/libexec/ld-elf.so.1\nphp     3308 webmail  txt   VREG 151,131079   749398 1473486\n/u1/jails/jail-webmail/usr/local/lib/libc-client4.so.8\nphp     3308 webmail  txt   VREG 151,131079   126427 1452224\n/u1/jails/jail-webmail/usr/local/lib/libexpat.so.4\nphp     3308 webmail  txt   VREG 151,131079    19544 1292898\n/u1/jails/jail-webmail/usr/lib/libhistory.so.4\nphp     3308 webmail  txt   VREG 151,131079   147000 1292903\n/u1/jails/jail-webmail/usr/lib/libreadline.so.4\nphp     3308 webmail  txt   VREG 151,131079   258872 1292446\n/u1/jails/jail-webmail/usr/lib/libncurses.so.5\nphp     3308 webmail  txt   VREG 151,131079    85712 1473115\n/u1/jails/jail-webmail/usr/local/lib/libpq.so.3\nphp     3308 webmail  txt   VREG 151,131079   132379 1473270\n/u1/jails/jail-webmail/usr/local/lib/mysql/libmysqlclient.so.10\nphp     3308 webmail  txt   VREG 151,131079    51156 1292749\n/u1/jails/jail-webmail/usr/lib/libz.so.2\nphp     3308 webmail  txt   VREG 151,131079    28480 1292428\n/u1/jails/jail-webmail/usr/lib/libcrypt.so.2\nphp     3308 webmail  txt   VREG 151,131079   192724 1452773\n/u1/jails/jail-webmail/usr/local/lib/libldap.so.2\nphp     3308 webmail  txt   VREG 151,131079    47937 1452770\n/u1/jails/jail-webmail/usr/local/lib/liblber.so.2\nphp     3308 webmail  txt   VREG 151,131079    38500 1292702\n/u1/jails/jail-webmail/usr/lib/libpam.so.1\nphp     3308 webmail  txt   VREG 151,131079   908698 1473181\n/u1/jails/jail-webmail/usr/local/lib/libiconv.so.3\nphp     3308 webmail  txt   VREG 151,131079   211156 1473420\n/u1/jails/jail-webmail/usr/local/lib/libgd.so.4\nphp     3308 webmail  txt   VREG 151,131079   340310 1473287\n/u1/jails/jail-webmail/usr/local/lib/libfreetype.so.9\nphp     3308 webmail  txt   VREG 151,131079   139364 1472995\n/u1/jails/jail-webmail/usr/local/lib/libpng.so.5\nphp     3308 webmail  txt   VREG 151,131079   135696 1473155\n/u1/jails/jail-webmail/usr/local/lib/libjpeg.so.9\nphp     3308 webmail  txt   VREG 151,131079   117736 1292433\n/u1/jails/jail-webmail/usr/lib/libm.so.2\nphp     3308 webmail  txt   VREG 151,131079   762896 1293883\n/u1/jails/jail-webmail/usr/lib/libcrypto.so.2\nphp     3308 webmail  txt   VREG 151,131079   181720 1293903\n/u1/jails/jail-webmail/usr/lib/libssl.so.2\nphp     3308 webmail  txt   VREG 151,131079   575584 1292596\n/u1/jails/jail-webmail/usr/lib/libc.so.4\nphp     3308 webmail    0u  PIPE 0xf08bb4e0    16384\nphp     3308 webmail    1u  PIPE 0xeba05bc0    16384         ->0xf08bb760\nphp     3308 webmail    2u  PIPE 0xebcb63a0    16384         ->0xeba03960\nphp     3308 webmail    4u  PIPE 0xeba03a00    16384         ->0xeb666a00\nphp     3308 webmail    5u  PIPE 0xeb666a00    16384         ->0xeba03a00\nphp     3308 webmail    6u  VREG 151,131079     4519 1474234\n/u1/jails/jail-webmail/www/logs/httpd-error.log\nphp     3308 webmail    7u  VREG 151,131079        0 1474628\n/u1/jails/jail-webmail/www/servers/webmail109/logs/httpd-error.log\nphp     3308 webmail    8u  VREG 151,131079        0 1474629\n/u1/jails/jail-webmail/www/servers/webmail108/logs/httpd-error.log\nphp     3308 webmail    9u  VREG 151,131079        0 1474630\n/u1/jails/jail-webmail/www/servers/webmail107/logs/httpd-error.log\nphp     3308 webmail   10u  VREG 151,131079        0 1474631\n/u1/jails/jail-webmail/www/servers/webmail106/logs/httpd-error.log\nphp     3308 webmail   11u  VREG 151,131079        0 1474632\n/u1/jails/jail-webmail/www/servers/webmail105/logs/httpd-error.log\nphp     3308 webmail   12u  VREG 151,131079        0 1474633\n/u1/jails/jail-webmail/www/servers/webmail104/logs/httpd-error.log\nphp     3308 webmail   13u  VREG 151,131079        0 1474634\n/u1/jails/jail-webmail/www/servers/webmail103/logs/httpd-error.log\nphp     3308 webmail   14u  VREG 151,131079        0 1474635\n/u1/jails/jail-webmail/www/servers/webmail102/logs/httpd-error.log\nphp     3308 webmail   15u  VREG 151,131079        0 1474636\n/u1/jails/jail-webmail/www/servers/webmail101/logs/httpd-error.log\nphp     3308 webmail   16u  VREG 151,131079        0 1474637\n/u1/jails/jail-webmail/www/servers/webmail100/logs/httpd-error.log\nphp     3308 webmail   17u  VREG 151,131079     2109 1474254\n/u1/jails/jail-webmail/www/servers/webmail/logs/httpd-error.log\nphp     3308 webmail   18w  VREG 151,131079      675 1474236\n/u1/jails/jail-webmail/www/logs/httpd-access.log\nphp     3308 webmail   19w  VREG 151,131079        0 1474638\n/u1/jails/jail-webmail/www/servers/webmail109/logs/httpd-access.log\nphp     3308 webmail   20w  VREG 151,131079        0 1474639\n/u1/jails/jail-webmail/www/servers/webmail108/logs/httpd-access.log\nphp     3308 webmail   21w  VREG 151,131079        0 1474640\n/u1/jails/jail-webmail/www/servers/webmail107/logs/httpd-access.log\nphp     3308 webmail   22w  VREG 151,131079        0 1474641\n/u1/jails/jail-webmail/www/servers/webmail106/logs/httpd-access.log\nphp     3308 webmail   23w  VREG 151,131079        0 1474642\n/u1/jails/jail-webmail/www/servers/webmail105/logs/httpd-access.log\nphp     3308 webmail   24w  VREG 151,131079        0 1474643\n/u1/jails/jail-webmail/www/servers/webmail104/logs/httpd-access.log\nphp     3308 webmail   25w  VREG 151,131079        0 1474644\n/u1/jails/jail-webmail/www/servers/webmail103/logs/httpd-access.log\nphp     3308 webmail   26w  VREG 151,131079        0 1474645\n/u1/jails/jail-webmail/www/servers/webmail102/logs/httpd-access.log\nphp     3308 webmail   27w  VREG 151,131079        0 1474646\n/u1/jails/jail-webmail/www/servers/webmail101/logs/httpd-access.log\nphp     3308 webmail   28w  VREG 151,131079        0 1474647\n/u1/jails/jail-webmail/www/servers/webmail100/logs/httpd-access.log\nphp     3308 webmail   29w  VREG 151,131079     7821 1474255\n/u1/jails/jail-webmail/www/servers/webmail/logs/httpd-access.log\n--snipp--", "is_private": false, "bug_id": 17206, "id": 31614, "time": "2003-02-19T15:46:29Z", "creator": "ck@cksoft.de", "creation_time": "2003-02-19T15:46:29Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 17206, "attachment_id": 4966, "id": 31740, "time": "2003-02-21T11:32:14Z", "creator": "ck@cksoft.de", "creation_time": "2003-02-21T11:32:14Z", "is_private": false, "text": "Created attachment 4966\ndisables inheriting of access and error logs"}, {"count": 2, "tags": [], "text": "Apache httpd fails to close access and error logs when it forks and \nexecs cgi scripts.  From our preliminary understanding of the code\nthe fix is to call apr_file_inherit_unset() in place of \napr_file_inherit_set() in both server/log.c and loggers/mod_log_config.c.\n\nThe bug first appeared going from 2.0.39 to 2.0.40 because a typo in the\ndefinition of the APR_INHERIT flag had reversed the effect of\napr_file_inherit_set().  For this please see cvs diff of\n/apr/include/arch/unix/Attic/inherit.h between 1.10 and 1.11.\n\nThe attached patch forces cleanup of logfiles on fork/exec of cgi's.\n\nAll calls of *_inherit_set() and *_inherit_unset() should be validated \nfor correct behavior in their respective contexts.\n\nCredit for digging through the sources and finding the fix goes\nBjoern Zeeb <bzeeb@zabbadoz.net>.\n\nIn case of questions we have more detailed information available.\nPlease email.\n\n\n\n", "attachment_id": null, "id": 31748, "creator": "ck@cksoft.de", "time": "2003-02-21T12:02:32Z", "bug_id": 17206, "creation_time": "2003-02-21T12:02:32Z", "is_private": false}, {"count": 3, "tags": [], "text": "the fix does not help with all mpms.\nPeople who need to know more got 2nd mail.", "is_private": false, "bug_id": 17206, "id": 31802, "time": "2003-02-22T21:50:31Z", "creator": "bzeeb@zabbadoz.net", "creation_time": "2003-02-22T21:50:31Z", "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 17206, "is_private": false, "id": 32632, "attachment_id": null, "creator": "bzeeb@zabbadoz.net", "creation_time": "2003-03-07T07:14:47Z", "time": "2003-03-07T07:14:47Z", "text": "further public discussions on patches are here\n(apr) http://marc.theaimsgroup.com/?t=104688218100008&r=1&w=2\nand here\n(httpd) http://marc.theaimsgroup.com/?t=104696493400002&r=1&w=2\n\nAlso pointed wrowe to his commit\nhttp://cvs.apache.org/viewcvs.cgi/httpd-2.0/server/log.c.diff?r1=1.94&r2=1.95&di\nff_format=h\n"}, {"count": 5, "tags": [], "text": "\n  Thanks to you, Christian, Bjoern and Joe I believe we have this licked.\n  Fixes are applied to the forthcoming 2.0.45 release and the 2.1.0-dev tree.\n", "is_private": false, "bug_id": 17206, "id": 33576, "time": "2003-03-20T22:08:40Z", "creator": "wrowe@apache.org", "creation_time": "2003-03-20T22:08:40Z", "attachment_id": null}, {"count": 6, "tags": [], "text": "Many thanks back to you, William Rowe, for your great work\nsolving even more problems in apr/httpd related to this. Thanks.", "is_private": false, "bug_id": 17206, "id": 34375, "time": "2003-04-02T20:19:31Z", "creator": "bzeeb@zabbadoz.net", "creation_time": "2003-04-02T20:19:31Z", "attachment_id": null}]