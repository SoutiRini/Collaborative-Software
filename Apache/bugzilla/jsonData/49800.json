[{"count": 0, "tags": [], "creator": "l.declercq@nuxwin.com", "attachment_id": null, "id": 139355, "time": "2010-08-23T01:33:13Z", "bug_id": 49800, "creation_time": "2010-08-23T01:33:13Z", "is_private": false, "text": "Hello ;\n\nFirstly, sorry to annoy you with my reports. It's not my fault if I found some strange behaviors with mod_log_config.\n\nToday, I found a new strange behavior (bug ?). This behavior occurs only with the Piped Log script used in conjunction to the ErrorLog directive.\n\nFor now, I've set the directive as follow:\n\n\nErrorLog \"||/var/www/ispcp/engine/ispcp-apache-logger -t error -l /var/log/ispcp\"\n\n\nSo here, I uses the alternative syntax to avoid to involve the Shell. My script is usable both for the ErrorLog and the CustomLog directives. That explain the arguments -t  that allow to switch between them, and -l /var/log/ispcp that indicates the log directory path for these own events.\n\nOk, now, let's me to explain to you the problem here. First, the log from my script when I start Apache:\n\n[Mon Aug 23 06:52:52 2010] [notice] ispCP Apache Logger started ErrorLog Handler -- resuming normal operations\n[Mon Aug 23 06:52:52 2010] [debug] Ending Error log processing...\n[Mon Aug 23 06:52:52 2010] [notice] No more lines received, shutting down (pid 4617)\n[Mon Aug 23 06:52:52 2010] [notice] ispCP Apache Logger started ErrorLog Handler -- resuming normal operations\n[Mon Aug 23 06:52:52 2010] [notice] ispCP Apache Logger started CustomLog Handler -- resuming normal operations\n\n\nHere we can see a process spawn by Apache related to my script (first line) but the script dies due to an EOL (line 2 and 3). After, we can see that Apache re-spawn the script and then it's live normally. The last line is related to the process spawn by apache for  the CustomLog directive. All works fine for this last.\n\nWhat's the problem here ? Why Apache broke the communication with the first process and re-spawn it again ?\n\nIn the script, I've added code like follow for my ErrorLog handler to see the problem\n\nsub ErrorLogHandler {\n\n\teventLog(\n\t\t'notice', 'ispCP Apache Logger started ErrorLog Handler -- ' .\n\t\t\t'resuming normal operations'\n\t);\n\n\twhile(<STDIN>) {\n\t \tLog processing here...\n\t}\n\n\t# Occurs when apache breaks the communication (for unknown reason)\n\texitall('EOL');\n}\n\nThe exitall() subroutine is my signal handler that is normally called only when any signal occurs (like sigterm). It look like this:\n\nsub exitall() {\n\n\tmy $signal =  shift;\n\n\tmy $loggingType = ($opt{'loggingType'} eq 'access') ? 'Access' : 'Error';\n\n\teventLog('debug', \"Ending $loggingType log processing...\");\n\n\tif($signal eq 'EOL') {\n\t\teventLog('notice', \"No more lines received, shutting down (pid $$)\");\n\t} else {\n\t\teventLog('notice', \"Caught SIG$signal, shutting down (pid $$)\");\n\t}\n\n\t# Close all filehandles\n\tcacheout_close();\n\n\texit;\n}\n\nNote: I can provide you the script if you want.\n\n\n\nroot@ispcp:/var/www/ispcp/engine# apache2ctl -V\nServer version: Apache/2.2.16 (Debian)\nServer built:   Jul 24 2010 20:24:16\nServer's Module Magic Number: 20051115:24\nServer loaded:  APR 1.4.2, APR-Util 1.3.9\nCompiled using: APR 1.4.2, APR-Util 1.3.9\nArchitecture:   32-bit\nServer MPM:     Worker\n  threaded:     yes (fixed thread count)\n    forked:     yes (variable process count)\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/worker\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"/etc/apache2\"\n -D SUEXEC_BIN=\"/usr/lib/apache2/suexec\"\n -D DEFAULT_PIDLOG=\"/var/run/apache2.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"mime.types\"\n -D SERVER_CONFIG_FILE=\"apache2.conf\""}, {"count": 1, "tags": [], "bug_id": 49800, "attachment_id": null, "text": "Log more explicit:\n\n\napache2ctl start\n\n[Mon Aug 23 07:59:50 2010] [notice] Starting ispCP Apache logger (pid 5501)\n[Mon Aug 23 07:59:50 2010] [notice] ispCP Apache Logger started ErrorLog Handler -- resuming normal operations\n[Mon Aug 23 07:59:50 2010] [debug] Ending Error log processing...\n[Mon Aug 23 07:59:50 2010] [notice] No more lines received, shutting down (pid 5501)\n[Mon Aug 23 07:59:50 2010] [notice] Starting ispCP Apache logger (pid 5504)\n[Mon Aug 23 07:59:50 2010] [notice] ispCP Apache Logger started ErrorLog Handler -- resuming normal operations\n[Mon Aug 23 07:59:50 2010] [notice] Starting ispCP Apache logger (pid 5505)\n[Mon Aug 23 07:59:50 2010] [notice] ispCP Apache Logger started CustomLog Handler -- resuming normal operations\n\napache2ctl stop\n\n\n[Mon Aug 23 08:00:30 2010] [debug] Ending Access log processing...\n[Mon Aug 23 08:00:30 2010] [notice] Caught SIGTERM, shutting down (pid 5505)\n[Mon Aug 23 08:00:30 2010] [debug] Ending Error log processing...\n[Mon Aug 23 08:00:30 2010] [notice] Caught SIGTERM, shutting down (pid 5504)\n\nI hope that will help you to understand me.", "id": 139357, "time": "2010-08-23T02:02:15Z", "creator": "l.declercq@nuxwin.com", "creation_time": "2010-08-23T02:02:15Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 49800, "attachment_id": null, "is_private": false, "id": 139361, "time": "2010-08-23T06:37:46Z", "creator": "covener@gmail.com", "creation_time": "2010-08-23T06:37:46Z", "text": "some startup hooks run twice, including those used by mod_log_config to start piped loggers."}, {"count": 3, "tags": [], "bug_id": 49800, "attachment_id": null, "text": "And for you, it's normal behavior ?\n\nStrange answer, strange steam...\n\nThanks for the answer same if for me you wrong...", "id": 139384, "time": "2010-08-23T13:04:39Z", "creator": "l.declercq@nuxwin.com", "creation_time": "2010-08-23T13:04:39Z", "is_private": false}]