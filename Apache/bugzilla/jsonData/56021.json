[{"count": 0, "tags": [], "bug_id": 56021, "text": "Was trying to configure SSL on tomcat 7 to use Windows-MY keystore (provider that wraps the MSCAPI to access certificates in the keystore of Windows cert manager) but didn't get to work. Tomcat startup fails to load the connector since it looks for a empty file for the keystore inside catalina_home directory.\n\nBut I got it working with a small code change in org.apache.tomcat.util.net.AbstractEndpoint.adjustRelativePath() method. When Windows-MY keystore is used there is no physical keystore file. To be able to pass in empty value for the keyStoreFile in the connector I added a check for not empty path before adjusting the path.\n\n    public String adjustRelativePath(String path, String relativeTo) {\n        String newPath = path;\n        if (!\"\".equalsIgnoreCase(newPath)) { \n            File f = new File(newPath);\n            if ( !f.isAbsolute()) {\n                newPath = relativeTo + File.separator + newPath;\n                f = new File(newPath);\n            }\n            if (!f.exists()) {\n                getLog().warn(\"configured file:[\"+newPath+\"] does not exist.\");\n            }\n        }\n        return newPath;\n    }\n\njava version \"1.7.0_07\"\n\nTo reproduce (on windows):\n1. Install a cert to the windows cert manager (start run certmgr.msc).\n2. Configure the SSL connector with cert alias ('issued to' column value of the cert in the cermgr)\n   <Connector port=\"8443\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\"\n               SSLEnabled=\"true\"\n               maxThreads=\"150\" scheme=\"https\" secure=\"true\"\n               keyAlias=\"ssl.cert.alias\"\n               keystoreFile=\"\"\n               keystoreType=\"Windows-My\"\n               clientAuth=\"false\" sslProtocol=\"TLS\" />\n3. Start tomcat\n\nThe fix has been tested on windows 7 and windows server 2012.", "id": 172428, "time": "2014-01-16T19:37:09Z", "creator": "samare@gmail.com", "creation_time": "2014-01-16T19:37:09Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "text": "Thanks for the report and the suggested fix.\n\nI applied a slightly different patch that allowed some additional code clean-up.\n\nThe patch has been applied to 8.0.x for 8.0.0 onwards and to 7.0.x for 7.0.51 onwards.\n\nThanks again for your support of the Apache Tomcat community.", "attachment_id": null, "id": 172505, "creator": "markt@apache.org", "time": "2014-01-19T20:02:24Z", "bug_id": 56021, "creation_time": "2014-01-19T20:02:24Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 56021, "attachment_id": null, "id": 179826, "time": "2014-12-17T13:56:03Z", "creator": "joakim.ganse@accept-it.se", "creation_time": "2014-12-17T13:56:03Z", "is_private": false, "text": "Does this work now? and how do I set it up?\n\nMy current setup is on Windows 2012 R2 with Tomcat 7.0.55.\nTomcat is installed as a service.\nI have verified that the certificate exists in the windows cert manager.\n\n<Connector port=\"443\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\"\n               maxThreads=\"150\" SSLEnabled=\"true\" scheme=\"https\" secure=\"true\"\n               clientAuth=\"false\" sslProtocol=\"TLS\" \n               KeyAlias=\"server.my.domain\"\n               keystoreFile=\"\"\n               keystoreType=\"Windows-MY\"\n               \n                />\n\nError:\n2014-12-17 14:45:14,306 [main] INFO  org.apache.coyote.http11.Http11Protocol- Initializing ProtocolHandler [\"http-bio-8180\"]\n2014-12-17 14:45:14,322 [main] INFO  org.apache.coyote.http11.Http11NioProtocol- Initializing ProtocolHandler [\"http-nio-443\"]\n2014-12-17 14:45:14,759 [main] ERROR org.apache.coyote.http11.Http11NioProtocol- Failed to initialize end point associated with ProtocolHandler [\"http-nio-443\"]\njava.io.IOException: Alias name server.my.domain does not identify a key entry"}, {"count": 3, "tags": [], "creator": "samare@gmail.com", "is_private": false, "id": 179834, "creation_time": "2014-12-18T11:33:03Z", "time": "2014-12-18T11:33:03Z", "bug_id": 56021, "text": "1. Make sure you have the correct keyAlias, following openssl command should show alias as the common name (CN) - openssl pkcs12 -info -in filename.pfx\n2. Certificate needs to be installed to the LocalMachine\\My store if the tomcat service runs with log on as local system. The CurrentUser\\My store is not accessible from other user accounts. You can use powershell to install and verify the cert in the LocalMachine\\My store.", "attachment_id": null}]