[{"count": 0, "tags": [], "bug_id": 58179, "text": "My name is Bai Guangdong, a research fellow from National University of Singapore. I find an atomicity violation similar to bug 53498. \n\nThe problem occurs in the same file java/org/apache/catalina/core/ApplicationContext.java. Look at the code snippet below. \n\nL791         oldValue = attributes.get(name);\nL792         if (oldValue != null)\nL793             replaced = true;\nL794         attributes.put(name, value);\n...          ... \nL801         if (replaced)\nL802             event =\nL803                 new ServletContextAttributeEvent(context.getServletContext(),\nL804                                                  name, oldValue);\nL805         else\nL806             event =\nL807                 new ServletContextAttributeEvent(context.getServletContext(),\nL808                                                  name, value);\n...          ... \nL816                 if (replaced) {\nL817                     context.fireContainerEvent\nL818                         (\"beforeContextAttributeReplaced\", listener);\nL819                     listener.attributeReplaced(event);\nL820                     context.fireContainerEvent(\"afterContextAttributeReplaced\",\nL821                                                listener);\nL822                 } else {\nL823                     context.fireContainerEvent(\"beforeContextAttributeAdded\",\nL824                                                listener);\nL825                     listener.attributeAdded(event);\nL826                     context.fireContainerEvent(\"afterContextAttributeAdded\",\nL827                                                listener);\n\nSuppose two threads T1 and T2 executes this code snippet with the same key (\"name\"). Initially, \"attributes\" is empty. T1 executes line 791 and \"oldValue\" in T1 becomes null. Before T1 executes line 794, T2 executes 791 and \"oldValue\" in T2 becomes null as well. Then T1 executes line 794, and later T2 replaces T1's \"value\" at line 794. Afterwards, both T1 and T2 fire the \"beforeContextAttributeAdded\" event at line 823. However, in the above situation, \"replaced\" in T2 should be true and \"beforeContextAttributeReplaced\" should be fired at line 817.", "id": 184167, "time": "2015-07-24T14:54:37Z", "creator": "baiguangdong@gmail.com", "creation_time": "2015-07-24T14:54:37Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 184185, "creation_time": "2015-07-27T10:25:45Z", "time": "2015-07-27T10:25:45Z", "bug_id": 58179, "text": "Thanks for the report.\n\nFixed in trunk, 8.0.x (for 8.0.25) and 7.0.x (for 7.0.64).", "is_private": false}]