[{"count": 0, "tags": [], "bug_id": 60444, "attachment_id": 34500, "id": 195364, "creation_time": "2016-12-05T21:34:54Z", "time": "2016-12-05T21:34:54Z", "creator": "ts-nospam12@online.de", "text": "Created attachment 34500\ncomplete log of ant build\n\nThis might be OS specific: Running the tests, I'm occasionally stalled by the following test failure:\n\n     [java] There was 1 failure:\n     [java] 1) testSleep(org.apache.jmeter.protocol.http.control.TestHTTPMirrorThread)\n     [java] junit.framework.AssertionFailedError: Expected > 1000 992\n     [java]     at junit.framework.Assert.fail(Assert.java:57)\n     [java]     at junit.framework.Assert.assertTrue(Assert.java:22)\n     [java]     at junit.framework.TestCase.assertTrue(TestCase.java:192)\n     [java]     at org.apache.jmeter.protocol.http.control.TestHTTPMirrorThread.testSleep(TestHTTPMirrorThread.java:413)\n\nI'm not too certain about the primary cause, which I think, is one of the following:\na.) Thread.sleep() relies on the granularity of the internal clock, which might shave off some millis from the 1000 ms, that have been asked for.\nb.) The JVM generally isn't guaranteed to wait the full time given anyway, as the sleep might get interrupted.\n\nNow I'm a bit at a loss, what is the intention here: \nIf accuracy in maintaining the contract is required, I may fix this, by tracking the actual time spent waiting arround the invocation of\n    TimeUnit.MILLISECONDS.sleep(Integer.parseInt(sleepHeaderValue))\n@ HttpMirrorThread:223.\n\nelse we might just relax the assertion wihin the test.\n\nDo we ever need this functionality?\n\n\nWadayathink?\n\nP.S.:\nThe issue is annoying, since it breaks the test execution in one out of three executions on my machine, and it did so since I startet to dig through the code with Rel 3.0", "is_private": false}, {"count": 1, "tags": [], "bug_id": 60444, "attachment_id": null, "id": 195380, "creation_time": "2016-12-06T21:00:51Z", "time": "2016-12-06T21:00:51Z", "creator": "felix.schumacher@internetallee.de", "text": "On what computer do you see these failures?\n\nI think it might help to put the now=System.nanoTime() before the conn.connect().\n\nAnd by the way the attached log is only one byte long.", "is_private": false}, {"count": 2, "tags": [], "bug_id": 60444, "is_private": false, "id": 195494, "creation_time": "2016-12-14T17:45:44Z", "time": "2016-12-14T17:45:44Z", "creator": "ts-nospam12@online.de", "text": "Created attachment 34525\nant log\n\nSorry about the log, there it is now.\n\nAnyway, it's only puting the stacktrace into some context. This happens on a Windows 10 Notebook, both when running with JDK 1.7.0 or 1.8.0.\n\nFrom my point of view, the current position of now = System.nanoTime() is quite right. Placing it earlier is equivalent of adding some time, since the server side method will not get executed, until either getInputStream() or getOutputStream() are called, *and* the streams are read from or written to - thats at least what I took from various internet posts about the HttpUrlConnection. You might want to convince yourself by placing breakpoints into the test and the serverside method.\n\nMy questions are on a different tack: \n- What are we trying to achieve by the test?\n\nwhich also relates to the question:\n- what is the use case of a server side wait in a JMeter HTTP-Mirror?", "attachment_id": 34525}, {"count": 3, "tags": [], "creator": "ts-nospam12@online.de", "attachment_id": null, "id": 195531, "time": "2016-12-17T11:53:36Z", "bug_id": 60444, "creation_time": "2016-12-17T11:53:36Z", "is_private": false, "text": "If checked up on my previous statement, and have to correct:\nconnect() actually does initiate the roundtrip to the server, at least for the Sun implementation of the HttpUrlConnection.\n\nThus, we should indeed start taking time before the connect(). I'm going to supply a patch for this, which should mitigate the woes.\n\nHowever I would like to point out that this still isn't a healthy aproach: \nsleep() throws an InterruptedException, which is apart from a log statement silently swallowed, so the test does hinge on the assumption, that there are no spourious interruptions."}, {"count": 4, "attachment_id": null, "bug_id": 60444, "is_private": false, "id": 195532, "time": "2016-12-17T12:23:28Z", "creator": "felix.schumacher@internetallee.de", "creation_time": "2016-12-17T12:23:28Z", "tags": [], "text": "Thanks for your further analysis.\n\nPerhaps let the server return a result code/string, that could be parsed in the test method and checked for an (Interrupted)Exception?"}, {"count": 5, "tags": [], "bug_id": 60444, "attachment_id": null, "text": "@Felix: I'm, already shaving the yak here - my intention was just to get the tests going again.\nIntroducing additional erromessages, albeit sensible, invites compatibility trouble down the line.", "id": 195583, "time": "2016-12-21T14:10:43Z", "creator": "ts-nospam12@online.de", "creation_time": "2016-12-21T14:10:43Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 60444, "text": "Created attachment 34542\nPatch as promissed.", "id": 195584, "time": "2016-12-21T14:10:50Z", "creator": "ts-nospam12@online.de", "creation_time": "2016-12-21T14:10:50Z", "is_private": false, "attachment_id": 34542}, {"count": 7, "tags": [], "bug_id": 60444, "is_private": false, "id": 195588, "creation_time": "2016-12-21T15:26:05Z", "time": "2016-12-21T15:26:05Z", "creator": "p.mouawad@ubik-ingenierie.com", "text": "Thanks for contribution.\n\n\nDate: Wed Dec 21 15:25:34 2016\nNew Revision: 1775470\n\nURL: http://svn.apache.org/viewvc?rev=1775470&view=rev\nLog:\nBug 60444 - Intermittent failure of TestHTTPMirrorThread#testSleep()\nBugzilla Id: 60444\n\nModified:\n    jmeter/trunk/test/src/org/apache/jmeter/protocol/http/control/TestHTTPMirrorThread.java\n    jmeter/trunk/xdocs/changes.xml", "attachment_id": null}]