[{"count": 0, "tags": [], "bug_id": 45431, "attachment_id": null, "id": 118798, "time": "2008-07-18T02:42:57Z", "creator": "matthew.knl@gmail.com", "creation_time": "2008-07-18T02:42:57Z", "is_private": false, "text": "I am using POI 3.5 Beta 1.\nWhen I open a macro-enabled Excel (.xlsm) and save it as .xslm again.\nThe result file cannot be opened by MS Excel 2007.\n\nFollowing is my sample codes:\n\nXSSFWorkbook wb = new XSSFWorkbook(\"input.xlsm\");\nFileOutputStream outStream = new FileOutputStream(\"output.xlsm\");\nwb.write(outStream);\n\nIs that currently POI not support a macro-enabled Excel file? Thanks a lot."}, {"count": 1, "tags": [], "bug_id": 45431, "text": "Created attachment 22280\nInput Excel File", "id": 118799, "time": "2008-07-18T02:44:02Z", "creator": "matthew.knl@gmail.com", "creation_time": "2008-07-18T02:44:02Z", "is_private": false, "attachment_id": 22280}, {"count": 2, "tags": [], "bug_id": 45431, "attachment_id": null, "is_private": false, "id": 118831, "time": "2008-07-18T11:24:36Z", "creator": "apache@gagravarr.org", "creation_time": "2008-07-18T11:24:36Z", "text": "We weren't copying the vba stream over into the new file, which wasn't helping\n\nI've updated poi to copy over the vba stream if there is one. However, excel still refuses to load the file, so I don't know what else we're supposed to do. Clearly there is a secret hidden reference somewhere that we're not updating or something\n\nIt may be worth closely comparing the un-zipped contents of the pre-poi and post-poi files, to see if you can spot any important bits that differ"}, {"count": 3, "tags": [], "bug_id": 45431, "attachment_id": null, "id": 118848, "time": "2008-07-20T18:48:36Z", "creator": "matthew.knl@gmail.com", "creation_time": "2008-07-20T18:48:36Z", "is_private": false, "text": "I compared the pre-poi and post-poi files, I have following findings:\n\n(1) In [Content_Types].xml:\n\nExcel expected output:\n<Override PartName=\"/xl/workbook.xml\" ContentType=\"application/vnd.ms-excel.sheet.macroEnabled.main+xml\"/>\n\nPOI actual output:\n<Override PartName=\"/xl/workbook.xml\" ContentType=\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml\"/>\n\n(2) In [Content_Types].xml:\n\nExcel expected output:\n<Default Extension=\"vml\" ContentType=\"application/vnd.openxmlformats-officedocument.vmlDrawing\"/>\n<Override PartName=\"/xl/vbaProject0.bin\" ContentType=\"application/vnd.ms-office.vbaProject\"/>\n\nPOI actual output (the case difference):\n<Default Extension=\"vml\" ContentType=\"application/vnd.openxmlformats-officedocument.vmldrawing\"/>\n<Override PartName=\"/xl/vbaProject0.bin\" ContentType=\"application/vnd.ms-office.vbaproject\"/>\n\nI found that this problem is caused by OpenXml4J (http://people.apache.org/~nick/openxml4j-bin-alpha-080407.jar), I tried to use the library with a newer version, it fix this issue but I encountered another problem which doesn't happen in older version.\n\n(3) Package contents:\nSome .xlsm file contains not only vbaProject.bin, it also includes ActiveX controls and some .emf image files linked. If only copy the vbaProject.bin without the linked ActiveX controls and image, Excel will prompt error also. Please check my attached image.\n\nPatch\n=====\nI have created a patch which solve above problems (assume OpenXML4J (2) issue is fixed), but I know the patch just only solve my problem temporary (I hard code the output is macro-enabled workbook, image is .emf etc...) and it is not a generic solution for the POI project. I hope it helps the POI team to figure out the perfect solution some ways."}, {"count": 4, "tags": [], "creator": "matthew.knl@gmail.com", "text": "Created attachment 22289\nMacro-enabled workbook package structure: vmlDrawing, activeX...", "id": 118851, "time": "2008-07-20T18:54:17Z", "bug_id": 45431, "creation_time": "2008-07-20T18:54:17Z", "is_private": false, "attachment_id": 22289}, {"count": 5, "tags": [], "bug_id": 45431, "text": "Created attachment 22290\nMy patch to solve \"save macro-enabled workbook\" issue, temporary solution", "id": 118852, "time": "2008-07-20T18:55:25Z", "creator": "matthew.knl@gmail.com", "creation_time": "2008-07-20T18:55:25Z", "is_private": false, "attachment_id": 22290}, {"count": 6, "tags": [], "bug_id": 45431, "attachment_id": null, "text": "Thanks for the patch, and all the digging that went with it!\n\nI'll try to get us onto a newer version of openxml4j, and once the file part case issue is sorted, then I'll try to apply your patch :)", "id": 118861, "time": "2008-07-21T02:12:00Z", "creator": "apache@gagravarr.org", "creation_time": "2008-07-21T02:12:00Z", "is_private": false}, {"count": 7, "tags": [], "text": "I've got poi using the latest openxml4j, so hopefully things will now work fine for you\n\nI'll try to review + commit your patch in the near future", "is_private": false, "id": 119090, "creator": "apache@gagravarr.org", "time": "2008-07-28T16:37:47Z", "bug_id": 45431, "creation_time": "2008-07-28T16:37:47Z", "attachment_id": null}, {"count": 8, "tags": [], "text": "Could you upload a file similar to the one your image shows? I'd like one like that so I can write some more comprehensive unit tests for this stuff", "is_private": false, "id": 119105, "creator": "apache@gagravarr.org", "time": "2008-07-29T16:04:04Z", "bug_id": 45431, "creation_time": "2008-07-29T16:04:04Z", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 45431, "is_private": false, "id": 119106, "attachment_id": null, "creator": "apache@gagravarr.org", "creation_time": "2008-07-29T17:31:19Z", "time": "2008-07-29T17:31:19Z", "text": "Thanks for you patch. I've applied it to the svn branch, with some changes. I decided it'd make sense if we pushed a lot of the fiddly bits around reading and writing the sub-streams to XSSFRelation, rather than duplicating it each time. So, the code in XSSFWorkbook is very different, the others less so\n\nI'm able to open your initial file, save it, and have excel load it with no issues. Hopefully your complex file will work too, but please upload it so we can write unit tests for it :)"}, {"count": 10, "tags": [], "creator": "matthew.knl@gmail.com", "text": "This problem is solved in latest build.", "id": 123621, "time": "2008-12-30T01:47:18Z", "bug_id": 45431, "creation_time": "2008-12-30T01:47:18Z", "is_private": false, "attachment_id": null}]