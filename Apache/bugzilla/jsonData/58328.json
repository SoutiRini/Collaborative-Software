[{"count": 0, "tags": [], "text": "Created attachment 33062\nSample page showing the problem\n\nAs it says in https://tomcat.apache.org/migration-8.html#JavaServer_Pages_2.3 static fields can be used in expressions. The problem is that every undefined variable in such expression is checked agains configured set of packages due to lack of caching this lookup is performed on every request. Class that performs the lookup is the javax.el.ImportHandler http://svn.apache.org/viewvc/tomcat/tc8.0.x/trunk/java/javax/el/ImportHandler.java?view=markup . It has clazzes and statics variables, their initialization suggest that they could be used in multithreaded environment yet ImportHandler is constructed every time new ELContext is created (and if I understand correctly this is done in context of a single page request thus it's executed by single thread). \n\nI think that fields clazzes and statics should be static.\n\nTo reproduce this issue:\n\n1. Get Tomcat, unpack and start it\n2. Take attached jsp page and put it on ie to webapps/ROOT\n3. Use tool like siege ( https://www.joedog.org/siege-home/ ) to test the performance:\n\nsiege http://localhost:8080/heavyPage.jsp -c 1  -d 0 -t 10s\n\nMy results are pasted below (Tomcat7, Tomcat8, and Tomcat8 with ImportHandler.clazzes and ImportHandler.statics changed to static). \n\n\n\nApache Tomcat 7.0.64:\n\n  Transactions:\t\t        6938 hits\n  Availability:\t\t      100.00 %\n  Elapsed time:\t\t        9.41 secs\n  Data transferred:\t       16.03 MB\n  Response time:\t\t        0.00 secs\n  Transaction rate:\t      737.30 trans/sec\n  Throughput:\t\t        1.70 MB/sec\n  Concurrency:\t\t        0.97\n  Successful transactions:        6938\n  Failed transactions:\t           0\n  Longest transaction:\t        0.03\n  Shortest transaction:\t        0.00\n\n\nApache Tomcat 8.0.26:\n\n  Transactions:\t\t           7 hits\n  Availability:\t\t      100.00 %\n  Elapsed time:\t\t        9.14 secs\n  Data transferred:\t        0.02 MB\n  Response time:\t\t        1.27 secs\n  Transaction rate:\t        0.77 trans/sec\n  Throughput:\t\t        0.00 MB/sec\n  Concurrency:\t\t        0.97\n  Successful transactions:           7\n  Failed transactions:\t           0\n  Longest transaction:\t        1.36\n  Shortest transaction:\t        1.22\n\nApache Tomcat - trunk version with suggested fix:\n\n  Transactions:\t\t        5786 hits\n  Availability:\t\t      100.00 %\n  Elapsed time:\t\t        9.93 secs\n  Data transferred:\t       13.36 MB\n  Response time:\t\t        0.00 secs\n  Transaction rate:\t      582.68 trans/sec\n  Throughput:\t\t        1.35 MB/sec\n  Concurrency:\t\t        0.97\n  Successful transactions:        5786\n  Failed transactions:\t           0\n  Longest transaction:\t        0.02\n  Shortest transaction:\t        0.00\n\nBest,\n  Janusz", "attachment_id": 33062, "id": 184966, "creator": "janusz.parfieniuk@gmail.com", "time": "2015-09-04T14:14:29Z", "bug_id": 58328, "creation_time": "2015-09-04T14:14:29Z", "is_private": false}, {"count": 1, "tags": [], "creator": "markt@apache.org", "text": "\n\n*** This bug has been marked as a duplicate of bug 57773 ***", "id": 184999, "time": "2015-09-07T10:12:23Z", "bug_id": 58328, "creation_time": "2015-09-07T10:12:23Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "text": "(In reply to Janusz Parfieniuk from comment #0)\n> I think that fields clazzes and statics should be static.\n\nWrong.\n\nEach ImportHandler instance must be independent.", "attachment_id": null, "id": 185001, "creator": "markt@apache.org", "time": "2015-09-07T10:14:49Z", "bug_id": 58328, "creation_time": "2015-09-07T10:14:49Z", "is_private": false}]