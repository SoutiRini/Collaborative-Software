[{"count": 0, "tags": [], "text": "Situation/Reproducing:\n\nA client is sending a request over SSL. Before the first byte of \nthe response is writen the client is closing the connection (stop button\npressed).\n(error_log: [info] (32)Broken pipe: core_output_filter: writing data to the\nnetwork)\n\nIf in that situation the 'ssl_io_filter_cleanup' handler will be invoked, he is \ntrying to send a SSL shutdown message. By that a memory violations occurs. See\nthe following stack:\n\n   dummy_worker(opaque = 0x170fc0)\n   worker_thread(thd = 0x170fc0, dummy = 0x1b1110)\n   apr_pool_clear(pool = 0x255cc0)\n   run_cleanups(cref = 0x255cd0)\n   ssl_io_filter_cleanup(data = 0x256148)\n   ssl_filter_io_shutdown(filter_ctx = 0x256148, c = 0x255de8, abortive = 0)\n   SSL_smart_shutdown(ssl = 0x279268)\n   ssl3_shutdown(0x279268, 0x0, 0xfe3562e0, 0xfdbf8000, 0xfffffff8, 0x274b50)\n   ssl3_send_alert(0x279268, 0x279ba8, 0x1, 0x3, 0x0, 0x2)\n   ssl3_write_pending(0x279268, 0x15, 0x15, 0x2, 0x0, 0x279cf4)\n   BIO_write(0x260070, 0x27f790, 0x17, 0xff33ac84, 0xff1f655c, 0x0)\n   bio_filter_out_write(bio = 0x260070, in = 0x27f790 \"^U^C^A\", inl = 23)\n   bio_filter_out_flush(bio = 0x260070)\n   ap_pass_brigade(next = 0x25c118, bb = 0x25f098)\n   core_output_filter(f = 0x25c118, b = 0x260108)\n   apr_pool_clear(pool = 0x2600d0)\n   allocator_free(allocator = 0x1b3e50, node = (nil)) <-!!!!!!!!!\n                                        \n\nFixes:\nThere are two possible fixes: \n\na) Point fix in ssl_io_filter_cleanup: \n   Free only the SSL struct, but do not send any SSL shutdown.\n\nb) Generel fix in allocator_free:\n   Check if the parameter 'apr_memnode_t *node' is NULL\n  \n\n\nPatches:\na)\nIndex: modules/ssl/ssl_engine_io.c\n===================================================================\nRCS file:\n/opt/projects/CVSROOT/navajo/src/org/apache/httpd-2.X/modules/ssl/ssl_engine_io.c,v\nretrieving revision 1.8\ndiff -r1.8 ssl_engine_io.c\n1080,1084c1080,1081\n<     c = (conn_rec *)SSL_get_app_data(filter_ctx->pssl);\n<     if ((ret = ssl_filter_io_shutdown(filter_ctx, c, 0)) != APR_SUCCESS) {\n<         ap_log_error(APLOG_MARK, APLOG_INFO, ret, NULL,\n<                      \"SSL filter error shutting down I/O\");\n<     }\n---\n>       SSL_free(filter_ctx->pssl);\n>       filter_ctx->pssl = NULL;\n1086c1083\n<     return ret;\n---\n>     return APR_SUCCESS;\n\n\n\nb) \n\nIndex: srclib/apr/memory/unix/apr_pools.c\n===================================================================\nRCS file:\n/opt/projects/CVSROOT/navajo/src/org/apache/httpd-2.X/srclib/apr/memory/unix/apr_pools.c,v\nretrieving revision 1.3\ndiff -r1.3 apr_pools.c\n309a310,312\n>       if(!node)\n>               return;\n>", "is_private": false, "id": 54658, "creator": "hartmut.keil@gmx.ch", "time": "2004-03-25T14:25:09Z", "bug_id": 27945, "creation_time": "2004-03-25T14:25:09Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "jorton@redhat.com", "text": "Thanks for the report.  Something similar to (a) was checked in already:\n\nhttp://cvs.apache.org/viewcvs.cgi/httpd-2.0/modules/ssl/ssl_engine_io.c?r1=1.121&r2=1.122", "id": 54716, "time": "2004-03-26T09:23:44Z", "bug_id": 27945, "creation_time": "2004-03-26T09:23:44Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "jorton@redhat.com", "is_private": false, "text": "*** Bug 28577 has been marked as a duplicate of this bug. ***", "id": 58081, "time": "2004-05-25T19:13:56Z", "bug_id": 27945, "creation_time": "2004-05-25T19:13:56Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 27945, "text": "*** Bug 29073 has been marked as a duplicate of this bug. ***", "id": 58083, "attachment_id": null, "creator": "jorton@redhat.com", "creation_time": "2004-05-25T19:15:20Z", "time": "2004-05-25T19:15:20Z", "is_private": false}, {"count": 4, "attachment_id": null, "bug_id": 27945, "is_private": false, "id": 58510, "time": "2004-06-01T21:21:24Z", "creator": "jorton@redhat.com", "creation_time": "2004-06-01T21:21:24Z", "tags": [], "text": "*** Bug 28512 has been marked as a duplicate of this bug. ***"}, {"count": 5, "tags": [], "bug_id": 27945, "text": "*** Bug 29690 has been marked as a duplicate of this bug. ***", "id": 59617, "attachment_id": null, "creator": "jorton@redhat.com", "creation_time": "2004-06-20T08:08:42Z", "time": "2004-06-20T08:08:42Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 27945, "text": "*** Bug 29788 has been marked as a duplicate of this bug. ***", "id": 59880, "attachment_id": null, "creator": "jorton@redhat.com", "creation_time": "2004-06-25T15:00:41Z", "time": "2004-06-25T15:00:41Z", "is_private": false}, {"count": 7, "tags": [], "creator": "jorton@redhat.com", "text": "*** Bug 29277 has been marked as a duplicate of this bug. ***", "id": 72132, "time": "2005-03-10T14:44:29Z", "bug_id": 27945, "creation_time": "2005-03-10T14:44:29Z", "is_private": false, "attachment_id": null}]