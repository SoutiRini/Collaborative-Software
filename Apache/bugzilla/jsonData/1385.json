[{"count": 0, "tags": [], "bug_id": 1385, "attachment_id": null, "id": 1917, "time": "2001-04-18T21:50:33Z", "creator": "bojan@binarix.com", "creation_time": "2001-04-18T21:50:33Z", "is_private": false, "text": "The previous patch would use /dev/random by default, which is not always the\ngreatest idea since /dev/random blocks until enough entropy is available on the\nsystem. To avoid such problems (and possible Tomcat hangs), /dev/urandom is now\nthe default source and /dev/random is the source when the option 'beParanoid' is\nspecified.\n\n/dev/urandom should be at least as good as java.security.SecureRandom, but much\nfaster. Thanks to Doug Barnes for explaining the merits of /dev/urandom.\n\nHere is the patch:\n\n--- jakarta-tomcat-3.3-build/src/share/org/apache/tomcat/modules/session/Session\nIdGenerator.java        Mon Apr 16 21:28:34 2001\n+++ jakarta-tomcat-3.3-src-cvs-debug/src/share/org/apache/tomcat/modules/session\n/SessionIdGenerator.java        Mon Apr 16 21:40:20 2001\n@@ -96,6 +96,8 @@\n     String randomClassName=null;\n     Random randomSource=null;\n     DataInputStream randomIS=null;\n+    boolean beParanoid=false;\n+    boolean useDevRandom=false;\n     \n     static Jdk11Compat jdk11Compat=Jdk11Compat.getJdkCompat();\n     \n@@ -109,18 +111,26 @@\n        randomSource=createRandomClass( randomClassName );\n     }\n \n-    /** Use /dev/random special device. This is new code, but may reduce the\n-     *  big delay in generating the random\n+    /** When using special device random generator, be paranoid and\n+     *  use /dev/random. When this option is not set (default), the\n+     *  device /dev/urandom is used, which should be at least as safe\n+     *  as java.security.SecureRandom.\n+     *\n+     *  Reads to /dev/random might block until additional environmental\n+     *  noise is gathered and this can cause problems (ie. Tomcat might\n+     *  hang until such noise is generated).\n+     *  USE WITH CAUTION!!!\n+     */\n+    public void setBeParanoid( boolean p ) {\n+        beParanoid = p;\n+    }\n+    \n+\n+    /** Use special device to generate random. This is new code,\n+     *  but may reduce the big delay in generating the random.\n      */\n     public void setUseDevRandom( boolean u ) {\n-       if( ! u ) return;\n-       try {\n-           randomIS= new DataInputStream( new FileInputStream(\"/dev/random\"));\n-           randomIS.readLong();\n-           log( \"Opening /dev/random\");\n-       } catch( IOException ex ) {\n-           randomIS=null;\n-       }\n+        useDevRandom = u;\n     }\n     \n     \n@@ -141,6 +151,23 @@\n     /** Init session management stuff for this context. \n      */\n     public void engineInit(ContextManager cm) throws TomcatException {\n+        if( useDevRandom ){\n+            String device=\"/dev/urandom\";\n+\n+            if( beParanoid )\n+                device=\"/dev/random\";\n+\n+           try {\n+               randomIS= new DataInputStream( new FileInputStream( device ));\n+               randomIS.readLong();\n+               log( \"Opening \" + device );\n+           } catch( IOException ex ) {\n+               randomIS=null;\n+           }\n+        }\n+\n+       /* The following code gets executed even if randomIS is null due to\n+           IOException above, so we are covered */\n        if( randomSource==null && randomIS==null ) {\n            String randomClass=(String)cm.getProperty(\"randomClass\" );\n            if( randomClass==null ) {\n@@ -261,7 +288,7 @@\n        if( devRandomIS!=null ) {\n            try {\n                n=devRandomIS.readLong();\n-               System.out.println(\"Getting /dev/random \" + n );\n+                System.out.println( \"Getting from random device \" + n );\n            } catch( IOException ex ) {\n                ex.printStackTrace();\n            }"}, {"count": 1, "tags": [], "bug_id": 1385, "attachment_id": null, "id": 1964, "time": "2001-04-20T17:35:01Z", "creator": "cmanolache@yahoo.com", "creation_time": "2001-04-20T17:35:01Z", "is_private": false, "text": "Should be checked in, I have no time right no."}, {"count": 2, "tags": [], "bug_id": 1385, "is_private": false, "text": "Done ( in a slightly different form - devRandom=\"/dev/urandom\", can be\nany file )", "id": 1967, "time": "2001-04-21T10:42:59Z", "creator": "cmanolache@yahoo.com", "creation_time": "2001-04-21T10:42:59Z", "attachment_id": null}]