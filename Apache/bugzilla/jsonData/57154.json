[{"count": 0, "tags": [], "text": "Steps to reproduce:\n1) Go to the temporary directory (System.getProperty(\"java.io.tmpdir\")) and create a directory named \"test\" there.\n2) Run org.apache.tomcat.websocket.TestWsWebSocketContainer test case with Nio or Nio 2.\n\nThe following two test cases are failing: \ntestWriteTimeoutServerEndpoint\ntestWriteTimeoutServerContainer\n\nCause of the failure is the following ERROR:\nThe HTTP response from the server [HTTP/1.1 302 Found\n] did not permit the HTTP upgrade to WebSocket\njavax.websocket.DeploymentException: The HTTP response from the server [HTTP/1.1 302 Found\n] did not permit the HTTP upgrade to WebSocket\n\nThis test case configures DefaultServlet and tries to access\n\"ws://localhost:\" + getPort() + \"/test\".\n\nI suspect that Mapper responds with 302 redirect before the upgrade request reaches web application.\n\nThis issue is observed at Buildbot. See\nTEST-org.apache.tomcat.websocket.TestWsWebSocketContainer.NIO.txt\nTEST-org.apache.tomcat.websocket.TestWsWebSocketContainer.NIO2.txt\nfiles in http://ci.apache.org/projects/tomcat/tomcat8/logs/1634329/", "is_private": false, "bug_id": 57154, "id": 178779, "time": "2014-10-27T22:07:01Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-10-27T22:07:01Z", "attachment_id": null}, {"count": 1, "tags": [], "text": "Created attachment 32152\nTEST-org.apache.tomcat.websocket.TestWsWebSocketContainer.NIO.txt\n\nLog file from testing Tomcat 8 trunk (@r1634690)", "is_private": false, "bug_id": 57154, "id": 178780, "time": "2014-10-27T22:10:15Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-10-27T22:10:15Z", "attachment_id": 32152}, {"count": 2, "attachment_id": 32153, "bug_id": 57154, "is_private": false, "id": 178781, "time": "2014-10-27T22:10:58Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-10-27T22:10:58Z", "tags": [], "text": "Created attachment 32153\nTEST-org.apache.tomcat.websocket.TestWsWebSocketContainer.NIO2.txt\n\nLog file from testing Tomcat 8 trunk (@r1634690)"}, {"attachment_id": null, "tags": [], "bug_id": 57154, "is_private": false, "count": 3, "id": 178830, "time": "2014-10-29T15:01:15Z", "creator": "markt@apache.org", "creation_time": "2014-10-29T15:01:15Z", "text": "The root cause of this is indeed the redirect from the Mapper.\n\nThe redirect is a result of one of the requirements for welcome file processing. The Servlet spec is clear Tomcat can implement these any way it likes so the current Tomcat behaviour is valid.\n\nIt looks like the best solution for this bug is a fix for bug 57155."}, {"count": 4, "attachment_id": null, "bug_id": 57154, "is_private": false, "id": 178837, "time": "2014-10-29T22:22:02Z", "creator": "markt@apache.org", "creation_time": "2014-10-29T22:22:02Z", "tags": [], "text": "Fixed with the fixes for bug 57155."}, {"count": 5, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "id": 178858, "time": "2014-10-31T10:36:21Z", "bug_id": 57154, "creation_time": "2014-10-31T10:36:21Z", "is_private": false, "text": "This test failure is reproducible with current Tomcat 7.0.x testsuite.\nNote that it does not happen by default, but only if one creates a %TEMP%\\test directory.\n\nPossible solutions:\na) Backport the feature from bug 57155 (for reference: r1635222).\nb) Reconfigure the tests to use some different temporary directory as docBase instead of the system-wide one.\nc) Improve Mapper.\nd) Close as WONTFIX.\n\na) is the best one, but requires some work as resource implementations differ between Tomcat 8 and 7.\n\nb) is an alternative way if a) is too hard.\n\nc) unlikely without further analysis.\n\nd) possible. A test configuration issue is not a show stopper.\n\nI am reopening this for Tomcat 7 now, so that it is not forgotten."}, {"count": 6, "tags": [], "bug_id": 57154, "attachment_id": 32749, "id": 183067, "time": "2015-05-22T01:39:18Z", "creator": "huxing.zhang@gmail.com", "creation_time": "2015-05-22T01:39:18Z", "is_private": false, "text": "Created attachment 32749\nbackport the feature from bug 57155 to Tomcat 7.0.x\n\nHi @Konstantin and @Mark, \n\nI have backported the feature from bug 57155 to Tomcat 7.0.x.\nWould you please kindly review the attached fix?\nThe main idea is borrowed from Mark's implementation in Tomcat 8.0.x.\n\nThe changes in the patch mainly includes:\n1) an EmptyDirContext implementation which is not backed by a file system.\n2) an enhancement in StandardContext that allows an application to be configured to have no docBase, precisely speaking, to have docBase to be null.\n3) changes in test cases that replacing unnecessary file system doc base with null doc base."}, {"count": 7, "text": "Hi @Konstantin and @Mark, \n\nIs there any update on this?", "creator": "huxing.zhang@gmail.com", "is_private": false, "id": 183116, "time": "2015-05-27T01:26:25Z", "bug_id": 57154, "creation_time": "2015-05-27T01:26:25Z", "tags": [], "attachment_id": null}, {"count": 8, "tags": [], "text": "Thanks for the patch. It has been applied (with a few minor tweaks to silence some Eclipse warnings) to 7.0.x and will be included in 7.0.63 onwards.", "attachment_id": null, "id": 183121, "creator": "markt@apache.org", "time": "2015-05-27T10:11:56Z", "bug_id": 57154, "creation_time": "2015-05-27T10:11:56Z", "is_private": false}, {"count": 9, "tags": [], "text": "(In reply to Mark Thomas from comment #8)\n> Thanks for the patch. It has been applied (with a few minor tweaks to\n> silence some Eclipse warnings) to 7.0.x and will be included in 7.0.63\n> onwards.\n\nFor a reference, implementation of this feature in Tomcat 7 is\nr1681953 + r1724913\n\nComments working on backport to Tomcat 6\n==========================\n\n1). Currently null is an unsupported value for StandardContext.docBase.\n\nUsing the null value is going to fail with a NullPointerException thrown\nfrom a \"new File(null)\" call.\n\nSo implementing support for a null docBase is a new feature\nand does not break any existing one.\n\n\n2). There is a slight difference with Tomcat 7 that ApplicationContext and ReplicatedContext$ReplApplContext constructors accept additional argument basePath.\n\n    public ServletContext getServletContext() {\n        if (context == null) {\n            context = new ApplicationContext(getBasePath(), this);\n\nThis resulted in a stacktrace like this:\n\n  java.lang.NullPointerException\n     at java.io.File.<init>(File.java:194)\n     at org.apache.catalina.core.StandardContext.getBasePath(StandardContext.java:5179)\n     at org.apache.catalina.core.StandardContext.getServletContext(StandardContext.java:1932)\n     at org.apache.catalina.core.StandardContext.postWorkDirectory(StandardContext.java:5448)\n     at org.apache.catalina.core.StandardContext.start(StandardContext.java:4563)\n\nThe basePath value is used to implement methods ApplicationContext.getRealPath(String)\nand getResource(String).\n\n(For historic reference: commits that removed basePath field from ApplicationContext\nin Tomcat 7 are r784083 + r834220)\n\nIn both methods the use of basePath is conditioned on \"if (context.isFilesystemBased())\"\ncondition. So if StandardContext is not based on a filesystem, the value of basePath in ApplicationContext does not matter.\n\nThus I am going to change StandardContext.getBasePath() to return null for a null docBase,\ninstead of failing with a NullPointerException.", "attachment_id": null, "bug_id": 57154, "id": 187760, "time": "2016-01-17T04:06:04Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2016-01-17T04:06:04Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 57154, "attachment_id": null, "is_private": false, "id": 187762, "time": "2016-01-17T05:17:44Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2016-01-17T05:17:44Z", "text": "Implemented in Tomcat 6 by r1725061 and will be in 6.0.45 onwards."}]