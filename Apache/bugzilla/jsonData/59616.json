[{"count": 0, "tags": [], "creator": "florian.kleedorfer@austria.fm", "attachment_id": null, "text": "#Context \n\nWe're using tomcat 8 in a setting where the client has a self-signed client certificate that is transmitted to the server to identify the client. The certificate is used to gather client-specific data in the appliation. We aren't interested in setting up our own PKI for that, or using official CAs. Self-signed certs on the client are fine, as far as we're concerned.\n\nOur code that works in 8.0.30 stops working when switching to 8.0.32, as documented in this issue on github https://github.com/researchstudio-sat/webofneeds/issues/547\n\nI am suspecting its either an APR or an openssl issue, or something related to the way we generate our certificates. I looked up the versions used in the last working and the first non-working tomcat minor releases:\n\ntomcat 8.0.30: tcnative version 1.1.33.0, OpenSSL 1.0.1m 19 Mar 2015 (works for us)\ntomcat 8.0.32: tcnative version 1.2.4.0 , OpenSSL 1.0.2e 3 Dec 2015 (doesn't work for us)\n\nwhen using the tcnative-1.dll from the tomcat 8.0.30 installation, our application also works in tomcat 8.0.32, which is another clue that the APR library is responsible for this change in behaviour. \n\nI could not get earlier versions of the 1.2 library for comparison, so this is filed as an 1.2.4 bug. \n\n# Config:\n\nI'm experiencing this on Windows 7, using the -x64 zip downloads.\n\nHere's the configuration of the tomcat connector:\n\n<Connector\n     clientAuth=\"wanted\" port=\"8443\" minSpareThreads=\"5\"\n     enableLookups=\"true\" disableUploadTimeout=\"true\"\n     acceptCount=\"100\" maxThreads=\"200\"\n     scheme=\"https\" secure=\"true\" SSLEnabled=\"true\"\n     SSLCertificateFile=\"C:/Users/fkleedorfer/wonkey/t-cert.pem\"\n     SSLCertificateKeyFile=\"C:/Users/fkleedorfer/wonkey/t-key.pem\"\n     SSLPassword=\"changeit\"\n     SSLVerifyClient=\"optionalNoCA\"\n     SSLVerifyDepth=\"2\"\n     sslProtocol=\"TLS\"/>\n\n# Logs:\n\nHere's the trace of the failing TLS handshake (including the exception), with -Djavax.net.debug=all\n\nclient side:\n\nhttps://gist.github.com/fkleedorfer/8b4c3932a1de4b51617eac5e03c0be29\n\nserver side, with java util logging level=ALL:\n\nhttps://gist.github.com/fkleedorfer/f9ca53ee1466bf50dba6ce6d3c243b39\n\n# Self-Signed Client certificate:\n\nC:\\Users\\fkleedorfer\\wonkey>keytool -list -v -providerclass org.bouncycastle.jce\n.provider.BouncyCastleProvider -storetype UBER -storepass [XXXX] -keystore owner-k\neys.jks\n\nKeystore-Typ: UBER\nKeystore-Provider: BC\n\nKeystore enth\u00e4lt 1 Eintrag\n\nAliasname: https://192.168.124.49:8443/owner\nErstellungsdatum: 19.05.2016\nEintragstyp: PrivateKeyEntry\nZertifikatskettenl\u00e4nge: 1\nZertifikat[1]:\nEigent\u00fcmer: CN=https://192.168.124.49:8443/owner,OU=Web of Needs\nAussteller: CN=https://192.168.124.49:8443/owner,OU=Web of Needs\nSeriennummer: 1\nG\u00fcltig von: Wed May 18 00:00:00 CEST 2016 bis: Sat May 19 00:00:00 CEST 2018\nZertifikat-Fingerprints:\n          MD5:  85:BD:2C:67:B5:BF:24:D5:D8:A2:F5:8D:51:F2:31:89\n          SHA1: F1:92:56:6E:70:A8:DF:05:3E:B1:34:65:8F:CA:D8:69:C6:4C:34:A5\n          SHA256: 43:60:9F:10:05:F3:2B:60:89:16:0F:65:87:E4:07:C1:48:FE:5E:D2:51:\nC6:BA:42:3B:0C:3F:25:9B:E3:37:FD\n          Signaturalgorithmusname: SHA256WITHECDSA\n          Version: 3\n\n\n*******************************************\n*******************************************\n**\n\nI posted this issue in the tomcat-users mailing list but did not get any response: http://mail-archives.apache.org/mod_mbox/tomcat-users/201605.mbox/browser", "id": 191185, "time": "2016-05-23T15:13:04Z", "bug_id": 59616, "creation_time": "2016-05-23T15:13:04Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 59616, "attachment_id": null, "id": 191193, "time": "2016-05-23T15:55:42Z", "creator": "florian.kleedorfer@austria.fm", "creation_time": "2016-05-23T15:55:42Z", "is_private": false, "text": "I tried with the latest APR versions available on the website: https://tomcat.apache.org/download-native.cgi\nwith 1.1.34, our application works, \nwith 1.2.7, I'm experiencing the same issue"}, {"count": 2, "tags": [], "bug_id": 59616, "attachment_id": null, "is_private": false, "id": 191730, "time": "2016-06-17T07:51:16Z", "creator": "markt@apache.org", "creation_time": "2016-06-17T07:51:16Z", "text": "I'm seeing the issue (or something very like it) with 1.2.7 and Tomcat trunk. I spent a little time looking at the 1.1.x code vs 1.2.x but don't see any obvious root causes. I plan to do some more investigation today."}, {"count": 3, "attachment_id": null, "bug_id": 59616, "is_private": false, "id": 191748, "time": "2016-06-17T11:21:02Z", "creator": "markt@apache.org", "creation_time": "2016-06-17T11:21:02Z", "tags": [], "text": "Results of further testing:\n\nThe following work:\nOSX + Tomcat 9.0.x + OpenSSL 1.0.2h + APR 1.5.2 + tc-native 1.2.x + OSX client\nOSX + Tomcat 9.0.x + OpenSSL 1.0.2h + APR 1.5.2 + tc-native 1.2.7 + OSX client\nOSX + Tomcat 9.0.x + OpenSSL 1.0.2h + APR 1.5.2 + tc-native 1.2.6 + OSX client\nOSX + Tomcat 9.0.x + OpenSSL 1.0.2h + APR 1.5.2 + tc-native 1.2.6 + Win client\n\nThe following fail:\nWin + Tomcat 9.0.x + OpenSSL 1.0.2h + APR 1.5.2 + tc-native 1.2.7 + Win client\nWin + Tomcat 9.0.x + OpenSSL 1.0.2h + APR 1.5.2 + tc-native 1.2.7 + OSX client\n\nAssuming there is only a single bug here, the results above rule everything out apart from the OS hosting the Tomcat server. That suggests an OS specific element of one of the native builds is responsible for this change. It is going to take some more work to track this down."}, {"count": 4, "tags": [], "text": "Whatever is going wrong is going wrong in OpenSSL. Don't know where the root cause is at the moment but the error is:\n3648:error:14089086:SSL routines:ssl3_get_client_certificate:certificate verify failed:.\\ssl\\s3_srvr.c:3270:\n\nWhich is triggered a full failure rather than allowing the tc-native code to decide what to do.", "is_private": false, "id": 191757, "creator": "markt@apache.org", "time": "2016-06-17T18:37:28Z", "bug_id": 59616, "creation_time": "2016-06-17T18:37:28Z", "attachment_id": null}, {"count": 5, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 191759, "time": "2016-06-17T21:46:39Z", "bug_id": 59616, "creation_time": "2016-06-17T21:46:39Z", "is_private": false, "text": "I've found the root cause. There were some changes in the build scripts between 1.1.x and 1.2.x that meant OCSP was always enabled. Validation with optionalNoCA always fails if OCSP is enabled.\n\nI plan to commit my fix early next week and start the process to release a new set of Windows binaries for tc-native."}, {"id": 191828, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "count": 6, "text": "1.1.x is not affected.\n1.2.0 to 1.2.7 is affected.\nThis has been fixed in 1.2.x and will be included in 1.2.8 onwards.", "time": "2016-06-20T09:30:18Z", "bug_id": 59616, "creation_time": "2016-06-20T09:30:18Z", "is_private": false}]