[{"count": 0, "tags": [], "bug_id": 60189, "text": "Created attachment 34314\nPatch fixing the issue\n\nApache httpd in the latest version (2.4.23) configured with worker/event mpm segfaults after receiving multiple successive graceful reloads (SIGHUP).\n\n\nReproducer:\n  1. Install httpd\n  2. Ensure using worker or event\n     (e.g.: sed -i -e '/^Load/s/^/#/' -e '/#Load.*event/s/^#//' /etc/httpd/conf.modules.d/00-mpm.conf)\n  3. systemctl restart httpd\n  4. systemctl start httpd; n=0; while :; do ((n++)); systemctl reload httpd || break; done 2>/dev/null; echo reload failed after count=$n\n\n\nThis causes that httpd segfaults after many consequent httpd's reloads. This can be very unpleasant, if someone has multiple custom files in /etc/logrotate.d/ with httpd reload inside it.\n\n\nBT from the core:\n\n(gdb) bt\n#0  0x00007fb40864c900 in ?? ()\n#1  <signal handler called>\n#2  0x00007fb4144561a3 in __select_nocancel () at ../sysdeps/unix/syscall-template.S:84\n#3  0x00007fb414b66975 in apr_sleep (t=t@entry=46875) at time/unix/time.c:246\n#4  0x00007fb414b5a833 in free_proc_chain (procs=0x555d904709b8) at memory/unix/apr_pools.c:2483\n#5  0x00007fb414b5b7c3 in apr_pool_clear (pool=0x555d903b4188) at memory/unix/apr_pools.c:777\n#6  0x0000555d90044d5f in main (argc=<optimized out>, argv=<optimized out>) at main.c:713\n\nI'm proposing following change:\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\ndiff --git a/server/mpm/event/event.c b/server/mpm/event/event.c\nindex c64b08f..5852685 100644\n--- a/server/mpm/event/event.c\n+++ b/server/mpm/event/event.c\n@@ -2735,6 +2735,7 @@ static int event_run(apr_pool_t * _pconf, apr_pool_t * plog, server_rec * s)\n \n     /* we've been told to restart */\n     apr_signal(SIGHUP, SIG_IGN);\n+    apr_signal(AP_SIG_GRACEFUL, SIG_IGN);\n \n     if (one_process) {\n         /* not worth thinking about */\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n\nI think, AP_SIG_GRACEFUL should be ignored, after we announced to httpd, we are going to restart, because otherwise, it can cause RACE when AP_SIG_GRACEFUL is received and httpd is just in apr_pool_clear function. \n\nIf you need any further info, feel free to ask.", "id": 194088, "time": "2016-09-29T13:45:18Z", "creator": "luhliari@redhat.com", "creation_time": "2016-09-29T13:45:18Z", "is_private": false, "attachment_id": 34314}, {"count": 1, "tags": [], "bug_id": 60189, "attachment_id": null, "id": 199390, "time": "2017-06-25T12:25:43Z", "creator": "toscano.luca@gmail.com", "creation_time": "2017-06-25T12:25:43Z", "is_private": false, "text": "Hi Lubos,\n\nwould it be possible for you to provide a stack trace with symbols and the output of \"thread apply all bt\" rather than only \"bt\" ?\n\nThanks!\n\nLuca"}, {"count": 2, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "text": "until we hear back, looks like PR60487\n\n*** This bug has been marked as a duplicate of bug 60487 ***", "id": 199393, "time": "2017-06-25T12:41:23Z", "bug_id": 60189, "creation_time": "2017-06-25T12:41:23Z", "is_private": false}]