[{"count": 0, "tags": [], "text": "The behaviour between loaded document and created document on the fly is\ndifferent due to documentURI/CSSBase.\nOn the loaded document the documentURI/CSSBase is pointing to the correct URL,\nwhere in the created document the documentURI/CSSBase is null. Therefore, on the\ncreated document some operation sometimes throw NullPointerException.\nSome possible fix is by checking for null or put under try catch block for null.\nUnfortunately, there are many part of CSS related stuff assuming that the\ndocumentURI/CSSBase is exist and do the operation directly without checking\nwhether it is throw NullPointerException or not, make bug fixes hard to spot :)\n\n\nHere is some sample of method that identified throw NullPointerException:\n1) On package org.apache.batik.css.engine\nClass CSSEngine\nmethod getCSSBaseURI() // instead of return null, it throw NullPointerException\nbecause the element.getCSSBase could be null also\nmethod parseStyleDeclaration(String) // instead of throw DOMException, it throw\nNullPointerException if documentURI is null\n\n2) On package org.apache.batik.css.engine.value.svg\nClass SVGPaintManager\nmethod createValue(LexicalUnit lu, CSSEngine engine) // instead of throw\nDOMException, it throw NullPointerException due to resolveURI throw\nNullPointerException instead of return null", "is_private": false, "id": 41613, "creator": "tonny@kiyut.com", "time": "2003-07-28T01:08:27Z", "bug_id": 21919, "creation_time": "2003-07-28T01:08:27Z", "attachment_id": null}, {"count": 1, "tags": [], "text": "I believe these are now fixed in CVS.\nPlease get back to me if you think I can close this bug.", "is_private": false, "id": 41761, "creator": "deweese@apache.org", "time": "2003-07-30T11:24:26Z", "bug_id": 21919, "creation_time": "2003-07-30T11:24:26Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "tonny@kiyut.com", "text": "download the latest CVS and checking.\nThe bug almost done, but still one NullPointerException\n\nSome operation I could think of is passed, but one operation that still produce\nthe bug. I provided the code test below, just copy & paste (don't forget to\nchange the package). \n\nLook like the bug is from\nCSSEngine.getCSSBaseURI() // it is still throw NullPointerException if the\nelement.getCSSBase is null\n\n\n===============================================================================\npackage kiyut.bug; //don't forget to change the package for compile :)\n\nimport org.apache.batik.dom.svg.*;\nimport org.apache.batik.util.*;\n\nimport org.w3c.dom.*;\nimport org.w3c.dom.css.*;\nimport org.w3c.dom.svg.*;\n\nimport org.apache.batik.bridge.*;\nimport org.apache.batik.gvt.*;\n\npublic class Bug21919 {\n    String svgNS = SVGDOMImplementation.SVG_NAMESPACE_URI;\n    \n    public static void main(String[] args) {\n        Bug21919 bug = new Bug21919();\n        bug.runTest();\n    }\n    \n    /** Creates a new instance of bug21919 */\n    public Bug21919() {\n    }\n    \n    private void runTest() {\n        SVGDocument doc = createSVGDocument();\n        buildContent(doc);\n        hereIsTheBug(doc);\n    }\n    \n    private SVGDocument createSVGDocument() {\n        DOMImplementation impl = SVGDOMImplementation.getDOMImplementation();\n        Document doc = impl.createDocument(svgNS, \"svg\", null);\n        return (SVGDocument)doc;\n    }\n    \n    private void buildContent(SVGDocument doc) {\n        // get the root element (the svg element)\n        Element svgRoot = doc.getRootElement();\n        \n        // set the width and height attribute on the root svg element\n        svgRoot.setAttributeNS(null, \"width\", \"800\");\n        svgRoot.setAttributeNS(null, \"height\", \"600\");\n        \n        // create defs element with linear gradient\n        Element defsElt = doc.createElementNS(svgNS,SVGConstants.SVG_DEFS_TAG);\n        svgRoot.appendChild(defsElt);\n        SVGElement gradElt =\n(SVGElement)doc.createElementNS(svgNS,SVGConstants.SVG_LINEAR_GRADIENT_TAG);\n        gradElt.setId(\"grad1\");\n        defsElt.appendChild(gradElt);\n        \n        // create rect element with fill attribute of the gradient elt above\n        SVGElement rectElt =\n(SVGElement)doc.createElementNS(svgNS,SVGConstants.SVG_RECT_TAG);\n        svgRoot.appendChild(rectElt);\n        rectElt.setId(\"rect1\");\n        rectElt.setAttribute(SVGConstants.SVG_X_ATTRIBUTE, \"10\");\n        rectElt.setAttribute(SVGConstants.SVG_Y_ATTRIBUTE, \"10\");\n        rectElt.setAttribute(SVGConstants.SVG_WIDTH_ATTRIBUTE, \"100\");\n        rectElt.setAttribute(SVGConstants.SVG_HEIGHT_ATTRIBUTE, \"100\");\n        \n        // need to load GVT component, because without it SVGStyleable.getStyle\nwill throw NullPointerException\n        // is it necessary to load GVT component?\n        UserAgentAdapter userAgent = new UserAgentAdapter();\n        DocumentLoader documentLoader = new DocumentLoader(userAgent);\n        BridgeContext bridgeContext = new BridgeContext(userAgent, documentLoader);\n        bridgeContext.setDynamic(true);\n        GVTBuilder gvtBuilder = new DynamicGVTBuilder();\n        GraphicsNode root = gvtBuilder.build(bridgeContext, doc);\n                                \n        SVGStylable svgStylable = (SVGStylable)rectElt;\n        CSSStyleDeclaration cssStyle = svgStylable.getStyle();\n        // ************************************\n        // if the property is not URI, it is ok\n        // just comment the url line below and uncomment the none value after that\n        cssStyle.setProperty(SVGConstants.SVG_FILL_ATTRIBUTE,\"url(#grad1)\", \"\");\n       \n//cssStyle.setProperty(SVGConstants.SVG_FILL_ATTRIBUTE,SVGConstants.SVG_NONE_VALUE,\n\"\");\n        cssStyle.setProperty(SVGConstants.SVG_FILL_RULE_ATTRIBUTE,\nSVGConstants.SVG_NON_ZERO_VALUE, \"\");\n        cssStyle.setProperty(SVGConstants.SVG_FILL_OPACITY_ATTRIBUTE,\nInteger.toString(1), \"\");\n    }\n    \n    private void hereIsTheBug(SVGDocument doc) {\n        SVGRectElement rectElt = (SVGRectElement)doc.getElementById(\"rect1\");\n\n        // just check the value is correct or not\n        NamedNodeMap nodeMap = rectElt.getAttributes();\n        for (int i=0; i<nodeMap.getLength(); i++) {\n            Node node = nodeMap.item(i);\n            System.out.println(node.getNodeName()+\"=\" + node.getNodeValue());\n        }\n        \n        SVGStylable svgStylable = (SVGStylable)rectElt;\n        CSSStyleDeclaration cssStyle = svgStylable.getStyle();\n                \n       \ncssStyle.setProperty(SVGConstants.SVG_FILL_ATTRIBUTE,SVGConstants.SVG_NONE_VALUE,\n\"\");\n        System.out.println(\"...success change the fill property: none\");\n        System.out.println(cssStyle.getCssText());\n        \n        cssStyle.setProperty(SVGConstants.SVG_FILL_ATTRIBUTE,\"url(#grad1)\", \"\");\n        System.out.println(\"...success change the fill property: url(#grad1)\");\n        System.out.println(cssStyle.getCssText());\n    }\n}\n================================================================================", "id": 41824, "time": "2003-07-31T06:46:36Z", "bug_id": 21919, "creation_time": "2003-07-31T06:46:36Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 21919, "attachment_id": null, "is_private": false, "id": 44777, "time": "2003-09-28T00:12:37Z", "creator": "deweese@apache.org", "creation_time": "2003-09-28T00:12:37Z", "text": "Your code appears to run cleanly with current CVS.\nIt is possible that my fix to URL resolution for fill etc.\nfixed this bug as well.\nPlease test and let me know if you agree."}, {"count": 4, "tags": [], "text": "Yes bug fix on bug #21487 (fix on URL resolution fix this bug), loaded and\ncreated document show no difference.\n\nhowever trying to get the CSSEngine.getCSSBaseURI() directly still throws\nNullPointerException, but other operation using the public interface such as\nCSSStyleDeclaration no longer throws NullPointerException,\nsince this is internal implementation of CSSEngine, it is maybe ok, then this\nbug can be closed.\n\nlike the following code snipset\n// on created on the fly document, not loaded document\nSVGOMDocument svgDoc = (SVGOMDocument)rectElt.getOwnerDocument();\nSVGCSSEngine cssEngine = (SVGCSSEngine)svgDoc.getCSSEngine();\nURL url = cssEngine.getCSSBaseURI(); // this throws NullPointerException\n\nwhat I expect is CSSEngine.getCSSBaseURI() either return null or throws\nDOMException, not throws NullPointerException. but since this is internal\nimplementation of CSSEngine, it is maybe ok, then this bug can be closed.", "is_private": false, "id": 44848, "creator": "tonny@kiyut.com", "time": "2003-09-29T17:00:17Z", "bug_id": 21919, "creation_time": "2003-09-29T17:00:17Z", "attachment_id": null}]