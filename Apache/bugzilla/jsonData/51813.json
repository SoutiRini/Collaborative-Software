[{"count": 0, "tags": [], "bug_id": 51813, "is_private": false, "id": 149241, "creation_time": "2011-09-14T20:25:06Z", "time": "2011-09-14T20:25:06Z", "creator": "mike.jakubik@intertainservices.com", "text": "Hello,\n\nAfter a recent upgrade of tomcat-native and apr1, tomcat crashes about once a day with the following error.\n\nFreeBSD 8.2-STABLE #0: Mon Sep 12 16:17:30 EDT 2011\n\napr-devrandom-1.4.5.1.3.12_1\nopenjdk6-b23_1\ntomcat-6.0.33_1\ntomcat-native-1.1.22\n\nThanks.\n\n\n---\nMemory: 4k page, physical 3738444k(934611k free)\n\n/proc/meminfo:\n\n\nvm_info: OpenJDK 64-Bit Server VM (20.0-b11) for bsd-amd64 JRE (1.6.0-b23), built on Sep 12 2011 16:30:25 by \"root\" with gcc 4.2.2 20070831 prerelease [FreeBSD]\n\ntime: Wed Sep 14 15:37:34 2011\nelapsed time: 96332 seconds\n\ndiversity@app.local:~$ cat hs_err_pid11416.log \ndiversity@app.local:~$ cat hs_err_pid11416.log \n#\n# A fatal error has been detected by the Java Runtime Environment:\n#\n#  SIGSEGV (0xb) at pc=0x00000008e711c2ca, pid=11416, tid=34389419648\n#\n# JRE version: 6.0-b23\n# Java VM: OpenJDK 64-Bit Server VM (20.0-b11 mixed mode bsd-amd64 compressed oops)\n# Problematic frame:\n# C  [libtcnative-1.so.1+0x152ca]  Java_org_apache_tomcat_jni_Socket_sendbb+0x5a\n#\n# If you would like to submit a bug report, please visit:\n#   http://java.sun.com/webapps/bugreport/crash.jsp\n# The crash happened outside the Java Virtual Machine in native code.\n# See problematic frame for where to report the bug.\n#\n\n---------------  T H R E A D  ---------------\n\nCurrent thread (0x0000000801cee800):  JavaThread \"Finalizer\" daemon [_thread_in_native, id=100137, stack(0x00007fffff3f8000,0x00007fffff4f8000)]\n\nsiginfo:si_signo=SIGSEGV: si_errno=0, si_code=1 (SEGV_MAPERR), si_addr=0x0000000000000040\n\nRegisters:\nRAX=0x0000000000000000, RBX=0x0000000000000000, RCX=0x0000000000000000, RDX=0x00007fffff4f6f88\nRSP=0x00007fffff4f6f80, RBP=0x00000008eea0d0a0, RSI=0x0000000000000000, RDI=0x0000000000000000\nR8 =0x000000000000000e, R9 =0x000000080c848858, R10=0x0000000802151d3b, R11=0x000000080158d150\nR12=0x000000000000000e, R13=0x0000000000000000, R14=0x00007fffff4f6f88, R15=0x0000000801cee800\nRIP=0x00000008e711c2ca, EFLAGS=0x0000000000000001, ERR=0x0000000000000004\n  TRAPNO=0x000000000000000c\n\nTop of Stack: (sp=0x00007fffff4f6f80)\n0x00007fffff4f6f80:   00000008037c6ebc 000000000000000e\n0x00007fffff4f6f90:   0000000805b2a308 00007fffff4f7028\n0x00007fffff4f6fa0:   000000080515f000 0000000805b2a308\n0x00007fffff4f6fb0:   00007fffff4f7060 0000000802151d68\n0x00007fffff4f6fc0:   0000000007d4c462 0000000843bc1430\n0x00007fffff4f6fd0:   0000000843b9e0e8 07d4b5d600000000\n0x00007fffff4f6fe0:   0000000843bad168 00007fffff4f6fe8\n0x00007fffff4f6ff0:   0000000000000000 00007fffff4f7060\n0x00007fffff4f7000:   0000000805b2b660 0000000000000000\n0x00007fffff4f7010:   0000000805b2a308 0000000000000000\n0x00007fffff4f7020:   00007fffff4f7070 00007fffff4f7158\n0x00007fffff4f7030:   0000000803a2d280 0000000805b2b5f8\n0x00007fffff4f7040:   000000080214ef56 000000080000000e\n0x00007fffff4f7050:   00007fff00000000 00000008eea0d0a0\n0x00007fffff4f7060:   00000008f6d410a0 0000000803a2d280\n0x00007fffff4f7070:   0000000843bad168 00007fffff4f7090\n0x00007fffff4f7080:   00007fffff4f70e8 000000080214685a\n0x00007fffff4f7090:   00007fffff4f7100 000000080214685a\n0x00007fffff4f70a0:   00007fffff4f7158 0000000803be86f0\n0x00007fffff4f70b0:   0000000829fbb1f0 0000000843bb9e58\n0x00007fffff4f70c0:   00007fffff4f70c0 000000080c841ecd\n0x00007fffff4f70d0:   00007fffff4f7110 000000080c843338\n0x00007fffff4f70e0:   00007fffff4f7158 000000080214685a\n0x00007fffff4f70f0:   00007fffff4f7158 000000080214685a\n0x00007fffff4f7100:   0000000843bb9e58 0000000829fbb1e0\n0x00007fffff4f7110:   0000000843bb9e58 00007fffff4f7118\n0x00007fffff4f7120:   000000080c870e40 00007fffff4f7178\n0x00007fffff4f7130:   000000080c872b98 0000000812603d80\n0x00007fffff4f7140:   000000080c870e98 00007fffff4f7100\n0x00007fffff4f7150:   00007fffff4f7170 00007fffff4f71c0\n0x00007fffff4f7160:   000000080214685a 0000000000000000\n0x00007fffff4f7170:   0000000000000001 0000000843bba248 \n\nInstructions: (pc=0x00000008e711c2ca)\n0x00000008e711c2aa:   4c 89 f2 4c 89 e0 4c 89 ee 48 29 d8 48 89 44 24\n0x00000008e711c2ba:   08 48 03 75 20 48 8b 45 30 48 01 de 48 8b 7d 18\n0x00000008e711c2ca:   ff 50 40 89 c2 85 c0 74 cd 3d 77 11 01 00 74 47\n0x00000008e711c2da:   be 3e 2b fe ff 83 fa 23 74 1d 40 b6 3d 83 fa 04 \n\nRegister to memory mapping:\n\nRAX=0x0000000000000000 is an unknown value\nRBX=0x0000000000000000 is an unknown value\nRCX=0x0000000000000000 is an unknown value\nRDX=0x00007fffff4f6f88 is pointing into the stack for thread: 0x0000000801cee800\nRSP=0x00007fffff4f6f80 is pointing into the stack for thread: 0x0000000801cee800\nRBP=0x00000008eea0d0a0 is an unknown value\nRSI=0x0000000000000000 is an unknown value\nRDI=0x0000000000000000 is an unknown value\nR8 =0x000000000000000e is an unknown value\nR9 =0x000000080c848858 is an oop\n{instance class} \n - klass: {other class}\nR10=0x0000000802151d3b is an Interpreter codelet\nmethod entry point (kind = native)  [0x0000000802151ae0, 0x0000000802152320]  2112 bytes\nR11=0x000000080158d150: JVM_handle_bsd_signal+0x7d4e0 in /usr/local/openjdk6/jre/lib/amd64/server/libjvm.so at 0x0000000800e00000\nR12=0x000000000000000e is an unknown value\nR13=0x0000000000000000 is an unknown value\nR14=0x00007fffff4f6f88 is pointing into the stack for thread: 0x0000000801cee800\nR15=0x0000000801cee800 is a thread\n\n\nStack: [0x00007fffff3f8000,0x00007fffff4f8000],  sp=0x00007fffff4f6f80,  free space=1019k\nNative frames: (J=compiled Java code, j=interpreted, Vv=VM code, C=native code)\nC  [libtcnative-1.so.1+0x152ca]  Java_org_apache_tomcat_jni_Socket_sendbb+0x5a\n\nJava frames: (J=compiled Java code, j=interpreted, Vv=VM code)\nj  org.apache.tomcat.jni.Socket.sendbb(JII)I+0\nJ  org.apache.coyote.ajp.AjpAprProcessor.action(Lorg/apache/coyote/ActionCode;Ljava/lang/Object;)V\nJ  org.apache.coyote.Response.action(Lorg/apache/coyote/ActionCode;Ljava/lang/Object;)V\nj  org.apache.catalina.connector.OutputBuffer.doFlush(Z)V+80\nj  org.apache.catalina.connector.OutputBuffer.flush()V+2\nj  org.apache.catalina.connector.CoyoteOutputStream.flush()V+4\nj  javax.imageio.stream.MemoryCacheImageOutputStream.flushBefore(J)V+47\nj  javax.imageio.stream.MemoryCacheImageOutputStream.close()V+15\nj  javax.imageio.stream.ImageInputStreamImpl.finalize()V+8\nv  ~StubRoutines::call_stub\nJ  java.lang.ref.Finalizer.invokeFinalizeMethod(Ljava/lang/Object;)V\nJ  java.lang.ref.Finalizer.access$100(Ljava/lang/ref/Finalizer;)V\nJ  java.lang.ref.Finalizer$FinalizerThread.run()V\nv  ~StubRoutines::call_stub\n\nOther Threads:\n  0x0000000801d2d800 VMThread [stack: 0x00007fffff5fa000,0x00007fffff6fa000] [id=100135]\n  0x0000000801d2d000 WatcherThread [stack: 0x00007ffffeef3000,0x00007ffffeff3000] [id=100156]\n\nVM state:not at safepoint (normal execution)\n\nVM Mutex/Monitor currently owned by a thread: None\n\nHeap\n PSYoungGen      total 128640K, used 7850K [0x00000008dd160000, 0x00000008e5160000, 0x00000008e5160000)\n  eden space 126208K, 6% used [0x00000008dd160000,0x00000008dd90aa68,0x00000008e4ca0000)\n  from space 2432K, 0% used [0x00000008e4ca0000,0x00000008e4ca0000,0x00000008e4f00000)\n  to   space 2432K, 0% used [0x00000008e4f00000,0x00000008e4f00000,0x00000008e5160000)\n PSOldGen        total 849152K, used 755229K [0x0000000825160000, 0x0000000858ea0000, 0x00000008dd160000)\n  object space 849152K, 88% used [0x0000000825160000,0x00000008532e7738,0x0000000858ea0000)\n PSPermGen       total 289920K, used 288717K [0x0000000805160000, 0x0000000816c80000, 0x0000000825160000)\n  object space 289920K, 99% used [0x0000000805160000,0x0000000816b53670,0x0000000816c80000)\n\nCode Cache  [0x0000000802141000, 0x0000000804f11000, 0x0000000805141000)\n total_blobs=9408 nmethods=8841 adapters=519 free_code_cache=2687808 largest_free_block=54272\n\nDynamic libraries:\n0x0000000000400000 \t/usr/local/openjdk6/bin/java\n0x0000000800650000 \t/lib/libz.so.5\n0x0000000800765000 \t/lib/libthr.so.3\n0x000000080087e000 \t/lib/libc.so.7\n0x0000000800e00000 \t/usr/local/openjdk6/jre/lib/amd64/server/libjvm.so\n0x000000080188d000 \t/usr/lib/libstdc++.so.6\n0x0000000800aba000 \t/lib/libm.so.5\n0x0000000801a9b000 \t/lib/libgcc_s.so.1\n0x0000000801e00000 \t/usr/local/openjdk6/jre/lib/amd64/libverify.so\n0x0000000801f0f000 \t/usr/local/openjdk6/jre/lib/amd64/libjava.so\n0x000000080203a000 \t/usr/local/openjdk6/jre/lib/amd64/libzip.so\n0x00000008e7000000 \t/usr/local/openjdk6/jre/lib/amd64/libmanagement.so\n0x00000008e7107000 \t/usr/local/lib/libtcnative-1.so.1\n0x00000008e7229000 \t/usr/lib/libssl.so.6\n0x00000008e737c000 \t/lib/libcrypto.so.6\n0x00000008e761d000 \t/usr/local/lib/libapr-1.so.4\n0x00000008e7749000 \t/lib/libcrypt.so.5\n0x00000008e7862000 \t/usr/local/openjdk6/jre/lib/amd64/libawt.so\n0x00000008e7a2a000 \t/usr/local/openjdk6/jre/lib/amd64/headless/libmawt.so\n0x00000008e7b30000 \t/usr/local/openjdk6/jre/lib/amd64/liblcms.so\n0x00000008e7c69000 \t/usr/local/openjdk6/jre/lib/amd64/libjpeg.so\n0x00000008ebc00000 \t/usr/local/openjdk6/jre/lib/amd64/libnet.so\n0x00000008efa00000 \t/usr/local/openjdk6/jre/lib/amd64/librmi.so\n0x00000008f443a000 \t/usr/local/openjdk6/jre/lib/amd64/libfontmanager.so\n0x00000008f4c00000 \t/usr/local/lib/libfreetype.so.9\n0x00000008f6800000 \t/usr/lib/libbz2.so.4\n0x00000008f6910000 \t/usr/local/openjdk6/jre/lib/amd64/libnio.so\n0x000000080050a000 \t/libexec/ld-elf.so.1\n\nVM Arguments:\njvm_args: -Xms512m -Xmx3072m -XX:MaxPermSize=512m -Xmn128m -Duser.language=en -Duser.country=US -Dorg.apache.jasper.compiler.Parser.STRICT_QUOTE_ESCAPING=false -Dnetworkaddress.cache.ttl=3600 -Djava.endorsed.dirs=/usr/local/apache-tomcat-6.0/endorsed -Dcatalina.base=/usr/local/apache-tomcat-6.0 -Dcatalina.home=/usr/local/apache-tomcat-6.0 -Djava.io.tmpdir=/usr/local/apache-tomcat-6.0/temp \njava_command: org.apache.catalina.startup.Bootstrap start\nLauncher Type: SUN_STANDARD\n\nEnvironment Variables:\nJAVA_HOME=/usr/local/openjdk6\nPATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/games:/usr/local/sbin:/usr/local/bin:/home/diversity/bin\nUSERNAME=root\nLD_LIBRARY_PATH=/usr/local/openjdk6/jre/lib/amd64/server:/usr/local/openjdk6/jre/lib/amd64:/usr/local/openjdk6/jre/../lib/amd64\nSHELL=/usr/local/bin/bash\n\nSignal Handlers:\nSIGSEGV: [libjvm.so+0x860b50], sa_mask[0]=0xfffefeff, sa_flags=0x00000042\nSIGBUS: [libjvm.so+0x860b50], sa_mask[0]=0xfffefeff, sa_flags=0x00000042\nSIGFPE: [libjvm.so+0x70ae70], sa_mask[0]=0xfffefeff, sa_flags=0x00000042\nSIGPIPE: [libjvm.so+0x70ae70], sa_mask[0]=0xfffefeff, sa_flags=0x00000042\nSIGXFSZ: [libjvm.so+0x70ae70], sa_mask[0]=0xfffefeff, sa_flags=0x00000042\nSIGILL: [libjvm.so+0x70ae70], sa_mask[0]=0xfffefeff, sa_flags=0x00000042\nSIGUSR1: SIG_DFL, sa_mask[0]=0x00000000, sa_flags=0x00000000\nSIGUSR2: [libjvm.so+0x70d6c0], sa_mask[0]=0x00000000, sa_flags=0x00000042\nSIGHUP: [libjvm.so+0x70c170], sa_mask[0]=0xfffefeff, sa_flags=0x00000042\nSIGINT: [libjvm.so+0x70c170], sa_mask[0]=0xfffefeff, sa_flags=0x00000042\nSIGTERM: [libjvm.so+0x70c170], sa_mask[0]=0xfffefeff, sa_flags=0x00000042\nSIGQUIT: [libjvm.so+0x70c170], sa_mask[0]=0xfffefeff, sa_flags=0x00000042\n\n\n---------------  S Y S T E M  ---------------\n\nOS:Bsd\nuname:FreeBSD 8.2-STABLE FreeBSD 8.2-STABLE #0: Mon Sep 12 16:17:30 EDT 2011     root@app.local:/usr/obj/usr/src/sys/APP amd64\nrlimit: STACK 524288k, CORE infinity, NPROC 5547, NOFILE 11095\nCPU:total 4 (4 cores per cpu, 1 threads per core) family 6 model 23 stepping 6, cmov, cx8, fxsr, mmx, sse, sse2, sse3, ssse3, sse4.1\n\nMemory: 4k page, physical 3738444k(934611k free)\n\n/proc/meminfo:\n\n\nvm_info: OpenJDK 64-Bit Server VM (20.0-b11) for bsd-amd64 JRE (1.6.0-b23), built on Sep 12 2011 16:30:25 by \"root\" with gcc 4.2.2 20070831 prerelease [FreeBSD]\n\ntime: Wed Sep 14 15:37:34 2011\nelapsed time: 96332 seconds", "attachment_id": null}, {"count": 1, "tags": [], "creator": "mike.jakubik@intertainservices.com", "attachment_id": null, "id": 149336, "time": "2011-09-16T18:50:26Z", "bug_id": 51813, "creation_time": "2011-09-16T18:50:26Z", "is_private": false, "text": "This appears to be a problem with the new jpeg encoder code in OpenJDKs javax.imageio. We have changed our code to render a PNG instead, and the issue appears to be solved."}, {"count": 2, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "id": 149339, "time": "2011-09-16T20:51:10Z", "bug_id": 51813, "creation_time": "2011-09-16T20:51:10Z", "is_private": false, "text": "There was a recent discussion on the users list where someone discovered that one of the JRE imaging APIs was keeping a reference to an OutputStream and randonly flushing it long after the request had completed.\n\nhttp://markmail.org/thread/pg6tcml5rvuiifv2\n\nThis wasn't causing crashes, though.\n\nI wonder if this might be a related problem: the output stream is flushed, but the response has already been sent and the thread/buffer put back into the worker queue. When another flush comes, it's in an invalid state?\n\nMike, would you be willing to try to reproduce the problem and then wrap an OutputStream around the response's OutputStream, and pass THAT to the ImageIO?\n\nSee here for an example of the kind of code I'm talking about:\nhttps://wiki.apache.org/tomcat/FAQ/KnownIssues#ImageIOIssues"}, {"count": 3, "tags": [], "creator": "mike.jakubik@intertainservices.com", "attachment_id": null, "id": 149527, "time": "2011-09-20T16:08:58Z", "bug_id": 51813, "creation_time": "2011-09-20T16:08:58Z", "is_private": false, "text": "Hi Christopher,\n\nThanks for the info, but it appears that simply switching to render a png instead of a jpeg has fixed our problem. Unfortunately i am not a programmer myself, and i don't have the resources to try your code.\n\nThanks."}, {"count": 4, "tags": [], "creator": "chris@christopherschultz.net", "text": "We have another bite:\nhttp://markmail.org/message/f5idaje4a4vg7vkd\n\nUpdated versions of everything, but the symptom is the same: ImageIO bug + APR + sendbb() + si_addr=0x0000000000000040", "id": 167334, "time": "2013-05-21T20:12:06Z", "bug_id": 51813, "creation_time": "2013-05-21T20:12:06Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "id": 167335, "time": "2013-05-21T20:12:39Z", "bug_id": 51813, "creation_time": "2013-05-21T20:12:39Z", "is_private": false, "text": "I think this ought to do it (though I'm sure there are other places in tcnative that could afford to have this same kind of checking):\n\n\nIndex: native/src/network.c\n===================================================================\n--- native/src/network.c\t(revision 1484904)\n+++ native/src/network.c\t(working copy)\n@@ -587,6 +587,10 @@\n         tcn_ThrowAPRException(e, APR_ENOTSOCK);\n         return -(jint)APR_ENOTSOCK;\n     }\n+    if(!s->net) {\n+      tcn_ThrowAPRException(e, APR_EINVALSOCK);\n+      return -(jint)APR_EINVALSOCK;\n+    }\n     TCN_ASSERT(s->opaque != NULL);\n     TCN_ASSERT(s->jsbbuff != NULL);\n #ifdef TCN_DO_STATISTICS"}, {"count": 6, "tags": [], "creator": "chris@christopherschultz.net", "text": "(Note the above example patch is against tcnative/1.1.x branch)", "id": 167336, "time": "2013-05-21T20:13:09Z", "bug_id": 51813, "creation_time": "2013-05-21T20:13:09Z", "is_private": false, "attachment_id": null}, {"count": 7, "attachment_id": 30402, "bug_id": 51813, "text": "Created attachment 30402\nPatch against tcnative-1.1.x\n\nI'm not sure if I should be checking s->net or s->sock. They both seem to be set to NULL in the various recycle routines so it probably doesn't matter either way.\n\nI'm also not sure if APR_EINVALSOCK is the right error code to use.", "id": 167695, "time": "2013-06-06T16:20:28Z", "creator": "chris@christopherschultz.net", "creation_time": "2013-06-06T16:20:28Z", "tags": [], "is_private": false}, {"count": 8, "tags": [], "bug_id": 51813, "is_private": false, "id": 167723, "creation_time": "2013-06-07T16:18:31Z", "time": "2013-06-07T16:18:31Z", "creator": "rainer.jung@kippdata.de", "text": "(In reply to Christopher Schultz from comment #7)\n> Created attachment 30402 [details]\n> Patch against tcnative-1.1.x\n> \n> I'm not sure if I should be checking s->net or s->sock. They both seem to be\n> set to NULL in the various recycle routines so it probably doesn't matter\n> either way.\n\nI'd go with the net member and add the check to and function of name send* and recv*, which already have the null pointer check for s (or its jlong equivalent sock).\n\n> I'm also not sure if APR_EINVALSOCK is the right error code to use.\n\n * APR_EINVALSOCK   APR was given an invalid socket\n * APR_ENOSOCKET    APR was not given a socket\n\nSo APR_EINVALSOCK sounds good.\n\nI haven't though checked the code that calls the recv* and send* methods for special error handling.\n\nRegards,\n\nRainer", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 51813, "attachment_id": null, "id": 167728, "creation_time": "2013-06-07T19:59:49Z", "time": "2013-06-07T19:59:49Z", "creator": "chris@christopherschultz.net", "text": "(In reply to Rainer Jung from comment #8)\n> (In reply to Christopher Schultz from comment #7)\n> > Created attachment 30402 [details]\n> > Patch against tcnative-1.1.x\n> > \n> > I'm not sure if I should be checking s->net or s->sock. They both seem to be\n> > set to NULL in the various recycle routines so it probably doesn't matter\n> > either way.\n> \n> I'd go with the net member and add the check to and function of name send*\n> and recv*, which already have the null pointer check for s (or its jlong\n> equivalent sock).\n\nI think that's pretty much what I've done. Do you think I missed anything?\n\n> > I'm also not sure if APR_EINVALSOCK is the right error code to use.\n> \n>  * APR_EINVALSOCK   APR was given an invalid socket\n>  * APR_ENOSOCKET    APR was not given a socket\n> \n> So APR_EINVALSOCK sounds good.\n\nOkay, I'll commit as-is, then.", "is_private": false}, {"count": 10, "tags": [], "bug_id": 51813, "is_private": false, "id": 169101, "creation_time": "2013-08-05T08:29:14Z", "time": "2013-08-05T08:29:14Z", "creator": "rainer.jung@kippdata.de", "text": "Here's another occurance:\n\n    [junit] Running org.apache.tomcat.websocket.TestWebSocketFrameClient\n    [junit] Aug 02, 2013 2:52:50 PM org.apache.catalina.core.AprLifecycleListener init\n    [junit] INFO: Loaded APR based Apache Tomcat Native library 1.1.27 using APR version 1.4.8.\n    [junit] Aug 02, 2013 2:52:50 PM org.apache.catalina.core.AprLifecycleListener init\n    [junit] INFO: APR capabilities: IPv6 [true], sendfile [true], accept filters [false], random [true].\n    [junit] Aug 02, 2013 2:52:50 PM org.apache.catalina.core.AprLifecycleListener initializeSSL\n    [junit] INFO: OpenSSL successfully initialized (OpenSSL 1.0.1esp1 12 Feb 2013)\n    [junit] Aug 02, 2013 2:52:52 PM org.apache.coyote.AbstractProtocol init\n    [junit] INFO: Initializing ProtocolHandler [\"http-apr-127.0.0.1-auto-1\"]\n    [junit] Aug 02, 2013 2:52:52 PM org.apache.catalina.core.StandardService startInternal\n    [junit] INFO: Starting service Tomcat\n    [junit] Aug 02, 2013 2:52:52 PM org.apache.catalina.core.StandardEngine startInternal\n    [junit] INFO: Starting Servlet Engine: Apache Tomcat/8.0.0-RC1\n    [junit] Aug 02, 2013 2:52:53 PM org.apache.coyote.AbstractProtocol start\n    [junit] INFO: Starting ProtocolHandler [\"http-apr-127.0.0.1-auto-1-59353\"]\n    [junit] Aug 02, 2013 2:53:53 PM org.apache.coyote.AbstractProtocol pause\n    [junit] INFO: Pausing ProtocolHandler [\"http-apr-127.0.0.1-auto-1-59353\"]\n    [junit] Aug 02, 2013 2:53:54 PM org.apache.catalina.core.StandardService stopInternal\n    [junit] INFO: Stopping service Tomcat\n    [junit] Aug 02, 2013 2:53:54 PM org.apache.coyote.AbstractProtocol stop\n    [junit] INFO: Stopping ProtocolHandler [\"http-apr-127.0.0.1-auto-1-59353\"]\n    [junit] #\n    [junit] # A fatal error has been detected by the Java Runtime Environment:\n    [junit] #\n    [junit] #  SIGSEGV (0xb) at pc=0xb76dfe74, pid=11403, tid=26\n    [junit] #\n    [junit] # JRE version: 7.0_25-b15\n    [junit] # Java VM: Java HotSpot(TM) Server VM (23.25-b01 mixed mode solaris-sparc )\n    [junit] # Problematic frame:\n    [junit] # C  [libtcnative-1.so.0.1.27+0xfe74]Tests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 66.655 sec\n    [junit]   Java_org_apache_tomcat_jni_Socket_recv+0x34\n    [junit] #\n    [junit] # Core dump written. Default location: /shared/build/dev/tomcat/incoming/tc8.0.x/8.0.0-RC1/tmp-8.0.0-RC1/apache-tomcat-8.0.0-RC1-src-gz/core or core.11403\n    [junit] #\n    [junit] # An error report file with more information is saved as:\n    [junit] # /shared/build/dev/tomcat/incoming/tc8.0.x/8.0.0-RC1/tmp-8.0.0-RC1/apache-tomcat-8.0.0-RC1-src-gz/hs_err_pid11403.log\n    [junit]                  -------------\n    [junit]   0  (0xb7af8558)  [b6|00|   24]\n    [junit]                  [   0x00000000]\n    [junit]                  [   0xb794be80]\n    [junit]                  [   0x0c800001]\n    [junit]                  -------------\n    [junit]   1  (0xb7af8568)  [00|b7|   25]\n    [junit]                  [   0xb7af6f78]\n    [junit]                  [   0x00000000]\n    [junit]                  [   0x80800001]\n    [junit]                  -------------\n\n\n\n b76dfe74 Java_org_apache_tomcat_jni_Socket_recv (30b528, b30ff188,\nb30fd09c, b29500, b30ff214, 0) + 34\n fbc0f780 * org/apache/tomcat/jni/Socket.recv(J[BII)I+32362\n fbc0f72c * org/apache/tomcat/jni/Socket.recv(J[BII)I+0\n fbc068ec *\norg/apache/coyote/http11/upgrade/AprServletInputStream.doRead(Z[BII)I+73\n(line 101)\n fbc068ec *\norg/apache/coyote/http11/upgrade/AbstractServletInputStream.read([BII)I+20\n(line 229)\n fbc068ec *\norg/apache/tomcat/websocket/server/WsFrameServer.onDataAvailable()V+46\n(line 89)\n fbc06b84 *\norg/apache/tomcat/websocket/server/WsHttpUpgradeHandler$WsReadListener.onDataAvailable()V+4\n(line 384)\n fbc0771c *\norg/apache/coyote/http11/upgrade/AbstractServletInputStream.onDataAvailable()V+11\n(line 337)\n fbc06b84 *\norg/apache/coyote/http11/upgrade/AbstractProcessor.upgradeDispatch(Lorg/apache/tomcat/util/net/SocketStatus;)Lorg/apache/tomcat/util/net/AbstractEndpoint$Handler$SocketState;+11\n(line 189)\n fbc073e0 *\norg/apache/coyote/AbstractProtocol$AbstractConnectionHandler.process(Lorg/apache/tomcat/util/net/SocketWrapper;Lorg/apache/tomcat/util/net/SocketStatus;)Lorg/apache/tomcat/util/net/AbstractEndpoint$Handler$SocketState;+171\n(line 1221)\n fbc06848 *\norg/apache/coyote/http11/Http11AprProtocol$Http11ConnectionHandler.process(Lorg/apache/tomcat/util/net/SocketWrapper;Lorg/apache/tomcat/util/net/SocketStatus;)Lorg/apache/tomcat/util/net/AbstractEndpoint$Handler$SocketState;+76\n(line 546)\n fbc073e0 *\norg/apache/tomcat/util/net/AprEndpoint$SocketProcessor.doRun()V+26 (line\n4492)\n fbc06b84 *\norg/apache/tomcat/util/net/AprEndpoint$SocketProcessor.run()V+55 (line 4468)\n...\n\nGDB tells my:\n\n#7  0xb76dfe74 in Java_org_apache_tomcat_jni_Socket_recv (e=0x30b528,\no=0xb30ff188, sock=<optimized out>, buf=0xb30ff214, offset=0,\ntoread=8192) at src/network.c:733\n733             if ((ss = (*s->net->recv)(s->opaque, sb, &nbytes)) ==\nAPR_SUCCESS)\n\n#7  0xb76dfe74 in Java_org_apache_tomcat_jni_Socket_recv (e=0x30b528,\no=0xb30ff188, sock=<optimized out>, buf=0xb30ff214, offset=0,\ntoread=8192) at src/network.c:733\n        sb =\n\"\\000\\006\\026\\200\\000\\f\u00de\u00cc\u00b3\\017\u00d1\\000\u00b7\\205{\u00cd\u00b7\\205{\u00d8\u00b3\\017\u00d1\\234\u00b3\\017\u00d1\\030\u00b3\\017\u00d0\u00a8\u00b7\\227(p\u00bb\\204H\\200\u00f2\\032\\226x\\000\\000\\000\\023\\000\\000\\000\\000\u00fb\u00c1\\227h\u00f2\\032\\227\\020\u00b3\\017\u00d18\u00b3\\017\u00d18\u00fb\u00c0hH\\000\\000\\b\u00b9\u00b3\\017\u00d1h\u00b3\\017\u00d1H\u00fb\u00c0hH\u00b3\\017\u00d1P\\000\\000\\002\u00b0\u00b7\\211+\u00d8\\000\\000\\000u\\000\\000\\000\\000\u00f2\\032\\227\n\u00f2\\032\\226\\210\u00f2\\032\\226\\210\\000\\000\\000u\\000\\000\\000\\000\u00b3\\017\u00d1h\u00fb\u00c0hH\u00bb\\204Hh\u00bc\u00d0\u00ach\\000\\000\\001\\032\\000\\000\\000\\000\u00b3\\017\u00d1\\230\u00b7\\225x'\u00b7\\225xH\u00b3\\017\u00d2$\u00b3\\017\u00d1 \u00b3\\017\u00d18\u00b7\\225}\u00f8\\000\\060\u00b4\\000\\000\\000\\000\\000\\000\\000\\000\u00b6\\000\\000\\000\\000\u00fb\u00c1\u00c4\u00c0\"...\n        s = 0xb29500\n        nbytes = 8192\n        ss = <optimized out>\n\n(gdb) print *s\n$5 = {pool = 0xb294c0, child = 0x0, sock = 0x0, opaque = 0xb297d8,\n  jsbbuff = 0x330398 \"HTTP/1.1 101 Switching Protocols\\r\\nServer:\nApache-Coyote/1.1\\r\\nUpgrade: websocket\\r\\nConnection:\nupgrade\\r\\nSec-WebSocket-Accept: tPEj68f24a5073zco+NHsEUCKpY=\\r\\nDate:\nFri, 02 Aug 2013 12:52:53 GMT\\r\\n\\r\\n\",\n  jrbbuff = 0xbfbc78 \"GET /firehose HTTP/1.1\\r\\nSec-WebSocket-Version:\n13\\r\\nUpgrade: websocket\\r\\nHost: localhost:59353\\r\\nSec-WebSocket-Key:\nqzlX6/aQxs4TAKyKCb+XLg==\\r\\nConnection: upgrade\\r\\n\\r\\n\", net = 0x0, pe\n= 0xb87958, last_active = 0, timeout = -2}\n\nThe reason for the crash is likely:\n\n(gdb) print s->net\n$7 = (tcn_nlayer_t *) 0x0\n\nSo dereferencing it in (*s->net->recv) gives a segfault.", "attachment_id": null}, {"count": 11, "attachment_id": null, "bug_id": 51813, "text": "Fixed in 1.1.x in r1518225, will be available in tcnative-1.1.28.\n\nNote that I did not add further checking for s->net->send and/or s->net->recv. Please re-open if it appears that will be necessary.", "id": 169776, "time": "2013-08-28T14:53:31Z", "creator": "chris@christopherschultz.net", "creation_time": "2013-08-28T14:53:31Z", "tags": [], "is_private": false}, {"count": 12, "tags": [], "creator": "markt@apache.org", "text": "*** Bug 57521 has been marked as a duplicate of this bug. ***", "id": 200437, "time": "2017-08-24T08:30:21Z", "bug_id": 51813, "creation_time": "2017-08-24T08:30:21Z", "is_private": false, "attachment_id": null}]