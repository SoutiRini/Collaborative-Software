[{"count": 0, "tags": [], "bug_id": 41930, "text": "Hi everyone!\n\nMy team is trying to track down what seems to be a random core dump on a large\nproduction site at work. It appears to be a memory corruption problem somewhere.\n\nChecking the core files with gdb I find apr_brigade_write() called with \npointers to invalid memory locations.\n\nAnother type of core dump that usually happens to us, is the one that was \npreviously discussed by Paul Linder (bug n.39738). Although I think they are \nnot the same problem, the cause may be the same: invalid memory locations.\n\nIt was reproduced not only with Apache 2.0.59, but with Apache 2.0.53 as well.\n\nWhat follow are the datails of the environment where this core dump took place:\n\n[cmc@madarrcc33 apache_2.0.53_debug]$ uname -a\nLinux madarrcc33.indra.es 2.6.10-1.771_FC2smp #1 SMP Mon Mar 28 01:10:51 EST \n2005 i686 i686 i386 GNU/Linux\n\n[cmc@madarrcc33 bin]$ cat /proc/meminfo | grep Mem\nMemTotal:      3895676 kB\nMemFree:        499028 kB\n\n[cmc@madarrcc33 bin]$ ./httpd -l\nCompiled in modules:\n  core.c\n  mod_access.c\n  mod_auth.c\n  mod_include.c\n  mod_log_config.c\n  mod_env.c\n  mod_setenvif.c\n  worker.c\n  http_core.c\n  mod_mime.c\n  mod_status.c\n  mod_autoindex.c\n  mod_asis.c\n  mod_cgid.c\n  mod_negotiation.c\n  mod_dir.c\n  mod_imap.c\n  mod_actions.c\n  mod_userdir.c\n  mod_alias.c\n  mod_so.c\n\n\n\nAnd this is a sample backtrace of the controversial thread:\n\n[...]\n\nThread 9 (process 10826):\n#0  0x001077a2 in _dl_sysinfo_int80 () from /lib/ld-linux.so.2\nNo symbol table info available.\n#1  0x00147276 in kill () from /lib/tls/libc.so.6\nNo symbol table info available.\n#2  0x08089052 in sig_coredump (sig=10760) at mpm_common.c:956\nNo locals.\n#3  <signal handler called>\nNo symbol table info available.\n#4  0x00187ff5 in memcpy () from /lib/tls/libc.so.6\nNo symbol table info available.\n#5  0x0085fe66 in apr_brigade_write (b=0x9300298, flush=0, ctx=0x0, \nstr=0x8f15d000 <Address 0x8f15d000 out of bounds>, \n    nbyte=1585) at apr_brigade.c:417\n\te = (apr_bucket *) 0x9303485\n\tremaining = 2400571392\n\tbuf = \n0x9303485 \"/cmc/entorno/intranetwl8/docroot/INT/componentes/INT_Pla081_CoePerson\nas/0,0,61000_0_0&glo_entorno=dev&glo_portal=INT&idSeccion1=57129&idSeccion2=5713\n0&idSeccion3=57131&idSeccion4=57132,00.html\"\n#6  0x08091021 in core_output_filter (f=0x92febc0, b=0x9320ad8) at core.c:4033\n\td = (apr_bucket *) 0x9302168\n\trv = 154149224\n\tmore = (apr_bucket_brigade *) 0x0\n\tc = (conn_rec *) 0x92fe828\n\tnet = (core_net_rec *) 0x92feb98\n\tctx = (core_output_filter_ctx_t *) 0x92fecd0\n\teblock = APR_NONBLOCK_READ\n\tinput_pool = (apr_pool_t *) 0x9326fb8\n#7  0x080899f7 in ap_pass_brigade (next=0x11db, bb=0x318) at util_filter.c:512\n\te = (apr_bucket *) 0x9300c78\n#8  0x08068730 in chunk_filter (f=0x93087e8, b=0x9328e70) at http_core.c:218\n\thdr_len = 154143864\n\tbytes = 2\n\teos = (apr_bucket *) 0x93008b8\n\tflush = (apr_bucket *) 0x0\n\tchunk_hdr = \"2\\r\\n\\000\u00e0\\2100\\t\\000\\000\\000\\000\\220S\u00cc\\000hG1\\t\"\n\tc = (conn_rec *) 0x92fe828\n\tmore = (apr_bucket_brigade *) 0x0\n\te = (apr_bucket *) 0x9300c28\n\trv = 154143864\n#9  0x080899f7 in ap_pass_brigade (next=0x11db, bb=0x318) at util_filter.c:512\n\te = (apr_bucket *) 0x9300c78\n#10 0x0808baa6 in ap_content_length_filter (f=0x9327c58, b=0x9328e70) at \nprotocol.c:1232\n\tr = (request_rec *) 0x9326ff0\n\tctx = (struct content_length_ctx *) 0x9328ec8\n\te = (apr_bucket *) 0x93008b8\n\teos = 1\n\teblock = APR_NONBLOCK_READ\n#11 0x080899f7 in ap_pass_brigade (next=0x11db, bb=0x318) at util_filter.c:512\n\te = (apr_bucket *) 0x9300c78\n#12 0x08064d95 in send_parsed_content (f=0x93288a8, bb=0x9328a68) at \nmod_include.c:3388\n\tdata = 0x0\n\tlen = 2\n\trelease = 151270848\n\tnewb = (apr_bucket *) 0x9328a6c\n\tstore = (char **) 0xaded68b8\n\tstore_len = (apr_size_t *) 0x9302760\n\tindex = 154307176\n\tctx = (ssi_ctx_t *) 0x92fec00\n\tr = (request_rec *) 0x9326ff0\n\tb = (apr_bucket *) 0x93008b8\n\tpass_bb = (apr_bucket_brigade *) 0x9328e70\n\trv = 0\n\tmagic = 0x93288a8 \"\u00a0\\023\u00ff\\b\"\n#13 0x080899f7 in ap_pass_brigade (next=0x11db, bb=0x318) at util_filter.c:512\n\te = (apr_bucket *) 0x9300c78\n#14 0x08090351 in default_handler (r=0x9326ff0) at core.c:3610\n\treq_cfg = (core_request_config *) 0x9300c78\n\tc = (conn_rec *) 0x92fe828\n\tbb = (apr_bucket_brigade *) 0x9328a68\n\te = (apr_bucket *) 0x9300708\n\td = (core_dir_config *) 0x9328158\n\terrstatus = 154307180\n\tfd = (apr_file_t *) 0x9328970\n\tstatus = 154143864\n\tbld_content_md5 = 154142472\n#15 0x0807eb2e in ap_run_handler (r=0x9326ff0) at config.c:152\n\tpHook = (ap_LINK_handler_t *) 0x9300c78\n\tn = 8\n\trv = 154143864\n#16 0x0807f042 in ap_invoke_handler (r=0x9326ff0) at config.c:364\n\tnew_handler = 0x11db <Address 0x11db out of bounds>\n\tp2 = 0x9300c78 \"\\234\\0020\\t\\234\\0020\\t \u00d1\\206\"\n\thandler = 0x9027d38 \"text/html\"\n\tresult = 154300400\n\told_handler = 0x0\n#17 0x0806c7f3 in ap_process_request (r=0x9326ff0) at http_request.c:249\n\taccess_status = 4571\n#18 0x080688d1 in ap_process_http_connection (c=0x92fe828) at http_core.c:251\n\tr = (request_rec *) 0x9326ff0\n\tcsd_set = 0\n\tcsd = (apr_socket_t *) 0x0\n#19 0x08087caa in ap_run_process_connection (c=0x92fe828) at connection.c:43\n\tpHook = (ap_LINK_process_connection_t *) 0x9300c78\n\tn = 0\n\trv = 154143864\n#20 0x0807bd09 in process_socket (p=0x92fe700, sock=0x92fe738, \nmy_child_num=4571, my_thread_num=154143864, \n    bucket_alloc=0x9300708) at worker.c:521\n\tcurrent_conn = (conn_rec *) 0x92fe828\n\tconn_id = 154134568\n\tcsd = 16\n\tsbh = (ap_sb_handle_t *) 0x92fe820\n#21 0x0807c352 in worker_thread (thd=0x904b5e0, dummy=0x9300c78) at worker.c:835\n\tprocess_slot = 1\n\tthread_slot = 25\n\tcsd = (apr_socket_t *) 0x92fe738\n\tbucket_alloc = (apr_bucket_alloc_t *) 0x9300c78\n\tlast_ptrans = (apr_pool_t *) 0x0\n\tptrans = (apr_pool_t *) 0x92fe700\n\trv = 154143864\n\tis_idle = 1\n#22 0x00cc0148 in dummy_worker (opaque=0x9300c78) at thread.c:105\nNo locals.\n#23 0x0035a98c in start_thread () from /lib/tls/libpthread.so.0\nNo symbol table info available.\n#24 0x001db7da in clone () from /lib/tls/libc.so.6\nNo symbol table info available.\n\n[...]", "id": 100799, "time": "2007-03-22T10:56:08Z", "creator": "vmferr@gmail.com", "creation_time": "2007-03-22T10:56:08Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "id": 100804, "time": "2007-03-22T13:35:37Z", "bug_id": 41930, "creation_time": "2007-03-22T13:35:37Z", "is_private": false, "text": "(In reply to comment #0)\n\nPlease ensure that you have the gdb macros loaded that are defined in .gdbinit\nthat is delivered with the sources of httpd (see\nhttp://httpd.apache.org/dev/debugging.html)\n\n\n> #4  0x00187ff5 in memcpy () from /lib/tls/libc.so.6\n> No symbol table info available.\n> #5  0x0085fe66 in apr_brigade_write (b=0x9300298, flush=0, ctx=0x0, \n> str=0x8f15d000 <Address 0x8f15d000 out of bounds>, \n>     nbyte=1585) at apr_brigade.c:417\n> \te = (apr_bucket *) 0x9303485\n> \tremaining = 2400571392\n\nThat looks far too large for me. This could be an indicator for an overflow here.\n\nPlease issue:\n\nframe 5\ndump_brigade b\ndump_bucket e\n\n\n> \tbuf = \n> 0x9303485 \"/cmc/entorno/intranetwl8/docroot/INT/componentes/INT_Pla081_CoePerson\n> as/0,0,61000_0_0&glo_entorno=dev&glo_portal=INT&idSeccion1=57129&idSeccion2=5713\n> 0&idSeccion3=57131&idSeccion4=57132,00.html\"\n> #6  0x08091021 in core_output_filter (f=0x92febc0, b=0x9320ad8) at core.c:4033\n> \td = (apr_bucket *) 0x9302168\n> \trv = 154149224\n> \tmore = (apr_bucket_brigade *) 0x0\n> \tc = (conn_rec *) 0x92fe828\n> \tnet = (core_net_rec *) 0x92feb98\n> \tctx = (core_output_filter_ctx_t *) 0x92fecd0\n> \teblock = APR_NONBLOCK_READ\n> \tinput_pool = (apr_pool_t *) 0x9326fb8\n\nPlease issue\n\nframe 6\ndump_brigade b\ndump_bucket temp\ndump_bucket e"}, {"count": 2, "tags": [], "bug_id": 41930, "text": "\nUsing the .gdbinit file delivered with the sources of Apache 2.0.59, what  \nfollows is the information you requested:\n\n\n(gdb) frame 5\n#5  0x00cc8b12 in apr_brigade_write (b=0x8c5ccd8, flush=0, ctx=0x0, \nstr=0xaaf1e000 <Address 0xaaf1e000 out of bounds>, nbyte=1037) at \napr_brigade.c:417\n417         memcpy(buf, str, nbyte);\n\n(gdb) dump_brigade b\ndump of brigade 0x8c5ccd8\n   | type     (address)    | length | data addr  | contents               | rc\n--------------------------------------------------------------------------------\n 0 | HEAP     (0x08c60030) | 108    | 0x08c601c0 | [4d~~<!-- VERSION ...] | 1\nend of brigade\n\n(gdb) dump_bucket e\n bucket=Cannot access memory at address 0xa200a0a\n\n\n\n\n\n(gdb) frame 6\n#6  0x08091c7d in core_output_filter (f=0x8c5b7a0, b=0xb23c0a48) at core.c:4103\n4103                                    apr_brigade_write(temp_brig, NULL, \nNULL, str, n);\n\n(gdb) dump_brigade b\ndump of brigade 0xb23c0a48\n   | type     (address)    | length | data addr  | contents               | rc\n--------------------------------------------------------------------------------\n 0 | MMAP     (0x08c5ffe0) | 1037   | 0x08c604e0 | [Cannot access memory at \naddress 0xaaf1e000\n\n(gdb) dump_bucket temp\nNo symbol \"temp\" in current context.\n\n(gdb) dump_bucket e\nNo symbol \"e\" in current context.\n\n\nIn advance, thank you for your help!\n", "id": 100820, "time": "2007-03-23T05:19:20Z", "creator": "vmferr@gmail.com", "creation_time": "2007-03-23T05:19:20Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 41930, "attachment_id": null, "text": "SIGBUS (rather than SIGSEGV) on Linux usually only happens when an mmaped file\nis e.g. truncated out from under the server.  Do you have files in this site\nwhich may be modified in-place whilst being served?\n\nI'd first try \"EnableMMap off\" to see if this goes away.", "id": 100821, "time": "2007-03-23T05:35:40Z", "creator": "jorton@redhat.com", "creation_time": "2007-03-23T05:35:40Z", "is_private": false}, {"count": 4, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "id": 100848, "time": "2007-03-23T15:13:39Z", "bug_id": 41930, "creation_time": "2007-03-23T15:13:39Z", "is_private": false, "text": "(In reply to comment #2)\n\n> (gdb) frame 6\n> #6  0x08091c7d in core_output_filter (f=0x8c5b7a0, b=0xb23c0a48) at core.c:4103\n> 4103                                    apr_brigade_write(temp_brig, NULL, \n> NULL, str, n);\n> \n> (gdb) dump_brigade b\n> dump of brigade 0xb23c0a48\n>    | type     (address)    | length | data addr  | contents               | rc\n> --------------------------------------------------------------------------------\n>  0 | MMAP     (0x08c5ffe0) | 1037   | 0x08c604e0 | [Cannot access memory at \n> address 0xaaf1e000\n\nI agree with Joe here: Looks like a problem with an MMAPed file. So please try\n\"EnableMMap off\" as Joe suggested.\nWhere do you have the files stored that are delivered by httpd (local disk / NFS\n/ something else)?\nHave you changed these files while the crash happened?"}, {"count": 5, "tags": [], "bug_id": 41930, "attachment_id": null, "is_private": false, "id": 105366, "time": "2007-07-13T06:03:53Z", "creator": "vmferr@gmail.com", "creation_time": "2007-07-13T06:03:53Z", "text": "Thanks to everyone!\n\nI'm sorry I have said nothing for three months.\n\n\"Do you have files in this site which may be modified in-place whilst being \nserved?\" --> Yes, we have. Most of the request to Apache ask for SSI pages -\nthat have to be completed before being sent to the client-. What's more, \nsometimes we save them to disk -by way of a cache memory-.\n\nThe directiva \"EnableMMAP\" was in fact enabled. Disabling it, this behaviour \nseems to have disappeared. \n\nWe keep having other troubles but I think they are not related to this thread.\n\nLet me not to close this thread for the time being, until we are sure this \nbehaviour is not appearing again."}]