[{"count": 0, "tags": [], "bug_id": 39643, "text": "When requesting the same object twice (a cachable object that respond to the mem\ncache parameters), a segmentation fault is generated (ie. [Tue May 23 12:59:31\n2006] [notice] child pid 960 exit signal Segmentation fault (11)) with Apache\n2.2.2 on RHEL ES 3 (Linux apache 2.4.21-40.ELsmp #1 SMP Thu Feb 2 22:22:39 EST)\nacting as a reverse proxy, with both mem cache and disk cache enabled for\nseveral virtual hosts.\n\nSeveral things were tried, but it makes no difference:\n- reload or restart Apache\n- reboot\n- disabling disk cache\n- changing mem cache parameters\n- request with \"deflatable\" and \"not deflatable\" objects\n- request with different browser (Firefox 1.5.0.3, IE 6.0SP2, telnet...)\n- requesting different objects (but still 2 times following) on different\nvirtual hosts\n\nBut disabling mem cache always makes it work perfectly without crashes.\n\nThis is an exemple of telnet request (extracted from tcpdump):\nGET /fichiers/1417/00000012.htm HTTP/1.1\nAccept: */*\nReferer: http://www.my-site.com/synergies/Pages/index_FS.asp?res=1024&\nAccept-Language: en-us\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)\nHost: www.my-site.com\nConnection: Keep-Alive\n\nThis is the cache configuration:\nCacheDefaultExpire 60\nCacheLastModifiedFactor 0.1\nCacheMaxExpire 86400\n<IfModule mod_mem_cache.c>\nCacheEnable mem /\nMCacheMaxObjectCount 10000\nMCacheMaxObjectSize 32768\nMCacheMaxStreamingBuffer 16384\nMCacheMinObjectSize 0\nMCacheRemovalAlgorithm GDSF\nMCacheSize 32768\n</IfModule>\n<IfModule mod_disk_cache.c>\nCacheEnable disk /\nCacheDirLength 2\nCacheDirLevels 3\nCacheMaxFileSize 1000000\nCacheMinFileSize 64\nCacheRoot /var/cache/apache\n</IfModule>\n\nAnd this is the gdb output:\nGNU gdb Red Hat Linux (6.1post-1.20040607.52rh)\nCopyright 2004 Free Software Foundation, Inc.\nGDB is free software, covered by the GNU General Public License, and you are\nwelcome to change it and/or distribute copies of it under certain conditions.\nType \"show copying\" to see the conditions.\nThere is absolutely no warranty for GDB.  Type \"show warranty\" for details.\nThis GDB was configured as \"i386-redhat-linux-gnu\"...Using host libthread_db\nlibrary \"/lib/tls/libthread_db.so.1\".\n\nwarning: core file may not match specified executable file.\nCore was generated by `/usr/local/apache/bin/httpdpprod -f\n/usr/local/apache/conf/httpd.conf -k'.\nProgram terminated with signal 11, Segmentation fault.\n...\n#0  0x00bc9ba1 in __read_nocancel () from /lib/tls/libpthread.so.0\n(gdb) where\n#0  0x00bc9ba1 in __read_nocancel () from /lib/tls/libpthread.so.0\n#1  0x08082355 in ap_mpm_pod_check (pod=0xfffffe00) at pod.c:54\n#2  0x0808072a in child_main (child_num_arg=-512) at worker.c:1233\n#3  0x0808090a in make_child (s=0x9c4ef48, slot=0) at worker.c:1316\n#4  0x0808096b in startup_children (number_to_start=2) at worker.c:1350\n#5  0x080814bd in ap_mpm_run (_pconf=0x2, plog=0x9c7b160, s=0x9c4ef48) at\nworker.c:1700\n#6  0x08061f60 in main (argc=5, argv=0xbfffbb64) at main.c:717\n(gdb) bt full\n#0  0x00bc9ba1 in __read_nocancel () from /lib/tls/libpthread.so.0\nNo symbol table info available.\n#1  0x08082355 in ap_mpm_pod_check (pod=0xfffffe00) at pod.c:54\n        c = 0 '\\0'\n        fd = 8\n        rc = -512\n#2  0x0808072a in child_main (child_num_arg=-512) at worker.c:1233\n        threads = (apr_thread_t **) 0xaa1b040\n        rv = 16\n        ts = (thread_starter *) 0xa94cce0\n        thread_attr = (apr_threadattr_t *) 0xa94ccf0\n        start_thread_id = (apr_thread_t *) 0xa94cd28\n#3  0x0808090a in make_child (s=0x9c4ef48, slot=0) at worker.c:1316\n        pid = 0\n#4  0x0808096b in startup_children (number_to_start=2) at worker.c:1350\n        i = 0\n#5  0x080814bd in ap_mpm_run (_pconf=0x2, plog=0x9c7b160, s=0x9c4ef48) at\nworker.c:1700\n        remaining_children_to_start = 2\n        rv = -512\n#6  0x08061f60 in main (argc=5, argv=0xbfffbb64) at main.c:717\n        exit_status = 0\n        c = 102 'f'\n        configtestonly = 0\n        confname = 0xbfffdb6c \"/usr/local/apache/conf/httpd.conf\"\n        def_server_root = 0x8089e25 \"/usr/local/apache\"\n        temp_error_log = 0x0\n        error = 0xfffffe00 <Address 0xfffffe00 out of bounds>\n        process = (process_rec *) 0x9c4b120\n        server_conf = (server_rec *) 0x9c4ef48\n        pglobal = (apr_pool_t *) 0x9c4b0a0\n        pconf = (apr_pool_t *) 0x9c4d0a8\n        plog = (apr_pool_t *) 0x9c7b160\n        ptemp = (apr_pool_t *) 0x9c7f170\n        pcommands = (apr_pool_t *) 0x9c4f0b0\n        opt = (apr_getopt_t *) 0x9c4f148\n        rv = -1073759564\n        mod = (module **) 0xbfffbab4\n        optarg = 0xbfffdb6c \"/usr/local/apache/conf/httpd.conf\"\n        signal_server = (apr_OFN_ap_signal_server_t *) 0x1\n\nThanks in advance,\nCarl ROLLER", "id": 89391, "time": "2006-05-23T15:39:38Z", "creator": "croller@generali.fr", "creation_time": "2006-05-23T15:39:38Z", "is_private": false, "attachment_id": null}, {"count": 1, "attachment_id": null, "creator": "chip@force-elite.com", "text": "I highly recommend that if you want a working cache system that you use\nmod_disk_cache.", "id": 89392, "time": "2006-05-23T15:46:52Z", "bug_id": 39643, "creation_time": "2006-05-23T15:46:52Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "text": "Which MPM are you using?\nIf you are using worker, please provide the stack traces of the other threads as\nwell (see also http://httpd.apache.org/dev/debugging.html).", "id": 89393, "time": "2006-05-23T15:52:57Z", "bug_id": 39643, "creation_time": "2006-05-23T15:52:57Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 39643, "text": "Created attachment 18334\nworker gdb thread trace\n\nThis is the worker configuration:\n<IfModule worker.c>\nServerLimit\t\t32\nStartServers\t\t 2\nMaxClients\t       250\nMinSpareThreads \t50\nMaxSpareThreads        125\nThreadsPerChild \t50\nMaxRequestsPerChild  10000\n</IfModule>", "id": 89394, "time": "2006-05-23T16:40:53Z", "creator": "croller@generali.fr", "creation_time": "2006-05-23T16:40:53Z", "is_private": false, "attachment_id": 18334}, {"count": 4, "attachment_id": null, "creator": "rpluem@apache.org", "is_private": false, "id": 89406, "time": "2006-05-23T19:04:16Z", "bug_id": 39643, "creation_time": "2006-05-23T19:04:16Z", "tags": [], "text": "Thanks for the trace. Meanwhile I tried to reproduce this problem in my\nenvironment with no success. Having a look at the stack trace I get the feeling\nthat either a severe stack corruption has happened or the output from gdb is\nbogus as:\n\nNo symbol table info available.\n#3  0x00b6a5bb in filter_harness (f=0xaa394f8, bb=0xaa39528) at mod_filter.c:380\n        ret = 0\n        cachecontrol = 0x0\n        str = 0xb6b7a918 \"H\\uffff\\uffff\\uffffMO\\uffff\"\n        ctx = (harness_ctx *) 0x0\n        filter = (ap_filter_rec_t *) 0xa13c1f8\n\nWe cannot be in line 380 of mod_filter with cachecontrol being 0x.\n\n#4  0x080799ce in ap_pass_brigade (next=0xaa394f8, bb=0x0) at util_filter.c:526\n        e = (apr_bucket *) 0x0\n#5  0x00b34f4d in cache_url_handler (r=0xaa37c70, lookup=0) at mod_cache.c:79\n        __s = (void *) 0xaa38e60\n        rv = 164174920\n        auth = 0x0\n        providers = (cache_provider_list *) 0x9c91c48\n        cache = (cache_request_rec *) 0xaa38e60\n        conf = (cache_server_conf *) 0x0\n        out = (apr_bucket_brigade *) 0x0\n\nThere is no call to ap_pass_brigade in line 79 of mod_cache.c. Furthermore\nhaving conf set to NULL while being in line 79 is highly unlikely.\n\nCan you set the log level to debug and provide the output?\nPlease provide the output for both actions (first request and second request\nwhere the crash happens). What do you cache? Is it local content, proxied content?"}, {"count": 5, "tags": [], "bug_id": 39643, "is_private": false, "text": "Created attachment 18338\nworker gdb thread trace\n\ntrace after rebuild", "id": 89428, "time": "2006-05-24T10:44:43Z", "creator": "croller@generali.fr", "creation_time": "2006-05-24T10:44:43Z", "attachment_id": 18338}, {"count": 6, "tags": [], "bug_id": 39643, "is_private": false, "text": "Created attachment 18339\nsite access.log\n\nApache starts with mem_cache enabled\n2 requests -> crash\nApache stops and starts with mem_cache disabled\n4 requests -> OK\nApache stops\n\nThe first 2 requests are not in the site access.log maybe due to buffering\nbefore Apache crashes...", "id": 89429, "time": "2006-05-24T10:51:50Z", "creator": "croller@generali.fr", "creation_time": "2006-05-24T10:51:50Z", "attachment_id": 18339}, {"count": 7, "tags": [], "bug_id": 39643, "is_private": false, "text": "Created attachment 18340\nsite rewrite.log", "id": 89430, "time": "2006-05-24T10:52:18Z", "creator": "croller@generali.fr", "creation_time": "2006-05-24T10:52:18Z", "attachment_id": 18340}, {"count": 8, "tags": [], "creator": "croller@generali.fr", "attachment_id": 18341, "text": "Created attachment 18341\nsite error.log", "id": 89431, "time": "2006-05-24T10:52:55Z", "bug_id": 39643, "creation_time": "2006-05-24T10:52:55Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 39643, "text": "Created attachment 18342\nerror.log", "id": 89432, "time": "2006-05-24T10:53:36Z", "creator": "croller@generali.fr", "creation_time": "2006-05-24T10:53:36Z", "is_private": false, "attachment_id": 18342}, {"count": 10, "attachment_id": null, "creator": "croller@generali.fr", "is_private": false, "id": 89433, "time": "2006-05-24T10:57:39Z", "bug_id": 39643, "creation_time": "2006-05-24T10:57:39Z", "tags": [], "text": "> What do you cache? Is it local content, proxied content?\nThe cache is for proxied content.\n\n"}, {"count": 11, "tags": [], "bug_id": 39643, "text": "Thanks for the update. It had been very helpful. The reason for the segfault is\na problem between mod_cache and mod_filter. I have to discuss the options for a\nfinal fix on the dev list. Meanwhile you could try the following workaround\npatch which should prevent the segfault. Effectively it disables mod_filter on\nreponses that get delivered from the cache. As I do not know your further\nconfiguration I do not know if this breaks other things on your site.:\n\n--- mod_filter.c        (Revision 406722)\n+++ mod_filter.c        (Arbeitskopie)\n@@ -355,6 +355,9 @@\n     harness_ctx *ctx = f->ctx;\n     ap_filter_rec_t *filter = f->frec;\n\n+    if (!ctx)\n+        return ap_pass_brigade(f->next, bb);\n+\n     if (f->r->status != 200) {\n         ap_remove_output_filter(f);\n         return ap_pass_brigade(f->next, bb);\n\n", "id": 89464, "time": "2006-05-25T05:30:42Z", "creator": "rpluem@apache.org", "creation_time": "2006-05-25T05:30:42Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 39643, "text": "Thanks to you for your reactivity !\n\nIt doesn't crash anymore, but I still have to test how mod_filter will react\nwith my deflate configuration (which might not be very \"clean\", but I don't find\nany \"state-of-the-art\" deflate configuration with inclusion and exclusion):\n\nFilterDeclare comp-resp\nFilterProvider comp-resp DEFLATE Request_URI\n/\\.?htm|\\.txt|\\.xml|\\.xsl|\\.dtd|\\.jsp|\\.jsv|\\.do|\\.asp|\\.srv/\nFilterProvider comp-resp DEFLATE Content-Type /^text.*/\nFilterProvider comp-resp INFLATE Content-Type /^text.css/\nFilterProvider comp-resp DEFLATE Content-Disposition !/^attachment.*/\nFilterProvider comp-resp INFLATE req=x-flash-version *\nFilterProtocol comp-resp change=yes\nFilterChain comp-resp\n", "id": 89571, "time": "2006-05-30T08:14:25Z", "creator": "croller@generali.fr", "creation_time": "2006-05-30T08:14:25Z", "is_private": false, "attachment_id": null}]