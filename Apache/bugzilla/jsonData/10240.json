[{"count": 0, "tags": [], "bug_id": 10240, "attachment_id": null, "text": "I have Apache 1.3.26 + mod_ssl setup as a reverse proxy using mod_rewrite +\nmod_proxy.\n\nRequests for partial content (with Range: header) to cached content are answered\nby mod_proxy with a 200 code with an empty content. It seems the problem comes\nfrom the If-Modified-Since header mod_proxy adds to the request sent to the\norigin server, the origin server answers with 304 and mod_proxy returns to the\nbrowser a 200 answer instead of a 206 with partial content or a 200 with full\ncontent (when Unless-Modified-Since was in the original request).\n\nDisabling the cache solves the problem but is bad for performance.\n\nTwo traces are included below, one with caching enabled, the other with caching\ndisabled.\n\nThe prefixes BP, PS, SP and PB mean\n\nBP  Browser to Proxy\nPS  Proxy to origin Server\nSP  origin Server to Proxy\nPB  Proxy to Browser\n\nTrace #1, caching enabled.\n\n---8<------8<------8<------8<------8<------8<------8<------8<---\n-BP\tGET /nsw-cgi/htdocs/10250784326661.pdf HTTP/1.1\nBP\tAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*\nBP\tAccept-Language: fr\nBP\tAccept-Encoding: gzip, deflate\nBP\tUser-Agent: Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)\nBP\tHost: www.domain.com\nBP\tConnection: Keep-Alive\n\nPS\tGET /nsw-cgi/htdocs/10250784326661.pdf HTTP/1.1\nPS\tHost: aaa.bbb.ccc.ddd:ppp\nPS\tAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*\nPS\tAccept-Encoding: gzip, deflate\nPS\tAccept-Language: fr\nPS\tUser-Agent: Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)\nPS\tX-Forwarded-For: www.xxx.yyy.zzz\nPS\tX-Forwarded-Host: www.domain.com\nPS\tX-Forwarded-Server: www.domain.com\nPS\tConnection: close\n\nSP\tHTTP/1.1 200 OK\nSP\tServer: Microsoft-IIS/4.0\nSP\tConnection: close\nSP\tDate: Wed, 26 Jun 2002 08:02:22 GMT\nSP\tContent-Type: application/pdf\nSP\tAccept-Ranges: bytes\nSP\tLast-Modified: Wed, 26 Jun 2002 08:02:17 GMT\nSP\tETag: \"dce33ecae71cc21:1e05\"\nSP\tContent-Length: 4009\n\nPB\tHTTP/1.1 200 OK\nPB\tDate: Wed, 26 Jun 2002 08:09:00 GMT\nPB\tServer: Microsoft-IIS/4.0\nPB\tContent-Type: application/pdf\nPB\tAccept-Ranges: bytes\nPB\tLast-Modified: Wed, 26 Jun 2002 08:02:17 GMT\nPB\tETag: \"dce33ecae71cc21:1e05\"\nPB\tContent-Length: 4009\nPB\tX-Cache: MISS from www.domain.com\nPB\tKeep-Alive: timeout=15, max=86\nPB\tConnection: Keep-Alive\n\nBP\tGET /nsw-cgi/htdocs/10250784326661.pdf HTTP/1.1\nBP\tAccept: */*\nBP\tRange: bytes=1126-\nBP\tUnless-Modified-Since: Wed, 26 Jun 2002 08:02:17 GMT\nBP\tIf-Range: \"dce33ecae71cc21:1e05\"\nBP\tUser-Agent: contype\nBP\tHost: www.domain.com\n\nPS\tGET /nsw-cgi/htdocs/10250784326661.pdf HTTP/1.1\nPS\tHost: aaa.bbb.ccc.ddd:ppp\nPS\tAccept: */*\nPS\tIf-Range: \"dce33ecae71cc21:1e05\"\nPS\tRange: bytes=1126-\nPS\tUnless-Modified-Since: Wed, 26 Jun 2002 08:02:17 GMT\nPS\tUser-Agent: contype\nPS\tIf-Modified-Since: Wed, 26 Jun 2002 08:02:17 GMT\nPS\tIf-None-Match: \"dce33ecae71cc21:1e05\"\nPS\tX-Forwarded-For: www.xxx.yyy.zzz\nPS\tX-Forwarded-Host: www.domain.com\nPS\tX-Forwarded-Server: www.domain.com\nPS\tConnection: close\n\nSP\tHTTP/1.1 304 Not Modified\nSP\tServer: Microsoft-IIS/4.0\nSP\tDate: Wed, 26 Jun 2002 08:02:22 GMT\nSP\tConnection: close\nSP\tETag: \"dce33ecae71cc21:1e05\"\nSP\tContent-Length: 0\n\nPB\tHTTP/1.1 200 OK\nPB\tDate: Wed, 26 Jun 2002 08:09:00 GMT\nPB\tServer: Microsoft-IIS/4.0\nPB\tContent-Type: application/pdf\nPB\tAccept-Ranges: bytes\nPB\tLast-Modified: Wed, 26 Jun 2002 08:02:17 GMT\nPB\tETag: \"dce33ecae71cc21:1e05\"\nPB\tContent-Length: 0\nPB\tX-Cache: HIT from www.domain.com (with revalidation)\n\nBP\tGET /nsw-cgi/htdocs/10250784326661.pdf HTTP/1.1\nBP\tAccept: */*\nBP\tAccept-Encoding: gzip, deflate\nBP\tUser-Agent: Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)\nBP\tHost: www.domain.com\nBP\tConnection: Keep-Alive\n\nPS\tGET /nsw-cgi/htdocs/10250784326661.pdf HTTP/1.1\nPS\tHost: aaa.bbb.ccc.ddd:ppp\nPS\tAccept: */*\nPS\tAccept-Encoding: gzip, deflate\nPS\tUser-Agent: Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)\nPS\tIf-Modified-Since: Wed, 26 Jun 2002 08:02:17 GMT\nPS\tIf-None-Match: \"dce33ecae71cc21:1e05\"\nPS\tX-Forwarded-For: www.xxx.yyy.zzz\nPS\tX-Forwarded-Host: www.domain.com\nPS\tX-Forwarded-Server: www.domain.com\nPS\tConnection: close\n\nSP\tHTTP/1.1 304 Not Modified\nSP\tServer: Microsoft-IIS/4.0\nSP\tDate: Wed, 26 Jun 2002 08:02:23 GMT\nSP\tConnection: close\nSP\tETag: \"dce33ecae71cc21:1e05\"\nSP\tContent-Length: 0\n\nPB\tHTTP/1.1 200 OK\nPB\tDate: Wed, 26 Jun 2002 08:09:00 GMT\nPB\tServer: Microsoft-IIS/4.0\nPB\tContent-Type: application/pdf\nPB\tAccept-Ranges: bytes\nPB\tLast-Modified: Wed, 26 Jun 2002 08:02:17 GMT\nPB\tETag: \"dce33ecae71cc21:1e05\"\nPB\tContent-Length: 0\nPB\tX-Cache: HIT from www.domain.com (with revalidation)\nPB\tKeep-Alive: timeout=15, max=81\nPB\tConnection: Keep-Alive\n---8<------8<------8<------8<------8<------8<------8<------8<---\n\ntrace #2, caching disabled for *.pdf (NoCache *.pdf)\n\n---8<------8<------8<------8<------8<------8<------8<------8<---\n-BP\tGET /nsw-cgi/htdocs/1025079013204.pdf HTTP/1.1\nBP\tAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*\nBP\tAccept-Language: fr\nBP\tAccept-Encoding: gzip, deflate\nBP\tUser-Agent: Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)\nBP\tHost: www.domain.com\nBP\tConnection: Keep-Alive\n\nPS\tGET /nsw-cgi/htdocs/1025079013204.pdf HTTP/1.1\nPS\tHost: aaa.bbb.ccc.ddd:ppp\nPS\tAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*\nPS\tAccept-Encoding: gzip, deflate\nPS\tAccept-Language: fr\nPS\tUser-Agent: Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)\nPS\tX-Forwarded-For: www.xxx.yyy.zzz\nPS\tX-Forwarded-Host: www.domain.com\nPS\tX-Forwarded-Server: www.domain.com\nPS\tConnection: close\n\nSP\tHTTP/1.1 200 OK\nSP\tServer: Microsoft-IIS/4.0\nSP\tConnection: close\nSP\tDate: Wed, 26 Jun 2002 08:11:01 GMT\nSP\tContent-Type: application/pdf\nSP\tAccept-Ranges: bytes\nSP\tLast-Modified: Wed, 26 Jun 2002 08:10:55 GMT\nSP\tETag: \"e4192fffe81cc21:1e05\"\nSP\tContent-Length: 4009\n\nPB\tHTTP/1.1 200 OK\nPB\tDate: Wed, 26 Jun 2002 08:17:38 GMT\nPB\tServer: Microsoft-IIS/4.0\nPB\tContent-Type: application/pdf\nPB\tAccept-Ranges: bytes\nPB\tLast-Modified: Wed, 26 Jun 2002 08:10:55 GMT\nPB\tETag: \"e4192fffe81cc21:1e05\"\nPB\tContent-Length: 4009\nPB\tX-Cache: MISS from www.domain.com\nPB\tKeep-Alive: timeout=15, max=75\nPB\tConnection: Keep-Alive\n\nBP\tGET /nsw-cgi/htdocs/1025079013204.pdf HTTP/1.1\nBP\tAccept: */*\nBP\tRange: bytes=1126-\nBP\tUnless-Modified-Since: Wed, 26 Jun 2002 08:10:55 GMT\nBP\tIf-Range: \"e4192fffe81cc21:1e05\"\nBP\tUser-Agent: contype\nBP\tHost: www.domain.com\n\nPS\tGET /nsw-cgi/htdocs/1025079013204.pdf HTTP/1.1\nPS\tHost: aaa.bbb.ccc.ddd:ppp\nPS\tAccept: */*\nPS\tIf-Range: \"e4192fffe81cc21:1e05\"\nPS\tRange: bytes=1126-\nPS\tUnless-Modified-Since: Wed, 26 Jun 2002 08:10:55 GMT\nPS\tUser-Agent: contype\nPS\tX-Forwarded-For: www.xxx.yyy.zzz\nPS\tX-Forwarded-Host: www.domain.com\nPS\tX-Forwarded-Server: www.domain.com\nPS\tConnection: close\n\nSP\tHTTP/1.1 206 Partial content\nSP\tServer: Microsoft-IIS/4.0\nSP\tConnection: close\nSP\tDate: Wed, 26 Jun 2002 08:11:01 GMT\nSP\tContent-Type: application/pdf\nSP\tETag: \"e4192fffe81cc21:1e05\"\nSP\tContent-Length: 2883\nSP\tContent-Range: bytes 1126-4008/4009\n\nPB\tHTTP/1.1 206 Partial content\nPB\tDate: Wed, 26 Jun 2002 08:17:38 GMT\nPB\tServer: Microsoft-IIS/4.0\nPB\tContent-Type: application/pdf\nPB\tETag: \"e4192fffe81cc21:1e05\"\nPB\tContent-Length: 2883\nPB\tContent-Range: bytes 1126-4008/4009\nPB\tX-Cache: MISS from www.domain.com\n\nBP\tGET /nsw-cgi/htdocs/1025079013204.pdf HTTP/1.1\nBP\tAccept: */*\nBP\tAccept-Encoding: gzip, deflate\nBP\tRange: bytes=1126-\nBP\tIf-Range: \"e4192fffe81cc21:1e05\"\nBP\tUser-Agent: Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)\nBP\tHost: www.domain.com\nBP\tConnection: Keep-Alive\n\nPS\tGET /nsw-cgi/htdocs/1025079013204.pdf HTTP/1.1\nPS\tHost: aaa.bbb.ccc.ddd:ppp\nPS\tAccept: */*\nPS\tAccept-Encoding: gzip, deflate\nPS\tIf-Range: \"e4192fffe81cc21:1e05\"\nPS\tRange: bytes=1126-\nPS\tUser-Agent: Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)\nPS\tX-Forwarded-For: www.xxx.yyy.zzz\nPS\tX-Forwarded-Host: www.domain.com\nPS\tX-Forwarded-Server: www.domain.com\nPS\tConnection: close\n\nSP\tHTTP/1.1 206 Partial content\nSP\tServer: Microsoft-IIS/4.0\nSP\tConnection: close\nSP\tDate: Wed, 26 Jun 2002 08:11:01 GMT\nSP\tContent-Type: application/pdf\nSP\tETag: \"e4192fffe81cc21:1e05\"\nSP\tContent-Length: 2883\nSP\tContent-Range: bytes 1126-4008/4009\n\nPB\tHTTP/1.1 206 Partial content\nPB\tDate: Wed, 26 Jun 2002 08:17:39 GMT\nPB\tServer: Microsoft-IIS/4.0\nPB\tContent-Type: application/pdf\nPB\tETag: \"e4192fffe81cc21:1e05\"\nPB\tContent-Length: 2883\nPB\tContent-Range: bytes 1126-4008/4009\nPB\tX-Cache: MISS from www.domain.com\nPB\tKeep-Alive: timeout=15, max=100\nPB\tConnection: Keep-Alive\n---8<------8<------8<------8<------8<------8<------8<------8<---", "id": 18599, "time": "2002-06-26T09:35:05Z", "creator": "Mathias.Herberts@iroise.net", "creation_time": "2002-06-26T09:35:05Z", "is_private": false}, {"count": 1, "tags": [], "creator": "mavricknz@yahoo.com", "text": "This was fixed for me by the patch in 10128. The content lenght was set to 0 \n(from 304) hence no content was read from the cached file. You should get back \na 200 OK response and full content with the patch.", "id": 20119, "time": "2002-07-24T09:30:23Z", "bug_id": 10240, "creation_time": "2002-07-24T09:30:23Z", "is_private": false, "attachment_id": null}]