[{"count": 0, "tags": [], "bug_id": 42530, "attachment_id": null, "text": "ManagerBase.backgroundProcess throws NullPointerException. \n\n  java.lang.NullPointerException\n      at org.apache.catalina.session.ManagerBase.processExpires\n(ManagerBase.java:682)\n      at org.apache.catalina.session.ManagerBase.backgroundProcess\n(ManagerBase.java:667)\n      at org.apache.catalina.core.ContainerBase.backgroundProcess\n(ContainerBase.java:1316)\n      at \norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChil\ndren(ContainerBase.java:1601)\n      at \norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChil\ndren(ContainerBase.java:1610)\n      at \norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChil\ndren(ContainerBase.java:1610)\n      at \norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run\n(ContainerBase.java:1590)\n      at java.lang.Thread.run(Thread.java:595)\n\nEnvironment:\n  Tomcat6.0.13\n  JDK1.5.11\nTestServlet\u0081F\n  protected void doGet(HttpServletRequest request,\n          HttpServletResponse response) throws ServletException, IOException {\n      HttpSession session = request.getSession();\n      session.invalidate();\n  }\nTest:\n  ab -c 3000 -n 300000 http://localhost:8080/contextName/TestServlet\n\n\nIt is as follows in org.apache.catalina.session.ManagerBase:(findSessions() \nthat is called by processExpires()).\n\n  public Session[] findSessions() {\n\n      Session results[] = null;\n      synchronized (sessions) {\n          results = new Session[sessions.size()];  ----- (A)\n          results = (Session[]) sessions.values().toArray(results); ----- (B)\n      }\n      return (results);\n\n  }\n\nIn Tomcat6, sessions of ManagerBase has been changed from HashMap to \nConcurrentHashMap.\nAt the same time, synchronized operations of sessions have been removed from \nthe  methods \nsuch as findSession(String is), add(Session session), and remove(Session \nsession).\n\nHowever, if the lock of sessions is not acquired by add(Session session) and \nremove(Session session), \nServlets can execute session.invalidate() between (A) and (B). (see above.)\n\nAs a result, NullpointerException is thrown by processing the 682 line of \nManagerBase.processExpires(). \n  if (!sessions[i].isValid()) {\n  \nI think add(Session session) and remove(Session session) should manipulate \nsessions in synchronized manner like Tomcat5.5.", "id": 103735, "time": "2007-05-27T21:26:55Z", "creator": "keiichi.fujino@gmail.com", "creation_time": "2007-05-27T21:26:55Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 42530, "attachment_id": null, "is_private": false, "id": 103742, "time": "2007-05-28T02:23:22Z", "creator": "remm@apache.org", "creation_time": "2007-05-28T02:23:22Z", "text": "(In reply to comment #0)\n> I think add(Session session) and remove(Session session) should manipulate \n> sessions in synchronized manner like Tomcat5.5.\n\nWe're not going to do that."}, {"count": 2, "tags": [], "bug_id": 42530, "attachment_id": null, "text": "(In reply to comment #1)\n> (In reply to comment #0)\n> > I think add(Session session) and remove(Session session) should manipulate \n> > sessions in synchronized manner like Tomcat5.5.\n> We're not going to do that.\n\nHow about the addition of the Null check to the 682 line of the \norg.apache.catalina.session.ManagerBase?\n\n  if (sessions[i] != null && !sessions[i].isValid()) {\n", "id": 103746, "time": "2007-05-28T05:42:45Z", "creator": "keiichi.fujino@gmail.com", "creation_time": "2007-05-28T05:42:45Z", "is_private": false}, {"count": 3, "tags": [], "creator": "keiichi.fujino@gmail.com", "text": "I confirmed this correction.\nhttp://svn.apache.org/viewvc?view=rev&revision=542185\nThanks. \n\nbut,this correction is only the following. \n\nhttp://svn.apache.org/viewvc/tomcat/trunk/java/org/apache/catalina/session/Mana\ngerBase.java?view=log\n(Is this for Tomcat6.1.x ?)\n\nPlease add a similar correction also to tc6.0.x. \n\nhttp://svn.apache.org/viewvc/tomcat/tc6.0.x/trunk/java/org/apache/catalina/sess\nion/ManagerBase.java?view=log\n\n", "id": 105692, "time": "2007-07-16T19:42:36Z", "bug_id": 42530, "creation_time": "2007-07-16T19:42:36Z", "is_private": false, "attachment_id": null}, {"count": 4, "text": "This has been ported to 6.0.x and is included in 6.0.18 onwards.", "creator": "markt@apache.org", "is_private": false, "id": 121310, "time": "2008-10-08T07:15:05Z", "bug_id": 42530, "creation_time": "2008-10-08T07:15:05Z", "tags": [], "attachment_id": null}]