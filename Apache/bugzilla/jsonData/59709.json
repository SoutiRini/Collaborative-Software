[{"count": 0, "tags": [], "bug_id": 59709, "text": "<If> is executed too early in the chain, so is little useful for reqenv variables since can't see them from other modules, f.e. from mod_geoip2 which sets them later. From other side, <SetEnvIfExpr> can see mod_geoip2 reqenv variables well.\n\nPlease move <If> processing further in the chain at least to the stage where <SetEnvIfExpr> is executed. Yes, I know workaround using <SetEnvIfExpr> and mod_rewrite, but it looks too ugly for complex cases.", "id": 191685, "time": "2016-06-15T15:19:17Z", "creator": "ache@vniz.net", "creation_time": "2016-06-15T15:19:17Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 59709, "text": "I don't think what you suggest is wise, as it would delay the correct per-directory configuration being available to anything enclosed in <If>.\n\nmod_geoip2 seems to run quite early when the config is server-wide, just like mod_setenvif. Have you tried mod_geoip2 w/o delaying the execution by putting it in per-directory config?", "id": 191686, "time": "2016-06-15T15:27:03Z", "creator": "covener@gmail.com", "creation_time": "2016-06-15T15:27:03Z", "is_private": false, "attachment_id": null}, {"count": 2, "attachment_id": null, "creator": "ache@vniz.net", "text": "(In reply to Eric Covener from comment #1)\n> I don't think what you suggest is wise, as it would delay the correct\n> per-directory configuration being available to anything enclosed in <If>.\n> \n> mod_geoip2 seems to run quite early when the config is server-wide, just\n> like mod_setenvif. Have you tried mod_geoip2 w/o delaying the execution by\n> putting it in per-directory config?\n\nI have many virtual hosts and many directories, so run mod_geoip2 server-wide once for all of them. I don't think that opening mod_geoip2 database in per-(many)directory scope each time will speed things up.", "id": 191687, "time": "2016-06-15T15:34:27Z", "bug_id": 59709, "creation_time": "2016-06-15T15:34:27Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 59709, "text": "(In reply to Andrey Chernov from comment #2)\n> (In reply to Eric Covener from comment #1)\n> > I don't think what you suggest is wise, as it would delay the correct\n> > per-directory configuration being available to anything enclosed in <If>.\n> > \n> > mod_geoip2 seems to run quite early when the config is server-wide, just\n> > like mod_setenvif. Have you tried mod_geoip2 w/o delaying the execution by\n> > putting it in per-directory config?\n> \n> I have many virtual hosts and many directories, so run mod_geoip2\n> server-wide once for all of them. I don't think that opening mod_geoip2\n> database in per-(many)directory scope each time will speed things up.\n\nI meant the opposite, but you already have the config that should set variables early.  It's surprising that the variables are not available if you use it in server scope already, but I didn't look at geoip2 in detail.", "id": 191689, "time": "2016-06-15T16:00:52Z", "creator": "covener@gmail.com", "creation_time": "2016-06-15T16:00:52Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 59709, "is_private": false, "text": "from geoip2:\n\n    /* we have two entry points, the header_parser hook, right before\n     * the authentication hook used for Dirctory specific enabled geoiplookups\n     * or right before directory rewrite rules.\n     */\n    ap_hook_header_parser(geoip_per_dir, NULL, aszSucc, APR_HOOK_FIRST);\n\n    /* and the servectly wide hook, after reading the request. Perfecly\n     * suitable to serve serverwide mod_rewrite actions\n     */\n    ap_hook_post_read_request(geoip_post_read_request, NULL, aszSucc,\n                              APR_HOOK_MIDDLE);\n\nap_if_walk() should be between these two.", "id": 191690, "time": "2016-06-15T16:05:31Z", "creator": "covener@gmail.com", "creation_time": "2016-06-15T16:05:31Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 59709, "text": "(In reply to Eric Covener from comment #4)\n> from geoip2:\n> \n>     /* we have two entry points, the header_parser hook, right before\n>      * the authentication hook used for Dirctory specific enabled\n> geoiplookups\n>      * or right before directory rewrite rules.\n>      */\n>     ap_hook_header_parser(geoip_per_dir, NULL, aszSucc, APR_HOOK_FIRST);\n> \n>     /* and the servectly wide hook, after reading the request. Perfecly\n>      * suitable to serve serverwide mod_rewrite actions\n>      */\n>     ap_hook_post_read_request(geoip_post_read_request, NULL, aszSucc,\n>                               APR_HOOK_MIDDLE);\n> \n> ap_if_walk() should be between these two.\n\nIn geoip_per_dir(), after not founding per-directory config, it exits from the hook:\n\ndcfg = ap_get_module_config(r->per_dir_config, &geoip_module);\nif (!dcfg) {\n        return DECLINED;\n}\n\nWhat wrong happens, in case you'll move ap_if_walk() down to APR_HOOK_MIDDLE?", "id": 191691, "time": "2016-06-15T16:22:07Z", "creator": "ache@vniz.net", "creation_time": "2016-06-15T16:22:07Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 59709, "text": "(In reply to Andrey Chernov from comment #5)\n> (In reply to Eric Covener from comment #4)\n> > from geoip2:\n> > \n> >     /* we have two entry points, the header_parser hook, right before\n> >      * the authentication hook used for Dirctory specific enabled\n> > geoiplookups\n> >      * or right before directory rewrite rules.\n> >      */\n> >     ap_hook_header_parser(geoip_per_dir, NULL, aszSucc, APR_HOOK_FIRST);\n> > \n> >     /* and the servectly wide hook, after reading the request. Perfecly\n> >      * suitable to serve serverwide mod_rewrite actions\n> >      */\n> >     ap_hook_post_read_request(geoip_post_read_request, NULL, aszSucc,\n> >                               APR_HOOK_MIDDLE);\n> > \n> > ap_if_walk() should be between these two.\n> \n> In geoip_per_dir(), after not founding per-directory config, it exits from\n> the hook:\n> \n> dcfg = ap_get_module_config(r->per_dir_config, &geoip_module);\n> if (!dcfg) {\n>         return DECLINED;\n> }\n> \n\nCan you elaborate on the relevance? It seems like this should no-op in your global/server config setup.\n\n> What wrong happens, in case you'll move ap_if_walk() down to APR_HOOK_MIDDLE?\n\nI don't understand the question -- ap_if_walk() is not run as part of any hook, it's run between hooks by the core of the server.  If it were delayed, modules that \"newly\" run before it wouldn't see their configuration enclosed in <if>.", "id": 191692, "time": "2016-06-15T16:26:18Z", "creator": "covener@gmail.com", "creation_time": "2016-06-15T16:26:18Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 59709, "text": "(In reply to Eric Covener from comment #6)\n> (In reply to Andrey Chernov from comment #5)\n> > (In reply to Eric Covener from comment #4)\n> > > from geoip2:\n> > > \n> > >     /* we have two entry points, the header_parser hook, right before\n> > >      * the authentication hook used for Dirctory specific enabled\n> > > geoiplookups\n> > >      * or right before directory rewrite rules.\n> > >      */\n> > >     ap_hook_header_parser(geoip_per_dir, NULL, aszSucc, APR_HOOK_FIRST);\n> > > \n> > >     /* and the servectly wide hook, after reading the request. Perfecly\n> > >      * suitable to serve serverwide mod_rewrite actions\n> > >      */\n> > >     ap_hook_post_read_request(geoip_post_read_request, NULL, aszSucc,\n> > >                               APR_HOOK_MIDDLE);\n> > > \n> > > ap_if_walk() should be between these two.\n> > \n> > In geoip_per_dir(), after not founding per-directory config, it exits from\n> > the hook:\n> > \n> > dcfg = ap_get_module_config(r->per_dir_config, &geoip_module);\n> > if (!dcfg) {\n> >         return DECLINED;\n> > }\n> > \n> \n> Can you elaborate on the relevance? It seems like this should no-op in your\n> global/server config setup.\n\nSorry, wrong code pasted from geoip_per_dir(), really I mean that one:\n\n geoip_server_config_rec *cfg =\n        ap_get_module_config(r->server->module_config, &geoip_module);\n if (cfg && cfg->GeoIPEnabled) {\n        return DECLINED;\n }\n\nI.e. if _server_ config exists and GeoIPEnabled (as in my case), geoip_per_dir() exits from the hook with nothing processed.\n\n> > What wrong happens, in case you'll move ap_if_walk() down to APR_HOOK_MIDDLE?\n> \n> I don't understand the question -- ap_if_walk() is not run as part of any\n> hook, it's run between hooks by the core of the server.  If it were delayed,\n> modules that \"newly\" run before it wouldn't see their configuration enclosed\n> in <if>.\n\nIt sound like who was first, chicken or egg:) Should modules affect <If> to allow their results processed by it, or should <If> affect modules to be configured per-directory? We lost something in any case. Just guessing, perhaps running ap_if_walk() twice, early and later can solve it.", "id": 191694, "time": "2016-06-15T16:52:21Z", "creator": "ache@vniz.net", "creation_time": "2016-06-15T16:52:21Z", "is_private": false, "attachment_id": null}]