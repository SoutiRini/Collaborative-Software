[{"count": 0, "tags": [], "creator": "ruben.degraaf@direct-energie.com", "attachment_id": 35028, "is_private": false, "id": 199023, "time": "2017-06-02T13:16:03Z", "bug_id": 61147, "creation_time": "2017-06-02T13:16:03Z", "text": "Created attachment 35028\nboth full and truncated response\n\nHello,\n\nI've struggled with this bug for some days now, so this is what I've discovered :\n\nThe bug is present in the following versions :\n\nApache/2.2.15 (compiled by redhat - the one for RHEL 6.9)\nApache/2.4.7 (compiled by redhat - the one for RHEL 7.3)\nApache/2.4.25 (compiled by IUS community = https://github.com/iuscommunity-pkg/httpd24u)\n\nSo what I'm doing is interrogating a webservice running on a wildfly 10.0 Final server and the reply I have when I directly interrogate the server is the attached file called full response.txt\n\nNow when I put a server running mod_proxy (any from the 3 versions above) in front of the server, the response I get is the attached file called truncated response.txt\n\nI do catch an error in the httpd logs and it's the following one :\n\n[proxy_http:error] [pid 15142] (70008)Partial results are valid but processing is incomplete: [client 192.168.123.4:37489] AH01110: error reading response\n\nJust for information, the response is a pdf file encapsulated in xml and WE DO HAVE THE ISSUE FOR SOME FILES ONLY, NOT ALL OF THEM. \n\n(Sorry for caps, but the text editing in this bug report tool is a bit basic)\n\nMy configuration of mod_proxy is pretty basic :\n\n<VirtualHost 192.168.171.202:80>\n\n        ProxyPass / http://s-docweb-qua-01:8080/\n        ProxyPassReverse / http://s-docweb-qua-01:8080/\n        ProxyPass /web-console !\n        ProxyPass /admin-console !\n        ProxyPass /jmx-console !\n        ProxyPass /jbossws !\n        ProxyPass /error/ !\n        ProxyPass /usage !\n        ProxyPass /mod_cluster_manager !\n\n        <Location />\n        Require all granted\n        </Location>\n\n        <Location /mod_cluster_manager>\n            SetHandler mod_cluster-manager\n            Require all granted\n        </Location>\n\n    CustomLog \"/var/log/httpd/docweb-vip-qua-01_request_log\" \"%t %h \\\"%r\\\" %b **%T/%D**\"\n    ErrorLog \"/var/log/httpd/docweb-vip-qua-01_error_log\"\n    TransferLog \"/var/log/httpd/docweb-vip-qua-01_access_log\"\n    LogLevel trace8\n\n</VirtualHost>\n\n\n\nThe file posted to get the response from the webservice is the following one :\n\n<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:sch=\"http://www.internalwebsite.com/de/docweb/envoiDocument/schemas\">\n   <soapenv:Header/>\n   <soapenv:Body>\n      <sch:GetDocumentByTraitementIdRequestElement>\n         <sch:traitementId>9905</sch:traitementId>\n      </sch:GetDocumentByTraitementIdRequestElement>\n   </soapenv:Body>\n</soapenv:Envelope>\n\n\nand I POST on the webservice using a simple wget :\n\nwget http://192.168.171.202/docweb/ws/EnvoiDocument --post-file /tmp/soap\n\nHere is the full trace8 log when interrogating the webservice :\n\n[Fri Jun 02 15:12:02.724302 2017] [http2:trace1] [pid 16175] h2_h2.c(591): [client 192.168.123.4:58944] h2_h2, process_conn\n[Fri Jun 02 15:12:02.724361 2017] [http2:trace1] [pid 16175] h2_h2.c(605): [client 192.168.123.4:58944] h2_h2, process_conn, new connection using protocol 'http/1.1', direct=0, tls acceptable=1\n[Fri Jun 02 15:12:02.724370 2017] [http2:trace1] [pid 16175] h2_h2.c(661): [client 192.168.123.4:58944] h2_h2, declined\n[Fri Jun 02 15:12:02.724498 2017] [core:trace5] [pid 16175] protocol.c(645): [client 192.168.123.4:58944] Request received from client: POST /docweb/ws/EnvoiDocument HTTP/1.0\n[Fri Jun 02 15:12:02.724600 2017] [http:trace4] [pid 16175] http_request.c(420): [client 192.168.123.4:58944] Headers received from client:\n[Fri Jun 02 15:12:02.724604 2017] [http:trace4] [pid 16175] http_request.c(424): [client 192.168.123.4:58944]   User-Agent: Wget/1.11.4 Red Hat modified\n[Fri Jun 02 15:12:02.724606 2017] [http:trace4] [pid 16175] http_request.c(424): [client 192.168.123.4:58944]   Accept: */*\n[Fri Jun 02 15:12:02.724608 2017] [http:trace4] [pid 16175] http_request.c(424): [client 192.168.123.4:58944]   Host: 192.168.171.202\n[Fri Jun 02 15:12:02.724610 2017] [http:trace4] [pid 16175] http_request.c(424): [client 192.168.123.4:58944]   Connection: Keep-Alive\n[Fri Jun 02 15:12:02.724612 2017] [http:trace4] [pid 16175] http_request.c(424): [client 192.168.123.4:58944]   Content-Type: application/x-www-form-urlencoded\n[Fri Jun 02 15:12:02.724614 2017] [http:trace4] [pid 16175] http_request.c(424): [client 192.168.123.4:58944]   Content-Length: 386\n[Fri Jun 02 15:12:02.724688 2017] [proxy:trace2] [pid 16175] mod_proxy.c(656): [client 192.168.123.4:58944] AH03461: attempting to match URI path '/docweb/ws/EnvoiDocument' against prefix '/' for proxying\n[Fri Jun 02 15:12:02.724696 2017] [proxy:trace1] [pid 16175] mod_proxy.c(741): [client 192.168.123.4:58944] AH03464: URI path '/docweb/ws/EnvoiDocument' matches proxy handler 'proxy:http://s-docweb-qua-01:8080/docweb/ws/EnvoiDocument'\n[Fri Jun 02 15:12:02.724723 2017] [authz_core:debug] [pid 16175] mod_authz_core.c(809): [client 192.168.123.4:58944] AH01626: authorization result of Require all granted: granted\n[Fri Jun 02 15:12:02.724727 2017] [authz_core:debug] [pid 16175] mod_authz_core.c(809): [client 192.168.123.4:58944] AH01626: authorization result of <RequireAny>: granted\n[Fri Jun 02 15:12:02.724730 2017] [core:trace3] [pid 16175] request.c(293): [client 192.168.123.4:58944] request authorized without authentication by access_checker_ex hook: /docweb/ws/EnvoiDocument\n[Fri Jun 02 15:12:02.724765 2017] [proxy_http:trace1] [pid 16175] mod_proxy_http.c(60): [client 192.168.123.4:58944] HTTP: canonicalising URL //s-docweb-qua-01:8080/docweb/ws/EnvoiDocument\n[Fri Jun 02 15:12:02.724813 2017] [proxy:trace2] [pid 16175] proxy_util.c(1962): [client 192.168.123.4:58944] http: found worker http://s-docweb-qua-01:8080/ for http://s-docweb-qua-01:8080/docweb/ws/EnvoiDocument\n[Fri Jun 02 15:12:02.724818 2017] [proxy:debug] [pid 16175] mod_proxy.c(1228): [client 192.168.123.4:58944] AH01143: Running scheme http handler (attempt 0)\n[Fri Jun 02 15:12:02.724821 2017] [proxy_ajp:debug] [pid 16175] mod_proxy_ajp.c(738): [client 192.168.123.4:58944] AH00894: declining URL http://s-docweb-qua-01:8080/docweb/ws/EnvoiDocument\n[Fri Jun 02 15:12:02.724825 2017] [proxy_fcgi:debug] [pid 16175] mod_proxy_fcgi.c(913): [client 192.168.123.4:58944] AH01076: url: http://s-docweb-qua-01:8080/docweb/ws/EnvoiDocument proxyname: (null) proxyport: 0\n[Fri Jun 02 15:12:02.724828 2017] [proxy_fcgi:debug] [pid 16175] mod_proxy_fcgi.c(916): [client 192.168.123.4:58944] AH01077: declining URL http://s-docweb-qua-01:8080/docweb/ws/EnvoiDocument\n[Fri Jun 02 15:12:02.724833 2017] [proxy_http:trace1] [pid 16175] mod_proxy_http.c(1904): [client 192.168.123.4:58944] HTTP: serving URL http://s-docweb-qua-01:8080/docweb/ws/EnvoiDocument\n[Fri Jun 02 15:12:02.724837 2017] [proxy:debug] [pid 16175] proxy_util.c(2156): AH00942: HTTP: has acquired connection for (s-docweb-qua-01)\n[Fri Jun 02 15:12:02.724841 2017] [proxy:debug] [pid 16175] proxy_util.c(2209): [client 192.168.123.4:58944] AH00944: connecting http://s-docweb-qua-01:8080/docweb/ws/EnvoiDocument to s-docweb-qua-01:8080\n[Fri Jun 02 15:12:02.727195 2017] [proxy:debug] [pid 16175] proxy_util.c(2418): [client 192.168.123.4:58944] AH00947: connected /docweb/ws/EnvoiDocument to s-docweb-qua-01:8080\n[Fri Jun 02 15:12:02.727213 2017] [proxy:trace2] [pid 16175] proxy_util.c(2850): HTTP: fam 2 socket created to connect to s-docweb-qua-01\n[Fri Jun 02 15:12:02.728830 2017] [proxy:debug] [pid 16175] proxy_util.c(2884): AH02824: HTTP: connection established with 192.168.172.21:8080 (s-docweb-qua-01)\n[Fri Jun 02 15:12:02.728847 2017] [proxy:debug] [pid 16175] proxy_util.c(3051): AH00962: HTTP: connection complete to 192.168.172.21:8080 (s-docweb-qua-01)\n[Fri Jun 02 15:12:02.728887 2017] [core:trace6] [pid 16175] core_filters.c(525): [remote 192.168.172.21:8080] core_output_filter: flushing because of FLUSH bucket\n[Fri Jun 02 15:12:02.731922 2017] [proxy:debug] [pid 16203] proxy_util.c(1779): AH00925: initializing worker http://s-docweb-qua-01:8080/ shared\n[Fri Jun 02 15:12:02.731929 2017] [proxy:debug] [pid 16203] proxy_util.c(1821): AH00927: initializing worker http://s-docweb-qua-01:8080/ local\n[Fri Jun 02 15:12:02.731949 2017] [proxy:debug] [pid 16203] proxy_util.c(1872): AH00931: initialized single connection worker in child 16203 for (s-docweb-qua-01)\n[Fri Jun 02 15:12:02.764298 2017] [proxy_http:trace3] [pid 16175] mod_proxy_http.c(1376): [client 192.168.123.4:58944] Status from backend: 200\n[Fri Jun 02 15:12:02.764380 2017] [proxy_http:trace4] [pid 16175] mod_proxy_http.c(1049): [client 192.168.123.4:58944] Headers received from backend:\n[Fri Jun 02 15:12:02.764393 2017] [proxy_http:trace4] [pid 16175] mod_proxy_http.c(1051): [client 192.168.123.4:58944] Connection: keep-alive\n[Fri Jun 02 15:12:02.764482 2017] [proxy_http:trace4] [pid 16175] mod_proxy_http.c(1051): [client 192.168.123.4:58944] X-Powered-By: xxx\n[Fri Jun 02 15:12:02.764495 2017] [proxy_http:trace4] [pid 16175] mod_proxy_http.c(1051): [client 192.168.123.4:58944] Server: yyy\n[Fri Jun 02 15:12:02.764501 2017] [proxy_http:trace4] [pid 16175] mod_proxy_http.c(1051): [client 192.168.123.4:58944] Transfer-Encoding: chunked\n[Fri Jun 02 15:12:02.764507 2017] [proxy_http:trace4] [pid 16175] mod_proxy_http.c(1051): [client 192.168.123.4:58944] Content-Type: text/xml;charset=UTF-8\n[Fri Jun 02 15:12:02.764512 2017] [proxy_http:trace4] [pid 16175] mod_proxy_http.c(1051): [client 192.168.123.4:58944] Date: Fri, 02 Jun 2017 13:12:02 GMT\n[Fri Jun 02 15:12:02.764539 2017] [proxy_http:trace3] [pid 16175] mod_proxy_http.c(1647): [client 192.168.123.4:58944] start body send\n[Fri Jun 02 15:12:02.764590 2017] [http:trace3] [pid 16175] http_filters.c(1089): [client 192.168.123.4:58944] Response sent with status 200, headers:\n[Fri Jun 02 15:12:02.764594 2017] [http:trace5] [pid 16175] http_filters.c(1096): [client 192.168.123.4:58944]   Date: Fri, 02 Jun 2017 13:12:02 GMT\n[Fri Jun 02 15:12:02.764595 2017] [http:trace5] [pid 16175] http_filters.c(1099): [client 192.168.123.4:58944]   Server: yyy\n[Fri Jun 02 15:12:02.764598 2017] [http:trace4] [pid 16175] http_filters.c(918): [client 192.168.123.4:58944]   X-Powered-By: xxx\n[Fri Jun 02 15:12:02.764601 2017] [http:trace4] [pid 16175] http_filters.c(918): [client 192.168.123.4:58944]   Content-Type: text/xml;charset=UTF-8\n[Fri Jun 02 15:12:02.764602 2017] [http:trace4] [pid 16175] http_filters.c(918): [client 192.168.123.4:58944]   Connection: close\n[Fri Jun 02 15:12:02.764643 2017] [core:trace6] [pid 16175] core_filters.c(525): [client 192.168.123.4:58944] core_output_filter: flushing because of FLUSH bucket\n[Fri Jun 02 15:12:02.765745 2017] [core:trace6] [pid 16175] core_filters.c(525): [client 192.168.123.4:58944] core_output_filter: flushing because of FLUSH bucket\n[Fri Jun 02 15:12:02.765863 2017] [core:trace6] [pid 16175] core_filters.c(525): [client 192.168.123.4:58944] core_output_filter: flushing because of FLUSH bucket\n[Fri Jun 02 15:12:02.767527 2017] [proxy_http:error] [pid 16175] (70008)Partial results are valid but processing is incomplete: [client 192.168.123.4:58944] AH01110: error reading response\n[Fri Jun 02 15:12:02.767557 2017] [proxy_http:trace2] [pid 16175] mod_proxy_http.c(1792): [client 192.168.123.4:58944] end body send\n[Fri Jun 02 15:12:02.767564 2017] [proxy:debug] [pid 16175] proxy_util.c(2171): AH00943: HTTP: has released connection for (s-docweb-qua-01)\n[Fri Jun 02 15:12:02.767698 2017] [core:trace6] [pid 16175] core_filters.c(525): [client 192.168.123.4:58944] core_output_filter: flushing because of FLUSH bucket\n[Fri Jun 02 15:12:02.767704 2017] [core:trace6] [pid 16175] core_filters.c(525): [client 192.168.123.4:58944] core_output_filter: flushing because of FLUSH bucket"}, {"count": 1, "tags": [], "text": "And here are the general server logs during the webservice interrogation (not very interesting I think) :\n\n[Fri Jun 02 15:12:01.739635 2017] [proxy_hcheck:trace2] [pid 16175] mod_proxy_hcheck.c(888): Run of _proxy_hcheck_ watchdog.\n[Fri Jun 02 15:12:02.730371 2017] [core:trace4] [pid 16171] mpm_common.c(533): mpm child 16203 (gen 0/slot 5) started\n[Fri Jun 02 15:12:02.731623 2017] [http2:trace3] [pid 16203] h2_conn.c(150): h2_workers: min=1 max=1, mthrpchild=1, tx_files=2\n[Fri Jun 02 15:12:02.731664 2017] [http2:trace3] [pid 16203] h2_workers.c(227): h2_workers: starting\n[Fri Jun 02 15:12:02.731698 2017] [http2:trace3] [pid 16203] h2_workers.c(216): h2_workers: adding worker(0)\n[Fri Jun 02 15:12:02.731817 2017] [watchdog:debug] [pid 16203] mod_watchdog.c(586): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Fri Jun 02 15:12:02.731872 2017] [proxy:debug] [pid 16203] proxy_util.c(1779): AH00925: initializing worker proxy:reverse shared\n[Fri Jun 02 15:12:02.731877 2017] [proxy:debug] [pid 16203] proxy_util.c(1821): AH00927: initializing worker proxy:reverse local\n[Fri Jun 02 15:12:02.731914 2017] [proxy:debug] [pid 16203] proxy_util.c(1872): AH00931: initialized single connection worker in child 16203 for (*)\n[Fri Jun 02 15:12:02.732019 2017] [http2:trace3] [pid 16203] h2_workers.c(119): h2_worker(0): looking for work\n[Fri Jun 02 15:12:02.732025 2017] [http2:trace3] [pid 16203] h2_workers.c(159): h2_worker(0): waiting signal (eternal), worker_count=1, idle=1\n[Fri Jun 02 15:12:03.742497 2017] [proxy_hcheck:trace2] [pid 16175] mod_proxy_hcheck.c(888): Run of _proxy_hcheck_ watchdog.\n[Fri Jun 02 15:12:05.745165 2017] [proxy_hcheck:trace2] [pid 16175] mod_proxy_hcheck.c(888): Run of _proxy_hcheck_ watchdog.", "is_private": false, "id": 199024, "creator": "ruben.degraaf@direct-energie.com", "time": "2017-06-02T13:20:31Z", "bug_id": 61147, "creation_time": "2017-06-02T13:20:31Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 61147, "attachment_id": null, "id": 199025, "time": "2017-06-02T13:24:22Z", "creator": "covener@gmail.com", "creation_time": "2017-06-02T13:24:22Z", "is_private": false, "text": "Do you have a binary packet capture between Apache and the backend?"}, {"count": 3, "tags": [], "bug_id": 61147, "attachment_id": 35029, "id": 199026, "time": "2017-06-02T13:47:26Z", "creator": "ruben.degraaf@direct-energie.com", "creation_time": "2017-06-02T13:47:26Z", "is_private": false, "text": "Created attachment 35029\ntcpdump for incomplete response"}, {"count": 4, "tags": [], "bug_id": 61147, "attachment_id": null, "id": 199027, "time": "2017-06-02T13:49:17Z", "creator": "ruben.degraaf@direct-energie.com", "creation_time": "2017-06-02T13:49:17Z", "is_private": false, "text": "Sure, i just added a tcpdump for the webservice interrogation (the one that fails).\n\n192.168.123.4 is the server who runs the wget / POST \n192.168.171.202 is the virtual host running mod_proxy\n192.168.172.21 is the server running the webservice"}, {"count": 5, "tags": [], "text": "Created attachment 35030\nbackend tcpdump\n\nAnd here is a tcpdump taken on the backend server, the one running the webservice.", "is_private": false, "id": 199029, "creator": "ruben.degraaf@direct-energie.com", "time": "2017-06-02T15:14:25Z", "bug_id": 61147, "creation_time": "2017-06-02T15:14:25Z", "attachment_id": 35030}, {"count": 6, "tags": [], "bug_id": 61147, "attachment_id": null, "id": 199030, "time": "2017-06-02T15:16:08Z", "creator": "ruben.degraaf@direct-energie.com", "creation_time": "2017-06-02T15:16:08Z", "is_private": false, "text": "By the Way, I zipped that last dump file because when I post it here in full (47 KB) my ip gets banned while uploading for some weird reason and I'm no longer allowed to see apache's bugzilla..."}, {"attachment_id": null, "tags": [], "creator": "rpluem@apache.org", "is_private": false, "count": 7, "id": 199031, "time": "2017-06-02T15:37:25Z", "bug_id": 61147, "creation_time": "2017-06-02T15:37:25Z", "text": "The backend sends an incomplete response. It misses the last zero size chunk. It even misses the LF after the last data chunk. Some something is wrong on your backend side."}, {"count": 8, "tags": [], "bug_id": 61147, "attachment_id": null, "id": 199032, "time": "2017-06-02T15:41:40Z", "creator": "ruben.degraaf@direct-energie.com", "creation_time": "2017-06-02T15:41:40Z", "is_private": false, "text": "Mmh maybe, but why am I able to get the whole response when I call the backend directly while bypassing the mod proxy server ?\n\nYou want me to tcpdump the backend response without mod_proxy ?"}, {"count": 9, "tags": [], "bug_id": 61147, "is_private": false, "text": "(In reply to Ruben de Graaf from comment #8)\n> Mmh maybe, but why am I able to get the whole response when I call the\n> backend directly while bypassing the mod proxy server ?\n> \n> You want me to tcpdump the backend response without mod_proxy ?\n\nPlease do. Maybe your browser does handle invalid chunking better.", "id": 199067, "time": "2017-06-06T06:37:17Z", "creator": "rpluem@apache.org", "creation_time": "2017-06-06T06:37:17Z", "attachment_id": null}, {"count": 10, "tags": [], "text": "Ok there is a bug in our Palo Alto firewall...\n\nWhen going from a vlan owned by the firewall to an other vlan owned by the Palo Alto firewall it goes fine (from any vlan to the backend, the packets are well forged and the response is complete).\n\nBut when going from an external vlan (owned by an other firewall) to a vlan owned by the Aplo Alto firewall for some reason the response is incomplete...\n\nThanks for pointing that out, I'll close the ticket now.", "is_private": false, "id": 199069, "creator": "ruben.degraaf@direct-energie.com", "time": "2017-06-06T08:35:21Z", "bug_id": 61147, "creation_time": "2017-06-06T08:35:21Z", "attachment_id": null}]