[{"count": 0, "tags": [], "creator": "marcus.kellermann@bentley.com", "attachment_id": null, "id": 23127, "time": "2002-09-19T22:51:50Z", "bug_id": 12837, "creation_time": "2002-09-19T22:51:50Z", "is_private": false, "text": "Possible Memory Leak in I_R2.dll\n\n\nWhile doing some testing I noticed that the ISAPI connector using I_R2.dll \nappears that it may have a memory leak in it.  \n\nTesting:\nAll test were done using the ab.exe testing program\nWindows 2000 Server Service pack 2\nPentium 4, 1.5Ghz\n512mb RAM\n\nNote: -c500 -n100000 sugested by Nacho\n\nTest1: ab -c500 -n100000 http://localhost/examples/jsp/index.html\n  - start with a reboot to insure memory was cleared\n  - Available memory at begining of test 364916K\n  - inetinfo.exe process started out at 10,416K  mem usage\n  - Tomcat java.exe process started out at 19,440K mem usage\n  - at 50,000 requests inetinfo was using 206,256K of memory \n    the java process was hovering around 18,240K\n    ab.exe its self was using 3,512K\n  \n  - at 70,000 requests  NOTICE that the VIRTUAL SIZE is HUGE.  The machine ran \nout of RAM\n    CWD:     C:\\WINNT\\system32\\\n    CmdLine: C:\\WINNT\\System32\\inetsrv\\inetinfo.exe\n    VirtualSize:   1137040 KB   PeakVirtualSize:   1141200 KB\n    WorkingSetSize: 14368 KB    PeakWorkingSetSize:373076 KB\n    NumberOfThreads: 91\n    \n    CWD:     D:\\Tomcat 4.1\\bin\\\n    CmdLine: \"d:\\j2sdk1.4.0.01\\bin\\java\"     -\nDjava.endorsed.dirs=\"..\\bin;..\\comm\n    on\\endorsed\" -classpath \"d:\\j2sdk1.4.0.01\n\\lib\\tools.jar;..\\bin\\bootstrap.jar\" -D\n    catalina.base=\"..\" -Dcatalina.home=\"..\" -Djava.io.tmpdir=\"..\\temp\" \norg.apache.ca\n    talina.startup.Bootstrap  start\n    VirtualSize:   217376 KB   PeakVirtualSize:   217376 KB\n    WorkingSetSize: 10232 KB   PeakWorkingSetSize: 23420 KB\n    NumberOfThreads: 90\n    ab.exe its self was using 3,512K\n\n  - At end of RUN\n    CWD:     C:\\WINNT\\system32\\\n    CmdLine: C:\\WINNT\\System32\\inetsrv\\inetinfo.exe\n    VirtualSize:   1125764 KB   PeakVirtualSize:   1141200 KB\n    WorkingSetSize: 15068 KB   PeakWorkingSetSize:373076 KB\n    NumberOfThreads: 91\n\n   \tCWD:     D:\\Tomcat 4.1\\bin\\\n   \tCmdLine: \"d:\\j2sdk1.4.0.01\\bin\\java\"     -\nDjava.endorsed.dirs=\"..\\bin;..\\comm\n\ton\\endorsed\" -classpath \"d:\\j2sdk1.4.0.01\n\\lib\\tools.jar;..\\bin\\bootstrap.jar\" -D\n\tcatalina.base=\"..\" -Dcatalina.home=\"..\" -Djava.io.tmpdir=\"..\\temp\" \norg.apache.ca\n\ttalina.startup.Bootstrap  start\n   \tVirtualSize:   217376 KB   PeakVirtualSize:   221536 KB\n   \tWorkingSetSize: 10576 KB   PeakWorkingSetSize: 23420 KB\n    \n  - overall system memory was at 3,896 free\n  - after aborting the test at 50K request, the system did not free any of the \nmemory from the \n    inetinfo.exe process\n  - tomcat was only using 10,416K during the same test\n  \n  - Right after starting the test the following error appeared in the TOMCAT \nconsole\n\t\tSep 19, 2002 6:12:45 PM org.apache.jk.server.JkCoyoteHandler \naction\n\t\tSEVERE: Error in action code\n\t\tjava.net.SocketException: Software caused connection abort: \nsocket write error\n\t\t        at java.net.SocketOutputStream.socketWrite0(Native \nMethod)\n\t\t        at java.net.SocketOutputStream.socketWrite\n(SocketOutputStream.java:92)\n\t\t        at java.net.SocketOutputStream.write\n(SocketOutputStream.java:126)\n\t\t        at org.apache.jk.common.ChannelSocket.send\n(ChannelSocket.java:380)\n\t\t        at org.apache.jk.common.ChannelSocket.invoke\n(ChannelSocket.java:558)\n\t\t        at org.apache.jk.server.JkCoyoteHandler.action\n(JkCoyoteHandler.java:354)\n\t\t\n\t\t        at org.apache.coyote.Response.action(Response.java:216)\n\t\t        at org.apache.coyote.Response.finish(Response.java:336)\n\t\t        at \norg.apache.coyote.tomcat4.CoyoteResponse.finishResponse(CoyoteRespons\n\t\te.java:503)\n\t\t        at org.apache.coyote.tomcat4.CoyoteAdapter.service\n(CoyoteAdapter.java:22\n\t\t4)\n\t\t        at org.apache.jk.server.JkCoyoteHandler.invoke\n(JkCoyoteHandler.java:256)\n\t\t\n\t\t        at org.apache.jk.common.HandlerRequest.invoke\n(HandlerRequest.java:355)\n\t\t        at org.apache.jk.common.ChannelSocket.invoke\n(ChannelSocket.java:563)\n\t\t        at org.apache.jk.common.ChannelSocket.processConnection\n(ChannelSocket.ja\n\t\tva:535)\n\t\t        at org.apache.jk.common.SocketConnection.runIt\n(ChannelSocket.java:638)\n\t\t        at \norg.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadP\n\t\tool.java:533)\n\t\t        at java.lang.Thread.run(Thread.java:536)\n\t\tSep 19, 2002 6:12:45 PM org.apache.jk.common.ChannelSocket \nprocessConnection\n\t\tSEVERE: Error, closing connection\n\t\tjava.net.SocketException: Software caused connection abort: \nJVM_recv in socket i\n\t\tnput stream read\n\t\t        at java.net.SocketInputStream.socketRead0(Native Method)\n\t\t        at java.net.SocketInputStream.read\n(SocketInputStream.java:116)\n\t\t        at java.io.BufferedInputStream.fill\n(BufferedInputStream.java:183)\n\t\t        at java.io.BufferedInputStream.read1\n(BufferedInputStream.java:222)\n\t\t        at java.io.BufferedInputStream.read\n(BufferedInputStream.java:277)\n\t\t        at org.apache.jk.common.ChannelSocket.read\n(ChannelSocket.java:471)\n\t\t        at org.apache.jk.common.ChannelSocket.receive\n(ChannelSocket.java:409)\n\t\t        at org.apache.jk.common.ChannelSocket.processConnection\n(ChannelSocket.ja\n\t\tva:524)\n\t\t        at org.apache.jk.common.SocketConnection.runIt\n(ChannelSocket.java:638)\n\t\t        at \norg.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadP\n\t\tool.java:533)\n\t\t        at java.lang.Thread.run(Thread.java:536)\n\t\tSep 19, 2002 6:12:46 PM org.apache.jk.common.ChannelSocket \nprocessConnection\n\t\tWARNING: server has closed the current connection (-1)\n\t\tSep 19, 2002 6:12:46 PM org.apache.jk.common.ChannelSocket \nprocessConnection\n\t\tWARNING: server has closed the current connection (-1)\n--------------------------------------------------------------------------------\n---------\nTest 1: RESULTS\n--------------------------------------------------------------------------------\n---------\n\tCopyright (c) 1996 Adam Twiss, Zeus Technology Ltd, \nhttp://www.zeustech.net/\n\tCopyright (c) 1998-2002 The Apache Software Foundation, \nhttp://www.apache.org/\n\t\n\tBenchmarking localhost (be patient)\n\tCompleted 10000 requests\n\tCompleted 20000 requests\n\tCompleted 30000 requests\n\tCompleted 40000 requests\n\tCompleted 50000 requests\n\tCompleted 60000 requests\n\tCompleted 70000 requests\n\tCompleted 80000 requests\n\tCompleted 90000 requests\n\tFinished 100000 requests\n\t\n\t\n\tServer Software:        Microsoft-IIS/5.0\n\tServer Hostname:        localhost\n\tServer Port:            80\n\t\n\tDocument Path:          /examples/jsp/index.html\n\tDocument Length:        0 bytes\n\t\n\tConcurrency Level:      500\n\tTime taken for tests:   1370.140165 seconds\n\tComplete requests:      100000\n\tFailed requests:        99918\n\t   (Connect: 0, Length: 99918, Exceptions: 0)\n\tWrite errors:           0\n\tNon-2xx responses:      1\n\tTotal transferred:      768468823 bytes\n\tHTML transferred:       748086066 bytes\n\tRequests per second:    72.99 [#/sec] (mean)\n\tTime per request:       6.851 [ms] (mean)\n\tTime per request:       0.014 [ms] (mean, across all concurrent \nrequests)\n\tTransfer rate:          547.72 [Kbytes/sec] received\n\t\n\tConnection Times (ms)\n\t            min  mean[+/-sd] median   max\n\tConnect:    0     0    3.2 0 500\n\tProcessing: 0  6838 90070.3 380 1368758\n\tWaiting:    -1032473565212 -51616909 7300544625.2 370 1368748\n\tTotal:      0  6839 90070.4 380 1368758\n\t\n\tPercentage of the requests served within a certain time (ms)\n\t  50%    380\n\t  66%    410\n\t  75%    640\n\t  80%   1532\n\t  90%   2493\n\t  95%   3334\n\t  98%   3715\n\t  99%   5878\n\t 100%  1368758 (longest request)\n\n\nTest2: ab -c500 -n100000 http://localhost:8080/examples/jsp/index.html\n--------------------------------------------------------------------------------\n---------\n  - start with a reboot to insure memory was cleared\n  - inetinfo.exe process is not running\n  - going straight to tomcat which is listening on port 8080\n  \n  - at 5000 Requests\n   \tCWD:     D:\\Tomcat 4.1\\bin\\\n   \tCmdLine: \"d:\\j2sdk1.4.0.01\\bin\\java\"     -\nDjava.endorsed.dirs=\"..\\bin;..\\comm\n\ton\\endorsed\" -classpath \"d:\\j2sdk1.4.0.01\n\\lib\\tools.jar;..\\bin\\bootstrap.jar\" -D\n\tcatalina.base=\"..\" -Dcatalina.home=\"..\" -Djava.io.tmpdir=\"..\\temp\" \norg.apache.ca\n\ttalina.startup.Bootstrap  start\n   \tVirtualSize:   204064 KB   PeakVirtualSize:   208224 KB\n   \tWorkingSetSize: 22760 KB   PeakWorkingSetSize: 23292 KB\n   \tNumberOfThreads: 38\n   \n\tTotal System Memory Free  398396K \n  \n  -\tAt end of Requests\n  \n   \tCWD:     D:\\Tomcat 4.1\\bin\\\n   \tCmdLine: \"d:\\j2sdk1.4.0.01\\bin\\java\"     -\nDjava.endorsed.dirs=\"..\\bin;..\\comm\n\ton\\endorsed\" -classpath \"d:\\j2sdk1.4.0.01\n\\lib\\tools.jar;..\\bin\\bootstrap.jar\" -D\n\tcatalina.base=\"..\" -Dcatalina.home=\"..\" -Djava.io.tmpdir=\"..\\temp\" \norg.apache.ca\n\ttalina.startup.Bootstrap  start\n   \tVirtualSize:   204064 KB   PeakVirtualSize:   208224 KB\n   \tWorkingSetSize: 22760 KB   PeakWorkingSetSize: 23292 KB\n   \tNumberOfThreads: 38\n  \n\n--------------------------------------------------------------------------------\n---------\nTest 1: RESULTS\n--------------------------------------------------------------------------------\n---------\nBenchmarking localhost (be patient)\nCompleted 10000 requests\nCompleted 20000 requests\nCompleted 30000 requests\nCompleted 40000 requests\nCompleted 50000 requests\nCompleted 60000 requests\nCompleted 70000 requests\nCompleted 80000 requests\nCompleted 90000 requests\nFinished 100000 requests\n\n\nServer Software:        Apache\nServer Hostname:        localhost\nServer Port:            8080\n\nDocument Path:          /examples/jsp/index.html\nDocument Length:        7487 bytes\n\nConcurrency Level:      500\nTime taken for tests:   246.424340 seconds\nComplete requests:      100000\nFailed requests:        0\nWrite errors:           0\nTotal transferred:      771200000 bytes\nHTML transferred:       748700000 bytes\nRequests per second:    405.80 [#/sec] (mean)\nTime per request:       1.232 [ms] (mean)\nTime per request:       0.002 [ms] (mean, across all concurrent requests)\nTransfer rate:          3056.21 [Kbytes/sec] received\n\nConnection Times (ms)\n            min  mean[+/-sd] median   max\nConnect:    0     0    3.0 0 30\nProcessing: 20  1226 16162.7 150 246093\nWaiting:    0  1148 16167.3 80 246083\nTotal:      20  1227 16162.7 150 246093\n\nPercentage of the requests served within a certain time (ms)\n  50%    150\n  66%    160\n  75%    160\n  80%    160\n  90%    170\n  95%    190\n  98%    210\n  99%    230\n 100%  246093 (longest request)"}, {"count": 1, "tags": [], "bug_id": 12837, "attachment_id": null, "text": "Fixed. Caused by the wrong memory pool allocation.\n", "id": 23182, "time": "2002-09-21T07:35:11Z", "creator": "mturk@apache.org", "creation_time": "2002-09-21T07:35:11Z", "is_private": false}]