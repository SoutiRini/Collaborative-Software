[{"count": 0, "attachment_id": 22000, "creator": "maxmeneault@free.fr", "is_private": false, "id": 116963, "time": "2008-05-26T02:48:00Z", "bug_id": 45076, "creation_time": "2008-05-26T02:48:00Z", "tags": [], "text": "Created attachment 22000\npre_config hooks patch for trunk\n\nApparently pre_config hooks are not ordered when ap_run_pre_config is called.\nI noticed and verified one issue and I noticed another one (syntactically only) while reading through the code.\n\nFirst issue (verified):\nWhile during the first configuration pass pre_config hooks seem to be ordered for prelinked modules during the second one hooks are not ordered (i.e. not in the order specified by APR_HOOK_FIRST...defines).\nFix:\napr_hook_sort_all is called too late during second and further configuration passes.\nIt needs to be called before ap_run_pre_config (l.734 of server/main.c).\n\nSecond issue (only noticed while reading the code):\npre_config hooks might not be ordered for dynamically loaded modules even during first configuration pass.\nFix:\napr_hook_sort_all needs to be called before ap_run_pre_config (l.656 of server/main.c)\n\nI was working on 2.2.3 which suffer from these issues. I checked 2.2.8 and trunk which still suffer these issues.\n\nPlease see attached a patch for trunk to fix these issues.\n\nI compiled the server and checked that my patch correct the first issue (I don't use dynamically loaded modules).\n\nMy patch shouldn't provoke any regression however I don't know why apr_hook_sort_all was called so late. Was there any reason for that?\n\nThe only assumption I make is that hooks have to be hooked during register hooks during module initialization or otherwise apr_hook_sort_all should be manually called after registering a hook (as mod_cgid does)."}, {"count": 1, "attachment_id": 22001, "creator": "maxmeneault@free.fr", "text": "Created attachment 22001\npre_config hooks patch for 2.2.8\n\nPatch for the 2.2.8 version (just in case)", "id": 116964, "time": "2008-05-26T03:23:00Z", "bug_id": 45076, "creation_time": "2008-05-26T03:23:00Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 45076, "is_private": false, "text": "Created attachment 22844\npre_config hooks patch for 2.2.10\n\nAdding patch for 2.2.10 as requested by Bruce Mills (Apache dev mailing list, thread: ap_run_pre_config issue).\nNote: I didn't test it but it should work as well as older patches.", "id": 122300, "time": "2008-11-08T12:47:08Z", "creator": "maxmeneault@free.fr", "creation_time": "2008-11-08T12:47:08Z", "attachment_id": 22844}, {"count": 3, "attachment_id": null, "creator": "sf@sfritsch.de", "text": "This is already fixed in trunk and has been proposed for 2.2.20", "id": 147169, "time": "2011-06-15T22:32:29Z", "bug_id": 45076, "creation_time": "2011-06-15T22:32:29Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "bug_id": 45076, "attachment_id": null, "text": "I checked trunk revision 1032002; the patch to server/main.c is the same as mine so it should effectively be fixed in trunk.\n\nThanks.", "id": 147183, "time": "2011-06-16T06:56:58Z", "creator": "maxmeneault@free.fr", "creation_time": "2011-06-16T06:56:58Z", "is_private": false}, {"count": 5, "attachment_id": null, "creator": "torsten.foertsch@gmx.net", "text": "Reopen the bug because the fix introduces a very similar bug.\n\nModperl allows to write modules in Perl. Those modules can also register \nhooks. The earliest point in time when that may happen is in \nap_process_config_tree() because there are config statements that \ninfluence certain parameters of the perl interpreter. So, we have to \nprocess those statements prior to starting the interpreter. But only the \nperl interpreter knows which modules to load. Those modules then can \ninstall hooks. But with revision 1162854 these hooks are called out of \norder.", "id": 150323, "time": "2011-10-07T18:01:29Z", "bug_id": 45076, "creation_time": "2011-10-07T18:01:29Z", "tags": [], "is_private": false}, {"count": 6, "tags": [], "bug_id": 45076, "is_private": false, "text": "Created attachment 27730\nfix order for pre_config hooks as well as hooks that are registered later\n\nThe patch is to be applied on top of revision 1162854 which has MENEAULT's patch applied. In addition to calling apr_hook_sort_all() at the new location it calls it again when ap_process_config_tree() is done.", "id": 150324, "time": "2011-10-07T18:07:58Z", "creator": "torsten.foertsch@gmx.net", "creation_time": "2011-10-07T18:07:58Z", "attachment_id": 27730}, {"count": 7, "attachment_id": null, "creator": "sf@sfritsch.de", "is_private": false, "id": 150345, "time": "2011-10-08T07:16:58Z", "bug_id": 45076, "creation_time": "2011-10-08T07:16:58Z", "tags": [], "text": "committed in trunk as r1180325"}, {"count": 8, "attachment_id": null, "creator": "sf@sfritsch.de", "is_private": false, "id": 153455, "time": "2012-02-04T20:55:27Z", "bug_id": 45076, "creation_time": "2012-02-04T20:55:27Z", "tags": [], "text": "fixed in 2.2.22"}]