[{"count": 0, "tags": [], "text": "Hi \n\nI'm using Tomcat 6.0.35 on RHEL 6.x and Windows 7.   I've stumbled upon a bug in org.apache.catalina.valves.RemoteIpValve.   \n\nThe issue is related to using commas in any regular expressions used with the \"internalProxies\" or \"trustedProxies\" attributes.  \n\n*** Steps to reproduce ***\n\nAdd the following XML to $CATALINA_HOME/conf/context.xml  under the Context element: \n\n    <Valve className=\"org.apache.catalina.valves.RemoteIpValve\"\n        internalProxies=\"10\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\"\n        protocolHeader=\"Example-Header\"\n        protocolHeaderHttpsValue=\"example-value\" />\n\nThe bug is triggered by the comma in {1,3}\n\nThe XML above is based on the regex given on the pages http://tomcat.apache.org/tomcat-6.0-doc/config/valve.html and http://tomcat.apache.org/tomcat-6.0-doc/api/org/apache/catalina/valves/RemoteIpValve.html: \n\n    10\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}, 192\\.168\\.\\d{1,3}\\.\\d{1,3}, 169\\.254\\.\\d{1,3}\\.\\d{1,3}, 127\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\n\n*** Symptoms of the bug ***\n\nRemoteIpValve incorrectly splits the =\"10\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\" string into the two regular expressions \"10\\.\\d{1\" and \"3}\\.\\d{1,3}\\.\\d{1,3}\" (RemoteIpValve.java line 396).  In then attempts to parse the first regular expression which throws a PatternSyntaxException (line 382).  The class catches this and throws a IllegalArgumentException (line 384).  \n\nBecause an exemption is thrown, the \"internalProxies\" will keep its default value (set on line 445) instead of being cleared.  This is confusing for someone trying to diagnose why the value they set \"internalProxies\" to is not working.  It would be better if the class cleared the value of \"internalProxies\" in this case.  \n\n*** Suggested fix ***\n\n1) Instead of throwing the IllegalArgumentException, the class could log a debug message against the class's logger with information on the string that could not be parse as a regular expression.  This would a) help people with identifying and diagnosing the issue and b) stop RemoteIpValve from falling back to its default list of \"internalProxies\".  \n\n2) When internalProxies is initialized (line 445), use commaDelimitedListToPatternArray to parse the default regular expressions from a single string instead of parsing the four regular expressions separately.  This change would instantly flag up any issues (e.g. a comma) in the default regular expressions.  \n\n3) An update to the RemoteIpValve documentation http://tomcat.apache.org/tomcat-6.0-doc/config/valve.html and http://tomcat.apache.org/tomcat-6.0-doc/api/org/apache/catalina/valves/RemoteIpValve.html to remove the commas from the documentation's example regular expressions.  For example, this regular expression \n\n    10\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}, 192\\.168\\.\\d{1,3}\\.\\d{1,3}, 169\\.254\\.\\d{1,3}\\.\\d{1,3}, 127\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\n\ncould be replaced with \n\n    10\\.\\d+\\.\\d+\\.\\d+, 192\\.168\\.\\d+\\.\\d+, 169\\.254\\.\\d+\\.\\d+, 127\\.\\d+\\.\\d+\\.\\d+\n\n4) An update to the class's documentation to make it clear that commas should not be used in the regular expressions, other than to separate multiple regular expressions.  \n\n*** Other things that might be affected by the same bug ***\n\nRemoteIpValue.java seems unchanged in Tomcat 6.0.36 so the bug should affect that version too.  \n\nLooking at RemoteIpValve and RemoteIpFilter in Tomcat 7, I can see that this bug has been avoided by treating \"internalProxies\" and \"trustedProxies\" as a single regular expressons instead of as comma separated lists of regular expressions.  That looks like an elgant solution.  \n\nKind regards\nSimon Dean", "is_private": false, "bug_id": 54080, "id": 163077, "time": "2012-10-31T10:30:22Z", "creator": "simon.dean@moneysupermarket.com", "creation_time": "2012-10-31T10:30:22Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 54080, "text": "Created attachment 29545\nDocumentation patch\n\nPatch which hopefully clarifies the dangers of using commas in regular expressions.", "id": 163148, "time": "2012-11-02T21:41:16Z", "creator": "chris@christopherschultz.net", "creation_time": "2012-11-02T21:41:16Z", "is_private": false, "attachment_id": 29545}, {"count": 2, "tags": [], "bug_id": 54080, "text": "It should be possible to write '\\d{1,3}' simply as '\\d\\d?\\d?'.", "id": 163242, "time": "2012-11-06T18:53:55Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2012-11-06T18:53:55Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "text": "Tomcat 6 documentation corrected by r1444396 , will be in 6.0.37.", "attachment_id": null, "id": 165144, "creation_time": "2013-02-09T17:16:16Z", "time": "2013-02-09T17:16:16Z", "creator": "knst.kolinko@gmail.com", "bug_id": 54080, "is_private": false}]