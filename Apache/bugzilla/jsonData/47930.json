[{"count": 0, "tags": [], "bug_id": 47930, "attachment_id": 24333, "text": "Created attachment 24333\nSample webapp and scripts to reproduce issue\n\nWhen using PersistentManager with a filestore backing, I've noticed that (near)\nsimultaneous requests with the same session ID, can cause PersistentManager to\nreturn two different session objects, shortly after restarting Tomcat.\n\nI have included a sample webapp, with a test script to create simultaneous HTTP\nrequests to a servlet, that reproduces this issue.\n\nGeneral steps to reproduce:\n\n0. Configure PersistentManager to use FileStore.\n\n        <Manager className=\"org.apache.catalina.session.PersistentManager\" >\n                <Store className=\"org.apache.catalina.session.FileStore\"\n                        directory=\"/tmp\" >\n                </Store>\n        </Manager>\n\n1. Make a HTTP request to a servlet, and establish a new session. Note the new\nsession ID created on the server.\n2. Restart Tomcat (cleanly shutdown and startup).\n3. Shortly after Tomcat starts and initialises, make near simultaneous HTTP\nrequests to a servlet using the previously established session cookie.\n4. Output the session IDs and session object hashcodes on the server side, that\nis associated with each request.\n5. Some of the reported session object hashcodes will be different (even though\ntheir session IDs are the same). Additionally the HttpSessionListener will\nreport that the additional sessions are created/destroyed.\n\nExpected results:\n\nSession object hashcodes should be the same for the requests (and have the same\nsession ID).\n\n\nNotes on the included attachment:\n\n- sessionTest.zip contains a sample webapp with two servlets. The LoginServlet\nestablishes a new session for a request. The TestServlet will use the session\ncookie attached to a request, and will retrieve the session object (printing\nits ID and hex-encoded object hashcode).\nSessionListener will log each time a session is created or destroyed.\n\n- The session_test.sh script will automatically start/shutdown Tomcat, and make\nHTTP requests using curl. You may have to change the location of TOMCAT_HOME,\nthe URL of the deployed webapp, and the COOKIE path.\n\n- Using the sample webapp and script will not always reproduce the issue. It\nmay take a few goes for it to reproduce it.\n\nExample output:\n\n[tomcat@localhost sessionTest]$ ./session_test.sh \nStarting Tomcat..\nLogging in to init new session.. \nNew sessiond ID: JSESSIONID=09DDD0198C190E3394C19808DD8E074A\nNew session obj hashcode: 3e5e9db7\n---\nShutting down Tomcat..\nStarting Tomcat..\nSession ID: JSESSIONID=09DDD0198C190E3394C19808DD8E074A\nSession obj hashcode: 46bb05de\n---\nSession ID: JSESSIONID=09DDD0198C190E3394C19808DD8E074A\nSession obj hashcode: 46bb05de\n---\nSession ID: JSESSIONID=09DDD0198C190E3394C19808DD8E074A\nSession obj hashcode: 68acbd3a\n---\nSession ID: JSESSIONID=09DDD0198C190E3394C19808DD8E074A\nSession obj hashcode: 46bb05de\n---\nSession ID: JSESSIONID=09DDD0198C190E3394C19808DD8E074A\nSession obj hashcode: 24bb6086\n---\nSession ID: JSESSIONID=09DDD0198C190E3394C19808DD8E074A\nSession obj hashcode: 24bb6086\n---\nRemoving cookie /tmp/foo.cookie\nShutting down Tomcat..\n\nNotice that we have three different session objects tied to the same session\nID, after the requests are made (with hashcodes: 46bb05de, 68acbd3a, 24bb6086).", "id": 130795, "time": "2009-10-01T22:42:57Z", "creator": "sean.soerjanto@smartsgroup.com", "creation_time": "2009-10-01T22:42:57Z", "is_private": false}, {"count": 1, "tags": [], "creator": "markt@apache.org", "text": "I have fixed this in trunk and proposed the patch for 6.0.x", "id": 132940, "attachment_id": null, "bug_id": 47930, "creation_time": "2009-12-18T10:44:06Z", "time": "2009-12-18T10:44:06Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 47930, "attachment_id": null, "id": 133037, "time": "2009-12-21T11:15:46Z", "creator": "markt@apache.org", "creation_time": "2009-12-21T11:15:46Z", "is_private": false, "text": "This has been fixed in 6.0.x and will be included in 6.0.21 onwards."}]