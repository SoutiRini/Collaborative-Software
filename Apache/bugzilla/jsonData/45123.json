[{"count": 0, "tags": [], "bug_id": 45123, "text": "Originally reported as a re-open of bug 42541.\n\nIf the example file (https://issues.apache.org/bugzilla/attachment.cgi?id=22062) is read and re-written by POI, the formulas in Sheet1!C6:C21 all display as '#VALUE!' in Excel.\n\nThe formulas contain tokens with operand class 'array'.  The code in SharedFormulaRecord.convertSharedFormulas() does not propagate the operand class correctly.", "id": 117304, "time": "2008-06-03T10:02:01Z", "creator": "josh@apache.org", "creation_time": "2008-06-03T10:02:01Z", "is_private": false, "attachment_id": null}, {"count": 1, "attachment_id": null, "creator": "josh@apache.org", "text": "The following patch fixes this bug:\nIndex: SharedFormulaRecord.java\n===================================================================\n--- SharedFormulaRecord.java    (revision 661934)\n+++ SharedFormulaRecord.java    (working copy)\n@@ -201,6 +201,10 @@\n         if (ptgs != null)\n           for (int k = 0; k < ptgs.size(); k++) {\n             Ptg ptg = (Ptg) ptgs.get(k);\n+            byte originalOperandClass = -1;\n+            if (!ptg.isBaseToken()) {\n+                originalOperandClass = ptg.getPtgClass();\n+            }\n             if (ptg instanceof RefNPtg) {\n               RefNPtg refNPtg = (RefNPtg)ptg;\n               ptg = new ReferencePtg(fixupRelativeRow(formulaRow,refNPtg.getRow(),refNPtg.isRowRelative()),\n@@ -249,7 +253,11 @@\n                                 areaNAPtg.isLastRowRelative(),\n                                 areaNAPtg.isFirstColRelative(),\n                                 areaNAPtg.isLastColRelative());\n-            }\n+            }\n+            if (!ptg.isBaseToken()) {\n+                ptg.setClass(originalOperandClass);\n+            }\n+\n             newPtgStack.add(ptg);\n         }\n         return newPtgStack;\n\n\nA junit also needs to be added.", "id": 117306, "time": "2008-06-03T10:06:48Z", "bug_id": 45123, "creation_time": "2008-06-03T10:06:48Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 45123, "text": "Josh,\n     Could you send me the revised SharedFormulaRecord.java file or give me the location to get that file. I want to test it out.\n\nThanks", "id": 117310, "time": "2008-06-03T11:48:05Z", "creator": "vkt3142@njit.edu", "creation_time": "2008-06-03T11:48:05Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "josh@apache.org", "text": "Created attachment 22065\nDraft of SharedFormulaRecord (.java and .class)\n\nbase version is r652934", "id": 117312, "time": "2008-06-03T12:54:27Z", "bug_id": 45123, "creation_time": "2008-06-03T12:54:27Z", "is_private": false, "attachment_id": 22065}, {"count": 4, "tags": [], "bug_id": 45123, "is_private": false, "id": 117314, "attachment_id": null, "creator": "josh@apache.org", "creation_time": "2008-06-03T13:00:10Z", "time": "2008-06-03T13:00:10Z", "text": "(In reply to comment #3)\n> Created an attachment (id=22065) [details]\n\nThis file can be patched into the svn trunk (I think it depends on bug 45060, which is very recent). \n\nYou can get the latest from subversion with the following command:\nsvn co https://svn.apache.org/repos/asf/poi/trunk\n\n\n"}, {"count": 5, "tags": [], "bug_id": 45123, "attachment_id": null, "text": "(In reply to comment #1)\n> The following patch fixes this bug ...\n\nApplied patch in svn r663436\n\njunit test added as well.\n", "id": 117352, "time": "2008-06-04T20:14:26Z", "creator": "josh@apache.org", "creation_time": "2008-06-04T20:14:26Z", "is_private": false}]