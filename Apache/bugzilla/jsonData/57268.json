[{"count": 0, "attachment_id": null, "bug_id": 57268, "is_private": false, "id": 179303, "time": "2014-11-26T14:46:53Z", "creator": "jaroslav@thinline.cz", "creation_time": "2014-11-26T14:46:53Z", "tags": [], "text": "When using event mpm, Apache processes randomly crash when serving request to download large file. It seems the crash occurs when file download takes long time (downloading 256MB file on 10Mbit line triggers the crash, but downloading the same file on gbit LAN works fine.) It also seems the crash only occurs when the server is busy serving other requests.\n\nThis is how I am able to reproduce the issue on my test server:\n\n- create small file in document root (index.html with content \"index\") and large file large.bin (dd if=/dev/zero of=large.bin bs=$((1024**2)) count=256)\n- run ab -q -n 2000000 -c 20 'http://[a:b:c:d::1]/index.html' on the server\n- run wget 'http://[a:b:c:d::1]/large.bin' on my workstation (~5 minutes long download)\n\nThe server transmits some data and then wget reports \"Connection closed at byte xxx. Retrying.\" The amount of transmitted data changes every try, sometimes the crash occurs after few seconds, sometimes it takes few minutes, in few cases the file downloaded without causing Apache to crash.\n\nWhen the server was idle - only wget running, no ab - server didn't crash in any of my tries.\n\nWhen the crash occurs, Apache logs this into error log:\n\n[Wed Nov 26 14:38:14.982708 2014] [core:notice] [pid 12215:tid 140446535845760] AH00052: child pid 16079 exit signal Segmentation fault (11).\n\nIn some cases kernel logs message like this one into dmesg (message from different server, therefore different pid):\n\n[1943221.021819] apache2[31073]: segfault at 7f3c380c52d8 ip 00007f3c59d66ab2 sp 00007f3c3afece30 error 4 in mod_mpm_event.so[7f3c59d60000+e000]\n\nWe are using Apache downloaded from Debian Jessie repository (apache2-bin), together with libapache2-mod-fcgid, php5-cgi, suexec (apache2-suexec-custom) and libapache2-mod-geoip. (PHP is not involved in processing any of the files mentioned above.) List of active modules follows (from server-info): core.c, event.c, http_core.c, mod_access_compat.c, mod_alias.c, mod_auth_basic.c, mod_authn_core.c, mod_authn_file.c, mod_authz_core.c, mod_authz_host.c, mod_authz_user.c, mod_autoindex.c, mod_deflate.c, mod_dir.c, mod_env.c, mod_fcgid.c, mod_filter.c, mod_geoip.c, mod_info.c, mod_log_config.c, mod_logio.c, mod_mime.c, mod_negotiation.c, mod_setenvif.c, mod_so.c, mod_status.c, mod_unique_id.c, mod_unixd.c, mod_version.c, mod_watchdog.c\n\nIf I recall correctly, testing server is running in default configuration from Debian package - let me know if you need some configuration details.\n\nAt the moment it seems switching to mpm_worker works around the problem."}, {"count": 1, "tags": [], "creator": "ylavic.dev@gmail.com", "text": "There are 2 pending patches about mpm_event possible crashes in trunk (follow up attachements).\nCan you apply those in your environment, and preferably test them separatly so that we can determine which one (if not both) should be backported?\n\nOtherwise, can you provide a backtrace of the crash using gdb and a core file (http://httpd.apache.org/dev/debugging.html may help).\n\nYou will probably need to add \"CoreDumpDirectory /tmp\" in httpd.conf, and start httpd with unlimited core files (ulimit -c unlimited).\n\nOnce you have got a core(.pid) file in /tmp :\n$ gdb /path/to/httpd -c /tmp/core.xxxx\n% gdb) thread apply all bt\n\nThen you could provide the output here.", "id": 179399, "time": "2014-12-01T11:38:16Z", "bug_id": 57268, "creation_time": "2014-12-01T11:38:16Z", "is_private": false, "attachment_id": null}, {"count": 2, "attachment_id": 32245, "creator": "ylavic.dev@gmail.com", "is_private": false, "id": 179400, "time": "2014-12-01T11:41:39Z", "bug_id": 57268, "creation_time": "2014-12-01T11:41:39Z", "tags": [], "text": "Created attachment 32245\nr1639614"}, {"count": 3, "attachment_id": 32246, "creator": "ylavic.dev@gmail.com", "is_private": false, "id": 179401, "time": "2014-12-01T11:42:41Z", "bug_id": 57268, "creation_time": "2014-12-01T11:42:41Z", "tags": [], "text": "Created attachment 32246\nr1638879 + r1640031"}, {"count": 4, "tags": [], "bug_id": 57268, "text": "Hello, thank you for the reply.\n\nApache 2.4.10 in Debian is already shipped with patches r1638879 + r1640031 applied, so these don't fix this crash.\n\nI applied the other one - r1639614 - on Debian source tree and so far it seems the issue is fixed with it. I am no longer able to reproduce the crash, even after multiple tries.\n\nIf you still need the backtrade or any other information, let me know...", "id": 179422, "time": "2014-12-01T22:41:43Z", "creator": "jaroslav@thinline.cz", "creation_time": "2014-12-01T22:41:43Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "text": "(In reply to jaroslav from comment #4)\n> Hello, thank you for the reply.\n> \n> Apache 2.4.10 in Debian is already shipped with patches r1638879 + r1640031\n> applied, so these don't fix this crash.\n> \n> I applied the other one - r1639614 - on Debian source tree and so far it\n> seems the issue is fixed with it. I am no longer able to reproduce the\n> crash, even after multiple tries.\n> \n> If you still need the backtrade or any other information, let me know...\n\nSorry to take you up on it, but it would be nice to see a backtrace w/o r1639614 just to confirm.  It is a bit odd that it helps for a crash mid-response.", "attachment_id": null, "id": 179423, "creation_time": "2014-12-01T23:02:11Z", "time": "2014-12-01T23:02:11Z", "creator": "covener@gmail.com", "bug_id": 57268, "is_private": false}, {"count": 6, "tags": [], "text": "Created attachment 32247\nbacktrace", "is_private": false, "bug_id": 57268, "id": 179424, "time": "2014-12-01T23:42:24Z", "creator": "jaroslav@thinline.cz", "creation_time": "2014-12-01T23:42:24Z", "attachment_id": 32247}, {"count": 7, "tags": [], "creator": "jaroslav@thinline.cz", "attachment_id": null, "text": "No problem, added it into attachements. The testing server has apache2-dbg package (debugging symbols) installed, hope it helps.", "id": 179425, "time": "2014-12-01T23:46:52Z", "bug_id": 57268, "creation_time": "2014-12-01T23:46:52Z", "is_private": false}, {"count": 8, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "text": "(In reply to jaroslav from comment #7)\n> No problem, added it into attachements. The testing server has apache2-dbg\n> package (debugging symbols) installed, hope it helps.\n\nthanks, does actually seem consistent at least on the surface.", "id": 179426, "time": "2014-12-02T00:26:44Z", "bug_id": 57268, "creation_time": "2014-12-02T00:26:44Z", "is_private": false}, {"count": 9, "tags": [], "creator": "ylavic.dev@gmail.com", "is_private": false, "text": "Both r1639614 and r1638879+r1640031 backported to upcoming 2.4.11.\nThanks Jaroslav for reporting and testing.", "id": 179443, "time": "2014-12-02T14:05:00Z", "bug_id": 57268, "creation_time": "2014-12-02T14:05:00Z", "attachment_id": null}, {"count": 10, "tags": [], "text": "Thank you for the help.", "attachment_id": null, "bug_id": 57268, "id": 179444, "time": "2014-12-02T14:07:07Z", "creator": "jaroslav@thinline.cz", "creation_time": "2014-12-02T14:07:07Z", "is_private": false}]