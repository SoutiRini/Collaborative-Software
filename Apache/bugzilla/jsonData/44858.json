[{"count": 0, "tags": [], "bug_id": 44858, "attachment_id": null, "id": 115799, "time": "2008-04-23T06:26:40Z", "creator": "sargastic@yahoo.fr", "creation_time": "2008-04-23T06:26:40Z", "is_private": false, "text": "Not quite sure if it's a bug or one hell of a feature :-)\n\nThere are two \"zones\" on our SSL-ized server :\n\nSSLPassPhraseDialog     builtin\nSSLSessionCache         \"shm:/apache/logs/ssl_scache(512000)\"\nSSLSessionCacheTimeout  300\nSSLMutex                \"file:/apache/logs/ssl_mutex\"\n\n<VirtualHost _default_:443>\n#\n# The regular, simple SSL server\n#\n\nDocumentRoot \"/apache/htdocs\"\nServerName some.thing.org:443\n\nSSLEngine on\nSSLCertificateFile    \"/apache/conf/ssl/server.crt\"\nSSLCertificateKeyFile \"/apache/conf/ssl/server.key\"\nSSLCACertificateFile  \"/apache/conf/ssl/ca.crt\"\n\nAlias /manual /apache/manual\n\n# And a sub-tree with Client Cert verification\n#\n<Directory \"/apache/manual\">\n    Options Indexes\n    AllowOverride None\n    Order allow,deny\n    Allow from all\n\n    SSLRequireSSL\n    SSLVerifyClient require\n    SSLVerifyDepth 1\n</Directory>\n</VirtualHost>\n\nSince Firefox 2.0.13, the default config of the browser regarding client certificates is \"Ask everytime\" (that's because of https://bugzilla.mozilla.org/show_bug.cgi?id=295922).\n\nAnd that's where we get badly hit. When requesting server:443/manual/something, we ALWAYS get an SSL renegociation :\n\n[info] Initial (No.1) HTTPS request received for child 2 (server some.thing.org:443)\n[debug] ssl_engine_kernel.c(426): Changed client verification (0 to 3) type will force renegotiation\n[info] Requesting connection re-negotiation\n\nThe \"(0 to 3)\" in the second message means \"verify_old is 0 (NONE), verify is 3 (PEER_STRICT)\", probably because when URL-parsing we went from / (no client cert verification) to /manual (SSLVerifyClient Require). That's just a guess.\n\nThe end result is that, for every request (except keepalive), the browser asks \"Which client certificate do you want to use ?\", making the user-experience quite hellish."}, {"count": 1, "tags": [], "bug_id": 44858, "attachment_id": null, "id": 115800, "time": "2008-04-23T06:41:07Z", "creator": "jorton@redhat.com", "creation_time": "2008-04-23T06:41:07Z", "is_private": false, "text": "Using \"SSLOptions +OptRenegotiate\" in the directory context should prevent that, have you tried it?"}, {"count": 2, "tags": [], "text": "I just tested it, and got exactly the same behavior :\n\n[debug] ssl_engine_kernel.c(426): Changed client verification (0 to 3) type will force renegotiation\n\n<Directory \"/apache/manual\">\n    Options Indexes\n    AllowOverride None\n    Order allow,deny\n    Allow from all\n\n    SSLRequireSSL\n    SSLVerifyClient require\n    SSLVerifyDepth  1\n    SSLOptions +OptRenegotiate\n</Directory>", "is_private": false, "id": 115815, "creator": "sargastic@yahoo.fr", "time": "2008-04-23T11:23:46Z", "bug_id": 44858, "creation_time": "2008-04-23T11:23:46Z", "attachment_id": null}, {"count": 3, "text": "Can you capture the complete logs for that?  The sequence should be:\n\n1. initial request to /manual\n     => client cert requested\n\n2. subsequent request to /blah\n     => no client cert requested\n\n3. second request to /manual\n     => client cert already presented\n\nIf request (3) has not re-used the SSL session from (1), then this is an expected failure.", "creator": "jorton@redhat.com", "attachment_id": null, "id": 115864, "time": "2008-04-25T03:04:26Z", "bug_id": 44858, "creation_time": "2008-04-25T03:04:26Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "bug_id": 44858, "attachment_id": null, "is_private": false, "id": 127547, "time": "2009-06-02T02:50:45Z", "creator": "juan-manuel.perez@tecsidel.es", "creation_time": "2009-06-02T02:50:45Z", "text": "We have exactly this problem. As I see this bug was frozen, we'll reopen it, providing some more information. I expect it is enough for you to check it.\nThe problem is not really severe if you use Firefox 2, because when the user is prompted for a certificate, it has the option to 'Remember this decision'. But with Firefox3 this option has been removed, and now users are prompted continuously for a certificate.\nWe have checked it with the latest available binary distribution (apache_2.2.8-win32-x86-openssl-0.9.8g.msi).\nWe provide the logs (with debug level on).\nWe also provide the used configuration files, a test page, and a certificate to reproduce the problem, and a document explaining the problem.\nWe have already tested other configurations, but they either don't work as expected, or are not valid for our requirements: we need some pages to require client certificate, and others not to. We are looking for a workaround, but the one we are thinking of is not very nice..."}, {"count": 5, "tags": [], "creator": "juan-manuel.perez@tecsidel.es", "attachment_id": 23741, "text": "Created attachment 23741\nHow to test the problem/bug", "id": 127548, "time": "2009-06-02T02:52:35Z", "bug_id": 44858, "creation_time": "2009-06-02T02:52:35Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 44858, "attachment_id": 23742, "id": 127549, "time": "2009-06-02T02:53:05Z", "creator": "juan-manuel.perez@tecsidel.es", "creation_time": "2009-06-02T02:53:05Z", "is_private": false, "text": "Created attachment 23742\nLogs"}, {"count": 7, "tags": [], "text": "I think this is the same problem as bug 47055, which has more analysis, so marking this as a dupe.\n\n*** This bug has been marked as a duplicate of bug 47055 ***", "is_private": false, "id": 127550, "creator": "jorton@redhat.com", "time": "2009-06-02T03:06:20Z", "bug_id": 44858, "creation_time": "2009-06-02T03:06:20Z", "attachment_id": null}, {"count": 8, "tags": [], "text": "Did you tried the patch from bug 47055?\nI can help.", "is_private": false, "id": 127555, "creator": "mike.pechkin@gmail.com", "time": "2009-06-02T06:31:00Z", "bug_id": 44858, "creation_time": "2009-06-02T06:31:00Z", "attachment_id": null}, {"count": 9, "tags": [], "text": "Thank you very much.\n\nThis patch solves, indeed, the problem we reported. We have only these comments:\n- It worked properly only after adding the +OptRenegotiate option. Thus, we\n  finally have this configuration (only relevant piece shown):\n        SSLVerifyClient none\n        <Location \"/test\">\n          SSLVerifyClient require\n          SSLVerifyDepth  10\n          SSLOptions +OptRenegotiate\n        </Location>\n- There is only a little 'misbehaviour' we have found. If, after starting apache, and firefox 3 (with clean cache), we first access 'https://localhost' (which doesn't require client cert), and then we access 'https://test/', we are prompted for the client certificate twice (this is the 'misbehaviour'). From then onwards, we are not prompted any more (perfect!) Also, if we first access 'https://test/', we are prompted only once (perfect!).\n\nI have only one more question. When is planned this patch to be included in an official Apache release?", "is_private": false, "id": 128132, "creator": "juan-manuel.perez@tecsidel.es", "time": "2009-06-22T01:24:13Z", "bug_id": 44858, "creation_time": "2009-06-22T01:24:13Z", "attachment_id": null}]