[{"count": 0, "tags": [], "creator": "danlee5002@gmail.com", "attachment_id": null, "id": 149236, "time": "2011-09-14T17:11:40Z", "bug_id": 51812, "creation_time": "2011-09-14T17:11:40Z", "is_private": false, "text": "I have created a web app (servlet application) that does asynchronous hits from the browser to periodically fetch some status information and update the page.  These asynchronous hits are directed to a dedicated servlet in the same webapp that takes great pains to never touch the session so that the session access time is not modified.  The idea is that these asynchronous hits don't count as real hits else the session would never idle time out.\n\nThis worked fine on Tomcat-6.0.14.  Upgrading to Tomcat-7.0.14 causes a problem in that these asynchronous hits are updating the session access time.\n\nI have traced the problem down to org.apache.catalina.valves.AccessLogValve.java.  When it is doing its logging, it is trying to fetch the \"principal\" object from the session and thus changing the session last access time.  This does not seem to be legitimate.\n\nHere is the relevant code:\n\n /**\n  * Enforce the security restrictions in the web application deployment\n  * descriptor of our associated Context.\n  *\n  * @param request Request to be processed\n  * @param response Response to be processed\n  *\n  * @exception IOException if an input/output error occurs\n  * @exception ServletException if thrown by a processing element\n  */\n @Override\n public void invoke(Request request, Response response)\n    throws IOException, ServletException {\n\n    if (log.isDebugEnabled())\n        log.debug(\"Security checking request \" +\n            request.getMethod() + \" \" + request.getRequestURI());\n    LoginConfig config = this.context.getLoginConfig();\n\n    // Have we got a cached authenticated Principal to record?\n    if (cache) {\n        Principal principal = request.getUserPrincipal();\n        if (principal == null) {\n            Session session = request.getSessionInternal(false);  <- Session Ticked Here\n            if (session != null) {\n                principal = session.getPrincipal();\n                if (principal != null) {\n                    if (log.isDebugEnabled())\n                        log.debug(\"We have cached auth type \" +\n                            session.getAuthType() +\n                            \" for principal \" +\n                            session.getPrincipal());\n                    request.setAuthType(session.getAuthType());\n                    request.setUserPrincipal(principal);\n                }\n            }\n        }\n\nChanging the source code so that cache=false, solves the problem and the session access time is not affected by these asynchronous hits.  I cannot find a way to set cache=false other than changing source.  Adding cache=\"false\" to the Valve tag in server.xml seems to have no effect.  \n\nIt would be nice if this parameter were controllable or if the code did not have this characteristic.  Logging should not effect the user's session."}, {"count": 1, "tags": [], "creator": "markt@apache.org", "text": "This report does not make any sense. The code quoted is from AuthenticatorBase which has nothing to do with the AccessLogValve.\n\nSecondly, I can't see any code path from the quoted code that would trigger an update to the sessions last accessed time. Neither can I see any such code in the AccessLogValve.\n\nFinally, session expiration is tested by the Servlet TCK which every release of Tomcat 7.0.x has passed.", "id": 149586, "attachment_id": null, "bug_id": 51812, "creation_time": "2011-09-21T12:32:58Z", "time": "2011-09-21T12:32:58Z", "is_private": false}, {"count": 2, "tags": [], "creator": "knst.kolinko@gmail.com", "text": "(In reply to comment #0)\n> I cannot find\n> a way to set cache=false other than changing source.  Adding cache=\"false\" to\n> the Valve tag in server.xml seems to have no effect.  \n\nAuthenticators can be configured with <Valve> tag, and \"cache\" is a valid and documented parameter there. E.g.,\n\nhttp://tomcat.apache.org/tomcat-7.0-doc/config/valve.html#Basic_Authenticator_Valve", "id": 149597, "attachment_id": null, "bug_id": 51812, "creation_time": "2011-09-21T18:13:02Z", "time": "2011-09-21T18:13:02Z", "is_private": false}]