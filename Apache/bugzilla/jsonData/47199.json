[{"attachment_id": null, "tags": [], "bug_id": 47199, "text": "Hi\nI am getting the following error when trying to run the following test case in TestExcelExtractor.java: \n\npublic void testImportMacroPSB() throws Exception {\n\t\tString filename = \"C:\\\\poi-src-3.5-beta5-20090512\\\\poi-3.5-beta5\\\\testOLD\\\\test.xls\";\n\t\tInputStream macro = new FileInputStream(filename);\n\t\tWorkbook oldWb = new HSSFWorkbook(macro);\n\t\tassertNotNull(oldWb);\n\t\t  FileOutputStream out = new FileOutputStream(\"c:/testPSB.xls\");\n\t\t  oldWb.write(out);\n\t        out.close();\n\t\t\t\n\t}\n\n\nException in thread \"main\" java.lang.RuntimeException: two Page Settings Blocks found in the same sheet\n\tat org.apache.poi.hssf.model.Sheet.<init>(Sheet.java:241)\n\tat org.apache.poi.hssf.model.Sheet.createSheet(Sheet.java:160)\n\tat org.apache.poi.hssf.usermodel.HSSFWorkbook.<init>(HSSFWorkbook.java:288)\n\tat org.apache.poi.hssf.usermodel.HSSFWorkbook.<init>(HSSFWorkbook.java:202)\n\tat org.apache.poi.hssf.usermodel.HSSFWorkbook.<init>(HSSFWorkbook.java:318)\n\tat org.apache.poi.hssf.usermodel.HSSFWorkbook.<init>(HSSFWorkbook.java:299)\n\tat org.apache.poi.ss.usermodel.WorkbookFactory.create(WorkbookFactory.java:60)\n\tat com.ericsson.ccrtool.excel.impl.write.ExcelSheetComparer.main(ExcelSheetComparer.java:29)\n\nThis is not similar to bug https://issues.apache.org/bugzilla/show_bug.cgi?id=46840. Here the exception is coming in line number 241 of Sheet.java\n\nThe test file I am using here is an old file (1 year old ), When I open the file and change some cell value then the test case is passed. But I dont want to open and save all the file each time when ever I am getting the above error. \n\n\nI have also run the the POI code BiffViewer.java for both the old file (Which is giving problem) and the new file (open the old file save the file make new file) and I found that there is difference in the TABID element of the output file. In the correct file the element_0 start with counter \"1\" which was \"O\" in the old file.\n\nold file(PSB problem file)\n\n[TABID]\n    .elements        = 17\n    .element_0 = 0\n    .element_1 = 1\n    .element_2 = 2\n    .element_3 = 3\n    .element_4 = 4\n    .element_5 = 5\n    .element_6 = 6\n    .element_7 = 7\n    .element_8 = 8\n    .element_9 = 9\n    .element_10 = 10\n    .element_11 = 11\n    .element_12 = 12\n    .element_13 = 13\n    .element_14 = 14\n    .element_15 = 15\n    .element_16 = 16\n[/TABID]\n\n\nNew file (open and save the old file)\n[TABID]\n    .elements        = 17\n    .element_0 = 1\n    .element_1 = 2\n    .element_2 = 3\n    .element_3 = 4\n    .element_4 = 5\n    .element_5 = 6\n    .element_6 = 7\n    .element_7 = 8\n    .element_8 = 9\n    .element_9 = 10\n    .element_10 = 11\n    .element_11 = 12\n    .element_12 = 13\n    .element_13 = 14\n    .element_14 = 15\n    .element_15 = 16\n    .element_16 = 17\n[/TABID]\n\nI am sorry to say that I cant share my test file as per company privacy rule. \n\nPlease let me know if you could help me on this issue. \n\nThis problem is coming with both Excel 2003 file and Excel 2007 file and I have taken the latest (14 May 2009) zip file from the POI 3.5 \n\nWaiting for your reply.. \n\nThanks and Regards \nNaveen Kumar", "count": 0, "id": 127037, "time": "2009-05-15T05:31:27Z", "creator": "kumar.naveen@in.ibm.com", "creation_time": "2009-05-15T05:31:27Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 47199, "is_private": false, "text": "Another bug besides bug 46840 was fixed recently: bug 46953.  That fix was made on May 11, and if you were running that code, it would be impossible to get that exception from line 241.  In the most recent version of Sheet.java (since May 11) this exception would have been thrown from line 236: \nhttp://svn.apache.org/viewvc/poi/trunk/src/java/org/apache/poi/hssf/model/Sheet.java?annotate=773438\n\nThe top pair of frames in your stacktrace is matched by revisions 757520 to 773411 (Mar 23 bug 46840 - May 11 bug 46953)\nI am closing this bug on the assumption that that you're running a slightly older version of POI than May 14.  If you experience a similar problem please re-open with the new details.\n\nNightly builds can be found here http://encore.torchbox.com/poi-svn-build/\nThe fix for bug 46953 found from this file: poi-source-3.5-beta6-20090511.zip onwards.\n\n\nThanks for doing the extra investigation using BiffViewer.  I am guessing that the changes Excel made to the TABIDs  is unrelated to your problem.\n\nHopefully you don't need to troubleshoot further, but if Excel 'fixed' the file for your problem, it's likely that it shuffled a few records around, and that information would be interesting.  If you pipe the BiffViewer output through \"grep Offset=0x\", that will extract only the record headers.  The resulting file will not have any proprietary data, but the ordering of biff records will be preserved and that would be enough to diagnose this bug.\n\n*** This bug has been marked as a duplicate of bug 46953 ***", "id": 127041, "time": "2009-05-15T11:11:48Z", "creator": "josh@apache.org", "creation_time": "2009-05-15T11:11:48Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "kumar.naveen@in.ibm.com", "text": "Hi, \n\nSorry, the error is coming in line number 236 now. I have taken the latest jar files: \npoi-contrib-3.5-beta6-20090518.jar\npoi-ooxml-3.5-beta6-20090518.jar\npoi-scratchpad-3.5-beta6-20090518.jar\npoi-3.5-beta6-20090518.jar\n\nFollowing exception is throwing in the console. \n \nException in thread \"main\" java.lang.RuntimeException: two Page Settings Blocks found in the same sheet\n\tat org.apache.poi.hssf.model.Sheet.<init>(Sheet.java:236)\n\tat org.apache.poi.hssf.model.Sheet.createSheet(Sheet.java:162)\n\tat org.apache.poi.hssf.usermodel.HSSFWorkbook.<init>(HSSFWorkbook.java:288)\n\tat org.apache.poi.hssf.usermodel.HSSFWorkbook.<init>(HSSFWorkbook.java:202)\n\tat org.apache.poi.hssf.usermodel.HSSFWorkbook.<init>(HSSFWorkbook.java:318)\n\tat org.apache.poi.hssf.usermodel.HSSFWorkbook.<init>(HSSFWorkbook.java:299)\n\tat org.apache.poi.ss.usermodel.WorkbookFactory.create(WorkbookFactory.java:60). \n\nThis is coming with my old file also. The step to recreate is same as above.", "count": 2, "id": 127099, "time": "2009-05-18T00:28:49Z", "bug_id": 47199, "creation_time": "2009-05-18T00:28:49Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 47199, "text": "Thanks for re-verifying the bug with the most recent POI build.\n\nIn general it is difficult to fix any problem without sample the code/data to reproduce it.  Can you please upload the BiffViewer summary as mentioned above (pipe the BiffViewer output through \"grep Offset=0x\").  It will help to have BIFF summaries for both files (the '1 year old' file and the one re-saved by Excel).", "count": 3, "id": 127121, "time": "2009-05-18T10:09:02Z", "creator": "josh@apache.org", "creation_time": "2009-05-18T10:09:02Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 47199, "attachment_id": 23687, "text": "Created attachment 23687\nutput file which is giving PSB problem", "id": 127151, "time": "2009-05-19T05:57:38Z", "creator": "kumar.naveen@in.ibm.com", "creation_time": "2009-05-19T05:57:38Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 47199, "is_private": false, "text": "Created attachment 23688\nnew output file without PSB problem", "id": 127154, "time": "2009-05-19T06:11:07Z", "creator": "kumar.naveen@in.ibm.com", "creation_time": "2009-05-19T06:11:07Z", "attachment_id": 23688}, {"count": 6, "tags": [], "creator": "kumar.naveen@in.ibm.com", "text": "PFA the information needed .", "id": 127155, "time": "2009-05-19T06:17:45Z", "bug_id": 47199, "creation_time": "2009-05-19T06:17:45Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 47199, "is_private": false, "text": "The files you uploaded are incomplete.  It appears that the output of BiffView has been truncated.  None of the sheet sub-streams are present, and even the workbook stream is incomplete.  I can see 49 BOUNDSHEET records which implies 49 sheet sub-streams are missing.\n\nI am pretty sure that BiffView will not silently quit in the middle of a file. So either it crashed and you didn't mention that, or you have deliberately truncated the output hoping that we only needed to consider the record order in the first 5% of the workbook.  Perhaps you are concerned that even these BIFF header summaries constitute information that you must keep private.  I can't convince you otherwise, but at least let us know that's what you are thinking.\n\n\nIf you are not able to upload a complete BIFF summary, you could try single stepping the code in a debugger:\n - First (since there are many sheets), find out which sheet the error occurs on.  When the bug occurs, take at \"this._sheets.size\" 2 stack frames up (HSSFWorkbook.java:288). \n - Next re-run your app and progress over all the previous sheets and stop at HSSFWorkbook.java:288 before reading the sheet with the problem.\n - Put a breakpoint on line Sheet.java:219, let the app execute to there.\n - Observe carefully how many and which records are read from the RecordStream in the PageSettingsBlock constructor.\n - Let the app run to the Sheet.java:219 breakpoint again.  Pay attention to which records (non-PSB) have been read from the RecordStream since creating the PageSettingsBlock, and the current record (which seems to belong to the PSB)\n - Make sure that execution _immediately_ proceeds to the exception at Sheet.java:236 (otherwise you haven't observed the exact conditions for the bug yet)\n\nWhen you find out specifically what POI is doing wrong (and what Excel is doing 'right'), please reply here so we can incorporate this knowledge back into POI.", "id": 127252, "time": "2009-05-21T12:51:13Z", "creator": "josh@apache.org", "creation_time": "2009-05-21T12:51:13Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 47199, "is_private": false, "text": "Hi, \n\nHow do I get the sheet name? I have searched in the code but not able to get the sheet.\n\nIn Sheet.java : \nI have tried to print the \"recSid\" the value is coming as 41 (Dec) and 0x0029 (hex).\n\nthe value for \" _psBlock != records.get(prevPsbIx) \" is coming as true in my case, Is it correct or we have to use equals method for comparing the objects.\nPlease advise.", "id": 127273, "time": "2009-05-22T03:41:06Z", "creator": "kumar.naveen@in.ibm.com", "creation_time": "2009-05-22T03:41:06Z", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 47199, "text": "It seems like you are going with the debugging approach.\n\n(In reply to comment #8)\n> How do I get the sheet name? I have searched in the code but not able to get\n> the sheet.\n\nAt stack frame (HSSFWorkbook.java:288), you can see the number of already loaded sheets with \"_sheets.size()\".  This also happens to be the index to the sheet currently being constructed, so that sheet name can be observed with:\nworkbook.getSheetName(_sheets.size());\n\n\n> In Sheet.java :\n> I have tried to print the \"recSid\" the value is coming as 41 (Dec) and 0x0029\n> (hex).\n\nThat sid corresponds to BottomMarginRecord.  We are going to need more information than this (see Comment 7).  Basically we need the list of records (found within RecordStream rs) starting from the records that the _psBlock has, all the way through to the current record (seems to be BottomMarginRecord) and a little further, just to make sure there are no more PSB records after that.  I guess that execution was at line 234 when you made this observation.  That's an important detail to clarify too.\n\n\n> the value for \" _psBlock != records.get(prevPsbIx) \" is coming as true in my\n> case, Is it correct or we have to use equals method for comparing the objects.\n\nDid you try out your suggestion \"!_psBlock.equals(records.get(prevPsbIx))\"?", "id": 127306, "time": "2009-05-22T11:07:16Z", "creator": "josh@apache.org", "creation_time": "2009-05-22T11:07:16Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 47199, "is_private": false, "text": "Created attachment 23710\nGiving PSB problem \n\n\nI have attached the file which is giving PSB problem. \n\nPlease use this file directly, if you open and change any of the value then this wont throw exception.\n\n\n\nTest Case :\n================\n\n\t\n\tpublic void testImportMacroPSB() throws Exception {\n\t\tString filename = \"C:\\\\poi-src-3.5-beta5-20090219\\\\poi-3.5-beta5\\\\testOLD\\\\excel.xls\";\n\t\tInputStream macro = new FileInputStream(filename);\n\t\tWorkbook oldWb = new HSSFWorkbook(macro);\n\t\tassertNotNull(oldWb);\n\t\t  FileOutputStream out = new FileOutputStream(\"c:/testPSB.xls\");\n\t\t  oldWb.write(out);\n\t        out.close();\n\t}\n\n\nPlease let me you if anything else is required. \n\nThanks \nNaveen Kumar", "id": 127360, "time": "2009-05-25T02:33:00Z", "creator": "kumar.naveen@in.ibm.com", "creation_time": "2009-05-25T02:33:00Z", "attachment_id": 23710}, {"attachment_id": null, "tags": [], "creator": "kumar.naveen@in.ibm.com", "text": "Hi\n\nPlease let  me know if any one is working on this.. \n\nWaiting for your reply . \n\nThanks \nNaveen", "count": 11, "id": 127464, "time": "2009-05-28T00:28:56Z", "bug_id": 47199, "creation_time": "2009-05-28T00:28:56Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 47199, "text": "I hit this problem today on a XLS (Excel 2003) file when reading it with HSSF from POI 3.5 beta 5 of Feb 19, 2009.  I too am working with proprietary data that I cannot upload, and I bet that any modification will cause the problem to vanish.  The one bright spot: I tried reading the file with the streaming HSSF approach (i.e., eventusermodel, HSSFListener, and friends), and that worked very well.", "id": 127483, "time": "2009-05-28T11:48:57Z", "creator": "apache7@chris-lott.org", "creation_time": "2009-05-28T11:48:57Z", "is_private": false, "attachment_id": null}, {"count": 13, "tags": [], "bug_id": 47199, "is_private": false, "text": "Hi Chris,\n\nThanks for your repley . \n\nI dont know how to use the event model and all. \n\nPlease suggest me how to resolve the error, as my release is pending due to this error. \n\nThanks\nNaveen", "id": 127530, "time": "2009-05-31T22:15:44Z", "creator": "kumar.naveen@in.ibm.com", "creation_time": "2009-05-31T22:15:44Z", "attachment_id": null}, {"count": 14, "tags": [], "bug_id": 47199, "is_private": false, "text": "Fixed in svn r780774\n\njunits added\n\nThanks for taking the time to upload something that would reproduce the error.  The problem in the sample file (attachment id=23710) was that the margin records are not found with the rest of the PageSettingsBlock.  If Excel re-saves the file, it corrects that problem.  POI now does the same.\n\nI'm not sure if if is of concern to you, but my Excel (2007) reports the data loss in the sample file (\"Shared workbook revisions and custom workbook views may have been lost\"). Same warning message from Excel after re-writing with POI.", "id": 127538, "time": "2009-06-01T11:53:53Z", "creator": "josh@apache.org", "creation_time": "2009-06-01T11:53:53Z", "attachment_id": null}, {"count": 15, "tags": [], "bug_id": 47199, "is_private": false, "text": "Thanks a lot for the solution. \n\nCheers!!!\nNaveen", "id": 127552, "time": "2009-06-02T04:39:21Z", "creator": "kumar.naveen@in.ibm.com", "creation_time": "2009-06-02T04:39:21Z", "attachment_id": null}]