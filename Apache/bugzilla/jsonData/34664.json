[{"count": 0, "attachment_id": null, "bug_id": 34664, "is_private": false, "id": 74213, "time": "2005-04-28T11:12:24Z", "creator": "pash_ka@fonbet.info", "creation_time": "2005-04-28T11:12:24Z", "tags": [], "text": "Platform: ASUS AP1600R (2 Xeon 2.4Ghz, 2Gb RAM)\nSoftware: Win2000, Apache 2.0.54, PHP 5.0.4, MySQL 4.1.10a, no \nfirevals/antivirus\nAverage server load: 5-10 requests/sec\n\nFirst, I've noticed \n---\n[warn] (OS 64)The specified network name is no longer available.  : \nwinnt_accept: Asynchronous AcceptEx failed\n---\nwarnings and very unstable behaviour of Apache: sometimes request had been \nprocessed in 20 ms and oter times - more than 3000 ms (since i was running \ntests on local mashine network perfomance was not an option, and this strange \nrandom responce times was tested on plain html-page with no scripting).\n\nThe solution I've found in bug 21425:\n---\nWin32DisableAcceptEx\nEnableMMAP Off\nEnableSendfile Off \n---\nsolved both of tis problems but inroduced another one: \n---\nFATAL:  erealloc():  Unable to allocate 98304 bytes\n---\nErrors like this one occured every 5-10 minutes and caused server restart.\nThe only solution I've found is decreasing ThreadsPerChild setting from 350 to \n170. Since doing this I have not seen this error.\n\nI've also noticed another problem: restarting server with \"apache -k restart\" \ncommand and even stoping it with \"net stop apache2\" failed to close child \nprocess. And sometimes lines like\n---\n[crit] [Thu Apr 28 10:54:23 2005] file .\\\\server\\\\mpm\\\\winnt\\\\child.c, line \n1078, assertion \"(rv >= 0) && (rv < threads_created)\" failed\n---\n(bug 11997) ocured in error log.\n\nI've commented out \"EnableMMAP Off\" and now everything works fine. Or I just \nhadn't seen the problem yet. :)"}, {"count": 1, "tags": [], "bug_id": 34664, "attachment_id": null, "text": "I'm sorry but the problem described in bug 11997 is still here...\nAnd child process fails to exit and stays in memory.", "id": 74344, "time": "2005-05-03T09:42:25Z", "creator": "pash_ka@fonbet.info", "creation_time": "2005-05-03T09:42:25Z", "is_private": false}, {"count": 2, "attachment_id": null, "bug_id": 34664, "is_private": false, "id": 86127, "time": "2006-02-23T10:52:10Z", "creator": "levi_tedder@hotmail.com", "creation_time": "2006-02-23T10:52:10Z", "tags": [], "text": "I'm having the same problem on my Win2k server (fully patched/updated) - 2x\nIntel Xeon. I have Apache 2.0.55 (with openSSL 0.9.8a), PHP 5.1.2. \n\nThe log entry:\n[Thu Feb 23 09:28:12 2006] [warn] (OS 64)The specified network name is no longer\navailable.  : winnt_accept: Asynchronous AcceptEx failed.\n\nwas not present while we were using a Symantec Enterprise Firewall, but were\nintroduced when we switched to Cisco Pix 515e Firewall (appliance). I got rid of\nsuch log entries with Win32DisableAcceptEx in the httpd.conf, but this caused\nthe following errors about every 10-20 minutes:\n\nFATAL:  erealloc():  Unable to allocate 393216 bytes\n[Thu Feb 23 10:15:58 2006] [notice] Parent: child process exited with status 1\n-- Restarting.\n\nI see that memory consumption by apache is increasing, and number of threads\ntoo, until it restarts itself.\n\nIf I remove the Win32DisableAcceptEx, the server is \"very\" slow in handling\nrequests and of course the error.log is getting all those entries I quoted first.\nBut as I said, this started after we installed the Cisco FW, and we have placed\na bug-thing with Cisco as well.\n"}, {"count": 3, "tags": [], "bug_id": 34664, "attachment_id": null, "is_private": false, "id": 90862, "time": "2006-07-04T14:10:17Z", "creator": "vincent.lepot@smile.fr", "creation_time": "2006-07-04T14:10:17Z", "text": "I have the same problem on Win2K servers, PHP 4.3.11.\n\nThe erealloc/emalloc fatals occurs when I put Win32DisableAcceptEx config\ndirective in httpd.conf. When I comment it, no more erealloc/emalloc occurs in\nthe logs, but the warnings described above.\n\nSo it seems to be a memory leak when using the old Accept primitive or something..."}, {"count": 4, "tags": [], "creator": "levi_tedder@hotmail.com", "text": "(In reply to comment #2)\n\nThis problem is \"increasing\", meaning it cause a big problem. The line:\n\nFATAL:  erealloc():  Unable to allocate 1572864 bytes\n\nwith the exact same number of bytes each time, is appearing every 10-15 minutes\nnow, and after a day or two apache stops responding (web pages will not load). A\nrestart of the service will not fix it, I need to restart the entire server.\n\nI have the following now:\n\n(win2k server still (2 cpu))\n\nApache 2.0.59\nOpenSSL 0.9.8c\nPHP 5.1.6", "id": 94612, "time": "2006-10-07T03:10:41Z", "bug_id": 34664, "creation_time": "2006-10-07T03:10:41Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 34664, "attachment_id": null, "is_private": false, "id": 95914, "time": "2006-11-16T13:53:08Z", "creator": "filip.tc@gmail.com", "creation_time": "2006-11-16T13:53:08Z", "text": "Exact same issue here. Apache restarts (stopping all transfers & active\nconnections) after consuming a lot of RAM memory (up to peaks of 100-200MB).\n\nApache 2.2.3\nWinXP 1GBRAM Pentium M 1,4GHz\nHappens when Firewall disabled.\n\nHope to see a bugfix soon.\nPhil"}, {"count": 6, "tags": [], "bug_id": 34664, "attachment_id": null, "text": "FYI this is known-of on 2.0.59 as well, and in the process of researching.\n\nCan you reporters confirm if you are or are not proxying traffic, and if\nthat's using ssl from the client and/or ssl to the backend?\n\nOr if you are simply using ssl or not for client (non-proxy) traffic?", "id": 95915, "time": "2006-11-16T14:54:36Z", "creator": "wrowe@apache.org", "creation_time": "2006-11-16T14:54:36Z", "is_private": false}, {"count": 7, "attachment_id": null, "bug_id": 34664, "text": "(In reply to comment #6)\n> FYI this is known-of on 2.0.59 as well, and in the process of researching.\n> Can you reporters confirm if you are or are not proxying traffic, and if\n> that's using ssl from the client and/or ssl to the backend?\n> Or if you are simply using ssl or not for client (non-proxy) traffic?\n\nWe are not proxying traffic, and are simply using ssl for client traffic. Note \nthat this issue is only valid when Win32DisableAcceptEx is enabled \n(uncommented) in the conf. I have not tried this with PHP 5.2 which has been \nreleased, to see if that has something to do with it\n", "id": 95917, "time": "2006-11-16T23:04:46Z", "creator": "levi_tedder@hotmail.com", "creation_time": "2006-11-16T23:04:46Z", "tags": [], "is_private": false}, {"count": 8, "tags": [], "bug_id": 34664, "text": "One more note - we -don't- call erealloc from apr 0.9 or httpd 2.0.\n\nSo something else is going on here, either in PHP or in the msvcrt, or perhaps\nbecause of crossed up msvc versions.", "id": 95919, "time": "2006-11-17T01:27:14Z", "creator": "wrowe@apache.org", "creation_time": "2006-11-17T01:27:14Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "creator": "levi_tedder@hotmail.com", "attachment_id": null, "id": 95920, "time": "2006-11-17T01:32:26Z", "bug_id": 34664, "creation_time": "2006-11-17T01:32:26Z", "is_private": false, "text": "FYI there's a bugreport at php.net regarding this, although I don't think it's \nanything new there: http://bugs.php.net/bug.php?id=32002\n\nI will try to install PHP 5.2 after the weekend and will let you know if it \nhelps in any way. I understand that there's some changes to memoryhandling or \nsomething there...."}, {"count": 10, "tags": [], "creator": "wrowe@apache.org", "text": "Well if you can determine that this happens with PHP compiled with Visual C 6.0,\nlinked using /MD (multithread dll c runtime) or only Visual C > 6.0, we might be\non to something.\n\nIt's a question of if this is a PHP bug, or a memory management flaw resulting\nfrom the c runtimes in use.", "id": 95921, "time": "2006-11-17T01:42:40Z", "bug_id": 34664, "creation_time": "2006-11-17T01:42:40Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "bug_id": 34664, "text": "I have not used SSL or mod_proxy at the time of this report.\nIt was very simple configuration for a few vhosts with PHP (as module) ans SSI.\n\nNow we've changed the platform to Linux, so I can do no more tests... ", "id": 95924, "time": "2006-11-17T05:46:22Z", "creator": "pash_ka@fonbet.info", "creation_time": "2006-11-17T05:46:22Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 34664, "text": "I have now installed PHP 5.2 on the server (regular downloaded from php.net),\nand the issue seems to be gone. No fatal errors for 24 hours, but I will let you\nknow if it happens again during peek traffic (although it came every 10-15\nminutes no matter what traffic we had).", "id": 96480, "time": "2006-12-03T04:51:03Z", "creator": "levi_tedder@hotmail.com", "creation_time": "2006-12-03T04:51:03Z", "is_private": false, "attachment_id": null}, {"count": 13, "attachment_id": null, "bug_id": 34664, "is_private": false, "id": 96505, "time": "2006-12-04T00:28:40Z", "creator": "levi_tedder@hotmail.com", "creation_time": "2006-12-04T00:28:40Z", "tags": [], "text": "Well, the fatal is still gone, but Apache seems to leak memory. It starts with a\nfew MB, but is up in 4-500 MB \"shortly\". \n\nFrom my conf:\n<IfModule mpm_winnt.c>\nThreadsPerChild 200\nMaxRequestsPerChild  0\n</IfModule>\nEnableMMAP off\nWin32DisableAcceptEx\nEnableSendfile off\n\nI have removed Win32DisableAcceptEx, and the memory consumption does not\nincrease. But then I'm back to \"The specified network name is no longer\navailable.  : winnt_accept: Asynchronous AcceptEx failed.\" in the log. Last time\nI did this it also served pages really slow, but now it seems to do this faster.\nSo, I think I will leave it like this and just purge the error log once in a\nwhile. Or degrade to PHP 5.1.6 to have apache restart itself :)\n\n"}, {"count": 14, "tags": [], "creator": "csaba@ai-media.com", "attachment_id": null, "id": 97160, "time": "2006-12-21T11:03:01Z", "bug_id": 34664, "creation_time": "2006-12-21T11:03:01Z", "is_private": false, "text": "Hello everyone,\n\nI'd like to report that this particular bug is affecting us as well. We have two\nidentical web servers running (using load balancing):\nDell, Win2003 Web Edition, 2.8 Ghz, 2 GB memory\nApache 2.2.3, OpenSSL 0.9.8d\nTomcat 5.5.17\nPHP 5.2, Zend Optimizer 3\n\nWe used to run IIS for over 4 years, but we've always had problems with the\nIIS->Tomcat integration. This September we switched to Apache and also started\nusing PHP.\n\nI had to apply the \"Win32DisableAcceptEx / EnableMMAP off / EnableSendfile off\"\ntrio, without it, same errors as mentioned above kept appearing in the error\nlog, and the users got Page Not Found errors. After applying these settings,\neverything seemed fine. There's no firewall software running, but there is a\nSonicwall firewall on the network.\n\nAfter applying Win32DisableAcceptEx, then \"FATAL:  erealloc():  Unable to\nallocate XXX bytes\" lines immediately started appearing. I did a lot of\nsearching, assuming the problem was with PHP. (5.1.6 did the same thing. We have\nsome pages that are encoded, so we needed the new Zend Optimizer too before we\ncould upgrade to 5.2. It's now out, we upgraded, same problem.)\n\nI wrote a small program to monitor and log the memory taken up by httpd.exe, and\nI found that it restarted itself about every 4-5 hours, when it reached around\n440Mb. Then I finally found this thread, and the suggestion of the original\nposter worked. \"ThreadsPerChild\" was 250 in httpd.conf, I reduced that to 120,\nand it was fine. The service was 100% up! However, our sites became slow, we're\ngetting about 100 requests per second. We tried to increase the number of\nthreads. With 150 it still died every 4-5 hours. With 135 too. Now it's on 128,\nand it's been stable for almost a day. That's way too low however, the servers\nshould be able to handle a lot more than that.\n\nI understand that this problem will be very hard to track down and fix... I'm\nstill not even 100% convinced that it's an Apache problem, could be PHP. Still I\nhope someone will be able to figure this out and put out a fix."}, {"count": 15, "tags": [], "bug_id": 34664, "attachment_id": null, "text": "Hi all,\n\nOh, how I hope someone can give us a clue on what to do with this. Here's what\nwe've been doing to try to isolate the problem.\n\n1) We thought SSL might be the problem, so we took it out of the equation by\nsetting up a new web server to take all the SSL connection, and reconfigured\nApache on our production servers to only listen on port 80. No noticeable\nchanges or improvement.\n\n2) We purchased a shiny new web server from Dell. Quad core CPU (2.33 Ghz), 4 GB\nRAM. Very fast, and should be more than adequate for a simple web server. Same\nconfiguration as our other servers. Apache (or PHP, we still don't know which)\ndies just as happily:\n\nFatal error: Out of memory (allocated 0) (tried to allocate 2 bytes) in Unknown\non line 0\n[Mon Mar 05 02:44:04 2007] [notice] Parent: child process exited with status\n4294967295 -- Restarting.\n\nWe watched the server closely, and when these errors happen, the CPU is low, the\nnumber of active connections is low, and there's over 2 GB of physical memory\navailable. It's running out of *SOMETHING*, we just don't know what. It always,\nvery reliably runs out of this something. The higher the threads, the faster (it\nseems).\n\nBut, at least we had 3 servers serving up 128 threads each, which was\ntemporarily acceptable.\n\n3) We are running 7 websites, only one of which uses PHP. So we directed the 6\nwebsites to just one server and we opened up the threads to 512, and that\nmachine has been running without a hitch ever since. So it's just Apache +\nTomcat. Hooray! Go Apache! This points to the problem definitely being in PHP,\nor the integration of PHP + Apache. (Please, don't send us away to go and post\nit on the PHP bug list just yet... All they are going to do is mark it as bogus.)\n\n4) We updated to Apache 2.2.4. No noticeable difference unfortunately.\n\nThe problem is, the traffic on the one site that uses PHP is steadily\nincreasing. (It feels weird calling this a problem :-)) We upgraded our staging\nserver to 2 GB of RAM, so it's the same specs as the others, and now 3\nproduction servers are serving up just that one site. In addition we restart\nApache daily. It worked fine for a while, but now it's getting worse: even with\njust serving 128 threads, and restarting the whole service daily (we have the\nredundancy for it), the above error is starting to present itself more and more\nfrequently...\n\nI didn't mention yet that we tried for over a week to reliably reproduce this\nproblem on our staging server, but we simply cannot. Our conclusion was that\nit's because when we send load to it (much bigger loads than what we normally\nget on production), it's all coming from the same IP. Whereas normal traffic\ncomes from all over the place, different IPs, different browsers.\n\nWe've looked at this so much already and running out of ideas and options. Help\nplease?", "id": 100059, "time": "2007-03-05T11:15:44Z", "creator": "csaba@ai-media.com", "creation_time": "2007-03-05T11:15:44Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 34664, "attachment_id": null, "is_private": false, "id": 112075, "time": "2007-12-21T22:12:51Z", "creator": "wrowe@apache.org", "creation_time": "2007-12-21T22:12:51Z", "text": "closing this as a php bug.\n\nhttp://httpd.apache.org/dev/debugging.html\n\ngives information on how to get an ENTIRE backtrace."}]