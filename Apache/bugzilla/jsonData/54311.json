[{"count": 0, "tags": [], "bug_id": 54311, "attachment_id": 29768, "is_private": false, "id": 164100, "time": "2012-12-16T03:08:11Z", "creator": "tixu@cs.ucsd.edu", "creation_time": "2012-12-16T03:08:11Z", "text": "Created attachment 29768\npatch to check the return value and print the error setting\n\nHi, \n\nIn both mpm_event and mpm_worker, the error return of inappropriate ThreadStackSize setting is not checked and printed out. This brings difficult to users who wants to set small ThreadStackSize. In my case, I cannot easily know whether the my setting is accepted or not without any log message.\n\nThe code is shown as follows:\n/*\n   server/mpm/event/event.c\n   server/mpm/worker/worker.c\n*/\nif (ap_thread_stacksize != 0) {\n    apr_threadattr_stacksize_set(thread_attr, ap_thread_stacksize);\n}\n\nThe return value of apr_threadattr_stacksize_set() tells whether the setting is valid or not. But the current code does not check the return value.\n\nI suggest to add a patch to check the return value and print out an error message, as follows (the patch is tested).\n\n     if (ap_thread_stacksize != 0) {\n-        rv = apr_threadattr_stacksize_set(thread_attr, ap_thread_stacksize);\n-        if(rv != APR_SUCCESS) {\n-            ap_log_error(APLOG_MARK, APLOG_WARNING | APLOG_STARTUP, 0, NULL, APLOGNO(00522)\n-                         \"WARNING: ThreadStackSize of %ld is inappropriate, change back to the default\", \n-                         ap_thread_stacksize);\n-        }\n+        apr_threadattr_stacksize_set(thread_attr, ap_thread_stacksize);\n     }   \n\nThe only thing I'm not sure is the APLOGNO. I don't know the rule of the number assignment. And it seems that adding a log message will break the sequential APLOGNO series."}, {"count": 1, "tags": [], "creator": "tixu@cs.ucsd.edu", "text": "Created attachment 29769\npatch to check the return value and print the error setting\n\nI update my patch. Thanks!", "id": 164101, "attachment_id": 29769, "bug_id": 54311, "creation_time": "2012-12-16T03:37:58Z", "time": "2012-12-16T03:37:58Z", "is_private": false}, {"count": 2, "tags": [], "text": "Created attachment 29770\nPlease refer to this patch, thanks!\n\nHere is the correct one. I write it based on the SendBufferSize checker.\n\nThe old patches are obsolete because it does not consider return value could be APR_ENOTIMPL. Please refer to this one.\n\nThanks a lot!\n\n-        apr_threadattr_stacksize_set(thread_attr, ap_thread_stacksize);\n+        rv = apr_threadattr_stacksize_set(thread_attr, ap_thread_stacksize);\n+        if(rv != APR_SUCCESS && rv != APR_ENOTIMPL) {\n+            ap_log_error(APLOG_MARK, APLOG_WARNING | APLOG_STARTUP, 0, NULL, APLOGNO(00522)\n+                         \"WARNING: ThreadStackSize of %ld is inappropriate, using default\", \n+                         ap_thread_stacksize);\n+        }", "is_private": false, "id": 164102, "creator": "tixu@cs.ucsd.edu", "time": "2012-12-16T03:43:16Z", "bug_id": 54311, "creation_time": "2012-12-16T03:43:16Z", "attachment_id": 29770}, {"count": 3, "tags": [], "creator": "christophe.jaillet@wanadoo.fr", "text": "Thanks for the patch.\n\nLooks reasonable.\n\nAnother place where the return value of 'apr_threadattr_stacksize_set' is not checked can be found on trunk in 'server/mpm/eventopt/eventopt.c' at line 2225", "id": 164448, "time": "2013-01-07T22:10:51Z", "bug_id": 54311, "creation_time": "2013-01-07T22:10:51Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "tixu@cs.ucsd.edu", "attachment_id": null, "id": 164461, "time": "2013-01-07T23:13:47Z", "bug_id": 54311, "creation_time": "2013-01-07T23:13:47Z", "is_private": false, "text": "Thanks a lot, Christophe.\n\nBut I don't find the file, i.e., 'server/mpm/eventopt/eventopt.c' in my source directory (actually I even don't have the eventopt directory). \n\nIs it new in trunk (compared with my stable version)?"}, {"count": 5, "tags": [], "creator": "christophe.jaillet@wanadoo.fr", "text": "Applied a slightly modified version to trunk.\nr1433682\n\nIf nobody complains, I'll propose it for backport in 2.4.x branch.", "id": 164641, "attachment_id": null, "bug_id": 54311, "creation_time": "2013-01-15T21:55:00Z", "time": "2013-01-15T21:55:00Z", "is_private": false}, {"count": 6, "tags": [], "text": "Proposed for backport to v2.4.", "is_private": false, "id": 166970, "creator": "minfrin@sharp.fm", "time": "2013-04-30T15:01:27Z", "bug_id": 54311, "creation_time": "2013-04-30T15:01:27Z", "attachment_id": null}, {"count": 7, "tags": [], "creator": "minfrin@sharp.fm", "text": "Backported to v2.4.5.", "id": 167147, "attachment_id": null, "bug_id": 54311, "creation_time": "2013-05-12T10:40:06Z", "time": "2013-05-12T10:40:06Z", "is_private": false}]