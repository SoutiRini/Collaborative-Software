[{"count": 0, "tags": [], "bug_id": 59687, "attachment_id": 33936, "text": "Created attachment 33936\nsimple file that causes trouble when removing rows with comments and missing rows above.\n\nThe attached file was created with Excel 2016.  It has only one cell with data, A4, with a comment on that cell.  The XML for the sheet shows only that one row defined.\n\nThe following test method fails, because XSSFSheet.removeRow(row) uses the physical offset, not the logical row #, when looking for row comments to remove.  If there are undefined rows (gaps in the physical sequence) these are different, and the comments remain after the row is deleted.\n\nThe fix is to store the rowNum from the row being deleted, and use that rather than the physical idx in the comment removal loop in XSSFSheet.removeRow(row).\n\nI'd do this as a patch, but I have another patch pending, and would rather not revert and reapply for so small a change.  If that's what it takes, I'll do it, though.\n\nAdd this test to TestXSSFSheetShiftRows, and the attached file to test-data/spreadsheet:\n\n\n    @Test\n    public void testRemoveRowWithCommentAndGapAbove() throws IOException {\n        final XSSFWorkbook wb = XSSFTestDataSamples.openSampleWorkbook(\"removeRowWithCommentBug.xlsx\");\n        final XSSFSheet sheet = wb.getSheetAt(0);\n\n        // comment exists\n        CellAddress commentCellAddress = new CellAddress(3, 0);\n        assertNotNull(sheet.getCellComment(commentCellAddress));\n        \n        assertEquals(\"Wrong starting # of comments\",  1, sheet.getCommentsTable(true).getNumberOfComments());\n        \n        sheet.removeRow(sheet.getRow(commentCellAddress.getRow()));\n        \n        assertEquals(\"There should not be any comments left!\",  0, sheet.getCommentsTable(true).getNumberOfComments());\n    }", "id": 191507, "time": "2016-06-09T17:30:17Z", "creator": "greg.woolsey@gmail.com", "creation_time": "2016-06-09T17:30:17Z", "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 59687, "text": "Thanks for catching this error, writing a unit test, and suggesting a fix!\n\nApplied in r1761860 and r1761861. Will be included in POI 3.16 beta 1.", "id": 193913, "time": "2016-09-22T07:52:36Z", "creator": "onealj@apache.org", "creation_time": "2016-09-22T07:52:36Z", "tags": [], "is_private": false}]