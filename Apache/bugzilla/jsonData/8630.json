[{"count": 0, "tags": [], "bug_id": 8630, "attachment_id": null, "id": 15072, "time": "2002-04-29T19:52:32Z", "creator": "cuongbavo@yahoo.com", "creation_time": "2002-04-29T19:52:32Z", "is_private": false, "text": "I don't know if this is a TomCat or ODBC driver problem, but basically I am \ntrying to update the MS Access database; and within 3 trials, the server \ncrashes.  In other words, the crash point varies; but reproducable. If it \ndoesn't crashes, then the database is updated correctly.\n\nhere is the update database code:\n---------------------------------\n/*\n**  ProcCheckout.java\n**\n*/\n\nimport java.io.*;\nimport java.text.*;\nimport javax.servlet.*;\nimport javax.servlet.http.*;\nimport java.sql.Connection;\nimport java.sql.Statement;\nimport java.sql.ResultSet;\nimport java.sql.DriverManager;\nimport java.net.*;\nimport java.util.*;\n\npublic class ProcCheckout extends HttpServlet\n{\n  public static final int MAXCART = 20;\n  public static final double SHIPPINGRATE = 5.99;\n  public static final double DISCOUNTRATE = 0.10;\n\n  private ShoppingCart[] myCart;\n  private Integer numItem;\n  private ServletConfig config;\n  private Connection theConnection;\n  private Statement theStatement;\n  private ResultSet theResult;\n  private String LastName, FirstName, Street, City, State, ZipCode, Phone, \nEmail,\n                 sLastName, sFirstName, sStreet, sCity, sState, sZipCode,\n\t\t CardNum, CardType, ExpireDate, strError, orderid, password;\n\n/*******************************************************************************\n***/\npublic void init(ServletConfig config) throws ServletException\n{\n  try\n  {\t\n    Class.forName(\"sun.jdbc.odbc.JdbcOdbcDriver\");\n    theConnection = DriverManager.getConnection(\"jdbc:odbc:Sale\", \"admin\", \"\"); \n    theStatement = theConnection.createStatement\n(ResultSet.TYPE_SCROLL_SENSITIVE,\n                                                        \nResultSet.CONCUR_UPDATABLE);\n  }catch(Exception e){\n    //out.println(e.getMessage());\n  }\n}\n\n/*******************************************************************************\n***/\npublic void doGet (HttpServletRequest req, HttpServletResponse res)\n                        throws ServletException, IOException \n{\n  HttpSession session = req.getSession(true);\n  PrintWriter out = res.getWriter();\n  String Receipt = \"\";\n  res.setContentType(\"text/html\");\n\n  if (! getBilling(req))    //not valid billing information\n  {\n    out.println(\"<html><head><title>Billing Information \nError</title></head></body>\");\n    out.println(strError);\n    out.println(\"</body></head>\");\n    return;\n  }\n\n  myCart  = (ShoppingCart[]) session.getAttribute(\"ShoppingCart\");\n  numItem = (Integer) session.getAttribute(\"NumItem\");\n\n  if ((numItem == null) || (myCart == null) || (myCart[0] == null))\n  {\n    out.println(\"<html><head><title>Invalid Transaction \nCheckout</title></head></body>\");\n    out.println(\"<font color=\\\"red\\\">Sorry, your Shopping Cart is empty. Please \ncontinue\"\n              + \" your shopping.</font>\");\n    out.println(\"</body></head>\");\n    return;\n  }\n    \n  Date transDate = new Date();\n  orderid  = Phone + transDate.toString();\n  password = CardNum;\n\n  Receipt = \"<b>Customer:</b> \" + FirstName + \" \" + LastName \n+ \"<br><b>Phone:</b> \" + Phone\n          + \"<br><b>Email:</b> \" + Email \n+ \"<br><b><u>Address:</u></b><br>&nbsp;&nbsp;&nbsp;&nbsp;\" \n          + Street + \"<br>&nbsp;&nbsp;&nbsp;&nbsp;\"\n          + City + \", \" + State + \" \" + ZipCode + \"\\n<br><br><b>Ship \nTo:</b><br>&nbsp;&nbsp;&nbsp;&nbsp;\"\n          + sFirstName + \" \" + sLastName + \"<br>&nbsp;&nbsp;&nbsp;&nbsp;\" + \nsStreet + \"<br>&nbsp;&nbsp;&nbsp;&nbsp;\"\n          + sCity + \", \" + sState + \" \" + sZipCode + \"\\n\"\n          + \"<br><br><hr width=\\\"90%\\\">\"\n          + \"<table align=\\\"center\\\" width=\\\"90%\\\">\"\n          + \"<tr>\" \n          + \"<th bgcolor=\\\"#0000FF\\\" align=\\\"left\\\">Items Bought</th>\"\n          + \"<th bgcolor=\\\"#0000FF\\\" align=\\\"center\\\">Qty</th>\"\n          + \"<th bgcolor=\\\"#0000FF\\\" align=\\\"right\\\">Unit Price</th>\"\n          + \"<th bgcolor=\\\"#0000FF\\\" align=\\\"right\\\">Cost</th>\" \n          + \"</tr>\\n\";\n\n  double cost = 0.0,\n         subtotal = 0.0,\n         discount = 0.0,\n         shipping = 0.0;\n\n  for (int x = 0;x < numItem.intValue();x++)\n  {\n    cost = myCart[x].getPrice() * myCart[x].getQty();\n    subtotal = subtotal + cost;\n    shipping = shipping + SHIPPINGRATE * myCart[x].getQty();\n\n    if (myCart[x].getQty() > 1)  //give 10% off each additional item for qty > 1\n      discount = discount + (myCart[x].getQty() - 1) * myCart[x].getPrice() * \nDISCOUNTRATE;\n\n    Receipt = Receipt + \"<tr>\"\n            + \"<td>\" + myCart[x].getProdName() + \"</td>\" \n            + \"<td align=\\\"center\\\">\" + myCart[x].getQty() + \"</td>\"\n            + \"<td align=\\\"right\\\">\" + curFormat(myCart[x].getPrice()) \n+ \"</td>\" \n            + \"<td align=\\\"right\\\">\" + curFormat(cost) + \"</td>\"\n            + \"</tr>\\n\";\n  }\n    \n  Receipt = Receipt + \"<tr><td colspan=\\\"2\\\"></td><td colspan=\\\"2\\\"><hr \nwidth=\\\"100%\\\"></td></tr>\\n\"\n          + \"<tr><td colspan=\\\"2\\\"></td><td><b>SubTotal:</b></td><td \nalign=\\\"right\\\">\" + curFormat(subtotal) + \"</td></tr>\\n\"\n          + \"<tr><td colspan=\\\"2\\\"></td><td><b>Discount:</b></td><td \nalign=\\\"right\\\"> - \" + curFormat(discount) + \"</td></tr>\\n\"\n          + \"<tr><td colspan=\\\"2\\\"></td><td><b>Shipping:</b></td><td \nalign=\\\"right\\\"> + \" + curFormat(shipping) + \"</td></tr>\\n\"\n          + \"<tr><td colspan=\\\"2\\\"></td><td colspan=\\\"2\\\"><hr width=\\\"100%\n\\\"></td></tr>\\n\"\n          + \"<tr><td colspan=\\\"2\\\"></td><td><b>TOTAL:</b></td><td \nalign=\\\"right\\\">\" + curFormat(subtotal - discount + shipping) \n          + \"</td></tr>\\n\"\n          + \"<TR><TD width=\\\"100%\\\" colspan=\\\"4\\\">\"\n          + \"<font size=\\\"0.5\\\" color=\\\"red\\\">Discount: 10% off each additional \nquantity per item.<br>\"\n          + \"Shipping: $5.99/Qty per item.</font>\"\n          + \"</TD></TR></table><hr width=\\\"100%\\\">\";\n\n  try\n  {\n    theResult = theStatement.executeQuery(\"select * from SALEORDER\");\n    theResult.moveToInsertRow();\n    theResult.updateString(1, orderid);\n    theResult.updateString(2, password);\n    theResult.updateString(3, FirstName);\n    theResult.updateString(4, LastName);\n    theResult.updateBoolean(5, false);\n    theResult.updateString(6, transDate.toString());\n    theResult.updateString(7, CardNum);\n    theResult.updateString(8, CardType);\n    theResult.updateString(9, ExpireDate);\n    theResult.updateString(10, Email);\n    theResult.updateString(11, req.getRemoteAddr());\n    theResult.updateString(12, Receipt);\n    theResult.insertRow();\n    theResult.close();\n  }catch(Exception e){\n    out.println(\"<html><head><title>Database ORDER \nError</title></head></body>\");\n    out.println(\"<font color=\\\"red\\\">Sorry, We have problem placing your Order \"\n              + \"at this time. Please try again. If this problem persists, \nplease \"\n              + \"contact our Customer Service Representatives. Thank you!!!\n</font>\");\n    out.println(\"</body></head>\");\n    return;\n  }\n\n  out.println(\"<html><head><title>SportShop Sale Receipt</title></head><body>\");\n  out.println(\"<br><h2 align=\\\"center\\\">SportShop Sale Receipt</h2>\");\n  out.println(Receipt);\n  out.println(\"<b><u>Tracking Information:</u></b><br>\" \n            + \"&nbsp;&nbsp;&nbsp;&nbsp;<b>OrderID:</b> \" + orderid + \"<br>\"\n            + \"&nbsp;&nbsp;&nbsp;&nbsp;<b>Password:</b> \" + password + \"<hr \nwidth=\\\"50%\\\">\"\n            + \"<center><b>Thank you for Shopping with us.<br>Have a nice day!!!\n</b></center>\");\n  out.println(\"<br></body></head>\");\n}\n\n/*******************************************************************************\n***/\npublic void doPost (HttpServletRequest req, HttpServletResponse res)\n                        throws ServletException, IOException \n{\n  doGet(req, res);\n}\n\n/*******************************************************************************\n***/\npublic void destroy()\n{\n  try\n  {\n    theResult.close();\t\t\t\t\t\n    theStatement.close();\t\t\t\t\n    theConnection.close(); \n  }catch(Exception e){\n    //out.println(e.getMessage());\n  }\n}\n\n/*******************************************************************************\n***/\nprivate String curFormat(double Value)\n{\n  DecimalFormat Currency = new DecimalFormat(\"$###,##0.00\");\n  return(Currency.format(Value));\n}\n\n/***************************************************************************/\npublic boolean getBilling(HttpServletRequest request) \n\t\t\tthrows IOException, ServletException\n{\n  boolean valid = true;\n  strError = \"<h2>Invalid/Missing Billing Information</h2><p>Please \"\n           + \"Click on the \\\"<--BACK\\\" arrow and update the following \"\n\t   + \"input fields:<br>\\n<ul>\\n\";\n\n  //Get Personal Information\n  LastName = request.getParameter(\"LastName\");\n  if (LastName.equals(\"\"))\n  {\n    strError = strError + \"<li>Last Name is missing.</li>\\n\";\n    valid = false;\n  }\n  FirstName = request.getParameter(\"FirstName\");\n  if (FirstName.equals(\"\"))\n  {\n    strError = strError + \"<li>First Name is missing.</li>\\n\";\n    valid = false;\n  }\n  Phone = request.getParameter(\"Phone\");\n  if (Phone.equals(\"\"))\n  {\n    strError = strError + \"<li>Phone Number is missing.</li>\\n\";\n    valid = false;\n  }\n  Email = request.getParameter(\"Email\");\n  if (Email.equals(\"\"))\n  {\n    Email = \"None\";\n  }\n  Street = request.getParameter(\"Street\");\n  if (Street.equals(\"\"))\n  {\n    strError = strError + \"<li>Street is missing.</li>\\n\";\n    valid = false;\n  }\n  City = request.getParameter(\"City\");\n  if (City.equals(\"\"))\n  {\n    strError = strError + \"<li>City is missing.</li>\\n\";\n    valid = false;\n  }\n  State = request.getParameter(\"State\");\n  if (State.equals(\"\"))\n  {\n    strError = strError + \"<li>State is missing.</li>\\n\";\n    valid = false;\n  }\n  ZipCode = request.getParameter(\"ZipCode\");\n  if (ZipCode.equals(\"\"))\n  {\n    strError = strError + \"<li>Zip Code is missing.</li>\\n\";\n    valid = false;\n  }\n\n  //Get Shipping Information\n  sLastName = request.getParameter(\"sLastName\");\n  sFirstName = request.getParameter(\"sFirstName\");\n  if (sLastName.equals(\"\") && sFirstName.equals(\"\"))\n  {\n    sLastName = LastName;\n    sFirstName = FirstName;\n  }\n  sStreet = request.getParameter(\"sStreet\");\n  sCity = request.getParameter(\"sCity\");\n  sState = request.getParameter(\"sState\");\n  sZipCode = request.getParameter(\"sZipCode\");\n  if (sStreet.equals(\"\") || sCity.equals(\"\") \n                         || sState.equals(\"\") || sZipCode.equals(\"\"))\n  {\n    sStreet = Street;\n    sCity = City;\n    sState = State;\n    sZipCode = ZipCode;\n  }\n  \n  //Check Credit Card information\n  CardNum = request.getParameter(\"CardNumber\");\n  if (CardNum.equals(\"\") || (CardNum.length() != 16))\n  {\n    strError = strError + \"<li>Credit Card number is not valid.</li>\\n\";\n    valid = false;\n  }\n  CardType = request.getParameter(\"CardType\");\n  ExpireDate = request.getParameter(\"ExpireDate\");\n  if (ExpireDate.equals(\"\"))\n  {\n    strError = strError + \"<li>Must enter Card Expiration Date.</li>\\n\";\n    valid = false;\n  }\n\n  return(valid);\n}\n\n/*******************************************************************************\n***/\n}\n\nHere is the Crash data:\n-----------------------\n\nAn unexpected exception has been detected in native code outside the VM.\nUnexpected Signal : EXCEPTION_ACCESS_VIOLATION occurred at PC=0x77FCB892\nFunction=RtlFreeHeap+0x25F\nLibrary=C:\\WINNT\\System32\\ntdll.dll\n\nCurrent Java thread:\n\tat sun.jdbc.odbc.JdbcOdbc.ReleaseStoredBytes(Native Method)\n\tat sun.jdbc.odbc.JdbcOdbcResultSet.FreeCols(Unknown Source)\n\t- locked <02A4FA78> (a sun.jdbc.odbc.JdbcOdbcResultSet)\n\tat sun.jdbc.odbc.JdbcOdbcResultSet.insertRow(Unknown Source)\n\tat ProcCheckout.doGet(ProcCheckout.java:145)\n\tat ProcCheckout.doPost(ProcCheckout.java:171)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:760)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:853)\n\tat org.apache.catalina.servlets.InvokerServlet.serveRequest\n(InvokerServlet.java:446)\n\tat org.apache.catalina.servlets.InvokerServlet.doPost\n(InvokerServlet.java:216)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:760)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:853)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter\n(ApplicationFilterChain.java:247)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter\n(ApplicationFilterChain.java:193)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke\n(StandardWrapperValve.java:243)\n\tat org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:566)\n\tat org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:472)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:943)\n\tat org.apache.catalina.core.StandardContextValve.invoke\n(StandardContextValve.java:201)\n\tat org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:566)\n\tat org.apache.catalina.valves.CertificatesValve.invoke\n(CertificatesValve.java:246)\n\tat org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:564)\n\tat org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:472)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:943)\n\tat org.apache.catalina.core.StandardContext.invoke\n(StandardContext.java:2344)\n\tat org.apache.catalina.core.StandardHostValve.invoke\n(StandardHostValve.java:164)\n\tat org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:566)\n\tat org.apache.catalina.valves.ErrorDispatcherValve.invoke\n(ErrorDispatcherValve.java:170)\n\tat org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:564)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke\n(ErrorReportValve.java:170)\n\tat org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:564)\n\tat org.apache.catalina.valves.AccessLogValve.invoke\n(AccessLogValve.java:462)\n\tat org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:564)\n\tat org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:472)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:943)\n\tat org.apache.catalina.core.StandardEngineValve.invoke\n(StandardEngineValve.java:163)\n\tat org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:566)\n\tat org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:472)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:943)\n\tat org.apache.catalina.connector.http.HttpProcessor.process\n(HttpProcessor.java:1011)\n\tat org.apache.catalina.connector.http.HttpProcessor.run\n(HttpProcessor.java:1106)\n\tat java.lang.Thread.run(Unknown Source)\n\nDynamic libraries:\n0x00400000 - 0x00406000 \tC:\\Program Files\\Java\\j2re1.4.0\\bin\\java.exe\n0x77F80000 - 0x77FFB000 \tC:\\WINNT\\System32\\ntdll.dll\n0x77DB0000 - 0x77E0B000 \tC:\\WINNT\\system32\\ADVAPI32.dll\n0x77E80000 - 0x77F35000 \tC:\\WINNT\\system32\\KERNEL32.DLL\n0x77D40000 - 0x77DB0000 \tC:\\WINNT\\system32\\RPCRT4.DLL\n0x78000000 - 0x78046000 \tC:\\WINNT\\system32\\MSVCRT.dll\n0x6D330000 - 0x6D442000 \tC:\\Program Files\\Java\\j2re1.4.0\n\\bin\\client\\jvm.dll\n0x77E10000 - 0x77E74000 \tC:\\WINNT\\system32\\USER32.dll\n0x77F40000 - 0x77F7C000 \tC:\\WINNT\\system32\\GDI32.DLL\n0x77570000 - 0x775A0000 \tC:\\WINNT\\System32\\WINMM.dll\n0x6D1D0000 - 0x6D1D7000 \tC:\\Program Files\\Java\\j2re1.4.0\\bin\\hpi.dll\n0x6D300000 - 0x6D30D000 \tC:\\Program Files\\Java\\j2re1.4.0\\bin\\verify.dll\n0x6D210000 - 0x6D228000 \tC:\\Program Files\\Java\\j2re1.4.0\\bin\\java.dll\n0x6D320000 - 0x6D32D000 \tC:\\Program Files\\Java\\j2re1.4.0\\bin\\zip.dll\n0x6D2D0000 - 0x6D2DD000 \tC:\\Program Files\\Java\\j2re1.4.0\\bin\\net.dll\n0x75050000 - 0x75058000 \tC:\\WINNT\\System32\\WSOCK32.dll\n0x75030000 - 0x75043000 \tC:\\WINNT\\System32\\WS2_32.DLL\n0x75020000 - 0x75028000 \tC:\\WINNT\\System32\\WS2HELP.DLL\n0x74FD0000 - 0x74FEF000 \tC:\\WINNT\\system32\\msafd.dll\n0x75010000 - 0x75017000 \tC:\\WINNT\\System32\\wshtcpip.dll\n0x6D250000 - 0x6D25A000 \tC:\\Program Files\\Java\\j2re1.4.0\\bin\\JdbcOdbc.dll\n0x1F7D0000 - 0x1F804000 \tC:\\WINNT\\System32\\ODBC32.dll\n0x76B30000 - 0x76B6E000 \tC:\\WINNT\\system32\\comdlg32.dll\n0x77C70000 - 0x77CBA000 \tC:\\WINNT\\system32\\SHLWAPI.DLL\n0x77B50000 - 0x77BD9000 \tC:\\WINNT\\system32\\COMCTL32.DLL\n0x782F0000 - 0x78532000 \tC:\\WINNT\\system32\\SHELL32.DLL\n0x1F8C0000 - 0x1F8D6000 \tC:\\WINNT\\System32\\odbcint.dll\n0x1F8F0000 - 0x1F932000 \tC:\\WINNT\\System32\\odbcjt32.dll\n0x1B000000 - 0x1B16F000 \tC:\\WINNT\\System32\\msjet40.dll\n0x1B5C0000 - 0x1B655000 \tC:\\WINNT\\System32\\mswstr10.dll\n0x77A50000 - 0x77B46000 \tC:\\WINNT\\system32\\ole32.dll\n0x779B0000 - 0x77A4B000 \tC:\\WINNT\\system32\\OLEAUT32.dll\n0x1F8E0000 - 0x1F8EE000 \tC:\\WINNT\\System32\\odbcji32.dll\n0x1B2C0000 - 0x1B2CD000 \tC:\\WINNT\\System32\\msjter40.dll\n0x1B2D0000 - 0x1B2F6000 \tC:\\WINNT\\System32\\MSJINT40.DLL\n0x775A0000 - 0x77625000 \tC:\\WINNT\\System32\\CLBCATQ.DLL\n0x1B7F0000 - 0x1B82A000 \tC:\\WINNT\\System32\\msjtes40.dll\n0x117F0000 - 0x117FB000 \tC:\\WINNT\\System32\\VBAJET32.DLL\n0x11C10000 - 0x11C72000 \tC:\\WINNT\\System32\\expsrv.dll\n0x77920000 - 0x77943000 \tC:\\WINNT\\system32\\imagehlp.dll\n0x72A00000 - 0x72A2D000 \tC:\\WINNT\\system32\\DBGHELP.dll\n0x690A0000 - 0x690AB000 \tC:\\WINNT\\System32\\PSAPI.DLL\n\nLocal Time = Sat Apr 20 00:09:20 2002\nElapsed Time = 57\n#\n# The exception above was detected in native code outside the VM\n#\n# Java VM: Java HotSpot(TM) Client VM (1.4.0-b92 mixed mode)\n#"}, {"count": 1, "tags": [], "text": "This is not a Tomcat issue, but rather a \"SEGFAULT\" in the ntdll.dll provided with your Win32 \ndistribution, or a mishap in your JDBC provider.", "attachment_id": null, "id": 15073, "creator": "pier@betaversion.org", "time": "2002-04-29T19:55:19Z", "bug_id": 8630, "creation_time": "2002-04-29T19:55:19Z", "is_private": false}]