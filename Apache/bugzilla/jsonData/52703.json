[{"count": 0, "tags": [], "creator": "calestyo@scientia.net", "attachment_id": null, "id": 153907, "time": "2012-02-18T03:14:28Z", "bug_id": 52703, "creation_time": "2012-02-18T03:14:28Z", "is_private": false, "text": "Hi.\n\nThis is a really weird problem. I'm actually not sure whether it's a bug in Apache (or the browsers) but, having absolutely no idea, I need some point to start (sorry).\n\nIt is similar (and may be related to #52631). It happens with Firefox and Chromium.\n\n\nSetup is the following:\nI'm using SSL with SNI and SSL client authentication required.\nI have fakeBasicAuth enabled.\n\nI go to the site, I'm asked for my certificate, I'm granted access,.. so far everything fine.\n\nBut after some time (haven't measured it, about in the range of 10 minutes), when I click reload, or any link within the same site, the access is forbidden and I get HTTP 403.\nIt seems as if the SSL session would still be open (the browsers show their coloured address and there is no client cert or other SSL error).\n\nLooking in the vhost's log I see:\n[Sat Feb 18 04:08:23 2012] [error] No hostname was provided via SNI for a name based virtual host\n[Sat Feb 18 04:08:23 2012] [error] No hostname was provided via SNI for a name based virtual host\n\nand in the server wide error log:\nat Feb 18 04:08:22 2012] [info] [client 91.8.39.109] Connection to child 84 established (server localhost:443)\n[Sat Feb 18 04:08:22 2012] [info] Seeding PRNG with 1312 bytes of entropy\n[Sat Feb 18 04:08:23 2012] [info] [client 91.8.39.109] Connection to child 17 established (server localhost:443)\n[Sat Feb 18 04:08:23 2012] [info] Seeding PRNG with 1312 bytes of entropy\n[Sat Feb 18 04:08:23 2012] [info] [client 91.8.39.109] Connection to child 213 established (server localhost:443)\n[Sat Feb 18 04:08:23 2012] [info] Seeding PRNG with 1312 bytes of entropy\n[Sat Feb 18 04:08:23 2012] [info] [client 91.8.39.109] Connection to child 148 established (server localhost:443)\n[Sat Feb 18 04:08:23 2012] [info] Seeding PRNG with 1312 bytes of entropy\n[Sat Feb 18 04:08:23 2012] [info] [client 91.8.39.109] Connection to child 83 established (server localhost:443)\n[Sat Feb 18 04:08:23 2012] [info] Seeding PRNG with 1312 bytes of entropy\n[Sat Feb 18 04:08:23 2012] [info] [client 91.8.39.109] Connection to child 11 established (server localhost:443)\n[Sat Feb 18 04:08:23 2012] [info] Seeding PRNG with 1312 bytes of entropy\n[Sat Feb 18 04:08:23 2012] [info] [client 91.8.39.109] Connection closed to child 84 with standard shutdown (server localhost:443)\n[Sat Feb 18 04:08:23 2012] [info] [client 91.8.39.109] Connection closed to child 11 with standard shutdown (server localhost:443)\n[Sat Feb 18 04:08:33 2012] [info] [client 91.8.39.109] Request header read timeout\n[Sat Feb 18 04:08:33 2012] [info] [client 91.8.39.109] (70007)The timeout specified has expired: SSL input filter read failed.\n[Sat Feb 18 04:08:33 2012] [info] [client 91.8.39.109] Connection closed to child 17 with standard shutdown (server localhost:443)\n[Sat Feb 18 04:08:33 2012] [info] [client 91.8.39.109] Request header read timeout\n[Sat Feb 18 04:08:33 2012] [info] [client 91.8.39.109] (70007)The timeout specified has expired: SSL input filter read failed.\n[Sat Feb 18 04:08:33 2012] [info] [client 91.8.39.109] Connection closed to child 213 with standard shutdown (server localhost:443)\n[Sat Feb 18 04:08:33 2012] [info] [client 91.8.39.109] Request header read timeout\n[Sat Feb 18 04:08:33 2012] [info] [client 91.8.39.109] (70007)The timeout specified has expired: SSL input filter read failed.\n[Sat Feb 18 04:08:33 2012] [info] [client 91.8.39.109] Connection closed to child 148 with standard shutdown (server localhost:443)\n[Sat Feb 18 04:08:33 2012] [info] [client 91.8.39.109] Request header read timeout\n[Sat Feb 18 04:08:33 2012] [info] [client 91.8.39.109] (70007)The timeout specified has expired: SSL input filter read failed.\n[Sat Feb 18 04:08:33 2012] [info] [client 91.8.39.109] Connection closed to child 83 with standard shutdown (server localhost:443)\n\n\n...for every tried access.\nThe times of both log output correspond (both from the same access).\nNot sure what this timeout from the server log is,.. but I guess it's due to my use of RequestReadTimeout, could that be?!\n\n\nWhen I restart Apache and try it again with both browsers it still doesn't work again (still get 403, but still the SSL session seems to be successfully created).\n\n\nThe only way to get it working again, is to close the browsers and start again, or with firefox, to clear all \"Active Logons\".\n\n\nNow I have absolutely no idea where to start tracing,... not even whether this seems to be more a browser issue or a server issue.\nJust some indication that some timeout or cache that runs out could be the reason.\n\n\nAny ideas?\n\n\nCheers,\nChris."}, {"count": 1, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "id": 153914, "time": "2012-02-18T12:07:32Z", "bug_id": 52703, "creation_time": "2012-02-18T12:07:32Z", "is_private": false, "text": "You're using bugzilla for support and discussion, but it is to be used strictly for reporting bugs.  Discuss your issue on a mailing list until it can be distilled to an actual bug with supporting doc.\n\nhttp://httpd.apache.org/lists.html#http-users"}, {"count": 2, "tags": [], "creator": "calestyo@scientia.net", "attachment_id": null, "id": 153930, "time": "2012-02-19T19:02:32Z", "bug_id": 52703, "creation_time": "2012-02-19T19:02:32Z", "is_private": false, "text": "For the records:\n\nI've opened tickets at...\n\n\nFirefox:\nhttps://bugzilla.mozilla.org/show_bug.cgi?id=728715\n\nand\n\nChromium:\nhttps://code.google.com/p/chromium/issues/detail?id=114944\n\nabout this issue."}, {"count": 3, "tags": [], "text": "I just found out that this issue, as well as #52631, is seemingly solved by setting\nSSLSessionCache (https://httpd.apache.org/docs/current/mod/mod_ssl.html#sslsessioncache) to it's default:\nnone\nfrom my own setting (Debian's default):\nSSLSessionCache shmcb:${APACHE_RUN_DIR}/ssl_scache(512000)\n\n\nI came to this idea via http://vincent.bernat.im/en/blog/2011-ssl-session-reuse-rfc5077.html ...\n\nSo SSLSessionCache is responsible for SSL Session resumption, right?!\n\nAgain, it happens with Firefox/Chromium (both using NSS) so this might be either a NSS bug or an Apache bug or some bad playing between both.\n\n\nEric et al, I guess this is enough proof that this is a bug as one could imagine from the beginning, right?! So reopening it.", "is_private": false, "id": 154461, "creator": "calestyo@scientia.net", "time": "2012-03-03T00:44:00Z", "bug_id": 52703, "creation_time": "2012-03-03T00:44:00Z", "attachment_id": null}, {"count": 4, "text": "So the \"after some time\" is the first time the session is attempted to be  resumed, or the first time it's attempted and fails or what?  What does a packet capture say?", "creator": "covener@gmail.com", "attachment_id": null, "id": 154463, "time": "2012-03-03T01:12:08Z", "bug_id": 52703, "creation_time": "2012-03-03T01:12:08Z", "tags": [], "is_private": false}, {"count": 5, "tags": [], "creator": "calestyo@scientia.net", "attachment_id": null, "id": 154465, "time": "2012-03-03T01:25:31Z", "bug_id": 52703, "creation_time": "2012-03-03T01:25:31Z", "is_private": false, "text": ">So the \"after some time\" is the first time the session is attempted\n>to be resumed, or the first time it's attempted and fails or what?\n\nAs far as I can tell from my debugging: yes\n\n\n>What does a packet capture say?\n\nI've done already one in the past, which can be found in the attachments of:\nhttps://bugzilla.mozilla.org/show_bug.cgi?id=728715\n\nIs this useful (is it the same you want for https://issues.apache.org/bugzilla/show_bug.cgi?id=52631#c11)? If not what shall I do?"}, {"count": 6, "tags": [], "bug_id": 52703, "attachment_id": null, "id": 154467, "time": "2012-03-03T01:46:26Z", "creator": "covener@gmail.com", "creation_time": "2012-03-03T01:46:26Z", "is_private": false, "text": "I clicked through.  In the failing case the client tries to resume the session and does not set a server_name extension in the handshake.  The resume seems to succeed (the session ID itself is not in the parsed trace, but the exchange is clearly very short).\n\nPresumably openssl doesn't save/restore this info in the session, because it comes in on a part of the handshake that isn't abbreviated (initial client hello).\n\nWhen the same client isn't trying to resume a session, it sends the server_name extension.\n\nIt does not seem to directly explain why the clients do the right thing with SSL session caching disabled, since all things being equal they should just continue down the \"fail\" case but with a new session created.\n\nSo in short, Apache uses the extension when it's present in the handshake."}, {"count": 7, "tags": [], "bug_id": 52703, "attachment_id": null, "is_private": false, "id": 154468, "time": "2012-03-03T02:02:11Z", "creator": "calestyo@scientia.net", "creation_time": "2012-03-03T02:02:11Z", "text": "So you mean basically, that this has to be a bug in the clients (that is NSS), right?\n\nI thought session resumption would mean that the client doesn't have to send all information (including server_name) again?"}, {"count": 8, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "id": 154469, "time": "2012-03-03T02:46:45Z", "bug_id": 52703, "creation_time": "2012-03-03T02:46:45Z", "is_private": false, "text": "The TLS extensions RFC (rfc6066?) says that when the session is resumed, the original extensions should be used.\n\nSome related discussion here:\n  http://rt.openssl.org/Ticket/Display.html?id=2019&user=guest&pass=guest"}, {"count": 9, "text": "Hey Eric,\n\nWe've found out new hints, see https://bugzilla.mozilla.org/show_bug.cgi?id=728715 especially starting with comment 12.\n\n\nThere seem to be still some bugs hidden somewhere..\n\na) It does not work with SSL 3.0 and session resumption (SSLSessionCache) enabled.\n\nb) It works however with TLS 1.0 AND session resumption (SSLSessionCache) enabled.\nBUT:\nThere seem to be either a bug or documentation ambiguity in https://httpd.apache.org/docs/current/mod/mod_ssl.html#sslprotocol :\n\n\"TLSv1 SSLv3\"\nseems to be different from\n\"+TLSv1 +SSLv3\"\n\nCould you possibly have a look? :)", "creator": "calestyo@scientia.net", "attachment_id": null, "id": 154489, "time": "2012-03-04T16:04:04Z", "bug_id": 52703, "creation_time": "2012-03-04T16:04:04Z", "tags": [], "is_private": false}, {"count": 10, "tags": [], "text": "\n> BUT:\n> There seem to be either a bug or documentation ambiguity in\n> https://httpd.apache.org/docs/current/mod/mod_ssl.html#sslprotocol :\n> \n> \"TLSv1 SSLv3\"\n> seems to be different from\n> \"+TLSv1 +SSLv3\"\n> \n\nSSLProtocol doesn't treat two non-+/- options as being both enabled -- the last one wins as if they were on separate lines.", "is_private": false, "id": 154491, "creator": "covener@gmail.com", "time": "2012-03-04T16:18:16Z", "bug_id": 52703, "creation_time": "2012-03-04T16:18:16Z", "attachment_id": null}, {"count": 11, "tags": [], "text": "*** Bug 52631 has been marked as a duplicate of this bug. ***", "is_private": false, "id": 154493, "creator": "covener@gmail.com", "time": "2012-03-04T16:20:01Z", "bug_id": 52703, "creation_time": "2012-03-04T16:20:01Z", "attachment_id": null}, {"count": 12, "tags": [], "text": "Kaspar / drh -- does this split between sslv3 and tlsv1.0 in openssl make sense wrt the extended client hello extensions coming from the abbreviated handshake or the original handshake? \n\nIs it at odds with interpretation by NSS?", "is_private": false, "id": 154495, "creator": "covener@gmail.com", "time": "2012-03-04T16:27:16Z", "bug_id": 52703, "creation_time": "2012-03-04T16:27:16Z", "attachment_id": null}, {"count": 13, "tags": [], "bug_id": 52703, "attachment_id": null, "is_private": false, "id": 154497, "time": "2012-03-04T16:35:56Z", "creator": "calestyo@scientia.net", "creation_time": "2012-03-04T16:35:56Z", "text": "Hi Eric.\n\nWith respect to comment #10, I've submitted bug #52821.\n\nThis explains why it didn't work for me with TLS 1.0 (as TLS 1.0 was simply not\nused)\n\n\nNevertheless, it's still open why it doesn't work with SSL 3.0, so until that\nis found out, please keep the bug open.\nIf it's a problem in NSS, I'll take care to close the Apache bug here, once\neverything is solved.\n\nThanks."}, {"count": 14, "tags": [], "bug_id": 52703, "attachment_id": null, "id": 154504, "time": "2012-03-04T19:06:03Z", "creator": "covener@gmail.com", "creation_time": "2012-03-04T19:06:03Z", "is_private": false, "text": "Include an update her summarizing the SSLv3 problem, specifically whether it is an issue in full handshakes, abbreviated/resumed handshakes, and where your client sets the server_name extension (initial handshake, resumed handshake)."}, {"count": 15, "tags": [], "bug_id": 52703, "attachment_id": null, "id": 154964, "time": "2012-03-16T00:06:06Z", "creator": "calestyo@scientia.net", "creation_time": "2012-03-16T00:06:06Z", "is_private": false, "text": "Hi Eric.\n\nIs there still something required from your side?\n\nAt least the corresponding NSS bug (https://bugzilla.mozilla.org/show_bug.cgi?id=728715) was closed today.\n\n\nChris."}]