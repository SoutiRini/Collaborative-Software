[{"count": 0, "tags": [], "text": "If the classes used are stored in the \"shared\" folder,\nthe JNDI context within the Servlet.destroy() method is only\ncorrect in the thread calling the destroy method.\n\nIf a subthread is created, it does not find the context.\n\nIf have a sampe Webapplication, that reproduces the bug.\n(But no webspace for providing it)\n\nBest regards\nDI Horst Scheruga", "attachment_id": null, "id": 91814, "creator": "horst@scheruga.net", "time": "2006-08-02T13:49:28Z", "bug_id": 40162, "creation_time": "2006-08-02T13:49:28Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 40162, "text": "Please attach your WAR to this issue: click the \"Create a New Attachment\" link\nabove this comment field, below the Keywords field.", "id": 97319, "time": "2006-12-26T06:23:29Z", "creator": "yoavs@computer.org", "creation_time": "2006-12-26T06:23:29Z", "is_private": false, "attachment_id": null}, {"attachment_id": 19319, "tags": [], "bug_id": 40162, "text": "Created attachment 19319\nTest War file\n\nWith this war file the bug occurs within Eclipse and Tomcat 5.5.17 in debug\nmode.\n\nIt does not occur if not in debug mode.", "count": 2, "id": 97419, "time": "2006-12-28T09:52:06Z", "creator": "horst@scheruga.net", "creation_time": "2006-12-28T09:52:06Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 40162, "attachment_id": 19320, "id": 97420, "time": "2006-12-28T10:03:45Z", "creator": "horst@scheruga.net", "creation_time": "2006-12-28T10:03:45Z", "is_private": false, "text": "Created attachment 19320\nTestfiles"}, {"count": 4, "tags": [], "bug_id": 40162, "attachment_id": null, "id": 97421, "time": "2006-12-28T10:06:48Z", "creator": "horst@scheruga.net", "creation_time": "2006-12-28T10:06:48Z", "is_private": false, "text": "A Zip file with a ReadMe.txt within is now attached.\nIt describes how to produce the bug.\n\nA WAR file is not sufficient, since the class files need to be loaded form the \nshared directory of the tomcat installation.\n"}, {"count": 5, "tags": [], "bug_id": 40162, "text": "For future reference, when providing test cases please include the source. Without the source we either have to guess what the test case is doing or use a tool like JAD.\n\nThis isn't going to work out of the box without some additional work on your part. Take a look at the code in the org.apache.naming package, particularly SelectorContext, ContextBindings and java.javaURLContextFactory\n\nAlternatively, a simpler solution would be to move the shared code to your web application. Disk and memory is cheap and a good build tool (eg Ant) will let you keep a single copy of the code, whilst using it in multiple locations.\n\nIf you have any further questions, please ask on the Tomcat users list.", "id": 128822, "time": "2009-07-14T00:11:40Z", "creator": "markt@apache.org", "creation_time": "2009-07-14T00:11:40Z", "is_private": false, "attachment_id": null}, {"attachment_id": 23974, "tags": [], "bug_id": 40162, "text": "Created attachment 23974\ntest web application with source and ant build file", "count": 6, "id": 128825, "time": "2009-07-14T03:10:59Z", "creator": "horst@scheruga.net", "creation_time": "2009-07-14T03:10:59Z", "is_private": false}, {"count": 7, "text": "(In reply to comment #5)\n\nSorry for forgetting to attach the source code.\nI corrected the attachment to contain the source and an ant build file.\n\nUsing the shared directory instead of putting the files to each web application is allows sometimes easier release management and development.", "creator": "horst@scheruga.net", "attachment_id": null, "id": 128826, "time": "2009-07-14T03:11:48Z", "bug_id": 40162, "creation_time": "2009-07-14T03:11:48Z", "tags": [], "is_private": false}, {"count": 8, "tags": [], "bug_id": 40162, "text": "You cannot do what you are trying.\n\nOnce a Web Application is stopped, its resources are to be available for garbage collection, that includes their classloader, context etc. Thus all references to them in global objects are being cleared.\n\nIn your example you expect that the Runnable will obtain the InitialContext that belongs to the web application. There is a race condition, but in most cases it won't be able to obtain it, because to get it you should go through some static methods, use some global lookup table, and the references there are already cleared.\nAnd even if it can, I think that there is no guarantee that the Context will be usable at that time.\n\n\nTo dig into the code, see o.a.naming.java.javaURLContextFactory#getInitialContext() and o.a.naming.ContextBindings#unbindClassLoader(..)\nWell, Mark already mentioned those classes.\n\n\nI do not know, where \"shared\" code comes into the play. I do not believe that moving the code into webapp will fix/workaround this.", "id": 128858, "time": "2009-07-14T19:58:30Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2009-07-14T19:58:30Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "creator": "horst@scheruga.net", "attachment_id": null, "text": "(In reply to comment #8)\n\nFinding a workaround for my problem is not so hard.\n\nIn the Servlet.init() method I store the Jndi Context value I need into a String.\n\nFor retrieving the JndiContext I use the attached JndiContext class, which has an instance variable of type InheritableThreadLocal, which is used if the Jndi context does not deliver the needed values\n\nIn Servlet.destroy() I set the stored String into the JndiContext class.\n\n---\nHowever the servlets destroy() methods should be called by tomcat BEFORE the resources of a web application are released.", "id": 128865, "time": "2009-07-15T04:41:28Z", "bug_id": 40162, "creation_time": "2009-07-15T04:41:28Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 40162, "text": "Created attachment 23986\nJndiContext workaorund class", "id": 128866, "time": "2009-07-15T04:45:24Z", "creator": "horst@scheruga.net", "creation_time": "2009-07-15T04:45:24Z", "is_private": false, "attachment_id": 23986}, {"count": 11, "tags": [], "text": "(In reply to comment #9)\n> However the servlets destroy() methods should be called by tomcat BEFORE the\n> resources of a web application are released.\n\nIt *is* called BEFORE.  It is your Runnable that runs *AFTER* those are released. If you need additional threads, write a Listener and terminate/wait for them before the webapp stops.", "attachment_id": null, "id": 128872, "creator": "knst.kolinko@gmail.com", "time": "2009-07-15T05:51:54Z", "bug_id": 40162, "creation_time": "2009-07-15T05:51:54Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 40162, "text": "(In reply to comment #11)\nOf cource you are right!\nThanks for pointing that out for me.\n\nSorry for taking your time.", "count": 12, "id": 128910, "time": "2009-07-16T06:47:35Z", "creator": "horst@scheruga.net", "creation_time": "2009-07-16T06:47:35Z", "is_private": false}]