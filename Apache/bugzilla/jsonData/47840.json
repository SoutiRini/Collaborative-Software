[{"count": 0, "tags": [], "bug_id": 47840, "text": "Created attachment 24264\npatch for jk_lb_worker.c\n\nI use the domain directive in workers.properties, and output the actual worker\nname to the log.\n\n<<workers.properties>>\n worker.foo.domain=dom01\n worker.foo.route=node01\n ...\n worker.bar.domain=dom01\n worker.bar.route=node02\n ...\n worker.lb.balance_workers=foo, bar\n ...\n\n<<log setting>>\n * Use %R:\n  JkRequestLogFormat \"%w(%R) %V %T\"\nor\n * Use JK_WORKER_NAME:\n  LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\n\\\"%{JK_WORKER_ROUTE}n\\\"\" combined\n\n\nI expected that an actual worker name was \"dom01\".\nHowever, \"4+\" was output to the log as a worker name.\n\n<<mod_jk.log>>\n[Mon Sep 14 14:27:31.700 2009] wlb(4+) localhost 0.003631\n\n<<access_log>>\n127.0.0.1 - - [14/Sep/2009:14:27:31 +0900] \"GET /test.jsp HTTP/1.1\" 200 1596\n\"http://localhost/index.jsp\" \"ELinks/0.11.1 (textmode; Linux; 80x24-2)\" \"4+\"\n\nWhen \"end->service()\" is executed, wr.domain is initialized.\n\nI attached the patch.\n\nregards.", "id": 130393, "time": "2009-09-14T20:45:35Z", "creator": "mashmk02@gmail.com", "creation_time": "2009-09-14T20:45:35Z", "is_private": false, "attachment_id": 24264}, {"count": 1, "attachment_id": 24265, "creator": "mashmk02@gmail.com", "is_private": false, "id": 130394, "time": "2009-09-14T20:48:56Z", "bug_id": 47840, "creation_time": "2009-09-14T20:48:56Z", "tags": [], "text": "Created attachment 24265\npatch for jk_lb_worker.c\n\nOops, sorry. I attached incorrect file."}, {"count": 2, "tags": [], "bug_id": 47840, "attachment_id": null, "is_private": false, "id": 130523, "time": "2009-09-18T19:35:24Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2009-09-18T19:35:24Z", "text": "I think your patch doesn't help. I analyzed the problem and came up with another solution. Would you please try the below patch and see if it fixes the problem for you:\n\nIndex: common/jk_lb_worker.c\n===================================================================\n--- common/jk_lb_worker.c       (revision 810065)\n+++ common/jk_lb_worker.c       (working copy)\n@@ -840,7 +840,11 @@\n             }\n             else if (*wr.domain && !uses_domain) {\n                 candidate = find_best_bydomain(s, p, wr.domain, states, l);\n-                s->route = wr.domain;\n+                if (candidate >= 0) {\n+                    s->route = wr.domain;\n+                } else {\n+                    s->route = NULL;\n+                }\n             }\n             if (candidate >= 0) {\n                 wr = p->lb_workers[candidate];"}, {"count": 3, "tags": [], "text": "I used your patch. However, the problem still remains.\n\n---\nI am setting jvmRoute of Tomcat as follows.\nTomcat-1\n <Engine name=\"Catalina\" defaultHost=\"localhost\" jvmRoute=\"dom01.node01\">\nTomcat-2\n <Engine name=\"Catalina\" defaultHost=\"localhost\" jvmRoute=\"dom01.node02\">\n\nIn this case, Tomcat returns the following sessionsid. \n JSESSIONID=xxxxxxx.dom01.node01\n or\n JSESSIONID=xxxxxxx.dom01.node02\n\nWhen a browser sends these sessionid, the following codes are not executed. \n    828         if (!JK_WORKER_USABLE_STICKY(states[wr.i], activation)) {\n    829             /* We have a worker that is error state or stopped.\n    830              * If it has a redirection set use that redirection worker.\n    831              * This enables to safely remove the member from the\n    832              * balancer. Of course you will need a some kind of\n    833              * session replication between those two remote.\n    834              */\n    835             if (p->sticky_session_force)\n\nBecause,\n * Line 813: find_by_session returns -1.\n  * session_route = \"dom01.node01\" or \"dom01.node02\"\n  * lb_workers[i].route = \"node01\" or \"node02\"\n\n * Line 816: find_best_bydomain returns 0 or 1.\n  * session_route = \"dom01.node01\"(or \"dom01.node02\"), and domain_len = 5\n  * wr.domain = \"dom01\"\n\n * JK_WORKER_USABLE_STICKY is true.\n  * lb status is JK_LB_STATE_OK\n  * activation is JK_LB_ACTIVATION_ACTIVE\n\n    804 static int find_bysession_route(jk_ws_service_t *s,\n    805                                 lb_worker_t *p,\n    806                                 const char *session_route,\n    807                                 int *states,\n    808                                 jk_logger_t *l)\n    809 {\n    810     int uses_domain  = 0;\n    811     int candidate = -1;\n    812\n    813     candidate = find_by_session(s, p, session_route, l);\n    814     if (candidate < 0) {\n    815         uses_domain = 1;\n    816         candidate = find_best_bydomain(s, p, session_route, states, l);\n    817     }\n\ns->route is set by the following codes. \n    821         if (uses_domain)\n    822             s->route = wr.domain;\n\nBest regards.", "is_private": false, "id": 130718, "creator": "mashmk02@gmail.com", "time": "2009-09-28T01:52:18Z", "bug_id": 47840, "creation_time": "2009-09-28T01:52:18Z", "attachment_id": null}, {"count": 4, "attachment_id": null, "creator": "rainer.jung@kippdata.de", "text": "Is this resolved using version 1.2.30?", "id": 135807, "time": "2010-03-31T07:05:45Z", "bug_id": 47840, "creation_time": "2010-03-31T07:05:45Z", "tags": [], "is_private": false}, {"count": 5, "attachment_id": null, "creator": "mashmk02@gmail.com", "is_private": false, "id": 135829, "time": "2010-04-01T00:27:11Z", "bug_id": 47840, "creation_time": "2010-04-01T00:27:11Z", "tags": [], "text": "(In reply to comment #4)\n> Is this resolved using version 1.2.30?\nI used 1.2.31-dev. However, the result was same. \n\n<<access_log>>\n127.0.0.1 - - [01/Apr/2010:09:26:00 +0900] \"GET /jbpm-console/app/processes.jsf HTTP/1.1\" 200 2034 \"http://localhost/\" \"Mozilla/5.0 (X11; U; Linux x86_64; ja; rv:1.9.0.18) Gecko/2010021718 CentOS/3.0.18-1.el5.centos Firefox/3.0.18\" \"\\x04+\" 1FB9719A77AE75C661E6F83E24AFAADF.dom01.testnode01\n\n<<mod_jk.log>>\n[Thu Apr 01 09:26:00 2010]lb1(^D+) localhost 0.027254\n\nregards."}, {"count": 6, "attachment_id": null, "creator": "rainer.jung@kippdata.de", "text": "Eiji: Does this problem still exist in 1.2.32?", "id": 150916, "time": "2011-10-25T19:12:18Z", "bug_id": 47840, "creation_time": "2011-10-25T19:12:18Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "creator": "rainer.jung@kippdata.de", "text": "I think this was fixed recently in r1646958:\n\nCopy instead of reference another log note.\n\nValue was taken from service struct which\ndoesn't live until logging phase.\n\nI observed a similar issue with another log note I was able to analyze and explain looking at the life cycle of the service struct.\n\nThe fix will be part of version 1.2.41.", "id": 179976, "time": "2014-12-22T19:55:19Z", "bug_id": 47840, "creation_time": "2014-12-22T19:55:19Z", "is_private": false, "attachment_id": null}]