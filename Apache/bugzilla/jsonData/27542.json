[{"attachment_id": null, "tags": [], "creator": "white@extrasy.net", "text": "This bug pretty much interconnects with the following one \nhttp://archive.apache.org/gnats/304, although, it's dated 1997 and marked as \nfixed.\n\nThere is a problem with mod_proxy when it tries to connect (forward, internal \nproxy) to the domain name, which points to several IP addresses.  Technically, \nit appears when I'm trying to use mod_rewrite RewriteRule with the internal \nproxying facility.  I am still not very sure who's an originator of the \nproblem, mod_rewrite or mod_proxy.\n\nEg. I'm using the mod_rewrite with [proxy|P] directive to have the internal \nproxying for the specific address to http://www.domain.com/. But the domain \nhttp://www.domain.com/ points to several IP addresses, which is used for fail-\nover and (or?) some kind of load-balancing, eg.:\n\nwww.domain.com. IN A 10.0.10.1\n                IN A 10.0.10.2\n                IN A 10.0.10.3\n\nSome of IPs generate connection reset, and supposedly mod_proxy should try \nanother IP address to connect. Unfortunetly, it does not this, and if it \nrecieves connection reset before the correct answer (eg. it tried broken \naddress before the working one) mod_proxy just hangs up with the nasty 502 \nerror like this one:\n\nProxy Error\nThe proxy server received an invalid response from an upstream server.\nThe proxy server could not handle the request GET /test/1231.\n\nReason: Could not connect to remote machine: Invalid argument\n\nand the log file says:\n\n[Tue Mar 9 06:30:25 2004] [error] [client 1.2.59.190] (22)Invalid argument: \nproxy connect to 10.0.10.1 port 80 failed\n\nLikely, IE, Squid and a lot of different browsers and proxies handle this \nsituation just fine, but not mod_proxy. Yes, I am aware that this is not RFC-\ndocumented way of handling such situation, but looks pretty reasonable.", "count": 0, "id": 53727, "time": "2004-03-09T15:29:53Z", "bug_id": 27542, "creation_time": "2004-03-09T15:29:53Z", "is_private": false}, {"count": 1, "tags": [], "creator": "white@extrasy.net", "attachment_id": null, "text": "As I discovered, it looks like mod_proxy problem, but not mod_rewrite one.", "id": 53791, "time": "2004-03-10T09:11:49Z", "bug_id": 27542, "creation_time": "2004-03-10T09:11:49Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "white@extrasy.net", "text": "Actually, as it comes from the debug logs mod_proxy tries to do other \nconnections after it receives \"Connection refused\" or \"Operation timed out\", \nbut somehow hangs up with \"Invalid argument\" parameter.\n\n[Wed Mar 10 02:56:24 2004] [error] [client 3.10.112.130] (61)Connection \nrefused: proxy connect to 3.22.185.120 port 80 failed\n[Wed Mar 10 02:56:24 2004] [error] [client 3.10.112.130] (22)Invalid argument: \nproxy connect to 3.10.112.131 port 80 failed\n[Wed Mar 10 02:56:24 2004] [error] [client 3.10.112.130] (22)Invalid argument: \nproxy connect to 3.22.185.108 port 80 failed\n[Wed Mar 10 02:56:24 2004] [error] [client 3.10.112.130] (22)Invalid argument: \nproxy connect to 3.22.185.99 port 80 failed\n", "count": 2, "id": 53792, "time": "2004-03-10T09:59:15Z", "bug_id": 27542, "creation_time": "2004-03-10T09:59:15Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 27542, "is_private": false, "text": "Likely I fixed this.  I'd much appreciate if this will be commited to the \nsource tree - I am not happy applying patches every time when I rebuild a \nsystem. :)\n\n--- proxy_http.c.orig   Wed Mar 10 05:34:43 2004\n+++ proxy_http.c        Wed Mar 10 05:35:00 2004\n@@ -278,6 +278,8 @@\n         i = ap_proxy_doconnect(sock, &server, r);\n         if (i == 0)\n             break;\n+       /* Even if the connection was unsuccesful we should reinit the socket */\n+       sock = ap_psocket_ex(p, PF_INET, SOCK_STREAM, IPPROTO_TCP, 1);\n         j++;\n     }\n #endif\n", "id": 53797, "time": "2004-03-10T12:38:14Z", "creator": "white@extrasy.net", "creation_time": "2004-03-10T12:38:14Z", "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 27542, "is_private": false, "text": "noting that a patch is available for review\n\nre-opening; not considered resolved/fixed/whatever until a fix is in CVS", "id": 53798, "time": "2004-03-10T12:41:13Z", "creator": "trawick@apache.org", "creation_time": "2004-03-10T12:41:13Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "trawick@apache.org", "text": "patch looks good here; when it gets applied the fix needs to be propagated to\nthe \"#ifdef SINIX_D_RESOLVER_BUG\" path\n\nwhile not absolutely required, it would be reasonable to go ahead and close the\nnow-unusable socket via ap_pclosesocket() rather than wait for pool cleanup; \n", "count": 5, "id": 53801, "time": "2004-03-10T13:03:02Z", "bug_id": 27542, "creation_time": "2004-03-10T13:03:02Z", "is_private": false}]