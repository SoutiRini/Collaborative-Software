[{"count": 0, "tags": [], "text": "Vaadin 7.4.2 webapp runs perfectly in Tomcat 8.0.20 repeatedly evokes IllegalStateException in Tomcat 8.0.21:\n\nException in thread \"WebSocketServer-localhost-/vfc-6\" java.lang.IllegalStateException: When sending a fragmented message, all fragments bust be of the same type\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.writeMessagePart(WsRemoteEndpointImplBase.java:411)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.endMessage(WsRemoteEndpointImplBase.java:366)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase$IntermediateMessageHandler.onResult(WsRemoteEndpointImplBase.java:513)\n\tat org.apache.tomcat.websocket.server.WsRemoteEndpointImplServer$OnResultRunnable.run(WsRemoteEndpointImplServer.java:247)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat java.lang.Thread.run(Thread.java:745)\n\nRolling back to 8.0.20 but retaining Tomcat Native 1.1.33 restores error-free webapp operation.  I haven't isolated a simple example as the webapp mostly works and I don't yet know what triggers the error.  The offending function generates new threads, access a database, creates various forms and uses WebSocket to push data to other user interfaces.  I understand I have provided insufficient information to qualify as a bug report, but please take it as a data point, in case you receive other similar reports.", "is_private": false, "id": 182176, "creator": "steve.demy@shaw.ca", "time": "2015-03-29T04:45:43Z", "bug_id": 57776, "creation_time": "2015-03-29T04:45:43Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 57776, "text": "Are you using perMessageDeflate ?", "id": 182193, "time": "2015-03-31T10:44:11Z", "creator": "markt@apache.org", "creation_time": "2015-03-31T10:44:11Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 57776, "text": "Thanks for the report. It was sketchy in terms of reproduction but there was enough information to pin-point a suspect commit. From there it was fairly easy to see what had gone wrong.\n\nA fix for a problem in trunk was incorrect. It fixed the blocking case which was broken in trunk but broke the non-blocking case. The back-port then broke the perMessage-deflate if compression of a single message part resulted in multiple message parts.\n\nThe original issue has been fixed in trunk and the regression / incorrect fix reverted in 8.0.x for 8.0.22 onwards and 7.0.x for 7.0.62 onwards.", "id": 182201, "time": "2015-03-31T17:21:06Z", "creator": "markt@apache.org", "creation_time": "2015-03-31T17:21:06Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 57776, "text": "Thanks Mark for taking the time to convert my limited insight into a solution.", "id": 182205, "time": "2015-03-31T20:43:15Z", "creator": "steve.demy@shaw.ca", "creation_time": "2015-03-31T20:43:15Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "*** Bug 57831 has been marked as a duplicate of this bug. ***", "id": 182483, "time": "2015-04-19T07:38:22Z", "bug_id": 57776, "creation_time": "2015-04-19T07:38:22Z", "is_private": false}]