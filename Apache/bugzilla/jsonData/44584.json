[{"count": 0, "tags": [], "bug_id": 44584, "text": "Created attachment 21654\nPatch for ab.c to check for EINTR\n\nThe ab (apache benchmark) utility creates many connections to the target web server, but ignores the case of EINTR that can be returned by the OS's connect() call. Because of that, it's almost unusable for generating large loads on OSes that actually generate EINTR, like FreeBSD.\n\nFrom connect(2) manual:\n\n     [EINTR]            The connection attempt was interrupted by the delivery\n                        of a signal.  The connection will be established in\n                        the background, as in the case of EINPROGRESS.\n\nThe attached patch simply adds the check for EINTR. This has been verified to work.", "id": 114506, "attachment_id": 21654, "creator": "ivoras@freebsd.org", "creation_time": "2008-03-11T13:45:57Z", "time": "2008-03-11T13:45:57Z", "is_private": false}, {"count": 1, "tags": [], "creator": "fielding@apache.org", "text": "EINTR is checked by apr_socket_connect while making the actual\nsystem call for connect.\n\nIf this isn't working, perhaps a different system call is not\nbeing restarted.  Please grab the latest version of ab.c\nfrom trunk and see if that fixes your issues.\n\nhttp://svn.apache.org/repos/asf/httpd/httpd/trunk/support/ab.c\n\n", "id": 116531, "time": "2008-05-12T14:45:17Z", "bug_id": 44584, "creation_time": "2008-05-12T14:45:17Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 44584, "attachment_id": null, "text": "(In reply to comment #1)\n> EINTR is checked by apr_socket_connect while making the actual\n> system call for connect.\n> \n> If this isn't working, perhaps a different system call is not\n> being restarted.  Please grab the latest version of ab.c\n> from trunk and see if that fixes your issues.\n> \n> http://svn.apache.org/repos/asf/httpd/httpd/trunk/support/ab.c\n> \n\nThe newest version doesn't work:\n\n$ ./ab -c 20 -n 100 http://my.host/\nThis is ApacheBench, Version 2.3 <$Revision$>\nCopyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/\nLicensed to The Apache Software Foundation, http://www.apache.org/\n\nBenchmarking my.host (be patient)...\nTest aborted after 10 failures\n\napr_socket_connect(): Operation already in progress (37)\nTotal of 55 requests completed\n\nIt seems like errno=37 (EALREADY) also needs to be checked:\n\n     37 EALREADY Operation already in progress.  An operation was attempted on\n             a non-blocking object that already had an operation in progress.\n\nThere is no APR_STATUS_IS_EALREADY.", "id": 116535, "time": "2008-05-12T15:40:12Z", "creator": "ivoras@freebsd.org", "creation_time": "2008-05-12T15:40:12Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 44584, "text": "Checked on Apache 2.2.9 release, same error:\n\n# ab -n 1000 -c 4 http://localhost/\nThis is ApacheBench, Version 2.3 <$Revision: 655654 $>\nCopyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/\nLicensed to The Apache Software Foundation, http://www.apache.org/\n\nBenchmarking localhost (be patient)\nCompleted 100 requests\nCompleted 200 requests\nCompleted 300 requests\nCompleted 400 requests\nCompleted 500 requests\n\nTest aborted after 10 failures\n\napr_socket_connect(): Operation already in progress (37)\nTotal of 560 requests completed\n", "id": 118290, "time": "2008-07-04T04:42:46Z", "creator": "ivoras@freebsd.org", "creation_time": "2008-07-04T04:42:46Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "text": "CC myself on FreeBSD related bugs", "attachment_id": null, "id": 124172, "creator": "pgollucci@apache.org", "time": "2009-01-18T16:19:18Z", "bug_id": 44584, "creation_time": "2009-01-18T16:19:18Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 44584, "is_private": false, "text": ">apr_socket_connect(): Operation already in progress (37)\n>Total of 55 requests completed\n\nThis happens on Leopard too and is related to the kqueue usage, so the problem could be in APR.\n\nab occasionally is awoken from kevent() with a notification for a socket which is in the process of connecting but has not yet completed.  ab thinks the condition must mean connect-complete, calls apr_socket_connect(), gets EALREADY (37), and bombs.\n\nMy unproven impression is that ab isn't keeping the pollset minimized (i.e., not removing items from the pollset as soon as it stops needing to be notified for them, but I'm not sure.\n\nFWIW, a hack like this keeps ab going:\n\n             if (rv & APR_POLLOUT) {\n                 if (c->state == STATE_CONNECTING) {\n                     apr_pollfd_t remove_pollfd;\n                     rv = apr_socket_connect(c->aprsock, destsa);\n+                    if (rv == 37) {\n+                        continue;\n+                    }\n                     remove_pollfd.desc_type = APR_POLL_SOCKET;\n                     remove_pollfd.desc.s = c->aprsock;\n                     apr_pollset_remove(readbits, &remove_pollfd);\n", "id": 124181, "time": "2009-01-18T16:51:32Z", "creator": "trawick@apache.org", "creation_time": "2009-01-18T16:51:32Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 44584, "text": "fixed in trunk\n\nChanges were significant, so I have no plans to propose for backport to the 2.2.x branch in the short term.  With some testing/everyday use in trunk on various platforms, it may be appropriate to backport later.", "id": 125263, "attachment_id": null, "creator": "trawick@apache.org", "creation_time": "2009-03-02T13:23:48Z", "time": "2009-03-02T13:23:48Z", "is_private": false}]