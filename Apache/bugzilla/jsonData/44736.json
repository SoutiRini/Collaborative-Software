[{"count": 0, "tags": [], "bug_id": 44736, "is_private": false, "id": 115218, "attachment_id": null, "creator": "vitiho@yahoo.com", "creation_time": "2008-04-01T17:22:50Z", "time": "2008-04-01T17:22:50Z", "text": "I have in my config:\n\n<Virtualhost 10.10.11.108:443>\n        ServerName test\n        DocumentRoot \"/var/www/test/\"\n        ErrorDocument 500 \"/error/50x.php\"\n        ErrorDocument 502 \"/error/50x.php\"\n        ErrorDocument 503 \"/error/50x.php\"\n        ErrorDocument 403 \"/error/403.html\"\n        ErrorDocument 404 \"/error/404.html\"\n        ProxyPass /error/ !\n        ProxyPass /lb/ !\n        RewriteEngine On\n        RewriteRule ^/$ /test/ [R]\n<Location /lb>\n        SetHandler balancer-manager\n</Location>\n        ProxyTimeout 3000\n        KeepAlive Off\n        ProxyPass / balancer://test/ stickysession=JSESSIONID nofailover=On\n        ProxyPassReverse / http://10.10.20.51:8080/\n        ProxyPassReverse / http://10.10.21.51:8080/\n        <Proxy balancer://dashboard/>\n                BalancerMember http://10.10.20.51:8080 route=node1 retry=0\n                BalancerMember http://10.10.21.51:8080 route=node2 retry=0\n        </Proxy>\n        ProxyPreserveHost On\n        ProxyErrorOverride On\n        SSLEngine on\n        SSLCertificateFile /etc/httpd/certs/_.localhost.com.crt\n        SSLCertificateKeyFile /etc/httpd/certs/_.localhost.com.key\n        SSLCertificateChainFile /etc/httpd/certs/some_intermediate.crt\n#       LogLevel debug\n        ErrorLog /var/log/httpd/test.error.log\n        CustomLog /var/log/httpd/test.access.log combined\n</Virtualhost>\n\n\nWhen apache 2.2.8 starts everything works fine and if I go to https://10.10.11.108/lb/\n\nI see something like this:\n\nStickySession\tTimeout\tFailoverAttempts\tMethod\nJSESSIONID\t0\t1 \tbyrequests\n\nWorker URL\tRoute\tRouteRedir\tFactor\tSet\tStatus\tElected\tTo\tFrom\nhttp://10.10.20.51:8080\tnode1\t\t1\t0\tOk\t19013\t19M\t143M\nhttp://10.10.21.51:8080\tnode2\t\t1\t0\tOk\t1602\t752K\t5.1M\n\nHowever sometimes if i modify other virtualhosts and do:\n\n# apachectl graceful\n\nLoad balancer looses stickyness, and if i go to https://10.10.11.108/lb/\n\nI see something like this:\n\nStickySession\tTimeout\tFailoverAttempts\tMethod\nJSESSIONID\t0\t1 \tbyrequests\n\nWorker URL\tRoute\tRouteRedir\tFactor\tSet\tStatus\tElected\tTo\tFrom\nhttp://10.10.20.51:8080\t\t\t0\t0\tOk\t19013\t19M\t143M\nhttp://10.10.21.51:8080\tnode1\t\t1\t0\tOk\t1602\t752K\t5.1M\n\nIf you do: /etc/init.d/httpd restart it works fine."}, {"count": 1, "tags": [], "bug_id": 44736, "attachment_id": null, "text": "Please try with 2.2.9", "id": 119895, "time": "2008-08-18T09:12:47Z", "creator": "jim@apache.org", "creation_time": "2008-08-18T09:12:47Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 44736, "attachment_id": null, "text": "Tried with 2.2.9 still not fixed. I believe my report is a duplicate of this:\nhttps://issues.apache.org/bugzilla/show_bug.cgi?id=42621\n\nFor know my \"simple solution\" is perl wrapper around apache reload. Basically do apachectl graceful, read configs from a perl script and go to balance-manager web page to fix the routes.", "id": 125449, "time": "2009-03-09T12:10:27Z", "creator": "vitiho@yahoo.com", "creation_time": "2009-03-09T12:10:27Z", "is_private": false}, {"count": 3, "attachment_id": null, "bug_id": 44736, "is_private": false, "id": 127179, "time": "2009-05-19T10:49:49Z", "creator": "wrowe@apache.org", "creation_time": "2009-05-19T10:49:49Z", "tags": [], "text": "*** Bug 42621 has been marked as a duplicate of this bug. ***"}, {"count": 4, "tags": [], "creator": "andrew.punch@247realmedia.com", "is_private": false, "text": "Created attachment 26555\nkeepalive.py - Python script to keep an apache process alive indefinitely by using the keepalive issue", "id": 143686, "time": "2011-01-26T20:03:50Z", "bug_id": 44736, "creation_time": "2011-01-26T20:03:50Z", "attachment_id": 26555}, {"count": 5, "tags": [], "creator": "glenn@apache.org", "text": "I have seen the exact same problem with mod_proxy_balancer losing its routes when you do an apachectl graceful. Here is my relevant config:\n\nProxyPass /balancer-manager !\n\n<Proxy balancer://webmail>\n  BalancerMember http://boreas.sp:80 route=boreas loadfactor=1\n  BalancerMember http://chinook.sp:80 route=chinook loadfactor=1\n  BalancerMember http://zephyrus.sp:80 route=zephyrus loadfactor=1\n  ProxySet lbmethod=byrequests\n</Proxy>\nProxyPass / balancer://webmail/ stickysession=WEBMAILID", "id": 145352, "time": "2011-03-28T10:49:56Z", "bug_id": 44736, "creation_time": "2011-03-28T10:49:56Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 44736, "attachment_id": null, "text": "I have seen the exact same problem with mod_proxy_balancer losing its routes when you do an apachectl graceful. Here is my relevant config:\n\nProxyPass /balancer-manager !\n\n<Proxy balancer://webmail>\n  BalancerMember http://boreas.sp:80 route=boreas loadfactor=1\n  BalancerMember http://chinook.sp:80 route=chinook loadfactor=1\n  BalancerMember http://zephyrus.sp:80 route=zephyrus loadfactor=1\n  ProxySet lbmethod=byrequests\n</Proxy>\nProxyPass / balancer://webmail/ stickysession=WEBMAILID\n\nOh, here is the server info (Server runs as a VM in ESX):\n\nFreeBSD kottke.kinetic.more.net 7.3-RELEASE-p2 FreeBSD 7.3-RELEASE-p2 #0: Mon Jul 12 19:23:19 UTC 2010     root@amd64-builder.daemonology.net:/usr/obj/usr/src/sys/GENERIC  amd64 \n\nServer version: Apache/2.2.16 (FreeBSD)\nServer built:   Aug 16 2010 15:38:53", "id": 145353, "time": "2011-03-28T10:53:24Z", "creator": "glenn@apache.org", "creation_time": "2011-03-28T10:53:24Z", "is_private": false}, {"count": 7, "tags": [], "creator": "jim@apache.org", "text": "WONTFIX - 2.2.x does not guarantee local changes via balancer-manager are kept", "id": 148384, "time": "2011-08-04T14:49:40Z", "bug_id": 44736, "creation_time": "2011-08-04T14:49:40Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "r.egglestone@auckland.ac.nz", "is_private": false, "text": "The comment on the WONTFIX above suggests that the issue has been misinterpreted.\n\nThe issue is not that local changes via balancer-manager are being lost, this behaviour is understood.\n\nThe issue is that by making change to the configuration file (no changes to balancer manager), and then doing a graceful restart, the routes can become offset in a way that no longer matches the configured servers.\n\nFor example, if I have this:\n\n<Proxy balancer://balancer1/>\n  BalancerMember http://host1 route=host1\n  BalancerMember http://host2 route=host2\n  BalancerMember http://host3 route=host3\n</Proxy>\n\n... and I comment out host1, then do a graceful restart, I may end up with Apache behaving like this ...\n\nhttp://host2 route=host1\nhttp://host3 route=host2\n\n\nSome observed notes:\n\n+ Problems appear when new balancer blocks are added or removed, or balancer \nmembers are added or removed.\n\n+ The route names can even cross from one balancer configuration block to another!\n\n+ It doesn't always happen, we see it on active systems.\n\n+ A subsequent graceful restart usually fixes the routes.\n\n+ When it does happen, it happens consistently - we have multiple httpd servers polling Subversion for configuration changes, then checking them out and doing a graceful restart. In this situation, all of our httpd servers tend to develop the same route problems at the same time.\n\n\nThis issue has various impacts on applications. In the worst case we saw it cause all traffic for a balancer to be directed to a single balancer member, which couldn't handle the load.", "id": 148394, "time": "2011-08-04T20:57:04Z", "bug_id": 44736, "creation_time": "2011-08-04T20:57:04Z", "attachment_id": null}, {"count": 9, "tags": [], "creator": "bugzilla@boneschanscher.net", "text": "Same here on a busy system changing between one active+hot spare backend servers configuration to a sticky load balanced setup activated by a reload causes node1 and node2 sessions to be routed to node1 first, but after a restart correctly to seperate nodes, which means half of the users loose their session info. Observed workaround is always to do a restart.", "id": 157077, "time": "2012-04-02T20:15:09Z", "bug_id": 44736, "creation_time": "2012-04-02T20:15:09Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "text": "Reproduced on OEL 5 with apache httpd 2.2.17.\nI'll try to reproduce on 2.2.22.", "is_private": false, "id": 158050, "creator": "dario_d_u@unitech.com.ar", "time": "2012-04-13T22:53:22Z", "bug_id": 44736, "creation_time": "2012-04-13T22:53:22Z", "attachment_id": null}, {"count": 11, "attachment_id": null, "bug_id": 44736, "is_private": false, "id": 158839, "time": "2012-05-04T23:21:18Z", "creator": "tarun@reddyemail.com", "creation_time": "2012-05-04T23:21:18Z", "tags": [], "text": "*** Bug 45950 has been marked as a duplicate of this bug. ***"}, {"count": 12, "attachment_id": null, "bug_id": 44736, "text": "I have been able to reproduce this on 2.2.22", "id": 162807, "time": "2012-10-18T01:00:10Z", "creator": "krauseed@gmail.com", "creation_time": "2012-10-18T01:00:10Z", "tags": [], "is_private": false}, {"count": 13, "tags": [], "creator": "jim@apache.org", "text": "Can you check w/ 2.4.x and/or trunk?", "id": 163115, "time": "2012-11-01T14:34:12Z", "bug_id": 44736, "creation_time": "2012-11-01T14:34:12Z", "is_private": false, "attachment_id": null}, {"count": 14, "attachment_id": null, "bug_id": 44736, "text": "Problem still exists with 2.2.24.\n\nI have no idea about 2.4, though. That would be major change in our environment, which we don't intent to do.", "id": 173794, "time": "2014-03-13T13:47:20Z", "creator": "mueller@wave-computer.de", "creation_time": "2014-03-13T13:47:20Z", "tags": [], "is_private": false}, {"count": 15, "tags": [], "creator": "williama_lovaton@coomeva.com.co", "text": "Hi there,\n\nCan this bug be fixed in the 2.2 branch?? I'm using RHEL 6 and it would be a huge and risky move to migrate to apache 2.4.\n\nI have more than 100 virtual hosts in my Apache Reverse Proxy, some of them are balanced with mod_proxy_balancer to backend servers (some are JBoss AJP and some others are Apache/PHP) but the vast majority are simple ProxyPass directives.\n\nThe annoying thing with this bug is that sometimes I need to do little adjustments to the config (eg. add a new ProxyPass directive in an existing vhost), most of the time in vhosts not using the mod_proxy_balancer feature and when I do a graceful for the changes to take effect, sometimes the vhosts using mod_proxy_balancer forget the routes and suddenly all of the clients are redirected to the first server making half of the users lose their sessions and overloading one of the server while the other is idle.\n\nRight now I'm using Apache 2.2.27 and the problem still happens.", "id": 176843, "time": "2014-08-02T00:59:55Z", "bug_id": 44736, "creation_time": "2014-08-02T00:59:55Z", "is_private": false, "attachment_id": null}, {"count": 16, "tags": [], "creator": "mueller@wave-computer.de", "text": "Yes, no one seems to care. Almost like using Oracle software.\nIs at least someone reading this?", "id": 176859, "time": "2014-08-04T08:37:11Z", "bug_id": 44736, "creation_time": "2014-08-04T08:37:11Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 44736, "is_private": false, "count": 17, "id": 176893, "time": "2014-08-04T23:33:13Z", "creator": "trawick@apache.org", "creation_time": "2014-08-04T23:33:13Z", "text": ">Yes, no one seems to care. Almost like using Oracle software.\n>Is at least someone reading this?\n\nHa ha ha!\n\nThe 2.2 answer was given previously:  WONTFIX - 2.2.x does not guarantee local changes via balancer-manager are kept\n\nIf you want to be constructive:\n\nCan someone that needs it on the older release volunteer to confirm that it is resolved on 2.4, as requested some time ago?"}, {"attachment_id": null, "tags": [], "bug_id": 44736, "text": "(In reply to Jeff Trawick from comment #17)\n> >Yes, no one seems to care. Almost like using Oracle software.\n> >Is at least someone reading this?\n> \n> Ha ha ha!\n> \n> The 2.2 answer was given previously:  WONTFIX - 2.2.x does not guarantee\n> local changes via balancer-manager are kept\n> \n> If you want to be constructive:\n> \n> Can someone that needs it on the older release volunteer to confirm that it\n> is resolved on 2.4, as requested some time ago?\n\nThanks Jeff for the answer but that WONTFIX does not apply here.  It is obvious (for me at least) that changes done through the balancer-manager page won't be kept between restarts.  That's totally understandable.\n\nThe thing here is that BalancerMember configuration gets mangled somehow when you issue a graceful.  It sometimes swaps the route name or the loadfactor changes to 0 when the configuration file says loadfactor=1.  The end result of this is that all requests are now sent to one server only.\n\nMy workaround here is to always do a restart instead of a graceful but this is not really a good idea when hundreds of vhosts are going through this reverse proxy (the active requests will be lost abruptly).\n\nUnfortunately no one using 2.2 here is able to confirm that 2.4 fixes the problem.  That at least would be an incentive to take the leap.", "count": 18, "id": 176895, "time": "2014-08-04T23:45:34Z", "creator": "williama_lovaton@coomeva.com.co", "creation_time": "2014-08-04T23:45:34Z", "is_private": false}, {"count": 19, "tags": [], "bug_id": 44736, "attachment_id": null, "is_private": false, "id": 176896, "time": "2014-08-05T00:01:12Z", "creator": "trawick@apache.org", "creation_time": "2014-08-05T00:01:12Z", "text": ">The thing here is that BalancerMember configuration gets mangled \n>somehow when you issue a graceful.  It sometimes swaps the \n>route name or the loadfactor changes to 0 when the configuration \n>file says loadfactor=1.  The end result of this is that all \n>requests are now sent to one server only.\n\nThanks for reiterating that.  (I recall that shared memory setup is different for graceful restart vs. hard restart, but I haven't looked at this particular bug.)"}, {"count": 20, "attachment_id": null, "bug_id": 44736, "text": "We've tested 2.4 in our test environment and couldn't reproduce the reported behavior. Unfortunately it's not possible to update our production environment to 2.4 to validate this with real day by day usage.", "id": 176908, "time": "2014-08-05T05:56:01Z", "creator": "michael.bittorf@heidelberg-mobil.com", "creation_time": "2014-08-05T05:56:01Z", "tags": [], "is_private": false}, {"count": 21, "tags": [], "creator": "mueller@wave-computer.de", "text": "(In reply to William Lovaton from comment #18)\n> (In reply to Jeff Trawick from comment #17)\n> > If you want to be constructive:\n> > \n> > Can someone that needs it on the older release volunteer to confirm that it\n> > is resolved on 2.4, as requested some time ago?\n> \n> Thanks Jeff for the answer but that WONTFIX does not apply here.  It is\n> obvious (for me at least) that changes done through the balancer-manager\n> page won't be kept between restarts.  That's totally understandable.\n> \n> The thing here is that BalancerMember configuration gets mangled somehow\n> when you issue a graceful.  It sometimes swaps the route name or the\n> loadfactor changes to 0 when the configuration file says loadfactor=1.  The\n> end result of this is that all requests are now sent to one server only.\n> \n> My workaround here is to always do a restart instead of a graceful but this\n> is not really a good idea when hundreds of vhosts are going through this\n> reverse proxy (the active requests will be lost abruptly).\n\nThat's exactly the problem. For a restart I would have to take one server out of the load balancing, wait until sessions have finished, restart it, move on to the next server, and so on.\nI just can't do that after every small config change.\n\n> \n> Unfortunately no one using 2.2 here is able to confirm that 2.4 fixes the\n> problem.  That at least would be an incentive to take the leap.\n\nI can't reproduce in our dev environment, because we just don't have multiple backend servers there. I would need to move on production server to 2.4 and rewrite all the vhost configs. If this would be an option, I would have moved everything to 2.4 already.\n\nIf this won't be fixed, we just stick with mod_jk. It's buggy too, and handling of the configuration files sucks, but that's the only alternative.", "id": 176913, "time": "2014-08-05T09:44:15Z", "bug_id": 44736, "creation_time": "2014-08-05T09:44:15Z", "is_private": false, "attachment_id": null}, {"count": 22, "attachment_id": 32086, "bug_id": 44736, "is_private": false, "id": 178318, "time": "2014-10-07T11:24:09Z", "creator": "jkaluza@redhat.com", "creation_time": "2014-10-07T11:24:09Z", "tags": [], "text": "Created attachment 32086\nproposed patch\n\nMatch the shared memory with workers according to their names."}, {"count": 23, "tags": [], "creator": "jkaluza@redhat.com", "text": "Created attachment 32087\nproposed patch v2\n\nMatch the shared memory with workers according to their names.", "id": 178319, "time": "2014-10-07T11:27:35Z", "bug_id": 44736, "creation_time": "2014-10-07T11:27:35Z", "is_private": false, "attachment_id": 32087}, {"count": 24, "tags": [], "creator": "ylavic.dev@gmail.com", "text": "Jan,\nthanks for the patch which seems to work.\nMaybe we could use the apr_md5() of the worker's name to save space in SHM?", "id": 178336, "time": "2014-10-08T10:47:37Z", "bug_id": 44736, "creation_time": "2014-10-08T10:47:37Z", "is_private": false, "attachment_id": null}, {"count": 25, "tags": [], "creator": "jkaluza@redhat.com", "text": "That's good idea. It would also fix the problem of >255 bytes long worker names. Expect the v3 soon.", "id": 178337, "time": "2014-10-08T11:19:16Z", "bug_id": 44736, "creation_time": "2014-10-08T11:19:16Z", "is_private": false, "attachment_id": null}, {"count": 26, "tags": [], "text": "Created attachment 32091\nproposed patch v3\n\nMatch the shared memory with workers according to MD5 hash of their names.", "is_private": false, "id": 178338, "creator": "jkaluza@redhat.com", "time": "2014-10-08T11:39:16Z", "bug_id": 44736, "creation_time": "2014-10-08T11:39:16Z", "attachment_id": 32091}, {"count": 27, "tags": [], "creator": "ylavic.dev@gmail.com", "is_private": false, "id": 178340, "creation_time": "2014-10-08T12:17:26Z", "time": "2014-10-08T12:17:26Z", "bug_id": 44736, "text": "Thanks, looks good.\n\nIsn't the ap_get_scoreboard_lb() call in init_balancer_members() also concerned by this?\n\nDetail: apr_md5() does all the init/update/final in a one go", "attachment_id": null}, {"count": 28, "tags": [], "text": "(In reply to Yann Ylavic from comment #27)\n> Thanks, looks good.\n> \n> Isn't the ap_get_scoreboard_lb() call in init_balancer_members() also\n> concerned by this?\n\nNot sure I understand. I change that ap_get_scoreboard_lb to ap_proxy_get_scoreboard_lb.\n\n> Detail: apr_md5() does all the init/update/final in a one go\n\nDone in next attached patch. Thanks.", "is_private": false, "id": 178341, "creator": "jkaluza@redhat.com", "time": "2014-10-08T12:24:35Z", "bug_id": 44736, "creation_time": "2014-10-08T12:24:35Z", "attachment_id": null}, {"count": 29, "tags": [], "bug_id": 44736, "attachment_id": 32093, "is_private": false, "id": 178342, "time": "2014-10-08T12:25:21Z", "creator": "jkaluza@redhat.com", "creation_time": "2014-10-08T12:25:21Z", "text": "Created attachment 32093\nproposed patch v4\n\nMatch the shared memory with workers according to MD5 hash of their names. Now just with apr_md5()."}, {"count": 30, "tags": [], "bug_id": 44736, "text": "(In reply to jkaluza from comment #28)\n> (In reply to Yann Ylavic from comment #27)\n> > Isn't the ap_get_scoreboard_lb() call in init_balancer_members() also\n> > concerned by this?\n> \n> Not sure I understand. I change that ap_get_scoreboard_lb to\n> ap_proxy_get_scoreboard_lb.\n\nI'm not sure either, but I think this should be done since the purpose is to determine whether the worker has already been initialized based on the status in SHM this time, so that lb parameters are not reset spuriously (below).", "id": 178343, "attachment_id": null, "creator": "ylavic.dev@gmail.com", "creation_time": "2014-10-08T12:33:10Z", "time": "2014-10-08T12:33:10Z", "is_private": false}, {"count": 31, "attachment_id": null, "bug_id": 44736, "text": "I already have it in my patches (or am I missing something)?\n\n-            slot = (proxy_worker_stat *) ap_get_scoreboard_lb(workers->id);\n+            slot = (proxy_worker_stat *) ap_proxy_get_scoreboard_lb(workers);", "id": 178344, "time": "2014-10-08T13:34:18Z", "creator": "jkaluza@redhat.com", "creation_time": "2014-10-08T13:34:18Z", "tags": [], "is_private": false}, {"count": 32, "tags": [], "bug_id": 44736, "is_private": false, "id": 178348, "attachment_id": null, "creator": "ylavic.dev@gmail.com", "creation_time": "2014-10-08T15:10:13Z", "time": "2014-10-08T15:10:13Z", "text": "(In reply to jkaluza from comment #31)\n> I already have it in my patches (or am I missing something)?\n> \n> -            slot = (proxy_worker_stat *) ap_get_scoreboard_lb(workers->id);\n> +            slot = (proxy_worker_stat *)\n> ap_proxy_get_scoreboard_lb(workers);\n\nSorry, it was based on your previous comment, and I didn't update the page to see the latest patch.\n\nMaybe you can add a fast path in ap_proxy_get_scoreboard_lb() with something like :\n\n+void *ap_proxy_set_scoreboard_lb(proxy_worker *worker) {\n+    int i = 0;\n+    proxy_worker_stat *free_slot = NULL;\n+    proxy_worker_stat *s;\n+    unsigned char digest[APR_MD5_DIGESTSIZE];\n+\n+    if (!ap_scoreboard_image) {\n+        return NULL;\n+    }\n     if (worker->s) {\n         return worker->s;\n     }\n+\n+    apr_md5(digest, (const unsigned char *) worker->name,\n+            strlen(worker->name));\n+\n+    /* Try to find out the right shared memory according to the hash\n+     * of worker->name. */\n+    while ((s = (proxy_worker_stat *)ap_get_scoreboard_lb(i++)) != NULL) {\n+        if (memcmp(s->digest, digest, APR_MD5_DIGESTSIZE) == 0) {\n             worker->s = s;\n+            return s;\n+        }\n+        else if (s->status == 0 && free_slot == NULL) {\n+            free_slot = s;\n+        }\n+    }\n+\n+    /* We failed to find out shared memory, so just use free slot */\n     worker->s = free_slot;\n+    return free_slot;\n+}\n\nso that the double call from init_balancer_members() does not hurt.\n(Note that I renamed it ap_proxy_set_scoreboard_lb, according to the changes...)\n\nApologies (again) to propose partial things each time, this is the last one I hope."}, {"count": 33, "attachment_id": 32095, "bug_id": 44736, "is_private": false, "id": 178358, "time": "2014-10-09T06:35:27Z", "creator": "jkaluza@redhat.com", "creation_time": "2014-10-09T06:35:27Z", "tags": [], "text": "Created attachment 32095\nproposed patch v5"}, {"count": 34, "tags": [], "creator": "ylavic.dev@gmail.com", "text": "Created attachment 32098\nproposed patch v6\n\nThis version avoids using ap_proxy_set_scoreboard_lb() in init_balancer_members() when PROXY_HAS_SCOREBOARD is not defined, and sets worker->s (with palloc()ed memory) only if it was not set above with ap_proxy_set_scoreboard_lb().", "id": 178364, "time": "2014-10-09T11:56:24Z", "bug_id": 44736, "creation_time": "2014-10-09T11:56:24Z", "is_private": false, "attachment_id": 32098}, {"count": 35, "tags": [], "text": "Proposed for 2.2.x in r1630402.", "is_private": false, "id": 178366, "creator": "ylavic.dev@gmail.com", "time": "2014-10-09T12:30:23Z", "bug_id": 44736, "creation_time": "2014-10-09T12:30:23Z", "attachment_id": null}, {"count": 36, "attachment_id": null, "bug_id": 44736, "text": "We have tried the patch first in our test environment without any noticeable issues. Today we rolled out the patch with Apache 2.2.29 on our production systems and noticed that the first worker in the balancer was favoured.\n\nWe noticed that the first worker received about 90% or all the requests and the second worker received the leftover 10% while the third and fourth worker received almost no requests.\n\nThe view of one of our balancer-manager's\n\nWorker URL\tRoute\tRouteRedir\tFactor\tSet\tStatus\tElected\tTo\tFrom\nhttp://xrtv1afp\txrtv1a\t\t\t0\t0\tOk\t25944\t20M\t223M\nhttp://xrtv1bfp\txrtv1b\t\t\t0\t0\tOk\t2077\t2.2M\t24M\nhttp://xrtv1cfp\txrtv1c\t\t\t0\t0\tOk\t196\t193K\t1.9M\nhttp://xrtv1dfp\txrtv1d\t\t\t0\t0\tOk\t278\t274K\t1.6M\n\nWe noticed this behaviour on all our updated frontproxies, which range around 150~200 apache instances.\n\nAfter rolling back the patch and staying on the 2.2.29 release the issue was gone.", "id": 178790, "time": "2014-10-28T13:30:40Z", "creator": "issues.apache@blackring.net", "creation_time": "2014-10-28T13:30:40Z", "tags": [], "is_private": false}, {"count": 37, "tags": [], "text": "According to the balancer-manager, the lbfactor seems to be 0. That shouldn't happen.\n\nAre your balancer members also used as standalone workers (eg. same URL used before in a ProxyPass or <Proxy> section in your configuration)?", "is_private": false, "id": 178791, "creator": "ylavic.dev@gmail.com", "time": "2014-10-28T14:28:40Z", "bug_id": 44736, "creation_time": "2014-10-28T14:28:40Z", "attachment_id": null}, {"count": 38, "tags": [], "creator": "williama_lovaton@coomeva.com.co", "is_private": false, "text": "(In reply to Yann Ylavic from comment #37)\n> According to the balancer-manager, the lbfactor seems to be 0. That\n> shouldn't happen.\n> \n> Are your balancer members also used as standalone workers (eg. same URL used\n> before in a ProxyPass or <Proxy> section in your configuration)?\n\nThat's happening to me too after installing a test package for RHEL 6.  There is also another problem I just noticed after the update:\n\nI have two <Proxy balancer> directives in my config for the same domain, one for port 80 and another one for port 443 (the secure connection is not mandatory yet) and before applying the patch both balancer-manager pages showed independent values and stats for plain and secure, now they are showing exactly the same values.  In my case the secure connection used to receive a lot less connections than the unsecure one.\n\nThe config for port 80 is this one:\n\n      Header add Set-Cookie \"ROUTEID=.%{BALANCER_WORKER_ROUTE}e; path=/\" env=BALANCER_ROUTE_CHANGED\n      <Proxy balancer://ciklos-balancer>\n         BalancerMember http://cdplin25.coomeva.nal:80 route=web1 loadfactor=1 retry=0\n         BalancerMember http://cdplin26.coomeva.nal:80 route=web2 loadfactor=1 retry=0\n\n         ProxySet stickysession=ROUTEID\n         ProxySet nofailover=On\n         ProxySet lbmethod=bybusyness\n      </Proxy>\n\n      ProxyPass /balancer-manager !\n      ProxyPass / balancer://ciklos-balancer/\n      ProxyPassReverse / balancer://ciklos-balancer/\n\n\n\nAnd config for port 443 is the following (the only difference is the balancer name):\n\n      Header add Set-Cookie \"ROUTEID=.%{BALANCER_WORKER_ROUTE}e; path=/\" env=BALANCER_ROUTE_CHANGED\n      <Proxy balancer://ssl-ciklos-balancer>\n         BalancerMember http://cdplin25.coomeva.nal:80 route=web1 loadfactor=1 retry=0\n         BalancerMember http://cdplin26.coomeva.nal:80 route=web2 loadfactor=1 retry=0\n\n         ProxySet stickysession=ROUTEID\n         ProxySet nofailover=On\n         ProxySet lbmethod=bybusyness\n      </Proxy>\n\n      ProxyPass /balancer-manager !\n      ProxyPass / balancer://ssl-ciklos-balancer/\n      ProxyPassReverse / balancer://ssl-ciklos-balancer/\n\n\nAlso note that the loadfactor is 1 but the balancer-manager shows 0 in both cases even after a hard stop/start sequence.", "id": 178792, "time": "2014-10-28T14:55:41Z", "bug_id": 44736, "creation_time": "2014-10-28T14:55:41Z", "attachment_id": null}, {"count": 39, "attachment_id": null, "bug_id": 44736, "is_private": false, "id": 178793, "time": "2014-10-28T18:48:02Z", "creator": "issues.apache@blackring.net", "creation_time": "2014-10-28T18:48:02Z", "tags": [], "text": "(In reply to Yann Ylavic from comment #37)\n> According to the balancer-manager, the lbfactor seems to be 0. That\n> shouldn't happen.\n> \n> Are your balancer members also used as standalone workers (eg. same URL used\n> before in a ProxyPass or <Proxy> section in your configuration)?\n\nWe use this type of configuration.\n<Proxy balancer://xrtv1cluster>\n        BalancerMember  http://xrtv1afp route=xrtv1a\n        BalancerMember  http://xrtv1bfp route=xrtv1b\n        BalancerMember  http://xrtv1cfp route=xrtv1c\n        BalancerMember  http://xrtv1dfp route=xrtv1d\n        ProxySet        stickysession=xrtv1balanceid\n</Proxy>\n\nand then we proxypass through the balancer.\n\nProxyPass       /       balancer://xrtv1cluster/\n\nHowever we do request the server-status page every now and then directly from the worker.\nThe lbfactor should be the default (1) and i see that currently (without the patch) it shows this aswel :\n\nWorker URL\tRoute\tRouteRedir\tFactor\tSet\tStatus\tElected\tTo\tFrom\nhttp://xrtv1afp\txrtv1a\t\t\t1\t0\tOk\t9914\t9.6M\t91M\nhttp://xrtv1bfp\txrtv1b\t\t\t1\t0\tOk\t9926\t9.4M\t93M\nhttp://xrtv1cfp\txrtv1c\t\t\t1\t0\tOk\t10063\t9.6M\t102M\nhttp://xrtv1dfp\txrtv1d\t\t\t1\t0\tOk\t9943\t10M\t94M"}, {"attachment_id": 32159, "tags": [], "bug_id": 44736, "is_private": false, "count": 40, "id": 178801, "time": "2014-10-28T23:35:08Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-10-28T23:35:08Z", "text": "Created attachment 32159\nproposed patch v7\n\nThanks for testing and reporting the defect.\n\nThe previous patch missed the (needed) unicity per vhost and per balancer for the workers and balancer members.\n\nThis new patch should fix this.\nCould you please give it a try?"}, {"count": 41, "tags": [], "creator": "ylavic.dev@gmail.com", "text": "(In reply to Yann Ylavic from comment #40)\n> The previous patch missed the (needed) unicity per vhost and per balancer\n> for the workers and balancer members.\ns/unicity/uniqueness/", "id": 178802, "time": "2014-10-28T23:48:04Z", "bug_id": 44736, "creation_time": "2014-10-28T23:48:04Z", "is_private": false, "attachment_id": null}, {"count": 42, "tags": [], "bug_id": 44736, "attachment_id": null, "is_private": false, "id": 178803, "time": "2014-10-28T23:53:35Z", "creator": "williama_lovaton@coomeva.com.co", "creation_time": "2014-10-28T23:53:35Z", "text": "Thanks Yann for your help.\n\nDoes it solve the problem about the load factor being 0 even when it's explicitly set to 1 in the config file?"}, {"count": 43, "tags": [], "bug_id": 44736, "text": "(In reply to William Lovaton from comment #42)\n> Does it solve the problem about the load factor being 0 even when it's\n> explicitly set to 1 in the config file?\n\nYes it should, the balancer member was initialized as a normal worker without the specific balancer parameters (hence those were all 0).\n\nI'd appreciate you can verify this with your configuration though.", "id": 178805, "attachment_id": null, "creator": "ylavic.dev@gmail.com", "creation_time": "2014-10-29T01:23:23Z", "time": "2014-10-29T01:23:23Z", "is_private": false}, {"count": 44, "attachment_id": null, "bug_id": 44736, "is_private": false, "id": 178809, "time": "2014-10-29T08:47:47Z", "creator": "issues.apache@blackring.net", "creation_time": "2014-10-29T08:47:47Z", "tags": [], "text": "we've implemented the new patch in our test environment and used ApacheBenchmark to test the system. \nAs far as we can currently see the new patch works more as intended\nThe lbfactor is set to 1 and also the requests are balanced evenly over the 2 workers.\n\n\nLoadBalancer Status for balancer://xrtv1cluster\n\nStickySession\t\tTimeout\tFailoverAttempts\tMethod\nbalancer://xrtv1cluster\t0\t1\t\t\tbyrequests\n\nWorker URL\t\tRoute\tRouteRedir\tFactor\tSet\tStatus\tElected\tTo\tFrom\nhttp://xrtv1afp-test\txrtv1a\t\t\t1\t0\tOk\t1776\t473K\t626K\nhttp://xrtv1bfp-test\txrtv1b\t\t\t1\t0\tOk\t1775\t473K\t626K"}, {"count": 45, "tags": [], "creator": "ylavic.dev@gmail.com", "is_private": false, "text": "(In reply to Ferry Manders from comment #44)\n> As far as we can currently see the new patch works more as intended\n> The lbfactor is set to 1 and also the requests are balanced evenly over the\n> 2 workers.\n\nThanks for testing, I'll propose this new patch instead of the previous one for 2.2.x backport.", "id": 178814, "time": "2014-10-29T09:44:10Z", "bug_id": 44736, "creation_time": "2014-10-29T09:44:10Z", "attachment_id": null}, {"count": 46, "tags": [], "bug_id": 44736, "attachment_id": null, "is_private": false, "id": 178815, "time": "2014-10-29T10:09:04Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-10-29T10:09:04Z", "text": "Backport proposal (2.2.x) updated in r1635084."}, {"attachment_id": null, "tags": [], "bug_id": 44736, "text": "Fixed in 2.2.30 (r1680920).", "count": 47, "id": 184044, "time": "2015-07-16T07:39:13Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2015-07-16T07:39:13Z", "is_private": false}]