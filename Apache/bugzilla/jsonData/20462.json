[{"attachment_id": null, "tags": [], "creator": "schemers@stanford.edu", "is_private": false, "count": 0, "id": 38302, "time": "2003-06-04T00:48:21Z", "bug_id": 20462, "creation_time": "2003-06-04T00:48:21Z", "text": "My setup:\n\nWindows XP, Service Pack 1\nApache 2.0.46 compiled with VS 7.1 (May 2003 developer CD install)\nmod_ssl with openssl also compiled with VS 7.1\n\nWhen running Apache from the command line or as a service, it consistently will\ncrash upon restart or stopping. In tracking this down with the debug, the crash\nappears to happen when a module is cleaning up data in a pool cleanup handler,\nmost typically when logging debug message.\n\nTo reproduce:\n\nbuild 2.0.46 with mod_ssl\nchange \"LogLevel\" in httpd.conf to \"debug\", so SSL spews a bunch of messages\n(including during module shutdown)\nstart the server\nconnect a few times (might not even be needed)\nstop the server\n\nI've pretty much gotten 100% success rate with it crashing on stops/restarts. It\nseems to be related to the cleanup handlers using something that has been freed\nalready. For example, the last crash I got I set a breakpoint in\nmain.c:destroy_and_exit_process so I could trace from there. It calls\napr_pool_destroy(process->pool), which then starts destroying child-pools.\n\nThe first child-pool it destroys is the \"plog\" pool, which has a pool cleanup\nhandler for the error_log file, so that file handler gets closed. Later on,\nanother pool cleanup handler invokes a handler for mod_ssl, and that module does\nsome ap_log_error calls, but that fails because the error_log file handler is no\nlonger valid.\n\nThe strange thing is is that sometimes ap_log_error is getting called because\nsomething else failed, like ssl_mutex_on(s) will fail because the global SSL\nmutex seems to have been freeed already, and its trying to log an error.\n\nThis seems to be some sort of pool-ordering problem, and I'm not sure if its\nstrictly a mod_ssl issue, a windows issue, or a core server issue with the way\npools getting cleaned up."}, {"attachment_id": null, "tags": [], "creator": "bjorn.wiberg@outlook.com", "is_private": false, "count": 1, "id": 42591, "time": "2003-08-11T23:50:20Z", "bug_id": 20462, "creation_time": "2003-08-11T23:50:20Z", "text": "I have encountered the same problem when adding mod_perl 2.0\n(http://perl.apache.org/dist/mod_perl-2.0-current.tar.gz,\nhttp://perl.apache.org/docs/2.0/os/win32/install.html) or PHP 5.0.0b1\n(http://www.php.net/get/php-5.0.0b1-Win32.zip/from/a/mirror) to Apache 2.0.47,\nalso under Windows XP SP1.\n\nStopping and starting separately (e.g. \"apache -k stop\" followed by \"apache -k\nstart\") doesn't seem to cause a crash on my system, but \"apache -k restart\"\nalmost always does.\n\nIn case of PHP 5.0.0b1, Windows Error Reporting indicates that the error occurs\nin  ntdll.dll:\n\nszAppName : Apache.exe     szAppVer : 2.0.47.0     szModName : ntdll.dll     \nszModVer : 5.1.2600.1217     offset : 00007d85     \n\nBest regards,\nBj\u00f6rn\n"}, {"count": 2, "tags": [], "bug_id": 20462, "text": "Suggesting change of severity according to classification recommendations (\"crashes, loss of data, severe memory leak\").", "id": 42617, "time": "2003-08-12T12:15:42Z", "creator": "bjorn.wiberg@outlook.com", "creation_time": "2003-08-12T12:15:42Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 20462, "text": "*** Bug 17701 has been marked as a duplicate of this bug. ***", "id": 48887, "time": "2003-12-11T10:06:33Z", "creator": "jorton@redhat.com", "creation_time": "2003-12-11T10:06:33Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "jorton@redhat.com", "is_private": false, "id": 48889, "attachment_id": null, "bug_id": 20462, "creation_time": "2003-12-11T10:06:58Z", "time": "2003-12-11T10:06:58Z", "text": "*** Bug 17055 has been marked as a duplicate of this bug. ***"}, {"count": 5, "tags": [], "bug_id": 20462, "is_private": false, "id": 48906, "creation_time": "2003-12-11T14:33:40Z", "time": "2003-12-11T14:33:40Z", "creator": "jorton@redhat.com", "text": "*** Bug 16375 has been marked as a duplicate of this bug. ***", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 20462, "attachment_id": null, "id": 54774, "time": "2004-03-27T21:43:24Z", "creator": "towerofpower@operamail.com", "creation_time": "2004-03-27T21:43:24Z", "is_private": false, "text": "The workaround, of setting LogLevel to above \"warn\", no longer works under \nApache 2.0.49\n\nhttp://nagoya.apache.org/bugzilla/show_bug.cgi?id=17055\n\nadmin@devside.net\nDeveloperSide.NET"}, {"attachment_id": null, "tags": [], "creator": "towerofpower@operamail.com", "is_private": false, "count": 7, "id": 54781, "time": "2004-03-28T02:38:14Z", "bug_id": 20462, "creation_time": "2004-03-28T02:38:14Z", "text": "Here might also be a related problem that I have just encountered.\n\nApache 2.0.49, mod_perl 1.99_13, mod_delfate (zlib 1.1.4), perl 5.8.3\nBuild from source under VS.NET 2002 (msvcr70.dll)\n\nUnder this configuration with PHP 4.3.4 (official binary) nothing is wrong, but \nas soon as I put in PHP 4.3.5 (official binary), and \"NET stop Apache2\" the \nbellow error window pops up...\n\n\nApache.exe - Application Error\nThe instruction at \"0x77fcca36\" referenced memory at \"0x00000000\". The memory \ncould not be \"writen\"\n\n\nhttp://www.devside.net\n\n\n***********************************************************\nDeveloperSide.NET Web-Server NON-SSL Package, version 1.09\n***********************************************************\n\nComponents:\n\nAll built components were compiled under Visual Studio .NET with MSVCR70.dll\n\n(built from source)\n\n\tApache 2.0.49\n\t  mod_deflate (zlib 1.1.4)\n\t  httpd.conf (optimized and minimized, setup for php, cgi, mod_deflate, \nmod_perl)\n\n\tPerl 5.8.3\n\n\tmod_perl 1.99_13\n\n\tMySQL 4.0.18\n\t  DBI\n\t  DBD::mysql\n\t  Net::MySQL\n\t  DBD::mysqlPP\n\n(binary install)\n\n\tPHP 4.3.4\n\t\n\tphpMyAdmin 2.5.6\n\t\n\tanalog 5.32\n\nAdditional Perl Modules (over base)\n\n\tCGI\n\tCompress::Zlib\n\tDBD::mysql\n\tDBD::mysqlPP\n\tDBI\n\tDevel::Symdump\n\tFCGI\n\tHTML::Parser\n\tHTML::Tagset\n\tHTML::Template\n\tImage::Size\n\tNet::MySQL\n\tSOAP::Lite\n\tURI\n\tWin32\n\tlibwww-perl\n\tmod_perl\n\nhttp://www.devside.net/download/nocrypto/pkg/www-1.09.rar\n\n\n***********************************************************\nDeveloperSide.NET Web-Server NON-SSL Package, version 1.09b\n***********************************************************\n\nEverything the same except for PHP 4.3.5 (over 4.3.4)\n\nhttp://www.devside.net/download/nocrypto/pkg/www-1.09b.rar"}, {"attachment_id": null, "tags": [], "creator": "towerofpower@operamail.com", "is_private": false, "count": 8, "id": 54793, "time": "2004-03-28T20:50:14Z", "bug_id": 20462, "creation_time": "2004-03-28T20:50:14Z", "text": "Apache 2.0.49, mod_ssl (OpenSSL 0.9.7d), PHP 4.3.5, mod_perl 1.99_13, \nmod_delfate (zlib 1.1.4), perl 5.8.3\n\nBuild from source under VS.NET 2002 (msvcr70.dll), except PHP 4.3.5\n\n>NTDLL.DLL!77fcca36()\n\nUnhandled exception at 0x77fcca36 in Apache.exe: 0xC0000005: Access violation \nwriting location 0x00000002.\n\nAnd occasionally...\nUnhandled exception at 0x77fcca36 in Apache.exe: 0xC0000005: Access violation \nwriting location 0x00000000."}, {"count": 9, "tags": [], "bug_id": 20462, "text": "*** Bug 28365 has been marked as a duplicate of this bug. ***", "id": 55747, "time": "2004-04-14T08:54:32Z", "creator": "jorton@redhat.com", "creation_time": "2004-04-14T08:54:32Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "creator": "jorton@redhat.com", "text": "*** Bug 26580 has been marked as a duplicate of this bug. ***", "id": 55749, "time": "2004-04-14T08:55:43Z", "bug_id": 20462, "creation_time": "2004-04-14T08:55:43Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "text": "Apache 2.0.49, mod_ssl (OpenSSL 0.9.7d), PHP 4.3.6, mod_perl 1.99_13, \nmod_delfate (zlib 1.1.4), perl 5.8.3\n\nBuild from source under VS.NET 2002 (msvcr70.dll), except PHP 4.3.6\n\nThe newly released PHP 4.3.6 has temporarily \"fixed\" the problems under both \nthe SSL and non-SSL Apache2 builds.  That is, as long as \"LogLevel\" under \nhttpd.conf is set to anything above \"warn\" (I have only tested it with \"error\").\n\nIf not...\n\nApache.exe - Application Error\n\nThe instruction at \"0x77f92373\" referenced memory at \"0x00000010\". The memory \ncould not be \"written\".\n\n\nThe non-SSL Apache2 with PHP 4.3.6 does not seem to exhibit any problems \nwith \"LogLevel\" at \"warn\" (or \"error\").\n\nFor reference, here are the PHP bugs that are related to this thread (I could \nbe wrong)...\n\nhttp://bugs.php.net/bug.php?id=27751\nhttp://bugs.php.net/bug.php?id=27810", "attachment_id": null, "id": 55875, "creation_time": "2004-04-16T07:20:14Z", "time": "2004-04-16T07:20:14Z", "creator": "towerofpower@operamail.com", "bug_id": 20462, "is_private": false}, {"count": 12, "tags": [], "bug_id": 20462, "text": "Under Window2000, I have run Apache 2.0.49, openssl 0.9.7.d with both PHP \n4.3.5 and PHP4.3.6. In both cases, it pops up a error showing \"apache.exe \napplication error\" when stop Apache. Since I run the debug version of both \nApache and PHP, so I was able to see where it is crashed. \n\n---When running php4.3.5, it crashes in PHP. And PHP 4.3.6 seems fix the \nproblem. \n\n-- Running Apache2.0.49 with PHP4.3.6, it does not crash in PHP anymore, when \ntrying to stop Apache, it is very clearly showed that the crash is inside \nApache. It only crashes when MOD_SSL is loaded.  See bug 28365 to detail debug \ndecription of the crash.\n\nIt seems that with 2.0.46, you have to set the loglevel to \"debug\" to see the \ncrash from Apache, but now with 2.0.49, I am still using \"error\" as logLevel, \nbut I can see the crash. So I believe that Apache.2.0.49 have introduced \nsomething that trigger/worsen the problem.\n\n", "id": 55907, "time": "2004-04-16T15:22:45Z", "creator": "shengperson@yahoo.com", "creation_time": "2004-04-16T15:22:45Z", "is_private": false, "attachment_id": null}, {"count": 13, "tags": [], "bug_id": 20462, "is_private": false, "text": "In ssl_engine_init.c, move line  ssl_scache_kill(base_server);\na few lines down as shown below, the probelm seems go away. You can try it out. \nPlease let me know if this fixes the problem you've seen, and also if you know \nof any bad side effect of this change.\n\nIt looks like from Apache 2.0.44 to 2.0.49, the ssl_init_ModuleKill() function \nitself has not been changed. But I am sure that there are underline code \nchanges (which I don't know where) causing later Apache to have this crash \nproblem. Without throughly looking into the change history in Apache, I am not \nsure this change will have any bad side effect(e.g. memory leak, etc..). So \nanybody who have opinon on this, please let me know.\n\nChange made in ssl_engine_init.c to fix the crash: \n\napr_status_t ssl_init_ModuleKill(void *data)\n{\n    SSLSrvConfigRec *sc;\n    server_rec *base_server = (server_rec *)data;\n    server_rec *s;\n\n    \n    /* \n     * Destroy the temporary keys and params\n     */\n    ssl_tmp_keys_free(base_server);\n\n    /*\n     * Free the non-pool allocated structures\n     * in the per-server configurations\n     */\n    for (s = base_server; s; s = s->next) {\n        sc = mySrvConfig(s);\n\n        ssl_init_ctx_cleanup_proxy(sc->proxy);\n\n        ssl_init_ctx_cleanup_server(sc->server);\n    }\n\n    /*\n     * Drop the session cache and mutex\n     */\n    ssl_scache_kill(base_server);\n\n    /*\n     * Try to kill the internals of the SSL library.\n     */\n    ERR_remove_state(0);\n    EVP_cleanup();\n\n    return APR_SUCCESS;\n}\n", "id": 56180, "time": "2004-04-21T16:06:57Z", "creator": "shengperson@yahoo.com", "creation_time": "2004-04-21T16:06:57Z", "attachment_id": null}, {"count": 14, "tags": [], "creator": "zvieger@textfactory.co.at", "text": "Those lines (ssl_callback_DelSessionCacheEntry) are meant as guard - but the \ncondition never comes true when Apache is terminated with SSL-Childs still \nconnected.\n\n\n\n    if (!(s = (server_rec *)SSL_CTX_get_app_data(ctx))) {\n        return; /* on server shutdown Apache is already gone */\n    }\n\nIt runs into logging to an invalid filehandle. Dirty fix in apr_file_write.\n\n    if (thefile->filehand == INVALID_HANDLE_VALUE)\n\t{\n\t\treturn APR_SUCCESS;\n\t}\n\nThe problem is actually a race condition in libeay32::doall_util_fn\n    a=lh->b[i]\n\nleft side ! NULL and right side NULL in while loop - uups\n\nI lack the literacy to fix it prooperly\n\n\nSee stack trace (W2K/SP4/Intel8.0 with VC71 integration 2.0.49:\n\n \tlibapr.dll!apr_thread_mutex_lock(apr_thread_mutex_t * \nmutex=0x00468e28)  Zeile 83 + 0x11\tC\n \tlibapr.dll!apr_file_write(apr_file_t * thefile=0x00468db0, const void * \nbuf=0x0006b91c, unsigned int * nbytes=0x0006b8f4)  Zeile 279\tC\n \tlibapr.dll!apr_file_puts(const char * str=0x0006b91c, apr_file_t * \nthefile=0x00468db0)  Zeile 403 + 0x1c\tC\n \tlibhttpd.dll!log_error_core(const char * const file=0x6fd2673c, int \nline=0x00000062, int level=0x00000004, int status=0x000afc86, const server_rec \n* s=0x004c1640, const request_rec * r=0x00000000, apr_pool_t * pool=0x00000000, \nconst char * const fmt=0x6fd267d0, char * args=0x0006fcc4)  Zeile 534\tC\n \tlibhttpd.dll!ap_log_error(const char * const file=0x6fd2673c, int \nline=0x00000062, int level=0x00000004, int status=0x000afc86, const server_rec \n* s=0x004c1640, const char * const fmt=0x6fd267d0)  Zeile 552 + 0x42\tC\n \tmod_ssl.so!ssl_mutex_on(server_rec * s=0x004c1640)  Zeile 98 + 0x2\n\tC\n \tmod_ssl.so!ssl_scache_dbm_remove(server_rec * s=0x004c1640, unsigned \nchar * id=0x005259c0, int idlen=0x00000020)  Zeile 273 + 0xc\tC\n \tmod_ssl.so!ssl_scache_remove(server_rec * s=0x004c1640, unsigned char * \nid=0x005259c0, int idlen=0x00000020)  Zeile 120 + 0x1c\tC\n \tmod_ssl.so!ssl_callback_DelSessionCacheEntry(ssl_ctx_st * \nctx=0x004fd198, ssl_session_st * session=0x00525978)  Zeile 1708 + 0x1c\tC\n \tssleay32.dll!timeout(ssl_session_st * s=0x00525978, timeout_param_st * \np=0x0006fda8)  Zeile 663 + 0x1c\tC\n \tssleay32.dll!timeout_LHASH_DOALL_ARG(const void * arg1=0x00525978, void \n* arg2=0x0006fda8)  Zeile 668 + 0x3e\tC\n>\tlibeay32.dll!doall_util_fn(lhash_st * lh=0x004fd338, int \nuse_arg=0x00000001, void (const void *, const void *)* func=0x00000000, void \n(const void *, void *, const void *, void *)* func_arg=0x00b9d046, void * \narg=0x0006fda8)  Zeile 287 + 0x17\tC\n \tlibeay32.dll!lh_doall_arg(lhash_st * lh=0x004fd338, void (const void *, \nvoid *, const void *, void *)* func=0x00b9d046, void * arg=0x0006fda8)  Zeile \n302 + 0x2c\tC\n \tssleay32.dll!SSL_CTX_flush_sessions(ssl_ctx_st * s=0x004fd198, long \nt=0x00000000)  Zeile 682 + 0x1d\tC\n \tssleay32.dll!SSL_CTX_free(ssl_ctx_st * a=0x004fd198)  Zeile 1435 + 0x16\n\tC\n \tmod_ssl.so!ssl_init_ctx_cleanup(modssl_ctx_t * mctx=0x004c2e48)  Zeile \n1171 + 0x19\tC\n \tmod_ssl.so!ssl_init_ctx_cleanup_server(modssl_ctx_t * mctx=0x004c2e48)  \nZeile 1187 + 0xc\tC\n \tmod_ssl.so!ssl_init_ModuleKill(void * data=0x0043c180)  Zeile 1226 + 0xf\n\tC\n \tlibapr.dll!run_cleanups(cleanup_t * * cref=0x0043a2f8)  Zeile 1957 + \n0x12\tC\n \tlibapr.dll!apr_pool_destroy(apr_pool_t * pool=0x0043a2e8)  Zeile 734 + \n0xf\tC\n \tlibapr.dll!apr_pool_destroy(apr_pool_t * pool=0x004382b8)  Zeile 727\n\tC\n \tApache.exe!destroy_and_exit_process(process_rec * process=0x00438348, \nint process_exit_value=0x00000000)  Zeile 209\tC\n \tApache.exe!main(int argc=0x00000005, const char * const * \nargv=0x00437d00)  Zeile 624 + 0x19\tC\n \tApache.exe!mainCRTStartup()  Zeile 398 + 0x11\tC\n", "id": 57133, "time": "2004-05-10T19:47:58Z", "bug_id": 20462, "creation_time": "2004-05-10T19:47:58Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "jorton@redhat.com", "is_private": false, "count": 15, "id": 58760, "time": "2004-06-04T14:01:22Z", "bug_id": 20462, "creation_time": "2004-06-04T14:01:22Z", "text": "*** Bug 25575 has been marked as a duplicate of this bug. ***"}]