[{"count": 0, "tags": [], "text": "Noticed this with Apache 2.0.63, but it looks fairly clear that the same problem exists in 2.2.14.\n\nThe way proxy_httpd.c is written, if a keepalive connection is closed by the other side in ap_proxy_http_handler() after ap_proxy_http_create_connection() and before a response is received, Apache will consider this to be a connection error and generate a 502 response.\n\nThis logic is only valid on the first request across the keepalive.  According to the HTTP 1.1 spec, proxy_httpd.c must be capable of handling asynchronous close events in the middle of a keepalive session.  When it encounters an unexpected close it should attempt to reestablish the connection and resend the request before generating a 502 response.", "is_private": false, "bug_id": 48037, "id": 131286, "time": "2009-10-21T16:35:38Z", "creator": "jd@cpanel.net", "creation_time": "2009-10-21T16:35:38Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 48037, "attachment_id": null, "is_private": false, "id": 161222, "time": "2012-08-10T06:39:44Z", "creator": "rpluem@apache.org", "creation_time": "2012-08-10T06:39:44Z", "text": "Please check a recent 2.2.x / 2.4.x. This should have the problem fixed."}, {"count": 2, "tags": [], "bug_id": 48037, "attachment_id": null, "id": 166584, "time": "2013-04-13T18:16:43Z", "creator": "williama_lovaton@coomeva.com.co", "creation_time": "2013-04-13T18:16:43Z", "is_private": false, "text": "Sorry, but this problem is still happening. I'm testing httpd 2.2.23 from http://centos.alt.ru/repository/centos/6/x86_64/ repository on a RHEL 6.4 server.  I was seeing the same problem from official RHEL packages (httpd-2.2.15-26.el6.x86_64.rpm) and updating to 2.2.23 didn't solve the problem.\n\nMy configuration is as follows:\n* Reverse Proxy: RHEL 6.4 with apache 2.2.23 from CentosALT (Worker MPM)\n* Backend Servers: 2 x RHEL 6.2 with apache 2.2.15-15.el6.x86_64 from RHEL (Prefork MPM, huge in-house PHP 5 web app)\n\nI'm using mod proxy balancer to spread the load between the 2 servers with the following configuration:\n\nProxyPreserveHost On\n\n<Proxy balancer://ciklos-balancer>\n   BalancerMember http://10.11.33.35:80 route=web1 redirect=web2 loadfactor=1 retry=0\n   BalancerMember http://10.11.33.36:80 route=web2 redirect=web1 loadfactor=1 retry=0\n\n   ProxySet stickysession=ROUTEID\n   ProxySet nofailover=On\n</Proxy>\n\nProxyPass /balancer-manager !\nProxyPass /server-status !\nProxyPass / balancer://ciklos-balancer/\nProxyPassReverse / balancer://ciklos-balancer/\n\n\nI'm also using mod_disk_cache to cache static data in the Reverse Proxy and the backend servers performs on the fly compression with mod_deflate.\n\nFrom the Reverse Proxy point of view the request is always the first one in the connection, which is keep alive 0 according to %k LogFormat and the response code is HTTP 502.  Now, these requests never gets to the backend server, inspecting both logs I can see the HTTP 502 request in the RP but there is no corresponding request in the backend server.\n\nThe error log shows the following 2 entries:\n[Sat Apr 13 12:27:41 2013] [error] [client 190.248.11.50] (20014)Internal error: proxy: error reading status line from remote server 10.11.33.36:80, referer: http://www.ciklos.com.co/ciklos/php/vista/odontologia/hcOdontologica.php\n[Sat Apr 13 12:27:41 2013] [error] [client 190.248.11.50] proxy: Error reading from remote server returned by /ciklos/ips.php, referer: http://www.ciklos.com.co/ciklos/php/vista/odontologia/hcOdontologica.php\n\nThe problem can be workarounded setting \"force-proxy-request-1.0\" and \"proxy-nokeepalive\" but then I lose the performance benefit from Keep Alive connections.  According to the logs I can get up to 190 keep-alive requests on the same connection from the Reverse Proxy to the backend server (not bad for a low traffic day like Saturdays).\n\nThere is also the option of using \"proxy-initial-not-pooled\" but again there is a performance penalty if you use it.\n\nThe problem doesn't happen so often. On a low traffic day like today I have a total of 432 HTTP 502 requests from a 1'300.000 requests sample.  But still it's something that worries me since it can annoy my users.\n\nWe are trying to replace an old NetScaler appliance which seems to handle Keep Alive connections just fine.\n\nIsn't there a way for mod_proxy_http to retry the request when this error happens? or maybe something else?\n\nThanks a lot for your time."}, {"count": 3, "tags": [], "bug_id": 48037, "attachment_id": null, "id": 168980, "time": "2013-07-31T14:53:30Z", "creator": "simon@nekapuzer.at", "creation_time": "2013-07-31T14:53:30Z", "is_private": false, "text": "We too are seeing this error on 2.2.23\n\nOur ProxyPass setup is very simple:\n\n    ProxyPass  /something  http://localhost:8080/somethingelse/\n\nWe have a high traffic site and get several of those errors every day:\n\n(20014)Internal error: proxy: error reading status line from remote server localhost:8080\nproxy: Error reading from remote server returned by /proxy/foo/bar\n\nThe proxy backend is a jetty6, which has a connection timeout of 200 seconds. We added \"ttl=100\" hoping this would mitigate the problem but I see no change.\n\n\"proxy-initial-not-pooled\" is not a solution for us, since we have KeepAlive disabled in apache (as i understand it, setting this env would thus disable the pooling completely?)"}, {"count": 4, "tags": [], "text": "It would be interesting to retest it with httpd-2.4. There are some changes in mod_proxy_http which could fix this issue.", "attachment_id": null, "id": 170370, "creator": "jkaluza@redhat.com", "time": "2013-10-01T09:57:46Z", "bug_id": 48037, "creation_time": "2013-10-01T09:57:46Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 48037, "attachment_id": 33423, "is_private": false, "id": 187538, "time": "2016-01-11T11:30:34Z", "creator": "helen@helresa.com", "creation_time": "2016-01-11T11:30:34Z", "text": "Created attachment 33423\nserver config files"}, {"count": 6, "tags": [], "text": "Created attachment 33424\nServer Config files", "is_private": false, "bug_id": 48037, "id": 187539, "time": "2016-01-11T11:32:10Z", "creator": "helen@helresa.com", "creation_time": "2016-01-11T11:32:10Z", "attachment_id": 33424}, {"count": 7, "tags": [], "text": "Hi \nWe are currently load testing a apache cacheing proxy server as part of an aws system.\n\nApache version : Apache/2.4.16 (Amazon) (Server built: Aug 13 2015 23:52:13)\n\nDuring testing we would get the following errors intermittently:\n\n[Sat Jan 09 15:15:00.220878 2016] [proxy_http:error] [pid 2538:tid (20014)Internal error: [client 52.62.36.40] AH01102: error reading status line from remote server xxxxxxxxxxx.s3-website-us-east-1.amazonaws.com:80\n\nthese errors result in 504 errors from the Amazon elbs\n\nSetting the following fixed the problem:\n SetEnv force-proxy-request-1.0 1\n SetEnv proxy-nokeepalive 1\n\n\nIf I am not mistaken this is the same problem as noted previously so it is still present in 2.4\n\nattached config files", "is_private": false, "bug_id": 48037, "id": 187540, "time": "2016-01-11T11:33:31Z", "creator": "helen@helresa.com", "creation_time": "2016-01-11T11:33:31Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 48037, "attachment_id": null, "is_private": false, "id": 187542, "time": "2016-01-11T12:13:54Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2016-01-11T12:13:54Z", "text": "Does it happen if you configure a TTL for the proxy connections?\n\nFor example: ProxyPass / http://my.example.com/\" ttl=<TTL>\nwhere <TTL> is lower (say 1 second) than the KeepAliveTimeout configured on the backend server."}, {"count": 9, "tags": [], "text": "(In reply to Yann Ylavic from comment #8)\n> For example: ProxyPass / http://my.example.com/\" ttl=<TTL>\nPlease ignore this spurious double-quote         ^", "attachment_id": null, "id": 187543, "creator": "ylavic.dev@gmail.com", "time": "2016-01-11T12:19:57Z", "bug_id": 48037, "creation_time": "2016-01-11T12:19:57Z", "is_private": false}, {"count": 10, "tags": [], "text": "(In reply to Yann Ylavic from comment #9)\n> (In reply to Yann Ylavic from comment #8)\n> > For example: ProxyPass / http://my.example.com/\" ttl=<TTL>\n> Please ignore this spurious double-quote         ^\n\nAs the backend server is aws s3 there is no configuration for it so I don't know what the keepalive timeout is for this. I could make a guess that it is set to something like 60 sec but I have no idea.", "attachment_id": null, "id": 187544, "creator": "helen@helresa.com", "time": "2016-01-11T12:34:29Z", "bug_id": 48037, "creation_time": "2016-01-11T12:34:29Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 48037, "attachment_id": null, "id": 187545, "time": "2016-01-11T12:51:37Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2016-01-11T12:51:37Z", "is_private": false, "text": "Well, I guess in that case a guess is needed.\nThere is nothing mod_proxy can do to avoid a race condition when the backend closes the connection while the next request is being sent on that same connection (and it can't either send the same request twice because requests are often non-idempotent).\nThus this must be addressed by configuring the correct TTL at the proxy, that is value lower than the keepalive timeout used at the backend, so that the race condition never happens.\nSince the KeepaliveTimeout is an idle timeout (in between requests), it is generally lower than the 60s you mention, so I'd suggest something like 4s to start with (for the proxy's TTL), and see if that helps..."}, {"count": 12, "tags": [], "bug_id": 48037, "attachment_id": null, "is_private": false, "id": 187546, "time": "2016-01-11T13:02:20Z", "creator": "helen@helresa.com", "creation_time": "2016-01-11T13:02:20Z", "text": "Ok I will try that in a bit - in the middle of an hour long load run at the moment--"}, {"count": 13, "tags": [], "bug_id": 48037, "attachment_id": null, "is_private": false, "id": 187554, "time": "2016-01-11T18:36:45Z", "creator": "helen@helresa.com", "creation_time": "2016-01-11T18:36:45Z", "text": "Ran with ttl=5 and ttl=1 both generated errors,\nOnly setting:\n\nSetEnv force-proxy-request-1.0 1\nSetEnv proxy-nokeepalive 1\n\nStops the errors"}, {"count": 14, "tags": [], "bug_id": 48037, "attachment_id": null, "is_private": false, "id": 189239, "time": "2016-03-07T21:25:37Z", "creator": "jim@apache.org", "creation_time": "2016-03-07T21:25:37Z", "text": "You could also setup IgnoreErrors, which should automatically retry the current connection."}, {"count": 15, "tags": [], "bug_id": 48037, "attachment_id": null, "id": 192757, "time": "2016-08-01T03:04:50Z", "creator": "vinci@protonmail.ch", "creation_time": "2016-08-01T03:04:50Z", "is_private": false, "text": "I am getting intermittent failures with errors like :-\n\n[Sun Jul 31 10:53:17.579566 2016] [proxy_http:error] [pid 42678] (103)Software caused connection abort: [client <ip>:<port>] AH01102: error reading status line from remote server <ip>:<port>, referer: <url>\n\n\nOther than this i also keep getting errors like :-\n\n[Sun Jul 31 21:06:11.629845 2016] [proxy_http:error] [pid 19153] (104)Connection reset by peer: [client <client_ip>:<port>] AH01095: prefetch request body failed to <backend_ip>:<port> (<backend_ip>) from <client_ip> (), referer: <url>\n\nit happens for like 1 request in a 1000.\n\nI am running httpd 2.4.18 on CentOS 6.8 and Back-end is jetty 9.3 which has support for HTTP/1.0, HTTP/1.1.\n\nI added \"SetEnv proxy-nokeepalive 1\" to disable keepalives, but i am still having these errors.\n\nShould i also add?\n\n\"SetEnv force-proxy-request-1.0 1\"\n\nMay I know why it is suggested to force use http/1.0 when the issue is just with keepalives?\n\nAny other suggestions to avoid these errors?\n\nThanks."}]