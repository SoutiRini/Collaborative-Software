[{"count": 0, "tags": [], "text": "FOUND A JAVA LEVEL DEADLOCK:\n----------------------------\n\"Thread-9\":\n  waiting to lock monitor 0x80231c (object 0x2a04e20, a\norg.apache.catalina.loader.WebappClassLoader$ResourceEntry),\n  which is locked by \"task\"\n\"task\":\n  waiting to lock monitor 0x8022bc (object 0x2d92dd8, a\norg.apache.catalina.loader.WebappClassLoader),\n  which is locked by \"Thread-9\"\n\nJAVA STACK INFORMATION FOR THREADS LISTED ABOVE:\n------------------------------------------------\nJava Stack for \"Thread-9\":\n==========\n        at\norg.apache.catalina.loader.WebappClassLoader.findClassInternal(WebappClassLoader.java:1660)\n        - waiting to lock <2a04e20> (a\norg.apache.catalina.loader.WebappClassLoader$ResourceEntry)\n        at\norg.apache.catalina.loader.WebappClassLoader.findClass(WebappClassLoader.java:953)\n        at\norg.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1390)\n        at\norg.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1270)\n        at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:310)\n        - locked <2d92dd8> (a org.apache.catalina.loader.WebappClassLoader)\n        at java.lang.ClassLoader.defineClass0(Native Method)\n        at java.lang.ClassLoader.defineClass(ClassLoader.java:488)\n        at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:106)\n        at\norg.apache.catalina.loader.WebappClassLoader.findClassInternal(WebappClassLoader.java:1661)\n        - locked <2a04e60> (a\norg.apache.catalina.loader.WebappClassLoader$ResourceEntry)\n        at\norg.apache.catalina.loader.WebappClassLoader.findClass(WebappClassLoader.java:953)\n        at\norg.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1390)\n        at\norg.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1270)\n        at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:310)\n        - locked <2d92dd8> (a org.apache.catalina.loader.WebappClassLoader)\n        at\nnet.jini.lookup.ServiceDiscoveryManager$LookupCacheImpl.<init>(ServiceDiscoveryManager.java:670)\n        at\nnet.jini.lookup.ServiceDiscoveryManager.createLookupCache(ServiceDiscoveryManager.java:2169)\n        at\nnet.jini.lookup.ServiceDiscoveryManager.createLookupCache(ServiceDiscoveryManager.java:1732)\n        at com.eTapestry.services.ServiceLocator.lookup(ServiceLocator.java:124)\n        at com.eTapestry.services.ServiceLocator.lookup(ServiceLocator.java:76)\n        at com.eTapestry.services.ServiceLocator.lookup(ServiceLocator.java:62)\n        at\ncom.eTapestry.presentation.filters.AuthenticationFilter.validateSignOn(AuthenticationFilter.java:125)\n        at\ncom.eTapestry.presentation.filters.AuthenticationFilter.doFilter(AuthenticationFilter.java:74)\n        at\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:213)\n        at\norg.apache.catalina.core.ApplicationFilterChain.access$0(ApplicationFilterChain.java:197)\n        at\norg.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:176)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:172)\n        at com.eTapestry.servlet.RequestLogFilter.doFilter(RequestLogFilter.java:73)\n        at\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:213)\n        at\norg.apache.catalina.core.ApplicationFilterChain.access$0(ApplicationFilterChain.java:197)\n        at\norg.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:176)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:172)\n        at\norg.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:260)\n        at\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n        at\norg.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n        at org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n        at\norg.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)\n        at\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n        at\norg.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n        at org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n        at\norg.apache.catalina.core.StandardContext.invoke(StandardContext.java:2350)\n        at\norg.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:180)\n        at\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n        at\norg.apache.catalina.valves.ErrorDispatcherValve.invoke(ErrorDispatcherValve.java:170)\n        at\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:641)\n        at\norg.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:171)\n        at\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:641)\n        at\norg.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n        at org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n        at\norg.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:174)\n        at\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n        at\norg.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n        at org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n        at org.apache.coyote.tomcat4.CoyoteAdapter.service(CoyoteAdapter.java:223)\n        at\norg.apache.coyote.http11.Http11Processor.process(Http11Processor.java:405)\n        at\norg.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.processConnection(Http11Protocol.java:380)\n        at\norg.apache.tomcat.util.net.TcpWorkerThread.runIt(PoolTcpEndpoint.java:508)\n        at\norg.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:533)\n        at java.lang.Thread.run(Thread.java:479)\nJava Stack for \"task\":\n==========\n        at java.lang.ClassLoader.checkCerts(ClassLoader.java:530)\n        - waiting to lock <2d92dd8> (a org.apache.catalina.loader.WebappClassLoader)\n        at java.lang.ClassLoader.defineClass(ClassLoader.java:482)\n        at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:106)\n        at\norg.apache.catalina.loader.WebappClassLoader.findClassInternal(WebappClassLoader.java:1661)\n        - locked <2a04e20> (a\norg.apache.catalina.loader.WebappClassLoader$ResourceEntry)\n        at\norg.apache.catalina.loader.WebappClassLoader.findClass(WebappClassLoader.java:953)\n        at\norg.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1390)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:287)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:250)\n        at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:310)\n        - locked <331dc08> (a sun.rmi.server.LoaderHandler$Loader)\n        at java.lang.Class.forName0(Native Method)\n        at java.lang.Class.forName(Class.java:115)\n        at com.sun.jini.reggie.RegistrarImpl_Stub.class$(Unknown Source)\n        at com.sun.jini.reggie.RegistrarImpl_Stub.<clinit>(Unknown Source)\n        at java.lang.reflect.Field.getLong(Native Method)\n        at java.io.ObjectStreamClass$2.run(ObjectStreamClass.java:410)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at java.io.ObjectStreamClass.init(ObjectStreamClass.java:396)\n        - locked <3318c08> (a java.lang.Object)\n        at java.io.ObjectStreamClass.lookupInternal(ObjectStreamClass.java:107)\n        at java.io.ObjectStreamClass.setClass(ObjectStreamClass.java:561)\n        at\njava.io.ObjectInputStream.inputClassDescriptor(ObjectInputStream.java:931)\n        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:361)\n        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:231)\n        at java.io.ObjectInputStream.inputObject(ObjectInputStream.java:1181)\n        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:381)\n        at java.io.ObjectInputStream.inputClassFields(ObjectInputStream.java:2258)\n        at java.io.ObjectInputStream.defaultReadObject(ObjectInputStream.java:514)\n        at java.io.ObjectInputStream.inputObject(ObjectInputStream.java:1407)\n        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:381)\n        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:231)\n        at java.rmi.MarshalledObject.get(MarshalledObject.java:133)\n        at\nnet.jini.discovery.IncomingUnicastResponse.<init>(IncomingUnicastResponse.java:72)\n        at\nnet.jini.discovery.LookupDiscovery$UnicastDiscoveryTask.run(LookupDiscovery.java:712)\n        at com.sun.jini.thread.TaskManager$TaskThread.run(TaskManager.java:271)\n\nFound 1 deadlock.", "attachment_id": null, "bug_id": 10967, "id": 19815, "time": "2002-07-18T20:58:34Z", "creator": "apache@ganyo.com", "creation_time": "2002-07-18T20:58:34Z", "is_private": false}, {"count": 1, "tags": [], "text": "I also ran into a similar situation with 4.1.7 but with jasper 1 instead of\njasper 2.  What seemed to trigger it was a JSP page recompile.  The thread\ndump in my case looks like there was a deadlock trying to load the new\nJSP servlet class.  The JSP recompile was done shortly after a manager reload.\n\nI had 4 threads with the following state:\n\n\"Ajp13Processor[8009][125]\" daemon prio=5 tid=0x5be8b0 nid=0xb7 waiting for\nmonitor entry [0xe93be000..0xe93c19e0]\n        at java.lang.ClassLoader.checkCerts(ClassLoader.java:535)\n        at java.lang.ClassLoader.defineClass(ClassLoader.java:487)\n        at\njava.security.SecureClassLoader.defineClass(SecureClassLoader.java:111)\n        at\norg.apache.catalina.loader.WebappClassLoader.findClassInternal(WebappClassLoader.java:1650)\n\nAnd 25 threads in this state:\n\n\"Ajp13Processor[8009][117]\" daemon prio=5 tid=0x69ab98 nid=0xaf waiting for\nmonitor entry [0xe953f000..0xe95419e0]\n        at java.lang.Class.newInstance0(Native Method)\n        at java.lang.Class.newInstance(Class.java:237)\n        at\norg.apache.jasper.servlet.JspServlet$JspServletWrapper.load(JspServlet.java:138)\n\nThen the customer did another reload when he didn't see his JSP recompile\ncomplete.  And I ended up with everything locked because the reload was waiting\nfor the above deadlocks.\n", "is_private": false, "id": 19855, "creator": "glenn@apache.org", "time": "2002-07-19T13:42:04Z", "bug_id": 10967, "creation_time": "2002-07-19T13:42:04Z", "attachment_id": null}, {"count": 2, "tags": [], "text": "If I remember well, I changed a sync relatively recently and synced on this\ninstead of a monitor object. Apparently, this is a mistake because of syncing\nthe superclass may be doing.\nI'll try to fix it soon and release 4.1.8 to include it (which will also pick up\nsome important Jasper2 fixes).", "is_private": false, "id": 19856, "creator": "remm@apache.org", "time": "2002-07-19T13:55:47Z", "bug_id": 10967, "creation_time": "2002-07-19T13:55:47Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 10967, "attachment_id": null, "text": "I looked at it more, and I don't understand why the locking fails (trying to\nlock the CL when an instance of an inner class is locked). Does someone have an\nexplnation ?\n\nWould making ResourceEntry a full-fledged class help ?", "id": 19931, "time": "2002-07-21T14:05:45Z", "creator": "remm@apache.org", "creation_time": "2002-07-21T14:05:45Z", "is_private": false}, {"count": 4, "tags": [], "text": "Glenn's investigation showed there could be problems with the fact that a static\ninner class is used. The class has been taken out of WebappClassLoader, which\ncould fix the issue. The bug is very hard to reproduce, so it's difficult to\nconfirm. The fix will be in 4.1.8.", "is_private": false, "id": 20007, "creator": "remm@apache.org", "time": "2002-07-22T19:52:29Z", "bug_id": 10967, "creation_time": "2002-07-22T19:52:29Z", "attachment_id": null}]