[{"count": 0, "tags": [], "creator": "davec@sybase.com", "is_private": false, "text": "If a servlet uses context.getRequestDispatcher(...).include(request, response)\nto include a JSP page, and that JSP contains a <jsp:include page=\"...\"/> then we\nget a ClassCastException from:\nStack Trace: java.lang.ClassCastException:\norg.apache.catalina.connector.HttpRequestFacade\n       at\norg.apache.catalina.core.ApplicationDispatcher.unwrapRequest(ApplicationDispatcher.java:845)\n       at\norg.apache.catalina.core.ApplicationDispatcher.doInclude(ApplicationDispatcher.java:575)\n       at\norg.apache.catalina.core.ApplicationDispatcher.include(ApplicationDispatcher.java:497\n\nHere is a fix that worked for me:\n\n % diff -u ApplicationDispatcher.java.save ApplicationDispatcher.java\n--- ApplicationDispatcher.java.save     Sat Jun  8 16:14:36 2002\n+++ ApplicationDispatcher.java  Sat Jun  8 16:16:44 2002\n@@ -93,6 +93,7 @@\n import org.apache.catalina.Response;\n import org.apache.catalina.Wrapper;\n import org.apache.catalina.connector.ResponseFacade;\n+import org.apache.catalina.connector.RequestFacade;\n import org.apache.catalina.core.StandardWrapper;\n import org.apache.catalina.util.InstanceSupport;\n import org.apache.catalina.util.StringManager;\n@@ -826,7 +827,8 @@\n         while (current != null) {\n \n             // If we run into the container request we are done\n-            if (current instanceof Request)\n+            if (current instanceof Request ||\n+               current instanceof RequestFacade)\n                 break;\n \n             // Remove the current request if it is our wrapper", "id": 17452, "time": "2002-06-09T03:08:16Z", "bug_id": 9722, "creation_time": "2002-06-09T03:08:16Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 9722, "attachment_id": null, "is_private": false, "id": 17454, "time": "2002-06-09T03:52:05Z", "creator": "remm@apache.org", "creation_time": "2002-06-09T03:52:05Z", "text": "I didn't try to reproduce the bug yet, but the proposed patch seems reasonable\n(the facade or the real request would both be on top of the stack). The same\nshould be done for the response if the fix is tested to be fine."}, {"count": 2, "tags": [], "bug_id": 9722, "attachment_id": null, "is_private": false, "id": 17718, "time": "2002-06-12T23:47:09Z", "creator": "remm@apache.org", "creation_time": "2002-06-12T23:47:09Z", "text": "The patch has been applied in the 4.1.4 milestone."}]