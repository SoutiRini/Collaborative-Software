[{"count": 0, "tags": [], "creator": "fujino.keiichi@oss.ntt.co.jp", "attachment_id": null, "text": "Even if \"false\" is set to metadata-complete, \nthe annotation doesn't become effective. \n\nTo invalidate the annotation by all the Web applications of Tomcat, \nmetadata-complete of conf/web.xml is set to \"true\". \n\n[conf/web.xml]\n<web-app xmlns=\"http://java.sun.com/xml/ns/javaee\"\n    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n    xsi:schemaLocation=\"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd\"\n    version=\"2.5\"\n    metadata-complete=\"true\"\n    >\n.....\n</web-app>\n\nTo make the annotation of Web application (testWebApp) effective, \nmetadata-complete of webapps/testWebApp/WEB-INF/web.xml is set to \"false\".\n\n[webapps/testWebApp/WEB-INF/web.xml]\n<web-app xmlns=\"http://java.sun.com/xml/ns/javaee\"\n   xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n   xsi:schemaLocation=\"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd\"\n   version=\"2.5\"\n   metadata-complete=\"false\"> \n....\n</web-app>\n\nHowever, testWebApp doesn't make the annotation effective. \n\nBecause WebRuleSet#IgnoreAnnotationsRule#begin is as follows. \nWhen metadata-complete is \"false\", context.setIgnoreAnnotations(false) is not invoked. \n[WebRuleSet#IgnoreAnnotationsRule#begin]\nfinal class IgnoreAnnotationsRule extends Rule {\n\n    public IgnoreAnnotationsRule() {\n    }\n\n    public void begin(String namespace, String name, Attributes attributes)\n        throws Exception {\n        Context context = (Context) digester.peek(digester.getCount() - 1);\n        String value = attributes.getValue(\"metadata-complete\");\n        if (\"true\".equals(value)) {\n            context.setIgnoreAnnotations(true);\n        }\n        if (digester.getLogger().isDebugEnabled()) {\n            digester.getLogger().debug\n                (context.getClass().getName() + \".setIgnoreAnnotations( \" +\n                    context.getIgnoreAnnotations() + \")\");\n        }\n    }\n\n}\n\nI think that the following patches are necessary. \n\nIndex: java/org/apache/catalina/startup/WebRuleSet.java\n===================================================================\n--- java/org/apache/catalina/startup/WebRuleSet.java\t(revision 763870)\n+++ java/org/apache/catalina/startup/WebRuleSet.java\t(working copy)\n@@ -848,6 +848,8 @@\n         String value = attributes.getValue(\"metadata-complete\");\n         if (\"true\".equals(value)) {\n             context.setIgnoreAnnotations(true);\n+        } else if (\"false\".equals(value)) {\n+            context.setIgnoreAnnotations(false);\n         }\n         if (digester.getLogger().isDebugEnabled()) {\n             digester.getLogger().debug\n\n\nBest regards.", "id": 128450, "time": "2009-07-01T02:51:39Z", "bug_id": 47462, "creation_time": "2009-07-01T02:51:39Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 47462, "text": "Thanks for the patch. It has been applied to trunk and proposed for 5.5.x and 6.0.x", "id": 132209, "time": "2009-11-22T12:52:02Z", "creator": "markt@apache.org", "creation_time": "2009-11-22T12:52:02Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 47462, "attachment_id": null, "text": "SRV.14.5 of Servlet 2.5 says that if \u201cmetadata-complete\u201d attribute is absent, it must be treated the same way as having the value of \"false\".\n\nThus, if we allow to specify it in global conf/web.xml, setting it to \"true\" there will result in violation of the spec.", "id": 132887, "time": "2009-12-16T23:45:57Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2009-12-16T23:45:57Z", "is_private": false}, {"count": 3, "tags": [], "creator": "fujino.keiichi@oss.ntt.co.jp", "text": "Created attachment 24721\nnew patch.\n\nOops!\nMy patch was a mistake. \nHowever, even if this patch is reverted, it is a violation of spec yet. \n\nIf \u201cmetadata-complete\" of conf/web.xml is set true, \nand \u201cmetadata-complete\" is not specified in each webApp, \nthe annotation is invalid yet. \n\nThis is violation of spec.\n\nI made a new patch. \nif\u201cmetadata-complete\" is not specified, the annotation is made effective.", "id": 132893, "time": "2009-12-17T02:08:29Z", "bug_id": 47462, "creation_time": "2009-12-17T02:08:29Z", "is_private": false, "attachment_id": 24721}, {"count": 4, "attachment_id": null, "creator": "markt@apache.org", "text": "(In reply to comment #2)\n> SRV.14.5 of Servlet 2.5 says that if \u201cmetadata-complete\u201d attribute is absent,\n> it must be treated the same way as having the value of \"false\".\n> \n> Thus, if we allow to specify it in global conf/web.xml, setting it to \"true\"\n> there will result in violation of the spec.\n\nI disagree. The spec does not consider the concept of a global or default web.xml. A global web.xml is a Tomcat invention and one where Tomcat controls how it is to be interpreted, not the spec. The convention is the the global web.xml sets the defaults for all application web.xml files unless explicitly overridden at the application level. Hence the behaviour with the patch applied is as expected.", "id": 132908, "time": "2009-12-17T08:16:39Z", "bug_id": 47462, "creation_time": "2009-12-17T08:16:39Z", "tags": [], "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 47462, "text": "(In reply to comment #3)\n> Created an attachment (id=24721) [details]\n> new patch.\n\nI can't see why null needs to be handled here. The only acceptable values are true or false.", "count": 5, "id": 132909, "time": "2009-12-17T08:17:37Z", "creator": "markt@apache.org", "creation_time": "2009-12-17T08:17:37Z", "is_private": false}, {"count": 6, "attachment_id": null, "creator": "knst.kolinko@gmail.com", "text": "From second thought:\n- The spec authors had to specify how to interpret the missing value. Leaving that unspecified would be much worse.\n- The default content of global conf/web.xml provides specification-compliant behavior. If you start changing that file, you should know what you are doing.\n\nThus, let's go with the original patch.", "id": 132915, "time": "2009-12-17T12:21:14Z", "bug_id": 47462, "creation_time": "2009-12-17T12:21:14Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "bug_id": 47462, "text": "(In reply to comment #5)\n> (In reply to comment #3)\n> > Created an attachment (id=24721) [details] [details]\n> > new patch.\n> \n> I can't see why null needs to be handled here. The only acceptable values are\n> true or false.\n\nI think.\nf \"metadata-complete\" is not specified for web.xml, value becomes null. \nIn a new patch.\nFor a strict spec, if \"metadata-complete\" is not specified, the annotation was made effective. \nHowever, I think that the concept is more profitable of conf/web.xml as for the comment 4. \n\nI support the previous patch. \n\nmany thanks.", "id": 132921, "time": "2009-12-17T16:42:58Z", "creator": "fujino.keiichi@oss.ntt.co.jp", "creation_time": "2009-12-17T16:42:58Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "The patch has been applied to 6.0.x and will be included in 6.0.21 onwards.", "id": 132956, "time": "2009-12-19T14:35:59Z", "bug_id": 47462, "creation_time": "2009-12-19T14:35:59Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 47462, "attachment_id": null, "text": "metadata-complete is @since Servlet 2.5,\nso this issue is not applicable to Tomcat 5.5.\nClosing as FIXED in TC 6.", "id": 133399, "time": "2010-01-06T18:06:55Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2010-01-06T18:06:55Z", "is_private": false}]