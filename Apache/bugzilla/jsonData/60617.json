[{"count": 0, "attachment_id": null, "bug_id": 60617, "text": "Issue Description\n===\n\nWsWebSocketContainer generates bad CONNECT request when a proxy is used. The host does not contain port information, hence the app cannot connect to wss:// endpoints. Also some stricter proxy servers may reject requests without port info, thus making WsWebSocketContainer.connectToServer() fail for both ws:// and wss:// endpoints.\n\nSteps to reproduce\n===\n\nPrerequisites\n---\n1. Download Tomcat 8.5.9\n2. Configure it to use port 8081\n3. Clone git@github.com:adamfisk/LittleProxy.git\n4. Clone MCVE: git@github.com:SvetlinZarev/websocket-tomcat-bug.git\n5. Build (3), (4) -> mvn clean install (you may want to rename the mcve to ROOT)\n\nYou can use any other proxy if you already have one.\n\nHow to reproduce it\n---\n1. Start LittleProxy (it defaults to port 8080)\n2. Configure Tomcat use the proxy: export CATALINA_OPTS=\"-Dhttp.proxyHost=localhost -Dhttp.proxyPort=8080 -Dhttps.proxyHost=localhost -Dhttps.proxyPort=8080\"\n3. Start tomcat: catalina.sh run\n4. Request the mcve: http://localhost:8081/ws\n\nExpected behavior\n---\nYou should see: \n\nConnected. Sending message...\nMessage: Hello World!\nDisconnected: \n\nActual behavior\n---\nAn exception is thrown. In case of LittleProxy it is a timeout exception during channel.handshake().get(); In my other case it is a DeploymentException caused by a bad request, because the (stricter) proxy rejected the request because  it does not contain port info.\n\nAdditional information\n---\nYou can play with the mcve by adding the following request parameters:\n* scheme - i.e. ws://, wss://\n* server - i.e. echo.websocket.org\nRequest the mcve with: http://localhost:8081/ws?scheme=wss://&server=echo.websocket.org:443\n\nIt will succeed. Now remove the port from the server string. It will fail.\n\n===\n\nAccording to rfc2817 section 5.2:\n\n    A CONNECT method requests that a proxy establish a tunnel connection on its behalf. The Request-URI portion of the Request-Line is always an 'authority' as defined by URI Generic Syntax [2], which is to say the host name and port number destination of the requested connection separated by a colon\n\nAlso by the never finalized draft https://tools.ietf.org/html/draft-luotonen-web-proxy-tunneling-01#section-3.1:\n\n    The client connects to the proxy server, and uses the CONNECT method to specify the hostname and the port number to connect to. The hostname and port number are separated by a colon, and both of them must be specified", "id": 196248, "time": "2017-01-20T14:00:08Z", "creator": "svetlin.zarev@abv.bg", "creation_time": "2017-01-20T14:00:08Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 60617, "text": "Pull request: https://github.com/apache/tomcat/pull/39", "id": 196264, "time": "2017-01-21T10:44:31Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2017-01-21T10:44:31Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "Thanks for the patch.\n\nFixed in:\n- trunk for 9.0.0.M18 onwards\n- 8.5.x for 8.5.12 onwards\n- 8.0.x for 8.0.42 onwards\n- 7.0.x for 7.0.76 onwards", "id": 196376, "time": "2017-01-24T20:24:54Z", "bug_id": 60617, "creation_time": "2017-01-24T20:24:54Z", "is_private": false}]