[{"count": 0, "tags": [], "creator": "nicholas@nicholaswilliams.net", "is_private": false, "text": "Created attachment 30084\nPatch to bring Tomcat in line with latest Servlet 3.1 spec\n\nTomcat's javax.servlet.http.WebConnection interface should extend AutoCloseable, but it does not.\n\nIn Tomcat's javax.servlet.ReadListener interface, onDataAvailable() and onAllDataRead() should throw IOException, but they do not.\n\nIn Tomcat's javax.servlet.WriteListener interface, onWritePossible() should throw IOException, but it does not.\n\nTomcat's javax.servlet.ServletContext class is missing the following method:\n  public String getVirtualServerName();\n\nPatch attached for the above issues.\n\nTomcat's javax.servlet.http.NoBodyResponse implementation is interesting. First, it Servlet 2.5 the void setContentLength() method was as follows:\n\nvoid setContentLength();\n  Code:\n     0: aload_0       \n     1: getfield      #6                  // Field didSetContentLength:Z\n     4: ifne          23\n     7: aload_0       \n     8: getfield      #2                  // Field resp:Ljavax/servlet/http/HttpServletResponse;\n    11: aload_0       \n    12: getfield      #5                  // Field noBody:Ljavax/servlet/http/NoBodyOutputStream;\n    15: invokevirtual #7                  // Method javax/servlet/http/NoBodyOutputStream.getContentLength:()I\n    18: invokeinterface #8,  2            // InterfaceMethod javax/servlet/http/HttpServletResponse.setContentLength:(I)V\n    23: return \n\n\nWhich is equivalent to:\n\n    void setContentLength() {\n        if (!didSetContentLength)\n          resp.setContentLength(noBody.getContentLength());\n    }\n\nIt changed in Servlet 3.0 (and remained the same in Servlet 3.1) and is now:\n\n  void setContentLength();\n    Code:\n       0: aload_0       \n       1: getfield      #5                  // Field didSetContentLength:Z\n       4: ifne          32\n       7: aload_0       \n       8: getfield      #6                  // Field writer:Ljava/io/PrintWriter;\n      11: ifnull        21\n      14: aload_0       \n      15: getfield      #6                  // Field writer:Ljava/io/PrintWriter;\n      18: invokevirtual #7                  // Method java/io/PrintWriter.flush:()V\n      21: aload_0       \n      22: aload_0       \n      23: getfield      #4                  // Field noBody:Ljavax/servlet/http/NoBodyOutputStream;\n      26: invokevirtual #8                  // Method javax/servlet/http/NoBodyOutputStream.getContentLength:()I\n      29: invokevirtual #9                  // Method setContentLength:(I)V\n      32: return\n\nThis is roughly equivalent to:\n\n    void setContentLength() {\n        if (!didSetContentLength) {\n            if (writer != null)\n                writer.flush();\n            super.setContentLength(noBody.getContentLength());\n        }\n    }\n\nHowever, Tomcat's implementation is still:\n\n    void setContentLength() {\n        if (!didSetContentLength)\n          super.setContentLength(noBody.getContentLength());\n    }\n\nThe spec implementation is correct, and the Tomcat implementation could report incorrect content length if the writer has not been flushed. I will attach a separate patch in the following comment that fixes this.\n\nFinally, I noticed that Tomcat's javax.servlet.http.NoBodyResponse class has the following methods that are not in the spec:\n\n  public void setContentLengthLong(long);\n  public void setHeader(String, String);\n  public void addHeader(String, String);\n  public void setIntHeader(String, int);\n  public void addIntHeader(String, int);\n\nHowever, I do not believe this is a problem in Tomcat. The last four were added as part of https://issues.apache.org/bugzilla/show_bug.cgi?id=53454 and the setContentLengthLong() was added by Mark to correspond with that new method in Servlet 3.1. I believe this is a problem with the Oracle implementation, and these methods should be in that. Tomcat's implementation clearly adheres to the spirit of the spec. The spec JAR does not. I'm going to file an issue about this in the servlet spec JIRA.", "id": 166040, "time": "2013-03-20T18:50:43Z", "bug_id": 54734, "creation_time": "2013-03-20T18:50:43Z", "attachment_id": 30084}, {"count": 1, "tags": [], "bug_id": 54734, "attachment_id": 30085, "text": "Created attachment 30085\nPatch to fix NoBodyResponse#setContentLength()", "id": 166041, "time": "2013-03-20T18:51:11Z", "creator": "nicholas@nicholaswilliams.net", "creation_time": "2013-03-20T18:51:11Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 54734, "attachment_id": null, "text": "I recommend that the patch to fix NoBodyResponse#setContentLength() get back-ported to Tomcat 7.0, since it should have behaved this way in Servlet 3.0.", "id": 166043, "time": "2013-03-20T18:53:55Z", "creator": "nicholas@nicholaswilliams.net", "creation_time": "2013-03-20T18:53:55Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 54734, "is_private": false, "text": "For reference, here is the Servlet Spec bug I filed about missing methods in NoBodyResponse:\n\nhttp://java.net/jira/browse/SERVLET_SPEC-69", "id": 166048, "time": "2013-03-20T19:08:24Z", "creator": "nicholas@nicholaswilliams.net", "creation_time": "2013-03-20T19:08:24Z", "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 54734, "text": "(In reply to comment #2)\n> I recommend that the patch to fix NoBodyResponse#setContentLength() get\n> back-ported to Tomcat 7.0, since it should have behaved this way in Servlet\n> 3.0.\n\nApplied to trunk and 7.0.x and will be included in 7.0.39 onwards.", "id": 166058, "time": "2013-03-20T22:38:00Z", "creator": "markt@apache.org", "creation_time": "2013-03-20T22:38:00Z", "is_private": false, "attachment_id": null}, {"count": 5, "attachment_id": null, "bug_id": 54734, "text": "Thanks for the patches. The various issues have been fixed in trunk.", "id": 166136, "time": "2013-03-25T14:20:48Z", "creator": "markt@apache.org", "creation_time": "2013-03-25T14:20:48Z", "tags": [], "is_private": false}]