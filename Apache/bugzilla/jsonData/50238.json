[{"count": 0, "tags": [], "bug_id": 50238, "is_private": false, "text": "This occurs under logging with serialized LoggerEvent as \nSimpleSocketServe does.\n\nFor example \n\nMulti processed socket clients send logs to SocketServer, and server \nreads serialized LoggingEvents with o.a.l.s.LoggingEvent#readObject(), \nthis calls internally o.a.l.s.LoggingEvent#readLevel(ObjectInputStream) \nwhich uses thead-unsafe `static final` variable. (see below at line 439)\n\nThis results in inconsistent log levels.\n\n\nI reproduced with 4-processes socket clients, each client has 10-threads, \ntoward single-process SimpleSocketServer. Clients sent 80,000 logs in \nall, and about 10 of them were wrong leveled.\n\n[LoggingEvent.java]\n\n142:  static final Integer[] PARAM_ARRAY = new Integer[1];\n\n...\n\n417:  private\n418:  void readLevel(ObjectInputStream ois)\n419:                      throws java.io.IOException, ClassNotFoundException {\n420:\n421:    int p = ois.readInt();\n422:    try {\n423:      String className = (String) ois.readObject();\n424:      if(className == null) {\n425:        level = Level.toLevel(p);\n426:      } else {\n427:        Method m = (Method) methodCache.get(className);\n428:        if(m == null) {\n429:          Class clazz = Loader.loadClass(className);\n430:          // Note that we use Class.getDeclaredMethod instead of\n431:          // Class.getMethod. This assumes that the Level subclass\n432:          // implements the toLevel(int) method which is a\n433:          // requirement. Actually, it does not make sense for Level\n434:          // subclasses NOT to implement this method. Also note that\n435:          // only Level can be subclassed and not Priority.\n436:          m = clazz.getDeclaredMethod(TO_LEVEL, TO_LEVEL_PARAMS);\n437:          methodCache.put(className, m);\n438:        }\n439:        PARAM_ARRAY[0] = new Integer(p);  // <=== !!! thread-unsafe !!!\n440:        level = (Level) m.invoke(null,  PARAM_ARRAY);\n441:      }\n442:    } catch(InvocationTargetException e) {\n443:        if (e.getTargetException() instanceof InterruptedException\n444:                || e.getTargetException() instanceof InterruptedIOException) {\n445:            Thread.currentThread().interrupt();\n446:        }\n447:    LogLog.warn(\"Level deserialization failed, reverting to default.\", e);\n448:        level = Level.toLevel(p);\n449:    } catch(NoSuchMethodException e) {\n450:        LogLog.warn(\"Level deserialization failed, reverting to default.\", e);\n451:        level = Level.toLevel(p);\n452:    } catch(IllegalAccessException e) {\n453:        LogLog.warn(\"Level deserialization failed, reverting to default.\", e);\n454:        level = Level.toLevel(p);\n455:    } catch(RuntimeException e) {\n456:        LogLog.warn(\"Level deserialization failed, reverting to default.\", e);\n457:        level = Level.toLevel(p);\n458:    }\n459:  }", "id": 141560, "time": "2010-11-09T04:02:50Z", "creator": "sasakij@pm.nttdata.co.jp", "creation_time": "2010-11-09T04:02:50Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "carnold@apache.org", "text": "Fix applied in rev 1034632.\n\nCould you confirm that you were using custom log levels?  From my reading that could would only be reached in that case.  If you are reaching that code without using custom levels, then we should investigate why since it would appear to add a lot of unnecessary reflection.", "id": 141685, "time": "2010-11-12T22:02:38Z", "bug_id": 50238, "creation_time": "2010-11-12T22:02:38Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 50238, "is_private": false, "count": 2, "id": 141801, "time": "2010-11-18T10:33:02Z", "creator": "sasakij@pm.nttdata.co.jp", "creation_time": "2010-11-18T10:33:02Z", "text": "Yes, I'm using custom log levels.\nThanks a lot for your help."}, {"count": 3, "tags": [], "bug_id": 50238, "attachment_id": null, "text": "I'm sorry, i've forgotten to change status.", "id": 141989, "time": "2010-11-24T23:57:06Z", "creator": "sasakij@pm.nttdata.co.jp", "creation_time": "2010-11-24T23:57:06Z", "is_private": false}]