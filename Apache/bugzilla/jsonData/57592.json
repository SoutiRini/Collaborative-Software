[{"count": 0, "tags": [], "bug_id": 57592, "is_private": false, "id": 181128, "attachment_id": null, "creator": "knst.kolinko@gmail.com", "creation_time": "2015-02-18T13:51:28Z", "time": "2015-02-18T13:51:28Z", "text": "First noted this when testing 8.0.20 release candidate,  but this is also reproducible with 8.0.18 and 8.0.17.\nhttp://markmail.org/message/rkkdl6publsievvi\n\nSteps to reproduce:\n1) go to  /examples/servlets/nonblocking/numberwriter  with a web browser\n2) look into access log\nExpected: status 200\nActual: status 500 for APR, NIO, NIO2.  (BIO is OK)\n\nThis issue depends on timing. E.g. it reproduces for me consistently with HTTP connector, but not HTTPS connector. It does not reproduce in some other configurations.\n\n3) Add the following line to logging.properties to enable FINE logging for Coyote:\norg.apache.coyote.level=FINE\n\nThe following is observed in the log:\nfor Nio 2, Tomcat 8.0.20:\n\n[[[\n18-Feb-2015 15:51:17.155 FINE [http-nio2-127.0.0.1-8084-exec-4]\norg.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process\nSocket: [org.apache.tomcat.util.net.Nio2Endpoint$Nio2SocketWrapper@851105:org.apache.tomcat.util.net.Nio2Channel@406c4:sun.nio.ch.WindowsAsynchronousSocketChannelImpl[connected\nlocal=/127.0.0.1:8084 remote=/127.0.0.1:51890]], Status in:\n[OPEN_WRITE], State out: [LONG]\n18-Feb-2015 15:51:17.169 FINE [http-nio2-127.0.0.1-8084-exec-10]\norg.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process\nSocket: [org.apache.tomcat.util.net.Nio2Endpoint$Nio2SocketWrapper@851105:org.apache.tomcat.util.net.Nio2Channel@406c4:sun.nio.ch.WindowsAsynchronousSocketChannelImpl[connected\nlocal=/127.0.0.1:8084 remote=/127.0.0.1:51890]], Status in:\n[OPEN_WRITE], State out: [ASYNC_END]\n18-Feb-2015 15:51:17.170 FINE [http-nio2-127.0.0.1-8084-exec-10]\norg.apache.coyote.http11.AbstractHttp11Processor.asyncDispatch Unable\nto write async data.\n java.lang.IllegalStateException: Calling [asyncOperation()] is not\nvalid for a request with Async state [DISPATCHED]\n    at org.apache.coyote.AsyncStateMachine.asyncOperation(AsyncStateMachine.java:207)\n    at org.apache.coyote.http11.AbstractHttp11Processor.asyncDispatch(AbstractHttp11Processor.java:1658)\n    at org.apache.coyote.http11.Http11Nio2Processor.asyncDispatch(Http11Nio2Processor.java:155)\n    at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:650)\n    at org.apache.coyote.http11.Http11Nio2Protocol$Http11ConnectionHandler.process(Http11Nio2Protocol.java:177)\n    at org.apache.tomcat.util.net.Nio2Endpoint$SocketProcessor.doRun(Nio2Endpoint.java:1087)\n    at org.apache.tomcat.util.net.Nio2Endpoint$SocketProcessor.run(Nio2Endpoint.java:1046)\n    at org.apache.tomcat.util.net.Nio2Endpoint.processSocket0(Nio2Endpoint.java:598)\n    at org.apache.tomcat.util.net.Nio2Endpoint.processSocket(Nio2Endpoint.java:583)\n    at org.apache.coyote.http11.InternalNio2OutputBuffer$2.completed(InternalNio2OutputBuffer.java:199)\n    at org.apache.coyote.http11.InternalNio2OutputBuffer$2.completed(InternalNio2OutputBuffer.java:165)\n    at sun.nio.ch.Invoker.invokeUnchecked(Invoker.java:126)\n    at sun.nio.ch.Invoker$2.run(Invoker.java:218)\n    at sun.nio.ch.AsynchronousChannelGroupImpl$1.run(AsynchronousChannelGroupImpl.java:112)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n    at java.lang.Thread.run(Thread.java:745)\n\n18-Feb-2015 15:51:17.183 FINE [http-nio2-127.0.0.1-8084-exec-10]\norg.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process\nSocket: [org.apache.tomcat.util.net.Nio2Endpoint$Nio2SocketWrapper@851105:org.apache.tomcat.util.net.Nio2Channel@406c4:sun.nio.ch.WindowsAsynchronousSocketChannelImpl[connected\nlocal=/127.0.0.1:8084 remote=/127.0.0.1:51890]], Status in:\n[OPEN_WRITE], State out: [CLOSED]\n]]]\n\nFor APR connector, Tomcat 8.0.20\n[[[\n18-Feb-2015 15:57:47.524 FINE [http-apr-127.0.0.1-8083-exec-6]\norg.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process\nSocket: [org.apache.tomcat.util.net.AprEndpoint$AprSocketWrapper@1342088:86309568],\nStatus in: [OPEN_WRITE], State out: [LONG]\n18-Feb-2015 15:57:47.529 FINE [http-apr-127.0.0.1-8083-exec-7]\norg.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process\nSocket: [org.apache.tomcat.util.net.AprEndpoint$AprSocketWrapper@1342088:86309568],\nStatus in: [OPEN_WRITE], State out: [ASYNC_END]\n18-Feb-2015 15:57:47.530 FINE [http-apr-127.0.0.1-8083-exec-7]\norg.apache.coyote.http11.AbstractHttp11Processor.asyncDispatch Unable\nto write async data.\n java.lang.IllegalStateException: Calling [asyncOperation()] is not\nvalid for a request with Async state [DISPATCHED]\n    at org.apache.coyote.AsyncStateMachine.asyncOperation(AsyncStateMachine.java:207)\n    at org.apache.coyote.http11.AbstractHttp11Processor.asyncDispatch(AbstractHttp11Processor.java:1658)\n    at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:650)\n    at org.apache.coyote.http11.Http11AprProtocol$Http11ConnectionHandler.process(Http11AprProtocol.java:285)\n    at org.apache.tomcat.util.net.AprEndpoint$SocketProcessor.doRun(AprEndpoint.java:2439)\n    at org.apache.tomcat.util.net.AprEndpoint$SocketProcessor.run(AprEndpoint.java:2428)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n    at java.lang.Thread.run(Thread.java:745)\n\n18-Feb-2015 15:57:47.536 FINE [http-apr-127.0.0.1-8083-exec-7]\norg.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process\nSocket: [org.apache.tomcat.util.net.AprEndpoint$AprSocketWrapper@1342088:86309568],\nStatus in: [OPEN_WRITE], State out: [CLOSED]\n]]]"}, {"count": 1, "tags": [], "text": "Created attachment 32488\nserver.xml\n\nserver.xml - Tomcat 8.0.20.\nCustom configuration of Connectors (different port numbers and protocols) and of AccessLogValve (logging port number)\n\nlogging.properties:\nadded  org.apache.coyote.level=FINE", "attachment_id": 32488, "id": 181129, "creator": "knst.kolinko@gmail.com", "time": "2015-02-18T13:53:38Z", "bug_id": 57592, "creation_time": "2015-02-18T13:53:38Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 57592, "attachment_id": 32489, "is_private": false, "id": 181130, "time": "2015-02-18T13:54:36Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-02-18T13:54:36Z", "text": "Created attachment 32489\nlocalhost_access_log.2015-02-18.txt  - Access Log - 8.0.20"}, {"count": 3, "tags": [], "bug_id": 57592, "text": "Created attachment 32490\ncatalina.2015-02-18.log - Log - 8.0.20", "id": 181131, "time": "2015-02-18T13:55:20Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-02-18T13:55:20Z", "is_private": false, "attachment_id": 32490}, {"count": 4, "tags": [], "creator": "knst.kolinko@gmail.com", "is_private": false, "text": "Created attachment 32491\nlocalhost_access_log.2015-02-18.txt - Access Log - 8.0.18", "id": 181132, "time": "2015-02-18T13:56:26Z", "bug_id": 57592, "creation_time": "2015-02-18T13:56:26Z", "attachment_id": 32491}, {"count": 5, "tags": [], "bug_id": 57592, "attachment_id": 32492, "is_private": false, "id": 181133, "time": "2015-02-18T13:57:05Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-02-18T13:57:05Z", "text": "Created attachment 32492\ncatalina.2015-02-18.log - Log - 8.0.18"}, {"count": 6, "tags": [], "text": "Testing the current Tomcat 9 trunk @1660633\n\nConfiguration is the same, minus BIO connectors that are not implemented in trunk.\n\nHTTP:\n 8082: Nio,\n 8083: Apr,\n 8084: Nio2\nHTTPS:\n 9443: Nio,\n 10443: Nio2.\n None for APR.\n\nUsing Java 8u31.\n\nHTTP connectors:  response status OK (200). Seeing some EOF exceptions in FINE logging. The one from APR connectors seems odd.\n\nThe JVM crashed when I was trying to access the Nio HTTPS connector, but the crash is in APR connector code. It tried to process timeout on a keep-alive request.", "is_private": false, "id": 181135, "creator": "knst.kolinko@gmail.com", "time": "2015-02-18T14:30:54Z", "bug_id": 57592, "creation_time": "2015-02-18T14:30:54Z", "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 57592, "attachment_id": 32494, "id": 181137, "time": "2015-02-18T14:33:11Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-02-18T14:33:11Z", "is_private": false, "text": "Created attachment 32494\nlocalhost_access_log.2015-02-18.txt - Tomcat 9 @1660633 - Access Log"}, {"count": 8, "tags": [], "bug_id": 57592, "text": "Created attachment 32495\ncatalina.2015-02-18.log - Tomcat 9 @1660633 - Log", "id": 181138, "time": "2015-02-18T14:33:41Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-02-18T14:33:41Z", "is_private": false, "attachment_id": 32495}, {"count": 9, "tags": [], "bug_id": 57592, "attachment_id": 32496, "id": 181139, "time": "2015-02-18T14:34:30Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-02-18T14:34:30Z", "is_private": false, "text": "Created attachment 32496\nhs_err_pid3936.log - Tomcat 9 @1660633 - Crash Log"}, {"count": 10, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 181556, "creation_time": "2015-03-06T15:40:53Z", "time": "2015-03-06T15:40:53Z", "bug_id": 57592, "text": "I could not reliably reproduce this. It looks like I have fixed this but do re-open it if you see it again.", "is_private": false}]