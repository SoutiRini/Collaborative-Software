[{"count": 0, "tags": [], "text": "Created attachment 31972\ncomplete but minimal httpd.conf for reproducing the problem\n\nUnmodified httpd 2.4.10 compiled from apache.org source on Fedora 19 x86_64.\n\nThe problem described below happens for certain PHP syntax errors (but not others) in WordPress 3.9 scripts when run WordPress is run via mod_proxy_fcgi under PHP-FPM (PHP 5.5.5).\n\nEnable mod_cache (a complete but minimal httpd.conf for reproducing the problem is attached):\n\nCacheRoot /opt/httpd/cache\nCacheEnable disk /\nCacheIgnoreNoLastMod On\n\nGenerate a response containing a Content-Type header with an empty value:\n\n#!/usr/bin/perl\nprint \"Content-Type:\\n\\n\";\nprint localtime() . \"\\n\";\n\nResult is a segmentation fault due to dereferencing a NULL pointer for the Content-Type value in the output headers table:\n\n[Mon Sep 08 00:01:49.413618 2014] [core:notice] [pid 36893:tid 140015984838528] AH00051: child pid 23242 exit signal Segmentation fault (11), possible coredump in /var/tmp\n\n[root@f19debug tmp]# gdb /opt/httpd/bin/httpd core.httpd.23242\nGNU gdb (GDB) Fedora 7.6.1-46.fc19\nCopyright (C) 2013 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"x86_64-redhat-linux-gnu\".\nFor bug reporting instructions, please see:\n<http://www.gnu.org/software/gdb/bugs/>...\nReading symbols from /opt/httpd/bin/httpd...done.\n[New LWP 23262]\n[New LWP 23242]\n[New LWP 23266]\n[New LWP 23267]\n[New LWP 23265]\n[New LWP 23268]\n[New LWP 23264]\n[New LWP 23263]\n[New LWP 23269]\n[New LWP 23270]\n[New LWP 23271]\n[New LWP 23272]\n[New LWP 23246]\n[New LWP 23247]\n[New LWP 23248]\n[New LWP 23249]\n[New LWP 23250]\n[New LWP 23251]\n[New LWP 23252]\n[New LWP 23253]\n[New LWP 23254]\n[New LWP 23255]\n[New LWP 23256]\n[New LWP 23257]\n[New LWP 23258]\n[New LWP 23260]\n[New LWP 23259]\n[Thread debugging using libthread_db enabled]\nUsing host libthread_db library \"/lib64/libthread_db.so.1\".\nCore was generated by `/opt/httpd/bin/httpd -k start'.\nProgram terminated with signal 11, Segmentation fault.\n#0  __strlen_sse2_pminub ()\n    at ../sysdeps/x86_64/multiarch/strlen-sse2-pminub.S:38\n38              movdqu  (%rdi), %xmm1\n(gdb) where\n#0  __strlen_sse2_pminub ()\n    at ../sysdeps/x86_64/multiarch/strlen-sse2-pminub.S:38\n#1  0x00007f5801c550d1 in store_table (fd=0x7f57e800bb28, table=0x7f57e8008128)\n    at mod_cache_disk.c:916\n#2  0x00007f5801c55a0b in write_headers (h=0x7f57e8007cc8, r=0x7f57e8002970)\n    at mod_cache_disk.c:1087\n#3  0x00007f5801c5681e in commit_entity (h=0x7f57e8007cc8, r=0x7f57e8002970)\n    at mod_cache_disk.c:1322\n#4  0x00007f5801e5f36c in cache_save_store (f=0x7f57e80040f0,\n    in=0x7f57e8007748, conf=0x253e210, cache=0x7f57e8003d88) at mod_cache.c:734\n#5  0x00007f5801e614ca in cache_save_filter (f=0x7f57e80040f0,\n    in=0x7f57e8007748) at mod_cache.c:1576\n#6  0x00000000004370b9 in ap_pass_brigade (next=0x7f57e80040f0,\n    bb=0x7f57e8007748) at util_filter.c:590\n#7  0x00007f5802071b85 in cgi_handler (r=0x7f57e8002970) at mod_cgi.c:1014\n#8  0x0000000000454539 in ap_run_handler (r=0x7f57e8002970) at config.c:169\n#9  0x0000000000454ff2 in ap_invoke_handler (r=0x7f57e8002970) at config.c:433\n#10 0x00000000004702d5 in ap_process_async_request (r=0x7f57e8002970)\n    at http_request.c:317\n#11 0x000000000046c6df in ap_process_http_async_connection (c=0x7f57fc0376b0)\n    at http_core.c:143\n#12 0x000000000046c8c9 in ap_process_http_connection (c=0x7f57fc0376b0)\n    at http_core.c:228\n---Type <return> to continue, or q <return> to quit---\n#13 0x0000000000461b48 in ap_run_process_connection (c=0x7f57fc0376b0)\n    at connection.c:41\n#14 0x00007f5802e94a12 in process_socket (thd=0x2553e60, p=0x7f57fc0373a8,\n    sock=0x7f57fc037420, cs=0x7f57fc037628, my_child_num=0, my_thread_num=15)\n    at event.c:1035\n#15 0x00007f5802e96f78 in worker_thread (thd=0x2553e60, dummy=0x7f57fc01fd60)\n    at event.c:1875\n#16 0x000000367e807c53 in start_thread (arg=0x7f57f4ff1700)\n    at pthread_create.c:308\n#17 0x000000367e0f5dbd in clone ()\n    at ../sysdeps/unix/sysv/linux/x86_64/clone.S:113\n(gdb) frame 1\n#1  0x00007f5801c550d1 in store_table (fd=0x7f57e800bb28, table=0x7f57e8008128)\n    at mod_cache_disk.c:916\n916                 iov[2].iov_len = strlen(elts[i].val);\n(gdb) print i\n$1 = 0\n(gdb) print elts[i].key\n$2 = 0x7f5801e6a545 \"Content-Type\"\n(gdb) print elts[i].val\n$3 = 0x0\n(gdb)", "is_private": false, "id": 177611, "creator": "mark@catseye.org", "time": "2014-09-08T04:45:14Z", "bug_id": 56924, "creation_time": "2014-09-08T04:45:14Z", "attachment_id": 31972}, {"count": 1, "tags": [], "creator": "mark@catseye.org", "is_private": false, "text": "Created attachment 31973\npatch to fix Content-Type empty value segfault\n\nmodules/cache/cache_util.c: Fix the segfault by checking the return value of ap_make_content_type() before adding it to the output headers table (only add it if it is not NULL).\n\nserver/util_script.c: Correct a logic error in processing the Content-Type script header, although the error does not appear to negatively affect anything and is unrelated to the segmentation fault.", "id": 177612, "time": "2014-09-08T04:52:23Z", "bug_id": 56924, "creation_time": "2014-09-08T04:52:23Z", "attachment_id": 31973}, {"count": 2, "tags": [], "bug_id": 56924, "attachment_id": null, "id": 177729, "time": "2014-09-11T08:24:32Z", "creator": "jkaluza@redhat.com", "creation_time": "2014-09-11T08:24:32Z", "is_private": false, "text": "I'm going to apply this patch to trunk, but I think the second part of the patch is not needed. Current code looks like this (shorter version just to show the \"l\" variable):\n\nw is \"ContentType:\\n\\n\\0\"\n\n>        l = strchr(w, ':')\n\nl is \":\\n\\n\\0\"\n\n>        *l++ = '\\0';\n\nl is \"\\n\\n\\0\"\nw is \"ContentType\\0\"\n\n>        while (apr_isspace(*l)) {\n>            ++l;\n>        }\n\nl is \"\\0\" (\\n\\n is skipped)\n\n>        if (!strcasecmp(w, \"Content-type\")) {\n>            char *endp = l + strlen(l) - 1;\n\nendp is l - 0 - 1.\n\n>            while (endp > l && apr_isspace(*endp)) {\n>                *endp-- = '\\0';\n>            }\n\nThis is skipped because enpd < l.\n\n>            tmp = apr_pstrdup(r->pool, l);\n\nThis just copies '\\0', so everything looks OK. Do you agree or there was something I'm missing here?"}, {"count": 3, "tags": [], "text": "Committed in trunk in r1624234.", "attachment_id": null, "bug_id": 56924, "id": 177747, "time": "2014-09-11T13:03:57Z", "creator": "jkaluza@redhat.com", "creation_time": "2014-09-11T13:03:57Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 56924, "attachment_id": null, "id": 177757, "time": "2014-09-11T14:54:24Z", "creator": "mark@catseye.org", "creation_time": "2014-09-11T14:54:24Z", "is_private": false, "text": "(In reply to jkaluza from comment #2)\n> I'm going to apply this patch to trunk, but I think the second part of the\n> patch is not needed. [...]\n> This just copies '\\0', so everything looks OK. Do you agree or there was\n> something I'm missing here?\n\nI agree that the second part of the patch is not needed and does not affect anything.\n\nMy concern was that if the original value for w was \"ContentType:\\0\" then the '\\0' that got copied would be the one that replaced the ':' rather than the one immediately after it.  This is purely an academic point.\n\nI won't be able to check whether w is actually w is \"ContentType:\\n\\n\\0\" or \"ContentType:\\0\" until tonight.\n\nThanks for the quick and helpful handling of this bug!"}, {"count": 5, "tags": [], "creator": "venkatunix02@gmail.com", "is_private": false, "text": "This issue may be impacting Apache 2.2 also. \n\ncache_merge_headers_out() function is not available in apache 2.2, but the code which got corrected(i.e., check return value of ap_make_content_type()) is present in different function of apache 2.2 as mentioned below. \n\nhttp://svn.apache.org/viewvc/httpd/httpd/branches/2.2.x/modules/cache/mod_mem_cache.c?revision=1343951&view=markup\n635\t        apr_table_setn(headers_out, \"Content-Type\",\n636\t                       ap_make_content_type(r, r->content_type));\n637\t    }\n\nhttp://svn.apache.org/viewvc/httpd/httpd/branches/2.2.x/modules/cache/mod_disk_cache.c?view=markup\n932\t        if (!apr_table_get(headers_out, \"Content-Type\")\n933\t            && r->content_type) {\n934\t            apr_table_setn(headers_out, \"Content-Type\",\n935\t                           ap_make_content_type(r, r->content_type));\n936\t        }\n\nCan someone please confirm this.", "id": 178512, "time": "2014-10-16T17:54:18Z", "bug_id": 56924, "creation_time": "2014-10-16T17:54:18Z", "attachment_id": null}, {"count": 6, "attachment_id": null, "bug_id": 56924, "text": "(In reply to venkatunix02 from comment #5)\n> This issue may be impacting Apache 2.2 also. \n\nAs discussed here (https://www.mail-archive.com/dev@httpd.apache.org/msg60793.html), ap_make_content_type() can't return NULL in 2.2, so it not concerned by this bug.", "id": 178536, "time": "2014-10-17T11:58:20Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-10-17T11:58:20Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "bug_id": 56924, "attachment_id": null, "is_private": false, "id": 180063, "time": "2014-12-29T20:31:09Z", "creator": "covener@gmail.com", "creation_time": "2014-12-29T20:31:09Z", "text": "CVE-2014-3581, waiting for next 2.4.x release"}, {"count": 8, "tags": [], "bug_id": 56924, "attachment_id": null, "id": 180502, "time": "2015-01-23T08:42:26Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2015-01-23T08:42:26Z", "is_private": false, "text": "Backported to 2.4.11 in r1627749, thanks Mark."}]