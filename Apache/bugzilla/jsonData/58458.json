[{"count": 0, "tags": [], "creator": "Oliver.Warz@pdv.de", "attachment_id": 33142, "id": 185486, "creation_time": "2015-09-25T17:54:52Z", "time": "2015-09-25T17:54:52Z", "bug_id": 58458, "text": "Created attachment 33142\nTestcase\n\nThis issue is similar to bug #57324\n\nIn the version of Tomcat 7.0.50, the behavior of Coyote handler is modified to handle \"Expect: 100-continue\" clients.\n\nWe use .net http clients to run multiple web service equests. The uri is protected with spring security (kerberos / spnego) and uses requests to post xml files and attachements to the server. Starting with tomcat 7.0.50 about 1% to 10% of the requests fail with connection reset errors.\n\nThe problem is reproducable with a small powershell script that do 10000 small post requests with the header \"Expect: 100-continue\" with an uri that does not exists in tomcat (no webapp). The expected result are 10000 http 404 errors.\nThe problem is not reproducable when the header \"Expect: 100-continue\" is not used.\nThe problem is not reproducable with tomcat versions 7.0.42.\n\nNo error is logged at tomcat level. The access log shows http 404 when a request fails, but the response is not recognized by the client.\n\n\nerror message:\n\"The underlying connection was closed: An unexpected error occurred on a receive.\"\n\nadditional infos:\n1) .NET defaults to Expect 100 behaviour\n2) .NET clients optimize the keepalive connections and do not send credentials with every request going out on keepalive connections\n\nReproducable with:\n7.0.64 APR Windows\n7.0.64 BIO Windows\n8.0.26 NIO Windows\n8.0.26 APR Windows\n8.0.26 NIO Linux\n8.0.26 NIO2 Linux \n8.0.26 APR Windows\n8.0.26 NIO2Windows\n7.0.63 APR Windows\n7.0.57 APR Windows\n7.0.57 BIO Windows\n7.0.50 APR Windows\n\nNot reproducable with:\n7.0.47 APR Windows\n7.0.42 APR Windows\n7.0.57 APR Linux   !\n8.0.26 BIO Windows !\n\nWindows = Windows 7 with Oracle Server JRE 8 Update 51\nLinux = Oracle Linux 7 with java-1.8.0-openjdk-1.8.0.51-1.b16.el7_1.x86_64\n\npossible workaround:\n- setting expect100Continue to false at application or system level\n- http://blogs.msdn.com/b/fiddler/archive/2011/11/05/http-expect-continue-delays-transmitting-post-bodies-by-up-to-350-milliseconds.aspx\n- https://msdn.microsoft.com/en-us/library/system.net.servicepointmanager.expect100continue%28v=vs.110%29.aspx\n\nTestcase:\n- running on windows 7 (.net framework required)\n- start tomcat 7.0.64 on port 8080 \n- cmd.exe\n-  Powershell.exe -executionpolicy remotesigned -File TomcatExpectTest.ps1\n\nExpect100Continue set to True\nQuerying http://localhost:8080/myUri(number)\n09/25/2015 19:42:25 request 257 - Exception Message: Exception calling \"GetResponse\" with \"0\" argument(s): \"The underlying connection was closed: An unexpected error occurred on a receive.\"\n...\n--- RESULTS\nRequests   :  10000\nHTTP 404   :  9871\nRST-Error  :  129    <--\nOTHER Error:  0\n--- END", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 58458, "is_private": false, "count": 1, "id": 185487, "time": "2015-09-25T19:05:26Z", "creator": "1983-01-06@gmx.net", "creation_time": "2015-09-25T19:05:26Z", "text": "Have you tried another client like curl? Microsoft's Expect100Continue implementation is known be to problemeatic (crap). I have instructed all .NET clients to disable this header."}, {"count": 2, "tags": [], "creator": "Oliver.Warz@pdv.de", "attachment_id": 33148, "id": 185493, "time": "2015-09-25T21:24:31Z", "bug_id": 58458, "creation_time": "2015-09-25T21:24:31Z", "is_private": false, "text": "Created attachment 33148\ntestcase with curl on windows"}, {"count": 3, "tags": [], "bug_id": 58458, "is_private": false, "text": "Thanks for your fast response.\n\nWith curl on windows the problem is also reproducible (tomcat 7.0.64 apr and 8.0.26 apr). There is an additional testcase (batch file).\n\nError message:\nD:\\curl-7.43.0-win64\\bin>TomcatExpectTest_curl.cmd\nRequest http://localhost:8080/myURI1\n...\nRequest http://localhost:8080/myURI11\ncurl: (56) Recv failure: Connection was reset\nRequest http://localhost:8080/myURI12\n...\nRequest http://localhost:8080/myURI23\ncurl: (56) Recv failure: Connection was reset\nRequest http://localhost:8080/myURI24\n...\nRequest http://localhost:8080/myURI32\ncurl: (56) Recv failure: Connection was reset\nRequest http://localhost:8080/myURI33\ncurl: (56) Recv failure: Connection was reset\nRequest http://localhost:8080/myURI34", "id": 185494, "time": "2015-09-25T21:26:22Z", "creator": "Oliver.Warz@pdv.de", "creation_time": "2015-09-25T21:26:22Z", "attachment_id": null}, {"count": 4, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 185519, "time": "2015-09-28T20:20:15Z", "bug_id": 58458, "creation_time": "2015-09-28T20:20:15Z", "is_private": false, "text": "I can't reproduce this with a non-Windows client.\n\nFrom my own load testing exprience a default Windows configuration does not handle connection churn well and the change to force a connection close will generate connection churn.\n\nJust using ab with a large number of requests and no keep-alive is enough to generate all sorts of I/O errors on a Windows client."}]