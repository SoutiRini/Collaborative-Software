[{"count": 0, "text": "The patch r1331416 introduced a serious bug: \n\nIn the case described in bug 52879 (a PHP script run as fastcgi through php-fpm and mod_proxy_fcgi which returns a Last-Modified header with no Status header), httpd (after fix r1331416) does indeed now return a 304 status (if a matching If-not-modified header is in the request) BUT the content of the php script is also sent. \n\nThis breaks the http protocol as described in rfc2616 section 10.3.5: \"The 304 response MUST NOT contain a message-body, and thus is always terminated by the first empty line after the header fields.\"\n\nThis invalid behavior cause a serious problem when processed by a reverse proxy placed in front of the backends. When the proxy receives this invalid 304 response (containing a body), it immediately sends a 304 to the client and ignores the rest of the packet; but the next packets sent by the backend stay in the tcp stack (the proxy does not expect further content). The reverse proxy prepends these packets in the response to the next request routed to the same backend. This, of course, seriouly breaks our applications...", "bug_id": 57198, "attachment_id": null, "id": 179037, "time": "2014-11-10T19:44:28Z", "creator": "spizella001@gmail.com", "creation_time": "2014-11-10T19:44:28Z", "tags": [], "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 57198, "text": "From the first quick try, I'm not able to reproduce the issue.\n\nMy PHP script looks like this:\n\n<?php header('Last-Modified: Wed, 15 Nov 1995 04:58:08 GMT');?>\ntest\n\nAt first I've tried request with If-Modified-Since before the date in PHP script. This returns 200 OK with body as expected:\n\n# curl --header 'If-Modified-Since: Tue, 14 Nov 1995 04:58:08 GMT' http://localhost/index.php -v\n> GET /index.php HTTP/1.1\n> User-Agent: curl/7.32.0\n> Host: localhost\n> Accept: */*\n> If-Modified-Since: Tue, 14 Nov 1995 04:58:08 GMT\n> \n< HTTP/1.1 200 OK\n< Date: Tue, 11 Nov 2014 09:41:25 GMT\n< Server: Apache/2.4.10 (Fedora) Phusion_Passenger/4.0.53\n< X-Powered-By: PHP/5.5.18\n< Last-Modified: Wed, 15 Nov 1995 04:58:08 GMT\n< Transfer-Encoding: chunked\n< Content-Type: text/html; charset=UTF-8\n< \ntest\n\nThen I've tried with different If-Modified-Since to trigger to 304. This returns 304, but I don't see the php script content there:\n\n# curl --header 'If-Modified-Since: Wed, 15 Nov 1995 04:58:08 GMT' http://localhost/index.php -v\n> GET /index.php HTTP/1.1\n> User-Agent: curl/7.32.0\n> Host: localhost\n> Accept: */*\n> If-Modified-Since: Wed, 15 Nov 1995 04:58:08 GMT\n> \n< HTTP/1.1 304 Not Modified\n< Date: Tue, 11 Nov 2014 09:41:17 GMT\n< Server: Apache/2.4.10 (Fedora) Phusion_Passenger/4.0.53\n< \n\nAre you doing anything differently? How do you reproduce it?\n\nNote that from the code, I think this should work properly, because the output brigade is cleaned-up before it's passed to output filters.", "id": 179044, "time": "2014-11-11T09:47:33Z", "creator": "jkaluza@redhat.com", "creation_time": "2014-11-11T09:47:33Z", "tags": [], "is_private": false}, {"count": 2, "attachment_id": null, "bug_id": 57198, "text": "curl seems to be following the rfc2616 correctly, and immediately close connection after receiving the 304 header, so the bug won't show with curl.\n\nI can see the problem when using telnet to connect to the server and sending the request manually.\n\nAlso, after some testing, it seems the bug is triggered only when the php script generate some large enough content.\n\nHere is how to reproduce:\n\n-> index.php:\n\n<?php header('Last-Modified: Wed, 15 Nov 1995 04:58:08 GMT');\nfor( $i=0; $i<60; $i++) {\n   echo( \"testing testing testing testing testing testing testing testing testing testing testing\\n\" );\n}\nflush();\n?>\n\n-> send request manually via telnet:\n\ntelnet localhost 80\nTrying 127.0.0.1...\nConnected to localhost.\nEscape character is '^]'.\nGET /index.php HTTP/1.1\nHost: localhost\nAccept: */*\nIf-Modified-Since: Tue, 15 Nov 1995 05:58:08 GMT\n\n\nHTTP/1.1 304 Not Modified\nDate: Tue, 11 Nov 2014 15:54:07 GMT\nServer: Apache/2.4.10 (Unix)\n\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\nConnection closed by foreign host.\n\n-> Note that telnet close the connection after about 5 seconds of waiting\n\n\nAnd this is what I get when the date triggers to send content:\n\ntelnet localhost 80\nTrying 127.0.0.1...\nConnected to localhost.\nEscape character is '^]'.\nGET /index.php HTTP/1.1\nHost: localhost\nAccept: */*\nIf-Modified-Since: Tue, 14 Nov 1995 05:58:08 GMT\n\n\nHTTP/1.1 200 OK\nDate: Tue, 11 Nov 2014 16:04:03 GMT\nServer: Apache/2.4.10 (Unix)\nX-Powered-By: PHP/5.5.18\nLast-Modified: Wed, 15 Nov 1995 04:58:08 GMT\nTransfer-Encoding: chunked\nContent-Type: text/html\n\n1028\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\n\n478\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\ntesting testing testing testing testing testing testing testing testing testing testing\n\n0\n\nConnection closed by foreign host.", "id": 179048, "time": "2014-11-11T16:10:51Z", "creator": "spizella001@gmail.com", "creation_time": "2014-11-11T16:10:51Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "creator": "spizella001@gmail.com", "text": "After some more testing, it appears that when a 304 message is returned, httpd skips the rest of the first chunk (as seen when a 200 message is returned) but then sends all the following chunks. \n\nMaybe this will help find the problem...", "id": 179052, "time": "2014-11-11T19:32:27Z", "bug_id": 57198, "creation_time": "2014-11-11T19:32:27Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "jkaluza@redhat.com", "attachment_id": 32204, "id": 179054, "time": "2014-11-12T07:13:44Z", "bug_id": 57198, "creation_time": "2014-11-12T07:13:44Z", "is_private": false, "text": "Created attachment 32204\nproposed patch\n\nStop handling body sent by fcgi backend after httpd sent 304 to the client."}, {"count": 5, "tags": [], "bug_id": 57198, "attachment_id": null, "text": "Thanks, proposed patch 32204 solved the problem!", "id": 179090, "time": "2014-11-13T21:39:32Z", "creator": "spizella001@gmail.com", "creation_time": "2014-11-13T21:39:32Z", "is_private": false}, {"count": 6, "tags": [], "creator": "jkaluza@redhat.com", "attachment_id": null, "id": 179183, "time": "2014-11-19T07:23:14Z", "bug_id": 57198, "creation_time": "2014-11-19T07:23:14Z", "is_private": false, "text": "Committed to trunk in r1640495."}, {"count": 7, "tags": [], "bug_id": 57198, "attachment_id": null, "id": 179270, "time": "2014-11-25T12:36:31Z", "creator": "jkaluza@redhat.com", "creation_time": "2014-11-25T12:36:31Z", "is_private": false, "text": "Proposed in 2.4.x."}, {"count": 8, "tags": [], "bug_id": 57198, "text": "Backported in 2.4.x in r1650677\n\nWill be part of 2.4.11", "id": 180249, "time": "2015-01-09T21:33:49Z", "creator": "christophe.jaillet@wanadoo.fr", "creation_time": "2015-01-09T21:33:49Z", "is_private": false, "attachment_id": null}]