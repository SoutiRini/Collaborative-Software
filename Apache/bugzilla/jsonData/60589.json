[{"count": 0, "tags": [], "creator": "woonsan@apache.org", "attachment_id": null, "id": 196076, "time": "2017-01-15T16:34:07Z", "bug_id": 60589, "creation_time": "2017-01-15T16:34:07Z", "is_private": false, "text": "First, I think the goals are as follows:\n\n# Goals\n\nG1. Drop dependencies on logkit, exclalibur and logkit.\nG2. Allow logging configuration with other popular logging framework configuration such as log4j2. log4j2 is the primary one to support.\n  (It should be able to support logback, but that's out of scope in this story. That can be part of other new story later.)\nG3. Keep the existing UI functionalities.\nG4. Keep the backward compatibility for 3rd party plugin modules.\nG5. Ensure all the code use slf4j for logging (exception: usages of logkit logger interface for backward compatibility). \n\nSecond, let me try to list all the existing logging related features of JMeter\n\n# Current Logging Related Features\n\nCF1. Users are able to configure log file, logging format, log levels for the combined root logger or for each category in the JMeter configuration properties file or command line arguments (`-j' for log file and `-L' for log level).\nCF2. Logs by libraries using Commons Logging are passed to the JMeter logging (logkit) by JMeter's Commons Logging implementation.\nCF3. Advanced Excalibur logging configuration is possible through `log_config' property in JMeter configuration properties.\nCF3. Logs Viewer UI Menu can be turned on to receive logging event and show in the UI panel (org.apache.jmeter.gui.LoggerPanel). Note this is not reading the log file directly, but receives and renders log events currently propagated by the underlying logging framework at runtime only.\nCF4. For libraries using log4j API directly, log4j system property is set with `log4j.conf' configuration properties by default, but the logs through log4j is not used by JMeter, it's simply appended to a separate log file.\n\nSince the goals include removing dependencies on logkit, excalibur and avalon, and introducing log4j2 logging framework, I'd like to propose the following in the feature level.\n\n# Proposal in Feature Level\n\nPF1. Users are able to configure log file, logging format, log levels, etc. for combined root logger and for each logger in a separate log4j2 configuration file, ./log4j2.xml or bin/log4j2.xml.\nPF2. Users are able to change the log4j2 configuration by passing the standard log4j2 system property (e.g, `-Dlog4j2.configuration=file:/var/conf/log4j2-pt1.xml').\nPF3. Logs Viewer UI Menu keeps the same functionality as it does.\nPF4. All the logging related configuration in JMeter configuration properties will be dropped. Also, the logging related command line arguments (`-j' for log file and `-L' for log level) will be dropped.\nPF5. Advanced Excalibur logging configuration support will be dropped.\nPF6. JMeter Commons Logging provision will be dropped. Instead jcl-over-slf4j jar dependency will be provided for the same feature.\nPF7. log4j support through `log4j.configuration' system property and `log4j.conf' will be dropped. Instead Log4j 2's log4j-1.2-api.jar [1] will be provided for backward compatibility.\n\n# Candidate solutions\n- I'll describe solution ideas in comments.\n\n-----\n[1] https://logging.apache.org/log4j/2.x/manual/migration.html"}, {"count": 1, "tags": [], "bug_id": 60589, "attachment_id": null, "id": 196077, "time": "2017-01-15T16:54:12Z", "creator": "woonsan@apache.org", "creation_time": "2017-01-15T16:54:12Z", "is_private": false, "text": "My solution ideas (roughly):\n- NewDriver.java can determine (default) log4j2 configuration file location (e.g, first ./log4j2.xml, second bin/log4j2.xml) if log4j2 configuration system property is not explicitly set by users.\n- Add jcl-over-slf4j jar and Log4j 2's log4j-1.2-api.jar dependencies for Commons Logging and Log4j using libraries.\n- Remove logkit, excalibur and avalon dependencies.\n- Fork logkit Logger interface with a wrapper class for slf4j logger for backward compatibility in jorphan. So we can remove logkit dependencies in maven pom as well.\n- Change LoggingManager only for using wrappers for slf4j. Drop logging initialization.\n- Remove all the logging related JMeter configuration properties and command line arguments support.\n- Provide logging event listener for the Logs Viewer UI feature).\n  (This can be a log4j2 listener implementation since I don't see any listener support by slf4j itself (yet).)"}, {"count": 2, "tags": [], "bug_id": 60589, "attachment_id": null, "text": "(In reply to Woonsan Ko from comment #1)\n\n> - Provide logging event listener for the Logs Viewer UI feature).\n>   (This can be a log4j2 listener implementation since I don't see any\n> listener support by slf4j itself (yet).)\n\nOne solution is to provide a custom log4j2 Appender implementation, as the most minimal direct log4j2 (runtime) dependency, for the Logs Viewer UI. So, users are supposed to configure this custom appender and reference in to root logger to keep the same functionality. The custom appender can possibly propagate events with the logging events.", "id": 196080, "time": "2017-01-15T18:47:04Z", "creator": "woonsan@apache.org", "creation_time": "2017-01-15T18:47:04Z", "is_private": false}, {"count": 3, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "text": "Thanks a lot for this full and great analysis !\n\nI am ok with all points.\nWait a bit for other committers feedback before starting work.\n\nThank you\n\nRegards", "id": 196086, "time": "2017-01-15T22:11:55Z", "bug_id": 60589, "creation_time": "2017-01-15T22:11:55Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 60589, "attachment_id": null, "id": 196231, "time": "2017-01-20T06:14:28Z", "creator": "woonsan@apache.org", "creation_time": "2017-01-20T06:14:28Z", "is_private": false, "text": "I've created an initial pull request. This is not ready for merging, but only for initial review on the direction:\n- https://github.com/apache/jmeter/pull/254\n\nThis PR contains only the following at the moment:\n- Removing dependencies on logkit, excalibur and avalon.\n- Forking some logkit classes in jorphan.\n- NewDriver.java setting log4j2 configuration file location system property.\n- Add jcl-over-slf4j, log4j-1.2-api, jcl-over-slf4j and log4j2 jars.\n- Update LoggingManager to return slf4j logger wrapper.\n\nIt doesn't include a custom appender for the UI and unit test fixes yet. Also requires cleanups.\n\nBut it seems working at runtime with log4j2 now in this steps:\n$ git clone -b feature/bz60589-1 https://github.com/woonsan/jmeter.git\n$ cd jmeter\n$ ant download_jars\n$ ant\n$ cd bin\n$ ./jmeter\nNow, I see jmeter.log being added by log4j2 via logkit fork Logger (wrapping slf4j logger) / LoggingManager.\n\nPlease review the PR and share your thoughts on the direction.\n\nP.S. The original logkit Logger is a class (not an interface) with final methods. So, I decided to remove the final modifier and add abstract modifier for overridable methods (for wrapper impl). And I kept unsupportable methods as NOP impl."}, {"count": 5, "tags": [], "bug_id": 60589, "attachment_id": null, "text": "(In reply to Woonsan Ko from comment #4)\n> I've created an initial pull request. This is not ready for merging, but\n> only for initial review on the direction:\n> - https://github.com/apache/jmeter/pull/254\n> \n> This PR contains only the following at the moment:\n> - Removing dependencies on logkit, excalibur and avalon.\n> - Forking some logkit classes in jorphan.\n> - NewDriver.java setting log4j2 configuration file location system property.\n> - Add jcl-over-slf4j, log4j-1.2-api, jcl-over-slf4j and log4j2 jars.\n> - Update LoggingManager to return slf4j logger wrapper.\n> \n> It doesn't include a custom appender for the UI and unit test fixes yet.\n> Also requires cleanups.\n> \n> But it seems working at runtime with log4j2 now in this steps:\n> $ git clone -b feature/bz60589-1 https://github.com/woonsan/jmeter.git\n> $ cd jmeter\n> $ ant download_jars\n> $ ant\n> $ cd bin\n> $ ./jmeter\n> Now, I see jmeter.log being added by log4j2 via logkit fork Logger (wrapping\n> slf4j logger) / LoggingManager.\n> \n> Please review the PR and share your thoughts on the direction.\n> \n> P.S. The original logkit Logger is a class (not an interface) with final\n> methods. So, I decided to remove the final modifier and add abstract\n> modifier for overridable methods (for wrapper impl). And I kept\n> unsupportable methods as NOP impl.\n\nThe direction looks good to me.\nThanks for your work.\n\nI suppose last step is having:\n- custom appender for the UI \n- The ability to set debug level through the menu\n- Fix Test Units\n\nRegards", "id": 196256, "time": "2017-01-21T08:11:19Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-01-21T08:11:19Z", "is_private": false}, {"count": 6, "text": "Hi,\n\nI think the PR is now ready for review:\n- https://github.com/apache/jmeter/pull/254\n\nHere's what I did with this PR in summary:\n- Removing dependencies on logkit, excalibur, avalon and commons-logging.\n- Adding slf4j and log4j dependencies.\n- Forking minimal logkit interfaces/classes in jorphan module.\n- NewDriver.java setting system properties for log4j2 configuration file location and the log file path (referenced by system property lookup in log4j2.xml files).\n- Migrating logging properties (in jmeter*.properties) to log4j2*.xml files with equivalent comments and examples.\n- Remove logkit initialization in LoggingManager and update it to return slf4j logger wrapper simply.\n- Fixing some unit tests accordingly as logkit LogTarget is not available in unit testing any more.\n- Implement LoggerPanel based on new logging mechanism for full backward compatibility.\n- Keep supporting -j command line option to allow log file setting. Almost full backward compatibility. 'LAST' value is dropped since this option handling happens before GUI initialized.\n- Keep supporting -L command line option to allow log level setting. Full backward compatibility.\n- Introduce -i command line option to allow to change log4j2 configuration file location by command line argument as well as the default log4j2 system property (log4j.configurationFile).\n- Minimal updates in getting started documentation.", "bug_id": 60589, "attachment_id": null, "id": 196444, "time": "2017-01-26T08:22:30Z", "creator": "woonsan@apache.org", "creation_time": "2017-01-26T08:22:30Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "bug_id": 60589, "attachment_id": null, "id": 196445, "time": "2017-01-26T08:29:49Z", "creator": "woonsan@apache.org", "creation_time": "2017-01-26T08:29:49Z", "is_private": false, "text": "(In reply to Philippe Mouawad from comment #5)\n\n> I suppose last step is having:\n> - custom appender for the UI \n\nIt was added and configured in the default log4j2*.xml files.\n\n> - The ability to set debug level through the menu\n\nI'm not sure if we want to do this with this ticket because the UI menu to change log level looks like a new improvement, not part of migration.\nThe PR includes backward compatible option support to change log level (`-L DEBUG' for example). I'd personally like to improve the UI menu for log level setting in a new ticket.\n\n> - Fix Test Units\n\nYes, everything seems to be fixed.\n\nThanks,\n\nWoonsan"}, {"count": 8, "tags": [], "bug_id": 60589, "attachment_id": null, "text": "(In reply to Woonsan Ko from comment #7)\n> (In reply to Philippe Mouawad from comment #5)\n\n> > - The ability to set debug level through the menu\n> \n> I'm not sure if we want to do this with this ticket because the UI menu to\n> change log level looks like a new improvement, not part of migration.\n> The PR includes backward compatible option support to change log level (`-L\n> DEBUG' for example). I'd personally like to improve the UI menu for log\n> level setting in a new ticket.\nI've created a new ticket for the UI menu to allow log level changes:\n- https://bz.apache.org/bugzilla/show_bug.cgi?id=60664\n\nWoonsan", "id": 196566, "time": "2017-01-30T16:03:01Z", "creator": "woonsan@apache.org", "creation_time": "2017-01-30T16:03:01Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 60589, "attachment_id": null, "id": 196728, "time": "2017-02-05T13:42:40Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-02-05T13:42:40Z", "is_private": false, "text": "Author: pmouawad\nDate: Sun Feb  5 13:42:22 2017\nNew Revision: 1781756\n\nURL: http://svn.apache.org/viewvc?rev=1781756&view=rev\nLog:\nBug 60589 - Migrate LogKit to SLF4J - Drop avalon, logkit and excalibur with backward compatibility for 3rd party modules\nPart 1 of PR #254\nContributed by Woonsan Ko\n\nBugzilla Id: 60589\n\nAdded:\n    jmeter/trunk/src/core/org/apache/jmeter/gui/logging/\n    jmeter/trunk/src/core/org/apache/jmeter/gui/logging/GuiLogEventAppender.java   (with props)\n    jmeter/trunk/src/core/org/apache/jmeter/gui/logging/GuiLogEventBus.java   (with props)\n    jmeter/trunk/src/core/org/apache/jmeter/gui/logging/GuiLogEventListener.java   (with props)\n    jmeter/trunk/src/core/org/apache/jmeter/gui/logging/LogEventObject.java   (with props)\nModified:\n    jmeter/trunk/src/core/org/apache/jmeter/JMeter.java\n    jmeter/trunk/src/core/org/apache/jmeter/NewDriver.java\n    jmeter/trunk/src/core/org/apache/jmeter/gui/GuiPackage.java\n    jmeter/trunk/src/core/org/apache/jmeter/gui/LoggerPanel.java\n    jmeter/trunk/src/core/org/apache/jmeter/gui/MainFrame.java\n    jmeter/trunk/src/core/org/apache/jmeter/gui/action/What.java\n    jmeter/trunk/src/core/org/apache/jmeter/samplers/SampleResult.java\n    jmeter/trunk/src/core/org/apache/jmeter/util/JMeterUtils.java"}, {"count": 10, "tags": [], "bug_id": 60589, "attachment_id": null, "text": "Author: pmouawad\nDate: Sun Feb  5 13:43:13 2017\nNew Revision: 1781757\n\nURL: http://svn.apache.org/viewvc?rev=1781757&view=rev\nLog:\nBug 60589 - Migrate LogKit to SLF4J - Drop avalon, logkit and excalibur with backward compatibility for 3rd party modules\nPart 2 of PR #254\nContributed by Woonsan Ko\n\nBugzilla Id: 60589\n\nAdded:\n    jmeter/trunk/src/jorphan/org/apache/jorphan/logging/Slf4jLogkitLogger.java   (with props)\n    jmeter/trunk/src/jorphan/org/apache/log/\n    jmeter/trunk/src/jorphan/org/apache/log/ContextMap.java   (with props)\n    jmeter/trunk/src/jorphan/org/apache/log/LogEvent.java   (with props)\n    jmeter/trunk/src/jorphan/org/apache/log/LogTarget.java   (with props)\n    jmeter/trunk/src/jorphan/org/apache/log/Logger.java   (with props)\n    jmeter/trunk/src/jorphan/org/apache/log/Priority.java   (with props)\nModified:\n    jmeter/trunk/src/jorphan/org/apache/jorphan/logging/LoggingManager.java", "id": 196729, "time": "2017-02-05T13:43:43Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-02-05T13:43:43Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 60589, "attachment_id": null, "text": "Author: pmouawad\nDate: Sun Feb  5 13:44:09 2017\nNew Revision: 1781758\n\nURL: http://svn.apache.org/viewvc?rev=1781758&view=rev\nLog:\nBug 60589 - Migrate LogKit to SLF4J - Drop avalon, logkit and excalibur with backward compatibility for 3rd party modules\nPart 3 of PR #254\nContributed by Woonsan Ko\n\nBugzilla Id: 60589\n\nModified:\n    jmeter/trunk/src/protocol/http/org/apache/jmeter/protocol/http/control/HttpMirrorServer.java", "id": 196730, "time": "2017-02-05T13:44:29Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-02-05T13:44:29Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 60589, "text": "Author: pmouawad\nDate: Sun Feb  5 13:45:14 2017\nNew Revision: 1781759\n\nURL: http://svn.apache.org/viewvc?rev=1781759&view=rev\nLog:\nBug 60589 - Migrate LogKit to SLF4J - Drop avalon, logkit and excalibur with backward compatibility for 3rd party modules\nPart 4 of PR #254\nContributed by Woonsan Ko\n\nBugzilla Id: 60589\n\nAdded:\n    jmeter/trunk/test/src/org/apache/jmeter/gui/logging/\n    jmeter/trunk/test/src/org/apache/jmeter/gui/logging/TestGuiLogEventAppender.java   (with props)\n    jmeter/trunk/test/src/org/apache/jmeter/util/LogRecord.java   (with props)\n    jmeter/trunk/test/src/org/apache/jmeter/util/LogRecordingDelegatingLogger.java   (with props)\nModified:\n    jmeter/trunk/test/src/org/apache/jmeter/JMeterVersionTest.java\n    jmeter/trunk/test/src/org/apache/jmeter/samplers/TestSampleResult.java\n    jmeter/trunk/test/src/org/apache/jorphan/reflect/TestFunctor.java\n    jmeter/trunk/test/src/org/apache/jorphan/test/AllTests.java", "id": 196731, "time": "2017-02-05T13:45:46Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-02-05T13:45:46Z", "is_private": false, "attachment_id": null}, {"text": "Author: pmouawad\nDate: Sun Feb  5 13:46:09 2017\nNew Revision: 1781760\n\nURL: http://svn.apache.org/viewvc?rev=1781760&view=rev\nLog:\nBug 60589 - Migrate LogKit to SLF4J - Drop avalon, logkit and excalibur with backward compatibility for 3rd party modules\nPart 5 of PR #254\nContributed by Woonsan Ko\n\nBugzilla Id: 60589\n\nAdded:\n    jmeter/trunk/bin/testfiles/log4j2-batch.xml   (with props)\nRemoved:\n    jmeter/trunk/bin/log4j.conf\n    jmeter/trunk/bin/logkit.xml\nModified:\n    jmeter/trunk/bin/jmeter.properties\n    jmeter/trunk/bin/mirror-server.cmd\n    jmeter/trunk/bin/mirror-server.sh\n    jmeter/trunk/bin/testfiles/jmeter-batch.properties\n    jmeter/trunk/bin/user.properties", "tags": [], "bug_id": 60589, "attachment_id": null, "count": 13, "id": 196732, "time": "2017-02-05T13:48:01Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-02-05T13:48:01Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 60589, "attachment_id": null, "text": "Author: pmouawad\nDate: Sun Feb  5 13:49:29 2017\nNew Revision: 1781761\n\nURL: http://svn.apache.org/viewvc?rev=1781761&view=rev\nLog:\nBug 60589 - Migrate LogKit to SLF4J - Drop avalon, logkit and excalibur with backward compatibility for 3rd party modules\nPart 6 of PR #254\nContributed by Woonsan Ko\n\nBugzilla Id: 60589\n\nRemoved:\n    jmeter/trunk/res/maven/ApacheJMeter_slf4j_logkit.pom\n\nAuthor: pmouawad\nDate: Sun Feb  5 13:51:56 2017\nNew Revision: 1781762\n\nURL: http://svn.apache.org/viewvc?rev=1781762&view=rev\nLog:\nBug 60589 - Migrate LogKit to SLF4J - Drop avalon, logkit and excalibur with backward compatibility for 3rd party modules\nPart 7 of PR #254\nContributed by Woonsan Ko\n\nRemoved:\n    jmeter/trunk/src/slf4j-logkit/", "id": 196733, "time": "2017-02-05T13:52:40Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-02-05T13:52:40Z", "is_private": false}, {"count": 15, "tags": [], "bug_id": 60589, "attachment_id": null, "text": "Author: pmouawad\nDate: Sun Feb  5 13:55:33 2017\nNew Revision: 1781763\n\nURL: http://svn.apache.org/viewvc?rev=1781763&view=rev\nLog:\nBug 60589 - Migrate LogKit to SLF4J - Drop avalon, logkit and excalibur with backward compatibility for 3rd party modules\nPart 8 of PR 254\nThis closes #254\nContributed by Woonsan Ko\n\nBugzilla Id: 60589\n\nAdded:\n    jmeter/trunk/licenses/bin/jcl-over-slf4j-1.7.22.txt   (with props)\n    jmeter/trunk/licenses/bin/slf4j-ext-1.7.22.txt   (with props)\nModified:\n    jmeter/trunk/LICENSE\n    jmeter/trunk/build.properties\n    jmeter/trunk/build.xml\n    jmeter/trunk/eclipse.classpath\n    jmeter/trunk/lib/   (props changed)\n    jmeter/trunk/lib/aareadme.txt\n    jmeter/trunk/licenses/bin/README.txt\n    jmeter/trunk/res/maven/ApacheJMeter_parent.pom\n    jmeter/trunk/xdocs/changes.xml\n\n\nAuthor: pmouawad\nDate: Sun Feb  5 13:56:05 2017\nNew Revision: 1781764\n\nURL: http://svn.apache.org/viewvc?rev=1781764&view=rev\nLog:\nBug 60589 - Migrate LogKit to SLF4J - Drop avalon, logkit and excalibur with backward compatibility for 3rd party modules\nRemove mention of commons-logging in docs\nBugzilla Id: 60589\n\nModified:\n    jmeter/trunk/xdocs/usermanual/get-started.xml", "id": 196734, "time": "2017-02-05T13:56:45Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-02-05T13:56:45Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 60589, "attachment_id": null, "text": "Author: pmouawad\nDate: Sun Feb  5 14:09:25 2017\nNew Revision: 1781765\n\nURL: http://svn.apache.org/viewvc?rev=1781765&view=rev\nLog:\nBug 60589 - Migrate LogKit to SLF4J - Drop avalon, logkit and excalibur with backward compatibility for 3rd party modules\nPart 9 of PR 254\nAdd missing log4j2.xml under svn\nContributed by Woonsan Ko\n\nBugzilla Id: 60589\n\nAdded:\n    jmeter/trunk/bin/log4j2.xml   (with props)", "id": 196735, "time": "2017-02-05T14:10:19Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-02-05T14:10:19Z", "is_private": false}]