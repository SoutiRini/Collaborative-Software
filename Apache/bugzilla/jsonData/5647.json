[{"count": 0, "tags": [], "creator": "rasand@attglobal.net", "attachment_id": null, "id": 9244, "time": "2002-01-01T13:35:24Z", "bug_id": 5647, "creation_time": "2002-01-01T13:35:24Z", "is_private": false, "text": "Hi all- I've encountered a potential bug in Tomcat 4.0's AJP13 listener.  I \nhave a default installtion of Apache 1.3.22, mod_jk, and Tomcat 4.0.1.  I have \nduplicated this environment on both Windows 2000 and Linux. mod_jk is talking \nto Tomcat via ajp13.  Tomcat is (as default) listening on 8080 for its HTTP \ninterface and on 8009 for ajp13.\n\nThe problem is this: when I access to Tomcat manager application through \nApache+mod_jk, i.e. http://myserver/manager/list, I get properly challenged to \nlog in, but my username and password never work, and Tomcat eventually says I am\nunauthorized.  If I then access the same resource directly through Tomcat,\ni.e. http://myserver:8080/manager/list, I get access with no problem.\n\nThe problem could be in mod_jk, although I suspect it may lie in Tomcat's\najp13 listener (simply because mod_jk is older and more widely used, whereas\nTomcat 4 is newer).\n\nPlease let me know if this is a bug, and if I can assist in any way.\n\nThanks!\n\nBest regards,\n\nRichard"}, {"count": 1, "tags": [], "creator": "thomas2.maesing@bgs-ag.de", "text": "Hi,\nI have observed the same. The latest mod_jk has introduced the\noption not to use the login information from the apche server.\n\nMay be that there is the problem.\n\nI can run my applications with tomcat 3.2.3 and 3.3a and the authentication \nworks fine.\n\nI want to use tomcat 4.0.1 now, but basic authentication does not work with \nmod_jk and ajp 13.", "id": 9925, "time": "2002-01-25T17:54:34Z", "bug_id": 5647, "creation_time": "2002-01-25T17:54:34Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "text": "*** Bug 5951 has been marked as a duplicate of this bug. ***", "is_private": false, "id": 9948, "creator": "remm@apache.org", "time": "2002-01-27T01:27:07Z", "bug_id": 5647, "creation_time": "2002-01-27T01:27:07Z", "attachment_id": null}, {"count": 3, "tags": [], "text": "Hi,\n\nI found a statement about this problem in the tomcat-user mailing list from last\nOctober, which says that realm authentication with ajp13 has not been ported to\nTomcat 4.0.1 yet, but is expected to be ported to Tomcat 4.0.2.\n(http://www.mail-archive.com/tomcat-user%40jakarta.apache.org/msg36130.html)\n\nBest regards\n\nR\u00fcdiger Pl\u00fcm\n", "attachment_id": null, "id": 9971, "creator": "ruediger.pluem@vodafone-telecommerce.de", "time": "2002-01-28T07:35:08Z", "bug_id": 5647, "creation_time": "2002-01-28T07:35:08Z", "is_private": false}, {"count": 4, "tags": [], "text": "Created attachment 1085\nfix by calling RequestBase.setAuthorization()", "is_private": false, "id": 9999, "creator": "ajfitzpatrick@lurking.org", "time": "2002-01-28T23:24:27Z", "bug_id": 5647, "creation_time": "2002-01-28T23:24:27Z", "attachment_id": 1085}, {"count": 5, "tags": [], "bug_id": 5647, "attachment_id": null, "is_private": false, "id": 10101, "time": "2002-01-31T04:14:16Z", "creator": "glenn@apache.org", "creation_time": "2002-01-31T04:14:16Z", "text": "I have seen the same problem.\n\nI applied Adam's patch to jakarta-tomcat-connectors from CVS updated tonight,\nand HTTP Basic Authentication worked, even over SSL.  This was using a\nbuild of Tomcat 4.1-dev from a few weeks ago.\n\nI have the karma to commit this, but since I don't normally work on\nthe apache connectors, I'll leave the commit to one of the regulars."}, {"count": 6, "tags": [], "bug_id": 5647, "attachment_id": null, "id": 10125, "time": "2002-01-31T17:19:41Z", "creator": "glenn@apache.org", "creation_time": "2002-01-31T17:19:41Z", "is_private": false, "text": "Commited Adam's patch to the HEAD of the jakarta-tomcat-connectors\ncvs repository.  Fixed in CVS."}, {"count": 7, "attachment_id": null, "creator": "mike@ds808.net", "text": "Hello,\nI'm the submitter of bug 5951 which was marked a duplicate of this bug.  I just \ndownloaded 4.0.2 which contains the patches above.  I am still having the \n*exact* problem as bug 5951.  Here is a reprint of that bug less the AJP13 \ndebug log which is still at bug 5951.  Can anyone tell me if they successfully \ngot this working under apj13 of the windows redirector? (tomcat 3.3)\n\nThanks Much\nMike\n\nReprint of bug 5951:\nI tried the tomcat 3.2 security example using basic authentication with tomcat \n4 standalone (http connector).  It works fine.  As soon as I use the tomcat 4 \najp13 connector with iis5, it does not work.  Where I expect the authentication \ndialog to appear, it simply just goes directly to a tomcat 4.0.2 http status \n403 - access to the requested resource has been denied screen.  I expected \ntomcat to respond with a Status: 401 unauthorized and a WWW-Authenticate: Basic \nRealm=\"xxxx\" response.  I even tried it with the /manager webapp with the same \nresults.  I even tried it with form base authentication with same results.  \nPlease advise.\n", "id": 10572, "time": "2002-02-12T04:43:26Z", "bug_id": 5647, "creation_time": "2002-02-12T04:43:26Z", "tags": [], "is_private": false}, {"count": 8, "tags": [], "text": "i just tried accessing the manager webapp with 4.0.2 and IIS, without any \nluck.  it appears that the auth challenge is not being done (the WWW-\nAuthenticate header is not sent) across ajp.  so, i'm not sure why, but it's \ndefinitely not working with IIS.  don't know about apache/netscape.", "attachment_id": null, "bug_id": 5647, "id": 10590, "time": "2002-02-12T15:50:02Z", "creator": "seguin@motive.com", "creation_time": "2002-02-12T15:50:02Z", "is_private": false}, {"count": 9, "tags": [], "text": "I've confirmed that the problem still exists in Tomcat 4.0.2. I first rebuilt \nthe native connector from D:\\jakarta-tomcat-connectors-4.0.2-src\\jk\\native\\iis.\n\nI've configured Tomcat4.0.2 with the AJP 1.3 Connector and successfully\ninstalled the iisapi dll from Tomcat3.3 into IIS. I am attempting to serve a\nprotected page through the connector using the protected realm example.\n\nWhen I hit the page directly on port 8080, I get the expected login form\nchallenge behavior. When I hit the page through the connector, I get a 403\naccess denied error.\n \nhttp://localhost:8080/examples/jsp/security/protected/index.jsp redirects to\nthe login screen as expected.\n\nhttp://localhost/examples/jsp/security/protected/index.jsp\nreturns 403 - Access to the requested resource has been denied.\n\nJonathan\n", "is_private": false, "id": 10591, "creator": "jonathan_pierce@seagram.com", "time": "2002-02-12T16:01:37Z", "bug_id": 5647, "creation_time": "2002-02-12T16:01:37Z", "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 5647, "attachment_id": null, "text": "This is related to <http://nagoya.betaversion.org/bugzilla/show_bug.cgi?\nid=2342>, the solution it's not easy, and there is no workaround right now:\n\n1) Implement the \"tomcatAuthentication\" hack from 3.3 in j-t-c's Ajp for 4.0, \nthis way at least we can have TC auth working under IIS.. with IIS you can not \nuse native auth at all, at least with actual ISAPI_PLUGIN..\n\n2) Start the dig to use what Bug#2342 suggest, that is, to use the correct Hook \nin IIS5.. while maitaining IIS4 compatibility..", "id": 10598, "time": "2002-02-12T17:47:00Z", "creator": "nacho@apache.org", "creation_time": "2002-02-12T17:47:00Z", "is_private": false}, {"count": 11, "tags": [], "text": "Hi Nacho,\nMy thoughts is that number 1 should definitely be implemented with or without \nthe 3.3 tomcatAuthentication attribute.  Just want tomcat to honor any \nauthentication situations present in the web.xml file if a request is forwarded \nto tomcat via ajp13 or any other connector.\n\nFor number 2, if we wanted iis5 to do authentication, this patch is one way to \ndo it if you got iis5 and willing to dump users in the windows users db. If you \nare a hosting co. or iis4 user, you can buy software (M$) to take over iisX \nauthentication which runs as an isapi filter with a higher order than tomcat's \nredirector.  So at least there are other options available if you want iisx \nauthentication with or without tomcat authentication.\n\nThanks for allowing me to contribute my input.\nMike\n", "is_private": false, "bug_id": 5647, "id": 10600, "time": "2002-02-12T20:00:37Z", "creator": "mike@ds808.net", "creation_time": "2002-02-12T20:00:37Z", "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 5647, "attachment_id": null, "id": 10737, "time": "2002-02-15T00:38:43Z", "creator": "jonathan_pierce@seagram.com", "creation_time": "2002-02-15T00:38:43Z", "is_private": false, "text": "*** Bug 6219 has been marked as a duplicate of this bug. ***"}, {"count": 13, "tags": [], "bug_id": 5647, "attachment_id": null, "text": "I've confirmed the fix for the AJP13 Connector / Authentication problem in\n4.0.2.\nThis solves high priority bugs 5647 and 6219.\n\nPlease have one of the committers confirm the fix and check it in to cvs. \n\nThe issue was reported in Bug 6219.\n\nI tested the following modification and it seems to resolve the problem.\n\nThe problem is in org.apache.ajp.tomcat4.Ajp13Request.setAjpRequest The fix is\nbelow:\nReplace from line 115:\n\n// String remoteUser = ajp.remoteUser().toString();\n // if(remoteUser != null)\n //   setUserPrincipal(new Ajp13Principal(remoteUser));\n\nString remoteUser = ajp.remoteUser().toString();\nif ((remoteUser != null) && (! remoteUser.equals (\"\")))\n        {\n            setUserPrincipal(new Ajp13Principal(remoteUser));\n        }\n        else\n        {\n         setUserPrincipal(null);\n    }\n\nAfter making this modification, I am able to successfully serve the protected\nexample url through the IIS connector and get properly challenged by the login\nscreen and am able to login and logout as expected.\n\nhttp://localhost/examples/jsp/security/protected/index.jsp\n", "id": 10739, "time": "2002-02-15T00:50:38Z", "creator": "jonathan_pierce@seagram.com", "creation_time": "2002-02-15T00:50:38Z", "is_private": false}, {"count": 14, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "id": 10803, "time": "2002-02-16T08:17:34Z", "bug_id": 5647, "creation_time": "2002-02-16T08:17:34Z", "is_private": false, "text": "This bug has been fixed in j-t-c, by introducing a new property for the AJP\nconnector."}, {"count": 15, "attachment_id": null, "creator": "mike@ds808.net", "text": "Hello,\nI just downloaded nightly build Feb-25 to see if the Feb-16 fix worked.  Using \nthe IIS connector and the /security/protected example, I am still not being \nchallenged by a login screen.  Tomcat just jumps directly to the 403 \nunauthorized screen.  Can anyone else confirm that this problem still exists?\n\nMike\n", "id": 11156, "time": "2002-02-26T06:47:15Z", "bug_id": 5647, "creation_time": "2002-02-26T06:47:15Z", "tags": [], "is_private": false}, {"count": 16, "tags": [], "creator": "seguin@motive.com", "text": "make sure that the jakarta virtual directory does not have \"Integrated Windows \nauthentication\" turned on.  to check/edit this:\n  Internet Services Manager Applet\n    -> Default Web Site\n       -> jakarta -> properties -> Directory Security\n          -> click the \"Edit\" button in the \"Anonymous access and \n             authentication control\" frame.", "id": 11164, "time": "2002-02-26T15:39:11Z", "bug_id": 5647, "creation_time": "2002-02-26T15:39:11Z", "is_private": false, "attachment_id": null}, {"count": 17, "tags": [], "text": "Sorry folks. I just realized the nightly build did not include the updated \nconnectors.  I rebuilt the jk jars from the cvs and EVERYTHING WORKED FINE.  \nThank you.  Is there any way to include this stuff in the nightly builds?\n", "is_private": false, "id": 11167, "creator": "mike@ds808.net", "time": "2002-02-26T18:37:23Z", "bug_id": 5647, "creation_time": "2002-02-26T18:37:23Z", "attachment_id": null}, {"count": 18, "attachment_id": null, "creator": "marcin_ol@poczta.onet.pl", "is_private": false, "id": 11434, "time": "2002-03-04T15:11:38Z", "bug_id": 5647, "creation_time": "2002-03-04T15:11:38Z", "tags": [], "text": "Are you sure the bug is resolved in Tomcat4.0.2 release for IIS connector as \nwell?\nI've added very similar bug for AJP13 with IIS (ID: 6219), and it has been \nmarked as a duplicate of this one...\nBut I've downloaded the 4.0.2, along with new filter DLL for IIS, and the \nproblem still exists.\nMaybe the filter DLL should not include fields, that do not have values, in \nAJP13 packets? Otherwise, the patch from 6219 should be applied to \nAJP13Request.java to get this work.\n"}, {"count": 19, "tags": [], "bug_id": 5647, "attachment_id": null, "id": 11435, "time": "2002-03-04T16:42:47Z", "creator": "marcin_ol@poczta.onet.pl", "creation_time": "2002-03-04T16:42:47Z", "is_private": false, "text": "We did a deep examination, and found that the source of this problem resides \ninside the IIS DLL code, file: jakarta-tomcat-\nconnectors/jk/native/isapi/jk_isapi_plugin.c :\n\n1) The instance 's' of a structure jk_ws_service_t is inited with a call to: \njk_init_ws_service(&s), where the member s.remote_user is set to NULL;\n2) that instance is passed to InitService method, which contains this line:\n  GETVARIABLE(\"REMOTE_HOST\", &s->remote_host, \"\");\n The line simply sets the value of s->remote_host to empty string, instead of \nleaving its NULL. This method affects also other variables.\n3) The AJP message is then filled with variables, that were not present in \noriginal request, but were substitited empty strings instead of NULLs\n4) The AJP13 message parser (in Java), initializes all found variables with no \nvalue with empty arrays, resulting later in their conversion to empty Strings \ninstead of null's. That later (in AJP13Request.java) results in empty Principal \nbeing set in HttpServletRequest.\n\nSolutions: As may be observed in CVS for AJP13Request, the patch was applied to \none version only, and has been removed in current version. So, either apply the \npatch again, or change jk_isapi_plugin.c such that it won't initialize server \nvariables that are not present in original request (just remove the lines from \nInitService function)."}, {"count": 20, "attachment_id": null, "creator": "cedric@wireless-networks.com", "is_private": false, "id": 12280, "time": "2002-03-25T09:50:07Z", "bug_id": 5647, "creation_time": "2002-03-25T09:50:07Z", "tags": [], "text": "I've downloaded the latest 4.0.4beta2, and use it in combination with\nApache 1.3.? from the latest OpenBSD distro.\nIn my web.xml app, I request BASIC authentication.\n\n1) If I put JkMount outside wirtual hosts in httpd.conf, it works.\n\n2) After putting JkMount into one (name) virtual host, it fails (by\nfailing, I mean: the popup windows comes up, but WITH THE WRONG resource\nname (the name of the virtual host:80) and authentication fails.\n\nIs that possible?\nCedric"}, {"count": 21, "attachment_id": null, "creator": "marcin_ol@poczta.onet.pl", "is_private": false, "id": 12331, "time": "2002-03-26T07:31:15Z", "bug_id": 5647, "creation_time": "2002-03-26T07:31:15Z", "tags": [], "text": "That, what I've said on 2002-03-04, is a bit wrong: the AJP connector DLL works \ncorrectly (I've looking at the wrong branch) - as Microsoft said in MSDN, when \nIIS is queried about REMOTE_USER, it returns empty string when user is \nanonymous (and in the correct connector branch, all variables are evaluated by \nquerying IIS, not by examining request directly).\nSo, there are two possible solutions: \n1). Don't call setUserPrincipal(..) in AJP13Request.setAJPRequest\nOR\n2). In FormAuthenticator, check not only for NULL in getUserPrincipal(), but \nalso for empty String.\nThe bug was corrected in CVS version 1.7 of AJP13Request.java only - solution 1 \nwas applied, and then removed in version 1.8."}, {"count": 22, "tags": [], "creator": "robert.priest@bentley.com", "text": "I tried both of those solutions and neither worked for me.\nDid they work for anyone else?\n\nI did do some more digging, and I am finding that jk_isapi_plugin.c\nis seeing the Authorization request, but by the time the request reaches\nRequestHandler.java, authorization is equal to null.\n\nIs this not more closely related to the problem than the setting of the \nprincipal object?\n\n\nHere is essentially what I did to find this info out:\n\nIn HttpFilterProc (jk_isapi_plugin.c) I added:\n\nif(p->GetHeader(pfc, \"Authorization:\", (LPVOID)Authorization, (LPDWORD)\n&szAuthorization)) {\n            jk_log(logger, JK_LOG_ERROR, \n                   \"HttpFilterProc Got Authorization: %s \\n\",Authorization);\n        }else\n\t\t{\n\t\t\tjk_log(logger, JK_LOG_ERROR, \n                   \"HttpFilterProc Authorization Not Found\\n\");\n\t\t}\n\n\nit returned:\n[Tue Mar 26 15:48:21 2002]  [jk_isapi_plugin.c (628)]: HttpFilterProc started\n[Tue Mar 26 15:48:21 2002]  [jk_isapi_plugin.c (648)]: HttpFilterProc Got Author\nization: Basic cHdhZG1pbjpwd2FkbWlu\n\nAND in RequestHandler.decodeRequest(), the base request (BaseRequest.java) is \ndumped to the log if debug (on the connector element in server.xml) is set > 5).\n\t*- I modified BaseRequest.toString() to also print the authorization \nobject.\n\n*BTW - decodeRequest() happens before setAjpRequest().\n\nThat dumps out:\n\n2002-03-26 15:48:21 Ajp13Request[5] Request:\n=== BaseRequest ===\nmethod          = OPTIONS\nprotocol        = HTTP/1.1\nrequestURI      = /slide/test\nremoteAddr      = 127.0.0.1\nremoteHost      = 127.0.0.1\nserverName      = localhost\nserverPort      = 80\nremoteUser      =\nauthType        =\nqueryString     = null\nauthorization   = null\nscheme          = http\nsecure          = false\ncontentLength   = 0\ncontentType     = null\nattributes      = {}\nheaders         = === MimeHeaders ===\naccept-language = en-us\nconnection = close\nhost = localhost\nuser-agent = WebDrive/5.01 NT\npragma = no-cache\ncontent-length = 0\n\ncookies         = === Cookies ===\n\njvmRoute        = null\n\n\nIsn't our problem here?\n", "id": 12360, "time": "2002-03-26T21:12:18Z", "bug_id": 5647, "creation_time": "2002-03-26T21:12:18Z", "is_private": false, "attachment_id": null}, {"count": 23, "tags": [], "creator": "nacho@apache.org", "attachment_id": null, "id": 17842, "time": "2002-06-15T01:08:47Z", "bug_id": 5647, "creation_time": "2002-06-15T01:08:47Z", "is_private": false, "text": "If anyone has already problems, please check against 4.0.4, this bug seems to \nbe fixed from some time ago..\n\nThere some good explations in the bug's log about how to config IIS & Tomcat to \nget done, please check them before reopen.."}, {"count": 24, "tags": [], "text": "When using Tomcat 4.0.3 all works fine, but after we switch to Tomcat 4.0.4\n(final) whe no longer get the REMOTE_USER from IIS (REMOTE_USER is null).\nWorkaround: copy the tomcat-ajp.jar from version 4.0.3 to 4.0.4 and it works \nagain.", "attachment_id": null, "id": 19754, "creator": "mail@nethyperon.com", "time": "2002-07-18T09:03:46Z", "bug_id": 5647, "creation_time": "2002-07-18T09:03:46Z", "is_private": false}, {"count": 25, "tags": [], "bug_id": 5647, "attachment_id": null, "is_private": false, "id": 19758, "time": "2002-07-18T11:38:46Z", "creator": "nacho@apache.org", "creation_time": "2002-07-18T11:38:46Z", "text": "You need to set the attribute tomcatAuthentication=\"false\" in the ajp13 \nconnector line, inside serevr.xml, not sure if coyote/jk2 supports that \nalready..\n\nBut this bug was posted against the original Ajp13 connector , sio i'm closing \nit, please add another bug, if you are having problems with Coyote/jk2, this \none has much information very outdated and perhaps is worse to maintain it.. \nthan to open another\n\nThanks.."}, {"count": 26, "tags": [], "bug_id": 5647, "attachment_id": null, "id": 45101, "time": "2003-10-05T18:07:27Z", "creator": "medthomas@ntlworld.com", "creation_time": "2003-10-05T18:07:27Z", "is_private": false, "text": "*** Bug 5951 has been marked as a duplicate of this bug. ***"}]