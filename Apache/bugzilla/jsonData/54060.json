[{"count": 0, "tags": [], "bug_id": 54060, "is_private": false, "text": "From DigestAuthenticator at line 546\n\n            // Bugzilla 37132: http://issues.apache.org/bugzilla/show_bug.cgi?id=37132\n            String[] tokens = authorization.split(\",(?=(?:[^\\\"]*\\\"[^\\\"]*\\\")+$)\");\n\nif the last term in the line is not enclosed in quotes, only a single 'term' results. For example:\n\nHeader: username=\"mthornton\", qop=auth\ntoken[0] is username=\"mthornton\", qop=auth\n\nHeader: username=\"mthornton\", qop=auth, cnonce=\"9926cb3c334ede11\"\ntoken[0] is username=\"mthornton\"\ntoken[1] is  qop=auth\ntoken[2] is  cnonce=\"9926cb3c334ede11\"\n\n(Headers abbreviated for clarity).", "id": 163007, "time": "2012-10-28T21:36:52Z", "creator": "mthornton@optrak.com", "creation_time": "2012-10-28T21:36:52Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 54060, "attachment_id": 29515, "id": 163008, "time": "2012-10-28T21:45:15Z", "creator": "mthornton@optrak.com", "creation_time": "2012-10-28T21:45:15Z", "is_private": false, "text": "Created attachment 29515\nSimple test of the parsing\n\nTest code for the erroneous line in DigestAuthenticator.\n\nIncludes two examples taken from actual logs of submitted headers.\nPlus two pruned examples."}, {"count": 2, "tags": [], "bug_id": 54060, "attachment_id": null, "text": "The current parsing would also be broken by including an embedded quote in fields (e.g. in the cnonce field). E.g. cnonce=\"Mgytrr\\\"gfh\"\n\nLooking for a regular expression that correctly handles this syntax may not be sensible.", "id": 163016, "time": "2012-10-29T10:10:50Z", "creator": "mthornton@optrak.com", "creation_time": "2012-10-29T10:10:50Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 54060, "is_private": false, "text": "Created attachment 29518\nProposed patch fixes problem\n\nA more rigorous parsing of header lines might be appropriate", "id": 163029, "time": "2012-10-29T15:21:54Z", "creator": "mthornton@optrak.com", "creation_time": "2012-10-29T15:21:54Z", "attachment_id": 29518}, {"id": 163030, "tags": [], "creator": "mthornton@optrak.com", "is_private": false, "count": 4, "text": "The patch is against 7.0.30 because that is the most recent version packaged for Ubuntu 12.10.", "time": "2012-10-29T15:28:00Z", "bug_id": 54060, "creation_time": "2012-10-29T15:28:00Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 54060, "is_private": false, "text": "diff -u format for the patch please. I'm tempted to use the HTTP header parser for this. It'll need a fair bit of work for this though.", "id": 163032, "time": "2012-10-29T17:10:02Z", "creator": "markt@apache.org", "creation_time": "2012-10-29T17:10:02Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 54060, "attachment_id": 29519, "text": "Created attachment 29519\nPatch in alternative format\n\nI hope this the preferred format\nresult of git diff -p", "id": 163034, "time": "2012-10-29T18:26:00Z", "creator": "mthornton@optrak.com", "creation_time": "2012-10-29T18:26:00Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 54060, "attachment_id": null, "text": "Thanks. Much more readable.\n\nI'm currently mulling over how to handle this. The HttpParser is very heavy-weight but the simple approach is demonstrably prone to failure. I'm wondering if writing a generic HTTP header value parser is the way to go. I may experiment a little and see what I can come up with.", "id": 163044, "time": "2012-10-29T20:54:34Z", "creator": "markt@apache.org", "creation_time": "2012-10-29T20:54:34Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 54060, "is_private": false, "text": "I have added a first cut of a new HTTP header parser to trunk. The tests attached to this issue pass but there is more work to do before the new parser can be used to solve this issue.", "id": 163136, "time": "2012-11-01T21:30:45Z", "creator": "markt@apache.org", "creation_time": "2012-11-01T21:30:45Z", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 54060, "text": "This has been fixed in trunk and 7.0.x and will be included in 7.0.33 onwards.", "id": 163153, "time": "2012-11-03T15:51:01Z", "creator": "markt@apache.org", "creation_time": "2012-11-03T15:51:01Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 54060, "attachment_id": null, "id": 164041, "time": "2012-12-12T22:37:39Z", "creator": "srowen@apache.org", "creation_time": "2012-12-12T22:37:39Z", "is_private": false, "text": "Hello all, first I would like to say that I think this patch is entirely right. I even checked against RFC 2617. But after this change I'm noticing that DIGEST authentication stops working in Safari, curl, and Java's SDK. Chrome is fine.\n\nThe reason, it seems, is that their Digest response includes either algorithm=\"MD5\" when it should be algorithm=MD5, or qop=\"auth\" when it should be qop=auth.\n\nFor example, from curl:\n\n* Connection #0 to host localhost left intact\n* Issue another request to this URL: 'https://localhost:8453/ready'\n* Re-using existing connection! (#0) with host localhost\n* Connected to localhost (::1) port 8453 (#0)\n* Server auth using Digest with user 'foo'\n> HEAD /ready HTTP/1.1\n> Authorization: Digest username=\"foo\", realm=\"Myrrix\", nonce=\"1355351469307:f5864c38c03153e941d0e0ec6e6b625f\", uri=\"/ready\", cnonce=\"MTM1NTM1\", nc=00000001, qop=\"auth\", response=\"cccab2adb7a9c59f9eeac8b6981e79c0\", opaque=\"B1094CC78FA4B4D9288C50B02C975C0F\"\n> User-Agent: curl/7.21.4 (universal-apple-darwin11.0) libcurl/7.21.4 OpenSSL/0.9.8r zlib/1.2.5\n> Host: localhost:8453\n> Accept: */*\n\nIn the new implementation this means the parser rejects it since it is not expecting a quoted field.\n\n\nGoing back to the prior version of Tomcat works in the sense that the old parser was (too) lenient on incorrect quoting. Also changing these fields to be treated like type 'FIELD_TYPE_QUOTED_STRING' works.\n\nIt's not a bug in Tomcat though AFAICT. But if it really means a lot of popular implementations don't work with it, I dunno, maybe worth revisiting."}, {"count": 11, "tags": [], "bug_id": 54060, "text": "(In reply to comment #10)\n> \n> The reason, it seems, is that their Digest response includes either\n> algorithm=\"MD5\" when it should be algorithm=MD5, or qop=\"auth\" when it\n> should be qop=auth.\n> \n\nQuoting of qop was allowed by r1429124 (following bug 54372 ).\n\nWhat clients quote the algorithm field?\n(I do not mind to fix it in the same way, but I would like to know the reason).", "id": 164545, "time": "2013-01-10T02:59:34Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-01-10T02:59:34Z", "is_private": false, "attachment_id": null}, {"id": 164881, "tags": [], "bug_id": 54060, "attachment_id": null, "count": 12, "text": "Hello Konstantin, it's the JVM that seems to send a bad algorithm value. I've reproduced it in the following, at least:\n\n- Java 1.6.0_37 for Mac OS X\n- Java 1.7.0_10 for Mac OS X\n- OpenJDK 1.7.0_09 for Linux\n\nThey send something like...\n\nDigest username=\"foo\", realm=\"Myrrix\", nonce=\"1359097999996:13ed87b1b78c157232d609a099bcdb6e\", nc=00000001, uri=\"/ready\", response=\"b6f80b049b4b39000da79c96442e0740\", algorithm=\"MD5\", opaque=\"3E8794E4CE80B19E5DF888D615FFBBA5\", cnonce=\"DGKKOPAFPJKCKKBDLFECINONACKFJIFNDOGKGLIO\", qop=\"auth\"\n\nalgorithm=\"MD5\" is the culprit.\n\n(Indeed looks like this is just wrong in the latest OpenJDK 7 source, at least: http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/7-b147/sun/net/www/protocol/http/DigestAuthentication.java?av=f#367 I will see about filing a bug.)\n\nIf I modify the code such that the \"algorithm\" field is treated as \"FIELD_TYPE_QUOTED_STRING\" then it works, and other clients seem to still work (Safari, Chrome, curl at least).\n\nIt would indeed be great to apply the same workaround, thanks!", "time": "2013-01-25T07:29:34Z", "creator": "srowen@apache.org", "creation_time": "2013-01-25T07:29:34Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 54060, "is_private": false, "text": "REOPENing the issue to address Comment 12", "id": 164908, "time": "2013-01-28T12:42:10Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-01-28T12:42:10Z", "attachment_id": null}, {"count": 14, "tags": [], "bug_id": 54060, "text": "Fixed in trunk and 7.0.x and will be included in 7.0.36 onwards.\n\nalgorithm is now permitted to be a quoted token. Note no such definition exists in the specs. It is <\"><TOKEN><\"> as some clients insist on adding quotes to tokens.", "id": 164909, "time": "2013-01-28T15:13:09Z", "creator": "markt@apache.org", "creation_time": "2013-01-28T15:13:09Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "bug_id": 54060, "text": "HttpClient is a culprit in quoting algorithm. Unfortunately Ubuntu 13.04 uses TomCat 7.0.35 and is thus affected. I have filed an issue with HttpClient:\nhttps://issues.apache.org/jira/browse/HTTPCLIENT-1354", "id": 167326, "time": "2013-05-21T13:00:40Z", "creator": "mthornton@optrak.com", "creation_time": "2013-05-21T13:00:40Z", "is_private": false, "attachment_id": null}]