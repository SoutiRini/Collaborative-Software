[{"count": 0, "tags": [], "creator": "roman.hlynovskiy@gmail.com", "attachment_id": null, "text": "Hello!\n\nI am getting steady segmentation fault in apache2 with virtualhosts count > 1330\n\nMy system configuration is:\ndebian testing\nkernel 2.4.30\nlibc 2.3.6\napache2 2.0.59\nlibssl 0.9.8b\n\nhere is gdb trace:\n(gdb) set args -f /etc/apache2-204/apache2.conf\n(gdb) br RAND_SSLeay\nFunction \"RAND_SSLeay\" not defined.\nMake breakpoint pending on future shared library load? (y or [n]) y\nBreakpoint 1 (RAND_SSLeay) pending.\n(gdb) r\nStarting program: /usr/local/src/httpd-2.0.59/.libs/apache2 -f\n/etc/apache2-204/apache2.conf\n[Thread debugging using libthread_db enabled]\n[New Thread 16384 (LWP 29369)]\nBreakpoint 2 at 0x40116610\nPending breakpoint \"RAND_SSLeay\" resolved\n[Switching to Thread 16384 (LWP 29369)]\n\nBreakpoint 2, 0x40116610 in RAND_SSLeay () from\n/usr/lib/i686/cmov/libcrypto.so.0.9.8\n(gdb) n\nSingle stepping until exit from function RAND_SSLeay, \nwhich has no line number information.\n0x4011775a in RAND_get_rand_method () from /usr/lib/i686/cmov/libcrypto.so.0.9.8\n(gdb) n\nSingle stepping until exit from function RAND_get_rand_method, \nwhich has no line number information.\n0x40117977 in RAND_status () from /usr/lib/i686/cmov/libcrypto.so.0.9.8\n(gdb) bt\n#0  0x40117977 in RAND_status () from /usr/lib/i686/cmov/libcrypto.so.0.9.8\n#1  0x40bc4aa8 in ssl_rand_seed (s=0x80bbfc0, p=0x80eef48, nCtx=SSL_RSCTX_STARTUP, \n    prefix=0x40bd1729 \"Init: \") at ssl_engine_rand.c:132\n#2  0x40bbda3e in ssl_init_Module (p=0x80b6e68, plog=0x80ecf40, ptemp=0x80eef48,\nbase_server=0x80bbfc0)\n    at ssl_engine_init.c:253\n#3  0x08078faa in ap_run_post_config (pconf=0x80b6e68, plog=0x80ecf40,\nptemp=0x80eef48, s=0x80bbfc0)\n    at config.c:86\n#4  0x0807e94b in main (argc=3, argv=0xbffffac4) at main.c:570\n(gdb) n\nSingle stepping until exit from function RAND_status, \nwhich has no line number information.\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x4011723a in RAND_SSLeay () from /usr/lib/i686/cmov/libcrypto.so.0.9.8\n(gdb) bt\n#0  0x4011723a in RAND_SSLeay () from /usr/lib/i686/cmov/libcrypto.so.0.9.8\n#1  0x0000000a in ?? ()\n#2  0x00000013 in ?? ()\n#3  0x4018f9de in CAST_S_table0 () from /usr/lib/i686/cmov/libcrypto.so.0.9.8\n#4  0x00000227 in ?? ()\n#5  0x00000000 in ?? ()\n\ni.e. segfault occurs in RAND_status call from ssl_engine_rand.c of mod_ssl\n\nbug is reprodusable at any time on the server\n\nsegfault occurs only if number of vhosts is > 1330.\nif I decrease number of vhosts to less than 1330, problem goes away.\ncurrently, I start apache with commented-out vhosts (i.e. in order to have less\nthan 1330 vhosts), after that uncomment previously-commented and reload apache. \n\ncommon apache config looks like:\n\n<VirtualHost A.B.C.D:80>\n        ServerName   DOMAIN:80\n        ServerAlias  www.DOMAIN.kz\n        UseCanonicalName Off\n        DocumentRoot /httpdocs\n        DocumentChroot /var/www/vhosts/DOMAIN\n        CustomLog  /var/www/vhosts/DOMAIN/statistics/logs/access_log plesklog\n        ErrorLog   /var/www/vhosts/DOMAIN/statistics/logs/error_log\n<IfModule mod_userdir.c>\n        UserDir /web_users\n</IfModule>\n        <IfModule mod_ssl.c>\n                SSLEngine off\n        </IfModule>\n        <Directory /httpdocs>\n        <IfModule mod_php4.c>\n                php_admin_flag engine on\n                php_admin_value open_basedir \"/httpdocs:/tmp:/usr/share/php\"\n        </IfModule>\n        <IfModule mod_php5.c>\n                php_admin_flag engine on\n                php_admin_value open_basedir \"/httpdocs:/tmp:/usr/share/php\"\n        </IfModule>\n                Options -Includes -ExecCGI\n        </Directory>\n        <Directory /web_users>\n        <IfModule mod_php4.c>\n                AddType text/plain .php .php4 .php3 .phtml\n                php_admin_flag engine off\n        </IfModule>\n        <IfModule mod_php5.c>\n                AddType text/plain .php .php5 .php4 .php3 .phtml\n                php_admin_flag engine off\n        </IfModule>\n        </Directory>\n</VirtualHost>\n\ni.e. SSL is disabled for 99% of vhosts", "id": 92013, "time": "2006-08-08T05:41:19Z", "bug_id": 40205, "creation_time": "2006-08-08T05:41:19Z", "is_private": false}, {"count": 1, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "text": "Can you capture the strace output?\n\n# strace -o /tmp/httpd.trace /path/to/httpd -X\n\nthen use the \"attachment\" feature in bugzilla to attach /tmp/httpd.trace.\n\nThe OpenSSL RAND code will randomly corrupt memory if it uses select() with fd\nnumbers >= 1024; that is likely to be the case here.", "id": 92022, "time": "2006-08-08T13:08:05Z", "bug_id": 40205, "creation_time": "2006-08-08T13:08:05Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 40205, "attachment_id": 18692, "id": 92073, "time": "2006-08-09T04:15:11Z", "creator": "roman.hlynovskiy@gmail.com", "creation_time": "2006-08-09T04:15:11Z", "is_private": false, "text": "Created attachment 18692\nhttpd2 trace\n\nhttpd2 strace output with SIGSEGV on RAND_status call"}, {"count": 3, "attachment_id": 20904, "creator": "jd@cpanel.net", "text": "Created attachment 20904\nUgly fix\n\nThis is really an OpenSSL bug:\n\nhttp://marc.info/?l=openssl-dev&m=114301777619250&w=2\n\nSupposed to be fixed in 0.9.8c and 0.9.7k AFAICT.\n\nIt would be nice if Apache 2.0 and 2.2 skipped the RAND_status() check when\nolder versions of OpenSSL are used.", "id": 108872, "time": "2007-10-01T16:42:46Z", "bug_id": 40205, "creation_time": "2007-10-01T16:42:46Z", "tags": [], "is_private": false}, {"count": 4, "attachment_id": null, "creator": "wrowe@apache.org", "text": "\"It would be nice if Apache 2.0 and 2.2 skipped the RAND_status() check when\nolder versions of OpenSSL are used.\"\n\nThere are a host of reasons not to encourage the use of older OpenSSL's when\nApache https: server is built.  Obviously the same forces are in play when\nattempted to reduce the entropy check of the running instance of libssl.\n\nMarking INVALID as not-an-httpd bug.\n\n ", "id": 108874, "time": "2007-10-01T18:45:10Z", "bug_id": 40205, "creation_time": "2007-10-01T18:45:10Z", "tags": [], "is_private": false}]