[{"count": 0, "tags": [], "bug_id": 25515, "attachment_id": null, "is_private": false, "id": 49108, "time": "2003-12-14T21:31:58Z", "creator": "spam99@2thebatcave.com", "creation_time": "2003-12-14T21:31:58Z", "text": "I have 2 apache 1.3.29 servers, server1 listens port 80 (on a firewall box),\nserver2 also listens on port 80 (on a box behind the firewall).  The firewall is\nconfigured to forward incoming requests for port 82 to server2 on port 80.\n\nBoth servers are configured for \"UseCanonicalName off\".  However apache seems to\nget it's port (for redirect purposes) from where it is listening on, and not\nfrom the user requests.  The documentation for UseCanonicalName says \"With\nUseCanonicalName Off Apache will form self-referential URLs using the hostname\nand port supplied by the client\".  My testing is as follows:\n\n\nWith the config as above, I can try this (replacing the actual FQDNs & IPs of\ncourse).  Note that both servers have a directory called \"/config\" that requires\nauthentication, but the passwords on each server are different.\n\nwget --http-user=test1 --http-passwd=test1 \"http://server2:82/config\"\n\n--15:04:07--  http://server2:82/config\n           => `config'\nResolving server2... done.\nConnecting to server2[10.1.1.1]:82... connected.\nHTTP request sent, awaiting response... 301 Moved Permanently\nLocation: http://server2/config/ [following]\n--15:04:07--  http://server2/config/\n           => `index.html'\nConnecting to server2[10.1.1.1]:80... connected.\nHTTP request sent, awaiting response... 401 Authorization Required\nAuthorization failed.\n\nAs you can see I connected fine to port 82, but I was redirected to port 80. \nNow if I change server2 to listen on port 82 (and thus change the port forward\nfrom 82->80 to 82->82), the redirect will be correct:\n\n wget --http-user=test1 --http-passwd=test1 \"http://server2:82/config\"\n--15:03:26--  http://server2:82/config\n           => `config'\nResolving server2... done.\nConnecting to server2[10.1.1.1]:82... connected.\nHTTP request sent, awaiting response... 301 Moved Permanently\nLocation: http://server2:82/config/ [following]\n--15:03:26--  http://server2:82/config/\n           => `index.html'\nConnecting to server2[10.1.1.1]:82... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: unspecified [text/html]\n\nI verified that \"UseCanonicalName off\" was working by using another servername\nthat pointed to the same external ip.  It does use the user supplied servername\nas expected.\n\nIt is almost as if apache looks at the user specified hostname and port, but\nthen checks to make sure that the user supplied port matches with one it is\nlistening on, and then dropps the user supplied port if it does not match.\n\nFrom my interpretation of the documentation, it does not appear that this\nbehaviour is correct."}, {"count": 1, "text": "I have encountered the problem, and use the workaround below.\n\n# Add / to directory requests.  This is normally done by mod_dir, but mod_dir\n# drops the port from HTTP_HOST for some reason, which results in a redirect\n# to the wrong port if port forwarding is in use.\nRewriteCond %{REQUEST_FILENAME} -d\nRewriteRule ^/(.+)[^/]$ http://%{HTTP_HOST}%{REQUEST_URI}/ [R=301]\n", "bug_id": 25515, "attachment_id": null, "id": 50095, "time": "2004-01-05T19:37:07Z", "creator": "jodym@oeone.com", "creation_time": "2004-01-05T19:37:07Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 25515, "attachment_id": null, "id": 50819, "time": "2004-01-20T16:19:45Z", "creator": "pedietz@west.com", "creation_time": "2004-01-20T16:19:45Z", "is_private": false, "text": "See the enhancement request 24442.\n\nhttp://nagoya.apache.org/bugzilla/show_bug.cgi?id=24442\n"}, {"text": "After upgrading to 1.3.31, it looks like this bug has been fixed.", "tags": [], "bug_id": 25515, "is_private": false, "count": 3, "id": 60121, "time": "2004-07-03T23:05:22Z", "creator": "spam99@2thebatcave.com", "creation_time": "2004-07-03T23:05:22Z", "attachment_id": null}]