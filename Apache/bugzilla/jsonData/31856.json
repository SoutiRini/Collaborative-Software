[{"count": 0, "tags": [], "bug_id": 31856, "attachment_id": null, "is_private": false, "id": 65531, "time": "2004-10-22T20:14:26Z", "creator": "ddkilzer@kilzer.net", "creation_time": "2004-10-22T20:14:26Z", "text": "A certificate and private key created by Java's keytool and extracted using\nvarious tools for use with the SSLProxyMachineCertificateFile directive causes\nApache2's child process (on Windows) to crash (and then reload).  Here are the\nerror messages printed to the error.log:\n\n[Fri Oct 22 15:09:16 2004] [notice] Parent: child process exited with status\n3221225477 -- Restarting.\n[Fri Oct 22 15:09:17 2004] [notice] Parent: Created child process 1488\n[Fri Oct 22 15:09:19 2004] [notice] Child 1488: Child process is running\n[Fri Oct 22 15:09:19 2004] [notice] Child 1488: Acquired the start mutex.\n[Fri Oct 22 15:09:19 2004] [notice] Child 1488: Starting 250 worker threads.\n\nI will post instructions on how to reproduce this error, sample files, and a\nwork-around next."}, {"count": 1, "tags": [], "text": "To reproduce the error, a certificate and key must be created using Java's\nkeytool, then the cert and key extracted using various means.  I used\ninformation from this web page to help me in the extraction process:\n\n  http://mark.foster.cc/kb/openssl-keytool.html\n\nAlso note that I'm using this pre-compiled distribution to test:\n\n  http://hunter.campbus.com/\n  http://hunter.campbus.com/Apache_2.0.52-Openssl_0.9.7d-Win32.zip\n\nFinally, I am hitting a Tomcat 5.0.28 server on the back end that is configured\nto require client authentication (referencing the JKS keystore created in step 1).\n\n1. Create a self-signed certificate and key in JKS format using Java's keytool.\n I used j2sdk1.4.2_06 for Win32:\n\nD:\\> D:\\j2sdk1.4.2_06\\bin\\keytool -genkey -alias crashapache2 -keyalg RSA\n-keystore 31856.jks\nPassword: pass12\nFirst and Last Name: Crash Apache2\nName of Organizational Unit: Bugzilla\nName of Organization: ASF\nName of City: Forest Hill\nName of State: Maryland\nTwo-letter ISO country: US\nIs [...] correct? yes\nEnter password for <crashapache2>:  [hit Enter]\n\n2. Use keytool to extract the certificate in DER format:\n\nD:\\> D:\\j2sdk1.4.2_06\\bin\\keytool -export -alias crashapache2 -keystore\n31856.jks -file crashapache2-der.crt\nEnter keystore password: pass12\n\n3. Use OpenSSL to convert the DER-encoded certificate to PEM-encoded:\n\nD:\\> D:\\Apache2\\bin\\openssl x509 -out crashapache2.crt -outform pem -text -in\ncrashapache2-der.crt -inform der\n\n4. Use the ExportPriv.java class\n(http://mark.foster.cc/pub/java/ExportPriv.java) to extract the private key.\n\nD:\\> D:\\j2sdk1.4.2_06\\bin\\javac ExportPriv.java\nD:\\> D:\\j2sdk1.4.2_06\\bin\\java ExportPriv 31856.jks crashapache2 pass12 >\ncrashapache2.key\n\n5. Combine the crashapache2.crt and crashapache2.key files into a single file,\ncrashapache2.crtkey, and remove the extraneous text so that the file looks like\nthis:\n\n-----BEGIN CERTIFICATE-----\nMII...\n-----END CERTIFICATE-----\n-----BEGIN PRIVATE KEY-----\nMII...\n-----END PRIVATE KEY-----\n\nIMPORTANT NOTE: The file must contain UNIX-style line endings!  If DOS-style\nline endings are used, the file will not be parsed properly.  (I used Cygwin and\nvim to accomplish this.)\n\n6. Reference the crashapache2.crtkey file in the SSLProxyMachineCertificateFile\ndirective, restart Apache, then try to access a protected URL.  The error\nmessages should be printed to error.log (assuming there is an error log defined\noutside of all virtual hosts).\n\nIMPORTANT NOTE:  The remote server MUST be set up properly to use the same\ncertificate and private key, or else you will NOT see this error message. \nInstead, this message will be printed to the virtual-host-specific error log:\n\n[Fri Oct 22 16:08:42 2004] [error] (20014)Error string not specified yet: proxy:\nrequest failed to W.X.Y.Z:8443 (fully.qualified.host.name)\n", "is_private": false, "id": 65543, "creator": "ddkilzer@kilzer.net", "time": "2004-10-22T21:13:57Z", "bug_id": 31856, "creation_time": "2004-10-22T21:13:57Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 31856, "text": "In step 6, when I said that the remote server must be, \"set up properly to use\nthe same certificate and private key\", I meant that the remote server must be\nconfigured to expect the same certificate and private key to be used for client\nauthentication.  The remote server needs a different certificate and private key\nto communicate via https.  I will note this when uploading the Tomcat server.xml\nconfig file later.", "id": 65545, "time": "2004-10-22T21:16:35Z", "creator": "ddkilzer@kilzer.net", "creation_time": "2004-10-22T21:16:35Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 31856, "text": "The workaround to fix this issue is to re-encode the private key using the\nOpenSSL tool:\n\nD:\\> rename crashapache2.key crashapache2-java.key\nD:\\> D:\\Apache2\\bin\\openssl rsa -in crashapache2-java.key -out crashapache2.key\n\nThen use the re-encoded crashapache2.key to add to the crashapache2.crtkey file.\n REMINDER: The crashapache2.crtkey file must have UNIX-style line endings!\n\nAfter restarting Apache, it should be able to access the remote server (Tomcat\nin my case) without any problems.\n", "id": 65546, "time": "2004-10-22T21:42:02Z", "creator": "ddkilzer@kilzer.net", "creation_time": "2004-10-22T21:42:02Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "text": "Created attachment 13197\nTomcat 5.0.28 config file", "is_private": false, "id": 65547, "creator": "ddkilzer@kilzer.net", "time": "2004-10-22T21:57:36Z", "bug_id": 31856, "creation_time": "2004-10-22T21:57:36Z", "attachment_id": 13197}, {"count": 5, "tags": [], "creator": "ddkilzer@kilzer.net", "attachment_id": 13198, "id": 65548, "time": "2004-10-22T22:02:19Z", "bug_id": 31856, "creation_time": "2004-10-22T22:02:19Z", "is_private": false, "text": "Created attachment 13198\nExportPriv.java: source for the ExportPriv class"}, {"count": 6, "tags": [], "text": "Created attachment 13199\nhttpd.conf: Apache 2.0.52 config file", "attachment_id": 13199, "id": 65552, "creator": "ddkilzer@kilzer.net", "time": "2004-10-22T22:20:57Z", "bug_id": 31856, "creation_time": "2004-10-22T22:20:57Z", "is_private": false}, {"count": 7, "tags": [], "creator": "ddkilzer@kilzer.net", "text": "Created attachment 13200\n31856.jks: Java keystore holding example client cert and private key", "id": 65553, "time": "2004-10-22T22:23:18Z", "bug_id": 31856, "creation_time": "2004-10-22T22:23:18Z", "is_private": false, "attachment_id": 13200}, {"count": 8, "tags": [], "creator": "ddkilzer@kilzer.net", "text": "Created attachment 13201\ncrashapache2-bad.crtkey: PEM-encoded cert and private key (causes crash)", "id": 65554, "time": "2004-10-22T22:24:37Z", "bug_id": 31856, "creation_time": "2004-10-22T22:24:37Z", "is_private": false, "attachment_id": 13201}, {"count": 9, "tags": [], "bug_id": 31856, "attachment_id": 13202, "is_private": false, "id": 65555, "time": "2004-10-22T22:25:17Z", "creator": "ddkilzer@kilzer.net", "creation_time": "2004-10-22T22:25:17Z", "text": "Created attachment 13202\ncrashapache2.crtkey: PEM-encoded cert and private key (works)"}, {"count": 10, "tags": [], "creator": "ddkilzer@kilzer.net", "text": "Test environment setup:\n\n1. To set up an instance of Tomcat 5.0.28, download the Tomcat 5.0.28 config\nfile (rename to \"server.xml\" and replace the default server.xml), and create a\nself-signed certificate and key called keystore.jks (password: pass00) using the\nJava keytool.\n\n2. Download the Apache config file, rename to \"httpd.conf\", and replace the\ndefault httpd.conf file.  You will have to change the following items in this file:\n\n- \"W.X.Y.Z\" with a local IP address to which to bind\n- \"local.host.name\" with the local hostname for the \"W.X.Y.Z\" IP address\n- \"remote.host.name\" with the remote hostname (to which Tomcat is bound)\n\nYou will also have to create a certificate and a private key called\n\"local-ssl.crt\" and \"local-ssl.key\" to run SSL on Apache (or optionally disable\nthese directives).\n\n3. Download 31856.jks and place it in Tomcat's conf directory.\n\n4. Download crashapache2-bad.crtky and crashapache2.crtkey and place them in\nApache's conf directory.  Rename crashapache2-bad.crtkey to crashapache2.crtkey\nto test the crash condition.\n\n5. Restart both servers and test.\n\nNote that you may also use OpenSSL to create a pkcs12 file from the certificate\nand the private key (see http://mark.foster.cc/kb/openssl-keytool.html) to test\nhitting Tomcat directly from a web browser.  Simply import the pkcs12 file into\n\"Your Certificates\" in Mozilla or Firefox to test this.\n\nWhew!  I hope that's enough info to reproduce this issue.\n", "id": 65558, "time": "2004-10-22T22:41:20Z", "bug_id": 31856, "creation_time": "2004-10-22T22:41:20Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "bug_id": 31856, "attachment_id": null, "text": "I had a thought on the way home as to what the problem may be.\n\nIf mod_ssl assumes (requires) that the base64-encoded private key end with an\nequals sign (=), then the bad key could be fixed by adding an equals sign to the\nend of the base64-encoded text.  (Conversely, the good key could be made bad by\nremoving the equals sign.)\n\nThis should be fairly easy to verify (through testing or through code review).\n", "id": 65567, "time": "2004-10-23T05:10:28Z", "creator": "ddkilzer@kilzer.net", "creation_time": "2004-10-23T05:10:28Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 31856, "attachment_id": null, "text": "1) What gets logged with \"LogLevel debug\", particularly the \"Proxy client\ncertificate callback:\" calls?\n\n2) can you apply the patch referenced from bug 24030, rebuild and retest?  It\ndoesn't look like the same problem but it would be quick to eliminate.\n\n3) what version of OpenSSL\n", "id": 65569, "time": "2004-10-23T06:51:48Z", "creator": "jorton@redhat.com", "creation_time": "2004-10-23T06:51:48Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 31856, "text": "1) LogLevel debug shows the following just before the child process is restarted:\n\n[Sat Oct 23 14:24:06 2004] [debug] ssl_engine_kernel.c(1764): OpenSSL: Loop:\nSSLv3 read server certificate A\n[Sat Oct 23 14:24:06 2004] [debug] ssl_engine_kernel.c(1764): OpenSSL: Loop:\nSSLv3 read server key exchange A\n[Sat Oct 23 14:24:06 2004] [debug] ssl_engine_kernel.c(1764): OpenSSL: Loop:\nSSLv3 read server certificate request A\n[Sat Oct 23 14:24:06 2004] [debug] ssl_engine_kernel.c(1764): OpenSSL: Loop:\nSSLv3 read server done A\n[Sat Oct 23 14:24:06 2004] [debug] ssl_engine_kernel.c(1530): Proxy client\ncertificate callback: (web.server.name:443) entered\n[Sat Oct 23 14:24:06 2004] [debug] ssl_engine_kernel.c(1503): Proxy client\ncertificate callback: (web.server.name:443) found acceptable cert, sending\n/C=US/ST=State/L=City/O=Organization/OU=Unit/CN=common-name\n\nAfter that, the log outputs startup (init) information, beginning with:\n\n[Sat Oct 23 14:24:10 2004] [info] Loading certificate & private key of SSL-aware\nserver\n[Sat Oct 23 14:24:10 2004] [debug] ssl_engine_pphrase.c(468): unencrypted RSA\nprivate key - pass phrase not required\n[Sat Oct 23 14:24:11 2004] [info] Configuring server for SSL protocol\n\n2) Bug 24030 was marked as resolved on May 25, 2004.  Surely that code has been\nincluded in Apache-2.0.52 by now?  Also, I'm using a pre-built binary, so I am\nnot set up to build my own distribution of Apache (see Comment #1).\n\n3) As mentioned in Comment #1, I'm using a pre-built binary of Apache-2.0.52 and\nOpenSSL-0.9.7d.\n", "count": 13, "id": 65603, "time": "2004-10-23T19:34:31Z", "creator": "ddkilzer@kilzer.net", "creation_time": "2004-10-23T19:34:31Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 31856, "attachment_id": null, "is_private": false, "id": 65605, "time": "2004-10-23T19:40:04Z", "creator": "ddkilzer@kilzer.net", "creation_time": "2004-10-23T19:40:04Z", "text": "Upon further investigation by Mark Foster (http://mark.foster.cc/), Java was\nexporting the private key in PKCS#8 format, not RSA format, which is why the\nMIME text of the private key doesn't match between the crashapache2-bad.crtkey\nand the crashapache2.crtkey files.\n\nThat means that this bug is really a case where using a private key in PKCS#8\nformat causes Apache to crash with the SSLProxyMachineCertificateFile directive.\n Yes, it was due to ignorance on my part, but I figured this still may be fixable.\n\nMark explains (in an email to me):\n\nI noticed something odd about your exported private key.\nIt has -----BEGIN PRIVATE KEY----- and not\n-----BEGIN RSA PRIVATE KEY-----\n  which got me to poking around and lead me to this\nhttp://www.openssl.org/docs/apps/pkcs8.html\n\nSure enough, this works...\nopenssl pkcs8 -inform PEM -nocrypt -in exported.key -out exported4.pem\n\nIn other words the output of this command looks exactly like the rsa. So the\nprivate key is being exported as PKCS#8 PEM format. It's not corrupted per se.\nApache must be expecting an RSA key in the \ncert/key file.\n-- \nSome days it's just not worth chewing through the restraints... Mark D. Foster,\nCISSP <mark@foster.cc> http://mark.foster.cc/\n"}, {"count": 15, "tags": [], "bug_id": 31856, "attachment_id": null, "is_private": false, "id": 65614, "time": "2004-10-24T12:56:11Z", "creator": "jorton@redhat.com", "creation_time": "2004-10-24T12:56:11Z", "text": "The fix for bug 24030 is proposed for inclusion in 2.0.53, but is not in 2.0.52.\n It is the same bug, anyway; mod_ssl refuses to start up with the bogus keypair\nconfigured in HEAD:\n\nincomplete client cert configured for SSL proxy (missing or encrypted private key?)\n\n\n*** This bug has been marked as a duplicate of 24030 ***"}]