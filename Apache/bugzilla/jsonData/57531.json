[{"count": 0, "tags": [], "bug_id": 57531, "attachment_id": 32428, "is_private": false, "id": 180742, "time": "2015-02-03T21:17:58Z", "creator": "kurt.newman@cpanel.net", "creation_time": "2015-02-03T21:17:58Z", "text": "Created attachment 32428\nGDB stack trace\n\nBasic setup instructions:\n\nSet up shtml ErrorDocument definitions (and corresponding Handler), setup Listen directive for multiple ports, and create a virtual host block.\n\nBackground:\n\n2.4.10 would handle this correctly, but now causes children (when in prefork mode) for 2.4.12 to segfaults.\n\nTesting setup:\n2.4.10 without patches\n2.4.12 without patches\n\nI've attached two basic configuration files that duplicate this succinctly, as well as a stack trace."}, {"count": 1, "tags": [], "creator": "kurt.newman@cpanel.net", "attachment_id": 32429, "id": 180743, "time": "2015-02-03T21:18:17Z", "bug_id": 57531, "creation_time": "2015-02-03T21:18:17Z", "is_private": false, "text": "Created attachment 32429\nhttpd.conf"}, {"count": 2, "attachment_id": 32430, "bug_id": 57531, "is_private": false, "id": 180744, "time": "2015-02-03T21:18:32Z", "creator": "kurt.newman@cpanel.net", "creation_time": "2015-02-03T21:18:32Z", "tags": [], "text": "Created attachment 32430\nerrordocument.conf"}, {"count": 3, "tags": [], "creator": "brian@behlendorf.com", "attachment_id": null, "id": 181510, "time": "2015-03-04T19:00:40Z", "bug_id": 57531, "creation_time": "2015-03-04T19:00:40Z", "is_private": false, "text": "I am hitting this too, oddly also with the same specific error, 400 Bad Gateway, with the default config file thus pulling in HTTP_BAD_GATEWAY.html.var.  I wonder if it's related to this snippet from:\n\nhttps://httpd.apache.org/docs/2.4/upgrading.html#misc\n\n\"Multi-language error documents from 2.2.x may not work unless they are\nadjusted to the new syntax of mod_include's #if expr= element or the\ndirective SSILegacyExprParser is enabled for the directory containing the\nerror documents.\"\n\nIs your \"400.html\" the same file as the stock HTTP_BAD_GATEWAY.html.var?\n\nI tried to see if there was any particular error in HTTP_BAD_GATEWAY.html.var relating to the #if expr= syntax and didn't find anything obvious.  Nor could I reproduce the error with my hand-cobbled HTTP requests designed to trigger 400 responses, but I do get them in production, so realistic traffic can trigger it.  However, when I change my config to eliminate ONLY the following line from my extra/httpd-multilang-errordoc.conf:\n\n#ErrorDocument 400 /error/HTTP_BAD_REQUEST.html.var\n\nthat stopped all my core dumps, so it strongly suggests either a bug in that error message's server-parsed HTML (which still shouldn't trigger a core dump!!) or an error while processing a bad HTTP request that makes setting up the CGI environment variables fail spectacularly.\n\nHoping this can get some attention from folks who'd know..."}, {"count": 4, "tags": [], "creator": "brian@behlendorf.com", "attachment_id": null, "id": 181512, "time": "2015-03-04T22:00:40Z", "bug_id": 57531, "creation_time": "2015-03-04T22:00:40Z", "is_private": false, "text": "More details:\n\nA friend (jl) noted:\n> A quick glance at the code suggested that the request method is\n> not set up in the request object and in the function mentioned in the\n> stacktrace this leads to strcmp(NULL, \"INCLUDED\") -> segfault.\n\nSo I went about looking for odd-looking requests that might have no method set, and found (IP address anonymized):\n\nx.x.x.x - - [04/Mar/2015:13:36:01 -0800] \"\\x16\\x03\\x03\" 400 326 \"-\" \"-\"\n\nPosts online suggested this was an SSL client attempting to talk SSL to port 80.  And in fact, I could reproduce this by trying to go to\n\nhttps://host:80/\n\nto the point where I could even generate a core, which I couldn't do before.\n\nAnyways, looks like before that strcmp is called the request method should be tested for, or set.\n\nBrian"}, {"count": 5, "tags": [], "creator": "kurt.newman@cpanel.net", "attachment_id": null, "id": 181513, "time": "2015-03-04T22:09:07Z", "bug_id": 57531, "creation_time": "2015-03-04T22:09:07Z", "is_private": false, "text": "The way that I was able to re-produce this, was by Listening on 2 ports (80 and 443), accessing port 443, but for a virtual host that isn't defined on that port."}, {"count": 6, "tags": [], "bug_id": 57531, "attachment_id": null, "id": 181514, "creation_time": "2015-03-04T22:55:54Z", "time": "2015-03-04T22:55:54Z", "creator": "covener@gmail.com", "text": "Sorry, this is a recent regression that will be fixed shortly in trunk", "is_private": false}, {"count": 7, "tags": [], "bug_id": 57531, "attachment_id": null, "text": "(In reply to Eric Covener from comment #6)\n> Sorry, this is a recent regression that will be fixed shortly in trunk\n\nLooks like you already found the problem?\n\nstill, minor correction: the \"request method\" I mentioned to brian (see comment #4) was actually \"r->protocol in ap_add_cgi_vars, in server/util_script.c. My bad, I had written from memory, not checked the actual source again.\n\nAlso, I'm looking at revision 1661207, not the released version.", "id": 181515, "time": "2015-03-05T01:08:41Z", "creator": "googol.plexed@gmail.com", "creation_time": "2015-03-05T01:08:41Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 57531, "attachment_id": null, "text": "fixed in trunk and proposed for backport, sorry for the delay.  \n\nhttp://svn.apache.org/r1664205", "id": 181516, "time": "2015-03-05T02:36:39Z", "creator": "covener@gmail.com", "creation_time": "2015-03-05T02:36:39Z", "is_private": false}, {"count": 9, "tags": [], "creator": "kurt.newman@cpanel.net", "attachment_id": null, "id": 181539, "time": "2015-03-05T18:16:29Z", "bug_id": 57531, "creation_time": "2015-03-05T18:16:29Z", "is_private": false, "text": "Awesome.  Thank you Eric!"}, {"count": 10, "tags": [], "bug_id": 57531, "attachment_id": null, "text": "Backported to 2.4.13 in r1668879.", "id": 183294, "time": "2015-06-02T22:06:59Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2015-06-02T22:06:59Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 57531, "attachment_id": null, "text": "And to 2.2.30 in r1680927.", "id": 183295, "time": "2015-06-02T22:08:08Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2015-06-02T22:08:08Z", "is_private": false}]