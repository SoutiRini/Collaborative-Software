[{"count": 0, "tags": [], "creator": "apacheuser123@hotmail.com", "attachment_id": null, "id": 91472, "time": "2006-07-21T20:16:37Z", "bug_id": 40090, "creation_time": "2006-07-21T20:16:37Z", "is_private": false, "text": "I didn't see \"mod_mem_cache\" in the Component field so assigning this to mod_cache.\n\nI have an Apache 2.2.2 setup on a Redhat box. Mod_proxy(mod_proxy_ajp) is being\nused to connect to tomcat on the same machine. Caching is implemented using\nmod_cache(mod_mem_cache). This setup works fine and caching seems to be working\nas expected.\n\nThe problem occurs when I try to optimize further by supporting HTML compression\nusing mod_deflate. In this case, whenever deflated documents are served by the\ncache the Content-length returned is 0. Is this a known issue ? Can mod_deflate\nand mod_mem_cache be used together ? Or is it that mod_mem_cache cannot handle\ncompressed content ?\n\nHere's the output from lwp-request( the second one shows the serving up of\ncached content)\n\n[root@bin]# lwp-request -uedsx http://localhost:80/Main.do -H\nAccept-Encoding:gzip,deflate\nLWP::UserAgent::new: ()\nLWP::UserAgent::request: ()\nLWP::UserAgent::send_request: GET http://localhost:80/Main.do\nLWP::UserAgent::_need_proxy: Not proxied\nLWP::Protocol::http::request: ()\nLWP::Protocol::collect: read 670 bytes\nLWP::Protocol::collect: read 4096 bytes\nLWP::Protocol::collect: read 3002 bytes\nLWP::UserAgent::request: Simple response: OK\nGET http://localhost:80/Main.do\n200 OK\nCache-Control: no-store, must-revalidate, post-check=0, pre-check=0\nConnection: close\nDate: Tue, 18 Jul 2006 18:27:35 GMT\nVary: Accept-Encoding,User-Agent\nContent-Encoding: gzip\nContent-Length: 7768\nContent-Type: text/html;charset=ISO-8859-1\nExpires: Tue, 18 Jul 2006 18:30:37 GMT\nLast-Modified: Tue, 18 Jul 2006 18:27:37 GMT\nClient-Date: Tue, 18 Jul 2006 18:27:37 GMT\nClient-Peer: 127.0.0.1:80\nClient-Response-Num: 1\n\n[root@bin]# lwp-request -uedsx http://localhost:80/Main.do -H\nAccept-Encoding:gzip,deflate\nLWP::UserAgent::new: ()\nLWP::UserAgent::request: ()\nLWP::UserAgent::send_request: GET http://localhost:80/Main.do\nLWP::UserAgent::_need_proxy: Not proxied\nLWP::Protocol::http::request: ()\nLWP::UserAgent::request: Simple response: OK\nGET http://localhost:80/Main.do\n200 OK\nCache-Control: no-store, must-revalidate, post-check=0, pre-check=0\nConnection: close\nDate: Tue, 18 Jul 2006 18:28:32 GMT\nAge: 56\nServer: Apache/2.2.2 (Unix)\nVary: Accept-Encoding,User-Agent\nContent-Encoding: gzip\nContent-Length: 0\nContent-Type: text/html;charset=ISO-8859-1\nExpires: Tue, 18 Jul 2006 18:30:37 GMT\nLast-Modified: Tue, 18 Jul 2006 18:27:37 GMT\nClient-Date: Tue, 18 Jul 2006 18:28:32 GMT\nClient-Peer: 127.0.0.1:80\nClient-Response-Num: 1\n\nHere's the deflate.log contents\n\"GET /Main.do HTTP/1.1\" 7750/35169 (22%)\n\"GET /Main.do HTTP/1.1\" -/- (-%)\n\nRelevant sections of my httpd.conf:\n\nLoadModule cache_module modules/mod_cache.so\nLoadModule mem_cache_module modules/mod_mem_cache.so\nLoadModule deflate_module modules/mod_deflate.so\nLoadModule expires_module modules/mod_expires.so\nLoadModule headers_module modules/mod_headers.so\nLoadModule proxy_module modules/mod_proxy.so\nLoadModule proxy_ajp_module modules/mod_proxy_ajp.so\n\n\n#\n# mod_expires settings\n#\n<IfModule expires_module>\nExpiresActive On\nExpiresByType text/css \"access plus 1 day\"\nExpiresByType image/gif \"access plus 1 month\"\nExpiresByType image/jpeg \"access plus 1 month\"\n</IfModule>\n\n#\n# mod_proxy/mod_proxy ajp settings\n#\n<IfModule proxy_module>\nProxyRequests Off\n<Proxy *>\n Order deny,allow\n Allow from all\n</Proxy>\nProxyPass /favicon.ico !\nProxyPass / ajp://localhost:8009/\nProxyPassReverse / ajp://localhost:8009/\n</IfModule>\n\n#\n# mod_cache/mod_mem_cache settings\n#\n<IfModule cache_module>\n <IfModule mem_cache_module>\n   CacheEnable mem /\n   CacheStoreNoStore On\n#   CacheIgnoreCacheControl On\n#   CacheIgnoreNoLastMod On\n#   CacheMaxExpire 150\n   MCacheSize  4096\n   MCacheMaxObjectCount 200\n   MCacheMinObjectSize 1\n   MCacheMaxObjectSize 524288\n </IfModule>\n</IfModule>\n\n#\n# Worker MPM settings\n#\n<IfModule mpm_worker_module>\n StartServers 1\n MaxClients 250\n ThreadsPerChild 50\n MinSpareThreads 25\n MaxSpareThreads 75\n</IfModule>\n\n<IfModule deflate_module>\n  SetOutputFilter DEFLATE\n  SetEnvIfNoCase Request_URI \\.(?:gif|jpe?g|png|rar|zip)$ no-gzip\n\n  DeflateFilterNote Input instream\n  DeflateFilterNote Output outstream\n  DeflateFilterNote Ratio ratio\n  LogFormat '\"%r\" %{outstream}n/%{instream}n (%{ratio}n%%)' deflate\n  CustomLog logs/deflate.log deflate\n\n  BrowserMatch ^Mozilla/4 gzip-only-text/html\n  BrowserMatch ^Mozilla/4\\.0[678] no-gzip\n  BrowserMatch \\bMSIE !no-gzip !gzip-only-text/html\n\n  <IfModule headers_module>\n    Header append Vary User-Agent\n  </IfModule>\n</IfModule>\n\nI posted this issue in the user support list. As suggested there, I configured\napache to use mod_disk_cache and it seems to be working and compressed content\nis getting served up correctly. So I am guessing that this means it is a bug in\nmod_mem_cache.\n\nPlease let me know if you need more information."}, {"count": 1, "tags": [], "creator": "chip@force-elite.com", "attachment_id": null, "is_private": false, "id": 91474, "time": "2006-07-21T20:45:05Z", "bug_id": 40090, "creation_time": "2006-07-21T20:45:05Z", "text": "If you want this to work, try using mod_disk_cache, which is known to be working\ncorrectly with mod_deflate."}, {"count": 2, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "is_private": false, "id": 91491, "time": "2006-07-22T16:14:38Z", "bug_id": 40090, "creation_time": "2006-07-22T16:14:38Z", "text": "This also happens with mod_disk_cache. The reason is that the first filter in\nthe filter chain that we kick off in the quick handler for a cached entity is\nthe deflate filter. This filter adds an eos bucket to our empty brigade. This\nresults in a brigade that looks like the following being delivered to the\ncontent_length filter:\n\nEOS bucket\nFile bucket\nEOS bucket\n\nThus the content_length filter calculates 0 as Content-Length. While one might\nargue that the behaviour of the deflate output filter is broken and that it\nshould not add an eos bucket to the brigade if it has not seen one, I think we\nshould start the filter chain always with our cache out filter when we kick off\nthe filter chain in the quick handler, as this is the point where we actually\nsaved the cached data during caching.\nPlease give the attached patch a try (patch against trunk, but also works\nagainst 2.2.2) and let me know if it solves your problem."}, {"count": 3, "tags": [], "creator": "rpluem@apache.org", "attachment_id": 18627, "is_private": false, "id": 91492, "time": "2006-07-22T16:15:45Z", "bug_id": 40090, "creation_time": "2006-07-22T16:15:45Z", "text": "Created attachment 18627\nPatch against trunk"}, {"count": 4, "tags": [], "text": "(In reply to comment #2)\n> This also happens with mod_disk_cache. The reason is that the first filter in\n> the filter chain that we kick off in the quick handler for a cached entity is\n> the deflate filter. This filter adds an eos bucket to our empty brigade. This\n\nI must correct myself. The deflate out filter returns immediately without\npassing the empty brigade down the chain. So the EOS at the start of the brigade\nthat we are seeing is actually caused by ap_finalize_request_protocol. But my\nfurther conclusions are still valid.", "is_private": false, "bug_id": 40090, "id": 91500, "time": "2006-07-22T22:13:44Z", "creator": "rpluem@apache.org", "creation_time": "2006-07-22T22:13:44Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 40090, "attachment_id": null, "text": "Ruediger Pluem, Thank you very much for the fix. Sorry I couldn't test your\npatch before today. Anyways, I applied the patch and ran some tests. It seems to\nhave fixed the issue that was reported.\n\nBut, I noticed another problem. Here's what's happening...\n\n#############\nFirst Request ( Works fine-Caches the compressed content correctly )\n#############\n[root@local]# lwp-request -uedsx http://localhost:80/Main.do -H \nAccept-Encoding:gzip,deflate\nLWP::UserAgent::new: ()\nLWP::UserAgent::request: ()\nLWP::UserAgent::send_request: GET http://localhost:80/Main.do\nLWP::UserAgent::_need_proxy: Not proxied\nLWP::Protocol::http::request: ()\nLWP::Protocol::collect: read 670 bytes\nLWP::Protocol::collect: read 4096 bytes\nLWP::Protocol::collect: read 2836 bytes\nLWP::UserAgent::request: Simple response: OK\nGET http://localhost:80/Main.do\n200 OK\nCache-Control: no-store, must-revalidate, post-check=0, pre-check=0\nConnection: close\nDate: Tue, 25 Jul 2006 18:42:12 GMT\nVary: Accept-Encoding,User-Agent\nContent-Encoding: gzip\nContent-Length: 7602\nContent-Type: text/html;charset=ISO-8859-1\nExpires: Tue, 25 Jul 2006 18:45:13 GMT\nLast-Modified: Tue, 25 Jul 2006 18:42:13 GMT\nClient-Date: Tue, 25 Jul 2006 18:42:13 GMT\nClient-Peer: 127.0.0.1:80\nClient-Response-Num: 1\n\n\terror_log\n\t#########\n        [Tue Jul 25 11:42:12 2006] [debug] mod_cache.c(131): Adding CACHE_SAVE\nfilter for /Main.do\n\t[Tue Jul 25 11:42:12 2006] [debug] mod_cache.c(138): Adding CACHE_REMOVE_URL\nfilter for /Main.do\n\t***snip fetches data correctly***\n\t[Tue Jul 25 11:42:13 2006] [debug] mod_deflate.c(447): [client 127.0.0.1] Zlib:\nCompressed 35547 to 7584 : URL /Main.do\n\t[Tue Jul 25 11:42:13 2006] [debug] mod_headers.c(612): headers:\nap_headers_output_filter()\n\t[Tue Jul 25 11:42:13 2006] [debug] mod_cache.c(621): cache: Caching url: /Main.do\n\t[Tue Jul 25 11:42:13 2006] [debug] mod_cache.c(627): cache: Removing\nCACHE_REMOVE_URL filter.\n\t[Tue Jul 25 11:42:13 2006] [debug] mod_cache.c(670): cache: Added date header\n\t[Tue Jul 25 11:42:13 2006] [info] mem_cache: Cached url:\nhttp://localhost:80/Main.do?\n\n###############\nSecond Request ( Works fine-Fetches compressed content from cache )\n##############\n[root@local]# lwp-request -uedsx http://localhost:80/Main.do -H\nAccept-Encoding:gzip,deflate\nLWP::UserAgent::new: ()\nLWP::UserAgent::request: ()\nLWP::UserAgent::send_request: GET http://localhost:80/Main.do\nLWP::UserAgent::_need_proxy: Not proxied\nLWP::Protocol::http::request: ()\nLWP::Protocol::collect: read 632 bytes\nLWP::Protocol::collect: read 4096 bytes\nLWP::Protocol::collect: read 2874 bytes\nLWP::UserAgent::request: Simple response: OK\nGET http://localhost:80/Main.do\n200 OK\nCache-Control: no-store, must-revalidate, post-check=0, pre-check=0\nConnection: close\nDate: Tue, 25 Jul 2006 18:42:30 GMT\nAge: 18\nServer: Apache/2.2.2 (Unix)\nVary: Accept-Encoding,User-Agent\nContent-Encoding: gzip\nContent-Length: 7602\nContent-Type: text/html;charset=ISO-8859-1\nExpires: Tue, 25 Jul 2006 18:45:13 GMT\nLast-Modified: Tue, 25 Jul 2006 18:42:13 GMT\nClient-Date: Tue, 25 Jul 2006 18:42:30 GMT\nClient-Peer: 127.0.0.1:80\nClient-Response-Num: 1\n\n\terror_log\n\t#########\n\t[Tue Jul 25 11:42:30 2006] [debug] mod_cache.c(280): cache: running CACHE_OUT\nfilter\n\t[Tue Jul 25 11:42:30 2006] [debug] mod_cache.c(294): cache: serving /Main.do\n\n\n#############\nThird Request ( Problem-It correctly detects a vary header mismatch but doesn't\ncache the results. )\n#############\nI make the third request using a different \"User-Agent\" ( firefox in this case )\n\n\terror_log\n\t#########\n\t[Tue Jul 25 11:43:18 2006] [debug] cache_storage.c(246): cache_select_url():\nVary header mismatch.\n\t[Tue Jul 25 11:43:18 2006] [debug] mod_cache.c(131): Adding CACHE_SAVE filter\nfor /Main.do\n\t[Tue Jul 25 11:43:18 2006] [debug] mod_cache.c(138): Adding CACHE_REMOVE_URL\nfilter for /Main.do\n\t***snip fetches data correctly***\n\t[Tue Jul 25 11:43:20 2006] [debug] mod_deflate.c(447): [client 127.0.0.1] Zlib:\nCompressed 35168 to 7751 : URL /Main.do\n\t[Tue Jul 25 11:43:20 2006] [debug] mod_headers.c(612): headers:\nap_headers_output_filter()\n\t\nI don't see \"cache: Caching url: /Main.do\" or \"cache: Removing CACHE_REMOVE_URL\nfilter\" log messages like in the first request.Looks like it caches compressed\ncontent only for the first type of \"User-Agent\" ?", "id": 91580, "time": "2006-07-25T19:06:25Z", "creator": "apacheuser123@hotmail.com", "creation_time": "2006-07-25T19:06:25Z", "is_private": false}, {"count": 6, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "id": 91582, "time": "2006-07-25T21:46:51Z", "bug_id": 40090, "creation_time": "2006-07-25T21:46:51Z", "is_private": false, "text": "mod_mem_cache cannot handle varied content correctly and a fix will require\nbigger changes. Thus I leave this report open. In the meantime you can fall back\nto mod_disk_cache which can handle varied content properly. Regarding possible\nperformance thoughts: In most cases mod_disk_cache is as fast as mod_mem_cache,\nin some cases it is even faster."}, {"count": 7, "tags": [], "creator": "rpluem@apache.org", "is_private": false, "id": 91621, "attachment_id": null, "bug_id": 40090, "creation_time": "2006-07-26T17:34:00Z", "time": "2006-07-26T17:34:00Z", "text": "Committed patch to trunk as r425787\n(http://svn.apache.org/viewvc?rev=425787&view=rev)."}, {"count": 8, "tags": [], "text": "Thanks for the feedback,Ruediger. Apart from using mod_disk_cache, the other\noption I can think of is to not have the User-Agent in the Vary header. The only\nreason I have it there is for the BrowserMatch directives for mod_deflate. Maybe\nI can get rid of those directives ?", "is_private": false, "bug_id": 40090, "id": 91626, "time": "2006-07-26T19:50:51Z", "creator": "apacheuser123@hotmail.com", "creation_time": "2006-07-26T19:50:51Z", "attachment_id": null}, {"count": 9, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "is_private": false, "id": 97166, "time": "2006-12-21T12:45:41Z", "bug_id": 40090, "creation_time": "2006-12-21T12:45:41Z", "text": "*** Bug 40278 has been marked as a duplicate of this bug. ***"}, {"count": 10, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "id": 97167, "time": "2006-12-21T13:07:32Z", "bug_id": 40090, "creation_time": "2006-12-21T13:07:32Z", "is_private": false, "text": "Proposed for backport as r489460\n(http://svn.apache.org/viewvc?rev489460=&view=rev)."}, {"id": 103296, "tags": [], "bug_id": 40090, "is_private": false, "count": 11, "text": "Backported to 2.2.x as r538868\n(http://svn.apache.org/viewvc?rev=538868&view=rev).", "time": "2007-05-17T04:01:29Z", "creator": "rpluem@apache.org", "creation_time": "2007-05-17T04:01:29Z", "attachment_id": null}]