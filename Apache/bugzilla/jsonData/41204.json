[{"count": 0, "tags": [], "creator": "jasonab@acm.org", "attachment_id": null, "id": 97034, "time": "2006-12-18T13:49:59Z", "bug_id": 41204, "creation_time": "2006-12-18T13:49:59Z", "is_private": false, "text": "PostgreSQL uses the '$$' string to do multi-line quoting, usually for stored\nprocedures. I use ant's <sql> task to load my database (including stored\nprocedures) from my build file.\n\nIn PropertyHelper.parsePropertyString, however, $$ is treated as a single $ for\nbackward compatability purposes. Unfortunately, that $$ is treated as $ even if\nno property string is found.\n\nThe fix that occurs to me is to pass the string through unmolested if no\nproperty substitution is found."}, {"count": 1, "tags": [], "bug_id": 41204, "attachment_id": null, "id": 97037, "creation_time": "2006-12-18T14:12:43Z", "time": "2006-12-18T14:12:43Z", "creator": "mbenson@apache.org", "text": "I think the correct thing in this case is for all $ characters to be escaped, so\nusing $$$$ should work.  Please confirm whether this is the case.  Further,\ncould you provide an example snippet of where you are having trouble?", "is_private": false}, {"count": 2, "tags": [], "bug_id": 41204, "attachment_id": null, "text": "Also, it does not appear that text in the\nsqltask is expanded for properties unless\nthe expandProperties attribute is true (it\nis false by default - attribute added in ant 1.7.0).", "id": 97038, "time": "2006-12-18T14:16:18Z", "creator": "peterreilly@apache.org", "creation_time": "2006-12-18T14:16:18Z", "is_private": false}, {"count": 3, "tags": [], "creator": "jasonab@acm.org", "attachment_id": 19283, "id": 97039, "time": "2006-12-18T14:25:26Z", "bug_id": 41204, "creation_time": "2006-12-18T14:25:26Z", "is_private": false, "text": "Created attachment 19283\nExample stored proc that ant <sql> rejects"}, {"count": 4, "tags": [], "creator": "jasonab@acm.org", "text": "I did try using $$$$, and that does work, but it's illegal PostgreSQL syntax. In\nother words, if I feed that stored proc directly into Postgres, it'll fail.\nObviously, I'd rather not write my stored procs with ant in mind.\n\nTo Peter's comment, I'm not sure I understand. Are you saying that 1.7 will fix\nthis automatically?", "id": 97040, "time": "2006-12-18T14:25:52Z", "bug_id": 41204, "creation_time": "2006-12-18T14:25:52Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 41204, "text": "No, I was saying that I did not think that $$ is touched by parsePropertyString\nfor the slqtask -:- but I was wrong, for the statements seem\nto be sent thru \"runStatements()\", (so I am confused, in Ant 1.7.0,\nthere seems to be double expansion of properties for sql if\nexpandProperties is true??).\n\n\nThe sqltask does some stange parsing of lines to feed them to jdbc.\nThis has give rise to a large number of bug reports, a number\nof which deal with stored procedures - for example:\nhttp://issues.apache.org/bugzilla/show_bug.cgi?id=30760\n\n", "id": 97042, "time": "2006-12-18T14:51:44Z", "creator": "peterreilly@apache.org", "creation_time": "2006-12-18T14:51:44Z", "is_private": false, "attachment_id": null}, {"count": 6, "attachment_id": null, "bug_id": 41204, "text": "That's why I asked for an example.  This report was filed against 1.6.5, so\nPeter is correct that nested sql shouldn't have had properties expanded against it.", "id": 97043, "time": "2006-12-18T15:01:07Z", "creator": "mbenson@apache.org", "creation_time": "2006-12-18T15:01:07Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "creator": "peterreilly@apache.org", "attachment_id": null, "id": 97044, "time": "2006-12-18T15:02:21Z", "bug_id": 41204, "creation_time": "2006-12-18T15:02:21Z", "is_private": false, "text": "The code to add expansion of properties was done in this:\nhttp://svn.apache.org/viewvc/ant/core/trunk/src/main/org/apache/tools/ant/taskdefs/SQLExec.java?r1=360155&r2=368466&diff_format=h\nI do not think that the changer realized that property expansion\nis already done."}, {"count": 8, "tags": [], "bug_id": 41204, "attachment_id": 19284, "text": "Created attachment 19284\nProposed fix for double property expansion in sqltask\n\nThis changes the default value of expandproperties to\ntrue and stops the double expansion when expandproperties is\ntrue - need to look at the code again to make sure that\nthis is the case and need to update the manual/", "id": 97046, "time": "2006-12-18T15:07:57Z", "creator": "peterreilly@apache.org", "creation_time": "2006-12-18T15:07:57Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 41204, "attachment_id": null, "text": "(In reply to comment #8)\n> Created an attachment (id=19284) [edit]\n> Proposed fix for double property expansion in sqltask\n> \n> This changes the default value of expandproperties to\n> true and stops the double expansion when expandproperties is\n> true - need to look at the code again to make sure that\n> this is the case and need to update the manual/\n\nwell--that surely sounds like a problem!", "id": 97048, "time": "2006-12-18T15:10:20Z", "creator": "mbenson@apache.org", "creation_time": "2006-12-18T15:10:20Z", "is_private": false}, {"count": 10, "tags": [], "creator": "mbenson@apache.org", "text": "(In reply to comment #4)\n> I did try using $$$$, and that does work, but it's illegal PostgreSQL syntax. In\n> other words, if I feed that stored proc directly into Postgres, it'll fail.\n> Obviously, I'd rather not write my stored procs with ant in mind.\n> \n\nOkay, is that loading the sql from a file, or as nested content?  If the latter,\nyou'll already have to write them twice.  Thus I assume the former.  Sounds like\nAnt 1.7.0 will have the double property expansion bug.  I think 1.7.1 will\nfollow hot on the heels of 1.7.0, with Peter's proposed fix.  In 1.7.1 you\nshould be able to turn off property expansion; since you don't want your file to\nbe Ant-specific, you shouldn't need it.  For now I think your best bet is to\nkeep running 1.6.5 and preprocess your SQL file such that any occurrence of $$\nis replaced by $$$$.  Because of property expansion you might find yourself\nusing a filter like:\n\n<replacestring from=\"$$$$\" to=\"$$$$$$$$\" />\n\nor something...\n\nHTH,\nMatt", "id": 97050, "time": "2006-12-18T15:16:50Z", "bug_id": 41204, "creation_time": "2006-12-18T15:16:50Z", "is_private": false, "attachment_id": null}, {"count": 11, "attachment_id": null, "bug_id": 41204, "is_private": false, "id": 97051, "time": "2006-12-18T15:32:55Z", "creator": "jasonab@acm.org", "creation_time": "2006-12-18T15:32:55Z", "tags": [], "text": "I am loading from a file, as you surmise.\n\nFor ant 1.6.5, what I am doing is placing a token between $$ (like $BODY$),\nwhich is legal for PostgreSQL and ant ignores it. I would prefer to not have to\ndo that, but it is an effective workaround."}, {"count": 12, "attachment_id": null, "bug_id": 41204, "text": "(In reply to comment #11)\n> I am loading from a file, as you surmise.\n> \n> For ant 1.6.5, what I am doing is placing a token between $$ (like $BODY$),\n> which is legal for PostgreSQL and ant ignores it. I would prefer to not have to\n> do that, but it is an effective workaround.\n\nCool.  I am going to change the description of this report to indicate the\nchanges Peter needs to make for 1.7.1 then.\n\nThanks!", "id": 97052, "time": "2006-12-18T15:48:07Z", "creator": "mbenson@apache.org", "creation_time": "2006-12-18T15:48:07Z", "tags": [], "is_private": false}, {"count": 13, "tags": [], "creator": "jasonab@acm.org", "attachment_id": null, "id": 97053, "time": "2006-12-18T15:53:23Z", "bug_id": 41204, "creation_time": "2006-12-18T15:53:23Z", "is_private": false, "text": "\n> Cool.  I am going to change the description of this report to indicate the\n> changes Peter needs to make for 1.7.1 then.\n\nGreat. Appreciate you guys getting on this so quickly.\n\n"}, {"count": 14, "attachment_id": null, "bug_id": 41204, "text": "this is one of those times when some <sql> tests would be handy; we can use\nhsqldb for this purpose, rather than anything that needs to be preinstalled", "id": 97066, "time": "2006-12-19T02:07:16Z", "creator": "stevel@apache.org", "creation_time": "2006-12-19T02:07:16Z", "tags": [], "is_private": false}, {"count": 15, "tags": [], "bug_id": 41204, "attachment_id": null, "text": "Opps,\njust testing....", "id": 97074, "time": "2006-12-19T06:21:29Z", "creator": "peterreilly@apache.org", "creation_time": "2006-12-19T06:21:29Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 41204, "attachment_id": null, "text": "Applied the patch", "id": 97487, "time": "2006-12-30T15:51:58Z", "creator": "peterreilly@apache.org", "creation_time": "2006-12-30T15:51:58Z", "is_private": false}]