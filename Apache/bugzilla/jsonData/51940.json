[{"count": 0, "tags": [], "bug_id": 51940, "attachment_id": null, "id": 150082, "time": "2011-10-03T16:15:05Z", "creator": "nsushkin@openfinance.com", "creation_time": "2011-10-03T16:15:05Z", "is_private": false, "text": "In Tomcat 6 (and 7), Form Authentication valve restores the original request after a POST with successful authentication and redirect is followed by the client's GET. In case of the POST, the valve also restores the original request's body. However, it doesn't do that for a PUT. To be consistent, Tomcat should restore the body on PUT as well.\n\nThe patch would be in FormAuthenticator.restoreRequest(Request, Session) [1], to change from\n\nif (\"POST\".equalsIgnoreCase(saved.getMethod())) {\n\nto\n\nif (\"POST\".equalsIgnoreCase(saved.getMethod()) ||\n\"PUT\".equalsIgnoreCase(saved.getMethod())\n) {\n\n[1] http://svn.apache.org/viewvc/tomcat/tc6.0.x/trunk/java/org/apache/catalina/authenticator/FormAuthenticator.java?view=markup#l450\n\n\nMaybe related to Bug #48692.\n\n\nThis issue was discussed on users mailing list archived at\n\nhttp://markmail.org/thread/klafrhln32v3zcau\n\nand\n\nhttp://mail-archives.apache.org/mod_mbox/tomcat-users/201109.mbox/%3C3052451.ZX31eH6Cz8@strela%3E\n\n\nRegarding \"Re: Should Form Authentication Valve restore request body on a PUT?\", \non Thursday, September 29, 2011 17:04:27,\nChristopher Schultz wrote to Tomcat Users List <users@tomcat.apache.org>\n\n> ...\n> The servlet spec (v3.0, SRV 13.6.3.1) has this to say:\n> \"\n> If the form based login is invoked because of an HTTP request, the\n> original request parameters must be preserved by the container for use\n> if, on successful authentication, it redirects the call to the\n> requested resource.\n> \"\n> \n> It doesn't say what kinds of HTTP verbs should or should not be\n> supported, but GET and PUT seem entirely obvious. It doesn't say that\n> the request body needs to be maintained, only the \"request\n> parameters\". Since the servlet specification doesn't have any\n> provisions for fetching request parameters from PUT operations, I\n> suppose the spec therefore doesn't directly recommend that PUT bodies\n> be stored for later use like when POST is used.\n> ...\n> On the face of it, that seems reasonable. I haven't read-through the\n> code that then replays the saved-request so I'm not sure if there's\n> more to be done.\n\n\nRegarding \"Re: Should Form Authentication Valve restore request body on a PUT?\", \non Friday, September 30, 2011 13:10:55,\nMark Thomas wrote to Tomcat Users List <users@tomcat.apache.org>\n\n> I'd have no objection so the proposed change.\n> \n> Mark"}, {"count": 1, "tags": [], "text": "Regarding \"Re: Should Form Authentication Valve restore request body on a PUT?\", \non Friday, October 07, 2011 10:13:00,\nChristopher Schultz wrote to Tomcat Users List <users@tomcat.apache.org>\n\n> Nicholas,\n> \n> On 10/6/2011 10:08 PM, Nicholas Sushkin wrote:\n> > I now reconfigured DefaultServlet in conf/web.xml with\n> > readonly=false. Now, an unauthenticated PUT (with or without a\n> > body) returns 204 No Content instead of the login form. Seems like\n> > a bug. Should I add this behavior to Bug #51940 or a new bug?\n> \n> I'll bet what is happening is that your PUT request is being forwarded\n> without modification to the login page, and your login page is some\n> static content. Is that right?\n> \n> If that's what's happening, the DefaultServlet is handling the\n> request, seeing that it is a PUT, and then complaining that it's\n> read-only. When you make the DefaultServlet read-write you tell the\n> DefaultServlet to accept uploads, and you'll probably end up\n> overwriting your login form with the request entity (oops).\n> \n> It looks like the authenticator code needs to transform the PUT\n> request into a GET (or POST?) so that the DefaultServlet doesn't try\n> to do an upload.\n> \n> I think you'd have similar problems if trying to use a JSP for your\n> login-page, because JSPs can't accept PUT requests unless specifically\n> configured to do so.\n> \n> Since you're just hacking, try setting the request method to \"GET\"\n> when you detect a PUT request that requires authentication.", "is_private": false, "id": 150321, "creator": "nsushkin@openfinance.com", "time": "2011-10-07T17:06:46Z", "bug_id": 51940, "creation_time": "2011-10-07T17:06:46Z", "attachment_id": null}, {"count": 2, "attachment_id": 27729, "bug_id": 51940, "is_private": false, "id": 150322, "time": "2011-10-07T17:40:01Z", "creator": "nsushkin@openfinance.com", "creation_time": "2011-10-07T17:40:01Z", "tags": [], "text": "Created attachment 27729\nPatch fixing PUT handling with form authentication\n\nImplemented Charles's suggestion. Before forwarding to the login page, but after saving the request, in the request, set method (type) to GET.\n\nAlso, in save/restore of a request, when the method is PUT, allowed saving/restoring of the method body.\n\nTested this patch on unauthenticated GET, PUT, POST, and DELETE."}, {"count": 3, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 150417, "time": "2011-10-10T15:13:20Z", "bug_id": 51940, "creation_time": "2011-10-10T15:13:20Z", "is_private": false, "text": "POST and PUT are not the only methods that may have a request body. Request bodies are described in RFC2616 for OPTION re"}, {"count": 4, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "Try again, this time with the full message.\n\nRFC 2616 explicitly discusses OPTIONS and a request body. However, any HTTP request method may use a request body [1] although in many cases it will be ignored.\n\nIt appears that the right thing to do here is to save any request body we find and restore it after authentication regardless of request method.\n\n[1] http://tech.groups.yahoo.com/group/rest-discuss/message/9962", "id": 150418, "time": "2011-10-10T15:17:37Z", "bug_id": 51940, "creation_time": "2011-10-10T15:17:37Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 51940, "attachment_id": null, "id": 150426, "time": "2011-10-10T15:48:59Z", "creator": "markt@apache.org", "creation_time": "2011-10-10T15:48:59Z", "is_private": false, "text": "Thanks for the patch. I used it as the basis for the fox that has been committed.\n\nThe fix has been applied to trunk and 7.0.x and will be included in 7.0.23 onwards.\n\nThe fix has also been proposed for 6.0.x."}, {"count": 6, "tags": [], "creator": "nsushkin@openfinance.com", "attachment_id": null, "text": "Perfect. I am glad Roy Fielding clarified the usage of request body in HTTP and REST. It makes sense and the code is now simpler and more generic.\n\nHow does that request for the bug fix to be included into 6.0.x work? Is that Release Manager for 6.0.x Jean-Frederic who needs to approve it? I see that both Bug Fixes and Enhancements are still accepted for 6.0.x ( http://wiki.apache.org/tomcat/TomcatVersions ). It would be most useful to me if the fix was included in Tomcat 6. Thank you.", "id": 150432, "time": "2011-10-10T17:08:25Z", "bug_id": 51940, "creation_time": "2011-10-10T17:08:25Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 51940, "attachment_id": null, "id": 150433, "time": "2011-10-10T17:29:14Z", "creator": "nsushkin@openfinance.com", "creation_time": "2011-10-10T17:29:14Z", "is_private": false, "text": "BTW, in your change to 7.0, there seems to be a slight inconsistency in the log message. In other log messages, when you say \"context [{n}]\", you pass context.getName(). In this message, you passed context.getServletContext().getContextPath() leftover from my patch.\n\nhttp://svn.apache.org/viewvc/tomcat/tc7.0.x/trunk/java/org/apache/catalina/authenticator/FormAuthenticator.java?view=markup#l375\n\nI wasn't going to say anything, but if you're revisiting this file, might as well fix the typo in \"somethign\" :)\n\nhttp://svn.apache.org/viewvc/tomcat/tc7.0.x/trunk/java/org/apache/catalina/authenticator/FormAuthenticator.java?view=markup#l626"}, {"count": 8, "attachment_id": null, "bug_id": 51940, "is_private": false, "id": 150437, "time": "2011-10-10T18:58:14Z", "creator": "markt@apache.org", "creation_time": "2011-10-10T18:58:14Z", "tags": [], "text": "Thanks for the review. Those issues have been fixed.\n\nAny proposal for back-port needs a minimum of 3 +1 votes from committers. Once\nit has the votes, a committer (usually the proposer but if doesn't have to be)\nwill commit it and it is included in the next release.\n\nThe RM role is 'just' one of creating the release. It has no special role to\nplay in the back-port process."}, {"count": 9, "tags": [], "bug_id": 51940, "attachment_id": null, "is_private": false, "id": 150463, "time": "2011-10-11T13:15:18Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2011-10-11T13:15:18Z", "text": "1. I tried to test this in trunk, and replaying a POST request fails for me.\n\nUsing the following standalone HTML page:\n[[[\n<FORM action=\"http://localhost:8080/examples/jsp/security/protected/index.jsp\" method=\"POST\">\n<input name=\"role\">\n<input type=\"submit\">\n</FORM>\n]]]\n\n- Configure a sample user with a role of \"tomcat\" and start Tomcat\n- Start a new web browser and load the above page\n- Type \"aaa\" and press submit.\n- Respond to FORM authentication.\n- The protected page is displayed.\nExpected: \"You have not been granted role aaaa\"\nActual: no such message.\n\nI tried to debug this, but I do not see anything wrong in FormAuthenticator.\nThe body and method were saved and restored. Request#parametersParsed was false.\n\nThen, setting a breakpoint in Request#parseParameters() I see that\nRequest#usingInputStream is true and thus parseParameters() exits early.\n\nThis is reproducible in 7.0.22.\nThis does not happen in 6.0.33 - it replays POSTs correctly.\n\n\n2. request.getCoyoteRequest().method().setString(\"GET\");\nis seen as GET in access log.  Not much of an issue though, as anyway we return not what was originally requested by client.\n\nI think that to fix this one can restore the original method in FormAuthenticator#forwardToLoginPage(..) when disp.forward() call returns."}, {"count": 10, "tags": [], "text": "(In reply to comment #9)\n> 1. I tried to test this in trunk, and replaying a POST request fails for me.\n\nThat is a side-effect of r987955 which is not directly related to this bug.\n\n> 2. request.getCoyoteRequest().method().setString(\"GET\");\n> is seen as GET in access log.  Not much of an issue though, as anyway we return\n> not what was originally requested by client.\n> \n> I think that to fix this one can restore the original method in\n> FormAuthenticator#forwardToLoginPage(..) when disp.forward() call returns.\n\nThat would work. I'm on the fence. We can record what was requested or what we process.", "is_private": false, "id": 150769, "creator": "markt@apache.org", "time": "2011-10-19T18:02:15Z", "bug_id": 51940, "creation_time": "2011-10-19T18:02:15Z", "attachment_id": null}, {"count": 11, "tags": [], "text": "(In reply to comment #10)\n> (In reply to comment #9)\n> > 1. I tried to test this in trunk, and replaying a POST request fails for me.\n> \n> That is a side-effect of r987955 which is not directly related to this bug.\n\nConfirming that r1186379 / r1186383 fixed it.\n\nTomcat 6 is not affected by this issue.\n\n\n> \n> > 2. request.getCoyoteRequest().method().setString(\"GET\");\n> > is seen as GET in access log.  Not much of an issue though, as anyway we return\n> > not what was originally requested by client.\n> > \n> > I think that to fix this one can restore the original method in\n> > FormAuthenticator#forwardToLoginPage(..) when disp.forward() call returns.\n> \n> That would work. I'm on the fence. We can record what was requested or what we\n> process.\n\nFixed this in r1186712 / r1186719", "is_private": false, "id": 150792, "creator": "knst.kolinko@gmail.com", "time": "2011-10-20T10:28:18Z", "bug_id": 51940, "creation_time": "2011-10-20T10:28:18Z", "attachment_id": null}, {"count": 12, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": 27825, "text": "Created attachment 27825\n2011-10-20_tc6_51940_v3.patch\n\nTC 6 version of the patch\nIn trunk these are r1181028, r1181136, r1186378, r1186712", "id": 150793, "time": "2011-10-20T10:39:24Z", "bug_id": 51940, "creation_time": "2011-10-20T10:39:24Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 51940, "attachment_id": null, "is_private": false, "id": 151079, "time": "2011-10-31T13:06:53Z", "creator": "markt@apache.org", "creation_time": "2011-10-31T13:06:53Z", "text": "Fixed in 6.0.x and will be included in 6.0.34 onwards."}]