[{"count": 0, "tags": [], "bug_id": 61202, "attachment_id": null, "id": 199290, "time": "2017-06-20T10:25:40Z", "creator": "aidbmfqognnq6gizaigaqaaaaaaaa@protected32.unixadm.org", "creation_time": "2017-06-20T10:25:40Z", "is_private": false, "text": "Hi,\n\n\nwith 2.4.26 the variable SCRIPT_NAME, which is passed to fcgi applications such as php-fpm, no longer contains the full uri path.\n\nex.\nhttp://server.example/~phil/blah.php\n\n$_SERVER['SCRIPT_NAME'] /blah.php\n$_SERVER['REQUEST_URI'] /~phil/blah.php\n$_SERVER['SCRIPT_FILENAME'] /home/phil/.public_html/blah.php\n$_SERVER['CONTEXT_DOCUMENT_ROOT'] /home/phil/.public_html\n$_SERVER['CONTEXT_PREFIX'] /~phil\n\nSCRIPT_NAME should be /~phil/blah.php, not /blah.php.\n\n\nKind regards\n\nPhil"}, {"count": 1, "tags": [], "bug_id": 61202, "attachment_id": null, "id": 199291, "time": "2017-06-20T10:30:57Z", "creator": "aidbmfqognnq6gizaigaqaaaaaaaa@protected32.unixadm.org", "creation_time": "2017-06-20T10:30:57Z", "is_private": false, "text": "SCRIPT_NAME is set to the correct value when using ProxyFCGIBackendType GENERIC:\n\n$_SERVER['SCRIPT_NAME'] /~phil/blah.php\n$_SERVER['REQUEST_URI'] /~phil/blah.php\n$_SERVER['SCRIPT_FILENAME'] /home/phil/.public_html/blah.php\n$_SERVER['CONTEXT_DOCUMENT_ROOT'] /home/phil/.public_html\n$_SERVER['CONTEXT_PREFIX'] /~phil"}, {"count": 2, "tags": [], "bug_id": 61202, "text": "The GENERIC/FPM code path change in mod_proxy_fcgi.c looks very wrong, particularly the \"TODO\" part responsible for stripping off leading directory components (390:392) and appending PATH_INFO to SCRIPT_NAME (RFC3875 says no):\n\n    379     if (fpm || apr_table_get(r->notes, \"virtual_script\")) {\n    380         /*\n    381          * Adjust SCRIPT_NAME, PATH_INFO and PATH_TRANSLATED for PHP-FPM\n    382          * TODO: Right now, PATH_INFO and PATH_TRANSLATED look OK...\n    383          */\n    384         const char *pend;\n    385         const char *script_name = apr_table_get(r->subprocess_env, \"SCRIPT_NAME\");\n    386         pend = script_name + strlen(script_name);\n    387         if (r->path_info && *r->path_info) {\n    388             pend = script_name + ap_find_path_info(script_name, r->path_info) - 1;\n    389         }\n    390         while (pend != script_name && *pend != '/') {\n    391             pend--;\n    392         }\n    393         apr_table_setn(r->subprocess_env, \"SCRIPT_NAME\", pend);\n    394         ap_log_rerror(APLOG_MARK, APLOG_TRACE4, 0, r,\n    395                       \"fpm:virtual_script: Modified SCRIPT_NAME to: %s\",\n    396                       pend);\n    397     }\n\nOther than rolling back the whole module to 2.6.25, it does indeed look like setting ProxyFCGIBackendType to GENERIC (which appears to work fine with FPM for me, too) is the solution.", "id": 199294, "time": "2017-06-20T14:32:32Z", "creator": "apache-b6e@deemzed.uk", "creation_time": "2017-06-20T14:32:32Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 61202, "text": "Thanks for the report. We're currently discussing the right fix; as many of you have already discovered, using a GENERIC backend type will revert to the 2.4.25 behavior. If you're a 2.4.26 user, you probably should not expect the current behavior of the FPM BackendType (nor its current status as the \"default\" setting) to remain as-is.\n\nNote that the 2.4.25 behavior won't work for everyone either. My eventual goal is to return us (by default) to the 2.4.20 behavior that seemed to work for many PHP-FPM users, and letting users of other \"incompatible\" (i.e. correct) FCGI daemons use the new ProxyFCGISetEnvIf directive if they need it. Sorry for introducing this mess with my fix to bug 59618.", "id": 199345, "time": "2017-06-22T22:12:25Z", "creator": "jchampion@apache.org", "creation_time": "2017-06-22T22:12:25Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 61202, "text": "(In reply to aidbmfqognnq6gizaigaqaaaaaaaa from comment #0)\n> Hi,\n> \n> \n> with 2.4.26 the variable SCRIPT_NAME, which is passed to fcgi applications\n> such as php-fpm, no longer contains the full uri path.\n\nHi Phil, I also agree it looks pretty bogus. Out of curiosity, what kind of config do you use to map these requests to proxy_fcgi?", "id": 199347, "time": "2017-06-22T22:40:22Z", "creator": "covener@gmail.com", "creation_time": "2017-06-22T22:40:22Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "text": "Same bug after upgrade:\n\nConfig for backend:\n\n<FilesMatch \\.php$>\n   SetHandler \"proxy:unix:/var/run/php-fpm/vu008621.sock|fcgi://vu008621\"\n</FilesMatch>\n<Proxy fcgi://vu008621 disablereuse=On>\n</Proxy>", "is_private": false, "bug_id": 61202, "id": 199356, "time": "2017-06-23T07:28:01Z", "creator": "tomas@merta.cz", "creation_time": "2017-06-23T07:28:01Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 61202, "attachment_id": null, "id": 199359, "time": "2017-06-23T11:06:40Z", "creator": "covener@gmail.com", "creation_time": "2017-06-23T11:06:40Z", "is_private": false, "text": "(In reply to Tomas Merta from comment #5)\n> Same bug after upgrade:\n> \n> Config for backend:\n> \n> <FilesMatch \\.php$>\n>    SetHandler \"proxy:unix:/var/run/php-fpm/vu008621.sock|fcgi://vu008621\"\n> </FilesMatch>\n> <Proxy fcgi://vu008621 disablereuse=On>\n> </Proxy>\n\nPlease open a new bug report. This PR is about a regression."}, {"count": 7, "tags": [], "bug_id": 61202, "attachment_id": null, "id": 199362, "time": "2017-06-23T12:16:15Z", "creator": "covener@gmail.com", "creation_time": "2017-06-23T12:16:15Z", "is_private": false, "text": "(In reply to Eric Covener from comment #6)\n> (In reply to Tomas Merta from comment #5)\n> > Same bug after upgrade:\n> > \n> > Config for backend:\n> > \n> > <FilesMatch \\.php$>\n> >    SetHandler \"proxy:unix:/var/run/php-fpm/vu008621.sock|fcgi://vu008621\"\n> > </FilesMatch>\n> > <Proxy fcgi://vu008621 disablereuse=On>\n> > </Proxy>\n> \n> Please open a new bug report. This PR is about a regression.\n\nSorry, I understand what you wrote now. Thanks for sharing your affected config."}, {"count": 8, "tags": [], "bug_id": 61202, "attachment_id": null, "text": "Hi Eric,\n\n\n(In reply to Eric Covener from comment #4)\n> Hi Phil, I also agree it looks pretty bogus. Out of curiosity, what kind of\n> config do you use to map these requests to proxy_fcgi?\n\nI guess it's a very common config:\n\n<IfModule proxy_fcgi_module>\n    ProxyFCGIBackendType GENERIC\n    <FilesMatch \\.php$>\n        SetHandler \"proxy:unix:/run/php-fpm/www.sock|fcgi://fpm-www\"\n    </FilesMatch>\n</IfModule>", "id": 199367, "time": "2017-06-23T14:09:18Z", "creator": "aidbmfqognnq6gizaigaqaaaaaaaa@protected32.unixadm.org", "creation_time": "2017-06-23T14:09:18Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 61202, "attachment_id": null, "id": 199370, "time": "2017-06-23T17:08:45Z", "creator": "jchampion@apache.org", "creation_time": "2017-06-23T17:08:45Z", "is_private": false, "text": "*** Bug 61211 has been marked as a duplicate of this bug. ***"}, {"count": 10, "tags": [], "bug_id": 61202, "attachment_id": null, "id": 199491, "time": "2017-06-29T18:08:43Z", "creator": "jchampion@apache.org", "creation_time": "2017-06-29T18:08:43Z", "is_private": false, "text": "Checked into trunk as r1800306 and proposed for backport to 2.4.x."}, {"count": 11, "tags": [], "creator": "ylavic.dev@gmail.com", "attachment_id": null, "text": "Backported to 2.4.27 with r1800618.", "id": 199865, "time": "2017-07-18T16:49:16Z", "bug_id": 61202, "creation_time": "2017-07-18T16:49:16Z", "is_private": false}]