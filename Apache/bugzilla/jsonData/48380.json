[{"count": 0, "tags": [], "creator": "matthias8283@gmx.at", "attachment_id": null, "text": "I created a table with the fox:widow-content-limit attribute. If a table cell contains a list-block element, which has the space-after attribute, a ClassCastException occurs.\n\nA small testcase is attached.\n\nStacktrace:\n11.12.2009 17:30:13 org.apache.fop.cli.Main startFOP\nSCHWERWIEGEND: Exception\njava.lang.ClassCastException: org.apache.fop.layoutmgr.SpaceElement\n\tat org.apache.fop.cli.InputHandler.transformTo(InputHandler.java:302)\n\tat org.apache.fop.cli.InputHandler.renderTo(InputHandler.java:130)\n\tat org.apache.fop.cli.Main.startFOP(Main.java:174)\n\tat org.apache.fop.cli.Main.main(Main.java:205)\nCaused by: java.lang.ClassCastException: org.apache.fop.layoutmgr.SpaceElement\n\tat org.apache.fop.layoutmgr.ElementListUtils.removeLegalBreaks(ElementListUtils.java:87)\n\tat org.apache.fop.layoutmgr.list.ListBlockLayoutManager.getNextKnuthElements(ListBlockLayoutManager.java:125)\n\tat org.apache.fop.layoutmgr.BlockStackingLayoutManager.getNextChildElements(BlockStackingLayoutManager.java:571)\n\tat org.apache.fop.layoutmgr.BlockStackingLayoutManager.getNextChildElements(BlockStackingLayoutManager.java:552)\n\tat org.apache.fop.layoutmgr.BlockStackingLayoutManager.getNextKnuthElements(BlockStackingLayoutManager.java:280)\n\tat org.apache.fop.layoutmgr.BlockLayoutManager.getNextKnuthElements(BlockLayoutManager.java:123)\n\tat org.apache.fop.layoutmgr.BlockLayoutManager.getNextKnuthElements(BlockLayoutManager.java:115)\n\tat org.apache.fop.layoutmgr.table.TableCellLayoutManager.getNextKnuthElements(TableCellLayoutManager.java:154)\n\tat org.apache.fop.layoutmgr.table.RowGroupLayoutManager.createElementsForRowGroup(RowGroupLayoutManager.java:118)\n\tat org.apache.fop.layoutmgr.table.RowGroupLayoutManager.getNextKnuthElements(RowGroupLayoutManager.java:61)\n\tat org.apache.fop.layoutmgr.table.TableContentLayoutManager.getKnuthElementsForRowIterator(TableContentLayoutManager.java:220)\n\tat org.apache.fop.layoutmgr.table.TableContentLayoutManager.getNextKnuthElements(TableContentLayoutManager.java:173)\n\tat org.apache.fop.layoutmgr.table.TableLayoutManager.getNextKnuthElements(TableLayoutManager.java:249)\n\tat org.apache.fop.layoutmgr.FlowLayoutManager.getNextChildElements(FlowLayoutManager.java:199)\n\tat org.apache.fop.layoutmgr.FlowLayoutManager.addChildElements(FlowLayoutManager.java:140)\n\tat org.apache.fop.layoutmgr.FlowLayoutManager.addChildElements(FlowLayoutManager.java:129)\n\tat org.apache.fop.layoutmgr.FlowLayoutManager.getNextKnuthElements(FlowLayoutManager.java:70)\n\tat org.apache.fop.layoutmgr.PageBreaker.getNextKnuthElements(PageBreaker.java:216)\n\tat org.apache.fop.layoutmgr.AbstractBreaker.getNextBlockList(AbstractBreaker.java:697)\n\tat org.apache.fop.layoutmgr.PageBreaker.getNextBlockList(PageBreaker.java:149)\n\tat org.apache.fop.layoutmgr.PageBreaker.getNextBlockList(PageBreaker.java:132)\n\tat org.apache.fop.layoutmgr.AbstractBreaker.doLayout(AbstractBreaker.java:341)\n\tat org.apache.fop.layoutmgr.PageBreaker.doLayout(PageBreaker.java:85)\n\tat org.apache.fop.layoutmgr.PageSequenceLayoutManager.activateLayout(PageSequenceLayoutManager.java:107)\n\tat org.apache.fop.area.AreaTreeHandler.endPageSequence(AreaTreeHandler.java:238)\n\tat org.apache.fop.fo.pagination.PageSequence.endOfNode(PageSequence.java:120)\n\tat org.apache.fop.fo.FOTreeBuilder$MainFOHandler.endElement(FOTreeBuilder.java:349)\n\tat org.apache.fop.fo.FOTreeBuilder.endElement(FOTreeBuilder.java:177)\n\tat org.apache.xalan.transformer.TransformerIdentityImpl.endElement(TransformerIdentityImpl.java:1101)\n\tat org.apache.xerces.parsers.AbstractSAXParser.endElement(Unknown Source)\n\tat org.apache.xerces.xinclude.XIncludeHandler.endElement(Unknown Source)\n\tat org.apache.xerces.impl.XMLNSDocumentScannerImpl.scanEndElement(Unknown Source)\n\tat org.apache.xerces.impl.XMLDocumentFragmentScannerImpl$FragmentContentDispatcher.dispatch(Unknown Source)\n\tat org.apache.xerces.impl.XMLDocumentFragmentScannerImpl.scanDocument(Unknown Source)\n\tat org.apache.xerces.parsers.XML11Configuration.parse(Unknown Source)\n\tat org.apache.xerces.parsers.XML11Configuration.parse(Unknown Source)\n\tat org.apache.xerces.parsers.XMLParser.parse(Unknown Source)\n\tat org.apache.xerces.parsers.AbstractSAXParser.parse(Unknown Source)\n\tat org.apache.xerces.jaxp.SAXParserImpl$JAXPSAXParser.parse(Unknown Source)\n\tat org.apache.xalan.transformer.TransformerIdentityImpl.transform(TransformerIdentityImpl.java:484)\n\tat org.apache.fop.cli.InputHandler.transformTo(InputHandler.java:299)\n\t... 3 more\n\n---------\n\njava.lang.ClassCastException: org.apache.fop.layoutmgr.SpaceElement\n\tat org.apache.fop.layoutmgr.ElementListUtils.removeLegalBreaks(ElementListUtils.java:87)\n\tat org.apache.fop.layoutmgr.list.ListBlockLayoutManager.getNextKnuthElements(ListBlockLayoutManager.java:125)\n\tat org.apache.fop.layoutmgr.BlockStackingLayoutManager.getNextChildElements(BlockStackingLayoutManager.java:571)\n\tat org.apache.fop.layoutmgr.BlockStackingLayoutManager.getNextChildElements(BlockStackingLayoutManager.java:552)\n\tat org.apache.fop.layoutmgr.BlockStackingLayoutManager.getNextKnuthElements(BlockStackingLayoutManager.java:280)\n\tat org.apache.fop.layoutmgr.BlockLayoutManager.getNextKnuthElements(BlockLayoutManager.java:123)\n\tat org.apache.fop.layoutmgr.BlockLayoutManager.getNextKnuthElements(BlockLayoutManager.java:115)\n\tat org.apache.fop.layoutmgr.table.TableCellLayoutManager.getNextKnuthElements(TableCellLayoutManager.java:154)\n\tat org.apache.fop.layoutmgr.table.RowGroupLayoutManager.createElementsForRowGroup(RowGroupLayoutManager.java:118)\n\tat org.apache.fop.layoutmgr.table.RowGroupLayoutManager.getNextKnuthElements(RowGroupLayoutManager.java:61)\n\tat org.apache.fop.layoutmgr.table.TableContentLayoutManager.getKnuthElementsForRowIterator(TableContentLayoutManager.java:220)\n\tat org.apache.fop.layoutmgr.table.TableContentLayoutManager.getNextKnuthElements(TableContentLayoutManager.java:173)\n\tat org.apache.fop.layoutmgr.table.TableLayoutManager.getNextKnuthElements(TableLayoutManager.java:249)\n\tat org.apache.fop.layoutmgr.FlowLayoutManager.getNextChildElements(FlowLayoutManager.java:199)\n\tat org.apache.fop.layoutmgr.FlowLayoutManager.addChildElements(FlowLayoutManager.java:140)\n\tat org.apache.fop.layoutmgr.FlowLayoutManager.addChildElements(FlowLayoutManager.java:129)\n\tat org.apache.fop.layoutmgr.FlowLayoutManager.getNextKnuthElements(FlowLayoutManager.java:70)\n\tat org.apache.fop.layoutmgr.PageBreaker.getNextKnuthElements(PageBreaker.java:216)\n\tat org.apache.fop.layoutmgr.AbstractBreaker.getNextBlockList(AbstractBreaker.java:697)\n\tat org.apache.fop.layoutmgr.PageBreaker.getNextBlockList(PageBreaker.java:149)\n\tat org.apache.fop.layoutmgr.PageBreaker.getNextBlockList(PageBreaker.java:132)\n\tat org.apache.fop.layoutmgr.AbstractBreaker.doLayout(AbstractBreaker.java:341)\n\tat org.apache.fop.layoutmgr.PageBreaker.doLayout(PageBreaker.java:85)\n\tat org.apache.fop.layoutmgr.PageSequenceLayoutManager.activateLayout(PageSequenceLayoutManager.java:107)\n\tat org.apache.fop.area.AreaTreeHandler.endPageSequence(AreaTreeHandler.java:238)\n\tat org.apache.fop.fo.pagination.PageSequence.endOfNode(PageSequence.java:120)\n\tat org.apache.fop.fo.FOTreeBuilder$MainFOHandler.endElement(FOTreeBuilder.java:349)\n\tat org.apache.fop.fo.FOTreeBuilder.endElement(FOTreeBuilder.java:177)\n\tat org.apache.xalan.transformer.TransformerIdentityImpl.endElement(TransformerIdentityImpl.java:1101)\n\tat org.apache.xerces.parsers.AbstractSAXParser.endElement(Unknown Source)\n\tat org.apache.xerces.xinclude.XIncludeHandler.endElement(Unknown Source)\n\tat org.apache.xerces.impl.XMLNSDocumentScannerImpl.scanEndElement(Unknown Source)\n\tat org.apache.xerces.impl.XMLDocumentFragmentScannerImpl$FragmentContentDispatcher.dispatch(Unknown Source)\n\tat org.apache.xerces.impl.XMLDocumentFragmentScannerImpl.scanDocument(Unknown Source)\n\tat org.apache.xerces.parsers.XML11Configuration.parse(Unknown Source)\n\tat org.apache.xerces.parsers.XML11Configuration.parse(Unknown Source)\n\tat org.apache.xerces.parsers.XMLParser.parse(Unknown Source)\n\tat org.apache.xerces.parsers.AbstractSAXParser.parse(Unknown Source)\n\tat org.apache.xerces.jaxp.SAXParserImpl$JAXPSAXParser.parse(Unknown Source)\n\tat org.apache.xalan.transformer.TransformerIdentityImpl.transform(TransformerIdentityImpl.java:484)\n\tat org.apache.fop.cli.InputHandler.transformTo(InputHandler.java:299)\n\tat org.apache.fop.cli.InputHandler.renderTo(InputHandler.java:130)\n\tat org.apache.fop.cli.Main.startFOP(Main.java:174)\n\tat org.apache.fop.cli.Main.main(Main.java:205)", "id": 132776, "time": "2009-12-11T12:38:00Z", "bug_id": 48380, "creation_time": "2009-12-11T12:38:00Z", "is_private": false}, {"count": 1, "tags": [], "creator": "matthias8283@gmx.at", "attachment_id": 24699, "text": "Created attachment 24699\nTestcase", "id": 132777, "time": "2009-12-11T12:39:39Z", "bug_id": 48380, "creation_time": "2009-12-11T12:39:39Z", "is_private": false}, {"count": 2, "text": "Created attachment 26460\nproposed patch to ElementListUtils.java\n\nApologies for the late response...\n\nI noticed the issue did not occur with fox:orphan-content-limit, since that triggers a call to ElementListUtils.removeLegalBreaksFromEnd(), which was equipped to deal with SpaceElements, contrary to the method removeLegalBreaks(), where the exception was thrown. \nSeems like the implementations of both methods were meant to be analogous, but got out of alignment.\nProposal is to fix this by merging the implementations into one private method, as they were almost identical anyway (apart from 3-4 lines, which can be handled rather gracefully through conditionals).\nFor now, the proposed fix does not alter the behavior in any way, except by avoiding the potential ClassCastException, although it did get me wondering whether the treatment of spaces is always correct here... \nThink: consecutive/adjoining spaces with a different precedence value, and whether it is correct to just add the space's optimum width. Theoretically, it seems possible that we leave in a break-opportunity that turns out (= after space-resolution) to leave less content before the break than the constraint specifies, because we counted 2 spaces here, of which only one is retained in the eventual output (?)", "bug_id": 48380, "attachment_id": 26460, "id": 143101, "time": "2011-01-05T14:01:49Z", "creator": "adelmelle@apache.org", "creation_time": "2011-01-05T14:01:49Z", "tags": [], "is_private": false}, {"count": 3, "text": "\nFixed in Trunk. See: http://svn.apache.org/viewvc?rev=1056513&view=rev", "bug_id": 48380, "is_private": false, "id": 143187, "time": "2011-01-07T16:18:15Z", "creator": "adelmelle@apache.org", "creation_time": "2011-01-07T16:18:15Z", "tags": [], "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 48380, "attachment_id": null, "id": 155470, "creation_time": "2012-04-01T06:17:54Z", "time": "2012-04-01T06:17:54Z", "creator": "gadams@apache.org", "text": "batch transition to closed; if someone wishes to restore one of these to resolved in order to perform a verification step, then feel free to do so", "is_private": false}]