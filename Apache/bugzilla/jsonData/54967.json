[{"attachment_id": null, "tags": [], "bug_id": 54967, "text": "When updating an existing zip file that has duplicate entries, the zip task throws a NullPointerException.  This simple script reproduces the problem:\n\n<?xml version=\"1.0\"?>\n<project name=\"testzip\" default=\"testzip\">\n\n    <target name=\"testzip\">\n        <delete dir=\"testfiles\"/>\n        <delete file=\"test.zip\"/>\n        <mkdir dir=\"testfiles\"/>\n        <echo file=\"testfiles/test.txt\">This is a test file</echo>\n        <zip destfile=\"test.zip\" basedir=\"testfiles\">\n            <fileset dir=\"testfiles\"/>\n        </zip>\n        <zip destfile=\"test.zip\" update=\"true\">\n            <fileset dir=\"${basedir}\" includes=\"build.xml\"/>\n        </zip>\n    </target>\n\n</project>\n\n\nOutput:\n\nBuildfile: /home/arussell/dev/testzip/build.xml\n\ntestzip:\n   [delete] Deleting directory /home/arussell/dev/testzip/testfiles\n   [delete] Deleting: /home/arussell/dev/testzip/test.zip\n    [mkdir] Created dir: /home/arussell/dev/testzip/testfiles\n      [zip] Building zip: /home/arussell/dev/testzip/test.zip\n      [zip] Updating zip: /home/arussell/dev/testzip/test.zip\n\nBUILD FAILED\n/home/arussell/dev/testzip/build.xml:12: java.lang.NullPointerException\n\tat org.apache.tools.ant.taskdefs.Zip.zipFile(Zip.java:1827)\n\tat org.apache.tools.ant.taskdefs.Zip.zipFile(Zip.java:1856)\n\tat org.apache.tools.ant.taskdefs.Zip.addResource(Zip.java:1031)\n\tat org.apache.tools.ant.taskdefs.Zip.addResources(Zip.java:953)\n\tat org.apache.tools.ant.taskdefs.Zip.executeMain(Zip.java:702)\n\tat org.apache.tools.ant.taskdefs.Zip.execute(Zip.java:568)\n\tat org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:291)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:601)\n\tat org.apache.tools.ant.dispatch.DispatchUtils.execute(DispatchUtils.java:106)\n\tat org.apache.tools.ant.Task.perform(Task.java:348)\n\tat org.apache.tools.ant.Target.execute(Target.java:435)\n\tat org.apache.tools.ant.Target.performTasks(Target.java:456)\n\tat org.apache.tools.ant.Project.executeSortedTargets(Project.java:1393)\n\tat org.apache.tools.ant.Project.executeTarget(Project.java:1364)\n\tat org.apache.tools.ant.helper.DefaultExecutor.executeTargets(DefaultExecutor.java:41)\n\tat org.apache.tools.ant.Project.executeTargets(Project.java:1248)\n\tat org.apache.tools.ant.Main.runBuild(Main.java:851)\n\tat org.apache.tools.ant.Main.startAnt(Main.java:235)\n\tat org.apache.tools.ant.launch.Launcher.run(Launcher.java:280)\n\tat org.apache.tools.ant.launch.Launcher.main(Launcher.java:109)\n\nTotal time: 0 seconds\n\n\nAfter a bit of digging, it seems that that this problem is related to the Zip64 support added in Ant 1.9.0.  When I built a version of Ant with zip64Mode in ZipOutputStream set to Zip64Mode.Never the problem went away.\n\nIt seems that the ZipEntry.equals method is concluding that objects are different when they should be the same.  This is down to the values of the extra fields being different.\n\nAnyway, I have only found this to cause a problem in build scripts that are erroneously adding duplicate entries to zip files so adding 'duplicate=\"preserve\"' is the simple workaround.\n\nThanks", "count": 0, "id": 167194, "time": "2013-05-14T12:51:35Z", "creator": "arussell@thrupoint.com", "creation_time": "2013-05-14T12:51:35Z", "is_private": false}, {"count": 1, "tags": [], "creator": "bodewig@apache.org", "text": "I can confirm the bug.  The problem seems to be ZipFile.getInputStream returning null when asked for the stream of a duplicate entry.  Off the top of my head I don't know a quick fix since ZipFile hashes entries by name - I'm looking into it.", "id": 167208, "time": "2013-05-15T04:35:02Z", "bug_id": 54967, "creation_time": "2013-05-15T04:35:02Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "text": "Just a quick status update: https://issues.apache.org/jira/browse/COMPRESS-227\n\nA quick fix is to simply ignore existing duplicate entries, everything that tried to preserve all duplicates will need an API change to ZipFile.  I'll discuss the options on the dev list.", "is_private": false, "id": 167308, "creator": "bodewig@apache.org", "time": "2013-05-20T15:26:35Z", "bug_id": 54967, "creation_time": "2013-05-20T15:26:35Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "bodewig@apache.org", "text": "the NPE itself has been fixed in Ant 1.9.2", "id": 171983, "time": "2013-12-31T14:54:38Z", "bug_id": 54967, "creation_time": "2013-12-31T14:54:38Z", "is_private": false, "attachment_id": null}]