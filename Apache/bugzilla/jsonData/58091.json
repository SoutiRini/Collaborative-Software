[{"count": 0, "tags": [], "text": "While trying to use memcache for SSL sessions\n\n  SSLSessionCache memcache:127.0.0.1\n\nI noticed the connection to the memcache server is not reused but dropped and recreated on every request. This can be checked using tcpdump.\n\nThe cause of this behavior seems to be incorrect TTL setting in mod_socache_memcache.c:\n\n  #ifndef MC_DEFAULT_SERVER_TTL\n  #define MC_DEFAULT_SERVER_TTL 600\n  #endif\n\nThis is than used when creating memcache server:\n\n        rv = apr_memcache_server_create(p,\n                                        host_str, port,\n                                        MC_DEFAULT_SERVER_MIN,\n                                        MC_DEFAULT_SERVER_SMAX,\n                                        thread_limit,\n                                        MC_DEFAULT_SERVER_TTL,\n                                        &st);\n\nMy guess is the author wanted a TTL of 600 seconds (10 minutes) which is reasonable, but the problem is the units for this parameter are in microseconds so the connection does not have a chance of reuse in next 600 microseconds.\n\nChanging this constant to 600 * 1000 * 1000 restores the intended behavior of caching the connection for 10 minutes.", "attachment_id": null, "bug_id": 58091, "id": 183845, "time": "2015-07-02T08:59:07Z", "creator": "valentin.vidic@carnet.hr", "creation_time": "2015-07-02T08:59:07Z", "is_private": false}, {"count": 1, "tags": [], "text": "Hi,\n\nlooks good to me.\nSee http://marc.info/?l=subversion-dev&m=139866123837158 for the same kind of issue in svn.\n\nThanks", "is_private": false, "id": 183863, "creator": "christophe.jaillet@wanadoo.fr", "time": "2015-07-02T19:58:29Z", "bug_id": 58091, "creation_time": "2015-07-02T19:58:29Z", "attachment_id": null}, {"count": 2, "tags": [], "text": "The parameter would preferably be configurable, so that a close from the memcache side (which may also have a timeout) does not produce an error.\n\nThe TTL is an idle timeout, active only when the connection is unused, hence reset on each use.\nThere is also no mechanism to test the connection before reusing it in mod_socache_memcache, unlike in mod_proxy.\nThe timeouts with the memcache have to be synced (a little lower here).\n\nThe current code inhibited that potential error.", "attachment_id": null, "bug_id": 58091, "id": 183872, "time": "2015-07-03T00:14:10Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2015-07-03T00:14:10Z", "is_private": false}, {"count": 3, "tags": [], "text": "I would also advocate a low (15/20 seconds) default (or at worse hard) timeout.", "attachment_id": null, "bug_id": 58091, "id": 183873, "time": "2015-07-03T00:17:28Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2015-07-03T00:17:28Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 58091, "attachment_id": null, "id": 184573, "time": "2015-08-15T22:05:37Z", "creator": "christophe.jaillet@wanadoo.fr", "creation_time": "2015-08-15T22:05:37Z", "is_private": false, "text": "Change of default value + new option to configure the TTL (MemcacheConnTTL) proposed in r1696105\n\n\n(In reply to Yann Ylavic from comment #2)\n> The timeouts with the memcache have to be synced (a little lower here).\n\nWhat do you mean? Can you elaborate?"}, {"count": 5, "tags": [], "text": "Proposed for backport in r1696139", "attachment_id": null, "bug_id": 58091, "id": 184578, "time": "2015-08-16T13:00:44Z", "creator": "christophe.jaillet@wanadoo.fr", "creation_time": "2015-08-16T13:00:44Z", "is_private": false}, {"count": 6, "tags": [], "text": "This is in 2.4.17", "is_private": false, "id": 185923, "creator": "christophe.jaillet@wanadoo.fr", "time": "2015-10-25T05:48:43Z", "bug_id": 58091, "creation_time": "2015-10-25T05:48:43Z", "attachment_id": null}]