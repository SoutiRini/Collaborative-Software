[{"count": 0, "tags": [], "creator": "richard-apache@musicbox.net", "attachment_id": null, "text": "Patch to add a new \"ProxySourceAddress\" directive to specify the source address\nof outgoing connections from mod_proxy.  If not specified, the local end of the\nsocket remains unbound, which typically uses the main IP address of the local\nmachine (OS-dependent).  A literal IP address is recommended, although anything\nsupported by apr_sockaddr_info_get(), including a hostname, is accepted.", "id": 58799, "time": "2004-06-05T16:15:10Z", "bug_id": 29404, "creation_time": "2004-06-05T16:15:10Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 29404, "is_private": false, "text": "Created attachment 11770\nPatchAvailable (against http-2.1 HEAD, but also applies cleanly to 2.0.49)", "id": 58800, "time": "2004-06-05T16:18:23Z", "creator": "richard-apache@musicbox.net", "creation_time": "2004-06-05T16:18:23Z", "attachment_id": 11770}, {"count": 2, "tags": [], "bug_id": 29404, "attachment_id": null, "is_private": false, "id": 58801, "time": "2004-06-05T16:20:19Z", "creator": "richard-apache@musicbox.net", "creation_time": "2004-06-05T16:20:19Z", "text": "I'm not familiar enough with the internals of APR to know if there is a clean\nway to tidy up the allocated pool memory in the case of a syntax error, though\nas the server is about to die anyway there's presumably not much point worrying!\n"}, {"count": 3, "attachment_id": null, "bug_id": 29404, "is_private": false, "id": 58869, "time": "2004-06-08T14:11:59Z", "creator": "minfrin@sharp.fm", "creation_time": "2004-06-08T14:11:59Z", "tags": [], "text": "The point behind pool memory is that it gets tidied up for you. You just need to\nselect the right pool, some pools only last as long as a request, others for the\nlife of the server child process.\n\nDoes your patch handle the case of when ProxySourceAddress is in a virtualhost\ncontainer?\n"}, {"count": 4, "tags": [], "bug_id": 29404, "text": "Yes, and it should follow the usual preference rules if it's also declared\noutside a VirtualHost.\n\nWould it be worth extending ProxySourceAddress to per-dir context?  It's not\nallowed there at the moment, but presumably it wouldn't be too difficult to add,\nsince mod_proxy already declares the per-dir create and merge hooks, and\nmaintains a per-dir config structure.  Actually, is it just a matter of adding\nACCESS_CONF or OR_ALL to the flags in proxy_cmds, and letting the core take care\nof the necessary merging?\n\nOn pools: I've used server->process->pconf, as bind_addr is only defined once at\ninitial config time and needs to survive across requests - is that an\nappropriate pool, or is there a better choice?\n", "id": 58888, "time": "2004-06-08T17:41:41Z", "creator": "richard-apache@musicbox.net", "creation_time": "2004-06-08T17:41:41Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 29404, "text": "Created attachment 11796\nEquivalent patch against apache-1.3 HEAD", "id": 58889, "time": "2004-06-08T18:10:54Z", "creator": "richard-apache@musicbox.net", "creation_time": "2004-06-08T18:10:54Z", "is_private": false, "attachment_id": 11796}, {"count": 6, "attachment_id": null, "bug_id": 29404, "text": "This patch is almost the thing I needed...\nCould you please give me some ideas as to how to make the \"ProxySourceAddress\"\nbe dynamically set according to EnvVars etc?\nParticularly I need to set it to REMOTE_ADDR but I still cannot find how to\nreference this (or any other connection-specific) parameter from within\nset_source_address()\n\n", "id": 73915, "time": "2005-04-21T19:15:51Z", "creator": "exposed@topcat.kled.org", "creation_time": "2005-04-21T19:15:51Z", "tags": [], "is_private": false}, {"count": 7, "text": "Hi,\n\nI have a problem with the Port for ProxySourceAddress.\nThe system is AIX 5.2 ML 4. Apache is 2.0.50.\n\nMy httpd.conf:\n\n<VirtualHost 223.99.214.38:80>\nProxySourceAddress 223.99.214.38\nServerName 223.99.214.38\nProxyPass /eroom http://223.99.214.12/eroom\nProxyPassReverse /eroom http://223.99.214.12/eroom\n</VirtualHost>\n\nSometimes it works, sometimes not.\nThe error_log shows this:\n\n[Fri Jun 17 11:39:38 2005] [notice] Apache/2.0.50 (Unix) DAV/2 configured --\nresuming normal operations\n[Fri Jun 17 11:39:42 2005] [error] proxy: HTTP: attempt to bind to source\naddress 223.99.214.38:52784 failed\n[Fri Jun 17 11:39:42 2005] [error] proxy: HTTP: attempt to bind to source\naddress 223.99.214.38:0 failed\n[Fri Jun 17 11:39:42 2005] [error] proxy: HTTP: attempt to bind to source\naddress 223.99.214.38:52784 failed\n\nWhy is the proxy module using Port 0 or 52784? I have no definitions of these ports.\n\nBest regards\nTorsten\n", "bug_id": 29404, "attachment_id": null, "id": 76493, "time": "2005-06-17T11:50:12Z", "creator": "torsten.reschke@gehe.de", "creation_time": "2005-06-17T11:50:12Z", "tags": [], "is_private": false}, {"count": 8, "tags": [], "text": "(In reply to comment #1)\n> Created an attachment (id=11770) [edit]\n> PatchAvailable (against http-2.1 HEAD, but also applies cleanly to 2.0.49)\n\nHello,\n\nI'm getting \"Address already in use\" Message (error_log) while reading further\nInformation from the backend web server ! As of result of this error, the web\npage elements are not beeing loaded (502 Bad Gateway in access_log).\n\nThe error occurs with Apache 2.0.54 on FreeBSD 5.4 and Solaris 8 systems.\n\n==> error_log <==\n[Mon Aug 01 12:55:12 2005] [debug] proxy_util.c(1161): (48)Address already in\nuse: proxy: HTTP: attempt to connect to 66.249.85.104:80 (www.google.de) failed\n[Mon Aug 01 12:55:12 2005] [debug] proxy_util.c(1150): proxy: HTTP: fam 2 socket\ncreated to connect to www.google.de\n[Mon Aug 01 12:55:12 2005] [error] (48)Address already in use: proxy: HTTP:\nattempt to connect to 66.249.85.99:80 (www.google.de) failed\n\nbest regards, \nsashi", "is_private": false, "id": 77900, "creator": "apache@sashi.de", "time": "2005-08-01T13:08:57Z", "bug_id": 29404, "creation_time": "2005-08-01T13:08:57Z", "attachment_id": null}, {"count": 9, "attachment_id": null, "creator": "jorton@redhat.com", "is_private": false, "id": 78146, "time": "2005-08-05T14:11:37Z", "bug_id": 29404, "creation_time": "2005-08-05T14:11:37Z", "tags": [], "text": "The patch should also set APR_SO_REUSEADDR if it is bind()ing the local end of\nthe socket to avoid that issue - see make_sock in listen.c"}, {"count": 10, "text": "Created attachment 18579\nProxy source address patch against httpd-2.2.2\n\nI have ported the original patch to httpd-2.2.2. I handles ProxySourceAddress\ndirective and also accepts a \"bind=1.2.3.4\" parameter for ProxyPass", "bug_id": 29404, "attachment_id": 18579, "id": 91052, "time": "2006-07-10T10:48:55Z", "creator": "xanco@nikhok.hu", "creation_time": "2006-07-10T10:48:55Z", "tags": [], "is_private": false}, {"count": 11, "tags": [], "bug_id": 29404, "text": "Created attachment 21507\nProxySourceAddress patch for 2.2.6", "id": 113631, "time": "2008-02-11T08:09:46Z", "creator": "asm@uezku.kemsu.ru", "creation_time": "2008-02-11T08:09:46Z", "is_private": false, "attachment_id": 21507}, {"count": 12, "tags": [], "creator": "asm@uezku.kemsu.ru", "attachment_id": 21508, "text": "Created attachment 21508\nProxySourceAddress patch for latest trunk (r620505)", "id": 113632, "time": "2008-02-11T08:10:29Z", "bug_id": 29404, "creation_time": "2008-02-11T08:10:29Z", "is_private": false}, {"count": 13, "tags": [], "text": "CC myself on FreeBSD related bugs", "is_private": false, "id": 124174, "creator": "pgollucci@apache.org", "time": "2009-01-18T16:19:19Z", "bug_id": 29404, "creation_time": "2009-01-18T16:19:19Z", "attachment_id": null}, {"count": 14, "tags": [], "text": "Created attachment 24440\nProxySourceAddress patch for 2.2.11", "is_private": false, "id": 131477, "creator": "dan@listening-station.net", "time": "2009-10-28T13:29:56Z", "bug_id": 29404, "creation_time": "2009-10-28T13:29:56Z", "attachment_id": 24440}, {"count": 15, "tags": [], "creator": "dan@listening-station.net", "attachment_id": 24441, "text": "Created attachment 24441\nProxySourceAddress patch for 2.2.14\n\nI just added patches for 2.2.11 and 2.2.14 - I'm using these two versions in production applications. I may have missed it - but - is this feature still in line for inclusion into trunk at some point?\n\nThanks!", "id": 131478, "time": "2009-10-28T13:50:08Z", "bug_id": 29404, "creation_time": "2009-10-28T13:50:08Z", "is_private": false}, {"count": 16, "attachment_id": null, "bug_id": 29404, "is_private": false, "id": 135831, "time": "2010-04-01T03:22:48Z", "creator": "jathan@gmail.com", "creation_time": "2010-04-01T03:22:48Z", "tags": [], "text": "(In reply to comment #15)\n> Created an attachment (id=24441) [details]\n> ProxySourceAddress patch for 2.2.14\n> \n> I just added patches for 2.2.11 and 2.2.14 - I'm using these two versions in\n> production applications. I may have missed it - but - is this feature still in\n> line for inclusion into trunk at some point?\n> \n> Thanks!\n\nI have a great need for the ProxySourceAddress patch you provided.  Having this would allow me to eliminate a nasty iptables double-NAT setup. If it's not too much trouble would you mind providing a patch against httpd 2.2.15?  Much thanks in advance."}, {"count": 17, "tags": [], "bug_id": 29404, "is_private": false, "text": "Created attachment 25229\nProxySourceAddress patch for 2.2.15", "id": 135882, "time": "2010-04-05T17:46:18Z", "creator": "dan@listening-station.net", "creation_time": "2010-04-05T17:46:18Z", "attachment_id": 25229}, {"count": 18, "tags": [], "text": "Committed in trunk in r1034916.  Documentation TBD.", "is_private": false, "bug_id": 29404, "id": 141702, "time": "2010-11-13T19:03:14Z", "creator": "nick@webthing.com", "creation_time": "2010-11-13T19:03:14Z", "attachment_id": null}, {"count": 19, "attachment_id": null, "bug_id": 29404, "is_private": false, "id": 141704, "time": "2010-11-14T04:14:08Z", "creator": "richard-apache@musicbox.net", "creation_time": "2010-11-14T04:14:08Z", "tags": [], "text": "Nick, that's great - THANK YOU!\n\nAs the original patch author (back in 2004!) I've been watching the evolution of this issue over the years, and it's great to have it committed at last.\n\nSince the original report, Apache has grown to have much more flexible proxy support (with balancer pools, etc), so would it be possible to add the changes suggested by Aron in comment #10 too, ie. allowing bind=<address> on ProxyPass?\n\nMoon on stick would be to port it all back to 2.2... is there any chance of that (if a patch is provided, of course), or is 2.4 due to be released soon anyway?"}, {"count": 20, "tags": [], "bug_id": 29404, "is_private": false, "text": "A BETTER (in the opinion of some, at least 2 people; maybe 3) version of this concept is at bug 45405.  That version also supports IPv6 and setting the TCP port range.  From what I can tell, this one (29404) is IPv4 only and lets the OS select the outbound source port.", "id": 147538, "time": "2011-06-27T23:32:10Z", "creator": "software+apache-httpd@kd6lvw.ampr.org", "creation_time": "2011-06-27T23:32:10Z", "attachment_id": null}, {"count": 21, "tags": [], "creator": "sf@sfritsch.de", "attachment_id": null, "is_private": false, "id": 154173, "time": "2012-02-26T16:33:12Z", "bug_id": 29404, "creation_time": "2012-02-26T16:33:12Z", "text": "fixed in 2.4.1"}]