[{"count": 0, "tags": [], "bug_id": 42474, "attachment_id": null, "id": 103425, "time": "2007-05-21T10:22:21Z", "creator": "yegor@dinom.ru", "creation_time": "2007-05-21T10:22:21Z", "is_private": false, "text": "1. Incorrect matching of notes to slides\n\nThis is a long standing problem apparently, I noticed a TODO comment about it... \nanyway, after a bit of trial and error the problem seems to be that for some PPT \nfiles the SlidePersistAtom from the note's SlideAtomSet has a wrong \nslideIdentifier sometimes, so matching it to the associated slide is impossible. \nBut if you look at the NotesAtom from the actual Notes record (retrieved via \ngetCoreRecordForSAS()) it has the correct slideId, so that's what I use in my patch.\n\nI don't know yet why SlideAtomSet.getSlidePersistAtom().getSlideIdentifier() is \ndifferent from Notes.getNotesAtom().getSlideId(), maybe that's the real bug and \nmy patch is merely working around it? Someone more knowledgeable could shed some \nlight on whether these two values are supposed to be always equal, in the \nmeantime this patch works perfectly for all my test cases which previously \nexhibited incorrect note->slide association.\n\n\n2. NPE in RichTextRun.isBold() when the RichTextRun comes from a Notes model object\n\nThe Notes object wasn't doing setSheet(this) on the text runs it returned, \ncausing a NPE inside RichTextRun.isCharFlagsTextPropVal() when any style \naccessor is called, because it tries to get the style info from the master sheet \nif not present. However, doing setSheet() in Notes was not enough, it merely \nmoved the NPE a couple of lines down because NotesMaster objects are not yet \nimplemented in HSLF, so I had to add a few null checks in RichTextRun too."}, {"count": 1, "tags": [], "text": "Created attachment 20225\ncorrect-matching-notes-to-slides.patch", "is_private": false, "id": 103426, "creator": "yegor@dinom.ru", "time": "2007-05-21T10:24:19Z", "bug_id": 42474, "creation_time": "2007-05-21T10:24:19Z", "attachment_id": 20225}, {"count": 2, "tags": [], "bug_id": 42474, "attachment_id": 20226, "id": 103427, "time": "2007-05-21T10:24:39Z", "creator": "yegor@dinom.ru", "creation_time": "2007-05-21T10:24:39Z", "is_private": false, "text": "Created attachment 20226\nfix-NPE-with-textruns-from-notes.patch"}, {"count": 3, "tags": [], "creator": "grnch@gmx.net", "attachment_id": 20229, "text": "Created attachment 20229\nPPT file demonstrating the second bug\n\nTo reproduce the NPE:\n\nnew SlideShow(new\nHSLFSlideShow(\"NPE-in-textrun-from-notes.ppt\")).getNotes()[0].getTextRuns()[0].getRichTextRuns()[0].isBold();", "id": 103448, "time": "2007-05-21T15:04:30Z", "bug_id": 42474, "creation_time": "2007-05-21T15:04:30Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 42474, "attachment_id": 20235, "id": 103468, "time": "2007-05-21T22:05:19Z", "creator": "grnch@gmx.net", "creation_time": "2007-05-21T22:05:19Z", "is_private": false, "text": "Created attachment 20235\nPPT file demonstrating the first bug (Notes->Slides linkage)\n\nFrom http://www.cse.lehigh.edu/~caar/marnold/presentations/vail3.ppt\n\nFound a good example PPT file for the first bug. To reproduce:\n\nNotes notes = new SlideShow(new\nHSLFSlideShow(\"vail3.ppt\")).getSlides()[7].getNotesSheet();\n\nWithout the patch, this returns null. With the patch it returns the correct\nNotes object with the correct text.\n\n\nP.S. You will notice that with or without the patch there are some superflous\nNotes being returned for Slides which have no actual Notes in PowerPoint, but\natleast with the patch Notes don't seem to get lost."}, {"count": 5, "tags": [], "bug_id": 42474, "text": "Created attachment 20236\ncorrect-matching-notes-to-slides.patch\n\nRevised the patch for the first bug to not remove the TODO comment about \nnotes->slides linkage as there is obviously more work to be done.", "id": 103469, "time": "2007-05-21T22:16:29Z", "creator": "grnch@gmx.net", "creation_time": "2007-05-21T22:16:29Z", "is_private": false, "attachment_id": 20236}, {"count": 6, "text": "I applied the patches.\nUnit tests are in\nsrc/scratchpad/testcases/org/apache/poi/hslf/usermodel/TestBugs.java\n\n1. Incorrect matching of notes to slides\nMy fix is a bit different from the suggested patch. To find Notes for a Slide we\nneed to look at Slide.SlideAtom.notesId. It references the corresponding notes\nslide ( 0 if slide has no notes). This logic works OK to me.   \n\n2. NPE in RichTextRun.isBold() when the RichTextRun comes from a Notes model object\n\nApplied. It's possible to have null master sheet for Notes. No NPE in this case.\n\n>P.S. You will notice that with or without the patch there are some superflous\n>Notes being returned for Slides which have no actual Notes in PowerPoint, but\n>atleast with the patch Notes don't seem to get lost.\n\nI confirmed that. For the ppt from\nhttp://www.cse.lehigh.edu/~caar/marnold/presentations/vail3.ppt slides 2 and 3\ndon't have notes in PowerPoint but have them in HSLF. This is quite unexpected\nto me. Slide.SlideAtom.notesId indicates that the slide has notes. It looks like\nthere is something else to check when linking Slides and Notes. But what? I'm\nleaving this riddle undiscovered.  \n\nYegor", "bug_id": 42474, "attachment_id": null, "id": 103591, "time": "2007-05-24T01:09:56Z", "creator": "yegor@dinom.ru", "creation_time": "2007-05-24T01:09:56Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "bug_id": 42474, "attachment_id": null, "id": 103592, "time": "2007-05-24T01:17:08Z", "creator": "grnch@gmx.net", "creation_time": "2007-05-24T01:17:08Z", "is_private": false, "text": "Hi Yegor, looks like the second patch was not applied properly. The SVN commit \nmessage contains this chunk:\n\n\n \t\t\t\t// Record the match between slide id and these \nnotes\n-\t\t\t\tSlidePersistAtom spa = \nnotesSets[i].getSlidePersistAtom();\n-\t\t\t\tInteger slideId = new \nInteger(spa.getSlideIdentifier());\n-\t\t\t\tslideIdToNotes.put(slideId, new Integer(i));\n+                SlidePersistAtom spa = notesSets[i].getSlidePersistAtom();\n+                Integer slideId = new Integer(spa.getSlideIdentifier());\n+                slideIdToNotes.put(slideId, new Integer(i));\n\n\nbut the newly added code in this chunk should be:\n\n\nNotesAtom na = notesRecord.getNotesAtom();\nInteger slideId = new Integer(na.getSlideID());\nslideIdToNotes.put(slideId, new Integer(i));\n"}, {"count": 8, "tags": [], "text": "(In reply to comment #7)\n> Hi Yegor, looks like the second patch was not applied properly. The SVN \ncommit \n> message contains this chunk:\n\nAh, nevermind, I missed your comment that you solved it differently... I will \ntest your fix with other PPT files I have around, and report any issues.", "is_private": false, "id": 103593, "creator": "grnch@gmx.net", "time": "2007-05-24T01:22:28Z", "bug_id": 42474, "creation_time": "2007-05-24T01:22:28Z", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 42474, "text": "Hi Ivan,\n\nthis is intentionally.\nSee how I link Slides and Notes:\n\t\t// Do we have a notes for this?\n\t\tNotes notes = null;\n        //Slide.SlideAtom.notesId references the corresponding notes slide. 0 if\nslide has no notes.\n        int noteId = slidesRecords[i].getSlideAtom().getNotesID();\n        if (noteId != 0){\n            Integer notesPos = (Integer)slideIdToNotes.get(new Integer(noteId));\n            if (notesPos != null) notes = _notes[notesPos.intValue()];\n            else logger.log(POILogger.ERROR, \"Notes not found for noteId=\" +\nnoteId);\n        }\n\nSlide.SlideAtom.notesId points to the Note sheet and id of this sheet is takes\nfrom the corresponding SlidePersistAtom.slideId. (Don't be misleaded.\nSlidePersistAtom.slideId is actually sheet identifier, it can point to Slide,\nNotes, Master and other objects).\n\nYegor", "id": 103594, "time": "2007-05-24T01:28:44Z", "creator": "yegor@dinom.ru", "creation_time": "2007-05-24T01:28:44Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "text": ">I will test your fix with other PPT files I have around, and report any issues.\nOK. Shout if there are still problems with Slide-->Notes linkage.\n\nP.S. You posted more bugs. It's time to look at them :)\n\nYegor", "is_private": false, "id": 103595, "creator": "yegor@dinom.ru", "time": "2007-05-24T01:31:57Z", "bug_id": 42474, "creation_time": "2007-05-24T01:31:57Z", "attachment_id": null}, {"count": 11, "tags": [], "text": "Your fix works great with all my reference PPTs, thank you.", "attachment_id": null, "id": 103606, "creator": "grnch@gmx.net", "time": "2007-05-24T03:57:28Z", "bug_id": 42474, "creation_time": "2007-05-24T03:57:28Z", "is_private": false}]