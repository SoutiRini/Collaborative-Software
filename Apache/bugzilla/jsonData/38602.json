[{"count": 0, "tags": [], "text": "We are testing Apache 2.2 before migrating to this new release, and we found \nout that Apache does not keep sockets open with or other server (JBoss 3.2).\n\nThe same configuration is working fine on Apache 2.0.55.\n\nWe tried with both worker and prefork MPM, and this is the same behavior.\n\nApache is runing on Red Hat AS 4.0, Update2, 64 Bit, on a Dell Dual Core 1850.\n\n\nThe Keep-Alive connection between the IE Brower and Apache works OK, and no \nsocket is created between multiple requests, but every requests sent(proxied) \nbetween Apache and JBoss cause a new socket to be created.\n\nIE includes the HTTP header: Connection: Keep-Alive, but Apache does not send \nit to JBosss.\n\nThis is an example of the message received from IE, and then sent to JBOSS\n\nHTTP Request #1 IE Browser -> Apache\n\nReferer: \nhttp://mvperf21/application/company/navigation/fx/app/applicationStatusBar.jsp\nIf-Modified-Since: Wed, 01 Jan 2003 18:23:51 GMT\nAccept-Encoding: gzip, deflate\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR \n1.1.4322)\nHost: mvperf21\nConnection: Keep-Alive           *************Keep Alive Header **********\nCookie: JSESSIONID=83A9AE074F3F79CF0F7D24D88EE02167; OrganizationId=AA5000; \nuid=KsXw/VpMpxQPpqeqxomCRnH515Hx9LID9MpiUAvkw9c=; \n__JPW_SID__=83A9AE074F3F79CF0F7D24D88EE02167\n\n\nHTTP/1.1 200 OK\nDate: Fri, 10 Feb 2006 02:31:45 GMT\nCache-Control: no-cache\nPragma: No-cache\nExpires: Thu, 01 Jan 1970 00:00:00 GMT\nContent-Type: text/xml;charset=ISO-8859-1\nContent-Length: 54\n\n<OK ts=\"1139538705730\" pt=\"101\">\n</OK>\n\n\n\n\nHTTP Request #2 Apache -> JBoss (No Keep-Aliver HTTP Header ????)\n\n\nGET /proxy/company/proxy/u.jsp?\ndiagnum=220&userid=82955&count=20&wait=100&priority=1&ackIdList=&latency=176.49\n542718129723&realLatency=230&MsgInterval=331&MsgProcTime=70&lastMsgCount=0&QTPr\nocTime=20&IRProcTime=10&sts=200 HTTP/1.1\nHost: 198.252.177.19:8080\nAccept: */*\nAccept-Language: en-us\nReferer: \nhttp://mvperf21/application/company/navigation/fx/app/applicationStatusBar.jsp\nIf-Modified-Since: Wed, 01 Jan 2003 18:23:51 GMT\nAccept-Encoding: gzip, deflate\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR \n1.1.4322)\nCookie: JSESSIONID=83A9AE074F3F79CF0F7D24D88EE02167; OrganizationId=AA5000; \nuid=KsXw/VpMpxQPpqeqxomCRnH515Hx9LID9MpiUAvkw9c=; \n__JPW_SID__=83A9AE074F3F79CF0F7D24D88EE02167\nMax-Forwards: 10\nX-Forwarded-For: 198.252.177.123\nX-Forwarded-Host: mvperf21\nX-Forwarded-Server: mvperf21.company.com\n\nHTTP/1.1 200 OK\nCache-Control: no-cache\nPragma: No-cache\nExpires: Thu, 01 Jan 1970 00:00:00 GMT\nContent-Type: text/xml;charset=ISO-8859-1\nContent-Length: 54\nDate: Fri, 10 Feb 2006 02:31:45 GMT\n\n\n\nThis is the content of the httpd-vhosts.conf\n\n\n<VirtualHost 198.252.177.38:80>\nServerAdmin admin@company.com\nDocumentRoot \"/company/opt/apache2/htdocs/\"\nServerName mvperf21.integral.com:80\nErrorLog logs/error_log\n\nTimeout 300\nKeepAlive On\nMaxKeepAliveRequests 1000\nKeepAliveTimeout 100\n\nProxyRequests Off\n\t\nProxyPass        /proxy/ http://198.252.177.19:8080/proxy/ smax=5 max=20 \nttl=120 retry=300\nProxyPassReverse /proxy/ http://198.252.177.19:8080/proxy/      \n\t\n</VirtualHost>", "is_private": false, "id": 85671, "creator": "jean.dagenais@integral.com", "time": "2006-02-10T04:36:09Z", "bug_id": 38602, "creation_time": "2006-02-10T04:36:09Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "doug.dixon@gmail.com", "is_private": false, "text": "In HTTP/1.1 the _default_ behaviour is to use persistent connections. To quote\nthe spec:\n\n\"A significant difference between HTTP/1.1 and earlier versions of HTTP is that\npersistent connections are the default behavior of any HTTP connection. That is,\nunless otherwise indicated, the client SHOULD assume that the server will\nmaintain a persistent connection, even after error responses from the server.\"\n\nSo in this case IE is sending a Keep-Alive header to try to get persistent\nconnections even if it's talking to an HTTP/1.0 server that supports them. It's\nnot needed for HTTP/1.1 servers.\n\nAnyway, it looks to me like you probably are getting persistent connections\nbetween Apache and JBoss, which I infer from the HTTP/1.1 in the request and\nresponse headers and more specifically from the lack of a \"Connection: close\"\nheader from JBoss. (\"Connection: close\" is how an HTTP/1.1 server says it wants\nto close the TCP connection)\n\nThis is not conclusive, though. The Ultimate Test, of course - and what I\nrecommend - is to look at the TCP conversation between your hosts (e.g. with\nEthereal or Tethereal) to see whether TCP connections really are being closed\nafter each request.", "id": 85723, "time": "2006-02-12T04:40:16Z", "bug_id": 38602, "creation_time": "2006-02-12T04:40:16Z", "attachment_id": null}, {"count": 2, "tags": [], "text": "I did a trace with Ethereal, and the socket connection between IE and Apache \nis kept open, but a new socket is used between Apache and JBoss for each \nexchange.\n\nIE Is running on 198.252.177.123\nApache is running on 198.252.177.38\nJBOss is running on 198.252.177.19\n\nNo.     Time        Source                Destination           Protocol Info\n     16 0.250856    198.252.177.123       198.252.177.38        HTTP     \nGET /jmsproxy/company/jmsproxy/u.jsp?diagnum=221\n     17 0.000203    198.252.177.38        198.252.177.19        TCP      11970 \n> 8080 [SYN] Seq=0 Ack=0 Win=5840 Len=0 MSS=1460 TSV=8098330 TSER=0 WS=9\n     18 0.000053    198.252.177.19        198.252.177.38        TCP      8080 \n> 11970 [SYN, ACK] Seq=0 Ack=1 Win=5792 Len=0 MSS=1460 TSV=30418315 \nTSER=8098330 WS=9\n     19 0.000022    198.252.177.38        198.252.177.19        TCP      11970 \n> 8080 [ACK] Seq=1 Ack=1 Win=6144 Len=0 TSV=8098330 TSER=30418315\n     20 0.000066    198.252.177.38        198.252.177.19        HTTP     \nGET /jmsproxy/company/jmsproxy/u.jsp?diagnum=221\n     21 0.000156    198.252.177.19        198.252.177.38        TCP      8080 \n> 11970 [ACK] Seq=1 Ack=858 Win=7680 Len=0 TSV=30418316 TSER=8098330\n     22 0.102066    198.252.177.19        198.252.177.38        HTTP     \nHTTP/1.1 200 OK\n     23 0.000011    198.252.177.38        198.252.177.19        TCP      11970 \n> 8080 [ACK] Seq=858 Ack=257 Win=7168 Len=0 TSV=8098432 TSER=30418418\n     24 0.000086    198.252.177.38        198.252.177.19        TCP      11970 \n> 8080 [FIN, ACK] Seq=858 Ack=257 Win=7168 Len=0 TSV=8098432 TSER=30418418\n     25 0.000041    198.252.177.38        198.252.177.123       HTTP     \nHTTP/1.1 200 OK\n     26 0.000114    198.252.177.19        198.252.177.38        TCP      8080 \n> 11970 [FIN, ACK] Seq=257 Ack=859 Win=7680 Len=0 TSV=30418418 TSER=8098432\n     27 0.000010    198.252.177.38        198.252.177.19        TCP      11970 \n> 8080 [ACK] Seq=859 Ack=258 Win=7168 Len=0 TSV=8098432 TSER=30418418\n     28 0.217864    198.252.177.123       198.252.177.38        TCP      1578 \n> http [ACK] Seq=1493 Ack=512 Win=16656 Len=0\n\n\n     29 0.091197    198.252.177.123       198.252.177.38        HTTP     \nGET /jmsproxy/company/jmsproxy/u.jsp?diagnum=222\n     30 0.000145    198.252.177.38        198.252.177.19        TCP      11971 \n> 8080 [SYN] Seq=0 Ack=0 Win=5840 Len=0 MSS=1460 TSV=8098741 TSER=0 WS=9\n     31 0.000107    198.252.177.19        198.252.177.38        TCP      8080 \n> 11971 [SYN, ACK] Seq=0 Ack=1 Win=5792 Len=0 MSS=1460 TSV=30418727 \nTSER=8098741 WS=9\n     32 0.000014    198.252.177.38        198.252.177.19        TCP      11971 \n> 8080 [ACK] Seq=1 Ack=1 Win=6144 Len=0 TSV=8098742 TSER=30418727\n     33 0.000064    198.252.177.38        198.252.177.19        HTTP     \nGET /jmsproxy/company/jmsproxy/u.jsp?diagnum=222\n     34 0.000170    198.252.177.19        198.252.177.38        TCP      8080 \n> 11971 [ACK] Seq=1 Ack=857 Win=7680 Len=0 TSV=30418728 TSER=8098742\n     35 0.102191    198.252.177.19        198.252.177.38        HTTP     \nHTTP/1.1 200 OK\n     36 0.000009    198.252.177.38        198.252.177.19        TCP      11971 \n> 8080 [ACK] Seq=857 Ack=257 Win=7168 Len=0 TSV=8098844 TSER=30418830\n     37 0.000079    198.252.177.38        198.252.177.19        TCP      11971 \n> 8080 [FIN, ACK] Seq=857 Ack=257 Win=7168 Len=0 TSV=8098844 TSER=30418830\n     38 0.000041    198.252.177.38        198.252.177.123       HTTP     \nHTTP/1.1 200 OK\n     39 0.000122    198.252.177.19        198.252.177.38        TCP      8080 \n> 11971 [FIN, ACK] Seq=257 Ack=858 Win=7680 Len=0 TSV=30418830 TSER=8098844\n     40 0.000009    198.252.177.38        198.252.177.19        TCP      11971 \n> 8080 [ACK] Seq=858 Ack=258 Win=7168 Len=0 TSV=8098844 TSER=30418830\n\n\nI am also trying to used pooled connection to the backend, \n\ne.g. ProxyPass /example http://backend.example.com min=20 max=50 \n\nand I was wondering why I do not see these 20 connections created when I start \nthe Apache server? Does it require a Proxy message do be received before \ncreating these connections?", "is_private": false, "id": 85742, "creator": "jean.dagenais@integral.com", "time": "2006-02-13T19:15:49Z", "bug_id": 38602, "creation_time": "2006-02-13T19:15:49Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 38602, "attachment_id": null, "text": "A patch against trunk has been created (r378032,\nhttp://svn.apache.org/viewcvs?rev=378032&view=rev). Could you please give it a try?\nPlease keep in mind that there is a further keepalive bug with mod_proxy on the\nclient side of the connection (#38524).", "id": 85830, "time": "2006-02-15T21:36:12Z", "creator": "rpluem@apache.org", "creation_time": "2006-02-15T21:36:12Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 38602, "text": "I verified the patch, and it solve the issues with Keep Alive connections.\n\nThe connections are kept open, and the Keep-Alive header is passed to the \nJBoss server.\n\nThanks a lot!", "id": 86568, "time": "2006-03-07T14:57:57Z", "creator": "jean.dagenais@integral.com", "creation_time": "2006-03-07T14:57:57Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 38602, "text": "Proposed for backport as r383321 (http://svn.apache.org/viewcvs?rev=383321&view=rev)", "count": 5, "id": 86581, "time": "2006-03-07T20:35:53Z", "creator": "rpluem@apache.org", "creation_time": "2006-03-07T20:35:53Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 38602, "attachment_id": null, "text": "*** Bug 39258 has been marked as a duplicate of this bug. ***", "id": 87732, "time": "2006-04-10T20:18:05Z", "creator": "rpluem@apache.org", "creation_time": "2006-04-10T20:18:05Z", "is_private": false}, {"count": 7, "tags": [], "text": "*** Bug 39258 has been marked as a duplicate of this bug. ***", "is_private": false, "id": 87803, "creator": "rpluem@apache.org", "time": "2006-04-11T22:14:53Z", "bug_id": 38602, "creation_time": "2006-04-11T22:14:53Z", "attachment_id": null}, {"count": 8, "tags": [], "text": "*** Bug 43238 has been marked as a duplicate of this bug. ***", "is_private": false, "id": 112668, "creator": "asmorgrav@yahoo.no", "time": "2008-01-09T00:08:50Z", "bug_id": 38602, "creation_time": "2008-01-09T00:08:50Z", "attachment_id": null}]