[{"count": 0, "tags": [], "text": "occasionally, tomcat will throw this error.\n\nI am not sure whether it is same bug as this one: https://issues.apache.org/bugzilla/show_bug.cgi?id=56840\n\nalthough the stack trace originated from apache Shiro framework.but it seems irrelevant:\n\n17:40:43.804 [http-nio-28443-exec-4] WARN  o.a.shiro.mgt.DefaultSecurityManager - Delegate RememberMeManager instance of type [org.apache.shiro.web.mgt.CookieRememberMeManager] threw an exception during onLogout for subject with principals [andson]\njava.lang.NullPointerException: null\n        at org.apache.catalina.connector.Request.getContextPath(Request.java:1918) ~[catalina.jar:8.0.15]\n        at org.apache.catalina.connector.RequestFacade.getContextPath(RequestFacade.java:783) ~[catalina.jar:8.0.15]\n        at javax.servlet.http.HttpServletRequestWrapper.getContextPath(HttpServletRequestWrapper.java:150) ~[servlet-api.jar:na]\n        at javax.servlet.http.HttpServletRequestWrapper.getContextPath(HttpServletRequestWrapper.java:150) ~[servlet-api.jar:na]\n        at org.apache.shiro.web.servlet.SimpleCookie.calculatePath(SimpleCookie.java:192) ~[shiro-web-1.2.2.jar:1.2.2]\n        at org.apache.shiro.web.servlet.SimpleCookie.removeFrom(SimpleCookie.java:349) ~[shiro-web-1.2.2.jar:1.2.2]\n        at org.apache.shiro.web.mgt.CookieRememberMeManager.forgetIdentity(CookieRememberMeManager.java:288) ~[shiro-web-1.2.2.jar:1.2.2]\n        at org.apache.shiro.web.mgt.CookieRememberMeManager.forgetIdentity(CookieRememberMeManager.java:260) ~[shiro-web-1.2.2.jar:1.2.2]\n        at org.apache.shiro.mgt.AbstractRememberMeManager.onLogout(AbstractRememberMeManager.java:537) ~[shiro-core-1.2.2.jar:1.2.2]\n        at org.apache.shiro.mgt.DefaultSecurityManager.rememberMeLogout(DefaultSecurityManager.java:244) [shiro-core-1.2.2.jar:1.2.2]\n        at org.apache.shiro.mgt.DefaultSecurityManager.beforeLogout(DefaultSecurityManager.java:299) [shiro-core-1.2.2.jar:1.2.2]\n        at org.apache.shiro.web.mgt.DefaultWebSecurityManager.beforeLogout(DefaultWebSecurityManager.java:240) [shiro-web-1.2.2.jar:1.2.2]\n        at org.apache.shiro.mgt.DefaultSecurityManager.logout(DefaultSecurityManager.java:545) [shiro-core-1.2.2.jar:1.2.2]\n        at org.apache.shiro.subject.support.DelegatingSubject.logout(DelegatingSubject.java:363) [shiro-core-1.2.2.jar:1.2.2]\n......\n\nfrom source :\n\norg.apache.catalina.connector.Request:\n \n   public String More ...getContextPath() {\n     String uri = getRequestURI();\n     .....\n     return uri.substring(0, pos); ---\u300b NullPointerException\n   }\n\n   public String getRequestURI() {\n     return coyoteRequest.requestURI().toString();\n   }\n\norg.apache.coyote.Request:\n\n   public MessageBytes More ...requestURI() \n     return uriMB;\n   }\n\norg.apache.tomcat.util.buf.MessageBytes\uff1a\n\n   public String More ...toString() {\n156        if( hasStrValue ) {\n157            return strValue;\n158        }\n159\n160        switch (type) {\n161        case T_CHARS:\n162            strValue=charC.toString();\n163            hasStrValue=true;\n164            return strValue;\n165        case T_BYTES:\n166            strValue=byteC.toString();\n167            hasStrValue=true;\n168            return strValue;\n169        }\n170        return null;\n171    }\n\nBUT the uriMB's type is initialized as T_NULL which will cause toString return null!! anything I miss?", "is_private": false, "bug_id": 57527, "id": 180715, "time": "2015-02-03T10:14:41Z", "creator": "rayeaster@163.com", "creation_time": "2015-02-03T10:14:41Z", "attachment_id": null}, {"count": 1, "tags": [], "text": "All the indications are that the application is retaining a reference to a request after the request has been recycled.", "is_private": false, "bug_id": 57527, "id": 180718, "time": "2015-02-03T10:50:20Z", "creator": "markt@apache.org", "creation_time": "2015-02-03T10:50:20Z", "attachment_id": null}, {"count": 2, "attachment_id": null, "bug_id": 57527, "text": "Hi, Mark,\ncould you be more specific on how to avoid this issue ?\nThank you. please shed a light.\n\n(In reply to Mark Thomas from comment #1)\n> All the indications are that the application is retaining a reference to a\n> request after the request has been recycled.", "id": 180722, "time": "2015-02-03T11:58:53Z", "creator": "rayeaster@163.com", "creation_time": "2015-02-03T11:58:53Z", "tags": [], "is_private": false}, {"count": 3, "text": "Request and Response objects must not be accessed outside of request processing cycle.\n\n> org.apache.shiro.web.mgt.CookieRememberMeManager.forgetIdentity(CookieRememberMeManager.java:288) ~[shiro-web-1.2.2.jar:1.2.2]\n\nhttp://svn.apache.org/viewvc/shiro/tags/shiro-root-1.2.2/web/src/main/java/org/apache/shiro/web/mgt/CookieRememberMeManager.java?view=markup#l288\n\n[[[\n273 \tpublic void forgetIdentity(SubjectContext subjectContext) {\n274 \tif (WebUtils.isHttp(subjectContext)) {\n275 \tHttpServletRequest request = WebUtils.getHttpRequest(subjectContext);\n276 \tHttpServletResponse response = WebUtils.getHttpResponse(subjectContext);\n277 \tforgetIdentity(request, response);\n278 \t}\n279 \t}\n]]]\n\nAs SubjectContext stores a request and response pair, you must never pass this object to a different thread, you must never store it for longer than duration of a single request.", "bug_id": 57527, "attachment_id": null, "id": 180723, "time": "2015-02-03T12:35:43Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-02-03T12:35:43Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "creator": "rayeaster@163.com", "text": "Thank you Konstantin, this code snippet explains the principle very well.\n\n(In reply to Konstantin Kolinko from comment #3)\n> Request and Response objects must not be accessed outside of request\n> processing cycle.\n> \n> > org.apache.shiro.web.mgt.CookieRememberMeManager.forgetIdentity(CookieRememberMeManager.java:288) ~[shiro-web-1.2.2.jar:1.2.2]\n> \n> http://svn.apache.org/viewvc/shiro/tags/shiro-root-1.2.2/web/src/main/java/\n> org/apache/shiro/web/mgt/CookieRememberMeManager.java?view=markup#l288\n> \n> [[[\n> 273 \tpublic void forgetIdentity(SubjectContext subjectContext) {\n> 274 \tif (WebUtils.isHttp(subjectContext)) {\n> 275 \tHttpServletRequest request = WebUtils.getHttpRequest(subjectContext);\n> 276 \tHttpServletResponse response = WebUtils.getHttpResponse(subjectContext);\n> 277 \tforgetIdentity(request, response);\n> 278 \t}\n> 279 \t}\n> ]]]\n> \n> As SubjectContext stores a request and response pair, you must never pass\n> this object to a different thread, you must never store it for longer than\n> duration of a single request.", "id": 180730, "time": "2015-02-03T14:16:27Z", "bug_id": 57527, "creation_time": "2015-02-03T14:16:27Z", "is_private": false, "attachment_id": null}]