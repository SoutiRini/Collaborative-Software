[{"count": 0, "attachment_id": null, "bug_id": 1689, "is_private": false, "id": 2365, "time": "2001-05-09T13:28:10Z", "creator": "joelr@viair.com", "creation_time": "2001-05-09T13:28:10Z", "tags": [], "text": "On further analysis, it is clear that the\nBoundedFIFO class is the culprit in this situation.\n\nAround line #50, in method get(), the code does the following:\n    if(numElements == 0) \n      return null;\n    \n    LoggingEvent r = buf[first];\n    if(++first == maxSize) {\n\tfirst = 0;\n\nThe result is that the LoggingEvent is returned from the queue, but *not* \nremoved.  This prevents the VM from freeing the memory associated with this \nevent until either the event is over-written, or the program completes.\n\nRecommended:\nThe resulting 'dangling' reference should be removed from the queue with the \nline:\n    buf[first] = null; // Perf enhancement -- allows VM to cleanup this object \nmore quickly.\n\nThe resulting code would thus look like:\n  public\n  LoggingEvent get() {\n    if(numElements == 0) \n      return null;\n    \n    LoggingEvent r = buf[first];\n    buf[first] = null; // Perf enhancement -- allows VM to cleanup this object \nmore quickly.\n    if(++first == maxSize) {\n\tfirst = 0;\n    }\n    numElements--;    \n    return r;    \n  }\n\nTesting on 1000000 log entries keeps VM memory use to ~55 - ~60 MB.  The key \nadvantage comes at the end of processing when events are no longer being added \nto the queue.  Memory consumption actually decreases now and the application \nfinishes quickly.  Before the fix, the VM memory use shot up to 150 Mb at this \npoint."}, {"count": 1, "attachment_id": null, "bug_id": 1689, "text": "\nI had thought of the issue when I first wrote the BoundedFIFO class. At the \ntime, I did not think it was necessary. How big is your bounded buffer by the \nway? Thanks, Ceki\n\nps: Thanks for the precise bug report.", "id": 2654, "time": "2001-05-25T07:43:13Z", "creator": "bugzilla@apache.org", "creation_time": "2001-05-25T07:43:13Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "text": "The buffer size is 100000.", "attachment_id": null, "bug_id": 1689, "id": 2706, "time": "2001-06-01T14:44:22Z", "creator": "joelr@viair.com", "creation_time": "2001-06-01T14:44:22Z", "is_private": false}, {"count": 3, "tags": [], "creator": "bugzilla@apache.org", "text": "Joel,\n\nSorry, I forgot about this one. Corrected it just now. Regards, Ceki", "id": 3113, "time": "2001-06-19T23:16:26Z", "bug_id": 1689, "creation_time": "2001-06-19T23:16:26Z", "is_private": false, "attachment_id": null}]