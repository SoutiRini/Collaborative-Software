[{"count": 0, "tags": [], "creator": "christophe.jaillet@wanadoo.fr", "attachment_id": 27414, "text": "Created attachment 27414\nProposed patch\n\nHi, \n\nin 'modules/metadata/mod_usertrack.c', the function 'make_cookie' can be improved.\n\nActually, it uses a hard coded 1024 bytes buffer that is heap allocated. At the end of the function, this buffer is copied into a pool with a 'apr_pstrdup' call when doing the final 'apr_table_setn' call.\nSo, if the buffer was directly allocated within the pool, we could get reed of the intermediate buffer.\n\n\nWhat this patch actually does is :\n   - remove the 'cookiebuf' buffer\n   - allocate 'cookiebuf' directly in the pool with calling 'apr_psprintf' instead of 'apr_snprintf'\n   - turns a 'apr_psprintf(r->pool, \"%s=%s...)' call to an equivalent  'apr_pstrcat' call which is faster (1)\n   - move this before 'if (cls->expires)' because the same allocation is done in the 2 paths of the 'if' (1)\n   - avoid calling 'apr_pstrdup' when setting 'cookiebuf' in the table as it is now already allocated in the right location.\n\n(1) : this part is unrelated to the removal of the buffer, but was already proposed, accepted but never applied.\nSee https://issues.apache.org/bugzilla/show_bug.cgi?id=42008 for that.\n\nFinally, this patch is *not* tested and is proposed as-is, as I'm not able to compile httpd for now on my machine.\n\n\nBest regards,\nChristophe JAILLET", "id": 148722, "time": "2011-08-20T06:33:48Z", "bug_id": 51696, "creation_time": "2011-08-20T06:33:48Z", "is_private": false}, {"count": 1, "tags": [], "creator": "christophe.jaillet@wanadoo.fr", "attachment_id": null, "text": "In fact, I should speak of stack instead of heap...", "id": 148731, "time": "2011-08-20T13:10:48Z", "bug_id": 51696, "creation_time": "2011-08-20T13:10:48Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 51696, "attachment_id": null, "is_private": false, "id": 160573, "time": "2012-07-10T21:37:11Z", "creator": "christophe.jaillet@wanadoo.fr", "creation_time": "2012-07-10T21:37:11Z", "text": "Must be revisited due to some change in trunk.\nMaybe should be closed now that the 1024 bytes buffer is gone.\n\nRearranging the code in 'make_cookie' could still be a win. It could avoid the allocation of a buffer via apr_snprintf which is then apr_pstrdup'ed at the end of the function.\n\nThis would save one of the 2 allocations which are strings build with: \"%x.%\" APR_UINT64_T_HEX_FMT.\n\nWould you like me to propose an updated patch ?"}]