[{"count": 0, "tags": [], "bug_id": 53905, "attachment_id": null, "id": 162292, "time": "2012-09-19T20:07:14Z", "creator": "scott.watson@hybris.com", "creation_time": "2012-09-19T20:07:14Z", "is_private": false, "text": "I am trying the new jdbc connection pool with tomcat 6.0.35 and I am noticing some strange behavior.\n\nThe info about what I am doing is below.\n\nWhen the pool starts up I see 5 connections as I would expect, then after about 60 seconds 2 connections get dropped as there has been no activity.  Up to this point everything seems to be working properly.\n\n\nMy test program will do a http get over a fixed number of times for x number of sessions\n\nSo I call all.bat like this\n\nc:\\temp> all.bat 2 200 \n\nwhich will create two session that will do a wget 200 times each of a random number.\n\n\nNow I run my test, this is just 2 clients calling the same url over and over again in a loop. ( I would expect to see only 2 connections required but on the first run I see a total of 8 connections.  When the test completes in about 20 seconds I run the test again and I see the pool grow to a total of 17 connections.\n\nAlso, once I am done my tests I don't see idle connections being released from the pool either. I have waited over an hour and I don't see the connections being disconnected.\n\nSQL> /\n\nSYSDATE                     SID USERNAME                       LOGON_TIME           IDLE\n-------------------- ---------- ------------------------------ -------------------- --------------------\n19-SEP-2012 15:59:06         32 DBA_XXXX                     19-SEP-2012 15:45:12 0:0:39\n19-SEP-2012 15:59:06         34 DBA_XXXX                     19-SEP-2012 15:58:31 0:0:34\n19-SEP-2012 15:59:06         54 DBA_XXXX                     19-SEP-2012 15:58:55 0:0:11\n19-SEP-2012 15:59:06         55 DBA_XXXX                     19-SEP-2012 15:58:54 0:0:4\n19-SEP-2012 15:59:06         58 DBA_XXXX                     19-SEP-2012 15:58:54 0:0:11\n19-SEP-2012 15:59:06         69 DBA_XXXX                     19-SEP-2012 15:58:57 0:0:8\n19-SEP-2012 15:59:06         71 DBA_XXXX                     19-SEP-2012 15:59:01 0:0:5\n19-SEP-2012 15:59:06         79 DBA_XXXX                     19-SEP-2012 15:58:29 0:0:36\n19-SEP-2012 15:59:06         81 DBA_XXXX                     19-SEP-2012 15:45:12 0:0:49\n19-SEP-2012 15:59:06         87 DBA_XXXX                     19-SEP-2012 15:59:02 0:0:4\n19-SEP-2012 15:59:06         92 DBA_XXXX                     19-SEP-2012 15:58:27 0:0:37\n19-SEP-2012 15:59:06         94 DBA_XXXX                     19-SEP-2012 15:58:29 0:0:37\n19-SEP-2012 15:59:06        108 DBA_XXXX                     19-SEP-2012 15:58:59 0:0:5\n19-SEP-2012 15:59:06        117 DBA_XXXX                     19-SEP-2012 15:58:56 0:0:10\n19-SEP-2012 15:59:06        119 DBA_XXXX                     19-SEP-2012 15:45:12 0:0:37\n19-SEP-2012 15:59:06        132 DBA_XXXX                     19-SEP-2012 15:58:53 0:0:12\n19-SEP-2012 15:59:06        133 DBA_XXXX                     19-SEP-2012 15:58:56 0:0:10\n\n17 rows selected.\n\n\n\n\nall.bat\n~~~~~~~\necho off\nset size=%2\n\nfor /L %%x in (1, 1, %1) do (call :sub %%x )\nGOTO :eof\n\n:sub\nstart cmd /k c:\\temp\\run.bat %1 %size%\nGOTO :eof\n\n:eof\n\n\n\nrun.bat\n~~~~~~~~\n\necho off\nset FILE=%1\nset SIZE=%2\n\n\nfor /L %%x in (1, 1, %SIZE% ) do (call :sub %%x )\nGOTO :eof\n\n:sub\necho Run %1\nwget -q --output-document=sess%FILE%.txt http://localhost:8080/test/db\nGOTO :eof\n\n\n:eof\n\ncontext.xml\n~~~~~~~~~~~~\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Context path=\"/test\" docBase=\"test\" debug=\"1\" reloadable=\"true\">\n    <!-- Specify a JDBC datasource -->\n    <Resource name=\"jdbc/testdb\" auth=\"Container\"\n        type=\"javax.sql.DataSource\" username=\"dba_XXXX\" password=\"XXXXXX\"\n        factory=\"org.apache.tomcat.jdbc.pool.DataSourceFactory\"\n        driverClassName=\"oracle.jdbc.OracleDriver\"\n        url=\"jdbc:oracle:thin:@test1:1521/DB1\"\n        initialSize=\"5\" maxActive=\"20\" maxIdle=\"4\" minIdle=\"3\"\n        maxWait=\"-1\"\n        defaultAutoCommit=\"false\"\n        testOnBorrow=\"false\"\n        testWhileIdle=\"true\"\n        validationQuery=\"select 1 from dual\" />\n \n</Context>\n\n\nTestServlet.java\n~~~~~~~~~~~~~~~~\n\nimport java.io.IOException;\nimport java.sql.Connection;\nimport java.sql.ResultSet;\nimport java.sql.SQLException;\nimport java.sql.Statement;\n \nimport javax.naming.Context;\nimport javax.naming.InitialContext;\nimport javax.naming.NamingException;\nimport javax.servlet.ServletException;\nimport javax.servlet.http.HttpServlet;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\nimport javax.sql.DataSource;\n\nimport java.io.*;\n\nimport javax.servlet.http.*;\nimport javax.servlet.*;\n \npublic class TestServlet extends HttpServlet {\n     \n    private DataSource dataSource;\n    private Connection connection;\n    private Statement statement;\n     \n    public void init() throws ServletException {\n        try {\n            // Get DataSource\n            Context initContext  = new InitialContext();\n            Context envContext  = (Context)initContext.lookup(\"java:/comp/env\");\n            dataSource = (DataSource)envContext.lookup(\"jdbc/testdb\");\n \n             \n        } catch (NamingException e) {\n            e.printStackTrace();\n        }\n    }\n \n    public void doGet(HttpServletRequest req, HttpServletResponse resp)\n            throws ServletException, IOException {\n\n        PrintWriter out = resp.getWriter(); \n        ResultSet resultSet = null;\n        out.println(\"so far so good\");\n        try {\n            // Get Connection and Statement\n            connection = dataSource.getConnection();\n        out.println(\"got connection\");\n            statement = connection.createStatement();\n        out.println(\"create a statement\");\n            String query = \"select to_char(round(dbms_random.value(1,1000),4)) from dual\";\n        out.println(\"Query is \" + query);\n            resultSet = statement.executeQuery(query);\n        out.println(\"Got resultset\");\n            while (resultSet.next()) {\n                out.println(resultSet.getString(1) );\n            }\n        } catch (SQLException e) {\n            e.printStackTrace();\n        }finally {\n            out.println(\"Close resultset\");            \n            try { if (null!=resultSet) resultSet.close(); out.println(\"resultset closed\");} catch (SQLException e) \n            {e.printStackTrace();}\n          \n            out.println(\"Close statement\");            \n            try { if (null!=statement) statement.close(); out.println(\"Statement closed\"); } catch (SQLException e) \n            {e.printStackTrace();}\n                       \n            out.println(\"Close connection\");            \n            try { if (null!=connection) connection.close(); out.println(\"Connection Closed\"); } catch (SQLException e) \n            {e.printStackTrace();}\n                        \n            out.close(); \n        }\n    }\n}\n\n\nWeb.xml\n~~~~~~~~\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<web-app id=\"WebApp_ID\" version=\"2.4\"\n    xmlns=\"http://java.sun.com/xml/ns/j2ee\"\n    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n    xsi:schemaLocation=\"http://java.sun.com/xml/ns/j2ee http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd\">\n    <display-name>TomcatConnectionPooling</display-name>\n    <welcome-file-list>\n        <welcome-file>index.jsp</welcome-file>\n    </welcome-file-list>\n \n\n  <resource-ref>\n      <description>DB Connection</description>\n      <res-ref-name>jdbc/testdb</res-ref-name>\n      <res-type>javax.sql.DataSource</res-type>\n      <res-auth>Container</res-auth>\n  </resource-ref>\n\n    <servlet>\n        <servlet-name>TestServlet</servlet-name>\n        <servlet-class>TestServlet</servlet-class>\n    </servlet>\n    <servlet-mapping>\n        <servlet-name>TestServlet</servlet-name>\n        <url-pattern>/db</url-pattern>\n    </servlet-mapping>\n\n\n</web-app>\n\n\nOracle 11GR2 JDBC Driver Version : ojdbc6.jar\nJDBC CONNECTION POOL Version     : 1.1.0.1"}, {"count": 1, "tags": [], "creator": "dmikusa@gopivotal.com", "text": "The behavior you are seeing might be caused because you are storing a reference to the Connection and Statement objects at the class level on the Servlet object.  \n\nOnly *one* Servlet is used to process all incoming requests, so this isn't thread safe.  Each request will result in a new Connection being created and it could possibly overwrite a previous connection before it is closed properly.\n\n...\npublic class TestServlet extends HttpServlet {\n     \n    private DataSource dataSource;\n    private Connection connection;\n    private Statement statement;\n     \n    public void init() throws ServletException {\n...\n\nInstead put Connection and Statement inside of \"doGet\".", "id": 165384, "time": "2013-02-19T21:23:42Z", "bug_id": 53905, "creation_time": "2013-02-19T21:23:42Z", "is_private": false, "attachment_id": null}]