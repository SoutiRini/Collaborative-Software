[{"count": 0, "tags": [], "bug_id": 59431, "text": "Created attachment 33826\nimage\n\nHello,\n\nI have been struggling with memory problem for a while. For some reason the memory (1,3 GB) get full after some days of usage. \n\nIm using websocket to send and receive queries to client connected with Tyrus with the following function.\nThe WsPayload is stored in the session userproperties and later ofcourse removed.\n\nI have a dump file of the heap and I see with Mat abnormal amount org.apache.tomcat.websocket.server.WsFrameServer objects each occupying 5MB. There is no relations between amount of objects and sessions. The sessions are about 30-70.\n\nThe dump file is 30 MB so its not possible to attache it but will attach a screenshot of MAT \n\n@OnMessage\npublic void onMessage(Session session, final ByteBuffer message) {\n        try (ByteArrayInputStream ins = new   ByteArrayInputStream(message.array());\n\t\t\tObjectInputStream in = new ObjectInputStream(new GZIPInputStream(ins))){\n\t\t\tWsPayLoad sPayLoad = (WsPayLoad) in.readObject();\n\t\t\t\n\t\t\tWsHelper.putRespWsPayloadsSess(session, sPayLoad, message);\n\t\t} catch (IOException | ClassNotFoundException e) {\n\t\t\te.printStackTrace();\n\t\t}\n\t}\n\nBR,\nHugo Larson", "id": 190742, "time": "2016-05-05T06:00:50Z", "creator": "hugo.larson@yahoo.com", "creation_time": "2016-05-05T06:00:50Z", "is_private": false, "attachment_id": 33826}, {"count": 1, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 190744, "time": "2016-05-05T09:49:31Z", "bug_id": 59431, "creation_time": "2016-05-05T09:49:31Z", "is_private": false, "text": "The attached image shows that the WsFrameServer object has no GC root and is therefore eligible for GC.\n\nA quick test with the latest 7.0.x code with YourKit shows WsFrameServer objects in memory but all of them are eligible for GC.\n\nFor this type of bug report to be valid, you need to provide a reproducible test case that results in one or more WsFrameServer objects in memory and not eligible for GC with no active WebSocket conenctions.\n\nThe users list is the best place to debug the memory issues you are experiencing."}, {"count": 2, "tags": [], "creator": "hugo.larson@yahoo.com", "attachment_id": null, "text": "Hi,\n\nHow can you tell that they are eligible for GC?\n\nAdditionally when I made the dump i had 30 sessions but even the active sessions could not allocate 5MB each\n\nThis it what MAT say in the problem suspect tab:\n103 instances of \"org.apache.tomcat.websocket.server.WsFrameServer\", loaded by \"org.apache.catalina.loader.StandardClassLoader @ 0xcd11dbe0\" occupy 543 285 448 (92,59%) bytes. \n\nKeywords\norg.apache.tomcat.websocket.server.WsFrameServer\norg.apache.catalina.loader.StandardClassLoader @ 0xcd11dbe0\n\nI dont think MAT would classify the object as suspects if they are eligible for GC.\n\nI really wish that I could reproduce the leak.\n\nThanks,\nHugo", "id": 190746, "time": "2016-05-05T11:26:39Z", "bug_id": 59431, "creation_time": "2016-05-05T11:26:39Z", "is_private": false}]