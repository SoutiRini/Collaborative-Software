[{"count": 0, "tags": [], "creator": "ulf.wahlqvist@cybercomgroup.com", "attachment_id": null, "id": 139248, "time": "2010-08-19T10:38:36Z", "bug_id": 49784, "creation_time": "2010-08-19T10:38:36Z", "is_private": false, "text": ""}, {"count": 1, "tags": [], "bug_id": 49784, "attachment_id": 25915, "is_private": false, "id": 139249, "time": "2010-08-19T11:02:03Z", "creator": "ulf.wahlqvist@cybercomgroup.com", "creation_time": "2010-08-19T11:02:03Z", "text": "Created attachment 25915\nExtracts from logfiles"}, {"count": 2, "tags": [], "creator": "ulf.wahlqvist@cybercomgroup.com", "attachment_id": null, "id": 139250, "time": "2010-08-19T11:04:21Z", "bug_id": 49784, "creation_time": "2010-08-19T11:04:21Z", "is_private": false, "text": "Description:\n\nOverview:\n\nI'm trying to get Apache to do Client certificate verification with OCSP-validation.\nIt works without OCSP, but OCSP-validation fails when I turn it on.\nOCSP-validation works when using OpenSSL directly from command-line.\nThe error is \"OCSP_check_validity:status too old\", but that doesn't make sense because the clocks are within 2 seconds. \n\n\nSteps to Reproduce:\n\nI use a cardbased certificate issued by Telia for use by locol government etc. \nI'm not using the OCSP-responder address in the certificates \"Authority Info Access\" (http://sithsocsp.trust.telia.com), because it is not reachable from my system. However, the same responder is reachable using another address (http://ocsp.trust.telia.com).\n\nI have verified that if I use openssl directly from command line it will verify OK. \n>openssl ocsp -issuer /usr/local/apache2/conf/SITHS_CA_v3.cer -CAfile \n>/usr/local/apache2/conf/SITHS_CA_v3.cer -cert /mnt/download/uwcert.cer \n>-text -url http://ocsp.trust.telia.com\n.\n.\nResponse verify OK\n/mnt/download/uwcert.cer: good\n        This Update: Jul 29 10:43:41 2010 GMT\n        Next Update: Jul 30 10:43:45 2010 GMT\n\nTests: \n\n// Logfiles appended //\n\nCASE 1/ If I set:\nSSLOCSPDefaultResponder http://ocsp.trust.telia.com SSLOCSPOverrideResponder on\n\nThe validation will fail with \"SSL Library Error: error:2707307F:OCSP routines:OCSP_check_validity:status too old\". \nI have set GMT as the timezone and made sure that time is synchronized. According to the log the time-stamp from my system and the OCSP-responder is within 1 second.\n\n\nCASE 2/ If I set:\nSSLOCSPDefaultResponder http://ocsp.trust.telia.com\n\nThe validation of the first cert in the chain will succeed but the second will fail with \"(110)Connection timed out: could not connect to OCSP responder 'sithsocsp.trust.telia.com'\". This is the expected behavior because my computer does not have access to sithsocsp.trust.telia.com.\n\n\nCASE 3/ If I set:\nSSLOCSPDefaultResponder http://ocsp.trust.telia.com\n\n- Try to authenticate - It will fail as in 2 above.\n- Do NOT close the browser (IE, by the way)\n- set: SSLOCSPDefaultResponder http://ocsp.trust.telia.com SSLOCSPOverrideResponder on\n- restart using apachectl graceful\n- Retry to authenticate - It will now SUCCEED!\n\nI discovered this by accident, but it is reproducible.\n\nConfiguration:\n\n[root@fedoragui crl]# uname -a\nLinux fedoragui.mydomain.com 2.6.33.5-112.fc13.i686 #1 SMP Thu May 27 03:11:56 UTC 2010 i686 i686 i386 GNU/Linux\n\n[root@fedoragui logs]# httpd -v\nServer version: Apache/2.3.6 (Unix)\nServer built:   Jul 16 2010 15:31:39\n\n[root@fedoragui logs]# openssl version\nOpenSSL 1.0.0a-fips 1 Jun 2010\n\nApache configuration:\n./configure --enable-ssl"}, {"count": 3, "tags": [], "creator": "steve@openssl.org", "attachment_id": null, "text": "(In reply to comment #2)\n> \n> I have verified that if I use openssl directly from command line it will verify\n> OK. \n> >openssl ocsp -issuer /usr/local/apache2/conf/SITHS_CA_v3.cer -CAfile \n> >/usr/local/apache2/conf/SITHS_CA_v3.cer -cert /mnt/download/uwcert.cer \n> >-text -url http://ocsp.trust.telia.com\n> .\n> .\n> Response verify OK\n> /mnt/download/uwcert.cer: good\n>         This Update: Jul 29 10:43:41 2010 GMT\n>         Next Update: Jul 30 10:43:45 2010 GMT\n> \n\nThe (currently fixed) parameters set in Apache for OCSP response validation require that This Update is not more than 10 minutes in the past. Check the command line switch -status_age 360 with openssl and see if you get the same error.", "id": 139503, "time": "2010-08-26T13:11:25Z", "bug_id": 49784, "creation_time": "2010-08-26T13:11:25Z", "is_private": false}, {"count": 4, "tags": [], "creator": "ulf.wahlqvist@cybercomgroup.com", "attachment_id": null, "text": "(In reply to comment #3)\n> (In reply to comment #2)\n> > \n> > I have verified that if I use openssl directly from command line it will verify\n> > OK. \n> > >openssl ocsp -issuer /usr/local/apache2/conf/SITHS_CA_v3.cer -CAfile \n> > >/usr/local/apache2/conf/SITHS_CA_v3.cer -cert /mnt/download/uwcert.cer \n> > >-text -url http://ocsp.trust.telia.com\n> > .\n> > .\n> > Response verify OK\n> > /mnt/download/uwcert.cer: good\n> >         This Update: Jul 29 10:43:41 2010 GMT\n> >         Next Update: Jul 30 10:43:45 2010 GMT\n> > \n> \n> The (currently fixed) parameters set in Apache for OCSP response validation\n> require that This Update is not more than 10 minutes in the past. Check the\n> command line switch -status_age 360 with openssl and see if you get the same\n> error.\n\nYou where right - that is the problem:\n\n[root@fedoragui crl]# openssl ocsp -issuer /usr/local/apache2/conf/SITHS_CA_v3.cer -CAfile /usr/local/apache2/conf/SITHS_CA_v3.cer -cert /mnt/download/uwcert.cer -text -url http://ocsp.trust.telia.com -status_age 360\n.\n.\n.\nResponse verify OK\n/mnt/download/uwcert.cer: WARNING: Status times invalid.\n3079378652:error:2707307F:OCSP routines:OCSP_check_validity:status too old:ocsp_cl.c:338:\ngood\n\tThis Update: Aug 27 14:13:55 2010 GMT\n\tNext Update: Aug 28 14:13:58 2010 GMT\n[root@fedoragui crl]# date\nFri Aug 27 14:49:36 GMT 2010\n\nI then tested with -validity_period 60 and it works:\n\n[root@fedoragui crl]# openssl ocsp -issuer /usr/local/apache2/conf/SITHS_CA_v3.cer -CAfile /usr/local/apache2/conf/SITHS_CA_v3.cer -cert /mnt/download/uwcert.cer -text -url http://ocsp.trust.telia.com -validity_period 60\n.\n.\n.\nResponse verify OK\n/mnt/download/uwcert.cer: good\n\tThis Update: Aug 27 14:13:55 2010 GMT\n\tNext Update: Aug 28 14:13:58 2010 GMT\n[root@fedoragui crl]# openssl ocsp -issuer /usr/local/apache2/conf/SITHS_CA_v3.cer -CAfile /usr/local/apache2/conf/SITHS_CA_v3.cer -cert /mnt/download/uwcert.cer -text -url http://ocsp.trust.telia.com -validity_period 60\n\nI thought that -status_age was the same as -validity_period, but I now suspect that -validity_period is how old the response is and -status_age is \"when the crl-list that the responder is using was timestamped\". I then waited until I got another \"This Update\"-timestamp and got the successful verification and also SUCCEEDED to AUTHENTICATE in my browser.\n \n[root@fedoragui crl]# openssl ocsp -issuer /usr/local/apache2/conf/SITHS_CA_v3.cer -CAfile /usr/local/apache2/conf/SITHS_CA_v3.cer -cert /mnt/download/uwcert.cer -text -url http://ocsp.trust.telia.com -status_age 360\n\nResponse verify OK\n/mnt/download/uwcert.cer: good\n\tThis Update: Aug 27 14:51:18 2010 GMT\n\tNext Update: Aug 28 14:51:21 2010 GMT\n[root@fedoragui crl]# date\nFri Aug 27 14:55:07 GMT 2010\n\n\nThe 10 minutes limit is definitely a problem for me, because \"This update\" is updated infrequently:\n\nThis Update: Aug 27 13:55:10 2010 GMT\nThis Update: Aug 27 14:13:55 2010 GMT\nThis Update: Aug 27 14:51:18 2010 GMT\n\nI guess that it is updated \"on demand\", when something changes and not periodically.", "id": 139521, "time": "2010-08-27T11:23:50Z", "bug_id": 49784, "creation_time": "2010-08-27T11:23:50Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 49784, "attachment_id": null, "id": 139560, "time": "2010-08-30T09:42:23Z", "creator": "ulf.wahlqvist@cybercomgroup.com", "creation_time": "2010-08-30T09:42:23Z", "is_private": false, "text": "I checked with Telia and they only update when something changes, as I suspected.\n\n/ulfW"}, {"count": 6, "tags": [], "creator": "asfbugz@velox.ch", "is_private": false, "text": "Fixed with r1059917 - #define MAX_AGE (360) is gone.", "id": 149727, "time": "2011-09-25T16:06:24Z", "bug_id": 49784, "creation_time": "2011-09-25T16:06:24Z", "attachment_id": null}]