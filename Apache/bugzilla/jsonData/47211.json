[{"count": 0, "tags": [], "bug_id": 47211, "is_private": false, "text": "Set-up description: Apache listens on port 80. Proxy pass of a directory (containing vbscript .asp files) to IIS 6 which listens on another port (e.g. 8080).\n\nProblem: Links to most images that have Japanese file names are not rendered when the page is viewed via the proxypass but are rendered fine when viewed directly via IIS.\n\nIllustration:\n\nhttp://localhost/aspdir/aspfile.asp  (Apache passthrough: Many images with Japanese file names not rendered and displayed as broken links) \n\nhttp://localhost:8080/aspdir/aspfile.asp (Direct to IIS 6: All images including those with Japanese file names displayed correctly.)\n\nNote on probable reason for some images ok, others not:\n\nA note from long history of working with unicode issues which I believe may be happening in this case because some Japanese files are rendered and many are not: Often an application does not handle Japanese characters correctly as double-byte entities and instead each of the 2 bytes that make up a double byte character is evaluated separately. This often results in issues when one of the double-byte components is a punctuation character such as a double quote, single quote, semicolon, or other. For example, if a Japanese file name is enclosed in double quotes but one of the characters in the name contains a double quote, then that double-quote component incorrectly closes the string causing problems. This or something similar might be the case here because a few of the images with Japanese file names are rendered ok via proxypass but many are not.", "id": 127082, "time": "2009-05-17T16:54:06Z", "creator": "bsgcic1776@acite.com", "creation_time": "2009-05-17T16:54:06Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 47211, "attachment_id": null, "text": "Addendum: OS is native Japanese Windows 2003 Server", "id": 127084, "time": "2009-05-17T17:06:20Z", "creator": "bsgcic1776@acite.com", "creation_time": "2009-05-17T17:06:20Z", "is_private": false}, {"count": 2, "tags": [], "creator": "nick@webthing.com", "attachment_id": null, "text": "This report is meaningless without details.  There are many possible explanations other than an apache bug: for example a misconfiguration, or a backend that violates the HTTP protocol.\n\nPlease provide a URL that demonstrates the problem.", "id": 127088, "time": "2009-05-17T19:23:47Z", "bug_id": 47211, "creation_time": "2009-05-17T19:23:47Z", "is_private": false}, {"count": 3, "tags": [], "creator": "bsgcic1776@acite.com", "attachment_id": null, "is_private": false, "id": 127090, "time": "2009-05-17T20:51:38Z", "bug_id": 47211, "creation_time": "2009-05-17T20:51:38Z", "text": "The server is only accessible internally and thus I cannot provide a url to the server.\nI will do my best to provide as many details as possible so that this can be confirmed as a bug if agreed as such and so that it can be resolved. I will submit a few posts to separate the info in the interest of readibility.\n\nBelow are the uncommented contents of Apache httpd.conf (Note: that IIS is accessed via 8070 rather than 8080 which I had typed in my original post for the purpose of keeping that description simple):\n\nThreadsPerChild 250\nMaxRequestsPerChild  0\nServerRoot \"C:/dev/xampp/apache\"\nListen 80\nLoadModule actions_module modules/mod_actions.so\nLoadModule alias_module modules/mod_alias.so\nLoadModule asis_module modules/mod_asis.so\nLoadModule auth_basic_module modules/mod_auth_basic.so\nLoadModule auth_digest_module modules/mod_auth_digest.so\nLoadModule authn_alias_module modules/mod_authn_alias.so\nLoadModule authn_anon_module modules/mod_authn_anon.so\nLoadModule authn_dbd_module modules/mod_authn_dbd.so\nLoadModule authn_dbm_module modules/mod_authn_dbm.so\nLoadModule authn_default_module modules/mod_authn_default.so\nLoadModule authn_file_module modules/mod_authn_file.so\nLoadModule authz_dbm_module modules/mod_authz_dbm.so\nLoadModule authz_default_module modules/mod_authz_default.so\nLoadModule authz_groupfile_module modules/mod_authz_groupfile.so\nLoadModule authz_host_module modules/mod_authz_host.so\nLoadModule authz_user_module modules/mod_authz_user.so\nLoadModule autoindex_module modules/mod_autoindex.so\nLoadModule cache_module modules/mod_cache.so\nLoadModule mem_cache_module modules/mod_mem_cache.so\nLoadModule cern_meta_module modules/mod_cern_meta.so\nLoadModule charset_lite_module modules/mod_charset_lite.so\nLoadModule cgi_module modules/mod_cgi.so\nLoadModule dav_module modules/mod_dav.so\nLoadModule dav_fs_module modules/mod_dav_fs.so\nLoadModule deflate_module modules/mod_deflate.so\nLoadModule dir_module modules/mod_dir.so\nLoadModule env_module modules/mod_env.so\nLoadModule expires_module modules/mod_expires.so\nLoadModule ext_filter_module modules/mod_ext_filter.so\nLoadModule headers_module modules/mod_headers.so\nLoadModule ident_module modules/mod_ident.so\nLoadModule include_module modules/mod_include.so\nLoadModule info_module modules/mod_info.so\nLoadModule isapi_module modules/mod_isapi.so\nLoadModule ldap_module modules/mod_ldap.so\nLoadModule log_config_module modules/mod_log_config.so\nLoadModule mime_module modules/mod_mime.so\nLoadModule mime_magic_module modules/mod_mime_magic.so\nLoadModule negotiation_module modules/mod_negotiation.so\nLoadModule proxy_ajp_module modules/mod_proxy_ajp.so\nLoadModule proxy_balancer_module modules/mod_proxy_balancer.so\nLoadModule proxy_connect_module modules/mod_proxy_connect.so\nLoadModule proxy_http_module modules/mod_proxy_http.so\nLoadModule proxy_ftp_module modules/mod_proxy_ftp.so\nLoadModule rewrite_module modules/mod_rewrite.so\nLoadModule setenvif_module modules/mod_setenvif.so\nLoadModule speling_module modules/mod_speling.so\nLoadModule status_module modules/mod_status.so\nLoadModule unique_id_module modules/mod_unique_id.so\nLoadModule usertrack_module modules/mod_usertrack.so\nLoadModule vhost_alias_module modules/mod_vhost_alias.so\nLoadModule ssl_module modules/mod_ssl.so\nServerAdmin admin@localhost\nServerName localhost:80\nDocumentRoot \"C:/dev/xampp/htdocs\"\n<Directory />\n    Options FollowSymLinks\n    AllowOverride None\n    Order deny,allow\n    Deny from all\n</Directory>\n<Directory \"C:/dev/xampp/htdocs\">\n    Options Indexes FollowSymLinks Includes ExecCGI\n    AllowOverride All\n    Order allow,deny\n    Allow from all\n</Directory>\n<IfModule dir_module>\n    DirectoryIndex index.php index.php4 index.php3 index.cgi index.pl index.html index.htm index.shtml index.phtml\n</IfModule>\n<FilesMatch \"^\\.ht\">\n    Order allow,deny\n    Deny from all\n</FilesMatch>\nErrorLog logs/error.log\nLogLevel warn\n<IfModule log_config_module>\n    LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\" combined\n    LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b\" common\n    <IfModule logio_module>\n      LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" %I %O\" combinedio\n    </IfModule>\n    CustomLog logs/access.log common\n</IfModule>\n<IfModule alias_module>\n    ScriptAlias /cgi-bin/ \"C:/dev/xampp/cgi-bin/\"\n</IfModule>\n<Directory \"C:/dev/xampp/cgi-bin\">\n    AllowOverride None\n    Options None\n    Order allow,deny\n    Allow from all\n</Directory>\nDefaultType text/plain\n<IfModule mime_module>\n    TypesConfig conf/mime.types\n    AddType application/x-compress .Z\n    AddType application/x-gzip .gz .tgz\n    AddHandler cgi-script .cgi\n   AddType text/html .shtml\n   AddOutputFilter INCLUDES .shtml\n</IfModule>\nEnableMMAP off\nEnableSendfile off\nInclude conf/extra/httpd-xampp.conf\nInclude conf/extra/httpd-multilang-errordoc.conf\nInclude conf/extra/httpd-autoindex.conf\nInclude conf/extra/httpd-languages.conf\nInclude conf/extra/httpd-userdir.conf\nInclude conf/extra/httpd-info.conf\nInclude conf/extra/httpd-vhosts.conf\nInclude conf/extra/httpd-manual.conf\nInclude conf/extra/httpd-dav.conf\nInclude conf/extra/httpd-default.conf\nInclude conf/extra/httpd-ssl.conf\n<IfModule ssl_module>\nSSLRandomSeed startup builtin\nSSLRandomSeed connect builtin\n</IfModule>\nInclude conf/extra/perl.conf\nInclude conf/extra/mod_jk.conf\n<VirtualHost 127.0.0.1:80>\nServerName localhost\nProxyRequests Off\nProxyPass\t/aspdir/\thttp://localhost:8070/aspdir/\n<Location /aspdir/>\n        ProxyPassReverse /\n</Location>\nProxyPass\t/\thttp://localhost:8085/tomcat6root/\n<Location />\n        ProxyPassReverse /\n</Location>\n</VirtualHost>"}, {"count": 4, "tags": [], "bug_id": 47211, "text": "Will upload some additional files and description in a couple of hours.", "id": 127091, "time": "2009-05-17T20:56:56Z", "creator": "bsgcic1776@acite.com", "creation_time": "2009-05-17T20:56:56Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 47211, "is_private": false, "text": "Created attachment 23676\nFile which illustrates the issues\n\nAs can be seen in the output files (will also attach those). Some images with Japanese text in the file names are not rendered by apache proxypass but all are rendered when direct to IIS.", "id": 127095, "time": "2009-05-17T23:55:51Z", "creator": "bsgcic1776@acite.com", "creation_time": "2009-05-17T23:55:51Z", "attachment_id": 23676}, {"count": 6, "tags": [], "bug_id": 47211, "attachment_id": 23677, "is_private": false, "id": 127096, "time": "2009-05-17T23:57:53Z", "creator": "bsgcic1776@acite.com", "creation_time": "2009-05-17T23:57:53Z", "text": "Created attachment 23677\nResults from Apache proxypass\n\nSome of the images with Japanese file names are not rendered."}, {"count": 7, "tags": [], "bug_id": 47211, "attachment_id": 23678, "text": "Created attachment 23678\nOutput when direct to IIS\n\nAll images rendered.", "id": 127097, "time": "2009-05-17T23:58:47Z", "creator": "bsgcic1776@acite.com", "creation_time": "2009-05-17T23:58:47Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 47211, "is_private": false, "text": "Attached are the following:\n\n1. aspfile.asp\nSimple html file with the links. I made this a very short file to emphasize unlikeliness of this being a user error.\n\n2. Output_Apache_Proxypass.pdf\nOutput from http://localhost/aspdir/aspfile.asp\n\n3. Output_IIS.pdf\nOutput from http://localhost:8070/aspdir/aspfile.asp\n\nI am happy to help in testing/investigating/etc. given that I have access to Japanese language OS.\n\nPlease let me know of other info, files, etc. that I should post that would be helpful.", "id": 127098, "time": "2009-05-18T00:05:36Z", "creator": "bsgcic1776@acite.com", "creation_time": "2009-05-18T00:05:36Z", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 47211, "text": "Yes, I had guessed *the* server you're using was not visible.  That's why I asked for *a URL* that demonstrates the alleged problem.  It doesn't matter where: I can set up apache locally to proxy a URL anywhere on the 'net.\n\nIf there's an Apache bug, I need to be able to reproduce it.  Details of your configuration are IRRELEVANT without a test-case URL that demonstrates it.", "id": 127102, "time": "2009-05-18T02:15:17Z", "creator": "nick@webthing.com", "creation_time": "2009-05-18T02:15:17Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "creator": "bsgcic1776@acite.com", "attachment_id": null, "text": "Ok, I understand. Please verify via the following two urls:\n\nApachy proxypass:\nhttp://wexlerassociates.com/aspdir/aspfile.htm\n\nIIS:\nhttp://wexlerassociates.com:8070/aspdir/aspfile.htm\n\nChanges made to httpd.conf to enable this test:\nChanged 127.0.0.1:80 to *:80 in VirtualHost\nAdded ServerAlias wexlerassociates.com *.wexlerassociates.com\n\nUpdated VirtualHost section is now as follows:\n\n<VirtualHost *:80>\nServerName localhost\nServerAlias wexlerassociates.com *.wexlerassociates.com\nProxyRequests Off\nProxyPass    /aspdir/    http://localhost:8070/aspdir/\n<Location /aspdir/>\n        ProxyPassReverse /\n</Location>\nProxyPass    /    http://localhost:8085/tomcat6root/\n<Location />\n        ProxyPassReverse /\n</Location>\n</VirtualHost>", "id": 127135, "time": "2009-05-18T18:41:43Z", "bug_id": 47211, "creation_time": "2009-05-18T18:41:43Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 47211, "attachment_id": null, "text": "I hope I understood what you are looking for in terms of a url to provide. If not, kindly clarify so that I can provide it.", "id": 127136, "time": "2009-05-18T18:44:24Z", "creator": "bsgcic1776@acite.com", "creation_time": "2009-05-18T18:44:24Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 47211, "text": "\"OS is native Japanese Windows 2003 Server\"\n\nWindows is a unicode operating system; all file paths in the Windows OS are\nhandled with utf-8 naming from the perspective of the server, Apache will not\nserve files by URLs named with local code pages.\n\nIf you correct the img ref='' targets to (% escaped) utf-8, all will be well.", "id": 127172, "time": "2009-05-19T10:32:44Z", "creator": "wrowe@apache.org", "creation_time": "2009-05-19T10:32:44Z", "is_private": false, "attachment_id": null}, {"count": 13, "tags": [], "creator": "bsgcic1776@acite.com", "attachment_id": null, "is_private": false, "id": 127195, "time": "2009-05-19T17:01:10Z", "bug_id": 47211, "creation_time": "2009-05-19T17:01:10Z", "text": "I performed the test again using (% escaped) utf-8. However, it still appears to be an Apache bug.\nI updated aspfile.htm to illustrate. Kindly verify via the following links:\n\nApache proxypass:\nhttp://wexlerassociates.com/aspdir/aspfile.htm\n\nIIS direct:\nhttp://wexlerassociates.com:8070/aspdir/aspfile.htm\n\nPlease note the following about the modified file:\n1. I used the following site to encode: http://andrewu.co.uk/tools/uriencoder/\n2. For the top image, I illustrated that non of the encodings of the andrewu.co.uk site work in Apache Proxypass. \"Javascript encodeURI()\", \"ASP's Server.HTMLEncode(): (HTML-Safe Encoding)\", \"Partial Decimal Entities\", and \"Decimal Entities\" render in IIS direct but not Apache Proxypass.\n3. Following the encoding examples for the top image, the other image examples are ordered below with the ones that work in both IIS direct and via Apache Proxypass at the very bottom of the page (only one of these at the very bottom have Japanese characters in it; the other two are just ascii names and hence would be expected to work)."}, {"count": 14, "tags": [], "bug_id": 47211, "attachment_id": null, "text": "Addendum:\nWhen the same page is viewed direct to Apache, the page renders correctly (as in the case of direct to iis). Actually, it is really a proxypass from port 80 to port 8060 since I have / of 80 proxypass to tomcat6.\nThus, the page is only incorrectly rendered in the proxypass to IIS.\n\nThe following is the url to test viewing the page direct to apache (proxypass from port 80 to 8060):\nhttp://localhost/apache/aspdir/aspfile.htm\n\nFor the above url, I copied the aspdir directory into the apache server root and added the following to httpd.conf:\n\nListen 8060\n\nInside the <VirtualHost *:80>, I added the following:\n\nProxyPass /apache/ http://localhost:8060/\n<Location /apache/>\n        ProxyPassReverse /\n</Location>", "id": 127196, "time": "2009-05-19T19:29:35Z", "creator": "bsgcic1776@acite.com", "creation_time": "2009-05-19T19:29:35Z", "is_private": false}, {"count": 15, "tags": [], "bug_id": 47211, "attachment_id": null, "is_private": false, "id": 127197, "time": "2009-05-19T19:36:50Z", "creator": "bsgcic1776@acite.com", "creation_time": "2009-05-19T19:36:50Z", "text": "Sorry, the url for the apache direct (proxypass from port 80 to port 8060) in the above comment is:\n\nhttp://wexlerassociates.com/apache/aspdir/aspfile.htm"}, {"count": 16, "tags": [], "creator": "nick@webthing.com", "attachment_id": null, "is_private": false, "id": 127223, "time": "2009-05-20T16:41:37Z", "bug_id": 47211, "creation_time": "2009-05-20T16:41:37Z", "text": "Thanks for the URLs, which confirm several things NOT being the problem.\n\nI've just tested proxying that:\n\n<Location /aspdir/>\n        ProxyPass http://wexlerassociates.com:8070/aspdir/\n        Order allow,deny\n        Allow from all\n</Location>\n\nI then request /aspdir/aspfile.htm and I see all the images under the head \"Encodings of above that work when direct to IIS but not through Apache Proxypass\".  In other words, WorksForMe.\n\nYou have either a configuration issue or a windows-platform issue.  I can't test the latter because I don't have a windows box, so I won't close it.\n\nI note your server identifies itself as\nServer: Apache/2.2.11 (Win32) DAV/2 mod_ssl/2.2.11 OpenSSL/0.9.8i PHP/5.2.9 mod_jk/1.2.27 mod_perl/2.0.4 Perl/v5.10.0\nWhat happens if you remove PHP, Perl, SSL, DAV and mod_jk?"}, {"count": 17, "tags": [], "bug_id": 47211, "is_private": false, "text": "Created attachment 23699\nOriginal unmodified httpd.conf", "id": 127225, "time": "2009-05-20T21:01:49Z", "creator": "bsgcic1776@acite.com", "creation_time": "2009-05-20T21:01:49Z", "attachment_id": 23699}, {"count": 18, "tags": [], "creator": "bsgcic1776@acite.com", "attachment_id": 23700, "text": "Created attachment 23700\nOriginal unmodified httpd-xampp.conf", "id": 127226, "time": "2009-05-20T21:03:09Z", "bug_id": 47211, "creation_time": "2009-05-20T21:03:09Z", "is_private": false}, {"count": 19, "tags": [], "bug_id": 47211, "text": "Created attachment 23701\nOriginal unmodified perl.conf", "id": 127227, "time": "2009-05-20T21:04:06Z", "creator": "bsgcic1776@acite.com", "creation_time": "2009-05-20T21:04:06Z", "is_private": false, "attachment_id": 23701}, {"count": 20, "tags": [], "bug_id": 47211, "attachment_id": null, "text": "I performed tests removing components as Nick suggested and further identified the source of the bug. Based on these results, the bug may (or may not) be located in a project complementary to Apache.\n\nDistribution downloaded from http://www.apachefriends.org/en/xampp-windows.html\nThe following were installed:\n1. XAMPP Windows 1.7.1 [Basic package]\nxampp-win32-1.7.1-installer.exe\n\n2. XAMPP Add-On: Perl 5.10.0-2.2.11\nxampp-win32-perl-addon-5.10.0-2.2.11-pl2-installer.exe\n\n3. XAMPP Add-On: Tomcat 6.0.18\nxampp-win32-tomcat-addon-6.0.18-2.2.11-pl1-installer.exe\n\nThere are 3 lines in two default configuration files that cause this bug.  The bug disappears when these 3 lines are commented out. They are related to Perl and PHP. (I did not bother to investigate at this juncture as to what portions of perl.conf are causing this):\n\nWithin apache/conf/httpd.conf:\nInclude conf/extra/perl.conf\n\nWithin apache/conf/extras/httpd-xampp.conf:\nPHPINIDir \"C:/dev/xampp/php\"\nLoadModule php5_module \"C:/dev/xampp/apache/bin/php5apache2_2.dll\"\n\nI am attaching the default (unmodified) versions of httpd.conf, httpd-xampp.conf, and perl.conf for your review.\n\nIt seems surprising to me that these are the culprits given that there is no perl or php in the test file.\n\nHow do you suggest proceeding with the resolution of these bugs?", "id": 127228, "time": "2009-05-20T21:07:36Z", "creator": "bsgcic1776@acite.com", "creation_time": "2009-05-20T21:07:36Z", "is_private": false}, {"count": 21, "tags": [], "bug_id": 47211, "attachment_id": null, "is_private": false, "id": 127393, "time": "2009-05-25T15:27:50Z", "creator": "nick@webthing.com", "creation_time": "2009-05-25T15:27:50Z", "text": "It's possible Perl or PHP is doing some normalising in the early stages of request processing.  You should figure out which of them it is, and raise an issue with the relevant community.\n\nIn either case, I think we've established it's not an httpd bug, so I'm closing this report.  But I'll leave you with one final thought: does the \"nocanon\" proxy option help with this?"}, {"count": 22, "tags": [], "creator": "bsgcic1776@acite.com", "attachment_id": null, "text": "Nick, Wow! Adding nocanon worked.\nThe new proxypass:\nProxyPass /aspdir/ http://localhost:8070/aspdir/ nocanon\n\nIn researching how to add nocanon, I saw your post:\nhttp://mail-archives.apache.org/mod_mbox/httpd-users/200810.mbox/%3C9D057998-B452-4CA4-A2B5-2F34F7903285@webthing.com%3E\nwhere you suggested DefaultType None instead of DefaultType text/plain to address an issue with passing arguments to cgi and js when nocanon is used. I just tested both \"None\" and \"text/plain\" and both work for rendering these images. Thus, it should still be DefaultType none if nocanon is used? I am guessing that that is the accepted solution/requirement for nocanon?\nAllowEncodedSlashes On, ProxyRequests Off, KeepAlive Off were also configured according to the above thread. I am guessing that they are irrelevant/unnecessary for nocanon (although I already have ProxyRequests Off).\n\n\nPhp and perl: Without nocanon, the bug occurs when either one is enabled (and the other not enabled) as well as when both are enabled. Without nocanon, both must be disabled to avert the error. To help other folks as well, I am guessing that I should submit a bug to both the php and perl projects or do you think just leaving it as nocanon as the accepted workaround is best?\n\nThank you for all your help in analyzing this bug issue.", "id": 127396, "time": "2009-05-25T16:30:45Z", "bug_id": 47211, "creation_time": "2009-05-25T16:30:45Z", "is_private": false}]