[{"count": 0, "tags": [], "creator": "reto.ischi@ergon.ch", "is_private": false, "text": "openssl version: 1.0.1e\n\n1. simple httpd.conf:\n======================================================================\nUser daemon\nListen 8000\nServerName test\nDocumentRoot /tmp\n\nLoadModule ssl_module bin/mod_ssl.so\nSSLSessionCache shmcb:log/ssl_scache(512000)\n\nPidFile  /tmp/httpd.pid\nErrorLog /tmp/httpd.log\nLogLevel debug\n\nSSLEngine on\nSSLCertificateKeyFile /opt/airlock/ext-apache/conf/ssl.key/server.key\nSSLCertificateFile  /opt/airlock/ext-apache/conf/ssl.crt/server.crt\nSSLCACertificateFile /opt/airlock/ext-apache/conf/ssl.crt/client-ca.crt\nSSLVerifyDepth 3\n\n<Location /cert>\n        SSLVerifyClient require\n        SSLOptions +OptRenegotiate\n</Location>\n\n<Location /nocert>\n        SSLVerifyClient none\n        SSLOptions -OptRenegotiate\n</Location>\n======================================================================\n\n2) Request to /cert/, full ssl handshake, client sends valid certificate without an intermediate CA certificate, request is accepted by httpd\n\n3) Request to /nocert/ within TCP keep-alive timeout (same httpd process used), no client certificate requested, request accepted by httpd\n\n4) Request again to /cert/ within TCP keep-alive, quick renegotiation initiated, no client cert requested, 403 forbidden send to client, apache error log shows: Cannot find peer certificate chain\n\nssl_engine_kernel.c:\n\n 672         if (renegotiate_quick) {\n 673             STACK_OF(X509) *cert_stack;\n 674 \n 675             /* perform just a manual re-verification of the peer */\n 676             ap_log_rerror(APLOG_MARK, APLOG_DEBUG, 0, r, APLOGNO(02258)\n 677                          \"Performing quick renegotiation: \"\n 678                          \"just re-verifying the peer\");\n 679 \n 680             cert_stack = (STACK_OF(X509) *)SSL_get_peer_cert_chain(ssl);\n 681 \n 682             cert = SSL_get_peer_certificate(ssl);\n 683 \n 684             if (!cert_stack && cert) {\n 685                 /* client cert is in the session cache, but there is\n 686                  * no chain, since ssl3_get_client_certificate()\n 687                  * sk_X509_shift-ed the peer cert out of the chain.\n 688                  * we put it back here for the purpose of quick_renegotiation.\n 689                  */\n 690                 cert_stack = sk_X509_new_null();\n 691                 sk_X509_push(cert_stack, cert);\n 692             }\n 693 \n 694             if (!cert_stack || (sk_X509_num(cert_stack) == 0)) {\n 695                 ap_log_rerror(APLOG_MARK, APLOG_ERR, 0, r, APLOGNO(02222)\n 696                               \"Cannot find peer certificate chain\");\n 697 \n 698                 return HTTP_FORBIDDEN;\n 699             }\n\nIn the second request to /cert/, \"cert_stack\" (line: 680) and \"cert\" (line: 682) is not NULL but sk_X509_num(cert_stack) is 0 (line: 694), therefore we get the error \"Cannot find peer certificate chain\u201d on line 695.\n\nConfiguration workarounds we can\u2019t apply:\n\na) Removing \u201cOptRenegotiate\u201d on /cert/. We need this feature to prevent client certificate requests with every access to /cert\n\nb) Setting SSLVerifyClient to require or optional on the whole virtual host: Not possible because requests to /nocert should not trigger a certificate request.\n\nc) Disable keep-alive.\n\nOur expectation:\n\nIn step 4) httpd performs a quick renegotiation without asking the client to send again his certificate. The cached client certificate is validated against the configured CA certificate and the request is accepted. SSL_get_peer_cert_chain() may return an empty chain because the client does not send an intermediate CA certificate. This should not result in an 403 access forbidden if the cached certificate and the configured CA cert forms a valid certificate chain.\n\nRelated bug report (but not the same issue): https://issues.apache.org/bugzilla/show_bug.cgi?id=47055\nThe patches there changes the behaviour but causes other problems (intermediate CAs not cached and cause another 403 access denies in a quick renegotiation).", "id": 171259, "time": "2013-11-16T15:37:20Z", "bug_id": 55786, "creation_time": "2013-11-16T15:37:20Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 55786, "attachment_id": 34123, "text": "Created attachment 34123\nHandle empty cert chain as no chain for quick renegotiation\n\nDoes this patch fixes the issue ?", "id": 193015, "time": "2016-08-11T12:27:08Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2016-08-11T12:27:08Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 55786, "is_private": false, "count": 2, "id": 193070, "time": "2016-08-12T11:52:35Z", "creator": "urkedal@nbi.dk", "creation_time": "2016-08-12T11:52:35Z", "text": "(In reply to Yann Ylavic from comment #1)\n> Created attachment 34123 [details]\n> Handle empty cert chain as no chain for quick renegotiation\n> \n> Does this patch fixes the issue ?\n\nYes, thanks!  I rebuilt httpd-2.4.6-40.el7.centos.4.x86_64 with your patch, which applied cleanly.  With Chromium the page would consistently fail after the first reload of the page, after applying the patch, there are no failures.\n\n(Well, we still have a lot of \"AH02261: Re-negotiation handshake failed: Not accepted by client!?\", but we had that on the EL 6 server as well, and seemingly does not cause any real issue.)\n\nI'll try to get it into EL 7, unless you'd like to do it."}, {"count": 3, "tags": [], "creator": "reto.ischi@ergon.ch", "text": "(In reply to Yann Ylavic from comment #1)\n> Created attachment 34123 [details]\n> Handle empty cert chain as no chain for quick renegotiation\n> \n> Does this patch fixes the issue ?\n\nWorks for me as well. Thanks!", "id": 193137, "time": "2016-08-16T11:53:01Z", "bug_id": 55786, "creation_time": "2016-08-16T11:53:01Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 55786, "attachment_id": null, "text": "Committed in r1756542 and proposed for backport to 2.4.x.", "id": 193143, "time": "2016-08-16T22:05:29Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2016-08-16T22:05:29Z", "is_private": false}, {"count": 5, "tags": [], "creator": "christophe.jaillet@wanadoo.fr", "is_private": false, "text": "This has been merged in 2.4.x in r1770838.\n\nThis is part of version 2.4.24", "id": 198877, "time": "2017-05-25T12:13:58Z", "bug_id": 55786, "creation_time": "2017-05-25T12:13:58Z", "attachment_id": null}]