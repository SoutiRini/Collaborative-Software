[{"count": 0, "tags": [], "bug_id": 53725, "attachment_id": 29238, "text": "Created attachment 29238\nPlease see description for purpose of attachment.\n\nFlushableGZIPOutputStream gives corrupt output in rare circumstances.  Tomcat 7 encounters this bug when compression is turned on.\n\nPlease see the attachment:  Compile and run ErrorCase.java which uses FlushableGZIPOutputStream to GZIP the contents of data.bin (included in the attachment) and then uses GZIPInputStream to gunzip the output of FlushableGZIPOutputStream, resulting in java.io.IOException: Corrupt GZIP trailer.", "id": 161431, "time": "2012-08-15T18:28:36Z", "creator": "kevin.l.stern@nokia.com", "creation_time": "2012-08-15T18:28:36Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 53725, "attachment_id": null, "is_private": false, "id": 161701, "time": "2012-08-25T20:11:18Z", "creator": "markt@apache.org", "creation_time": "2012-08-25T20:11:18Z", "text": "Thanks for the test case. It made fixing this a whole lot easier than it would otherwise have been.\n\nThe fix has been applied to trunk and 7.0.x and will be included in 7.0.30 onwards.\n\nI haven't included the test case in the unit tests due to the size of the file required to trigger this issue. (It would significantly increase the size of the source distribution.)"}, {"count": 2, "tags": [], "creator": "knst.kolinko@gmail.com", "is_private": false, "id": 161707, "attachment_id": null, "bug_id": 53725, "creation_time": "2012-08-26T14:43:50Z", "time": "2012-08-26T14:43:50Z", "text": "Good catch.\nI proposed backport of this fix (r1377342) to Tomcat 6.0."}, {"count": 3, "tags": [], "creator": "kevin.l.stern@nokia.com", "text": "Created attachment 29286\nDemonstrates the same problem post-fix.\n\nPlease unzip to obtain the data.bin which causes the issue.", "id": 161743, "attachment_id": 29286, "bug_id": 53725, "creation_time": "2012-08-27T20:52:56Z", "time": "2012-08-27T20:52:56Z", "is_private": false}, {"count": 4, "tags": [], "creator": "kevin.l.stern@nokia.com", "is_private": false, "id": 161744, "attachment_id": null, "bug_id": 53725, "creation_time": "2012-08-27T20:53:36Z", "time": "2012-08-27T20:53:36Z", "text": "I have attached a new data.bin which demonstrates that the problem remains post-fix."}, {"count": 5, "tags": [], "creator": "kevin.l.stern@nokia.com", "is_private": false, "id": 161746, "attachment_id": null, "bug_id": 53725, "creation_time": "2012-08-27T21:10:49Z", "time": "2012-08-27T21:10:49Z", "text": "Note that, not surprisingly, using Java 7's GZIPOutputStream with syncFlush=true resolves the issue."}, {"count": 6, "tags": [], "creator": "markt@apache.org", "text": "That is an option for Tomcat 8 (which will require Java 7) but not for Tomcat 7 and earlier.", "id": 161747, "attachment_id": null, "bug_id": 53725, "creation_time": "2012-08-27T21:12:22Z", "time": "2012-08-27T21:12:22Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 53725, "text": "Very different failure mode (a whole chunk of data is missing from the end). Probably a different bug. I'll start digging.", "id": 161789, "time": "2012-08-28T21:14:14Z", "creator": "markt@apache.org", "creation_time": "2012-08-28T21:14:14Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "markt@apache.org", "text": "Easy solution implemented for trunk (Tomcat 8).\n\nStill trying to find a fix for Tomcat 7.", "id": 161793, "attachment_id": null, "bug_id": 53725, "creation_time": "2012-08-28T22:41:41Z", "time": "2012-08-28T22:41:41Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 53725, "is_private": false, "id": 161794, "attachment_id": 29297, "creator": "knst.kolinko@gmail.com", "creation_time": "2012-08-28T23:21:29Z", "time": "2012-08-28T23:21:29Z", "text": "Created attachment 29297\n2012-08-29_tc6_53725.patch\n\nThank you for the test!\n\nFixed in 7.0 with r1378378. Will be in 7.0.30.\n\nHere is patch for Tomcat 6 (r1377343 + r1378378)."}, {"count": 10, "text": "That test (In reply to comment #9)\n> Created attachment 29297 [details]\n> 2012-08-29_tc6_53725.patch\n> \n> Thank you for the test!\n> \n> Fixed in 7.0 with r1378378. Will be in 7.0.30.\n> \n> Here is patch for Tomcat 6 (r1377343 + r1378378).\n\nWhile that patch fixed the test for the second test case, it re-broke it for the first.\n\nAfter a lot of trial and error I have a patch that works for both test cases. I'm not at all clear as to the root cause of what is happening as the critical code is native code. The latest patch may still fail for some edge cases.", "bug_id": 53725, "is_private": false, "id": 161795, "time": "2012-08-28T23:58:28Z", "creator": "markt@apache.org", "creation_time": "2012-08-28T23:58:28Z", "tags": [], "attachment_id": null}, {"count": 11, "tags": [], "creator": "jessh@ptc.com", "attachment_id": null, "is_private": false, "id": 161798, "time": "2012-08-29T00:24:53Z", "bug_id": 53725, "creation_time": "2012-08-29T00:24:53Z", "text": "After some time with dealing with such issues with our own servlet filter for compression and trying various solutions tried in Tomcat, I finally gave up and went with jzlib for pre-Java-7 cases and with the built-in sync-flush functionality in Java 7 cases.  I got tired of someone always coming up with some new case where trying to allow flushing with the pre-Java-7 GZipOutputStream caused an issue."}, {"count": 12, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "is_private": false, "id": 161801, "time": "2012-08-29T00:59:00Z", "bug_id": 53725, "creation_time": "2012-08-29T00:59:00Z", "text": "I reverted the fix in r1378402\nand implemented a different one in r1378403 + r1378408 \n(will be in 7.0.30)\n\n\nThe FlushableGZIPOutputStream#deflate() method is not called by this class directly, but by its parent class, DeflaterOutputStream.\nSuch calls are always in a loop,\n\n            while (!def.needsInput()) {\n                deflate();\n            }\n\t    while (!def.finished()) {\n\t\tdeflate();\n\t    }\n\nso I there should not be a need to add (!def.needsInput()) condition to the deflate() method itself."}, {"count": 13, "tags": [], "bug_id": 53725, "text": "Fixed in 6.0.x and will be included in 6.0.36 onwards.", "id": 162567, "time": "2012-10-04T16:09:14Z", "creator": "markt@apache.org", "creation_time": "2012-10-04T16:09:14Z", "is_private": false, "attachment_id": null}]