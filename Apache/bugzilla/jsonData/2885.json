[{"count": 0, "tags": [], "bug_id": 2885, "attachment_id": null, "id": 4128, "time": "2001-07-30T05:46:00Z", "creator": "aklimuk@iba.by", "creation_time": "2001-07-30T05:46:00Z", "is_private": false, "text": "Actions 1:\n- Start TomCat 4.0 b5\n- Call jsp in browser, e.g.enter address: \n    http://localhost:8080/test.jsp\n- JSP is loaded\n- Change and save this \"test.jsp\"\n- Reload page in browser\n\nResult 1:\n- Old page is loaded\n\n\nActions 2:\n- Delete JSP compiled code (test.java and test.class files) in working direcory\n- Reload page in browser\n\nResult 2:\n- Old page is loaded\n- In working directory new test.java and test.class files created.\n  But their content is OLD: it corresponds to the PREVIOUS version of test.jsp, \nand DOES NOT correspond to the current test.jsp file.\n\nActions 3:\n- Stop TomCat\n- Delete test.java and test.class files in working directory\n- Start TomCat\n- Reload page in browser\n\nResult 3:\n- New content of test.jsp is loaded.\n\n\nAddition:\n  I traced JspCompiler.java, package org.apache.jasper.compiler.\n  Problem is in function isOutDated(). It contains folowing string:\n<\noutDated = classFile.lastModified() < jspRealLastModified;\n>\n  Here classFile.lastModified() is modifying time of *.class file. \njspRealLastModified should contain modifying time of the original *.jsp file.\n  But actually jspRealLastModified is ALWAYS equal to 0!\n  This variable is calculated in following string in function isOutDated():\n<\njspRealLastModified = jspUrl.openConnection().getLastModified();\n>\n  May be problem is here. jspUrl.openConnection() is instance of \norg.apache.naming.resources.DirContextURLConnection class.\n  Function getLastModified() of DirContextURLConnection class returns 0. This \nis because \"attributes\" field is null. \"attributes\" should be calculated in \nconnect() function. But actually it is not calculated because of following \npiece of code in connect() function:\n<\n                    if (hostName != null) {\n                        if (!path.startsWith(\"/\" + hostName + \"/\"))\n                            return;\n                        path = path.substring(hostName.length()+ 1);\n                    }\n>\n  Here for out \"test.jsp\" hostName is \"localhost\", path \nis \"/localhost\\test.jsp\", and function returns at this point.\n  As a result \"attributes\" is null, and getLastModified() returns 0, and \nJspCompiler supposes that *.class file is newer then original *.jsp, and does \nnot recompile this *.class file."}, {"count": 1, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "text": "It was a Windows only problem which has been fixed in b6.", "id": 4150, "time": "2001-07-30T10:50:52Z", "bug_id": 2885, "creation_time": "2001-07-30T10:50:52Z", "is_private": false}, {"count": 2, "tags": [], "creator": "p.padhu@verizon.net", "attachment_id": null, "id": 24277, "time": "2002-10-10T15:32:02Z", "bug_id": 2885, "creation_time": "2002-10-10T15:32:02Z", "is_private": false, "text": "4.1.12 ( Linux ), jdk1.3.1 -\n\nThis bug is still there. "}, {"count": 3, "tags": [], "creator": "ifischer@is24.de", "attachment_id": null, "id": 39083, "time": "2003-06-19T10:23:42Z", "bug_id": 2885, "creation_time": "2003-06-19T10:23:42Z", "is_private": false, "text": "W2k, Tomcat 4.1.24 -> Bug still exists"}, {"count": 4, "tags": [], "creator": "medthomas@ntlworld.com", "attachment_id": null, "id": 43457, "time": "2003-08-28T20:54:32Z", "bug_id": 2885, "creation_time": "2003-08-28T20:54:32Z", "is_private": false, "text": "I have tested this in Win XP, Tomcat 4.1-HEAD and it works. Each of the three \ntests outlined above give the correct result and show the newly modified page."}, {"attachment_id": null, "tags": [], "creator": "lindberg+apachebug@clindberg.org", "is_private": false, "count": 5, "id": 50843, "time": "2004-01-20T21:34:20Z", "bug_id": 2885, "creation_time": "2004-01-20T21:34:20Z", "text": "I just ran across this bug myself, running Jasper standalone in conjunction\nwith HttpUnit's ServletUnit.  It actually seems to be a Sun bug; the JDK 1.3.x\nfile: URL handler does not implement getLastModified() correctly and instead\nreturns 0 every time, in turn causing Jasper to not recompile the JSP.\nI believe this bug was fixed in JDK 1.4.x, which might explain why it works\nfor a lot of people.\n\nThe following patch to org.apache.jasper.compiler.Compiler fixed the problem \nfor me:\n\n--- Compiler.java.orig\t2004-01-20 15:54:27.000000000 -0500\n+++ Compiler.java\t2004-01-20 15:57:48.000000000 -0500\n@@ -408,6 +408,10 @@\n                 return false;\n             }\n             jspRealLastModified = jspUrl.openConnection().getLastModified();\n+\n+            /* Workaround JDK 1.3 bug; Sun's file: URL handler does not seem \nto implement last modified */\n+            if (jspRealLastModified == 0 && \"file\".equalsIgnoreCase\n(jspUrl.getProtocol()))\n+                jspRealLastModified = new File(jspUrl.getPath()).lastModified\n();\n         } catch (Exception e) {\n             e.printStackTrace();\n             return true;\n"}, {"count": 6, "tags": [], "bug_id": 2885, "attachment_id": null, "id": 51955, "time": "2004-02-09T00:44:37Z", "creator": "funkman@joedog.org", "creation_time": "2004-02-09T00:44:37Z", "is_private": false, "text": "This works for me with a 1.3 jvm,  tomcat 4.0 on windows. A patch won't be\napplied to address a broken JVM implementation.\n"}, {"count": 7, "tags": [], "text": "I think Tomcat supplies its own file: URL handler, which solves the problem\nfor JDK 1.3 as well.  Thus, this probably only shows up now when using Jasper\nstandalone on JDK 1.3 (such as with HttpUnit's ServletUnit test cases).  I can\nunderstand not wanting to workaround JVM bugs, but this makes Jasper much less\nusable on its own under most any JDK 1.3 installation, and I thought it was a\npretty minimal patch with a very quick test.\n", "attachment_id": null, "id": 52703, "creator": "lindberg+apachebug@clindberg.org", "time": "2004-02-20T23:37:47Z", "bug_id": 2885, "creation_time": "2004-02-20T23:37:47Z", "is_private": false}]