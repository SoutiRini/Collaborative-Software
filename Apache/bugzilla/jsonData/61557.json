[{"count": 0, "tags": [], "text": "[Overview]\nIn Tomcat 8.5 and Tomcat 9, if we turn on FIPS mode, there are KeyStoreException which cause tomcat service could not startup successfully.\n\n[Steps to Reproduce]\n1. Follow the Oracle doc to enable FIPS mode\nhttps://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/FIPS.html\nThe cryptographic provider \n\n2. Edit Tomcat server.xml to enable SSL \nNote: Provider depends on what FIPS-complinat cryptographic provider you used.\n\n<Connector port=\"8443\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\"\nmaxThreads=\"150\" SSLEnabled=\"true\">\n<SSLHostConfig>\n<Certificate certificateKeystoreFile=\"c:\\test.bcfks\"\ntype=\"RSA\" certificateKeystorePassword=\"changeit\" certificateKeystoreType=\"BCFKS\" certificateKeystoreProvider=\"CCJ\"/>\n</SSLHostConfig>\n</Connector>\n\n3. startup Tomcat\n\n[Actual Results]\nKeyStoreException occurs! The log is like the following shows:\n\nSep 19, 2017 2:59:59 PM org.apache.coyote.AbstractProtocol init\nINFO: Initializing ProtocolHandler [\"https-jsse-nio-4119\"]\nSep 19, 2017 3:00:00 PM org.apache.coyote.AbstractProtocol init\nSEVERE: Failed to initialize end point associated with ProtocolHandler [\"https-jsse-nio-4119\"]\njava.lang.IllegalArgumentException: java.security.KeyStoreException: FIPS mode: KeyStore must be from provider CCJ\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.createSSLContext(AbstractJsseEndpoint.java:114)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.initialiseSsl(AbstractJsseEndpoint.java:85)\n\tat org.apache.tomcat.util.net.NioEndpoint.bind(NioEndpoint.java:225)\n\tat org.apache.tomcat.util.net.AbstractEndpoint.init(AbstractEndpoint.java:982)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.init(AbstractJsseEndpoint.java:244)\n\tat org.apache.coyote.AbstractProtocol.init(AbstractProtocol.java:620)\n\tat org.apache.coyote.http11.AbstractHttp11Protocol.init(AbstractHttp11Protocol.java:66)\n\tat org.apache.catalina.connector.Connector.initInternal(Connector.java:997)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.core.StandardService.initInternal(StandardService.java:549)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.core.StandardServer.initInternal(StandardServer.java:875)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:140)\n\tat org.apache.catalina.startup.Tomcat.start(Tomcat.java:367)\n\tat com.thirdbrigade.manager.service.Tomcat.startTomcat(Tomcat.java:171)\n\tat com.thirdbrigade.manager.service.DSMService$WorkerThread.run(DSMService.java:247)\nCaused by: java.security.KeyStoreException: FIPS mode: KeyStore must be from provider CCJ\n\tat sun.security.ssl.KeyManagerFactoryImpl$SunX509.engineInit(KeyManagerFactoryImpl.java:67)\n\tat javax.net.ssl.KeyManagerFactory.init(KeyManagerFactory.java:256)\n\tat org.apache.tomcat.util.net.jsse.JSSEUtil.getKeyManagers(JSSEUtil.java:232)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.createSSLContext(AbstractJsseEndpoint.java:112)\n\t... 16 more\n\nSep 19, 2017 3:00:00 PM org.apache.catalina.core.StandardService initInternal\nSEVERE: Failed to initialize connector [Connector[HTTP/1.1-4119]]\norg.apache.catalina.LifecycleException: Failed to initialize component [Connector[HTTP/1.1-4119]]\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:112)\n\tat org.apache.catalina.core.StandardService.initInternal(StandardService.java:549)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.core.StandardServer.initInternal(StandardServer.java:875)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:140)\n\tat org.apache.catalina.startup.Tomcat.start(Tomcat.java:367)\n\tat com.thirdbrigade.manager.service.Tomcat.startTomcat(Tomcat.java:171)\n\tat com.thirdbrigade.manager.service.DSMService$WorkerThread.run(DSMService.java:247)\nCaused by: org.apache.catalina.LifecycleException: Protocol handler initialization failed\n\tat org.apache.catalina.connector.Connector.initInternal(Connector.java:999)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\t... 8 more\nCaused by: java.lang.IllegalArgumentException: java.security.KeyStoreException: FIPS mode: KeyStore must be from provider CCJ\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.createSSLContext(AbstractJsseEndpoint.java:114)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.initialiseSsl(AbstractJsseEndpoint.java:85)\n\tat org.apache.tomcat.util.net.NioEndpoint.bind(NioEndpoint.java:225)\n\tat org.apache.tomcat.util.net.AbstractEndpoint.init(AbstractEndpoint.java:982)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.init(AbstractJsseEndpoint.java:244)\n\tat org.apache.coyote.AbstractProtocol.init(AbstractProtocol.java:620)\n\tat org.apache.coyote.http11.AbstractHttp11Protocol.init(AbstractHttp11Protocol.java:66)\n\tat org.apache.catalina.connector.Connector.initInternal(Connector.java:997)\n\t... 9 more\nCaused by: java.security.KeyStoreException: FIPS mode: KeyStore must be from provider CCJ\n\tat sun.security.ssl.KeyManagerFactoryImpl$SunX509.engineInit(KeyManagerFactoryImpl.java:67)\n\tat javax.net.ssl.KeyManagerFactory.init(KeyManagerFactory.java:256)\n\tat org.apache.tomcat.util.net.jsse.JSSEUtil.getKeyManagers(JSSEUtil.java:232)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.createSSLContext(AbstractJsseEndpoint.java:112)\n\t... 16 more\n\n[Expected Results]\nTomcat should be startup successfully.\n\n[Build]\nthe latest 8.5.20 and 9.0.0.M26 have this issue.\n\n[Additional Information]\nIn nightly build 8.5.21, there is related fix but it doesn't solve this issue.\nhttps://github.com/apache/tomcat/commit/5fca54ea7b653403b5b12ac1d830a8a5fa5484d7#diff-a067af9186cf2818d35dbaa0828e2960\n\nIt's caused by hard code \"JKS\" for the in-memory keystore in JSSEUtil.java\n=========================\nif (k != null && \"PKCS#8\".equalsIgnoreCase(k.getFormat())) {\n              // Switch to in-memory key store\n              ksUsed = KeyStore.getInstance(\"JKS\");\n               ksUsed.load(null,  null);\n              ksUsed.setKeyEntry(keyAlias, k, keyPassArray, ks.getCertificateChain(keyAlias));\n}\n=====================\nThe keystoretype should use what user assign in connector setting.\nfor example, in this example, it should be BCFKS.", "attachment_id": null, "bug_id": 61557, "id": 201039, "time": "2017-09-21T11:40:32Z", "creator": "hyderai.dev@gmail.com", "creation_time": "2017-09-21T11:40:32Z", "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 61557, "text": "This was not tested with trunk, and is likely already fixed in it.", "id": 201040, "time": "2017-09-21T11:51:18Z", "creator": "remm@apache.org", "creation_time": "2017-09-21T11:51:18Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "creator": "hyderai.dev@gmail.com", "attachment_id": null, "id": 201041, "time": "2017-09-21T13:58:31Z", "bug_id": 61557, "creation_time": "2017-09-21T13:58:31Z", "is_private": false, "text": "Update the correct version which the issue happens."}, {"count": 3, "tags": [], "creator": "markt@apache.org", "attachment_id": 35359, "id": 201059, "time": "2017-09-21T22:35:38Z", "bug_id": 61557, "creation_time": "2017-09-21T22:35:38Z", "is_private": false, "text": "Created attachment 35359\nProposed patch for 9.0.x\n\nDoes this patch fix the issue? It is for 9.0.x but should apply to 8.5.x as well."}, {"count": 4, "tags": [], "bug_id": 61557, "attachment_id": null, "text": "(In reply to Mark Thomas from comment #3)\n> Created attachment 35359 [details]\n> Proposed patch for 9.0.x\n> \n> Does this patch fix the issue? It is for 9.0.x but should apply to 8.5.x as\n> well.\n\nI pull 8.5 source code in local and apply the same patch. And it solved the issue!\nThe tomcat could startup successfully. \n\n[Log]\nSep 22, 2017 10:13:57 AM org.apache.coyote.AbstractProtocol init\nINFO: Initializing ProtocolHandler [\"https-jsse-nio-8443\"]\nSep 22, 2017 10:13:58 AM org.apache.tomcat.util.net.SSLUtilBase getEnabled\nWARNING: Some of the specified [protocols] are not supported by the SSL engine and have been skipped: [[SSLv2Hello]]\nSep 22, 2017 10:13:58 AM org.apache.tomcat.util.net.NioSelectorPool getSharedSelector\nINFO: Using a shared selector for servlet write/read\nSep 22, 2017 10:13:58 AM org.apache.coyote.AbstractProtocol init\nINFO: Initializing ProtocolHandler [\"ajp-nio-8009\"]\nSep 22, 2017 10:13:58 AM org.apache.tomcat.util.net.NioSelectorPool getSharedSelector\nINFO: Using a shared selector for servlet write/read\nSep 22, 2017 10:13:58 AM org.apache.catalina.startup.Catalina load\nINFO: Initialization processed in 3715 ms\nSep 22, 2017 10:13:58 AM org.apache.catalina.core.StandardService startInternal\nINFO: Starting service [Catalina]\nSep 22, 2017 10:13:58 AM org.apache.catalina.core.StandardEngine startInternal\nINFO: Starting Servlet Engine: Apache Tomcat/8.5.22-dev", "id": 201066, "time": "2017-09-22T06:02:49Z", "creator": "hyderai.dev@gmail.com", "creation_time": "2017-09-22T06:02:49Z", "is_private": false}, {"count": 5, "tags": [], "text": "Thanks for testing and confirming the fix.\n\nFixed in\n- trunk for 9.0.0 onwards\n- 8.5.x for 8.5.22 onwards", "is_private": false, "bug_id": 61557, "id": 201067, "time": "2017-09-22T07:11:30Z", "creator": "markt@apache.org", "creation_time": "2017-09-22T07:11:30Z", "attachment_id": null}]