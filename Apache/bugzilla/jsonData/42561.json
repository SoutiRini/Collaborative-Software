[{"count": 0, "tags": [], "text": "The AuthLDAPRemoteUserAttribute directive only works when authn processing goes \nthrough mod_authnz_ldap. If authn processing does not go through \nmod_authnz_ldap, but authz processing does go through, then this directive has \nno effect.\n\nI will attach a patch that enables the directive for authz-only processing, and \nensures that the directive is only processed once if both authn and authz is \nencountered.", "attachment_id": null, "bug_id": 42561, "id": 103935, "time": "2007-05-31T19:58:54Z", "creator": "adeason2@uiuc.edu", "creation_time": "2007-05-31T19:58:54Z", "is_private": false}, {"attachment_id": 20303, "tags": [], "creator": "adeason2@uiuc.edu", "text": "Created attachment 20303\nPatch for mod_authnz_ldap.c against svn trunk", "count": 1, "id": 103936, "time": "2007-05-31T19:59:42Z", "bug_id": 42561, "creation_time": "2007-05-31T19:59:42Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "Martin.vGagern@gmx.net", "is_private": false, "count": 2, "id": 111556, "time": "2007-12-07T14:25:16Z", "bug_id": 42561, "creation_time": "2007-12-07T14:25:16Z", "text": "I've developed this improvement independently, as I hit a real world example. We\nhave a distributed authentication system with kerberos for authentication and\nldap for authorization. So the user authenticates using GSSAPI or\nusername/password. mod_auth_kerb passes the kerberos principal as user name,\nwhich includes the realm along with the real user name. Using the krb5Principal\nattribute as the key to search ldap allows me to find the correct entry. For the\napplications, however, we want the simple user name.\n\nFor my modifications I copied even more strongly from the authentication\nfunction. You find \"req->user = ...\" in all these functions. After that the\nauthentication does the following things before logging its success:\n1. handle sec->user_is_dn resp. AuthLDAPRemoteUserIsDN\n2. set AUTHENTICATE_* environment variables\n3. handle sec->remote_user_attribute resp. AuthLDAPRemoteUserAttribute\n4. sanity check that the requested attribute is really available\n\nI copied all these code fragments, as UserIsDN would be useful in an\nauthorization-only scenario as well, more information in the environment might\nbe useful to scripts (I replaced AUTHENTICATE with AUTHORIZE), and an error\nmessage in case of a missing attribute might help diagnosing errors. All this I\ncopied after the \"req->user = r->user\" assignment at the end of the \"if(!req)\"\nblock for authorization.\n\nI did my changes against the 2.2.x branch, where a single function handles\nauthorization. Current trunk has four such functions, and exactly duplicate\n\"if(!req)\" blocks in each of these. That's a lot of code duplication; I didn't\nwant to contribute to this by copying the stuff described above and pasting it\nfour times. Instead I think this common code should be factored out, but I can't\ndo this just now."}, {"count": 3, "tags": [], "bug_id": 42561, "attachment_id": 21247, "id": 111557, "time": "2007-12-07T14:29:42Z", "creator": "Martin.vGagern@gmx.net", "creation_time": "2007-12-07T14:29:42Z", "is_private": false, "text": "Created attachment 21247\nDifferent patch against 2.2.x branch\n\nCode copied from authn_ldap_check_password to authz_ldap_check_user_access in\nthe 2.2.x branch. I'll work on merging this into trunk without too much code\nduplication when and if I find the time, if noone beats me to it."}, {"count": 4, "tags": [], "bug_id": 42561, "is_private": false, "text": "Thanks for the patch!\n\nI'm using it on Apache 2.2.9 for a web app and with mod_dav_svn to allow single sign-on to our SVN repository.", "id": 129983, "time": "2009-08-27T07:20:16Z", "creator": "isenberg@e-spirit.de", "creation_time": "2009-08-27T07:20:16Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "covener@gmail.com", "is_private": false, "count": 5, "id": 129987, "time": "2009-08-27T08:13:41Z", "bug_id": 42561, "creation_time": "2009-08-27T08:13:41Z", "text": "I think the first patch writes to the per-directory config unsafely -- it is not per-request.  \n\nAlso, I think having the authorization handler overwrite r->user would have to be gated by a new directive."}, {"count": 6, "attachment_id": null, "bug_id": 42561, "text": "(In reply to comment #5)\n> I think the first patch writes to the per-directory config unsafely -- it is\n> not per-request.  \n> \n> Also, I think having the authorization handler overwrite r->user would have to\n> be gated by a new directive.\n\nI should elaborate that the \"req\" structure floating around in the right placs is per-request seems to be the proper place for this, and I'd be apt to commit a version that applied to trunk that didn't change behavior until a new directive were set.  \"req\" existence can then tell you if ldap performed authn.", "id": 129990, "time": "2009-08-27T09:12:17Z", "creator": "covener@gmail.com", "creation_time": "2009-08-27T09:12:17Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "bug_id": 42561, "attachment_id": 25999, "id": 139746, "time": "2010-09-07T14:30:24Z", "creator": "reg-jya-apache@hydrix.com", "creation_time": "2010-09-07T14:30:24Z", "is_private": false, "text": "Created attachment 25999\nPatch against 2.2\n\n; allowing the use of custom_attribute as uid during authz phase and more"}, {"count": 8, "tags": [], "creator": "reg-jya-apache@hydrix.com", "attachment_id": null, "is_private": false, "id": 139747, "time": "2010-09-07T14:40:49Z", "bug_id": 42561, "creation_time": "2010-09-07T14:40:49Z", "text": "Here is a version against 2.2 correcting some bugs and issues earlier mentioned.\n\nI also added two new directives:\n\n-AuthLDAPRemoteFirstUserAttribute: By default, when using a remote user attribute, if there is more than one attributes of the same kind, mod_authnz_ldap returns as string made of all the attributes separated by a \"; \".\nThis can have some unwanted effects, for example. Apple's MacOS 10.6 Open Directory stores users and user aliases in LDAP as:\ndn: uid=jeanyves_avenard,cn=users,dc=m,dc=hydrix,dc=com\nuid: jeanyves_avenard\nuid: jean-yves.avenard\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\nobjectClass: shadowAccount\nobjectClass: apple-user\nobjectClass: extensibleObject\nobjectClass: organizationalPerson\nobjectClass: top\nobjectClass: person\nremote_user attribute would therefore contain: \"jeanyves_avenard; jean-yves.avenard\" which is of no use.\nWhen AuthLDAPRemoteFirstUserAttribute is set, then only the first attribute will be returned.\n\n-AuthzLDAPRemoteUserAttribute: By default, the custom user attribute is only use for authentication. When AuthzLDAPRemoteUserAttribute is set, it will also be be used during authorisation.\n\nCheers\nJean-Yves\nHydrix"}, {"count": 9, "tags": [], "bug_id": 42561, "text": "Created attachment 26056\nPatch against 2.2\n\nUpdate patch so AuthLDAPRemoteFirstUserAttribute is also used during authorization phase (useful when used in combination of mod_auth_kerb)", "id": 139976, "time": "2010-09-20T09:37:30Z", "creator": "reg-jya-apache@hydrix.com", "creation_time": "2010-09-20T09:37:30Z", "is_private": false, "attachment_id": 26056}]