[{"count": 0, "tags": [], "bug_id": 25935, "text": "The TelnetTask class does not close it's connections which leads to exhaustion\nof telnet sessions on some Telnet servers, such as the Microsoft Windows 2000\nTelnet Server (which is limited to two concurrent sessions).\n\nTo reproduce, execute the following build.xml against a Windows 2000 Telnet server:\n\n<?xml version=\"1.0\"?>\n<project name=\"telnet test\" default=\"default\">\n  <property name=\"server\" value=\"server\"/>\n  <property name=\"prompt\" value=\"C:\\&gt;\"/>\n  <property name=\"command\" value=\"dir\"/>\n  <target name=\"default\">\n    <telnet server=\"${server}\" \n            userid=\"userid\" \n            password=\"password\" \n            timeout=\"30\">\n      <read string=\"${prompt}\"/>\n      <write string=\"${command}\"/>\n      <read string=\"${prompt}\"/>\n    </telnet>\n    <sleep seconds=\"1\"/>\n  </target>\n  <target name=\"test\">\n    <antcall target=\"default\"/>\n    <antcall target=\"default\"/>\n    <antcall target=\"default\"/>\n    <antcall target=\"default\"/>\n  </target>\n</project>\n\nAnt will simply hang on the third invocation of the <telnet> task.  The\nstill-connected sessions can also be viewed on the telnet server machine using\nthe Telnet Admin program.\n\nI've created a patch against the latest from CVS which ensures that Telnet\nconnections are closed:\n\nIndex: TelnetTask.java\n===================================================================\nRCS file:\n/home/cvspublic/ant/src/main/org/apache/tools/ant/taskdefs/optional/net/TelnetTask.java,v\nretrieving revision 1.21\ndiff -u -r1.21 TelnetTask.java\n--- TelnetTask.java\t23 Oct 2003 09:06:43 -0000\t1.21\n+++ TelnetTask.java\t6 Jan 2004 21:36:17 -0000\n@@ -135,24 +135,37 @@\n        }\n \n        /**  Create the telnet client object */\n-       telnet = new AntTelnetClient();\n        try {\n-           telnet.connect(server, port);\n-       } catch (IOException e) {\n-           throw new BuildException(\"Can't connect to \" + server);\n-       }\n-       /**  Login if userid and password were specified */\n-       if (userid != null && password != null) {\n-          login();\n+           telnet = new AntTelnetClient();\n+           try {\n+               telnet.connect(server, port);\n+           } catch (IOException e) {\n+               throw new BuildException(\"Can't connect to \" + server);\n+           }\n+           /**  Login if userid and password were specified */\n+           if (userid != null && password != null) {\n+              login();\n+           }\n+           /**  Process each sub command */\n+           Enumeration tasksToRun = telnetTasks.elements();\n+           while (tasksToRun != null && tasksToRun.hasMoreElements()) {\n+               TelnetSubTask task = (TelnetSubTask) tasksToRun.nextElement();\n+               if (task instanceof TelnetRead && defaultTimeout != null) {\n+                   ((TelnetRead) task).setDefaultTimeout(defaultTimeout);\n+               }\n+               task.execute(telnet);\n+           }\n        }\n-       /**  Process each sub command */\n-       Enumeration tasksToRun = telnetTasks.elements();\n-       while (tasksToRun != null && tasksToRun.hasMoreElements()) {\n-           TelnetSubTask task = (TelnetSubTask) tasksToRun.nextElement();\n-           if (task instanceof TelnetRead && defaultTimeout != null) {\n-               ((TelnetRead) task).setDefaultTimeout(defaultTimeout);\n+       finally {\n+           /**  Close connection for Telnet servers with connection limits */\n+           if (telnet != null) {\n+               try {\n+                   telnet.disconnect();\n+               } catch (IOException e) {\n+                   throw new BuildException(\"Error disconnecting from \" + server);\n+               }\n+               telnet = null;\n            }\n-           task.execute(telnet);\n        }\n     }", "id": 50151, "time": "2004-01-06T22:03:55Z", "creator": "carcher@drillinginfo.com", "creation_time": "2004-01-06T22:03:55Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "text": "After applying the patch contained in the original bug report, I have\nencountered additional bugs (in the jakarta-commons-net component) when using\nthe <telnet> task to telnet from Linux to Windows 2000 Telnet Server.  Working\non submitting a patch for commons-net now.\n\nFor more information see:\nhttp://issues.apache.org/bugzilla/show_bug.cgi?id=26296", "is_private": false, "bug_id": 25935, "id": 50842, "time": "2004-01-20T21:33:17Z", "creator": "carcher@drillinginfo.com", "creation_time": "2004-01-20T21:33:17Z", "attachment_id": null}, {"count": 2, "tags": [], "text": "Patch applied, will go into Ant 1.6.2.\n\nI need your \"real name\" if you want to get listed as a CONTRIBUTOR.", "attachment_id": null, "bug_id": 25935, "id": 59761, "time": "2004-06-23T12:27:44Z", "creator": "bodewig@apache.org", "creation_time": "2004-06-23T12:27:44Z", "is_private": false}, {"count": 3, "tags": [], "creator": "bodewig@apache.org", "attachment_id": null, "is_private": false, "id": 64428, "time": "2004-09-30T14:43:32Z", "bug_id": 25935, "creation_time": "2004-09-30T14:43:32Z", "text": "*** Bug 31488 has been marked as a duplicate of this bug. ***"}]