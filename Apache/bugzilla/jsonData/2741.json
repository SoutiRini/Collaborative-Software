[{"count": 0, "tags": [], "bug_id": 2741, "attachment_id": null, "id": 3922, "time": "2001-07-23T07:39:06Z", "creator": "rrossi@mobshop.com", "creation_time": "2001-07-23T07:39:06Z", "is_private": false, "text": "This problem was discovered when we integrated Jive with our own product.  Both\nJive and our product are running in separate contexts served by one instance of\nTomcat 3.2.1.  The problem only occurs when we run tomcat on ports 80 and 443. \nIf we run on 8080 and 8443, the problem does not occur.\n\nAfter a user logs into our product, they are eventually presented with a link to\n\"https://thehost.com:443/jive/skins/admin/index.jsp\".\n\nThis URL detects that the user is not currently logged into Jive and is supposed\nto redirect to \"https://thehost.com:443/jive/skins/admin/login.jsp\" via JSP\ncode:\n\n    response.sendRedirect( \"login.jsp\" )\n\nHowever, the server mistakenly redirects to\n\"https://thehost.com:80/jive/admin/login.jsp\" causing the browser to hang (wrong\nprotocol/port match)\n\nWe searched the Tomcat source and came accross the following function in\norg/apache/tomcat/service/http/HttpRequestAdaptor.java:\n\npublic int getServerPort() {\n    if(serverPort == -1) {\n        //XXX Which is the default in case we can not get the port\n        //from the request??\n        serverPort=socket.getLocalPort();\n        String hostHeader = this.getHeader(\"host\");\n        if (hostHeader != null) {\n            int i = hostHeader.indexOf(':');\n            if (i > -1) {\n                hostHeader = hostHeader.substring(i+1);\n                try{\n                    serverPort=Integer.parseInt(hostHeader);\n                }catch(NumberFormatException pex){\n                }\n            }else serverPort=80;\n        }\n    }\n    return serverPort;\n}\n\nI changed the } else serverPort=80 to:\n\n   else\n   {\n       if (this.isSecure())\n          serverPort = 443;\n       else\n          serverPort = 80;\n   }\n\nThis fixed the problem.  It looks like Tomcat was not able to determine the\ncorrect port number for the redirection and defaulted to port 80.  This won't\nwork if the request was made from a secure port.\n\nThis problem did not occur if the user did not log into our product first.  That\nis, if we start Tomcat and point the browser directly to the jive admin URL, the\nredirection works.  Once the user logs into our product, the jive admin URL will\nnever work. (We would have to restart the tomcat server.)"}, {"count": 1, "tags": [], "bug_id": 2741, "attachment_id": null, "id": 4791, "time": "2001-08-24T14:00:01Z", "creator": "cmanolache@yahoo.com", "creation_time": "2001-08-24T14:00:01Z", "is_private": false, "text": "Fixed in 3.3, we don't override the serverPort unless explicitely \nincluded in the host header. ( the bug was that we overrote what we \ngot from LocalPort)"}]