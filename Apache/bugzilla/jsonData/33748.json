[{"count": 0, "tags": [], "bug_id": 33748, "attachment_id": null, "text": "Red Hat Linux release 8.0 (Psyche)\nServer version: Apache/2.0.47\nServer built:   Nov  9 2003 23:40:33\n\nUsing piped logs (rotatelogs), we're experiencing random \"crashes\".  The httpd\nprocesses never crash/die, but the parent becomes defunct and the max number of\nworkers are spawned.  Upon launching an lsof on one of the workers, I found it\nhad spawned pipes until max fd was reached (1024).  This was the case for each\nworker and added up to over 144,000 FIFO pipes with the same sequence/ID. \nPasted below is the lsof output on just one of the workers.  As you can see,\neach fd to the pipe is trying to write, I'm assuming it's trying to write to the\nnow-defunct parent.  If we change the config back to standard logfiles the\nproblem goes away, but we reach the 2gb filesize limit within 5 days, 2 days\nbefore the system log roller kicks off and end up losing 2 day's worth of data.\n\nhttpd     25484      root  cwd    DIR        8,3     4096        2 /\nhttpd     25484      root  rtd    DIR        8,3     4096        2 /\nhttpd     25484      root  txt    REG        8,3   389574    27336 /usr/sbin/httpd\nhttpd     25484      root  mem    REG        8,3    90168    45787 /lib/ld-2.3.2.so\nhttpd     25484      root  mem    REG        8,3    52908    26835\n/usr/lib/httpd/modules/mod_access.so\nhttpd     25484      root  mem    REG        8,3    60702    26891\n/usr/lib/libz.so.1.1.4\nhttpd     25484      root  mem    REG        8,3   194416    45692\n/lib/libssl.so.0.9.6b\nhttpd     25484      root  mem    REG        8,3   853424    45691\n/lib/libcrypto.so.0.9.6b\nhttpd     25484      root  mem    REG        8,3    43360    45148\n/lib/libpcre.so.0.0.1\nhttpd     25484      root  mem    REG        8,3    10112    23215\n/usr/lib/libpcreposix.so.0.0.0\nhttpd     25484      root  mem    REG        8,3   781725    27118\n/usr/lib/libaprutil-0.so.0.9.4\nhttpd     25484      root  mem    REG        8,3   201987    27126\n/usr/lib/libldap.so.2.0.17\nhttpd     25484      root  mem    REG        8,3    48163    26821\n/usr/lib/liblber.so.2.0.17\nhttpd     25484      root  mem    REG        8,3    30040    23192\n/usr/lib/libgdbm.so.2.0.0\nhttpd     25484      root  mem    REG        8,3   760175    45130 /lib/libdb-4.0.so\nhttpd     25484      root  mem    REG        8,3   162799    23190\n/usr/lib/libexpat.so.0.3.0\nhttpd     25484      root  mem    REG        8,3  1441743    27114\n/usr/lib/libapr-0.so.0.9.4\nhttpd     25484      root  mem    REG        8,3    32187    45806\n/lib/librt-2.3.2.so\nhttpd     25484      root  mem    REG        8,3   171281    45094\n/lib/i686/libm-2.3.2.so\nhttpd     25484      root  mem    REG        8,3    24729    45791\n/lib/libcrypt-2.3.2.so\nhttpd     25484      root  mem    REG        8,3    90721    45794\n/lib/libnsl-2.3.2.so\nhttpd     25484      root  mem    REG        8,3    12842    45792\n/lib/libdl-2.3.2.so\nhttpd     25484      root  mem    REG        8,3    88042    45089\n/lib/i686/libpthread-0.10.so\nhttpd     25484      root  mem    REG        8,3    53842    26819\n/usr/lib/libsasl.so.7.1.11\nhttpd     25484      root  mem    REG        8,3    37852    45740\n/lib/libpam.so.0.75\nhttpd     25484      root  mem    REG        8,3    73640    45805\n/lib/libresolv-2.3.2.so\nhttpd     25484      root  mem    REG        8,3   107787    26865\n/usr/lib/httpd/modules/mod_log_config.so\nhttpd     25484      root  mem    REG        8,3    49644    26855\n/usr/lib/httpd/modules/mod_env.so\nhttpd     25484      root  mem    REG        8,3    79046    26856\n/usr/lib/httpd/modules/mod_expires.so\nhttpd     25484      root  mem    REG        8,3    69221    26852\n/usr/lib/httpd/modules/mod_deflate.so\nhttpd     25484      root  mem    REG        8,3    59833    26858\n/usr/lib/httpd/modules/mod_headers.so\nhttpd     25484      root  mem    REG        8,3    59673    26875\n/usr/lib/httpd/modules/mod_setenvif.so\nhttpd     25484      root  mem    REG        8,3    68011    26868\n/usr/lib/httpd/modules/mod_mime.so\nhttpd     25484      root  mem    REG        8,3   114271    26878\n/usr/lib/httpd/modules/mod_status.so\nhttpd     25484      root  mem    REG        8,3    91805    26861\n/usr/lib/httpd/modules/mod_info.so\nhttpd     25484      root  mem    REG        8,3    55621    26853\n/usr/lib/httpd/modules/mod_dir.so\nhttpd     25484      root  mem    REG        8,3    67308    26859\n/usr/lib/httpd/modules/mod_imap.so\nhttpd     25484      root  mem    REG        8,3    58788    26839\n/usr/lib/httpd/modules/mod_alias.so\nhttpd     25484      root  mem    REG        8,3  1611965    26863\n/usr/lib/httpd/modules/mod_jk2.so\nhttpd     25484      root  mem    REG        8,3  1457833    26877\n/usr/lib/httpd/modules/mod_ssl.so\nhttpd     25484      root  mem    REG        8,3    49929    45801\n/lib/libnss_files-2.3.2.so\nhttpd     25484      root  mem    DEL        0,4           2228225 /SYSV01030017\nhttpd     25484      root  mem    CHR        1,5             18502 /dev/zero\nhttpd     25484      root  mem    CHR        1,5             18502 /dev/zero\nhttpd     25484      root  mem    REG        8,3  1452984    45093\n/lib/i686/libc-2.3.2.so\nhttpd     25484      root    0r   CHR        1,3                16 /dev/null\nhttpd     25484      root    1w   CHR        1,3                16 /dev/null\nhttpd     25484      root    2w   CHR        1,3                16 /dev/null\nhttpd     25484      root    3u  IPv4   29866605               TCP *:http (LISTEN)\nhttpd     25484      root    4u  IPv4   29866606               TCP *:https (LISTEN)\nhttpd     25484      root    5r  FIFO        0,5          29866614 pipe\nhttpd     25484      root    6w  FIFO        0,5          29866614 pipe\nhttpd     25484      root    7u  unix 0xce0bb900          29866610 socket\nhttpd     25484      root    8u   REG        8,3     4608    18554\n/var/log/httpd/ssl_error_log\nhttpd     25484      root    9r  FIFO        0,5          29866615 pipe\nhttpd     25484      root   10w  FIFO        0,5          29866615 pipe\nhttpd     25484      root   11w   REG        8,3        0    18561\n/var/log/httpd/ssl_access_log\nhttpd     25484      root   12w  FIFO        0,5          29866615 pipe\nhttpd     25484      root   13w   REG        8,3        0    18569\n/var/log/httpd/ssl_request_log\nhttpd     25484      root   14u   REG        8,3        0    18570\n/var/log/httpd/jk2.log\nhttpd     25484      root   15w   REG        8,3        0    19564\n/var/log/httpd/ssl_mutex.25481 (deleted)\nhttpd     25484      root   17w  FIFO        0,5          29866615 pipe\nhttpd     25484      root   18w  FIFO        0,5          29866615 pipe\nhttpd     25484      root   19w  FIFO        0,5          29866615 pipe\nhttpd     25484      root   20w  FIFO        0,5          29866615 pipe\n[...1000 later...]\nhttpd     25484      root 1021w  FIFO        0,5          29866615 pipe\nhttpd     25484      root 1022w  FIFO        0,5          29866615 pipe\nhttpd     25484      root 1023w  FIFO        0,5          29866615 pipe", "id": 71555, "time": "2005-02-26T00:54:18Z", "creator": "hogan.whittall@overture.com", "creation_time": "2005-02-26T00:54:18Z", "is_private": false}, {"text": "I have no comment on the pipe issue and rotatelogs, but if you upgrade to 2.0.53\nthen the 2GB log file issue will be resolved (if you have Apache write the log\nfiles directly instead of going through rotatelogs).", "tags": [], "bug_id": 33748, "attachment_id": null, "count": 1, "id": 71556, "time": "2005-02-26T00:58:02Z", "creator": "trawick@apache.org", "creation_time": "2005-02-26T00:58:02Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 33748, "attachment_id": null, "text": "Ah, this looks the same as the issues that just got fixed for 2.0.55.  This patch:\n\nhttp://people.apache.org/~jorton/ap_pipedlog2.diff\n\nfixes the fd leak in spawning piped loggers and hence avoids hitting the ulimit.\n There's an error handling bug in APR which leads to the parent segfault when\nhitting the ulimit.", "id": 78149, "time": "2005-08-05T14:38:17Z", "creator": "jorton@redhat.com", "creation_time": "2005-08-05T14:38:17Z", "is_private": false}]