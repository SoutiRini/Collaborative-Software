[{"count": 0, "tags": [], "creator": "jschneid@netilla.com", "text": "This has been kicking around the net for years, so I have a patch to fix it. \nThis patch needs to be applied in the modules/ssl directory, and it creates a\nnew configuration directive - \"SSLHonorCipherOrder\", which takes a boolean\nvalue.  If \"SSLHonorCipherOrder\" is true, the server prefers its own ordering\nfor cipher selection (as set by the \"SSLCipherSuite\" directive).  If it's set to\nfalse (or absent), the historical behavior of prefering the client cipher\nordering is used.  \n\nNote that the patch checks for the availability of the\nSSL_OP_CIPHER_SERVER_PREFERENCE define, so it's safe to use (but ignored) even\nif   you're using an ancient version of OpenSSL that doesn't support this.\n\nPatch follows:\n--<cut here>--\nIndex: modules/ssl/mod_ssl.c\n===================================================================\n--- modules/ssl/mod_ssl.c       2003/04/10 19:09:56     1.1.1.2\n+++ modules/ssl/mod_ssl.c       2004/04/28 15:57:20\n@@ -167,6 +167,10 @@\n     SSL_CMD_SRV(Protocol, RAW_ARGS,\n                 \"Enable or disable various SSL protocols\"\n                 \"(`[+-][SSLv2|SSLv3|TLSv1] ...' - see manual)\")\n+    SSL_CMD_SRV(HonorCipherOrder, FLAG,\n+                \"Use the server's cipher ordering preference\")\n\n     /*\n      * Proxy configuration for remote SSL connections\nIndex: modules/ssl/mod_ssl.h\n===================================================================\n--- modules/ssl/mod_ssl.h       2003/06/05 20:51:17     1.1.1.3\n+++ modules/ssl/mod_ssl.h       2004/04/28 15:57:21\n@@ -514,6 +514,9 @@\n     SSLModConfigRec *mc;\n     BOOL             enabled;\n     BOOL             proxy_enabled;\n+#ifdef SSL_OP_CIPHER_SERVER_PREFERENCE\n+    BOOL             bHonorCipherOrder;\n+#endif\n     const char      *vhost_id;\n     int              vhost_id_len;\n     int              session_cache_timeout;\n@@ -574,6 +577,9 @@\n const char  *ssl_cmd_SSLVerifyDepth(cmd_parms *, void *, const char *);\n const char  *ssl_cmd_SSLSessionCache(cmd_parms *, void *, const char *);\n const char  *ssl_cmd_SSLSessionCacheTimeout(cmd_parms *, void *, const char *);\n+const char  *ssl_cmd_SSLHonorCipherOrder(cmd_parms *, void *, int);\n const char  *ssl_cmd_SSLProtocol(cmd_parms *, void *, const char *);\n const char  *ssl_cmd_SSLOptions(cmd_parms *, void *, const char *);\n const char  *ssl_cmd_SSLRequireSSL(cmd_parms *, void *);\nIndex: modules/ssl/ssl_engine_config.c\n===================================================================\n--- modules/ssl/ssl_engine_config.c     2003/04/10 19:09:56     1.1.1.2\n+++ modules/ssl/ssl_engine_config.c     2004/04/28 15:57:21\n@@ -212,7 +212,9 @@\n     sc->vhost_id               = NULL;  /* set during module init */\n     sc->vhost_id_len           = 0;     /* set during module init */\n     sc->session_cache_timeout  = UNSET;\n-\n+#ifdef SSL_OP_CIPHER_SERVER_PREFERENCE\n+    sc->bHonorCipherOrder      = UNSET;\n+#endif\n     modssl_ctx_init_proxy(sc, p);\n\n     modssl_ctx_init_server(sc, p);\n@@ -296,6 +298,9 @@\n     cfgMergeBool(enabled);\n     cfgMergeBool(proxy_enabled);\n     cfgMergeInt(session_cache_timeout);\n+#ifdef SSL_OP_CIPHER_SERVER_PREFERENCE\n+    cfgMergeBool(bHonorCipherOrder);\n+#endif\n\n     modssl_ctx_cfg_merge_proxy(base->proxy, add->proxy, mrg->proxy);\n\n@@ -662,6 +667,18 @@\n\n     return NULL;\n }\n+\n+const char *ssl_cmd_SSLHonorCipherOrder(cmd_parms *cmd, void *dcfg, int flag)\n+{\n+#ifdef SSL_OP_CIPHER_SERVER_PREFERENCE\n+    SSLSrvConfigRec *sc = mySrvConfig(cmd->server);\n+    ap_log_error(APLOG_MARK, APLOG_DEBUG, 0, cmd->server,\n+        \"ssl_cmd_SSLHonorCipherOrder: Setting bHonorCipherOrder to %s\",\n+       flag?\"TRUE\":\"FALSE\");\n+    sc->bHonorCipherOrder = flag?TRUE:FALSE;\n+#endif\n+    return NULL;\n+}\n\n const char *ssl_cmd_SSLCipherSuite(cmd_parms *cmd,\n                                    void *dcfg,\nIndex: modules/ssl/ssl_engine_init.c\n===================================================================\n--- modules/ssl/ssl_engine_init.c       2003/06/05 20:51:17     1.1.1.3\n+++ modules/ssl/ssl_engine_init.c       2004/04/28 15:57:21\n@@ -416,6 +416,9 @@\n     SSL_METHOD *method = NULL;\n     char *cp;\n     int protocol = mctx->protocol;\n+#ifdef SSL_OP_CIPHER_SERVER_PREFERENCE\n+    SSLSrvConfigRec *sc = mySrvConfig(s);\n+#endif\n\n     /*\n      *  Create the new per-server SSL context\n@@ -464,6 +467,11 @@\n     if (!(protocol & SSL_PROTOCOL_TLSV1)) {\n         SSL_CTX_set_options(ctx, SSL_OP_NO_TLSv1);\n     }\n+#ifdef SSL_OP_CIPHER_SERVER_PREFERENCE\n+    if(TRUE == sc->bHonorCipherOrder) {\n+        SSL_CTX_set_options(ctx, SSL_OP_CIPHER_SERVER_PREFERENCE);\n+    }\n+#endif\n\n     SSL_CTX_set_app_data(ctx, s);\n--<cut here>--", "id": 56562, "time": "2004-04-28T16:17:32Z", "bug_id": 28665, "creation_time": "2004-04-28T16:17:32Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "id": 58633, "time": "2004-06-03T13:07:00Z", "bug_id": 28665, "creation_time": "2004-06-03T13:07:00Z", "is_private": false, "text": "Thanks for the patch, Jim.  Committed to HEAD with a few minor tweaks."}]