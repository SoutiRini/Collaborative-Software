[{"count": 0, "tags": [], "creator": "matthias.keller@ergon.ch", "attachment_id": null, "text": "Sometimes (about every third try) we get a NullPointerException within the connector when trying to write an empty, expired Cookie under Tomcat 8.5.13 and 8.5.16. This problem doesn't occur on Tomcat 7.0.77.\n\nThe stacktrace (from 8.5.13) is as follows:\n\norg.apache.catalina.connector.Response.generateCookieString(Response.java:999)\norg.apache.catalina.connector.Response.addCookie(Response.java:947)\norg.apache.catalina.connector.ResponseFacade.addCookie(ResponseFacade.java:386)\njavax.servlet.http.HttpServletResponseWrapper.addCookie(HttpServletResponseWrapper.java:58)\njavax.servlet.http.HttpServletResponseWrapper.addCookie(HttpServletResponseWrapper.java:58)\njavax.servlet.http.HttpServletResponseWrapper.addCookie(HttpServletResponseWrapper.java:58)\n\nThe code leading to it is:\n\nCookie c = new Cookie(cookieName, \"\");\nc.setMaxAge(0);\ncookie.setPath(contextPath);\nresponse.addCookie(cookie);\n\nWe use the LegacyCookieProcessor via tomcat's context.xml:\n<CookieProcessor className=\"org.apache.tomcat.util.http.LegacyCookieProcessor\" />", "id": 199754, "time": "2017-07-13T07:06:24Z", "bug_id": 61289, "creation_time": "2017-07-13T07:06:24Z", "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 61289, "is_private": false, "id": 199760, "time": "2017-07-13T11:55:53Z", "creator": "matthias.keller@ergon.ch", "creation_time": "2017-07-13T11:55:53Z", "tags": [], "text": "Here's the stacktrace of this problem from 8.5.16:\n\norg.apache.catalina.connector.Response.generateCookieString(Response.java:1019)\norg.apache.catalina.connector.Response.addCookie(Response.java:967)\norg.apache.catalina.connector.ResponseFacade.addCookie(ResponseFacade.java:386)\njavax.servlet.http.HttpServletResponseWrapper.addCookie(HttpServletResponseWrapper.java:58)\njavax.servlet.http.HttpServletResponseWrapper.addCookie(HttpServletResponseWrapper.java:58)\njavax.servlet.http.HttpServletResponseWrapper.addCookie(HttpServletResponseWrapper.java:58)"}, {"count": 2, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 199841, "time": "2017-07-16T22:46:47Z", "bug_id": 61289, "creation_time": "2017-07-16T22:46:47Z", "is_private": false, "text": "It looks like the Context object is null which points to the application accessing the response object outside of the normal request/response processing cycle. This can happen when an application incorrectly retains a reference to a response object.\n\nThe users list is the place to follow up on this. If that discussion concludes that there is a Tomcat bug here, please feel free to re-open this issue and provide the simplest possible test case that demonstrates the problem on a clea install of the latest stable 8.5.x release."}, {"count": 3, "tags": [], "creator": "hugolee0515@gmail.com", "attachment_id": null, "text": "I got the same exception when I create a spring boot application, the version of tomcat is 8.5.16.\nI has debug it, and found that the getContext() method got a null, so the exception occured.\nMy english is pool,all of you can the exceprion detail, as follow:\njava.lang.NullPointerException: null\n\tat org.apache.catalina.connector.Response.generateCookieString(Response.java:1019) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.catalina.connector.Response.addCookie(Response.java:967) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.catalina.connector.ResponseFacade.addCookie(ResponseFacade.java:386) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat com.easyedm.common.utils.CookieUtil.addCookie(CookieUtil.java:37) ~[classes/:na]\n\tat com.easyedm.common.utils.CookieUtil.addCookie(CookieUtil.java:49) ~[classes/:na]\n\tat com.easyedm.admin.service.impl.AdminInfoServiceImpl.userLoginRecord(AdminInfoServiceImpl.java:63) ~[classes/:na]\n\tat com.easyedm.admin.service.impl.AdminInfoServiceImpl.login(AdminInfoServiceImpl.java:52) ~[classes/:na]\n\tat com.easyedm.admin.controller.AdminInfoController.adminLogin(AdminInfoController.java:59) ~[classes/:na]\n\tat com.easyedm.admin.controller.AdminInfoController$$FastClassBySpringCGLIB$$e2440cb5.invoke(<generated>) ~[classes/:na]\n\tat org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:204) ~[spring-core-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:738) ~[spring-aop-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:157) ~[spring-aop-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.aop.framework.adapter.MethodBeforeAdviceInterceptor.invoke(MethodBeforeAdviceInterceptor.java:52) ~[spring-aop-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:179) ~[spring-aop-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:92) ~[spring-aop-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:179) ~[spring-aop-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:673) ~[spring-aop-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat com.easyedm.admin.controller.AdminInfoController$$EnhancerBySpringCGLIB$$242ca14c.adminLogin(<generated>) ~[classes/:na]\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_91]\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_91]\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_91]\n\tat java.lang.reflect.Method.invoke(Method.java:498) ~[na:1.8.0_91]\n\tat org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:205) ~[spring-web-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:133) ~[spring-web-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:97) ~[spring-webmvc-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:827) ~[spring-webmvc-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:738) ~[spring-webmvc-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:85) ~[spring-webmvc-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:967) ~[spring-webmvc-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:901) ~[spring-webmvc-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:970) ~[spring-webmvc-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:872) ~[spring-webmvc-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:661) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:846) ~[spring-webmvc-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:742) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:231) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52) ~[tomcat-embed-websocket-8.5.16.jar:8.5.16]\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:99) ~[spring-web-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107) ~[spring-web-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.springframework.web.filter.HttpPutFormContentFilter.doFilterInternal(HttpPutFormContentFilter.java:105) ~[spring-web-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107) ~[spring-web-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.springframework.web.filter.HiddenHttpMethodFilter.doFilterInternal(HiddenHttpMethodFilter.java:81) ~[spring-web-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107) ~[spring-web-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:197) ~[spring-web-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107) ~[spring-web-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:198) ~[tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:96) [tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:478) [tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:140) [tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:80) [tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:87) [tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:342) [tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:799) [tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66) [tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:868) [tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1455) [tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49) [tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [na:1.8.0_91]\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_91]\n\tat org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61) [tomcat-embed-core-8.5.16.jar:8.5.16]\n\tat java.lang.Thread.run(Thread.java:745) [na:1.8.0_91]", "id": 200378, "time": "2017-08-19T09:05:46Z", "bug_id": 61289, "creation_time": "2017-08-19T09:05:46Z", "is_private": false}, {"count": 4, "tags": [], "text": "As Mark stated, the cause is almost always incorrect response object handling in the application, and that this should be pursued on the Tomcat Users' mailing list.  Bugzilla is not a support forum.", "attachment_id": null, "bug_id": 61289, "id": 200381, "time": "2017-08-19T14:06:23Z", "creator": "chuck.caldarale@unisys.com", "creation_time": "2017-08-19T14:06:23Z", "is_private": false}, {"count": 5, "tags": [], "creator": "matthias.keller@ergon.ch", "attachment_id": null, "text": "For anyone stumbiling upon this issue later on, set the following system property to make the cause much more visible. This led me to the correct suspect immediately:\n\norg.apache.catalina.connector.RECYCLE_FACADES=true", "id": 200389, "time": "2017-08-21T04:59:22Z", "bug_id": 61289, "creation_time": "2017-08-21T04:59:22Z", "is_private": false}]