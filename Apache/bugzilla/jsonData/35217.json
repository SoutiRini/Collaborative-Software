[{"count": 0, "attachment_id": null, "bug_id": 35217, "text": "Looks like a possible RFC 2616 MUST violation. \nmod_cache does not ignore extension Cache-control\ndirectives. For example, when a directive includes\nsomething that looks like a standard directive (but\nis not), mod_cache honors the (non-existent) standard\ndirective.\n\nSee attached trace(s) for details and ways to reproduce\nthe violation mentioned above. Note that the test cases\ncheck that a valid standard directive is honored first.\nThe extension directive is tested in \"step 2\".\n\nTest case IDs in the trace link to human-oriented test case\ndescription and RFC quotes, if available.", "id": 76008, "time": "2005-06-04T01:21:03Z", "creator": "coad@measurement-factory.com", "creation_time": "2005-06-04T01:21:03Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "creator": "coad@measurement-factory.com", "text": "Created attachment 15298\nmax-age in the extension name\n\nthis trace has max-age directive inside an\nblah=value extension directive", "id": 76009, "time": "2005-06-04T01:23:27Z", "bug_id": 35217, "creation_time": "2005-06-04T01:23:27Z", "is_private": false, "attachment_id": 15298}, {"count": 2, "tags": [], "creator": "coad@measurement-factory.com", "text": "Created attachment 15299\nmax-age in the extension value\n\nthis trace has max-age directive inside the value\nof the blah=value extension directive", "id": 76010, "time": "2005-06-04T01:27:36Z", "bug_id": 35217, "creation_time": "2005-06-04T01:27:36Z", "is_private": false, "attachment_id": 15299}, {"count": 3, "attachment_id": null, "bug_id": 35217, "text": "I believe this issue is still present in 2.3/trunk.", "id": 83289, "time": "2005-12-06T07:49:57Z", "creator": "chip@force-elite.com", "creation_time": "2005-12-06T07:49:57Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "creator": "rahul.g.nair@gmail.com", "is_private": false, "text": "Confirming this in trunk again.\n\nFirst request to cache the url .\n\n|echo \"GET http://webproxy.india.sun.com:8000/tst.txt HTTP/1.0\\r\\n\\r\\n\" | nc 0 8080                                 \nHTTP/1.1 200 OK\nDate: Tue, 26 Aug 2008 11:12:53 GMT\nServer: Sun-Java-System-Web-Proxy-Server/4.0.4\nContent-length: 5\nContent-type: text/plain\nLast-modified: Tue, 26 Aug 2008 11:12:33 GMT\nEtag: \"5-48b3e521\"\nAccept-ranges: bytes\nVia: 1.0 agneyam:8000\nConnection: close\n\nabcd\n\nThis request used the cached URL\n\n|echo \"GET http://webproxy.india.sun.com:8000/tst.txt HTTP/1.0\\r\\n\\r\\n\" | nc 0 8080\nHTTP/1.1 200 OK\nDate: Tue, 26 Aug 2008 11:12:53 GMT\nServer: Sun-Java-System-Web-Proxy-Server/4.0.4\nLast-Modified: Tue, 26 Aug 2008 11:12:17 GMT\nContent-length: 5\nEtag: \"5-48b3e521\"\nAccept-ranges: bytes\nVia: 1.0 agneyam:8000\nAge: 1\nConnection: close\nContent-Type: text/plain\n\nabcd\n\nThis one didn't (Note the quoted \"name\"=value )\n|echo \"GET http://webproxy.india.sun.com:8000/tst.txt HTTP/1.0\\r\\nCache-Control: \" max-age=0 \"=new\\r\\n\\r\\n\" | nc 0 8080\nHTTP/1.1 200 OK\nDate: Tue, 26 Aug 2008 11:13:02 GMT\nServer: Sun-Java-System-Web-Proxy-Server/4.0.4\nContent-length: 5\nEtag: \"5-48b3e521\"\nAccept-ranges: bytes\nVia: 1.0 agneyam:8000\nLast-Modified: Tue, 26 Aug 2008 11:12:24 GMT\nConnection: close\nContent-Type: text/plain\n\nabcd\n", "id": 120097, "time": "2008-08-26T04:26:32Z", "bug_id": 35217, "creation_time": "2008-08-26T04:26:32Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 35217, "is_private": false, "id": 120098, "attachment_id": null, "creator": "rahul.g.nair@gmail.com", "creation_time": "2008-08-26T04:42:35Z", "time": "2008-08-26T04:42:35Z", "text": "Accroding to 2616, A token is defined as\n\n  token          = 1*<any CHAR except CTLs or separators>\n       separators     = \"(\" | \")\" | \"<\" | \">\" | \"@\"\n                      | \",\" | \";\" | \":\" | \"\\\" | <\">\n                      | \"/\" | \"[\" | \"]\" | \"?\" | \"=\"\n                      | \"{\" | \"}\" | SP | HT\n\nNote that (\") is defined as a separator. So by definition a value such as \"xxxxx\" will be interpreted by stripping away the separators. Thus the value \" max-age=0 \"=blah is interpreted as [max-age=0] [=blah] where the second entry is invalid while the first entry is valid cache control directive. \n\nFor this reason, the behavior of apache is correct.\n\n\n"}, {"count": 6, "attachment_id": null, "bug_id": 35217, "text": "Comment #5 says:\n> Note that (\") is defined as a separator.\n\nI do not know whether the problem has been fixed since our original report, but please note that the request in Comment #4 does not have quotes. The quotes you see will be eaten by the shell. To Apache, the request looks more like this:\n\nGET http://webproxy.india.sun.com:8000/tst.txt HTTP/1.0\\r\\n\nCache-Control:  max-age=0 =new\\r\\n\n\\r\\n\n\nwhich contains a valid max-age directive followed by garbage.\n\nThe original test cases (see attachments) do not have this problem.\n\n> So by definition a value such as\n> \"xxxxx\" will be interpreted by stripping away the separators. Thus the value \"\n> max-age=0 \"=blah is interpreted as [max-age=0] [=blah] where the second entry\n> is invalid while the first entry is valid cache control directive. \n\nWhether quoted strings are not token-like opaque blobs but regular input (that apparently should be re-parsed and interpreted!) preceded and followed by a separator is highly debatable.\n\nIMO, the second original test case leaves little doubt that there was a bug here because it uses a quoted string in the value of the extension directive. That usage is a 100% valid extension, right? Again, I do not know whether this has been fixed since.\n\nHTH.\n", "id": 120110, "time": "2008-08-26T09:46:53Z", "creator": "coad@measurement-factory.com", "creation_time": "2008-08-26T09:46:53Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "bug_id": 35217, "attachment_id": null, "text": "|I do not know whether the problem has been fixed since our original report, but\n|please note that the request in Comment #4 does not have quotes. The quotes you\n|see will be eaten by the shell. To Apache, the request looks more like this:\n\nyou are right, my testcases were wrong,\nbut my conclusion did not have anything to do with them.\n\n> > So by definition a value such as\n> > \"xxxxx\" will be interpreted by stripping away the separators. Thus the value \"\n> > max-age=0 \"=blah is interpreted as [max-age=0] [=blah] where the second entry\n> > is invalid while the first entry is valid cache control directive. \n> \n> Whether quoted strings are not token-like opaque blobs but regular input (that\n> apparently should be re-parsed and interpreted!) preceded and followed by a\n> separator is highly debatable.\n\nNot according to rfc 2616. RFC 2616 states quite clearly that cache-extension\nshould be either token or token=(token|quoted-string)\n\nCache-Control   = \"Cache-Control\" \":\" 1#cache-directive\n    cache-directive = cache-request-directive\n         | cache-response-directive\n    cache-request-directive =\n           \"no-cache\"                          ; Section 14.9.1\n         | \"no-store\"                          ; Section 14.9.2\n         | \"max-age\" \"=\" delta-seconds         ; Section 14.9.3, 14.9.4\n         | \"max-stale\" [ \"=\" delta-seconds ]   ; Section 14.9.3\n         | \"min-fresh\" \"=\" delta-seconds       ; Section 14.9.3\n         | \"no-transform\"                      ; Section 14.9.5\n         | \"only-if-cached\"                    ; Section 14.9.4\n         | cache-extension                     ; Section 14.9.6\n\ncache-extension = token [ \"=\" ( token | quoted-string ) ]\n\n(Note that a quoted string is allowed after the '=' not before.)\n\n> IMO, the second original test case leaves little doubt that there was a bug\n> here because it uses a quoted string in the value of the extension directive.\n> That usage is a 100% valid extension, right? Again, I do not know whether this\n> has been fixed since.\n\nSo with the above definition of token, what is below is not valid, \n\nCache-Control: public, \" max-age=8,max-age=8 \"=blah\\r\\n\n\nwhile this would be\nCache-Control: public, blah=\" max-age=8,max-age=8 \"\\r\\n\n\n", "id": 120111, "time": "2008-08-26T10:17:53Z", "creator": "rahul.g.nair@gmail.com", "creation_time": "2008-08-26T10:17:53Z", "is_private": false}, {"count": 8, "tags": [], "creator": "coad@measurement-factory.com", "is_private": false, "text": "> So with the above definition of token, what is below is not valid, \n>   Cache-Control: public, \" max-age=8,max-age=8 \"=blah\\r\\n\n> while this would be\n>   Cache-Control: public, blah=\" max-age=8,max-age=8 \"\\r\\n\n\nIn addition, none of the above HTTP headers contains the \"max-age\" Cache-Control directive, IMO.\n", "id": 120112, "time": "2008-08-26T10:32:04Z", "bug_id": 35217, "creation_time": "2008-08-26T10:32:04Z", "attachment_id": null}, {"count": 9, "tags": [], "creator": "rahul.g.nair@gmail.com", "is_private": false, "text": "| In addition, none of the above HTTP headers contains the \"max-age\"\n| Cache-Control directive, IMO.\n\nYour original bug was that the entry that you posted (Cache-control: \"xxxx\"=blah) was a valid extension directive. But as per the RFC, it is not. The question now, is as to what the httpd should do when faced with an invalid entry.\n\nThat question is open to further deliberation. IMO that is fair game for httpd to do as it pleases.\n", "id": 120113, "time": "2008-08-26T10:46:18Z", "bug_id": 35217, "creation_time": "2008-08-26T10:46:18Z", "attachment_id": null}, {"count": 10, "tags": [], "creator": "coad@measurement-factory.com", "is_private": false, "text": "> Your original bug was that the entry that you posted (Cache-control:\n> \"xxxx\"=blah) was a valid extension directive. \n\nNot exactly. There were two test cases in the original bug report. The first case is using the questionable quoted string as the directive name. The second test case does not. I do not recall claiming that both directives are perfectly valid -- I know that one of them is of questionable validity, but that is not the issue in this bug report.\n\n> But as per the RFC, it is not.\n> The question now, is as to what the httpd should do when faced with an invalid\n> entry.\n\nThat question is possible for the first test case but not for the second.\n\nAnd even for the first test case, I would not be surprised if httpd actually ignores directives it considers invalid. If that is correct, that the first test case is still good as it illustrates that httpd is not interpreting the invalid directive as invalid.\n", "id": 120114, "time": "2008-08-26T11:05:45Z", "bug_id": 35217, "creation_time": "2008-08-26T11:05:45Z", "attachment_id": null}, {"count": 11, "attachment_id": null, "bug_id": 35217, "is_private": false, "id": 120115, "time": "2008-08-26T11:19:26Z", "creator": "rahul.g.nair@gmail.com", "creation_time": "2008-08-26T11:19:26Z", "tags": [], "text": "(In reply to comment #10)\n> > Your original bug was that the entry that you posted (Cache-control:\n> > \"xxxx\"=blah) was a valid extension directive. \n> \n> Not exactly. There were two test cases in the original bug report. The first\n> case is using the questionable quoted string as the directive name. The second\n> test case does not. I do not recall claiming that both directives are perfectly\n> valid -- I know that one of them is of questionable validity, but that is not\n> the issue in this bug report.\n\nNow, I am confused, could you please specify the request(s), current response\nand expected response? (The html is long, and I don't think I am looking at the same lines as you are.)\n\n(And can I request you to quote it in text format? html is rather hard quote\n again in threads.)\n\n> > But as per the RFC, it is not.\n> > The question now, is as to what the httpd should do when faced with an invalid\n> > entry.\n> \n> That question is possible for the first test case but not for the second.\n> \n> And even for the first test case, I would not be surprised if httpd actually\n> ignores directives it considers invalid. If that is correct, that the first\n> test case is still good as it illustrates that httpd is not interpreting the\n> invalid directive as invalid.\n \n\n"}, {"count": 12, "tags": [], "creator": "coad@measurement-factory.com", "text": "Created attachment 22484\nmax-age in the extension name (plain)\n\nSaved 1st test case attachment as text per rahul request", "id": 120116, "time": "2008-08-26T11:54:51Z", "bug_id": 35217, "creation_time": "2008-08-26T11:54:51Z", "is_private": false, "attachment_id": 22484}, {"count": 13, "attachment_id": 22485, "bug_id": 35217, "is_private": false, "id": 120117, "time": "2008-08-26T11:58:50Z", "creator": "coad@measurement-factory.com", "creation_time": "2008-08-26T11:58:50Z", "tags": [], "text": "Created attachment 22485\nmax-age in the extension value (plain)\n\nSaved test case attachment as text per rahul request. This test case uses the following valid Cache-Control header:\n\n  Cache-Control: public, foobar=\" max-age=8,max-age=8 \"\\r\\n\n\nAgain, I do not know whether this bug has been fixed since it was reported.\n\nHTH."}, {"count": 14, "tags": [], "bug_id": 35217, "is_private": false, "id": 120118, "attachment_id": null, "creator": "coad@measurement-factory.com", "creation_time": "2008-08-26T12:08:33Z", "time": "2008-08-26T12:08:33Z", "text": "(In reply to comment #11)\n> Now, I am confused, could you please specify the request(s), current response\n> and expected response? (The html is long, and I don't think I am looking at the\n> same lines as you are.)\n> \n> (And can I request you to quote it in text format? html is rather hard quote\n>  again in threads.)\n\nAttached test case logs have all the exchanges with the proxy server. I have re-saved them in text format per your request, but they are easier to read if you use your browser to display the HTML attachment instead (you may have to save the HTML attachment as HTML for that to work).\n\nThe violation is (was?) not in sending a wrong response to a single request but in purging a cached document in reaction to an extension cache-control directive. You have to follow the trace to see that. FWIW, some folks find it easier to read the trace backwards, from the violation to the first request.\n\nHTH.\n"}, {"count": 15, "tags": [], "creator": "rahul.g.nair@gmail.com", "text": "> Created an attachment (id=22485) [details]\n> max-age in the extension value (plain)\n> Saved test case attachment as text per rahul request. This test case uses the\n> following valid Cache-Control header:\n> \n>   Cache-Control: public, foobar=\" max-age=8,max-age=8 \"\\r\\n\n\nThanks a lot, it is much easier now, and I understand where we were not on the\nsame page.\n\n> Again, I do not know whether this bug has been fixed since it was reported.\n\nLet me know if this is not what you are referring to.\n------------------------------------------------------\nFirst a simple request with out directives to make it cache.\n\n|echo \"GET http://webproxy.india.sun.com:8000/tst.txt HTTP/1.0\\r\\n\\r\\n\" | nc 0 8080\nHTTP/1.1 200 OK\nDate: Tue, 26 Aug 2008 18:52:36 GMT\nServer: Sun-Java-System-Web-Proxy-Server/4.0.4\nLast-Modified: Tue, 26 Aug 2008 11:12:33 GMT\nContent-length: 5\nEtag: \"5-48b3e521\"\nAccept-ranges: bytes\nVia: 1.0 agneyam:8000\nAge: 30\nConnection: close\nContent-Type: text/plain\n\nabcd\n\nas snooped in the backend.\n--> [\nGET /tst.txt HTTP/1.1\nHost: webproxy.india.sun.com:8000\nCache-Control: \"max-age=0\"=me\nVia: 1.0 agneyam:8000\nConnection: Keep-Alive\n\n]\n------------------------------------------------------\n\nNow trying with a vaild cache-control max-age (valid behavior).\n\n|echo \"GET http://webproxy.india.sun.com:8000/tst.txt HTTP/1.0\\r\\nCache-Control: max-age=0\\r\\n\\r\\n\" | nc 0 8080 \nHTTP/1.1 200 OK\nDate: Tue, 26 Aug 2008 18:53:43 GMT\nServer: Sun-Java-System-Web-Proxy-Server/4.0.4\nContent-length: 5\nEtag: \"5-48b3e521\"\nAccept-ranges: bytes\nVia: 1.0 agneyam:8000\nLast-Modified: Tue, 26 Aug 2008 11:12:33 GMT\nConnection: close\nContent-Type: text/plain\n\nabcd\n\n\n--> [\nGET /tst.txt HTTP/1.1\nHost: webproxy.india.sun.com:8000\nCache-Control: max-age=0\nIf-None-Match: \"5-48b3e521\"\nIf-Modified-Since: Tue, 26 Aug 2008 11:12:33 GMT\nVia: 1.0 agneyam:8000\nConnection: Keep-Alive\n\n]\n<-- [\nHTTP/1.1 304 Use local copy\nServer: Sun-Java-System-Web-Proxy-Server/4.0.4\nDate: Tue, 26 Aug 2008 18:53:43 GMT\nEtag: \"5-48b3e521\"\n\n]\n\n------------------------------------------------------\nNow trying an invalid cache-control directive,\n\n|echo \"GET http://webproxy.india.sun.com:8000/tst.txt HTTP/1.0\\r\\nCache-Control: \\\"max-age=0\\\"\\r\\n\\r\\n\" | nc 0 8080\nHTTP/1.1 200 OK\nDate: Tue, 26 Aug 2008 18:53:43 GMT\nServer: Sun-Java-System-Web-Proxy-Server/4.0.4\nLast-Modified: Tue, 26 Aug 2008 11:12:33 GMT\nContent-length: 5\nEtag: \"5-48b3e521\"\nAccept-ranges: bytes\nVia: 1.0 agneyam:8000\nAge: 2\nConnection: close\nContent-Type: text/plain\n\nabcd\n\n--> No request to the back end observed.\n\n------------------------------------------------------\nNow trying an second invalid cache-control directive,\n\n|echo \"GET http://webproxy.india.sun.com:8000/tst.txt HTTP/1.0\\r\\nCache-Control: \\\" max-age=0 \\\"=foobar \\r\\n\\r\\n\" | nc 0 8080\nHTTP/1.1 200 OK\nDate: Tue, 26 Aug 2008 18:58:18 GMT\nServer: Sun-Java-System-Web-Proxy-Server/4.0.4\nLast-Modified: Tue, 26 Aug 2008 11:12:33 GMT\nContent-length: 5\nEtag: \"5-48b3e521\"\nAccept-ranges: bytes\nVia: 1.0 agneyam:8000\nAge: 115\nConnection: close\nContent-Type: text/plain\n\nabcd\n\n--> No request to the back end observed.\n\n------------------------------------------------------\nTrying a third invalid cache-control directive,\n\n|echo \"GET http://webproxy.india.sun.com:8000/tst.txt HTTP/1.0\\r\\nCache-Control: foobar=\\\" max-age=0 \\\" \\r\\n\\r\\n\" | nc 0 8080\nHTTP/1.1 200 OK\nDate: Tue, 26 Aug 2008 18:58:18 GMT\nServer: Sun-Java-System-Web-Proxy-Server/4.0.4\nLast-Modified: Tue, 26 Aug 2008 11:12:33 GMT\nContent-length: 5\nEtag: \"5-48b3e521\"\nAccept-ranges: bytes\nVia: 1.0 agneyam:8000\nAge: 163\nConnection: close\nContent-Type: text/plain\n\nabcd\n\n--> No request to the back end observed.\n\n------------------------------------------------------\nAnd no cache-eviction observed.\n\nIs my verification correct?, if it is, then it is not present in trunk any more (though may be present in the earlier versions |> 2.0.54 < trunk| )\nthanks for the bug report.\n", "id": 120119, "time": "2008-08-26T12:24:05Z", "bug_id": 35217, "creation_time": "2008-08-26T12:24:05Z", "is_private": false, "attachment_id": null}, {"count": 16, "attachment_id": null, "bug_id": 35217, "text": "I do not see any problems with your verification steps. Looks like this bug was fixed.", "id": 120125, "time": "2008-08-26T14:32:40Z", "creator": "coad@measurement-factory.com", "creation_time": "2008-08-26T14:32:40Z", "tags": [], "is_private": false}, {"count": 17, "tags": [], "bug_id": 35217, "is_private": false, "id": 120130, "attachment_id": null, "creator": "rahul.g.nair@gmail.com", "creation_time": "2008-08-27T00:44:14Z", "time": "2008-08-27T00:44:14Z", "text": "Verified fixed in 2.2.9\nclosing it as fixed."}]