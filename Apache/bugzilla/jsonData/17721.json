[{"count": 0, "tags": [], "bug_id": 17721, "text": "In the 'ant' shell script (module ant/src/script/ant), there is a while\nloop to expand symlinks in $0 to try to find the real ANT_HOME.\n\nThis loop includes the following test, which is supposed to handle\nabsolute and relative paths correctly:\n\n\tif expr \"$link\" : '.*/.*' > /dev/null; then\n\t\tPRG=\"$link\"\n\telse\n\t\tPRG=`dirname \"$PRG\"`\"/$link\"\n\tfi\n\nHowever, this test incorrectly regards a link target like '../ant/bin/ant'\nas an absolute path, so ANT_HOME gets set up wrongly.\n\nI replaced this with the following simpler snippet:\n\n\tcase \"$link\" in\n\t\t/*) PRG=\"$link\" ;;\n\t\t*)  PRG=`dirname \"$PRG\"`\"/$link\" ;;\n\tesac\n\nwhich fixes the problem.\n\nThis was on Solaris 8 sparc with Ant 1.5.2 binary distribution, but\nthis test hasn't changed in the latest CVS, and it looks like it will\naffect all Unix distributions using this script.", "id": 32557, "time": "2003-03-06T14:12:33Z", "creator": "martin@macrospace.com", "creation_time": "2003-03-06T14:12:33Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 17721, "attachment_id": 5178, "text": "Created attachment 5178\nPatch file giving my exact change to fix problem.", "id": 32559, "time": "2003-03-06T14:16:54Z", "creator": "martin@macrospace.com", "creation_time": "2003-03-06T14:16:54Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 17721, "attachment_id": null, "text": "Hmm, in my case ant is ${HOME}/bin/ant and \n\n[bodewig@bodewig jakarta-ant]$ ls -l ~/bin/ant \nlrwxrwxrwx    1 bodewig  bodewig        44 Jan 17 13:42 /home/bodewig/bin/ant ->\n../ASF/jakarta/jakarta-ant/bootstrap/bin/ant\n\na relative symlink.  Linux that is.\n\nCould you try the ant srcipt from CVS HEAD - see URL above - as it uses a different\napproach that the one in the 1.5. branch?", "id": 33531, "time": "2003-03-20T09:37:34Z", "creator": "bodewig@apache.org", "creation_time": "2003-03-20T09:37:34Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 17721, "is_private": false, "count": 3, "id": 33760, "time": "2003-03-25T14:45:53Z", "creator": "martin@macrospace.com", "creation_time": "2003-03-25T14:45:53Z", "text": "The version from CVS HEAD gives me the same problem.\n\nOther parts of the script have changed, but the problematic test is the same.\n\nThe problem is with the test at line 54 in HEAD:\n\n\texpr \"$link\" : '.*/.*'\n\nThis is supposed to test if $link is an absolute path. However, what it\nactually tests is if $link contains a '/' character (rather than if it\nstarts with a '/').\n\nI also got it to work by changing this test to:\n\n\texpr \"$link\" : '^/.*'\n\nThis is a smaller change than my other proposed fix.\n\nHere is an extract from the output of \"sh -x ~/bin/ant\" on Solaris 8 (sparc),\nwith the script from HEAD:\n\n[...]\nPRG=/export/home/martin/bin/ant\n+ basename /export/home/martin/bin/ant \nprogname=ant\n+ [ -h /export/home/martin/bin/ant ] \n+ ls -ld /export/home/martin/bin/ant \nls=lrwxrwxrwx   1 martin         22 Mar 25 14:18 /export/home/martin/bin/ant ->\n../install/ant/bin/ant\n+ expr lrwxrwxrwx   1 martin         22 Mar 25 14:18 /export/home/martin/bin/ant\n-> ../install/ant/bin/ant : .*-> \\(.*\\)$ \nlink=../install/ant/bin/ant\n+ expr ../install/ant/bin/ant : .*/.* \nPRG=../install/ant/bin/ant\n+ [ -h ../install/ant/bin/ant ] \n+ dirname ../install/ant/bin/ant \nANT_HOME=../install/ant/bin/..\n+ cd ../install/ant/bin/.. \n/export/home/martin/bin/ant: ../install/ant/bin/..: does not exist\nANT_HOME=\n[...]\n\nI've also reproduced the bug on Linux (Cobalt Linux, which I think is based\non RedHat 5 point something), again with the script from HEAD:\n\n[...]\n+ PRG=/home/sites/home/users/martin/bin/ant\n++ basename /home/sites/home/users/martin/bin/ant\n+ progname=ant\n+ [ -h /home/sites/home/users/martin/bin/ant ]\n++ ls -ld /home/sites/home/users/martin/bin/ant\n+ ls=lrwxrwxrwx   1 martin   users          22 Mar 25 13:12\n/home/sites/home/users/martin/bin/ant -> ../install/ant/bin/ant\n++ expr lrwxrwxrwx   1 martin   users          22 Mar 25 13:12\n/home/sites/home/users/martin/bin/ant -> ../install/ant/bin/ant : .*-> \\(.*\\)$\n+ link=../install/ant/bin/ant\n+ expr ../install/ant/bin/ant : .*/.*\n+ PRG=../install/ant/bin/ant\n+ [ -h ../install/ant/bin/ant ]\n++ dirname ../install/ant/bin/ant\n+ ANT_HOME=../install/ant/bin/..\n++ cd ../install/ant/bin/..\n/home/sites/home/users/martin/bin/ant: ../install/ant/bin/..: No such file or\ndirectory\n+ ANT_HOME=\n[...]\n\nSetting ANT_HOME before running the script does work around the problem\n(because the test in question never gets run). Maybe this is why you can't\nreproduce it.\n\nDoes \"env - ~/bin/ant\" work for you?\n"}, {"count": 4, "tags": [], "bug_id": 17721, "text": "You are right, unsetting ANT_HOME produces the same error for me, thanks.\n\nThe FreeBSD manual page of expr says that : would implicitly anchor the expression,\nso the leading ^ wouldn't be needed.  Do you know whether the same is true for\nSolaris (Linux seems to do the same).\n", "id": 33761, "time": "2003-03-25T15:01:00Z", "creator": "bodewig@apache.org", "creation_time": "2003-03-25T15:01:00Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 17721, "text": "And more importantly, what would the change do to Cygwin?\n\nUhm, not really more important, but, the Cygwin users tend to make more noise 8-)\n", "id": 33762, "time": "2003-03-25T15:05:55Z", "creator": "bodewig@apache.org", "creation_time": "2003-03-25T15:05:55Z", "is_private": false, "attachment_id": null}, {"count": 6, "text": "The Solaris man page for expr doesn't seem to document whether it implicitly\nanchors the regex. However:\n\n\t$ expr foo : '/.*' > /dev/null ; echo $?\n\t1\n\t$ expr /foo : '/.*' > /dev/null ; echo $?\n\t0\n\t$ expr x/foo : '/.*' > /dev/null ; echo $?\n\t1\n\nso it looks like it does.\n\nI don't know what this will do to Cygwin. It should be fine as long as\nit's still true that exactly those paths starting with '/' are absolute.\nI think this is the case (otherwise loads of software would break), but\nI don't really know Cygwin so I can't say for sure.\n", "bug_id": 17721, "is_private": false, "id": 33763, "time": "2003-03-25T15:24:23Z", "creator": "martin@macrospace.com", "creation_time": "2003-03-25T15:24:23Z", "tags": [], "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 17721, "text": "It's said to work on Cygwin as well, patch committed, thanks.", "id": 33899, "time": "2003-03-27T08:26:55Z", "creator": "bodewig@apache.org", "creation_time": "2003-03-27T08:26:55Z", "is_private": false, "attachment_id": null}]