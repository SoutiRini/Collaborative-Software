[{"count": 0, "tags": [], "bug_id": 42366, "attachment_id": null, "id": 102997, "time": "2007-05-09T07:04:18Z", "creator": "thomas.lange@techunity.de", "creation_time": "2007-05-09T07:04:18Z", "is_private": false, "text": "I have a web application with a chat subsystem. Chat is implemented by \nstreaming a never ending page to the client, with new chat messages \nsubsequently added. The server recognizes if a user has left by a write to the \noutstream resulting in an exception. The server then closes the connection and \nthe serving thread is returned to the thread pool.\n\nWhile all standard (normally terminating) pages of the web application work \nfine, the chat page, while working as expected, results in the apache process \nbloating up, up to a gigabyte.\n\nI have ruled out hung tomcat threads, since several hundreds of thousands of \nrequests can be served, until memory consumption makes the system fail.\n\nThe problem occurs on FreeBSD and Linux with Apache 2.0.55 worker_mpm and \nmod_jk versions 1.2.14, 1.2.19 and 1.2.22.\n\nThe problem does not seem to exist in mod_jk 1.2.6. Using this version, the \nApache process stays small (less than 30 MB)."}, {"count": 1, "tags": [], "bug_id": 42366, "attachment_id": null, "id": 103013, "time": "2007-05-09T11:35:03Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2007-05-09T11:35:03Z", "is_private": false, "text": "I tried to reproduce, but did not succeed. So please give a couple of info:\n\n- mod_jk config (workers.properties, Jk* directives)\n\nDuring your test: \n\n- does the number of apache processes go up, or is it stable?\n- does the number of backend connections go up, or is it stable?\n\nAs I understand your report, neither Apache threads, nor backend connections get\nhung, but the apache processes grow in size?\n\nAny chance, you retry with Apache 2.0.59?\n\nFurthermore: Could you please save /proc/PID/maps before, after and a few times\nduring the test, where PID is the PID of one of the Apache children, that\nhandles the requests (which one gets the requests could be either logged with %P\nin the access log, or you simply look at mod_jk log lines, which contain the pid\nas a field. Those files are ASCII and can be attached to this BZ.\n\nFor my tests, I used a simple test jsp, of the form:\n\n<%@page session=\"false\"%>\n<%\nlong sleepDuration=0;\nString sleepDurationParameter = request.getParameter(\"dur\");\nif ( sleepDurationParameter != null && ! sleepDurationParameter.equals(\"\") ) {\n        sleepDuration=Long.valueOf(sleepDurationParameter).longValue();\n}\n%>\nParameter: <%= sleepDuration %>\nBegin Sleeping ...\n<%\nThread.sleep(sleepDuration);\n%>\nBegin Payload\n... (about 20K nonsense characters) ...\nThe End\n\nCould you retry with that? I called it like .../sl.jsp?dur=3000 with a client,\nwhich had a wait timeout of 1 second, I can force connection aborts and\nrespective error messages, but get not mem leak.\n\nWhat info/warn/error/emerg messages does your jk log file show?\n\n "}, {"count": 2, "tags": [], "bug_id": 42366, "attachment_id": null, "id": 112425, "time": "2008-01-01T21:40:11Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2008-01-01T21:40:11Z", "is_private": false, "text": "Could you please check, if the problem is fixed in the new version 1.2.26?"}, {"attachment_id": null, "tags": [], "bug_id": 42366, "is_private": false, "count": 3, "id": 115334, "time": "2008-04-05T11:23:45Z", "creator": "thomas.lange@techunity.de", "creation_time": "2008-04-05T11:23:45Z", "text": "I just tried it out with the current versions of mod_jk (1.2.26) and tomcat (5.5.26).\n\nThe problem is still the same.\n\nTop reports each of the apache processes using more than 150 MB of \"RES\" memory (and increasing), while with mod_jk 1.2.6 they each use around 10 MB (staying constant).\n\nAdditionally I noticed, that the problem only seems to appear with the following option activated:\n\nJkOptions     +FlushPackets\n"}, {"count": 4, "tags": [], "creator": "thomas.lange@techunity.de", "attachment_id": null, "id": 115335, "time": "2008-04-05T11:25:06Z", "bug_id": 42366, "creation_time": "2008-04-05T11:25:06Z", "is_private": false, "text": "And I'm sorry. It is still Apache 2.0.55 \n"}, {"count": 5, "tags": [], "creator": "thomas.lange@techunity.de", "attachment_id": null, "id": 115339, "time": "2008-04-05T11:41:15Z", "bug_id": 42366, "creation_time": "2008-04-05T11:41:15Z", "is_private": false, "text": "Please excuse the many posts.\n\n> - mod_jk config (workers.properties, Jk* directives)\n\nJK* directives:\n\n   JkWorkersFile /etc/apache2/workers.properties\n   JkLogFile  /var/log/jk.log\n   JkLogLevel error\n   JkOptions     +FlushPackets\n\n(as noted above, it seems to work without +FlushPackets)\n\nworkers.properties:\nworker.list=worker1, worker2\n\nworker.worker2.port=8010\nworker.worker2.host=127.0.0.1\nworker.worker2.type=ajp13\n\nworker.worker1.port=8009\nworker.worker1.host=127.0.0.1\nworker.worker1.type=ajp13\n\n(worker2 is not in use, there is not even a tomcat responding on that port)\n\n\n> - does the number of apache processes go up, or is it stable?\nit is stable, and the number is the same with both the working and the problematic version of mod_jk\n\n> - does the number of backend connections go up, or is it stable?\nI think it is stable.\n\nthe number of client connections, measured with\nnetstat | grep www | grep ESTA | wc -l\nis the same also.\n\n> Any chance, you retry with Apache 2.0.59?\nI will try to do that.\n\n> What info/warn/error/emerg messages does your jk log file show?\nwhenever a connection is dropped by the client, the following error message appears in the jk.log file (it is the same for version 1.2.6 and 1.2.26:\n\n[jk_ajp_common.c (1462)]: ERROR: Client connection aborted or network problems\n"}, {"attachment_id": null, "tags": [], "bug_id": 42366, "is_private": false, "count": 6, "id": 115367, "time": "2008-04-07T06:55:39Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2008-04-07T06:55:39Z", "text": "I couldn't reproduce the leak, even with FlushPackets.\n\nCan you provide a simple webapp to reproduce it?"}, {"count": 7, "text": "No response for 3.5 years.\nClosing as invalid.", "bug_id": 42366, "is_private": false, "id": 150906, "time": "2011-10-25T18:22:20Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2011-10-25T18:22:20Z", "tags": [], "attachment_id": null}]