[{"count": 0, "tags": [], "bug_id": 47244, "text": "Apologies if this is a duplicate, HSSFHeader and HSSFFooter seem to throw NullPointerException with some spreadsheets.\n\nException caught\njava.lang.NullPointerException\n\tat org.apache.poi.hssf.usermodel.HSSFFooter.<init>(HSSFFooter.java:44)\n\tat org.apache.poi.hssf.usermodel.HSSFSheet.getFooter(HSSFSheet.java:934)\n\tat org.apache.poi.hssf.extractor.ExcelExtractor.getText(ExcelExtractor.java:386)\n\nThis happens when I'm using the org.apache.poi.hssf.extractor.ExcelExtractor in particular.  FooterRecord/HeaderReccord appear to be null in these scenarios. \n\nBiffViewer fails with:\n\nBiffViewer:\n     [java] java.io.FileNotFoundException: no such entry: \"Workbook\"\n     [java] \tat org.apache.poi.poifs.filesystem.DirectoryNode.getEntry(DirectoryNode.java:272)\n     [java] \tat org.apache.poi.poifs.filesystem.DirectoryNode.createDocumentInputStream(DirectoryNode.java:124)\n     [java] \tat org.apache.poi.poifs.filesystem.POIFSFileSystem.createDocumentInputStream(POIFSFileSystem.java:458)\n\nIf I open the original attachment in OpenOffice and save it this cures the issue, so it's obviously some bad data in the spreadsheet.  I can't, unfortunately send you the spreadsheet.\n\nAttached is a patch that cures the issue, I'm not sure whether it is appropriate to ignore the header/footer and return null, but it appears to cure the issue and I get my spreadsheet output in the correct format.  Please let me know if you need anything else.\n\nIndex: HSSFSheet.java\n===================================================================\n--- HSSFSheet.java\t(revision 776494)\n+++ HSSFSheet.java\t(working copy)\n@@ -37,6 +37,8 @@\n import org.apache.poi.hssf.record.DVRecord;\n import org.apache.poi.hssf.record.EscherAggregate;\n import org.apache.poi.hssf.record.ExtendedFormatRecord;\n+import org.apache.poi.hssf.record.FooterRecord;\n+import org.apache.poi.hssf.record.HeaderRecord;\n import org.apache.poi.hssf.record.NoteRecord;\n import org.apache.poi.hssf.record.Record;\n import org.apache.poi.hssf.record.RowRecord;\n@@ -917,7 +919,11 @@\n      * @return The Document header.\n      */\n     public HSSFHeader getHeader() {\n-        return new HSSFHeader(_sheet.getPageSettings().getHeader());\n+        HeaderRecord header = _sheet.getPageSettings().getHeader();\n+        if (header != null) {\n+            return new HSSFHeader(header);\n+        }\n+        return null;\n     }\n \n     /**\n@@ -925,7 +931,11 @@\n      * @return The Document footer.\n      */\n     public HSSFFooter getFooter() {\n-        return new HSSFFooter(_sheet.getPageSettings().getFooter());\n+        FooterRecord footer = _sheet.getPageSettings().getFooter();\n+        if (footer != null) {\n+            return new HSSFFooter(footer);\n+        }\n+        return null;\n     }\n \n     /**", "id": 127301, "time": "2009-05-22T09:59:26Z", "creator": "jonathan.holloway@gmail.com", "creation_time": "2009-05-22T09:59:26Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 47244, "attachment_id": null, "id": 127508, "time": "2009-05-30T05:05:11Z", "creator": "yegor@dinom.ru", "creation_time": "2009-05-30T05:05:11Z", "is_private": false, "text": "Can you attach a file that causes the problem? The suggested patch looks fine, but I would like to have a clear test case before applying it. \n\nRegards,\nYegor"}, {"count": 2, "tags": [], "creator": "josh@apache.org", "attachment_id": null, "text": "Sorry Jonathan and Yegor, I meant to reply earlier, but hadn't got round to it.\n\nThe proposed patch is NQR because it creates a header/footer object which is detached from the HSSFSheet.  The newly created (empty) header / footer record needs to be placed into the PageSettingsBlock, otherwise updating it will have no effect.  That's easy enough, but it's messy to create objects that represent their own absence.\n\nI noticed that header/footer API on Sheet is a little deficient.  It's hard to tell whether the usermodel objects are supposed to have a similar life-cycle as the underlying biff records.  There's no methods on Sheet for update, delete or doesExist, and I think it would clutter things to add these.  The getHeader / getFooter methods seem to be called only twice from the full POI code-base. ExcelExtractor assumes that getFooter() will return null when the footer is not present.  HeadersAndFooters example expects that the footer will get lazily created by HSSFSheet.getFooter(). This seems to suggest that HSSFHeader / HSSFFooter should exist independent of HeaderRecord / FooterRecord.\n\nI think a better solution might involve HSSFHeader / HSSFFooter directly wrapping the PageSettingsBlock (which is lazily created, and already manages the presence of all such contained records).  The HSSFHeader / HSSFFooter would know how get / update / create and destroy the header / footer records, and tell the PageSettingsBlock as needed.  This approach probably holds up better in the XSSF world where headers and footers are further specialised to odd/even etc (i.e. XSSFHeader should know about it's odd/even variants, not XSSFSheet).\n\nWe should also update the javadoc of getHeader / getFooter to say @return never null.", "id": 127515, "time": "2009-05-31T01:04:19Z", "bug_id": 47244, "creation_time": "2009-05-31T01:04:19Z", "is_private": false}, {"count": 3, "text": "Fixed in svn r781645\n\njunits added\n\nPOI now tolerates missing header / footer records, and also adds them when writing.\n\nAlso changed assumption (see bug 45777) that the header / footer text cannot exceed 256 bytes.", "bug_id": 47244, "attachment_id": null, "id": 127622, "time": "2009-06-03T20:43:51Z", "creator": "josh@apache.org", "creation_time": "2009-06-03T20:43:51Z", "tags": [], "is_private": false}]