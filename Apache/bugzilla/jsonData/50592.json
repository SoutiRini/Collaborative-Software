[{"count": 0, "attachment_id": null, "creator": "frank@deze.org", "is_private": false, "id": 143360, "time": "2011-01-15T13:47:11Z", "bug_id": 50592, "creation_time": "2011-01-15T13:47:11Z", "tags": [], "text": "Apache HTTPD dumps core on a FreeBSD-8.2-STABLE system in an IPv6 only jail when starting.\n\n    six# /usr/local/etc/rc.d/apache22 start\n    Performing sanity check on apache22 configuration:\n    [Sat Jan 15 15:27:54 2011] [crit] [Sat Jan 15 15:27:54 2011] file config.c, line 1982, assertion \"rv == APR_SUCCESS\" failed\n    Abort trap (core dumped)\n    Starting apache22.\n    [Sat Jan 15 15:27:54 2011] [crit] [Sat Jan 15 15:27:54 2011] file config.c, line 1982, assertion \"rv == APR_SUCCESS\" failed\n    Abort trap (core dumped)\n    /usr/local/etc/rc.d/apache22: WARNING: failed to start apache22\n\nThe apache version is apache-2.2.17_1 from the FreeBSD port collection using all the default options:\n\nsix# httpd -V\n\n    Server version: Apache/2.2.17 (FreeBSD)\n    Server built: Jan 15 2011 14:48:51\n    Server's Module Magic Number: 20051115:25\n    Server loaded: APR 1.4.2, APR-Util 1.3.10\n    Compiled using: APR 1.4.2, APR-Util 1.3.10\n    Architecture: 32-bit\n    Server MPM: Prefork\n    threaded: no\n    forked: yes (variable process count)\n    Server compiled with....\n    -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n    -D APR_HAS_SENDFILE\n    -D APR_HAS_MMAP\n    -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n    -D APR_USE_FLOCK_SERIALIZE\n    -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n    -D APR_HAS_OTHER_CHILD\n    -D AP_HAVE_RELIABLE_PIPED_LOGS\n    -D DYNAMIC_MODULE_LIMIT=128\n    -D HTTPD_ROOT=\"/usr/local\"\n    -D SUEXEC_BIN=\"/usr/local/bin/suexec\"\n    -D DEFAULT_PIDLOG=\"/var/run/httpd.pid\"\n    -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n    -D DEFAULT_LOCKFILE=\"/var/run/accept.lock\"\n    -D DEFAULT_ERRORLOG=\"logs/error_log\"\n    -D AP_TYPES_CONFIG_FILE=\"etc/apache22/mime.types\"\n    -D SERVER_CONFIG_FILE=\"etc/apache22/httpd.conf\"\n    six#\n\nThe httpd.conf file is pretty straightforward as well, for space reasons I only include the differences compared to the httpd.conf from the distribution:\n\n    six# diff -u0 httpd.conf.dist httpd.conf\n    --- httpd.conf.dist 2011-01-12 02:18:09.000000000 +0100\n    +++ httpd.conf 2011-01-15 14:44:31.000000000 +0100\n    @@ -40 +40 @@\n    -Listen 80\n    +Listen [2001:980:1312:6::1]:80\n    @@ -104,0 +105 @@\n    +LoadModule php5_module libexec/apache22/libphp5.so\n    @@ -139 +140 @@\n    -ServerAdmin you@example.com\n    +ServerAdmin www@deze.org\n    @@ -148 +149 @@\n    -#ServerName www.example.com:80\n    +ServerName six.ipv6.deze.org:80\n    @@ -216 +217 @@\n    - DirectoryIndex index.html\n    + DirectoryIndex index.html index.php\n    @@ -380,0 +382,4 @@\n    +\n    + # For PHP\n    + AddType application/x-httpd-php .php\n    + AddType application/x-httpd-php-source .phps\n\nThe hostname of the jail is resolvable (forward and reverse) via DNS and is also in /etc/hosts.\nBut the hostname has only an AAAA record, but no A record in DNS.\n\n\n    six# host -6 six.ipv6.deze.org\n    six.ipv6.deze.org has IPv6 address 2001:980:1312:6::1\n    six# host 2001:980:1312:6::1\n    1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.6.0.0.0.2.1.3.1.0.8.9.0.1.0.0.2.ip6.arpa domain name pointer six.ipv6.deze.org.\n\n\nI posted this problem on the apache-users mailing list, and it was suggested to file bug because:\n\n\"IIUC apache is trying to setup the skeleton vhost config for the base\nserver and asking the system for a sockaddr for IPV4 INADDR_ANY (we\nhaven't read the config enough to even know the base configs\nServerName).\n\nI'd suggest opening a bug, I think httpd could at least ask APR/the OS\nto give up an IPV6 INADDRY_ANY before asserting.\""}, {"count": 1, "tags": [], "bug_id": 50592, "is_private": false, "text": "Trunk fix in r1059472 to exit cleanly with an error message on failure.", "id": 143366, "time": "2011-01-15T23:23:48Z", "creator": "nick@webthing.com", "creation_time": "2011-01-15T23:23:48Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 50592, "attachment_id": null, "id": 143367, "time": "2011-01-15T23:28:23Z", "creator": "nick@webthing.com", "creation_time": "2011-01-15T23:28:23Z", "is_private": false, "text": "Hmm, actually I'd better not mark my patch as a fix, as you suggest a possibly-better fix.  I won't attempt that unless I can reproduce the behaviour to test a fix."}, {"count": 3, "tags": [], "bug_id": 50592, "is_private": false, "text": "Has this been investigated at all? This issue still exists in 2.2.19, tested on FreeBSD 7.4-RELEASE-p2 in an IPv6 only jail. Configuring the jail with an IPv4 address as well allows Apache to start. My expected behavior is that Apache actually starts, it should have no reason not to.\n\nOutput of -V for me:\n\nServer version: Apache/2.2.19 (Unix)\nServer built:   Jun  6 2011 12:56:46\nServer's Module Magic Number: 20051115:28\nServer loaded:  APR 1.4.5, APR-Util 1.3.12\nCompiled using: APR 1.4.5, APR-Util 1.3.12\nArchitecture:   32-bit\nServer MPM:     Prefork\n  threaded:     no\n    forked:     yes (variable process count)\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_FLOCK_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"/usr/local/www\"\n -D SUEXEC_BIN=\"/usr/local/www/bin/suexec\"\n -D DEFAULT_PIDLOG=\"logs/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_LOCKFILE=\"logs/accept.lock\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"", "id": 146903, "time": "2011-06-06T19:09:05Z", "creator": "M8R-3mye921@thisisnotmyrealemail.com", "creation_time": "2011-06-06T19:09:05Z", "attachment_id": null}, {"count": 4, "attachment_id": 27206, "bug_id": 50592, "is_private": false, "id": 147502, "time": "2011-06-25T14:45:00Z", "creator": "root@linkage.white-void.net", "creation_time": "2011-06-25T14:45:00Z", "tags": [], "text": "Created attachment 27206\npatch for IPv6 only systems\n\nSame problem on FreeBSD 8.2-RELEASE with IPv6 only jails.\nPatch for httpd-2.2.19 attached."}, {"count": 5, "attachment_id": null, "creator": "frank@deze.org", "is_private": false, "id": 147692, "time": "2011-07-02T09:41:37Z", "bug_id": 50592, "creation_time": "2011-07-02T09:41:37Z", "tags": [], "text": "(In reply to comment #4)\n> Created attachment 27206 [details]\n> patch for IPv6 only systems\n> \n> Same problem on FreeBSD 8.2-RELEASE with IPv6 only jails.\n> Patch for httpd-2.2.19 attached.\n\nI confirm that this patch solves my problem. HTTPD now starts and seems to run normal.\n\nPlease include in the next release of apache!\n\nMany thanks,\n\nFrank"}, {"count": 6, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "id": 147743, "time": "2011-07-05T10:08:22Z", "bug_id": 50592, "creation_time": "2011-07-05T10:08:22Z", "is_private": false, "text": "Thanks for the patch.\n\nI am not sure why that code needs to use a specific address family.  Can you check it also works if you change the APR_INET to APR_UNSPEC, instead of your patch to fall back on _INET6?"}, {"count": 7, "attachment_id": 27255, "creator": "root@linkage.white-void.net", "text": "Created attachment 27255\npatch for IPv6 only systems (replacing APR_INET by APR_UNSPEC, refer comment #6)\n\n(In reply to comment #6)\n> Thanks for the patch.\n> \n> I am not sure why that code needs to use a specific address family.  Can you\n> check it also works if you change the APR_INET to APR_UNSPEC, instead of your\n> patch to fall back on _INET6?\n\nThanks. It works fine with only changing APR_INET to APR_UNSPEC.\nI agree with you, there are no need to specify any address families, I think.\n\nAttached the tested patch.", "id": 147748, "time": "2011-07-05T11:45:11Z", "bug_id": 50592, "creation_time": "2011-07-05T11:45:11Z", "tags": [], "is_private": false}, {"count": 8, "attachment_id": null, "creator": "sf@sfritsch.de", "is_private": false, "id": 147903, "time": "2011-07-13T19:21:35Z", "bug_id": 50592, "creation_time": "2011-07-13T19:21:35Z", "tags": [], "text": "Commited to trunk in r1146256"}]