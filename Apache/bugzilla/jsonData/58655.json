[{"count": 0, "tags": [], "bug_id": 58655, "text": "Created attachment 33299\nstacktrace of error\n\nWhen calling `HttpServletResponse#sendRedirect()`, if `RemoteIpFilter` is in use, an `IllegalStateException` is thrown (see attached stack-trace). \n\nThe error steams from the way `RemoteIpFilter.XForwardedResponse` tries to rewrite the 'Location' header. According to the servlet API, a response is considered committed after calling `sendRequest()` and it is illegal to call either `reset()` or another `sendRequest()` thereafter.\n\nWORKAROUND:\n\nComment the code after `super.sendRedirect(location);`. However, this effectively disables the `RemoteIpFilter` on the response path and makes the server return an URL with incorrect scheme.\n\n[1] https://github.com/apache/tomcat/blob/trunk/java/org/apache/catalina/filters/RemoteIpFilter.java#L679\n\n[2] https://tomcat.apache.org/tomcat-8.0-doc/servletapi/index.html", "id": 186574, "time": "2015-11-26T11:52:10Z", "creator": "cristiklein@gmail.com", "creation_time": "2015-11-26T11:52:10Z", "is_private": false, "attachment_id": 33299}, {"count": 1, "attachment_id": null, "creator": "cristiklein@gmail.com", "is_private": false, "id": 186575, "time": "2015-11-26T11:54:10Z", "bug_id": 58655, "creation_time": "2015-11-26T11:54:10Z", "tags": [], "text": "Forgot to mention, this bug is not triggered with Eclipse's servlet engine (I think Jetty), but only occurs when the servlet is deployed on Tomcat."}, {"count": 2, "tags": [], "bug_id": 58655, "is_private": false, "id": 186616, "creation_time": "2015-11-27T21:21:56Z", "time": "2015-11-27T21:21:56Z", "creator": "markt@apache.org", "text": "Using relative redirects (see bug 56917) should make this fixable.", "attachment_id": null}, {"count": 3, "attachment_id": null, "bug_id": 58655, "is_private": false, "id": 186671, "time": "2015-11-30T16:30:09Z", "creator": "markt@apache.org", "creation_time": "2015-11-30T16:30:09Z", "tags": [], "text": "Thanks for the report.\n\nThis has been fixed in 9.0.x (for 9.0.0.M2), 8.0.x (for 8.0.30) and 7.0.x (for 7.0.67).\n\n6.0.x was not affected."}, {"count": 4, "tags": [], "bug_id": 58655, "is_private": false, "text": "Thanks for the fix. I'm not sure to understand how the fix helps. What line or what mechanism rewrites the scheme from `http` to `https`?", "id": 186687, "time": "2015-11-30T19:00:15Z", "creator": "cristiklein@gmail.com", "creation_time": "2015-11-30T19:00:15Z", "attachment_id": null}, {"count": 5, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 186688, "time": "2015-11-30T20:09:43Z", "bug_id": 58655, "creation_time": "2015-11-30T20:09:43Z", "text": "The scheme isn't re-written. If you redirect using an absolute URI with a specific scheme then that is what you get. If you want the scheme to be \"rewritten\"/correct then use a relative redirect."}, {"count": 6, "attachment_id": null, "bug_id": 58655, "is_private": false, "id": 186709, "time": "2015-12-01T10:46:52Z", "creator": "cristiklein@gmail.com", "creation_time": "2015-12-01T10:46:52Z", "tags": [], "text": "Are you sure this works? The \"Location\" header eventually has to contain the absolute URL. [1] If this is left to the \"non-RemoteIpFilter\" code, wouldn't the scheme be filled incorrectly?\n\n[1] http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html"}, {"count": 7, "attachment_id": null, "bug_id": 58655, "text": "RFC2616 is obsolete. See RFC7231.", "id": 186711, "time": "2015-12-01T11:05:48Z", "creator": "markt@apache.org", "creation_time": "2015-12-01T11:05:48Z", "tags": [], "is_private": false}, {"count": 8, "tags": [], "bug_id": 58655, "is_private": false, "text": "Is there a reason why one uses RemoteIpFilter ? There exists a RemoteIpValve that can be used instead.\n\n1. There are redirects that are performed before a request reaches the filter.\nE.g. when using a FORM authentication (FormAuthenticator)\n\nIt cannot be solved by using a filter. One has to use RemoteIpValve here.\n\n\n2. There is an edge case. It is allowed to call sendRedirect() with an absolute URL. With simple implementation (using relative redirects) it won't be rewritten.\n\nYou have to bear with it (such calls are unlikely) or duplicate a lot of code from o.a.c.connector.Response.sendRedirect() to implement this feature.", "id": 186718, "time": "2015-12-01T16:29:00Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-12-01T16:29:00Z", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 58655, "is_private": false, "id": 186737, "creation_time": "2015-12-02T09:41:03Z", "time": "2015-12-02T09:41:03Z", "creator": "cristiklein@gmail.com", "text": "I'm confused. I thought `RemoteIpValve` was deprecated in favour of `RemoteIpFilter`. Otherwise, I feel they both serve the same purpose.", "attachment_id": null}]