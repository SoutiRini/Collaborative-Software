[{"count": 0, "tags": [], "creator": "peter.steiner@acm.org", "attachment_id": null, "text": "As Brian Pane reported [1], current_free_index in allocator_free may underflow\nto 2^32-1. Though the report dates almost a year back, I couldn't find any\ncorrection or patch in the trunk or in bugzilla.\n\nI have observed [2] a situation where this problem leads to losing a pointer to\na still allocated node, when a second node is freed. The pointer to this second\nnode is stored to allocator->free[index] (index == 1), thus overwriting the\npointer to the first node.\n\nThis leads to a leak of 8k (the default node size).\n\n[1] \"apr_allocator Re: Event MPM: Spinning on cleanups?\"\nhttp://mail-archives.apache.org/mod_mbox/httpd-dev/200512.mbox/%3CA99202F3-A131-4656-8A68-7574C9E9062F@apache.org%3E\n\n[2] http://www.mail-archive.com/log4cxx-user@logging.apache.org/msg01708.html", "id": 95755, "time": "2006-11-13T02:30:29Z", "bug_id": 40955, "creation_time": "2006-11-13T02:30:29Z", "is_private": false}, {"count": 1, "tags": [], "creator": "peter.steiner@acm.org", "is_private": false, "text": "See also https://issues.apache.org/jira/browse/LOGCXX-161,\nwhere I described how this error leads to a leak in the log4cxx project.", "id": 95757, "time": "2006-11-13T03:46:31Z", "bug_id": 40955, "creation_time": "2006-11-13T03:46:31Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 40955, "text": "Per dev@apr mail:\n\nThe issues Brian reference look real but are entirely unrelated to the\nsymptoms you have described - they cannot cause a \"memory leak\" in your\napp.  If the memory use in your app is increasing *indefinitely* then\nthat's a pool memory misuse problem.\n\nCheck that e.g. all pools you create are also destroyed and that no\nmemory is being allocated out of long-lived pools by whatever operation\nit is you see consuming memory.\n\nI'll leave this bug open to track the _max_free_set issues Brian points out.", "count": 2, "id": 96083, "time": "2006-11-22T08:06:02Z", "creator": "jorton@redhat.com", "creation_time": "2006-11-22T08:06:02Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 40955, "text": "Created attachment 19193\nPatch to fix the unsigned underflow (and have better comments)\n\nI have reviewed my memory use problem once more and found that Joe Orton is\nright (of course).\n\nMy problems have to do both with not setting a threshold with\napr_allocator_max_free_set() and having allocations in a long lived pool.\n\nThe patch is not related to my problems, but to the issue that Brian\ndiscovered. And I wrote some descriptive comments for the apr_allocator_t\nfields. Hope they are helpful...", "id": 96327, "time": "2006-11-29T00:49:26Z", "creator": "peter.steiner@acm.org", "creation_time": "2006-11-29T00:49:26Z", "is_private": false, "attachment_id": 19193}, {"count": 4, "tags": [], "bug_id": 40955, "text": "I've committed the remainder of the new patch, including underflow detection,\nto all three living branches.\n\nI'm marking fixed and trust you'll open another bug if you find another related\nor unrelated allocator issue.", "id": 109411, "time": "2007-10-16T21:18:06Z", "creator": "wrowe@apache.org", "creation_time": "2007-10-16T21:18:06Z", "is_private": false, "attachment_id": null}]