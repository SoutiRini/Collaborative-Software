[{"count": 0, "tags": [], "bug_id": 33967, "text": "Hi all,\n\nI recently post a suggestion for a problem of stop context (33589),\nbut you said to me that it was my problem.\nSo, I solved it with my solution,\nAnd I provide you this solution :\n\n1) I patch the Tomcat Manager to read the type parameter, pass it to the stop\nmethod, then put it in the desired Context.\n2) All my servlets inherit from a MotherServlet like below.\n\nIf other people like me want to use this new feature,\ncould you integrate this in the TC Manager ?\n\nIn advance, thank you.\n\nFor 1) :\n$diff ManagerServlet.java.new ManagerServlet.java.cvs\n371c370\n<             stop(writer, path,type);\n---\n>             stop(writer, path);\n1201c1200\n<     protected void stop(PrintWriter writer, String path, String type) {\n---\n>     protected void stop(PrintWriter writer, String path) {\n1204c1203\n<             log(\"stop: Stopping (\" + type +\") web application at '\" + path + \"'\");\n---\n>             log(\"stop: Stopping web application at '\" + path + \"'\");\n1227,1231d1225\n<           if ( (type != null) && (! type.equals(\"\")) ) {\n<               context.getServletContext().setAttribute(\"TYPE\",(Object)type);\n<           }\n\n\n\n$ diff HTMLManagerServlet.java.new HTMLManagerServlet.java.cvs\n84d83\n<         String type = request.getParameter(\"type\");\n107c106\n<             message = stop(path,type);\n---\n>             message = stop(path);\n524c523\n<     protected String stop(String path,String type) {\n---\n>     protected String stop(String path) {\n529c528\n<         super.stop(printWriter, path,type);\n---\n>         super.stop(printWriter, path);\n\n\nFor 2), people will have to use such a MotherServlet :\npublic abstract class MotherServlet extends HttpServlet\n{\n private static final Object lock = new Object();\n private static int nbActifsThreads = 0;\n...\n protected void service(HttpServletRequest request, HttpServletResponse\nresponse) throws IOException, ServletExcepti\non\n {\n   synchronized (lock) { nbActifsThreads++; }\n   try {\n     super.service(request, response);\n   }\n   finally {\n     try {\n       response.flushBuffer();\n     }\n     catch (IOException e) {\n       log( \"exception\", e );\n     }\n   }\n   synchronized (lock) { nbActifsThreads--; }\n }\n\n public synchronized void destroy()\n {\n   ServletContext myCtx = getServletContext();\n   String typeStop = (String)myCtx.getAttribute(\"TYPE\");\n   if ( (typeStop != null) && (typeStop.equals(\"LIGHT\")) )\n   {\n     while (nbThreadsActifs >0) {\n       try { Thread.sleep(100); } catch (Exception e) {}\n     }\n   }\n   // ... my specifics free resources\n   super.destroy();\n }\n}", "id": 72224, "time": "2005-03-11T18:14:02Z", "creator": "lionel.farbos@free.fr", "creation_time": "2005-03-11T18:14:02Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "lionel.farbos@free.fr", "is_private": false, "count": 1, "id": 72431, "time": "2005-03-15T10:36:18Z", "bug_id": 33967, "creation_time": "2005-03-15T10:36:18Z", "text": "additional comment :\n\nIn this proposition, the GUI doesn't have to be changed : with the GUI, only the\n\"force stop\" is possible (like now).\nThe people who want to do a \"light stop\" must have a shell script like this :\ncurl -u $loginManager:$pwdManager -H \"Host: $vHost\"\n\"http://$vHost:8080/manager/html/stop?path=$context&type=LIGHT\""}, {"count": 2, "tags": [], "bug_id": 33967, "is_private": false, "text": "The diff between TC4.1.32Alpha (HEAD tag) and the new version is :\n\n$diff ManagerServlet.java.cvs ManagerServlet.java.new\n316c316\n<             stop(writer, path);\n---\n>             stop(writer, path,type);\n1119c1119\n<     protected void stop(PrintWriter writer, String path) {\n---\n>     protected void stop(PrintWriter writer, String path,String type) {\n1122c1122\n<             log(\"stop: Stopping web application at '\" + path + \"'\");\n---\n>             log(\"stop: Stopping (\" + type +\") web application at '\" + path + \"'\");\n1144a1145,1147\n>           if ( (type != null) && (! type.equals(\"\")) ) {\n>               context.getServletContext().setAttribute(\"TYPE\",(Object)type);\n>             }\n\n\nThe patch for HTMLManagerServlet is not needed.\n\nand the batch script is better with :\ncurl -u $loginManager:$pwdManager -H \"Host: $vHost\"\n\"http://$vHost:8080/manager/stop?path=$context&type=LIGHT\"\n", "id": 72492, "time": "2005-03-16T16:13:54Z", "creator": "lionel.farbos@free.fr", "creation_time": "2005-03-16T16:13:54Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 33967, "is_private": false, "text": "Created attachment 14498\nManagerServlet source\n\nrather than a diff, the ManagerServlet source", "id": 72524, "time": "2005-03-16T18:40:43Z", "creator": "lionel.farbos@free.fr", "creation_time": "2005-03-16T18:40:43Z", "attachment_id": 14498}, {"count": 4, "tags": [], "bug_id": 33967, "is_private": false, "text": "This patch will not be applied to the Tomcat code base.", "id": 129703, "time": "2009-08-15T11:22:17Z", "creator": "markt@apache.org", "creation_time": "2009-08-15T11:22:17Z", "attachment_id": null}]