[{"count": 0, "text": "The following JSP page will for some strange reason produce\na Content-Type header stating ISO-8859-1 (tested with Tomcat 4.1.24).\nHowever, if you remove the fmt:formatNumber from the end, it will\nproduce a header with UTF-8 (as expected)!\n\n<%@ page language=\"java\" %>\n<%@ taglib uri=\"http://java.sun.com/jstl/fmt\" prefix=\"fmt\" %>\n<%\nresponse.setContentType(\"text/html;charset=UTF-8\");\n%>\n<html>\n<head>\n<title>Test</title>\n</head>\n<body>\nTest <fmt:formatNumber value=\"1\" pattern=\"0\"/>\n</body>\n</html>", "bug_id": 19408, "is_private": false, "id": 36255, "time": "2003-04-29T02:13:29Z", "creator": "jpl@remotejava.com", "creation_time": "2003-04-29T02:13:29Z", "tags": [], "attachment_id": null}, {"count": 1, "tags": [], "creator": "pierre.delisle@sun.com", "attachment_id": null, "id": 39130, "time": "2003-06-19T23:49:57Z", "bug_id": 19408, "creation_time": "2003-06-19T23:49:57Z", "is_private": false, "text": "Good catch!\n\nHowever, this works fine in Tomcat 5 and therefore appears to be\na bug in Tomcat 4.1.24.\n\nPlease note that the servlet 2.4, JSP 2.0, and JSTL 1.1\nspecs have all clarified how response encoding should be handled,\nand it is not surprising that Tomcat 4 might not be behaving\nas one might expect.\n\nAt any rate, this is definitely not a bug in JSTL. \nThe fact that the formatting tag triggers a call to response.setLocale()\nshould not modify the response encoding if it has already been set\nexplicitely (as you do in your sample code).\n\nFor the record, here is how the spec has been clarified in JSTL 1.1:\n\n Section 8.4\n \n Any i18n action that establishes a localization context is responsible\n for setting the response's locale of its page, unless the localization\n context that was established does not have any locale. This is done by\n calling method ServletResponse.setLocale() with the locale of the\n localization context.   \n This assumes that the response is buffered with a big enough buffer\n size, since ServletResponse.setLocale() and\n ServletResponse.setContentType() must be called before\n ServletResponse.getWriter() in order for the specified locale or\n charset to affect the construction of the writer.(1)\n \n More specifically, the response's setLocale() method is always called\n by the <fmt:setLocale> action (see Section 8.5). In addition, it is\n called by the following actions:\n \n - Any <fmt:bundle> (see Section 8.6) and <fmt:setBundle> (see Section 8.7) action.\n - Any <fmt:message> action that establishes an i18n localization context\n - Any formatting action that establishes a formatting locale on its own (see\n   Section 9.3).\n\n ***** begin clarification *****\n\n The rules related to the setting of an HTTP response\n character encoding, Content-Language header, and Content-Type header  \n are clearly defined in the Servlet specification. To avoid any\n ambiguity, the JSTL and JSP\n specifications define behavior related to a response's locale and\n character encoding exclusively in terms of Servlet API calls.\n\n It is therefore important to note that, as defined in the Servlet spec,\n a call to ServletResponse.setLocale() modifies the character encoding  \n of the response only if it has not already been  set explicitely by calls \n to ServletResponse.setContentType() (with CHARSET specified) or \n ServletResponse.setCharacterEncoding().\n\n Page authors should consult the JSP specification to understand how  \n page directives related to locale and character encoding setting translate  \n into Servlet API calls, and how they impact the final response settings.\n\n ***** end clarification ***** \n"}, {"count": 2, "tags": [], "creator": "pierre.delisle@sun.com", "attachment_id": null, "id": 48953, "time": "2003-12-12T00:36:43Z", "bug_id": 19408, "creation_time": "2003-12-12T00:36:43Z", "is_private": false, "text": "*** Bug 23125 has been marked as a duplicate of this bug. ***"}, {"count": 3, "tags": [], "creator": "pierre.delisle@sun.com", "attachment_id": null, "id": 49038, "time": "2003-12-12T23:46:44Z", "bug_id": 19408, "creation_time": "2003-12-12T23:46:44Z", "is_private": false, "text": "*** Bug 25456 has been marked as a duplicate of this bug. ***"}]