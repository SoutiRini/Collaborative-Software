[{"count": 0, "tags": [], "bug_id": 59134, "text": "I have been trying to open a wss connection through a http proxy, and I always got the following exception:\n  ...\n  Caused by: javax.websocket.DeploymentException: The HTTP request to initiate the WebSocket connection failed\n  ...\n  Caused by: java.io.EOFException: null\n  ...\n\nLooking at network traffic shows that the proxy connect request is sent, proxy connection is established and then a plain GET request is sent instead of the SSL handshake.\n\nDebugging in the WsWebSocketContainer::connectToServer() shows that there is a secure flag, to indicate whether an SSL connection is needed, but it never gets true when the connection is through a proxy.\n\n\nhttp://svn.apache.org/repos/asf/tomcat/trunk/java/org/apache/tomcat/websocket/WsWebSocketContainer.java\n\npublic Session connectToServer(Endpoint endpoint,\n            ClientEndpointConfig clientEndpointConfiguration, URI path)\n            throws DeploymentException\n        ...\n        boolean secure = false\n\n        ...\n\n        if (sa == null) {\n            if (port == -1) {\n                if (\"ws\".equalsIgnoreCase(scheme)) {\n                    sa = new InetSocketAddress(host, 80);\n                } else {\n                    // Must be wss due to scheme validation above\n                    sa = new InetSocketAddress(host, 443);\n                    secure = true;\n                }\n            } else {\n                if (\"wss\".equalsIgnoreCase(scheme)) {\n                    secure = true;\n                }\n                sa = new InetSocketAddress(host, port);\n            }\n        } else {\n            proxyConnect = createProxyRequest(host, port);\n        }\n\n        ...", "id": 189192, "time": "2016-03-07T08:29:21Z", "creator": "zraetn@gmail.com", "creation_time": "2016-03-07T08:29:21Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "text": "Sounds like your (reverse?) proxy is switching from HTTPS top HTTP internally. Bugzilla is not a support forum. Please post a message to the users list with questions, and only reopen this issue if there is a bug discovered in Tomcat.", "id": 189218, "time": "2016-03-07T17:02:27Z", "bug_id": 59134, "creation_time": "2016-03-07T17:02:27Z", "is_private": false}, {"count": 2, "tags": [], "text": "The original report looks valid. secure is never set when using a proxy", "attachment_id": null, "id": 189220, "creator": "markt@apache.org", "time": "2016-03-07T17:15:05Z", "bug_id": 59134, "creation_time": "2016-03-07T17:15:05Z", "is_private": false}, {"count": 3, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "Thanks for the report. This has been fixed in 9.0.x for 9.0.0.M4 onwards, 8.0.x for 8.0.33 onwards and 7.0.x for 7.0.69 onwards.", "id": 189225, "time": "2016-03-07T19:46:01Z", "bug_id": 59134, "creation_time": "2016-03-07T19:46:01Z", "is_private": false}]