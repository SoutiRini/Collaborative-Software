[{"attachment_id": 28009, "tags": [], "bug_id": 52268, "is_private": false, "count": 0, "id": 151888, "time": "2011-12-01T10:01:18Z", "creator": "obidin@phystech.edu", "creation_time": "2011-12-01T10:01:18Z", "text": "Created attachment 28009\nPatch that solves problem with cloning sheet with images\n\nTC\nCreate \"in.xlsx\" file with sheet that contents images.\nTry to clone that sheet.\n\nCode:\nis = new BufferedInputStream(new FileInputStream(WORKING_DIR + \"in.xlsx\"));\nos = new BufferedOutputStream(new FileOutputStream(WORKING_DIR + \"out.xlsx\"));\nWorkbook workbook = WorkbookFactory.create(is);\n\nworkbook.cloneSheet(0);\n\nworkbook.write(os);\n\nOpen out.xlsx with Microsoft Office.\n\nER\nThere will be images on the cloned sheet.\n\nAR\nThere are no images on the cloned sheet.\n\n\nI found the problem that cause this bug and made patch that solve that problem (see the attachment)."}, {"count": 1, "tags": [], "bug_id": 52268, "attachment_id": 28010, "id": 151889, "time": "2011-12-01T10:02:28Z", "creator": "obidin@phystech.edu", "creation_time": "2011-12-01T10:02:28Z", "is_private": false, "text": "Created attachment 28010\nSample input file that produce bug"}, {"count": 2, "tags": [], "bug_id": 52268, "attachment_id": null, "id": 151890, "time": "2011-12-01T11:23:18Z", "creator": "apache@gagravarr.org", "creation_time": "2011-12-01T11:23:18Z", "is_private": false, "text": "Is it possible to write a unit test to check for the correct cloning?\n\nIdeally we'd want to do the check using a unit test, so we can automatically make sure it doesn't get broken in future. Checks which require loading into Excel tend not to get done very often, so it's generally safer to unit test it where possible!"}, {"count": 3, "attachment_id": null, "bug_id": 52268, "is_private": false, "id": 151893, "time": "2011-12-01T12:03:35Z", "creator": "obidin@phystech.edu", "creation_time": "2011-12-01T12:03:35Z", "tags": [], "text": "I could not find public api that get information about images on sheet. The only way is to comparison of sheet.xml, sheet.xml.rels, drawing.xml and drawing.xml.rels files by xmlbeans, but I think it is not good way for unit-tests.\n\nMay be in the future there will be frendly api for working with images on sheet, it would be possible to make good unit-tests."}, {"count": 4, "tags": [], "bug_id": 52268, "is_private": false, "text": "The patch looks OK, but I'm reluctant to apply it without a unit test. You are right - current implementation of XSSFDrawing  can't iterate over shapes, but this functionality should be easy to add. I recall that last time I was trying to do that I couldn't properly parse CTDrawing - it had something to do with XmlBeans and extra root element. \n\nNow I see that passing XmlOpetions with\n\noptions.setLoadReplaceDocumentElement(null); \n\ndoes the trick. Thanks for finding it! \n\nI plan to commit the patch in a few days.\n\nRegards,\nYegor", "id": 151971, "time": "2011-12-05T07:17:14Z", "creator": "yegor@dinom.ru", "creation_time": "2011-12-05T07:17:14Z", "attachment_id": null}, {"count": 5, "tags": [], "text": "Applied in r1211339 with some tweaks, junit added.\n\nRegards,\nYegor", "attachment_id": null, "id": 152043, "creation_time": "2011-12-07T08:52:58Z", "time": "2011-12-07T08:52:58Z", "creator": "yegor@dinom.ru", "bug_id": 52268, "is_private": false}]