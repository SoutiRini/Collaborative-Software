[{"count": 0, "tags": [], "bug_id": 24970, "attachment_id": null, "text": "A JSP-Page (or Servlet) like\n\n  <%\n    response.setContentType(\"application/pdf\");\n  %>\n  wurst\n\nresults in the Content-Type-Header\n  \n  Content-Type: application/pdf;charset=ISO-8859-1\n\nwhich is not allowed according to HTTP-RFCs. The charset may only be appended\nwhen the Content-Type is \"text/*\".\n\nIt causes bad behaviour with IE, that's this can be critical for some Servlets.", "id": 48089, "time": "2003-11-25T12:33:06Z", "creator": "sven.koehler@gmail.com", "creation_time": "2003-11-25T12:33:06Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 24970, "attachment_id": null, "id": 48090, "time": "2003-11-25T12:55:36Z", "creator": "funkman@joedog.org", "creation_time": "2003-11-25T12:55:36Z", "is_private": false, "text": "Already fixed, can't find the commit message but this is close:\n\nhttp://marc.theaimsgroup.com/?l=tomcat-dev&m=106870694029743&w=2"}, {"count": 2, "tags": [], "bug_id": 24970, "text": "when can i expect the next tomcat 4.1 release?", "id": 48092, "attachment_id": null, "creator": "sven.koehler@gmail.com", "creation_time": "2003-11-25T12:59:32Z", "time": "2003-11-25T12:59:32Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 24970, "is_private": false, "count": 3, "id": 48094, "time": "2003-11-25T13:21:22Z", "creator": "funkman@joedog.org", "creation_time": "2003-11-25T13:21:22Z", "text": "http://jakarta.apache.org/tomcat/faq/version.html#when"}, {"attachment_id": null, "tags": [], "bug_id": 24970, "is_private": false, "count": 4, "id": 48109, "time": "2003-11-25T17:58:03Z", "creator": "sven.koehler@gmail.com", "creation_time": "2003-11-25T17:58:03Z", "text": "OK, i tried ...\n\nWell, can you point me at the code/class which needs a fix?\nI would have downgrade Tomcat, but i'd like keep 4.1.29 and patch it."}, {"count": 5, "tags": [], "bug_id": 24970, "attachment_id": null, "text": "Here's the patch.\n\nIndex: Response.java\n===================================================================\nRCS file:\n/home/cvs/jakarta-tomcat-connectors/coyote/src/java/org/apache/coyote/Response.java,v\nretrieving revision 1.29\nretrieving revision 1.31\ndiff -r1.29 -r1.31\n157a158,161\n>     /**\n>      * Has the charset been explicitly set.\n>      */\n>     protected boolean charsetSet = false;\n323a328\n>         charsetSet = false;\n473c478,479\n< \tcharacterEncoding = charset;\n---\n>         characterEncoding = charset;\n>         charsetSet=true;\n545a552\n>             charsetSet=true;\n555,557c562,565\n<         if (ret != null && characterEncoding != null) {\n<             ret += \";charset=\";\n<             ret += characterEncoding;\n---\n>         if (ret != null \n>             && characterEncoding != null\n>             && charsetSet) {\n>             ret = ret + \";charset=\" + characterEncoding;\n589a598\n>         charsetSet = false;\n", "id": 48110, "time": "2003-11-25T18:16:12Z", "creator": "remm@apache.org", "creation_time": "2003-11-25T18:16:12Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 24970, "text": "*** Bug 24996 has been marked as a duplicate of this bug. ***", "count": 6, "id": 48130, "time": "2003-11-26T00:12:45Z", "creator": "funkman@joedog.org", "creation_time": "2003-11-26T00:12:45Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 24970, "text": "Created attachment 9309\nput it in server/lib/tomcat-coyote.jar to solve this bug", "id": 48182, "attachment_id": 9309, "creator": "sven.koehler@gmail.com", "creation_time": "2003-11-26T19:35:04Z", "time": "2003-11-26T19:35:04Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 24970, "text": "The attachement i just uploaded is an updated Response.class build by patching\ntomcat 4.1.29 with the patch supplied by Tim Funk", "id": 48184, "attachment_id": null, "creator": "sven.koehler@gmail.com", "creation_time": "2003-11-26T19:36:01Z", "time": "2003-11-26T19:36:01Z", "is_private": false}, {"count": 9, "tags": [], "creator": "robert@emaxx.nl", "text": "I've some download problems with the attachment. Can you please provide the \npatch again or mail it to me directly?\n\nThanks!", "id": 48278, "attachment_id": null, "bug_id": 24970, "creation_time": "2003-11-28T10:49:49Z", "time": "2003-11-28T10:49:49Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 24970, "text": "*** Bug 25109 has been marked as a duplicate of this bug. ***", "id": 48342, "time": "2003-12-01T15:00:38Z", "creator": "remm@apache.org", "creation_time": "2003-12-01T15:00:38Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "bug_id": 24970, "text": "It's a shame, that Tomcat-people are unable to release a simple \"hotfix\".\nI guess most people will agree. Pointing me to the FAQ where it says:\n\"When will the next version be released? When it is ready.\" is an impertinence.", "id": 48344, "attachment_id": null, "creator": "sven.koehler@gmail.com", "creation_time": "2003-12-01T15:26:51Z", "time": "2003-12-01T15:26:51Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 24970, "text": "*** Bug 25162 has been marked as a duplicate of this bug. ***", "count": 12, "id": 48417, "time": "2003-12-03T13:27:16Z", "creator": "funkman@joedog.org", "creation_time": "2003-12-03T13:27:16Z", "is_private": false}, {"count": 13, "tags": [], "creator": "funkman@joedog.org", "is_private": false, "text": "*(BIG trusting assumption: the attachment is a valid file for Response.class)*\n\nIf one wishes to get a hotfix without compiling the fix themself ...\n\nTake the attachment 9309 in this bug report and save it as Response.class.\n\nThen move Response.class (creating the approprite dirs) to \n{TOMCAT INSTALL}/server/classes/org/apache/coyote/Response.class", "id": 49429, "time": "2003-12-19T13:39:36Z", "bug_id": 24970, "creation_time": "2003-12-19T13:39:36Z", "attachment_id": null}, {"count": 14, "tags": [], "creator": "funkman@joedog.org", "text": "*** Bug 25729 has been marked as a duplicate of this bug. ***", "id": 49618, "time": "2003-12-23T16:44:13Z", "bug_id": 24970, "creation_time": "2003-12-23T16:44:13Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "bug_id": 24970, "attachment_id": null, "id": 49653, "time": "2003-12-24T00:33:33Z", "creator": "tirta@fisherman.greenweed.us", "creation_time": "2003-12-24T00:33:33Z", "is_private": false, "text": "Hi,\n\nTry this patch, it doesnt work:\n\nStill encountered the garbage character everytime I open the link with .xls \nfile instead of using excel to open the link. This doesnt happen with 4.1.27\n\n\n-bash-2.05b$ md5 Response.class                                             \nMD5 (Response.class) = 0f47f349c673414045b68d2f5aca430a                     \n-bash-2.05b$ pwd                                                            \n/home/www/tomcat/server/classes/org/apache/coyote                           \n-bash-2.05b$ ls -l Response.class                                           \n-rw-r--r--    1 www      www          8853 Jan 28 08:18 Response.class      \n"}, {"count": 16, "tags": [], "bug_id": 24970, "text": "Well, i modified my tomcat-coyote.jar. i don't know if putting Response.class in\nthe class-folder helps. To copy Response.class over the file in\ntomcat-coyote.jar you can use WinRAR or WinZIP or any other tool.\n\nOf course i cannot convince people to trust me, but i can assure you that i'm\nnot an evil person. The patch is used by me in a productive system and i haven't\nhad any problems yet.", "id": 49655, "attachment_id": null, "creator": "sven.koehler@gmail.com", "creation_time": "2003-12-24T01:17:11Z", "time": "2003-12-24T01:17:11Z", "is_private": false}, {"count": 17, "tags": [], "text": "Even if you cannot make a binary patch work, you shouldn't reopen this issue, as\nthe bug has been fixed in CVS.", "is_private": false, "bug_id": 24970, "id": 49658, "time": "2003-12-24T06:01:14Z", "creator": "remm@apache.org", "creation_time": "2003-12-24T06:01:14Z", "attachment_id": null}, {"count": 18, "tags": [], "text": "Sorry Remy, Sven,\n\nLearn my lesson. Will not make the same mistake again by reopening the case.\n\nI will try again, even though actually I've tried to put it into the jar files, \n(*still doesnt work*), but i will check it again after this.", "attachment_id": null, "bug_id": 24970, "id": 49669, "time": "2003-12-24T14:00:55Z", "creator": "tirta@fisherman.greenweed.us", "creation_time": "2003-12-24T14:00:55Z", "is_private": false}, {"count": 19, "tags": [], "creator": "funkman@joedog.org", "is_private": false, "text": "*** Bug 26418 has been marked as a duplicate of this bug. ***", "id": 51154, "time": "2004-01-25T18:27:51Z", "bug_id": 24970, "creation_time": "2004-01-25T18:27:51Z", "attachment_id": null}, {"count": 20, "tags": [], "text": "This is still a bug. I have tested it with 4.1.30.\nFor images is it fixed.", "is_private": false, "bug_id": 24970, "id": 51710, "time": "2004-02-04T16:20:43Z", "creator": "sander@list.eo.nl", "creation_time": "2004-02-04T16:20:43Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 24970, "is_private": false, "count": 21, "id": 51712, "time": "2004-02-04T16:30:02Z", "creator": "remm@apache.org", "creation_time": "2004-02-04T16:30:02Z", "text": "How about posting a test case, or, even better, use tomcat-user to resolve this\nissue ? It is almost certain that you are doing something wrong."}, {"count": 22, "tags": [], "bug_id": 24970, "attachment_id": null, "id": 60211, "time": "2004-07-06T20:38:48Z", "creator": "paul.brohman@viasafe.com", "creation_time": "2004-07-06T20:38:48Z", "is_private": false, "text": "I noticed that this bug is marked as resolved, but i'm not sure it is. I came \nacross this situation today when setting the content type to \"application/pdf\".\n\nwhen i viewed the compiled code i noticed this being set by tomcat:\n\nresponse.setContentType(\"application/pdf;charset=ISO-8859-1\"); \n\nI set the content type to \"application/pdf\", but i didn't add the charset. \nTomcat seems to be setting the charset to the default when a content type is \nspecified. In the case of \"application/pdf\" setting the charset won't work with \nAdobe Reader 6.0, 6.01, and 6.0.2.\n\nViewing the headers with HTTPWatch, i'm able to see that the content type \nis \"application/pdf;charset=ISO-8859-1\" even though i just set \"application/pdf\"\n\nCould someone please let me know if this is still a bug."}, {"count": 23, "tags": [], "bug_id": 24970, "attachment_id": null, "id": 61372, "time": "2004-07-30T13:11:06Z", "creator": "frederic.surleau@atosorigin.com", "creation_time": "2004-07-30T13:11:06Z", "is_private": false, "text": "I agree with Paul Brohman, the bug is still present in 4.1.30.\n\nresponse.setContentType( \"application/pdf\" );\ngives Content-Type: application/pdf;charset=ISO-8859-1\n\nI've tried with Response.class from attachment 9309 first in {TOMCAT\nINSTALL}/server/classes/org/apache/coyote/Response.class and then by replacing\nResponse.class in tomcat-coyote.jar with the same result.\n\nSo I looked the source of Response.java and found in setContentType :\n\nif (!hasCharset) {\n\tthis.contentType = type;\n\treturn;\n}\n\nIn the other case (if hasCharset is true), and if charsetValue is valid, then\ncharsetSet is set to true.\n\nThe problem is the folowing :\n- I'm using J2EE 1.3 so the method setCharacterEncoding() can't be used.\n- When compiling a JSP, tomcat adds automaticaly\nresponse.setContentType(\"text/html;charset=ISO-8859-1\"); in the _jsp.java file.\n\nDoing this, charsetSet is set to true in response and characterEncoding is set\nto ISO-8859-1.\n\nThen my own code says :\nresponse.setContentType( \"application/pdf\" );\nBut in this case, charsetSet is NOT reset to false, and characterEncoding keeps\nit's old value.\n\nI think the above code should almost be :\nif (!hasCharset) {\n\tthis.contentType = type;\n\tcharsetSet=false;\n\treturn;\n}\n\nOr charsetSet should be set to false at the begining of setContentType;\n\nBut this means for those who can use setCharacterEncoding(), to use it AFTER\nsetContentType();\n\nSo to completely fix the problem, I think that setCharacterEncoding() should set\na special boolean and setContentType() another one.\n\nThen getContentType() should append the charset expression to Content-Type if\none the the two boolean is true.\n\nIn this case we will have the folowing results :\n\n\tresponse.setCharacterEncoding( \"ISO-8859-1\" );\n\tresponse.setContentType( \"application/pdf\" );\n\tresponse.getContentType(  ) -> Content-Type: application/pdf;charset=ISO-8859-1;\n\n\tresponse.setCharacterEncoding( \"ISO-8859-1\" );\n\tresponse.setContentType( \"plain/text;charset=UTF-8\" );\n\tresponse.getContentType(  ) -> Content-Type: plain/text;charset=UTF-8;\n\n\tresponse.setContentType( \"plain/text;charset=UTF-8\" );\n\tresponse.setCharacterEncoding( \"ISO-8859-1\" );\n\tresponse.getContentType(  ) -> Content-Type: plain/text;ISO-8859-1;\n\n\tresponse.setContentType(\"text/html;charset=ISO-8859-1\");\n\tresponse.setContentType( \"application/pdf\" );\n\tresponse.getContentType(  ) -> Content-Type: application/pdf\n\n\n\nNevertheless waiting for the bug to be fixed, a workaround is to use the reset()\nmethod who sets charsetSet to false.\n\n\tresponse.reset();\n\tresponse.addHeader( \"Content-Disposition\", \"inline; filename=\\\"\" + strFileName\n+ \"\\\"\" ) ;\n\tresponse.setContentType( \"application/pdf\" );\n\tresponse.setContentLength(data.length);\n\tresponse.getOutputStream().write( data ) ;\n\tresponse.getOutputStream().close() ;\n\nRegards"}, {"count": 24, "tags": [], "text": "The servlet spec expert group has decided that all Servlets that use a Writer \n(and this includes all JSPs) must include a charset in the 2.4 servlet spec.  \nSince Tomcat 4 uses the same connectors as Tomcat 5, and Tomcat 5 must set the \ncharset, this will certainly not be fixed.\n\nI'm glad to see that you've discovered that you can work around this with \nresponse.reset.  That is the only way that sending pdfs from a JSP is supported.", "is_private": false, "bug_id": 24970, "id": 61383, "time": "2004-07-30T14:44:01Z", "creator": "william.barker@wilshire.com", "creation_time": "2004-07-30T14:44:01Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 24970, "is_private": false, "count": 25, "id": 61436, "time": "2004-08-02T08:14:32Z", "creator": "frederic.surleau@atosorigin.com", "creation_time": "2004-08-02T08:14:32Z", "text": "OK, I read the \"JavaServer Pages Specification\" and it's clear that JSPs are\nservlets only designed to send TEXT data.\n\nTrying to send a PDF or other binary data via a JSP should not be done.\nA servlet should be written for this kind of things.\n\nThe workaroud 'response.reset()' should not be used in a production environment.\nIt works with the actual Coyote implementation, but nothing can guarantee that\nothers implementation will accept it.\nIn facts, the getOutputStream() method should not be allowed in a JSP.\n\nThe getWriter() method should be called() as soon as possible in the generated\njava code of the JSP. Then a call to getOutputStream() would result in a\nIllegalStateException.\n\nRegards"}, {"count": 26, "tags": [], "text": "*** Bug 32499 has been marked as a duplicate of this bug. ***", "attachment_id": null, "bug_id": 24970, "id": 67816, "time": "2004-12-02T20:21:34Z", "creator": "william.barker@wilshire.com", "creation_time": "2004-12-02T20:21:34Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 24970, "is_private": false, "count": 27, "id": 69682, "time": "2005-01-14T15:08:36Z", "creator": "funkman@joedog.org", "creation_time": "2005-01-14T15:08:36Z", "text": "*** Bug 33099 has been marked as a duplicate of this bug. ***"}, {"count": 28, "tags": [], "creator": "tomasz.bech@bull.com.pl", "is_private": false, "text": "are you sure Bug 33099 is duplication if this bug?!?", "id": 69684, "time": "2005-01-14T15:30:44Z", "bug_id": 24970, "creation_time": "2005-01-14T15:30:44Z", "attachment_id": null}, {"count": 29, "tags": [], "bug_id": 24970, "attachment_id": null, "id": 71360, "time": "2005-02-22T17:25:27Z", "creator": "Michiel.Meeuwissen@gmail.com", "creation_time": "2005-02-22T17:25:27Z", "is_private": false, "text": "(In reply to comment #25)\n> OK, I read the \"JavaServer Pages Specification\" and it's clear that JSPs are\n> servlets only designed to send TEXT data.\n\nI agree that one should not send pdf with a JSP. But how about\n\"text/vnd.rn-realtext\". Of course it is silly that Real-Player chokes in the\ncharset, but well, it does.\n\nSo I woudl really like to have some possibility to dynamically create .rt files,\nin which realplayer does not choke.\n\nMichiel\n "}, {"count": 30, "tags": [], "creator": "Michiel.Meeuwissen@gmail.com", "text": "I have a work-around in the form of a Filter. This filter uses a ResponseWrapper\nto wrap getWriter:\n\n public void doFilter(ServletRequest servletRequest, ServletResponse\nservletResponse, FilterChain filterChain) \n        throws java.io.IOException, ServletException {\n\n        HttpServletResponseWrapper wrapper = new\nHttpServletResponseWrapper((HttpServletResponse) servletResponse) {\n                private String contentType;\n                public void setContentType(String ct) {\n                    contentType = ct;\n                    super.setContentType(ct);\n                }\n\n                /**\n                 * This is the essence of this whole thing. The idea\n                 * is to fake the use of getOutputStream(). Then you\n                 * are in byte-writing mode.  and charset's become\n                 * irrelevant,and tomcat will not add one any more.\n                 */\n                \n                public PrintWriter getWriter() throws IOException {\n                    if (contentTypes.contains(contentType)) {\n                        log.debug(\"Wrapping outputstream to avoid charset\");\n                        try {\n                            // ISO-8859-1 is default for HTTP\n                            return new PrintWriter(new BufferedWriter(new\nOutputStreamWriter(getOutputStream(), \"ISO-8859-1\")));\n                        } catch (UnsupportedEncodingException uee) {\n                            // could not happen\n                            return super.getWriter();\n                        }\n                    } else {\n                        if (log.isDebugEnabled()) {\n                            log.debug(\" \" + contentType + \" is not contained by\n\" + contentTypes);\n                        }\n                        return super.getWriter();\n                    }\n                }\n        };\n        filterChain.doFilter(servletRequest, wrapper);\n        \n    }\n\n\nSo, you can configure a set of contentypes for which no charset is added and\nwhich therefore must be in ISO-8859-1.\n\n", "id": 71836, "time": "2005-03-04T16:37:21Z", "bug_id": 24970, "creation_time": "2005-03-04T16:37:21Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 24970, "is_private": false, "count": 31, "id": 102181, "time": "2007-04-23T17:22:15Z", "creator": "remm@apache.org", "creation_time": "2007-04-23T17:22:15Z", "text": "*** Bug 32499 has been marked as a duplicate of this bug. ***"}]