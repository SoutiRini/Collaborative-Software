[{"count": 0, "tags": [], "bug_id": 57749, "attachment_id": 32602, "text": "Created attachment 32602\nTEST-org.apache.catalina.nonblocking.TestNonBlockingAPI.NIO2.txt\n\nTesting 8.0.21 (release candidate), the following test failed:\n\nTEST-org.apache.catalina.nonblocking.TestNonBlockingAPI.NIO2.txt\n-> testNonBlockingWrite\n\nTestcase: testNonBlockingWrite took 7,925 sec\n\tCaused an ERROR\nConnection reset\njava.net.SocketException: Connection reset\n\tat java.net.SocketInputStream.read(SocketInputStream.java:189)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:121)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:107)\n\tat org.apache.catalina.nonblocking.TestNonBlockingAPI.testNonBlockingWrite(TestNonBlockingAPI.java:156)\n\n\nLooking into the junit log, there was an NPE in InternalNio2OutputBuffer:\n\n[[[\norg.apache.catalina.nonblocking.TestNonBlockingAPI$NBWriteServlet$1 onComplete\nINFO: onComplete\nException in thread \"http-nio2-127.0.0.1-auto-5-exec-4\" java.lang.NullPointerException\n\tat org.apache.coyote.http11.InternalNio2OutputBuffer$2.failed(InternalNio2OutputBuffer.java:205)\n\tat org.apache.coyote.http11.InternalNio2OutputBuffer$2.failed(InternalNio2OutputBuffer.java:165)\n\tat sun.nio.ch.Invoker.invokeUnchecked(Invoker.java:128)\n\tat sun.nio.ch.Invoker$2.run(Invoker.java:218)\n\tat sun.nio.ch.AsynchronousChannelGroupImpl$1.run(AsynchronousChannelGroupImpl.java:112)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n\tat java.lang.Thread.run(Thread.java:745)\n]]]\n\nThose lines:\n\n            @Override\n            public void failed(Throwable exc, ByteBuffer[] attachment) {\n205:             socket.setError(true);\n\nSo apparently socket is null.\n\n\nAll other tests (all 4 connectors) have passed successfully.\nSummary:\n\n[[[\ntest:\n   [concat] Testsuites with skipped tests:\n   [concat] TEST-org.apache.catalina.comet.TestCometProcessor.BIO.txt\n   [concat] TEST-org.apache.catalina.connector.TestRequest.APR.txt\n   [concat] TEST-org.apache.catalina.connector.TestRequest.BIO.txt\n   [concat] TEST-org.apache.catalina.connector.TestRequest.NIO.txt\n   [concat] TEST-org.apache.catalina.connector.TestRequest.NIO2.txt\n   [concat] TEST-org.apache.catalina.nonblocking.TestNonBlockingAPI.BIO.txt\n   [concat] TEST-org.apache.tomcat.util.net.TestClientCert.APR.txt\n   [concat] TEST-org.apache.tomcat.util.net.TestClientCert.NIO.txt\n   [concat] TEST-org.apache.tomcat.util.net.TestCustomSsl.APR.txt\n   [concat] TEST-org.apache.tomcat.util.net.TestCustomSsl.NIO.txt\n   [concat] TEST-org.apache.tomcat.util.net.TestSsl.APR.txt\n   [concat] TEST-org.apache.tomcat.util.net.TestSsl.NIO.txt\n   [concat] TEST-org.apache.tomcat.websocket.TestWebSocketFrameClientSSL.BIO.txt\n   [concat] TEST-org.apache.tomcat.websocket.TestWsWebSocketContainer.BIO.txt\n   [concat] Testsuites with failed tests:\n   [concat] TEST-org.apache.catalina.nonblocking.TestNonBlockingAPI.NIO2.txt\n]]]\n\nI am using JDK 8u31 (32-bit) on Windows 7, and testing with\n\ntest.accesslog=true\n\n\nI am attaching TEST-org.apache.catalina.nonblocking.TestNonBlockingAPI.NIO2.txt file. I converted the file from my local code page into UTF-8.", "id": 182048, "time": "2015-03-24T11:32:43Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-03-24T11:32:43Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 57749, "text": "I did 20 re-runs of org.apache.catalina.nonblocking.TestNonBlockingAPI * (4 connectors), and the issue did not reproduce itself.\n\nNo tests failed, no NullPointerException happened.", "id": 182051, "time": "2015-03-24T12:28:04Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-03-24T12:28:04Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 57749, "text": "That was going to be my first question - how easy is this to reproduce.\n\nI took a quick look at the code. The only way the socket could be null is if the output buffer had been recycled. That would be triggered by a socket close or the end of the request/response.\n\nSeeing that the issue happened after the write completed, I wonder if this is the result of the socket being closed on the input side. It would help to know what the exception was. I think some additional logging is called to start with.", "id": 182054, "time": "2015-03-24T12:51:42Z", "creator": "markt@apache.org", "creation_time": "2015-03-24T12:51:42Z", "is_private": false, "attachment_id": null}, {"count": 3, "attachment_id": null, "creator": "markt@apache.org", "is_private": false, "id": 182056, "time": "2015-03-24T13:06:07Z", "bug_id": 57749, "creation_time": "2015-03-24T13:06:07Z", "tags": [], "text": "I've added some logging and I'll set the TestNonBlockingAPI test running in a loop for NIO2 until it fails."}, {"count": 4, "tags": [], "bug_id": 57749, "text": "Created attachment 32607\nTEST-org.apache.catalina.nonblocking.TestNonBlockingAPI.NIO2.txt\n\nReproduced.\n\nThis is Tomcat 8 @r1668995. I am running with JDK 7u76 (instead of JDK 8 that I used when I encountered the issue for the first time). This happened once out or 30 runs.\n\nBTW, access log is the same both in successful and in failing case (with the same 200/200/500/500/200 result codes and the same amounts of response bytes)\n\nI converted the log file from local code page into UTF-8.", "id": 182076, "time": "2015-03-25T00:02:14Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-03-25T00:02:14Z", "is_private": false, "attachment_id": 32607}, {"count": 5, "tags": [], "bug_id": 57749, "text": "Created attachment 32608\naccess_log.2015-03-25\n\nAccess log file for the failed test.\n\nAs I mentioned earlier, I am using\ntest.accesslog=true", "id": 182077, "time": "2015-03-25T00:03:33Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-03-25T00:03:33Z", "is_private": false, "attachment_id": 32608}, {"count": 6, "tags": [], "bug_id": 57749, "text": "IMO, the logging level should be debug, there are other places where the socket is checked for null due to possible concurrent close and there's no logging at all.", "id": 182114, "time": "2015-03-26T09:33:34Z", "creator": "remm@apache.org", "creation_time": "2015-03-26T09:33:34Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "I opted for WARN until we were more sure what the root cause was. If it is concurrent close then no objections to making it debug.", "id": 182116, "time": "2015-03-26T11:06:28Z", "bug_id": 57749, "creation_time": "2015-03-26T11:06:28Z", "is_private": false}, {"count": 8, "attachment_id": null, "creator": "markt@apache.org", "is_private": false, "id": 182559, "time": "2015-04-22T14:37:58Z", "bug_id": 57749, "creation_time": "2015-04-22T14:37:58Z", "tags": [], "text": "Remy has made some changes and I was unable to repeat this with 8.0.x trunk in 80 repetitions. I am therefore going to assume that this is fixed."}]