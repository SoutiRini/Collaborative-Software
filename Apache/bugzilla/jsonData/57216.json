[{"count": 0, "tags": [], "creator": "tomcatuser2008@gmail.com", "text": "We have a servlet filter which creates a RequestDispatcher used to forward the request to a servlet:\n\n  String processingPath = processPath(req.getServletPath());\n  RequestDispatcher dispatch = request.getRequestDispatcher(processingPath);\n  dispatch.forward(request, response);\n\nIn Tomcat 8 the forward() fails because the servlet path doesn't match the servlet mapping definition.  This only occurs when the context path is \"/\".\n\nWe configure our Context in server.xml:\n\n<Host name=\"localhost\"  appBase=\"\" createDirs=\"false\" unpackWARs=\"false\" autoDeploy=\"false\" deployOnStartup=\"false\">\n  <Context path=\"/\" ...>\n    ...\n  </Context>\n</Host>\n\nIn ApplicationContext.getRequestDispatcher(String path) the context path is prepended to the resource uri:\n\n  uriCC.append(context.getPath(), 0, context.getPath().length());\n\nThen in Mapper.map() a ContextVersion is retrieved from contextObjectToContextVersionMap and passed to internalMapWrapper(), which tries to remove the context path:\n\n  int length = contextVersion.path.length();\n    ...\n  servletPath = pathOffset + length;\n    ...\n  path.setOffset(servletPath);\n\nBut the path is empty, so the offset is zero, and we end up with an extra \"/\" at the start of the servlet path. This causes the servlet mapping to not be matched.\n\nThis is ultimately due to these lines in MapperListener.registerContext():\n\n        String contextPath = context.getPath();\n        if (\"/\".equals(contextPath)) {\n            contextPath = \"\";\n        }\n\n        mapper.addContextVersion(host.getName(), host, contextPath,\n                context.getWebappVersion(), context, welcomeFiles, resources,\n                wrappers);\n\nIn earlier Tomcat versions, the same context object was used to get the context path in both ApplicationContext.getRequestDispatcher() and Mapper.map().  In Tomcat 8 ApplicationContext.getRequestDispatcher() uses a StandardContext object (with path=\"/\"), while Mapper.map() uses a ContextVersion object (with path=\"\").", "id": 179108, "time": "2014-11-14T23:40:16Z", "bug_id": 57216, "creation_time": "2014-11-14T23:40:16Z", "is_private": false, "attachment_id": null}, {"count": 1, "text": "(In reply to tomcatuser2008 from comment #0)\n\n> We configure our Context in server.xml:\n\nPretty much always a bad idea.\n\n> <Host name=\"localhost\"  appBase=\"\" createDirs=\"false\" unpackWARs=\"false\"\n\nAn empty appBase is asking for trouble.\n\n>   <Context path=\"/\" ...>\n\nThis is an invalid path setting.  To quote from section 3.5 of the servlet spec:\n\nContext Path: The path prefix associated with the ServletContext that this Servlet is a part of. If this context is the \"default\" context rooted at the base of the Web server's URL name space, this path will be an empty string. Otherwise, if the context is not rooted at the root of the server's name space, the path starts with a / character but does not end with a / character.\n\nYou need to correct your configuration.  The fact that something useful happened in prior versions is an accident.", "bug_id": 57216, "is_private": false, "id": 179117, "time": "2014-11-15T14:19:27Z", "creator": "chuck.caldarale@unisys.com", "creation_time": "2014-11-15T14:19:27Z", "tags": [], "attachment_id": null}, {"count": 2, "text": "Context path values of \"/\" are now logged as invalid and converted to \"\".", "bug_id": 57216, "is_private": false, "id": 179155, "time": "2014-11-17T08:09:33Z", "creator": "markt@apache.org", "creation_time": "2014-11-17T08:09:33Z", "tags": [], "attachment_id": null}, {"count": 3, "tags": [], "text": "I backported the path checks to Tomcat 7 (r1640351).\nIt will be in 7.0.58 onwards.", "attachment_id": null, "bug_id": 57216, "id": 179169, "time": "2014-11-18T14:43:52Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-11-18T14:43:52Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 57216, "attachment_id": null, "text": "For a record:\nThe check and correction of context paths originates from r1080714 in 7.0.12 (3 years ago). Thus the fix was backported to Tomcat 7 as well.", "id": 179170, "time": "2014-11-18T14:53:42Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-11-18T14:53:42Z", "is_private": false}, {"count": 5, "tags": [], "text": "Thanks for your prompt responses.  We'll change our config to <Context path=\"\" ...>.", "is_private": false, "bug_id": 57216, "id": 179198, "time": "2014-11-20T01:21:46Z", "creator": "tomcatuser2008@gmail.com", "creation_time": "2014-11-20T01:21:46Z", "attachment_id": null}]