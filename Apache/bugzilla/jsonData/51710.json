[{"count": 0, "tags": [], "creator": "antti.koskimaki@joinex.com", "text": "Created attachment 27425\nExcel plus unit-test\n\nI came across to situation where XSSFCell.getCellFormula() returned incorrect results. Excel-file is created with Excel-2007. \n\nTested on r1160172. Attached test-excel plus unit-test.", "id": 148785, "time": "2011-08-23T15:34:33Z", "bug_id": 51710, "creation_time": "2011-08-23T15:34:33Z", "is_private": false, "attachment_id": 27425}, {"count": 1, "tags": [], "bug_id": 51710, "text": "Does your file use shared formulas that don't start on the first cell by any chance? (There's a current discussion on the dev list about those)", "id": 148787, "time": "2011-08-23T15:51:06Z", "creator": "apache@gagravarr.org", "creation_time": "2011-08-23T15:51:06Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 51710, "text": "You ment this discussion ?\n\nhttp://apache-poi.1045710.n5.nabble.com/Excel-formula-oddness-td4680643.html \n\nYes, this seems to relate to the same issue. First of all, as far as I can recall, I created the example file with simple routine; first made one formula with \"semi-static\" references, then copied it from left to right for a total row, then copy for row, paste for area downwards. So the use case is \"shared formula\" case.\n\nI looked into sheet1.xml, and there is this weird syntax in the exact cell where the problem starts to show, E60. Until that, the row 60 is OK with si=\"2\" but ref-field in E60 is weird no matter how you think, and then for every cell with si=\"3\" POI returns incorrect formula.\n\n---8<---------\n\n<row r=\"60\" spans=\"1:13\">\n<c r=\"A60\" s=\"1\">\n<v>58</v>\n</c>\n<c r=\"B60\">\n<f t=\"shared\" si=\"2\"/>\n<v>580</v>\n</c>\n<c r=\"C60\">\n<f t=\"shared\" si=\"2\"/>\n<v>580</v>\n</c>\n<c r=\"D60\">\n<f t=\"shared\" si=\"2\"/>\n<v>580</v>\n</c>\n<c r=\"E60\">\n<f t=\"shared\" ref=\"C60:M83\" si=\"3\">$A60*E$2</f>\n<v>580</v>\n</c>\n<c r=\"F60\">\n<f t=\"shared\" si=\"3\"/>\n<v>580</v>\n</c>\n<c r=\"G60\">\n<f t=\"shared\" si=\"3\"/>\n<v>580</v>\n</c>", "id": 148790, "time": "2011-08-23T19:13:47Z", "creator": "antti.koskimaki@joinex.com", "creation_time": "2011-08-23T19:13:47Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 51710, "attachment_id": null, "text": "I stared the xml for a while and then noticed, that only thing that doesn't make sense is \"ref\" attribute of formula. The declared shared formula is always correct relative to the containing cell. The ref-attribute on the other hand is almost random, and does not in any way reflect to the formula copying process. What it seems to define is boundaries where the shared instance is in use.\n\nWhen I count the references, it appears that there's familiar magic numbers involved :=)\n\n 176 si=\"0\"\n 255 si=\"1\"\n 255 si=\"2\"\n 255 si=\"3\"\n  64 si=\"4\"\n 255 si=\"5\"\n 255 si=\"6\"\n  64 si=\"7\"\n..\n\nSo, it seems to me that \nA) one formula \"instance\" is shared maximum 255 times\nB) distribution of these shared instances is somewhat random (mystical optimization?)\nC) ref-attribute really does only define the \"boundaries\", nothing else\n\nI also peeked the POI code, and found out that there's calculations on ss-level. It raised a question if HSSF-heritage is misleading the XSSF-implementation here ?\n\nP.S. document that made me understand this shared-thing:  http://www.codeproject.com/KB/XML/ooxml_is_defective.aspx (see chapter 3)", "id": 148792, "time": "2011-08-23T20:52:18Z", "creator": "antti.koskimaki@joinex.com", "creation_time": "2011-08-23T20:52:18Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 51710, "is_private": false, "text": "Created attachment 27427\nsheet1.xml in readable form\n\nAttached the sheet1.xml (from example xlsx) in readable form (with linefeeds etc)", "id": 148793, "time": "2011-08-23T20:54:15Z", "creator": "antti.koskimaki@joinex.com", "creation_time": "2011-08-23T20:54:15Z", "attachment_id": 27427}, {"count": 5, "tags": [], "text": "Created attachment 28391\ngraphical explanation of the problem", "is_private": false, "id": 154281, "creator": "yegor@dinom.ru", "time": "2012-02-27T12:14:00Z", "bug_id": 51710, "creation_time": "2012-02-27T12:14:00Z", "attachment_id": 28391}, {"count": 6, "tags": [], "text": "Created attachment 28392\ngraphical explanation of the problem", "is_private": false, "id": 154282, "creator": "yegor@dinom.ru", "time": "2012-02-27T12:19:25Z", "bug_id": 51710, "creation_time": "2012-02-27T12:19:25Z", "attachment_id": 28392}, {"attachment_id": null, "tags": [], "creator": "yegor@dinom.ru", "is_private": false, "count": 7, "id": 154283, "time": "2012-02-27T12:21:19Z", "bug_id": 51710, "creation_time": "2012-02-27T12:21:19Z", "text": "Should be fixed in r1294127, your test file included in the POI test collection.\n\nIt appeares that if a shared formula range preceeds its master cell then the preceding part is discarded.\nFor example, if the cell is E60 and the shared formula range is C60:M85 then the effective range is E60:M85 and the part C60:M85 is ignored. \n\nSee the graphical explanation of the issue.\n\nRegards,\nYegor"}]