[{"count": 0, "tags": [], "bug_id": 48735, "is_private": false, "text": "I noticed that, after a failed worker has recovered, no request is fowarded to it although it is marked as OK in balancer-manager :\nLoad Balancer Manager for www.europarldv.ep.ec\nServer Version: Apache/2.2.12 (Unix) DAV/2 mod_ssl/2.2.12 OpenSSL/0.9.8e\nServer Built: Aug 5 2009 12:54:36\n\n--------------------------------------------------------------------------------\n\nLoadBalancer Status for balancer://websdi\nStickySession Timeout FailoverAttempts Method\nJSESSIONID|jsessionid 0 1 bybusyness\n\nWorker URL Route RouteRedir Factor Set Status Elected To From\nhttp://websdidv-node1.appsrv:64675 node1  1 0 Ok 250 81K 13M\nhttp://websdidv-node2.appsrv:64675 node2  1 0 Ok 51 16K 2.6M\n\nThis issue does not occur with the default method (byrequests).\n\nHere is my configuration :\n        ProxyPass /parliament/ balancer://websdi/parliament/ stickysession=JSESSIONID|jsessionid lbmethod=bybusyness scolonpathdelim=On\n        <Proxy balancer://websdi>\n                BalancerMember http://websdidv-node1.appsrv:64675 route=node1\n                BalancerMember http://websdidv-node2.appsrv:64675 route=node2\n        </Proxy>\n\nServer version: Apache/2.2.14 (Unix)\nServer built:   Jan 28 2010 09:10:16\nServer's Module Magic Number: 20051115:23\nServer loaded:  APR 1.3.9, APR-Util 1.3.9\nCompiled using: APR 1.3.9, APR-Util 1.3.9\nArchitecture:   32-bit\nServer MPM:     Worker\n  threaded:     yes (fixed thread count)\n    forked:     yes (variable process count)\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/worker\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_FCNTL_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"/local/products/revproxy\"\n -D SUEXEC_BIN=\"/local/products/revproxy/bin/suexec\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"\n\nSystem = SunOS\nNode = eiciluxd5\nRelease = 5.9\nKernelID = Generic_122300-36\nMachine = sun4u\nBusType = <unknown>\nSerial = <unknown>\nUsers = <unknown>\nOEM# = 0\nOrigin# = 1\nNumCPU = 4", "id": 134467, "time": "2010-02-13T14:06:46Z", "creator": "olivier.boel@europarl.europa.eu", "creation_time": "2010-02-13T14:06:46Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "markus.stoll@junidas.de", "attachment_id": 26123, "is_private": false, "id": 140486, "time": "2010-10-05T08:52:30Z", "bug_id": 48735, "creation_time": "2010-10-05T08:52:30Z", "text": "Created attachment 26123\nFix by adding error handling and atomic functions\n\nThe proposed bugfix uses a fix from #46215 (by Thomas Binder) by using atomic functions for increasing/decreasing busyness. I added proper error handling for unreachable workers (in this case the post_req function had never been called)."}, {"count": 2, "tags": [], "creator": "olivier.boel@europarl.europa.eu", "text": "I confirm the bug cannot be re-produced with 2.2.17\n\nThanks!", "id": 143461, "time": "2011-01-19T04:24:56Z", "bug_id": 48735, "creation_time": "2011-01-19T04:24:56Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "text": "Has this patch been applied to the 2.2.17 release? I'm confused because I don't seen anything in the changelog to reflect a fix.", "is_private": false, "bug_id": 48735, "id": 143473, "time": "2011-01-19T09:38:14Z", "creator": "evan.rabeck@VERIZONBUSINESS.COM", "creation_time": "2011-01-19T09:38:14Z", "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 48735, "attachment_id": null, "id": 146137, "time": "2011-05-05T11:56:57Z", "creator": "olivier.boel@europarl.europa.eu", "creation_time": "2011-05-05T11:56:57Z", "is_private": false, "text": "Hello, Gents,\n\n\nPlease ignore my previous comment (I confirm the bug cannot be re-produced with 2.2.17).\nThe problem still exists in 2.2.17.\nIt can be easily reproduced : stop one of of the nodes, watch the dashboard (Status=Err), restart the node, status will be OK but Elected will not evolve.\nThe only way to fix it is to shutdown and restart Apache (not gracefully).\n\nRegards,\n\n\nOlivier"}, {"count": 5, "tags": [], "creator": "sergek@lokitech.com", "attachment_id": null, "is_private": false, "id": 146255, "time": "2011-05-11T03:11:35Z", "bug_id": 48735, "creation_time": "2011-05-11T03:11:35Z", "text": "I'm having the same issue and would be happy to help diagnose the problem if it's unclear what is going on."}, {"count": 6, "tags": [], "text": "The original report was on 2.2.14 on Solaris, but the same behavior is happening for me with 2.2.17 on CentOS release 5.5 (Final), so it's more current than originally expressed, and doesn't seem to be platform specific.", "is_private": false, "bug_id": 48735, "id": 147465, "time": "2011-06-24T15:42:34Z", "creator": "sergek@lokitech.com", "creation_time": "2011-06-24T15:42:34Z", "attachment_id": null}, {"count": 7, "tags": [], "text": "Behaviour can be reproduced with Apache 2.2.19 on Solaris", "is_private": false, "bug_id": 48735, "id": 147907, "time": "2011-07-14T06:10:28Z", "creator": "olivier.boel@europarl.europa.eu", "creation_time": "2011-07-14T06:10:28Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "adam@softcomputer.com", "is_private": false, "count": 8, "id": 151090, "time": "2011-10-31T21:10:33Z", "bug_id": 48735, "creation_time": "2011-10-31T21:10:33Z", "text": "This can be easily reproduced. The \"busy\" counter is not decreased when the worker tries to send something to node which is down. For example when receiving the \"connection refused\" from the server.\n\nHave balancer for 2 members. One member should be down. Start sending messages concurrently for some period of time (more then 60s due to \"retry\" timeout for disabled worker due to errors).\n\n\nStart the server which was down and continue sending messages. The started server will not be getting messages only when the \"busy\" counter for the second node will be high enough so balancers selects the first node as less busy. The balancer thinks that the first node is still busy handling request which failed with error due to lack of proper handling of \"busy\" value."}, {"count": 9, "tags": [], "creator": "adam@softcomputer.com", "attachment_id": 27900, "id": 151201, "time": "2011-11-04T16:57:55Z", "bug_id": 48735, "creation_time": "2011-11-04T16:57:55Z", "is_private": false, "text": "Created attachment 27900\ncleanup of counters added when disabled worker becomes usable\n\nadded busy and lbstatus to the balancer-manager page."}, {"count": 10, "text": "I didn't see anything about these fixes being included in any of the recent releases (since 2.2.17). I'm still easily able to replicate the behavior under Apache 2.2.21 under Windows. There doesn't seem to be any way to get traffic routed to a restarted back-end instance without forcing a restart of Apache. The issue only happens when the load balancing method is set to bybusyness.", "bug_id": 48735, "attachment_id": null, "id": 152758, "time": "2012-01-13T18:49:17Z", "creator": "baldwibg@ah.org", "creation_time": "2012-01-13T18:49:17Z", "tags": [], "is_private": false}, {"count": 11, "tags": [], "creator": "sergek@lokitech.com", "attachment_id": null, "id": 154017, "time": "2012-02-22T09:47:48Z", "bug_id": 48735, "creation_time": "2012-02-22T09:47:48Z", "is_private": false, "text": "I've confirmed that the patch for mod_proxy_balancer.c (attachment by Amada C at 2011-11-04 16:57 UTC) successful fixed this bug when applied to httpd 2.2.20 on RHEL4 in our production environment.\n\nIt also provides extra details on the balancer manager page, which is way cool!"}, {"count": 12, "tags": [], "creator": "egarreau@gmail.com", "attachment_id": null, "is_private": false, "id": 154102, "time": "2012-02-24T09:58:56Z", "bug_id": 48735, "creation_time": "2012-02-24T09:58:56Z", "text": "I also confirm it perfectly works when applied to apache 2.2.21 (Linux / SunOS hosts in production)\n\nthanks a lot for this fix"}, {"count": 13, "tags": [], "creator": "till@meisterlabs.com", "attachment_id": null, "id": 158886, "time": "2012-05-07T16:47:52Z", "bug_id": 48735, "creation_time": "2012-05-07T16:47:52Z", "is_private": false, "text": "Can we have that in the next release? PLEASE\nPatching every Apache version to make it stable is not fun."}, {"count": 14, "text": "I also can reproduce this error with 2.4.2", "bug_id": 48735, "attachment_id": null, "id": 159091, "time": "2012-05-16T12:37:14Z", "creator": "zl@consol.de", "creation_time": "2012-05-16T12:37:14Z", "tags": [], "is_private": false}, {"count": 15, "tags": [], "creator": "trawick@apache.org", "attachment_id": null, "id": 159093, "time": "2012-05-16T13:18:01Z", "bug_id": 48735, "creation_time": "2012-05-16T13:18:01Z", "is_private": false, "text": "Thanks for your update, Zisis.  I'm working on a patch for trunk/2.4.x and will update the bug when it is testable."}, {"count": 16, "text": "Hello,\nI've just checked the patch an Solaris 10 - i386 platform with apache 2.2.21 release and it doesn't work for me. After the failing backend server is coming back online, it will be no more elected. In the LB manager status, i notice that the priority counter from this server keeps on increasing. On the opposite the priority of the another server keeps on decreasing. I don't know if this is the reason.\n\nRegards,\n\nChristophe", "bug_id": 48735, "attachment_id": null, "id": 159219, "time": "2012-05-22T15:21:43Z", "creator": "chriswaddi007@gmail.com", "creation_time": "2012-05-22T15:21:43Z", "tags": [], "is_private": false}, {"count": 17, "tags": [], "bug_id": 48735, "attachment_id": null, "text": "(In reply to comment #16)\n> Hello,\n> I've just checked the patch an Solaris 10 - i386 platform with apache 2.2.21\n> release and it doesn't work for me. After the failing backend server is\n> coming back online, it will be no more elected. In the LB manager status, i\n> notice that the priority counter from this server keeps on increasing. On\n> the opposite the priority of the another server keeps on decreasing. I don't\n> know if this is the reason.\n> \n> Regards,\n> \n> Christophe\n\n\nWas the patch applied manually? The symptomps are exactly like ones without the patch.", "id": 159220, "time": "2012-05-22T15:57:59Z", "creator": "adam@softcomputer.com", "creation_time": "2012-05-22T15:57:59Z", "is_private": false}, {"count": 18, "text": "Yes, i confirm.\n\nHere are some details. I stopped the node1. After it has successfully stopped, the result of the balancer manager is the following (the priority for node1 is 172):\n\nLoad Balancer Manager for eicixzl034\n\nServer Version: Apache/2.2.21 (Unix) mod_ssl/2.2.21 OpenSSL/0.9.8k DAV/2\nServer Built: May 23 2012 09:27:11\nLoadBalancer Status for balancer://platosws\n\nStickySession\tTimeout\tFailoverAttempts\tMethod\nJSESSIONID|jsessionid\t0\t1\tbybusyness\n\nWorker URL\tRoute\tRouteRedir\tPriority\tFactor\tSet\tStatus\tBusyness\tElected\tTo\tFrom\nhttp://platoswsdv-node1.appsrv:54000\tnode1\t\t172\t1\t0\tErr\t1\t65\t 34K\t 69K\nhttp://platoswsdv-node2.appsrv:54010\tnode2\t\t-170\t1\t0\tOk\t0\t406\t227K\t203K\n\nThen i restarted node1 and after successfull restart and some requests on the web site, i have the following:\n\nLoad Balancer Manager for eicixzl034\n\nServer Version: Apache/2.2.21 (Unix) mod_ssl/2.2.21 OpenSSL/0.9.8k DAV/2\nServer Built: May 23 2012 09:27:11\nLoadBalancer Status for balancer://platosws\n\nStickySession\tTimeout\tFailoverAttempts\tMethod\nJSESSIONID|jsessionid\t0\t1\tbybusyness\n\nWorker URL\tRoute\tRouteRedir\tPriority\tFactor\tSet\tStatus\tBusyness\tElected\tTo\tFrom\nhttp://platoswsdv-node1.appsrv:54000\tnode1\t\t429\t1\t0\tOk\t1\t70\t 36K\t 70K\nhttp://platoswsdv-node2.appsrv:54010\tnode2\t\t-427\t1\t0\tOk\t0\t669\t354K\t669K\n\nThe node1's priority keeps on increasing (429) and it is no more elected.", "bug_id": 48735, "attachment_id": null, "id": 159250, "time": "2012-05-23T08:07:47Z", "creator": "chriswaddi007@gmail.com", "creation_time": "2012-05-23T08:07:47Z", "tags": [], "is_private": false}, {"count": 19, "tags": [], "creator": "chriswaddi007@gmail.com", "attachment_id": null, "id": 160092, "time": "2012-06-19T08:43:15Z", "bug_id": 48735, "creation_time": "2012-06-19T08:43:15Z", "is_private": false, "text": "Hi,\n\nI've just reproduced the same problem as above on Solaris 10 - Sparc architecture."}, {"attachment_id": null, "tags": [], "creator": "trawick@apache.org", "text": "A fix has been committed to trunk (http://svn.apache.org/viewvc?view=revision&revision=1366344) and proposed for 2.4.x.  (2.2.x will follow that.)\n\nThe handling of the busy flag is different than either proposal here.  Feel free to comment on the viability of that.  Note that this exact fix has thus far been tested only with trunk and 2.4.x.  Potentially something different would be necessary for 2.2.x.\n\nAdditionally, changes to use atomic operations or augment the balancer manager have not been considered.  I suggest tracking those with different bugs.", "count": 20, "id": 160938, "time": "2012-07-27T12:19:28Z", "bug_id": 48735, "creation_time": "2012-07-27T12:19:28Z", "is_private": false}, {"count": 21, "tags": [], "creator": "trawick@apache.org", "attachment_id": null, "id": 160990, "time": "2012-07-29T23:30:21Z", "bug_id": 48735, "creation_time": "2012-07-29T23:30:21Z", "is_private": false, "text": ">Additionally, changes to use atomic operations or augment the \n>balancer manager have not been considered.  I suggest tracking\n>those with different bugs.\n\na. atomic operations\n\nI just opened\n\nBug 53618 - proxy_worker_shared fields not maintained in thread-safe manner\n\nfor the thread-safe handling of busy.\n\nb. balancer manager display\n\nhttpd trunk and 2.4 already display the extra information."}, {"count": 22, "tags": [], "bug_id": 48735, "attachment_id": null, "text": "Applying this patch from httpd trunk/2.4.x fixes the issue for me:\n  http://svn.apache.org/viewvc/httpd/httpd/trunk/modules/proxy/mod_proxy_balancer.c?r1=1366344&r2=1366343&pathrev=1366344\nThat's what I'll propose for the 2.2.x branch.  Can anyone reproduce the problem with this new patch applied?", "id": 160991, "time": "2012-07-29T23:56:33Z", "creator": "trawick@apache.org", "creation_time": "2012-07-29T23:56:33Z", "is_private": false}, {"count": 23, "tags": [], "bug_id": 48735, "is_private": false, "text": "Applied to 2.4 in r1374299.\nReleased with 2.4.3.\nApplied to 2.2 in r1373355.\nNot yet released there.", "id": 161580, "time": "2012-08-21T16:06:49Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2012-08-21T16:06:49Z", "attachment_id": null}, {"count": 24, "tags": [], "bug_id": 48735, "attachment_id": null, "text": "Just tested 2.4.3 - issue seems to be fixed now.\nThanks!", "id": 161620, "time": "2012-08-22T17:05:17Z", "creator": "zl@consol.de", "creation_time": "2012-08-22T17:05:17Z", "is_private": false}, {"count": 25, "tags": [], "bug_id": 48735, "attachment_id": null, "text": "i've just tried the new patch on apache 2.2.22. There is one error during the compilation:\nmod_proxy_balancer.c: In function `force_recovery':\nmod_proxy_balancer.c:420: error: structure has no member named `forcerecovery'\n*** Error code 1\n\nHas mod_proxy.h also been modified ? If yes, can you add it to the patch ?\n\nThanks", "id": 161832, "time": "2012-08-30T09:53:45Z", "creator": "chriswaddi007@gmail.com", "creation_time": "2012-08-30T09:53:45Z", "is_private": false}, {"count": 26, "tags": [], "bug_id": 48735, "attachment_id": null, "text": "You need at least\n\nhttp://svn.apache.org/viewvc?view=revision&revision=1373320\n\nbut I suggest trying the candidate for 2.2.23 instead, because there might be more requirements not included in 2.2.22. Version 2.2.23 already contains the patch for this bug, no need for additional patches as far as we currently know.\n\nhttp://httpd.apache.org/dev/dist/\n\nNote that 2.2.23 is not yet officially released(!!!), so it is only adequate for testing purposes. The official release should not be far away though.", "id": 161834, "time": "2012-08-30T10:35:17Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2012-08-30T10:35:17Z", "is_private": false}, {"count": 27, "tags": [], "creator": "chriswaddi007@gmail.com", "attachment_id": null, "id": 161861, "time": "2012-08-31T08:34:44Z", "bug_id": 48735, "creation_time": "2012-08-31T08:34:44Z", "is_private": false, "text": "I've just tested in 2.2.23. Seems to be working now.\nJust a remark on the balancer-manager web interface, the Priority and Busyness fields are not displayed althrough they were appearing in previous 2.2 releases when the patch was installed. Is it normal?\n\nThanks."}, {"count": 28, "tags": [], "creator": "trawick@apache.org", "attachment_id": null, "id": 161864, "time": "2012-08-31T10:59:51Z", "bug_id": 48735, "creation_time": "2012-08-31T10:59:51Z", "is_private": false, "text": "The balancer manager changes were not backported."}, {"count": 29, "text": "> I've just tested in 2.2.23. Seems to be working now.", "bug_id": 48735, "attachment_id": null, "id": 172527, "time": "2014-01-20T00:24:52Z", "creator": "covener@gmail.com", "creation_time": "2014-01-20T00:24:52Z", "tags": [], "is_private": false}]