[{"count": 0, "tags": [], "bug_id": 30278, "attachment_id": null, "text": "After .css file was cached with mod_disk_cache it is served with wrong content\ntype. Instead of \"text/css\" it's served with \"text/plain; charset=UTF-8\"\n\nConfiguration:\n...\n<IfModule mod_cache.c>\n   <IfModule mod_disk_cache.c>\n      CacheRoot \"/tmp/abc_static_cache\"\n      CacheEnable disk /abc/images\n      CacheEnable disk /abc/htmlarea\n      CacheEnable disk /abc/scripts\n      CacheEnable disk /abc/style\n   </IfModule>\n</IfModule>\n...\n\n\"/abc\" context is referse proxy forward to backend server using following two\ndirectives:\n...\nProxyPass /abc http://10.10.10.10:8080/abc\nProxyPassReverse /abc http://10.10.10.10:8080/abc\n...\n\nHere is the headers printout for very first request (right after clean apache\nrestart with purging of the caches folder):\n\n[igor@hyperion tmp]$ wget -s https://1.2.3.4/abc/style/common.css ; head\ncommon.css; rm -rf common.css\n--18:04:39--  https://1.2.3.4/abc/style/common.css\n           => `common.css'\nConnecting to [1.2.3.4]:443... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 10,368 [text/css]\n \n100%[==============================================================================================>]\n10,368       105.47K/s    ETA 00:00\n \n18:04:40 (105.47 KB/s) - `common.css' saved [10368/10368]\n \nHTTP/1.1 200 OK\nDate: Thu, 22 Jul 2004 23:04:26 GMT\nServer: Apache/2.0.50 (Fedora)\nContent-Length: 10368\nLast-Modified: Thu, 22 Jul 2004 16:50:00 GMT\nAccept-Ranges: bytes\nContent-Type: text/css\nVary: Accept-Encoding,User-Agent\nKeep-Alive: timeout=30, max=100\nConnection: Keep-Alive\n\nEach subsequent request for the same URL returns following headers:\n\n[igor@hyperion tmp]$ wget -s https://1.2.3.4/abc/style/common.css ; head\ncommon.css; rm -rf common.css\n--18:04:52--  https://1.2.3.4/abc/style/common.css\n           => `common.css'\nConnecting to [1.2.3.4]:443... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 10,368 [text/plain]\n \n100%[==============================================================================================>]\n10,368       117.73K/s    ETA 00:00\n \n18:04:53 (117.73 KB/s) - `common.css' saved [10368/10368]\n \nHTTP/1.1 200 OK\nDate: Thu, 22 Jul 2004 23:04:39 GMT\nServer: Apache/2.0.50 (Fedora)\nAccept-Ranges: bytes\nContent-Length: 10368\nLast-Modified: Thu, 22 Jul 2004 16:50:00 GMT\nContent-Type: text/plain; charset=UTF-8\nAge: 17\nKeep-Alive: timeout=30, max=100\nConnection: Keep-Alive\n[igor@hyperion tmp]$\n\n\nI can provide more information if needed, feel free to email me for more questions.", "id": 61017, "time": "2004-07-22T23:11:21Z", "creator": "igor@fedulov.com", "creation_time": "2004-07-22T23:11:21Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 30278, "text": "is utf8 your default charset type?\nWhat is 'AddDefaultCharset' set to in your httpd.conf?", "count": 1, "id": 61020, "time": "2004-07-23T01:25:04Z", "creator": "chip@force-elite.com", "creation_time": "2004-07-23T01:25:04Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 30278, "attachment_id": null, "text": "It's set to UTF-8, i.e. from httpd.conf:\n\nAddDefaultCharset UTF-8", "id": 61021, "time": "2004-07-23T01:42:49Z", "creator": "igor@fedulov.com", "creation_time": "2004-07-23T01:42:49Z", "is_private": false}, {"count": 3, "tags": [], "creator": "ruediger.pluem@vodafone.com", "text": "Does this only happen with css files or also with other files?\nWhat is your setting for DefaultType ?\nIs it unset or text/plain?\n\nI had a similar problem with mod_jk and mod_cache / mod_disk_cache. I would\nguess that they are related. See also\nhttp://nagoya.apache.org/bugzilla/show_bug.cgi?id=30398.", "id": 61544, "time": "2004-08-04T15:04:21Z", "bug_id": 30278, "creation_time": "2004-08-04T15:04:21Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 30278, "attachment_id": null, "text": "Here are my answers:\n1. DefaultType is set to \"text/plain\"\n2. Images from cache also come out with \"Content-Type: text/plain; charset=UTF-8\"\n\nLooks like what you are describing in your issue is exactly the same thing, I\nwonder if I can try your patch to see if it will fix the problem.", "id": 61546, "time": "2004-08-04T15:36:09Z", "creator": "igor@fedulov.com", "creation_time": "2004-08-04T15:36:09Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 30278, "attachment_id": null, "text": "No, you cannot use my patch as I patched mod_jk to solve my problem. You\nneed a patch for mod_disk_cache. But as I mentioned in 30398, I was not quite\nsure if this problem is a bug in mod_jk or mod_cache / mod_disk_cache\n(BTW: mod_mem_cache does not have this problem). After I read this report here\nI am quite sure that it is a bug in mod_disk_cache and that it should be fixed\nthere.\nmod_disk_cache.c already contains the needed code in write_headers, but\nit is executed too late. So I just moved this piece of code and created an\nappropriate patch for this which I will attach.\n\nI removed my patch from my mod_jk and added my patch to mod_disk_cache and\nmy problem from 30398 remains silent. I hope that this patch will also solve\nyour problem. A short feedback on your experience with the patch would be much\nappreciated.\n\nBTW: If you have any problems with mod_cache storing Cookies unintentional, or\nwith other weird HTTP header caching behaviour you may find the following links\nuseful:\n\nhttp://nagoya.apache.org/bugzilla/show_bug.cgi?id=30399\nhttp://nagoya.apache.org/bugzilla/show_bug.cgi?id=30419\n", "id": 61559, "time": "2004-08-04T20:48:50Z", "creator": "ruediger.pluem@vodafone.com", "creation_time": "2004-08-04T20:48:50Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 30278, "attachment_id": 12339, "text": "Created attachment 12339\nproposed solution patch to mod_disk_cache.c", "id": 61560, "time": "2004-08-04T20:49:45Z", "creator": "ruediger.pluem@vodafone.com", "creation_time": "2004-08-04T20:49:45Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 30278, "text": "I've tested this patch and it works perfectly. After either image or .css file\nis cached headers contain proper Content-Type thus allowing for proper display\nin strict HTML validating browsers! Thanks!\n\nHere is the output from the original wget commands:\n\n1. First request for a resource:\n16:36:57 (328.88 KB/s) - `common.css' saved [10440/10440]\n \nHTTP/1.1 200 OK\nDate: Wed, 04 Aug 2004 21:36:56 GMT\nServer: Apache/2.0.50 (Fedora)\nContent-Length: 10440\nLast-Modified: Fri, 23 Jul 2004 12:56:12 GMT\nAccept-Ranges: bytes\nContent-Type: text/css\nVary: Accept-Encoding,User-Agent\nKeep-Alive: timeout=30, max=100\nConnection: Keep-Alive\n\n2. Next request for the same resource:\n16:36:59 (463.42 KB/s) - `common.css' saved [10440/10440]\n \nHTTP/1.1 200 OK\nDate: Wed, 04 Aug 2004 21:36:59 GMT\nServer: Apache/2.0.50 (Fedora)\nAccept-Ranges: bytes\nContent-Length: 10440\nLast-Modified: Fri, 23 Jul 2004 12:56:12 GMT\nContent-Type: text/css\nAge: 4\nKeep-Alive: timeout=30, max=100\nConnection: Keep-Alive", "count": 7, "id": 61564, "time": "2004-08-04T21:43:01Z", "creator": "igor@fedulov.com", "creation_time": "2004-08-04T21:43:01Z", "is_private": false}, {"count": 8, "tags": [], "creator": "ruediger.pluem@vodafone.com", "attachment_id": null, "id": 62113, "time": "2004-08-18T11:13:13Z", "bug_id": 30278, "creation_time": "2004-08-18T11:13:13Z", "is_private": false, "text": "*** Bug 29016 has been marked as a duplicate of this bug. ***"}, {"attachment_id": 12879, "tags": [], "bug_id": 30278, "text": "Created attachment 12879\nPatch against 2.0.51", "count": 9, "id": 64305, "time": "2004-09-28T12:26:16Z", "creator": "ruediger.pluem@vodafone.com", "creation_time": "2004-09-28T12:26:16Z", "is_private": false}, {"count": 10, "tags": [], "creator": "jerenkrantz@apache.org", "text": "A variant of the 'patch against 2.0.51' has been committed to HEAD as\nmodules/experimental/mod_disk_cache.c rev 1.63.\n\nThanks!", "id": 64335, "time": "2004-09-28T17:42:49Z", "bug_id": 30278, "creation_time": "2004-09-28T17:42:49Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "bug_id": 30278, "attachment_id": null, "text": "Backported to v2.0.53.\n", "id": 65076, "time": "2004-10-13T16:38:41Z", "creator": "minfrin@apache.org", "creation_time": "2004-10-13T16:38:41Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 30278, "text": "I think I'm seeing this same issue in Apache 2.4.2 on RHEL6.2. I am using Apache ModProxy to proxy to a tomcat, when this is unavailable, content should continue to be served using mod_cache_disk. I'm seeing the Content-Type and Charset change when served from the disk_cache - this doesn't seem to happen immediately, and I presume it's related to the content becoming stale. Header output below. Please let me know if there is any additional information I can provide that would help.\nThanks,\nPaul\n\n-----------------------\nWhen tomcat available\n-----------------------\nDate\tTue, 19 Jun 2012 14:18:40 GMT\nAge\t6\nConnection\tKeep-Alive\nContent-Length\t339\nLast-Modified\tMon, 18 Jun 2012 15:50:24 GMT\nServer\tWeb Server\nETag\tW/\"339-1340034624000\"\nContent-Type\ttext/css;charset=utf-8\nAccept-Ranges\tbytes\nKeep-Alive\ttimeout=3, max=99\n\n-----------------------\nWhen tomcat unavailable - from disk_cache\n-----------------------\nDate\tTue, 19 Jun 2012 08:48:53 GMT\nConnection\tclose\nContent-Length\t339\nLast-Modified\tMon, 18 Jun 2012 15:50:24 GMT\nServer\tApache-Coyote/1.1\nETag\tW/\"339-1340034624000\"\nWarning\t111 Revalidation failed\nContent-Type\ttext/html; charset=iso-8859-1\nAccept-Ranges\tbytes", "id": 160099, "time": "2012-06-19T14:28:01Z", "creator": "p.beckett@uea.ac.uk", "creation_time": "2012-06-19T14:28:01Z", "is_private": false, "attachment_id": null}]