[{"attachment_id": null, "tags": [], "bug_id": 32752, "is_private": false, "count": 0, "id": 68656, "time": "2004-12-17T15:42:12Z", "creator": "ceki@apache.org", "creation_time": "2004-12-17T15:42:12Z", "text": "At 01:01 PM 12/17/2004, Hein Meling wrote:\n\nI've noticed that MDC.put(String, Object) has been deprecated and is\nbeing replaced by MDC.put(String, String) instead.  At first, I didn't\nthink of this as a problem other than calling the Object.toString()\nmethod instead.\n\nBut, later I discovered that this is flawed, because the Object might\nchange its state (and hence toString() output might be different)\nbetween debug calls.  Consider my example:\n\n  Group g = new Group(1);\n  g.setState(IDLE);\n  MDC.put(\"group\", g.toString());\n  log.debug(\"Hi\");\n  g.setState(SYNC);\n  log.debug(\"Ciao\");\n\nThis sequence, will result in both debug statements printing the same\nstate (IDLE) even if in SYNC state, as opposed to using the now\ndeprecated method (actually the 1.3 version does not work; it does work\nin 1.2.8 though):\n\n  MDC.put(\"group\", g);\n\nwhich would print the correct state.\n\nTo overcome this problem, I would have to identify every location that\nmodify the state of the Group object, and update the MDC entry, causing\na lot of clutter.\n\nSo to my question: is this signature change in 1.3alpha3 really\nwarranted??  Is there a good reason for it?\n\nThanks,\n\nHein"}, {"attachment_id": null, "tags": [], "bug_id": 32752, "is_private": false, "count": 1, "id": 82051, "time": "2005-11-02T16:06:46Z", "creator": "sdeboy@iname.com", "creation_time": "2005-11-02T16:06:46Z", "text": "MDC properties were merged with logger repository properties, and when that was\ndone Ceki chose to support Strings as values in the LoggerRepository setProperty\nmethod (and change the MDC implementation to match).\n\nWe could change the methods to use setProperty(String, Object) - we'd just need\nto change the interface signature for both MDC and LoggerRepository.  \n\nSince logger repository properties are new with 1.3, I don't think it's a problem.\n\nCeki may have stronger opinions about using strings as values, but since we can\ndo tostring on the object and push it on to the developer to provide a\nreasonable toString, I don't think this is a big deal.\n\nScott"}, {"attachment_id": null, "tags": [], "bug_id": 32752, "is_private": false, "count": 2, "id": 82120, "time": "2005-11-04T10:33:54Z", "creator": "ceki@apache.org", "creation_time": "2005-11-04T10:33:54Z", "text": "Hello Scott,\n\nAltough originally reported by Hein Meiling, you do realize that this bug reported \nwas entered by me, right? There was quite a lengthy discussion on this bug on the\nmailing lists.\n"}, {"count": 3, "tags": [], "creator": "cquezel@mechatools.com", "attachment_id": null, "text": "(In reply to comment #2)\n>There was quite a lengthy discussion on this bug on the mailing lists.\n\nCould you point out the thread title. All I found was a thread titled \"MDC\nsignature change in log4j v1.3\" and it is not lengthy by my standards.", "id": 87007, "time": "2006-03-19T21:50:53Z", "bug_id": 32752, "creation_time": "2006-03-19T21:50:53Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "cquezel@mechatools.com", "is_private": false, "count": 4, "id": 87130, "time": "2006-03-23T06:11:15Z", "bug_id": 32752, "creation_time": "2006-03-23T06:11:15Z", "text": "(In reply to comment #0)\n\nTo add to this discussion ...\n\nThis change is a show stopper for me as I make extensive use of Object.toString\n() method to dynamically compute the value at log time (not at put time). The \nmain problem with this change is that the workaround is some sort of wrapper \nto ensure that the MDC content is updated at log point.\n\nI think the old behavior should be preserved as it is more flexible and \nalready in use. (I am surprised  that so few people have commented this issue \non the mailing list).\n\nAnother point I'd like to raise is that the deprecation of the put() method is \naccompanied by a behavior change (in 1.3) that will \u201cnot\u201d be easily detected \nand might silently produce wrong (unexpected) values in existing code. Of \ncourse the other options are far from ideal:\n1)Remove the deprecated method (and break code compatibility)\n2)Log an explicit warning instead of the Object.toString(). The odds of an \nunwanted change going unnoticed are reduced but some correct code might/would \nalso break.\n\nI took a look at the beta8 sources to see what impacts reverting this change \nwould have. Here are my observations:\n\n1)The MDC.put(String, Object) method implementation would replace \nthe \u201cval.toString()\u201d call by \u201cval\u201d.\n\npublic static void put(String key, Object val) {\n\tput(key, val.toString()); // before\n}\n\npublic static void put(String key, Object val) {\n\tput(key, val); // after\n}\n\n2)The MDC.put(String, Object) method documentation would change to remove \nthe \u201cdeprecated\u201d flag and to eliminate the toString() reference.\n3)The LoggingEvent.initializeProperties() method implementation would have to \nbe changed to call the toString() method when copying the MDC context to the \nproperties Map.\n\n\tproperties.putAll(mdcMap); // before\n\n\t// start of after (code not tested)\n    \tIterator it = mdcMap.entrySet().iterator(); \n    \twhile(it.hasNext())\n    \t{\n    \t\tMap.Entry entry = (Map.Entry) it.next();\n\t\tproperties.put(entry.getKey(), entry.getValue().toString());\n    \t}\n\t// end of after \n \nI have not looked at the impacts of these changes to other existing code \n(outside log4j). For example, the public MDC.getContext() method (documented \nas internal) would contain Object that are possibly not Strings as before.\n\nClaude"}, {"count": 5, "tags": [], "bug_id": 32752, "attachment_id": null, "text": "I agree that changing the MDC signatures was an unnecessary move.\n\nJust because the underlying implementation changes, it doesn't necessarily call\nfor an external API change.", "id": 87159, "time": "2006-03-23T18:13:06Z", "creator": "eross@m-qube.com", "creation_time": "2006-03-23T18:13:06Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "carnold@apache.org", "is_private": false, "count": 6, "id": 106619, "time": "2007-08-10T15:33:54Z", "bug_id": 32752, "creation_time": "2007-08-10T15:33:54Z", "text": "log4j 1.3 development has been abandoned. "}]