[{"count": 0, "tags": [], "bug_id": 51754, "is_private": false, "text": "The behavior of filter ordering for default web.xml (i.e conf/web.xml) and the application filters in WEB-INF/web.xml has been changed from Tomcat 6 to Tomcat 7.\n\nAs you can see from the start method in http://www.docjar.com/html/api/org/apache/catalina/startup/ContextConfig.java.html it processes the default web.xml first\nand then the application web config.  This makes the filters from the default web.xml excuted before the application provided filters.  We were heavily relying on this behavior for processing the filters.\n\n\n1040       /**\n 1041        * Process a \"start\" event for this Context.\n 1042        */\n 1043       protected synchronized void start() {\n 1044           // Called from StandardContext.start()\n 1045   \n 1046           if (log.isDebugEnabled())\n 1047               log.debug(sm.getString(\"contextConfig.start\"));\n 1048   \n 1049           // Set properties based on DefaultContext\n 1050           Container container = context.getParent();\n 1051           if( !context.getOverride() ) {\n 1052               if( container instanceof Host ) {\n 1053                   // Reset the value only if the attribute wasn't\n 1054                   // set on the context.\n 1055                   xmlValidation = context.getXmlValidation();\n 1056                   if (!xmlValidation) {\n 1057                       xmlValidation = ((Host)container).getXmlValidation();\n 1058                   }\n 1059                   \n 1060                   xmlNamespaceAware = context.getXmlNamespaceAware();\n 1061                   if (!xmlNamespaceAware){\n 1062                       xmlNamespaceAware \n 1063                                   = ((Host)container).getXmlNamespaceAware();\n 1064                   }\n 1065   \n 1066                   container = container.getParent();\n 1067               }\n 1068           }\n 1069   \n 1070           // Process the default and application web.xml files\n 1071           defaultWebConfig();\n 1072           applicationWebConfig();\n\nSo, now with Tomcat 7, its different.\n\nMerging mechanism seeing in Tomcat 7 looks as follows in general:\nFrom http://svn.apache.org/repos/asf/tomcat/tc7.0.x/trunk/java/org/apache/catalina/startup/ContextConfig.java\n\n1) Create appWebXml for /WEB-INF/web.xml\n2) Create globalWebXml for conf/web.xml\n3) orderedFragments are merged to appWebXml ( Merge web-fragment.xml files into the main web.xml)\n4) globalWebXml is merged to appWebXml (which means that list of global filters are added to existing application\ndefined filters)\n\nAfter going through the Servlet API specs for 2.5 and 3.0, I didn't find anything related to how default web.xml and application provided web.xml should be ordered. (Did I miss anything?)\n\nThere is a deployment descriptor fragments introduced in 3.0 but it applies to web.xml and the web-fragment.xml.\n\nChanges in the ordering of filters from Tomcat 6 to 7 creates a lot of issues for us.  Can this be fixed in Tomcat 7? If not, can you provide any suggestions for workaround?", "id": 148964, "time": "2011-09-01T19:48:01Z", "creator": "charlesk40@yahoo.com", "creation_time": "2011-09-01T19:48:01Z", "attachment_id": null}, {"count": 1, "tags": [], "text": "The short answer is that this can't be fixed. The comment at the beginning of the webConfig() methods explains why (there were a number of spec breaking bugs introduced by trying to process the global web.xml file earlier).\n\nI am not aware of the spec even mentioning default web.xml settings provided by the container. This is likely to vary from container to container.\n\nI would suggest the following:\n- Define a ServletContextListener in conf/web.xml\n- Use this to add the filters programmatically during the contexInitialized()\n- Use the isMatchAfter parameter of the addMappingXXX methods of FilterRegistration to insert the filters before those defined in any web.xml\n\nBugzilla isn't really the place to go into details on exactly how to do this. If the above isn't enough, please use the Tomcat users mailing list for further advice.", "attachment_id": null, "bug_id": 51754, "id": 148985, "time": "2011-09-02T13:10:56Z", "creator": "markt@apache.org", "creation_time": "2011-09-02T13:10:56Z", "is_private": false}]