[{"count": 0, "tags": [], "bug_id": 40963, "attachment_id": null, "id": 95792, "time": "2006-11-13T13:33:39Z", "creator": "nikke@acc.umu.se", "creation_time": "2006-11-13T13:33:39Z", "is_private": false, "text": "Doing apr_file_trunc(f, 0) seems to screw up the file offset, at least on Linux\nand probably on all unix platforms.\n\nThe code does the following:\nopen file rw in buffered mode.\nread file.\napr_file_trunc(f, 0)\noff=0;\napr_file_seek(f, APR_SET, &off)\n\nDoing apr_file_writev at this point writtes to the file offset before the call\nto apr_file_trunc().\n\nstrace of the process shows a call to ftruncate followed by a call to writev.\n\nThe ftruncate() manpage states: \"The value of the seek pointer is  not  modified\nby a call to ftruncate()\".\n\nI peeked at file_io/unix/seek.c both in APR 1.2.7 and trunk but didn't see an\nobvious fix, although I suspect the culprit is setptr() in that file."}, {"count": 1, "tags": [], "creator": "nikke@acc.umu.se", "attachment_id": null, "id": 95798, "time": "2006-11-13T15:12:37Z", "bug_id": 40963, "creation_time": "2006-11-13T15:12:37Z", "is_private": false, "text": "Ahem.\n\nIt seems that it's apr_file_seek that's broken when buffering is enabled.\n\nDoing:\nread file\nseek to beginning\nwrite new contents to file\n\nwhen buffering is enabled acts like I would have left out the seek.\n\nOpening the file without buffering acts as expected, ie the new contents\noverwrites the old contents.\n\nOuch?"}, {"count": 2, "tags": [], "bug_id": 40963, "attachment_id": 20166, "is_private": false, "id": 103059, "time": "2007-05-10T16:51:44Z", "creator": "bojan@rexursive.com", "creation_time": "2007-05-10T16:51:44Z", "text": "Created attachment 20166\nTest program"}, {"count": 3, "tags": [], "bug_id": 40963, "attachment_id": null, "is_private": false, "id": 103060, "time": "2007-05-10T16:53:36Z", "creator": "bojan@rexursive.com", "creation_time": "2007-05-10T16:53:36Z", "text": "Result of the run is:\n\n012345678901234567890123456789abcdefghij\n\nWhere it should be:\n\nabcdefghij01234567890123456789"}, {"count": 4, "tags": [], "creator": "davi@apache.org", "attachment_id": 20167, "id": 103061, "time": "2007-05-10T18:20:06Z", "bug_id": 40963, "creation_time": "2007-05-10T18:20:06Z", "is_private": false, "text": "Created attachment 20167\nbug fix and test case\n\nThe file pointer position must be recalculated and set when writev()ing to a\nbuffered file."}, {"count": 5, "text": "Thanks for the fix Davi!\n\nCommitted in r537066 to trunk. Backported to 1.2.x in r537067. Backported to\n0.9.x in r537076.", "bug_id": 40963, "is_private": false, "id": 103062, "time": "2007-05-10T20:33:31Z", "creator": "bojan@rexursive.com", "creation_time": "2007-05-10T20:33:31Z", "tags": [], "attachment_id": null}]