[{"count": 0, "text": "found against trunk on Jun 18, 2012\n\nSEVERE:\njava.lang.StackOverflowError\n        at org.apache.catalina.core.StandardContextValve.event(StandardContextValve.java:128)\n        at org.apache.catalina.valves.ValveBase.event(ValveBase.java:204)\n        at org.apache.catalina.core.StandardHostValve.event(StandardHostValve.java:223)\n        at org.apache.catalina.valves.ValveBase.event(ValveBase.java:204)\n        at org.apache.catalina.valves.ValveBase.event(ValveBase.java:204)\n        at org.apache.catalina.core.StandardEngineValve.event(StandardEngineValve.java:110)\n        at org.apache.catalina.connector.CoyoteAdapter.event(CoyoteAdapter.java:209)\n        at org.apache.coyote.http11.Http11NioProcessor.event(Http11NioProcessor.java:124)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:569)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1653)\n        at org.apache.tomcat.util.net.NioEndpoint.processSocket(NioEndpoint.java:730)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:1008)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:999)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.longPoll(Http11NioProtocol.java:277)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:596)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1653)\n        at org.apache.tomcat.util.net.NioEndpoint.processSocket(NioEndpoint.java:730)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:1008)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:999)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.longPoll(Http11NioProtocol.java:277)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:596)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1653)\n        at org.apache.tomcat.util.net.NioEndpoint.processSocket(NioEndpoint.java:730)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:1008)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:999)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.longPoll(Http11NioProtocol.java:277)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:596)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1653)\n        at org.apache.tomcat.util.net.NioEndpoint.processSocket(NioEndpoint.java:730)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:1008)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:999)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.longPoll(Http11NioProtocol.java:277)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:596)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1653)\n        at org.apache.tomcat.util.net.NioEndpoint.processSocket(NioEndpoint.java:730)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:1008)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:999)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.longPoll(Http11NioProtocol.java:277)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:596)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1653)\n        at org.apache.tomcat.util.net.NioEndpoint.processSocket(NioEndpoint.java:730)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:1008)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:999)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.longPoll(Http11NioProtocol.java:277)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:596)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1653)\n        at org.apache.tomcat.util.net.NioEndpoint.processSocket(NioEndpoint.java:730)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:1008)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:999)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.longPoll(Http11NioProtocol.java:277)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:596)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1653)\n        at org.apache.tomcat.util.net.NioEndpoint.processSocket(NioEndpoint.java:730)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:1008)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:999)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.longPoll(Http11NioProtocol.java:277)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:596)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1653)\n        at org.apache.tomcat.util.net.NioEndpoint.processSocket(NioEndpoint.java:730)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:1008)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:999)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.longPoll(Http11NioProtocol.java:277)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:596)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1653)\n        at org.apache.tomcat.util.net.NioEndpoint.processSocket(NioEndpoint.java:730)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:1008)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:999)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.longPoll(Http11NioProtocol.java:277)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:596)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1653)\n        at org.apache.tomcat.util.net.NioEndpoint.processSocket(NioEndpoint.java:730)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:1008)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:999)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.longPoll(Http11NioProtocol.java:277)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:596)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1653)\n        at org.apache.tomcat.util.net.NioEndpoint.processSocket(NioEndpoint.java:730)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:1008)\n        at org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:999)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.longPoll(Http11NioProtocol.java:277)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:596)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)", "bug_id": 53406, "is_private": false, "id": 159937, "time": "2012-06-13T03:51:40Z", "creator": "fhanik@apache.org", "creation_time": "2012-06-13T03:51:40Z", "tags": [], "attachment_id": null}, {"count": 1, "attachment_id": null, "bug_id": 53406, "text": "The following are remarkable points in this stacktrace:\n\n> org.apache.tomcat.util.net.NioEndpoint.processSocket(NioEndpoint.java:730)\n> org.apache.tomcat.util.net.NioEndpoint$Poller.add(NioEndpoint.java:1008)\n\nNioEndpoint$Poller.add(NioChannel socket, int interestOps):\n[[[\n            if (close) {\n                processSocket(socket, SocketStatus.STOP, false);\n            }\n]]]\n\n> org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.longPoll(Http11NioProtocol.java:277)\n\n[[[\n            } else {\n                //...\n                socket.getSocket().getPoller().add(socket.getSocket());\n]]]\n\nso this happens with an application that uses Comet (those event() calls), when longPoll() is processed, but endpoint is being closed at the same time.\n\nIt looks like SocketStatus.STOP value is not being honored. The poller#close flag is inaccessible from outside.", "id": 159940, "time": "2012-06-13T07:08:16Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2012-06-13T07:08:16Z", "tags": [], "is_private": false}, {"count": 2, "attachment_id": null, "bug_id": 53406, "is_private": false, "id": 159958, "time": "2012-06-13T15:35:38Z", "creator": "fhanik@apache.org", "creation_time": "2012-06-13T15:35:38Z", "tags": [], "text": "Thanks for the analysis.\n\nHere is what I think will fix it\n\nIndex: java/org/apache/coyote/http11/Http11NioProcessor.java\n===================================================================\n--- java/org/apache/coyote/http11/Http11NioProcessor.java       (revision 1349898)\n+++ java/org/apache/coyote/http11/Http11NioProcessor.java       (working copy)\n@@ -155,7 +155,7 @@\n\n         rp.setStage(org.apache.coyote.Constants.STAGE_ENDED);\n\n-        if (error) {\n+        if (error || status==SocketStatus.STOP) {\n             return SocketState.CLOSED;\n         } else if (!comet) {\n             if (keepAlive) {\n\nWhat this does, is that it prevents reuse of connections after a Comet transaction has been notified of a STOP event."}, {"count": 3, "tags": [], "bug_id": 53406, "text": "I was thinking along the same lines but fixing it in the Adaptor rather than just for NIO. The issue with my fix is that it somewhat abused the error flag (by changing it's meaning to mean \"close the connection for any reason\" rather than \"something went wrong\".\n\nYour fix is clearer as to intention but it needs to be made to APR too. I'll so that now unless you beat me to it.", "id": 159960, "time": "2012-06-13T15:45:11Z", "creator": "markt@apache.org", "creation_time": "2012-06-13T15:45:11Z", "is_private": false, "attachment_id": null}, {"count": 4, "attachment_id": null, "bug_id": 53406, "text": "Fixed for trunk and 7.0.x and will be included in 7.0.28 onwards.", "id": 159961, "time": "2012-06-13T15:48:45Z", "creator": "markt@apache.org", "creation_time": "2012-06-13T15:48:45Z", "tags": [], "is_private": false}]