[{"count": 0, "tags": [], "bug_id": 60555, "attachment_id": null, "id": 195865, "creation_time": "2017-01-05T09:41:00Z", "time": "2017-01-05T09:41:00Z", "creator": "draculav@hotmail.com", "text": "tomcat-embed-core-8.5.4\n\nour service use springboot '1.4.0.RELEASE'\ncentos 6.5\n\nSSL:\nserver.ssl.key-store=classpath:cert/aaaaa.ca.pfx\nserver.ssl.key-store-password=aaaaa\nserver.ssl.keyStoreType=PKCS12\n\nAfter start, then use shell :\n#!/usr/bin/bash\nwhile true ;\ndo\n\tcurl -k https://IP/app/current/queryCurrent.action\t\n\techo \"\"\ndone\n\nand exec the command : netstat -antp | grep CLOSE_WAIT \ntcp        0      0 ********::443            ********:45138         CLOSE_WAIT  21773/java          \ntcp        0      0 ********::443            ********::44910         CLOSE_WAIT  21773/java          \ntcp        0      0 ********::443            ********::44464         CLOSE_WAIT  21773/java          \ntcp        0      0 ********::443            ********::45234         CLOSE_WAIT  21773/java          \ntcp        0      0 ********::443            ********::43768         CLOSE_WAIT  21773/java          \ntcp        0      0 ********::443            ********::44216         CLOSE_WAIT  21773/java \n......\nnondecreasing \n\nrun without ssl no problem\n\ncode line 1399 in org.apache.tomcat.util.net.NioEndpoint\nUsing HTTP always get true\nand When CLOSE_WAIT appears always \"handshake == SelectionKey.OP_READ\" and never change(Even if the client is closed)\n\nThese CLOSE_WAIT lived for more than 12 hours yet", "is_private": false}, {"count": 1, "tags": [], "bug_id": 60555, "attachment_id": null, "is_private": false, "id": 195883, "time": "2017-01-05T20:37:36Z", "creator": "markt@apache.org", "creation_time": "2017-01-05T20:37:36Z", "text": "\n\n*** This bug has been marked as a duplicate of bug 60035 ***"}, {"count": 2, "tags": [], "creator": "draculav@hotmail.com", "attachment_id": null, "is_private": false, "id": 195887, "time": "2017-01-06T10:08:57Z", "bug_id": 60555, "creation_time": "2017-01-06T10:08:57Z", "text": "Thanks. Has been upgraded to 8.5.6 and the problem is solved"}, {"count": 3, "tags": [], "bug_id": 60555, "attachment_id": null, "id": 195888, "creation_time": "2017-01-06T10:45:25Z", "time": "2017-01-06T10:45:25Z", "creator": "draculav@hotmail.com", "text": "(In reply to Mark Thomas from comment #1)\n> \n> *** This bug has been marked as a duplicate of bug 60035 ***\n\nThanks ,the problem is solved,\nbut I don't think the relationship with r1746551 is direct\nI think the main solution to this problem is the following code\n\norg.apache.tomcat.util.net.NioEndpoint\n\n                        if (socket.isHandshakeComplete()) {\n                            // No TLS handshaking required. Let the handler\n                            // process this socket / event combination.\n                            handshake = 0;\n                        } else if (event == SocketEvent.STOP || event == SocketEvent.DISCONNECT ||\n                                event == SocketEvent.ERROR) {\n                            // Unable to complete the TLS handshake. Treat it as\n                            // if the handshake failed.\n                            handshake = -1;\n                        } else {\n                            handshake = socket.handshake(key.isReadable(), key.isWritable());\n                            // The handshake process reads/writes from/to the\n                            // socket. status may therefore be OPEN_WRITE once\n                            // the handshake completes. However, the handshake\n                            // happens when the socket is opened so the status\n                            // must always be OPEN_READ after it completes. It\n                            // is OK to always set this as it is only used if\n                            // the handshake completes.\n                            event = SocketEvent.OPEN_READ;\n                        }", "is_private": false}, {"count": 4, "tags": [], "bug_id": 60555, "attachment_id": null, "id": 200198, "time": "2017-08-04T20:45:16Z", "creator": "vbhandari@vmware.com", "creation_time": "2017-08-04T20:45:16Z", "is_private": false, "text": "@hiki's comments seems right and thats why a port to 7.0 line would be needed. We have hit this issue in 7.0 tomcat version."}, {"count": 5, "tags": [], "creator": "vbhandari@vmware.com", "attachment_id": null, "text": "Reopening as porting to 7.0 version is needed.", "id": 200233, "time": "2017-08-08T11:03:09Z", "bug_id": 60555, "creation_time": "2017-08-08T11:03:09Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 60555, "attachment_id": null, "is_private": false, "id": 200245, "time": "2017-08-09T07:18:40Z", "creator": "vbhandari@vmware.com", "creation_time": "2017-08-09T07:18:40Z", "text": "http://svn.apache.org/viewvc/tomcat/trunk/java/org/apache/tomcat/util/net/NioEndpoint.java?r1=1757813&r2=1757903&diff_format=h\n\nThis is the change that needs to be ported to 7.0"}, {"count": 7, "tags": [], "bug_id": 60555, "attachment_id": null, "text": "This report, as originally described, is not reproducible on Tomcat 8.0.x and earlier. While sockets in CLOSE_WAIT are observed, they do not remain in that state for more than a few seconds. Further, analysis of this issue with 8.5.x/trunk showed that it was introduced by r1746551 and that r1757903 was the correct fix for that issue.\n\nYou can not be observing the same problem on 7.0.x, even if the symptoms are identical, as r1746551 was not back-ported to 8.0.x or earlier.\n\nSince the root causes are different there is no basis to conclude that the required fix is the same.\n\nPlease open a new issue and provide the steps to reproduce on a clean install of the latest stable release of any of the supported branches (currently 7.0.x, 8.0.x, 8.5.x and 9.0.x).", "id": 200251, "time": "2017-08-09T14:38:48Z", "creator": "markt@apache.org", "creation_time": "2017-08-09T14:38:48Z", "is_private": false}]