[{"count": 0, "tags": [], "text": "Hi,\nWe are facing an issue during Apache graceful restart meaning some of the child httpd process are not getting restarted sometime on graceful restart.\n\nAfter putting below below fix in prefork.c, we are not seeing issue.\n\n\nstatic void clean_child_exit(int code)\n{\n    //below code added to fix graceful restart\n    //fix start\n    apr_signal(SIGHUP, SIG_IGN);\n    apr_signal(SIGTERM, SIG_IGN);\n    apr_signal(SIGUSR1, SIG_IGN);\n    apr_signal(AP_SIG_GRACEFUL, SIG_IGN);\n    // fix end\n\t\n    mpm_state = AP_MPMQ_STOPPING;\n\n    if (pchild) {\n        apr_pool_destroy(pchild);\n    }\n    ap_mpm_pod_close(pod);\n    chdir_for_gprof();\n    exit(code);\n}\n\n\nHowever we would like to know if there is any impact with this changes.\n\nyour urgent reply is appreciated.\n\nThanks,\nAkshay", "attachment_id": null, "id": 168507, "creation_time": "2013-07-11T10:56:39Z", "time": "2013-07-11T10:56:39Z", "creator": "akshay.ballarpure@nsn.com", "bug_id": 55239, "is_private": false}, {"count": 1, "tags": [], "creator": "akshay.ballarpure@nsn.com", "attachment_id": null, "is_private": false, "id": 168557, "time": "2013-07-12T12:04:14Z", "bug_id": 55239, "creation_time": "2013-07-12T12:04:14Z", "text": "Can you please provide an update on the below?\n\nThanks,\nAkshay"}, {"count": 2, "tags": [], "bug_id": 55239, "attachment_id": null, "id": 168561, "time": "2013-07-12T12:35:03Z", "creator": "covener@gmail.com", "creation_time": "2013-07-12T12:35:03Z", "is_private": false, "text": "Can you clarify the problem? Children are not restarted during a graceful restart. They're replaced by new processes and allowed to exit when they're ready."}, {"count": 3, "tags": [], "creator": "akshay.ballarpure@nsn.com", "attachment_id": null, "id": 168562, "time": "2013-07-12T13:32:32Z", "bug_id": 55239, "creation_time": "2013-07-12T13:32:32Z", "is_private": false, "text": "I meant some processes are getting hang for sometime ( here i am not sure about timing)\n\nCan you clarify below statement?\nThey're replaced by new processes and allowed to exit when they're ready.\n\nhow much time it will take for them to exit ?\n\nThanks."}, {"count": 4, "tags": [], "creator": "akshay.ballarpure@nsn.com", "attachment_id": null, "is_private": false, "id": 168615, "time": "2013-07-16T04:56:11Z", "bug_id": 55239, "creation_time": "2013-07-16T04:56:11Z", "text": "Can you please update us?\n\n\nRegards,\nAkshay"}, {"count": 5, "tags": [], "bug_id": 55239, "attachment_id": null, "text": "\nWe are now ignoring all the signals while cleaning up resources. please let us know if any issue with these changes? Thanks .\n\nstatic void clean_child_exit(int code)\n{\n\tsigset_t mask;\n    sigfillset(&mask);\n    sigprocmask(SIG_SETMASK, &mask, NULL);\n\n    /*apr_signal(SIGHUP, SIG_IGN);\n    apr_signal(SIGTERM, SIG_IGN);\n\tapr_signal(SIGUSR1, SIG_IGN);\n    apr_signal(AP_SIG_GRACEFUL, SIG_IGN);*/\n\t\n    ap_log_error(APLOG_MARK, APLOG_ERR, 0, NULL, \"AKS:exiting %d process\", getpid()); \n    mpm_state = AP_MPMQ_STOPPING;\n\n    if (pchild) {\n        apr_pool_destroy(pchild);\n    }\n    ap_mpm_pod_close(pod);\n    chdir_for_gprof();\n    exit(code);\n}", "id": 168709, "time": "2013-07-22T09:36:05Z", "creator": "akshay.ballarpure@nsn.com", "creation_time": "2013-07-22T09:36:05Z", "is_private": false}, {"count": 6, "tags": [], "creator": "akshay.ballarpure@nsn.com", "attachment_id": null, "id": 168806, "time": "2013-07-26T12:10:03Z", "bug_id": 55239, "creation_time": "2013-07-26T12:10:03Z", "is_private": false, "text": "Can you please update us?  thanks."}, {"count": 7, "tags": [], "bug_id": 55239, "attachment_id": null, "id": 168807, "time": "2013-07-26T12:16:59Z", "creator": "covener@gmail.com", "creation_time": "2013-07-26T12:16:59Z", "is_private": false, "text": "Blocking signals makes them _not_ hang?   How long?\n\nCan you get a series of backtraces from one that's hanging and post it here?  \n\nDoes the server respond to new requests while some processes hang?"}, {"text": "all child httpd plus fast cgi processes will be killed immediately and started new processes on graceful restart.\n\nyou meant pstack and pfiles o/p on hanged processes ?\n\nApache/FCGI server were able to respond to new request for 6 hours after graceful restart.\n\nRegards,\nAkshay", "tags": [], "bug_id": 55239, "attachment_id": null, "count": 8, "id": 168808, "time": "2013-07-26T12:39:54Z", "creator": "akshay.ballarpure@nsn.com", "creation_time": "2013-07-26T12:39:54Z", "is_private": false}, {"count": 9, "tags": [], "creator": "akshay.ballarpure@nsn.com", "attachment_id": null, "id": 168877, "time": "2013-07-29T06:19:28Z", "bug_id": 55239, "creation_time": "2013-07-29T06:19:28Z", "is_private": false, "text": "Can you please update us .Thanks\n\n\n\nRegards,\nAkshay"}, {"count": 10, "tags": [], "bug_id": 55239, "attachment_id": null, "id": 168901, "time": "2013-07-29T11:27:21Z", "creator": "covener@gmail.com", "creation_time": "2013-07-29T11:27:21Z", "is_private": false, "text": "You haven't provided any detail describing a bug. At the very least, answer the previous quesions about how long the processes linger, what state they're in after the restart (pstack)."}, {"count": 11, "tags": [], "creator": "akshay.ballarpure@nsn.com", "attachment_id": 30649, "id": 168934, "time": "2013-07-30T06:19:07Z", "bug_id": 55239, "creation_time": "2013-07-30T06:19:07Z", "is_private": false, "text": "Created attachment 30649\npstack and pfiles o/p of lingering process\n\nhello,\nI am attaching here pstack and pfiles o/p for lingering process.\nWe are seeing process lingered for more than a week.\n\n\nRegards,\nAkshay"}, {"count": 12, "tags": [], "bug_id": 55239, "attachment_id": null, "id": 168939, "time": "2013-07-30T08:33:13Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2013-07-30T08:33:13Z", "is_private": false, "text": "\n\n*** This bug has been marked as a duplicate of bug 49504 ***"}]