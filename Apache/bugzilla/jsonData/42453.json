[{"count": 0, "tags": [], "creator": "tschafer@hotmail.com", "attachment_id": null, "text": "A request which takes longer than 5 minutes for tomcat to return a response\ncauses apache to return a 503 error to client while logging the following error:\n[Fri May 18 11:32:36 2007] [error] (OS 10060)A connection attempt failed because\nthe connected party did not properly respond after a period\n of time, or established connection failed because connected host has failed to\nrespond.  : ajp_ilink_receive() can't receive header\n[Fri May 18 11:32:36 2007] [error] ajp_read_header: ajp_ilink_receive failed\n[Fri May 18 11:32:36 2007] [error] (120006)APR does not understand this error\ncode: proxy: send body failed to (null) (*)\n\napache mod_proxy_ajp is configured to proxy requests to tomcat\nwith this addition to httpd.conf:\nProxyRequests Off\n<Proxy *>\nOrder deny,allow\nAllow from all\n</Proxy>\nProxyPass /webapp ajp://localhost/webapp\n\n\napache documentation implies there is no timeout for proxy requests.\nhttp://httpd.apache.org/docs/2.2/mod/mod_proxy.html\n\nIf timeout is hardcoded, then a request to enhance with a conf option\nIf timeout is adjustable, then a request to update documentation with mention of\ndefault timeout and conf option for changing\n\nVery enthused about upgrading from apache 2.0/mod_jk2 to apache 2.2/mod_proxy_ajp\nThis is the only known blocker to going live.\n\nGreat work integrating AJP into apache httpd. Much easier to use :)", "id": 103352, "time": "2007-05-18T12:44:06Z", "bug_id": 42453, "creation_time": "2007-05-18T12:44:06Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 42453, "text": "1. Timeout is adjustable (=> Timeout parameter at\nhttp://httpd.apache.org/docs/2.2/en/mod/mod_proxy.html#proxypass,\nProxyPass /webapp ajp://localhost/webapp timeout=1800 )\n2. It is documented, but the documentation might be misleading (=>\nhttp://httpd.apache.org/docs/2.2/en/mod/mod_proxy.html#proxypass)", "id": 103355, "time": "2007-05-18T14:34:20Z", "creator": "rpluem@apache.org", "creation_time": "2007-05-18T14:34:20Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "mail@dekies.de", "attachment_id": null, "text": "I have similar problems with my application. If there is a high request count,\nthe client will get a 503 error. I have two apaches (accessed by round robin\ndns) and two tomcats. So if one of them fails, the other one should handle the\nrequests. Unfortunately this doesn't work, both fail at the same time :-(\n\nThe apache error log shows the following:\n[error] ajp_read_header: ajp_ilink_receive failed\n[error] (120006)APR does not understand this error code: proxy: send body failed\nto (null) (x.x.x.x)\n[error] (70007)The timeout specified has expired: ajp_ilink_receive() can't\nreceive header\n\nThe tomcat logs contain broken pipe errors and IOExceptions, but I found in\n#38489 that this is the expected behaviour.\norg.apache.jk.core.MsgContext action\nWARNING: Error sending end packet\njava.net.SocketException: Broken pipe\n        at java.net.SocketOutputStream.socketWrite0(Native Method)\n        at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:92)\n        at java.net.SocketOutputStream.write(SocketOutputStream.java:136)\n        at org.apache.jk.common.ChannelSocket.send(ChannelSocket.java:531)\n       \nAug 17, 2007 1:12:44 PM org.apache.jk.common.ChannelSocket processConnection\nWARNING: processCallbacks status 2\n\n java.io.IOException\n        at org.apache.jk.common.JkInputStream.receive(JkInputStream.java:190)\n        at org.apache.jk.common.JkInputStream.doRead(JkInputStream.java:164)\n        at org.apache.coyote.Request.doRead(Request.java:418)\n        at\norg.apache.catalina.connector.InputBuffer.realReadBytes(InputBuffer.java:284\n)\n        at org.apache.tomcat.util.buf.ByteChunk.substract(ByteChunk.java:371)\n        at org.apache.catalina.connector.InputBuffer.readByte(InputBuffer.java:293)\n        at\norg.apache.catalina.connector.CoyoteInputStream.read(CoyoteInputStream.java:\n104)\n\n\nThe issue #36495 deals with similar problems. So I tried to set MaxClients to\n512 and keepalive=On (without success). Tomcat maxThreads is 1024.\n\n-- start of my config --\nServerLimit 1024\nMaxClients 1024\nKeepAlive On\nKeepAliveTimeout 5\nMaxKeepAliveRequests 20\n<IfModule mod_proxy.c>\n  ProxyRequests Off\n  ProxyTimeout 60\n  <Location /instance0>\n     ProxyPass balancer://instance0 stickysession=JSESSIONID\nlbmethod=byrequests\n  </Location>\n  \n  <Proxy balancer://instance0>\n     BalancerMember ajp://[host1-ip]:20009/instance0 route=node1 min=2 smax=5\n     BalancerMember ajp://[host2-ip]:20009/instance0 route=node2 min=2 smax=5\n  </Proxy>\n\n  <Location /instance1>\n      ProxyPass balancer://b2binstance1 stickysession=JSESSIONID lbmethod=byrequests\n  </Location>\n\n  <Proxy balancer://instance1>\n      BalancerMember ajp://[host1-ip]:21009/instance1 route=node1 min=2 smax=5\n      BalancerMember ajp://[host2-ip]:21009/instance1 route=node2 min=2 smax=5\n  </Proxy>\n</IfModule>\n-- config end --\n\nIt's exasperating...hope that somebody can give me a hint.\n\nenvironment: Apache 2.2.4, SunOS 5.8, Tomcat 5.5.20, JDK 1.5\n", "id": 107043, "time": "2007-08-22T11:32:53Z", "bug_id": 42453, "creation_time": "2007-08-22T11:32:53Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 42453, "attachment_id": null, "id": 107046, "time": "2007-08-22T12:28:40Z", "creator": "rpluem@apache.org", "creation_time": "2007-08-22T12:28:40Z", "is_private": false, "text": "Try adding an explicit timeout parameter to your BalancerMembers. ProxyTimeout\napplication is broken in 2.2.4 but will be fixed in the next 2.2.x release."}, {"count": 4, "tags": [], "creator": "mail@dekies.de", "attachment_id": null, "text": "Thanks for the quick response. Here's the new config, I'll try now:\n\n<Location /b2b-instance0>\n   ProxyPass balancer://b2binstance0 stickysession=JSESSIONID\nlbmethod=byrequests timeout=60\n</Location>\n\n<Proxy balancer://b2binstance0>\n   BalancerMember ajp://212.6.120.198:20009/b2b-instance0 route=node1 min=2\nsmax=5 timeout=60\n   BalancerMember ajp://212.6.120.199:20009/b2b-instance0 route=node2 min=2\nsmax=5 timeout=60\n</Proxy>", "id": 107156, "time": "2007-08-23T04:51:51Z", "bug_id": 42453, "creation_time": "2007-08-23T04:51:51Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 42453, "text": "(In reply to comment #4)\n> Thanks for the quick response. Here's the new config, I'll try now:\n> \n> <Location /b2b-instance0>\n>    ProxyPass balancer://b2binstance0 stickysession=JSESSIONID\n> lbmethod=byrequests timeout=60\n\nThe timeout parameter for a balancer has a different meaning that you might not\ndesire (http://httpd.apache.org/docs/2.2/en/mod/mod_proxy.html#proxypass). So I\nwould omit it here.\n\n", "id": 107167, "time": "2007-08-23T09:13:40Z", "creator": "rpluem@apache.org", "creation_time": "2007-08-23T09:13:40Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 42453, "text": "Ok seems to be better than before...now only one Apache had problems to connect\nto the tomcats. The other one was fine.\n\nAfter a graceful restart, found this many times in error log:\n(9)Bad file number: apr_socket_accept: (client socket)", "id": 107676, "time": "2007-09-04T01:13:46Z", "creator": "mail@dekies.de", "creation_time": "2007-09-04T01:13:46Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 42453, "text": "\"(9)Bad file number: apr_socket_accept: (client socket)\"\n\nindicative of something bogus in the socket stack, such as the host of various\n'web filtering' products that weren't completely implemented for the ws2api.\n\nPlease confirm that a clean machine (no extra network drivers) does not have\nthis issue; in the interim, closing as a config/socket stack mistake.\n", "id": 112342, "time": "2007-12-30T23:18:16Z", "creator": "wrowe@apache.org", "creation_time": "2007-12-30T23:18:16Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "text": "After months of testing I switched to http to avoid the problem. It's a pity \nthat mod_proxy_ajp doesn't work as stable as mod_jk before.", "attachment_id": null, "id": 112353, "creator": "mail@dekies.de", "time": "2007-12-31T03:32:32Z", "bug_id": 42453, "creation_time": "2007-12-31T03:32:32Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 42453, "text": "Revisiting this problem with an installation from\napache_2.2.8-win32-x86-openssl-0.9.8g.msi\n\nI've found that using:\nProxyPass /webapp ajp://localhost/webapp timeout=1800\nDoesn't have the desired effect.\n\nHowever adding:\nTimeout 1800\nto httpd.conf will result in allowing a longer running tomcat request to\nsuccessfully return it's result, regardless of whether timeout=1800 was added to\nthe ProxyPass\n\nIs there any way to configure apache to allow a ProxyPass to run longer than the\nstandard Timeout without overriding it for the entire URL space?\n", "id": 113502, "time": "2008-02-06T18:38:37Z", "creator": "tschafer@hotmail.com", "creation_time": "2008-02-06T18:38:37Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "text": "(In reply to comment #9)\n> Revisiting this problem with an installation from\n> apache_2.2.8-win32-x86-openssl-0.9.8g.msi\n> \n> I've found that using:\n> ProxyPass /webapp ajp://localhost/webapp timeout=1800\n> Doesn't have the desired effect.\n> \n\nI cannot reproduce this. It works and has the desired effect. It is likely that\nthe worker ajp://localhost/webapp is not used. Do you have any other ProxyPass\nsettings, <proxy> blocks or rewrite rules in your configuration?", "id": 113551, "time": "2008-02-07T12:29:09Z", "bug_id": 42453, "creation_time": "2008-02-07T12:29:09Z", "is_private": false}]