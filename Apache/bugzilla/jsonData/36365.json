[{"count": 0, "tags": [], "bug_id": 36365, "text": "I have Tomcat redirector plugin DLL, isapi_redirector.dll (1.2.14)\nplugin installed in IIS 5.1. I am using this redirector to connect IIS with\nJBoss. I have configured isapi to redirect uri with /tc/* using\nworkers.properties and uriworkermap.properties. Also, Using the IIS\nmanagement console, added a new virtual directory to my IIS  web site.\nThe name of the virtual directory given is tomcat and the\nisapi_redirector.dll seems to be loaded i.e I see green arrow.\n\n BTW, I have a created a directory and it has isapi_redirector.dll,\nworkers.properties, uriworkermap.properties,\nisapi_redirector-1.2.14.reg.\n\n \nContents of isapi_redirector-1.2.14.reg :\nWindows Registry Editor Version 5.00\n[HKEY_LOCAL_MACHINE\\SOFTWARE\\Apache Software Foundation\\Jakarta Isapi\nRedirector\\1.0]\n\"extension_uri\"=\"/tomcat/isapi_redirect.dll\"\n\"log_file\"=\"C:\\\\Temp\\\\jk_iis.log\"\n\"log_level\"=\"debug\"\n\"worker_file\"=\"E:\\\\isapi_redirect1.2.14\\\\workers.properties\"\n\"worker_mount_file\"=\"E:\\\\isapi_redirect1.2.14\\\\uriworkermap.properties\"\n\nContents of uriworkermap.properties:\n# Send all /tc requests to node1\n/tc/*=node1\n\nContents of workers.properties:\nworker.list=node1\nworker.node1.port=8009\nworker.node1.host=beaorchardj01.net.plm.eds.com\nworker.node1.type=ajp13\n\nBut when a request of the below form is sent:\nOPTIONS /tc/FileAccess HTTP/1.1\nUser-Agent: DAKCLIENT/6.0\nAccept-Language: en-US\nHost: beaorchardj01.net.plm.eds.com\n\nI receive the below message:\nHTTP/1.1 500 Server Error\nServer: Microsoft-IIS/5.1\nDate: Thu, 18 Aug 2005 20:57:39 GMT\nConnection: close\nContent-Type: text/html\nContent-Length: 87\n\n<html><head><title>Error</title></head><body>The parameter is incorrect. \n</body></html>\n\nBesides OPTIONS, PUT is another HTTP request that seems to be blocked. BUT, \nI seem to have no problem connecting to JBoss with request like POST,\nGET, SEARCH. \n\nIn ISAPI logs for OPTIONS:\n[Fri Aug 12 09:14:23 2005] [0352:4100] [debug]\nHttpFilterProc::jk_isapi_plugin.c (747): Filter started [Fri Aug 12\n09:14:23 2005] [0352:4100] [debug] HttpFilterProc::jk_isapi_plugin.c\n(813): Virtual Host redirection of\n/beaorchardj01.net.plm.eds.com/tc/FileAccess/\n[Fri Aug 12 09:14:23 2005] [0352:4100] [debug]\nmap_uri_to_worker::jk_uri_worker_map.c (449): Attempting to map URI\n'/beaorchardj01.net.plm.eds.com/tc/FileAccess/' from 1 maps [Fri Aug 12\n09:14:23 2005] [0352:4100] [debug]\nmap_uri_to_worker::jk_uri_worker_map.c (461): Attempting to map context\nURI '/tc/*'\n[Fri Aug 12 09:14:23 2005] [0352:4100] [debug]\nHttpFilterProc::jk_isapi_plugin.c (820): Default redirection of\n/tc/FileAccess/ [Fri Aug 12 09:14:23 2005] [0352:4100] [debug]\nmap_uri_to_worker::jk_uri_worker_map.c (449): Attempting to map URI\n'/tc/FileAccess/' from 1 maps [Fri Aug 12 09:14:23 2005] [0352:4100]\n[debug] map_uri_to_worker::jk_uri_worker_map.c (461): Attempting to map\ncontext URI '/tc/*'\n[Fri Aug 12 09:14:23 2005] [0352:4100] [debug]\nmap_uri_to_worker::jk_uri_worker_map.c (475): Found a wildchar match\nnode1 -> /tc/*\n[Fri Aug 12 09:14:23 2005] [0352:4100] [debug]\nHttpFilterProc::jk_isapi_plugin.c (830): check if [/tc/FileAccess/] is\npoints to the web-inf directory [Fri Aug 12 09:14:23 2005] [0352:4100]\n[debug] HttpFilterProc::jk_isapi_plugin.c (848): [/tc/FileAccess/] is a\nservlet url - should redirect to node1\n\nDO NOT see below statements from isapi for OPTIONS:\n[Fri Aug 12 09:14:23 2005] [0352:3556] [debug]\nwc_get_worker_for_name::jk_worker.c (111): found a worker node1 [Fri Aug\n12 09:14:23 2005] [0352:3556] [debug]\nHttpExtensionProc::jk_isapi_plugin.c (1003): got a worker for name node1\n\n\nIn IIS logs:\n#Software: Microsoft Internet Information Services 5.1\n#Version: 1.0\n#Date: 2005-08-18 20:42:01\n#Fields: date time c-ip cs-username s-sitename s-computername s-ip s-port \ncs-method cs-uri-stem cs-uri-query sc-status sc-win32-status sc-bytes \ncs-bytes time-taken cs-version cs-host cs(User-Agent) cs(Cookie) cs(Referer) \n2005-08-18 20:47:31 134.244.174.103 - W3SVC1 BEAORCHARDJ01 134.244.174.103 \n80 OPTIONS /tc/FileAccess/ - 500 87 0 124 0 HTTP/1.1 \nbeaorchardj01.net.plm.eds.com DAKCLIENT/6.0 - -\n\nIIS log for POST:\n2005-08-18 20:42:01 134.244.174.103 - W3SVC1 BEAORCHARDJ01 134.244.174.103 \n80 POST /tc/controller/gatewayPostserviceLogin_link - 200 0 413 487 47 \nHTTP/1.1 beaorchardj01.net.plm.eds.com:8888 Jakarta+Commons-HttpClient/2.0.2 \nJSESSIONID=93841C7C5271EE1532659A59D1A5B69D -\n\nOPTIONS and PUT seem to WORK FINE when I move to IIS 6.0 and \nisapi_redirector.dll(1.2.14) OR Use II5.1 with deprecated version of isapi \nredirector (JK2).\n\nPlease help....... This is very urgent. BTW, I have IIS 5.1 and working\non WinXp Professional Version 2002 Sp2.\n\n\nWe contacted Microsoft IIS developer for help. This is what they had to say:\n\"We have isolated the issue that IIS is capable of handling the HTTP OPTIONS \nand PUT requests by enabling WebDAV.Please contact the 3rd party vendor of \nisapi_redirector.dll.\"\n\nThanks....", "id": 79024, "time": "2005-08-26T00:52:40Z", "creator": "usha.nayak@ugsplm.com", "creation_time": "2005-08-26T00:52:40Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 36365, "text": "*** Bug 36463 has been marked as a duplicate of this bug. ***", "id": 79328, "time": "2005-09-02T13:18:58Z", "creator": "rolf.baenziger@franke.com", "creation_time": "2005-09-02T13:18:58Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 36365, "attachment_id": null, "id": 97219, "time": "2006-12-24T08:39:16Z", "creator": "yoavs@computer.org", "creation_time": "2006-12-24T08:39:16Z", "is_private": false, "text": "First, I'm downgrading the priority of this issue to reflect reality: seeing as\nhow many releases have been issued since this problem was reported, it's clearly\nnot a blocker for releases.\n\nSecond, I've finally gotten a bit of time to try and reproduce this, and I\nhaven't been able to.  I'm using Tomcat 5.5.20 and newer connectors on Windows\nXP, so the test is not exactly the same environment as yours.  Maybe this has\nbeen fixed in newer connectors, or maybe it's gone away for you, or maybe\nsomething else has happened meanwhile.  Either way, this WORKSFORME now.\n\nI'm definitely not an IIS expert.  If this issue persists for you with the most\nrecent versions of Tomcat and the connectors, feel free to reopen this."}, {"count": 3, "tags": [], "bug_id": 36365, "attachment_id": null, "id": 97309, "time": "2006-12-25T22:04:47Z", "creator": "Tim.Whittington@orionhealth.com", "creation_time": "2006-12-25T22:04:47Z", "is_private": false, "text": "I'm having the same issue as this (and Bug 36463) with PUTs to an IIS 5.1 on XP Pro.\n\nWhen with a pre 1.2.20 yields the \"Parameter is Incorrect\" error from IIS.\nThe FilterProc seems to work fine, but the ExtensionProc is never reached, so it\nappears to be failing somewhere in-between.\n\nAs mentioned in Bug 36463. I have older builds that this works fine for on the\nsame box, although I thought they were 1.2.6 - I'll have to double check.\n\nA quick SVN diff indicates that quite a bit has changed - I'm going to check if\nit's the custom IIS logging that's broken things.\n\nThis is definitely an issue - I just can't tell you what causes it yet."}, {"count": 4, "tags": [], "text": "Re-opening based on previous comment.", "attachment_id": null, "id": 97317, "creator": "markt@apache.org", "time": "2006-12-26T06:09:20Z", "bug_id": 36365, "creation_time": "2006-12-26T06:09:20Z", "is_private": false}, {"count": 5, "tags": [], "creator": "Tim.Whittington@orionhealth.com", "attachment_id": null, "text": "I've narrowed down what is happening here.\n\nThis seems to be due to a combination of:\n- IIS 5.1\n- The SF_NOTIFY_AUTH_COMPLETE event being used instead of SF_NOTIFY_PREPROC_HEADERS\n- Modifying the special \"uri\" header (via SetHeader) in HttpFilterProc to point\nto the extension URI (e.g. performing the redirection).\n- Making a request with an OPTIONS or PUT method (there could be others that\ndon't work, but POST and GET are fine).\n\nI don't know why this is the case, and I can't trace the root cause of the\n\"Parameter is Incorrect\" error.\n(with extended logging IIS reports an 87 - ERROR_INVALID_PARAMETER in the logs)\n\nChanging HttpFilterProc to trap SF_NOTIFY_PREPROC_HEADERS on IIS 5.1 fixes the\nproblem, but could break other things.\nBtw, his is why much older builds of the connector worked - the\nSF_NOTIFY_AUTH_COMPLETE was added at a later point.\n\nReading\nhttp://msdn.microsoft.com/library/default.asp?url=/library/en-us/iissdk/html/28d1ea12-9d69-49d5-9605-6915e5145710.asp\nwe don't seem to be using the authenticated user identity, but we may depend on\nthe filter being hit after authentication to allow website auth to apply before\nJK is hit.\n\nIn short, we can 'fix' this one of two ways:\n- Break IIS 5.1 for PUT/OPTIONS - e.g. don't fix it\n- Change IIS 5.1 to respond to the SF_NOTIFY_PREPROC_HEADERS event, which is not\nso good as the behaviour will differ from IIS 5.0/6.0.\n\nI'm open to suggestions - I don't really have many other options available apart\nfrom pinging MS again.\n", "id": 97426, "time": "2006-12-28T16:59:48Z", "bug_id": 36365, "creation_time": "2006-12-28T16:59:48Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 36365, "text": "Looking at the JK2 code, the use of the auth notification was made configurable\nby an ini file/registry directive for IIS >= 5, which is another option.\nOne of Gal/Larry/Ignacio might have some further ideas about why this flag was\nincluded.", "id": 97431, "time": "2006-12-29T00:36:49Z", "creator": "Tim.Whittington@orionhealth.com", "creation_time": "2006-12-29T00:36:49Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 36365, "attachment_id": 19342, "id": 97547, "time": "2007-01-02T16:25:18Z", "creator": "Tim.Whittington@orionhealth.com", "creation_time": "2007-01-02T16:25:18Z", "is_private": false, "text": "Created attachment 19342\nFix for SF_NOTIFY_AUTH_COMPLETE not working on IIS 5.1\n\nI've created a patch to fix this, which is based on the JK2 code.\nThe IIS version is checked in the registry during Filter init and the correct\nevents registered.\n\nThis duplicates the IIS5 check in HttpFilterProc, so I've factored that out."}, {"count": 8, "tags": [], "creator": "Tim.Whittington@orionhealth.com", "attachment_id": null, "text": "Can we get this issue patched - I've suddenly got a cluster of products that\nhave decided to use HTTP PUTs through IIS, and this is breaking the development\nenvironments.\n", "id": 98530, "time": "2007-01-25T15:14:18Z", "bug_id": 36365, "creation_time": "2007-01-25T15:14:18Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 36365, "text": "I have beckported that option from JK2.\n\nAdd registry DWORD 'auth_complete' directive\n0 (disabled) - uses SF_NOTIFY_PREPROC_HEADERS\n1 (enabled, default) - uses SF_NOTIFY_AUTH_COMPLETE if IIS >= 5.0\n\nSo, add auth_complete:0 to the registry and test on 5.1\nIt should use PREPROC_HEADERS notification.", "id": 98815, "time": "2007-01-31T00:41:23Z", "creator": "mturk@apache.org", "creation_time": "2007-01-31T00:41:23Z", "is_private": false, "attachment_id": null}]