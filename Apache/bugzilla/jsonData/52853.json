[{"count": 0, "tags": [], "text": "I am running an embedded container that loads the web application classes and external JARS using the method WebappLoader#addRepository(java.lang.String). One of the external JARs is spring-web with version 3.1. That JAR file provides the class SpringServletContainerInitializer annotated with @HandlesTypes to load implementations of WebApplicationInitializer for web apps that don't provide a web.xml.\n\nIn my application I provide an implementation of WebApplicationInitializer. This is found if I add my compiled class files as JAR file using WebappLoader#addRepository(java.lang.String) - the web application gets configured correctly. However, adding the classes directory instead will not resolve the class. This sounds like some kind of class loading issue to me.\n\nAs a side-note the web application is loaded just fine when you provide a web.xml (Servlet compatibility < 3.0). All classes can be resolved and used. You can have a look at the source code here: https://github.com/bmuschko/gradle-tomcat-plugin/blob/master/plugin/src/main/groovy/org/gradle/api/plugins/tomcat/TomcatRun.groovy#L70", "is_private": false, "id": 154671, "creator": "benjamin.muschko@gmail.com", "time": "2012-03-08T02:55:40Z", "bug_id": 52853, "creation_time": "2012-03-08T02:55:40Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 52853, "attachment_id": null, "id": 154763, "time": "2012-03-09T19:24:13Z", "creator": "markt@apache.org", "creation_time": "2012-03-09T19:24:13Z", "is_private": false, "text": "Supporting locations for JARs outside of WEB-INF/lib and classes outside of WEB-INF/classes goes beyond what the specification requires but since they are regularly requested features Tomcat does have mechanisms for doing this.\n\nHowever, for performance reasons, not all of the functionality that is enabled for the standard WEB-INF locations works for the extended locations. In this case, JARs are scanned by default, directories are not. To change this you need to explicitly configure the JarScanner [1] with scanAllDirectories=\"true\".\n\nThe users list is the place to seek further assistance if you require it.\n\n[1] http://tomcat.apache.org/tomcat-7.0-doc/config/jar-scanner.html"}, {"count": 2, "tags": [], "bug_id": 52853, "attachment_id": null, "id": 154784, "time": "2012-03-10T17:10:31Z", "creator": "benjamin.muschko@gmail.com", "creation_time": "2012-03-10T17:10:31Z", "is_private": false, "text": "Thanks for the pointer. Unfortunately, setting scanAllDirectories to true didn't work for me. I will take this to the users list."}, {"count": 3, "tags": [], "creator": "benjamin.muschko@gmail.com", "is_private": false, "id": 154919, "attachment_id": null, "bug_id": 52853, "creation_time": "2012-03-14T23:31:53Z", "time": "2012-03-14T23:31:53Z", "text": "Unfortunately, I didn't get a satisfying answer on the Tomcat user mailing list: http://tomcat.10.n6.nabble.com/HandlesTypes-not-resolving-classes-when-added-as-repository-directory-td4565554.html. Therefore, I am going to reopen this as a bug as there potentially might be an issue. Can you either give me other suggestions or have a deeper look? I'd be happy to provide examples or source code. Thanks!"}, {"count": 4, "tags": [], "bug_id": 52853, "attachment_id": null, "id": 154928, "time": "2012-03-15T09:03:44Z", "creator": "markt@apache.org", "creation_time": "2012-03-15T09:03:44Z", "is_private": false, "text": "The simplest possible test case (as source code) that exhibits this issue would be great. I can't stress the \"simplest possible\" bit enough. Based on the description, I'd expect the simplest possible example to be a few small classes. Ideally, you should based you test case on the Tomcat unit tests and provide a diff against tomcat/trunk since that way the test can become part of the standard test suite. Don't worry too much about what class you put the test in. We'll move it if necessary."}, {"count": 5, "tags": [], "creator": "benjamin.muschko@gmail.com", "attachment_id": null, "id": 154968, "time": "2012-03-16T01:39:34Z", "bug_id": 52853, "creation_time": "2012-03-16T01:39:34Z", "is_private": false, "text": "I will try to provide an example that runs an embedded container. I had a look at this repository https://github.com/apache/tomcat70 but couldn't find an example for running tests on an embedded Tomcat container. Is there an already existing setup that I can retrofit to start up an embedded container (including added the embedded Tomcat JARs to the classpath)?"}, {"count": 6, "tags": [], "text": "(In reply to comment #5)\n> I will try to provide an example that runs an embedded container.\n\nThat would be a question for the users@ list, but I'll answer shortly. See\n1) http://tomcat.apache.org/svn.html\n2) RUNNING.txt\n3) TomcatBaseTest class\n\nYou may also want to look at bug #52669 and r1244718 that fixed it. It might be that something is still missing there.", "is_private": false, "id": 154970, "creator": "knst.kolinko@gmail.com", "time": "2012-03-16T03:08:06Z", "bug_id": 52853, "creation_time": "2012-03-16T03:08:06Z", "attachment_id": null}, {"count": 7, "tags": [], "text": "> 2) RUNNING.txt\nand BUILDING.txt", "is_private": false, "id": 154971, "creator": "knst.kolinko@gmail.com", "time": "2012-03-16T03:09:03Z", "bug_id": 52853, "creation_time": "2012-03-16T03:09:03Z", "attachment_id": null}, {"count": 8, "tags": [], "text": "Waiting for a test case that reproduces this.", "is_private": false, "id": 155321, "creator": "markt@apache.org", "time": "2012-03-27T18:13:35Z", "bug_id": 52853, "creation_time": "2012-03-27T18:13:35Z", "attachment_id": null}, {"count": 9, "text": "I started to create a test case for this issue but I am not sure if it is actually working as I was not able to run the tests using Ant. When asking the question on the mailing list I didn't get a response: http://tomcat.10.n6.nabble.com/Build-Tomcat-from-sources-on-GitHub-repo-td4884681.html. Do you guys know what I am doing wrong? You can find my test case class (org.apache.catalina.loader.TestHandleTypesWebappLoader.java) here:\n\nhttps://github.com/bmuschko/tomcat70/blob/webapp-3.0-spring/test/org/apache/catalina/loader/TestHandleTypesWebappLoader.java\n\nAny help would be highly appreciated.", "bug_id": 52853, "attachment_id": null, "id": 158166, "time": "2012-04-18T12:50:10Z", "creator": "benjamin.muschko@gmail.com", "creation_time": "2012-04-18T12:50:10Z", "tags": [], "is_private": false}, {"count": 10, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "id": 158184, "time": "2012-04-18T21:53:37Z", "bug_id": 52853, "creation_time": "2012-04-18T21:53:37Z", "is_private": false, "text": "(In reply to comment #9)\n> When asking the\n> question on the mailing list I didn't get a response:\n> http://tomcat.10.n6.nabble.com/Build-Tomcat-from-sources-on-GitHub-repo-td4884681.html.\n\nThere is no such question in the mailing list archives. You were fooled by Nabble  - it did not sent the e-mail on your behalf, or it sent it so that it was rejected. You may notice that that page has a yellow warning line.\n\nI'd say that you have to subscribe to the mailing list properly.\nhttp://tomcat.apache.org/lists.html\n\nAnyway, you had to search the archives, as you are not the first one asking this question:\nhttp://markmail.org/message/ioay3hmulyp7o74w"}, {"count": 11, "tags": [], "bug_id": 52853, "attachment_id": null, "id": 158199, "time": "2012-04-19T12:11:17Z", "creator": "cbeams@gmail.com", "creation_time": "2012-04-19T12:11:17Z", "is_private": false, "text": "Thanks Benjamin for tackling this.  I just ran into it today while putting together a Gradle-based demo showing off Spring 3.1 features (which includes web.xml-free configuration via Spring's WebApplicationInitializer).\n\nNote that the 2.0-SNAPSHOT version of the tomcat7-maven-plugin does work just fine, so it must be possible against the existing embedded Tomcat bits.  Take a look at https://github.com/rstoyanchev/spring-mvc-async-sample for a very simple example of this in action.\n\nPerhaps just studying what the Maven plugin is doing differently and following suit in the Gradle plugin will be enough?"}, {"count": 12, "tags": [], "text": "Thanks for the pointer, Chris. I will certainly check out the plugin code.", "attachment_id": null, "bug_id": 52853, "id": 158211, "time": "2012-04-20T02:00:47Z", "creator": "benjamin.muschko@gmail.com", "creation_time": "2012-04-20T02:00:47Z", "is_private": false}, {"count": 13, "tags": [], "creator": "benjamin.muschko@gmail.com", "attachment_id": null, "id": 158505, "time": "2012-04-28T22:40:50Z", "bug_id": 52853, "creation_time": "2012-04-28T22:40:50Z", "is_private": false, "text": "I cleaned up my test cases and made them work. Steps to reproduce:\n\n1) git clone git://github.com/bmuschko/tomcat70.git\n2) Add modules directory to sources.\n3) Add test entry to build.properties: test.entry=org.apache.catalina.loader.TestHandleTypesWebappLoader\n4) Run \"ant test\"\n\nYou should see the following results:\n\na) Test case 1 finds SpringServletContainerInitializer as the implementation was added as JAR file.\n\n[junit] INFO: Spring WebApplicationInitializers detected on classpath: [org.apache.tomcat.spring.example.SpringExampleWebApplicationInitializer@3e68cd79]\n\nb) Test case 2 doesn't find SpringServletContainerInitializer as the implementation was added as directory.\n\n[junit] INFO: No Spring WebApplicationInitializer types detected on classpath\n\nI hope this is enough information for you guys to have a look into this issue. Maybe I just don't have the correct setup or am missing a configuration setting. Please let me know if you need more information."}, {"count": 14, "tags": [], "text": "One more comment to my test code on Git. As a step between 1 and 2 you will need to switch to the branch \"webapp-3.0-spring\". I forgot to mention that.\n\n1.5) git checkout webapp-3.0-spring", "is_private": false, "id": 158506, "creator": "benjamin.muschko@gmail.com", "time": "2012-04-28T22:54:44Z", "bug_id": 52853, "creation_time": "2012-04-28T22:54:44Z", "attachment_id": null}, {"count": 15, "tags": [], "bug_id": 52853, "attachment_id": null, "id": 158507, "time": "2012-04-29T00:42:06Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2012-04-29T00:42:06Z", "is_private": false, "text": "(In reply to comment #14)\n> \n> 1.5) git checkout webapp-3.0-spring\n\nIf you want this to be included in Tomcat test suite, please make a patch in Unified Diff format and attach to the issue.\n\nThat is to cover \"intentionally submitted for inclusion in the Work\" clause in Apache License."}, {"count": 16, "text": "Created attachment 28694\nPatch to reproduce Bug 52853\n\nAs there is a limit on the upload size I could not include the required JAR files. Here's a list of them that you will need to put under the directory lib.\n\n* aopalliance-1.0.jar\n* cglib-nodep-2.2.2.jar\n* commons-logging-1.1.1.jar\n* jcl-over-slf4j-1.6.4.jar\n* logback-classic-1.0.0.jar\n* logback-core-1.0.0.jar\n* slf4j-api-1.6.4.jar\n* spring-aop-3.1.1.RELEASE.jar\n* spring-asm-3.1.1.RELEASE.jar\n* spring-beans-3.1.1.RELEASE.jar\n* spring-context-3.1.1.RELEASE.jar\n* spring-context-support-3.1.1.RELEASE.jar\n* spring-core-3.1.1.RELEASE.jar\n* spring-expression-3.1.1.RELEASE.jar\n* spring-web-3.1.1.RELEASE.jar\n* spring-webmvc-3.1.1.RELEASE.jar\n\nFor the first test case you will need to compile the source files and JAR them into a file called app.jar under target/lib. For the second test case you will need to compile the source files to target/classes/main\".", "bug_id": 52853, "attachment_id": 28694, "id": 158512, "time": "2012-04-29T14:31:32Z", "creator": "benjamin.muschko@gmail.com", "creation_time": "2012-04-29T14:31:32Z", "tags": [], "is_private": false}, {"count": 17, "tags": [], "bug_id": 52853, "is_private": false, "id": 158865, "attachment_id": null, "creator": "markt@apache.org", "creation_time": "2012-05-06T21:43:18Z", "time": "2012-05-06T21:43:18Z", "text": "That is really the simplest test case you could come up with? I think it is safe to say it will not be being added to Tomcat with all those dependencies. I'll look at the git based test case shortly."}, {"count": 18, "tags": [], "text": "Well, my use case is that fact that I am using Spring's implementation of WebApplicationInitializer. As you might know Spring does define transitive dependencies that are required to make it work so I could not dumb down the test case.\n\nI am totally fine with it not being added to the Tomcat test suite. First and foremost I want to find out if it is a potential bug in embedded Tomcat or if I am missing some configuration that needs to be set.", "attachment_id": null, "bug_id": 52853, "id": 158866, "time": "2012-05-06T22:03:58Z", "creator": "benjamin.muschko@gmail.com", "creation_time": "2012-05-06T22:03:58Z", "is_private": false}, {"count": 19, "tags": [], "text": "You could have simplified this to just the raw elements without any of the Spring libraries. Hey ho.\n\nI have tracked down what is going on. There are two parts to this.\n\nFirst of all this is never going to work unless (as per my remarks in comment #1) you enabled directory scanning. Your testStartInternalForClassesDirectory() method is missing the following line to do this:\n((StandardJarScanner) context.getJarScanner()).setScanAllDirectories(true);\n\nSecond, there is a subtlety to the Jar scanner that isn't clear in the docs and needs to be made clearer. A directory is only scanned (even if scanAllDirectories==true) if it is an expanded JAR file. Tomcat determines this by looking for a META-INF directory. If that doesn't exist, it isn't scanned. Therefore, you also need to create a directory \"/target/classes/main/META_INF\"\n\nWith those two changes, you'll see the behaviour you expect. The bug here is in the documentation that does not make that crystal clear. I'll get the docs updated.", "attachment_id": null, "bug_id": 52853, "id": 158867, "time": "2012-05-06T22:25:11Z", "creator": "markt@apache.org", "creation_time": "2012-05-06T22:25:11Z", "is_private": false}, {"count": 20, "tags": [], "bug_id": 52853, "attachment_id": null, "id": 158881, "time": "2012-05-07T13:59:46Z", "creator": "markt@apache.org", "creation_time": "2012-05-07T13:59:46Z", "is_private": false, "text": "Docs from trunk (r1335026) and 7.0.x (r1335027) updated and will be included in 7.0.28 onwards."}, {"count": 21, "tags": [], "bug_id": 52853, "attachment_id": null, "id": 158898, "time": "2012-05-08T01:46:32Z", "creator": "benjamin.muschko@gmail.com", "creation_time": "2012-05-08T01:46:32Z", "is_private": false, "text": "Thanks for pointing me towards the right solution, Mark. Works!"}]