[{"count": 0, "tags": [], "text": "Using the Cloud Foundry Java Client Libraries (https://github.com/cloudfoundry/cf-java-client), a WebSocket stream is used to stream logs from apps that are starting in Cloud Foundry.  The initial request is an HTTPS request that then should return an HTTP 101 to switch protocols to WebSockets.  If the headers for this response come in one read of the API, then the Tomcat WebSockets implementation has no issue, as in:\n\nHTTP/1.1 101 Switching Protocols\nUpgrade: websocket\nConnection: Upgrade\nSec-WebSocket-Accept: hkNdVhwFUAVd2BNAbrwraD5lyx4=\n<\\r\\n>\n\nHowever, if it takes a second read to get all the headers, Tomcat's WebSockets do not empty the buffer, causing a ReadBufferOverflowException, as in:\n\nHTTP/1.1 101 Switching Protocols\nSec-WebSocket-Accept: XtszcLxcZ+4QUaIvrLf7oi+r04M=\nDate: Fri, 03 Oct 2014 01:19:45 GMT\nX-Global-Transaction-ID: 217338896\nUpgrade: websocket\n\nAnd then another read:\n\nConnection: Upgrade\n<\\r\\n>\n\nThe stack trace for this problem is:\n\n!ENTRY org.cloudfoundry.ide.eclipse.server.core 4 0 2014-06-12 11:52:13.251\n!MESSAGE Failed to add application log listener for eyTestWeb3 - Error performing Cloud Foundry operation: javax.websocket.DeploymentException: The HTTP request to initiate the WebSocket connection failed\n!STACK 1\norg.eclipse.core.runtime.CoreException: Error performing Cloud Foundry operation: javax.websocket.DeploymentException: The HTTP request to initiate the WebSocket connection failed\nat org.cloudfoundry.ide.eclipse.server.core.internal.CloudErrorUtil.toCoreException(CloudErrorUtil.java:208)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.BaseClientRequest.runAndWait(BaseClientRequest.java:154)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.ClientRequest.runAndWait(ClientRequest.java:66)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.LocalServerRequest.runAndWait(LocalServerRequest.java:64)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.BaseClientRequest.run(BaseClientRequest.java:70)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.CloudFoundryServerBehaviour.addApplicationLogListener(CloudFoundryServerBehaviour.java:782)\nat org.cloudfoundry.ide.eclipse.server.ui.internal.console.ApplicationLogConsoleStream.initialiseStream(ApplicationLogConsoleStream.java:82)\nat org.cloudfoundry.ide.eclipse.server.ui.internal.console.CloudFoundryConsole.getStream(CloudFoundryConsole.java:84)\nat org.cloudfoundry.ide.eclipse.server.ui.internal.console.CloudFoundryConsole.startTailing(CloudFoundryConsole.java:64)\nat org.cloudfoundry.ide.eclipse.server.ui.internal.console.ConsoleManager.startConsole(ConsoleManager.java:112)\nat org.cloudfoundry.ide.eclipse.server.ui.internal.CloudFoundryUiCallback.startApplicationConsole(CloudFoundryUiCallback.java:79)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.CloudFoundryServerBehaviour$RestartOperation.performDeployment(CloudFoundryServerBehaviour.java:2643)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.CloudFoundryServerBehaviour$StartOperation.performDeployment(CloudFoundryServerBehaviour.java:2232)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.CloudFoundryServerBehaviour$PushApplicationOperation.performDeployment(CloudFoundryServerBehaviour.java:2460)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.CloudFoundryServerBehaviour$ApplicationOperation.performOperation(CloudFoundryServerBehaviour.java:1994)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.AbstractDeploymentOperation.run(AbstractDeploymentOperation.java:42)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.CloudFoundryServerBehaviour.publishModule(CloudFoundryServerBehaviour.java:1367)\nat org.eclipse.wst.server.core.model.ServerBehaviourDelegate.publishModule(ServerBehaviourDelegate.java:1091)\nat org.eclipse.wst.server.core.model.ServerBehaviourDelegate.publishModules(ServerBehaviourDelegate.java:1183)\nat org.eclipse.wst.server.core.model.ServerBehaviourDelegate.publish(ServerBehaviourDelegate.java:987)\nat org.eclipse.wst.server.core.model.ServerBehaviourDelegate.publish(ServerBehaviourDelegate.java:774)\nat org.eclipse.wst.server.core.internal.Server.publishImpl(Server.java:3154)\nat org.eclipse.wst.server.core.internal.Server$PublishJob.run(Server.java:345)\nat org.eclipse.core.internal.jobs.Worker.run(Worker.java:53)\nCaused by: org.cloudfoundry.client.lib.CloudOperationException: javax.websocket.DeploymentException: The HTTP request to initiate the WebSocket connection failed\nat org.cloudfoundry.client.lib.rest.LoggregatorClient.connectToLoggregator(LoggregatorClient.java:45)\nat org.cloudfoundry.client.lib.rest.CloudControllerClientImpl.streamLoggregatorLogs(CloudControllerClientImpl.java:1634)\nat org.cloudfoundry.client.lib.rest.CloudControllerClientImpl.streamLogs(CloudControllerClientImpl.java:233)\nat org.cloudfoundry.client.lib.CloudFoundryClient.streamLogs(CloudFoundryClient.java:336)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.CloudFoundryServerBehaviour$19.doRun(CloudFoundryServerBehaviour.java:778)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.CloudFoundryServerBehaviour$19.doRun(CloudFoundryServerBehaviour.java:1)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.BaseClientRequest.runAndWait(BaseClientRequest.java:127)\n... 22 more\nCaused by: javax.websocket.DeploymentException: The HTTP request to initiate the WebSocket connection failed\nat org.apache.tomcat.websocket.WsWebSocketContainer.connectToServer(WsWebSocketContainer.java:315)\nat org.cloudfoundry.client.lib.rest.LoggregatorClient.connectToLoggregator(LoggregatorClient.java:42)\n... 28 more\nCaused by: java.util.concurrent.ExecutionException: org.apache.tomcat.websocket.ReadBufferOverflowException\nat org.apache.tomcat.websocket.AsyncChannelWrapperSecure$WrapperFuture.get(AsyncChannelWrapperSecure.java:508)\nat org.apache.tomcat.websocket.WsWebSocketContainer.processResponse(WsWebSocketContainer.java:542)\nat org.apache.tomcat.websocket.WsWebSocketContainer.connectToServer(WsWebSocketContainer.java:296)\n... 29 more\nCaused by: org.apache.tomcat.websocket.ReadBufferOverflowException\nat org.apache.tomcat.websocket.AsyncChannelWrapperSecure$ReadTask.run(AsyncChannelWrapperSecure.java:305)\nat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1121)\nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:614)\nat java.lang.Thread.run(Thread.java:777)\n!SUBENTRY 1 org.cloudfoundry.ide.eclipse.server.core 4 0 2014-06-12 11:52:13.254\n!MESSAGE Error performing Cloud Foundry operation: javax.websocket.DeploymentException: The HTTP request to initiate the WebSocket connection failed\n!STACK 0\norg.cloudfoundry.client.lib.CloudOperationException: javax.websocket.DeploymentException: The HTTP request to initiate the WebSocket connection failed\nat org.cloudfoundry.client.lib.rest.LoggregatorClient.connectToLoggregator(LoggregatorClient.java:45)\nat org.cloudfoundry.client.lib.rest.CloudControllerClientImpl.streamLoggregatorLogs(CloudControllerClientImpl.java:1634)\nat org.cloudfoundry.client.lib.rest.CloudControllerClientImpl.streamLogs(CloudControllerClientImpl.java:233)\nat org.cloudfoundry.client.lib.CloudFoundryClient.streamLogs(CloudFoundryClient.java:336)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.CloudFoundryServerBehaviour$19.doRun(CloudFoundryServerBehaviour.java:778)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.CloudFoundryServerBehaviour$19.doRun(CloudFoundryServerBehaviour.java:1)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.BaseClientRequest.runAndWait(BaseClientRequest.java:127)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.ClientRequest.runAndWait(ClientRequest.java:66)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.LocalServerRequest.runAndWait(LocalServerRequest.java:64)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.BaseClientRequest.run(BaseClientRequest.java:70)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.CloudFoundryServerBehaviour.addApplicationLogListener(CloudFoundryServerBehaviour.java:782)\nat org.cloudfoundry.ide.eclipse.server.ui.internal.console.ApplicationLogConsoleStream.initialiseStream(ApplicationLogConsoleStream.java:82)\nat org.cloudfoundry.ide.eclipse.server.ui.internal.console.CloudFoundryConsole.getStream(CloudFoundryConsole.java:84)\nat org.cloudfoundry.ide.eclipse.server.ui.internal.console.CloudFoundryConsole.startTailing(CloudFoundryConsole.java:64)\nat org.cloudfoundry.ide.eclipse.server.ui.internal.console.ConsoleManager.startConsole(ConsoleManager.java:112)\nat org.cloudfoundry.ide.eclipse.server.ui.internal.CloudFoundryUiCallback.startApplicationConsole(CloudFoundryUiCallback.java:79)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.CloudFoundryServerBehaviour$RestartOperation.performDeployment(CloudFoundryServerBehaviour.java:2643)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.CloudFoundryServerBehaviour$StartOperation.performDeployment(CloudFoundryServerBehaviour.java:2232)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.CloudFoundryServerBehaviour$PushApplicationOperation.performDeployment(CloudFoundryServerBehaviour.java:2460)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.CloudFoundryServerBehaviour$ApplicationOperation.performOperation(CloudFoundryServerBehaviour.java:1994)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.AbstractDeploymentOperation.run(AbstractDeploymentOperation.java:42)\nat org.cloudfoundry.ide.eclipse.server.core.internal.client.CloudFoundryServerBehaviour.publishModule(CloudFoundryServerBehaviour.java:1367)\nat org.eclipse.wst.server.core.model.ServerBehaviourDelegate.publishModule(ServerBehaviourDelegate.java:1091)\nat org.eclipse.wst.server.core.model.ServerBehaviourDelegate.publishModules(ServerBehaviourDelegate.java:1183)\nat org.eclipse.wst.server.core.model.ServerBehaviourDelegate.publish(ServerBehaviourDelegate.java:987)\nat org.eclipse.wst.server.core.model.ServerBehaviourDelegate.publish(ServerBehaviourDelegate.java:774)\nat org.eclipse.wst.server.core.internal.Server.publishImpl(Server.java:3154)\nat org.eclipse.wst.server.core.internal.Server$PublishJob.run(Server.java:345)\nat org.eclipse.core.internal.jobs.Worker.run(Worker.java:53)\nCaused by: javax.websocket.DeploymentException: The HTTP request to initiate the WebSocket connection failed\nat org.apache.tomcat.websocket.WsWebSocketContainer.connectToServer(WsWebSocketContainer.java:315)\nat org.cloudfoundry.client.lib.rest.LoggregatorClient.connectToLoggregator(LoggregatorClient.java:42)\n... 28 more\nCaused by: java.util.concurrent.ExecutionException: org.apache.tomcat.websocket.ReadBufferOverflowException\n    at org.apache.tomcat.websocket.AsyncChannelWrapperSecure$WrapperFuture.get(AsyncChannelWrapperSecure.java:508)\n    at org.apache.tomcat.websocket.WsWebSocketContainer.processResponse(WsWebSocketContainer.java:544)\n    at org.apache.tomcat.websocket.WsWebSocketContainer.connectToServer(WsWebSocketContainer.java:297)\n    ... 6 more\nCaused by: org.apache.tomcat.websocket.ReadBufferOverflowException\n    at org.apache.tomcat.websocket.AsyncChannelWrapperSecure$ReadTask.run(AsyncChannelWrapperSecure.java:305)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:744)\n\nAnd the fix is rather straightforward--\n\nOn lines 565-567 of http://svn.apache.org/repos/asf/tomcat/tc7.0.x/trunk/java/org/apache/tomcat/websocket/WsWebSocketContainer.java\n\nJust add:\n\nif (!readHeaders) {\n  response.compact();\n}", "is_private": false, "id": 178266, "creator": "benjsmi@us.ibm.com", "time": "2014-10-03T12:45:44Z", "bug_id": 57054, "creation_time": "2014-10-03T12:45:44Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 57054, "attachment_id": null, "is_private": false, "id": 178275, "time": "2014-10-03T19:13:02Z", "creator": "markt@apache.org", "creation_time": "2014-10-03T19:13:02Z", "text": "Thanks for the report.\n\nThis has been fixed in 8.0.x for 8.0.15 onwards and in 7.0.x for 7.0.57 onwards.\n\nFor the record the proposed patch won't work since we aren't flipping the buffer between reads and writes."}, {"count": 2, "tags": [], "text": "Would you mind to provide the bugzilla number that fixes this problem for reference? Thanks.", "is_private": false, "id": 178277, "creator": "eyuen@ca.ibm.com", "time": "2014-10-03T20:14:12Z", "bug_id": 57054, "creation_time": "2014-10-03T20:14:12Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 57054, "attachment_id": null, "is_private": false, "id": 178278, "time": "2014-10-03T20:23:00Z", "creator": "eyuen@ca.ibm.com", "creation_time": "2014-10-03T20:23:00Z", "text": "Also, given that the latest public release of tomcat is 8.0.14 and 8.0.15 is not available yet.  Is it possible that we can get an official patch that works with 8.0.14 to have this problem fixed in the current version? Thanks."}, {"count": 4, "attachment_id": null, "bug_id": 57054, "is_private": false, "id": 178282, "time": "2014-10-03T23:45:19Z", "creator": "chris@christopherschultz.net", "creation_time": "2014-10-03T23:45:19Z", "tags": [], "text": "The Subversion revisions for the patch(es) for this issue is(are):\n\nr1629293 in trunk (Tomcat 8)\nr1629294 in Tomcat 7.0.x branch\n\n(The Bugzilla id is obviously bug #57054)\n\nThe Apache Tomcat project does not issue official patches. Instead, we release new versions. Tomcat 8 has been seeing a release about once per month. You are welcome to take Tomcat 8.0.14 source and apply r1629293 to it if you'd like."}]