[{"attachment_id": null, "tags": [], "bug_id": 56401, "is_private": false, "count": 0, "id": 174503, "time": "2014-04-11T20:05:07Z", "creator": "chris@christopherschultz.net", "creation_time": "2014-04-11T20:05:07Z", "text": "Create a new \"startup\" logger and emit some good information to it such as version, etc."}, {"count": 1, "tags": [], "creator": "markt@apache.org", "is_private": false, "text": "Fixed in 8.0.x and will be included in 8.0.13 onwards.", "id": 177644, "time": "2014-09-08T19:15:41Z", "bug_id": 56401, "creation_time": "2014-09-08T19:15:41Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 56401, "text": "Several comments, from testing this and adding i18n in r1623804\n\n1. It is good that this does not affect embedded Tomcat.\nThere are no changes in the information logged by unit tests.\n\n2. The Catalina.logInfo() method is called from Catalina class constructor. As such, it performs logging on shutdown.bat.\nI think it should not perform logging on shutdown. As such, I am REOPENing this.\n\nAn alternative implementation could be a <Listener> in server.xml that prints such information.", "count": 2, "id": 177668, "time": "2014-09-09T13:09:26Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-09-09T13:09:26Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 56401, "attachment_id": null, "text": "Additional concern:\n3. It may be better to log all information in one single log.info() statement. E.g. \"Initializing\\n {0}\\n {1}\\n {2} ...\".  The current log format implicitly relies on use of org.apache.juli.OneLineFormatter.\n\nIf you backport it to Tomcat 7 that uses SimpleFormatter, or if you run Tomcat 8 from within Eclipse IDE (that does not have logging configured by default == uses JRE default configuration == uses SimpleFormatter), it looks rather odd.\n\n\nReverted the code in r1627247 due to item #2 that I raised in Comment #2.", "id": 178070, "time": "2014-09-24T09:15:25Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-09-24T09:15:25Z", "is_private": false}, {"count": 4, "tags": [], "text": "Re-impemented as a LifecycleListener", "is_private": false, "id": 178077, "creator": "markt@apache.org", "time": "2014-09-24T12:43:06Z", "bug_id": 56401, "creation_time": "2014-09-24T12:43:06Z", "attachment_id": null}, {"count": 5, "tags": [], "creator": "knst.kolinko@gmail.com", "is_private": false, "text": "Re: r1627296\n\nCould the logging be moved from constructor to Lifecycle.BEFORE_INIT_EVENT, like activities performed by AprLifecycleListener?\n\n\nReason: Doing logging in VersionLoggerListener constructor interferes with storeconfig feature. IIRC, it instantiates classes to look for their default properties to omit writing them out.\n\nSteps to reproduce with Tomcat 8.0.14 release candidate and JDK 7u67:\n\n1. Add the following listener to conf/server.xml\n  <Listener className=\"org.apache.catalina.storeconfig.StoreConfigLifecycleListener\"/>\n\n2. Start Tomcat\n\n3. Connect with jconsole, open mbean Catalina/StoreConfig and invoke \"storeConfig()\" operation.\n\n4. The following messages are logged for this operation:\n\n[[[\n25-Sep-2014 16:38:24.694 INFO [RMI TCP Connection(1)-<IPADDRESS>] org.apache.catalina.startup.VersionLoggerListener.log Server version: Apache Tomcat/8.0.14\n25-Sep-2014 16:38:24.697 INFO [RMI TCP Connection(1)-<IPADDRESS>] org.apache.catalina.startup.VersionLoggerListener.log Server built:   Sep 24 2014 09:01:51\n25-Sep-2014 16:38:24.699 INFO [RMI TCP Connection(1)-<IPADDRESS>] org.apache.catalina.startup.VersionLoggerListener.log Server number:  8.0.14.0\n25-Sep-2014 16:38:24.700 INFO [RMI TCP Connection(1)-<IPADDRESS>] org.apache.catalina.startup.VersionLoggerListener.log OS Name:        Windows 7\n25-Sep-2014 16:38:24.702 INFO [RMI TCP Connection(1)-<IPADDRESS>] org.apache.catalina.startup.VersionLoggerListener.log OS Version:     6.1\n25-Sep-2014 16:38:24.703 INFO [RMI TCP Connection(1)-<IPADDRESS>] org.apache.catalina.startup.VersionLoggerListener.log Architecture:   x86\n25-Sep-2014 16:38:24.704 INFO [RMI TCP Connection(1)-<IPADDRESS>] org.apache.catalina.startup.VersionLoggerListener.log JVM Version:    1.7.0_67-b01\n25-Sep-2014 16:38:24.705 INFO [RMI TCP Connection(1)-<IPADDRESS>] org.apache.catalina.startup.VersionLoggerListener.log JVM Vendor:     Oracle Corporation\n25-Sep-2014 16:38:24.796 INFO [RMI TCP Connection(1)-<IPADDRESS>] org.apache.catalina.storeconfig.StandardContextSF.storeWithBackup Store Context  separate with backup (at file <CATALINA_BASE>\\conf\\Catalina\\localhost\\ROOT.xml.2014-09-25.16-38-24 )\n25-Sep-2014 16:38:24.829 INFO [RMI TCP Connection(1)-<IPADDRESS>] org.apache.catalina.storeconfig.StandardContextSF.storeWithBackup Store Context /manager separate with backup (at file <CATALINA_BASE>\\webapps\\manager\\META-INF\\context.xml.2014-09-25.16-38-24 )\n25-Sep-2014 16:38:24.847 INFO [RMI TCP Connection(1)-<IPADDRESS>] org.apache.catalina.storeconfig.StandardContextSF.storeWithBackup Store Context /docs separate with backup (at file <CATALINA_BASE>\\conf\\Catalina\\localhost\\docs.xml.2014-09-25.16-38-24 )\n25-Sep-2014 16:38:24.865 INFO [RMI TCP Connection(1)-<IPADDRESS>] org.apache.catalina.storeconfig.StandardContextSF.storeWithBackup Store Context /examples separate with backup (at file <CATALINA_BASE>\\conf\\Catalina\\localhost\\examples.xml.2014-09-25.16-38-24 )\n25-Sep-2014 16:38:24.889 INFO [RMI TCP Connection(1)-<IPADDRESS>] org.apache.catalina.storeconfig.StandardContextSF.storeWithBackup Store Context /host-manager separate with backup (at file <CATALINA_BASE>\\webapps\\host-manager\\META-INF\\context.xml.2014-09-25.16-38-24 )\n]]]", "id": 178111, "time": "2014-09-25T12:50:43Z", "bug_id": 56401, "creation_time": "2014-09-25T12:50:43Z", "attachment_id": null}, {"count": 6, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 178112, "time": "2014-09-25T13:47:31Z", "bug_id": 56401, "creation_time": "2014-09-25T13:47:31Z", "is_private": false, "text": "(In reply to Konstantin Kolinko from comment #5)\n> Re: r1627296\n> \n> Could the logging be moved from constructor to Lifecycle.BEFORE_INIT_EVENT,\n> like activities performed by AprLifecycleListener?\n\nThey could, but then you have the problem that the AprLifecycleListener triggers logging in its constructor and I think that version info logging should appear before any other logging.\n\nI took a quick look at refactoring the AprLifecycleListener but that is tied up with the Connector constructors and would be hard to untangle.\n\nI'm happy to look at this some more but if anyone has a bright idea on how to solve this..."}, {"count": 7, "tags": [], "text": "> I took a quick look at refactoring the AprLifecycleListener but that\n> is tied up with the Connector constructors and would be hard to untangle.\n\nAck. Agreed.\n\n\nFor a record, the call chain to AprLifecycleListener.init() is the following.\n\n[[[\nat org.apache.catalina.core.AprLifecycleListener.init(AprLifecycleListener.java:181)\nat org.apache.catalina.core.AprLifecycleListener.isAprAvailable(AprLifecycleListener.java:96)\nat org.apache.catalina.connector.Connector.setProtocol(Connector.java:564)\nat org.apache.catalina.connector.Connector.<init>(Connector.java:66)\nat org.apache.catalina.startup.ConnectorCreateRule.begin(ConnectorCreateRule.java:62)\n]]]\n\nWhen parsing server.xml one needs to set properties on a Connector. Majority of those properties are propagated further to a ProtocolHandler class. Configuring a ProtocolHandler by default auto-selects between APR and non-APR implementation. That auto-selection relies on response from AprLifecycleListener.isAprAvailable(). Thus init() method is triggered.\n\nSo I agree that it is difficult to untangle it.", "is_private": false, "id": 178113, "creator": "knst.kolinko@gmail.com", "time": "2014-09-25T14:39:14Z", "bug_id": 56401, "creation_time": "2014-09-25T14:39:14Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 56401, "text": "The best I can come up with is to write all the info logging during AprLifecycleListener.init() to a buffer and then write that out during Lifecycle.BEFORE_INIT_EVENT. Then move the VersionLogging messages to Lifecycle.BEFORE_INIT_EVENT as well.\n\nErrors and warnings would still appear before the version information but I could live with that.\n\nI'll take a look at at patch to do this shortly.", "count": 8, "id": 178115, "time": "2014-09-25T16:03:53Z", "creator": "markt@apache.org", "creation_time": "2014-09-25T16:03:53Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 56401, "text": "Imporved fix applied to 8.0.x for 8.0.15 onwards.", "count": 9, "id": 178116, "time": "2014-09-25T16:31:33Z", "creator": "markt@apache.org", "creation_time": "2014-09-25T16:31:33Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 56401, "attachment_id": null, "is_private": false, "id": 178621, "time": "2014-10-20T14:01:59Z", "creator": "violetagg@apache.org", "creation_time": "2014-10-20T14:01:59Z", "text": "This is back-ported in 7.0.x and will be available in 7.0.57 onwards."}]