[{"count": 0, "tags": [], "creator": "vmahajan@amberpoint.com", "is_private": false, "text": "Like it's done for ds:Signature elements, even for ds:KeyInfo elements\n\"xmlns:ds\" namespace declaration should be added explicitly since ds:KeyInfo\nelements can also be contained inside non-dsig elements like xenc:EncryptedKey.\nIf this is not done, one could land up with an invalid XML after the\nxenc:EncryptedKey is martialed. Here's a suggested patch:\n\n----------------------------------------------------------\n--- KeyInfo.java.bak\t2008-01-09 16:44:51.949750000 +0530\n+++ KeyInfo.java\t2008-01-10 11:10:33.090375000 +0530\n@@ -107,6 +107,18 @@\n \n       super(doc);\n \n+       String xmlnsDsPrefix = getDefaultPrefixBindings(Constants.SignatureSpecNS);\n+       if (xmlnsDsPrefix == null || xmlnsDsPrefix.length() == 0)\n+       {\n+           this._constructionElement.setAttributeNS\n+                   (Constants.NamespaceSpecNS, \"xmlns\", Constants.SignatureSpecNS);\n+       }\n+       else\n+       {\n+           this._constructionElement.setAttributeNS\n+                   (Constants.NamespaceSpecNS, xmlnsDsPrefix,\nConstants.SignatureSpecNS);\n+       }\n+\n       XMLUtils.addReturnToElement(this._constructionElement);\n       \n    }\n----------------------------------------------------------", "id": 112756, "time": "2008-01-10T22:47:21Z", "bug_id": 44206, "creation_time": "2008-01-10T22:47:21Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "sean.mullan@oracle.com", "is_private": false, "count": 1, "id": 113341, "time": "2008-02-01T11:16:31Z", "bug_id": 44206, "creation_time": "2008-02-01T11:16:31Z", "text": "I could not reproduce this when I run the Encrypter sample: \"ant encrypt\". Can\nyou attach a test case? Also, KeyInfo(Document) invokes\nSignatureElementProxy(Document) which invokes ElementProxy(Document) which\ninvokes the createElementForFamilyLocal method which contains code to set the\nxmlns attribute for the element's namespace."}, {"count": 2, "tags": [], "bug_id": 44206, "attachment_id": null, "id": 113564, "time": "2008-02-08T02:42:42Z", "creator": "vmahajan@amberpoint.com", "creation_time": "2008-02-08T02:42:42Z", "is_private": false, "text": "Looking at the code, SignatureElementProxy(Document) *doesn't* seem to invoke\nElementProxy(Document). Instead it calls XMLUtils.createElementInSignatureSpace\nwhich does not set the dsig namespace declaration attribute on the created\nelement, which I think is the root of the problem.\n"}, {"count": 3, "tags": [], "creator": "sean.mullan@oracle.com", "attachment_id": null, "text": "I'll need a reproducible test case. Here is the result of running \"ant encrypt\".\nKeyInfo is correctly defined in the ds namespace:\n\n<apache:RootElement\nxmlns:apache=\"http://www.apache.org/ns/#app1\"><xenc:EncryptedData\nxmlns:xenc=\"http://www.w3.org/2001/04/xmlenc#\"\nType=\"http://www.w3.org/2001/04/xmlenc#Content\"><xenc:EncryptionMethod\nAlgorithm=\"http://www.w3.org/2001/04/xmlenc#aes128-cbc\"\nxmlns:xenc=\"http://www.w3.org/2001/04/xmlenc#\"/><ds:KeyInfo\nxmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\">\n<xenc:EncryptedKey\nxmlns:xenc=\"http://www.w3.org/2001/04/xmlenc#\"><xenc:EncryptionMethod\nAlgorithm=\"http://www.w3.org/2001/04/xmlenc#kw-tripledes\"\nxmlns:xenc=\"http://www.w3.org/2001/04/xmlenc#\"/><xenc:CipherData\nxmlns:xenc=\"http://www.w3.org/2001/04/xmlenc#\"><xenc:CipherValue\nxmlns:xenc=\"http://www.w3.org/2001/04/xmlenc#\">nzKwpPcRTfVFYeSdD8i0VHEPn79G+czKj3Utn8wvQIQ=</xenc:CipherValue></xenc:CipherData></xenc:EncryptedKey></ds:KeyInfo><xenc:CipherData\nxmlns:xenc=\"http://www.w3.org/2001/04/xmlenc#\"><xenc:CipherValue\nxmlns:xenc=\"http://www.w3.org/2001/04/xmlenc#\">4vhHtYBvBCicGyyIpzzD8YPTr1Wq7IbOisJZejerdxk+kizkcYMyRP3jrpz+jd6l0rL99+QES/Yq\nVKckYFWbEVK9SFDof1Fhq6ngRIWDjMlOi1iRz4qcRGBQDmJAGX2hfnt9tkvwNHmdXg/DQn35XA==</xenc:CipherValue></xenc:CipherData></xenc:EncryptedData></apache:RootElement>", "id": 113637, "time": "2008-02-11T10:22:47Z", "bug_id": 44206, "creation_time": "2008-02-11T10:22:47Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 44206, "attachment_id": null, "id": 113652, "time": "2008-02-12T00:58:36Z", "creator": "vmahajan@amberpoint.com", "creation_time": "2008-02-12T00:58:36Z", "is_private": false, "text": "I now feel that this behavior is dependent on the XML serializer being used. I\nguess the serializer I am using is not emitting the namespace declaration of a\nnamespace-qualified element unless the declaration is added explicitly. Given\nthat, this is probably not an important issue and you can close the bug, and\nI'll use the proposed patch at my end. But it probably wouldn't hurt to submit\nthe patch as it simply adds the dsig namespace declaration explicitly to the\n<ds:KeyInfo> element, as is done for <ds:Signature> element in the library."}, {"count": 5, "text": "(In reply to comment #4)\n> I now feel that this behavior is dependent on the XML serializer being used. I\n> guess the serializer I am using is not emitting the namespace declaration of a\n> namespace-qualified element unless the declaration is added explicitly. Given\n> that, this is probably not an important issue and you can close the bug, and\n> I'll use the proposed patch at my end. But it probably wouldn't hurt to submit\n> the patch as it simply adds the dsig namespace declaration explicitly to the\n> <ds:KeyInfo> element, as is done for <ds:Signature> element in the library.\n\nFor now, I'm going to close this bug. The problem with the patch is that then\nthe namespace attribute is always emitted for the KeyInfo element, even when it\nisn't necessary. I think a better fix is to add a new constructor or method that\noptionally enables this behavior.", "bug_id": 44206, "attachment_id": null, "id": 113793, "time": "2008-02-15T07:03:07Z", "creator": "sean.mullan@oracle.com", "creation_time": "2008-02-15T07:03:07Z", "tags": [], "is_private": false}]