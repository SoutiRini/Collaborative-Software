[{"count": 0, "tags": [], "text": "With Tomcat 7.0.42 and the NIO connector, calling AsyncContext.dispatch() from an onTimeout() handler fails with this error message:\n\njul 31, 2013 1:40:30 PM org.apache.coyote.AbstractProtocol$AbstractConnectionHandler process\nSEVERE: Error reading request, ignored\njava.lang.IllegalStateException: Calling [asyncPostProcess()] is not valid for a request with Async state [STARTED]\n        at org.apache.coyote.AsyncStateMachine.asyncPostProcess(AsyncStateMachine.java:204)\n        at org.apache.coyote.AbstractProcessor.asyncPostProcess(AbstractProcessor.java:116)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:593)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1690)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:724)\n\n\nTest code:\n\npublic class AsyncServlet extends HttpServlet {\n\n  protected void doGet(final HttpServletRequest request, HttpServletResponse response)\n      throws ServletException, IOException {\n\n    if (request.isAsyncStarted()) {\n      response.getWriter().write(\"asyncResult=\" + request.getAttribute(\"asyncResult\"));\n    }\n    else {\n      final AsyncContext asyncContext = request.startAsync(request, response);\n\n      asyncContext.addListener(new AsyncListener() {\n        public void onTimeout(AsyncEvent event) throws IOException {\n            request.setAttribute(\"asyncResult\", \"timeout\\n\");\n            asyncContext.dispatch();\n        }\n        public void onStartAsync(AsyncEvent event) throws IOException {}\n        public void onError(AsyncEvent event) throws IOException {}\n        public void onComplete(AsyncEvent event) throws IOException {}\n      });\n\n      asyncContext.setTimeout(5000L);\n    }\n  }\n\n}\n\n\nThis seems somewhat similar to the (ancient) report #50308.", "is_private": false, "bug_id": 55331, "id": 168971, "time": "2013-07-31T11:50:09Z", "creator": "pdewacht@gmail.com", "creation_time": "2013-07-31T11:50:09Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 55331, "attachment_id": null, "id": 169006, "time": "2013-08-01T10:03:13Z", "creator": "markt@apache.org", "creation_time": "2013-08-01T10:03:13Z", "is_private": false, "text": "Thanks for the report. This has been fixed in trunk and 7.0.x and will be included in 7.0.43 onwards.\n\nNote that the example servlet provided above will trigger an infinite loop as once the dispatch occurs, request.isAsyncStarted() will return false."}]