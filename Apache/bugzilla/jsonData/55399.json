[{"count": 0, "attachment_id": null, "creator": "guillermo.grandes@gmail.com", "text": "== Server: Windows, Language: es_ES\n== Client: Linux, Language: en_US\n\n== Request:\n\nPOST /xxxxxx HTTP/1.1\nHost: x.x.x.x:8080\nAccept: */*\nAccept-Language: en\nContent-Length: 0\nContent-Type: application/x-www-form-urlencoded\n\n== Response:\n\nHTTP/1.1 400 Petici\u00f3n incorrecta\nServer: Apache-Coyote/1.1\nContent-Type: text/html;charset=ISO-8859-1\nContent-Length: 1030\nDate: Sat, 10 Aug 2013 17:25:17 GMT\nConnection: close\n\n...cut...\n\n---\n\nHTTP Response \"Petici\u00f3n incorrecta\" must be in English. Right?\n\nI tried to do response.setLocale() workarround in the Servlet but neither works:\n\n---\nprotected void doPost(HttpServletRequest request, HttpServletResponse response)\n\tthrows ServletException, IOException {\n// ...\n\tresponse.setLocale(Locale.ENGLISH); // Locale.US neither\n// ...\n\tresponse.sendError(HttpServletResponse.SC_BAD_REQUEST, \"BAD REQUEST\");\n}\n---\n\nHttpServletResponse.setLocale() don't honors?", "id": 169341, "time": "2013-08-10T17:50:55Z", "bug_id": 55399, "creation_time": "2013-08-10T17:50:55Z", "tags": [], "is_private": false}, {"count": 1, "attachment_id": null, "creator": "chris@christopherschultz.net", "text": "What version of Tomcat?\n\nCan you echo these items back to the client and post the output:\n\nprotected void doPost(HttpServletRequest request, HttpServletResponse response)\n\tthrows ServletException, IOException {\n//  ...\n    ServletWriter out = response.getWriter();\n    out.println(\"request locale=\" + request.getLocale());\n    out.println(\"server locale=\" + Locale.getDefault());\n    response.sendError(HttpServletResponse.SC_BAD_REQUEST, \"BAD REQUEST\");\n}", "id": 169344, "time": "2013-08-11T01:01:58Z", "bug_id": 55399, "creation_time": "2013-08-11T01:01:58Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 55399, "is_private": false, "text": "Tested on tomcat-7.0.42\n\nServletWriter.println() don't work as expect (response.sendError clear the response buffer), but changing ServletWriter to System.out output is:\n\nprotected void doPost(HttpServletRequest request, HttpServletResponse response)\n\tthrows ServletException, IOException {\n\t// ...\n\tSystem.out.println(\"request locale=\" + request.getLocale());\n\tSystem.out.println(\"server locale=\" + Locale.getDefault());\n\tresponse.sendError(HttpServletResponse.SC_BAD_REQUEST, \"BAD REQUEST\");\n}\n\n--- Eclipse console ---\nrequest locale=en\nserver locale=es_ES\n---\n\n# Request:\ncurl -i -H \"Accept-Language: en\" -d \"\" \"http://x.x.x.x:8080/LocaleTest\"\n---\nHTTP/1.1 400 Petici\u00f3n incorrecta\nServer: Apache-Coyote/1.1\nContent-Type: text/html;charset=ISO-8859-1\nContent-Length: 1010\nDate: Sun, 11 Aug 2013 21:29:02 GMT\nConnection: close\n\n<html><head><title>Apache Tomcat/7.0.42 - Informe de Error</title><style><!--H1 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:22px;} H2 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:16px;} H3 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:14px;} BODY {font-family:Tahoma,Arial,sans-serif;color:black;background-color:white;} B {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;} P {font-family:Tahoma,Arial,sans-serif;background:white;color:black;font-size:12px;}A {color : black;}A.name {color : black;}HR {color : #525D76;}--></style> </head><body><h1>Estado HTTP 400 - BAD REQUEST</h1><HR size=\"1\" noshade=\"noshade\"><p><b>type</b> Informe de estado</p><p><b>mensaje</b> <u>BAD REQUEST</u></p><p><b>descripci\u00f3n</b> <u>El requerimiento enviado por el cliente era sint\u00e1cticamente incorrecto.</u></p><HR size=\"1\" noshade=\"noshade\"><h3>Apache Tomcat/7.0.42</h3></body></html>\n---", "id": 169345, "time": "2013-08-11T21:35:11Z", "creator": "guillermo.grandes@gmail.com", "creation_time": "2013-08-11T21:35:11Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 55399, "is_private": false, "text": "That's certainly odd. How about this:\n\n\tSystem.out.println(\"current stack:\");\n        new Throwable(\"Stack Trace\").printStackTrace();", "id": 169348, "time": "2013-08-11T23:25:02Z", "creator": "chris@christopherschultz.net", "creation_time": "2013-08-11T23:25:02Z", "attachment_id": null}, {"count": 4, "tags": [], "text": "java.lang.Throwable: Stack Trace\n\tat org.test.servlet.LocaleTest.doPost(LocaleTest.java:138)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:647)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:728)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:305)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:222)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:123)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:99)\n\tat org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:953)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1023)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:589)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1686)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:895)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:918)\n\tat java.lang.Thread.run(Thread.java:662)", "attachment_id": null, "id": 169385, "creator": "guillermo.grandes@gmail.com", "time": "2013-08-13T00:14:50Z", "bug_id": 55399, "creation_time": "2013-08-13T00:14:50Z", "is_private": false}, {"count": 5, "tags": [], "text": "This report doesn't surprise me at all.\n\nThe manager application had a similar issue.\n\nI'll look at using a similar approach as used for the manager application for the error pages.", "attachment_id": null, "id": 169461, "creator": "markt@apache.org", "time": "2013-08-15T13:51:00Z", "bug_id": 55399, "creation_time": "2013-08-15T13:51:00Z", "is_private": false}, {"count": 6, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 169469, "time": "2013-08-15T19:22:47Z", "bug_id": 55399, "creation_time": "2013-08-15T19:22:47Z", "is_private": false, "text": "The error pages were simple to fix but fixing the HTTP response status line is going to be more invasive. That part may end up being Tomcat 8 only because of the internal changes required."}, {"count": 7, "tags": [], "bug_id": 55399, "attachment_id": null, "id": 169475, "time": "2013-08-15T21:14:55Z", "creator": "markt@apache.org", "creation_time": "2013-08-15T21:14:55Z", "is_private": false, "text": "This has been fixed in trunk and 7.0.x and will be included in 7.0.43 onwards.\n\nError pages now use the Accept-Language header.\n\nAll responses use the Locale set on the response.\n\nI considered parsing the Accept-Language header on every request and using that to set the locale on every response but decided not to on performance grounds (no hard numbers on this so if someone shows the performance impact is negligible then it could get added). Users that want this can easily write a filter to do so."}, {"count": 8, "tags": [], "creator": "guillermo.grandes@gmail.com", "attachment_id": null, "id": 169528, "time": "2013-08-16T22:27:26Z", "bug_id": 55399, "creation_time": "2013-08-16T22:27:26Z", "is_private": false, "text": "(In reply to Mark Thomas from comment #6)\n> The error pages were simple to fix but fixing the HTTP response status line\n> is going to be more invasive. That part may end up being Tomcat 8 only\n> because of the internal changes required.\n\nIn that case, perhaps the logical would respond in English (ubiquitous) by default, and set locale when requested... right?"}, {"count": 9, "tags": [], "text": "*** Bug 56374 has been marked as a duplicate of this bug. ***", "attachment_id": null, "id": 174435, "creator": "knst.kolinko@gmail.com", "time": "2014-04-10T09:08:20Z", "bug_id": 55399, "creation_time": "2014-04-10T09:08:20Z", "is_private": false}]