[{"count": 0, "tags": [], "creator": "chrisd@apache.org", "attachment_id": null, "id": 87786, "time": "2006-04-11T21:09:19Z", "bug_id": 39275, "creation_time": "2006-04-11T21:09:19Z", "is_private": false, "text": "Per this thread on the httpd-dev mailing list:\n\nhttp://marc.theaimsgroup.com/?t=114453426100001&r=1&w=2\n\nI have been seeing something similar with 2.2.0 using the worker\nMPM, where with the following settings, I get over 10 child processes\ninitializing immediately (e.g., up to 15), and then they drop back to\n10.  I see the \"server reached MaxClients\" message as well right\nafter httpd startup, although nothing is connecting yet.\n\n<IfModule mpm_worker_module>\n    StartServers         10\n    MaxClients          150\n    MinSpareThreads      25\n    MaxSpareThreads     100\n    ThreadsPerChild      10\n</IfModule>\n\nIn my case, the problem relates to how long the child_init phase\ntakes to execute.  I can \"tune\" this by raising DBDMin (and DBDKeep)\nso that mod_dbd attempts to open increasingly large numbers of\nDB connections during child_init.  With DBDMin set to 0 or 1,\nall is well; no funny behaviour.  Up at DBDMin and DBDKeep at 3,\nthat's when (for me) things go pear-shaped.\n\nIn server/mpm/worker/worker.c, after make_child() creates a\nchild process it immediately sets the scoreboard parent slot's pid\nvalue.  The main process goes into server_main_loop() and begins\nexecuting perform_idle_server_maintenance() every second; this\nlooks at any process with a non-zero pid in the scoreboard and\nassumes that any of its worker threads marked SERVER_DEAD are,\nin fact, dead.\n\nHowever, if the child processes are starting \"slowly\" because\nap_run_child_init() in child_main() is taking its time, then\nstart_threads() hasn't even been run yet, so the threads aren't\nmarked SERVER_STARTING -- they're just set to 0 as the default\nvalue.  But 0 == SERVER_DEAD, so the main process sees a lot\nof dead worker threads and begins spawning new child processes,\nup to MaxClients/ThreadsPerChild in the worst case.  In this case,\nwhen no worker threads have started yet, but all possible child\nprocesses have been spawned (and are working through their\nchild_init phases), then the following is true and the\n\"server reached MaxClients\" message is printed, even though\nthe server hasn't started accepting connections yet:\n\n    else if (idle_thread_count < min_spare_threads) {\n        /* terminate the free list */\n        if (free_length == 0) {\n\nI considered wedging another thread status into the\nscoreboard, between SERVER_DEAD (the initial value) and\nSERVER_STARTING.  The make_child() would set all the thread\nslots to this value and start_threads() would later flip them\nto SERVER_STARTING after actually creating the worker threads.\n\nThat would have various ripple effects on other bits of\nhttpd, though, like mod_status and other MPMs, etc.  So instead\nI tried adding a status field to the process_score scoreboard\nstructure, and making the following changes to worker.c such that\nthis field is set by make_child to SERVER_STARTING and then\nchanged to SERVER_READY once the start thread that runs\nstart_threads() has done its initial work.\n\nDuring this period, while the new child process is running\nap_run_child_init() and friends, perform_idle_server_maintenance()\njust counts that child process's worker threads as all being\neffectively in SERVER_STARTING mode.  Once the process_score.status\nfield changes to SERVER_READY, perform_idle_server_maintenance()\nbegins to look at the individual thread status values."}, {"count": 1, "tags": [], "bug_id": 39275, "attachment_id": 18070, "id": 87787, "time": "2006-04-11T21:10:32Z", "creator": "chrisd@apache.org", "creation_time": "2006-04-11T21:10:32Z", "is_private": false, "text": "Created attachment 18070\nadds a per-process status field"}, {"count": 2, "tags": [], "creator": "chrisd@apache.org", "attachment_id": 18071, "id": 87790, "time": "2006-04-11T21:14:47Z", "bug_id": 39275, "creation_time": "2006-04-11T21:14:47Z", "is_private": false, "text": "Created attachment 18071\nadds process_score status"}, {"count": 3, "tags": [], "bug_id": 39275, "attachment_id": null, "text": "I should add that this patch is more food-for-thought than a clear fix.\nFor one thing, other MPMs like event and prefork aren't considered.\nFor another, hard and graceful restarts may not play well with the per-process\nstatus field, since at least with graceful restarts, new processes can\ngradually take over thread slots in the scoreboard from an exiting process.\nI'll do some additional testing and perhaps a better solution will present itself.\nComments welcome!", "id": 87801, "time": "2006-04-11T21:49:42Z", "creator": "chrisd@apache.org", "creation_time": "2006-04-11T21:49:42Z", "is_private": false}, {"count": 4, "tags": [], "creator": "gregames@apache.org", "attachment_id": null, "id": 88735, "time": "2006-05-03T00:34:28Z", "bug_id": 39275, "creation_time": "2006-05-03T00:34:28Z", "is_private": false, "text": "svn rev. 399099 should take care of it. "}, {"count": 5, "tags": [], "creator": "peter@poeml.de", "attachment_id": null, "id": 92758, "time": "2006-08-30T22:10:54Z", "bug_id": 39275, "creation_time": "2006-08-30T22:10:54Z", "is_private": false, "text": "Greg, svn rev. 399099 helps fine during server start. However, the same problem\noccurs during a graceful restart."}, {"count": 6, "tags": [], "creator": "peter@poeml.de", "attachment_id": 18771, "id": 92760, "time": "2006-08-30T22:14:15Z", "bug_id": 39275, "creation_time": "2006-08-30T22:14:15Z", "is_private": false, "text": "Created attachment 18771\na module which introduces a delay in child_init() for testing"}, {"count": 7, "tags": [], "creator": "peter@poeml.de", "attachment_id": 18806, "is_private": false, "id": 92912, "time": "2006-09-01T21:26:42Z", "bug_id": 39275, "creation_time": "2006-09-01T21:26:42Z", "text": "Created attachment 18806\nbackport for 2.0.x\n\nThis is the same fix for 2.0.x. It has the same problem as the 2.2.x\nbackport, as well as the fix in trunk: startup is fixed, but graceful\nrestart isn't."}]