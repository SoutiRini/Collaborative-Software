[{"count": 0, "tags": [], "creator": "paul@vinkenoog.nl", "attachment_id": null, "is_private": false, "id": 101641, "time": "2007-04-12T16:28:56Z", "bug_id": 42109, "creation_time": "2007-04-12T16:28:56Z", "text": "When fonts are embedded in the PDF, zero-width spaces have a backspace effect:\nthe text following the ZWSP is left-shifted by about one character's width, so\nit partly overprints the preceding text. At the end of a text area containing\nZWSPs there's extra whitespace, up to the point where the text would have ended\nhad it been rendered correctly.\n\nObserved with Times, Verdana and MSMincho, but not with Courier, and only if the\nfont is embedded in the PDF file. It makes no difference whether the metrics\nfile has an entry for ZWSP (8203d) or not.\n\nAttached are a FO and a PDF file demonstrating the effect. I also attach a patch\nthat intercepts non-stretchable ZWSPs before they are written to the PDF stream.\nThis doesn't address the cause of the problem so it's probably not the best\nsolution, but at least it cures the disease. And there's no point in writing\nzero-dimension areas to the PDF anyway."}, {"count": 1, "tags": [], "bug_id": 42109, "is_private": false, "text": "Created attachment 19940\nExample FO", "id": 101642, "time": "2007-04-12T16:31:52Z", "creator": "paul@vinkenoog.nl", "creation_time": "2007-04-12T16:31:52Z", "attachment_id": 19940}, {"count": 2, "tags": [], "bug_id": 42109, "text": "Created attachment 19941\nPDF built from example FO", "id": 101643, "time": "2007-04-12T16:33:53Z", "creator": "paul@vinkenoog.nl", "creation_time": "2007-04-12T16:33:53Z", "is_private": false, "attachment_id": 19941}, {"count": 3, "tags": [], "bug_id": 42109, "attachment_id": 19942, "id": 101644, "time": "2007-04-12T16:38:16Z", "creator": "paul@vinkenoog.nl", "creation_time": "2007-04-12T16:38:16Z", "is_private": false, "text": "Created attachment 19942\nPatch for org\\apache\\fop\\render\\pdf\\PDFRenderer.java"}, {"count": 4, "tags": [], "creator": "paul@vinkenoog.nl", "text": "Created attachment 19943\nPatch for org\\apache\\fop\\render\\pdf\\PDFRenderer.java\n\nSorry, seem to have added the entire Java file instead of just the patch! Hope\nI get it right this time.", "id": 101645, "attachment_id": 19943, "bug_id": 42109, "creation_time": "2007-04-12T16:43:54Z", "time": "2007-04-12T16:43:54Z", "is_private": false}, {"count": 5, "tags": [], "creator": "bowditch_chris@hotmail.com", "text": "Thanks for spotting this and submitting a patch. Good work.\n\nBug Confirmed. I tested your FO with Arial in PDF and the same affect occured.\n\nI was a little concerned that your fix was PDF specific, so I tried to \nrecreate the issue in Postscript but the bug doesn't seem to affect the \nPostscript Renderer.", "id": 101653, "attachment_id": null, "bug_id": 42109, "creation_time": "2007-04-13T01:32:47Z", "time": "2007-04-13T01:32:47Z", "is_private": false}, {"count": 6, "tags": [], "creator": "paul@vinkenoog.nl", "attachment_id": null, "is_private": false, "id": 101707, "time": "2007-04-14T09:28:10Z", "bug_id": 42109, "creation_time": "2007-04-14T09:28:10Z", "text": "I dug a little deeper (though not to the bottom) and found out that the problem\narises when PDFRenderer.escapeText() generates the string to be inserted in the\ncontent stream. Zero-width spaces get converted to normal spaces here, and an\nadjustment is added which is equal to charwidth(space) - charwidth(zwsp). With\nTimes for instance, this is inserted: \"( ) 250 \" (without the quotes). With\nHelvetica it's \"( ) 278 \". In either case, the appearance of the PDF is correct.\n\nThe character widths are queried from the parent area's Font object. If they are\ncorrect (as is the case with non-embedded Base-14 fonts), there's no visible\n(back)space in the PDF. (However, if you copy-and-paste the text, it contains\nspaces where the ZWSPs were.)\n\nBut if the font is embedded in the PDF, the width of the regular space character\nseems to be reported wrongly by the font and - for Times - this is inserted:\n\"<0003> 777 \" (<0003> being the correct code for space). The adjustment is way\ntoo large, hence the backspace effect.\n\nAnyway, even if rendered correctly, ZWSPs are useless once they've done their\njob as break-opportunity indicators. They add dead weight to the PDF and mess up\ncopy-and-paste. As I assume that other renderers have no need for them either, I\nthink it would be best if they weren't added to the area tree at all. So I'll\nupload another patch that can be used instead of the previous one (or alongside\nit; they're not in each other's way).\n\nSide note: while working on this, I also discovered that if ZWSPs are inserted\nthrough <fo:character>s, they are not used for line breaking.\n"}, {"count": 7, "tags": [], "creator": "paul@vinkenoog.nl", "text": "Created attachment 19961\nPatch to keep zero-width spaces out of the area tree", "id": 101715, "attachment_id": 19961, "bug_id": 42109, "creation_time": "2007-04-14T09:32:03Z", "time": "2007-04-14T09:32:03Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 42109, "text": "Thanks a lot for that patch, Paul. I've applied it:\nhttp://svn.apache.org/viewvc?view=rev&rev=540049\n\nPaul, please make it a habit of running the test suite (done automatically when\nbuilding from the command-line using Ant) when you want to submit something. One\nof the test cases needed to be adjusted to account for the missing ZWSPs in the\narea tree. Thanks.\n\nBTW, the only case where the ZWSP probably shouldn't be removed is when at some\npoint we will support tagged PDF. But at the moment, this is probably the most\nelegant solution.", "id": 103400, "time": "2007-05-21T00:37:48Z", "creator": "jeremias@apache.org", "creation_time": "2007-05-21T00:37:48Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 42109, "is_private": false, "id": 103573, "creation_time": "2007-05-23T15:32:58Z", "time": "2007-05-23T15:32:58Z", "creator": "paul@vinkenoog.nl", "text": "> Paul, please make it a habit of running the test suite (done automatically\n> when building from the command-line using Ant) when you want to submit\n> something.\n\nOK. I set it up a while ago but ran into a lot of errors and didn't have time to\nfully investigate what went wrong. So I went back to \"build package\". But I'll\ntry again next time, and be a little more perseverant.", "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 42109, "is_private": false, "id": 155691, "creation_time": "2012-04-01T06:36:01Z", "time": "2012-04-01T06:36:01Z", "creator": "gadams@apache.org", "text": "batch transition pre-FOP1.0 resolved+fixed bugs to closed+fixed", "attachment_id": null}]