[{"text": "Created attachment 25836\nCaptured packets (can be opened by tcpdump, Wireshark, etc.)\n\nSymptom:\nIf the (forward-)proxy receives \"Connection: Keep-alive\" request from client, it sends \"Connection: Keep-alive\" to the origin server as well. But the proxy closes the connection to the origin server immediately after it receives the response (or after it sends response to the client).\n[Initially found on 2.2.11 and confirmed with 2.2.16]\n\n\nThe possible negative impact of the symptom:\nThe origin server would expect the upcoming HTTP request in the persistent connection. So the sudden close of connection may cause a confusion on the origin server.\n\n\nWorkaround:\nIf the Keep-alive to the origin server is disabled (\"SetEnv proxy-nokeepalive\" in httpd.conf), then there is no chance that the proxy confuses the origin server with \"Connection: Keep-alive\".\nHowever, I don't know how can we enable Keep-alive (without immediate closing the connection) to the origin server.\n\n\nHow to reproduce:\n1. Turn on forward proxy feature with the following httpd.conf, and run httpd.\n---\nProxyRequests On\n<Proxy *>\nAllow from all\n</Proxy>\n---\n\n2. Run tcpdump (or anything equivalent) to monitor the packets.\n# tcpdump -i any -s 0 -w 0.cap tcp port 80\n\n3. Use telnet to send a request:\n$ telnet localhost 80\nGET http://httpd.apache.org:80/ HTTP/1.1\nHost: httpd.apache.org:80\nConnection: Keep-Alive", "tags": [], "bug_id": 49699, "attachment_id": 25836, "count": 0, "id": 138861, "time": "2010-08-03T23:00:57Z", "creator": "rshibuya0619@gmail.com", "creation_time": "2010-08-03T23:00:57Z", "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 49699, "text": "The connection seems closed indirectly through apr_pool_clear(), in the ap_proxy_release_connection() of proxy_util.c\n---\n1665        if (conn->close_on_recycle || conn->close || worker->disablereuse ||\n1666            !worker->is_address_reusable) {\n1667            apr_pool_t *p = conn->pool;\n1668            apr_pool_clear(p);\n---\n\nAt the line 1665, according to the debugger,\n  conn->close_on_recycle == 0,\n  conn->close == 0,\n  worker->disablereuse == 0,\n  worker->is_address_reusable == 0.\n\nI wonder why 'is_address_reusable' is set to 0, since I have not configured anything special to prohibit the reuse of the opened connection.", "id": 138862, "time": "2010-08-03T23:28:28Z", "creator": "rshibuya0619@gmail.com", "creation_time": "2010-08-03T23:28:28Z", "tags": [], "is_private": false}]