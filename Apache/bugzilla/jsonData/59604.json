[{"count": 0, "tags": [], "bug_id": 59604, "attachment_id": 33854, "id": 191123, "time": "2016-05-20T00:54:22Z", "creator": "davec@aesclever.com", "creation_time": "2016-05-20T00:54:22Z", "is_private": false, "text": "Created attachment 33854\nlog file\n\nTomcat 8.0.33 was deployed as-is on USS (Unix Systems Service)under z/OS V2R2.\n\nDefault apps failed to start due to \"Invalid <url-pattern>\" errors.\n\nSomehow it thinks there are invalid characters in web.xml even though nothing was modified."}, {"count": 1, "tags": [], "bug_id": 59604, "attachment_id": null, "id": 191124, "time": "2016-05-20T01:04:25Z", "creator": "davec@aesclever.com", "creation_time": "2016-05-20T01:04:25Z", "is_private": false, "text": "Tomcat 7.0.67 could be deployed with no problem in the same environment."}, {"count": 2, "tags": [], "bug_id": 59604, "text": "That looks like some form of encoding problem. Tomcat 7.0.x uses ISO-8859-1 for web.xml whereas Tomcat 8.0.x uses UTF-8.\n\nGiven that the contents of the files are correct for the given encoding this looks like a JVM issue on your OS.\n\nAs far as I am aware, none of the Tomcat committers have access to a z/OS system for testing. You are going to have to debug this one on your own unless you can provide one of us with access to a test system.\n\nInteresting... conf/web.xml is still using ISO-8859-1. That should be UTF-8. Although I don't think it will help in your case it is worth changing to see if it does.", "id": 191139, "time": "2016-05-20T09:37:14Z", "creator": "markt@apache.org", "creation_time": "2016-05-20T09:37:14Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "text": "Note that it succeeded in parsing XML markup (the tag of '<url-pattern>'), but contents of the tag is parsed as garbage. This is rather odd. Those patterns are English as well.\n\n\nMaybe those web.xml files were processed, overwrittem, broken by some tool?\n\nNote that server.xml was processed correctly, otherwise the server wouldn't start. Though a difference is that server.xml uses attributes to configure values, while web.xml uses plain text content wrapped by elements.\n\n\nMaybe try a different XML parser implementation. E.g. place a recent copy of Apache Xerces-J into \"endorsed\" directory. From your logs its location is:\n\n-Djava.endorsed.dirs=/u/aes/apache-tomcat-8.0.33/endorsed\n\n\n\nSome (unrelated) oddity in the logs:\n\nVersionLoggerListener.log Command line argument: -Djava.class.path=.\n\nVersionLoggerListener.log Command line argument: -Djava.class.path=/u/aes/apache-tomcat-8.0.33/bin/bootstrap.jar:/u/aes/apache-tomcat-8.0.33/bin/tomcat-juli.jar\n\nWhere the first incorrect value of \"-Djava.class.path\" argument comes from?\n\n\n\nNote that such questions are normally asked on the users mailing list. You need help from fellow users to help find the root cause here.", "id": 191140, "time": "2016-05-20T11:33:36Z", "bug_id": 59604, "creation_time": "2016-05-20T11:33:36Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 59604, "attachment_id": null, "id": 191147, "time": "2016-05-20T22:32:17Z", "creator": "davec@aesclever.com", "creation_time": "2016-05-20T22:32:17Z", "is_private": false, "text": "Both versions (8.0.33 and 7.0.67) were deployed as-is without any changes, using the same JAVA_HOME.  7.0.67 runs OK without any problem.\n\nNote: \nz/OS shell is EBCDIC-based but it can support ASCII shell scripts (e.g., Tomcat's startup.sh, etc.).  Below is my \"init\" script to set up the automatic conversion. \n\n#!/bin/sh                                           \nexport CATALINA_HOME=/u/aes/apache-tomcat-8.0.33    \nexport JAVA_HOME=/usr/lpp/java/J8.0_64              \nexport _BPXK_AUTOCVT=ON                             \nchtag -t -c ISO8859-1 $CATALINA_HOME/bin/*.sh"}, {"count": 5, "tags": [], "bug_id": 59604, "attachment_id": null, "id": 191170, "time": "2016-05-22T18:17:44Z", "creator": "markt@apache.org", "creation_time": "2016-05-22T18:17:44Z", "is_private": false, "text": "Unless you are able to provide a committer with access to a suitable test system, you are going to have to debug this yourself."}, {"count": 6, "tags": [], "bug_id": 59604, "attachment_id": null, "id": 191199, "time": "2016-05-23T19:08:50Z", "creator": "davec@aesclever.com", "creation_time": "2016-05-23T19:08:50Z", "is_private": false, "text": "We might be able to provide access to z/OS shell.  Meanwhile, what kind of diagnostic data I can collect for debugging purpose?"}, {"count": 7, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "Anything that narrows down what is going on is useful.\n\nMy sugegstion is to try the following but keep in mind that you may have to modify this as you go as you find out more information.\n\nStrip Tomcat down to a single webapp that exhibits the problem (e.g ROOT).\n\nTry different charsets in the XML prolog for conf/web.xml. UTF-8 and ISO-8859-1 as a minimum.\n\nRemove content from conf/web.xml until you have the smallest possible file that triggers the error.\n\nTry writing a simple Java program to parse that file. Does that work?", "id": 191239, "time": "2016-05-24T19:52:06Z", "bug_id": 59604, "creation_time": "2016-05-24T19:52:06Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 59604, "attachment_id": null, "id": 191240, "time": "2016-05-24T20:54:08Z", "creator": "chris@christopherschultz.net", "creation_time": "2016-05-24T20:54:08Z", "is_private": false, "text": "(In reply to Dave from comment #6)\n> We might be able to provide access to z/OS shell.  Meanwhile, what kind of\n> diagnostic data I can collect for debugging purpose?\n\nCan you perform an MD5 signature of the conf/web.xml file so we can be sure it's identical to the stock web.xml? Is it possible to get a byte-for-byte copy of the file off that system somewhere we can see it?\n\nDo you have any other XML-related utilities on that system that can be run against the file to check for formatting, content, etc.? I'm thinking something like 'xmllint' which is popular on *NIX systems (I recognize that z/OS is different).\n\nMaybe even an \"od\"-style byte dump copy-pasted into the comments, here?\n\n(Actually, a better place for this thread would be the users mailing list since it's not entirely clear that there is a bug here, yet.)"}, {"count": 9, "tags": [], "text": "Created attachment 33884\nmodified web.xml for ROOT\n\nI stripped out the comments and the following:", "attachment_id": 33884, "bug_id": 59604, "id": 191242, "time": "2016-05-25T00:47:22Z", "creator": "davec@aesclever.com", "creation_time": "2016-05-25T00:47:22Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 59604, "text": "Created attachment 33885\nlog file with only ROOT app", "id": 191243, "time": "2016-05-25T00:48:41Z", "creator": "davec@aesclever.com", "creation_time": "2016-05-25T00:48:41Z", "is_private": false, "attachment_id": 33885}, {"count": 11, "tags": [], "bug_id": 59604, "attachment_id": null, "id": 191244, "time": "2016-05-25T00:56:32Z", "creator": "davec@aesclever.com", "creation_time": "2016-05-25T00:56:32Z", "is_private": false, "text": "... continue with my last comment:\n\nI removed all the apps except ROOT and modified its web.xml by stripping off the comments and the following:\n\n<display-name>Welcome to Tomcat</display-name>\n  <description>\n     Welcome to Tomcat\n  </description>\n\n\nI'm still getting the same parsing error even though there are no servlet mappings in this bare minimum web.xml.  It looks like an encoding issue, but I guess the problem is not with the file contents but how it's being read."}, {"count": 12, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "(In reply to Dave from comment #11)\n\n> I'm still getting the same parsing error even though there are no servlet\n> mappings in this bare minimum web.xml.  It looks like an encoding issue, but\n> I guess the problem is not with the file contents but how it's being read.\n\nYou need to do the same to the global web.xml in conf/web.xml", "id": 191247, "time": "2016-05-25T06:20:37Z", "bug_id": 59604, "creation_time": "2016-05-25T06:20:37Z", "is_private": false}, {"count": 13, "tags": [], "creator": "davec@aesclever.com", "attachment_id": 33892, "text": "Created attachment 33892\nconf/web.xml (did not make any changes)", "id": 191262, "time": "2016-05-26T01:23:34Z", "bug_id": 59604, "creation_time": "2016-05-26T01:23:34Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 59604, "attachment_id": 33893, "id": 191263, "time": "2016-05-26T01:24:11Z", "creator": "davec@aesclever.com", "creation_time": "2016-05-26T01:24:11Z", "is_private": false, "text": "Created attachment 33893\nlog file with nothing in webapps/"}, {"count": 15, "tags": [], "bug_id": 59604, "attachment_id": null, "id": 191264, "time": "2016-05-26T01:24:52Z", "creator": "davec@aesclever.com", "creation_time": "2016-05-26T01:24:52Z", "is_private": false, "text": "If I remove everything in webapps/ then there are no errors in the startup log."}, {"count": 16, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "Please try the following:\n\nClean Tomcat install.\nConfirm problem exists.\nRemove apps one by one until only ROOT is left.\nConfirm problem still exists as each app is removed.\nRemove ROOT/WEB-INF/web.xml\nConfirm problem still exists.\nRemove content from conf/web.xml until you have the minimal conf/web.xml that triggers the problem.\n\nI'm expecting a minimal conf/web.xml with a single Servlet definition and associated Servlet mapping to trigger this issue.\n\nExperiment with different encodings for the XML prolog for conf/web.xml. Test UTF-8 and ISO-8859-1 as a minimum.\n\nReport your findings.", "id": 191267, "time": "2016-05-26T08:51:09Z", "bug_id": 59604, "creation_time": "2016-05-26T08:51:09Z", "is_private": false}, {"count": 17, "tags": [], "creator": "davec@aesclever.com", "attachment_id": null, "text": "The problem still exists after each step:\n\n1. as each app is removed\n2. with only ROOT app\n3. after removing ROOT/WEB-INF/web.xml\n4. with a minimum conf/web.xml\n\nI will upload the minimum conf/web.xml and catalina.out", "id": 191275, "time": "2016-05-26T20:23:51Z", "bug_id": 59604, "creation_time": "2016-05-26T20:23:51Z", "is_private": false}, {"count": 18, "tags": [], "creator": "davec@aesclever.com", "attachment_id": 33895, "text": "Created attachment 33895\nminimum /conf/web.xml", "id": 191276, "time": "2016-05-26T20:25:00Z", "bug_id": 59604, "creation_time": "2016-05-26T20:25:00Z", "is_private": false}, {"count": 19, "tags": [], "bug_id": 59604, "text": "The problem still exits even with a \"bare bones\" conf/web.xml", "id": 191277, "time": "2016-05-26T20:32:02Z", "creator": "davec@aesclever.com", "creation_time": "2016-05-26T20:32:02Z", "is_private": false, "attachment_id": null}, {"count": 20, "tags": [], "creator": "davec@aesclever.com", "attachment_id": 33896, "text": "Created attachment 33896\n\"bare bones\" conf/web.xml", "id": 191278, "time": "2016-05-26T20:32:50Z", "bug_id": 59604, "creation_time": "2016-05-26T20:32:50Z", "is_private": false}, {"count": 21, "tags": [], "bug_id": 59604, "attachment_id": 33897, "id": 191279, "time": "2016-05-26T20:34:33Z", "creator": "davec@aesclever.com", "creation_time": "2016-05-26T20:34:33Z", "is_private": false, "text": "Created attachment 33897\nlog file with bare bones conf/web.xml"}, {"count": 22, "tags": [], "bug_id": 59604, "attachment_id": null, "id": 191280, "time": "2016-05-26T20:35:18Z", "creator": "davec@aesclever.com", "creation_time": "2016-05-26T20:35:18Z", "is_private": false, "text": "By the way, switching between UTF-8 and ISO-8859-1 made no difference."}, {"count": 23, "tags": [], "bug_id": 59604, "attachment_id": 33897, "id": 191331, "time": "2016-05-31T13:26:19Z", "creator": "markt@apache.org", "creation_time": "2016-05-31T13:26:19Z", "is_private": false, "text": "Comment on attachment 33897\nlog file with bare bones conf/web.xml\n\nInteresting. The exception is happening in the WebSocket ServletContainerInitializer. It looks to be complaining that the URL pattern is an empty string. However, the URL pattern is hard-coded to \"/*\".\n\nThere is no more debugging logging we can enable that will shed any light on this. Some custom patches to add additional logging are going to be required. While I can provide suitable patches, shell access to a test environment would enable this to be investigated much faster."}, {"count": 24, "tags": [], "creator": "davec@aesclever.com", "attachment_id": null, "id": 191338, "creation_time": "2016-05-31T18:54:29Z", "time": "2016-05-31T18:54:29Z", "bug_id": 59604, "text": "OK.  Mark, I will send the z/OS shell access info to you.", "is_private": false}, {"count": 25, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "Thanks for the shell access. It really speed up debugging this.\n\nThe bug has been fixed in:\n- trunk for 9.0.0.M7 onwards\n- 8.5.x for 8.5.3 onwards\n- 8.0.x for 8.0.36 onwards\n\n7.0.x and earlier were not affected.", "id": 191341, "time": "2016-06-01T11:28:56Z", "bug_id": 59604, "creation_time": "2016-06-01T11:28:56Z", "is_private": false}, {"count": 26, "tags": [], "text": "Thanks for the speedy fix.", "attachment_id": null, "bug_id": 59604, "id": 191360, "time": "2016-06-01T19:43:45Z", "creator": "davec@aesclever.com", "creation_time": "2016-06-01T19:43:45Z", "is_private": false}]