[{"count": 0, "tags": [], "bug_id": 12007, "attachment_id": null, "text": "Version: CVS: 23-Aug-2002, 19:15\n\nJVM version:\n  java version \"1.4.0_01\"\n  Java(TM) 2 Runtime Environment, Standard Edition (build 1.4.0_01-b03)\n  Java HotSpot(TM) Client VM (build 1.4.0_01-b03, mixed mode)\n\nMy test script uses:\n  - 100 threads \n  - 3 loops\n  - 1 HTTP request per loop\n\nI get many instances of the following exception.  Not on the\nfirst test run, but about the fifth.  Once it starts, it keeps\nhappening; I have to restart JMeter.\n\njava.net.SocketException: Too many open files\n        at java.net.Socket.createImpl(Socket.java:312)\n        at java.net.Socket.connect(Socket.java:423)\n        at java.net.Socket.connect(Socket.java:375)\n        at sun.net.NetworkClient.doConnect(NetworkClient.java:139)\n        at sun.net.www.http.HttpClient.openServer(HttpClient.java:366)\n        at sun.net.www.http.HttpClient.openServer(HttpClient.java:582)\n        at sun.net.www.http.HttpClient.<init>(HttpClient.java:292)\n        at sun.net.www.http.HttpClient.<init>(HttpClient.java:253)\n        at sun.net.www.http.HttpClient.New(HttpClient.java:321)\n        at sun.net.www.http.HttpClient.New(HttpClient.java:306)\n        at sun.net.www.http.HttpClient.New(HttpClient.java:301)\n        at \nsun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:\n469)\n        at \nsun.net.www.protocol.http.HttpURLConnection.connect(HttpURLConnection.java:460)\n        at \norg.apache.jmeter.protocol.http.sampler.HTTPSampler.sample(HTTPSampler.java:887)\n        at \norg.apache.jmeter.protocol.http.sampler.HTTPSampler.sample(HTTPSampler.java:415)\n        at org.apache.jmeter.threads.JMeterThread.run(JMeterThread.java:137)\n        at java.lang.Thread.run(Thread.java:536)\n\nIt does NOT matter whether I \"clear all\" between runs; same\nproblem either way.\n\nIf I add a \"Connection: close\" HTTP header, the problem does NOT\noccur -- but if that distorts the measurements, it isn't a useful\nworkaround.\n\n\nAnalysis:\n\nWhat's happening is that the underlying sockets aren't being\nclosed, and eventually the JVM bumps into the system's\nper-process limit on open file descriptors.\n\nThe right solution would be to make the sockets close at the\nRight Time (which I guess is when, or shortly after, the server\nhas closed its end of the connection).  That seems hard with\nHttpURLConnection.  It's all very confused:\n  - disconnect() just seems to close it immediately -- or not;\n    the Javadocs are intentionally vague about what it actually\n    does, and especially when it does it.\n\n  - close() might be the right choice.  The Evaluation section of\n    Java bug #4147525 says: \"... call close() on the input and/or\n    output stream. This will correctly result in the underlying\n    socket being closed when you aren't doing keepalive\n    connections and will correctly cache and reuse keepalive\n    connections (and which will timeout and close themselves\n    after a short time anyway).\"\n\n  - But maybe not.  Bug #4142971 says: \"Calling the close()\n    methods has no effect one way or the other on whether the\n    underlying HTTP connection is persistent.\"\n\nFailing a clear answer, perhaps the HttpURLConnection objects\ncould be added to a list, and all disconnected at once at the end\nof the test run.  That'd still limit the total size of the run,\nbut at least the lost descriptors wouldn't accumulate between\nruns.\n\nMaybe the real answer is to give up on HttpURLConnection, and\ninstead use the HTTP Client from Jakarta Commons.  Someone\nsuggested that in connection with a different problem (bug\n#4143518).", "id": 21664, "time": "2002-08-24T06:41:45Z", "creator": "eric_97@pobox.com", "creation_time": "2002-08-24T06:41:45Z", "is_private": false}, {"count": 1, "tags": [], "creator": "mstover1@apache.org", "is_private": false, "text": "Your workaround is the same as unselecting the \"keep-alive\" checkbox on the HTTP\nRequest.  It's not a terrible thing to do if it prevents you from running out of\nsockets.  It has a small performance penalty - adding a few hundred milliseconds\nto the time of each request.  \n\nI'd also like to know what happens if you run with keep-alive on, run till you\nget exceptions, then let JMeter sit for a half hour or so before trying again. \nHave the sockets been closed by that time?  What is the timeout period for how\nlong the sockets are kept open?  Are they closing after that period like they\nshould?\n\nThe Jakarta HTTPClient has some problems in terms of use with JMeter.  The\nbiggest is that it aggressively re-uses connections, which would not be\nappropriate for JMeter simulating multiple users (thanks to Martin Ramshaw for\nstudying the matter).", "id": 21667, "time": "2002-08-24T14:16:55Z", "bug_id": 12007, "creation_time": "2002-08-24T14:16:55Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 12007, "attachment_id": null, "id": 21668, "creation_time": "2002-08-24T14:17:29Z", "time": "2002-08-24T14:17:29Z", "creator": "mstover1@apache.org", "text": "Didn't mean to close it.", "is_private": false}, {"count": 3, "tags": [], "bug_id": 12007, "attachment_id": null, "id": 21707, "creation_time": "2002-08-25T19:40:22Z", "time": "2002-08-25T19:40:22Z", "creator": "mstover1@apache.org", "text": "HTTPSampler has been modified to call \"disconnect\" on all HttpURLConnection\nobjects when it is through.  The \"Disconnect\" function tells the object that we\nare through with it - it doesn't necessarily close the connection immediately. \nHowever, it should cause the JVM to close the connection in a reasonable time\nperiod.\nThis is completely independent of choosing the \"keep-alive\" option.   Choosing\nthe \"keep-alive\" option causes the keep-alive header to be written as such,  Not\nchoosing it causes HTTPSampler to write no such header.\n\nLet me know how it works out.", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "jsalvata@atg.com", "is_private": false, "count": 4, "id": 28313, "time": "2002-12-27T16:14:41Z", "bug_id": 12007, "creation_time": "2002-12-27T16:14:41Z", "text": "Marking all bugs RESOLVED before JMeter 1.8's release date as VERIFIED.\nYes, it's pretty poor QA procedure, but there's bugs here lingering since JMeter\n1.6, and we need to clean up a little."}, {"count": 5, "tags": [], "bug_id": 12007, "is_private": false, "id": 28535, "creation_time": "2002-12-29T14:19:54Z", "time": "2002-12-29T14:19:54Z", "creator": "jsalvata@atg.com", "text": "Bulk-closing all bugs RESOLVED before JMeter 1.8 release date.", "attachment_id": null}]