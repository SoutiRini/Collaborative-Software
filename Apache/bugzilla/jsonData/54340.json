[{"count": 0, "text": "Created attachment 29788\nTest case that reproduces the bug\n\nForm-based authentication in combination with URL rewriting does not work: when the user successfully authenticates he is redirected to the application but, the login page is shown again. When he reloads this page then he does get to the actual application !\n\nThe correct behaviour (which can be observed in for example jetty) is that the user correctly can access the actual application after logging in.\n\nThe following access log illustrates the odd behaviour:\n\n127.0.0.1 - - [21/Dec/2012:17:10:30 +0100] \"GET /test-form-auth/protected HTTP/1.1\" 200 450\n127.0.0.1 - - [21/Dec/2012:17:10:35 +0100] \"POST /test-form-auth/j_security_check;jsessionid=DBE966BD9F3CA8A7F57B5677F1D831F4 HTTP/1.1\" 302 -\n127.0.0.1 - - [21/Dec/2012:17:10:35 +0100] \"GET /test-form-auth/protected;jsessionid=DBE966BD9F3CA8A7F57B5677F1D831F4 HTTP/1.1\" 200 450\n127.0.0.1 - koen [21/Dec/2012:17:10:38 +0100] \"GET /test-form-auth/protected;jsessionid=DBE966BD9F3CA8A7F57B5677F1D831F4 HTTP/1.1\" 200 59\n\nNotice the two last requests: they are identical, yet, the server returns the first time the login.jsp page, and the second time the actual web application.\n\nOn top of this (and perhaps related to these problems), in the actual web application a different session ID is actually printed.\n\nThe same application in jetty regenerates the session ID (after authentication) and directly redirects to this new session, reporting the same session ID within the application as is visible in the URL.\n\nThe project in attachment is a self-contained test case that reproduces the problem, including an ant script to create the war file.", "creator": "koen@emweb.be", "is_private": false, "id": 164205, "time": "2012-12-21T16:23:25Z", "bug_id": 54340, "creation_time": "2012-12-21T16:23:25Z", "tags": [], "attachment_id": 29788}, {"count": 1, "tags": [], "bug_id": 54340, "text": "1. Tomcat version = ?\n\nI'd guess that you are facing bug 53584, which was fixed in 7.0.30.\n\n\n> On top of this (and perhaps related to these problems), in the actual web\n> application a different session ID is actually printed.\n\n2. As expected. See \"changeSessionIdOnAuthentication\" in\nhttp://tomcat.apache.org/tomcat-7.0-doc/config/valve.html\n\n3. It works for me in 7.0.34\n\nTo be sure, I changed the <web-app> element in your web.xml to use version=\"3.0\" and relevant version of the schema, instead of 2.3 that you are using.\n\nA fragment of my access log:\n\n127.0.0.1 - - [21/Dec/2012:20:38:59 +0400] \"GET /test-form-auth/protected HTTP/1.1\" 200 450\n127.0.0.1 - - [21/Dec/2012:20:39:15 +0400] \"POST /test-form-auth/j_security_check;jsessionid=38B9A84964A6005AA58ABC5CDA9F6367 HTTP/1.1\" 302 -\n127.0.0.1 - tomcat [21/Dec/2012:20:39:15 +0400] \"GET /test-form-auth/protected HTTP/1.1\" 200 59\n\nTested both with Firefox 17.0.1 and IE 8. Tomcat 7.0.34, BIO connector.\n\n\nThough there are two bits of a mystery:\n------------------\na) Why access log did print jsessionid in the second request, but did not in the third one? FireBug shows that there was jsessionid in the request that Firefox sent.\n\nb) The page that is shown after the test. I tried to refresh it. It worked, but it ended up with 2 jsessionid parameters in the URL (as displayed in the address bar).\n\n\n\nSteps to reproduce for b):\n\n1. Go to\nhttp://localhost:8080/test-form-auth/protected;jsessionid=84C65A4F88EFC446C0DADAC649BD53BE\n\n2. Login form is displayed (as expected). Log in.\n\n3. After logging in the test page is displayed (as expected),\nbut somehow the address bar shows 2 jsessionid path parameters in the URL:\n\nhttp://localhost:8080/test-form-auth/protected;jsessionid=C578A9AAB9E8020B438270DD65DC174C;jsessionid=9DB72687A728F05162C1C3D1B7E94F90\n\nReproducible both with Firefox 17 and IE 8. Firebug shows that Location header in the 302 response for the POST request to j_security_check had 2 jsessionid:\n\nLocation: http://localhost:8080/test-form-auth/protected;jsessionid=C578A9AAB9E8020B438270DD65DC174C;jsessionid=9DB72687A728F05162C1C3D1B7E94F90\n\nAccess log:\n127.0.0.1 - - [21/Dec/2012:21:06:31 +0400] \"GET /test-form-auth/protected;jsessionid=C578A9AAB9E8020B438270DD65DC174C HTTP/1.1\" 200 450\n127.0.0.1 - - [21/Dec/2012:21:06:47 +0400] \"POST /test-form-auth/j_security_check;jsessionid=9DB72687A728F05162C1C3D1B7E94F90 HTTP/1.1\" 302 -\n127.0.0.1 - tomcat [21/Dec/2012:21:06:47 +0400] \"GET /test-form-auth/protected;jsessionid=C578A9AAB9E8020B438270DD65DC174C HTTP/1.1\" 200 59", "id": 164206, "time": "2012-12-21T18:08:10Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2012-12-21T18:08:10Z", "is_private": false, "attachment_id": null}, {"count": 2, "text": "Hey,\n\nIndeed, it looks like the same bug. I really did search the database, but, apparently, not good enough, so sorry for that. We will test with a more recent version (we tested with tomcat 7.0.26 and 7.0.28).\n\n>> On top of this (and perhaps related to these problems), in the actual web\n>> application a different session ID is actually printed.\n>\n>2. As expected. See \"changeSessionIdOnAuthentication\" in\n>http://tomcat.apache.org/tomcat-7.0-doc/config/valve.html\n\nI do understand that the session ID is changed, however, I would have assumed that authentication happens when the credential are received, i.e. in the POST to j_security_check; and then a redirect happens to a URL with a new session ID. But this is not what is observed, instead it seems that either only the session ID is changed when the request arrives to the actual application, or, there is a mismatch between the session ID in the URL and the one that is reported by sessionID() ?\n\nThe expected behavior (to me), which is seen in jetty, is that the first access to the actual application (after authentication) has a sessionId() reported that is equal to the session ID in the URL, but is possibly changed from a sessionId() that was used prior to authentication.\n\nRegards,\nkoen", "bug_id": 54340, "is_private": false, "id": 164240, "time": "2012-12-26T09:43:26Z", "creator": "koen@emweb.be", "creation_time": "2012-12-26T09:43:26Z", "tags": [], "attachment_id": null}, {"count": 3, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 164395, "time": "2013-01-04T22:16:29Z", "bug_id": 54340, "creation_time": "2013-01-04T22:16:29Z", "is_private": false, "text": "\n\n*** This bug has been marked as a duplicate of bug 53584 ***"}]