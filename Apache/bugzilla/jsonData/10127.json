[{"count": 0, "tags": [], "bug_id": 10127, "text": "sun jdk1.4.0_01\ntomcat 4.0.4 final\nwinnt4 sp6a\nIE5,6 & Mozilla 0.9.9\n\nusing tomcat embedded in our app, we find that tomcat will lock the jsp under \ncertain circumstances so the original cannot be edited and saved until tomcat \nis shut down. If we open the jsp source in dreamweaver (or any editor), and \nthen view the page via our servlet, we can change the jsp source, hit refresh \nin the browser, and see the changes immediately. However, if we hit refresh \ntwice in a row (without making any changes to the jsp source) the jsp becomes \nlocked by tomcat, and we can no longer make any changes without either closing \ntomcat down, or deleting the .java and .class files from tomcats work \ndirectory, as a sharing violation occurs. (this also stops us deleting or \nrenaming the jsp)\nUsing HandleEx (from sysinternals.com), we can see that every time refresh is \npressed in the browser without changes being made to the jsp, a new handle to \nthe file is created and kept open.\nI've entered a severity of Major, because our users (mainly web designers) need \nto be able to make changes to a jsp and view the changes immediately, and this \nproblem is causing them major delays because they have to keep shutting down \nthe jvm, and restarting.", "id": 18323, "attachment_id": null, "creator": "ashley.smith@hewittbaconwoodrow.com", "creation_time": "2002-06-21T15:21:39Z", "time": "2002-06-21T15:21:39Z", "is_private": false}, {"count": 1, "tags": [], "creator": "wtff@freenet.de", "text": "I can confirm this bahaviour.\nBoth tomcat 4.0.4 and 4.0.4 beta2 lock jsp files. \nI am running jdk 1.3.0\n\n(I would like to monitor this bug as if I had submitted it myself. Can anyone \ntell me if I can do this?)", "id": 18604, "time": "2002-06-26T14:11:55Z", "bug_id": 10127, "creation_time": "2002-06-26T14:11:55Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 10127, "attachment_id": null, "text": "> (I would like to monitor this bug as if I had submitted it myself. Can anyone \n> tell me if I can do this?)\n\n\"Add CC:\" is the field you should have used", "id": 18606, "time": "2002-06-26T14:28:19Z", "creator": "a.brazhnyk@biconsulting.ws", "creation_time": "2002-06-26T14:28:19Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 10127, "attachment_id": null, "text": "happens here too on tomcat 4.0.3, jdk1.3.0", "id": 18652, "time": "2002-06-27T13:43:43Z", "creator": "as273@hotmail.com", "creation_time": "2002-06-27T13:43:43Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 10127, "attachment_id": null, "text": "Jasper checks to see if a JSP is modified by asking for the last modified date\nof the file. If the JSP is under heavy use, then maybe on Windows this would\nlead to locking the file. I cannot reproduce the problem when the JSP is not\nunder heavy use.\nJasper 2 cleans up JSP reloading and last modification checking, with the option\nof doing that in the background on non-development servers.", "id": 18935, "time": "2002-07-03T13:48:48Z", "creator": "remm@apache.org", "creation_time": "2002-07-03T13:48:48Z", "is_private": false}, {"count": 5, "tags": [], "creator": "ashley.smith@hewittbaconwoodrow.com", "attachment_id": null, "id": 18938, "time": "2002-07-03T13:56:06Z", "bug_id": 10127, "creation_time": "2002-07-03T13:56:06Z", "is_private": false, "text": "this is not happening under heavy use. this is one user, one browser, one \nrequest, and is reproducible at will. Can somebody point me in the right \ndirection for the code that does the last modified checking please, and i'll \nsee if i can debug it to find where the problem is.\nta."}, {"count": 6, "tags": [], "bug_id": 10127, "attachment_id": null, "text": "*** Bug 12628 has been marked as a duplicate of this bug. ***", "id": 27080, "time": "2002-11-27T18:09:25Z", "creator": "vicentesalvador@netscape.net", "creation_time": "2002-11-27T18:09:25Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 10127, "text": "Could this problem be related to this note I found in the Ant javac task docs?\n\nWindows Note:When the modern compiler is used in unforked mode on Windows, it\nlocks up the files present in the classpath of the <javac> task, and does not\nrelease them. The side effect of this is that you will not be able to delete or\nmove those files later on in the build. The workaround is to fork when invoking\nthe compiler.", "id": 27213, "attachment_id": null, "creator": "glenn@apache.org", "creation_time": "2002-12-01T13:57:09Z", "time": "2002-12-01T13:57:09Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 10127, "attachment_id": null, "text": "Hi,\n\nI think I found the reason for this behaviour.\n\nFrom my point of view the reason can be found in the method loadJSP\nin org.apache.jasper.servlet.JspServlet (lines 509 till 590) in JspServlet.java.\n(I refer to Tomcat 4.0.4 here, but this seems to be also valid for all later\nversions\nof Tomcat, including 4.1.x).\n\nLines 509-517:\n\n    boolean loadJSP(String jspUri, String classpath,\n        boolean isErrorPage, HttpServletRequest req, HttpServletResponse res)\n        throws JasperException, FileNotFoundException\n    {\n        // First check if the requested JSP page exists, to avoid creating\n        // unnecessary directories and files.\n        if (context.getResourceAsStream(jspUri) == null)\n            throw new FileNotFoundException(jspUri);\n \nTo be more precise I see the problem in context.getResourceAsStream(jspUri).\nOn success context.getResourceAsStream(jspUri) returns an InputStream.\nBut this instance of InputStream is discarded immediately after the if clause\nwithout\ncalling the close method to close the file. So the file jspUri stays open until this\ninstance of InputStream gets collected by the garbage collection of the VM\nduring which\nthe finalize method will close the file via the close method.\n \nSo I would like to propose the following straight forward patch to solve this\n(against 4.0.4):\n\ndiff -Nru\njakarta-tomcat-4.0.4-src.orig/jasper/src/share/org/apache/jasper/servlet/JspServlet.java\njakarta-tomcat-4.0.4-src/jasper/src/share/org/apache/jasper/servlet/JspServlet.java\n---\njakarta-tomcat-4.0.4-src.orig/jasper/src/share/org/apache/jasper/servlet/JspServlet.java\n2002-06-11 07:09:42.000000000 +0200\n+++\njakarta-tomcat-4.0.4-src/jasper/src/share/org/apache/jasper/servlet/JspServlet.java\n2003-08-20 22:19:11.000000000 +0200\n@@ -68,6 +68,7 @@\n \n import java.util.Hashtable;\n import java.util.Enumeration;\n+import java.io.InputStream;\n import java.io.File;\n import java.io.PrintWriter;\n import java.io.IOException;\n@@ -510,11 +511,23 @@\n \tboolean isErrorPage, HttpServletRequest req, HttpServletResponse res) \n \tthrows JasperException, FileNotFoundException \n     {\n+        InputStream JspPage;\n+\n \t// First check if the requested JSP page exists, to avoid creating\n \t// unnecessary directories and files.\n-\tif (context.getResourceAsStream(jspUri) == null)\n+\tif ((JspPage = context.getResourceAsStream(jspUri)) == null) {\n \t    throw new FileNotFoundException(jspUri);\n-\n+        }\n+        else {\n+          // Close InputStream to avoid file descriptor resource leak\n+          // and file locking with Windows\n+          try {\n+              JspPage.close();\n+          } catch (IOException e) {\n+          // Ignore any IOException in this case\n+          }\n+        }\n+            \n \tJspServletWrapper jsw=(JspServletWrapper) jsps.get(jspUri);\n \tif( jsw==null ) {\n \t    throw new JasperException(\"Can't happen - JspServletWrapper=null\");\n\n\n\nThis patch should be also applicable in general to all Tomcat versions after 4.0.4.\n\n\nRegards\n\nR\u00fcdiger\n", "id": 43087, "time": "2003-08-21T10:53:09Z", "creator": "ruediger.pluem@vodafone.com", "creation_time": "2003-08-21T10:53:09Z", "is_private": false}, {"count": 9, "tags": [], "creator": "ruediger.pluem@vodafone.com", "text": "Hi,\n\nsorry I must correct myself. This problem is already fixed in the Tomcat 4.1.X\nseries since Tomcat 4.1.13.\n(http://cvs.apache.org/viewcvs/jakarta-tomcat-jasper/jasper2/src/share/org/apache/jasper/servlet/JspServlet.java,\nhttp://nagoya.apache.org/bugzilla/show_bug.cgi?id=13843)\n\nI looked in the wrong CVS repository for checking (actually\nI looked in the jasper directory of jakarta-tomcat-4.0 rather than in the jasper2\ndirectory of jakarta-tomcat-jasper).\n\nBut my remarks are still vaild for Tomcat 4.0.x.\n\n\nRegards\n\nR\u00fcdiger", "id": 43170, "time": "2003-08-22T15:24:10Z", "bug_id": 10127, "creation_time": "2003-08-22T15:24:10Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 10127, "attachment_id": null, "text": "As noted in the previous post this has been fixed. (fixes are no longer \napplied to the 4.0.x branch)", "id": 57575, "time": "2004-05-17T22:43:07Z", "creator": "markt@apache.org", "creation_time": "2004-05-17T22:43:07Z", "is_private": false}]