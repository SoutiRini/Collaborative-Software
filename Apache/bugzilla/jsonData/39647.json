[{"count": 0, "tags": [], "creator": "cshumway@titan-project.org", "text": "This is similar, but does not appear to be the same as bug 39266.  I've applied\nthe patch to mod_mem_cache.c and it makes no diffrence.  It also does not matter\nif the storage for mod_cache is disk or memory cache.\n\nHere's the configuration:  Frontend reverse caching proxy server running httpd\n2.2.2, prefork mpm.  The backend web server is httpd 1.3.36 with mod_jk 1.2.15.\n Mod_jk connects to Tomcat 5.0.30 via an ajp 1.3 connector. The namespace /res/*\nis mounted into Tomcat via mod_jk's JKMount directive.\n\nThe first time content is accessed via the front end proxy, it sends the\napproperate content-type header, e.g. 'image/jpeg'.  Further attempts to get the\nsame image usually return a content-type header of 'text/html'.\n\nHere's the correct headers from the client and server:\n\nGET /res/img/content/liferaft.jpg HTTP/1.1\nHost: nuked.greatschools.net\nUser-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.3)\nGecko/20060426 Firefox/1.5.0.3\nAccept:\ntext/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5\nAccept-Language: en-us,en;q=0.5\nAccept-Encoding: gzip,deflate\nAccept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\nKeep-Alive: 300\nConnection: keep-alive\nCookie: TRNO=1127250133.198.144.205.133; NumAd=-1;\ns_vi=[CS]v1|43F0FFA7000062EC-A160B0300000792[CE];\nfcP=C=133&T=1137020088512&V=1137020102487;\nNXCLICK2=011FHWHwNX_mailing/gn/2006_02/ca/8951!y!01!4qcu!52qf!02!4qcv!52qhNX_mailing/gn/2006_02_21/ca/8427!y!01!4r4q!53Uk!02!4r4r!53UqNX_mailing/mss/2006_03/ca/8438.76346803398!y!02!4rJ8!53pF;\nRMFD=011FiFmA; RMID=c690cd854329f1d0; T3CK=TANT%3D1%7CTANO%3D0; s_cc=true;\ns_sq=%5B%5BB%5D%5D; JSESSIONID=8870E2C3BE344A492CCC1DCCDE4036AC; PATHWAY=3\nPragma: no-cache\nCache-Control: no-cache\n\nHTTP/1.x 200 OK\nDate: Tue, 23 May 2006 20:22:31 GMT\nServer: Apache/1.3.33 (Unix) mod_perl/1.29 mod_ssl/2.8.22 OpenSSL/0.9.7d\nmod_jk/1.2.15\nEtag: W/\"26797-1148335021000\"\nContent-Length: 26797\nExpires: Wed, 24 May 2006 00:22:31 GMT\nContent-Type: image/jpeg\nLast-Modified: Mon, 22 May 2006 21:57:01 GMT\nKeep-Alive: timeout=5, max=99\nConnection: Keep-Alive\n\nThe next time the image is requested, the server returns the context-type as\n'text/html', which causes the browser to try to render the image as if it where\nhtml.\n\nGET /res/img/content/liferaft.jpg HTTP/1.1\nHost: nuked.greatschools.net\nUser-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.3)\nGecko/20060426 Firefox/1.5.0.3\nAccept:\ntext/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5\nAccept-Language: en-us,en;q=0.5\nAccept-Encoding: gzip,deflate\nAccept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\nKeep-Alive: 300\nConnection: keep-alive\nCookie: TRNO=1127250133.198.144.205.133; NumAd=-1;\ns_vi=[CS]v1|43F0FFA7000062EC-A160B0300000792[CE];\nfcP=C=133&T=1137020088512&V=1137020102487;\nNXCLICK2=011FHWHwNX_mailing/gn/2006_02/ca/8951!y!01!4qcu!52qf!02!4qcv!52qhNX_mailing/gn/2006_02_21/ca/8427!y!01!4r4q!53Uk!02!4r4r!53UqNX_mailing/mss/2006_03/ca/8438.76346803398!y!02!4rJ8!53pF;\nRMFD=011FiFmA; RMID=c690cd854329f1d0; T3CK=TANT%3D1%7CTANO%3D0; s_cc=true;\ns_sq=%5B%5BB%5D%5D; JSESSIONID=8870E2C3BE344A492CCC1DCCDE4036AC; PATHWAY=3\nPragma: no-cache\nCache-Control: no-cache\n\nHTTP/1.x 200 OK\nDate: Tue, 23 May 2006 20:22:32 GMT\nServer: Apache/1.3.33 (Unix) mod_perl/1.29 mod_ssl/2.8.22 OpenSSL/0.9.7d\nmod_jk/1.2.15\nEtag: W/\"26797-1148335021000\"\nContent-Length: 26797\nExpires: Wed, 24 May 2006 00:22:32 GMT\nContent-Type: text/html\nLast-Modified: Mon, 22 May 2006 21:57:01 GMT\nKeep-Alive: timeout=5, max=98\nConnection: Keep-Alive\n\nHere's another data point:  If the browser requests content that is not being\nserved by mod_jk, then it will work correctly every time.  For example, if the\nbrowser requests images/reportcard.jpg, which is being served directly by the\nbackend web server, it will always send a content type of image/jpeg.\n\nGET /images/reportcard.jpg HTTP/1.1\nHost: nuked.greatschools.net\nUser-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.3)\nGecko/20060426 Firefox/1.5.0.3\nAccept:\ntext/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5\nAccept-Language: en-us,en;q=0.5\nAccept-Encoding: gzip,deflate\nAccept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\nKeep-Alive: 300\nConnection: keep-alive\nCookie: TRNO=1127250133.198.144.205.133; NumAd=-1;\ns_vi=[CS]v1|43F0FFA7000062EC-A160B0300000792[CE];\nfcP=C=133&T=1137020088512&V=1137020102487;\nNXCLICK2=011FHWHwNX_mailing/gn/2006_02/ca/8951!y!01!4qcu!52qf!02!4qcv!52qhNX_mailing/gn/2006_02_21/ca/8427!y!01!4r4q!53Uk!02!4r4r!53UqNX_mailing/mss/2006_03/ca/8438.76346803398!y!02!4rJ8!53pF;\nRMFD=011FiFmA; RMID=c690cd854329f1d0; T3CK=TANT%3D1%7CTANO%3D0; s_cc=true;\ns_sq=%5B%5BB%5D%5D; JSESSIONID=8870E2C3BE344A492CCC1DCCDE4036AC; PATHWAY=3\nPragma: no-cache\nCache-Control: no-cache\n\nHTTP/1.x 200 OK\nDate: Tue, 23 May 2006 20:30:24 GMT\nServer: Apache/1.3.33 (Unix) mod_perl/1.29 mod_ssl/2.8.22 OpenSSL/0.9.7d\nmod_jk/1.2.15\nCache-Control: max-age=21600\nExpires: Wed, 24 May 2006 02:30:24 GMT\nEtag: \"1fae43-4487-3f4e92c4\"\nAccept-Ranges: bytes\nContent-Length: 17543\nLast-Modified: Thu, 28 Aug 2003 23:39:48 GMT\nKeep-Alive: timeout=5, max=89\nConnection: Keep-Alive\nContent-Type: image/jpeg", "id": 89409, "time": "2006-05-23T20:31:27Z", "bug_id": 39647, "creation_time": "2006-05-23T20:31:27Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "id": 89410, "time": "2006-05-23T21:12:20Z", "bug_id": 39647, "creation_time": "2006-05-23T21:12:20Z", "is_private": false, "text": "Please post your cache and proxy configuration here. Furthermore please set the\nloglevel to debug on the proxy server and post the error_log of two subsequent\nrequests where the first one is served directly and the second one is served by\nthe cache with the wrong content-type."}, {"count": 2, "tags": [], "creator": "cshumway@titan-project.org", "text": "Thank you for the follow up.  Here's some more information:\n\n--- httpd.conf ---\nServerRoot \"/usr/local\"\nListen 80\n\nLoadModule authn_file_module libexec/apache22/mod_authn_file.so\nLoadModule authn_dbm_module libexec/apache22/mod_authn_dbm.so\nLoadModule authn_anon_module libexec/apache22/mod_authn_anon.so\nLoadModule authn_default_module libexec/apache22/mod_authn_default.so\nLoadModule authz_host_module libexec/apache22/mod_authz_host.so\nLoadModule authz_groupfile_module libexec/apache22/mod_authz_groupfile.so\nLoadModule authz_user_module libexec/apache22/mod_authz_user.so\nLoadModule authz_dbm_module libexec/apache22/mod_authz_dbm.so\nLoadModule authz_owner_module libexec/apache22/mod_authz_owner.so\nLoadModule authz_default_module libexec/apache22/mod_authz_default.so\nLoadModule auth_basic_module libexec/apache22/mod_auth_basic.so\nLoadModule auth_digest_module libexec/apache22/mod_auth_digest.so\nLoadModule file_cache_module libexec/apache22/mod_file_cache.so\nLoadModule cache_module libexec/apache22/mod_cache.so\nLoadModule disk_cache_module libexec/apache22/mod_disk_cache.so\nLoadModule mem_cache_module libexec/apache22/mod_mem_cache.so\nLoadModule include_module libexec/apache22/mod_include.so\nLoadModule filter_module libexec/apache22/mod_filter.so\nLoadModule charset_lite_module libexec/apache22/mod_charset_lite.so\nLoadModule deflate_module libexec/apache22/mod_deflate.so\nLoadModule log_config_module libexec/apache22/mod_log_config.so\nLoadModule logio_module libexec/apache22/mod_logio.so\nLoadModule env_module libexec/apache22/mod_env.so\nLoadModule mime_magic_module libexec/apache22/mod_mime_magic.so\nLoadModule cern_meta_module libexec/apache22/mod_cern_meta.so\nLoadModule expires_module libexec/apache22/mod_expires.so\nLoadModule headers_module libexec/apache22/mod_headers.so\nLoadModule usertrack_module libexec/apache22/mod_usertrack.so\nLoadModule unique_id_module libexec/apache22/mod_unique_id.so\nLoadModule setenvif_module libexec/apache22/mod_setenvif.so\nLoadModule version_module libexec/apache22/mod_version.so\nLoadModule proxy_module libexec/apache22/mod_proxy.so\nLoadModule proxy_connect_module libexec/apache22/mod_proxy_connect.so\nLoadModule proxy_ftp_module libexec/apache22/mod_proxy_ftp.so\nLoadModule proxy_http_module libexec/apache22/mod_proxy_http.so\nLoadModule proxy_ajp_module libexec/apache22/mod_proxy_ajp.so\nLoadModule proxy_balancer_module libexec/apache22/mod_proxy_balancer.so\nLoadModule ssl_module libexec/apache22/mod_ssl.so\nLoadModule mime_module libexec/apache22/mod_mime.so\nLoadModule dav_module libexec/apache22/mod_dav.so\nLoadModule status_module libexec/apache22/mod_status.so\nLoadModule autoindex_module libexec/apache22/mod_autoindex.so\nLoadModule asis_module libexec/apache22/mod_asis.so\nLoadModule info_module libexec/apache22/mod_info.so\nLoadModule cgi_module libexec/apache22/mod_cgi.so\nLoadModule dav_fs_module libexec/apache22/mod_dav_fs.so\nLoadModule vhost_alias_module libexec/apache22/mod_vhost_alias.so\nLoadModule negotiation_module libexec/apache22/mod_negotiation.so\nLoadModule dir_module libexec/apache22/mod_dir.so\nLoadModule imagemap_module libexec/apache22/mod_imagemap.so\nLoadModule actions_module libexec/apache22/mod_actions.so\nLoadModule speling_module libexec/apache22/mod_speling.so\nLoadModule userdir_module libexec/apache22/mod_userdir.so\nLoadModule alias_module libexec/apache22/mod_alias.so\nLoadModule rewrite_module libexec/apache22/mod_rewrite.so\n\nUser www\nGroup www\n\nServerAdmin sysadmin@greatschools.net\n\n<Directory />\n  AllowOverride None\n  Order deny,allow\n  Deny from all\n</Directory>\n\nTypesConfig /usr/local/etc/apache22/mime.types\n\nErrorLog /var/log/httpd-error.log\nLogLevel debug\n\n# simulated proxy log\nLogFormat \"%h %u %X %t \\\"%r\\\" %s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\n\\\"%{Cookie}i\\\"\" proxylog\ncustomlog /var/log/apache/proxy.log proxylog\n\n# proxy-level rewrites\nRewriteEngine on\n\n# return 403 forbidden if no user-agent specified\n# but don't block our load balancers since they don't specify a user-agent\nRewriteCond %{HTTP_USER_AGENT} =\"\"\nReWriteCond %{REMOTE_ADDR} !207.33.22.13[34]\nReWriteRule ^/* / [L,F]\n\n# cache\nMCacheRemovalAlgorithm GDSF \nMCacheSize 786432\nMCacheMaxObjectSize  256000\nMCacheMaxObjectCount 65535\nCacheDefaultExpire 14400\nCacheEnable mem /\n\n# proxy\nProxyRequests Off\nProxyPreserveHost on\nProxyPass / http://dev.greatschools.net/\n\n<Proxy *>\n  Order deny,allow\n  Allow from all\n</Proxy>\n\n# mod_deflate\n<Location />\n  SetOutputFilter DEFLATE\n  SetEnvIfNoCase Request_URI \\.(?:gif|jpe?g|png)$ no-gzip dont-vary\n  Header append Vary User-Agent env=!dont-vary\n</Location>\n\n---\nHere's the relevent log for the working request:\n\n\n[Tue May 23 14:23:20 2006] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /res/img/content/liferaft.jpg\n[Tue May 23 14:23:20 2006] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /res/img/content/liferaft.jpg\n[Tue May 23 14:23:20 2006] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //dev.greatschools.net/res/img/content/liferaft.jpg\n[Tue May 23 14:23:20 2006] [debug] proxy_util.c(1378): [client 198.144.205.133]\nproxy: http: found worker http://dev.greatschools.net/ for\nhttp://dev.greatschools.net/res/img/content/liferaft.jpg\n[Tue May 23 14:23:20 2006] [debug] mod_proxy.c(756): Running scheme http handler\n(attempt 0)\n[Tue May 23 14:23:20 2006] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://dev.greatschools.net/res/img/content/liferaft.jpg\n[Tue May 23 14:23:20 2006] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (dev.greatschools.net)\n[Tue May 23 14:23:20 2006] [debug] proxy_util.c(1858): proxy: connecting\nhttp://dev.greatschools.net/res/img/content/liferaft.jpg to dev.greatschools.net:80\n[Tue May 23 14:23:20 2006] [debug] proxy_util.c(1951): proxy: connected\n/res/img/content/liferaft.jpg to dev.greatschools.net:80\n[Tue May 23 14:23:20 2006] [debug] proxy_util.c(2045): proxy: HTTP: fam 2 socket\ncreated to connect to dev.greatschools.net\n[Tue May 23 14:23:20 2006] [debug] proxy_util.c(2141): proxy: HTTP: connection\ncomplete to 198.144.205.152:80 (dev.greatschools.net)\n[Tue May 23 14:23:20 2006] [debug] mod_proxy_http.c(1448): proxy: start body send\n[Tue May 23 14:23:20 2006] [debug] mod_headers.c(612): headers:\nap_headers_output_filter()\n[Tue May 23 14:23:20 2006] [debug] mod_cache.c(602): cache: Caching url:\n/res/img/content/liferaft.jpg\n[Tue May 23 14:23:20 2006] [debug] mod_cache.c(608): cache: Removing\nCACHE_REMOVE_URL filter.\n[Tue May 23 14:23:20 2006] [info] mem_cache: Cached url:\nhttp://nuked.greatschools.net:80/res/img/content/liferaft.jpg?\n[Tue May 23 14:23:20 2006] [debug] mod_proxy_http.c(1537): proxy: end body send\n[Tue May 23 14:23:20 2006] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (dev.greatschools.net)\n[Tue May 23 14:23:20 2006] [debug] proxy_util.c(1625): proxy: grabbed scoreboard\nslot 0 in child 63574 for worker http://dev.greatschools.net/\n[Tue May 23 14:23:20 2006] [debug] proxy_util.c(1644): proxy: worker\nhttp://dev.greatschools.net/ already initialized\n[Tue May 23 14:23:20 2006] [debug] proxy_util.c(1724): proxy: initialized single\nconnection worker 0 in child 63574 for (dev.greatschools.net)\n[Tue May 23 14:23:20 2006] [debug] proxy_util.c(1625): proxy: grabbed scoreboard\nslot 1 in child 63574 for worker proxy:reverse\n[Tue May 23 14:23:20 2006] [debug] proxy_util.c(1644): proxy: worker\nproxy:reverse already initialized\n[Tue May 23 14:23:20 2006] [debug] proxy_util.c(1724): proxy: initialized single\nconnection worker 1 in child 63574 for (*)\n\nHere's the relevent log for the non-working request:\n\n[Tue May 23 14:23:24 2006] [debug] cache_storage.c(261): Cached response for\n/res/img/content/liferaft.jpg isn't fresh.  Adding/replacing conditional request\nheaders.\n[Tue May 23 14:23:24 2006] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /res/img/content/liferaft.jpg\n[Tue May 23 14:23:24 2006] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /res/img/content/liferaft.jpg\n[Tue May 23 14:23:24 2006] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //dev.greatschools.net/res/img/content/liferaft.jpg\n[Tue May 23 14:23:24 2006] [debug] proxy_util.c(1378): [client 198.144.205.133]\nproxy: http: found worker http://dev.greatschools.net/ for\nhttp://dev.greatschools.net/res/img/content/liferaft.jpg\n[Tue May 23 14:23:24 2006] [debug] mod_proxy.c(756): Running scheme http handler\n(attempt 0)\n[Tue May 23 14:23:24 2006] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://dev.greatschools.net/res/img/content/liferaft.jpg\n[Tue May 23 14:23:24 2006] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (dev.greatschools.net)\n[Tue May 23 14:23:24 2006] [debug] proxy_util.c(1858): proxy: connecting\nhttp://dev.greatschools.net/res/img/content/liferaft.jpg to dev.greatschools.net:80\n[Tue May 23 14:23:24 2006] [debug] proxy_util.c(1951): proxy: connected\n/res/img/content/liferaft.jpg to dev.greatschools.net:80\n[Tue May 23 14:23:24 2006] [debug] proxy_util.c(2141): proxy: HTTP: connection\ncomplete to 198.144.205.152:80 (dev.greatschools.net)\n[Tue May 23 14:23:24 2006] [debug] mod_proxy_http.c(1541): proxy: header only\n[Tue May 23 14:23:24 2006] [debug] mod_headers.c(612): headers:\nap_headers_output_filter()\n[Tue May 23 14:23:24 2006] [debug] mod_cache.c(602): cache: Caching url:\n/res/img/content/liferaft.jpg\n[Tue May 23 14:23:24 2006] [debug] mod_cache.c(608): cache: Removing\nCACHE_REMOVE_URL filter.\n[Tue May 23 14:23:24 2006] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (dev.greatschools.net)\n[Tue May 23 14:23:24 2006] [debug] cache_storage.c(261): Cached response for\n/res/img/content/liferaft.jpg isn't fresh.  Adding/replacing conditional request\nheaders.\n[Tue May 23 14:23:24 2006] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /res/img/content/liferaft.jpg\n[Tue May 23 14:23:24 2006] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /res/img/content/liferaft.jpg\n[Tue May 23 14:23:24 2006] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //dev.greatschools.net/res/img/content/liferaft.jpg\n[Tue May 23 14:23:24 2006] [debug] proxy_util.c(1378): [client 198.144.205.133]\nproxy: http: found worker http://dev.greatschools.net/ for\nhttp://dev.greatschools.net/res/img/content/liferaft.jpg\n[Tue May 23 14:23:24 2006] [debug] mod_proxy.c(756): Running scheme http handler\n(attempt 0)\n[Tue May 23 14:23:24 2006] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://dev.greatschools.net/res/img/content/liferaft.jpg\n[Tue May 23 14:23:24 2006] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (dev.greatschools.net)\n[Tue May 23 14:23:24 2006] [debug] proxy_util.c(1858): proxy: connecting\nhttp://dev.greatschools.net/res/img/content/liferaft.jpg to dev.greatschools.net:80\n[Tue May 23 14:23:24 2006] [debug] proxy_util.c(1951): proxy: connected\n/res/img/content/liferaft.jpg to dev.greatschools.net:80\n[Tue May 23 14:23:24 2006] [debug] proxy_util.c(2141): proxy: HTTP: connection\ncomplete to 198.144.205.152:80 (dev.greatschools.net)\n[Tue May 23 14:23:24 2006] [debug] mod_proxy_http.c(1541): proxy: header only\n[Tue May 23 14:23:24 2006] [debug] mod_headers.c(612): headers:\nap_headers_output_filter()\n[Tue May 23 14:23:24 2006] [debug] mod_cache.c(602): cache: Caching url:\n/res/img/content/liferaft.jpg\n[Tue May 23 14:23:24 2006] [debug] mod_cache.c(608): cache: Removing\nCACHE_REMOVE_URL filter.\n[Tue May 23 14:23:24 2006] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (dev.greatschools.net) \n", "id": 89412, "time": "2006-05-23T21:27:13Z", "bug_id": 39647, "creation_time": "2006-05-23T21:27:13Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 39647, "attachment_id": null, "text": "Heres some data from the log when fetching a stand-alone image, one not served\nvia mod_jk.  Interestingly I noticed when mem_cache cached the content, it added\na '?' at the end of the URI.  I added a '?' to the end of\n/res/img/content/liferaft.jpg and it looks like it sent the headers correctly\nevery time.\n\n\n[Tue May 23 15:15:20 2006] [info] mod_unique_id: using ip addr 198.144.205.144\n[Tue May 23 15:15:21 2006] [info] Init: Seeding PRNG with 0 bytes of entropy\n[Tue May 23 15:15:21 2006] [info] Init: Generating temporary RSA private keys\n(512/1024 bits)\n[Tue May 23 15:15:21 2006] [info] Init: Generating temporary DH parameters\n(512/1024 bits)\n[Tue May 23 15:15:21 2006] [warn] Init: Session Cache is not configured [hint:\nSSLSessionCache]\n[Tue May 23 15:15:21 2006] [info] Init: Initializing (virtual) servers for SSL\n[Tue May 23 15:15:21 2006] [info] Server: Apache/2.2.2, Interface:\nmod_ssl/2.2.2, Library: OpenSSL/0.9.7e-p1\n[Tue May 23 15:15:21 2006] [info] mod_unique_id: using ip addr 198.144.205.144\n[Tue May 23 15:15:22 2006] [info] Init: Seeding PRNG with 0 bytes of entropy\n[Tue May 23 15:15:22 2006] [info] Init: Generating temporary RSA private keys\n(512/1024 bits)\n[Tue May 23 15:15:23 2006] [info] Init: Generating temporary DH parameters\n(512/1024 bits)\n[Tue May 23 15:15:23 2006] [info] Init: Initializing (virtual) servers for SSL\n[Tue May 23 15:15:23 2006] [info] Server: Apache/2.2.2, Interface:\nmod_ssl/2.2.2, Library: OpenSSL/0.9.7e-p1\n[Tue May 23 15:15:23 2006] [notice] Digest: generating secret for digest\nauthentication ...\n[Tue May 23 15:15:23 2006] [notice] Digest: done\n[Tue May 23 15:15:23 2006] [notice] Apache/2.2.2 (FreeBSD) mod_ssl/2.2.2\nOpenSSL/0.9.7e-p1 DAV/2 configured -- resuming normal operations\n[Tue May 23 15:15:23 2006] [info] Server built: May 23 2006 12:40:34\n[Tue May 23 15:15:23 2006] [debug] prefork.c(991): AcceptMutex: flock (default:\nflock)\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1625): proxy: grabbed scoreboard\nslot 0 in child 63711 for worker http://dev.greatschools.net/\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1724): proxy: initialized single\nconnection worker 0 in child 63711 for (dev.greatschools.net)\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1625): proxy: grabbed scoreboard\nslot 1 in child 63711 for worker proxy:reverse\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1724): proxy: initialized single\nconnection worker 1 in child 63711 for (*)\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1625): proxy: grabbed scoreboard\nslot 0 in child 63712 for worker http://dev.greatschools.net/\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1644): proxy: worker\nhttp://dev.greatschools.net/ already initialized\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1724): proxy: initialized single\nconnection worker 0 in child 63712 for (dev.greatschools.net)\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1625): proxy: grabbed scoreboard\nslot 1 in child 63712 for worker proxy:reverse\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1644): proxy: worker\nproxy:reverse already initialized\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1724): proxy: initialized single\nconnection worker 1 in child 63712 for (*)\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1625): proxy: grabbed scoreboard\nslot 0 in child 63715 for worker http://dev.greatschools.net/\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1644): proxy: worker\nhttp://dev.greatschools.net/ already initialized\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1724): proxy: initialized single\nconnection worker 0 in child 63715 for (dev.greatschools.net)\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1625): proxy: grabbed scoreboard\nslot 1 in child 63715 for worker proxy:reverse\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1644): proxy: worker\nproxy:reverse already initialized\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1724): proxy: initialized single\nconnection worker 1 in child 63715 for (*)\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1625): proxy: grabbed scoreboard\nslot 0 in child 63713 for worker http://dev.greatschools.net/\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1644): proxy: worker\nhttp://dev.greatschools.net/ already initialized\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1724): proxy: initialized single\nconnection worker 0 in child 63713 for (dev.greatschools.net)\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1625): proxy: grabbed scoreboard\nslot 1 in child 63713 for worker proxy:reverse\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1644): proxy: worker\nproxy:reverse already initialized\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1724): proxy: initialized single\nconnection worker 1 in child 63713 for (*)\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1625): proxy: grabbed scoreboard\nslot 0 in child 63714 for worker http://dev.greatschools.net/\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1644): proxy: worker\nhttp://dev.greatschools.net/ already initialized\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1724): proxy: initialized single\nconnection worker 0 in child 63714 for (dev.greatschools.net)\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1625): proxy: grabbed scoreboard\nslot 1 in child 63714 for worker proxy:reverse\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1644): proxy: worker\nproxy:reverse already initialized\n[Tue May 23 15:15:23 2006] [debug] proxy_util.c(1724): proxy: initialized single\nconnection worker 1 in child 63714 for (*)\n[Tue May 23 15:16:25 2006] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /images/reportcard.jpg\n[Tue May 23 15:16:25 2006] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /images/reportcard.jpg\n[Tue May 23 15:16:25 2006] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //dev.greatschools.net/images/reportcard.jpg\n[Tue May 23 15:16:25 2006] [debug] proxy_util.c(1378): [client 198.144.205.133]\nproxy: http: found worker http://dev.greatschools.net/ for\nhttp://dev.greatschools.net/images/reportcard.jpg\n[Tue May 23 15:16:25 2006] [debug] mod_proxy.c(756): Running scheme http handler\n(attempt 0)\n[Tue May 23 15:16:25 2006] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://dev.greatschools.net/images/reportcard.jpg\n[Tue May 23 15:16:25 2006] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (dev.greatschools.net)\n[Tue May 23 15:16:25 2006] [debug] proxy_util.c(1858): proxy: connecting\nhttp://dev.greatschools.net/images/reportcard.jpg to dev.greatschools.net:80\n[Tue May 23 15:16:25 2006] [debug] proxy_util.c(1951): proxy: connected\n/images/reportcard.jpg to dev.greatschools.net:80\n[Tue May 23 15:16:25 2006] [debug] proxy_util.c(2045): proxy: HTTP: fam 2 socket\ncreated to connect to dev.greatschools.net\n[Tue May 23 15:16:25 2006] [debug] proxy_util.c(2141): proxy: HTTP: connection\ncomplete to 198.144.205.152:80 (dev.greatschools.net)\n[Tue May 23 15:16:25 2006] [debug] mod_proxy_http.c(1448): proxy: start body send\n[Tue May 23 15:16:25 2006] [debug] mod_headers.c(612): headers:\nap_headers_output_filter()\n[Tue May 23 15:16:25 2006] [debug] mod_cache.c(602): cache: Caching url:\n/images/reportcard.jpg\n[Tue May 23 15:16:25 2006] [debug] mod_cache.c(608): cache: Removing\nCACHE_REMOVE_URL filter.\n[Tue May 23 15:16:25 2006] [info] mem_cache: Cached url:\nhttp://nuked.greatschools.net:80/images/reportcard.jpg?\n[Tue May 23 15:16:25 2006] [debug] mod_proxy_http.c(1537): proxy: end body send\n[Tue May 23 15:16:25 2006] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (dev.greatschools.net)\n[Tue May 23 15:16:26 2006] [debug] proxy_util.c(1625): proxy: grabbed scoreboard\nslot 0 in child 63719 for worker http://dev.greatschools.net/\n[Tue May 23 15:16:26 2006] [debug] proxy_util.c(1644): proxy: worker\nhttp://dev.greatschools.net/ already initialized\n[Tue May 23 15:16:26 2006] [debug] proxy_util.c(1724): proxy: initialized single\nconnection worker 0 in child 63719 for (dev.greatschools.net)\n[Tue May 23 15:16:26 2006] [debug] proxy_util.c(1625): proxy: grabbed scoreboard\nslot 1 in child 63719 for worker proxy:reverse\n[Tue May 23 15:16:26 2006] [debug] proxy_util.c(1644): proxy: worker\nproxy:reverse already initialized\n[Tue May 23 15:16:26 2006] [debug] proxy_util.c(1724): proxy: initialized single\nconnection worker 1 in child 63719 for (*)\n[Tue May 23 15:16:41 2006] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /images/reportcard.jpg\n[Tue May 23 15:16:41 2006] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /images/reportcard.jpg\n[Tue May 23 15:16:41 2006] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //dev.greatschools.net/images/reportcard.jpg\n[Tue May 23 15:16:41 2006] [debug] proxy_util.c(1378): [client 198.144.205.133]\nproxy: http: found worker http://dev.greatschools.net/ for\nhttp://dev.greatschools.net/images/reportcard.jpg\n[Tue May 23 15:16:41 2006] [debug] mod_proxy.c(756): Running scheme http handler\n(attempt 0)\n[Tue May 23 15:16:41 2006] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://dev.greatschools.net/images/reportcard.jpg\n[Tue May 23 15:16:41 2006] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (dev.greatschools.net)\n[Tue May 23 15:16:41 2006] [debug] proxy_util.c(1858): proxy: connecting\nhttp://dev.greatschools.net/images/reportcard.jpg to dev.greatschools.net:80\n[Tue May 23 15:16:41 2006] [debug] proxy_util.c(1951): proxy: connected\n/images/reportcard.jpg to dev.greatschools.net:80\n[Tue May 23 15:16:41 2006] [debug] proxy_util.c(2045): proxy: HTTP: fam 2 socket\ncreated to connect to dev.greatschools.net\n[Tue May 23 15:16:41 2006] [debug] proxy_util.c(2141): proxy: HTTP: connection\ncomplete to 198.144.205.152:80 (dev.greatschools.net)\n[Tue May 23 15:16:41 2006] [debug] mod_proxy_http.c(1448): proxy: start body send\n[Tue May 23 15:16:41 2006] [debug] mod_headers.c(612): headers:\nap_headers_output_filter()\n[Tue May 23 15:16:41 2006] [debug] mod_cache.c(602): cache: Caching url:\n/images/reportcard.jpg\n[Tue May 23 15:16:41 2006] [debug] mod_cache.c(608): cache: Removing\nCACHE_REMOVE_URL filter.\n[Tue May 23 15:16:41 2006] [info] mem_cache: Cached url:\nhttp://nuked.greatschools.net:80/images/reportcard.jpg?\n[Tue May 23 15:16:41 2006] [debug] mod_proxy_http.c(1537): proxy: end body send\n[Tue May 23 15:16:41 2006] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (dev.greatschools.net)\n\n", "id": 89413, "time": "2006-05-23T22:22:58Z", "creator": "cshumway@titan-project.org", "creation_time": "2006-05-23T22:22:58Z", "is_private": false}, {"count": 4, "tags": [], "creator": "cshumway@titan-project.org", "text": "Here's an interesting data point.  I was tinkering with this issue a bit more\ntoday and discovered that I could hit the cached image that was origionally\nserved via mod_jk using wget all I want, and it would always return image/jpeg\nas the content-type.  Once I loaded up firefox and hit ctrl+F5 (force refresh)\nmod_cache started to return text/html as the content type.  So for some reason,\nthe act of force refreshing in firefox seems to be a trigger.\n", "id": 89416, "time": "2006-05-24T01:17:13Z", "bug_id": 39647, "creation_time": "2006-05-24T01:17:13Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 39647, "attachment_id": null, "text": "You are correct that this has something to do with doing a refresh in Firefox.\nRequesting a refresh in Firefox requires the cache to revalidate the cached\nentity on the back end server. Something seems to go wrong during this process.\nCurrently I cannot decide if this is because something is wrong in the cache\ncode or because the backend delivers a bad response. So it would be most helpful\nif you could sniff the network traffic between your proxy httpd and your backend\nhttpd, do a non working refresh request with Firefox and attach the results of\nyour sniffing to this report.", "id": 89474, "time": "2006-05-25T11:37:07Z", "creator": "rpluem@apache.org", "creation_time": "2006-05-25T11:37:07Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 39647, "attachment_id": null, "text": "Thank you for the followup.  Here's some investigation with tcpdump and ethereal\nfrom the proxy server.\n\nThe client is 198.144.205.133, the reverse proxy server is 198.144.205.144 and\nthe backend web server is 198.144.205.152.\n\nHere is the client making the inital request for /res/img/content/liferaft.jpg.\n13:39:20.748596 IP 198.144.205.133.3180 > 198.144.205.144.80: S\n3335533019:3335533019(0) win 65535 <mss 1460,nop,nop,sackOK>\n\n13:39:20.748697 IP 198.144.205.144.80 > 198.144.205.133.3180: S\n876667792:876667792(0) ack 3335533020 win 65535 <mss 1460,sackOK,eol>\n\n13:39:20.748824 IP 198.144.205.133.3180 > 198.144.205.144.80: . ack 1 win 65535\n\n13:39:20.749129 IP 198.144.205.133.3180 > 198.144.205.144.80: P 1:834(833) ack 1\nwin 65535\n\n\nHere are the headers the client sent to the proxy server.\n\nGET /res/img/content/liferaft.jpg HTTP/1.1\nHost: nuked.greatschools.net\nUser-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.3)\nGecko/20060426 Firefox/1.5.0.3\nAccept:\ntext/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5\nAccept-Language: en-us,en;q=0.5\nAccept-Encoding: gzip,deflate\nAccept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\nKeep-Alive: 300\nConnection: keep-alive\nCookie: T3CK=TANT%3D1%7CTANO%3D0; fcP=C=133&T=1137020088512&V=1137020102487;\ns_vi=[CS]v1|43F0FFA7000062EC-A160B0300000792[CE]; RMID=c690cd854329f1d0;\nRMFD=011Fiz3b;\nNXCLICK2=011FHWHwNX_mailing/gn/2006_02/ca/8951!y!01!4qcu!52qf!02!4qcv!52qhNX_mailing/gn/2006_02_21/ca/8427!y!01!4r4q!53Uk!02!4r4r!53UqNX_mailing/mss/2006_03/ca/8438.76346803398!y!02!4rJ8!53pF;\nTRNO=1127250133.198.144.205.133\n\nNext, the proxy server makes a connection to the backend web server to fufill\nthe request:\n\n13:39:20.751945 IP 198.144.205.144.55524 > 198.144.205.152.80: S\n1402262641:1402262641(0) win 65535 <mss 1460,nop,wscale 1,nop,nop,timestamp\n4082124725 0,sackOK,eol>\n13:39:20.752099 IP 198.144.205.152.80 > 198.144.205.144.55524: S\n2054288495:2054288495(0) ack 1402262642 win 57344 <mss 1460,nop,wscale\n0,nop,nop,timestamp 1733763502 4082124725>\n13:39:20.752170 IP 198.144.205.144.55524 > 198.144.205.152.80: . ack 1 win 33304\n<nop,nop,timestamp 4082124725 1733763502>\n13:39:20.752735 IP 198.144.205.144.55524 > 198.144.205.152.80: P 1:956(955) ack\n1 win 33304 <nop,nop,timestamp 4082124726 1733763502>\n13:39:20.757824 IP 198.144.205.152.80 > 198.144.205.144.55524: . 1:1449(1448)\nack 956 win 57920 <nop,nop,timestamp 1733763503 4082124726>\n13:39:20.757934 IP 198.144.205.152.80 > 198.144.205.144.55524: . 1449:2897(1448)\nack 956 win 57920 <nop,nop,timestamp 1733763503 4082124726>\n13:39:20.757977 IP 198.144.205.144.55524 > 198.144.205.152.80: . ack 2897 win\n32580 <nop,nop,timestamp 4082124731 1733763503>\n13:39:20.758057 IP 198.144.205.152.80 > 198.144.205.144.55524: . 2897:4345(1448)\nack 956 win 57920 <nop,nop,timestamp 1733763503 4082124726>\n13:39:20.758179 IP 198.144.205.152.80 > 198.144.205.144.55524: . 4345:5793(1448)\nack 956 win 57920 <nop,nop,timestamp 1733763503 4082124726>\n13:39:20.758211 IP 198.144.205.144.55524 > 198.144.205.152.80: . ack 5793 win\n31132 <nop,nop,timestamp 4082124731 1733763503>\n13:39:20.758313 IP 198.144.205.152.80 > 198.144.205.144.55524: . 5793:7241(1448)\nack 956 win 57920 <nop,nop,timestamp 1733763503 4082124726>\n13:39:20.758426 IP 198.144.205.152.80 > 198.144.205.144.55524: . 7241:8689(1448)\nack 956 win 57920 <nop,nop,timestamp 1733763503 4082124731>\n13:39:20.758462 IP 198.144.205.144.55524 > 198.144.205.152.80: . ack 8689 win\n29684 <nop,nop,timestamp 4082124732 1733763503>\n13:39:20.758549 IP 198.144.205.152.80 > 198.144.205.144.55524: .\n8689:10137(1448) ack 956 win 57920 <nop,nop,timestamp 1733763503 4082124731>\n13:39:20.758675 IP 198.144.205.152.80 > 198.144.205.144.55524: .\n10137:11585(1448) ack 956 win 57920 <nop,nop,timestamp 1733763503 4082124731>\n13:39:20.758715 IP 198.144.205.144.55524 > 198.144.205.152.80: . ack 11585 win\n28236 <nop,nop,timestamp 4082124732 1733763503>\n13:39:20.758796 IP 198.144.205.152.80 > 198.144.205.144.55524: .\n11585:13033(1448) ack 956 win 57920 <nop,nop,timestamp 1733763503 4082124731>\n13:39:20.758918 IP 198.144.205.152.80 > 198.144.205.144.55524: .\n13033:14481(1448) ack 956 win 57920 <nop,nop,timestamp 1733763503 4082124731>\n13:39:20.758953 IP 198.144.205.144.55524 > 198.144.205.152.80: . ack 14481 win\n26788 <nop,nop,timestamp 4082124732 1733763503>\n13:39:20.759041 IP 198.144.205.152.80 > 198.144.205.144.55524: .\n14481:15929(1448) ack 956 win 57920 <nop,nop,timestamp 1733763503 4082124731>\n13:39:20.759168 IP 198.144.205.152.80 > 198.144.205.144.55524: .\n15929:17377(1448) ack 956 win 57920 <nop,nop,timestamp 1733763503 4082124732>\n13:39:20.759211 IP 198.144.205.144.55524 > 198.144.205.152.80: . ack 17377 win\n25340 <nop,nop,timestamp 4082124732 1733763503>\n13:39:20.759288 IP 198.144.205.152.80 > 198.144.205.144.55524: .\n17377:18825(1448) ack 956 win 57920 <nop,nop,timestamp 1733763503 4082124732>\n13:39:20.759411 IP 198.144.205.152.80 > 198.144.205.144.55524: .\n18825:20273(1448) ack 956 win 57920 <nop,nop,timestamp 1733763503 4082124732>\n13:39:20.759448 IP 198.144.205.144.55524 > 198.144.205.152.80: . ack 20273 win\n23892 <nop,nop,timestamp 4082124733 1733763503>\n13:39:20.759536 IP 198.144.205.152.80 > 198.144.205.144.55524: .\n20273:21721(1448) ack 956 win 57920 <nop,nop,timestamp 1733763503 4082124732>\n13:39:20.759656 IP 198.144.205.152.80 > 198.144.205.144.55524: .\n21721:23169(1448) ack 956 win 57920 <nop,nop,timestamp 1733763503 4082124732>\n13:39:20.759697 IP 198.144.205.144.55524 > 198.144.205.152.80: . ack 23169 win\n22444 <nop,nop,timestamp 4082124733 1733763503>\n13:39:20.759780 IP 198.144.205.152.80 > 198.144.205.144.55524: .\n23169:24617(1448) ack 956 win 57920 <nop,nop,timestamp 1733763503 4082124732>\n13:39:20.759903 IP 198.144.205.152.80 > 198.144.205.144.55524: .\n24617:26065(1448) ack 956 win 57920 <nop,nop,timestamp 1733763503 4082124732>\n13:39:20.759940 IP 198.144.205.144.55524 > 198.144.205.152.80: . ack 26065 win\n20996 <nop,nop,timestamp 4082124733 1733763503>\n13:39:20.759994 IP 198.144.205.152.80 > 198.144.205.144.55524: P\n26065:27126(1061) ack 956 win 57920 <nop,nop,timestamp 1733763503 4082124732>\n13:39:20.760244 IP 198.144.205.144.55524 > 198.144.205.152.80: . ack 27126 win\n24465 <nop,nop,timestamp 4082124733 1733763503>\n13:39:20.761346 IP 198.144.205.144.55524 > 198.144.205.152.80: . ack 27126 win\n28465 <nop,nop,timestamp 4082124735 1733763503>\n13:39:20.762105 IP 198.144.205.144.55524 > 198.144.205.152.80: . ack 27126 win\n32465 <nop,nop,timestamp 4082124735 1733763503>\n13:39:37.395766 IP 198.144.205.152.80 > 198.144.205.144.55524: F 27126:27126(0)\nack 956 win 57920 <nop,nop,timestamp 1733765167 4082124735>\n13:39:37.395864 IP 198.144.205.144.55524 > 198.144.205.152.80: . ack 27127 win\n33304 <nop,nop,timestamp 4082141370 1733765167>\n13:40:46.519437 IP 198.144.205.144.55524 > 198.144.205.152.80: F 956:956(0) ack\n27127 win 33304 <nop,nop,timestamp 4082210495 1733765167>\n13:40:46.519586 IP 198.144.205.152.80 > 198.144.205.144.55524: . ack 957 win\n57920 <nop,nop,timestamp 1733772078 4082210495>\n\nHere are the headers that the proxy server sends to the backend for the request:\n\nGET /res/img/content/liferaft.jpg HTTP/1.1\nHost: nuked.greatschools.net\nUser-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.3)\nGecko/20060426 Firefox/1.5.0.3\nAccept:\ntext/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5\nAccept-Language: en-us,en;q=0.5\nAccept-Encoding: gzip,deflate\nAccept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\nCookie: T3CK=TANT%3D1%7CTANO%3D0; fcP=C=133&T=1137020088512&V=1137020102487;\ns_vi=[CS]v1|43F0FFA7000062EC-A160B0300000792[CE]; RMID=c690cd854329f1d0;\nRMFD=011Fiz3b;\nNXCLICK2=011FHWHwNX_mailing/gn/2006_02/ca/8951!y!01!4qcu!52qf!02!4qcv!52qhNX_mailing/gn/2006_02_21/ca/8427!y!01!4r4q!53Uk!02!4r4r!53UqNX_mailing/mss/2006_03/ca/8438.76346803398!y!02!4rJ8!53pF;\nTRNO=1127250133.198.144.205.133\nMax-Forwards: 10\nX-Forwarded-For: 198.144.205.133\nX-Forwarded-Host: nuked.greatschools.net\nX-Forwarded-Server: nuked.greatschools.net.\nConnection: Keep-Alive\n\nHere are the headers the backend responds with:\n\nHTTP/1.1 200 OK\nDate: Thu, 25 May 2006 20:39:20 GMT\nServer: Apache/1.3.33 (Unix) mod_perl/1.29 mod_ssl/2.8.22 OpenSSL/0.9.7d\nmod_jk/1.2.15\nETag: W/\"26797-1148506126000\"\nLast-Modified: Wed, 24 May 2006 21:28:46 GMT\nContent-Length: 26797\nKeep-Alive: timeout=15, max=1000\nConnection: Keep-Alive\nContent-Type: image/jpeg\n\n\nThen the proxy server responds to the client's request:\n\n13:39:20.760358 IP 198.144.205.144.80 > 198.144.205.133.3180: . 1:1461(1460) ack\n834 win 65535\n13:39:20.760894 IP 198.144.205.144.80 > 198.144.205.133.3180: . 1461:2921(1460)\nack 834 win 65535\n13:39:20.760919 IP 198.144.205.144.80 > 198.144.205.133.3180: . 2921:4381(1460)\nack 834 win 65535\n13:39:20.760932 IP 198.144.205.144.80 > 198.144.205.133.3180: . 4381:5841(1460)\nack 834 win 65535\n13:39:20.761507 IP 198.144.205.133.3180 > 198.144.205.144.80: . ack 2921 win 65535\n13:39:20.761607 IP 198.144.205.144.80 > 198.144.205.133.3180: . 5841:7301(1460)\nack 834 win 65535\n13:39:20.761621 IP 198.144.205.144.80 > 198.144.205.133.3180: . 7301:8761(1460)\nack 834 win 65535\n13:39:20.761635 IP 198.144.205.144.80 > 198.144.205.133.3180: . 8761:10221(1460)\nack 834 win 65535\n13:39:20.761719 IP 198.144.205.133.3180 > 198.144.205.144.80: . ack 5841 win 65535\n13:39:20.761748 IP 198.144.205.144.80 > 198.144.205.133.3180: .\n10221:11681(1460) ack 834 win 65535\n13:39:20.761763 IP 198.144.205.144.80 > 198.144.205.133.3180: .\n11681:13141(1460) ack 834 win 65535\n13:39:20.761778 IP 198.144.205.144.80 > 198.144.205.133.3180: .\n13141:14601(1460) ack 834 win 65535\n13:39:20.763225 IP 198.144.205.133.3180 > 198.144.205.144.80: . ack 8761 win 65535\n13:39:20.763468 IP 198.144.205.133.3180 > 198.144.205.144.80: . ack 11681 win 65535\n13:39:20.763526 IP 198.144.205.144.80 > 198.144.205.133.3180: .\n14601:16061(1460) ack 834 win 65535\n13:39:20.763544 IP 198.144.205.144.80 > 198.144.205.133.3180: .\n16061:17521(1460) ack 834 win 65535\n13:39:20.763712 IP 198.144.205.133.3180 > 198.144.205.144.80: . ack 14601 win 65535\n13:39:20.763735 IP 198.144.205.144.80 > 198.144.205.133.3180: .\n17521:18981(1460) ack 834 win 65535\n13:39:20.763748 IP 198.144.205.144.80 > 198.144.205.133.3180: .\n18981:20441(1460) ack 834 win 65535\n13:39:20.764661 IP 198.144.205.133.3180 > 198.144.205.144.80: . ack 17521 win 65535\n13:39:20.764691 IP 198.144.205.144.80 > 198.144.205.133.3180: .\n20441:21901(1460) ack 834 win 65535\n13:39:20.764703 IP 198.144.205.144.80 > 198.144.205.133.3180: .\n21901:23361(1460) ack 834 win 65535\n13:39:20.764904 IP 198.144.205.133.3180 > 198.144.205.144.80: . ack 20441 win 65535\n13:39:20.764924 IP 198.144.205.144.80 > 198.144.205.133.3180: .\n23361:24821(1460) ack 834 win 65535\n13:39:20.764937 IP 198.144.205.144.80 > 198.144.205.133.3180: .\n24821:26281(1460) ack 834 win 65535\n13:39:20.765177 IP 198.144.205.133.3180 > 198.144.205.144.80: . ack 23361 win 65535\n13:39:20.765197 IP 198.144.205.144.80 > 198.144.205.133.3180: P 26281:27164(883)\nack 834 win 65535\n13:39:20.765423 IP 198.144.205.133.3180 > 198.144.205.144.80: . ack 26281 win 65535\n13:39:20.941506 IP 198.144.205.133.3180 > 198.144.205.144.80: . ack 27164 win 64652\n13:39:25.763406 IP 198.144.205.144.80 > 198.144.205.133.3180: F 27164:27164(0)\nack 834 win 65535\n13:39:25.763601 IP 198.144.205.133.3180 > 198.144.205.144.80: . ack 27165 win 64652\n13:39:27.958133 IP 198.144.205.133.3180 > 198.144.205.144.80: F 834:834(0) ack\n27165 win 64652\n13:39:27.958237 IP 198.144.205.144.80 > 198.144.205.133.3180: . ack 835 win 65534\n\nHere are the headers the proxy responds with:\n\nHTTP/1.1 200 OK\nDate: Thu, 25 May 2006 20:39:20 GMT\nServer: Apache/1.3.33 (Unix) mod_perl/1.29 mod_ssl/2.8.22 OpenSSL/0.9.7d\nmod_jk/1.2.15\nETag: W/\"26797-1148506126000\"\nLast-Modified: Wed, 24 May 2006 21:28:46 GMT\nContent-Length: 26797\nContent-Type: image/jpeg\nExpires: Thu, 25 May 2006 22:58:23 GMT\nKeep-Alive: timeout=5, max=100\nConnection: Keep-Alive\n\nThat transaction worked okay.  Here's one that didn't work:\n\n13:41:01.094260 IP 198.144.205.133.3187 > 198.144.205.144.80: S\n1953506917:1953506917(0) win 65535 <mss 1460,nop,nop,sackOK>\n13:41:01.094354 IP 198.144.205.144.80 > 198.144.205.133.3187: S\n1632330321:1632330321(0) ack 1953506918 win 65535 <mss 1460,sackOK,eol>\n13:41:01.094490 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 1 win 65535\n13:41:01.094805 IP 198.144.205.133.3187 > 198.144.205.144.80: P 1:877(876) ack 1\nwin 65535\n13:41:01.102707 IP 198.144.205.144.80 > 198.144.205.133.3187: . 1:1461(1460) ack\n877 win 65535\n13:41:01.102733 IP 198.144.205.144.80 > 198.144.205.133.3187: . 1461:2921(1460)\nack 877 win 65535\n13:41:01.103237 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 2921 win 65535\n13:41:01.103328 IP 198.144.205.144.80 > 198.144.205.133.3187: . 2921:4381(1460)\nack 877 win 65535\n13:41:01.103340 IP 198.144.205.144.80 > 198.144.205.133.3187: . 4381:5841(1460)\nack 877 win 65535\n13:41:01.103354 IP 198.144.205.144.80 > 198.144.205.133.3187: . 5841:7301(1460)\nack 877 win 65535\n13:41:01.103824 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 5841 win 65535\n13:41:01.103847 IP 198.144.205.144.80 > 198.144.205.133.3187: . 7301:8761(1460)\nack 877 win 65535\n13:41:01.103858 IP 198.144.205.144.80 > 198.144.205.133.3187: . 8761:10221(1460)\nack 877 win 65535\n13:41:01.103870 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n10221:11681(1460) ack 877 win 65535\n13:41:01.104210 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 8761 win 65535\n13:41:01.104234 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n11681:13141(1460) ack 877 win 65535\n13:41:01.104246 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n13141:14601(1460) ack 877 win 65535\n13:41:01.104258 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n14601:16061(1460) ack 877 win 65535\n13:41:01.104457 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 11681 win 65535\n13:41:01.104481 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n16061:17521(1460) ack 877 win 65535\n13:41:01.104495 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n17521:18981(1460) ack 877 win 65535\n13:41:01.104507 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n18981:20441(1460) ack 877 win 65535\n13:41:01.104724 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 14601 win 65535\n13:41:01.104745 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n20441:21901(1460) ack 877 win 65535\n13:41:01.104758 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n21901:23361(1460) ack 877 win 65535\n13:41:01.104771 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n23361:24821(1460) ack 877 win 65535\n13:41:01.104966 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 17521 win 65535\n13:41:01.104985 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n24821:26281(1460) ack 877 win 65535\n13:41:01.105004 IP 198.144.205.144.80 > 198.144.205.133.3187: P 26281:27164(883)\nack 877 win 65535\n13:41:01.105213 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 20441 win 65535\n13:41:01.105461 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 23361 win 65535\n13:41:01.105706 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 26281 win 65535\n13:41:01.237467 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 27164 win 64652\n13:41:05.312399 IP 198.144.205.133.3187 > 198.144.205.144.80: P 877:1753(876)\nack 27164 win 64652\n13:41:05.316143 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n27164:28624(1460) ack 1753 win 65535\n13:41:05.316167 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n28624:30084(1460) ack 1753 win 65535\n13:41:05.316187 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n30084:31544(1460) ack 1753 win 65535\n13:41:05.316197 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n31544:33004(1460) ack 1753 win 65535\n13:41:05.316217 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n33004:34464(1460) ack 1753 win 65535\n13:41:05.316233 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n34464:35924(1460) ack 1753 win 65535\n13:41:05.316242 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n35924:37384(1460) ack 1753 win 65535\n13:41:05.316261 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n37384:38844(1460) ack 1753 win 65535\n13:41:05.316278 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n38844:40304(1460) ack 1753 win 65535\n13:41:05.316293 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n40304:41764(1460) ack 1753 win 65535\n13:41:05.316302 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n41764:43224(1460) ack 1753 win 65535\n13:41:05.316323 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n43224:44684(1460) ack 1753 win 65535\n13:41:05.316679 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 30084 win 65535\n13:41:05.316774 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n44684:46144(1460) ack 1753 win 65535\n13:41:05.316785 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n46144:47604(1460) ack 1753 win 65535\n13:41:05.316795 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n47604:49064(1460) ack 1753 win 65535\n13:41:05.316874 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 33004 win 65535\n13:41:05.316897 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n49064:50524(1460) ack 1753 win 65535\n13:41:05.316910 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n50524:51984(1460) ack 1753 win 65535\n13:41:05.316922 IP 198.144.205.144.80 > 198.144.205.133.3187: .\n51984:53444(1460) ack 1753 win 65535\n13:41:05.317132 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 35924 win 65535\n13:41:05.317153 IP 198.144.205.144.80 > 198.144.205.133.3187: P 53444:54325(881)\nack 1753 win 65535\n13:41:05.317382 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 38844 win 65535\n13:41:05.317626 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 41764 win 65535\n13:41:05.317868 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 44684 win 65535\n13:41:05.318118 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 47604 win 65535\n13:41:05.318363 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 50524 win 65535\n13:41:05.318610 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 53444 win 65535\n13:41:05.503052 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 54325 win 64654\n13:41:05.629138 IP 198.144.205.133.3187 > 198.144.205.144.80: P 1753:2489(736)\nack 54325 win 64654\n13:41:05.633724 IP 198.144.205.144.80 > 198.144.205.133.3187: P 54325:54883(558)\nack 2489 win 65535\n13:41:05.831178 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 54883 win 64096\n13:41:10.634808 IP 198.144.205.144.80 > 198.144.205.133.3187: F 54883:54883(0)\nack 2489 win 65535\n13:41:10.634969 IP 198.144.205.133.3187 > 198.144.205.144.80: . ack 54884 win 64096\n13:41:24.506079 IP 198.144.205.133.3187 > 198.144.205.144.80: F 2489:2489(0) ack\n54884 win 64096\n13:41:24.506191 IP 198.144.205.144.80 > 198.144.205.133.3187: . ack 2490 win 65534\n\nThis is actually two requests over a single tcp connection.  I assume firefox is\nrecycling a still connected keep alive session if the user hits ctrl+F5 fast enough.\n\nThe client / server headers:\n\nGET /res/img/content/liferaft.jpg HTTP/1.1\nHost: nuked.greatschools.net\nUser-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.3)\nGecko/20060426 Firefox/1.5.0.3\nAccept:\ntext/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5\nAccept-Language: en-us,en;q=0.5\nAccept-Encoding: gzip,deflate\nAccept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\nKeep-Alive: 300\nConnection: keep-alive\nCookie: T3CK=TANT%3D1%7CTANO%3D0; fcP=C=133&T=1137020088512&V=1137020102487;\ns_vi=[CS]v1|43F0FFA7000062EC-A160B0300000792[CE]; RMID=c690cd854329f1d0;\nRMFD=011Fiz3b;\nNXCLICK2=011FHWHwNX_mailing/gn/2006_02/ca/8951!y!01!4qcu!52qf!02!4qcv!52qhNX_mailing/gn/2006_02_21/ca/8427!y!01!4r4q!53Uk!02!4r4r!53UqNX_mailing/mss/2006_03/ca/8438.76346803398!y!02!4rJ8!53pF;\nTRNO=1127250133.198.144.205.133\nPragma: no-cache\nCache-Control: no-cache\n\nHTTP/1.1 200 OK\nDate: Thu, 25 May 2006 20:41:01 GMT\nServer: Apache/1.3.33 (Unix) mod_perl/1.29 mod_ssl/2.8.22 OpenSSL/0.9.7d\nmod_jk/1.2.15\nETag: W/\"26797-1148506126000\"\nContent-Length: 26797\nExpires: Fri, 26 May 2006 00:41:01 GMT\nContent-Type: image/jpeg\nLast-Modified: Wed, 24 May 2006 21:28:46 GMT\nKeep-Alive: timeout=5, max=100\nConnection: Keep-Alive\n\nGET /res/img/content/liferaft.jpg HTTP/1.1\nHost: nuked.greatschools.net\nUser-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.3)\nGecko/20060426 Firefox/1.5.0.3\nAccept:\ntext/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5\nAccept-Language: en-us,en;q=0.5\nAccept-Encoding: gzip,deflate\nAccept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\nKeep-Alive: 300\nConnection: keep-alive\nCookie: T3CK=TANT%3D1%7CTANO%3D0; fcP=C=133&T=1137020088512&V=1137020102487;\ns_vi=[CS]v1|43F0FFA7000062EC-A160B0300000792[CE]; RMID=c690cd854329f1d0;\nRMFD=011Fiz3b;\nNXCLICK2=011FHWHwNX_mailing/gn/2006_02/ca/8951!y!01!4qcu!52qf!02!4qcv!52qhNX_mailing/gn/2006_02_21/ca/8427!y!01!4r4q!53Uk!02!4r4r!53UqNX_mailing/mss/2006_03/ca/8438.76346803398!y!02!4rJ8!53pF;\nTRNO=1127250133.198.144.205.133\nPragma: no-cache\nCache-Control: no-cache\n\nHTTP/1.1 200 OK\nDate: Thu, 25 May 2006 20:41:05 GMT\nServer: Apache/1.3.33 (Unix) mod_perl/1.29 mod_ssl/2.8.22 OpenSSL/0.9.7d\nmod_jk/1.2.15\nETag: W/\"26797-1148506126000\"\nContent-Length: 26797\nExpires: Fri, 26 May 2006 00:41:05 GMT\nContent-Type: text/html\nLast-Modified: Wed, 24 May 2006 21:28:46 GMT\nKeep-Alive: timeout=5, max=99\nConnection: Keep-Alive\n\n\nThe first request worked, but the second one was returned as text/html.\n\nMeanwhile, the proxy server is making requests to the backend to handle the\nclient's request.\n\n13:40:46.519646 IP 198.144.205.144.64919 > 198.144.205.152.80: S\n755704577:755704577(0) win 65535 <mss 1460,nop,wscale 1,nop,nop,timestamp\n4082210496 0,sackOK,eol>\n13:40:46.519763 IP 198.144.205.152.80 > 198.144.205.144.64919: S\n2886095240:2886095240(0) ack 755704578 win 57344 <mss 1460,nop,wscale\n0,nop,nop,timestamp 1733772078 4082210496>\n13:40:46.519805 IP 198.144.205.144.64919 > 198.144.205.152.80: . ack 1 win 33304\n<nop,nop,timestamp 4082210496 1733772078>\n13:40:46.520087 IP 198.144.205.144.64919 > 198.144.205.152.80: P 1:1089(1088)\nack 1 win 33304 <nop,nop,timestamp 4082210496 1733772078>\n13:40:46.524652 IP 198.144.205.152.80 > 198.144.205.144.64919: P 1:257(256) ack\n1089 win 57920 <nop,nop,timestamp 1733772079 4082210496>\n13:40:46.624500 IP 198.144.205.144.64919 > 198.144.205.152.80: . ack 257 win\n33304 <nop,nop,timestamp 4082210601 1733772079>\n13:41:01.097038 IP 198.144.205.144.63148 > 198.144.205.152.80: F 999:999(0) ack\n27127 win 33304 <nop,nop,timestamp 4082225073 1733765874>\n13:41:01.097158 IP 198.144.205.152.80 > 198.144.205.144.63148: . ack 1000 win\n57920 <nop,nop,timestamp 1733773536 4082225073>\n13:41:01.097278 IP 198.144.205.144.55877 > 198.144.205.152.80: S\n3660931143:3660931143(0) win 65535 <mss 1460,nop,wscale 1,nop,nop,timestamp\n4082225074 0,sackOK,eol>\n13:41:01.097392 IP 198.144.205.152.80 > 198.144.205.144.55877: S\n1545466721:1545466721(0) ack 3660931144 win 57344 <mss 1460,nop,wscale\n0,nop,nop,timestamp 1733773536 4082225074>\n13:41:01.097431 IP 198.144.205.144.55877 > 198.144.205.152.80: . ack 1 win 33304\n<nop,nop,timestamp 4082225074 1733773536>\n13:41:01.097709 IP 198.144.205.144.55877 > 198.144.205.152.80: P 1:1089(1088)\nack 1 win 33304 <nop,nop,timestamp 4082225074 1733773536>\n13:41:01.102080 IP 198.144.205.152.80 > 198.144.205.144.55877: P 1:257(256) ack\n1089 win 57920 <nop,nop,timestamp 1733773536 4082225074>\n13:41:01.202018 IP 198.144.205.144.55877 > 198.144.205.152.80: . ack 257 win\n33304 <nop,nop,timestamp 4082225179 1733773536>\n13:41:03.254784 IP 198.144.205.152.80 > 198.144.205.144.64919: F 257:257(0) ack\n1089 win 57920 <nop,nop,timestamp 1733773752 4082210601>\n13:41:03.254877 IP 198.144.205.144.64919 > 198.144.205.152.80: . ack 258 win\n33304 <nop,nop,timestamp 4082227231 1733773752>\n13:41:05.313389 IP 198.144.205.144.55877 > 198.144.205.152.80: P 1089:2177(1088)\nack 257 win 33304 <nop,nop,timestamp 4082229290 1733773536>\n13:41:05.315555 IP 198.144.205.152.80 > 198.144.205.144.55877: P 257:512(255)\nack 2177 win 57920 <nop,nop,timestamp 1733773958 4082229290>\n13:41:05.414874 IP 198.144.205.144.55877 > 198.144.205.152.80: . ack 512 win\n33304 <nop,nop,timestamp 4082229392 1733773958>\n13:41:05.629992 IP 198.144.205.144.55877 > 198.144.205.152.80: P 2177:3035(858)\nack 512 win 33304 <nop,nop,timestamp 4082229607 1733773958>\n13:41:05.631281 IP 198.144.205.152.80 > 198.144.205.144.55877: P 512:1753(1241)\nack 3035 win 57920 <nop,nop,timestamp 1733773989 4082229607>\n13:41:05.730896 IP 198.144.205.144.55877 > 198.144.205.152.80: . ack 1753 win\n33304 <nop,nop,timestamp 4082229708 1733773989>\n13:41:22.446789 IP 198.144.205.152.80 > 198.144.205.144.55877: F 1753:1753(0)\nack 3035 win 57920 <nop,nop,timestamp 1733775671 4082229708>\n13:41:22.446885 IP 198.144.205.144.55877 > 198.144.205.152.80: . ack 1754 win\n33304 <nop,nop,timestamp 4082246424 1733775671>\n\nHere are the headers from the proxy -> backend conversation.\n\nGET /res/img/content/liferaft.jpg HTTP/1.1\nHost: nuked.greatschools.net\nUser-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.3)\nGecko/20060426 Firefox/1.5.0.3\nAccept:\ntext/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5\nAccept-Language: en-us,en;q=0.5\nAccept-Encoding: gzip,deflate\nAccept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\nCookie: T3CK=TANT%3D1%7CTANO%3D0; fcP=C=133&T=1137020088512&V=1137020102487;\ns_vi=[CS]v1|43F0FFA7000062EC-A160B0300000792[CE]; RMID=c690cd854329f1d0;\nRMFD=011Fiz3b;\nNXCLICK2=011FHWHwNX_mailing/gn/2006_02/ca/8951!y!01!4qcu!52qf!02!4qcv!52qhNX_mailing/gn/2006_02_21/ca/8427!y!01!4r4q!53Uk!02!4r4r!53UqNX_mailing/mss/2006_03/ca/8438.76346803398!y!02!4rJ8!53pF;\nTRNO=1127250133.198.144.205.133\nPragma: no-cache\nCache-Control: no-cache\nIf-None-Match: W/\"26797-1148506126000\"\nIf-Modified-Since: Wed, 24 May 2006 21:28:46 GMT\nMax-Forwards: 10\nX-Forwarded-For: 198.144.205.133\nX-Forwarded-Host: nuked.greatschools.net\nX-Forwarded-Server: nuked.greatschools.net.\nConnection: Keep-Alive\n\nHTTP/1.1 304 Not Modified\nDate: Thu, 25 May 2006 20:41:01 GMT\nServer: Apache/1.3.33 (Unix) mod_perl/1.29 mod_ssl/2.8.22 OpenSSL/0.9.7d\nmod_jk/1.2.15\nContent-Length: 0\nKeep-Alive: timeout=15, max=1000\nConnection: Keep-Alive\nContent-Type: text/html\n\nIt looks like the backend is responding with http status code 304.  I'm\nwondering if the text/html content-type from the 304 code is being erroniously\ncached in this case?\n\nI have the tcpdump capture file here.  If I can provide any more information or\nperhaps put the capture file somewhere for download please don't hesitate to ask.\n", "id": 89502, "time": "2006-05-25T22:26:03Z", "creator": "cshumway@titan-project.org", "creation_time": "2006-05-25T22:26:03Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 39647, "attachment_id": null, "text": "I just ran some tcpdump sniffing while pulling an image served directly by httpd\non the backend, not going through mod_jk.  It does not set the conent-type\nheader when it returns a 304 http status code.  Here are the headers from the\nproxy -> backend conversation:\n\nGET /images/reportcard.jpg HTTP/1.1\nHost: nuked.greatschools.net\nUser-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.3)\nGecko/20060426 Firefox/1.5.0.3\nAccept:\ntext/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5\nAccept-Language: en-us,en;q=0.5\nAccept-Encoding: gzip,deflate\nAccept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\nCookie: TRNO=1127250133.198.144.205.133;\nNXCLICK2=011FHWHwNX_mailing/gn/2006_02/ca/8951!y!01!4qcu!52qf!02!4qcv!52qhNX_mailing/gn/2006_02_21/ca/8427!y!01!4r4q!53Uk!02!4r4r!53UqNX_mailing/mss/2006_03/ca/8438.76346803398!y!02!4rJ8!53pF;\nRMFD=011Fiz3b; NumAd=-1; RMID=c690cd854329f1d0;\ns_vi=[CS]v1|43F0FFA7000062EC-A160B0300000792[CE]; T3CK=TANT%3D1%7CTANO%3D0;\nfcP=C=133&T=1137020088512&V=1137020102487\nPragma: no-cache\nCache-Control: no-cache\nIf-None-Match: \"1fae43-4487-3f4e92c4\"\nIf-Modified-Since: Thu, 28 Aug 2003 23:39:48 GMT\nMax-Forwards: 10\nX-Forwarded-For: 198.144.205.133\nX-Forwarded-Host: nuked.greatschools.net\nX-Forwarded-Server: nuked.greatschools.net.\nConnection: Keep-Alive\n\n\nHTTP/1.1 304 Not Modified\nDate: Thu, 25 May 2006 23:56:23 GMT\nServer: Apache/1.3.33 (Unix) mod_perl/1.29 mod_ssl/2.8.22 OpenSSL/0.9.7d\nmod_jk/1.2.15\nConnection: Keep-Alive, Keep-Alive\nKeep-Alive: timeout=15, max=998\nETag: \"1fae43-4487-3f4e92c4\"\nExpires: Fri, 26 May 2006 05:56:23 GMT\nCache-Control: max-age=21600\n\n", "id": 89508, "time": "2006-05-26T00:07:30Z", "creator": "cshumway@titan-project.org", "creation_time": "2006-05-26T00:07:30Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 39647, "attachment_id": 18353, "text": "Created attachment 18353\nPatch for additional Debug messages against 2.2.x\n\nThanks for the update. I think we are getting closer. Can you please apply the\nattached patch, run a non working request and post the according error log?\nThe patch is only temporary and does not fix anything, but it should help me to\nunderstand the problem better.", "id": 89513, "time": "2006-05-26T08:54:12Z", "creator": "rpluem@apache.org", "creation_time": "2006-05-26T08:54:12Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 39647, "attachment_id": null, "id": 89525, "creation_time": "2006-05-26T18:18:25Z", "time": "2006-05-26T18:18:25Z", "creator": "cshumway@titan-project.org", "text": "Here you go.  I applied the patch, and also the patch found in bug 39266.  Here\nis a snipit from the debug log.\n\n[Fri May 26 11:15:05 2006] [debug] cache_storage.c(261): Cached response for\n/res/img/content/liferaft.jpg isn't fresh.  Adding/replacing conditional request\nheaders.\n[Fri May 26 11:15:05 2006] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /res/img/content/liferaft.jpg\n[Fri May 26 11:15:05 2006] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /res/img/content/liferaft.jpg\n[Fri May 26 11:15:05 2006] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //dev.greatschools.net/res/img/content/liferaft.jpg\n[Fri May 26 11:15:05 2006] [debug] proxy_util.c(1378): [client 64.85.232.3]\nproxy: http: found worker http://dev.greatschools.net/ for\nhttp://dev.greatschools.net/res/img/content/liferaft.jpg\n[Fri May 26 11:15:05 2006] [debug] mod_proxy.c(756): Running scheme http handler\n(attempt 0)\n[Fri May 26 11:15:05 2006] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://dev.greatschools.net/res/img/content/liferaft.jpg\n[Fri May 26 11:15:05 2006] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (dev.greatschools.net)\n[Fri May 26 11:15:05 2006] [debug] proxy_util.c(1858): proxy: connecting\nhttp://dev.greatschools.net/res/img/content/liferaft.jpg to dev.greatschools.net:80\n[Fri May 26 11:15:05 2006] [debug] proxy_util.c(1951): proxy: connected\n/res/img/content/liferaft.jpg to dev.greatschools.net:80\n[Fri May 26 11:15:05 2006] [debug] proxy_util.c(2045): proxy: HTTP: fam 2 socket\ncreated to connect to dev.greatschools.net\n[Fri May 26 11:15:05 2006] [debug] proxy_util.c(2141): proxy: HTTP: connection\ncomplete to 198.144.205.152:80 (dev.greatschools.net)\n[Fri May 26 11:15:05 2006] [debug] mod_proxy_http.c(1541): proxy: header only\n[Fri May 26 11:15:05 2006] [debug] mod_headers.c(612): headers:\nap_headers_output_filter()\n[Fri May 26 11:15:05 2006] [debug] mod_cache.c(602): cache: Caching url:\n/res/img/content/liferaft.jpg\n[Fri May 26 11:15:05 2006] [debug] mod_cache.c(608): cache: Removing\nCACHE_REMOVE_URL filter.\n[Fri May 26 11:15:05 2006] [debug] mod_cache.c(726): cache: Content-Type\ntext/html text/html\n[Fri May 26 11:15:05 2006] [debug] mod_cache.c(738): cache: Content-Type\ntext/html image/jpeg\n[Fri May 26 11:15:05 2006] [debug] http_filters.c(990): http_filter:\nContent-Type text/html image/jpeg\n[Fri May 26 11:15:05 2006] [debug] http_filters.c(995): http_filter:\nContent-Type image/jpeg image/jpeg\n[Fri May 26 11:15:05 2006] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (dev.greatschools.net)\n[Fri May 26 11:15:06 2006] [debug] cache_storage.c(261): Cached response for\n/res/img/content/liferaft.jpg isn't fresh.  Adding/replacing conditional request\nheaders.\n[Fri May 26 11:15:06 2006] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /res/img/content/liferaft.jpg\n[Fri May 26 11:15:06 2006] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /res/img/content/liferaft.jpg\n[Fri May 26 11:15:06 2006] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //dev.greatschools.net/res/img/content/liferaft.jpg\n[Fri May 26 11:15:06 2006] [debug] proxy_util.c(1378): [client 64.85.232.3]\nproxy: http: found worker http://dev.greatschools.net/ for\nhttp://dev.greatschools.net/res/img/content/liferaft.jpg\n[Fri May 26 11:15:06 2006] [debug] mod_proxy.c(756): Running scheme http handler\n(attempt 0)\n[Fri May 26 11:15:06 2006] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://dev.greatschools.net/res/img/content/liferaft.jpg\n[Fri May 26 11:15:06 2006] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (dev.greatschools.net)\n[Fri May 26 11:15:06 2006] [debug] proxy_util.c(1858): proxy: connecting\nhttp://dev.greatschools.net/res/img/content/liferaft.jpg to dev.greatschools.net:80\n[Fri May 26 11:15:06 2006] [debug] proxy_util.c(1951): proxy: connected\n/res/img/content/liferaft.jpg to dev.greatschools.net:80\n[Fri May 26 11:15:06 2006] [debug] proxy_util.c(2141): proxy: HTTP: connection\ncomplete to 198.144.205.152:80 (dev.greatschools.net)\n[Fri May 26 11:15:06 2006] [debug] mod_proxy_http.c(1541): proxy: header only\n[Fri May 26 11:15:06 2006] [debug] mod_headers.c(612): headers:\nap_headers_output_filter()\n[Fri May 26 11:15:06 2006] [debug] mod_cache.c(602): cache: Caching url:\n/res/img/content/liferaft.jpg\n[Fri May 26 11:15:06 2006] [debug] mod_cache.c(608): cache: Removing\nCACHE_REMOVE_URL filter.\n[Fri May 26 11:15:06 2006] [debug] mod_cache.c(726): cache: Content-Type\ntext/html text/html\n[Fri May 26 11:15:06 2006] [debug] mod_cache.c(738): cache: Content-Type\ntext/html text/html\n[Fri May 26 11:15:06 2006] [debug] http_filters.c(990): http_filter:\nContent-Type text/html text/html\n[Fri May 26 11:15:06 2006] [debug] http_filters.c(995): http_filter:\nContent-Type text/html text/html\n[Fri May 26 11:15:06 2006] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (dev.greatschools.net)\n\nThis is two requests over the same tcp keepalive connection from firefox.  The\nfirst request seemed to work, the second one firefix tried to render the jpeg as\nif it was html.\n", "is_private": false}, {"count": 10, "tags": [], "bug_id": 39647, "text": "Just for comparison's sake, here is some debug log output while force-refreshing\nan image being served directly by the backend httpd server, not through mod_jk.\n\n[Fri May 26 11:20:28 2006] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /images/reportcard.jpg\n[Fri May 26 11:20:28 2006] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /images/reportcard.jpg\n[Fri May 26 11:20:28 2006] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:28 2006] [debug] proxy_util.c(1378): [client 64.85.232.3]\nproxy: http: found worker http://dev.greatschools.net/ for\nhttp://dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:28 2006] [debug] mod_proxy.c(756): Running scheme http handler\n(attempt 0)\n[Fri May 26 11:20:28 2006] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:28 2006] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (dev.greatschools.net)\n[Fri May 26 11:20:28 2006] [debug] proxy_util.c(1858): proxy: connecting\nhttp://dev.greatschools.net/images/reportcard.jpg to dev.greatschools.net:80\n[Fri May 26 11:20:28 2006] [debug] proxy_util.c(1951): proxy: connected\n/images/reportcard.jpg to dev.greatschools.net:80\n[Fri May 26 11:20:28 2006] [debug] proxy_util.c(2045): proxy: HTTP: fam 2 socket\ncreated to connect to dev.greatschools.net\n[Fri May 26 11:20:28 2006] [debug] proxy_util.c(2141): proxy: HTTP: connection\ncomplete to 198.144.205.152:80 (dev.greatschools.net)\n[Fri May 26 11:20:29 2006] [debug] mod_proxy_http.c(1448): proxy: start body send\n[Fri May 26 11:20:29 2006] [debug] mod_headers.c(612): headers:\nap_headers_output_filter()\n[Fri May 26 11:20:29 2006] [debug] mod_cache.c(602): cache: Caching url:\n/images/reportcard.jpg\n[Fri May 26 11:20:29 2006] [debug] mod_cache.c(608): cache: Removing\nCACHE_REMOVE_URL filter.\n[Fri May 26 11:20:29 2006] [debug] http_filters.c(990): http_filter:\nContent-Type image/jpeg image/jpeg\n[Fri May 26 11:20:29 2006] [debug] http_filters.c(995): http_filter:\nContent-Type image/jpeg image/jpeg\n[Fri May 26 11:20:29 2006] [info] mem_cache: Cached url:\nhttp://nuked.greatschools.net:80/images/reportcard.jpg?\n[Fri May 26 11:20:29 2006] [debug] mod_proxy_http.c(1537): proxy: end body send\n[Fri May 26 11:20:29 2006] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (dev.greatschools.net)\n[Fri May 26 11:20:38 2006] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /images/reportcard.jpg\n[Fri May 26 11:20:38 2006] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /images/reportcard.jpg\n[Fri May 26 11:20:38 2006] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:38 2006] [debug] proxy_util.c(1378): [client 64.85.232.3]\nproxy: http: found worker http://dev.greatschools.net/ for\nhttp://dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:38 2006] [debug] mod_proxy.c(756): Running scheme http handler\n(attempt 0)\n[Fri May 26 11:20:38 2006] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:38 2006] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (dev.greatschools.net)\n[Fri May 26 11:20:38 2006] [debug] proxy_util.c(1858): proxy: connecting\nhttp://dev.greatschools.net/images/reportcard.jpg to dev.greatschools.net:80\n[Fri May 26 11:20:38 2006] [debug] proxy_util.c(1951): proxy: connected\n/images/reportcard.jpg to dev.greatschools.net:80\n[Fri May 26 11:20:38 2006] [debug] proxy_util.c(2045): proxy: HTTP: fam 2 socket\ncreated to connect to dev.greatschools.net\n[Fri May 26 11:20:38 2006] [debug] proxy_util.c(2141): proxy: HTTP: connection\ncomplete to 198.144.205.152:80 (dev.greatschools.net)\n[Fri May 26 11:20:38 2006] [debug] mod_proxy_http.c(1448): proxy: start body send\n[Fri May 26 11:20:38 2006] [debug] mod_headers.c(612): headers:\nap_headers_output_filter()\n[Fri May 26 11:20:38 2006] [debug] mod_cache.c(602): cache: Caching url:\n/images/reportcard.jpg\n[Fri May 26 11:20:38 2006] [debug] mod_cache.c(608): cache: Removing\nCACHE_REMOVE_URL filter.\n[Fri May 26 11:20:38 2006] [debug] http_filters.c(990): http_filter:\nContent-Type image/jpeg image/jpeg\n[Fri May 26 11:20:38 2006] [debug] http_filters.c(995): http_filter:\nContent-Type image/jpeg image/jpeg\n[Fri May 26 11:20:38 2006] [info] mem_cache: Cached url:\nhttp://nuked.greatschools.net:80/images/reportcard.jpg?\n[Fri May 26 11:20:38 2006] [debug] mod_proxy_http.c(1537): proxy: end body send\n[Fri May 26 11:20:38 2006] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (dev.greatschools.net)\n[Fri May 26 11:20:39 2006] [debug] cache_storage.c(261): Cached response for\n/images/reportcard.jpg isn't fresh.  Adding/replacing conditional request headers.\n[Fri May 26 11:20:39 2006] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /images/reportcard.jpg\n[Fri May 26 11:20:39 2006] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /images/reportcard.jpg\n[Fri May 26 11:20:39 2006] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:39 2006] [debug] proxy_util.c(1378): [client 64.85.232.3]\nproxy: http: found worker http://dev.greatschools.net/ for\nhttp://dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:39 2006] [debug] mod_proxy.c(756): Running scheme http handler\n(attempt 0)\n[Fri May 26 11:20:39 2006] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:39 2006] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (dev.greatschools.net)\n[Fri May 26 11:20:39 2006] [debug] proxy_util.c(1858): proxy: connecting\nhttp://dev.greatschools.net/images/reportcard.jpg to dev.greatschools.net:80\n[Fri May 26 11:20:39 2006] [debug] proxy_util.c(1951): proxy: connected\n/images/reportcard.jpg to dev.greatschools.net:80\n[Fri May 26 11:20:39 2006] [debug] proxy_util.c(2141): proxy: HTTP: connection\ncomplete to 198.144.205.152:80 (dev.greatschools.net)\n[Fri May 26 11:20:39 2006] [debug] mod_proxy_http.c(1541): proxy: header only\n[Fri May 26 11:20:39 2006] [debug] mod_headers.c(612): headers:\nap_headers_output_filter()\n[Fri May 26 11:20:39 2006] [debug] mod_cache.c(602): cache: Caching url:\n/images/reportcard.jpg\n[Fri May 26 11:20:39 2006] [debug] mod_cache.c(608): cache: Removing\nCACHE_REMOVE_URL filter.\n[Fri May 26 11:20:39 2006] [debug] mod_cache.c(726): cache: Content-Type (null)\nimage/jpeg\n[Fri May 26 11:20:39 2006] [debug] mod_cache.c(738): cache: Content-Type (null)\nimage/jpeg\n[Fri May 26 11:20:39 2006] [debug] http_filters.c(990): http_filter:\nContent-Type (null) image/jpeg\n[Fri May 26 11:20:39 2006] [debug] http_filters.c(995): http_filter:\nContent-Type image/jpeg image/jpeg\n[Fri May 26 11:20:39 2006] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (dev.greatschools.net)\n[Fri May 26 11:20:40 2006] [debug] cache_storage.c(261): Cached response for\n/images/reportcard.jpg isn't fresh.  Adding/replacing conditional request headers.\n[Fri May 26 11:20:40 2006] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /images/reportcard.jpg\n[Fri May 26 11:20:40 2006] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /images/reportcard.jpg\n[Fri May 26 11:20:40 2006] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:40 2006] [debug] proxy_util.c(1378): [client 64.85.232.3]\nproxy: http: found worker http://dev.greatschools.net/ for\nhttp://dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:40 2006] [debug] mod_proxy.c(756): Running scheme http handler\n(attempt 0)\n[Fri May 26 11:20:40 2006] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:40 2006] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (dev.greatschools.net)\n[Fri May 26 11:20:40 2006] [debug] proxy_util.c(1858): proxy: connecting\nhttp://dev.greatschools.net/images/reportcard.jpg to dev.greatschools.net:80\n[Fri May 26 11:20:40 2006] [debug] proxy_util.c(1951): proxy: connected\n/images/reportcard.jpg to dev.greatschools.net:80\n[Fri May 26 11:20:40 2006] [debug] proxy_util.c(2141): proxy: HTTP: connection\ncomplete to 198.144.205.152:80 (dev.greatschools.net)\n[Fri May 26 11:20:40 2006] [debug] mod_proxy_http.c(1541): proxy: header only\n[Fri May 26 11:20:40 2006] [debug] mod_headers.c(612): headers:\nap_headers_output_filter()\n[Fri May 26 11:20:40 2006] [debug] mod_cache.c(602): cache: Caching url:\n/images/reportcard.jpg\n[Fri May 26 11:20:40 2006] [debug] mod_cache.c(608): cache: Removing\nCACHE_REMOVE_URL filter.\n[Fri May 26 11:20:40 2006] [debug] mod_cache.c(726): cache: Content-Type (null)\nimage/jpeg\n[Fri May 26 11:20:40 2006] [debug] mod_cache.c(738): cache: Content-Type (null)\nimage/jpeg\n[Fri May 26 11:20:40 2006] [debug] http_filters.c(990): http_filter:\nContent-Type (null) image/jpeg\n[Fri May 26 11:20:40 2006] [debug] http_filters.c(995): http_filter:\nContent-Type image/jpeg image/jpeg\n[Fri May 26 11:20:40 2006] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (dev.greatschools.net)\n[Fri May 26 11:20:41 2006] [debug] cache_storage.c(261): Cached response for\n/images/reportcard.jpg isn't fresh.  Adding/replacing conditional request headers.\n[Fri May 26 11:20:41 2006] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /images/reportcard.jpg\n[Fri May 26 11:20:41 2006] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /images/reportcard.jpg\n[Fri May 26 11:20:41 2006] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:41 2006] [debug] proxy_util.c(1378): [client 64.85.232.3]\nproxy: http: found worker http://dev.greatschools.net/ for\nhttp://dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:41 2006] [debug] mod_proxy.c(756): Running scheme http handler\n(attempt 0)\n[Fri May 26 11:20:41 2006] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:41 2006] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (dev.greatschools.net)\n[Fri May 26 11:20:41 2006] [debug] proxy_util.c(1858): proxy: connecting\nhttp://dev.greatschools.net/images/reportcard.jpg to dev.greatschools.net:80\n[Fri May 26 11:20:41 2006] [debug] proxy_util.c(1951): proxy: connected\n/images/reportcard.jpg to dev.greatschools.net:80\n[Fri May 26 11:20:41 2006] [debug] proxy_util.c(2141): proxy: HTTP: connection\ncomplete to 198.144.205.152:80 (dev.greatschools.net)\n[Fri May 26 11:20:41 2006] [debug] mod_proxy_http.c(1541): proxy: header only\n[Fri May 26 11:20:41 2006] [debug] mod_headers.c(612): headers:\nap_headers_output_filter()\n[Fri May 26 11:20:41 2006] [debug] mod_cache.c(602): cache: Caching url:\n/images/reportcard.jpg\n[Fri May 26 11:20:41 2006] [debug] mod_cache.c(608): cache: Removing\nCACHE_REMOVE_URL filter.\n[Fri May 26 11:20:41 2006] [debug] mod_cache.c(726): cache: Content-Type (null)\nimage/jpeg\n[Fri May 26 11:20:41 2006] [debug] mod_cache.c(738): cache: Content-Type (null)\nimage/jpeg\n[Fri May 26 11:20:41 2006] [debug] http_filters.c(990): http_filter:\nContent-Type (null) image/jpeg\n[Fri May 26 11:20:41 2006] [debug] http_filters.c(995): http_filter:\nContent-Type image/jpeg image/jpeg\n[Fri May 26 11:20:41 2006] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (dev.greatschools.net)\n[Fri May 26 11:20:41 2006] [debug] cache_storage.c(261): Cached response for\n/images/reportcard.jpg isn't fresh.  Adding/replacing conditional request headers.\n[Fri May 26 11:20:41 2006] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /images/reportcard.jpg\n[Fri May 26 11:20:41 2006] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /images/reportcard.jpg\n[Fri May 26 11:20:41 2006] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:41 2006] [debug] proxy_util.c(1378): [client 64.85.232.3]\nproxy: http: found worker http://dev.greatschools.net/ for\nhttp://dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:41 2006] [debug] mod_proxy.c(756): Running scheme http handler\n(attempt 0)\n[Fri May 26 11:20:41 2006] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://dev.greatschools.net/images/reportcard.jpg\n[Fri May 26 11:20:41 2006] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (dev.greatschools.net)\n[Fri May 26 11:20:41 2006] [debug] proxy_util.c(1858): proxy: connecting\nhttp://dev.greatschools.net/images/reportcard.jpg to dev.greatschools.net:80\n[Fri May 26 11:20:41 2006] [debug] proxy_util.c(1951): proxy: connected\n/images/reportcard.jpg to dev.greatschools.net:80\n[Fri May 26 11:20:41 2006] [debug] proxy_util.c(2141): proxy: HTTP: connection\ncomplete to 198.144.205.152:80 (dev.greatschools.net)\n[Fri May 26 11:20:41 2006] [debug] mod_proxy_http.c(1541): proxy: header only\n[Fri May 26 11:20:41 2006] [debug] mod_headers.c(612): headers:\nap_headers_output_filter()\n[Fri May 26 11:20:41 2006] [debug] mod_cache.c(602): cache: Caching url:\n/images/reportcard.jpg\n[Fri May 26 11:20:41 2006] [debug] mod_cache.c(608): cache: Removing\nCACHE_REMOVE_URL filter.\n[Fri May 26 11:20:41 2006] [debug] mod_cache.c(726): cache: Content-Type (null)\nimage/jpeg\n[Fri May 26 11:20:41 2006] [debug] mod_cache.c(738): cache: Content-Type (null)\nimage/jpeg\n[Fri May 26 11:20:41 2006] [debug] http_filters.c(990): http_filter:\nContent-Type (null) image/jpeg\n[Fri May 26 11:20:41 2006] [debug] http_filters.c(995): http_filter:\nContent-Type image/jpeg image/jpeg\n[Fri May 26 11:20:41 2006] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (dev.greatschools.net)\n", "id": 89526, "time": "2006-05-26T18:23:16Z", "creator": "cshumway@titan-project.org", "creation_time": "2006-05-26T18:23:16Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "creator": "rpluem@apache.org", "attachment_id": 18357, "id": 89534, "time": "2006-05-26T22:49:37Z", "bug_id": 39647, "creation_time": "2006-05-26T22:49:37Z", "is_private": false, "text": "Created attachment 18357\nPatch against trunk\n\nI think I got it know. The attached patch should fix your problem. So could you\nplease do the following:\n\n1. Start with clean sources (at least without the debug patch I sent earlier)\n2. Apply the patch for 39266\n3. Apply the attached patch\n4. Compile\n5. Test\n6. Let me know the results :-)."}, {"count": 12, "tags": [], "bug_id": 39647, "attachment_id": 18358, "text": "Created attachment 18358\nPatch against mod_jk.c (1.3 Version) of mod_jk 1.2.15\n\nApart from the patch against 2.2.x I am pretty much sure that the behaviour of\nthe backend (sending Content-Length and Content-Type for a 304 response) is not\ncompliant with RFC 2616. \n\n10.3.5 in RFC 2616 states:\n\nThe 304 response MUST NOT contain a message-body, and thus is always terminated\nby the first empty line after the header fields.\n\nI read this as Content-Length and Content-Type header MUST NOT be sent with 304\nresponses and the behaviour of httpd 2.2.x and the http connector of Tomcat not\ndoing this seem to support this view.\nFrom my limited point of view on httpd 1.3 this should be fixed inside mod_jk.\nI  think that the attached patch, which is untested due to my lack of an\navailable httpd 1.3, does this without breaking other things.\nSo, if you like you can give the attached patch a try to make your backend RFC\n2616 compliant again :-).", "id": 89535, "time": "2006-05-26T22:59:32Z", "creator": "rpluem@apache.org", "creation_time": "2006-05-26T22:59:32Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 39647, "attachment_id": null, "id": 89590, "creation_time": "2006-05-30T18:12:37Z", "time": "2006-05-30T18:12:37Z", "creator": "cshumway@titan-project.org", "text": "Hi there.  Thanks for your help on this issue.  The patch\nmodules/cache/cache_storage.c seems to do the trick!\n\nI'll try out the patch to mod_jk too.  I agree, it seems like mod_jk is breaking\nRFC 2616, I'll try out the patch on the backend web server and make sure it\ndoesn't break anything else.\n\n", "is_private": false}, {"count": 14, "tags": [], "bug_id": 39647, "attachment_id": null, "id": 89600, "time": "2006-05-30T20:49:13Z", "creator": "rpluem@apache.org", "creation_time": "2006-05-30T20:49:13Z", "is_private": false, "text": "Committed to trunk as r410370 (http://svn.apache.org/viewvc?rev=410370&view=rev)."}, {"count": 15, "tags": [], "bug_id": 39647, "attachment_id": null, "text": "FYI I've been running the patch against mod_jk.c for about two weeks now with no\nill effects.\n", "id": 90175, "time": "2006-06-14T00:58:58Z", "creator": "cshumway@titan-project.org", "creation_time": "2006-06-14T00:58:58Z", "is_private": false}, {"count": 16, "tags": [], "creator": "rpluem@apache.org", "text": "Backported to 2.2.x as r425725 (http://svn.apache.org/viewvc?rev=425725&view=rev).", "id": 91608, "time": "2006-07-26T13:13:11Z", "bug_id": 39647, "creation_time": "2006-07-26T13:13:11Z", "is_private": false, "attachment_id": null}, {"count": 17, "attachment_id": null, "bug_id": 39647, "text": "The resolution to this bug breaks a MUST-level requirement of RFC2616. From <http://www.w3.org/\nProtocols/rfc2616/rfc2616-sec13.html#sec13.5.3>;\n\n[[[\nThe end-to-end headers stored in the cache entry are used for the constructed response, except that\n[...]\n      - any end-to-end headers provided in the 304 or 206 response MUST\n        replace the corresponding headers from the cache entry.\nUnless the cache decides to remove the cache entry, it MUST also replace the end-to-end headers \nstored with the cache entry with corresponding headers received in the incoming response, except for \nWarning headers as described immediately above. If a header field- name in the incoming response \nmatches more than one header in the cache entry, all such old headers MUST be replaced.\n\nIn other words, the set of end-to-end headers received in the incoming response overrides all \ncorresponding end-to-end headers stored with the cache entry (except for stored Warning headers with \nwarn-code 1xx, which are deleted even if not overridden).\n]]]\n\nThe correct resolution was to fix mod_jk, which the reporter said worked for them.\n\nPlease back this patch out.", "id": 99205, "time": "2007-02-09T15:17:37Z", "creator": "mnot@mnot.net", "creation_time": "2007-02-09T15:17:37Z", "tags": [], "is_private": false}, {"count": 18, "tags": [], "bug_id": 39647, "attachment_id": null, "id": 99209, "creation_time": "2007-02-09T15:55:21Z", "time": "2007-02-09T15:55:21Z", "creator": "rpluem@apache.org", "text": "I respectfully disagree here. According to 10.3.5 the response must not / should\nnot contain any entity headers (depending on the validator type). Furthermore\n10.3.5 states that this should prevent inconsistencies between the cached entity\nbody and the updated header. Content-type is an entity header and changing the\nContent-type clearly would create inconsistencies between the cached entity body\nand the updated header. So we are generous in what we acccept.\nIf you still disagree please continue this discussion on the\ndev@httpd.apache.org list.", "is_private": false}, {"count": 19, "tags": [], "bug_id": 39647, "attachment_id": null, "text": "10.3.5 says:\n \n[[[\nIf the conditional GET used a strong cache validator (see section 13.3.3), the response SHOULD NOT \ninclude other entity-headers. Otherwise (i.e., the conditional GET used a weak validator), the response \nMUST NOT include other entity-headers; this prevents inconsistencies between cached entity-bodies \nand updated headers.\n]]]\n\nThat applies to the responses; it doesn't specify the behaviour of the cache when it receives such \nresponses.\n\n10.3.5 goes on to say \n\n[[[\nIf a cache uses a received 304 response to update a cache entry, the cache MUST update the entry to \nreflect any new field values given in the response.\n]]]\n\nHowever, your reading does make sense. Rather than try and second-guess an apparent inconsistency \nin the spec, I\"ll follow up with the HTTP-WG list.\n", "id": 99212, "time": "2007-02-09T21:36:18Z", "creator": "mnot@mnot.net", "creation_time": "2007-02-09T21:36:18Z", "is_private": false}]