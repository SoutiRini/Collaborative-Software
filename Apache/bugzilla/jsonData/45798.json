[{"count": 0, "tags": [], "bug_id": 45798, "attachment_id": 22561, "text": "Created attachment 22561\nExcel 2002 spreadsheet demonstrating a bug caused by cells with 3D references\n\nCalling toString() on a cell with a 3D reference containing another sheet in the workbook causes an IndexOutOfBoundsException.\n\n\nExample:\n\n FileInputStream fis = new FileInputStream(argv[0]);\n POIFSFileSystem fs  = new POIFSFileSystem(fis);\n HSSFWorkbook wb = new HSSFWorkbook(fs); \n HSSFSheet sheet = wb.getSheetAt(0);\n HSSFRow row = sheet.getRow(1);\n HSSFCell cell = row.getCell((short)1);  \n System.out.println(cell);\n\nException in thread \"main\" java.lang.IndexOutOfBoundsException: Index: 2, Size: 2\n        at java.util.ArrayList.RangeCheck(Unknown Source)\n        at java.util.ArrayList.get(Unknown Source)\n        at org.apache.poi.hssf.model.Workbook.getSheetName(Workbook.java:534)\n        at\norg.apache.poi.hssf.model.Workbook.findSheetNameFromExternSheet(Workbook.java:1867)\n        at org.apache.poi.hssf.model.Workbook.getSheetReferences(Workbook.java:1849)\n        at org.apache.poi.hssf.usermodel.HSSFWorkbook.getSheetReferences(HSSFWorkbook.java:788)\n        at org.apache.poi.hssf.usermodel.HSSFWorkbook.getSheetReferences(HSSFWorkbook.java:79)\n        at org.apache.poi.hssf.record.formula.Ref3DPtg.getSheetName(Ref3DPtg.java:169)\n        at org.apache.poi.hssf.record.formula.Ref3DPtg.toFormulaString(Ref3DPtg.java:182)\n        at org.apache.poi.hssf.model.FormulaParser.toFormulaString(FormulaParser.java:925)\n        at org.apache.poi.hssf.model.FormulaParser.toFormulaString(FormulaParser.java:858)\n        at org.apache.poi.hssf.usermodel.HSSFCell.getCellFormula(HSSFCell.java:686)\n        at org.apache.poi.hssf.usermodel.HSSFCell.toString(HSSFCell.java:1031)\n        at java.lang.String.valueOf(Unknown Source)\n        at java.io.PrintStream.println(Unknown Source)\n        at bs.main(bs.java:69)\n\n\nThe exception is raised in POI-3.1-FINAL and POI-3.5-beta2.\n\nThe problem originates in Workbook.findSheetNameFromExternSheet(), \nThis method calls LinkTable.getIndexToSheet():\n\npublic short getIndexToSheet(short num) {\n  return _externSheetRecord.getREFRecordAt(num).getIndexToFirstSupBook();\n}\n\nExternSheetSubRecord.getIndexToFirstSubBook() returns 2, which is then used to get the 2nd element of the Workbook\u2019s boundsheets, a list of length 2.\n\n5 ExternSheetSubRecords are created from the attached spreadsheet, they are:\n\n   supbookindex =0\n   1stsbindex   =0\n   lastsbindex  =0\n\n   supbookindex =1\n   1stsbindex   =2\n   lastsbindex  =2\n\n   supbookindex =2\n   1stsbindex   =1\n   lastsbindex  =1\n\n   supbookindex =0\n   1stsbindex   =-1\n   lastsbindex  =-1\n\n    supbookindex =0\n   1stsbindex   =1\n   lastsbindex  =1\n\nIt seems that the original DocumentInputStream could be off, 3 non -1 supbookindices are created, and the 2nd 1stsbindex returns 2...", "id": 120571, "time": "2008-09-12T18:52:19Z", "creator": "sshaw@lucas.cis.temple.edu", "creation_time": "2008-09-12T18:52:19Z", "is_private": false}, {"count": 1, "tags": [], "creator": "josh@apache.org", "text": "Fixed in svn r695264.\n\nJunit added.\n\nThe main problem seems to be that ref #1 in the EXTERNSHEET record, which refers to sheet index 2, even though the worbook has only 2 sheets:\n        \nOffset 0x3954 (14676)\nrecordid = 0x17, size = 32\n[EXTERNSHEET]\n   numOfRefs\t = 5\nrefrec\t\t #0: extBook=0 firstSheet=0 lastSheet=0\nrefrec\t\t #1: extBook=1 firstSheet=2 lastSheet=2\nrefrec\t\t #2: extBook=2 firstSheet=1 lastSheet=1\nrefrec\t\t #3: extBook=0 firstSheet=-1 lastSheet=-1\nrefrec\t\t #4: extBook=0 firstSheet=1 lastSheet=1\n[/EXTERNSHEET]\n\n        \t\t\nThe fix for this bug involved removing the eager initialisation of the extern SheetReferences.  As it turns out, the formula in cell B1 has a Ref3DPtg with externSheetIndex=4 which resolves to sheetIndex 1.\n        \nSome investigation was done to see how Excel would handle a formula having externSheetIndex=1 (sheetIndex 2).  Excel displays the formula as ''!$A2, but also prompts the user about broken links.\n\nNote - this fix is just for the sample code provided.  It's quite possible (since the LinkTable is not fully understood) that POI may still fail in other ways with this spreadsheet.\n\nAn unrelated issue was that BiffViewer crashed on the DrawingGroupRecord.  This was not investigated any further.\n", "id": 120593, "time": "2008-09-14T12:04:54Z", "bug_id": 45798, "creation_time": "2008-09-14T12:04:54Z", "is_private": false, "attachment_id": null}]