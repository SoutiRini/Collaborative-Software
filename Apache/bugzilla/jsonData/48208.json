[{"count": 0, "tags": [], "bug_id": 48208, "attachment_id": 24546, "text": "Created attachment 24546\npatch_48158_c5_wildCard.txt\n\nas per bug 48158 comment 8, this is now an RFE on its own:\n\nLuciana has come up with a patch to allow accepting any client certificate on a\nper Connector basis.\n\nIn server.xml the following attribute should be added in the Connector element:\n\n<Connector ... acceptAllCerts=\"true\"/>\n\nIf this argument is present and set to true or yes, then the\nAcceptAllTrustManager will be used as Trust Manager.\n\nThe \"truststoreFile\" of\nhttp://tomcat.apache.org/tomcat-5.5-doc/ssl-howto.html#Edit%20the%20Tomcat%20Configuration%20File\ncan be left empty\n\noriginally was attachment (id=24542)", "id": 132027, "time": "2009-11-17T00:44:09Z", "creator": "hauser@acm.org", "creation_time": "2009-11-17T00:44:09Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 48208, "attachment_id": null, "text": "Accepting all client certificates defeats the purpose of CLIENT_CERT.", "id": 143775, "time": "2011-01-28T18:39:49Z", "creator": "markt@apache.org", "creation_time": "2011-01-28T18:39:49Z", "is_private": false}, {"count": 2, "attachment_id": null, "creator": "hauser@acm.org", "text": "Mark, I have to disagree\nin the context of CLIENT_CERT, the user still is forced to use a client certificate. If your policy is of a complexity that the standard container-provided security features do not match, the application can then make sure it only provides services to the client-certs provided that conform with its requirements", "id": 143783, "time": "2011-01-29T00:34:24Z", "bug_id": 48208, "creation_time": "2011-01-29T00:34:24Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 48208, "attachment_id": null, "text": "Then we disagree.\n\nRegardless of the complexity of the rules you may wish to apply, for there to be any security at all the client certificates have to be issued by a trusted certificate authority. The AcceptAllTrustManager is sufficiently insecure and its use sufficiently dangerous that I do not believe it should be part of the standard Tomcat distribution.\n\nThere should be sufficient scope within the current configuration options to install a custom trust manager although I haven't investigated this. If that process is excessively painful then I think an acceptable approach would be to add support for a trustManagerClassName attribute that would override the call to TrustManagerFactory.getTrustManagers() in a similar way to the above patch.", "id": 143789, "time": "2011-01-29T07:19:18Z", "creator": "markt@apache.org", "creation_time": "2011-01-29T07:19:18Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 48208, "attachment_id": null, "text": "Hello Mark.\nI do understand your point. Our application has a particular way of enforcing client authentication and authorization through an application level verification of the client certificates.\n\nOpening the possibility for every application to accept any certificates may not be the best approach and lead to security problems to other applications that not necessarily will have the same policy as we do. Nevertheless, I did like your idea of allowing to specify the trustmanager's class.\n\nI have implemented this idea, but I haven't had the time to test this code. But I believe it should work (famous last words). In any case it gives a good idea of how to structure the code in a way to allow proprietary TrustManagers.\n\nI have taken the liberty to re-open the bug for your evaluation. I believe this can be an interesting addition to tomcat.", "id": 143829, "time": "2011-01-31T11:20:59Z", "creator": "moreira@privasphere.com", "creation_time": "2011-01-31T11:20:59Z", "is_private": false}, {"count": 5, "tags": [], "creator": "moreira@privasphere.com", "attachment_id": 26581, "text": "Created attachment 26581\npatch for tomcat 6 svn revision 1065625\n\nThis patch allows to specify the TrustManager class name.", "id": 143830, "time": "2011-01-31T11:23:10Z", "bug_id": 48208, "creation_time": "2011-01-31T11:23:10Z", "is_private": false}, {"count": 6, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "id": 143834, "time": "2011-01-31T15:42:47Z", "bug_id": 48208, "creation_time": "2011-01-31T15:42:47Z", "is_private": false, "text": "If you don't need authentication, why bother configuring it?\n\nIf you just want ANY client certificate to be available to your webapp, why not configure <Connector clientAuth=\"want\" />?\n\nEnabling CLIENT_CERT *authentication* with no form of validation of the certificate is entirely without merit.\n\nIf you just want the client certificate, then you want clientAuth=\"want\" with no authentication configured.\n\nLike Mark, I will -1 any attempt to add this feature unless you can give us a reasonable use case that is not possible to configure in Tomcat."}, {"count": 7, "tags": [], "bug_id": 48208, "attachment_id": null, "text": "Hi Chris, we do need authentication and \"want\" is not good enough since the user can opt out not to use client cert auth altogether AFAICR.\n\nTo avoid misunderstandings, I have updated the Summary.\n\nLuciana's patch attachment (id=26581) for tomcat 6 svn revision 1065625 exactly tries to implement what Mark suggested as \"acceptable approach\" in comment 3", "id": 143842, "time": "2011-01-31T19:27:22Z", "creator": "hauser@acm.org", "creation_time": "2011-01-31T19:27:22Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 48208, "attachment_id": null, "text": "Just another application scenario the mandates a custom TrustManager as suggested by Mark:\n\nThere is a restriction that depending on the time-of-the-day, a different set of certificates is trusted.\n\nOur original solution approach was then to accept all certificates. Once the certificate is provided and the full SSL handshake is finished, we can choose the set of acceptable trusted issuing certificates depending on time-of-day or other context paramters. Only then we do the verification and possibly abort the session.\n\nAs I mentioned before, wedo understand your reservations on incorporating an AcceptAllTrustManager patch, however, we would hope that a more generic solution as the  trustManagerClassName suggested by Mark Thomas would be a fair compromise.\nThen, we could move the logic from the application into our custom trust manager we define in \u201ctrustManagerClassName\u201d.", "id": 143949, "time": "2011-02-03T05:24:46Z", "creator": "hauser@acm.org", "creation_time": "2011-02-03T05:24:46Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 48208, "attachment_id": null, "text": "This has been fixed in 7.0.x and will be included in 7.0.11 onwards.\n\nThe patch has not yet been back-ported to 6.0.x", "id": 144770, "time": "2011-03-06T04:40:27Z", "creator": "markt@apache.org", "creation_time": "2011-03-06T04:40:27Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 48208, "attachment_id": 26732, "text": "Created attachment 26732\nProposed patch for Tomcat 6\n\nSome slight modifications from the patch provided by Luciana Moreira.", "id": 144773, "time": "2011-03-06T11:39:29Z", "creator": "markt@apache.org", "creation_time": "2011-03-06T11:39:29Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 48208, "text": "I looked and it seems very good from my perspective.", "id": 144803, "time": "2011-03-07T10:02:21Z", "creator": "moreira@privasphere.com", "creation_time": "2011-03-07T10:02:21Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 48208, "attachment_id": null, "text": "Regarding implementation in 7.0.x: the tests added in r1078436 in TestCustomSsl do work with BIO connector, but fail with NIO. I have not tested APR.\n\nTested with JDK 6u23, WinXP, Ant 1.8.2, trunk @1078628\nTEST-org.apache.tomcat.util.net.TestCustomSsl.NIO.txt:\n\nTestsuite: org.apache.tomcat.util.net.TestCustomSsl\nTests run: 3, Failures: 1, Errors: 0, Time elapsed: 7,187 sec\n------------- Standard Error -----------------\n(...)\n------------- ---------------- ---------------\n\nTestcase: testCustomSslImplementation took 3,906 sec\nTestcase: testCustomTrustManager1 took 1,641 sec\nTestcase: testCustomTrustManager2 took 1,64 sec\n\tFAILED\nexpected:<200> but was:<-1>\njunit.framework.AssertionFailedError: expected:<200> but was:<-1>\n\tat org.apache.tomcat.util.net.TestCustomSsl.doTestCustomTrustManager(TestCustomSsl.java:133)\n\tat org.apache.tomcat.util.net.TestCustomSsl.testCustomTrustManager2(TestCustomSsl.java:79)", "id": 144807, "time": "2011-03-07T13:55:40Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2011-03-07T13:55:40Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 48208, "attachment_id": null, "text": "(In reply to comment #10)\n> Created an attachment (id=26732) [details]\n> Proposed patch for Tomcat 6\n\nRegarding this patch for tc6:\n\nWhen trustManageClassName is specified, there is a lot of work to get and configure a TrustManagerFactory instance (tmf) in JSSESocketFactory#getTrustManagers() and then that getTrustManagers() method just ignores this tmf instance.\n\nThe documentation update part of the patch says that \"If this attribute is set, the trust store attributes may be ignored.\" but with the current code they actually cannot be ignored because that (unneeded) tmf.init() call is likely to fail if those values are bogus.", "id": 144813, "time": "2011-03-07T21:26:55Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2011-03-07T21:26:55Z", "is_private": false}, {"count": 14, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "(In reply to comment #12)\n> Regarding implementation in 7.0.x: the tests added in r1078436 in TestCustomSsl\n> do work with BIO connector, but fail with NIO. I have not tested APR.\n\nThere is a lot of duplication between SSL Support in BIO and NIO. Removing that duplication should fix this and any other (as yet undiscovered issues).\n\nThis attribute is not supported for APR.", "id": 144825, "time": "2011-03-08T08:41:45Z", "bug_id": 48208, "creation_time": "2011-03-08T08:41:45Z", "is_private": false}, {"count": 15, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 147098, "time": "2011-06-14T11:23:33Z", "bug_id": 48208, "creation_time": "2011-06-14T11:23:33Z", "is_private": false, "text": "This has been fixed in 6.0.x and will be included in 6.0.33 onwards."}, {"count": 16, "tags": [], "creator": "hauser@acm.org", "attachment_id": null, "text": "in tomcat 7, \"trustManagerClassName\" of http://tomcat.apache.org/tomcat-7.0-doc/config/http.html#SSL%20Support will no longer be dealt with in JSSESocketFactory.java but at least as of version TOMCAT_7_0_28, this is now in AbstractEndpoint.java\n\nhttp://svn.apache.org/viewvc/tomcat/tc7.0.x/tags/TOMCAT_7_0_28/java/org/apache/tomcat/util/net/AbstractEndpoint.java?view=markup", "id": 168512, "time": "2013-07-11T15:24:42Z", "bug_id": 48208, "creation_time": "2013-07-11T15:24:42Z", "is_private": false}]