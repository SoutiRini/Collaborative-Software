[{"count": 0, "tags": [], "creator": "ruvinsky@yahoo.com", "attachment_id": null, "text": "NOTE:  You should add a \"4.0.5 Final\" Tomcat version option in Bugzilla.\n\nI have confirmed this is a bug in Tomcat 4.0.5 when run with the \nSecurityManager enabled (but this may have existed in older Tomcat versions).  \nAfter starting the server using the HTTP/1.1 Connector, a requested servlet \nthat calls request.getParameter() will cause Tomcat to throw a \njava.lang.NoClassDefFoundError exception for class \"ParameterMap.\"  This is due \nto the webapp code not being granted the \"defineClassInPackage\" \nRuntimePermission for org.apache.catalina.util in the \"catalina.policy\" file.  \nI imagine that the best solution here is to avoid having to grant this extra \npermission to webapps in the policy file by simply ensuring that ParameterMap \ngets loaded by the \"server\" classloader during Tomcat initialization.  This \nshould be as simple as changing org.apache.catalina.connector.HttpRequestBase \nas follows:\n\n-    protected ParameterMap parameters = null;\n+    protected ParameterMap parameters = new ParameterMap();\n\nAlthough the HTTP/1.1 Connector is deprecated as of Tomcat 4.1.x, the fix to \nthis can still be made to HttpRequestBase, as it is a connector-independent \nbase class.\n\n-Eddie\n______\n\nExample request:\n  http://127.0.0.1:8080/examples/servlet/RequestParamExample?\nfirstname=foo&lastname=bar\"\n\nExample output (exception):\n<html><head><title>Apache Tomcat/4.0.5 - Error report</title><STYLE><!--H1{font-\nfamily : sans-serif,Arial,Tahoma;color : white;background-color : #0086b2;} BODY\n{font-family : sans-serif,Arial,Tahoma;color : black;background-color : white;} \nB{color : white;background-color : #0086b2;} HR{color : #0086b2;} --></STYLE> \n</head><body><h1>Apache Tomcat/4.0.5 - HTTP Status 500 - Internal Server \nError</h1><HR size=\"1\" noshade><p><b>type</b> Exception \nreport</p><p><b>message</b> <u>Internal Server \nError</u></p><p><b>description</b> <u>The server encountered an internal error \n(Internal Server Error) that prevented it from fulfilling this \nrequest.</u></p><p><b>exception</b> <pre>javax.servlet.ServletException: \nServlet execution threw an exception\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter\n(ApplicationFilterChain.java:269)\n        at org.apache.catalina.core.ApplicationFilterChain.access$000\n(ApplicationFilterChain.java:98)\n        at org.apache.catalina.core.ApplicationFilterChain$1.run\n(ApplicationFilterChain.java:176)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter\n(ApplicationFilterChain.java:172)\n        at filters.ExampleFilter.doFilter(ExampleFilter.java:149)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter\n(ApplicationFilterChain.java:213)\n        at org.apache.catalina.core.ApplicationFilterChain.access$000\n(ApplicationFilterChain.java:98)\n        at org.apache.catalina.core.ApplicationFilterChain$1.run\n(ApplicationFilterChain.java:176)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter\n(ApplicationFilterChain.java:172)\n        at org.apache.catalina.core.StandardWrapperValve.invoke\n(StandardWrapperValve.java:243)\n        at org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:566)\n        at org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:472)\n        at org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:943)\n        at org.apache.catalina.core.StandardContextValve.invoke\n(StandardContextValve.java:190)\n        at org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:566)\n        at org.apache.catalina.authenticator.AuthenticatorBase.invoke\n(AuthenticatorBase.java:475)\n        at org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:564)\n        at org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:472)\n        at org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:943)\n        at org.apache.catalina.core.StandardContext.invoke\n(StandardContext.java:2347)\n        at org.apache.catalina.core.StandardHostValve.invoke\n(StandardHostValve.java:180)\n        at org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:566)\n        at org.apache.catalina.valves.ErrorDispatcherValve.invoke\n(ErrorDispatcherValve.java:170)\n        at org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:564)\n        at org.apache.catalina.valves.ErrorReportValve.invoke\n(ErrorReportValve.java:170)\n        at org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:564)\n        at org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:472)\n        at org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:943)\n        at org.apache.catalina.core.StandardEngineValve.invoke\n(StandardEngineValve.java:174)\n        at org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:566)\n        at org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:472)\n        at org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:943)\n        at org.apache.catalina.connector.http.HttpProcessor.process\n(HttpProcessor.java:1027)\n        at org.apache.catalina.connector.http.HttpProcessor.run\n(HttpProcessor.java:1125)\n        at java.lang.Thread.run(Thread.java:484)\n</pre></p><p><b>root cause</b> <pre>java.lang.NoClassDefFoundError: \norg/apache/catalina/util/ParameterMap\n        at org.apache.catalina.connector.HttpRequestBase.parseParameters\n(HttpRequestBase.java:615)\n        at org.apache.catalina.connector.HttpRequestBase.getParameter\n(HttpRequestBase.java:691)\n        at org.apache.catalina.connector.RequestFacade.getParameter\n(RequestFacade.java:160)\n        at RequestParamExample.doGet(RequestParamExample.java:56)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:740)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:853)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter\n(ApplicationFilterChain.java:247)\n        at org.apache.catalina.core.ApplicationFilterChain.access$000\n(ApplicationFilterChain.java:98)\n        at org.apache.catalina.core.ApplicationFilterChain$1.run\n(ApplicationFilterChain.java:176)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter\n(ApplicationFilterChain.java:172)\n        at filters.ExampleFilter.doFilter(ExampleFilter.java:149)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter\n(ApplicationFilterChain.java:213)\n        at org.apache.catalina.core.ApplicationFilterChain.access$000\n(ApplicationFilterChain.java:98)\n        at org.apache.catalina.core.ApplicationFilterChain$1.run\n(ApplicationFilterChain.java:176)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter\n(ApplicationFilterChain.java:172)\n        at org.apache.catalina.core.StandardWrapperValve.invoke\n(StandardWrapperValve.java:243)\n        at org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:566)\n        at org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:472)\n        at org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:943)\n        at org.apache.catalina.core.StandardContextValve.invoke\n(StandardContextValve.java:190)\n        at org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:566)\n        at org.apache.catalina.authenticator.AuthenticatorBase.invoke\n(AuthenticatorBase.java:475)\n        at org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:564)\n        at org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:472)\n        at org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:943)\n        at org.apache.catalina.core.StandardContext.invoke\n(StandardContext.java:2347)\n        at org.apache.catalina.core.StandardHostValve.invoke\n(StandardHostValve.java:180)\n        at org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:566)\n        at org.apache.catalina.valves.ErrorDispatcherValve.invoke\n(ErrorDispatcherValve.java:170)\n        at org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:564)\n        at org.apache.catalina.valves.ErrorReportValve.invoke\n(ErrorReportValve.java:170)\n        at org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:564)\n        at org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:472)\n        at org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:943)\n        at org.apache.catalina.core.StandardEngineValve.invoke\n(StandardEngineValve.java:174)\n        at org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:566)\n        at org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:472)\n        at org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:943)\n        at org.apache.catalina.connector.http.HttpProcessor.process\n(HttpProcessor.java:1027)\n        at org.apache.catalina.connector.http.HttpProcessor.run\n(HttpProcessor.java:1125)\n        at java.lang.Thread.run(Thread.java:484)", "id": 23489, "time": "2002-09-26T22:06:38Z", "bug_id": 13052, "creation_time": "2002-09-26T22:06:38Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 13052, "text": "This duplicates a previous report.  See bug 12101 for the\nwork around. \n\n*** This bug has been marked as a duplicate of 12101 ***", "id": 23494, "time": "2002-09-27T00:40:30Z", "creator": "glenn@apache.org", "creation_time": "2002-09-27T00:40:30Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 13052, "is_private": false, "text": "Although it may be related, this is technically a DIFFERENT problem than bug \n12101.  Your fix to 12101 was to add the \"accessClassInPackage\" \nRuntimePermission to the catalina.policy file.  In Tomcat 4.0.5, even with this \npolicy file, the exception is thrown due to a lack of a \"defineClassInPackage\" \npermission.  Hence, this bug calls for an additional fix to Tomcat.\n\nI proposed a few solutions -- you can either grant the \"defineClassInPackage\" \nfor org.apache.catalina.util to webapp code or (better yet) fix it in the \nTomcat source by defining ParameterMap during server initialization (e.g., when \nHttpRequestBase gets instantiated).\n\nSo, I'm reopening this bug for your attention and comments.", "id": 23500, "time": "2002-09-27T06:19:46Z", "creator": "ruvinsky@yahoo.com", "creation_time": "2002-09-27T06:19:46Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 13052, "text": "As I stated in the other bugzilla report, there is nothing in\norg.apache.catalina.util.* that is security sensitive.\n\nFix your policy so that the correct defineClassInPackage Runitme permission is \ngranted.\n", "id": 23587, "time": "2002-09-27T22:19:36Z", "creator": "glenn@apache.org", "creation_time": "2002-09-27T22:19:36Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "ruvinsky@yahoo.com", "text": "Glenn, I have fixed the problem on my end by adding the following two lines in \nmy catalina.policy:\n\n        permission \njava.lang.RuntimePermission \"accessClassInPackage.org.apache.catalina.util\";\n        permission \njava.lang.RuntimePermission \"accessClassInPackage.org.apache.catalina.util.*\";\n+       permission \njava.lang.RuntimePermission \"defineClassInPackage.org.apache.catalina.util\";\n+       permission \njava.lang.RuntimePermission \"defineClassInPackage.org.apache.catalina.util.*\";\n\nThe reason why I posted this bug is so that you can fix this catalina.policy in \nthe Tomcat distribution to fix this bug for others.  Please do so.  Thanks.", "id": 23650, "attachment_id": null, "bug_id": 13052, "creation_time": "2002-09-30T17:06:59Z", "time": "2002-09-30T17:06:59Z", "is_private": false}, {"count": 5, "tags": [], "creator": "glenn@apache.org", "attachment_id": null, "text": "Note, only security exploit bug fixes are being made to the Tomcat 4.0.x branch.\nI had already added the accessClassInPackage for the util package to the\ncatalina.policy in the current Tomcat 4.1.x branch.  I added the additional\ndefineClassInPackage permissions to this branch in CVS. Thanks for reporting this.", "id": 23668, "time": "2002-09-30T20:02:42Z", "bug_id": 13052, "creation_time": "2002-09-30T20:02:42Z", "is_private": false}]