[{"count": 0, "attachment_id": null, "creator": "tim.mcbride@alcoa.com", "text": "apparently, this was done so that ap_set_keepalive will work properly:\n\n(proxy_http.c)\n            /* In order for ap_set_keepalive to work properly, we can NOT\n             * have any length information stored in the output headers.\n\n            apr_table_unset(r->headers_out,\"Transfer-Encoding\");\n            apr_table_unset(r->headers_out,\"Content-Length\");\n\n            ap_log_error(APLOG_MARK, APLOG_DEBUG|APLOG_NOERRNO, 0, r->server,\n                         \"proxy: start body send\");\n             \nHowever, this is overbroad.  If we have Connection: close, then we're not going \nto have a keepalive connection, so we don't need or want to nuke the c-l and t-\ne headers.  Refering to an earlier bug declared invalid (#8673), not every \nvendor comprehends the standards, and so might very well send a set of HTTP \nheaders that is inconsistent with the standard.  mod_proxy should not touch any \nheaders that it does not absolutely have to.\n\nHere's ap_set_keepalive, just so all of the appropriate code is in one place:\n\nAP_DECLARE(int) ap_set_keepalive(request_rec *r)\n{\n    int ka_sent = 0;\n    int wimpy = ap_find_token(r->pool,\n                              apr_table_get(r->headers_out, \"Connection\"),\n                              \"close\");\n    const char *conn = apr_table_get(r->headers_in, \"Connection\");\n \n    /* The following convoluted conditional determines whether or not\n     * the current connection should remain persistent after this response\n     * (a.k.a. HTTP Keep-Alive) and whether or not the output message\n     * body should use the HTTP/1.1 chunked transfer-coding.  In English,\n     *\n     *   IF  we have not marked this connection as errored;\n     *   and the response body has a defined length due to the status code\n     *       being 304 or 204, the request method being HEAD, already\n     *       having defined Content-Length or Transfer-Encoding: chunked, or\n     *       the request version being HTTP/1.1 and thus capable of being set\n     *       as chunked [we know the (r->chunked = 1) side-effect is ugly];\n     *   and the server configuration enables keep-alive;\n     *   and the server configuration has a reasonable inter-request timeout;\n     *   and there is no maximum # requests or the max hasn't been reached;\n     *   and the response status does not require a close;\n     *   and the response generator has not already indicated close;\n     *   and the client did not request non-persistence (Connection: close);\n     *   and    we haven't been configured to ignore the buggy twit\n     *       or they're a buggy twit coming through a HTTP/1.1 proxy\n     *   and    the client is requesting an HTTP/1.0-style keep-alive\n     *       or the client claims to be HTTP/1.1 compliant (perhaps a proxy);\n     *   THEN we can be persistent, which requires more headers be output.\n     *\n     * Note that the condition evaluation order is extremely important.\n     */\n...\n}\n \nthe code corresponding to the Content-Length condition is:\n \n        && ((r->status == HTTP_NOT_MODIFIED)\n            || (r->status == HTTP_NO_CONTENT)\n            || r->header_only\n            || apr_table_get(r->headers_out, \"Content-Length\")\n            || ap_find_last_token(r->pool,\n                                  apr_table_get(r->headers_out,\n                                                \"Transfer-Encoding\"),\n                                  \"chunked\")\n            || ((r->proto_num >= HTTP_VERSION(1,1))\n                && (r->chunked = 1))) /* THIS CODE IS CORRECT, see above. */", "id": 15186, "time": "2002-04-30T19:21:44Z", "bug_id": 8677, "creation_time": "2002-04-30T19:21:44Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 8677, "is_private": false, "text": "I think you have a slight misunderstanding of what a Proxy server does.  It \ndoesn't just simply pass all content untouched from server to client.  It\nmay do all sorts of other things including changing encodings.\n\nNow, if the server is really unconditionally stripping the content length,\nI agree that doesn't sound like a good idea, especially if serving to\na HTTP/1.0 client.  But I'll leave it for someone more familiar with\nmod_proxy to take a detailed look at this.", "id": 15201, "time": "2002-04-30T22:04:06Z", "creator": "slive@apache.org", "creation_time": "2002-04-30T22:04:06Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 8677, "is_private": false, "id": 15500, "attachment_id": null, "creator": "minfrin@sharp.fm", "creation_time": "2002-05-05T18:00:04Z", "time": "2002-05-05T18:00:04Z", "text": "Stripping the Transfer-Encoding header is required by RFC2616, as it is a hop by\nhop header, so this behaviour is correct.\n\nAs to stripping the Content-Length, I understand that the Content-Length filter\nis responsible for putting in this header, although if the content length is\nalready there, I see no point in stripping it.\n"}, {"count": 3, "tags": [], "text": "Answer from the dev list:\n\nJustin Erenkrantz wrote:\n\nNah, this allows us flexibility in optimizing the data sent to our\nclient.  If we can send chunked-encoding, I believe that is a better\nthan using C-L.  I believe that the RFC allows us to do these sorts\nof optimizations.\n", "is_private": false, "id": 15504, "creator": "minfrin@sharp.fm", "time": "2002-05-05T18:45:52Z", "bug_id": 8677, "creation_time": "2002-05-05T18:45:52Z", "attachment_id": null}, {"count": 4, "tags": [], "text": "I think I'll reopen this, at least until someone can convince me that this is \nreally how things \"should be\".   It certainly seems like it is \"allowed\",\nand it shouldn't actually break any clients, but it does not seem at all \noptimal.  For HTTP/1.0 clients it verges on very bad behvior.\n\nI'll also downgrade to \"Enhancement\" and remove the encoding reference.", "attachment_id": null, "bug_id": 8677, "id": 15508, "time": "2002-05-05T19:47:18Z", "creator": "slive@apache.org", "creation_time": "2002-05-05T19:47:18Z", "is_private": false}, {"count": 5, "attachment_id": null, "creator": "seb.bacon@jamkit.com", "text": "I can confirm that this bug is still around.  Now the chunked-encoding issue\nforces admins to upgrade, this bug is more of a blocker.  Sorry can't help - not\na C hacker, but I'll test patches...", "id": 19039, "time": "2002-07-05T09:21:17Z", "bug_id": 8677, "creation_time": "2002-07-05T09:21:17Z", "tags": [], "is_private": false}, {"count": 6, "tags": [], "bug_id": 8677, "is_private": false, "id": 19040, "attachment_id": null, "creator": "seb.bacon@jamkit.com", "creation_time": "2002-07-05T09:23:44Z", "time": "2002-07-05T09:23:44Z", "text": "Oops, ignore the last comment, I managed to post it to the wrong bug."}, {"count": 7, "tags": [], "bug_id": 8677, "attachment_id": null, "is_private": false, "id": 21739, "time": "2002-08-26T14:50:58Z", "creator": "siegfried.delwiche@sbs.be", "creation_time": "2002-08-26T14:50:58Z", "text": "I suggest to raise level to an higher level since this is really blocking (at \nleast the content-length header).\nA typical application not working anymore is the windows update tool\n\nAs far as I understand the protocol, it mentions \n14.13\nThe Content-Length entity-header field indicates the size of the entity-body, \nin decimal number of OCTETs, sent to the recipient or, in the case of the HEAD \nmethod, the size of the entity-body that would have been sent had the request \nbeen a GET. \n\nWindows update makes a HEAD request on the cab file that contains the updater \nprogram and gets in trouble since it does not receive a content length.\n\nHope this will be fixed soon."}, {"count": 8, "tags": [], "text": "Patch to fix this has been commited to v2.0.45-dev and v2.1.0-dev.\n\nIf this does not fix this problem, please reopen this bug.\n", "is_private": false, "id": 29793, "creator": "minfrin@sharp.fm", "time": "2003-01-21T15:43:34Z", "bug_id": 8677, "creation_time": "2003-01-21T15:43:34Z", "attachment_id": null}, {"count": 9, "attachment_id": null, "creator": "lars@kneschke.de", "is_private": false, "id": 44957, "time": "2003-10-01T16:22:01Z", "bug_id": 8677, "creation_time": "2003-10-01T16:22:01Z", "tags": [], "text": "I do still have problems with Windows Update using apache 2.0.47.\n\nCu"}, {"count": 10, "tags": [], "text": "mod_proxy no longer nukes Content-Length header but a related CONTENT_LENGTH\nfilter bug, #18757, breaks responses to HEAD requests and breaks Windows Update\nclients. #18757 contains a patch to fix the problem but apparently no-one has\nhad time to commit the patch.\n\n*** This bug has been marked as a duplicate of 18757 ***", "attachment_id": null, "id": 48167, "creator": "sami.tikka@f-secure.com", "time": "2003-11-26T14:03:18Z", "bug_id": 8677, "creation_time": "2003-11-26T14:03:18Z", "is_private": false}]