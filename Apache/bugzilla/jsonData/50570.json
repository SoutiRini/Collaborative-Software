[{"count": 0, "tags": [], "bug_id": 50570, "attachment_id": null, "id": 143267, "time": "2011-01-11T12:27:44Z", "creator": "chris@christopherschultz.net", "creation_time": "2011-01-11T12:27:44Z", "is_private": false, "text": "Both OpenSSL and JSSE allow themselves to be put into FIPS mode, and we should allow SSL connectors to request it (and have them fail if FIPS mode can't be set).\n\nOpenSSL:\nhttp://www.mail-archive.com/openssl-dev@openssl.org/msg20882.html"}, {"count": 1, "tags": [], "bug_id": 50570, "attachment_id": null, "id": 143269, "time": "2011-01-11T12:34:15Z", "creator": "chris@christopherschultz.net", "creation_time": "2011-01-11T12:34:15Z", "is_private": false, "text": "It might make more sense to put this into the AprLifecycleListener, as it appears that FIPS mode for OpenSSL is not done on a per-context basis, but per-process.\n\nIt would be nice to enable this for JSSE as well, so where would that go?"}, {"count": 2, "tags": [], "text": "Unless its changed since I last looked at it, a FIPS JSSE solution requires a new security provider and all the configuration happens in the JRE. Tomcat configuration does not change.", "is_private": false, "bug_id": 50570, "id": 143277, "time": "2011-01-11T17:04:30Z", "creator": "markt@apache.org", "creation_time": "2011-01-11T17:04:30Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 50570, "attachment_id": null, "id": 143326, "time": "2011-01-13T14:49:06Z", "creator": "chris@christopherschultz.net", "creation_time": "2011-01-13T14:49:06Z", "is_private": false, "text": "Changing description to reflect new requirements: NIO/BIO connectors need no such explicit configuration.\n\nIt looks like this can be done by adding a member, accessor, and mutator to AprEndpoint and then in AprEndpoint.bind, call (a new method) SSLContext.setFIPSMode which calls FIPS_mode_set.\n\nOne thing I'm unclear on is how to get the configuration from server.xml's <Connector> all the way down to the AprEndpoint object. What object has setXXX() called on it when configuring a <Connector>?"}, {"count": 4, "tags": [], "creator": "cbeckey@gmail.com", "attachment_id": 26582, "id": 143838, "time": "2011-01-31T16:59:41Z", "bug_id": 50570, "creation_time": "2011-01-31T16:59:41Z", "is_private": false, "text": "Created attachment 26582\nSource and properties files to add FIPS initialization call to OpenSSL\n\nThe attached zip file contains source to allow FIPS mode initialization of OpenSSL."}, {"text": "A patch (like diff against the existing code) would be more easy to look to,", "tags": [], "bug_id": 50570, "attachment_id": null, "count": 5, "id": 143849, "time": "2011-02-01T03:38:39Z", "creator": "jfclere@gmail.com", "creation_time": "2011-02-01T03:38:39Z", "is_private": false}, {"count": 6, "tags": [], "creator": "cbeckey@gmail.com", "attachment_id": null, "is_private": false, "id": 143862, "time": "2011-02-01T12:44:28Z", "bug_id": 50570, "creation_time": "2011-02-01T12:44:28Z", "text": "(In reply to comment #5)\n> A patch (like diff against the existing code) would be more easy to look to,\n\nThe code is built from a base of Version 6.0.20.  I had assumed that a diff against the (current) 7.x codebase would be nearly worthless.  If a diff from 6.0.20 would be useful I can generate that."}, {"count": 7, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "id": 143874, "time": "2011-02-01T17:51:52Z", "bug_id": 50570, "creation_time": "2011-02-01T17:51:52Z", "is_private": false, "text": "(In reply to comment #6)\n> The code is built from a base of Version 6.0.20.  I had assumed that a diff\n> against the (current) 7.x codebase would be nearly worthless.  If a diff from\n> 6.0.20 would be useful I can generate that.\n\nA diff against 6.0.20 would be better than just a big ZIP file: we'd have to do our own diffs and figure it all out, anyway, so you'd be saving us a big step.\n\nIt might be best to give us two patches: one for the Java code and another for the C code."}, {"count": 8, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "id": 143875, "time": "2011-02-01T17:53:33Z", "bug_id": 50570, "creation_time": "2011-02-01T17:53:33Z", "is_private": false, "text": "(From private email from CHris Beckey):\n\n> I just zip'd together the source and attached it to the bug report.  The changes are in:\n> \n> org.apache.tomcat.core.AprLifecycleListener.java\n> org.apache.tomcat.core.LocalStrings.properties\n> org.apache.tomcat.jni.SSL.java\n> org.apache.tomcat.jni.Library.java\n> \n> and in tomcat native\n> ssl.c\n> \n> I modified the code in Library.java to load each of the (3) required libraries (APR, libtcnative and libeay) explicitly rather than depending on references within the libs.  This was for my debugging and is not required but it does make it explicit if one of them is missing.\n> \n> The listener declaration in server.xml looks like this:\n>   <Listener className=\"org.apache.catalina.core.AprLifecycleListener\" SSLEngine=\"on\" FIPSMode=\"on\" />\n> \n> I was unsure whether to abort startup if FIPS was requested but did not initialize. I think it is valid to refuse to continue in that case but didn't implement it that way."}, {"count": 9, "tags": [], "bug_id": 50570, "attachment_id": null, "id": 143876, "creation_time": "2011-02-01T17:54:18Z", "time": "2011-02-01T17:54:18Z", "creator": "chris@christopherschultz.net", "text": "Updating bug description to match reality: FIPS mode should be set in the APR listener, and not in an individual Connector.", "is_private": false}, {"count": 10, "tags": [], "creator": "cbeckey@gmail.com", "attachment_id": 26775, "id": 145021, "time": "2011-03-15T16:16:28Z", "bug_id": 50570, "creation_time": "2011-03-15T16:16:28Z", "is_private": false, "text": "Created attachment 26775\nPatch to implement FIPS mode setting in Tomcat 7 trunk\n\nRequires TC native patch, which has also been attached to bug #50570"}, {"count": 11, "tags": [], "bug_id": 50570, "attachment_id": 26776, "id": 145022, "time": "2011-03-15T16:17:55Z", "creator": "cbeckey@gmail.com", "creation_time": "2011-03-15T16:17:55Z", "is_private": false, "text": "Created attachment 26776\npatch to implement FIPS mode setting in tc native \n\nRequires patch to Tomcat, which is attached to bug #05070"}, {"count": 12, "tags": [], "bug_id": 50570, "attachment_id": null, "id": 145023, "time": "2011-03-15T16:54:37Z", "creator": "cbeckey@gmail.com", "creation_time": "2011-03-15T16:54:37Z", "is_private": false, "text": "(In reply to comment #9)\n> Updating bug description to match reality: FIPS mode should be set in the APR\n> listener, and not in an individual Connector."}, {"count": 13, "tags": [], "creator": "cbeckey@gmail.com", "attachment_id": null, "id": 145024, "time": "2011-03-15T17:13:13Z", "bug_id": 50570, "creation_time": "2011-03-15T17:13:13Z", "is_private": false, "text": "The first attachment (named \"Source and properties files to add FIPS ...\") contains source code and properties using TC 6.0.20 as the base.\nThe next two attached files (named \"patch to implement ...\") are patches against the trunk as of the 14th of March 2011, i.e. after version 7.0.11.\nThese were tested against OpenSSL V 0.9.8q with the OpenSSL FIPS module 1.2.2 built and linked in using the directions at \nhttp://www.openssl.org/docs/fips/UserGuide-1.2.pdf"}, {"count": 14, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "id": 147464, "time": "2011-06-24T14:47:13Z", "bug_id": 50570, "creation_time": "2011-06-24T14:47:13Z", "is_private": false, "text": "Just a quick update: I'm taking a vacation from $work next week and I hope to work on this feature. Chris, if there are any updates to your patch please post them. Otherwise, I'll use the existing one."}, {"count": 15, "tags": [], "bug_id": 50570, "attachment_id": 27224, "id": 147578, "time": "2011-06-28T20:40:40Z", "creator": "chris@christopherschultz.net", "creation_time": "2011-06-28T20:40:40Z", "is_private": false, "text": "Created attachment 27224\nSomewhat simpler patch for FIPS mode (against TC7 trunk)\n\nI'm not quite done with my adaptation, but I figured I would get some feedback on this one in the meantime."}, {"count": 16, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": 27225, "is_private": false, "id": 147579, "time": "2011-06-28T21:37:31Z", "bug_id": 50570, "creation_time": "2011-06-28T21:37:31Z", "text": "Created attachment 27225\nA fipsModeSet implementation that is more robust than the original patch\n\n* Provide a fipsModeSet function when OPENSSL is not available.\n* Provide a fipsModeSet implementation that fails gracefully when FIPS is not available.\n* Provide a human-readable error message when failing to enter FIPS mode."}, {"count": 17, "tags": [], "bug_id": 50570, "attachment_id": 26582, "id": 147580, "time": "2011-06-28T21:44:38Z", "creator": "chris@christopherschultz.net", "creation_time": "2011-06-28T21:44:38Z", "is_private": false, "text": "Comment on attachment 26582\nSource and properties files to add FIPS initialization call to OpenSSL\n\nReplaced with non-zipped patches."}, {"count": 18, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "is_private": false, "id": 147783, "time": "2011-07-05T21:57:06Z", "bug_id": 50570, "creation_time": "2011-07-05T21:57:06Z", "text": "(In reply to comment #16)\n\nRegarding attachment 27225 (Java patch) I have two comments:\n\n1) Code formatting.\nWe usually have \"{\" on the same line as previous statement (like in Java coding style).\n\n2) I go not get why there are two methods in SSL.java:\nfipsModeSet(Integer mode) and fipsModeSet(int mode).\n\nIf you need class object of \"int\" to do lookup of the method, it is available as Integer.TYPE."}, {"count": 19, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "is_private": false, "id": 147785, "time": "2011-07-05T22:54:15Z", "bug_id": 50570, "creation_time": "2011-07-05T22:54:15Z", "text": "Thanks for the comments. Very helpful!\n\n(In reply to comment #18)\n> (In reply to comment #16)\n> \n> Regarding attachment 27225 [details] (Java patch) I have two comments:\n> \n> 1) Code formatting.\n> We usually have \"{\" on the same line as previous statement (like in Java coding\n> style).\n\nI'm happy to change the use of whitespace, but \"usually\" is somewhat subjective in the TC code base :)\n\n> 2) I go not get why there are two methods in SSL.java:\n> fipsModeSet(Integer mode) and fipsModeSet(int mode).\n> \n> If you need class object of \"int\" to do lookup of the method, it is available\n> as Integer.TYPE.\n\nI mostly reduced the patch provided by (the other) Chris and I remember thinking about the overloaded methods but can't remember why I decided to leave them there. Certainly the rest of the code does not require both methods.\n\nCome to think of it, I'm not sure why the method call needs to be done using reflection at all... both AprLifecycleListener.java and SSL.java are in the Tomcat project (as opposed to tcnative) and thus should never be out of sync.\n\nThe only potential problem is if the native call fails because of a mismatched tcnative library, but that would fail in a way that reflection wouldn't solve, anyway.\n\nI'll update the patch."}, {"count": 20, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 150927, "time": "2011-10-26T09:33:44Z", "bug_id": 50570, "creation_time": "2011-10-26T09:33:44Z", "text": "Chris, did you put together an updated patch for this?"}, {"count": 21, "tags": [], "bug_id": 50570, "attachment_id": null, "id": 150942, "creation_time": "2011-10-26T18:44:18Z", "time": "2011-10-26T18:44:18Z", "creator": "chris@christopherschultz.net", "text": "(In reply to comment #20)\n> Chris, did you put together an updated patch for this?\n\nI have a patch sitting in my local svn working copy of TC 8 trunk: I haven't gotten a chance to test it, yet (building openssl-FIPS+apr proved to be a pain in the past, but I think I've got it working). I haven't yet made the changes suggested by Konstantin.\n\nI was a little concerned about the dependency on tcnative 1.1.23 which isn't yet released: 1.1.23 will have the native FIPS code required to make this Java patch work.\n\nShall I do tcnative-version-sniffing and bail if the version isn't high enough, or just let a native-method-not-found exception be thrown?", "is_private": false}, {"count": 22, "tags": [], "bug_id": 50570, "attachment_id": null, "id": 150943, "creation_time": "2011-10-26T19:09:37Z", "time": "2011-10-26T19:09:37Z", "creator": "markt@apache.org", "text": "Since this is security related, requesting FIPS and the native library not supporting it should prevent Tomcat from starting. You probably want to trap the exception and throw a new one with a nicer error message. I haven't looked at the code to see if anything else would be required.", "is_private": false}, {"count": 23, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "id": 151347, "time": "2011-11-09T21:54:01Z", "bug_id": 50570, "creation_time": "2011-11-09T21:54:01Z", "is_private": false, "text": "Fixed in trunk, will be in 7.0.23 and later.\nProposed for 6.0.x."}, {"count": 24, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "is_private": false, "id": 152397, "time": "2011-12-25T19:23:18Z", "bug_id": 50570, "creation_time": "2011-12-25T19:23:18Z", "text": "Fixed in 6.0 by r1224628 and will be in 6.0.36."}]