[{"attachment_id": null, "tags": [], "bug_id": 22915, "text": "The memcpy() at line 367 of apr_rmm_realloc which attempts to copy the old data\nto the newly allocated memory region is copying the newly requested number of\nbytes from the old region, which means if one uses realloc to grow a memory\nregion (presumably the more common case), then we would be reading past the end\nof the old memory region.  In cases where the old region were too close to the\nedge of the allocated shared memory, this would result in an attempt to read\noutside the process's memory space and thus result in a crash.  The correct\nnumber of bytes to copy is the min() of the requested size and the size of the\nold buffer.\n\nHere are diffs for a fix:\n\n*** apr_rmm.c   21 Apr 2003 18:42:02 -0000      1.20\n--- apr_rmm.c   3 Sep 2003 22:09:24 -0000\n***************\n*** 360,365 ****\n--- 360,367 ----\n  {\n      apr_rmm_off_t this;\n      apr_rmm_off_t old;\n+     struct rmm_block_t *blk;\n+     apr_size_t oldsize;\n  \n      if (!entity) {\n          return apr_rmm_malloc(rmm, reqsize);\n***************\n*** 372,379 ****\n          return this;\n      }\n  \n      memcpy(apr_rmm_addr_get(rmm, this),\n!            apr_rmm_addr_get(rmm, old), reqsize);\n      apr_rmm_free(rmm, old);\n  \n      return this;\n--- 374,384 ----\n          return this;\n      }\n  \n+     blk = (rmm_block_t*)((char*)rmm->base + old);\n+     oldsize = blk->size;\n+ \n      memcpy(apr_rmm_addr_get(rmm, this),\n!            apr_rmm_addr_get(rmm, old), oldsize < reqsize ? oldsize : reqsize);\n      apr_rmm_free(rmm, old);\n  \n      return this;", "count": 0, "id": 43685, "time": "2003-09-03T22:16:49Z", "creator": "shrauner@inktomi.com", "creation_time": "2003-09-03T22:16:49Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 22915, "is_private": false, "count": 1, "id": 47846, "time": "2003-11-21T18:28:29Z", "creator": "trawick@apache.org", "creation_time": "2003-11-21T18:28:29Z", "text": "making APR patch easily findable"}, {"count": 2, "tags": [], "creator": "trawick@apache.org", "attachment_id": null, "id": 54318, "time": "2004-03-20T21:34:06Z", "bug_id": 22915, "creation_time": "2004-03-20T21:34:06Z", "is_private": false, "text": "Thanks for the patch!  It has been committed to apr-util 1.0-dev and probably\nneeds to be backported to apr-util 0.9 as well.\n\n(leaving PR open until backported)\n"}, {"attachment_id": null, "tags": [], "bug_id": 22915, "is_private": false, "count": 3, "id": 54360, "time": "2004-03-22T01:00:19Z", "creator": "trawick@apache.org", "creation_time": "2004-03-22T01:00:19Z", "text": "backported to apr-util 0.9 branch...\n\nthanks again!"}]