[{"count": 0, "tags": [], "creator": "ebruno@solution-soft.com", "text": "apr-util/dbm/apr_sdbm_lock does not pass the APR_FLOCK_NONBLOCK flag to \napr_file_lock. This is because of the way type is tested in function.\n\nIt is minor change that will not affect exising code to allow \nAPR_FLOCK_NONBLOCK to passed through apr_sdbm_lock to apr_file_lock\n\ndiff shown below:\ndiff -C 3 sdbm_lock_old.c sdbm_lock.c\n*** sdbm_lock_old.c     Fri Feb 13 01:52:42 2004\n--- sdbm_lock.c Fri Apr 30 11:18:35 2004\n***************\n*** 21,30 ****\n  #include \"sdbm_tune.h\"\n\n  /* NOTE: this function blocks until it acquires the lock */\n! APU_DECLARE(apr_status_t) apr_sdbm_lock(apr_sdbm_t *db, int type)\n  {\n      apr_status_t status;\n!\n      if (!(type == APR_FLOCK_SHARED || type == APR_FLOCK_EXCLUSIVE))\n          return APR_EINVAL;\n\n--- 21,31 ----\n  #include \"sdbm_tune.h\"\n\n  /* NOTE: this function blocks until it acquires the lock */\n! APU_DECLARE(apr_status_t) apr_sdbm_lock(apr_sdbm_t *db, int intype)\n  {\n      apr_status_t status;\n!     int type;\n!     type = (intype & APR_FLOCK_TYPEMASK);\n      if (!(type == APR_FLOCK_SHARED || type == APR_FLOCK_EXCLUSIVE))\n          return APR_EINVAL;\n\n***************\n*** 46,52 ****\n       * zero size: either a fresh database, or one with a single,\n       * unsplit data page: dirpage is all zeros.\n       */\n!     if ((status = apr_file_lock(db->dirf, type)) == APR_SUCCESS)\n      {\n          apr_finfo_t finfo;\n          if ((status = apr_file_info_get(&finfo, APR_FINFO_SIZE, db->dirf))\n--- 47,53 ----\n       * zero size: either a fresh database, or one with a single,\n       * unsplit data page: dirpage is all zeros.\n       */\n!     if ((status = apr_file_lock(db->dirf, intype)) == APR_SUCCESS)\n      {\n          apr_finfo_t finfo;\n          if ((status = apr_file_info_get(&finfo, APR_FINFO_SIZE, db->dirf))", "id": 56705, "time": "2004-04-30T18:26:08Z", "bug_id": 28718, "creation_time": "2004-04-30T18:26:08Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "wrowe@apache.org", "text": "Mass reassign the 44 open apr-bugs to apr bug list", "id": 93820, "time": "2006-09-19T19:54:33Z", "bug_id": 28718, "creation_time": "2006-09-19T19:54:33Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "wrowe@apache.org", "attachment_id": null, "id": 96074, "time": "2006-11-22T06:30:32Z", "bug_id": 28718, "creation_time": "2006-11-22T06:30:32Z", "is_private": false, "text": "Here's my thought - flock nonblock wasn't supported yet - so beginning with 1.3.0\nwe apply this patch as a feature of 1.3 family?\n\nVersioning rules allow us to add new facilities in minor (1.X) bumps, while the\nremoval of features or binary ABI changes require major (2.0) bumps.\n\nA bug fix could be applied to any subversion, but in this case it's a behavior as\nopposed to a flaw.  So I'll commit this to trunk this weekend for 1.3.0."}, {"count": 3, "attachment_id": 20063, "bug_id": 28718, "text": "Created attachment 20063\nUpdated patch to trunk", "id": 102574, "time": "2007-04-27T14:06:22Z", "creator": "davi@apache.org", "creation_time": "2007-04-27T14:06:22Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "creator": "wrowe@apache.org", "is_private": false, "text": "I'm totally confused how the currently attached patch enables locks.\n\nIf it is ment to refuse share locks as input flags, it doesn't jive\nwith the title of this bug report.", "id": 103981, "time": "2007-06-01T15:30:39Z", "bug_id": 28718, "creation_time": "2007-06-01T15:30:39Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 28718, "is_private": false, "text": "(In reply to comment #4)\n> I'm totally confused how the currently attached patch enables locks.\n> \n> If it is ment to refuse share locks as input flags, it doesn't jive\n> with the title of this bug report.\n\nThe patch uses the APR_FLOCK_TYPEMASK mask to extract the lock type\n(shared or exclusive) and preserves the other bits -- in special, the\nAPR_FLOCK_NONBLOCK for apr_file_lock().", "id": 104040, "time": "2007-06-04T10:33:50Z", "creator": "davi@apache.org", "creation_time": "2007-06-04T10:33:50Z", "attachment_id": null}, {"count": 6, "tags": [], "creator": "davi@apache.org", "text": "Patch committed to trunk in revision 558403:\n\nhttp://svn.apache.org/viewvc?view=rev&revision=558403", "id": 105820, "time": "2007-07-21T17:15:07Z", "bug_id": 28718, "creation_time": "2007-07-21T17:15:07Z", "is_private": false, "attachment_id": null}]