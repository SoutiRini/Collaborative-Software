[{"count": 0, "tags": [], "bug_id": 55418, "attachment_id": null, "id": 169447, "time": "2013-08-14T20:23:21Z", "creator": "skunk@iSKUNK.ORG", "creation_time": "2013-08-14T20:23:21Z", "is_private": false, "text": "After a successful build of APR-util 1.5.1 (and APR 1.4.6 before that), I invoke \"make check\", which then fails as follows:\n\n/bin/bash /tmp/subversion-apr-build/_install/build-1/libtool --silent --mode=link cc   -Xa -v -xstrconst -i -mt -xtarget=opteron -xarch=amd64 -xbuiltin -xO5 -DHAVE_CONFIG_H -DSOLARIS2=10 -D_POSIX_PTHREAD_SEMANTICS  -D__EXTENSIONS__ -D_REENTRANT -I/tmp/subversion-apr-util-build/include -I/tmp/subversion-apr-util-build/include/private -I/nfs/freeport/src/subversion/subversion--1.8.1/apr-util/include/private -I/nfs/freeport/src/subversion/subversion--1.8.1/apr-util/include  -I/tmp/subversion-apr-build/_install/include/apr-1  -I/nfs/freeport/arch/sunos_x86_64/include -I/nfs/freeport/src/subversion/subversion--1.8.1/apr-util/xml/expat/lib       -no-install -L/nfs/freeport/arch/sunos_x86_64/lib -o dbd dbd.lo ../libaprutil-1.la /tmp/subversion-apr-util-build/xml/expat/libexpat.la /tmp/subversion-apr-build/_install/lib/libapr-1.la -luuid -lsendfile -lrt -lsocket -lnsl -lpthread\nUndefined                       first referenced\n symbol                             in file\natomic_swap_32                      /tmp/subversion-apr-build/_install/lib/libapr-1.a(solaris.o)\natomic_cas_ptr                      /tmp/subversion-apr-build/_install/lib/libapr-1.a(solaris.o)\natomic_swap_ptr                     /tmp/subversion-apr-build/_install/lib/libapr-1.a(solaris.o)\natomic_inc_32_nv                    /tmp/subversion-apr-build/_install/lib/libapr-1.a(solaris.o)\natomic_dec_32_nv                    /tmp/subversion-apr-build/_install/lib/libapr-1.a(solaris.o)\natomic_cas_32                       /tmp/subversion-apr-build/_install/lib/libapr-1.a(solaris.o)\nld: fatal: Symbol referencing errors. No output written to dbd\n*** Error code 1\nmake: Fatal error: Command failed for target `dbd'\nCurrent working directory /tmp/subversion-apr-util-build/test\n*** Error code 1\n\n\nAccording to APR's apr_arch_atomic.h, the Solaris-specific atomics code is used if the system is version 10 or later:\n\n    #elif defined(SOLARIS2) && SOLARIS2 >= 10\n    #   define USE_ATOMICS_SOLARIS\n\nAnd this system is definitely Solaris 10:\n\n    $ uname -a\n    SunOS darkstar 5.10 Generic i86pc i386 i86pc\n\nHowever, the above-listed functions are not present:\n\n    $ grep atomic_swap_32 /usr/include/atomic.h \n    $ grep atomic_swap_32 /usr/include/sys/atomic.h\n    $ gnu-grep -R atomic_swap_32 /usr/include\n    $\n\nSo it seems that APR's configure script should check whether or not these functions are available on a Solaris system, and if not, force the use of the generic atomic routines."}, {"count": 1, "tags": [], "creator": "guru@unixarea.de", "attachment_id": null, "id": 182298, "time": "2015-04-10T09:00:44Z", "bug_id": 55418, "creation_time": "2015-04-10T09:00:44Z", "is_private": false, "text": "I did a harcoded change and set:\n\n#elif defined(SOLARIS2) && SOLARIS2 >= 10\n#   define USE_ATOMICS_GENERIC\n\nin that include file; but the unresolved symbols are still there:\n\n# nm  /usr/local/sisis-pap/apache/lib/libaprutil-1.so.0.4.1 | fgrep atom                  \n[599]   |         0|         0|FUNC |GLOB |0    |UNDEF  |apr_atomic_dec32\n[497]   |         0|         0|FUNC |GLOB |0    |UNDEF  |apr_atomic_inc32\n[632]   |         0|         0|FUNC |GLOB |0    |UNDEF  |apr_atomic_read32\n[456]   |         0|         0|FUNC |GLOB |0    |UNDEF  |apr_atomic_set32\n\nthis need deeper analyzing;"}, {"count": 2, "tags": [], "creator": "ylavic.dev@gmail.com", "attachment_id": 32643, "is_private": false, "id": 182313, "time": "2015-04-10T20:55:22Z", "bug_id": 55418, "creation_time": "2015-04-10T20:55:22Z", "text": "Created attachment 32643\nDetect possible Solaris 10 breaches and force USE_ATOMICS_GENERIC\n\nLooks like (early?) Solaris 10 are missing some atomic functions exports to userland (Bug-ID 4954703 \"userland atomic.h port should include cas primitives\", Patch-ID 118884 or 118885 available, depending on CPU).\n\nWorkaround is ./configure --enable-nonportable-atomics=no ...\n\nPatch attached for future APR versions (possibly), can you give it a try?"}, {"count": 3, "tags": [], "bug_id": 55418, "attachment_id": null, "text": "I came up with the same fix/workaround and it worked for me on the affected Solris SPARC 10 system;", "id": 182348, "time": "2015-04-14T06:18:53Z", "creator": "guru@unixarea.de", "creation_time": "2015-04-14T06:18:53Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 55418, "attachment_id": null, "id": 182416, "time": "2015-04-16T04:23:42Z", "creator": "skunk@iSKUNK.ORG", "creation_time": "2015-04-16T04:23:42Z", "is_private": false, "text": "Thank you, Matthias.\n\nFor my part, the original system on which I got the error has been retired, and its replacement system---also Solaris 10---does appear to have the functions in question:\n\n    $ uname -a\n    SunOS darkstar2 5.10 Generic_147441-01 i86pc i386 i86pc\n\n    $ grep atomic_swap_32 /usr/include/sys/atomic.h\n    extern uint32_t atomic_swap_32(volatile uint32_t *, uint32_t);\n    extern uint32_t atomic_swap_32();\n\nThere is probably some point release or patch to 5.10 that adds these.\n\nSo the same versions of APR (1.4.6) and APR-util (1.5.1) build fine for me on this system (without --disable-nonportable-atomics), and the APR-util test suite passes clean. But the APR test suite does not:\n\n    Failed Tests            Total   Fail    Failed %\n    ===================================================\n    testsockets                 7      1     14.29%\n    testuser                    3      1     33.33%\n    Programs failed: testall\n\nSix of one, half-dozen of the other...."}, {"count": 5, "tags": [], "bug_id": 55418, "attachment_id": null, "text": "Committed in r1675668, backported to 1.6.x and 1.5.x.\nAvailable in upcoming 1.5.2.", "id": 182599, "time": "2015-04-23T18:17:02Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2015-04-23T18:17:02Z", "is_private": false}, {"count": 6, "tags": [], "creator": "trawick@apache.org", "attachment_id": null, "id": 182722, "time": "2015-04-29T14:17:33Z", "bug_id": 55418, "creation_time": "2015-04-29T14:17:33Z", "is_private": false, "text": "fixed in 1.5.2, to be announced today"}]