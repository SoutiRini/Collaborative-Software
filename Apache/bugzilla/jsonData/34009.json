[{"count": 0, "tags": [], "bug_id": 34009, "attachment_id": null, "id": 72387, "time": "2005-03-14T16:15:25Z", "creator": "public@wernig.net", "creation_time": "2005-03-14T16:15:25Z", "is_private": false, "text": "Hi\n\nI'v upgraded from 2.0.52 to 2.0.53 on Solaris9, using the same configure options\nfor both builds. gcc is 3.4.0 and 3.3.2 (happened on both servers).\nMPM=worker, 1 CPU\n\n\nI have \nRLimitCPU 30 60\nRLimitMEM 524288 1048576\n\nin the main httpd.conf. I suppose this applies to all children, then?\n\nWhile this worked fine under 2.0.52, after the upgrade all CGI scripts (perl,\nksh) get immediately killed on all virtual hosts.\nI get a 500 Premature end of script headers in the browser and error log.\nAdditionally, the error log (sometimes!) reports:\n\n[Sat Mar 12 21:50:39 2005] [error] [client a.b.c.d] ld.so.1: /usr/bin/ksh:\nfatal: /dev/zero: mmap anon failed: Not enough space\n\nThe same results from scripts running with suexec:\n[Mon Mar 14 15:49:36 2005] [error] [client w.x.y.z] ld.so.1:\n/usr/local/apache2/bin/suexec: fatal: /dev/zero: mmap anon failed: Not enough\nspace\n\nWhen I disable RLimitMEM in the main httpd.conf, the scripts run normally on all\nvirtual hosts. \nWhen I enable it selectively on specific virtual hosts, CGI scripts get killed\non those hosts only.\n\nThe RLimitCPU directive does not seem to have any effect on this behaviour.\nI've not checked though if it works at all.\n\n\n\nSome perhaps relevant lines of output from configure:\nsrclib/apr/config.log:configure:28748: result: decision on anonymous shared\nmemory allocation method... 4.4BSD-style mmap() via MAP_ANON\nsrclib/apr/config.log:configure:28451: checking for mmap that can map /dev/zero\nsrclib/apr/config.log:havemmapzero='1'\nsrclib/apr/config.log:usemmapzero='0'\nsrclib/apr/config.status:s,@usemmapzero@,0,;t t\nsrclib/apr/config.status:s,@havemmapzero@,1,;t t"}, {"count": 1, "tags": [], "bug_id": 34009, "text": "I noticed that the problem goes away (as far as I could test) if I rise the\nfirst value (soft limit) to 10MB. The second value (hard limit) does not seem to\ncount.\nRLimitMEM 5000000 15000000 doesn't work\nRLimitMEM 10000000 15000000  works\n\nSo now I (hastily) conclude that \neither\n\nthe scripts really do need that much memory (unlikely when looking at what they\ndo, though) and the limits were not enforced up to 2.0.53\n\nor\n\nsomehow mmap borks \n\nor\n\nanother behaviour changed in 2.0.53 (found nothing in the changelog)\n\nor\n\nsomehow the hard limit gets set to the soft limit\n\n[tbc]\n/m", "id": 72401, "time": "2005-03-14T18:17:49Z", "creator": "public@wernig.net", "creation_time": "2005-03-14T18:17:49Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 34009, "attachment_id": null, "text": "The soft limit is always the one that applies.  See, for example,\nhttp://www.die.net/doc/linux/man/man2/setrlimit.2.html\n\nAre you using mod_cgi or mod_cgid?  Which one where you using with your last\nbuild?  Are you sure that absolutely nothing else has changed between the two\nbuilds?", "id": 72411, "time": "2005-03-14T21:12:41Z", "creator": "slive@apache.org", "creation_time": "2005-03-14T21:12:41Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 34009, "text": "ok, i misunderstood the hard/soft limit concept. i suppose, the statements in\nthe link apply to solaris, too.\n\nand, yes, both mod_cgi and mod_cgid are compiled in, as they were before. no\nchanges were made to the configure options. but i did find a note in\n<srcdir>/CHANGES on RLimitMEM, that's not in the online changelog:\n:quote:\n  *) Linux 2.0 and above implement RLIMIT_AS, RLIMIT_DATA has almost no\n     effect.  Work around it by using RLIMIT_AS for the RLimitMEM\n     directive.  [Enrik Berkhan <enrik inka.de>] PR#1816\n:unquote:\n\nbtw: i now realize that the 500k/1MB limits for memory are quite restrictive.\nBut still, 10MB for every script is far too much in my eyes, especially if they\nare granted that memory upon execution, not dynamically as neede. This means\nthat at the latest 100 paralles script executions will block the server (1 GB\nmem), but in reality it'll be much earlier.", "id": 72415, "time": "2005-03-14T22:52:29Z", "creator": "public@wernig.net", "creation_time": "2005-03-14T22:52:29Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 34009, "text": "I'm not sure why you have both mod_cgi and mod_cgid.  You definitely want to be\nusing mod_cgid, because mod_cgi will fork processes that contain as many threads\nas the parent process.  This could easily explain the memory usage.", "id": 72448, "time": "2005-03-15T15:49:32Z", "creator": "slive@apache.org", "creation_time": "2005-03-15T15:49:32Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "creator": "public@wernig.net", "text": "Yes, compiling without mod_cgi fixes it. I can now set the RLimitMEM to the old\nvalues in the master config. I'll close this bug. It seems to be more of a\ndocumentation problem, as there remains some behaviour that's different between\n.52 and .53, which I didn't find in the changelog.", "id": 7493, "time": "2005-03-23T08:44:32Z", "bug_id": 34009, "creation_time": "2005-03-23T08:44:32Z", "is_private": false, "attachment_id": null}]