[{"count": 0, "tags": [], "bug_id": 40101, "is_private": false, "text": "I have a page which people POST data too.  I have blocked large blocks in\n.htaccess with \"Deny From\".  They seem to have archived the pages though, or\npeople are turning on proxies to post, but as soon as they POST from a banned\nIP, I get segfault in the logs and this error \"Additionally an error was\nencounted while...\" for the 403 request itself, which is just a plain .html page.\n\nThis is easy to reproduce, any POST form, surf to it, ban your IP in .htaccess,\nhit \"submit\" and you will see a segfault.\n\nThank you", "id": 91531, "time": "2006-07-24T10:06:40Z", "creator": "bchabot@amninc.net", "creation_time": "2006-07-24T10:06:40Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 40101, "text": "I cannot reproduce this. Please attach a backtrace of your segfault. For hints\nhow to create a proper backtrace please have a look at\nhttp://httpd.apache.org/dev/debugging.html.", "count": 1, "id": 91546, "time": "2006-07-24T14:47:35Z", "creator": "rpluem@apache.org", "creation_time": "2006-07-24T14:47:35Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 40101, "is_private": false, "text": "(In reply to comment #1)\n> I cannot reproduce this. Please attach a backtrace of your segfault. For hints\n> how to create a proper backtrace please have a look at\n> http://httpd.apache.org/dev/debugging.html.\n\nI hope this strace is enough, I can't make this drop a core, it's also very hard\nto attach to the child that's going to die (I suppose I could attach with gdb\nand start killing children like I did for this one).  \n\nIt only does this on POSTs to forms from IPs that are blocked, not on normal\npage requests even if the IP is blocked.  I am using suexec, chroot()'d,\nfastcgi, php.  But, this is a simple 403 request to a ErrorDocument\n/403_error.html, so I don't think any of that would interfere, and I'm almost\npositive it was doing this long before fastcgi and it's suexec wrapper.\n\nIt looks like it's segfaulting when it writes to the log?  At any rate, there is\nno log entry for the blocked IP.  (Also, I mangled the IPs and hostname, prolly\nnot well.. but meh.)\n\nThank you!\n\n------- STRACE FROM THE CHILD WHEN IT DIED -------\n\n15041 poll([{fd=4, events=POLLIN}, {fd=3, events=POLLIN, revents=POLLIN}], 2,\n-1) = 1\n15041 accept(3, {sa_family=AF_INET, sin_port=htons(43259),\nsin_addr=inet_addr(\"21.21.14.20\")}, [16]) = 69\n15041 semop(60719148, 0x402e7fd6, 1)    = 0\n15041 gettimeofday({1153764525, 36922}, NULL) = 0\n15041 getsockname(69, {sa_family=AF_INET, sin_port=htons(80),\nsin_addr=inet_addr(\"6.3.21.33\")}, [16]) = 0\n15041 gettimeofday({1153764525, 37085}, NULL) = 0\n15041 brk(0)                            = 0x82f0000\n15041 brk(0x82f2000)                    = 0x82f2000\n15041 fcntl64(69, F_GETFL)              = 0x2 (flags O_RDWR)\n15041 fcntl64(69, F_SETFL, O_RDWR|O_NONBLOCK) = 0\n15041 brk(0)                            = 0x82f2000\n15041 brk(0x82f4000)                    = 0x82f4000\n15041 read(69, 0x82f1e88, 8000)         = -1 EAGAIN (Resource temporarily\nunavailable)\n15041 poll([{fd=69, events=POLLIN, revents=POLLIN}], 1, 300000) = 1\n15041 read(69, \"POST /misc/add_review.php?id=51 \"..., 8000) = 1116\n15041 gettimeofday({1153764525, 39239}, NULL) = 0\n15041 semop(60686379, 0x402e7fd0, 1)    = 0\n15041 semop(60686379, 0x402e7fd6, 1)    = 0\n15041 semop(60686379, 0x402e7fd0, 1)    = 0\n15041 semop(60686379, 0x402e7fd6, 1)    = 0\n15041 gettimeofday({1153764525, 39580}, NULL) = 0\n15041 gettimeofday({1153764525, 39610}, NULL) = 0\n15041 stat64(\"/www/n/d/ndhost.net/html/misc/add_review.php\",\n{st_mode=S_IFREG|0755, st_size=14137, ...}) = 0\n15041 open(\"/www/n/d/ndhost.net/html/.htaccess\", O_RDONLY) = 71\n15041 brk(0)                            = 0x82f4000\n15041 brk(0x82f6000)                    = 0x82f6000\n15041 fstat64(71, {st_mode=S_IFREG|0775, st_size=6550, ...}) = 0\n15041 brk(0)                            = 0x82f6000\n15041 brk(0x82f9000)                    = 0x82f9000\n15041 read(71, \"#\\n# Apache/PHP/site settings:\\n#\\n\"..., 4096) = 4096\n15041 brk(0)                            = 0x82f9000\n15041 brk(0x82fc000)                    = 0x82fc000\n15041 read(71, \"doctor/(.*)$\\n  RewriteRule ^(.*)\"..., 4096) = 2454\n15041 brk(0)                            = 0x82fc000\n15041 brk(0x82fe000)                    = 0x82fe000\n15041 read(71, \"\", 4096)                = 0\n15041 brk(0)                            = 0x82fe000\n15041 brk(0x8300000)                    = 0x8300000\n15041 brk(0)                            = 0x8300000\n15041 brk(0x8301000)                    = 0x8301000\n15041 brk(0)                            = 0x8301000\n15041 brk(0x8303000)                    = 0x8303000\n15041 close(71)                         = 0\n15041 open(\"/www/n/d/ndhost.net/html/misc/.htaccess\", O_RDONLY) = -1 ENOENT (No\nsuch file or directory)\n15041 open(\"/www/n/d/ndhost.net/html/misc/add_review.php/.htaccess\", O_RDONLY) =\n-1 ENOTDIR (Not a directory)\n15041 brk(0)                            = 0x8303000\n15041 brk(0x8305000)                    = 0x8305000\n15041 gettimeofday({1153764525, 42933}, NULL) = 0\n15041 write(15, \"[Mon Jul 24 14:08:45 2006] [erro\"..., 187) = 187\n15041 semop(60686379, 0x402e7fd0, 1)    = 0\n15041 semop(60686379, 0x402e7fd6, 1)    = 0\n15041 semop(60686379, 0x402e7fd0, 1)    = 0\n15041 semop(60686379, 0x402e7fd6, 1)    = 0\n15041 stat64(\"/www/n/d/ndhost.net/html/403_error.html\", {st_mode=S_IFREG|0775,\nst_size=524, ...}) = 0\n15041 open(\"/www/n/d/ndhost.net/html/403_error.html/.htaccess\", O_RDONLY) = -1\nENOTDIR (Not a directory)\n15041 gettimeofday({1153764525, 43353}, NULL) = 0\n15041 write(15, \"[Mon Jul 24 14:08:45 2006] [erro\"..., 182) = 182\n15041 brk(0)                            = 0x8305000\n15041 brk(0x8307000)                    = 0x8307000\n15041 brk(0)                            = 0x8307000\n15041 brk(0x8309000)                    = 0x8309000\n15041 brk(0)                            = 0x8309000\n15041 brk(0x830b000)                    = 0x830b000\n15041 read(69, 0x8308a30, 8000)         = -1 EAGAIN (Resource temporarily\nunavailable)\n15041 writev(69, [{\"HTTP/1.1 403 Forbidden\\r\\nDate: Mo\"..., 201}, {\"<!DOCTYPE\nHTML PUBLIC \\\"-//IETF//\"..., 402}], 2) = 603\n15041 gettimeofday({1153764525, 43948}, NULL) = 0\n15041 write(43, \"21.21.14.20 - - [24/Jul/2006\"..., 228) = 228\n15041 --- SIGSEGV (Segmentation fault) @ 0 (0) ---\n15041 chdir(\"/tmp\")                     = 0\n15041 rt_sigaction(SIGSEGV, {SIG_DFL}, {SIG_DFL}, 8) = 0\n15041 getpid()                          = 15041\n15041 getpid()                          = 15041\n15041 kill(15041, SIGSEGV)              = 0\n15041 sigreturn()                       = ? (mask now [RTMIN])\n15041 --- SIGSEGV (Segmentation fault) @ 0 (0) ---", "id": 91551, "time": "2006-07-24T18:22:12Z", "creator": "bchabot@amninc.net", "creation_time": "2006-07-24T18:22:12Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 40101, "is_private": false, "count": 3, "id": 91552, "time": "2006-07-24T19:00:50Z", "creator": "rpluem@apache.org", "creation_time": "2006-07-24T19:00:50Z", "text": "Sorry but the strace does not really help. It seems to me that it tries to write\na core dump to the /tmp directory. Please set ulimit -c to unlimited in\napachectl. On Linux systems ulimit -c often defaults to 0 which prevents core\ndumping."}, {"count": 4, "tags": [], "creator": "bchabot@amninc.net", "attachment_id": null, "text": "Alright,  got it to core, and gdb \"bt full\"  I hope this is more helpful!!\n\n----------------\n\ngdb /usr/local/apache/bin/httpd /tmp/core.21101 \nGNU gdb Red Hat Linux (5.3post-0.20021129.18rh)\nCopyright 2003 Free Software Foundation, Inc.\nGDB is free software, covered by the GNU General Public License, and you are\nwelcome to change it and/or distribute copies of it under certain conditions.\nType \"show copying\" to see the conditions.\nThere is absolutely no warranty for GDB.  Type \"show warranty\" for details.\nThis GDB was configured as \"i386-redhat-linux-gnu\"...\nCore was generated by `/usr/local/apache/bin/httpd -f /etc/conf/httpd/httpd2.conf'.\nProgram terminated with signal 11, Segmentation fault.\nReading symbols from /usr/local/ssl/lib/libssl.so.0.9.7...done.\nLoaded symbols for /usr/local/ssl/lib/libssl.so.0.9.7\nReading symbols from /usr/local/ssl/lib/libcrypto.so.0.9.7...done.\nLoaded symbols for /usr/local/ssl/lib/libcrypto.so.0.9.7\nReading symbols from /usr/kerberos/lib/libgssapi_krb5.so.2...done.\nLoaded symbols for /usr/kerberos/lib/libgssapi_krb5.so.2\nReading symbols from /usr/kerberos/lib/libkrb5.so.3...done.\nLoaded symbols for /usr/kerberos/lib/libkrb5.so.3\nReading symbols from /usr/kerberos/lib/libcom_err.so.3...done.\nLoaded symbols for /usr/kerberos/lib/libcom_err.so.3\nReading symbols from /usr/kerberos/lib/libk5crypto.so.3...done.\nLoaded symbols for /usr/kerberos/lib/libk5crypto.so.3\nReading symbols from /lib/libresolv.so.2...done.\nLoaded symbols for /lib/libresolv.so.2\nReading symbols from /usr/lib/libz.so.1...done.\nLoaded symbols for /usr/lib/libz.so.1\nReading symbols from /usr/local/apache-2.0.55/lib/libaprutil-0.so.0...done.\nLoaded symbols for /usr/local/apache-2.0.55/lib/libaprutil-0.so.0\nReading symbols from /usr/lib/libgdbm.so.2...done.\nLoaded symbols for /usr/lib/libgdbm.so.2\nReading symbols from /lib/libdb-4.0.so...done.\nLoaded symbols for /lib/libdb-4.0.so\nReading symbols from /usr/lib/libexpat.so.0...done.\nLoaded symbols for /usr/lib/libexpat.so.0\nReading symbols from /usr/local/apache-2.0.55/lib/libapr-0.so.0...done.\nLoaded symbols for /usr/local/apache-2.0.55/lib/libapr-0.so.0\n---Type <return> to continue, or q <return> to quit---\nReading symbols from /lib/librt.so.1...done.\nLoaded symbols for /lib/librt.so.1\nReading symbols from /lib/libm.so.6...done.\nLoaded symbols for /lib/libm.so.6\nReading symbols from /lib/libcrypt.so.1...done.\nLoaded symbols for /lib/libcrypt.so.1\nReading symbols from /lib/libnsl.so.1...done.\nLoaded symbols for /lib/libnsl.so.1\nReading symbols from /lib/libpthread.so.0...done.\nLoaded symbols for /lib/libpthread.so.0\nReading symbols from /lib/libdl.so.2...done.\nLoaded symbols for /lib/libdl.so.2\nReading symbols from /lib/libc.so.6...done.\nLoaded symbols for /lib/libc.so.6\nReading symbols from /lib/ld-linux.so.2...done.\nLoaded symbols for /lib/ld-linux.so.2\nReading symbols from /lib/libnss_files.so.2...done.\nLoaded symbols for /lib/libnss_files.so.2\nReading symbols from /usr/local/apache/modules/mod_frontpage.so...done.\nLoaded symbols for /usr/local/apache/modules/mod_frontpage.so\nReading symbols from /usr/local/apache/modules/mod_watch.so...done.\nLoaded symbols for /usr/local/apache/modules/mod_watch.so\nReading symbols from /usr/local/apache/modules/mod_fastcgi.so...done.\nLoaded symbols for /usr/local/apache/modules/mod_fastcgi.so\n#0  0x0809edbb in ap_strcasecmp_match (str=0x0, \n    expected=0x404dcb06 \"text/html\") at util.c:203\n203\t        if (!str[x] && expected[y] != '*')\n(gdb) bt full\n#0  0x0809edbb in ap_strcasecmp_match (str=0x0, \n    expected=0x404dcb06 \"text/html\") at util.c:203\n\tx = 0\n\ty = 0\n#1  0x404d9a8b in watchCounters (r=0x82f3eb0) at mod_watch.c:554\n\tdata = (struct shEntry *) 0x82f3a90\n\twc = (watchConnectionIO *) 0x82f2210\n#2  0x404da35b in watchLog (r=0x82f3eb0) at mod_watch.c:916\n\tkey = 0x1 <Address 0x1 out of bounds>\n\tdata = (struct shEntry *) 0x20\n\tdconf = (struct watchConfDir *) 0x811cf00\n#3  0x080a74d2 in ap_run_log_transaction (r=0x82f3eb0) at protocol.c:1549\n\tpHook = (ap_LINK_log_transaction_t *) 0x0\n\tn = 1\n\trv = 0\n#4  0x08082771 in ap_process_request (r=0x82f3eb0) at http_request.c:274\n\taccess_status = 0\n#5  0x0807e6a1 in ap_process_http_connection (c=0x82e9cc0) at http_core.c:251\n\tr = (request_rec *) 0x82f3eb0\n\tcsd_set = 1\n\tcsd = (apr_socket_t *) 0x82e9be8\n#6  0x080a29b2 in ap_run_process_connection (c=0x82e9cc0) at connection.c:43\n\tpHook = (ap_LINK_process_connection_t *) 0x5\n---Type <return> to continue, or q <return> to quit---\n\tn = 0\n\trv = 5\n#7  0x08097fbb in child_main (child_num_arg=5) at prefork.c:610\n\tptrans = (apr_pool_t *) 0x82e9bb0\n\tallocator = (apr_allocator_t *) 0x82e7b20\n\tcurrent_conn = (conn_rec *) 0x82e9cc0\n\tstatus = 137272512\n\ti = 0\n\tlr = (ap_listen_rec *) 0x82e9cc0\n\tcurr_pollfd = 0\n\tlast_pollfd = 1\n\tpollset = (apr_pollfd_t *) 0x82e7c50\n\toffset = 5\n\tcsd = (void *) 0x82e9be8\n\tsbh = (ap_sb_handle_t *) 0x82e7c20\n\trv = 5\n\tbucket_alloc = (apr_bucket_alloc_t *) 0x82ede60\n#8  0x080980d8 in make_child (s=0x80e4218, slot=0) at prefork.c:704\n\tpid = 0\n#9  0x080981bf in startup_children (number_to_start=10) at prefork.c:722\n\ti = 0\n#10 0x080988cd in ap_mpm_run (_pconf=0x0, plog=0x8117130, s=0x80e4218)\n    at prefork.c:941\n---Type <return> to continue, or q <return> to quit---\n\tindex = 137272512\n\tremaining_children_to_start = 10\n\trv = 5\n#11 0x0809d956 in main (argc=3, argv=0xbfffeaf4) at main.c:618\n\tc = 102 'f'\n\tconfigtestonly = 0\n\tconfname = 0xbfffff50 \"/etc/conf/httpd/httpd2.conf\"\n\tdef_server_root = 0x80c99c4 \"/usr/local/apache-2.0.55\"\n\ttemp_error_log = 0x0\n\tprocess = (process_rec *) 0x80dd0c8\n\tserver_conf = (server_rec *) 0x80e4218\n\tpglobal = (apr_pool_t *) 0x80dd048\n\tpconf = (apr_pool_t *) 0x80df050\n\tplog = (apr_pool_t *) 0x8117130\n\tptemp = (apr_pool_t *) 0x811d148\n\tpcommands = (apr_pool_t *) 0x80e1058\n\topt = (apr_getopt_t *) 0x80e10f0\n\trv = 5\n\tmod = (module **) 0x80e4218\n\toptarg = 0xbfffff50 \"/etc/conf/httpd/httpd2.conf\"\n\tsignal_server = (apr_OFN_ap_signal_server_t *) 0\n#12 0x403c462d in __libc_start_main () from /lib/libc.so.6\nNo symbol table info available.\n(gdb) quit\n\u001b]0;root@berkana:/tmp [root@berkana tmp]# ", "id": 91556, "time": "2006-07-24T21:14:54Z", "bug_id": 40101, "creation_time": "2006-07-24T21:14:54Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 40101, "text": "(In reply to comment #4)\n> Alright,  got it to core, and gdb \"bt full\"  I hope this is more helpful!!\n\nThanks, yes it is, but maybe not in the way you hoped :-).\n\n\n> Reading symbols from /usr/local/apache/modules/mod_watch.so...done.\n> Loaded symbols for /usr/local/apache/modules/mod_watch.so\n> Reading symbols from /usr/local/apache/modules/mod_fastcgi.so...done.\n> Loaded symbols for /usr/local/apache/modules/mod_fastcgi.so\n> #0  0x0809edbb in ap_strcasecmp_match (str=0x0, \n>     expected=0x404dcb06 \"text/html\") at util.c:203\n> 203\t        if (!str[x] && expected[y] != '*')\n> (gdb) bt full\n> #0  0x0809edbb in ap_strcasecmp_match (str=0x0, \n>     expected=0x404dcb06 \"text/html\") at util.c:203\n> \tx = 0\n> \ty = 0\n> #1  0x404d9a8b in watchCounters (r=0x82f3eb0) at mod_watch.c:554\n> \tdata = (struct shEntry *) 0x82f3a90\n> \twc = (watchConnectionIO *) 0x82f2210\n\nThe bug is in your third party module mod_watch. It calls ap_strcasecmp_match\nwith a NULL pointer as first parameter. This causes a SIGSEGV.\n=> invalid", "count": 5, "id": 91558, "time": "2006-07-24T21:23:33Z", "creator": "rpluem@apache.org", "creation_time": "2006-07-24T21:23:33Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 40101, "attachment_id": null, "id": 91561, "time": "2006-07-24T23:48:04Z", "creator": "bchabot@amninc.net", "creation_time": "2006-07-24T23:48:04Z", "is_private": false, "text": "(In reply to comment #5)\n> (In reply to comment #4)\n> > Alright,  got it to core, and gdb \"bt full\"  I hope this is more helpful!!\n> \n> Thanks, yes it is, but maybe not in the way you hoped :-).\n> \n\nAs long as I know what it is, I'm happy. =)\n\nThanks, and sorry for making you troubleshoot something that wasn't really Apache!\n\n"}]