[{"count": 0, "tags": [], "creator": "DRuggeri@primary.net", "text": "Created attachment 24576\nAdds dynamic locking callbacks to TCNative for use by openssl engines\n\nHello;\n   The attached patch adds dynamic locking callbacks needed by certain engines in OpenSSL (chil, specifically). Most of this code was poached from HTTPD 2.2.x mod_ssl (ssl_util.c). The notable differences to TCNative after applying the patch are that the call to ssl_thread_setup had to be moved before the engine is initialized since the callbacks must be set before engine init, and the dynamic callback functions were added to ssl_thread_setup.\n\nThe issue:\nWhen utilizing an OpenSSL engine that requires the locking callback, no locks will be found causing the vendor's native library to exit. When using chil, this only happens when an assertion fails and detects that multiple threads are active, but no upcalls are provided. I am unsure what other engines require this functionality.\n\nThe solution:\nAdd the callback functions to use APR locks. Register them with OpenSSL via the CRYPTO_set_dyn..... functions.\n\n\nNote:\nThis is the first TCNative patch I have submitted and was informed that there should be a xdocs/miscellaneous/changelog.xml file. This patch is against the tomcat-native-1.1.16-src.tar.gz file which does not include such a document. In any event, I think the CHANGELOG.txt entry should read:\nImprovement: Add dynamic locking callbacks for openssl engines (druggeri)", "id": 132184, "time": "2009-11-20T13:40:32Z", "bug_id": 48253, "creation_time": "2009-11-20T13:40:32Z", "is_private": false, "attachment_id": 24576}, {"count": 1, "tags": [], "bug_id": 48253, "text": "Patch looks good except that there shouldn't be any\nstatic ... function/type declarations inside .h files.\n\nJust copy that from ssl_private.h directly to the ssl.c\nand only for the forward declarations.", "id": 135673, "time": "2010-03-26T14:41:51Z", "creator": "mturk@apache.org", "creation_time": "2010-03-26T14:41:51Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 48253, "text": "(In reply to comment #1)\n> Patch looks good except that there shouldn't be any\n> static ... function/type declarations inside .h files.\n> \n> Just copy that from ssl_private.h directly to the ssl.c\n> and only for the forward declarations.\n\nThank you for your time, Mladen. I have updated the patch against the latest source distribution (1.1.20) and moved the proposed content of ssl_private.h to the lines immediately preceding the proposed functions in ssl.c. Please let me know if I misunderstood your directive, or if things are OK. Should I have also moved the CRYPTO_dynlock_value struct to ssl_private.h?", "id": 135752, "time": "2010-03-29T14:07:12Z", "creator": "DRuggeri@primary.net", "creation_time": "2010-03-29T14:07:12Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 48253, "is_private": false, "text": "Created attachment 25206\nUpdated patch - moves proposed changes from ssl_private.h to ssl.c", "id": 135756, "time": "2010-03-29T14:11:08Z", "creator": "DRuggeri@primary.net", "creation_time": "2010-03-29T14:11:08Z", "attachment_id": 25206}, {"count": 4, "tags": [], "bug_id": 48253, "attachment_id": null, "is_private": false, "id": 143159, "time": "2011-01-07T03:01:23Z", "creator": "jfclere@gmail.com", "creation_time": "2011-01-07T03:01:23Z", "text": "Fixed by svn commit: r1055907"}]