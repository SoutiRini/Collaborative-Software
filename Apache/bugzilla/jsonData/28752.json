[{"count": 0, "tags": [], "bug_id": 28752, "is_private": false, "text": "Hello,\n\nI have been working in some optimizations in the xml security library; this\noptimization has reduced the memory foot print & speed up the signing &\nverification of big XML documents. The speed-up ratio varies enormously between\ntests case. Some simple ones (verified a signed Liberty LogoutRequest wrapped in\na SOAP enveloped) accomplish in half time, the opensaml assertion test got a\n<10% and a modified opensaml POSTProfile (where only the assertions are signed)\ngot a 15%-20% speed-up. Our Liberty implementation case got a 40% speed-up from\nthe 1.1 release. So it\u2019s very document dependant.\n\n            The changes are a big path file of 168.243 bytes that can be\nsummarized in four parts:\n\n    * C14N rewrite: I\u2019ll see that a big part of time is gone in the\ncanonicalization. This part is our biggest time hog: So I have more or less\nrewrite it using a name spaces table approach. As I descend the document nodes I\nfill a name space table with the xmlns definitions and whether are rendered in\nc14n tree or not.\n      The old method relay of having the doc tree circumvented (i.e. have all\nthe namespaces of the parent copies in all of its children) and then look upward\nin the tree (using the getParent() DOM function) to see if a current namespace\nhad been already rendered. This method is memory expensive (it creates a new\nattribute for every namespace defined in a parent node) and not very efficient\nfor big tree documents. The new one seems better in these two aspects. But the\nspeed improvements depend of the specific DOM tree.\n      These changes permit to get rid of a lot of calls to circumventeBug2650\n      These changes are the 60% of the patch. And impact only: \norg/apache/xml/security/c14n/implementations/*\n\n    * Remove all unnecessary use of XPath API: It seems that using XPath is slow\nand memory tax. So I have try to change all the xpath calls for their equivalent\nin DOM. These have decrease the memory usage a little and improve a little the\nspeed (the bigger ones where already changed in 1.1). These changes impact: (See\n(1))\n    * Trying to don\u2019t use XMLSignatureInput with nodesets: I have tried to don\u2019t\nused XMLSignatureInput with a set of nodes but in the xpath transformation.\nNormally the reference node specifies a node not a nodeset, only if there is a\nxpath transformation a nodeset is needed. The use of a node instead of a nodeset\nis better for memory purpose and permit to canonicalize using c14nSubtree\ninstead of c14Xpathnodeset, the latter need to visit every node in the document\ntree, the former only the node & its children.\n      The problem is that if the enveloped signature transformation is used a\nnodeset is needed again. In order to fix it, I have added a new field to the\nXMLSignatureInput and added new functions to c14n classes to specified a exclude\nnode in the subtree(this way the c14n only skips the exclude node when it finds\nit). This change impacts: (See (2))\n    * Miscellaneous changes: In org/apache/xml/security/signature/Reference.java\nsome time is spend calculating the _transformsInput field in every deference\n(when signing or verifying a reference) this field is seldom used (only for\ndebugging purpouse) so it\u2019s better to calculate it only when required.\n      Other little change can be done in\norg/apache/xml/security/signature/SignedInfo.java to don\u2019t do the\ncannonicalization and the parse of importing of the signedinfo element if safe\nc14n methods are used (these safes are the standard ones).\n\n \n\nSo if there is some interest I can contribute back these changes, so it can be\npeer reviewed and fixed if needed. Or if any one want to test without the fuss\nof recompilling  I can send him the .jar file with the modified library.\n\n \n\nRegards,\n\n \n\nRaul Benito\n\n\np.s- Sorry for the big email in html but it reads better.\n\n\n1:\n\n    * org/apache/xml/security/keys/content/KeyValue.java\n    * org/apache/xml/security/keys/content/RetrievalMethod.java\n    *\norg/apache/xml/security/keys/keyresolver/implementations/DSAKeyValueResolver.java\n    *\norg/apache/xml/security/keys/keyresolver/implementations/RSAKeyValueResolver.java\n    *\norg/apache/xml/security/keys/keyresolver/implementations/X509CertificateResolver.java\n    * org/apache/xml/security/keys/keyresolver/implementations/X509SKIResolver.java\n    *\norg/apache/xml/security/keys/keyresolver/implementations/X509SubjectNameResolver.java\n    * org/apache/xml/security/signature/SignatureProperties.java\n    * org/apache/xml/security/signature/XMLSignature.java\n    * org/apache/xml/security/transforms/Transforms.java (Already use a DOM\nmethod only refactor to invoke a common one).\n    * org/apache/xml/security/utils/ElementProxy.java\n    * org/apache/xml/security/utils/SignatureElementProxy.java\n    * org/apache/xml/security/utils/XMLUtils.java (Added the functions to do the\nDOM searches).\n\n\n2:\n\n    * org/apache/xml/security/signature/XMLSignatureInput.java       \n    * org/apache/xml/security/transforms/implementations/TransformC14N.java\n    * org/apache/xml/security/transforms/implementations/TransformC14NExclusive.java\n    *\norg/apache/xml/security/transforms/implementations/TransformC14NExclusiveWithComments.java\n    *\norg/apache/xml/security/transforms/implementations/TransformEnvelopedSignature.java\n(and also move some methods XMLUtils)\n    * org/apache/xml/security/utils/IdResolver.java\n    * org/apache/xml/security/utils/SignatureElementProxy.java\n    * org/apache/xml/security/utils/resolver/implementations/ResolverFragment.java\n    * org/apache/xml/security/utils/resolver/implementations/ResolverXPointer.java\n    * org/apache/xml/security/utils/XMLUtils.java (Added some methods)\n    * (and the c14n implementations but these have been take on account above).", "id": 56771, "time": "2004-05-03T21:16:16Z", "creator": "raul-info@r-bg.com", "creation_time": "2004-05-03T21:16:16Z", "attachment_id": null}, {"text": "Created attachment 11417\nA new patch", "tags": [], "bug_id": 28752, "is_private": false, "count": 1, "id": 56772, "time": "2004-05-03T21:19:19Z", "creator": "raul-info@r-bg.com", "creation_time": "2004-05-03T21:19:19Z", "attachment_id": 11417}, {"count": 2, "tags": [], "creator": "raul-info@r-bg.com", "attachment_id": 11443, "is_private": false, "id": 56901, "time": "2004-05-05T22:27:34Z", "bug_id": 28752, "creation_time": "2004-05-05T22:27:34Z", "text": "Created attachment 11443\nMore documentation, code clean-up."}, {"count": 3, "tags": [], "creator": "blautenb@apache.org", "attachment_id": null, "is_private": false, "id": 56919, "time": "2004-05-06T11:31:33Z", "bug_id": 28752, "creation_time": "2004-05-06T11:31:33Z", "text": "Raul,\n\nI've tried applying these, but I get the following error\n\nberin@pluto:src$ patch -p0 < ~/tmp/raul.patch \npatching file\norg/apache/xml/security/c14n/implementations/Canonicalizer20010315.java\npatching file\norg/apache/xml/security/c14n/implementations/Canonicalizer20010315Excl.java\nHunk #1 FAILED at 1.\n1 out of 1 hunk FAILED -- saving rejects to file\norg/apache/xml/security/c14n/implementations/Canonicalizer20010315Excl.java.rej\n<SNIP>.\n\nAll the other files work - the problem only seems to be 20010315Excl.java\n\nGiven it looks like you are doing a CVS diff, I'm not sure what's going on. \nCould you send me a copy of the file with all the changes?  And I'll add directly.\n\nCheers,\n     Berin\n"}, {"text": "Created attachment 11448\nCanonicalizer20010315Excl.java file. NOT A patch", "tags": [], "bug_id": 28752, "is_private": false, "count": 4, "id": 56935, "time": "2004-05-06T16:31:07Z", "creator": "raul-info@r-bg.com", "creation_time": "2004-05-06T16:31:07Z", "attachment_id": 11448}, {"count": 5, "tags": [], "creator": "blautenb@apache.org", "attachment_id": null, "is_private": false, "id": 57052, "time": "2004-05-09T12:23:57Z", "bug_id": 28752, "creation_time": "2004-05-09T12:23:57Z", "text": "Raul,\n\nI've applied the patches, but I'm getting failed unit tests when I run \"and\ntest\".  Haven't yet had time to look through and find where, but have you run a\ntest against the codebase?\n\nI'm also getting log4j errors, but I'm wondering if that's my codebase (I might\nhave something else strange somewhere).\n\nCheers,\n     Berin\n"}, {"count": 6, "tags": [], "creator": "dims@yahoo.com", "attachment_id": null, "is_private": false, "id": 57055, "time": "2004-05-09T15:39:17Z", "bug_id": 28752, "creation_time": "2004-05-09T15:39:17Z", "text": "Berin,\n\ni did the same...got only one failure. test_sixteen_external_dsa in\norg.apache.xml.security.test.interop.BaltimoreTest. \n\n=============================================================================\nDid not find a public key, so I can't check the signature\n\njava.lang.RuntimeException: Did not find a public key, so I can't check the\nsignature at org.apache.xml.security.test.interop.InteropTest.verify(Unknown\nSource) at\norg.apache.xml.security.test.interop.BaltimoreTest.test_sixteen_external_dsa(Unknown\nSource) at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) at\nsun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39) at\nsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n=============================================================================\n\n=============================================================================\nMay 9, 2004 10:37:46 AM org.apache.xml.security.signature.Reference verify\nINFO: Verification successful for URI \"#object\"\nMay 9, 2004 10:37:46 AM org.apache.xml.security.signature.Reference verify\nINFO: Verification successful for URI \"#object\"\nMay 9, 2004 10:37:47 AM org.apache.xml.security.signature.Reference verify\nINFO: Verification successful for URI \"\"\nMay 9, 2004 10:37:47 AM org.apache.xml.security.signature.Reference verify\nINFO: Verification successful for URI \"#object\"\nMay 9, 2004 10:37:47 AM org.apache.xml.security.signature.Reference verify\nINFO: Verification successful for URI \"#object\"\nMay 9, 2004 10:37:48 AM org.apache.xml.security.signature.Reference verify\nINFO: Verification successful for URI \"#object\"\nMay 9, 2004 10:37:48 AM org.apache.xml.security.signature.Reference verify\nINFO: Verification successful for URI\n\"http://xmldsig.pothole.com/xml-stylesheet.txt\"\nMay 9, 2004 10:37:48 AM org.apache.xml.security.signature.Reference verify\nINFO: Verification successful for URI \"http://www.w3.org/TR/xml-stylesheet\"\nMay 9, 2004 10:37:49 AM org.apache.xml.security.test.interop.BaltimoreTest\ntest_sixteen_external_dsa\nSEVERE: Verification crashed for\nC:\\APACHE\\xml-security/data/ie/baltimore/merlin-examples/merlin-xmldsig-sixteen/signature.xml\n============================================================================="}, {"count": 7, "tags": [], "text": "Berin,\n   I had three fails at home and 4 errors:\n*test34subtree(org.apache.xml.security.test.c14n.implementations.Canonicalizer20010315Test)\n      3.4 Character Modifications and Character\n*test34subset(org.apache.xml.security.test.c14n.implementations.Canonicalizer20010315Test)\n      3.4 Character Modifications and Character References. (uncommented,\npatched to run on validating Parsers)\n*test37(org.apache.xml.security.test.c14n.implementations.Canonicalizer20010315Test)\n      3.7 Document Subsets. (uncommented)\n   \n  But none fails at work and the same four errors. I think that the four errors\nwhere some data file I haven't download, so i don't look it very deep. So I\ninvestigate the fails thing a little and it seems it is something related to\nwhitespace remove in the value part of an attribute.\n\nSo I begin to blame the xerces or JDK version. But it was none of this. For\ntesting the opensaml I put at home in jre endorsed libs the \ndom3-xercesImpl-2.5.0.jar  dom3-xml-apis-2.5.0.jar and after removing this files\neverything the fails have dispair.\n\nPerhaps do you have the same problem.\n\nRegarding the errors I look at it more deep & i download the ibm files and set\ncorrectly the basedir property(something that can be automaticly done in the\nalltests). And everything has run fine but the external_dsa I'm having a look\nand i detect where It fail already. I will try to fix it in a couple of hours.\n\n\nRegards\n", "attachment_id": null, "bug_id": 28752, "id": 57058, "time": "2004-05-09T18:04:50Z", "creator": "raul-info@r-bg.com", "creation_time": "2004-05-09T18:04:50Z", "is_private": false}, {"count": 8, "tags": [], "creator": "raul-info@r-bg.com", "attachment_id": 11476, "is_private": false, "id": 57059, "time": "2004-05-09T19:19:57Z", "bug_id": 28752, "creation_time": "2004-05-09T19:19:57Z", "text": "Created attachment 11476\nFix a bug in the RetrivalMethod keyresolver."}, {"count": 9, "tags": [], "creator": "raul-info@r-bg.com", "attachment_id": 11478, "id": 57062, "time": "2004-05-09T21:42:29Z", "bug_id": 28752, "creation_time": "2004-05-09T21:42:29Z", "is_private": false, "text": "Created attachment 11478\nOptimize the c14nwithcomments transformation"}, {"count": 10, "tags": [], "creator": "dims@yahoo.com", "attachment_id": null, "id": 57063, "time": "2004-05-09T22:18:37Z", "bug_id": 28752, "creation_time": "2004-05-09T22:18:37Z", "is_private": false, "text": "Raul,\n\ncan you please do a fresh complete \"cvs diff -u\" (from the xml-security)\ndirectory and post the diff.\n\nthanks,\ndims"}, {"count": 11, "tags": [], "creator": "raul-info@r-bg.com", "attachment_id": 11481, "is_private": false, "id": 57064, "time": "2004-05-09T22:54:06Z", "bug_id": 28752, "creation_time": "2004-05-09T22:54:06Z", "text": "Created attachment 11481\nAgain the big patch"}, {"count": 12, "tags": [], "text": "Raul,\n\nhad a few emails with Berin. Bottom line, we need merlin 16 working to accept\nthis patch.\n\nthanks,\ndims", "attachment_id": null, "bug_id": 28752, "id": 57073, "time": "2004-05-10T10:46:43Z", "creator": "dims@yahoo.com", "creation_time": "2004-05-10T10:46:43Z", "is_private": false}, {"count": 13, "tags": [], "text": "Well, I finally have made all tests running. The problem was not the parse &\nreimporting of the SignedInfo data. But that I have forgot to remove the\ncomments node when fragment resolver is used(BIG ERROR from me part). After\nfixing it, and some small bugs in c14n inclusive and xpathnodeset, all the 88\ntests have passed.\n\nRegards,", "attachment_id": null, "bug_id": 28752, "id": 57147, "time": "2004-05-11T06:26:42Z", "creator": "raul-info@r-bg.com", "creation_time": "2004-05-11T06:26:42Z", "is_private": false}, {"count": 14, "tags": [], "text": "Created attachment 11510\nPass all the 88 tests", "attachment_id": 11510, "bug_id": 28752, "id": 57148, "time": "2004-05-11T06:31:34Z", "creator": "raul-info@r-bg.com", "creation_time": "2004-05-11T06:31:34Z", "is_private": false}, {"count": 15, "tags": [], "creator": "blautenb@apache.org", "attachment_id": null, "is_private": false, "id": 57195, "time": "2004-05-11T12:26:10Z", "bug_id": 28752, "creation_time": "2004-05-11T12:26:10Z", "text": "Brilliant!  I've loaded the patch against a clean checkout of the codebase and\nit works beautifully.\n\nI just want to do a once over to make sure I understand what's in there, and I\nwill check in (hopefully tomorrow night).\n\nAgain - many thanks for this one.  I can see a huge amount of effort, and thanks\nfor covering off the failing unit tests.\n\nCheers,\n    Berin\n"}, {"count": 16, "tags": [], "text": "Raul,\n\nCan i close this now?\n\nthanks,\ndims", "attachment_id": null, "id": 60507, "creation_time": "2004-07-12T18:14:38Z", "time": "2004-07-12T18:14:38Z", "creator": "dims@yahoo.com", "bug_id": 28752, "is_private": false}, {"count": 17, "text": "Yeah, please...\n\n\n", "bug_id": 28752, "is_private": false, "id": 60518, "time": "2004-07-12T19:02:38Z", "creator": "raul-info@r-bg.com", "creation_time": "2004-07-12T19:02:38Z", "tags": [], "attachment_id": null}, {"count": 18, "text": "Closing old bugs.", "bug_id": 28752, "is_private": false, "id": 91944, "time": "2006-08-06T17:27:41Z", "creator": "raul-info@r-bg.com", "creation_time": "2006-08-06T17:27:41Z", "tags": [], "attachment_id": null}]