[{"count": 0, "tags": [], "creator": "betoneto.tbo@gmail.com", "attachment_id": null, "is_private": false, "id": 176567, "time": "2014-07-21T19:13:45Z", "bug_id": 56756, "creation_time": "2014-07-21T19:13:45Z", "text": "I was using the Tomcat 7.0.40 with Spring Instrument agent.\n\nI'm launching the tomcat with the VM argument \"-javaagent:spring-instrument.jar\", and after update tomcat to version 7.0.54 the spring strarts with this error:\n\n\"java.lang.IllegalStateException: Must start with Java agent to use InstrumentationLoadTimeWeaver. See Spring documentation.\"\n\nSeems that it (spring) has no more visibility to the loaded agent.\n\nI was obliged to downgrade to version 7.0.40 again."}, {"attachment_id": null, "tags": [], "bug_id": 56756, "text": "How are you launching Tomcat? How are you setting that parameter? This is probably best discussed on the user list and not in Bugzilla since there's no evidence thus far that a bug exists.", "count": 1, "id": 176605, "time": "2014-07-22T20:53:25Z", "creator": "chris@christopherschultz.net", "creation_time": "2014-07-22T20:53:25Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 56756, "text": "This is the command line that I'm using:\n\nJREP_ATH\\java.exe -Dfile.encoding=Cp1252 -javaagent:MY_PATH_TO\\spring-instrument-4.0.6.RELEASE.jar -classpath \"bootstrap.jar;tomcat-juli.jar\" org.apache.catalina.startup.Bootstrap start\n\nStarting in tomcat bin directory (working dir).\n\nThis command works with tomcat 7.0.40... but with 7.0.54 doesn't.\nWith version 7.0.54 seems that the webapp classloder has no visibility to the javaagent loaded by the command-line parameter.", "count": 2, "id": 176618, "time": "2014-07-23T11:06:01Z", "creator": "betoneto.tbo@gmail.com", "creation_time": "2014-07-23T11:06:01Z", "is_private": false}, {"count": 3, "tags": [], "creator": "markt@apache.org", "text": "Can you put together the simplest possible web application that demonstrates this and attach it to this issue please?", "id": 176947, "time": "2014-08-06T08:26:56Z", "bug_id": 56756, "creation_time": "2014-08-06T08:26:56Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 56756, "text": "From Andy Wilkinson (Spring developer at $work):\n\n<quote>\n...if you want to involve as little of Spring as possible a Servlet that calls InstrumentationLoadTimeWeaver.isInstrumentationAvailable() directly should be sufficient. It'll return true if things are working and false if they're not. That class is in spring-context.\n</quote>\n\nThis should be enough for me to reproduce / test this.", "id": 176950, "time": "2014-08-06T14:24:43Z", "creator": "markt@apache.org", "creation_time": "2014-08-06T14:24:43Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "creator": "markt@apache.org", "text": "I have tested this with 7.0.40, 7.0.x and 8.0.x and all work as expected. This looks like configuration error. The users list is the place to seek help.", "id": 176952, "time": "2014-08-06T15:13:20Z", "bug_id": 56756, "creation_time": "2014-08-06T15:13:20Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "creator": "betoneto.tbo@gmail.com", "is_private": false, "text": "Created attachment 31882\nexample to reproduce\n\nThis is an maven project using:\n- servlet 3.0\n- spring 4.0.5 instrumentation\n\nOpen eclipse JEE:\n1 - import the project (attachment)\n2 - configure a WTP server with tomcat 7.40\n3 - configure a WTP server with tomcat 7.54\n4 - in the both server launchers configure the java agent\n   -javaagent:\"c:\\users\\user\\.m2\\repository\\org\\springframework\\spring-instrument\\4.0.5.RELEASE\\spring-instrument-4.0.5.RELEASE.jar\"\n5 - run the application on server 7.40\n6 - access the site (http://localhost:8080/test-instrumentation)\n7 - this site will print: Instrumentation is: on\n8 - stop the server, and run the other (7.54)\n9 - access the same url site\n10 - note, this time the site will print: Instrumentation is: off", "id": 176957, "time": "2014-08-06T16:42:19Z", "bug_id": 56756, "creation_time": "2014-08-06T16:42:19Z", "attachment_id": 31882}, {"count": 7, "tags": [], "creator": "betoneto.tbo@gmail.com", "is_private": false, "text": "Created attachment 31883\nweb application to reproduce\n\n1 - Import the attachment as a project in Eclipse JEE (my version is Kepler)\n2 - Configure 2 WTP servers (with tomcat 7.40 and 7.54)\n3 - Configure the java agent in both server launchers\n    -javaagent:\"c:\\users\\YOUR_USER\\.m2\\repository\\org\\springframework\\spring-instrument\\4.0.5.RELEASE\\spring-instrument-4.0.5.RELEASE.jar\"\"\n5 - Run the server with tomcat 7.40\n6 - Access the web application on your browser: http://localhost:8080/test-instrumentation\n7 - This page will print: Instrumentation is: on\n8 - Stop the server, and run the other (with tomcat 7.54)\n9 - Access the web application url again\n10 - This time the page print: Instrumentation is: off", "id": 176959, "time": "2014-08-06T16:51:03Z", "bug_id": 56756, "creation_time": "2014-08-06T16:51:03Z", "attachment_id": 31883}, {"count": 8, "tags": [], "text": "1 - Import the attachment as a project in Eclipse JEE (my version is Kepler)\n2 - Configure 2 WTP servers (with tomcat 7.40 and 7.54)\n3 - Configure the java agent in both server launchers\n    -javaagent:\"c:\\users\\YOUR_USER\\.m2\\repository\\org\\springframework\\spring-instrument\\4.0.5.RELEASE\\spring-instrument-4.0.5.RELEASE.jar\"\"\n5 - Run the server with tomcat 7.40\n6 - Access the web application on your browser: http://localhost:8080/test-instrumentation\n7 - This page will print: Instrumentation is: on\n8 - Stop the server, and run the other (with tomcat 7.54)\n9 - Access the web application url again\n10 - This time the page print: Instrumentation is: off", "is_private": false, "id": 176960, "creation_time": "2014-08-06T16:51:21Z", "time": "2014-08-06T16:51:21Z", "creator": "betoneto.tbo@gmail.com", "bug_id": 56756, "attachment_id": null}, {"count": 9, "tags": [], "text": "Unsurprisingly this still works for me when running Tomcat via Eclipse.\n\nPlease stop re-opening this bug and use the users mailing list to debug your configuration error.", "is_private": false, "id": 176971, "creation_time": "2014-08-07T11:17:59Z", "time": "2014-08-07T11:17:59Z", "creator": "markt@apache.org", "bug_id": 56756, "attachment_id": null}, {"count": 10, "tags": [], "creator": "mart.bakhoff@zeroturnaround.com", "attachment_id": 32278, "text": "Created attachment 32278\nsample application", "id": 179670, "time": "2014-12-09T21:34:15Z", "bug_id": 56756, "creation_time": "2014-12-09T21:34:15Z", "is_private": false}, {"count": 11, "tags": [], "creator": "mart.bakhoff@zeroturnaround.com", "attachment_id": null, "text": "Hi Mark, \n\nThanks for looking into this issue. I have some additional information that you can use to reproduce the issue. \n\nIt seems that tomcat changed its classloaders somewhere between 7.0.50-7.0.53. In the new version, if org.springframework:spring-instrument is maven dependencies then there will be two copies of InstrumentationSavingAgent loaded into the application - one in the WebappClassLoader and one in the system classloader. Spring uses the webapp classloader which makes it unable to find the instrumentation. See the sample application - mvn package, deploy the war and open http://localhost:8080/instrumentation-demo/ \n\nThanks\nM\u00e4rt B", "id": 179672, "time": "2014-12-09T21:39:46Z", "bug_id": 56756, "creation_time": "2014-12-09T21:39:46Z", "is_private": false}, {"count": 12, "text": "Then remove the duplicate JAR from the web application.\n\nAgain, the users list is the place to seek configuration help.", "creator": "markt@apache.org", "is_private": false, "id": 179674, "time": "2014-12-09T21:45:04Z", "bug_id": 56756, "creation_time": "2014-12-09T21:45:04Z", "tags": [], "attachment_id": null}]