[{"count": 0, "attachment_id": 33737, "bug_id": 59286, "is_private": false, "id": 190051, "time": "2016-04-07T18:24:01Z", "creator": "csutherl@apache.org", "creation_time": "2016-04-07T18:24:01Z", "tags": [], "text": "Created attachment 33737\nException stack trace\n\nWhen using APR for a connector and trying to bind to an ipv6 address (other than lo ::1 or all ::), the connector fails to initialize with a \"[22] Invalid argument\" exception. I'm using the default server.xml with the address attribute added on the Connectors to reproduce. I noticed that the error is coming up from the Socket.bind() call, but I wanted to open this with the AprEndpoint in mind because it isn't crashing in the natives. Also note that I am using OpenJDK 8u77 for my testing.\n\nThis only occurs with APR (NIO/NIO2 seem OK). I'm testing with APR 1.5.2 and OpenSSL 1.0.2g:\n\n07-Apr-2016 12:02:28.415 INFO [main] org.apache.catalina.core.AprLifecycleListener.lifecycleEvent Loaded APR based Apache Tomcat Native library 1.2.6 using APR version 1.5.2.\n07-Apr-2016 12:02:28.415 INFO [main] org.apache.catalina.core.AprLifecycleListener.lifecycleEvent APR capabilities: IPv6 [true], sendfile [true], accept filters [false], random [true].\n07-Apr-2016 12:02:28.417 INFO [main] org.apache.catalina.core.AprLifecycleListener.initializeSSL OpenSSL successfully initialized (OpenSSL 1.0.2g-fips  1 Mar 2016)\n\nI put a breakpoint on the bind call, but the working (lo) bind and the non-working one look pretty much identical. I am not familiar with network/socket programming, so it's pretty foreign to me.\n\nThis does occur on tomcat-trunk as well."}, {"text": "It looks like this affects httpd as well. That and the fact that the Socket.bind() returns the 22 status is cause enough to start looking into APR instead of Tomcat's AprEndpoint I think.", "tags": [], "creator": "csutherl@apache.org", "is_private": false, "count": 1, "id": 190132, "time": "2016-04-11T13:49:31Z", "bug_id": 59286, "creation_time": "2016-04-11T13:49:31Z", "attachment_id": null}, {"count": 2, "attachment_id": null, "bug_id": 59286, "is_private": false, "id": 190144, "time": "2016-04-11T19:05:51Z", "creator": "csutherl@apache.org", "creation_time": "2016-04-11T19:05:51Z", "tags": [], "text": "It looks like this fails when using an ipv6 link-local scoped address. If you use a globally scoped address, then it works normally. Is that behavior expected with APR?"}, {"count": 3, "tags": [], "bug_id": 59286, "is_private": false, "id": 190245, "attachment_id": null, "creator": "csutherl@apache.org", "creation_time": "2016-04-14T13:47:02Z", "time": "2016-04-14T13:47:02Z", "text": "Sorry for all the movement on this one...Moving to tcnative instead of APR. I've finally isolated the issue down to being a problem with link-local IPv6 and found a bugzilla (https://bz.apache.org/bugzilla/show_bug.cgi?id=52717) that already tried to address the problem a few years ago. I guess that makes this a duplicate and the other should be reopened, but I'll leave that up to you guys."}]