[{"count": 0, "tags": [], "bug_id": 47954, "text": "I am using an embedded version of tomcat 6.0.20\nThe connector's configuration is taken from the ordinary server.xml file.\nConnector is defined using NIO protocol (or AJP/1.3) in the following way:\n\n<Connector port=\"8080\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\" \n               connectionTimeout=\"20000\" \n               redirectPort=\"8443\" />\n\nConnectors objects are created via calling to StandardService.findConnectors() method, and being added (in our server code) to the Embedded object calling Embedded.addConnector(connector) method.\n\nNevertheless in such case the ProtocolHandler type which is created for the connector object is : org.apache.coyote.http11.Http11Protocol instead of org.apache.coyote.http11.Http11NioProtocol.\n\nIn case creating the NIO connector using Embedded.createConnector() method - connector is created correctly.\n\nThe root cause of the problem is with the Connector.setProtocol() method which is being called within the process of the Digester configuration parser which create an empty Connector object and run all it's configured attributes using reflection setters , among them it calls setProtocol() method. \nsetProtocol method should start a new correlating protocolHandler for any new set protocol besides http/1.1 ( such as NIO, AJP..)\n\nAttached a suggested fix to :\n\n\n    public void setProtocol(String protocol) {\n\n        // Test APR support\n        initializeAPR();\n\n        if (aprInitialized) {\n            if (\"HTTP/1.1\".equals(protocol)) {\n                setProtocolHandlerClassName\n                    (\"org.apache.coyote.http11.Http11AprProtocol\");\n            } else if (\"AJP/1.3\".equals(protocol)) {\n                setProtocolHandlerClassName\n                    (\"org.apache.coyote.ajp.AjpAprProtocol\");\n            } else if (protocol != null) {\n                setProtocolHandlerClassName(protocol);\n            } else {\n                setProtocolHandlerClassName\n                    (\"org.apache.coyote.http11.Http11AprProtocol\");\n            }\n        } else {\n            if (\"HTTP/1.1\".equals(protocol)) {\n                setProtocolHandlerClassName\n                    (\"org.apache.coyote.http11.Http11Protocol\");\n            } else if (\"AJP/1.3\".equals(protocol)) {\n                setProtocolHandlerClassName\n                    (\"org.apache.jk.server.JkCoyoteHandler\");\n            } else if (protocol != null) {\n                setProtocolHandlerClassName(protocol);\n\n            }\n\n        }\n        try{\n            //Reem's fix to NIO support\n            Class clazz = Class.forName(protocolHandlerClassName);\n            this.protocolHandler = (ProtocolHandler) clazz.newInstance();\n            //set port\n            IntrospectionUtils.setProperty(this, \"port\", \"\" + port);\n\n        }catch (Exception e){\n            log.error(\"Error setting protocol :\"+e);            \n        }\n\n    }\n\n\nin addition here is the stack trace of the digester instanciating new Connector:\n\n        at java.lang.Thread.dumpStack(Thread.java:1206)\n        at org.apache.catalina.connector.Connector.<init>(Connector.java:76)\n        at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\n        at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:39)\n        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:27)\n        at java.lang.reflect.Constructor.newInstance(Constructor.java:513)\n        at java.lang.Class.newInstance0(Class.java:355)\n        at java.lang.Class.newInstance(Class.java:308)\n        at org.apache.tomcat.util.digester.ObjectCreateRule.begin(ObjectCreateRule.java:206)\n        at org.apache.tomcat.util.digester.Rule.begin(Rule.java:153)\n        at org.apache.tomcat.util.digester.Digester.startElement(Digester.java:1358)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.startElement(AbstractSAXParser.java:501)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractXMLDocumentParser.emptyElement(AbstractXMLDocumentParser.java:179)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanStartElement(XMLDocumentFragmentScannerImpl.java:1339)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl$FragmentContentDriver.next(XMLDocumentFragmentScannerImpl.java:2747)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentScannerImpl.next(XMLDocumentScannerImpl.java:648)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanDocument(XMLDocumentFragmentScannerImpl.java:510)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:807)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:737)\n        at com.sun.org.apache.xerces.internal.parsers.XMLParser.parse(XMLParser.java:107)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.parse(AbstractSAXParser.java:1205)\n        at com.sun.org.apache.xerces.internal.jaxp.SAXParserImpl$JAXPSAXParser.parse(SAXParserImpl.java:522)\n        at org.apache.tomcat.util.digester.Digester.parse(Digester.java:1644)\n\n\n\nin addition here is the stack trace of the digester setting protocol for created Connector:\n\n\n        at java.lang.Thread.dumpStack(Thread.java:1206)\n        at org.apache.catalina.connector.Connector.setProtocol(Connector.java:697)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.tomcat.util.IntrospectionUtils.setProperty(IntrospectionUtils.java:278)\n        at org.apache.catalina.startup.SetAllPropertiesRule.begin(SetAllPropertiesRule.java:66)\n        at org.apache.tomcat.util.digester.Digester.startElement(Digester.java:1358)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.startElement(AbstractSAXParser.java:501)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractXMLDocumentParser.emptyElement(AbstractXMLDocumentParser.java:179)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanStartElement(XMLDocumentFragmentScannerImpl.java:1339)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl$FragmentContentDriver.next(XMLDocumentFragmentScannerImpl.java:2747)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentScannerImpl.next(XMLDocumentScannerImpl.java:648)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanDocument(XMLDocumentFragmentScannerImpl.java:510)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:807)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:737)\n        at com.sun.org.apache.xerces.internal.parsers.XMLParser.parse(XMLParser.java:107)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.parse(AbstractSAXParser.java:1205)\n        at com.sun.org.apache.xerces.internal.jaxp.SAXParserImpl$JAXPSAXParser.parse(SAXParserImpl.java:522)\n        at org.apache.tomcat.util.digester.Digester.parse(Digester.java:1644)", "id": 130940, "time": "2009-10-07T08:27:15Z", "creator": "reemhal@hotmail.com", "creation_time": "2009-10-07T08:27:15Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 47954, "text": "Created attachment 24356\nsuggested fixed to Connector.java", "id": 130941, "time": "2009-10-07T08:50:41Z", "creator": "reemhal@hotmail.com", "creation_time": "2009-10-07T08:50:41Z", "is_private": false, "attachment_id": 24356}, {"count": 2, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": 24363, "text": "Created attachment 24363\nThe same as attachment 24356, but as diff -u\n\nPatches are better provided as an unified diff, created with \"svn diff\". I made one from your file.\n\nSo, the actual complaint is that the method \"Connector.setProtocol()\" is useless, because it does not change the protocolHandler instance used by the Connector class?\n\nHow are you reading that server.xml? The o.a.catalina.startup.ConnectorCreateRule class takes care of the \"protocol\" attribute. How it comes that you are not using it? See Catalina.createStartDigester() that configures the digester.", "id": 130970, "time": "2009-10-08T03:54:24Z", "bug_id": 47954, "creation_time": "2009-10-08T03:54:24Z", "is_private": false}, {"count": 3, "tags": [], "creator": "reemhal@hotmail.com", "text": "Sorry for the format of the patch supplied - i will try to bring it in a correct format next time .\n\nYou are correct with your diagnostics of the problem it is the method \"Connector.setProtocol()\" which is useless in such case.\n\nAs to the reading of the server.xm file it's done using the digester (See the dump supplied, instanciating a new Connector instance and setting its protocol..) \nI can send you the actual relevant code if you like.", "id": 130991, "time": "2009-10-08T09:52:20Z", "bug_id": 47954, "creation_time": "2009-10-08T09:52:20Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "text": "Looks like the digester is not configured correctly.\n\nI'd be very wary of changing this in Tomcat 6 in case it breaks other embedded use cases.\n\nI wouldn't be against making changes in Tomcat 7 although there have been quite a few changes to embedded that should make life a lot easier and I know that connectors other than BIO work.\n\nI'm marking this as WONTFIX for now although feel free to re-open if you have any related suggestions for changes to Tomcat 7. Alternatively, just create a new issue against Tomcat 7 and attach you r patch there.", "is_private": false, "id": 132941, "creator": "markt@apache.org", "time": "2009-12-18T10:52:03Z", "bug_id": 47954, "creation_time": "2009-12-18T10:52:03Z", "attachment_id": null}]