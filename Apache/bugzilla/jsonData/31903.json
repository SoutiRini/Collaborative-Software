[{"attachment_id": null, "tags": [], "bug_id": 31903, "is_private": false, "count": 0, "id": 65767, "time": "2004-10-26T19:30:41Z", "creator": "jzhou@workforcesoftware.com", "creation_time": "2004-10-26T19:30:41Z", "text": "WebappClassLoader may fail to load class from local repository when multiple\nthreads are trying to load same class concurrently. \n\nNeed to change method findClassInternal (line 1577 ),  \n\n        if ((entry == null) || (entry.binaryContent == null))\n            throw new ClassNotFoundException(name);\n\nto \n\n        if ((entry == null) || (entry.binaryContent == null &&\nentry.loadedClass==null))\n            throw new ClassNotFoundException(name);\n\nsince after one thread calls defineClass() on the entry, the entry's\nbinaryContent is set to null, but in this case, the class is already loaded, so\nthe code should not throw ClassNotFoundException. \n\nAlso in method findClassInternal, following code still use double checked\nlocking, which is proven broken -  \n\n        if (entry.loadedClass == null) {\n            synchronized (this) {\n                if (entry.loadedClass == null) {\n                    clazz = defineClass(name, entry.binaryContent, 0,\n                                        entry.binaryContent.length,\n                                        codeSource);\n                    entry.loadedClass = clazz;\n                    entry.binaryContent = null;\n                    entry.source = null;\n                    entry.codeBase = null;\n                    entry.manifest = null;\n                    entry.certificates = null;\n                } else {\n                    clazz = entry.loadedClass;\n                }\n            }\n        } else {\n            clazz = entry.loadedClass;\n        }"}, {"count": 1, "tags": [], "bug_id": 31903, "attachment_id": null, "text": "Are you reporting an actual problem, or is it just reading of the source code ?\n\nThe first part could make sense: I added entry.binaryContent = null after the\nrest, so the condition might be wrong.", "id": 65783, "time": "2004-10-26T23:37:20Z", "creator": "remm@apache.org", "creation_time": "2004-10-26T23:37:20Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 31903, "text": "This is a reproducible real problem.\n\nOur server uses tomcat 5.0 as a servlet engine. When it runs multiple worker\nthreads to execute a JavaScritpt (using Rhino) on the server side, it will\noccasionally but consistently throw NoClassDefFoundError on a class in Rhino\nlibrary, which is located in the WEB-INF\\lib directory. \n\nWe eventually figure out if two threads start to load same class concurrently\nfor WEB-INF/lib, one of them will fail if \n\na) the first thread manages to call defineClass on the resource entry and set\nthe binaryContent to null; \n\nb) when the second adds its entry to the HashMap, it will find an entry for that\n class already exists, so it will return the existing entry (the one whose\nbinaryContent is null); \n\nFor the second part, it has been reported by some other people. Please see the\nfollowing link\n\nhttp://www.cs.umd.edu/~pugh/java/memoryModel/DoubleCheckedLocking.html\n\nIt would be better to replace the code with single checked locking and make it\nthread-safe. ", "id": 65828, "time": "2004-10-27T14:26:10Z", "creator": "jzhou@workforcesoftware.com", "creation_time": "2004-10-27T14:26:10Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "text": "You're not supposed to fork threads in your webapp.\n\nAs for the double check thing, try to post productive stuff, thanks.", "is_private": false, "id": 65829, "creator": "remm@apache.org", "time": "2004-10-27T14:30:31Z", "bug_id": 31903, "creation_time": "2004-10-27T14:30:31Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 31903, "is_private": false, "count": 4, "id": 65830, "time": "2004-10-27T14:33:25Z", "creator": "jessh@ptc.com", "creation_time": "2004-10-27T14:33:25Z", "text": "It's well and good that you're \"not supposed to fork threads\", but let's get\nreal -- this is something that code needs to do more often than the strict\nletter of J2EE lets on."}, {"count": 5, "tags": [], "bug_id": 31903, "is_private": false, "id": 65832, "creation_time": "2004-10-27T14:54:26Z", "time": "2004-10-27T14:54:26Z", "creator": "jzhou@workforcesoftware.com", "text": "\n\"You're not supposed to fork threads in your webapp.\"\n\nOh, this is the simpler fix, thanks.\n", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 31903, "text": "The J2EE spec forbids it, and experience shows it can cause many tricky problems.\n\nThe change for entry.loadedClass == null is good, since I added the\nentry.binaryContent = null without seeing that the check would need an update.\nThis was introduced in 5.0.3.", "count": 6, "id": 65837, "time": "2004-10-27T15:14:38Z", "creator": "remm@apache.org", "creation_time": "2004-10-27T15:14:38Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 31903, "is_private": false, "id": 65841, "creation_time": "2004-10-27T16:20:41Z", "time": "2004-10-27T16:20:41Z", "creator": "jzhou@workforcesoftware.com", "text": "Thanks Remy. It is forbidden to create threads in ejb container, and it is not\nrecommended to spawn threads in servlet container, but don't recall this is\nstrictly forbidden by the servlet spec (I might be wrong here). ", "attachment_id": null}]