[{"count": 0, "tags": [], "bug_id": 60889, "attachment_id": null, "text": "JMeter 3.1 JDBC sample will call SELECT USER() each time before execution SQL.\nIt maybe relative with commons-pool2-2.4.2.jar package. But the behaviour is not reasonable.", "id": 197816, "time": "2017-03-20T01:14:53Z", "creator": "liu_xp2003@sina.com", "creation_time": "2017-03-20T01:14:53Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 60889, "text": "(In reply to Liu XP from comment #0)\n> JMeter 3.1 JDBC sample will call SELECT USER() each time before execution\n> SQL.\n> It maybe relative with commons-pool2-2.4.2.jar package. But the behaviour is\n> not reasonable.\n\nHello,\nWhat is the Database you're using ?\nWhat make you think this request is emitted ?\n\nThank you", "id": 197843, "time": "2017-03-20T21:08:12Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-03-20T21:08:12Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 60889, "text": "(In reply to Philippe Mouawad from comment #1)\n> (In reply to Liu XP from comment #0)\n> > JMeter 3.1 JDBC sample will call SELECT USER() each time before execution\n> > SQL.\n> > It maybe relative with commons-pool2-2.4.2.jar package. But the behaviour is\n> > not reasonable.\n> \n> Hello,\n> What is the Database you're using ?\n> What make you think this request is emitted ?\n> \n> Thank you\n\nHi,\nIt's not due to commons-pool, it could have been related to commons-dbcp.\n\nBut IMO, I think you may have a validation query in your test plan.\n\nRegards", "id": 197844, "time": "2017-03-20T21:09:54Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-03-20T21:09:54Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 60889, "text": "Hi Philippe,\n\nThere is default validation query SELECT 1 in JDBC Connection Configuration.\nAnd I captured both query \"SELECT 1\" and \"SELECT USER()\" by Wireshark.\nI used MySQL 5.6+ to duplicate this case. And it is not relative with MySQL server version.\n\nAnd You corrected my type mistook. This behaviour could have been related to commons-dbcp2.", "id": 197875, "time": "2017-03-21T16:32:35Z", "creator": "liu_xp2003@sina.com", "creation_time": "2017-03-21T16:32:35Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 60889, "is_private": false, "id": 197887, "creation_time": "2017-03-21T20:43:23Z", "time": "2017-03-21T20:43:23Z", "creator": "p.mouawad@ubik-ingenierie.com", "text": "Hi,\nCan you try setting test while idle to false ?\nAnd report if you still see this query ?\nI would expect the following behaviour:\n1) test while idle to false : No query\n2) test while idle == true + No Validation query => SELECT USER() is emitted\n3) test while idle == true + Validation query => validation query is emitted\n\n\nIn case 3) are you seeing the 2 queries ?\nThanks", "attachment_id": null}, {"count": 5, "tags": [], "creator": "liu_xp2003@sina.com", "attachment_id": null, "text": "Hi,\n\nThis is result. I listed Request Query & Request Quit in Wireshark.\nThe Query \"SELECT USER()\" could be found in each test case.\n1) test while idle to false : No query\nStatement [truncated]: /* mysql-connector-java-5.1.40 ( Revision: 402933ef52cad9aa82624e80acbea46e3a701ce6 ) */SELECT  @@session.auto_increment_increment AS auto_increment_increment, @@character_set_client AS character_set_client, @@charac\nStatement: SET NAMES utf8\nStatement: SET character_set_results = NULL\nStatement: SET autocommit=1\nStatement: SET autocommit=0\nCommand: Ping (14)        -- test ping instead of validation query.\nStatement: select @@session.tx_read_only\nStatement: rollback\nStatement: SET autocommit=1\nCommand: Quit (1)\nStatement [truncated]: /* mysql-connector-java-5.1.40 ( Revision: 402933ef52cad9aa82624e80acbea46e3a701ce6 ) */SELECT  @@session.auto_increment_increment AS auto_increment_increment, @@character_set_client AS character_set_client, @@charac\nStatement: SET NAMES utf8\nStatement: SET character_set_results = NULL\nStatement: SET autocommit=1\nStatement: SET autocommit=0\nStatement: SELECT USER()        -- stubborn query.\nStatement: select Name from zabbixkey;        -- test JDBC Request\nStatement: select @@session.tx_read_only\nStatement: rollback\nStatement: SET autocommit=1\nCommand: Quit (1)\n\n\n2) test while idle == true + No Validation query => SELECT USER() is emitted\nStatement [truncated]: /* mysql-connector-java-5.1.40 ( Revision: 402933ef52cad9aa82624e80acbea46e3a701ce6 ) */SELECT  @@session.auto_increment_increment AS auto_increment_increment, @@character_set_client AS character_set_client, @@charac\nStatement: SET NAMES utf8\nStatement: SET character_set_results = NULL\nStatement: SET autocommit=1\nStatement: SET autocommit=0\nCommand: Ping (14)        -- test ping instead of validation query.\nStatement: select @@session.tx_read_only\nStatement: rollback\nStatement: SET autocommit=1\nCommand: Quit (1)\nStatement [truncated]: /* mysql-connector-java-5.1.40 ( Revision: 402933ef52cad9aa82624e80acbea46e3a701ce6 ) */SELECT  @@session.auto_increment_increment AS auto_increment_increment, @@character_set_client AS character_set_client, @@charac\nStatement: SET NAMES utf8\nStatement: SET character_set_results = NULL\nStatement: SET autocommit=1\nStatement: SET autocommit=0\nStatement: SELECT USER()        -- stubborn query.\nStatement: select Name from zabbixkey;        -- test JDBC Request\nStatement: select @@session.tx_read_only\nStatement: rollback\nStatement: SET autocommit=1\nCommand: Quit (1)\n\n\n3) test while idle == true + Validation query => validation query is emitted\nStatement [truncated]: /* mysql-connector-java-5.1.40 ( Revision: 402933ef52cad9aa82624e80acbea46e3a701ce6 ) */SELECT  @@session.auto_increment_increment AS auto_increment_increment, @@character_set_client AS character_set_client, @@charac\nStatement: SET NAMES utf8\nStatement: SET character_set_results = NULL\nStatement: SET autocommit=1\nStatement: SET autocommit=0\nStatement: Select 1        -- Yes, this is my validation query.\nStatement: select @@session.tx_read_only\nStatement: rollback\nStatement: SET autocommit=1\nCommand: Quit (1)\nStatement [truncated]: /* mysql-connector-java-5.1.40 ( Revision: 402933ef52cad9aa82624e80acbea46e3a701ce6 ) */SELECT  @@session.auto_increment_increment AS auto_increment_increment, @@character_set_client AS character_set_client, @@charac\nStatement: SET NAMES utf8\nStatement: SET character_set_results = NULL\nStatement: SET autocommit=1\nStatement: SET autocommit=0\nStatement: SELECT USER()        -- stubborn query.\nStatement: select Name from zabbixkey;        -- test JDBC Request\nStatement: select @@session.tx_read_only\nStatement: rollback\nStatement: SET autocommit=1\nCommand: Quit (1)\n\nThanks,\nLiuXP", "id": 197896, "time": "2017-03-22T06:33:09Z", "bug_id": 60889, "creation_time": "2017-03-22T06:33:09Z", "is_private": false}, {"count": 6, "attachment_id": null, "bug_id": 60889, "text": "Hello,\nI looked into code of MySQL driver :\nmysql-connector-java-5.1.41-bin\n\n\"select User()\" is triggered by DatabaseMetaData#getUserName()\n\nQuery cannot be in commons-dbcp, so it should have been in driver through isValid()\nConnection#isValid of MySQL Driver calls ping() not this query.\n\nCould you check if you have this issue with 5.1.41 ?\n\nThanks", "id": 198049, "time": "2017-03-28T20:38:35Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-03-28T20:38:35Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "bug_id": 60889, "is_private": false, "id": 198053, "creation_time": "2017-03-29T05:35:00Z", "time": "2017-03-29T05:35:00Z", "creator": "liu_xp2003@sina.com", "text": "Hi Philippe,\n\nIt is relative with JMeter JDBC Sampler JDBCSampler.java line 88 res.setResponseHeaders(conn.toString());\nThe toString method is Overrided by DBCP2 DelegatingConnect.java line 101 toString(). And it will call meta.getUserName() in MySQL JDBC function.\n\nI comment conn.toString() line 88 and used following code to set ResponseHeaders.\nIt could avoid to calling \"SELECT USER()\" Query.\n\n            //res.setResponseHeaders(conn.toString());\n            res.setResponseHeaders(\"DB Pool Name: \" + getDataSource() + \";\\nConnect Catalog: \" + conn.getCatalog());", "attachment_id": null}, {"count": 8, "attachment_id": null, "bug_id": 60889, "is_private": false, "id": 198176, "time": "2017-04-06T09:23:01Z", "creator": "liu_xp2003@sina.com", "creation_time": "2017-04-06T09:23:01Z", "tags": [], "text": "Hi Philippe,\n\nThis issue could be reproduced with MySQL JDBC 5.1.41. The following is my patch info. It could depress the SELECT USER() Query.\n------------------------------------------------\n--- a/src/protocol/jdbc/org/apache/jmeter/protocol/jdbc/sampler/JDBCSampler.java\n+++ b/src/protocol/jdbc/org/apache/jmeter/protocol/jdbc/sampler/JDBCSampler.java\n@@ -80,7 +80,7 @@ public class JDBCSampler extends AbstractJDBCTestElement implements Sampler, Tes\n             } finally {\n                 res.connectEnd();\n             }\n-            res.setResponseHeaders(conn.toString());\n+            res.setResponseHeaders(\"DB Pool Name: \" + getDataSource() + \";\\nConnect Catalog: \" + conn.getCatalog());\n             res.setResponseData(execute(conn, res));\n         } catch (SQLException ex) {\n             final String errCode = Integer.toString(ex.getErrorCode());\n------------------------------------------------\n\nMySQL JDBC 5.1.41 Wireshark:\nStatement [truncated]: /* mysql-connector-java-5.1.41 ( Revision: 83c6dc41b96809df81444362933043b20a1d49d5 ) */SELECT  @@session.auto_increment_increment AS auto_increment_increment, @@character_set_client AS character_set_client, @@charac\nStatement: SET NAMES utf8\nStatement: SET character_set_results = NULL\nStatement: SET autocommit=1\nStatement: SET autocommit=0\nStatement: Select 1\nStatement: select @@session.tx_read_only\nStatement: rollback\nStatement: SET autocommit=1\nCommand: Quit (1)\nStatement [truncated]: /* mysql-connector-java-5.1.41 ( Revision: 83c6dc41b96809df81444362933043b20a1d49d5 ) */SELECT  @@session.auto_increment_increment AS auto_increment_increment, @@character_set_client AS character_set_client, @@charac\nStatement: SET NAMES utf8\nStatement: SET character_set_results = NULL\nStatement: SET autocommit=1\nStatement: SET autocommit=0\nStatement: SELECT USER()\nStatement: select Name from zabbixkey;\nStatement: select @@session.tx_read_only\nStatement: rollback\nStatement: SET autocommit=1\nCommand: Quit (1)\n\n\nThanks,\nLiuXP"}, {"count": 9, "tags": [], "bug_id": 60889, "is_private": false, "text": "Hello,\nThanks for this feedback.\n\nMy main concern is backward compatibility and impact of modifying this.\nconn.getCatalog() could trigger also a jdbc call in other drivers and would result in the same issue.\n\nWould it be possible for you to tell me what you get as HTTP REquest headers when using JMeter 2.13 ?\n\nThe ideal solution would be to call a method that will not trigger any call the DB Server.", "id": 198193, "time": "2017-04-06T15:02:18Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-04-06T15:02:18Z", "attachment_id": null}, {"count": 10, "attachment_id": null, "bug_id": 60889, "text": "Hi,\n\nWhen using JMeter 2.13, we can see following info in JDBC sampler header. The header info is not valuable.\n\nResponse headers:\ncom.mysql.jdbc.JDBC4Connection@4895c35b\n\n\nFor HTTP Response headers, it is included valuable info from server side such as Content-Encoding\uff0cConnection keep-alive,Server info,Set-Cookie and so on. I am don't know how to find JDBC Sampler reference solution from HTTP Request.", "id": 198196, "time": "2017-04-06T16:27:12Z", "creator": "liu_xp2003@sina.com", "creation_time": "2017-04-06T16:27:12Z", "tags": [], "is_private": false}, {"text": "(In reply to Liu XP from comment #10)\n> Hi,\n> \n> When using JMeter 2.13, we can see following info in JDBC sampler header.\n> The header info is not valuable.\n> \n> Response headers:\n> com.mysql.jdbc.JDBC4Connection@4895c35b\n\nIs information provided by 3.1 more valuable ? \nAnd With your patch ?\n\nMy opinion is that we should not put any information that impacts load on DB Server or response times. So I would tend to only put the first part of your patch.\nWe would not loose anything compared to 2.13 and maybe few limited information compared to 3.1\n\n\n> \n> \n> For HTTP Response headers, it is included valuable info from server side\n> such as Content-Encoding\uff0cConnection keep-alive,Server info,Set-Cookie and so\n> on. I am don't know how to find JDBC Sampler reference solution from HTTP\n> Request.\n\nYes because HTTP headers has a real meaning. DB response header is not a real concept", "tags": [], "bug_id": 60889, "is_private": false, "count": 11, "id": 198198, "time": "2017-04-06T16:30:31Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-04-06T16:30:31Z", "attachment_id": null}, {"count": 12, "attachment_id": null, "creator": "liu_xp2003@sina.com", "is_private": false, "id": 198201, "time": "2017-04-07T03:35:05Z", "bug_id": 60889, "creation_time": "2017-04-07T03:35:05Z", "tags": [], "text": "In JMeter 3.1 response, we can see more info about the JDBC URL and DriverName.\nIt is good for us know detail JDBC pool info that was used by JDBC sampler in View Results Tree.\n\n3.1 Response headers:\n1190470568, URL=jdbc:mysql://10.100.17.1:3306/test?useUnicode=true&characterEncoding=utf-8, UserName=test@10.101.20.49, MySQL-AB JDBC Driver\n\nI think JDBC pool name, JDBC URL and DriverName is valuable in response. And I agree with your opinion that we should not put any information that impacts load on DB Server or response times. And your patch suggestion is also reasonable."}, {"count": 13, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": null, "text": "(In reply to Liu XP from comment #12)\n> In JMeter 3.1 response, we can see more info about the JDBC URL and\n> DriverName.\n> It is good for us know detail JDBC pool info that was used by JDBC sampler\n> in View Results Tree.\n> \n> 3.1 Response headers:\n> 1190470568,\n> URL=jdbc:mysql://10.100.17.1:3306/test?useUnicode=true&characterEncoding=utf-\n> 8, UserName=test@10.101.20.49, MySQL-AB JDBC Driver\n> \n> I think JDBC pool name, JDBC URL and DriverName is valuable in response. \n\nUnfortunately giving such information requires for now calling a method on Connection which might trigger a server call.\nFixing that would require storing this info in DataSourceComponentImpl (see DataSourceComponent.java) so that it can be reused in JDBCSampler class in \nDataSourceElement.getConnection(getDataSource()); which would need to be changed.\n\nIf you want this to be integrated before 3.2 release, then please provide a PR, otherwise we'll have to wait after that.\n\nA quick fix is to just call:\nres.setResponseHeaders(getDataSource());\n\nThis would not lose information compared to 2.13 but it would compared to 3.0/3.1. And I don't know if many users use this information.\n\n\n\n\nAnd\n> I agree with your opinion that we should not put any information that\n> impacts load on DB Server or response times. And your patch suggestion is\n> also reasonable.", "id": 198210, "time": "2017-04-07T16:49:58Z", "bug_id": 60889, "creation_time": "2017-04-07T16:49:58Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 60889, "text": "Hi Team ,\nAny thoughts on this ?\n\nThanks", "id": 198380, "time": "2017-04-19T20:10:01Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-04-19T20:10:01Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "bug_id": 60889, "is_private": false, "id": 198599, "creation_time": "2017-04-30T10:46:54Z", "time": "2017-04-30T10:46:54Z", "creator": "felix.schumacher@internetallee.de", "text": "As the info was totally unusable in older versions, I don't think, that many people are relying on this information and changing it, will have no big impact (hopefully:)\n\nAs Liu is interested in url, db driver and connection pool instance, I think we should use that. Those should -- without looking it up -- have no impact in form of database calls.", "attachment_id": null}, {"count": 16, "tags": [], "bug_id": 60889, "text": "(In reply to Felix Schumacher from comment #15)\n> As the info was totally unusable in older versions, I don't think, that many\n> people are relying on this information and changing it, will have no big\n> impact (hopefully:)\n> \n> As Liu is interested in url, db driver and connection pool instance, I think\n> we should use that. Those should -- without looking it up -- have no impact\n> in form of database calls.\n\nHi Felix, to add what Liu wants we need to make some non minor changes to pass the information from Configuration component to Request components.", "id": 198600, "time": "2017-04-30T10:49:03Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-04-30T10:49:03Z", "is_private": false, "attachment_id": null}, {"count": 17, "tags": [], "bug_id": 60889, "text": "My comment aimed at using the connection instance, to ask for information. This is ignoring the possibility, that that might trigger a database call.\n\nDo you think that risk is too high?", "id": 198601, "time": "2017-04-30T11:01:41Z", "creator": "felix.schumacher@internetallee.de", "creation_time": "2017-04-30T11:01:41Z", "is_private": false, "attachment_id": null}, {"count": 18, "tags": [], "bug_id": 60889, "text": "Author: pmouawad\nDate: Sat May 27 15:06:20 2017\nNew Revision: 1796408\n\nURL: http://svn.apache.org/viewvc?rev=1796408&view=rev\nLog:\nBug 60889 - JMeter JDBC sample calls SELECT USER() when testing with MySQL JDBC due to Connection#toString call for response headers\nBugzilla Id: 60889\n\nModified:\n    jmeter/trunk/src/protocol/jdbc/org/apache/jmeter/protocol/jdbc/config/DataSourceElement.java\n    jmeter/trunk/src/protocol/jdbc/org/apache/jmeter/protocol/jdbc/sampler/JDBCSampler.java\n    jmeter/trunk/xdocs/changes.xml", "id": 198913, "time": "2017-05-27T15:06:41Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-05-27T15:06:41Z", "is_private": false, "attachment_id": null}]