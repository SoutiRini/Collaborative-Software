[{"count": 0, "text": "If the client is closing the SSL connection correctly, i.e. sending\nthe close_notify alert message, the SSL session will be removed.\nSee the follwowing stack:\n\n  dummy_worker(opaque = 0x16b170)\n   worker_thread(thd = 0x16b170, dummy = 0x245d30)\n   apr_pool_clear(pool = 0x24b428)\n   run_cleanups(cref = 0x24b438)\n   ssl_io_filter_cleanup(data = 0x24b9a8)\n   SSL_free(s = 0x265fa0)\n   ssl_clear_bad_session(s = 0x265fa0)\n   SSL_CTX_remove_session(ctx = 0x23efe8, c = 0x24f560)\n   remove_session_lock(ctx = 0x23efe8, c = 0x24f560, lck = 1)\n   remove_session_cb(session_ctx = 0x23efe8, session = 0x24f560)\n\nThat situation is common pattern for most browser: If the server is \nsending a redirect with a large response body, the browser does not completly\nread the body. \n\nHow to reproduce:\nThe easiest way is a cgi script that is sending data, sleeping for\na while, sending data, etc. After seeing the first chunk in the browser,\npress the stop button. \n\nFix: \ndiff with httpd/2.2.0 (the same for httpd/2.0.x)\nIndex: modules/ssl//ssl_engine_io.c\n===================================================================\nRCS file:\n/opt/projects/CVSROOT/navajo/src/org/apache/httpd-2.2.X/modules/ssl/ssl_engine_io.c,v\nretrieving revision 1.2\ndiff -c -r1.2 ssl_engine_io.c\n*** modules/ssl//ssl_engine_io.c        2006/02/01 17:10:55     1.2\n--- modules/ssl//ssl_engine_io.c        2006/04/20 18:35:18\n***************\n*** 1439,1444 ****\n--- 1439,1452 ----\n              status = ssl_filter_write(f, data, len);\n              apr_bucket_delete(bucket);\n\n+                       /* try to read the  close_notify of the client*/\n+                       if( APR_STATUS_IS_ECONNRESET(status ) &&\n+                               SSL_peek(filter_ctx->pssl, NULL,0) == 0 &&\n+                               SSL_get_shutdown(filter_ctx->pssl) ==\nSSL_RECEIVED_SHUTDOWN\n+                       ) {\n+                               SSL_set_shutdown(filter_ctx->pssl,\n(SSL_RECEIVED_SHUTDOWN|SSL_SENT_SHUTDOWN));\n+                       }\n+\n              if (status != APR_SUCCESS) {\n                  break;\n              }\n\n\nRemarks:\nin ssl_io_filter_output will be checked that\na) the connection has been closed \nb) the client has sent the close_notify alert\n  (otherwise an attacker could drop the connection, i.e.\n  a truncating attack. )\n\n(a) is just for performance)", "creator": "hartmut.keil@gmx.ch", "attachment_id": null, "id": 88333, "time": "2006-04-20T20:43:30Z", "bug_id": 39370, "creation_time": "2006-04-20T20:43:30Z", "tags": [], "is_private": false}]