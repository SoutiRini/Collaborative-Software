[{"count": 0, "tags": [], "text": "I believe there's an issue with how ProxyPassReverse handles redirects in conjuction with mod_proxy_balancer.\nSee below for an example configuration which details the setup.\n\nThe browser requests /foo from the Apache HTTPd  frontendserver. The frontend server forwards the request to one of the balancer member servers (backend servers).\nThe backend server decides /myservice/foo is a directory and redirects to /myservice/foo/\n\nThe browsers get the following Location: header back:\nLocation: http://example.net/myservice/foo/\n\nFrom the below configuration you'd expect it to be just \"http://example.net/foo/\", with \"/myservice\" zapped. That's at least how things work when you're not using mod_proxy_balancer (see \"Demo 3\" below) at all.\n\n\nAn example configuration which details the issue in two ways with mod_proxy_balancer (demo 1 and 2) and one example which doesn't use mod_proxy_balancer and provides the expected result (demo 3) \n<VirtualHost *>\n    ServerName example.net\n\n\t# Demo 1: The following does not work:\n\tProxyPass\t\t\t/\t\tbalancer://mycluster/myservice/ stickysession=JSESSIONID|jsessionid nofailover=On\n\tProxyPassReverse\t/\t\tbalancer://mycluster/myservice/\n\t<Proxy balancer://mycluster>\n\t\t\tBalancerMember http://tomcat1.example.net:8180\n\t\t\tBalancerMember http://tomcat2.example.net:8180\n\t</Proxy>\n\n\t# Demo 2: ..and neither does this\n\tProxyPass\t\t\t/\t\tbalancer://mycluster/ stickysession=JSESSIONID|jsessionid nofailover=On\n\tProxyPassReverse\t/\t\tbalancer://mycluster/\n\t<Proxy balancer://mycluster>\n\t\t\tBalancerMember http://tomcat1.example.net:8180/myservice/\n\t\t\tBalancerMember http://tomcat2.example.net:8180/myservice/\n\t</Proxy>\n\n\n\t# Demo 3: This works though (but we can't do LB)\n\tProxyPass\t\t\t/ http://tomcat1.example.net:8180/myservice/\n\tProxyPassReverse\t/ http://tomcat1.example.net:8180/myservice/\n\n</VirtualHost>", "attachment_id": null, "bug_id": 45434, "id": 118815, "time": "2008-07-18T06:28:09Z", "creator": "noah@hd.se", "creation_time": "2008-07-18T06:28:09Z", "is_private": false}, {"count": 1, "tags": [], "creator": "noah@hd.se", "text": "Here's log output aswell.\n\nmod_proxy_balancer.c(46): proxy: BALANCER: canonicalising URL //mycluster/myservice/foo\nmod_proxy_balancer.c(276): proxy: BALANCER: Found value (null) for stickysession JSESSIONID|jsessionid\nmod_proxy_balancer.c(952): proxy: Entering byrequests for BALANCER (balancer://mycluster)\nmod_proxy_balancer.c(535): proxy: BALANCER (balancer://mycluster) worker (http://tomcat1.example.net:8180/) rewritten to http://tomcat1.example.net:8180//myservice/foo\nmod_proxy.c(966): Running scheme balancer handler (attempt 0)\nmod_proxy_http.c(1909): proxy: HTTP: serving URL http://tomcat1.example.net:8180//myservice/foo\nproxy_util.c(2044): proxy: HTTP: has acquired connection for (tomcat1.example.net)\nproxy_util.c(2102): proxy: connecting http://tomcat1.example.net:8180//myservice/foo to tomcat1.example.net:8180\nproxy_util.c(2195): proxy: connected //myservice/foo to tomcat1.example.net:8180\nproxy_util.c(2347): proxy: HTTP: fam 2 socket created to connect to tomcat1.example.net\nproxy_util.c(2448): proxy: HTTP: connection complete to 172.20.11.240:8180 (tomcat1.example.net)\nproxy_util.c(1071): ppr: real: balancer://mycluster/myservice/\nproxy_util.c(1085): ppr: checking balancer: balancer://mycluster\nproxy_util.c(1097): ppr: matching member (http://tomcat1.example.net:8180/) and URL (http://tomcat1.example.net:8180/myservice/foo/)\nproxy_util.c(1104): ppr: matched member (/myservice/foo/)\nmod_proxy_http.c(1686): proxy: start body send\nmod_proxy_http.c(1775): proxy: end body send\nproxy_util.c(2062): proxy: HTTP: has released connection for (tomcat1.example.net)\nproxy_util.c(1854): proxy: grabbed scoreboard slot 2 in child 18003 for worker http://tomcat1.example.net:8180/\nproxy_util.c(1873): proxy: worker http://tomcat1.example.net:8180/ already initialized\nproxy_util.c(1967): proxy: initialized single connection worker 2 in child 18003 for (tomcat1.example.net)\nproxy_util.c(1854): proxy: grabbed scoreboard slot 3 in child 18003 for worker http://tomcat1.example.net:8180/\nproxy_util.c(1873): proxy: worker http://tomcat1.example.net:8180/ already initialized\nproxy_util.c(1967): proxy: initialized single connection worker 3 in child 18003 for (tomcat1.example.net)\n\n", "id": 118817, "time": "2008-07-18T06:52:10Z", "bug_id": 45434, "creation_time": "2008-07-18T06:52:10Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "noah@hd.se", "text": "I believe the bug for \"Demo 1\" is somewhere around this block at line 2502 in modules/proxy/proxy_util.c.\n                l2 = strlen(u);\n                if (l1 >= l2 && strncasecmp(u, url, l2) == 0) {\n                    u = apr_pstrcat(r->pool, ent[i].fake, &url[l2], NULL);\n                    ap_log_error(APLOG_MARK, APLOG_DEBUG, 0, r->server,\n                         \"ppr: matched member (%s)\", u);\n                    return ap_construct_url(r->pool, u, r);\n                }\n\n", "id": 118819, "time": "2008-07-18T07:13:33Z", "bug_id": 45434, "creation_time": "2008-07-18T07:13:33Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 45434, "attachment_id": null, "id": 118824, "time": "2008-07-18T08:29:06Z", "creator": "rpluem@apache.org", "creation_time": "2008-07-18T08:29:06Z", "is_private": false, "text": "Your configuration is just wrong. In all three cases please add the following *two* ProxyPassReverse directives:\n\nProxyPassReverse        / http://tomcat1.example.net:8180/myservice/\nProxyPassReverse        / http://tomcat2.example.net:8180/myservice/\n"}, {"count": 4, "tags": [], "bug_id": 45434, "attachment_id": null, "id": 127182, "time": "2009-05-19T11:00:02Z", "creator": "wrowe@apache.org", "creation_time": "2009-05-19T11:00:02Z", "is_private": false, "text": "Note, \n\nProxyPassReverse    /        balancer://mycluster/\nwas fixed by 2.2.9, and\n\nProxyPassReverse    /        balancer://mycluster/myservice/\nis fixed for future 2.x releases, and proposed for backport to 2.2.12"}, {"count": 5, "tags": [], "bug_id": 45434, "attachment_id": null, "id": 144360, "creation_time": "2011-02-16T11:46:26Z", "time": "2011-02-16T11:46:26Z", "creator": "jorton@redhat.com", "text": "For posterity, looks like this was fixed in r777191 for 2.2.x.", "is_private": false}, {"count": 6, "tags": [], "bug_id": 45434, "attachment_id": null, "id": 161581, "creation_time": "2012-08-21T16:11:22Z", "time": "2012-08-21T16:11:22Z", "creator": "rainer.jung@kippdata.de", "text": "Bug was reintroduced in 2.4 and trunk.\nFixed in r1365479 for trunk and r1365604 for 2.4.\nReleased with 2.4.3.", "is_private": false}]