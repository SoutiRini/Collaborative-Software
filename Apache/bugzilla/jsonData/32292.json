[{"count": 0, "tags": [], "creator": "hayashin@ist.fujitsu.com", "text": "The following operation was found although it was not so big a problem.\nThen telneted to port 8080(tomcat 4.1.30) and gave following request\n (bat request because 2 spaspace befor \"HTTP/1.1\").\n----\nHEAD /index.html  HTTP/1.0\n\n\n----\nresponse was following\n----\nHTTP/1.1 505 HTTP Version Not Supported\nDate: Thu, 18 Nov 2004 07:34:18 GMT\nServer: Apache-Coyote/1.1\nConnection: Keep-Alive\n----\nAlthough a response header means KEEP-ALIVE processing,\nsocket close immediately.\n\nI think that correction would be inadequate at 4.1.27 folowing code.\norg.apache.coyote.http11.Http11Processor#statusDropsConnection\n----\n    /**\n     * Determine if we must drop the connection because of the HTTP status\n     * code.  Use the same list of codes as Apache/httpd.\n     */\n    protected boolean statusDropsConnection(int status) {\n        return status == 400 /* SC_BAD_REQUEST */ ||\n               status == 408 /* SC_REQUEST_TIMEOUT */ ||\n               status == 411 /* SC_LENGTH_REQUIRED */ ||\n               status == 413 /* SC_REQUEST_ENTITY_TOO_LARGE */ ||\n               status == 414 /* SC_REQUEST_URI_TOO_LARGE */ ||\n               status == 500 /* SC_INTERNAL_SERVER_ERROR */ ||\n               status == 503 /* SC_SERVICE_UNAVAILABLE */ ||\n               status == 501 /* SC_NOT_IMPLEMENTED */;\n    }\n----\nI think that 505 should also be included here, but it does not know \nwhether be else or not.(...or other fix code)\n\nregards,\nNaru Hayashi from Japan", "id": 67125, "time": "2004-11-18T13:33:49Z", "bug_id": 32292, "creation_time": "2004-11-18T13:33:49Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 32292, "text": "*** Bug 32293 has been marked as a duplicate of this bug. ***", "id": 67188, "time": "2004-11-18T23:49:44Z", "creator": "markt@apache.org", "creation_time": "2004-11-18T23:49:44Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 32292, "text": "I disagree.\n\nImagine that Tomcat only supported HTTP/1.0\n\nThe UA makes a request using HTTP/1.1, receieves the 505 and therefore elects \nto repeat the request but using HTTP/1.0. In this case it makes sense to keep \nthe connection open.", "count": 2, "id": 67260, "time": "2004-11-19T20:04:27Z", "creator": "markt@apache.org", "creation_time": "2004-11-19T20:04:27Z", "is_private": false}, {"count": 3, "tags": [], "creator": "hayashin@ist.fujitsu.com", "text": "Thank you for your reply.\nI can understand that the response 505 and the connection should\n be Keep-Alive are not wrong in this matter. but the problem is \naltough the response said \"Connection: Keep-Alive\" the real \nconnection is closed after the response.\n\nIn regarding to this matter I think there are 2 problems.\n1. Regarding to \"HEAD /index.html  HTTP/1.0\" response I think it\n is better to response with 400 rather than 505 (there are 2 \nspaces after URI so I think it is a Bad Request)\n2. Regarding to \"HEAD /index.html HTTP/1.2\" response I think it \nis better to response with 505 but the Socket should not be \nclosed immediately\n\nSo I think to try to solve the problems with\n1) for number 1 solution\norg.apache.coyote.http11.Http11Processor#prepareRequest()\n(line No.1090)\n-----------------\n    protected void prepareRequest() {\n\n        http11 = true;\n        http09 = false;\n        contentDelimitation = false;\n        expectation = false;\n        if (sslSupport != null) {\n            request.scheme().setString(\"https\");\n        }\n        MessageBytes protocolMB = request.protocol();\n        if (protocolMB.equals(Constants.HTTP_11)) {\n            http11 = true;\n            protocolMB.setString(Constants.HTTP_11);\n        } else if (protocolMB.equals(Constants.HTTP_10)) {\n            http11 = false;\n            keepAlive = false;\n            protocolMB.setString(Constants.HTTP_10);\n        } else if (protocolMB.equals(\"\")) {\n            // HTTP/0.9\n            http09 = true;\n            http11 = false;\n            keepAlive = false;\n        // ********** FIX FROM **********\n        } else if (!protocolMB.startsWith(\"HTTP/\")) {\n            error = true;\n            // 400 - Bas request\n            response.setStatus(400);\n        // ********** FIX TO **********\n        } else {\n            // Unsupported protocol\n            http11 = false;\n            error = true;\n            // Send 505; Unsupported HTTP version\n            response.setStatus(505);\n        }\n....\n-----------------\n2) for number 2 solution\norg.apache.coyote.http11.Http11Processor#prepareResponse()\n(line No.1530)\n-----------------\n    protected void prepareResponse() {\n\n        boolean entityBody = true;\n        contentDelimitation = false;\n...\n        // If we know that the request is bad this early, add the\n        // Connection: close header.\n        keepAlive = keepAlive && !statusDropsConnection(statusCode);\n        if (!keepAlive) {\n            response.addHeader(\"Connection\", \"close\");\n        } else if (!http11) {\n            response.addHeader(\"Connection\", \"Keep-Alive\");\n        // ********** FIX FROM **********\n            error=false;\n        // ********** FIX TO **********\n        }\n...\n-----------------\n\nregards,\nNaru Hayashi from Japan", "id": 68092, "time": "2004-12-08T09:21:05Z", "bug_id": 32292, "creation_time": "2004-12-08T09:21:05Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 32292, "attachment_id": null, "id": 68551, "time": "2004-12-15T08:11:38Z", "creator": "hayashin@ist.fujitsu.com", "creation_time": "2004-12-15T08:11:38Z", "is_private": false, "text": "I am very very sorry REOPEN this bug.\nThis is a very small problem( not problem?). \nAlthough it does not mind even if this is not fixed, I want to know whether it \nwill be fixed or not.\nNaru Hayashi\n"}, {"count": 5, "tags": [], "bug_id": 32292, "text": "Fixed in the CVS.", "id": 68552, "time": "2004-12-15T08:17:41Z", "creator": "william.barker@wilshire.com", "creation_time": "2004-12-15T08:17:41Z", "is_private": false, "attachment_id": null}]