[{"count": 0, "text": "I encountered the following while testing 7.0.22 RC.\n\nTo reproduce:\n1. Replace conf/logging.properties with the following:\n===============\nhandlers = 1catalina.org.apache.juli.FileHandler\n.handlers = 1catalina.org.apache.juli.FileHandler\n\n1catalina.org.apache.juli.FileHandler.level = FINE\n1catalina.org.apache.juli.FileHandler.directory = ${catalina.base}/logs\n1catalina.org.apache.juli.FileHandler.prefix = catalina.\n1catalina.org.apache.juli.FileHandler.bufferSize=20000\n\n.level=FINE\n===============\nNote that level=FINE enables debug logging.\n\n2. Run testsuite for NIO + org.apache.coyote.http11.TestInternalInputBuffer\nby adding the following to build.properties:\nexecute.test.bio=false\nexecute.test.nio=true\nexecute.test.apr=false\ntest.entry=org.apache.coyote.http11.TestInternalInputBuffer\n\n3. The test fails:\n==============\nTestsuite: org.apache.coyote.http11.TestInternalInputBuffer\nTests run: 7, Failures: 2, Errors: 0, Time elapsed: 50,357 sec\n\nTestcase: testBug48839 took 9,594 sec\nTestcase: testBug51557NoColon took 1,217 sec\n\tFAILED\n\njunit.framework.AssertionFailedError: \n\tat org.apache.coyote.http11.TestInternalInputBuffer.testBug51557NoColon(TestInternalInputBuffer.java:137)\n\nTestcase: testBug51557Separators took 22,807 sec\nTestcase: testBug51557Ctl took 13,104 sec\n\tFAILED\n\njunit.framework.AssertionFailedError: \n\tat org.apache.coyote.http11.TestInternalInputBuffer.doTestBug51557Char(TestInternalInputBuffer.java:216)\n\tat org.apache.coyote.http11.TestInternalInputBuffer.testBug51557Ctl(TestInternalInputBuffer.java:160)\n\nTestcase: testBug51557Continuation took 1,248 sec\nTestcase: testBug51557BoundaryStart took 1,185 sec\nTestcase: testBug51557BoundaryEnd took 1,186 sec\n==============\n\n4. It is the only test in testsuite that is failing in this logging configuration. The rest of testsuite did run successfully.\nThis test also succeeds when it is run with BIO or APR. Only NIO fails.\n\n\nIn the log file the following exception occurs 3 times:\n==============\n28.09.2011 17:50:38 org.apache.coyote.http11.AbstractHttp11Processor process\nFINE: Error parsing HTTP request header\njava.lang.StringIndexOutOfBoundsException: String index out of range: -40\n\tat java.lang.String.checkBounds(String.java:397)\n\tat java.lang.String.<init>(String.java:482)\n\tat org.apache.coyote.http11.InternalNioInputBuffer.skipLine(InternalNioInputBuffer.java:672)\n\tat org.apache.coyote.http11.InternalNioInputBuffer.parseHeader(InternalNioInputBuffer.java:526)\n\tat org.apache.coyote.http11.InternalNioInputBuffer.parseHeaders(InternalNioInputBuffer.java:435)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:905)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:515)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1550)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\tat java.lang.Thread.run(Thread.java:662)\n==============\n\nIt is caused by debug logging in\norg.apache.coyote.http11.InternalNioInputBuffer.skipLine(InternalNioInputBuffer.java:672)\n\n671        if (log.isDebugEnabled()) {\n672            log.debug(sm.getString(\"iib.invalidheader\", new String(buf,\n673                    headerData.start,\n674                    headerData.lastSignificantChar - headerData.start + 1,\n675                    DEFAULT_CHARSET)));\n676        }\n\nInternalInputBuffer and InternalAprInputBuffer have similar debug logging in their skipLine() methods, but they do not fail.", "bug_id": 51912, "attachment_id": null, "id": 149913, "time": "2011-09-28T14:22:54Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2011-09-28T14:22:54Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "id": 149936, "time": "2011-09-29T10:35:20Z", "bug_id": 51912, "creation_time": "2011-09-29T10:35:20Z", "is_private": false, "text": "Fixed in trunk and 7.0.x (r1177256) and will be in 7.0.23.\n\nReassigning to Tomcat 6, as I think its InternalNioInputBuffer.parseHeader should be aligned with TC7."}, {"count": 2, "tags": [], "bug_id": 51912, "attachment_id": null, "text": "It has been almost nine months. Are you going to propose a patch for this? If not, lets close this as fixed in 7.0.x.", "id": 160151, "time": "2012-06-21T08:43:49Z", "creator": "markt@apache.org", "creation_time": "2012-06-21T08:43:49Z", "is_private": false}, {"count": 3, "tags": [], "creator": "markt@apache.org", "text": "No proposal was forthcoming for 6.0.x", "id": 168981, "time": "2013-07-31T14:57:05Z", "bug_id": 51912, "creation_time": "2013-07-31T14:57:05Z", "is_private": false, "attachment_id": null}]