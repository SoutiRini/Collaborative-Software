[{"count": 0, "tags": [], "bug_id": 59122, "attachment_id": null, "text": "In production environment - tomcat_7_0_53 behind Apache/mod_jk - our customers report problems caused by random lost session issues.\n\nWe have investigated enabling AccessLogValve and to exclude bad session handling in request processing, like programmatically invoking of session.invalidate or session.setMaxTimeInterval etc.., we have catched and logged HttpSessionEvent via HttpSessionListener interface implementation.\n\n####################################################################################\n##### Logging by AccessLogValve\n##### At first access time\n82.112.204.155 - - [03/Mar/2016:08:27:03 +0100] \"GET /rdsv5i/servlet/custom-logon/clienti-asp HTTP/1.1\" Cookie=\"__utma=31431036.270103424.1433757878.1456913762.1456990022.212; __utmz=31431036.1433757878.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none); __utmb=31431036.1.10.1456990022; __utmt=1; __utmc=31431036; CustomLogonServlet.company=IAP; user=caruso; rds_home_page_logon=%2Frdsv5i%2Fservlet%2Fcustom-logon%2Fclienti-asp%3F1456913769327\" Set-Cookie=\"JSESSIONID=ADDBC908E913C159A330C746ABFE2340; Path=/rdsv5i; Secure\"\n\n##### User work without problems for 10 minutes:\n82.112.204.155 - - [03/Mar/2016:08:37:58 +0100] \"POST /rdsv5i/spoolviewer/spoolavailable.jsp HTTP/1.1\" Cookie=\"AlreadyConnectedGUID=f34dc1bb-a117-4405-a40d-289c73e07de9; JSESSIONID=ADDBC908E913C159A330C746ABFE2340; __utma=31431036.270103424.1433757878.1456913762.1456990022.212; __utmz=31431036.1433757878.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none); __utmb=31431036.1.10.1456990022; __utmc=31431036; CustomLogonServlet.company=IAP; user=caruso; rds_home_page_logon=%2Frdsv5i%2Fservlet%2Fcustom-logon%2Fclienti-asp%3F1456990031203\" Set-Cookie=\"-\"\n\n#### Suddenly Tomcat send Set-Cookie\n82.112.204.155 - - [03/Mar/2016:08:38:06 +0100] \"POST /rdsv5i/spoolviewer/spoolavailable.jsp HTTP/1.1\" Cookie=\"AlreadyConnectedGUID=f34dc1bb-a117-4405-a40d-289c73e07de9; JSESSIONID=ADDBC908E913C159A330C746ABFE2340; __utma=31431036.270103424.1433757878.1456913762.1456990022.212; __utmz=31431036.1433757878.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none); __utmb=31431036.1.10.1456990022; __utmc=31431036; CustomLogonServlet.company=IAP; user=caruso; rds_home_page_logon=%2Frdsv5i%2Fservlet%2Fcustom-logon%2Fclienti-asp%3F1456990031203\" Set-Cookie=\"JSESSIONID=28C983BAE315B709093B357C0DE7810D; Path=/rdsv5i; Secure\"\n\nand session lost issues...\n\n#### Logging by my HttpSessionListener\n##### At first access time\n03-Mar-2016 08:27:03.437 INFO [ajp-apr-8109-exec-5] com.rds_software.RdsUtil.http.HttpSessionEventsLogger.sessionCreated id=\"ADDBC908E913C159A330C746ABFE2340\"\n\n#### Suddenly Tomcat send Set-Cookie\n03-Mar-2016 08:38:06.358 INFO [ajp-apr-8109-exec-6] com.rds_software.RdsUtil.http.HttpSessionEventsLogger.sessionCreated id=\"28C983BAE315B709093B357C0DE7810D\"\n\n#### At first access time session destroying\n03-Mar-2016 09:08:43.365 INFO [ContainerBackgroundProcessor[StandardEngine[Catalina]]] com.rds_software.RdsUtil.http.HttpSessionEventsLogger.sessionDestroyed id=\"ADDBC908E913C159A330C746ABFE2340\" lastAccessedTime=\"08:37\" maxInactiveTimeInterval=\"1800\" stackTrace=\"Stacktrace: \norg.apache.catalina.session.StandardSession.expire(StandardSession.java:806)\n  org.apache.catalina.session.StandardSession.isValid(StandardSession.java:656)\n  org.apache.catalina.session.ManagerBase.processExpires(ManagerBase.java:532)\n  org.apache.catalina.session.ManagerBase.backgroundProcess(ManagerBase.java:517)\n  org.apache.catalina.core.ContainerBase.backgroundProcess(ContainerBase.java:1352)\n  org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1530)\n  org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1540)\n  org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1540)\n  org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run(ContainerBase.java:1519)\n\"\n####################################################################################\n\nMy question is: \nHow is possible tomcat create a new session at 08:38:06 when browser sent back JSESSIONID=ADDBC908E913C159A330C746ABFE2340 and ADDBC908E913C159A330C746ABFE2340 have been destroyed at 9:08:46?\n\nAt 08:38:06 Session ADDBC908E913C159A330C746ABFE2340 not was valid?\n\nI worked heavy for a week to code a test case to reproduce this strange behaviour but unsuccesfully.\n\nEvery suggest or idea is appreciate.", "id": 189124, "time": "2016-03-04T23:27:31Z", "creator": "lanarimarco@gmail.com", "creation_time": "2016-03-04T23:27:31Z", "is_private": false}, {"count": 1, "tags": [], "creator": "markt@apache.org", "text": "There is insufficient evidence in this report of a bug in Tomcat. The most likely explanation is an application bug.\n\nThe Tomcat 7 version being used is quite old. I don't recall any session handling issues but it is worth testing to see if an upgrade resolves the issue.\n\nThere are only things that can trigger a Set-Cookie header. The first is creation of a new session and the second is the session ID change on authentication.\n\nGiven that the original session expires 30 mins after the new session is created this isn't a session ID change due to authentication. Therefore, a new session is being created because the previous session cannot be found.\n\nThe Set-Cookie=\"-\" looks very strange.\n\nYou'll need to do some more investigation with the application to figure out what is going wrong. You might want to consider logging the HTTP requets headers and the stack trace for the session creation. If you need help with investigating your application, the users@ mailing list is the place to ask, not Bugzilla.\n\nIf the discussion on users@ identifies a Tomcat bug then please feel free to re-open this issue and provide the details.", "id": 189207, "time": "2016-03-07T15:18:20Z", "bug_id": 59122, "creation_time": "2016-03-07T15:18:20Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 59122, "attachment_id": null, "text": "I have news.\nComparing AccessLogValve logs and org.apache.catalina.connector.CoyoteAdapter logs, in normal condition, in front of:\n\n############### REQUEST OK HANDLING #######################################\n#AccessLogValve logs\n93.145.128.242 - - [08/Mar/2016:10:16:35 +0100] \"GET /rdsv5i/rds-its/xmlv5i/css/style.jsp?resolution=1024X768 HTTP/1.1\" Cookie=\"JSESSIONID=CE848CE8D53223658BD8D69D5CB667D4.tom01v6\" Set-Cookie=\"-\"\n\nI see:\n#CoyoteAdapter logs\n08-Mar-2016 10:16:35.848 FINE [ajp-apr-8109-exec-3] org.apache.catalina.connector.CoyoteAdapter.parsePathParameters The variable [uriBC] has value [/rdsv5i/rds-its/xmlv5i/css/style.jsp]\n08-Mar-2016 10:16:35.848 FINE [ajp-apr-8109-exec-3] org.apache.catalina.connector.CoyoteAdapter.parsePathParameters The variable [semicolon] has value [-1]\n08-Mar-2016 10:16:35.848 FINE [ajp-apr-8109-exec-3] org.apache.catalina.connector.CoyoteAdapter.parsePathParameters The variable [enc] has value [ISO-8859-1]\n08-Mar-2016 10:16:35.848 FINE [ajp-apr-8109-exec-3] org.apache.catalina.connector.CoyoteAdapter.parseSessionCookiesId  Requested cookie session id is CE848CE8D53223658BD8D69D5CB667D4.tom01v6\n\n\nBut when tomcat sent a renewed jsessionid (lost session issue), I observed that although browser sent JSESSIONID=CE848CE8D53223658BD8D69D5CB667D4.tom01v6:\n\n############### REQUEST KO HANDLING #######################################\n#AccessLogValve logs\n93.145.128.242 - - [08/Mar/2016:10:16:35 +0100] \"GET /rdsv5i/rds-its/xmlv5i/js/customers/righi.js HTTP/1.1\" 404 1037 Cookie=\"JSESSIONID=CE848CE8D53223658BD8D69D5CB667D4.tom01v6\" Set-Cookie=\"JSESSIONID=0D954B6C1223E63C54DB8BDA265A7B83.tom01v6; Path=/rdsv5i; Secure\"\n\nCoyote connector doesn't recognize it:\n#CoyoteAdapter logs\n08-Mar-2016 10:16:35.864 FINE [ajp-apr-8109-exec-6] org.apache.catalina.connector.CoyoteAdapter.parsePathParameters The variable [uriBC] has value [/rdsv5i/rds-its/xmlv5i/js/customers/righi.js]\n08-Mar-2016 10:16:35.864 FINE [ajp-apr-8109-exec-6] org.apache.catalina.connector.CoyoteAdapter.parsePathParameters The variable [semicolon] has value [-1]\n08-Mar-2016 10:16:35.864 FINE [ajp-apr-8109-exec-6] org.apache.catalina.connector.CoyoteAdapter.parsePathParameters The variable [enc] has value [ISO-8859-1]\n\nYou can observe the missing of:\nRequested cookie session id is CE848CE8D53223658BD8D69D5CB667D4.tom01v6 in logs\n\nlike observed in \"REQUEST OK HANDLING\"\n\nI suspect some problem in cookie parsing, what do you think?", "id": 189313, "time": "2016-03-09T17:33:32Z", "creator": "lanarimarco@gmail.com", "creation_time": "2016-03-09T17:33:32Z", "is_private": false}, {"count": 3, "tags": [], "creator": "markt@apache.org", "text": "See comment #1. The users list is the place for this discussion.", "id": 189339, "time": "2016-03-10T14:39:21Z", "bug_id": 59122, "creation_time": "2016-03-10T14:39:21Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 59122, "is_private": false, "count": 4, "id": 189346, "time": "2016-03-10T20:27:34Z", "creator": "lanarimarco@gmail.com", "creation_time": "2016-03-10T20:27:34Z", "text": "Ok. Sorry"}]