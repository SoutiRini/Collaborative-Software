[{"count": 0, "tags": [], "bug_id": 31448, "attachment_id": null, "id": 64299, "time": "2004-09-28T09:43:42Z", "creator": "alfred@freebsd.org", "creation_time": "2004-09-28T09:43:42Z", "is_private": false, "text": "This is pretty easy to replicate...\n\nTry to compile a module, but add this to the apxs compile line:\n\n-Wc,-Wall\n\nWhat happens is that apxs passes -Wall to BOTH gcc and libtool, then libtool\npasses cflags to ld(1) which breaks.\n\n/usr/local/apache2/bin/apxs -c  -Wc,-O -Wc,-pipe -Wc,-g -Wc,-I/usr/home/bright/w\nork/tourserve/itour2/../include -Wc,-I/usr/local/include -Wc,-I/usr/home/bright/\nwork/tourserve/itour2/../keys -Wc,-Wall -Wc,-Wno-format-y2k -Wc,-W -Wc,-Wmissing\n-prototypes -Wc,-Wpointer-arith -Wc,-Wreturn-type -Wc,-Wcast-qual -Wc,-Wwrite-st\nrings -Wc,-Wswitch -Wc,-Wcast-align -Wc,-Wno-uninitialized -Wc,-Werror -Wc,-I/us\nr/local/apache2/include -Wc,-DAPACHE_2 -Wc,-I../libfetch -Wc,-g -Wc,-I/usr/home/\nbright/work/tourserve/itour2/../include -Wc,-I/usr/local/include -Wc,-I/usr/home\n/bright/work/tourserve/itour2/../keys  -Wl,-L/usr/local/lib -Wl,-L../libfetch -W\nl,-L/usr/local/lib -Wl,../libfetch/libfetch.a -o mod_itour.so ../itour//mod_itou\nr.c\n/usr/local/apache2/build/libtool --silent --mode=compile gcc -prefer-pic  -DAP_H\nAVE_DESIGNATED_INITIALIZER -D_REENTRANT -D_THREAD_SAFE -g -O2 -I/usr/local/apach\ne2/include  -I/usr/local/apache2/include   -I/usr/local/apache2/include -I/usr/l\nocal/include -O -pipe -g -I/usr/home/bright/work/tourserve/itour2/../include -I/\nusr/local/include -I/usr/home/bright/work/tourserve/itour2/../keys -Wall -Wno-fo\nrmat-y2k -W -Wmissing-prototypes -Wpointer-arith -Wreturn-type -Wcast-qual -Wwri\nte-strings -Wswitch -Wcast-align -Wno-uninitialized -Werror -I/usr/local/apache2\n/include -DAPACHE_2 -I../libfetch -g -I/usr/home/bright/work/tourserve/itour2/..\n/include -I/usr/local/include -I/usr/home/bright/work/tourserve/itour2/../keys  \n-c -o ../itour//mod_itour.lo ../itour//mod_itour.c && touch ../itour//mod_itour.\nslo\n/usr/local/apache2/build/libtool --silent --mode=link gcc -o mod_itour.so -O -pi\npe -g -I/usr/home/bright/work/tourserve/itour2/../include -I/usr/local/include -\nI/usr/home/bright/work/tourserve/itour2/../keys -Wall -Wno-format-y2k -W -Wmissi\nng-prototypes -Wpointer-arith -Wreturn-type -Wcast-qual -Wwrite-strings -Wswitch\n -Wcast-align -Wno-uninitialized -Werror -I/usr/local/apache2/include -DAPACHE_2\n -I../libfetch -g -I/usr/home/bright/work/tourserve/itour2/../include -I/usr/loc\nal/include -I/usr/home/bright/work/tourserve/itour2/../keys  -Wc,-O -Wc,-pipe -W\nc,-g -Wc,-I/usr/home/bright/work/tourserve/itour2/../include -Wc,-I/usr/local/in\nclude -Wc,-I/usr/home/bright/work/tourserve/itour2/../keys -Wc,-Wall -Wc,-Wno-fo\nrmat-y2k -Wc,-W -Wc,-Wmissing-prototypes -Wc,-Wpointer-arith -Wc,-Wreturn-type -\nWc,-Wcast-qual -Wc,-Wwrite-strings -Wc,-Wswitch -Wc,-Wcast-align -Wc,-Wno-uninit\nialized -Wc,-Werror -Wc,-I/usr/local/apache2/include -Wc,-DAPACHE_2 -Wc,-I../lib\nfetch -Wc,-g -Wc,-I/usr/home/bright/work/tourserve/itour2/../include -Wc,-I/usr/\nlocal/include -Wc,-I/usr/home/bright/work/tourserve/itour2/../keys -Wl,-L/usr/lo\ncal/lib -Wl,-L../libfetch -Wl,-L/usr/local/lib -Wl,../libfetch/libfetch.a -rpath\n /usr/local/apache2/modules -module -avoid-version    ../itour//mod_itour.lo\n/usr/bin/ld: unrecognized option '-Wall'\n/usr/bin/ld: use the --help option for usage information\ncollect2: ld returned 1 exit status\napxs:Error: Command failed with rc=65536\n.\n*** Error code 1"}, {"attachment_id": null, "tags": [], "bug_id": 31448, "is_private": false, "count": 1, "id": 64307, "time": "2004-09-28T13:12:38Z", "creator": "jorton@redhat.com", "creation_time": "2004-09-28T13:12:38Z", "text": "Thanks for the report.  Can you try this patch for apxs.in:\n\nhttp://cvs.apache.org/viewcvs.cgi/httpd-2.0/support/apxs.in?r1=1.62&r2=1.63\n"}, {"count": 2, "tags": [], "bug_id": 31448, "attachment_id": null, "id": 64316, "time": "2004-09-28T13:44:10Z", "creator": "alfred@freebsd.org", "creation_time": "2004-09-28T13:44:10Z", "is_private": false, "text": "Thank you for the quick turnaround... This fixed passing CFLAGS, but now it's\ntrying to link the module standalone and barfing:\n\n~/work/tourserve/itour2 % make all    \n/usr/local/apache2/bin/apxs -c  -Wc,-O -Wc,-pipe -Wc,-g\n-Wc,-I/usr/home/bright/work/tourserve/itour2/../include -Wc,-I/usr/local/include\n-Wc,-I/usr/home/bright/work/tourserve/itour2/../keys -Wc,-Wall\n-Wc,-Wno-format-y2k -Wc,-W -Wc,-Wmissing-prototypes -Wc,-Wpointer-arith\n-Wc,-Wreturn-type -Wc,-Wcast-qual -Wc,-Wwrite-strings -Wc,-Wswitch\n-Wc,-Wcast-align -Wc,-Wno-uninitialized -Wc,-Werror\n-Wc,-I/usr/local/apache2/include -Wc,-DAPACHE_2 -Wc,-I../libfetch -Wc,-g\n-Wc,-I/usr/home/bright/work/tourserve/itour2/../include -Wc,-I/usr/local/include\n-Wc,-I/usr/home/bright/work/tourserve/itour2/../keys  -Wl,-L/usr/local/lib\n-Wl,-L../libfetch -Wl,-L/usr/local/lib -Wl,../libfetch/libfetch.a -o\nmod_itour.so ../itour//mod_itour.c\n/usr/local/apache2/build/libtool --silent --mode=compile gcc -prefer-pic \n-DAP_HAVE_DESIGNATED_INITIALIZER -D_REENTRANT -D_THREAD_SAFE -g -O2\n-I/usr/local/apache2/include  -I/usr/local/apache2/include  \n-I/usr/local/apache2/include -I/usr/local/include -O -pipe -g\n-I/usr/home/bright/work/tourserve/itour2/../include -I/usr/local/include\n-I/usr/home/bright/work/tourserve/itour2/../keys -Wall -Wno-format-y2k -W\n-Wmissing-prototypes -Wpointer-arith -Wreturn-type -Wcast-qual -Wwrite-strings\n-Wswitch -Wcast-align -Wno-uninitialized -Werror -I/usr/local/apache2/include\n-DAPACHE_2 -I../libfetch -g -I/usr/home/bright/work/tourserve/itour2/../include\n-I/usr/local/include -I/usr/home/bright/work/tourserve/itour2/../keys  -c -o\n../itour//mod_itour.lo ../itour//mod_itour.c && touch ../itour//mod_itour.slo\n/usr/local/apache2/build/libtool --silent --mode=link gcc -o mod_itour.so\n-L/usr/local/lib -L../libfetch -L/usr/local/lib ../libfetch/libfetch.a  -rpath\n/usr/local/apache2/modules -module -avoid-version    ../itour//mod_itour.lo\n/usr/lib/crt1.o(.text+0x81): In function `_start':\n: undefined reference to `main'\n../itour//mod_itour.o(.text+0x494): In function `create_server_config':\n../itour//mod_itour.c:254: undefined reference to `apr_palloc'\n../itour//mod_itour.o(.text+0x4b3):../itour//mod_itour.c:259: undefined\nreference to `ap_add_version_component'\n../itour//mod_itour.o(.text+0x4d5):../itour//mod_itour.c:260: undefined\nreference to `ap_log_error'\n../itour//mod_itour.o(.text+0x515): In function `itour_conf_master':\n../itour//mod_itour.c:275: undefined reference to `apr_pstrdup'\n../itour//mod_itour.o(.text+0x53c):../itour//mod_itour.c:276: undefined\nreference to `ap_log_error'\n../itour//mod_itour.o(.text+0x5ad): In function `itour_conf_timeout':\n../itour//mod_itour.c:291: undefined reference to `ap_log_error'\n../itour//mod_itour.o(.text+0x664): In function `itour_dbadd':\n../itour//mod_itour.c:363: undefined reference to `ap_log_error'\n../itour//mod_itour.o(.text+0x6dc): In function `itour_dbcheck':\n../itour//mod_itour.c:386: undefined reference to `ap_log_error'\n../itour//mod_itour.o(.text+0x701):../itour//mod_itour.c:392: undefined\nreference to `apr_psprintf'\n../itour//mod_itour.o(.text+0x754):../itour//mod_itour.c:397: undefined\nreference to `ap_log_error'\n../itour//mod_itour.o(.text+0x7b1):../itour//mod_itour.c:404: undefined\nreference to `ap_log_error'\n../itour//mod_itour.o(.text+0x7e8):../itour//mod_itour.c:408: undefined\nreference to `ap_log_error'\n../itour//mod_itour.o(.text+0x83b):../itour//mod_itour.c:416: undefined\nreference to `ap_log_error'\n../itour//mod_itour.o(.text+0x866):../itour//mod_itour.c:421: undefined\nreference to `apr_table_set'\n../itour//mod_itour.o(.text+0x898):../itour//mod_itour.c:426: undefined\nreference to `ap_rprintf'\n../itour//mod_itour.o(.text+0x8e9): In function `itour_remotequery':\n../itour//mod_itour.c:437: undefined reference to `ap_log_error'\n../itour//mod_itour.o(.text+0x984):../itour//mod_itour.c:458: undefined\nreference to `apr_table_set'\n../itour//mod_itour.o(.text+0x9a3):../itour//mod_itour.c:462: undefined\nreference to `ap_rprintf'\n../itour//mod_itour.o(.text+0x9e5): In function `itour_status_handler':\n../itour//mod_itour.c:470: undefined reference to `ap_log_error'\n../itour//mod_itour.o(.text+0xa75): In function `itour_register_hooks':\n../itour//mod_itour.c:537: undefined reference to `ap_hook_handler'\ncollect2: ld returned 1 exit status\napxs:Error: Command failed with rc=65536\n.\n*** Error code 1\n\nNote this is a FreeBSD 6.0 box."}, {"count": 3, "tags": [], "text": "If you must pass an \"-o\" option to apxs, it must be like \"-o mod_foo.la\"\notherwise you'll confuse libtool.  Can you try that?\n", "attachment_id": null, "id": 64320, "creator": "jorton@redhat.com", "time": "2004-09-28T13:56:21Z", "bug_id": 31448, "creation_time": "2004-09-28T13:56:21Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 31448, "attachment_id": null, "id": 64325, "time": "2004-09-28T14:37:03Z", "creator": "jorton@redhat.com", "creation_time": "2004-09-28T14:37:03Z", "is_private": false, "text": "I fixed apxs to handle \"-o mod_foo.so\" correctly too:\n\nhttp://cvs.apache.org/viewcvs.cgi/httpd-2.0/support/apxs.in?r1=1.63&r2=1.64\n\nThese changes will be proposed for backport for a future 2.0.x release.  You\ndon't have to escape -I and -D options using \"-Wc,-I\", by the way, apxs\nunderstands those already."}, {"count": 5, "tags": [], "text": "Well, here's the problem with that... :)\n\nI'm actually compiling in a seperate directory and using the VPATH/PATH\nfeature of make to locate my sources.  Even if I manually specify the source\nfile as ../itour/mod_itour.c apxs and libtool conspire to dump files out into\n../itour/ instead of the current working directory.\n\nAlso... why do I need to say \"-o mod_so.la\"?  What I really want is \"mod_so.so\".\n\nThis won't work for me.\n\nBasically:\n\nI have:\ntourserve/itour - sources + Apache13 makefile\ntourserve/itour2 - Apache2 makefile\n\nThe apache2 makefile just overrides a couple of knobs and includes the apache13\nmakefile.  But for some reason apxs decides to dump files into my source\ndirectories instead of my current directory.\n\nHere's a fix that prevents it, but only if you give a -o option to apxs, I\nhaven't figured out how to fix it without -o.\n\nBasically this patch just removes any leading pathnames from the source files\nwhen making the object file names:\n\n--- apxs.in     Mon Feb  9 12:59:49 2004\n+++ apxs.new    Tue Sep 28 07:47:18 2004\n@@ -400,13 +400,15 @@\n     my $s;\n     my $mod;\n     foreach $s (@srcs) {\n-        my $slo = $s;\n+        my $ss = $s;\n+        $ss =~ s|.*/||;\n+        my $slo = $ss;\n         $slo =~ s|\\.c$|.slo|;\n-        my $lo = $s;\n+        my $lo = $ss;\n         $lo =~ s|\\.c$|.lo|;\n-        my $la = $s;\n+        my $la = $ss;\n         $la =~ s|\\.c$|.la|;\n-        my $o = $s;\n+        my $o = $ss;\n         $o =~ s|\\.c$|.o|;\n         push(@cmds, \"$libtool $ltflags --mode=compile $CFG_CC $cflags -I$CFG_IN\nCLUDEDIR $apr_includedir $apu_includedir $opt -c -o $lo $s && touch $slo\");\n         unshift(@objs, $lo);\n@@ -419,12 +421,9 @@\n\n\nAlso, why do I need a \"-o mod_foo.la\", all i really want is \"mod_foo.o\", can't\nthat be fixed?", "is_private": false, "id": 64326, "creator": "alfred@freebsd.org", "time": "2004-09-28T14:50:21Z", "bug_id": 31448, "creation_time": "2004-09-28T14:50:21Z", "attachment_id": null}, {"count": 6, "tags": [], "text": "Created attachment 12885\nfix for object files being created in source dirs.", "attachment_id": 12885, "id": 64327, "creator": "alfred@freebsd.org", "time": "2004-09-28T14:57:35Z", "bug_id": 31448, "creation_time": "2004-09-28T14:57:35Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 31448, "is_private": false, "count": 7, "id": 64328, "time": "2004-09-28T14:58:40Z", "creator": "alfred@freebsd.org", "creation_time": "2004-09-28T14:58:40Z", "text": "Ok, I fixed it!\n\nThis should be applied, what it does it strip the leading pathnames from derived\nsources so that object files don't wind up in source directories:\n\nThe diff is attached.\n\nhttp://issues.apache.org/bugzilla/showattachment.cgi?attach_id=12885\n\n\n"}, {"count": 8, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "text": "WONTFIX to that: VPATH builds are complicated and apxs is supposed to be a\nsimple build tool.  If you want to do a VPATH build then you could symlink the\nsources across and then apxs should work OK.  The .so vs .la thing is fixed per\nmy comment above, too.\n\nThanks for the report.", "id": 64330, "time": "2004-09-28T16:27:37Z", "bug_id": 31448, "creation_time": "2004-09-28T16:27:37Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 31448, "attachment_id": null, "id": 64331, "time": "2004-09-28T16:28:40Z", "creator": "jorton@redhat.com", "creation_time": "2004-09-28T16:28:40Z", "is_private": false, "text": "(or use a proper Makefile as per the example created by \"apxs -g\", that should\nwork with VPATH builds or could be fixed to, at least)"}, {"count": 10, "tags": [], "text": "http://cvs.apache.org/viewcvs.cgi/httpd-2.0/support/apxs.in?r1=1.62&r2=1.64\ncommitted to httpd v2.0.53.", "is_private": false, "id": 65599, "creator": "minfrin@apache.org", "time": "2004-10-23T14:31:02Z", "bug_id": 31448, "creation_time": "2004-10-23T14:31:02Z", "attachment_id": null}]