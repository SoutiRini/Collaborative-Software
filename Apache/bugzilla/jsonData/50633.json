[{"count": 0, "attachment_id": 26532, "bug_id": 50633, "text": "Created attachment 26532\nWAR to reproduce the issue\n\nI attach a simple WAR file to illustrate this. To reproduce, follow these steps. Obviously the cookie ids etc. will be different for you.\n\n- deploy attached cookie-bug.war\n- delete JSESSIONID browser cookie for localhost\n\nFirst round:\n\n- go to http://localhost:8080/cookie-bug/do.jsp\n  - no Cookie header is sent by the browser\n  - Tomcat forwards to login.jsp\n  - Set-Cookie:JSESSIONID=8E5BD8A089735AEAAC1477F7F2C9A234; Path=/cookie-bug\n- enter \"tomcat\" as password and press Login\n- this POSTs to j_security_check\n  - Cookie: JSESSIONID=8E5BD8A089735AEAAC1477F7F2C9A234\n- do.jsp: JSESSIONID=8E5BD8A089735AEAAC1477F7F2C9A234\n  - Cookie: JSESSIONID=8E5BD8A089735AEAAC1477F7F2C9A234\n  - JSP displays\n    - requested: 8E5BD8A089735AEAAC1477F7F2C9A234\n    - session id: 8E5BD8A089735AEAAC1477F7F2C9A234\n    - cookie: JSESSIONID=8E5BD8A089735AEAAC1477F7F2C9A234\n- click on logout\n  - Cookie: JSESSIONID=8E5BD8A089735AEAAC1477F7F2C9A234\n- you are back to do.jsp\n  - Cookie: JSESSIONID=8E5BD8A089735AEAAC1477F7F2C9A234\n  - forwards to login.jsp\n  - Set-Cookie: JSESSIONID=A591F1194A99A1AA6CBDAE7511F0BF57; Path=/cookie-bug\n\nSo far so good! Now the second round:\n\n- enter \"tomcat\" as password and press Login\n- this POSTs to j_security_check\n  - Cookie: JSESSIONID=A591F1194A99A1AA6CBDAE7511F0BF57\n- do.jsp:\n  - Cookie: JSESSIONID=A591F1194A99A1AA6CBDAE7511F0BF57\n  - displays\n    - requested: A591F1194A99A1AA6CBDAE7511F0BF57\n    - session id: A591F1194A99A1AA6CBDAE7511F0BF57\n    - Cookie: JSESSIONID=8E5BD8A089735AEAAC1477F7F2C9A234 => how is this possible?\n\nEverything is fine *except* the Cookie value comes from nowhere!\n\nIt looks like there is a stale cookie that somehow got reused.", "id": 143572, "time": "2011-01-21T22:06:43Z", "creator": "erik@bruchez.org", "creation_time": "2011-01-21T22:06:43Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "text": "> It looks like there is a stale cookie that somehow got reused.\n\nIt comes from the request that was cached when you were redirected to the login form. That is by design.\n\nNote, that since 6.0.21 the session id is changed when you successfully pass authentication. This feature is an implementation for bug 45255 and can be turned off in configuration.\n\nMore details below.\n\n------------------------------------------------\nNote: You are missing the following from your reproduction recipe:\n1) The following user has to be added to tomcat-users.xml (it is commented out by default):\n  <user username=\"tomcat\" password=\"tomcat\" roles=\"tomcat\"/>\n\n2) In do.jsp the request.getCookies() call can return null, which results in NPE. I replaced the cycle on cookies in do.jsp with the following lines:\n<%  Cookie[] cookies = request.getCookies();\n  if (cookies == null) {\n    out.println(\"No cookies\");\n  } else {\n    for (Cookie cookie : cookies) out.println(cookie.getName() + \"=\" + cookie.getValue() + \"<br/>\");\n  }\n %>\n\nI am using Firefox 3.6.13 + Firebug 1.6.1, looking at the \"Network\" tab in Firebug.\n\nHere is what happens at the end of the First round, when clicking on \"logout\" link:\n-- Request (#1):\nGET http://localhost:8080/cookie-bug/logout.jsp\nCookie: JSESSIONID=30D060D22DE3C7F061C0CE5CA54F1B1B\n-- Response:\n302 Moved Temporarily\nLocation: http://localhost:8080/cookie-bug/do.jsp\n-- Request (#2):\nGET http://localhost:8080/cookie-bug/do.jsp\nCookie: JSESSIONID=30D060D22DE3C7F061C0CE5CA54F1B1B\n-- Response:\n200 OK\nSet-Cookie: JSESSIONID=01E55440D4AFC906EEB4B4B7899CD1AF; Path=/cookie-bug\n--\n\nThe login page is displayed.\n\nI am filling in password and submitting the form.\n\n-- Request (#3):\nPOST http://localhost:8080/cookie-bug/j_security_check\nCookie: JSESSIONID=01E55440D4AFC906EEB4B4B7899CD1AF\n-- Response:\n302 Moved Temporarily\nLocation: http://localhost:8080/cookie-bug/do.jsp\n-- Request (#4):\nGET http://localhost:8080/cookie-bug/do.jsp\nCookie: JSESSIONID=01E55440D4AFC906EEB4B4B7899CD1AF\n-- Response:\n200 OK\nSet-Cookie: JSESSIONID=8050014652FAB01314FC23D2774143BF; Path=/cookie-bug\n--\n\nThe page displays:\nRequested session id: 8050014652FAB01314FC23D2774143BF\nSession id: 8050014652FAB01314FC23D2774143BF\nCookies:\nJSESSIONID=30D060D22DE3C7F061C0CE5CA54F1B1B\n\nThe explanation:\nTomcat caches the request (#2) with all its headers and cookies and replays it for you when browser resends the request after successful authentication. I.e., when (#4) is received you are not seeing it, but you are seeing data from (#2) instead.\n\nSo the session id is new, but the cookie is an old one.\n\nI do not see an issue here. I am closing this as INVALID. Please ask on the users@ list if you have other questions.", "id": 143573, "time": "2011-01-22T10:18:19Z", "bug_id": 50633, "creation_time": "2011-01-22T10:18:19Z", "is_private": false}, {"count": 2, "tags": [], "text": "Konstantin, I appreciate the prompt reply and explanation.", "is_private": false, "id": 143584, "creator": "erik@bruchez.org", "time": "2011-01-22T16:51:21Z", "bug_id": 50633, "creation_time": "2011-01-22T16:51:21Z", "attachment_id": null}]