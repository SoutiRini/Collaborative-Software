[{"count": 0, "tags": [], "creator": "apache@ganyo.com", "attachment_id": null, "text": "FOUND A JAVA LEVEL DEADLOCK:\n----------------------------\n\"Thread-4\":\n  waiting to lock monitor 0x8022ec (object 0x33b3b78, a\norg.apache.catalina.loader.ResourceEntry),\n  which is locked by \"task\"\n\"task\":\n  waiting to lock monitor 0x80226c (object 0x2d965c8, a\norg.apache.catalina.loader.WebappClassLoader),\n  which is locked by \"Thread-4\"\n\nJAVA STACK INFORMATION FOR THREADS LISTED ABOVE:\n------------------------------------------------\nJava Stack for \"Thread-4\":\n==========\n        at\norg.apache.catalina.loader.WebappClassLoader.findClassInternal(WebappClassLoader.java:1660)\n        - waiting to lock <33b3b78> (a org.apache.catalina.loader.ResourceEntry)\n        at\norg.apache.catalina.loader.WebappClassLoader.findClass(WebappClassLoader.java:953)\n        at\norg.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1390)\n        at\norg.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1270)\n        at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:310)\n        - locked <2d965c8> (a org.apache.catalina.loader.WebappClassLoader)\n        at com.eTapestry.services.ServiceLocator.<clinit>(ServiceLocator.java:35)\n        at\ncom.eTapestry.presentation.filters.AuthenticationFilter.validateSignOn(AuthenticationFilter.java:125)\n        at\ncom.eTapestry.presentation.filters.AuthenticationFilter.doFilter(AuthenticationFilter.java:74)\n        at\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:213)\n        at\norg.apache.catalina.core.ApplicationFilterChain.access$000(ApplicationFilterChain.java:98)\n        at\norg.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:176)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:172)\n        at\ncom.eTapestry.presentation.filters.RequestLogFilter.doFilter(RequestLogFilter.java:70)\n        at\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:213)\n        at\norg.apache.catalina.core.ApplicationFilterChain.access$000(ApplicationFilterChain.java:98)\n        at\norg.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:176)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:172)\n        at\norg.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:260)\n        at\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n        at\norg.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n        at org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n        at\norg.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)\n        at\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n        at\norg.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n        at org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n        at\norg.apache.catalina.core.StandardContext.invoke(StandardContext.java:2350)\n        at\norg.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:180)\n        at\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n        at\norg.apache.catalina.valves.ErrorDispatcherValve.invoke(ErrorDispatcherValve.java:170)\n        at\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:641)\n        at\norg.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:171)\n        at\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:641)\n        at\norg.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n        at org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n        at\norg.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:174)\n        at\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n        at\norg.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n        at org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n        at org.apache.coyote.tomcat4.CoyoteAdapter.service(CoyoteAdapter.java:223)\n        at\norg.apache.coyote.http11.Http11Processor.process(Http11Processor.java:405)\n        at\norg.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.processConnection(Http11Protocol.java:380)\n        at\norg.apache.tomcat.util.net.TcpWorkerThread.runIt(PoolTcpEndpoint.java:508)\n        at\norg.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:533)\n        at java.lang.Thread.run(Thread.java:479)\nJava Stack for \"task\":\n==========\n        at java.lang.ClassLoader.checkCerts(ClassLoader.java:530)\n        - waiting to lock <2d965c8> (a org.apache.catalina.loader.WebappClassLoader)\n        at java.lang.ClassLoader.defineClass(ClassLoader.java:482)\n        at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:106)\n        at\norg.apache.catalina.loader.WebappClassLoader.findClassInternal(WebappClassLoader.java:1661)\n        - locked <33b3b78> (a org.apache.catalina.loader.ResourceEntry)\n        at\norg.apache.catalina.loader.WebappClassLoader.findClass(WebappClassLoader.java:953)\n        at\norg.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1390)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:287)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:250)\n        at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:310)\n        - locked <3366ab0> (a sun.rmi.server.LoaderHandler$Loader)\n        at java.lang.Class.getField0(Native Method)\n        at java.lang.Class.getDeclaredField(Class.java:1108)\n        at java.io.ObjectStreamClass$1.run(ObjectStreamClass.java:295)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at java.io.ObjectStreamClass.init(ObjectStreamClass.java:288)\n        - locked <33c4808> (a java.lang.Object)\n        at java.io.ObjectStreamClass.lookupInternal(ObjectStreamClass.java:107)\n        at java.io.ObjectStreamClass.setClass(ObjectStreamClass.java:561)\n        at\njava.io.ObjectInputStream.inputClassDescriptor(ObjectInputStream.java:931)\n        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:361)\n        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:231)\n        at java.io.ObjectInputStream.inputObject(ObjectInputStream.java:1181)\n        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:381)\n        at java.io.ObjectInputStream.inputClassFields(ObjectInputStream.java:2258)\n        at java.io.ObjectInputStream.defaultReadObject(ObjectInputStream.java:514)\n        at java.io.ObjectInputStream.inputObject(ObjectInputStream.java:1407)\n        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:381)\n        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:231)\n        at java.rmi.MarshalledObject.get(MarshalledObject.java:133)\n        at\nnet.jini.discovery.IncomingUnicastResponse.<init>(IncomingUnicastResponse.java:72)\n        at\nnet.jini.discovery.LookupDiscovery$UnicastDiscoveryTask.run(LookupDiscovery.java:712)\n        at com.sun.jini.thread.TaskManager$TaskThread.run(TaskManager.java:271)\n\nFound 1 deadlock.", "id": 20443, "time": "2002-07-30T20:15:29Z", "bug_id": 11307, "creation_time": "2002-07-30T20:15:29Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 11307, "is_private": false, "text": "Could you provide more information about your configuration\nand the application you are running.\nOne of the threads with the deadlock is not a thread created by\nTomcat 4.", "id": 20484, "time": "2002-07-31T13:45:07Z", "creator": "glenn@apache.org", "creation_time": "2002-07-31T13:45:07Z", "attachment_id": null}, {"count": 2, "attachment_id": null, "bug_id": 11307, "is_private": false, "id": 20488, "time": "2002-07-31T14:43:02Z", "creator": "apache@ganyo.com", "creation_time": "2002-07-31T14:43:02Z", "tags": [], "text": "Sure.  The application is a Struts application utilizing JSP and Servlets.  The\nnon-tomcat thread that you see in the ClassLoader is from one of the Jini\nLookupDiscovery threads handling a response from the LookupService informing it\nthat a service matching the requested template was found.  This necessitates the\nremote class loading to be able to unmarshall the response."}, {"count": 3, "tags": [], "bug_id": 11307, "text": "Could you provide a simple example web application and instructions\non how to reproduce this?\n\nAlso, what JVM are you using?", "id": 20511, "time": "2002-08-01T05:58:07Z", "creator": "glenn@apache.org", "creation_time": "2002-08-01T05:58:07Z", "is_private": false, "attachment_id": null}, {"count": 4, "attachment_id": null, "bug_id": 11307, "is_private": false, "id": 20532, "time": "2002-08-01T12:54:08Z", "creator": "apache@ganyo.com", "creation_time": "2002-08-01T12:54:08Z", "tags": [], "text": "java version \"1.3.1_03\"\nJava(TM) 2 Runtime Environment, Standard Edition (build 1.3.1_03-b03)\nJava HotSpot(TM) Client VM (build 1.3.1_03-b03, mixed mode)\n\nSorry, I wish I had time to produce an example, but that's just not going to be\npossible right now given my current employment duties."}, {"count": 5, "tags": [], "bug_id": 11307, "text": "I am still unable to reproduce this. Sorry, but someone who can reproduce it\nwill have to fix it. The lock trace also looks fine (ie: the locks are on\ndifferent objects, so I don't see where the problem is). This works fine for me.", "id": 20801, "time": "2002-08-08T14:46:23Z", "creator": "remm@apache.org", "creation_time": "2002-08-08T14:46:23Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "creator": "apache@ganyo.com", "attachment_id": null, "text": "Maybe you can't reproduce it and/or fix it, but the lock trace is definitely not\nfine.  Reread it.  There is a deadlock shown very clearly.  IMO, this should\n*NOT* be marked as \"resolved\" regardless of your ability to fix it.", "id": 20806, "time": "2002-08-08T14:53:41Z", "bug_id": 11307, "creation_time": "2002-08-08T14:53:41Z", "is_private": false}, {"count": 7, "attachment_id": null, "bug_id": 11307, "is_private": false, "id": 20819, "time": "2002-08-08T21:27:49Z", "creator": "remm@apache.org", "creation_time": "2002-08-08T21:27:49Z", "tags": [], "text": "Sorry, but I need an explanation. The trace looks fine to me (thread 1 wants to\nlock the CL, while thread 2 waits on a ResourceEntry). If you understand what\nthe problem is and you can explain it to me, maybe you could also take five\nminutes, and help everyone here, as: I really don't understand what the problem\nis, and, more importantly, I cannot reproduce this and never ran into this\nproblem (so it does work for me)."}, {"count": 8, "attachment_id": null, "bug_id": 11307, "is_private": false, "id": 20822, "time": "2002-08-08T21:47:34Z", "creator": "apache@ganyo.com", "creation_time": "2002-08-08T21:47:34Z", "tags": [], "text": "Sorry, I was a bit short in my last message... I was just dismayed that the bug\nwas being marked as \"resolved\" despite the documentation to the contrary.\n\nAnyway, you're right, the Threads are trying to lock different objects.  The\nproblem is that each Thread has already locked what the other Thread now wants\nto lock.  Looking at the stack traces, you'll see:\n\n\"Thread-4\" at WebappClassLoader.java:1660 is trying to lock object \"0x33b3b78\"\n(a org.apache.catalina.loader.ResourceEntry) but \"task\" has already locked that\nobject at WebappClassLoader.java:1661.\n\nLikewise, \"task\" at ClassLoader.java:530 wants to lock object \"0x2d965c8\" (a\norg.apache.catalina.loader.WebappClassLoader), but \"Thread-4\" has already locked\nthat object at ClassLoader.java:310.\n\n(Aside: I agree, threaded deadlocks are notoriously hard to reproduce. \nGenerally I end up having to examine the stacks and audit the code to find out\nwhat went wrong.  Given that I'm not familiar with the Catalina code, don't have\nan environment set up to work on it, and am desparately trying to meet a\ndeadline at work, I just have to apologize profusely for not being able to help\nright now.  But please let me know if I can explain anything else that would\nhelp you navigate the deadlock information.)\n"}, {"count": 9, "tags": [], "bug_id": 11307, "text": "Ok, thanks for the explanation. I think I understand the issue a bit better now.", "id": 20838, "time": "2002-08-09T10:03:05Z", "creator": "remm@apache.org", "creation_time": "2002-08-09T10:03:05Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "text": "This is likely fixed in CVS. Please confirm. The fix will be in 4.1.9.", "id": 20840, "time": "2002-08-09T10:12:02Z", "bug_id": 11307, "creation_time": "2002-08-09T10:12:02Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 11307, "is_private": false, "text": "Yes, this does look to be fixed.  Thank you.", "id": 20917, "time": "2002-08-12T15:27:58Z", "creator": "apache@ganyo.com", "creation_time": "2002-08-12T15:27:58Z", "attachment_id": null}, {"count": 12, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "text": "Thanks a lot for the help fixing this and for the confirmation. You clearly had\na better idea of what the problem was.", "id": 21055, "time": "2002-08-14T20:15:48Z", "bug_id": 11307, "creation_time": "2002-08-14T20:15:48Z", "is_private": false}]