[{"count": 0, "tags": [], "bug_id": 60346, "text": "Created attachment 34423\nTemplate with embedding to reproduce the bug.\n\n1) Create an SXSSF workbook from template that has an embedding.\n2) Create a sheet\n3) Move sheet to first position\n4) Create a cell and set a comment\n5) Write out the workbook\n\nResult: the embedding from the template lost its formula, so it is not possible to open from Excel.\n\n(Order of step 3 and 4 can be changed)\n\nSample template attached.\n\n\nimport java.io.File;\nimport java.io.FileOutputStream;\nimport java.io.IOException;\nimport org.apache.poi.openxml4j.exceptions.InvalidFormatException;\nimport org.apache.poi.ss.usermodel.Cell;\nimport org.apache.poi.ss.usermodel.ClientAnchor;\nimport org.apache.poi.ss.usermodel.Comment;\nimport org.apache.poi.ss.usermodel.CreationHelper;\nimport org.apache.poi.ss.usermodel.Drawing;\nimport org.apache.poi.ss.usermodel.RichTextString;\nimport org.apache.poi.ss.usermodel.Row;\nimport org.apache.poi.ss.usermodel.Sheet;\nimport org.apache.poi.xssf.streaming.SXSSFWorkbook;\nimport org.apache.poi.xssf.usermodel.XSSFWorkbook;\n\n/**\n *\n * @author Szenthe L\u00e1szl\u00f3\n */\npublic class TestAttach {\n\n    public static final String WORKDIR = \"C:\\\\tmp\";\n    \n    public static void main(String[] args) throws Throwable {\n        try {\n\n            // Open the template workbook containing an embedding\n            SXSSFWorkbook wb = new SXSSFWorkbook(new XSSFWorkbook(new File( WORKDIR + File.separator + \"xlsx.xlsx\")));\n\n            // Create a sheet\n            Sheet sheet = wb.createSheet(\"test\");\n            \n            // Insert into first position\n            wb.setSheetOrder(\"test\", 0);\n            \n            // Create a cell with comment attached\n            Row row = sheet.createRow(1);\n            Cell cell = row.createCell(1);\n\n            CreationHelper factory = wb.getCreationHelper();\n            Drawing drawing = sheet.createDrawingPatriarch();\n\n            ClientAnchor anchor = factory.createClientAnchor();\n            anchor.setCol1(cell.getColumnIndex());\n            anchor.setCol2(cell.getColumnIndex() + 3);\n            anchor.setRow1(row.getRowNum());\n            anchor.setRow2(row.getRowNum() + 6);\n\n            \n            Comment comment;\n            comment = drawing.createCellComment(anchor);\n            RichTextString str = factory.createRichTextString(\"comment\");\n            comment.setString(str);\n            //comment.setAuthor(\"Author\");\n\n            // Assign the comment to the cell\n            cell.setCellComment(comment);\n            \n            \n            \n            // Write out the workbook\n            wb.write(new FileOutputStream(new File(WORKDIR, \"out.xlsx\")));\n            \n        } catch (IOException | InvalidFormatException ex) {\n            ex.printStackTrace();\n        }\n\n    }\n}", "id": 194839, "attachment_id": 34423, "creator": "lacus-apache@rainstorm.org", "creation_time": "2016-11-06T11:24:28Z", "time": "2016-11-06T11:24:28Z", "is_private": false}]