[{"attachment_id": null, "tags": [], "bug_id": 34090, "is_private": false, "count": 0, "id": 72730, "time": "2005-03-20T22:54:24Z", "creator": "m.bock@odisys.de", "creation_time": "2005-03-20T22:54:24Z", "text": "Since tomcat 5.X, we are not able to load persistant sessions on tomcat start.\nThe attached exception is thrown on tomcat start (s. below).\nAfter investigating the problem, it seems to be caused by the class\norg.apache.catalina.util.CustomObjectInputStream. The method defined there\n\n    public Class resolveClass(ObjectStreamClass classDesc)\n        throws ClassNotFoundException, IOException {\n        return Class.forName(classDesc.getName(), false, classLoader);\n    }\n\ndoesn't have the fallback of it's superclass java.io.ObjectInputStream\n\n    protected Class resolveClass(ObjectStreamClass desc)\n\tthrows IOException, ClassNotFoundException\n    {\n\tString name = desc.getName();\n\ttry {\n\t    return Class.forName(name, false, latestUserDefinedLoader());\n\t} catch (ClassNotFoundException ex) {\n\t    Class cl = (Class) primClasses.get(name);\n\t    if (cl != null) {\n\t\treturn cl;\n\t    } else {\n\t\tthrow ex;\n\t    }\n\t}\n    }\n\nso primitive classes result in a java.lang.ClassNotFoundException.\nTo prove this, I serialized our complete session-data with writeObject and\nreadObject. Using the standard classes, no exception was thrown.\n\nHere's the exception:\n\nClassNotFoundException while loading persisted sessions:\njava.lang.ClassNotFoundException: int\njava.lang.ClassNotFoundException: int\n\tat\norg.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1340)\n\tat\norg.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1189)\n\tat java.lang.ClassLoader.loadClassInternal(ClassLoader.java:302)\n\tat java.lang.Class.forName0(Native Method)\n\tat java.lang.Class.forName(Class.java:219)\n\tat\norg.apache.catalina.util.CustomObjectInputStream.resolveClass(CustomObjectInputStream.java:72)\n\tat java.io.ObjectInputStream.readNonProxyDesc(ObjectInputStream.java:1513)\n\tat java.io.ObjectInputStream.readClassDesc(ObjectInputStream.java:1435)\n\tat java.io.ObjectInputStream.readClass(ObjectInputStream.java:1402)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1260)\n\tat java.io.ObjectInputStream.defaultReadFields(ObjectInputStream.java:1845)\n\tat java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:1769)\n\tat java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1646)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1274)\n\tat java.io.ObjectInputStream.readArray(ObjectInputStream.java:1603)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1271)\n\tat java.io.ObjectInputStream.defaultReadFields(ObjectInputStream.java:1845)\n\tat java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:1769)\n\tat java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1646)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1274)\n\tat java.io.ObjectInputStream.defaultReadFields(ObjectInputStream.java:1845)\n\tat java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:1769)\n\tat java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1646)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1274)\n\tat java.io.ObjectInputStream.readObject(ObjectInputStream.java:324)\n\tat java.util.ArrayList.readObject(ArrayList.java:547)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat\nsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:324)\n\tat java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:838)\n\tat java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:1746)\n\tat java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1646)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1274)\n\tat java.io.ObjectInputStream.defaultReadFields(ObjectInputStream.java:1845)\n\tat java.io.ObjectInputStream.defaultReadObject(ObjectInputStream.java:452)\n\tat de.odisys.bo.Session.readObject(Session.java:930)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat\nsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:324)\n\tat java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:838)\n\tat java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:1746)\n\tat java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1646)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1274)\n\tat java.io.ObjectInputStream.defaultReadFields(ObjectInputStream.java:1845)\n\tat java.io.ObjectInputStream.defaultReadObject(ObjectInputStream.java:452)\n\tat de.odisys.bo.ServletSession.readObject(ServletSession.java:216)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat\nsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:324)\n\tat java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:838)\n\tat java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:1746)\n\tat java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1646)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1274)\n\tat java.io.ObjectInputStream.readObject(ObjectInputStream.java:324)\n\tat\norg.apache.catalina.session.StandardSession.readObject(StandardSession.java:1342)\n\tat\norg.apache.catalina.session.StandardSession.readObjectData(StandardSession.java:885)\n\tat org.apache.catalina.session.StandardManager.doLoad(StandardManager.java:416)\n\tat org.apache.catalina.session.StandardManager.load(StandardManager.java:343)\n\tat org.apache.catalina.session.StandardManager.start(StandardManager.java:657)\n\tat org.apache.catalina.core.ContainerBase.setManager(ContainerBase.java:499)\n\tat org.apache.catalina.startup.ContextConfig.managerConfig(ContextConfig.java:315)\n\tat org.apache.catalina.startup.ContextConfig.start(ContextConfig.java:635)\n\tat org.apache.catalina.startup.ContextConfig.lifecycleEvent(ContextConfig.java:216)\n\tat\norg.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:119)\n\tat org.apache.catalina.core.StandardContext.start(StandardContext.java:4290)\n\tat org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:823)\n\tat org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:807)\n\tat org.apache.catalina.core.StandardHost.addChild(StandardHost.java:595)\n\tat\norg.apache.catalina.core.StandardHostDeployer.addChild(StandardHostDeployer.java:903)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat\nsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:324)\n\tat org.apache.commons.beanutils.MethodUtils.invokeMethod(MethodUtils.java:216)\n\tat org.apache.commons.digester.SetNextRule.end(SetNextRule.java:256)\n\tat org.apache.commons.digester.Rule.end(Rule.java:276)\n\tat org.apache.commons.digester.Digester.endElement(Digester.java:1058)\n\tat org.apache.catalina.util.CatalinaDigester.endElement(CatalinaDigester.java:76)\n\tat org.apache.xerces.parsers.AbstractSAXParser.endElement(Unknown Source)\n\tat org.apache.xerces.impl.XMLDocumentFragmentScannerImpl.scanEndElement(Unknown\nSource)\n\tat\norg.apache.xerces.impl.XMLDocumentFragmentScannerImpl$FragmentContentDispatcher.dispatch(Unknown\nSource)\n\tat org.apache.xerces.impl.XMLDocumentFragmentScannerImpl.scanDocument(Unknown\nSource)\n\tat org.apache.xerces.parsers.XML11Configuration.parse(Unknown Source)\n\tat org.apache.xerces.parsers.XML11Configuration.parse(Unknown Source)\n\tat org.apache.xerces.parsers.XMLParser.parse(Unknown Source)\n\tat org.apache.xerces.parsers.AbstractSAXParser.parse(Unknown Source)\n\tat org.apache.commons.digester.Digester.parse(Digester.java:1567)\n\tat\norg.apache.catalina.core.StandardHostDeployer.install(StandardHostDeployer.java:488)\n\tat org.apache.catalina.core.StandardHost.install(StandardHost.java:863)\n\tat org.apache.catalina.startup.HostConfig.deployDescriptors(HostConfig.java:483)\n\tat org.apache.catalina.startup.HostConfig.deployApps(HostConfig.java:427)\n\tat org.apache.catalina.startup.HostConfig.start(HostConfig.java:983)\n\tat org.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java:349)\n\tat\norg.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:119)\n\tat org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1091)\n\tat org.apache.catalina.core.StandardHost.start(StandardHost.java:789)\n\tat org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1083)\n\tat org.apache.catalina.core.StandardEngine.start(StandardEngine.java:478)\n\tat org.apache.catalina.core.StandardService.start(StandardService.java:480)\n\tat org.apache.catalina.core.StandardServer.start(StandardServer.java:2313)\n\tat org.apache.catalina.startup.Catalina.start(Catalina.java:556)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat\nsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:324)\n\tat org.apache.catalina.startup.Bootstrap.start(Bootstrap.java:287)\n\tat org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:425)"}, {"count": 1, "tags": [], "bug_id": 34090, "attachment_id": null, "id": 47968, "time": "2005-03-21T17:40:41Z", "creator": "remm@apache.org", "creation_time": "2005-03-21T17:40:41Z", "is_private": false, "text": "Whatever it is you are doing is absolutely scary. I tried to see if calling the\nsuperclass helps and does not cause regressions or problems, as the field you\nmention cannot be used."}, {"count": 2, "tags": [], "text": "(In reply to comment #1)\n> Whatever it is you are doing is absolutely scary. I tried to see if calling the\n> superclass helps and does not cause regressions or problems, as the field you\n> mention cannot be used.\n\nAfter a lot of investigation, I've found the underlying problem. Catalina's\nCustomObjectInputStream seems to be unable to deserialize the Class-Objects of\nthe build-in types like Integer.TYPE or Long.TYPE. Other Class-Objects cause no\nproblems. After eliminanting this Class-Object from our code, the session is\nrestored successfully on Tomcat startup. \nI would classify this as a bug, because the Class-Objects of the build-in types\nshould be serializable. The standard ObjectInputStream has no problem with these\nClass-Objects.", "is_private": false, "bug_id": 34090, "id": 45842, "time": "2005-03-21T21:16:03Z", "creator": "m.bock@odisys.de", "creation_time": "2005-03-21T21:16:03Z", "attachment_id": null}, {"count": 3, "tags": [], "text": "Unfortunately, I think this will not going to be fixed for a variety of reasons.\nCalling the superclass, which seems the only acceptable solution, might cause\nrandom problems (although feel free to test it; if you manage to convince me\nthat it is safe because you tested it extensively, then I might commit the change).", "attachment_id": null, "id": 42432, "creator": "remm@apache.org", "time": "2005-03-22T11:05:55Z", "bug_id": 34090, "creation_time": "2005-03-22T11:05:55Z", "is_private": false}, {"count": 4, "text": "This bug is actually fixed in (or before) apache-tomcat-6.0.14:\n\n    public Class resolveClass(ObjectStreamClass classDesc)\n        throws ClassNotFoundException, IOException {\n        try {\n            return Class.forName(classDesc.getName(), false, classLoader);\n        } catch (ClassNotFoundException e) {\n            // Try also the superclass because of primitive types\n            return super.resolveClass(classDesc);\n        }\n    }\n\nSo this bug can be closed and Michael, yes you were right all the way.\n\n", "creator": "jos.coenen@ibs.nl", "attachment_id": null, "id": 106967, "time": "2007-08-21T08:23:14Z", "bug_id": 34090, "creation_time": "2007-08-21T08:23:14Z", "tags": [], "is_private": false}]