[{"count": 0, "tags": [], "creator": "patric@rufflar.com", "text": "java.lang.NullPointerException\n\tat java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:768)\n\tat org.apache.tomcat.jdbc.pool.interceptor.SlowQueryReport.getQueryStats(SlowQueryReport.java:156)\n\tat org.apache.tomcat.jdbc.pool.interceptor.SlowQueryReport.reportFailedQuery(SlowQueryReport.java:85)\n\tat org.apache.tomcat.jdbc.pool.interceptor.SlowQueryReportJmx.reportFailedQuery(SlowQueryReportJmx.java:147)\n\tat org.apache.tomcat.jdbc.pool.interceptor.AbstractQueryReport$StatementProxy.invoke(AbstractQueryReport.java:236)", "id": 148270, "time": "2011-07-29T08:07:18Z", "bug_id": 51582, "creation_time": "2011-07-29T08:07:18Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 51582, "text": "Another one:\n\njava.lang.NullPointerException\n\tat org.apache.tomcat.jdbc.pool.interceptor.SlowQueryReport.reportFailedQuery(SlowQueryReport.java:86)\n\tat org.apache.tomcat.jdbc.pool.interceptor.SlowQueryReportJmx.reportFailedQuery(SlowQueryReportJmx.java:147)\n\tat org.apache.tomcat.jdbc.pool.interceptor.AbstractQueryReport$StatementProxy.invoke(AbstractQueryReport.java:236)\n\tat $Proxy7.executeQuery(Unknown Source)", "count": 1, "id": 148592, "time": "2011-08-12T14:10:40Z", "creator": "patric@rufflar.com", "creation_time": "2011-08-12T14:10:40Z", "is_private": false}, {"count": 2, "tags": [], "creator": "patric@rufflar.com", "attachment_id": null, "id": 148593, "time": "2011-08-12T14:15:43Z", "bug_id": 51582, "creation_time": "2011-08-12T14:15:43Z", "is_private": false, "text": "Both exceptions seems to be caused due to race conditions (one thread is executing a statement, while another one is canceling it and possibly closing the ProxyConnection)"}, {"count": 3, "tags": [], "creator": "patric@rufflar.com", "text": "And also another one (most probably they all have the same cause).\n\njava.lang.NullPointerException\n at org.apache.tomcat.jdbc.pool.interceptor.SlowQueryReport.reportSlowQuery(SlowQueryReport.j\nava:96)\n at org.apache.tomcat.jdbc.pool.interceptor.SlowQueryReportJmx.reportSlowQuery(SlowQueryRepor\ntJmx.java:181)\n at org.apache.tomcat.jdbc.pool.interceptor.AbstractQueryReport$StatementProxy.invoke(Abstrac\ntQueryReport.java:250)\n at $Proxy104.executeQuery(Unknown Source)\n\n\nWe're seeing this issue pretty often - is there an estimation when it is going to be fixed?", "id": 150495, "time": "2011-10-12T13:54:12Z", "bug_id": 51582, "creation_time": "2011-10-12T13:54:12Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 51582, "attachment_id": null, "text": "(In reply to comment #0)\n> java.lang.NullPointerException\n>     at java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:768)\n>     at\n> org.apache.tomcat.jdbc.pool.interceptor.SlowQueryReport.getQueryStats(SlowQueryReport.java:156)\n>     at\n> org.apache.tomcat.jdbc.pool.interceptor.SlowQueryReport.reportFailedQuery(SlowQueryReport.java:85)\n>     at\n> org.apache.tomcat.jdbc.pool.interceptor.SlowQueryReportJmx.reportFailedQuery(SlowQueryReportJmx.java:147)\n>     at\n> org.apache.tomcat.jdbc.pool.interceptor.AbstractQueryReport$StatementProxy.invoke(AbstractQueryReport.java:236)\n\n\nThis error implies the SQL is null. Do you have a full stack trace for this one?", "id": 150976, "time": "2011-10-27T19:47:47Z", "creator": "fhanik@apache.org", "creation_time": "2011-10-27T19:47:47Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 51582, "attachment_id": null, "text": "Patrick, in r1189978 this has been fixed. However, if you could post a full stack trace so I can figure out why there is no 'sql' string present, ie, I've missed a call that doesn't call", "id": 150977, "time": "2011-10-27T20:01:18Z", "creator": "fhanik@apache.org", "creation_time": "2011-10-27T20:01:18Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 51582, "attachment_id": null, "text": "Hi Filip,\n\nhere is an extended stacktrace of comment #0, however I truncated the lower stack trace elements.\n\n> (In reply to comment #0)\n\nNote: As the name implies, CStatement.cancel() calls cancel() on the jdbc-pool's Proxy of the jdbc Statement.\n\n\njava.lang.NullPointerException\n        at java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:768)\n        at org.apache.tomcat.jdbc.pool.interceptor.SlowQueryReport.getQueryStats(SlowQueryReport.jav\na:156)\n        at org.apache.tomcat.jdbc.pool.interceptor.SlowQueryReport.reportFailedQuery(SlowQueryReport\n.java:85)\n        at org.apache.tomcat.jdbc.pool.interceptor.SlowQueryReportJmx.reportFailedQuery(SlowQueryRep\nortJmx.java:147)\n        at org.apache.tomcat.jdbc.pool.interceptor.AbstractQueryReport$StatementProxy.invoke(Abstrac\ntQueryReport.java:236)\n        at $Proxy96.cancel(Unknown Source)\n        at my.product.jdbc.CStatement.cancel(CStatement.java:97)\n\t\t\n\n\nBTW: What about the NPE in comment #1? It's unlikely that this exception related to a null sql query.", "id": 150978, "time": "2011-10-27T20:14:28Z", "creator": "patric@rufflar.com", "creation_time": "2011-10-27T20:14:28Z", "is_private": false}, {"count": 7, "tags": [], "text": "(In reply to comment #6)\n\n> \n> BTW: What about the NPE in comment #1? It's unlikely that this exception\n> related to a null sql query.\n\nhi Patric, I think it is very likely, the statement is\n\n            QueryStats qs = this.getQueryStats(sql);\n            qs.failure(delta, now);  <-- NPE here\n\nif SQL is null, the qs variable is also null\n\nFilip", "attachment_id": null, "bug_id": 51582, "id": 151910, "time": "2011-12-02T01:04:49Z", "creator": "fhanik@apache.org", "creation_time": "2011-12-02T01:04:49Z", "is_private": false}, {"count": 8, "tags": [], "creator": "patric@rufflar.com", "text": "Hi Filip,\n\nI was able to debug the NPE situation (during a load test):\nsql is suprisingly _not_ null, but SlowQueryReport.this.queries is:\n\n    protected QueryStats getQueryStats(String sql) {\n        ConcurrentHashMap<String,QueryStats> queries = SlowQueryReport.this.queries;\n        if (queries==null) return null;    <-- null is returned here\n...", "id": 153199, "time": "2012-01-26T18:04:42Z", "bug_id": 51582, "creation_time": "2012-01-26T18:04:42Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 51582, "attachment_id": 28218, "text": "Created attachment 28218\ntest application to reproduce the bug\n\nThis test application will do concurrently\n- execute a statement\n- cancel it\n- close the connection\n\nand repeat those steps infinitely.\n\nOn my machine, I am seeing the NPE every 5 seconds with this application.\n(tested with oracle jdbc driver and database)\nPlease note, that you have to adjust user/pass/url/query.\n\nThe connection.close() is the source of the issue, which sets the query concurrent hash map to null.", "id": 153208, "time": "2012-01-27T09:22:10Z", "creator": "patric@rufflar.com", "creation_time": "2012-01-27T09:22:10Z", "is_private": false}, {"count": 10, "tags": [], "creator": "fhanik@apache.org", "attachment_id": null, "id": 153744, "time": "2012-02-13T19:08:19Z", "bug_id": 51582, "creation_time": "2012-02-13T19:08:19Z", "is_private": false, "text": "Fixed in r1243655\nit was setting the query cache to null when the connection was returned to the pool instead of when the connection was actually closed"}, {"count": 11, "tags": [], "text": "Thanks, Filip and welcome back.", "attachment_id": null, "bug_id": 51582, "id": 153750, "time": "2012-02-13T19:42:40Z", "creator": "patric@rufflar.com", "creation_time": "2012-02-13T19:42:40Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 51582, "attachment_id": null, "text": "Fixed in r1243682 for the Tomcat 7 branch", "id": 153752, "time": "2012-02-13T20:38:02Z", "creator": "fhanik@apache.org", "creation_time": "2012-02-13T20:38:02Z", "is_private": false}]