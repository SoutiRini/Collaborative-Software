[{"count": 0, "tags": [], "creator": "cyrille.leclerc@pobox.com", "attachment_id": 23772, "id": 127724, "time": "2009-06-07T17:38:02Z", "bug_id": 47330, "creation_time": "2009-06-07T17:38:02Z", "is_private": false, "text": "Created attachment 23772\nFirst version of the proposed patch\n\nHere is a proposal to port Apache Server mod_remoteip module as a Tomcat Valve to have the actual end user remote ip in ServletRequest.getRemoteAddr() and ServletRequest.getRemoteHost() methods even if reverse proxies (e.g. Apache Http Server mod_proxy_http + mod_proxy_balancer) and/or hardware load balancer (e.g. F5 Big IP, etc).\n\nThis feature will benefit security and audit frameworks like SpringSecurity which use ServletRequest.getRemoteAddr() in its eventing mechanism to track web user ip.\n\nThis proposal is composed of :\n* RemoteIpValve.java : the proposed standalone code\n* RemoteIpValveTest.java : 12 test cases to validate the behavior\nNote : no existing Tomcat code is modified by this proposed Valve\n\nDocumentation for mod_remoteip : http://httpd.apache.org/docs/trunk/mod/mod_remoteip.html\n\nMain differences between mod_remoteip and RemoteIpValve :\n* RemoteIpValve uses regular expressions to express network subnets when mod_remoteip uses ip address blocks because:\n** request filters valves (RemoteAddrValve and RemoteHostValve) already use regular expressions for this\n** there are no ip address blocks library available in Tomcat similar to apr_ipsubnet_test that is used in httpd.\n** The directives RemoteIPInternalProxyList and RemoteIPTrustedProxyList are not ported: configuration is server.xml oriented and limited to the java equivalents of  RemoteIPInternalProxy  and RemoteIPTrustedProxy\n\nSample of configuration : \n <Valve \n   className=\"org.apache.catalina.connector.RemoteIpValve\"\n   allowedInternalProxies=\"192\\.168\\.0\\.10, 192\\.168\\.0\\.11\"\n   remoteIPHeader=\"x-forwarded-for\"\n   remoteIPProxiesHeader=\"x-forwarded-by\"\n   trustedProxies=\"proxy1, proxy2\"\n   />\n\nConfiguration parameters :\n\n|-------------------------|-----------------------------------|--------------------------------------|-----------------------------------------------|\n| REMOTEIPVALVE PROPERTY  | EQUIVALENT MOD_REMOTEIP DIRECTIVE | FORMAT                               | DEFAULT VALUE                                 |\n|-------------------------|-----------------------------------|--------------------------------------|-----------------------------------------------|\n| remoteIPHeader          | RemoteIPHeader                    | Compliant http header string         | x-forwarded-for                               |\n|-------------------------|-----------------------------------|--------------------------------------|-----------------------------------------------|\n| internalProxies         | RemoteIPInternalProxy             | Comma delimited list of regular      | 10\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3},                |\n|                         |                                   | expressions (in the syntax supported | 192\\.168\\.\\d{1,3}\\.\\d{1,3},                   |\n|                         |                                   | by the Pattern library)              | 169\\.254\\.\\d{1,3}\\.\\d{1,3},                   |\n|                         |                                   |                                      | 127\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}                |\n|                         |                                   |                                      |                                               |\n|                         |                                   |                                      | By default, 10/8, 192.168/16, 169.254/16      |\n|                         |                                   |                                      | and 127/8 are allowed ; 172.16/12 has not     |\n|                         |                                   |                                      | been enabled by default because it is         |\n|                         |                                   |                                      | complex to describe with regular expressions  |\n|-------------------------|-----------------------------------|--------------------------------------|-----------------------------------------------|\n| proxiesHeader           | RemoteIPProxiesHeader             | Compliant http header String         | x-forwarded-by                                |\n|-------------------------|-----------------------------------|--------------------------------------|-----------------------------------------------|\n| trustedProxies          | RemoteIPTrustedProxy              | Comma delimited list of regular      |                                               |\n|                         |                                   | expressions (in the syntax supported |                                               |\n|                         |                                   | by the Pattern library)              |                                               |\n|-------------------------|-----------------------------------|--------------------------------------|-----------------------------------------------|\n\n\nReason why RemoteIpValve is declared in the o.a.catalina.connector package instead of o.a.catalina.valves :\nBecause Request.setRemoteAddr(String) and Request.setRemoteHost(String) methods are currently no-op and RemoteIpValve use package visibility to directly modify Request.remoteAddr and Request.remoteHost fields.\nRemoteIpValve could be moved to o.a.catalina.valves if the Request.setRemoteAddr(String) and Request.setRemoteHost(String) methods to no longer be no-op but to actually modify the underlying fields."}, {"count": 1, "tags": [], "creator": "cyrille.leclerc@pobox.com", "attachment_id": 23773, "is_private": false, "id": 127725, "time": "2009-06-07T17:42:33Z", "bug_id": 47330, "creation_time": "2009-06-07T17:42:33Z", "text": "Created attachment 23773\nJavadoc of RemoteIpValve\n\nThe plain text table of configuration parameters I wrote in the initial description has unfortunately been damaged. This javadoc contains the HTML version of the description of RemoteIpValve"}, {"count": 2, "tags": [], "creator": "cyrille.leclerc@pobox.com", "attachment_id": 23970, "is_private": false, "id": 128800, "time": "2009-07-13T09:50:20Z", "bug_id": 47330, "creation_time": "2009-07-13T09:50:20Z", "text": "Created attachment 23970\nSecond version of the proposed patch\n\nAdd support for x-forwarded-proto / x-forwarded-ssl / front-end-https styles http header for https request : sets request.secure = true, request.scheme = https, request.serverPort = 443\n\nDetailed documentation at : http://code.google.com/p/xebia-france/wiki/RemoteIpValve"}, {"count": 3, "tags": [], "creator": "cyrille.leclerc@pobox.com", "attachment_id": null, "is_private": false, "id": 131065, "time": "2009-10-11T03:46:39Z", "bug_id": 47330, "creation_time": "2009-10-11T03:46:39Z", "text": "As Tomcat valves are currently being converted into Servlet Filter (1), here is a Servlet Filter implementation of mod_remoteip we called XForwardedFilter : \nhttp://code.google.com/p/xebia-france/wiki/XForwardedFilter\nhttp://xebia-france.googlecode.com/svn/web/xebia-servlet-extras/tags/xebia-servlet-extras-1.0.0/src/main/java/fr/xebia/servlet/filter/XForwardedFilter.java\n\nLicensing and copyright\n\nThe XforwardedFilter code is still licensed ASL 2 but the copyright is for \"Xebia and the original author or authors\" but we can change it to the usual Apache Software Foundation license and copyright with great pleasure.\n\nImplementation decisions\n\nThis filter has been developped before knowing that the Tomcat project would move from Valve to Filter and is intended to be servlet container agnostic.\n\nWe decided to rely on SLF4J for logging to be as portable as possible. Integrating this Filter in Tomcat project may require to migrate to JULI.\n\n(1) Google Summer Of Code 2009, project \"Convert current Tomcat valves to Servlet Filters\" : http://wiki.apache.org/tomcat/SummerOfCode2009"}, {"count": 4, "tags": [], "creator": "markt@apache.org", "attachment_id": 24455, "is_private": false, "id": 131541, "time": "2009-11-01T18:32:58Z", "bug_id": 47330, "creation_time": "2009-11-01T18:32:58Z", "text": "Created attachment 24455\nTomcat 7 patch with completed TODOs and failing test case\n\nMany thanks for these patches. I'd like to add the valve and filter to Tomcat 7 and the valve to Tomcat 6. I have made the necessary changes to Tomcat 7 the valve can sit in the right package.\n\nWhen I applied the patch, I completed the TODOs and added some documentation. However, one of the test cases failed and my initial investigation suggests that the patch needs further work.\n\nI have attached my final Tomcat 7 patch. Please update as necessary to correct the failing test case and then I'll apply it. Once the valve is applied, I'll look a the filter which will probably be generated by porting the final version of the valve."}, {"count": 5, "tags": [], "bug_id": 47330, "attachment_id": 24465, "id": 131590, "creation_time": "2009-11-02T13:17:01Z", "time": "2009-11-02T13:17:01Z", "creator": "cyrille.leclerc@pobox.com", "text": "Created attachment 24465\nFixed Tomcat 7 patch with successful test case\n\nHere is the fixed patch. A small mistake seems to have been introduced in the test case during the refactoring.\nUnfortunately, my \"svn diff\" command did not order the changed files in the same order as the \"24455: Tomcat 7 patch with completed TODOs and failing test case\" patch did.\n\n\nFor the Servlet API Filter implementation of this feature, there is some work to port it from a valve because the HttpServletRequest interface does not ease adding and removing http headers. \n\nTo do this, I completely reimplemented the headers mechanisms with a case insensitive list of headers rebuilt in a request wrapper. \n\nAnother apporach could have been to decorate the getXxxHeader() and getHeaderNames() methods. The getHeaderNames() method would be more complex because we need to add headers (like x-forwarded-server) but also to remove some (like x-forwarded-for). If this was an Iterator instead of an Enumeration, I would use a predicate to exclude the \"removed\" headers, a FilterEnumeration to apply the predicate on the Enumeration and a ChainIterator for the \"added\" headers. This would imply reinventing a subset of Apache Commons Collection applied to the old ages Enumeration.\n\n\nAnother point on the Filter port of the RemoteIpValve feature is the logging implementation. Using Tomcat JULI would make reusing this Filter outside of Tomcat more complex.\n\n\nThe version 1.0.0 of XForwardedFilter.java I linked on a previous comment of this defect had a bug in the debug statement, here is a fixed version :\nhttp://xebia-france.googlecode.com/svn/web/xebia-servlet-extras/tags/xebia-servlet-extras-1.0.1/src/main/java/fr/xebia/servlet/filter/XForwardedFilter.java", "is_private": false}, {"count": 6, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 131663, "time": "2009-11-03T17:25:13Z", "bug_id": 47330, "creation_time": "2009-11-03T17:25:13Z", "is_private": false, "text": "The updated patch is missing a bunch of files including the valve and the test case."}, {"count": 7, "tags": [], "bug_id": 47330, "is_private": false, "text": "Created attachment 24471\nFixed Tomcat 7 patch with successful test case\n\nSorry for the time you lost. Here is the patch that includes the following modified/added files : \n- valve.xml\n- RemoteIpValveTest.java\n- RemoteIpValve.java\n- LocalStrings.properties\n- mbeans-descriptors.xml", "id": 131669, "time": "2009-11-04T01:04:03Z", "creator": "cyrille.leclerc@pobox.com", "creation_time": "2009-11-04T01:04:03Z", "attachment_id": 24471}, {"count": 8, "tags": [], "bug_id": 47330, "is_private": false, "text": "Thanks for the updated patch.\n\nI have applied the valve patch to trunk. The filter patch will follow along with a backport proposal for the valve to 6.0.x", "id": 131716, "time": "2009-11-04T18:05:37Z", "creator": "markt@apache.org", "creation_time": "2009-11-04T18:05:37Z", "attachment_id": null}, {"count": 9, "tags": [], "text": "I've applied the filter to trunk and proposed the valve for backport to 6.0.x along with the required changes to Request", "is_private": false, "bug_id": 47330, "id": 131743, "time": "2009-11-05T12:35:50Z", "creator": "markt@apache.org", "creation_time": "2009-11-05T12:35:50Z", "attachment_id": null}, {"count": 10, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 131771, "time": "2009-11-06T11:22:39Z", "bug_id": 47330, "creation_time": "2009-11-06T11:22:39Z", "text": "The valve has been applied to 6.0.x and will be included in 6.0.21 onwards."}, {"count": 11, "tags": [], "text": "Created attachment 24505\nlogging, naming and javadoc patch of RemoteIpFilter\n\nHere is a patch of RemoteIpFilter with the following :\n* fix NPE in log statement if protocolHeader has not been defined and the servlet container does not support request.getHeader(null)\n* fix mismatch between javadoc  and code for filter parameter name \"allowedInternalProxies\" -> \"internalProxies\"\n* finish javadoc refactoring \"XForwardedFilter\" -> \"RemoteIpFilter\"", "attachment_id": 24505, "id": 131805, "creation_time": "2009-11-08T15:50:42Z", "time": "2009-11-08T15:50:42Z", "creator": "cyrille.leclerc@pobox.com", "bug_id": 47330, "is_private": false}, {"count": 12, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 131821, "time": "2009-11-09T06:31:33Z", "bug_id": 47330, "creation_time": "2009-11-09T06:31:33Z", "is_private": false, "text": "Patch applied. Many thanks."}, {"count": 13, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 132770, "time": "2009-12-11T08:46:28Z", "bug_id": 47330, "creation_time": "2009-12-11T08:46:28Z", "text": "*** Bug 48378 has been marked as a duplicate of this bug. ***"}]