[{"count": 0, "tags": [], "bug_id": 54475, "is_private": false, "text": "In order to compile JSPs with Java 8, I made the following additions to the JSP servlet in conf\\web.xml:\n\n        <init-param>\n            <param-name>compiler</param-name>\n            <param-value>modern</param-value>\n        </init-param>\n        <init-param>\n            <param-name>compilerSourceVM</param-name>\n            <param-value>1.8</param-value>\n        </init-param>\n        <init-param>\n            <param-name>compilerTargetVM</param-name>\n            <param-value>1.8</param-value>\n        </init-param>\n\nHowever, I get the following error:\n\n\norg.apache.jasper.JasperException: org.apache.jasper.JasperException: Unable to compile class for JSP\n\torg.apache.jasper.servlet.JspServletWrapper.handleJspException(JspServletWrapper.java:549)\n\torg.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:378)\n\torg.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:390)\n\torg.apache.jasper.servlet.JspServlet.service(JspServlet.java:334)\n\tjavax.servlet.http.HttpServlet.service(HttpServlet.java:728)\n\t...\nCaused by java.io.IOException: unexpected tag: 18\n\tat org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool(SmapUtil.java:434)\n\tat org.apache.jasper.compiler.SmapUtil$SDEInstaller.addSDE(SmapUtil.java:251)\n\tat org.apache.jasper.compiler.SmapUtil$SDEInstaller.install(SmapUtil.java:223)\n\tat org.apache.jasper.compiler.SmapUtil$SDEInstaller.install(SmapUtil.java:200)\n\tat org.apache.jasper.compiler.SmapUtil.installSmap(SmapUtil.java:163)\n\tat org.apache.jasper.compiler.AntCompiler.generateClass(AntCompiler.java:284)\n\tat org.apache.jasper.compiler.Compiler.compile(Compiler.java:378)\n\t...\n\nIf I also add the suppressSmap parameter to the JSP servlet in conf\\web.xml, the error goes away, and the JSP compiles fine:\n\n        <init-param>\n            <param-name>suppressSmap</param-name>\n            <param-value>true</param-value>\n        </init-param>\n\nSomething about the SMAP is not playing well with Java 8 language features like the lambda expression.", "id": 164836, "time": "2013-01-23T18:21:08Z", "creator": "nicholas@nicholaswilliams.net", "creation_time": "2013-01-23T18:21:08Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 54475, "text": "Note, I realize that Java 8 is still beta. This bug may not be related to Tomcat, but could instead be a JDK issue. I have filed this bug mostly for tracking purposes, and so that someone more knowledgeable in these matters than I knows to take a look at it.", "id": 164837, "time": "2013-01-23T18:29:00Z", "creator": "nicholas@nicholaswilliams.net", "creation_time": "2013-01-23T18:29:00Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "text": "Since 1.8 isn't out yet, I wouldn't expect support for it, yet.\n\nYou should be able to use the JSP precompiler to generate Java source for you and then use whatever compiler you want to actually generate .class files. But the SMAP-generation might be a tall order.", "attachment_id": null, "id": 164839, "creator": "chris@christopherschultz.net", "time": "2013-01-23T18:38:01Z", "bug_id": 54475, "creation_time": "2013-01-23T18:38:01Z", "is_private": false}, {"count": 3, "attachment_id": null, "bug_id": 54475, "text": "Like I said, I got the JSPs to compile in Tomcat with the Ant compiler (just without the SMAP) and I understand that Java 8 is still in flux. This bug report was so that at some point, as Java 8 becomes more solid, somebody that understands the SMAP stuff will know to figure out whether this is a JDK issue or a Tomcat issue, and fix it if it's a Tomcat issue.", "id": 164844, "time": "2013-01-23T19:36:05Z", "creator": "nicholas@nicholaswilliams.net", "creation_time": "2013-01-23T19:36:05Z", "tags": [], "is_private": false}, {"count": 4, "attachment_id": null, "bug_id": 54475, "text": "This was a Java issue. I just tested this with jdk1.8.0_b81_x64 and everything works as expected. I confirmed the major version of the compiled class with javap.", "id": 166086, "time": "2013-03-21T23:03:14Z", "creator": "markt@apache.org", "creation_time": "2013-03-21T23:03:14Z", "tags": [], "is_private": false}, {"count": 5, "attachment_id": 31415, "bug_id": 54475, "text": "Created attachment 31415\nFailing servlet\n\nI downloaded JDK 1.8.0 (1.8.0-b132) and Ant 1.9.3.\nI downloaded Tomcat 7.0.52 and set up web.xml as specified, then removed ecj-4.3.1.jar and added tools.jar from the JDK and ant.jar, ant-launcher.jar from the Ant distribution.\n\nI am able to reproduce the failure with the attached servlet.\n\nNote that compiling servlets using JDK 1.8.0 works fine as long as the servlet files don't contain any lambdas, so removing the '.filter (s -> s.length () == 5)' causes the servlet to be correctly served. Adding a lambda causes the Java 8 compiler to add an InvokeDynamic target to the constant pool and triggers the SMAP failure.\nhttp://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html#jvms-4.4\n\nThe exact exception is:\n\njava.io.IOException: unexpected tag: 18\n\tat org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool(SmapUtil.java:431)\n\tat org.apache.jasper.compiler.SmapUtil$SDEInstaller.addSDE(SmapUtil.java:248)\n\tat org.apache.jasper.compiler.SmapUtil$SDEInstaller.<init>(SmapUtil.java:220)\n\tat org.apache.jasper.compiler.SmapUtil$SDEInstaller.install(SmapUtil.java:199)\n\tat org.apache.jasper.compiler.SmapUtil.installSmap(SmapUtil.java:163)\n\tat org.apache.jasper.compiler.AntCompiler.generateClass(AntCompiler.java:284)\n\tat org.apache.jasper.compiler.Compiler.compile(Compiler.java:378)\n\tat org.apache.jasper.compiler.Compiler.compile(Compiler.java:353)\n\tat org.apache.jasper.compiler.Compiler.compile(Compiler.java:340)\n\tat org.apache.jasper.JspCompilationContext.compile(JspCompilationContext.java:657)\n\tat org.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:357)\n\tat org.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:390)\n\tat org.apache.jasper.servlet.JspServlet.service(JspServlet.java:334)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:727)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:303)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\n\tat org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:220)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:122)\n\tat org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:501)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:170)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:98)\n\tat org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:950)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:116)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1040)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:607)\n\tat org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:315)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat java.lang.Thread.run(Thread.java:744)", "id": 173969, "time": "2014-03-20T10:19:24Z", "creator": "robbie_usenet@yahoo.co.uk", "creation_time": "2014-03-20T10:19:24Z", "tags": [], "is_private": false}, {"attachment_id": null, "tags": [], "creator": "markt@apache.org", "is_private": false, "count": 6, "id": 173971, "time": "2014-03-20T12:14:24Z", "bug_id": 54475, "creation_time": "2014-03-20T12:14:24Z", "text": "Looks like we have something to fix here."}, {"count": 7, "tags": [], "text": "Created attachment 31416\nProposed patch to alleviate crash behaviour\n\nI propose the following very simple patch to stop the crashing.\nI suppose there is some more work to do to verify the SMAP data with Java 8 classfiles.", "attachment_id": 31416, "id": 173973, "creator": "robbie_usenet@yahoo.co.uk", "time": "2014-03-20T13:09:02Z", "bug_id": 54475, "creation_time": "2014-03-20T13:09:02Z", "is_private": false}, {"count": 8, "attachment_id": null, "bug_id": 54475, "text": "Fixed in 8.0.x for 8.0.5 onwards, 7.0.x for 7.0.53 onwards and 6.0.x for 6.0.40 onwards.", "id": 174030, "time": "2014-03-23T09:39:48Z", "creator": "markt@apache.org", "creation_time": "2014-03-23T09:39:48Z", "tags": [], "is_private": false}]