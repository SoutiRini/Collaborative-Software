[{"count": 0, "tags": [], "creator": "romain.bourgue@agriculture.gouv.fr", "attachment_id": null, "text": "When using mod_proxy the headers_out already set by other modules (mod_cas,\nmod_usertrack(?)...) are overwritten by mod_proxy. Therefore, no cookies can be\nset and these modules can't work.\n\nThe 2.2 version _does_ save the pre-existing headers_out before modifying them.\n\nIt would be great if mod_proxy 2.0 could preserve the pre-existing headers_out,\njust like 2.2 do...\n\nHere is a patch against 2.0.59 that backports this 2.2 behaviour :\n\n--- proxy_http.c.old    2007-01-17 20:08:19.000000000 +0100\n+++ proxy_http.c        2007-01-17 20:12:24.000000000 +0100\n@@ -1282,6 +1282,12 @@\n     return APR_SUCCESS;\n }\n\n+static int addit_dammit(void *v, const char *key, const char *val)\n+{\n+           apr_table_addn(v, key, val);\n+               return 1;\n+}\n+\n static\n apr_status_t ap_proxy_http_process_response(apr_pool_t * p, request_rec *r,\n                                             proxy_http_conn_t *p_conn,\n@@ -1302,7 +1308,7 @@\n                                 * in the case that the origin told us\n                                 * to HTTP_CONTINUE\n                                 */\n-\n+    apr_table_t *save_table;\n     /* Get response from the remote server, and pass it up the\n      * filter chain\n      */\n@@ -1372,6 +1378,12 @@\n             /* N.B. for HTTP/1.0 clients, we have to fold line-wrapped headers*/\n             /* Also, take care with headers with multiple occurences. */\n\n+\n+            /* First, tuck away all already existing cookies */\n+            save_table = apr_table_make(r->pool, 2);\n+            apr_table_do(addit_dammit, save_table, r->headers_out,\n+                         \"Set-Cookie\", NULL);\n+\n             r->headers_out = ap_proxy_read_headers(r, rp, buffer,\n                                                    sizeof(buffer), origin);\n             if (r->headers_out == NULL) {\n@@ -1391,6 +1403,18 @@\n                 return r->status;\n             }\n\n+            /* Now, add in the just read cookies */\n+            apr_table_do(addit_dammit, save_table, r->headers_out,\n+                         \"Set-Cookie\", NULL);\n+\n+            /* and now load 'em all in */\n+            if (!apr_is_empty_table(save_table)) {\n+                apr_table_unset(r->headers_out, \"Set-Cookie\");\n+                r->headers_out = apr_table_overlay(r->pool,\n+                                                   r->headers_out,\n+                                                   save_table);\n+            }\n+\n             /* can't have both Content-Length and Transfer-Encoding */\n             if (apr_table_get(r->headers_out, \"Transfer-Encoding\")\n                 && apr_table_get(r->headers_out, \"Content-Length\")) {", "id": 98198, "time": "2007-01-17T11:35:15Z", "bug_id": 41394, "creation_time": "2007-01-17T11:35:15Z", "is_private": false}, {"attachment_id": 19423, "tags": [], "creator": "romain.bourgue@agriculture.gouv.fr", "is_private": false, "count": 1, "id": 98199, "time": "2007-01-17T11:41:20Z", "bug_id": 41394, "creation_time": "2007-01-17T11:41:20Z", "text": "Created attachment 19423\nPatch against proxy_http.c 2.0.59"}, {"count": 2, "attachment_id": null, "creator": "nick@webthing.com", "text": "Huh?  This looks like a patch that's been in 2.0.x for years!", "id": 106410, "time": "2007-08-06T15:13:51Z", "bug_id": 41394, "creation_time": "2007-08-06T15:13:51Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 41394, "text": "It was indeed committed in rev 103638\n(http://svn.apache.org/viewvc?view=rev&revision=103638), released in 2.0.50, but\nthen removed in rev 104015 (2.0.51) \n(http://svn.apache.org/viewvc?view=rev&revision=104015).\n\nI don't know why.", "id": 106430, "time": "2007-08-07T01:50:36Z", "creator": "romain.bourgue@agriculture.gouv.fr", "creation_time": "2007-08-07T01:50:36Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "nick@webthing.com", "is_private": false, "count": 4, "id": 106433, "time": "2007-08-07T03:18:19Z", "bug_id": 41394, "creation_time": "2007-08-07T03:18:19Z", "text": "Interesting.  I expect it may have got caught up in branching 2.0/2.2.  There\nwere a lot of major improvements in mod_proxy&family, that people felt should be\nin 2.2 but were too big a change for 2.0.\n\nAnyway, it's certainly fixed in the forthcoming releases of current branches,\nboth 2.0 and 2.2."}]