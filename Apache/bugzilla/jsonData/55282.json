[{"count": 0, "tags": [], "bug_id": 55282, "is_private": false, "id": 168673, "creation_time": "2013-07-19T15:41:05Z", "time": "2013-07-19T15:41:05Z", "creator": "valiantsinshukaila@gmail.com", "text": "Created attachment 30604\nsource code to reproduce the issue\n\nIf using jsf 2 project and add Phase Listeners there, they are created and added to the list of Phase Listeners twice which means on page load same Phase Listeners are executed twice.\nThis is happening only when com.sun.faces.config.ConfigureListener is defined in web.xml.\nWithout such declaration in web.xml jsf is initialized one time.\nSuch behaviour seems to happen on 7.0.42 version.\nI was using 7.0.41 and didn't see such behaviour. I didn't have a chance to check it again on 7.0.41 but checked on 7.0.6(because had it installed) and there everything was fine.\nSuch behaviour can be very critical for applications using jsf and Phase Listeners. And Maybe not only Phase Listeners are duplicated(didn't look), because the problem here is that jsf is initialized twice and other things can get duplicated too.\nAttaching eclipse project where you can check the bug on 7.0.42 and compare to other tomcat version. In 7.0.42 there is duplicated message in console that Phase Listener is created.", "attachment_id": 30604}, {"count": 1, "tags": [], "bug_id": 55282, "text": "A ServletContainerInitializer is defined which is processed by Tomcat as required by the Servlet 3.0 and later Servlet specifications.\n\nIt appears that the SCI adds an instance of com.sun.faces.config.ConfigureListener so when it is defined a second time in web.xml everything gets processed twice.\n\nEither disable the SCI or removed the listener definition from web.xml.", "id": 168742, "time": "2013-07-23T18:57:34Z", "creator": "markt@apache.org", "creation_time": "2013-07-23T18:57:34Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 55282, "attachment_id": null, "text": "Yes, changing the web.xml will fix the problem. But also if the servlet version 2.5 is defined in web.xml everything still get's initialized twice.\nI believe this is not what supposed to be. Not back compatibility for application that worked fine on older versions of tomcat.", "id": 169353, "time": "2013-08-12T07:50:34Z", "creator": "valiantsinshukaila@gmail.com", "creation_time": "2013-08-12T07:50:34Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "markt@apache.org", "is_private": false, "count": 3, "id": 169354, "time": "2013-08-12T08:42:53Z", "bug_id": 55282, "creation_time": "2013-08-12T08:42:53Z", "text": "The Servlet 3.0 EG made very clear that annotations must be processed regardless of any version declared in web.xml. Personally, I think that is the wrong decision but is pre-dates my involvement with the EG."}, {"count": 4, "tags": [], "creator": "valiantsinshukaila@gmail.com", "attachment_id": null, "is_private": false, "id": 169355, "time": "2013-08-12T09:35:12Z", "bug_id": 55282, "creation_time": "2013-08-12T09:35:12Z", "text": "com.sun.faces.config.ConfigureListener is not marked with any annotations but is loaded twice if it is defined as <listener> in web.xml. Not really clear how servlet 3 spec defines this. Maybe post a link in spec to clarify this for me? \nFrom my opinion this issue means that any of the old applications that were created before tomcat 7 released will work incorrectly on 7.0.42 or just not work at all."}, {"count": 5, "tags": [], "bug_id": 55282, "text": "Sorry, I should have re-read this a little more carefully before commenting. However, the bug is still INVALID.\n\nA Servlet 3.0 container is required to scan for SCIs irrespective of any version declared in the web.xml.\n\nThe docs for the library you are using should make clear that the web.xml definition is not required when running on a Servlet 3.0 or later container unless SCI scanning is disabled (e.g. via an absolute ordering) for the JAR that provides the SCI.", "id": 169356, "time": "2013-08-12T09:48:51Z", "creator": "markt@apache.org", "creation_time": "2013-08-12T09:48:51Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "olgr@ciklum.com", "text": "I have encountered the same problem when used a workoaround solution for a SEAM project (https://issues.jboss.org/browse/JBSEAM-4401). I need the ConfigureListener to be invoked before the SeamListener.\n\nDuring debugging I found that the com.sun.faces.config.ConfigureListener is added twice in org.apache.catalina.core.StandardContext.\n\nThe first instance is added because it is described in the web.xml.\n\nThe second instance is added by a JarScanner because the listener is described in jsf-impl.jar/META-INF/jsf_core.tld. My jsf-impl has an Implementation-Version: 2.1.7-SNAPSHOT.\n\nI have no idea how to avoid the situation yet.", "count": 6, "id": 169456, "time": "2013-08-15T08:34:17Z", "bug_id": 55282, "creation_time": "2013-08-15T08:34:17Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 55282, "text": "For now I applied the following workaround. I have added the jsf-impl.jar to the property \"tomcat.util.scan.DefaultJarScanner.jarsToSkip\" of the TOMCAT\\conf\\catalina.properties. As a result my application started running properly. But I still have to check that it won't fail in some situations.", "id": 169457, "time": "2013-08-15T11:26:17Z", "creator": "olgr@ciklum.com", "creation_time": "2013-08-15T11:26:17Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 55282, "attachment_id": null, "text": "I have found the reason for adding com.sun.faces.config.ConfigureListener a second time: Tomcat 7.0.41 contained following method in class org.apache.catalina.core.StandardContext:\n\npublic void addApplicationListener(String listener)\n\nThis method checks that the same listener isn't added twice:\n\n...\nfor (int i = 0; i < applicationListeners.length; i++) {\n  if (listener.equals(applicationListeners[i])) {\n    log.info(sm.getString(\"standardContext.duplicateListener\",listener));\n    return;\n  }\n  ...\n\n\nIn Tomcat 7.0.42 the type of instance variable applicationListeners was changed from String[] to ApplicationListener[] and the method signature was changed to\n\npublic void addApplicationListener(ApplicationListener listener) \n\nBut the check \"listener.equals(applicationListeners[i])\" in the fow loop wasn't adjusted --> now it doesn't compares the fq class names of the listeners but calls Object.equals() because class ApplicationListener doesn't overwrite equals() method.\n\nThe solution would be to overwrite equals() and hashCode() method in org.apache.catalina.deploy.ApplicationListener.\n\nI have checked current Tomcat version 8.0.8 and the issue is still present there. I would help much to fix it in Tomcat 7 and 8 releases.\n\n\n(In reply to Oleksii from comment #6)\n> I have encountered the same problem when used a workoaround solution for a\n> SEAM project (https://issues.jboss.org/browse/JBSEAM-4401). I need the\n> ConfigureListener to be invoked before the SeamListener.\n> \n> During debugging I found that the com.sun.faces.config.ConfigureListener is\n> added twice in org.apache.catalina.core.StandardContext.\n> \n> The first instance is added because it is described in the web.xml.\n> \n> The second instance is added by a JarScanner because the listener is\n> described in jsf-impl.jar/META-INF/jsf_core.tld. My jsf-impl has an\n> Implementation-Version: 2.1.7-SNAPSHOT.\n> \n> I have no idea how to avoid the situation yet.", "id": 175383, "time": "2014-05-22T11:46:53Z", "creator": "volker.malzahn@cor.fja.com", "creation_time": "2014-05-22T11:46:53Z", "is_private": false}, {"count": 9, "tags": [], "creator": "violetagg@apache.org", "attachment_id": null, "is_private": false, "id": 175506, "time": "2014-05-27T19:48:58Z", "bug_id": 55282, "creation_time": "2014-05-27T19:48:58Z", "text": "Thanks for the investigation. \nThis has been fixed in trunk for 8.0.9 and in 7.0.x for 7.0.55 onwards."}, {"attachment_id": null, "tags": [], "creator": "knst.kolinko@gmail.com", "text": "(In reply to Volker from comment #8)\n\nI also fixed the error message that was displayed (r1600616 7.0.55).\n\nThe addApplicationListener(ApplicationListener) API was reviewed and reverted in Tomcat 8 - issue 56588.", "count": 10, "id": 175666, "time": "2014-06-05T12:51:30Z", "bug_id": 55282, "creation_time": "2014-06-05T12:51:30Z", "is_private": false}]