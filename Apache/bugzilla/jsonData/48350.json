[{"count": 0, "tags": [], "bug_id": 48350, "text": "Created attachment 24680\nThread Dump of Deadlock\n\nHello,\nI encountered this bug on trunk version of JMeter.\nA deadlock occurs and nothing happens (no output file generated) on remote testing.\n\nI have a Controller that contacts 2 Windows JMeter Servers to run distributed test.\nAttached is stacktrace.\n\nVersion 2.4.20091009 \n\nPhilippe\nhttp://www.ubik-ingenierie.com", "id": 132678, "time": "2009-12-08T11:35:34Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2009-12-08T11:35:34Z", "is_private": false, "attachment_id": 24680}, {"count": 1, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": 25091, "text": "Created attachment 25091\nThread Dump of Deadlocked Threads\n\nSorry for my previous attachment, it didn't show deadlock.\nHere is the good one that shows Deadlock in the controller when serializing HashTree.\n\nPhilippe\nhttp://www.ubik-ingenierie.com", "id": 135103, "time": "2010-03-06T12:50:45Z", "bug_id": 48350, "creation_time": "2010-03-06T12:50:45Z", "is_private": false}, {"count": 2, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": 25092, "text": "Created attachment 25092\nTest scenario\n\nThis scenario illustrates the bug.", "id": 135104, "time": "2010-03-06T12:51:32Z", "bug_id": 48350, "creation_time": "2010-03-06T12:51:32Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 48350, "is_private": false, "text": "To reproduce deadlock do the following:\n- Start 2 servers on same machine or 2 different machines\n- Start controller\n\n\nDeadlock occurs on a very high frequence (4 times on 5 runs).\nI reprocuded it on:\n-Mac OSX (controller and servers on same machine)\n-Linux (controller and servers on same machine)\n-Window / Mac (controller on Mac, Servers on Windows)\n\n\nPhilippe\nhttp://www.ubik-ingenierie.com", "id": 135105, "time": "2010-03-06T12:54:20Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2010-03-06T12:54:20Z", "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 48350, "is_private": false, "text": "Created attachment 25093\nPatch to deadlock\n\nPatch that avoids deadlock by synchronizing only configuration send to each remote server.\nShould have a very low performance impact.\nTested successfully.\n\nPhilippe Mouawad\nhttp://www.ubik-ingenierie.com", "id": 135106, "time": "2010-03-06T13:25:06Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2010-03-06T13:25:06Z", "attachment_id": 25093}, {"count": 5, "tags": [], "bug_id": 48350, "is_private": false, "text": "Thanks very much for the thread dump and patch.\nIt's not obvious why the deadlock occurs, because each remote host has its own ClientJMeterEngine.\n\nDo you have a simpler test case that shows the problem?\n\nAlso, do you use the -G options at all?\n\nSeems to me that this could perhaps also cause a deadlock, as the ClientJMeterEngine code for this is fairly similar.\n\nPerhaps you could try a test with your patch plus a dummy -G option, e.g. just add\n\n-Gdummy=1\n\nto the client startup.\n\nIf this also causes deadlocks, then the remote.setProperties() call probably needs to be moved into the synch. block as well.\n\nCould you also please try:\n\nremote.configure(testTree, host);\ninstead of\nremote.configure(test, host);\n\nwithout the synch. block?\n\nMight also be worth trying synchronising on (testTree) with the above change.", "id": 135108, "time": "2010-03-06T15:17:59Z", "creator": "sebb@apache.org", "creation_time": "2010-03-06T15:17:59Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 48350, "text": "By the way, which version of JMeter are you using?\n\nAlso, which OS?\n\nThese are listed at the start of jmeter.log.", "id": 135109, "time": "2010-03-06T15:19:04Z", "creator": "sebb@apache.org", "creation_time": "2010-03-06T15:19:04Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 48350, "is_private": false, "text": "Issue occurs on Trunk version of JMeter on which I applied the patch.\nIt also occured on 2.4.\n\nConcerning OS I thought I had answered it, I tested on:\n- MacOS X as Controller , 1 server on Windows XP, 1 server on Windows 2000\n- Linux Redhat as Controller, Linux as 2 Servers\n- MacOSx as Controller,  2 servers on Mac OSX\n\n\nConcerning the test case you can use Tomcat 6 as server to run IT, I created specially to submint the bug so you can reproduce.\nI think bug occurs when scenario is complex as the one I create.\n\nNo -G option at all.\n\nThe deadlock is only on master controller which sends it config to 2 others servers.\nThis send is done by 2 threads, one for each remote server as I understand.\n\nI will try to do what you are asking for as soon as possible.\n\nCordially.\nPhilippe\nhttp://www.ubik-ingenierie.com", "id": 135110, "time": "2010-03-06T15:32:15Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2010-03-06T15:32:15Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 48350, "attachment_id": 25095, "is_private": false, "id": 135111, "time": "2010-03-06T16:07:37Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2010-03-06T16:07:37Z", "text": "Created attachment 25095\nCleaned up Test"}, {"count": 9, "tags": [], "bug_id": 48350, "attachment_id": null, "text": "Hello,\nI tested:\nremote.configure(testTree, host);\ninstead of\nremote.configure(test, host);\n\nSame behaviour, because testTree is the same reference as test so same locked object.\n\nPhilippe.", "id": 135112, "time": "2010-03-06T16:14:31Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2010-03-06T16:14:31Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 48350, "text": "Forget my previous comment", "id": 135113, "time": "2010-03-06T16:15:11Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2010-03-06T16:15:11Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": 25096, "text": "Created attachment 25096\nDeadlock Scenario", "id": 135114, "time": "2010-03-06T16:21:03Z", "bug_id": 48350, "creation_time": "2010-03-06T16:21:03Z", "is_private": false}, {"count": 12, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": null, "text": "Hello Sebb,\nI just tested removing synchronized with \nremote.configure(testTree, host);\ninstead of\nremote.configure(test, host);\n\n\nDeadlock does not occur,my understanding  of your modification is that you cleanup a bit HashTree from Swing elements and other ones useless for test.\nBut changes are a bit more important than my hack, maybe more tests are required than my little ones.\nI will try on my real life scenario.\n\nPhilippe\nhttp://www.Ubik-ingenierie.com", "id": 135115, "time": "2010-03-06T16:25:51Z", "bug_id": 48350, "creation_time": "2010-03-06T16:25:51Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 48350, "is_private": false, "text": "Created attachment 25097\nPath that solves issue with -G option", "id": 135116, "time": "2010-03-06T16:35:20Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2010-03-06T16:35:20Z", "attachment_id": 25097}, {"count": 14, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": null, "is_private": false, "id": 135117, "time": "2010-03-06T16:37:01Z", "bug_id": 48350, "creation_time": "2010-03-06T16:37:01Z", "text": "Hello Sebb,\nI tested with -Gdummy=1 and deadlock occurs with your change and mine.\nSo I applied your change:\n            remote.configure(testTree, host);\t\t\t\t\n\nAnd added the following change on properties:\n                \tProperties clonedProperties = null;\n                \tsynchronized (LOCK) {\n                \t\t clonedProperties = (Properties)savep.clone();\t\n\t\t\t\t\t}\n                    remote.setProperties(clonedProperties);\n\n\n\nI cloned the saveP so each thread has its copy.\n\nI tested and everything is OK\n\nCordially\nPhilippe Mouawad\nhttp://www.ubik-ingenierie.com"}, {"count": 15, "tags": [], "creator": "sebb@apache.org", "attachment_id": null, "text": "I've been able to reproduce the problem with a slightly trimmed version of the test plan.\n\nUsing \n\nremote.configure(testTree, host);\ninstead of\nremote.configure(test, host);\n\ndoes not stop the deadlocks.\n\nNor does synchronizing on testTree, however using a static lock object does work for me.\n\nThe -G option does not seem to cause deadlocks.\n\nI'm not yet sure why there can be a deadlock; the code seems to create a separate copy of the test tree for each client. Perhaps one of the nested data structures is not being copied. If so, then fixing that should prevent the deadlock.\n\nHowever this may be very tricky to find; in the meantime your original suggested patch would prevent the deadlocks.\n\nI don't think it's necessary to synch. for the -G option.", "id": 135118, "time": "2010-03-06T16:56:48Z", "bug_id": 48350, "creation_time": "2010-03-06T16:56:48Z", "is_private": false}, {"count": 16, "tags": [], "creator": "sebb@apache.org", "attachment_id": 25099, "is_private": false, "id": 135122, "time": "2010-03-06T18:58:54Z", "bug_id": 48350, "creation_time": "2010-03-06T18:58:54Z", "text": "Created attachment 25099\nSimpler test case - does not need Tomcat"}, {"count": 17, "tags": [], "bug_id": 48350, "is_private": false, "text": "Created attachment 25100\nPatch to deadlock\n\nHere is a patch that:\n- Synchronizes configuration sending to avoid deadlock\n- clones properties to avoid locking issues (remove synchronization block since Properties object is only read)\n\n\nYou are right, there are 2 different references of test HashTree but they share somewhere the same object.\n\n\nPhilippe\nhttp://wwww.ubik-ingenierie.com", "id": 135123, "time": "2010-03-06T19:10:48Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2010-03-06T19:10:48Z", "attachment_id": 25100}, {"count": 18, "tags": [], "bug_id": 48350, "text": "(In reply to comment #15)\n> I've been able to reproduce the problem with a slightly trimmed version of the\n> test plan.\n> \n> Using \n> \n> remote.configure(testTree, host);\n> instead of\n> remote.configure(test, host);\n> \n> does not stop the deadlocks.\n> \n> Nor does synchronizing on testTree, however using a static lock object does\n> work for me.\n> \n> The -G option does not seem to cause deadlocks.\n> \n> I'm not yet sure why there can be a deadlock; the code seems to create a\n> separate copy of the test tree for each client. Perhaps one of the nested data\n> structures is not being copied. If so, then fixing that should prevent the\n> deadlock.\n> \n> However this may be very tricky to find; in the meantime your original\n> suggested patch would prevent the deadlocks.\n> \n> I don't think it's necessary to synch. for the -G option.\n\nHello,\nFrom my investigations:\n- synchronizing on testTree doesn't do it because there are 2 different instances of test\n- and concerning this fix, it doesn't do it because due to HashTree testTree = test, test and testTree are the same object:\n> remote.configure(testTree, host);\n> instead of\n> remote.configure(test, host);\n\nPhilippe.", "id": 135124, "time": "2010-03-06T19:22:20Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2010-03-06T19:22:20Z", "is_private": false, "attachment_id": null}, {"count": 19, "tags": [], "creator": "sebb@apache.org", "attachment_id": null, "text": "Applied patch:\n\nURL: http://svn.apache.org/viewvc?rev=919850&view=rev\nLog:\nBug 48350 - Deadlock on distributed testing with 2 clients\n\nModified:\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/engine/ClientJMeterEngine.java\n   jakarta/jmeter/trunk/xdocs/changes.xml\n\nAs far as I can make out, there's no need to clone the properties.", "id": 135127, "time": "2010-03-06T21:39:28Z", "bug_id": 48350, "creation_time": "2010-03-06T21:39:28Z", "is_private": false}, {"count": 20, "tags": [], "bug_id": 48350, "text": "Thanks again for the report and fix.", "id": 135128, "time": "2010-03-06T21:39:58Z", "creator": "sebb@apache.org", "creation_time": "2010-03-06T21:39:58Z", "is_private": false, "attachment_id": null}]