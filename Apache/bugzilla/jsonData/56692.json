[{"attachment_id": null, "tags": [], "creator": "chanjarster@gmail.com", "is_private": false, "count": 0, "id": 176180, "time": "2014-07-03T06:19:17Z", "bug_id": 56692, "creation_time": "2014-07-03T06:19:17Z", "text": "I'm writing a custom Valve and find a strange bug.\nif the servlet never call request.getParameterNames(), then i will get an empty Enumerations if i call request.getParameterNames();in a Valve."}, {"count": 1, "tags": [], "bug_id": 56692, "text": "1. Please provide a sample web application that reproduces the issue.\n\n2. If parsing the parameters failed (e.g. due to an IOException), the list of parameters will be empty.\nThis is expected behaviour, as defined by Servlet Specification.\n\nIn case of a parsing failure request.getAttribute(\"org.apache.catalina.parameter_parse_failed\") will return a non-null value.\n\n3. Debugging:\nhttp://wiki.apache.org/tomcat/FAQ/Developing#Debugging", "id": 176183, "time": "2014-07-03T09:27:34Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-07-03T09:27:34Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 56692, "text": "Hi,\n\nI cannot reproduce the described behavior.\nAs Konstantin wrote please provide a reproducible example otherwise I'll close the issue with WORKSFORME.\n\nRegards,\nVioleta", "id": 176206, "time": "2014-07-04T04:59:15Z", "creator": "violetagg@apache.org", "creation_time": "2014-07-04T04:59:15Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 56692, "text": "Created attachment 31791\nCode can reproduce the bug\n\nSee Class BUG56692.\n\nI comment out the code on line:38, and try to print out the param on line:66, nothing prints out\n\nIf I remove the comment on line:38, then param name shows.", "id": 176207, "time": "2014-07-04T05:19:11Z", "creator": "chanjarster@gmail.com", "creation_time": "2014-07-04T05:19:11Z", "is_private": false, "attachment_id": 31791}, {"count": 4, "tags": [], "creator": "chanjarster@gmail.com", "text": "(In reply to Violeta Georgieva from comment #2)\n> Hi,\n> \n> I cannot reproduce the described behavior.\n> As Konstantin wrote please provide a reproducible example otherwise I'll\n> close the issue with WORKSFORME.\n> \n> Regards,\n> Violeta\n\nCode is uploaded", "id": 176220, "time": "2014-07-05T06:53:34Z", "bug_id": 56692, "creation_time": "2014-07-05T06:53:34Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "id": 176227, "time": "2014-07-05T14:07:00Z", "bug_id": 56692, "creation_time": "2014-07-05T14:07:00Z", "is_private": false, "text": "Your diagnosis is off. You ask for parameters (for a POST request) not in a valve, but in an AccessLog.log() method.\n\nThe log() method does not belong to Valve interface and is called in quite different point in request processing cycle. It is called when request processing have already been completed.\n\n\nParsing parameters from the body of a POST request is an expensive operation that requires I/O and is not expected from an AccessLog component.\n\nThus I think it is a WONTFIX."}, {"attachment_id": 31792, "tags": [], "creator": "knst.kolinko@gmail.com", "is_private": false, "count": 6, "id": 176231, "time": "2014-07-05T14:44:15Z", "bug_id": 56692, "creation_time": "2014-07-05T14:44:15Z", "text": "Created attachment 31792\nBug56692.java\n\nOP's example adapted to be run as a Tomcat testcase. (Dependency on Apache HttpClient has been removed)."}, {"count": 7, "text": "Technically, the following happens:\n\nDebugging Bug56692.java (Attachment 31792) with the current Tomcat 8 trunk @1608001\n\n(1) InputBuffer is marked as closed.\nStack trace from debugger:\n\n\tInputBuffer.close() line: 232\t\n\tOutputBuffer.close() line: 300\t\n\tResponse.finishResponse() line: 423\t\n\tCoyoteAdapter.service(Request, Response) line: 567\t\n\n(2) Reading request body fails with new IOException(sm.getString(\"inputBuffer.streamClosed\"));\nStack trace from debugger:\n\n\tInputBuffer.read(byte[], int, int) line: 360\t\n\tCoyoteInputStream.read(byte[], int, int) line: 190\t\n\tRequest.readPostBody(byte[], int) line: 3035\t\n\tRequest.parseParameters() line: 2984\t\n\tRequest.getParameterNames() line: 1128\t\n\tBug56692$BugValve.log(Request, Response, long) line: 65\t\n\tAccessLogAdapter.log(Request, Response, long) line: 51\t\n\tStandardHost(ContainerBase).logAccess(Request, Response, long, boolean) line: 1042\t\n\tStandardContext(ContainerBase).logAccess(Request, Response, long, boolean) line: 1049\t\n\tCoyoteAdapter.service(Request, Response) line: 574\t\n\nSo technically if one delays closing of InputBuffer into some separate method, then this behaviour might be possible.\n\nCaveats:\n1. Closing the InputBuffer is commented in OutputBuffer.close() as the way to prevent errors with AJP protocol (bug 50189)\n\n2. The time needed to parse the body won't be included into values of %D and %T (Time taken to process the request) that are already calculated when AccessLog.log() is invoked.\n\n3. ExtendedAccessLogValve has support for logging request parameters with \"x-P(XXX)\". It may be worth documenting its limitations. [1]\n\n[1] http://tomcat.apache.org/tomcat-8.0-doc/config/valve.html#Access_Log_Valve", "bug_id": 56692, "is_private": false, "id": 176232, "time": "2014-07-05T14:57:15Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-07-05T14:57:15Z", "tags": [], "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 56692, "is_private": false, "count": 8, "id": 176235, "time": "2014-07-06T02:59:16Z", "creator": "chanjarster@gmail.com", "creation_time": "2014-07-06T02:59:16Z", "text": "Thanks for explan.\n\nDoes that mean that the request parameters never got the chance to be parsed, so the Request in valve can not got the parameters ?\n\nAnd I have another question: How can I set logger to DEBUG level when I run Tomcat test case ? I'm writing a custom Valve, if you tell me it will be very helpful. Thanks in advance.\n\n\n(In reply to Konstantin Kolinko from comment #7)\n> Technically, the following happens:\n> \n> Debugging Bug56692.java (Attachment 31792 [details]) with the current Tomcat\n> 8 trunk @1608001\n> \n> (1) InputBuffer is marked as closed.\n> Stack trace from debugger:\n> \n> \tInputBuffer.close() line: 232\t\n> \tOutputBuffer.close() line: 300\t\n> \tResponse.finishResponse() line: 423\t\n> \tCoyoteAdapter.service(Request, Response) line: 567\t\n> \n> (2) Reading request body fails with new\n> IOException(sm.getString(\"inputBuffer.streamClosed\"));\n> Stack trace from debugger:\n> \n> \tInputBuffer.read(byte[], int, int) line: 360\t\n> \tCoyoteInputStream.read(byte[], int, int) line: 190\t\n> \tRequest.readPostBody(byte[], int) line: 3035\t\n> \tRequest.parseParameters() line: 2984\t\n> \tRequest.getParameterNames() line: 1128\t\n> \tBug56692$BugValve.log(Request, Response, long) line: 65\t\n> \tAccessLogAdapter.log(Request, Response, long) line: 51\t\n> \tStandardHost(ContainerBase).logAccess(Request, Response, long, boolean)\n> line: 1042\t\n> \tStandardContext(ContainerBase).logAccess(Request, Response, long, boolean)\n> line: 1049\t\n> \tCoyoteAdapter.service(Request, Response) line: 574\t\n> \n> So technically if one delays closing of InputBuffer into some separate\n> method, then this behaviour might be possible.\n> \n> Caveats:\n> 1. Closing the InputBuffer is commented in OutputBuffer.close() as the way\n> to prevent errors with AJP protocol (bug 50189)\n> \n> 2. The time needed to parse the body won't be included into values of %D and\n> %T (Time taken to process the request) that are already calculated when\n> AccessLog.log() is invoked.\n> \n> 3. ExtendedAccessLogValve has support for logging request parameters with\n> \"x-P(XXX)\". It may be worth documenting its limitations. [1]\n> \n> [1]\n> http://tomcat.apache.org/tomcat-8.0-doc/config/valve.html#Access_Log_Valve"}, {"attachment_id": null, "tags": [], "bug_id": 56692, "is_private": false, "count": 9, "id": 176236, "time": "2014-07-06T03:42:03Z", "creator": "chanjarster@gmail.com", "creation_time": "2014-07-06T03:42:03Z", "text": "@Konstantin Kolinko\n\nI find the logging.properties at output/build/conf/logging.properties and the logger name for temporary context's logger name is \"org.apache.catalina.core.ContainerBase.[Tomcat].[localhost].[/]\", so the problem is solved"}, {"count": 10, "tags": [], "bug_id": 56692, "text": "(In reply to Daniel Qian from comment #8)\n>\n> Does that mean that the request parameters never got the chance to be\n> parsed, so the Request in valve can not got the parameters ?\n\nOnce again:\nA Valve is OK (Valve.invoke(), Valve.event()).\nYour problem is with AccessLog (AccessLog.log()).", "id": 176240, "time": "2014-07-06T11:37:59Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-07-06T11:37:59Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "bug_id": 56692, "text": "Bugzilla is not a support forum. Further discussion of this topic belongs on the users mailing list.", "id": 176257, "time": "2014-07-06T21:39:05Z", "creator": "markt@apache.org", "creation_time": "2014-07-06T21:39:05Z", "is_private": false, "attachment_id": null}]