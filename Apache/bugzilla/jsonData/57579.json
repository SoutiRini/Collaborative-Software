[{"count": 0, "tags": [], "bug_id": 57579, "is_private": false, "text": "Created attachment 32467\nError instead of no sample showing\n\nHi,\n\nI was trying to write a simple test script for our site and found interesting issue. I think it's a bug the new feature of not recording samples for HTTP-cached responses (https://issues.apache.org/bugzilla/show_bug.cgi?id=54778).\n\nSteps to reproduce:\n\n(1) Create test with 1 HTTP Sampler request for an URL which returns Expires & Cache-Control headers in HTTP response, like:\nResponse headers:\n  HTTP/1.1 200 OK\n  Date: Thu, 12 Feb 2015 22:09:52 GMT\n  ...\n  Vary: Accept-Encoding\n  Expires: Sun, 09 Feb 2025 22:09:52 GMT\n  Cache-Control: max-age=315360000, public\n  ETag: \"c7109969:dtagent7888VJDk:dtagent7888kDJV\"\n  Last-Modified: Wed, 30 Oct 2013 17:05:39 GMT\n  Content-Type: text/css\n  Content-Length: 320\n  Connection: close\n\n(2) Add \"HTTP Cache Manager\" element, check \"Use Cache-Control / Expires header when processing GET requests\" \n\n(3) Run the test with 1 thread, with 10 iterations (Loop count = 10).\n\nResult:\nFirst run executes HTTP request, server returns 200 + caching headers. Second request (and any subsequent) fails with Error in the JMeter. This was taken from element \"View Results Tree\":\n\n\"Sampler result\" tab:\nThread Name: Liferay Authenticated Users Browsing 1-1\nSample Start: 1969-12-31 18:00:00 CST\nLoad time: 0\nLatency: 0\nSize in bytes: 413\nHeaders size in bytes: 0\nBody size in bytes: 413\nSample Count: 1\nError Count: 1\nResponse code: Non HTTP response code: java.lang.NullPointerException\nResponse message: Non HTTP response message: null\n\nResponse headers:\n\n\nHTTPSampleResult fields:\nContentType: \nDataEncoding: null\n\n\"Request\" tab:\nnull\n\n\"Response data\" tab:\njava.lang.NullPointerException\n\tat org.apache.jmeter.protocol.http.sampler.HTTPSamplerBase.sample(HTTPSamplerBase.java:1142)\n\tat org.apache.jmeter.protocol.http.sampler.HTTPSamplerBase.sample(HTTPSamplerBase.java:1130)\n\tat org.apache.jmeter.threads.JMeterThread.process_sampler(JMeterThread.java:431)\n\tat org.apache.jmeter.threads.JMeterThread.run(JMeterThread.java:258)\n\tat java.lang.Thread.run(Thread.java:745)\n\n  \n\nExpected:\nNo error is shown, no sample is recorded.\n\nWorkaround:\nIf you change the behavior of JMeter cache manager using this property:\n\ncache_manager.cached_resource_mode=RETURN_200_CACHE\n\nthen script works without errors (samples with response time=0 are recorded as expected).\n\nDetails:\nSeems like issue 54778 causes this, I debugged through the code and if the main sample URL is found in the JMeter cache:\n\norg.apache.jmeter.protocol.http.sampler.HTTPAbstractImpl.updateSampleResultForResourceInCache():365\n    ...\n    protected HTTPSampleResult updateSampleResultForResourceInCache(HTTPSampleResult res) {\n        switch (CACHED_RESOURCE_MODE) {\n            case RETURN_NO_SAMPLE:\n                return null; // line 365\n            case RETURN_200_CACHE:\n    ...\n\nnull is returned as the HTTPSampleResult. But then JMeter tries to set the label on this result:\norg.apache.jmeter.protocol.http.sampler.HTTPSamplerBase.sample():1142\n    ...\n    public SampleResult sample() {\n        SampleResult res = null;\n        try {\n            res = sample(getUrl(), getMethod(), false, 0);\n            res.setSampleLabel(getName()); // line 1142\n            return res;\n        } catch (Exception e) {\n            return errorResult(e, new HTTPSampleResult());\n        }\n    }\n    ...\n\nThis fails for NPE.\n\nNote that if the same HTTP response headers are set on a HTTP request which is a sub-sample (for example originating from \"Retrieve All Embedded Resource\"), this works fine -- no error is shown, no sample is recorded.\n\n\nI'm using OS X 10.10.2 which is not in the list of OSes.", "id": 181021, "time": "2015-02-12T22:41:48Z", "creator": "sustacek@gmail.com", "creation_time": "2015-02-12T22:41:48Z", "attachment_id": 32467}, {"count": 1, "attachment_id": 32468, "bug_id": 57579, "text": "Created attachment 32468\nfirst iteration request", "id": 181022, "time": "2015-02-12T22:43:51Z", "creator": "sustacek@gmail.com", "creation_time": "2015-02-12T22:43:51Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "creator": "sustacek@gmail.com", "attachment_id": 32469, "text": "Created attachment 32469\nsecond iteration - request tab", "id": 181023, "time": "2015-02-12T22:44:29Z", "bug_id": 57579, "creation_time": "2015-02-12T22:44:29Z", "is_private": false}, {"count": 3, "tags": [], "creator": "sustacek@gmail.com", "attachment_id": 32470, "text": "Created attachment 32470\nsecond iteration - response data tab", "id": 181024, "time": "2015-02-12T22:44:58Z", "bug_id": 57579, "creation_time": "2015-02-12T22:44:58Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 57579, "is_private": false, "id": 181085, "creation_time": "2015-02-15T13:32:07Z", "time": "2015-02-15T13:32:07Z", "creator": "p.mouawad@ubik-ingenierie.com", "text": "Date: Sun Feb 15 13:31:44 2015\nNew Revision: 1659922\n\nURL: http://svn.apache.org/r1659922\nLog:\nBug 57579 - NullPointerException error is raised on main sample if \"RETURN_NO_SAMPLE\" is used (default) and \"Use Cache-Control / Expires header...\" is checked in HTTP Cache Manager\nBugzilla Id: 57579\n\nModified:\n    jmeter/trunk/src/protocol/http/org/apache/jmeter/protocol/http/sampler/AccessLogSampler.java\n    jmeter/trunk/src/protocol/http/org/apache/jmeter/protocol/http/sampler/HTTPSamplerBase.java\n    jmeter/trunk/xdocs/changes.xml", "attachment_id": null}]