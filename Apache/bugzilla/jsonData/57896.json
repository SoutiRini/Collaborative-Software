[{"count": 0, "tags": [], "bug_id": 57896, "attachment_id": null, "is_private": false, "id": 182866, "time": "2015-05-07T12:05:03Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-05-07T12:05:03Z", "text": "This issue was originally fixed by introducing a new configuration option in Tomcat 8 in r1448679 (for 8.0.0), backported to Tomcat 7 in r1675821 (for 7.0.62). It has not been fixed in Tomcat 6 yet.\n\nI am filing this into Bugzilla to better document the problem.\n\nThe problem is that method \"unescapeDoubleQuotes\" modifies bytes in the buffer that it is processing\n(The method is LegacyCookieProcessor.unescapeDoubleQuotes() in current Tomcat 8, ServerCookie.unescapeDoubleQuotes() in current Tomcat 7 and 6).\n\nAs such, the value of original \"cookie\" HTTP header is corrupted. It can be noted by calling request.getHeader(\"cookie\") or by logging the header value in AccessLogValve.\n\nSteps to reproduce with current Tomcat 6 (6.0.43), Firefox 37.0.2:\n\n1. Configure an AccessLogValve to log incoming \"cookie\" and outgoing \"set-cookie\" HTTP headers.\n\nThat is, uncomment AccessLogValve in Host element of server.xml and set the following value for pattern attribute:\n\n    pattern=\"%h %l %u %t &quot;%r&quot; %s %b [Cookie received: %{cookie}i] [Set-Cookie sent: %{set-cookie}o]\"\n\n2. Start Tomcat and open Servlets Examples -> Cookies  page in examples web application,\n\nhttp://localhost:8080/examples/servlets/servlet/CookieExample\n\n3. Fill the form to create a cookie and submit it:\nName: foo\nValue: bar \"baz\"\n\n4. Re-visit the Cookies example page, so that browser sends you the cookie that was created.\n\n5. Look into access log file.\n\nThe logs look like the following:\n\n127.0.0.1 - - [07/May/2015:15:25:37 +0400] \"GET /examples/servlets/servlet/CookieExample HTTP/1.1\" 200 637 [Cookie received: -] [Set-Cookie sent: -]\n127.0.0.1 - - [07/May/2015:15:28:24 +0400] \"POST /examples/servlets/servlet/CookieExample HTTP/1.1\" 200 809 [Cookie received: -] [Set-Cookie sent: foo=\"bar \\\"baz\\\"\"; Version=1]\n127.0.0.1 - - [07/May/2015:15:28:42 +0400] \"GET /examples/servlets/servlet/CookieExample HTTP/1.1\" 200 714 [Cookie received: foo=\"bar \"baz\"\\\"\"] [Set-Cookie sent: -]\n\nActual value:\n[Cookie received: foo=\"bar \"baz\"\\\"\"]\nExpected value:\n[Cookie received: foo=\"bar \\\"baz\\\"\"]\n\nNotes:\n======\n1. This happens only with unquoting of '\"' character. No other character are unquoted by unescapeDoubleQuotes() method.\n\n2. Current specification of cookies (RFC6265) defines that cookie values cannot contain double quote and backslash characters. A well-behaving web application should not create cookies whose values contain such characters.\n\n cookie-value      = *cookie-octet / ( DQUOTE *cookie-octet DQUOTE )\n cookie-octet      = %x21 / %x23-2B / %x2D-3A / %x3C-5B / %x5D-7E\n                       ; US-ASCII characters excluding CTLs,\n                       ; whitespace DQUOTE, comma, semicolon,\n                       ; and backslash\n\n3. The fix introduced new system property,\norg.apache.tomcat.util.http.ServerCookie.PRESERVE_COOKIE_HEADER\n\nIt defaults to 'false'. By default you have to opt-in for this fix by setting that property to 'true'.\n\nWhen running in \"strict servlet compliance\" mode, that setting defaults to 'true' and the fix is enabled.\n\nThe new Rfc6265CookieProcessor implementation of CookieProcessor that is available as an opt-in feature in Tomcat 8 does not have this bug and is not affected by that configuration option."}, {"count": 1, "attachment_id": null, "creator": "knst.kolinko@gmail.com", "text": "Documentation updated in Tomcat 9/8/7 (r1678174 / r1678178 / r1678180) and will be in 7.0.62, 8.0.23.\n\nBackport proposed for Tomcat 6.", "id": 182869, "time": "2015-05-07T13:12:55Z", "bug_id": 57896, "creation_time": "2015-05-07T13:12:55Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 57896, "is_private": false, "text": "Implemented in Tomcat 6 by r1710457 and will be in 6.0.45.", "id": 185928, "time": "2015-10-25T16:05:17Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-10-25T16:05:17Z", "attachment_id": null}]