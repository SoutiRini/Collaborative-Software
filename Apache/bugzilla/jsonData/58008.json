[{"count": 0, "tags": [], "bug_id": 58008, "attachment_id": null, "text": "Wen trying to shut Apache down, it crashes from self-induced SIGABRT with the following stack:\n\n#0  0x00000008019501aa in thr_kill () from /lib/libc.so.7\n#1  0x0000000801950116 in raise () from /lib/libc.so.7\n#2  0x000000080194e8f9 in abort () from /lib/libc.so.7\n#3  0x0000000808b7d0ff in Rivet_Panic (arg1=<optimized out>) at apache-2/mod_rivet.c:1049\n#4  0x00000008088e0d84 in Tcl_PanicVA (format=<optimized out>, argList=<optimized out>) at /home/ports/lang/tcl86/work/tcl8.6.4/generic/tclPanic.c:99\n#5  0x00000008088e0e72 in Tcl_Panic (format=0x18c3b <error: Cannot access memory at address 0x18c3b>) at /home/ports/lang/tcl86/work/tcl8.6.4/generic/tclPanic.c:153\n#6  0x00000008088be542 in CutChannel (chan=<optimized out>) at /home/ports/lang/tcl86/work/tcl8.6.4/generic/tclIO.c:3118\n#7  CloseChannel (interp=<optimized out>, chanPtr=<optimized out>, errorCode=<optimized out>) at /home/ports/lang/tcl86/work/tcl8.6.4/generic/tclIO.c:2978\n#8  FlushChannel (interp=<optimized out>, chanPtr=<optimized out>, calledFromAsyncFlush=<optimized out>) at /home/ports/lang/tcl86/work/tcl8.6.4/generic/tclIO.c:2863\n#9  0x00000008088bb7ec in Tcl_Close (interp=0x81c582010, chan=<optimized out>) at /home/ports/lang/tcl86/work/tcl8.6.4/generic/tclIO.c:3411\n#10 0x00000008088bbfdc in Tcl_UnregisterChannel (interp=0x81c582010, chan=0x81c5c4390) at /home/ports/lang/tcl86/work/tcl8.6.4/generic/tclIO.c:1247\n#11 0x0000000808b7c8d1 in Rivet_ChildHandlers (s=0x80246b050, init=0) at apache-2/mod_rivet.c:1325\n#12 0x0000000808b7c97f in Rivet_ChildExit (data=0x80246b050) at apache-2/mod_rivet.c:1399\n#13 0x00000008011b24be in apr_pool_destroy () from /opt/lib/libapr-1.so.0\n#14 0x0000000805733872 in clean_child_exit (code=0) at prefork.c:218\n#15 0x0000000805733807 in just_die (sig=15) at prefork.c:344\n#16 0x00000008015f38eb in ?? () from /lib/libthr.so.3\n#17 0x00000008015f2ffc in ?? () from /lib/libthr.so.3\n#18 <signal handler called>\n#19 0x000000080195136a in _select () from /lib/libc.so.7\n#20 0x00000008015f0f72 in ?? () from /lib/libthr.so.3\n#21 0x000000080891be70 in NotifierThreadProc (clientData=<optimized out>) at tclUnixNotfy.c:1216\n#22 0x00000008015ee775 in ?? () from /lib/libthr.so.3\n\n(I'm using rivet-2.2.3, but this latest version is not yet mentioned in the list of valid versions in Bugzilla.)", "id": 183343, "time": "2015-06-07T12:15:33Z", "creator": "mi+apache@aldan.algebra.com", "creation_time": "2015-06-07T12:15:33Z", "is_private": false}, {"count": 1, "tags": [], "creator": "mxmanghi@apache.org", "attachment_id": null, "id": 183392, "time": "2015-06-09T14:54:02Z", "bug_id": 58008, "creation_time": "2015-06-09T14:54:02Z", "is_private": false, "text": "Please, would you tell us what are the global parameters in the configuration? For example the output of \n\nputs [::rivet::inspect -all]\n\nor \n\nparray [array set [::rivet::inspect -all]]\n\nwould help. \n\nConsider also to update your trunk working copy or re-export from trunk if you didn't create your own wc"}, {"count": 2, "tags": [], "creator": "mxmanghi@apache.org", "attachment_id": null, "id": 183395, "time": "2015-06-09T16:03:30Z", "bug_id": 58008, "creation_time": "2015-06-09T16:03:30Z", "is_private": false, "text": "hold on, your code is of the 2.2 series, not trunk! What version of rivet are you using actually?"}, {"count": 3, "tags": [], "bug_id": 58008, "text": "(In reply to Massimo Manghi from comment #1)\n> puts [::rivet::inspect -all]\n\nHere it is in a table: http://aldan.algebra.com/~mi/tmp/t.rvt\n\n(In reply to Massimo Manghi from comment #2)\n> What version of rivet are you using actually?\n\nAs I wrote from the very beginning:\n\n>> (I'm using rivet-2.2.3, but this latest version is not yet mentioned in the list of valid versions in Bugzilla.)\n\nHope, this helps.", "id": 183397, "time": "2015-06-09T16:21:53Z", "creator": "mi+apache@aldan.algebra.com", "creation_time": "2015-06-09T16:21:53Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 58008, "text": "Yes, you're right, I added it now. How many virtual hosts do you have in your configuration?", "id": 183398, "time": "2015-06-09T16:27:05Z", "creator": "mxmanghi@apache.org", "creation_time": "2015-06-09T16:27:05Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 58008, "text": "(In reply to Massimo Manghi from comment #4)\n> Yes, you're right, I added it now. How many virtual hosts do you have in\n> your configuration?\n\nQuite a few (not even sure -- easily 10).\n\nWorse, some of them use Websh... I had a problem with the coexistence before (you may remember Bug 54162) -- maybe, we are witnessing a regression on that once-fixed problem?", "id": 183399, "time": "2015-06-09T16:31:27Z", "creator": "mi+apache@aldan.algebra.com", "creation_time": "2015-06-09T16:31:27Z", "is_private": false, "attachment_id": null}, {"count": 6, "attachment_id": null, "bug_id": 58008, "is_private": false, "id": 183400, "time": "2015-06-09T16:39:18Z", "creator": "mxmanghi@apache.org", "creation_time": "2015-06-09T16:39:18Z", "tags": [], "text": "I remember that bug. You have at hand a method that might give a strong indication there is a conflict or not: disable your WebSH based web sites and see what happens"}, {"count": 7, "attachment_id": null, "bug_id": 58008, "is_private": false, "id": 183401, "time": "2015-06-09T16:41:39Z", "creator": "mxmanghi@apache.org", "creation_time": "2015-06-09T16:41:39Z", "tags": [], "text": "Forgive my wrong wording of the recommendation: I mean to disable WebSh based stuff by not loading WebSH altogether and see what happens"}, {"count": 8, "tags": [], "creator": "mi+apache@aldan.algebra.com", "attachment_id": null, "id": 183402, "time": "2015-06-09T16:44:12Z", "bug_id": 58008, "creation_time": "2015-06-09T16:44:12Z", "is_private": false, "text": "No, removing the websh-related pieces (the LoadModule and the websh-using vhost-definition) did not help :-/\n\n(If you'd like to investigate in situ, send me your passwd-entry and ssh-key.)"}, {"count": 9, "tags": [], "bug_id": 58008, "attachment_id": null, "text": "More specifically, ALL of the child httpd-processes crash. One of them often dies from SEGFAULT (signal 11):\n\nProgram terminated with signal SIGSEGV, Segmentation fault.\n#0  0x00000008011b28c3 in apr_pool_clear () from /opt/lib/libapr-1.so.0\n(gdb) where\n#0  0x00000008011b28c3 in apr_pool_clear () from /opt/lib/libapr-1.so.0\n#1  0x000000080573342f in child_main (child_num_arg=5) at prefork.c:597\n#2  0x00000008057327fe in make_child (s=0x80246b050, slot=5) at prefork.c:800\n#3  0x0000000805732d35 in perform_idle_server_maintenance (p=0x802421028) at prefork.c:902\n#4  0x00000008057315b5 in prefork_run (_pconf=0x802421028, plog=0x80246f028, s=0x80246b050) at prefork.c:1090\n#5  0x000000000043c63b in ap_run_mpm (pconf=0x802421028, plog=0x80246f028, s=0x80246b050) at mpm_common.c:94\n#6  0x0000000000430649 in main (argc=2, argv=0x7fffffffe640) at main.c:777\n(gdb) info thread\n  Id   Target Id         Frame \n* 4    Thread 802406400 (LWP 101604) 0x00000008011b28c3 in apr_pool_clear () from /opt/lib/libapr-1.so.0\n  3    Thread 802407c00 (LWP 100778) 0x0000000801879cea in chdir () from /lib/libc.so.7\n* 1    Thread 802406400 (LWP 101604) 0x00000008011b28c3 in apr_pool_clear () from /opt/lib/libapr-1.so.0\n\nwhile all others die in Rivet_Panic as already submitted.", "id": 183404, "time": "2015-06-09T16:59:38Z", "creator": "mi+apache@aldan.algebra.com", "creation_time": "2015-06-09T16:59:38Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 58008, "text": "Created attachment 32801\nno channel unregistering\n\nI can't reproduce the problem, but I think it's probably pedantic to unregister a channel just before the child exits (and consequently all its memory released)\n\nwould you please try if this patch has any side effects?\n\nIf you had a chance to test the code in trunk using the worker MPM the feedback would be highly valuable.", "id": 183407, "time": "2015-06-09T21:59:31Z", "creator": "mxmanghi@apache.org", "creation_time": "2015-06-09T21:59:31Z", "is_private": false, "attachment_id": 32801}, {"count": 11, "tags": [], "creator": "mxmanghi@apache.org", "text": "I tested your case on 2 machines with mixed results: it's been impossible to reproduce the problem on my PC at home, whereas a quick test on a PC at work showed a similar backtrace. In this case one of the calls in the backtrace was to TclX which wasn't called at all from both mod_rivet and the application code. I deinstalled TclX but the problem still existed with a slightly different bt output\nThe problem seems to be around Tcl_UnregisterChannel, but given your configuration I don't understand how since it should be called only once\n\nNotice also that the other backtrace you showed has no calls to mod_rivet in the stack.We should understand if there is still a inter-module interference somehow\n\nAre you running Apache 2.2 or 2.4? Which patchlevel version exactly?", "id": 183426, "time": "2015-06-10T08:36:35Z", "bug_id": 58008, "creation_time": "2015-06-10T08:36:35Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 58008, "text": "With the patch applied, the crash happens a few steps later, when the interpreter itself is deleted:\n\n#0  0x00000008019501aa in thr_kill () from /lib/libc.so.7\n#1  0x0000000801950116 in raise () from /lib/libc.so.7\n#2  0x000000080194e8f9 in abort () from /lib/libc.so.7\n#3  0x0000000808b7d08f in ?? () from /opt/libexec/apache24/mod_rivet.so\n#4  0x00000008088e0d84 in Tcl_PanicVA (format=<optimized out>, argList=<optimized out>)\n    at /home/ports/lang/tcl86/work/tcl8.6.4/generic/tclPanic.c:99\n#5  0x00000008088e0e72 in Tcl_Panic (format=0x18b90 <error: Cannot access memory at address 0x18b90>)\n    at /home/ports/lang/tcl86/work/tcl8.6.4/generic/tclPanic.c:153\n#6  0x000000080881a60f in Tcl_AsyncDelete (async=0x8024fbed0) at /home/ports/lang/tcl86/work/tcl8.6.4/generic/tclAsync.c:283\n#7  0x000000080881c021 in DeleteInterpProc (interp=0x81c582010)\n    at /home/ports/lang/tcl86/work/tcl8.6.4/generic/tclBasic.c:1423\n#8  0x0000000808b7c90f in ?? () from /opt/libexec/apache24/mod_rivet.so\n#9  0x00000008011b24be in apr_pool_destroy () from /opt/lib/libapr-1.so.0\n#10 0x0000000805733872 in clean_child_exit (code=0) at prefork.c:218\n#11 0x0000000805733807 in just_die (sig=15) at prefork.c:344\n#12 0x00000008015f38eb in ?? () from /lib/libthr.so.3\n#13 0x00000008015f2ffc in ?? () from /lib/libthr.so.3\n#14 <signal handler called>\n#15 0x000000080195136a in _select () from /lib/libc.so.7\n#16 0x00000008015f0f72 in ?? () from /lib/libthr.so.3\n#17 0x000000080891be70 in NotifierThreadProc (clientData=<optimized out>) at tclUnixNotfy.c:1216\n#18 0x00000008015ee775 in ?? () from /lib/libthr.so.3\n#19 0x0000000000000000 in ?? ()\n\n> Are you running Apache 2.2 or 2.4? Which patchlevel version exactly?\n\nUsing apache-2.4.12.", "id": 183429, "time": "2015-06-10T13:21:28Z", "creator": "mi+apache@aldan.algebra.com", "creation_time": "2015-06-10T13:21:28Z", "is_private": false, "attachment_id": null}, {"count": 13, "attachment_id": null, "bug_id": 58008, "is_private": false, "id": 186805, "time": "2015-12-05T11:22:04Z", "creator": "mxmanghi@apache.org", "creation_time": "2015-12-05T11:22:04Z", "tags": [], "text": "it should be OK now with rivet 2.2.4"}]