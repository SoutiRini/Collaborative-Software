[{"count": 0, "attachment_id": null, "bug_id": 19103, "is_private": false, "id": 35400, "time": "2003-04-17T07:09:59Z", "creator": "wagner@sprynet.com", "creation_time": "2003-04-17T07:09:59Z", "tags": [], "text": "The following code is (with the exception of me adding an import statement to\nget it to compile) right out of a JSP book (I've put \"---->\" to point to the\ncode generating the error). I assume the author of the book knows more about\nthis than I do, thus I assume it's correct, but it COULD be dated.\n\nHere's the code:\n\n\n<%@ page import=\"java.util.Enumeration\" %>\n<HTML><HEAD><TITLE>Example of Using Session</TITLE></HEAD><BODY>\n[<A HREF=toys.jsp>Shop for Toys</A>] \n<H1> Online CD Catalog </H1>\n<TABLE>\n<% \n   String[] titles = {\"Tchaikovsky_Orchestral_Masterpieces\",\n                      \"Mendelssohn_Melodic_Masterpieces\",\n                      \"Haydn_Symphonic_Masterpieces\",\n                      \"Schumann_Romantic_Legends\",\n                      \"Bach_Baroque_Masterpieces\"};\n   for(int j=0; j<titles.length; j++){ %>\n     <TR><TD><%=titles[j]%></TD>\n         <TD><A HREF=cds.jsp?itemName=<%=titles[j]%>>\n              Add to Shopping Cart</A></TD>\n     </TR>\n<% } %>\n</TABLE>\n<A HREF=cds.jsp?itemName=emptyCart>Empty Shopping Cart</A>\n<% String item = request.getParameter(\"itemName\");\n   if(item != null && item.equals(\"emptyCart\"))\n      {\n      Enumeration attributeNames = session.getAttributeNames();\n      while(attributeNames.hasMoreElements())\n         {\n         String attributeName = (String)attributeNames.nextElement();\n         System.out.println(\"WVW++++++++++attribute is: \"+attributeName);\n------>  session.removeAttribute(attributeName);\n         }\n      } \n   else if(item != null)\n      {\n       String attributeName = item + \"CD\";\n       session.setAttribute(attributeName,item);\n       }\n%>\n<HR>\n<H1> Content of Shopping Cart </H1>\n<UL>\n<% Enumeration attributeNames = session.getAttributeNames();\n   if(attributeNames != null)\n   while(attributeNames.hasMoreElements()){\n     String attributeName = (String)attributeNames.nextElement();\n     String attributeValue = (String)session.getAttribute(attributeName); %>\n     <LI><%=attributeValue%>\n<% } %>\n</BODY>\n</HTML>\n\n-----------------------\nEND OF SOURCE CODE!!!\n-----------------------\n\nThis also links to another nearly identical page, so I haven't included it. The\npage will generate a list of items that you can add to a \"shopping cart\". You\ncan also empty the shopping cart by clicking on the:\n\n       <A HREF=cds.jsp?itemName=emptyCart>Empty Shopping Cart</A>\n\nlink. This will work fine if only one item has been put in the shopping cart,\nbut if more than one item is added, the following exception is generated in both\nMac OS X 10.2 and Red Hat Linux 7.2, using both 4.1.18 and 4.1.24:\n \nHTTP Exception 500-\nTYPE Exception report\nMESSAGE\nDESCRIPTION The server encountered an internal error () that prevented it from\nfulfilling this request.\nEXCEPTION\norg.apache.jasper.JasperException\n\tat org.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:248)\n\tat org.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:295)\n\tat org.apache.jasper.servlet.JspServlet.service(JspServlet.java:241)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:853)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:247)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:193)\n\tat\norg.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:260)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n\tat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat\norg.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n\tat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat org.apache.catalina.core.StandardContext.invoke(StandardContext.java:2415)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:180)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n\tat\norg.apache.catalina.valves.ErrorDispatcherValve.invoke(ErrorDispatcherValve.java:170)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:641)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:172)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:641)\n\tat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat\norg.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:174)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n\tat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat org.apache.coyote.tomcat4.CoyoteAdapter.service(CoyoteAdapter.java:223)\n\tat org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:432)\n\tat\norg.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.processConnection(Http11Protocol.java:386)\n\tat org.apache.tomcat.util.net.TcpWorkerThread.runIt(PoolTcpEndpoint.java:534)\n\tat\norg.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:530)\n\tat java.lang.Thread.run(Thread.java:536)\n\nROOT CAUSE\n\njava.util.ConcurrentModificationException\n\tat java.util.HashMap$HashIterator.nextEntry(HashMap.java:762)\n\tat java.util.HashMap$KeyIterator.next(HashMap.java:798)\n\tat org.apache.catalina.util.Enumerator.nextElement(Enumerator.java:166)\n\tat org.apache.jsp.cds_jsp._jspService(cds_jsp.java:99)\n\tat org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:137)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:853)\n\tat org.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:204)\n\tat org.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:295)\n\tat org.apache.jasper.servlet.JspServlet.service(JspServlet.java:241)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:853)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:247)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:193)\n\tat\norg.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:260)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n\tat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat\norg.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n\tat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat org.apache.catalina.core.StandardContext.invoke(StandardContext.java:2415)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:180)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n\tat\norg.apache.catalina.valves.ErrorDispatcherValve.invoke(ErrorDispatcherValve.java:170)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:641)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:172)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:641)\n\tat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat\norg.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:174)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n\tat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat org.apache.coyote.tomcat4.CoyoteAdapter.service(CoyoteAdapter.java:223)\n\tat org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:432)\n\tat\norg.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.processConnection(Http11Protocol.java:386)\n\tat org.apache.tomcat.util.net.TcpWorkerThread.runIt(PoolTcpEndpoint.java:534)\n\tat\norg.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:530)\n\tat java.lang.Thread.run(Thread.java:536)"}, {"count": 1, "tags": [], "bug_id": 19103, "attachment_id": null, "id": 35632, "time": "2003-04-19T05:25:04Z", "creator": "wagner@sprynet.com", "creation_time": "2003-04-19T05:25:04Z", "is_private": false, "text": "Today, just to see what would happen I took the test app I identified in this\nbug report, created a .war file and then dumped the .war file into the deploy\nsubdirectory of JBoss 3.0.4 and the program worked like the author said it\nwould. This is an non-Tomcat version of JBoss. I tested it on both Mac OS X 10.2\nand Red Hat Linux 7.2."}, {"count": 2, "tags": [], "text": "The exception java.util.ConcurrentModificationException is thrown because you\nare removing an item from the Hash after the iterator has been created.  So what\nis the bug?\n\nNow what book is it, so that I can tell people to avoid it?  :-)", "attachment_id": null, "bug_id": 19103, "id": 35733, "time": "2003-04-21T22:45:52Z", "creator": "kin-man.chung@sun.com", "creation_time": "2003-04-21T22:45:52Z", "is_private": false}, {"count": 3, "attachment_id": null, "bug_id": 19103, "is_private": false, "id": 35735, "time": "2003-04-21T23:03:05Z", "creator": "funkman@joedog.org", "creation_time": "2003-04-21T23:03:05Z", "tags": [], "text": "session.getAttributeNames() returns an Enumeration which is NOT defined (in the\njavadocs) as fail fast. That is the crux of the bug report. Since Enumeration is\nnot fail fast, it should not throw the exception on modification of the session.\n"}, {"count": 4, "tags": [], "creator": "funkman@joedog.org", "is_private": false, "id": 35737, "creation_time": "2003-04-21T23:06:54Z", "time": "2003-04-21T23:06:54Z", "bug_id": 19103, "text": "*** Bug 6617 has been marked as a duplicate of this bug. ***", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 19103, "attachment_id": 5936, "id": 35743, "time": "2003-04-22T01:42:56Z", "creator": "funkman@joedog.org", "creation_time": "2003-04-22T01:42:56Z", "is_private": false, "text": "Created attachment 5936\n\"Clone\" the iterator in org.apache.catalina.util.Enumerator to prevent failfast"}, {"count": 6, "tags": [], "bug_id": 19103, "attachment_id": null, "id": 35820, "time": "2003-04-22T20:17:31Z", "creator": "kin-man.chung@sun.com", "creation_time": "2003-04-22T20:17:31Z", "is_private": false, "text": "Cloning the iterator in o.a.c.util.Enumerator will remove the\nConcurrentModificationException, and will let this example work.  However, it\nwill also lead to inconsistent states and makes other failures harder to\ndetect.  For instance, if an attribute that has not yet been seen during the\niteration is removed, then it will still be included in the iteration even\nthough it was removed.  In other words, we are getting around failfast in\ncircumstances it was invented for.\n\nI'd have closed this bug as \"WONTFIX\" were it not for the fact that there is a\nreal need for cleaning up the attribute list.  It's too bad that there is no\nEnumeration.remove() (like the Iterator.remove) that allows the last referenced\nitem be removed.  Perhaps the correct fix in Tomcat should emulate such behavior\nin removeAttribute?  That is, only allow attribute removal if they have been\nreferenced in the iteration, and throws an exception otherwise. "}, {"count": 7, "tags": [], "text": "Tim's patch has been applied, and will be in 4.1.25 and 5.0.2.", "is_private": false, "bug_id": 19103, "id": 36334, "time": "2003-04-29T22:07:42Z", "creator": "remm@apache.org", "creation_time": "2003-04-29T22:07:42Z", "attachment_id": null}]