[{"count": 0, "attachment_id": 29595, "creator": "marek.ruszczak@comarch.pl", "text": "Created attachment 29595\nResult of recording when exception was raised\n\nI've have some application to test which is working fine, but during recording process with JMeter when I select some link, proxy rises an exception (visible only in web browser):\n\njava.net.URISyntaxException: Illegal character in path at index 51: http://10.133.47.78:8080/comarch-cm/cm/showAccounts|C|21737.treeGroupNode|G|21731.treeGroupNode|G|21691.?clickContext=tree\n\tat java.net.URI$Parser.fail(Unknown Source)\n\tat java.net.URI$Parser.checkChars(Unknown Source)\n\tat java.net.URI$Parser.parseHierarchical(Unknown Source)\n\tat java.net.URI$Parser.parse(Unknown Source)\n\tat java.net.URI.<init>(Unknown Source)\n\tat java.net.URL.toURI(Unknown Source)\n\tat org.apache.jmeter.protocol.http.sampler.HTTPHC4Impl.sample(HTTPHC4Impl.java:232)\n\tat org.apache.jmeter.protocol.http.sampler.HTTPSamplerProxy.sample(HTTPSamplerProxy.java:62)\n\tat org.apache.jmeter.protocol.http.sampler.HTTPSamplerBase.sample(HTTPSamplerBase.java:1075)\n\tat org.apache.jmeter.protocol.http.proxy.Proxy.run(Proxy.java:212)\n\n\nI'm including a short version of recording.\n\nBelow is the content of problematic GET request from \"View Results Tree\" attached to \"HTTP Proxy Server\" (HTTP view):\n\tMethod  \tGET\n\tProtocol\thttp\n\tHost    \t10.133.47.78\n\tPort    \t8080\n\tPath    \t/comarch-cm/cm/showAccounts|C|21737.treeGroupNode|G|21731.treeGroupNode|G|21691.\n\n\tclickContext\ttree\n\nLooks like \"|\" character character is problematic here.", "id": 163419, "time": "2012-11-13T12:01:17Z", "bug_id": 54142, "creation_time": "2012-11-13T12:01:17Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 54142, "is_private": false, "text": "Ok. I found something like that: http://tools.ietf.org/html/rfc2396#section-2.4.3\nSo \"|\" character is classified as \"unwise\"! Does it mean that JMeter should treat this character as incorrect? I'm not convinced.\n\nAnyway I will report problem to application owners.", "id": 163423, "time": "2012-11-13T13:23:09Z", "creator": "marek.ruszczak@comarch.pl", "creation_time": "2012-11-13T13:23:09Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 54142, "text": "\"|\" seems to be an unsafe character and should have been encoded in your case , read http://www.faqs.org/rfcs/rfc1738.html,:\n   \"Other characters are unsafe because\n   gateways and other transport agents are known to sometimes modify\n   such characters. These characters are \"{\", \"}\", \"|\", \"\\\", \"^\", \"~\",\n   \"[\", \"]\", and \"`\".\n\n   All unsafe characters must always be encoded within a URL.\"", "id": 163494, "time": "2012-11-17T15:32:46Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2012-11-17T15:32:46Z", "is_private": false, "attachment_id": null}, {"id": 163495, "tags": [], "bug_id": 54142, "is_private": false, "count": 3, "text": "Java uses RFC2396 to check URL.\nIn this case, | is not valid.", "time": "2012-11-17T15:53:35Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2012-11-17T15:53:35Z", "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 54142, "text": "Hi,\n\nI understand that this character is classified as \"unwise\" (\"unsafe\"), and all new web application must not use it.\nOn other hand there are some old web application which are using that character in path (like mine).\nIMO JMeter should support old web applications, which do not respect this rule. Instead throwing an exception and making recording of test case impossible (or extremely complicated) it should do something else like:\n   - escape those problematic characters (modify request)\n   - or ignore the problem (add some warnings)\n\nI can understand that you have different opinion and that is why decided to mark report as \"WONTFIX\", but can you at least give me a general hint how/where can I fix it? This way I could create my own private branch of JMeter.", "id": 163520, "time": "2012-11-19T09:00:22Z", "creator": "marek.ruszczak@comarch.pl", "creation_time": "2012-11-19T09:00:22Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "creator": "marek.ruszczak@comarch.pl", "is_private": false, "text": "Small update in case if someone else accouter same problem.\nThis issue is not related to JMeter or web application.\nIt is web browser problem.\n\nI've encounter this problem when using Fire Fox.\nWhen I've tried Internet Explorer the problematic \"|\" character was replaced with \"%7C\" and recording of test was successful.", "id": 163521, "time": "2012-11-19T10:34:53Z", "bug_id": 54142, "creation_time": "2012-11-19T10:34:53Z", "attachment_id": null}, {"count": 6, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "is_private": false, "text": "Thanks for feedback.\n\nRegarding your previous comment, we usually do what you describe and tend to help as much as possible users with workarounds.\nBut in this case I had no idea :-)\n\nRegards\nPhilippe", "id": 163522, "time": "2012-11-19T10:38:18Z", "bug_id": 54142, "creation_time": "2012-11-19T10:38:18Z", "attachment_id": null}, {"count": 7, "tags": [], "text": "Thanks.\nUnder IE problem reappear in later stage, when JavaScript with this character kick in, so I have to find workaround.\nIf I find it, then I will post it here.", "is_private": false, "id": 163526, "creation_time": "2012-11-19T11:39:15Z", "time": "2012-11-19T11:39:15Z", "creator": "marek.ruszczak@comarch.pl", "bug_id": 54142, "attachment_id": null}, {"count": 8, "attachment_id": null, "creator": "sebb@apache.org", "text": "I can confirm that FireFox fails to encode URLs containing | when entered in the location field. IMO that is a bug in Firefox.\n\nHowever Opera, Chrome and IE do encode the \"|\" character when entered in the location field.\n\n==\n\nThe Proxy intercepts the outgoing request, which should already have been encoded.\n\nIn general it's not possible to safely re-encode a URL, because the encoding process introduces % characters which themselves need encoding.\n\nFor example /| should be presented as /%7C.\n\nIf this is re-encoded, it will encode the % again.", "id": 163528, "time": "2012-11-19T12:07:37Z", "bug_id": 54142, "creation_time": "2012-11-19T12:07:37Z", "tags": [], "is_private": false}, {"count": 9, "tags": [], "text": "Created attachment 29741\npath to fixing the unwise characters problem", "is_private": false, "id": 164010, "creation_time": "2012-12-10T14:43:10Z", "time": "2012-12-10T14:43:10Z", "creator": "marek.ruszczak@comarch.pl", "bug_id": 54142, "attachment_id": 29741}, {"count": 10, "tags": [], "text": "Hi,\n\nI've included patch which fixes this issue.\nPlease review that and consider to release that to trunk.\nFix is very simple.\nRoot cause of the problem is in behavior of java.net.URL.toURI() method which throws exception when simple encoding of forbidden/unwise character could do the job.\nPatch doesn't contain new test cases to cover corrected functionality.\n\nBR,\n\nMarek Ruszczak", "is_private": false, "id": 164011, "creator": "marek.ruszczak@comarch.pl", "time": "2012-12-10T14:48:35Z", "bug_id": 54142, "creation_time": "2012-12-10T14:48:35Z", "attachment_id": null}, {"count": 11, "tags": [], "bug_id": 54142, "attachment_id": 29742, "is_private": false, "id": 164023, "time": "2012-12-11T10:34:20Z", "creator": "marek.ruszczak@comarch.pl", "creation_time": "2012-12-11T10:34:20Z", "text": "Created attachment 29742\nCorrected patch - double encoding problem\n\nHi,\n\nI've noticed that there is problem with encoding url.\nFor example FireFox will encode spaces but will not encode unwise characters  (\"|\").\nSo there is danger of encoding something which was already encoded. To overcome this problem I'm first decoding uri (path and query parts) and then encode everything (including unwise characters).\nChoice of encoding (UTF-8/ANSI-ASCII/...) is problematic, so defensively someone should review my patch.\n\nI've notice that this also can be fixed in: org.apache.jmeter.protocol.http.sampler.HTTPSamplerBase.getUrl\nit might be better place to fix it but for me it is hard to evaluate.\n\nBR,\n\nMarek"}, {"count": 12, "tags": [], "bug_id": 54142, "attachment_id": null, "is_private": false, "id": 164024, "time": "2012-12-11T11:45:59Z", "creator": "sebb@apache.org", "creation_time": "2012-12-11T11:45:59Z", "text": "The problem only arises when using the Proxy Server.\n\nHowever the patch affects all usage of the HC4 implementation. I think this is wrong:\n- we should not mess with existing test plans using HC4\n- it may not work for other HTTP implementations\n- it's unnecessary work for most samples\n\nAny patch that is applied needs to be for the Proxy Server only.\n\nBut I do agree that decoding and then re-encoding the URL should avoid the double-encoding issue as mentioned in comment 8.\n\nIt would be sensible to check if the URL is valid before attempting to fix it, rather than unconditionally \"fixing\" each URL. This would avoid unnecessary conversions possibly changing the URL.\n\nThis would be slightly more work for the invalid case - but the work is done by the Proxy Server, not as part of a test - and is the minimal work required to work round what is a browser bug."}, {"count": 13, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": null, "is_private": false, "id": 164122, "time": "2012-12-17T07:39:21Z", "bug_id": 54142, "creation_time": "2012-12-17T07:39:21Z", "text": "You should try to apply your fix in DefaultSamplerCreator#computePath() method."}, {"count": 14, "attachment_id": null, "bug_id": 54142, "text": "Fixed as part of 54482 fix", "id": 165065, "time": "2013-02-04T22:04:40Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2013-02-04T22:04:40Z", "tags": [], "is_private": false}, {"count": 15, "tags": [], "bug_id": 54142, "text": "Date: Mon Feb  4 22:05:10 2013\nNew Revision: 1442395\n\nURL: http://svn.apache.org/viewvc?rev=1442395&view=rev\nLog:\nBug 54142 - HTTP Proxy Server throws an exception when path contains \"|\" character\nBugzilla Id: 54142\n\nModified:\n    jmeter/trunk/xdocs/changes.xml", "id": 165066, "time": "2013-02-04T22:05:49Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2013-02-04T22:05:49Z", "is_private": false, "attachment_id": null}, {"count": 16, "attachment_id": null, "bug_id": 54142, "text": "I've tested it and it works perfectly.\nThanks a lot.\n\nBR,\n\nMarek\n\nPS. I'm not sure if I should change status to VERIFIED/FIXED so I leave it as it is.", "id": 165075, "time": "2013-02-05T11:32:39Z", "creator": "marek.ruszczak@comarch.pl", "creation_time": "2013-02-05T11:32:39Z", "tags": [], "is_private": false}, {"count": 17, "tags": [], "text": "Fix introduces regressions on this kind of URLs\nhttp://XXX.XXXX.com/toto_titi_tata/CatalogData/ItemImages\\IJ\\Items_1152\\07_06_015_Na_0_0_0_Aucune_0_Na_Na_Batik_s.jpg", "is_private": false, "id": 166535, "creation_time": "2013-04-11T20:20:13Z", "time": "2013-04-11T20:20:13Z", "creator": "p.mouawad@ubik-ingenierie.com", "bug_id": 54142, "attachment_id": null}, {"count": 18, "tags": [], "bug_id": 54142, "text": "Date: Thu Apr 11 20:24:48 2013\nNew Revision: 1467074\n\nURL: http://svn.apache.org/r1467074\nLog:\nRollback to fix of bugs:\n54482- HC fails to follow redirects with non-encoded chars\n54293- JMeter rejects html tags '&lt;' in query params as invalid when they are accepted by the browser\n54142- HTTP Proxy Server throws an exception when path contains \"|\" character\n\nBugzilla Id: 54482,54293,54142\n\nModified:\n    jmeter/trunk/src/protocol/http/org/apache/jmeter/protocol/http/sampler/HTTPHC3Impl.java\n    jmeter/trunk/src/protocol/http/org/apache/jmeter/protocol/http/sampler/HTTPHC4Impl.java\n    jmeter/trunk/xdocs/changes.xml", "id": 166538, "time": "2013-04-11T20:26:06Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2013-04-11T20:26:06Z", "is_private": false, "attachment_id": null}, {"count": 19, "tags": [], "bug_id": 54142, "is_private": false, "text": "Created attachment 30670\nPatch for issue fixing unsafe URLs during parsing\n\nPatch proposition which escapes IllegalURLCharacters if browser does not.\nThe idea is to convert to URI the URL, if it fails then it means it contains unsafe characters, then they are fixed.\n\nMy issue with this patch is that it fixes the issues for HttpClient3 and 4 but it also fixes for Java which could break", "id": 169080, "time": "2013-08-03T22:50:40Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2013-08-03T22:50:40Z", "attachment_id": 30670}, {"count": 20, "tags": [], "creator": "sebb@apache.org", "attachment_id": null, "is_private": false, "id": 169212, "time": "2013-08-07T00:44:14Z", "bug_id": 54142, "creation_time": "2013-08-07T00:44:14Z", "text": "(In reply to Philippe Mouawad from comment #19)\n> Created attachment 30670 [details]\n> Patch for issue fixing unsafe URLs during parsing\n> \n> Patch proposition which escapes IllegalURLCharacters if browser does not.\n> The idea is to convert to URI the URL, if it fails then it means it contains\n> unsafe characters, then they are fixed.\n\nSeems OK. \nThe conversion method could be added to ConversionUtils.\nIt needs some test cases.\n\n> My issue with this patch is that it fixes the issues for HttpClient3 and 4\n> but it also fixes for Java which could break\n\nNot sure I follow.\n\nThe purpose of this patch is to fix up URLs generated by browsers that don't encode all unsafe characters. It should be equivalent to using a well-behaved browser currently."}, {"count": 21, "tags": [], "bug_id": 54142, "attachment_id": null, "is_private": false, "id": 169282, "time": "2013-08-07T21:27:19Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2013-08-07T21:27:19Z", "text": "Date: Wed Aug  7 21:25:45 2013\nNew Revision: 1511503\n\nURL: http://svn.apache.org/r1511503\nLog:\nBug 54142 - HTTP Proxy Server throws an exception when path contains \"|\" character\nIntegrated my patch with a slight change to make current behaviour with Java Impl remain the same as bug only affects HC impls\nBugzilla Id: 54142\n\nModified:\n    jmeter/trunk/src/protocol/http/org/apache/jmeter/protocol/http/proxy/HttpRequestHdr.java\n    jmeter/trunk/src/protocol/http/org/apache/jmeter/protocol/http/util/ConversionUtils.java\n    jmeter/trunk/xdocs/changes.xml"}]