[{"count": 0, "tags": [], "bug_id": 34897, "attachment_id": null, "text": "Okay, I have tested this repeatedly with Apache 2.0.53 on Debian.  We commonly\nmix LDAP authenticated users with a handful of local accounts.\n\nI'm setting up authentication for a directory in my httpd.conf.\n\nI start with a working configuration that allows LDAP users to access a\ndirectory secured using Basic Auth.\n\nIf I add an AuthUserFile directive to the same <Directory> block, LDAP\nauthentication won't work at all for that directory, only local users will work.\n   The same settings work again for LDAP users as soon as you remove or comment\nout the AuthUserFile directive.  This happens regardless of whether\nAuthLDAPAuthoritative is set to \"off\" or \"on\".\n\nMy understanding is that with AuthLDAPAuthoritative set to \"off\", the system\nshould check LDAP first, then fail over to the local user settings.\n\nHere's an example <Directory> block:\n\n  <Directory \"/apps/content/fdi.cc.vt.edu/web_root/authtest\">\n     Options FollowSymLinks Indexes\n     AllowOverride None\n\n     AuthType Basic\n     AuthUserFile /home/www/fdi.cc.vt.edu/conf/.htpasswd\n\n     AuthName \"Please enter your PID and password to access secure content\"\n\n     AuthLDAPEnabled on\n     AuthLDAPAuthoritative off\n     AuthLDAPURL \"ldaps://authn.directory.vt.edu:636/ou=accounts,dc=vt,dc=edu?uupid\"\n\n     require user tblake local\n  </Directory>\n\nIn this example, the LDAP user is \"tblake\", and the local user is \"local\".\n\nI tried turning LogLevel to \"debug\", the only thing I saw in the error log was:\n\n\"user tblake not found: /authtest/\"\n\nWhich to me sounds like it's not even trying to hit the LDAP server if\nAuthUserFile is set.  I looked at the patch list for 2.0.54, it didn't sound\nlike this was addressed in that release.", "id": 74810, "time": "2005-05-12T15:56:21Z", "creator": "anthony.atkins@vt.edu", "creation_time": "2005-05-12T15:56:21Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 34897, "attachment_id": null, "id": 74821, "time": "2005-05-12T19:15:23Z", "creator": "anthony.atkins@vt.edu", "creation_time": "2005-05-12T19:15:23Z", "is_private": false, "text": "Okay.  A colleague of mine (Dave Hawes, dhawes@vt.edu) supplied the following patch:\n\n== BEGIN PATCH ==\n--- mod_auth_ldap.c     Fri Feb  4 15:21:18 2005\n+++ mod_auth_ldap.c     Fri Mar 25 17:08:32 2005\n@@ -1074,8 +1074,10 @@\n\n static void mod_auth_ldap_register_hooks(apr_pool_t *p)\n {\n+    static const char * const aszPost[] = { \"mod_auth.c\", NULL };\n+\n     ap_hook_post_config(auth_ldap_post_config,NULL,NULL,APR_HOOK_MIDDLE);\n-    ap_hook_check_user_id(mod_auth_ldap_check_user_id, NULL, NULL,\nAPR_HOOK_MIDDLE);\n+    ap_hook_check_user_id(mod_auth_ldap_check_user_id, NULL, aszPost,\nAPR_HOOK_MIDDLE);\n     ap_hook_auth_checker(mod_auth_ldap_auth_checker, NULL, NULL, APR_HOOK_MIDDLE);\n }\n\n== END PATCH ==\n\nThe patch forces mod_auth to load after mod_auth_ldap, which in conjunction with\nthe AuthLDAPAuthoritative allows for a combination of LDAP and .htpasswd users\nin the same context.\n\nI realize that this isn't appropriate for the code base at large, as there are\nmany other mixtures of auth that people use, but hopefully it will help someone\nin a similar circumstance who's searching for bugs.\n\nThis might be considered a feature request, but it's difficult to see how the\nAuthLDAPAuthoritative directive is meaningful if you have to go so far out of\nthe way to use it.  Maybe a global directive to control the order in which auth\nmodules load is in order."}, {"count": 2, "tags": [], "text": "I think all you really need to do is set AuthAuthoritative to OFF as well as \nAuthLDAPAuthoritative.  Then it won't matter which order the auth modules are \nloaded.  They will either handle the authentication or defer.", "is_private": false, "bug_id": 34897, "id": 74826, "time": "2005-05-12T21:48:21Z", "creator": "bnicholes@apache.org", "creation_time": "2005-05-12T21:48:21Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 34897, "is_private": false, "id": 74831, "attachment_id": null, "creator": "anthony.atkins@vt.edu", "creation_time": "2005-05-12T23:05:18Z", "time": "2005-05-12T23:05:18Z", "text": "That works just fine.  Great."}]