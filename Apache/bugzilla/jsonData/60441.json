[{"attachment_id": null, "tags": [], "bug_id": 60441, "is_private": false, "count": 0, "id": 195354, "time": "2016-12-05T08:50:44Z", "creator": "tiziano.digennaro@gmail.com", "creation_time": "2016-12-05T08:50:44Z", "text": "In our production system we have a custom compiled version of apache 2.2.31 on a debian machine with OpenSSL 1.0.1u\n\nServer version: Apache/2.2.31 (Unix)\nServer built:   Oct 31 2016 13:51:59\nServer's Module Magic Number: 20051115:40\nServer loaded:  APR 1.5.2, APR-Util 1.5.4\nCompiled using: APR 1.5.2, APR-Util 1.5.4\nArchitecture:   64-bit\nServer MPM:     Worker\n  threaded:     yes (fixed thread count)\n    forked:     yes (variable process count)\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/worker\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"/opt/loadbalancer/apache\"\n -D SUEXEC_BIN=\"/opt/loadbalancer/apache/bin/suexec\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"\n\nSometimes during high load we got from the client and ssl handshake failure.\nI was able to reproduce the bug with apache banchmark. It always happens above 4 as concurrency level (ab -c 5 -n 2000 -p post.body)\nHere the tcpdump that show after the Change Cipher Spec it always happens this issue.\n12\t0.001043\t193.33.xxx.xxx\t10.xxx.xxx.xxx\tTCP\t68\t10498\u2192443 [SYN] Seq=0 Win=8192 Len=0 MSS=1420 WS=256 SACK_PERM=1\n26\t0.016894\t193.xxx.xxx.xxx\t10.xxx.xxx.xxx\tTCP\t62\t10498\u2192443 [ACK] Seq=1 Ack=1 Win=66560 Len=0\n35\t0.020474\t193.xxx.xxx.xxx\t10.xxx.xxx.xxx TLSv1.2\t573\tClient Hello\n49\t0.042871\t193.xxx.xxx.xxx\t10.xxx.xxx.xxx\tTCP\t62\t10498\u2192443 [ACK] Seq=518 Ack=2841 Win=66560 Len=0\n50\t0.043990\t193.xxx.xxx.xxx 10.xxx.xxx.xxx\tTCP\t62\t10498\u2192443 [ACK] Seq=518 Ack=4873 Win=66560 Len=0\n54\t0.045390\t193.xxx.xxx.xxx\t10.xxx.xxx.xxx\tTLSv1.2\t182\tClient Key Exchange, Change Cipher Spec, Encrypted Handshake Message\n89\t0.091799\t193.xxx.xxx.xxx\t10.xxx.xxx.xxx\tTLSv1.2\t412\tApplication Data\n109\t0.131868\t193.xxx.xxx.xxx\t10.xxx.xxx.xxx\tTCP\t62\t10498\u2192443 [ACK] Seq=1000 Ack=5936 Win=65536 Len=0\n110\t0.132318\t193.xxx.xxx.xxx\t10.xxx.xxx.xxx\tTLSv1.2\t87\tEncrypted Alert\n111\t0.132563\t193.xxx.xxx.xxx\t10.xxx.xxx.xxx\tTCP\t62\t10498\u2192443 [FIN, ACK] Seq=1031 Ack=5936 Win=65536 Len=0\n\nI always got and \"Content Type: Alert (21)\" as Encrypted Alert.\nI'm not able to got any error message on the apache itselfe, so could be a problem in openssl itselfe"}, {"count": 1, "tags": [], "creator": "tiziano.digennaro@gmail.com", "attachment_id": null, "is_private": false, "id": 195360, "time": "2016-12-05T12:12:24Z", "bug_id": 60441, "creation_time": "2016-12-05T12:12:24Z", "text": "Heres the ssl option that currently i'm using\n\nSSLRandomSeed startup builtin\nSSLRandomSeed connect builtin\nSSLPassPhraseDialog  builtin\nSSLSessionCache        shmcb:/var/run/apache/ssl_scache(1024000)\nSSLSessionCacheTimeout  300\nSSLMutex  file:/var/run/apache/ssl_mutex\n\n\nSSLEngine on\nSSLProtocol -ALL +TLSv1 +TLSv1.1 +TLSv1.2\nSSLCipherSuite ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK\nSSLHonorCipherOrder On\nSSLCertificateFile file\nSSLCertificateKeyFile file\nSSLCACertificateFile file\nSSLOptions +StdEnvVars\nSSLProxyEngine\t\t\tOn"}, {"count": 2, "tags": [], "bug_id": 60441, "attachment_id": null, "id": 195374, "time": "2016-12-06T17:27:09Z", "creator": "covener@gmail.com", "creation_time": "2016-12-06T17:27:09Z", "is_private": false, "text": "You'll have to find some more data here -- error log, some optional feature that casues the issue, or some sign of a regression."}]