[{"count": 0, "tags": [], "creator": "ian@penguinhosting.net", "attachment_id": null, "is_private": false, "id": 33481, "time": "2003-03-19T19:03:04Z", "bug_id": 18156, "creation_time": "2003-03-19T19:03:04Z", "text": "When executing CGI's inside a Userdir, Apache attempts to run the CGI at the\nSuexecUserGroup from the VirtualHost directive instead of the user who's\ndirectory we're looking at.  This trips the security protection in suexec and\ncauses an Internal Server Error message.  Suexec logs something like:\n\n[2003-03-19 18:57:32]: target uid/gid (1000/1000) mismatch with directory\n(1053/1053) or program (1053/1053)\n\n(Where 1000/1000 is the SuexecUserGroup for the 'ares.penguinhosting.net' named\nvirtual host, and 1053/1053 is the user/group of 'david' for the listed URL).\n\nApache 1 behaves properly in the same case."}, {"count": 1, "tags": [], "bug_id": 18156, "attachment_id": null, "id": 54902, "time": "2004-03-30T20:38:48Z", "creator": "hans@vankilsdonk.nl", "creation_time": "2004-03-30T20:38:48Z", "is_private": false, "text": "I'm having the exact same problem. Running suexec in the document root is no\nproblem, however, Apache is not sending the \"~\" to Suexec when a userdir is\naccessed."}, {"count": 2, "tags": [], "text": "Are you actually using mod_userdir ONLY to serve these requests, or is there\nsome kind of Alias/ScriptAlias/RewriteRule that is involved?", "is_private": false, "bug_id": 18156, "id": 54904, "time": "2004-03-30T21:14:52Z", "creator": "slive@apache.org", "creation_time": "2004-03-30T21:14:52Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 18156, "attachment_id": null, "id": 54905, "time": "2004-03-30T21:39:25Z", "creator": "hans@vankilsdonk.nl", "creation_time": "2004-03-30T21:39:25Z", "is_private": false, "text": "I've got some Rewriterules, but they don't apply for the UserDir directive. This\nis my VirtualHost config:\n\n<VirtualHost www.domain.nl:80>\n        SuexecUserGroup username group\n        ServerAdmin emailaddress\n\n        DocumentRoot \"/home/sites/site1/web/\"\n                <Directory \"/home/sites/site1/web\">\n                    Options Indexes FollowSymLinks MultiViews Includes +ExecCGI\n                    AllowOverride All\n                    Order allow,deny\n                    Allow from all\n                </Directory>\n\n        ServerName www.domain.nl\n        ServerAlias *.domain.nl domain.nl\n\n        RewriteEngine On\n        RewriteRule ^/personal/?$       http://www.domain.nl:81 [L,R]\n        RewriteRule ^/siteadmin/?$      http://www.domain.nl:81 [L,R]\n        RewriteRule ^/admin/?$          http://www.domain.nl:81 [L,R]\n        RewriteRule ^/login/?$          http://www.domain.nl:81 [L,R]\n        RewriteRule ^/webmail/?$        http://www.domain.nl:81/webmail/ [L,R]\n        RewriteRule ^/fileman/?$        http://www.domain.nl:81/webmail/ [L,R]\n        RewriteOptions inherit\n        <Directory \"/home/sites/site1/users/*/web\">\n            Options Indexes FollowSymLinks MultiViews Includes +ExecCGI\n            AllowOverride All\n            Order allow,deny\n            Allow from all\n        </Directory>\n        ErrorLog /home/sites/site1/logs/error.log\n        CustomLog /home/sites/site1/logs/web.log combined\n</VirtualHost>\n\nIn httpd.conf the following is set:\n\nUserDir web\n\nand my suexec -V output is:\n\n -D AP_DOC_ROOT=\"/home/sites/\"\n -D AP_GID_MIN=100\n -D AP_HTTPD_USER=\"www\"\n -D AP_LOG_EXEC=\"/usr/local/apache2/logs/suexec_log\"\n -D AP_SAFE_PATH=\"/usr/local/bin:/usr/bin:/bin\"\n -D AP_SUEXEC_UMASK=022\n -D AP_UID_MIN=100\n -D AP_USERDIR_SUFFIX=\"web\"\n\n"}, {"count": 4, "tags": [], "creator": "floeff@arcor.de", "attachment_id": null, "text": "Anything new regarding this bug? I'm facing EXACTLY the same problem on 2.0.49, \nwhich renders it completely unusable for me. Apache 1 worked fine, it used User \nand Group when no UserDir request was made, and used the correct user when a \nUserDir request was made.\n\nPlease have a look at this soon, it prevents me from using 2.x :-(", "id": 55608, "time": "2004-04-10T11:09:16Z", "bug_id": 18156, "creation_time": "2004-04-10T11:09:16Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 18156, "attachment_id": null, "id": 55609, "time": "2004-04-10T11:23:20Z", "creator": "floeff@arcor.de", "creation_time": "2004-04-10T11:23:20Z", "is_private": false, "text": "Attached is some system information that might be helpful.\n\nMy configure command-line:\n./configure --enable-mods-shared=all --enable-ssl --enable-proxy --enable-suexec \n--with-suexec-caller=nobody --with-suexec-docroot=/home\n\n\nOutput of suexec -V:\n -D AP_DOC_ROOT=\"/home\"\n -D AP_GID_MIN=100\n -D AP_HTTPD_USER=\"nobody\"\n -D AP_LOG_EXEC=\"/usr/local/apache2/logs/suexec_log\"\n -D AP_SAFE_PATH=\"/usr/local/bin:/usr/bin:/bin\"\n -D AP_UID_MIN=100\n -D AP_USERDIR_SUFFIX=\"public_html\"\n\n\nOutput of apachectl -V:\nServer version: Apache/2.0.49\nServer built:   Apr 10 2004 13:17:23\nServer's Module Magic Number: 20020903:7\nArchitecture:   32-bit\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D HTTPD_ROOT=\"/usr/local/apache2\"\n -D SUEXEC_BIN=\"/usr/local/apache2/bin/suexec\"\n -D DEFAULT_PIDLOG=\"logs/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_LOCKFILE=\"logs/accept.lock\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"\n\n\nRelevant settings in httpd.conf:\nUserDir disabled\nUserDir disabled root\n[...]\n<Directory /home/*/public_html>\n     AllowOverride All\n     Options -Indexes MultiViews ExecCGI SymLinksIfOwnerMatch IncludesNoExec\n        Order allow,deny\n        Allow from all\n</Directory>\n[...]\n<Directory /home/sites/*/users/*/public_html>\n    AllowOverride All\n    Options -Indexes MultiViews ExecCGI SymLinksIfOwnerMatch IncludesNoExec\n    Order Deny,Allow\n    Allow from all\n</Directory>\n\n\nRelevant settings in my included virtualhosts.conf:\nNameVirtualHost *:80\n\n<VirtualHost *:80>\nServerName my.main.domain\nUserDir disabled\nUserDir disabled root\nRewriteEngine on\nRewriteOptions inherit\n</VirtualHost>\n[...]\n<VirtualHost *:80>\nServerName www.sub.domain.ofmine\nServerAlias sub.domain.of.mine\nServerAdmin my@root.address\nDocumentRoot /home/sites/s1234/users/u0001/public_html\nUserDir disabled\nUserDir disabled root\nUserDir enabled s1234u0003\n[...some other enabled UserDirs...]\nSuexecUserGroup s1234u0074 s1234\nRewriteEngine on\nRewriteOptions inherit\n[...some RewriteRules...]\n</VirtualHost>"}, {"count": 6, "tags": [], "bug_id": 18156, "attachment_id": null, "id": 56506, "time": "2004-04-27T19:52:33Z", "creator": "floeff@arcor.de", "creation_time": "2004-04-27T19:52:33Z", "is_private": false, "text": "Anything new in here? This one is a really bad one :-("}, {"count": 7, "tags": [], "bug_id": 18156, "attachment_id": null, "id": 56509, "time": "2004-04-27T20:18:25Z", "creator": "nd@perlig.de", "creation_time": "2004-04-27T20:18:25Z", "is_private": false, "text": "Perhaps someone could answer to the question regarding the scriptalias directives?\nOr better - attach the *full* config?"}, {"count": 8, "tags": [], "bug_id": 18156, "attachment_id": null, "text": "I have attached my config. Is there some important part missing? It doesn't work\nwith and without RewriteRules.", "id": 56512, "time": "2004-04-27T20:42:55Z", "creator": "floeff@arcor.de", "creation_time": "2004-04-27T20:42:55Z", "is_private": false}, {"count": 9, "tags": [], "creator": "heller@deepsoft.com", "attachment_id": null, "text": "'m guessing this is a variation of the 'bug' (really documentation problem)\nwith suexec + UserDir in Apache 2.0.x.\n\nBasically, you cannot use the 'old style' scriptalias directives with user dirs\nand suexec.\n\nTry this version of your user CGI bin directory setup:\n\n        <Directory ~ \"/home/sites/site1/users/*/web\">\n            Options Indexes FollowSymLinks MultiViews Includes +ExecCGI\n            AllowOverride All\n            Order allow,deny\n            Allow from all\n            SetHandler cgi-script\n        </Directory>\n\nOh, you need to include the UserDir and SuExec modulea:\n\nLoadModule userdir_module modules/mod_userdir.so\nLoadModule suexec_module modules/mod_suexec.so\n\nAnd *don't* include any sort of scriptalias for your user's dirs.\n", "id": 56515, "time": "2004-04-27T21:01:58Z", "bug_id": 18156, "creation_time": "2004-04-27T21:01:58Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 18156, "attachment_id": null, "id": 56550, "time": "2004-04-28T14:18:37Z", "creator": "floeff@arcor.de", "creation_time": "2004-04-28T14:18:37Z", "is_private": false, "text": "LoadModule suexec_module modules/mod_suexec.so\nand\nLoadModule userdir_module modules/mod_userdir.so\nare activated in my httpd.conf.\n\nHowever, your solution shown below does not help. :-(\nMay I e-mail you my httpd.conf and my included virtualhosts.conf, so you can\ncheck it? Because of data privacy and security issues, I don't want to attach\nthe full \nconfiguration to this bug.\n\nMay I e-mail it to you privately?\n\nThanks!"}, {"count": 11, "tags": [], "bug_id": 18156, "attachment_id": null, "id": 56551, "time": "2004-04-28T14:37:29Z", "creator": "heller@deepsoft.com", "creation_time": "2004-04-28T14:37:29Z", "is_private": false, "text": "I'm not one of the Apache developers, just a fellow user of suexec.  I\nam not sure how much help I can give you.  I don't presently have an \nApache 2.0.x server installed and running anywhere at present, so I \ncannot actually test anything either.  All I know is that  \n\nIt is entirely possible that it is a real bug.\n\nMaybe what you need to post is a stripped down version of your \nhttpd.conf and virtualhosts.conf files, ones that are minimually \nsuffientent to cause the problem, but which don't leak any real \n(priviledged) data -- this way the developers can re-create your problem     \nand then come up with a working solution. "}, {"count": 12, "tags": [], "creator": "floeff@arcor.de", "attachment_id": null, "text": "Hi there, and thanks for the quick reply ;-)\nIf any of the developers could post to this bug (I haven't heard anything from\nthem yet ;-( I'd happily provide them with my httpd.conf ;)", "id": 56561, "time": "2004-04-28T16:08:21Z", "bug_id": 18156, "creation_time": "2004-04-28T16:08:21Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 18156, "attachment_id": null, "text": "Here's what you should do:\nStart with a default install of apache from httpd.apache.org, and then make the\nabsolute minimum changes that are necessary to show the problem.  Then give us a\nlist of the changes.", "id": 56565, "time": "2004-04-28T16:22:39Z", "creator": "slive@apache.org", "creation_time": "2004-04-28T16:22:39Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 18156, "attachment_id": null, "text": "Here it comes ;-)\n\n\nSystem installed on:\n\nDebian GNU/Linux Sarge x86\n\n\nNon-FQDN hostname of the system tested on: floeff3.effenberger (sometimes\nmentioned in the configuration file)\n\n\nApache source code used:\n\nhttp://www.artfiles.org/apache.org/httpd/httpd-2.0.49.tar.gz\n\n\nSteps taken for compilation:\n\n- apt-get install libssl-dev binfmt-support\n\n- ./configure --enable-mods-shared=all --enable-ssl --enable-proxy\n--enable-suexec --with-suexec-caller=nobody --with-suexec-docroot=/home\n\n- make\n\n- make install\n\n- addgroup site1\n\n- adduser --shell /bin/false --ingroup site1 user1\n\n- mkdir /home/user1/public_html\n\n- chown user1:site1 /home/user1/public_html\n\n- adduser --shell /bin/false --ingroup site1 user2\n\n- mkdir /home/user2/public_html\n\n- chown user2:site1 /home/user2/public_html\n\n- Content of /home/user1/public_html/whoami.pl and\n/home/user2/public_html/whoami.pl:\n  #!/usr/bin/perl\n  print \"Content-type: text/plain\\n\\n\";\n  system \"whoami\";\n\n- chown user1:site1 /home/user1/public_html/whoami.pl\n\n- chmod 755 /home/user1/public_html/whoami.pl\n\n- chown user2:site1 /home/user2/public_html/whoami.pl\n\n- chmod 755 /home/user2/public_html/whoami.pl\n\n\nOpen http://floeff3 => \"user1\" is being printed\nOpen http://floeff3/~user2/ => Internal Server Error with\n\n[2004-04-29 16:01:36]: target uid/gid (1002/1004) mismatch with directory\n(1003/1004) or program (1003/1004)\n\n\n# id user1\nuid=1002(user1) gid=1004(site1) groups=1004(site1)\n\n# id user2\nuid=1003(user2) gid=1004(site1) groups=1004(site1)\n\n\nI have put the configuration changes I've made together in the attached patch\nfile which you should use against /usr/local/apache2/httpd.conf\n\nPlease let me know if you need anything else. Thanks for taking the time. ;-)", "id": 56630, "time": "2004-04-29T14:04:50Z", "creator": "floeff@arcor.de", "creation_time": "2004-04-29T14:04:50Z", "is_private": false}, {"count": 15, "tags": [], "creator": "floeff@arcor.de", "attachment_id": 11376, "text": "Created attachment 11376\npatch for the original httpd.conf file", "id": 56631, "time": "2004-04-29T14:05:51Z", "bug_id": 18156, "creation_time": "2004-04-29T14:05:51Z", "is_private": false}, {"count": 16, "tags": [], "creator": "slive@apache.org", "attachment_id": null, "text": "Thanks, that's clearer.  But there is still some stuff which I assume is\nirrelevant to your problem, like the mod_rewrite directives and the UserDir\ndisabled stuff.  Does your problem go away if you remove those?\n\nUnfortunately, I don't have a unix system available to test on at the moment. \nI've looked at the code, and it appears to me that when both SuexecUserGroup and\nmod_userdir is active, there is no defined ordering between the\nget_suexec_identity hooks.  So perhaps the userdir suexec stuff doesn't work at\nall if SuexecUserGroup is present.  In that case, simply fixing the hook\nordering could fix the problem.", "id": 56632, "time": "2004-04-29T14:41:18Z", "bug_id": 18156, "creation_time": "2004-04-29T14:41:18Z", "is_private": false}, {"count": 17, "tags": [], "bug_id": 18156, "attachment_id": null, "id": 56633, "time": "2004-04-29T15:25:08Z", "creator": "floeff@arcor.de", "creation_time": "2004-04-29T15:25:08Z", "is_private": false, "text": "Thanks for your fast reply! I've set the following lines (in the patch) to the\nhttpd.conf defaults:\n\n===\n-UserDir public_html\n+#UserDir public_html\n+UserDir disabled\n+UserDir disabled root\n[...]\n+RewriteEngine on\n+RewriteOptions inherit\n[...]\n+Userdir enabled user2\n===\n\nI still get an Internal Server Error, so they don't seem to have anything to do\nwith the problem. ;-)\n\nIs there anything else you need or did I sent all information necessary to fix\nthe bug?"}, {"count": 18, "tags": [], "text": "Here's a wild guess:\n\nIndex: mod_userdir.c\n===================================================================\nRCS file: /home/cvs/httpd-2.0/modules/mappers/mod_userdir.c,v\nretrieving revision 1.52.2.4\ndiff -u -d -b -r1.52.2.4 mod_userdir.c\n--- mod_userdir.c       9 Feb 2004 20:53:19 -0000       1.52.2.4\n+++ mod_userdir.c       29 Apr 2004 15:38:30 -0000\n@@ -350,7 +350,7 @@\n \n     ap_hook_translate_name(translate_userdir,aszPre,aszSucc,APR_HOOK_MIDDLE);\n #ifdef HAVE_UNIX_SUEXEC\n-    ap_hook_get_suexec_identity(get_suexec_id_doer,NULL,NULL,APR_HOOK_MIDDLE);\n+    ap_hook_get_suexec_identity(get_suexec_id_doer,NULL,NULL,APR_HOOK_FIRST);\n #endif\n }\n \nIf that isn't it, you'll have to wait for another developer to look at it, since\nI don't have the resources to do suexec testing.", "attachment_id": null, "bug_id": 18156, "id": 56634, "time": "2004-04-29T15:41:21Z", "creator": "slive@apache.org", "creation_time": "2004-04-29T15:41:21Z", "is_private": false}, {"count": 19, "tags": [], "creator": "floeff@arcor.de", "attachment_id": null, "is_private": false, "id": 56635, "time": "2004-04-29T16:22:07Z", "bug_id": 18156, "creation_time": "2004-04-29T16:22:07Z", "text": "Thanks Joshua, this one seems to work! I've tested it locally, and I have no\nproblems anymore! ;-)\n\nWill this bugfix be incorporated in 2.0.50?"}, {"count": 20, "tags": [], "bug_id": 18156, "attachment_id": null, "text": "I won't commit this myself, since I can't test it.  But another developer will\nhopefully pick it up.\n\nThis could be considered a non-compatible change, since there is a chance\nsomeone might be relying on SuexecUserGroup taking precedence of UserDir for\nsuexec.  But this change should get us closer to the way it worked in 1.3, and\nit makes sense to me as the expected way things should work, so I think it\nshould be committed.", "id": 56639, "time": "2004-04-29T16:57:27Z", "creator": "slive@apache.org", "creation_time": "2004-04-29T16:57:27Z", "is_private": false}, {"count": 21, "tags": [], "creator": "floeff@arcor.de", "attachment_id": null, "text": "Okay :)\nMaybe you just have to make the change clear in the change log or add an option \nfor httpd.conf to choose between the \"new old\" and the 2.0 default behaviour.\nThanks again for your quick reply and great help, much appreciated!", "id": 56646, "time": "2004-04-29T17:42:36Z", "bug_id": 18156, "creation_time": "2004-04-29T17:42:36Z", "is_private": false}, {"count": 22, "tags": [], "bug_id": 18156, "attachment_id": null, "text": "Where can I \"find\" a developer to test and eventually contribute this to the\nCVS? :-)", "id": 57406, "time": "2004-05-14T11:41:23Z", "creator": "floeff@arcor.de", "creation_time": "2004-05-14T11:41:23Z", "is_private": false}, {"count": 23, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "text": "A workaround is to swap the order of the LoadModule lines for suexec and userdir.\n\nI'll test Joshua's patch: it's hard to argue this is an incompatible change\nsince the current behaviour is not defined so it's OK for 2.0 as well, I'd guess.", "id": 62067, "time": "2004-08-17T10:39:50Z", "bug_id": 18156, "creation_time": "2004-08-17T10:39:50Z", "is_private": false}, {"count": 24, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "is_private": false, "id": 62100, "time": "2004-08-18T08:25:37Z", "bug_id": 18156, "creation_time": "2004-08-18T08:25:37Z", "text": "Committed, will propose for backport.  Thanks for the report and thank you\nJoshua for the patch."}, {"count": 25, "tags": [], "bug_id": 18156, "attachment_id": null, "id": 62101, "time": "2004-08-18T08:29:06Z", "creator": "floeff@arcor.de", "creation_time": "2004-08-18T08:29:06Z", "is_private": false, "text": "Thanks a lot for implementing it! :-)"}]