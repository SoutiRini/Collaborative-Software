[{"count": 0, "tags": [], "bug_id": 17564, "attachment_id": null, "text": "Sometimes mod_negotiation fails to select right veriant. At once after restart\nit works, but after several page reloads it get 406 Not Acceptaple. This hapens\nif, for exaple, browse send following headers\n\nAccept:text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,video/x-mng,image/png,image/jpeg,image/gif;q=0.2,text/css,*/*;q=0.1\nAccept-Charset: KOI8-R, utf-8;q=0.66, *;q=0.66\nAccept-Language: ru, en;q=0.66, fr;q=0.33\n\nAfter server restart atof at line 392 of mod_negotiation.c:\n result->quality = (float)atof(cp);\nworks right\n\ntext/html Quality: 0.9 -> 0.900000\ntext/plain Quality: 0.8 -> 0.800000\nimage/gif Quality: 0.2 -> 0.200000\n*/* Quality: 0.1 -> 0.100000\ncompress Quality: 0.9 -> 0.900000\nen Quality: 0.66 -> 0.660000\nfr Quality: 0.33 -> 0.330000\nutf-8 Quality: 0.66 -> 0.660000\n* Quality: 0.66 -> 0.660000\n\n(value before '->' is string passed as argument for atof function, value after -\nis a value returned by atof)\n\nBuf after i get 406 (Not Acceptable) it look like\ntext/html Quality: 0.9 -> 0,000000\ntext/plain Quality: 0.8 -> 0,000000\nimage/gif Quality: 0.2 -> 0,000000\n*/* Quality: 0.1 -> 0,000000\ncompress Quality: 0.9 -> 0,000000\nen Quality: 0.66 -> 0,000000\nfr Quality: 0.33 -> 0,000000\nutf-8 Quality: 0.66 -> 0,000000\n* Quality: 0.66 -> 0,000000\n\nIf i change atof call at line 392 for this function:\n\nstatic float ap_atoq(const char *str) {\n  float result1 = atof(str);\n  float result2 = 0.0;\n  char *p = strchr(str, '.'), *d;\n  \n  if (p != NULL) {\n    *p = ',';\n    result2 = atof(str);\n  } else {\n    d = strchr(str, ',');\n    if (d != NULL) {\n      *d = '.';\n      result2 = atof(str);\n    }\n  }\n  if (result2 > result1) return result2;\n  return result1;\n}\n\nit seems all work fine.\n\nProbably, httpd-2.0 is also affected.", "id": 32228, "time": "2003-03-01T19:43:01Z", "creator": "maxime@maxime.net.ru", "creation_time": "2003-03-01T19:43:01Z", "is_private": false}, {"count": 1, "tags": [], "creator": "nd@perlig.de", "text": "I'm not sure whether I fully understand your report.\nWhy should we parse wrong numbers with commas in it?\n\n...err, I think, I start to understand. The atof function is dependent on some\nlocale settings?", "id": 32725, "time": "2003-03-08T18:16:26Z", "bug_id": 17564, "creation_time": "2003-03-08T18:16:26Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 17564, "attachment_id": null, "text": "In some locales (include russian), comma is used as decimal point separator.\nThus atof function under such locales is false to parse right variant weight\nwith dot as desimal point separator.", "id": 32726, "time": "2003-03-08T18:43:40Z", "creator": "maxime@maxime.net.ru", "creation_time": "2003-03-08T18:43:40Z", "is_private": false}, {"count": 3, "tags": [], "creator": "nd@perlig.de", "attachment_id": null, "id": 32903, "time": "2003-03-11T00:28:25Z", "bug_id": 17564, "creation_time": "2003-03-11T00:28:25Z", "is_private": false, "text": "Well, I've fixed the problem by dropping atof() entirely (and writing our own\nmore RFC compliant version).\nThe fix currently applies to version 2.1 (main dev branch) and is proposed for\nbackport.\n\nThanks for your report and thanks for using Apache!"}, {"count": 4, "tags": [], "bug_id": 17564, "attachment_id": null, "text": "*** Bug 9427 has been marked as a duplicate of this bug. ***", "id": 37101, "time": "2003-05-13T00:55:21Z", "creator": "nd@perlig.de", "creation_time": "2003-05-13T00:55:21Z", "is_private": false}, {"count": 5, "tags": [], "text": "Sounds fixed to me.", "attachment_id": null, "bug_id": 17564, "id": 37751, "time": "2003-05-24T18:06:35Z", "creator": "slive@apache.org", "creation_time": "2003-05-24T18:06:35Z", "is_private": false}]