[{"count": 0, "tags": [], "bug_id": 56785, "text": "Hello,\n\nwe go the following exception in Aplicaiton startup. \n\njava.lang.NullPointerException\n        at org.apache.catalina.startup.ContextConfig.processAnnotationsFile(ContextConfig.java:1966)\n        at org.apache.catalina.startup.ContextConfig.processAnnotationsFile(ContextConfig.java:1967)\n        at org.apache.catalina.startup.ContextConfig.processAnnotationsUrl(ContextConfig.java:1920)\n        at org.apache.catalina.startup.ContextConfig.processAnnotations(ContextConfig.java:1878)\n        at org.apache.catalina.startup.ContextConfig.webConfig(ContextConfig.java:1146)\n        at org.apache.catalina.startup.ContextConfig.configureStart(ContextConfig.java:768)\n        at org.apache.catalina.startup.ContextConfig.lifecycleEvent(ContextConfig.java:303)\n        at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:117)\n        at org.apache.catalina.util.LifecycleBase.fireLifecycleEvent(LifecycleBase.java:90)\n        at org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:5069)\n        at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:150)\n        ... 6 more\n\nThe reason was that we added -Duser.dir=<customDir> to give Tomcat a uniqe working dir. Within our <customDir> there was a directory which was not accessible for the tomcat user. It belongs to root and no one else has access. So tomcat tries to scan the user.dir and tries to list files within the restricted dir. \n\nDoing so ths file.listFiles() command retuns null (instead of a list of files) which is not correctly handled and causing this Nullpointer and preventing the Server from startup.\n\nto recrate set -Duser.dir in setenv.sh to /tmp, create a folder /tmp/test, give permission 700 to /tmp/test, chwon root:root /tmp/test and start a tomcat with at least one application and a user other than root.\n\nThe fix would be to correctly handle nullpointers or to simply write a meningfull log message. \n\nKind regards \nJuergen Sussner", "id": 176742, "time": "2014-07-29T08:22:52Z", "creator": "Juergen.Sussner@gmail.com", "creation_time": "2014-07-29T08:22:52Z", "is_private": false, "attachment_id": null}, {"count": 1, "attachment_id": null, "bug_id": 56785, "is_private": false, "id": 176779, "time": "2014-07-30T19:28:47Z", "creator": "chris@christopherschultz.net", "creation_time": "2014-07-30T19:28:47Z", "tags": [], "text": "So, ultimately, this is a permissions problem: File.isDirectory returns 'true' but then File.list() fails, which returns null. We can't get any information about the error without probing the File object further.\n\nIt should be easy to test for this."}, {"count": 2, "tags": [], "bug_id": 56785, "attachment_id": null, "text": "(In reply to Juergen Sussner from comment #0)\n> to recrate set -Duser.dir in setenv.sh to /tmp, create a folder /tmp/test,\n> give permission 700 to /tmp/test, chwon root:root /tmp/test and start a\n> tomcat with at least one application and a user other than root.\n\nI was unable to reproduce this issue:\n\nCATALINA_OPTS is -Duser.dir=/tmp -Xms63M -Xmx192M -XX:+UseCompressedOops -Djava.awt.headless=true\n\n$ ls -ld /tmp/foo\ndrwx------  2 root  wheel  68 Jul 30 15:35 /tmp/foo\n\nI'm not running Tomcat as root. I'm using current trunk.\n\nI don't doubt there is a potential bug here, and it's somewhat easily fixed, but I can't reproduce the problem to begin with so I won't be able to verify the fix.\n\nI have set metadata-complete=\"false\" and version=\"2.5\" in my web.xml document element.\n\nAm I missing anything?", "id": 176780, "time": "2014-07-30T19:41:06Z", "creator": "chris@christopherschultz.net", "creation_time": "2014-07-30T19:41:06Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 56785, "text": "Hello,\n\nYou are right, a standart tomcat did not seem to have this issue, it somehow depends on the applicaitons we had installed. Sorry my fault. i'll try to investigate. \n\nThere has to be some sort of application setup / setting that triggers this ContextConfig.processAnnotations. \n\nAnnyway. i didt a short test programm to show where the nullpointer came from:\n\nimport java.io.File;\n\n\npublic class FilePermissionCheck {\n\t\n\tpublic static void main(String[] args) {\n\t\tif (args.length != 1) {\n\t\t\tSystem.out.println(\"Usage: FilePermissionCheck <fileNameWithPath>\");\n\t\t\tSystem.exit(-1);\n\t\t}\n\t\t\n\t\tString fileName = args[0];\n\t\t\n\t\tFile f = new File(fileName);\n\t\t\n\t\tSystem.out.println(\"isDirectory() = \" + f.isDirectory());\n\t\tSystem.out.println(\"canRead() = \" + f.canRead());\n\t\tSystem.out.println(\"canWrite() = \" + f.canWrite());\n\t\tSystem.out.println(\"canExecute() = \" + f.canExecute());\n\t\tSystem.out.println(\"listFiles() = \" + f.listFiles());\n\t\n\t\t\n\t}\n\n}\n\ndoing so on a SLES10 system results in the following:\n\n## /tmp/user.dir> ls -la\ntotal 24\ndrwxr-xr-x  3 suweb users  4096 Jul 31 07:27 .\ndrwxrwxrwt 37 root  root  12288 Jul 31 07:35 ..\n-rw-r--r--  1 suweb users  1350 Jul 31 07:27 FilePermissionCheck.class\ndrwx------  2 root  root   4096 Jul 31 06:58 root\n\n## /tmp/user.dir> id\nuid=55052(suweb) gid=100(users) groups=100(users),1001(web)\n\n## /tmp/user.dir> java -version\njava version \"1.7.0\"\nJava(TM) SE Runtime Environment (build pxa6470sr6fp1-20140108_01(SR6 FP1))\nIBM J9 VM (build 2.6, JRE 1.7.0 Linux amd64-64 Compressed References 20140106_181350 (JIT enabled, AOT enabled)\nJ9VM - R26_Java726_SR6_20140106_1601_B181350\nJIT  - r11.b05_20131003_47443.02\nGC   - R26_Java726_SR6_20140106_1601_B181350_CMPRSS\nJ9CL - 20140106_181350)\nJCL - 20140103_01 based on Oracle 7u51-b11\n\n## /tmp/user.dir> java FilePermissionCheck .\nisDirectory() = true\ncanRead() = true\ncanWrite() = true\ncanExecute() = true\nlistFiles() = [Ljava.io.File;@22cf6604\n\n## /tmp/user.dir> java FilePermissionCheck root\nisDirectory() = true\ncanRead() = false\ncanWrite() = false\ncanExecute() = false\nlistFiles() = null", "id": 176789, "time": "2014-07-31T05:38:51Z", "creator": "Juergen.Sussner@gmail.com", "creation_time": "2014-07-31T05:38:51Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 56785, "attachment_id": null, "id": 176814, "time": "2014-07-31T17:47:06Z", "creator": "chris@christopherschultz.net", "creation_time": "2014-07-31T17:47:06Z", "is_private": false, "text": "Oh, I can certainly see the possibility for a problem. I was just homing to be able to verify that I had fixed it properly rather than just assuming I had done it properly.\n\nWould you be willing to build Tomcat from source with a patch I provide, or I could provide a replacement .class file for ContextConfig that you could try. I'd like at least /someone/ to verify a fix before I commit one."}, {"count": 5, "tags": [], "text": "(In reply to Christopher Schultz from comment #2)\n(In reply to Juergen Sussner from comment #0)\n\n1) -Duser.dir=/tmp is a wrong way to set that property. The correct way is to perform \"cd /tmp\" when launching Tomcat.\n\n2) I guess that the issue would happen when some directory in $CATALINA_BASE/webapps/testapp/WEB-INF/classes  is not readable. The \"user.dir\" property value is irrelevant.\n\nWhy would you have an unreadable directory in such a place among your classes? Is there a valid reason for that?\n\nWhat if skipped directory contains something important, e.g. a @WebFilter?\nI think it is OK to fail fatally and refuse to start such a misconfigured application.", "attachment_id": null, "bug_id": 56785, "id": 176818, "time": "2014-07-31T23:12:41Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-07-31T23:12:41Z", "is_private": false}, {"count": 6, "tags": [], "text": "Sure, it would be great if you could provide a replacement class so i would patch the class in our tomcat having this effect to verrify the fix.\n\nI assume there are no class signature braking changes between 8.0.8 and the current trunk.\n\nSince the affected tomcat is one of my company i cant just give you the applications, but i'll try to annonymize the stuff and send it to you whe i am back in office, hopefully this could help to recreate the issue.\n\n-------------------------------\n\nThe other sing is: we migrated the config from a tomcat 6 and the property -Duser.dir was set to /tmp/ within /tmp/ the virus scanner created a only root readable directory. \n\nIt took some time and a strace and a remote debugging session to figure out what prevents the tomcat from starting as non root user, because every application, work dir and tomcat installation files belong to the tomcat user\n\nThe debugger clearly pointed out that the tomcat scanns the directory denoted by user.dir and tries to list all files, event files in this unreadable directory created by the virus scanner.\n\nAnnyhow. Even if this is a missconfiguration, it would be great if the tomcat issues a meaningfull error message and not just a nullpointer, leving no clue where to look for the issue.\n\nKind regards \nJuergen Sussner", "attachment_id": null, "bug_id": 56785, "id": 176834, "time": "2014-08-01T20:43:37Z", "creator": "Juergen.Sussner@gmail.com", "creation_time": "2014-08-01T20:43:37Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 56785, "text": "(In reply to Konstantin Kolinko from comment #5)\n> (In reply to Christopher Schultz from comment #2)\n> (In reply to Juergen Sussner from comment #0)\n> \n> 1) -Duser.dir=/tmp is a wrong way to set that property. The correct way is\n> to perform \"cd /tmp\" when launching Tomcat.\n> \n> 2) I guess that the issue would happen when some directory in\n> $CATALINA_BASE/webapps/testapp/WEB-INF/classes  is not readable. The\n> \"user.dir\" property value is irrelevant.\n> \n> Why would you have an unreadable directory in such a place among your\n> classes? Is there a valid reason for that?\n> \n> What if skipped directory contains something important, e.g. a @WebFilter?\n> I think it is OK to fail fatally and refuse to start such a misconfigured\n> application.\n\nA fatal exception is okay, but right now it's a NPE. I was going to change it to an IOException with a nice error message. Same behavior: just a nicer error message (and it will actually tell you the problem).", "id": 176839, "time": "2014-08-01T22:30:32Z", "creator": "chris@christopherschultz.net", "creation_time": "2014-08-01T22:30:32Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 56785, "text": "A non-readable directory in WEB-INF/classes won't trigger this but a non-readable directory elsewhere on the classpath with <JarScanner scanAllDirectories=\"true\" /> will.\n\nIncluding user.dir on the class path is unusual. You might want to look into why that is necessary.\n\nI'm looking at possible patches for this now.", "id": 176919, "time": "2014-08-05T12:27:45Z", "creator": "markt@apache.org", "creation_time": "2014-08-05T12:27:45Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "text": "For consistency with how this is handled in WEB-INF/classes, unreadable directories will simply be ignored.", "is_private": false, "id": 176922, "creator": "markt@apache.org", "time": "2014-08-05T12:57:00Z", "bug_id": 56785, "creation_time": "2014-08-05T12:57:00Z", "attachment_id": null}, {"count": 10, "tags": [], "text": "The fix is in Tomcat 8.0.11 onwards.\n\nFixed in Tomcat 7 (r1725170) and will be in 7.0.68 onwards.", "is_private": false, "id": 187782, "creator": "knst.kolinko@gmail.com", "time": "2016-01-18T03:34:52Z", "bug_id": 56785, "creation_time": "2016-01-18T03:34:52Z", "attachment_id": null}]