[{"count": 0, "tags": [], "creator": "glindholm@yahoo.com", "attachment_id": null, "is_private": false, "id": 186894, "time": "2015-12-11T15:12:24Z", "bug_id": 58721, "creation_time": "2015-12-11T15:12:24Z", "text": "Recently switched to Tomcat 8.0.28 and Http11Nio2Protocol and after a week the service failed with java.net.SocketException: \"Too many open files\".\n\nAfter restarting the server I monitored the open files and saw the TCP connections grow and grow:\n\n# lsof -u tomcat -a -i TCP\n\nAfter the restart there were 10-20 open files, the list changing rapidly.\nAfter one day there were 250+ open files, most were unchanging.\nThe keep alive timeout is set to 10 seconds, they should have all been closed within those 10 seconds.\n\nI switched back to Http11NioProtocol and after two days there are no hanging open files, every time i check I see 10-20 open files and they get closed and new ones opened.\n\n\nHere was the Connector setting:\n\n<Connector port=\"443\" protocol=\"org.apache.coyote.http11.Http11Nio2Protocol\"\n               connectionTimeout=\"20000\"\n               keepAliveTimeout=\"10000\"\n               scheme=\"https\" secure=\"true\"\n\t       SSLEnabled=\"true\" sslProtocol=\"TLS\" sslEnabledProtocols=\"TLSv1.2,TLSv1.1,TLSv1\"\n               keystoreFile=\"${catalina.base}/conf/productcodes.keystore\"\n               keystorePass=\"xxx\" \n\t       keyAlias=\"tomcat\" \n\t       keyPass=\"xxx\"\n\t       useServerCipherSuitesOrder=\"true\"\nciphers=\"TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384,\nTLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384,\nTLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA384,\nTLS_ECDH_RSA_WITH_AES_256_CBC_SHA384,\nTLS_DHE_DSS_WITH_AES_256_CBC_SHA256,\nTLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA,\nTLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,\n..."}, {"count": 1, "tags": [], "bug_id": 58721, "attachment_id": null, "id": 187710, "time": "2016-01-15T14:31:10Z", "creator": "remm@apache.org", "creation_time": "2016-01-15T14:31:10Z", "is_private": false, "text": "More information is needed on the scenario leading to the leak, since \"normal\" resource processing doesn't cause it. Without these details, the issue will be resolved as INVALID."}, {"count": 2, "tags": [], "text": "Some additional information:\n\nWhen I switch to Http11Nio2Protocol the problem only occurred on a service that was not behind a load balancer.\n\nWe are running on AWS and most of the services are behind load balancers. For these services all of the requests are coming from the 2 IP addresses of the 2 machines that form the load balancer. \n\nThe service that had the problem was not behind a load balancer and was receiving requests from thousands of external addresses.  \n\nWhat additional information would be helpful?\n\nThe problem is reproduce-able, if I switch it back to Http11Nio2Protocol then the open file list starts growing within a couple hours. The service gets several thousand requests per day.", "attachment_id": null, "id": 187803, "creation_time": "2016-01-18T15:39:32Z", "time": "2016-01-18T15:39:32Z", "creator": "glindholm@yahoo.com", "bug_id": 58721, "is_private": false}, {"count": 3, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "id": 187807, "time": "2016-01-18T17:08:50Z", "bug_id": 58721, "creation_time": "2016-01-18T17:08:50Z", "is_private": false, "text": "This sound like fairly generic use where a server processes requests.\nWhat we need is some kind of scenario that would lead to a socket (or file ?) not being closed. If I use NIO2 SSL and do some requests, I fail to see any resource leaks."}, {"count": 4, "tags": [], "bug_id": 58721, "is_private": false, "text": "Since apparently you don't have additional reproduction information on this, it could be worthwhile to test 9 M3.", "id": 188604, "time": "2016-02-19T11:40:03Z", "creator": "remm@apache.org", "creation_time": "2016-02-19T11:40:03Z", "attachment_id": null}, {"count": 5, "tags": [], "text": "8.5.0 can be used to retest this as well.", "is_private": false, "bug_id": 58721, "id": 189758, "time": "2016-03-28T13:38:00Z", "creator": "remm@apache.org", "creation_time": "2016-03-28T13:38:00Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 58721, "is_private": false, "count": 6, "id": 190603, "time": "2016-04-27T14:56:02Z", "creator": "remm@apache.org", "creation_time": "2016-04-27T14:56:02Z", "text": "Last call before closing this."}, {"count": 7, "tags": [], "bug_id": 58721, "attachment_id": null, "text": "This should be retested with 8.5, at least.", "id": 191681, "time": "2016-06-15T14:18:35Z", "creator": "remm@apache.org", "creation_time": "2016-06-15T14:18:35Z", "is_private": false}]