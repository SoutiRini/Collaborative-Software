[{"count": 0, "tags": [], "bug_id": 53831, "attachment_id": null, "is_private": false, "id": 161966, "time": "2012-09-05T14:10:14Z", "creator": "hashar@free.fr", "creation_time": "2012-09-05T14:10:14Z", "text": "In the ant 1.8.2 build system, I am having a javascript that rely on an <antcall/>. That causes me a java.lang.NullPointerException which points to antcall.\n\n<project default=\"main\">\n    <target name=\"main\">\n        <script language=\"javascript\"> <![CDATA[\n        task = project.createTask( 'macro' );\n        task.execute();\n        ]]></script>\n    </target>\n\n    <macrodef name=\"macro\">\n        <sequential>\n            <antcall target=\"antcall\" />\n        </sequential>\n    </macrodef>\n\n    <target name=\"antcall\">\n        <echo>[antcall] succeed</echo>\n    </target>\n\n</project>\n\n\nbuild.xml:11: java.lang.NullPointerException( #3 ... ). The stacktrace just talk about RhinoScriptEngine, not sure that is any helpful\n\n\n\nat com.sun.script.javascript.RhinoScriptEngine.eval(RhinoScriptEngine.java:153)\nat com.sun.script.javascript.RhinoScriptEngine.eval(RhinoScriptEngine.java:167)\nat javax.script.AbstractScriptEngine.eval(AbstractScriptEngine.java:247)\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\nat java.lang.reflect.Method.invoke(Method.java:597)\nat org.apache.tools.ant.util.ReflectUtil.invoke(ReflectUtil.java:108)\nat org.apache.tools.ant.util.ReflectWrapper.invoke(ReflectWrapper.java:81)\nat org.apache.tools.ant.util.optional.JavaxScriptRunner.evaluateScript(JavaxScriptRunner.java:103)\nat org.apache.tools.ant.util.optional.JavaxScriptRunner.executeScript(JavaxScriptRunner.java:67)\nat org.apache.tools.ant.taskdefs.optional.Script.execute(Script.java:52)\nat org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:291)\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\nat java.lang.reflect.Method.invoke(Method.java:597)\nat org.apache.tools.ant.dispatch.DispatchUtils.execute(DispatchUtils.java:106)\nat org.apache.tools.ant.Task.perform(Task.java:348)\nat org.apache.tools.ant.Target.execute(Target.java:390)\nat org.apache.tools.ant.Target.performTasks(Target.java:411)\nat org.apache.tools.ant.Project.executeSortedTargets(Project.java:1399)\nat org.apache.tools.ant.Project.executeTarget(Project.java:1368)\nat org.apache.tools.ant.helper.DefaultExecutor.executeTargets(DefaultExecutor.java:41)\nat org.apache.tools.ant.Project.executeTargets(Project.java:1251)\nat org.apache.tools.ant.Main.runBuild(Main.java:809)\nat org.apache.tools.ant.Main.startAnt(Main.java:217)\nat org.apache.tools.ant.launch.Launcher.run(Launcher.java:280)\nat org.apache.tools.ant.launch.Launcher.main(Launcher.java:109)"}, {"count": 1, "tags": [], "creator": "hashar@free.fr", "attachment_id": null, "text": "I found a bug report in Groovy detailing a similar issue http://jira.codehaus.org/browse/GROOVY-1506 . The attached patch by Andreas Sahlbach fixed the groovy issue by assigning an owner to a newly created task.\n\nSo I have gone ahead and added:\n\ntask.setOwningTarget( self.getOwningTarget() );\nThat fixed the issue. I have put the original script and the fixed one in gist 3636007 so other people can play with.\n\n\nFinal script is below:\n\n<project default=\"main\">\n    <target name=\"main\">\n        <script language=\"javascript\"> <![CDATA[\n        task = project.createTask( 'macro' );\n\n        if( task.getOwningTarget() == null ) {\n            task.log( \"Assigning an owner ...\" );\n            task.setOwningTarget( self.getOwningTarget() );\n            task.log( \"Task:  \" + task.getOwningTarget() );\n        }\n\n        try {\n            task.execute();\n        } catch(err) {\n            task.log( \"Execution error: \" + err.message );\n        }\n\n        ]]></script>\n    </target>\n\n    <macrodef name=\"macro\">\n        <sequential>\n            <antcall target=\"antcall\" />\n        </sequential>\n    </macrodef>\n\n    <target name=\"antcall\">\n        <echo>[antcall] succeed</echo>\n    </target>\n\n</project>\nThe resulting execution is:\n\n$ ant\nBuildfile: /Users/amusso/ant/bug/build.xml\n\nmain:\n    [macro] Assigning an owner ...\n    [macro] Task:  main\n\nantcall:\n     [echo] [antcall] succeed\n\nBUILD SUCCESSFUL\nTotal time: 0 seconds\n\\O/", "id": 161967, "time": "2012-09-05T14:10:43Z", "bug_id": 53831, "creation_time": "2012-09-05T14:10:43Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 53831, "is_private": false, "text": "See also:\n http://stackoverflow.com/questions/12280295\n\nSource code:\n https://gist.github.com/3636007\n\nTo clone the build script:\n git clone git://gist.github.com/3636007.git bug53831\n\n git checkout 9e686eb # failing build.xml\n git checkout 3bb9964 # working file", "id": 161968, "time": "2012-09-05T14:12:42Z", "creator": "hashar@free.fr", "creation_time": "2012-09-05T14:12:42Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 53831, "attachment_id": 29334, "is_private": false, "id": 161969, "time": "2012-09-05T14:13:25Z", "creator": "hashar@free.fr", "creation_time": "2012-09-05T14:13:25Z", "text": "Created attachment 29334\nworking build file"}, {"count": 4, "tags": [], "bug_id": 53831, "attachment_id": 29335, "is_private": false, "id": 161970, "time": "2012-09-05T14:14:07Z", "creator": "hashar@free.fr", "creation_time": "2012-09-05T14:14:07Z", "text": "Created attachment 29335\nfailing build file"}]