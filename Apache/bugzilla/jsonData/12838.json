[{"count": 0, "tags": [], "creator": "gjfdh@yahoo.com", "is_private": false, "id": 23129, "creation_time": "2002-09-19T23:26:56Z", "time": "2002-09-19T23:26:56Z", "bug_id": 12838, "text": "To get right to the point...\n\nsetupDirectoryScanner(FileScanner ds, Project p) in AbstractFileSet.java does \nnot dereference referenced file sets.  If you set up a scanner against a \nfileset that is referenced (refid=xxx), the scanner is actually set against \nthe \"pointer\" fileset which has no include or exclude patterns.  This means  \nthe scanner will scan everything.\n\nIn my case I was using referenced file sets within an FTP-delete command, and \nevery file in and below the CWD was being deleted -- rather than just the few \nfiles I asked for. :-(\n\nFor example, suppose we have this build.xml file:\n\n<?xml version=\"1.0\"?>\n<project default=\"test\">\n    <target name=\"test\">\n        <fileset dir=\"/tmp\" id=\"myset\">\n            <include name=\"foo\"/>\n        </fileset>\n\n        <ftp\n            action=\"list\"\n            server=\"${ftp.server}\"\n            userid=\"${ftp.userid}\"\n            password=\"${ftp.password}\" \n            remotedir=\"/tmp\"\n            verbose=\"yes\"\n            listing=\"xxx.txt\"\n        >\n            <fileset refid=\"myset\"/>\n        </ftp>\n    </target>\n</project>\n\nThis build should list \"/tmp/foo\" on the ftp server.  But with the bug, because \nthe nested fileset is a reference, the <ftp> task instead lists the entire \ncontents of the /tmp directory, recursively.  In the debugging message below, \nyou can see that the pattern set is empty.  It does not contain a name \nrestriction.\n\n\ntest2:\nAdding reference: myset -> org.apache.tools.ant.types.FileSet@35746070\n      [ftp] Opening FTP connection to xxx.xxx.xxx.xxx\n      [ftp] connected\n      [ftp] logging in to FTP server\n      [ftp] login succeeded\n      [ftp] changing the remote directory\n      [ftp] listing files\nfileset: Setup scanner in dir null with patternSet{ includes: [] excludes: [] }\n      [ftp] listing .X0-lock\n      [ftp] listing .X11-unix\\X0\n      [ftp] listing .font-unix\\fs7100\n      [ftp] listing bar\n      [ftp] listing foo\n      [ftp] 5 files listed\n      [ftp] disconnecting\n\n\n\nI fixed the bug on my system so that \"myset\" is properly deferenced.  Now the \npattern set is found and <ftp> does the right thing:\n\n\ntest2:\nAdding reference: myset -> org.apache.tools.ant.types.FileSet@353ca1f2\n      [ftp] Opening FTP connection to xxx.xxx.xxx.xxx\n      [ftp] connected\n      [ftp] logging in to FTP server\n      [ftp] login succeeded\n      [ftp] changing the remote directory\n      [ftp] listing files\nfileset: Setup scanner in dir \\tmp with patternSet{ includes: [foo] excludes: \n[] }\n      [ftp] listing foo\n      [ftp] 1 files listed\n      [ftp] disconnecting\n\n\n\n\nProposed Fix:\n\nIn AbstractFileSet.java, wrap the setupDirectoryScanner method logic within an \nif-then-else block.  Recurse over references.\n\n    public void setupDirectoryScanner(FileScanner ds, Project p) {\n        if (ds == null) {\n            throw new IllegalArgumentException(\"ds cannot be null\");\n        }\n\n        // *** This if-statement is new ***\n\tif (isReference()) {\n\t\tgetRef(p).setupDirectoryScanner(ds, p);\n\t} else {\n\t\tds.setBasedir(dir);\n\t\tfinal int count = additionalPatterns.size();\n\t\tfor (int i = 0; i < count; i++) {\n\t\t    Object o = additionalPatterns.elementAt(i);\n\t\t    defaultPatterns.append((PatternSet) o, p);\n\t\t}\n\n\t\tp.log(getDataTypeName() + \": Setup scanner in dir \" + dir +\n\t\t    \" with \" + defaultPatterns, Project.MSG_DEBUG);\n\n\t\tds.setIncludes(defaultPatterns.getIncludePatterns(p));\n\t\tds.setExcludes(defaultPatterns.getExcludePatterns(p));\n\t\tif (ds instanceof SelectorScanner) {\n\t\t    SelectorScanner ss = (SelectorScanner)ds;\n\t\t    ss.setSelectors(getSelectors(p));\n\t\t}\n\n\t\tif (useDefaultExcludes) {\n\t\t    ds.addDefaultExcludes();\n\t\t}\n\t        ds.setCaseSensitive(isCaseSensitive);\n\t}\n    }", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 12838, "text": "Thanks, this report has also uncovered a few other cases where AbstractFileset\nshould check for references.", "count": 1, "id": 23242, "time": "2002-09-23T11:29:30Z", "creator": "bodewig@apache.org", "creation_time": "2002-09-23T11:29:30Z", "is_private": false}]