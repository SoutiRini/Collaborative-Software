[{"count": 0, "tags": [], "bug_id": 50858, "attachment_id": null, "text": "This is possibly redundant with bug #46221, however, different classes and libraries appear to be involved, so I am submitting this anyways.\n\nI have implemented a trivial \"Hello World\" Web Application, which invokes \n\"LogManager.getLogger(HelloServlet.class)\". Demonstrating the classloader leak is a little cumbersome, I apologize, but here are the steps:\n  1. Deploy the attached \"simple.war\" to the web container of your choice (I used Tomcat v6.0.29)\n  2. Navigate to http://localhost:8080/simple; you should see a \"Hello, world!\" message. A warning will also be logged that log4j was not instantiated properly.\n  3. Undeploy \"simple.war\".\n  4. Using jps/jmap/jhat, view the heap dump of your web container. View references to the WebAppClassLoader, excluding weak references. You will see that the WebAppClassLoader still has static references from about a dozen Log4j classes, such as org.apache.log4j.Category and org.apache.log4j.Priority.ERROR.\n\nI also implemented a ServletContextListener to call LogManager.shutDown() and Introspector.flushCaches(), following advice from http://marc.info/?l=log4j-user&m=109585865720819. This didn't solve the problem. The only way I could resolve the ClassLoader leak was to remove all references to LogManager.", "id": 144687, "time": "2011-03-02T18:54:22Z", "creator": "piepera@pragmatics.com", "creation_time": "2011-03-02T18:54:22Z", "is_private": false}, {"count": 1, "tags": [], "creator": "piepera@pragmatics.com", "text": "Created attachment 26722\nA war file which demonstrates the ClassLoader leak", "id": 144688, "time": "2011-03-02T18:56:18Z", "bug_id": 50858, "creation_time": "2011-03-02T18:56:18Z", "is_private": false, "attachment_id": 26722}, {"count": 2, "tags": [], "bug_id": 50858, "is_private": false, "text": "Created attachment 26723\nA project for building the sample war file, using maven.\n\nThis maven project includes a pom.xml, web.xml, and some java source files. You should be able to build it with \"mvn clean install\".", "id": 144689, "time": "2011-03-02T18:57:43Z", "creator": "piepera@pragmatics.com", "creation_time": "2011-03-02T18:57:43Z", "attachment_id": 26723}, {"count": 3, "tags": [], "creator": "piepera@pragmatics.com", "attachment_id": 26724, "id": 144690, "time": "2011-03-02T19:00:22Z", "bug_id": 50858, "creation_time": "2011-03-02T19:00:22Z", "is_private": false, "text": "Created attachment 26724\nThe html output from jhat, showing the rootset references from log4j to the WebappClassLoader."}, {"count": 4, "tags": [], "creator": "s.franke@bebbosoft.de", "text": "It seems that there is a ThreadLocal reference the WAR/EAR class loader, unload will only occur, if the thread releases the thread local resources or dies:\n\n--> java.lang.reflect.Method@0x31054290 (77 bytes) (field returnType:)\n--> class com.sun.xml.bind.v2.schemagen.xmlschema.ComplexType (84 bytes) (??:)\n--> org.apache.felix.framework.ModuleImpl$ModuleClassLoaderJava5@0x2ec33a28 (70 bytes) (field parent:)\n--> java.net.URLClassLoader@0x2a206438 (62 bytes) (field classes:)\n--> java.util.Vector@0x2a1ea138 (24 bytes) (field elementData:)\n--> [Ljava.lang.Object;@0x304386c0 (1288 bytes) (Element 59 of [Ljava.lang.Object;@0x304386c0:)\n--> class org.apache.felix.framework.util.EventDispatcher (84 bytes) (static field m_thread:)\n--> java.lang.Thread@0x2a208840 (108 bytes) (field group:)\n--> java.lang.ThreadGroup@0x2a16f8d8 (43 bytes) (field groups:)\n--> [Ljava.lang.ThreadGroup;@0x2b2cc2d0 (40 bytes) (Element 2 of [Ljava.lang.ThreadGroup;@0x2b2cc2d0:)\n--> java.lang.ThreadGroup@0x2b326060 (43 bytes) (field threads:)\n--> [Ljava.lang.Thread;@0x313d5b00 (136 bytes) (Element 5 of [Ljava.lang.Thread;@0x313d5b00:)\n--> com.sun.grizzly.http.HttpWorkerThread@0x31323718 (156 bytes) (field threadLocals:)\n--> java.lang.ThreadLocal$ThreadLocalMap@0x31332de0 (20 bytes) (field table:)\n--> [Ljava.lang.ThreadLocal$ThreadLocalMap$Entry;@0x334e6c98 (16392 bytes) (Element 2010 of [Ljava.lang.ThreadLocal$ThreadLocalMap$Entry;@0x334e6c98:)\n--> java.lang.ThreadLocal$ThreadLocalMap$Entry@0x332826c0 (28 bytes) (field value:)\n--> com.sun.corba.ee.spi.orbutil.codegen.Wrapper$Environment@0x33283d10 (24 bytes) (field root:)\n--> com.sun.corba.ee.impl.orbutil.codegen.ClassGeneratorImpl@0x33215020 (71 bytes) (field methods:)\n--> java.util.ArrayList@0x33223a30 (20 bytes) (field elementData:)\n--> [Ljava.lang.Object;@0x330e9480 (240 bytes) (Element 35 of [Ljava.lang.Object;@0x330e9480:)\n--> com.sun.corba.ee.impl.orbutil.codegen.MethodGenerator@0x3323cd20 (53 bytes) (field rtype:)\n--> com.sun.corba.ee.spi.orbutil.codegen.Type@0x33217db8 (49 bytes) (field typeClass:)\n--> class foo.bar.XYDTO (84 bytes) (??:)\n--> org.glassfish.javaee.full.deployment.EarClassLoader@0x3295df18 (92 bytes) (field classes:)", "id": 148039, "time": "2011-07-20T16:05:25Z", "bug_id": 50858, "creation_time": "2011-07-20T16:05:25Z", "is_private": false, "attachment_id": null}]