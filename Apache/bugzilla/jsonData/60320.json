[{"count": 0, "tags": [], "bug_id": 60320, "is_private": false, "id": 194711, "creation_time": "2016-10-28T22:04:51Z", "time": "2016-10-28T22:04:51Z", "creator": "fanningpj@yahoo.com", "text": "Created attachment 34408\npassword protected xlsx\n\nI will attach TestThisEncryption.xlsx. The password is: Test001!!\nThis opens ok in Excel but Poi fails to decrypt it using the password.\nIt seems to happen if the xlsx is created in one Excel version and then later password protected with a recent version of Excel on Windows.\nIf anyone has any insight into why this workbook won't decrypt in Poi 3.15 that would be appreciated.\n\nThis is the decryptor check that fails for me:\n\n  def checkPassword(fileName: String, password: String) {\n    val fs = new POIFSFileSystem(new FileInputStream(fileName))\n    val info = new EncryptionInfo(fs)\n    val decryptor = Decryptor.getInstance(info)\n    println(s\"$fileName password works? ${decryptor.verifyPassword(password)}\")\n  }", "attachment_id": 34408}, {"count": 1, "tags": [], "creator": "kiwiwings@apache.org", "attachment_id": null, "id": 194714, "time": "2016-10-28T22:15:30Z", "bug_id": 60320, "creation_time": "2016-10-28T22:15:30Z", "is_private": false, "text": "the file also can't be opened via Libre Office 5 ... is the password wrong?"}, {"count": 2, "tags": [], "creator": "fanningpj@yahoo.com", "attachment_id": null, "is_private": false, "id": 194715, "time": "2016-10-28T22:21:48Z", "bug_id": 60320, "creation_time": "2016-10-28T22:21:48Z", "text": "Thanks Andreas for checking. The xlsx opens for in Excel 2016 on Mac. The xlsx itself was created by a colleague using a Windows install of Excel."}, {"count": 3, "tags": [], "bug_id": 60320, "is_private": false, "id": 194716, "creation_time": "2016-10-28T22:27:56Z", "time": "2016-10-28T22:27:56Z", "creator": "kiwiwings@apache.org", "text": "hm .. the cipher of the header (aes128) doesn't match the cipher of the verifier (aes256) ...", "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 60320, "attachment_id": null, "is_private": false, "id": 194718, "time": "2016-10-29T00:11:49Z", "creator": "onealj@apache.org", "creation_time": "2016-10-29T00:11:49Z", "text": "I am able to open the workbook with \"Test001!!\" in Excel 2013 on Windows 7."}, {"count": 5, "tags": [], "bug_id": 60320, "attachment_id": null, "text": "Up till now the implementation used the cipher and hashes of the header and verifier interchangeably, as they were always the same in the test files.\nSo I guess, now we need to use the verifier data (keydata element) for validating the key, and the header data for en-/decryption.\nI'll play around with it ...\n(and it looks like Libre Office made the same mistake ...)", "id": 194721, "time": "2016-10-29T08:15:25Z", "creator": "kiwiwings@apache.org", "creation_time": "2016-10-29T08:15:25Z", "is_private": false}, {"count": 6, "tags": [], "creator": "kiwiwings@apache.org", "attachment_id": 34410, "is_private": false, "id": 194726, "time": "2016-10-29T21:28:12Z", "bug_id": 60320, "creation_time": "2016-10-29T21:28:12Z", "text": "Created attachment 34410\npreliminary patch for decrypting\n\nThis is a preliminary patch for decrypting. Currently encryption doesn't work. When both work, I'll add another customized encryption test, to produce a similar file as the original failing one ..."}, {"count": 7, "tags": [], "bug_id": 60320, "is_private": false, "id": 194750, "creation_time": "2016-11-01T01:34:37Z", "time": "2016-11-01T01:34:37Z", "creator": "kiwiwings@apache.org", "text": "Thank you for providing the test file - patch applied via r1767399\n\nI guess this won't be the last issue around encryption, as the agile encryption leaves a few more possibilities open on what to go wrong next :|", "attachment_id": null}]