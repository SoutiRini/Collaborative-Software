[{"count": 0, "tags": [], "creator": "altumano@gmail.com", "attachment_id": null, "id": 135419, "creation_time": "2010-03-18T10:22:10Z", "time": "2010-03-18T10:22:10Z", "bug_id": 48933, "text": "I'm chasing a strange problem with Tomcat + SSL + APR + Firefox.\n\nNamely, the setup works perfectly (i.e. the client certificate is sent and the servlet application can get it).\nBut if I allow the SSL connection to time out (it happens 1 minute after the last request), the servlet application does not get the client certificate anymore.\n\nThe workaround (for user) is to clear Firefox cache (Tools - Clear Recent History - 1 hour, Active logins).\nAfter this, the application will work again until the next timeout.\n\nThis problem does NOT occur if I use pure Java SSL config (no APR) or when I use browser other that Firefox.\n\nFrom that you can imply that this might be a Firefox problem, but I'm not so sure.\nFirefox works perfectly with all other HTTPS sites and also pure Java SSL config works with Firefox.\nSo obviously this problem occurs because Tomcat libnative fails to handle some peculiarities of Firefox SSL packets.\n\nHere is my exact setup:\n- Debian 5 (Lenny)\n- libapr1 1.2.12-5+lenny1\n- openssl  0.9.8g-15+lenny6\n- Tomcat 6.0.26 with tomcat-native-1.1.20\n- server authentication certificates (newcert.pem, newkey-no-password.pem)\n- client authentication certificates (ca.pem and a personal\ncertificate client1.p12)\n- a simple servlet \"ssltest\" to get the client cert:\n      writer.println(Arrays.deepToString((X509Certificate[])\nrequest.getAttribute(\"javax.servlet.request.X509Certificate\")));\n- Firefox 3.6\n\nThe only change in server.xml is the connector conf:\n\n   <Connector port=\"8443\" SSLEnabled=\"true\"\n              maxThreads=\"150\" scheme=\"https\" secure=\"true\"\n              SSLCertificateFile=\"${user.home}/newcert.pem\"\n              SSLCertificateKeyFile=\"${user.home}/newkey-no-password.pem\"\n              SSLVerifyClient=\"require\"\n              SSLVerifyDepth=\"2\"\n              SSLCACertificateFile=\"${user.home}/ssl/ca.pem\"\n              />\n\nAnd installed ssltest.war into webapps.\n\nNow steps to reproduce:\n1) import client1.p12 into browser\n2) go to https://localhost:8443/ssltest, it will show the client certificate\n3) wait 1 minute\n4) refresh browser - the application will not get the client certificate\n (request.getAttribute(\"javax.servlet.request.X509Certificate\") returns null)", "is_private": false}, {"count": 1, "tags": [], "text": "Created attachment 25143\nCertificates (All passwords are \"changeit\")\n\nAll passwords are \"changeit\"", "attachment_id": 25143, "id": 135420, "creator": "altumano@gmail.com", "time": "2010-03-18T10:26:30Z", "bug_id": 48933, "creation_time": "2010-03-18T10:26:30Z", "is_private": false}, {"count": 2, "tags": [], "creator": "altumano@gmail.com", "attachment_id": 25144, "id": 135421, "creation_time": "2010-03-18T10:30:31Z", "time": "2010-03-18T10:30:31Z", "bug_id": 48933, "text": "Created attachment 25144\nTest application", "is_private": false}, {"count": 3, "attachment_id": 25145, "bug_id": 48933, "is_private": false, "id": 135422, "time": "2010-03-18T10:34:11Z", "creator": "altumano@gmail.com", "creation_time": "2010-03-18T10:34:11Z", "tags": [], "text": "Created attachment 25145\nTest application source"}, {"count": 4, "attachment_id": null, "bug_id": 48933, "is_private": false, "id": 135423, "time": "2010-03-18T10:39:48Z", "creator": "altumano@gmail.com", "creation_time": "2010-03-18T10:39:48Z", "tags": [], "text": "For testing, I was using ssltap:\n\nssltap -sxlp 18443 localdebian:8443\n\nThe URL will then be https://localhost:18443/ssltest\n\nFrom the ssltap log I can see that after 1 minute since the last request I get EOF:\n\nRead EOF on Server socket. [Thu Mar 18 12:15:52 2010]\nRead EOF on Client socket. [Thu Mar 18 12:16:00 2010]\n\nand after that the problem will occur."}, {"count": 5, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "At a guess you are hitting issues with SSL renegotiation and the various work-arounds put in place for CVE-2009-3555. My tests with 6.0.x (trunk), 1.1.20, openssl 0.9.8k and Firefox 3.6.3 work as expected. After 1 min I get re-prompted for my cert and everything continues to work.", "id": 137265, "time": "2010-06-01T18:10:45Z", "bug_id": 48933, "creation_time": "2010-06-01T18:10:45Z", "is_private": false}]