[{"count": 0, "tags": [], "creator": "qfox@ya.ru", "text": "Created attachment 24935\nProblem as I see in rewrite.log\n\nWe have about 100,000 customers on server and cant take them a host because host rewriting via mod_rewrite is very slow, but after VirtualDocumentRoot mod_rewrite begins redirecting and doubling directory.\n\nLog file attached.\n\n.htaccess example in directory `ff` for log understanding:\n<code>\n&lt;IfModule mod_rewrite.c&gt;\nRewriteCond %{ENV:REDIRECT_STATUS} 200|[45]0[0-9]\nRewriteRule .* - [L]\n... some simple rules ...\nRewriteRule .* /index.php [L,QSA]\n&lt;/IfModule&gt;\n</code>\n\n&lt;VirtualHost *:80&gt;\n        ServerName domain.name\n        ServerAlias *.domain.name\n\n        UseCanonicalName Off\n\n        VirtualDocumentRoot /home/www/name.domain/%-3/\n\n        RewriteEngine   on\n\n        LogFormat \"%V %h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\" vhost_combined\n        ErrorLog /var/log/apache2/vhosts/error.log\n        RewriteLog /var/log/apache2/vhosts/rewrite.log\n        CustomLog /var/log/apache2/vhosts/access.log vhost_combined\n        RewriteLogLevel 5\n&lt;/VirtualHost&gt;\n\nSo, as far as I see there is no real simple and fast solution for that. And have a very dirty miracle of apache goodness as professional web-server. ;-(\n\nI don`t think that apache is \"The one module web-server\" or you say: \"Use the fkng mod_rewrite all where you can!\"?", "id": 134276, "time": "2010-02-06T19:08:08Z", "bug_id": 48691, "creation_time": "2010-02-06T19:08:08Z", "is_private": false, "attachment_id": 24935}, {"count": 1, "tags": [], "creator": "qfox@ya.ru", "attachment_id": null, "id": 134277, "time": "2010-02-06T19:16:45Z", "bug_id": 48691, "creation_time": "2010-02-06T19:16:45Z", "is_private": false, "text": "Tell me please how I can use mod_rewrite in directories with hacks?\nMaybe with SetEnvIf or something else?"}, {"count": 2, "tags": [], "bug_id": 48691, "attachment_id": null, "text": "This bugzilla is for reporting suspected bugs in Apache HTTP Server, not a support forum for questions, configuration assistance, support, or systems analysis.\n  \nPerhaps someone on the Apache HTTP Server users list can help you determine what's going on with your system, and if this due diligence points to an Apache HTTP Server bug, reopen this ticket with a rigorous description that illustrates (via verbatim error messages, configurations, logs, packet captures, etc) the misbehavior in Apache HTTP Server. \n \nhttp://httpd.apache.org/userslist.html\n\n\n(Hint: Try RewriteBase or the DPI flag, make sure the config you provide is verbatim (doesn't seem to match the operative part of the rewritelog), and keep the hyperbole to yourself)", "id": 134281, "time": "2010-02-07T05:18:36Z", "creator": "covener@gmail.com", "creation_time": "2010-02-07T05:18:36Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 48691, "attachment_id": null, "is_private": false, "id": 134282, "time": "2010-02-07T05:25:23Z", "creator": "qfox@ya.ru", "creation_time": "2010-02-07T05:25:23Z", "text": "Nice comment. Thanks.\n\nSo if it is not an error then why mod_rewrite does not works with/without rewritebase?\n\nMod_rewrite is a part of apache http-server or I was mistaken?"}, {"count": 4, "tags": [], "creator": "qfox@ya.ru", "text": "Btw, yesterday I was understand whats really happened in rewrite by reading logs and testing.\n\nBqz after VirtualDocumentRoot directive DOCUMENT_ROOT is not really set success mod_rewrite added (wtf?) base_path to url on each iteration.\nAnd RewriteBase can`t help.\n\nBut when we rewrite via RewriteCode and Rules without VirtualDocumentRoot, RewriteBase can solve the problem. LOL. Incompatibility is all our)...\n\nfor example:\n<VirtualHost *:80>\n        ServerName users.domain.name\n        ServerAlias *.users.domain.name\n        UseCanonicalName Off\n\n        # without any document root all is crazy. VirtualDocumentRoot not set any. its idiotic directive\n        DocumentRoot /home/www/name.domain.users/\n\n        # virtuality\n        # bogus shit\n        #VirtualDocumentRoot /home/www/name.domain.users/%-4/\n        # another shit\n        RewriteCond %{IS_SUBREQ} false\n        RewriteCond %{HTTP_HOST} ^([^\\.]+(?:\\.[^\\.]+)*)\\.users\\.domain\\.name$\n        RewriteRule ^(.+) /%1$1\n\n        ErrorLog /var/log/apache2/ru.qfox.dev/error.log\n        CustomLog /var/log/apache2/ru.qfox.dev/access.log vhost_combined\n        RewriteLog /var/log/apache2/ru.qfox.dev/rewrite.log\n        RewriteLogLevel 5\n</VirtualHost>\n\nAnd RewriteBase ... in all root .htaccesses if we need to use mod_rewrite.\nBtw, why we cant rewrite DocumentRoot in .htaccess? Apache have a lot of hacks bqz backcompat, but NOT have that one (???).\n\n\nAs I see mod_vhost must have(!) real good methods/directives for virtual hosts.\nBut ITS wrong way and bogus shit.\n\nThanks for response, do any you want. Dixi.", "id": 134284, "time": "2010-02-07T05:47:09Z", "bug_id": 48691, "creation_time": "2010-02-07T05:47:09Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "creator": "covener@gmail.com", "text": "tl;dr version: relying 50% on VirtualDocumentRoot and 50% on per-directory rewrites is hard.", "id": 134285, "time": "2010-02-07T06:31:26Z", "bug_id": 48691, "creation_time": "2010-02-07T06:31:26Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 48691, "attachment_id": null, "text": "(In reply to comment #5)\n> tl;dr version: relying 50% on VirtualDocumentRoot and 50% on per-directory\n> rewrites is hard.\n\nSorry, but not for customer. It`s not intuitive.\nWhen mod_vhost_alias do their job of host virtualization, mod_rewrite do their self job to rewrites (or not) urls inside host.\n\nI understand that mod_rewrite can do both, but why we have module that is not useable at full of power? Can we rewrite mod_vhost_alias to mod_vhost_alias2, for example, which will get all of vhosting troubles to self without any other problems?\na2moddis vhost_alias if you don`t want to use mod_vhost_alias to vitrualization.\n\n\nJust for understanding why I think that is works wrong.\nWe have a lot solutions for virtualization our apache. But usually used or mod_rewrite alone, either mod_vhost_alias+mod_rewrite. mod_rewrite alone is very hard to use but, as i see, working solution. So look at the second. We can create hundreds of VirtualHost blocks, and can use VirtualDocumentRoot with exressions. What you choose? Of course, many people starts trying to use VirtualDocumentRoot. And its not working solution ;-(, but intuitive. Man searchs WHY it not works properly, found some solutions based on mod_rewrite, or tried to write conf-generators. So them spend time, because of no good solution...\nAnd in that time mod_rewrite working after \"Virutalization\" on each iteration adds to start of file-path directory. Actually it doesn`t clean it between iterations as I see bqz have no documentroot or another ground. When we define some documentroot with virtualdocumentroot it .\n\n\nBtw, one more possible solution is to add to documentroot some variables-parsing mechs like %{HTTP_HOST}, or %0, $0 (if it possible, RewriteCond can write to common variables storage some variables, and, by default, it can contains parse of http_host like in VirtualDocumentRoot. So the solution will be to type DocumentRoot and VirtualDocumentRoot in one VirtualHost block with equal param, for ex: DocumentRoot /path/%-1/%-2.0/%-2/, VirtualDocumentRoot /path/%-1/%-2.0/%-2/).\n\nBy my opinion soft must be intuitive. And creation of common mechs to send variables to any directive where them can be accessible is very right, intuitive and useable.\n\nSorry for a lot of text.", "id": 134287, "time": "2010-02-07T07:48:48Z", "creator": "qfox@ya.ru", "creation_time": "2010-02-07T07:48:48Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 48691, "attachment_id": null, "text": "(In reply to comment #6)\n> And in that time mod_rewrite working after \"Virutalization\" on each iteration\n> adds to start of file-path directory. Actually it doesn`t clean it between\n> iterations as I see bqz have no documentroot or another ground. When we define\n> some documentroot with virtualdocumentroot it .\nSorry.\nWhen we define documentroot with virtualdocumentroot mod_rewrite adds a part which cant clear.\n\nFor example:\nhttp://foo.domain/path/file.html\nhack in .htaccess:\nRewriteCond %{ENV:REDIRECT_STATUS} 200|404\nRewriteRule .* - [L]\n\nwe have documentroot\ndocumentroot /var/www/subdomain/\nvirtualdocumentroot /var/www/subdomain/%-3/\nrewrites:\n1. path/file.html -> /var/www/subdomain/foo/path/file.html\n2. /var/www/subdomain/foo/path/file.html -> /var/www/subdomain/foo/foo/path/file.html - it stops if hack in .htaccess\n3. /var/www/subdomain/foo/foo/path/file.html -> /var/www/subdomain/foo/foo/foo/path/file.html - if no hack.\n4... infinite loop with foo/foo/foo/... rewritelog looks nice)\n\nwe have no documentroot (it is, but equals something like /htdocs)\n#documentroot\nvirtualdocumentroot /var/www/subdomain/%-3/\n\n1. path/file.html -> /var/www/subdomain/foo/path/file.html\n2. /var/www/subdomain/foo/path/file.html -> /var/www/subdomain/foo/path/var/www/subdomain/foo/path/file.html - it stops if hack in .htaccess\n3... infinite loop with /var/www/subdomain/foo/path/var/www/subdomain/...\n\nand if we have special documentroot\ndocumentroot /var/www/subdomain/foo/\nvirtualdocumentroot /var/www/subdomain/%-3/\n\n1. path/file.html -> /var/www/subdomain/foo/path/file.html\n2. /var/www/subdomain/foo/path/file.html -> /var/www/subdomain/foo/path/file.html - it stops because hack/fileexistance\n\nIt`s not a solution, it`s an example and proofs or my bug-theory.)\n\n\nI think in future apache can set DocumentRoot by VirtualDocumentRoot if DocumentRoot set to special value. Or DocumentRoot can use variables. Or other solutions. And current algorithms is very ugly.", "id": 134288, "time": "2010-02-07T08:03:41Z", "creator": "qfox@ya.ru", "creation_time": "2010-02-07T08:03:41Z", "is_private": false}]