[{"count": 0, "tags": [], "bug_id": 5932, "text": "MDC seems to work inproperly with AsyncAppender.\n\nI have a custom appender that reads some entries from the MDC, and writes them \nto a database. If I use it with the AsyncAppender, the MDC information is \nsometimes wrong.\n\nThe problems seems to be that LoggingEvent.getMDCCopy() doesn't actully create \na copy of the hashtable, but just gets a reference to it.\n\nIf you apply the patch below...\n\ndiff -b -Naur orig/org/apache/log4j/spi/LoggingEvent.java patched/org/apache/log\n4j/spi/LoggingEvent.java\n--- orig/org/apache/log4j/spi/LoggingEvent.java Mon Jan 21 10:08:10 2002\n+++ patched/org/apache/log4j/spi/LoggingEvent.java      Mon Jan 21 10:07:44 2002\n@@ -200,7 +200,7 @@\n   void getMDCCopy() {\n        if(mdcLookupRequired) {\n          ndcLookupRequired = false;\n-         mdcCopy = MDC.getContext();\n+         mdcCopy = (Hashtable)MDC.getContext().clone();\n        }\n   }\n\n... it starts working.\n\nHowever, there will still be problems, if you put mutable objects in the MDC, \nsince Hashtable.clone makes shallow clones.", "id": 9754, "time": "2002-01-21T00:22:52Z", "creator": "heikki.linnakangas@iki.fi", "creation_time": "2002-01-21T00:22:52Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 5932, "is_private": false, "count": 1, "id": 15130, "time": "2002-04-30T14:46:42Z", "creator": "ceki@apache.org", "creation_time": "2002-04-30T14:46:42Z", "text": "\nHello Heikki,\n\nThank you for the clear bug report. Your fix has been incorporated and will\nship with log4j 1.2 final. "}]