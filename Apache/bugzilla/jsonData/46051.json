[{"count": 0, "tags": [], "creator": "chris@hubick.com", "is_private": false, "text": "Created attachment 22763\nremove special CoyoteWriter println handling\n\npublic void doGet(final HttpServletRequest request, final HttpServletResponse response) throws ServletException, IOException {\n  response.setContentType(\"text/plain\");\n  PrintWriter writer = response.getWriter();\n  writer.print(\"hello world\");\n  writer.println(); //FIXME ignores System.getProperty(\"line.separator\") and always outputs \\r\\n\n  return;\n}\n\nThis means that if you use a servlet Writer on a Unix system to output any text based data format which is defined as requiring Unix format line endings ('\\n'), that data will be corrupted.\n\nThis appears to be because org.apache.catalina.connector.CoyoteWriter does:\n--------\nprivate static final char[] LINE_SEP = { '\\r', '\\n' };\n\npublic void println() {\n  write(LINE_SEP);\n}\n--------\n\nThis used to work in Tomcat 4.\n\nLooking at the old code at http://svn.apache.org/repos/asf/tomcat/archive/tc4.0.x/tags/tc4.0.6/connectors/coyote/src/java/org/apache/coyote/tomcat4/CoyoteWriter.java it appears to defer line endings to the PrintWriter base class which does the right thing.\n\nWas this change was made to output HTTP headers properly or something?  It specifically seems to override the default behavior to do this.  I don't know the code well enough to determine if the attached patch to revert to the default behavior again would break something?\n\nThanks for your consideration.", "id": 121740, "time": "2008-10-21T10:54:42Z", "bug_id": 46051, "creation_time": "2008-10-21T10:54:42Z", "attachment_id": 22763}, {"count": 1, "tags": [], "creator": "markt@apache.org", "text": "The change is http://svn.apache.org/viewvc?view=rev&revision=298149\n\nI am tempted to leave this as is. Whilst strict adherence to the PrintWriter interface requires that System.getProperty(\"line.separator\") is used, any truly portable web application is going to have to write it's own new lines anyway to be resilient against the case where it runs on a different platform.\n\nIf this was fixed, I would change the initialisation of LINE_SEP.", "id": 121744, "time": "2008-10-21T12:23:58Z", "bug_id": 46051, "creation_time": "2008-10-21T12:23:58Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "chris@hubick.com", "is_private": false, "text": "I see where you are coming from, and somewhat agree - though I think there is value in strict adherance to the API.  The decision is yours - I just wanted to make sure you were aware of it.\n\nLuckily, I had the code to this servlet and patched it to work around this.\n\nJust to note, we were actually bit by this bug when we upgraded from Tomcat 4 on our CAS ( http://www.ja-sig.org/products/cas/ ) central authentication server.  The Yale CAS server code writes out XML using the response Writer, and after the upgrade this output then contained the additional '\\r'.  Of course, this technically shouldn't matter to the XML either, except that the old (2.0.10) mod_cas C client we are using on some old servers apparently doesn't use a real XML parser and breaks reading these line endings in.  We can't upgrade the client in our legacy environment because their newer mod_auth_cas client requires a newer Apache.  So, yeah, I patched the server to work as before, and we are working to upgrade all our old client servers, but as with any enterprise, that takes time.\n", "id": 121745, "time": "2008-10-21T12:50:48Z", "bug_id": 46051, "creation_time": "2008-10-21T12:50:48Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 46051, "text": "Just testing a new way to provide an svn link:\nr298149\nor\nrevision 298149\n\n", "id": 121796, "time": "2008-10-22T12:59:36Z", "creator": "markt@apache.org", "creation_time": "2008-10-22T12:59:36Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 46051, "attachment_id": null, "text": "Testing svn links in mail messages - please ignore.\n\nr298149\nor\nrevision 298149\n", "id": 121837, "time": "2008-10-23T12:43:13Z", "creator": "markt@apache.org", "creation_time": "2008-10-23T12:43:13Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 46051, "attachment_id": null, "text": "Testing svn links in mail messages again - please ignore.\n\nr298149\nor\nrevision 298149\n", "id": 121838, "time": "2008-10-23T12:53:23Z", "creator": "markt@apache.org", "creation_time": "2008-10-23T12:53:23Z", "is_private": false}, {"count": 6, "tags": [], "creator": "markt@apache.org", "text": "I've fixed this in trunk. I am not going to propose it for back-porting since it might break something and it doesn't make much sense for app servers anyway. But since there is a spec it will be in 7.x", "id": 122113, "time": "2008-11-01T17:49:30Z", "bug_id": 46051, "creation_time": "2008-11-01T17:49:30Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 46051, "attachment_id": null, "text": "Sounds good, thanks! :)", "id": 122120, "time": "2008-11-01T19:31:46Z", "creator": "chris@hubick.com", "creation_time": "2008-11-01T19:31:46Z", "is_private": false}]