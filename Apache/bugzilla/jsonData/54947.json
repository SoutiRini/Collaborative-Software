[{"attachment_id": null, "tags": [], "bug_id": 54947, "text": "If an HTTP request is broken up across multiple packets *and* the first packet contains a GET request up to \"\\r\" AND the \"\\n\" terminating the first line of the request is included in the next packet Tomcat incorrectly throws an HTTP \"505 Version Not Supported\" response.  This is with the Http11NioProtocol connector only - the default HTTP/1.1 connector does not exhibit this problem.\n\nAn example request:\nPacket 1: GET / HTTP/1.1\\r\nPacket 2: \\nHost: localhost\\r\\n\nPacket 3: Connection: Close\\r\\n\\r\\n\n\nResponse:\nHTTP/1.1 505 HTTP Version Not Supported\nServer: Apache-Coyote/1.1\nDate: Thu, 09 May 2013 20:23:58 GMT\nConnection: close\n\nThe following Python program reproduces the problem for me in both Tomcat 6.0.37 and Tomcat 7.0.39:\n\"\"\"\n#!/usr/bin/python\n\nimport socket\nimport time\n\ns = socket.socket()\ns.connect((\"localhost\",8080))\ns.sendall(\"GET / HTTP/1.1\\r\")\ntime.sleep(1.5) # make sure the above goes out in its own packet\ns.sendall(\"\\nHost: localhost\\r\\n\")\ns.sendall(\"Connection: close\\r\\n\\r\\n\")\nprint s.makefile().read()\n\"\"\"\n\nMoving the \"\\n\" to from the second sendall to the end of the first sendall causes Tomcat to respond correctly.", "count": 0, "id": 167121, "time": "2013-05-09T20:27:01Z", "creator": "greg.2.harris@nokia.com", "creation_time": "2013-05-09T20:27:01Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 54947, "is_private": false, "text": "Created attachment 30272\nPatch for trunk\n\nHi,\n\nI can reproduce the issue with current trunk and Tomcat 7.0.40.\n\nAttached is a patch against trunk that fixes the issue for me by resolving a logic error in InternalNioInputBuffer (\"end = 0\" was set twice: when starting to read the HTTP version up to \\r, and after the \\n has been received; which meant \"end\" was set to the position of \"\\n\" instead of \"\\r\", causing the version string to be \"HTTP/1.1\\r\" instead of \"HTTP/1.1\").", "id": 167151, "time": "2013-05-12T21:48:47Z", "creator": "kpreisser@apache.org", "creation_time": "2013-05-12T21:48:47Z", "attachment_id": 30272}, {"count": 2, "tags": [], "bug_id": 54947, "attachment_id": null, "is_private": false, "id": 167176, "time": "2013-05-13T16:13:31Z", "creator": "markt@apache.org", "creation_time": "2013-05-13T16:13:31Z", "text": "Restore originally reported version.\n\nBy default, bugs get fixed in trunk and back-ported until the reported version is reached so this needs to be left as the original value else 6.0.x might not get fixed."}, {"attachment_id": null, "tags": [], "bug_id": 54947, "text": "Ok, sorry for changing the version.", "count": 3, "id": 167177, "time": "2013-05-13T16:58:38Z", "creator": "kpreisser@apache.org", "creation_time": "2013-05-13T16:58:38Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 54947, "text": "Thanks for the report, test case and fix.\n\nI added a test to Tomcat's unit tests based on the provided test case that confirmed that problem. I also confirmed the proposed patch fixes the issue.\n\nThe patch has been applied to trunk and 7.0.x and will be included in 7.0.41 onwards.\n\nThe patch has been proposed for 6.0.x", "id": 167454, "time": "2013-05-28T11:34:29Z", "creator": "markt@apache.org", "creation_time": "2013-05-28T11:34:29Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 54947, "text": "Fixed in 6.0.x and will be included in 6.0.38 onwards.\n\nThanks again for the patch.", "id": 170051, "time": "2013-09-11T20:19:42Z", "creator": "markt@apache.org", "creation_time": "2013-09-11T20:19:42Z", "is_private": false, "attachment_id": null}]