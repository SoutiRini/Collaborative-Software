[{"count": 0, "tags": [], "text": "When using embedded Tomcat, the servlet init method is called twice by the container. This has been seen with an Apache DirectMemory unit test. I have checked with a normal Tomcat launched by the Tomcat Maven plugin (mvn tomcat7:run) and in this case, the init method is correctly called once.", "is_private": false, "id": 159353, "creation_time": "2012-05-26T21:36:56Z", "time": "2012-05-26T21:36:56Z", "creator": "jeffmaury@jeffmaury.com", "bug_id": 53301, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 53301, "is_private": false, "text": "This is user error. Use the users mailing list to debug.", "id": 159354, "time": "2012-05-26T22:30:36Z", "creator": "markt@apache.org", "creation_time": "2012-05-26T22:30:36Z", "attachment_id": null}, {"count": 2, "attachment_id": null, "creator": "jeffmaury@jeffmaury.com", "is_private": false, "id": 159358, "time": "2012-05-27T19:17:04Z", "bug_id": 53301, "creation_time": "2012-05-27T19:17:04Z", "tags": [], "text": "Don't understand why you claim it is a user error"}, {"attachment_id": null, "tags": [], "creator": "knst.kolinko@gmail.com", "is_private": false, "count": 3, "id": 159388, "time": "2012-05-28T11:35:23Z", "bug_id": 53301, "creation_time": "2012-05-28T11:35:23Z", "text": "> Don't understand why you claim it is a user error\n\nIt is your responsibility to provide enough details to prove and reproduce the issue. Your report is lacking and there are several statements in it that appear to be based on false assumptions.\n\nYou should ask for help on the users list to better diagnose your problem. Bugzilla is not a support forum.\n\nFYI:\n1. tomcat7:run uses embedded Tomcat \n2. init() can be called as many times as many instances of a Servlet are there"}, {"count": 4, "tags": [], "bug_id": 53301, "text": "Sorry, but the intent was not to get support but rather to signal the Tomcat community of the problem.\nI agree I should have given more materials about the problem: so you should find now a sample Maven project that demonstrate the problem. Just run 'mvn test' and you should get the error.\nThis has been tested against 7.0.27, 7.0.26 and 7.0.25 (using the tomcatVersion property)", "id": 159408, "time": "2012-05-28T19:25:21Z", "creator": "jeffmaury@jeffmaury.com", "creation_time": "2012-05-28T19:25:21Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 53301, "is_private": false, "text": "Created attachment 28844\nSample Maven project with a test", "id": 159409, "time": "2012-05-28T19:26:13Z", "creator": "jeffmaury@jeffmaury.com", "creation_time": "2012-05-28T19:26:13Z", "attachment_id": 28844}, {"count": 6, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "is_private": false, "id": 159413, "time": "2012-05-28T21:13:19Z", "bug_id": 53301, "creation_time": "2012-05-28T21:13:19Z", "text": "Ok. Reproducible.\n\nI modified your SampleServlet to print stacktrace when init() is called, like this:\n[[[\n    @Override\n    public void init( ServletConfig config )\n        throws ServletException\n    {\n        log.info( \"Init called, config=\"+config, new Throwable() );\n        super.init( config );\n...\n]]]\n\nI'll attach full source later. There are two calls to init() in a row and stack traces are the following:\n[[[\n00:58:32.187 [main] INFO  init - Tomcat started on port:4396\n00:58:32.609 [http-bio-auto-1-exec-1] INFO  init - Init called, config=org.apache.catalina.core.StandardWrapperFacade@15e2075\njava.lang.Throwable: null\n at org.apache.tomcat.tomcat53301.SampleServlet.init(SampleServlet.java:43) [classes/:na]\n at org.apache.catalina.startup.Tomcat$ExistingStandardWrapper.loadServlet(Tomcat.java:854) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.core.StandardWrapper.allocate(StandardWrapper.java:857) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:136) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:169) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:472) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:168) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:98) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:407) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:999) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:565) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:307) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886) [na:1.6.0_32]\n at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908) [na:1.6.0_32]\n at java.lang.Thread.run(Thread.java:662) [na:1.6.0_32]\n00:58:32.625 [http-bio-auto-1-exec-1] INFO  init - Init called, config=org.apache.catalina.core.StandardWrapperFacade@15e2075\njava.lang.Throwable: null\n at org.apache.tomcat.tomcat53301.SampleServlet.init(SampleServlet.java:43) [classes/:na]\n at org.apache.catalina.core.StandardWrapper.initServlet(StandardWrapper.java:1266) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.core.StandardWrapper.allocate(StandardWrapper.java:877) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:136) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:169) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:472) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:168) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:98) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:407) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:999) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:565) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:307) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886) [na:1.6.0_32]\n at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908) [na:1.6.0_32]\n at java.lang.Thread.run(Thread.java:662) [na:1.6.0_32]\n]]]\n\nEssentially it is the same single call to\norg.apache.catalina.core.StandardWrapper.allocate()\nand it calls init() twice with the following stack traces\na)\n[[[\n at org.apache.tomcat.tomcat53301.SampleServlet.init(SampleServlet.java:43) [classes/:na]\n at org.apache.catalina.startup.Tomcat$ExistingStandardWrapper.loadServlet(Tomcat.java:854) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.core.StandardWrapper.allocate(StandardWrapper.java:857) [tomcat-embed-core-7.0.27.jar:7.0.27]\n]]]\nb)\n[[[\n at org.apache.tomcat.tomcat53301.SampleServlet.init(SampleServlet.java:43) [classes/:na]\n at org.apache.catalina.core.StandardWrapper.initServlet(StandardWrapper.java:1266) [tomcat-embed-core-7.0.27.jar:7.0.27]\n at org.apache.catalina.core.StandardWrapper.allocate(StandardWrapper.java:877) [tomcat-embed-core-7.0.27.jar:7.0.27]\n]]]\n\nThe second call happens because StandardWrapper#instanceInitialized flag is still false, but init() has already been called by Tomcat$ExistingStandardWrapper.loadServlet().\n\nSo either Tomcat$ExistingStandardWrapper should not call init(), or it should update the flag when doing so."}, {"count": 7, "attachment_id": 28845, "creator": "knst.kolinko@gmail.com", "is_private": false, "id": 159414, "time": "2012-05-28T21:15:20Z", "bug_id": 53301, "creation_time": "2012-05-28T21:15:20Z", "tags": [], "text": "Created attachment 28845\nSampleServlet.java\n\nSampleServlet.java update.\nAdded stackstace printing in init(). Overwrote destroy()."}, {"count": 8, "tags": [], "bug_id": 53301, "is_private": false, "text": "Thanks for the analysis Konstantin - that made the fix very simple.\n\nFixed in trunk and 7.0.x and will be included in 7.0.28 onwards. I also included a test case for this.", "id": 159588, "time": "2012-06-01T10:19:36Z", "creator": "markt@apache.org", "creation_time": "2012-06-01T10:19:36Z", "attachment_id": null}]