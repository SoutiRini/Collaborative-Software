[{"count": 0, "tags": [], "creator": "shimizuhiroto123@gmail.com", "attachment_id": 31307, "id": 173019, "time": "2014-02-13T07:52:14Z", "bug_id": 56133, "creation_time": "2014-02-13T07:52:14Z", "is_private": false, "text": "Created attachment 31307\npatch against trunk\n\nI used apache httpd-2.2.3-22.el5,mod_jk 1.2.28.\nSignal bus error occurs and core dump file is output.\nI analyze of follows.\n\n(gdb) bt\n#0  0x00002b7cb2c946a7 in kill () from /lib64/libc.so.6\n#1  <signal handler called>\n#2  0x00002b7cb8870f80 in jk_is_input_event (sd=-1, timeout=40000, l=0x2b7cc3499fe8) at jk_connect.c:878\n\njk_is_input_event() caused signal bus error, because of sd=-1.\n\n---mod_jk.log\n[Sun Jan 19 11:22:12 2014][15227:1221724480] [info] ajp_connection_tcp_send_message::jk_ajp_common.c\n (1101): sendfull for socket 62 returned -32 (errno=32)\n---\n\najp_connection_tcp_send_message() set the variable sd to -1 and return JK_FALSE(0).\nThus rc=0,and the loop continue.\nThe variable sd is still -1,and jk_is_input_event() caused signal bus error.\n\nI made patch against trunk.\n\n==================================================================\n--- common/jk_ajp_common.c\t(revision 1555413)\n+++ common/jk_ajp_common.c\t(working copy)\n@@ -2267,7 +2267,7 @@\n              */\n             op->recoverable = JK_FALSE;\n             rc = ajp_connection_tcp_send_message(p, op->post, l);\n-            if (rc < 0) {\n+            if (rc != JK_TRUE) {\n                 jk_log(l, JK_LOG_ERROR,\n                        \"(%s) Tomcat is down or network problems\",\n                         p->worker->name);\n\n==================================================================\n$ gdb /usr/sbin/httpd.worker core.15227\n:\n(gdb) bt\n#0  0x00002b7cb2c946a7 in kill () from /lib64/libc.so.6\n#1  <signal handler called>\n#2  0x00002b7cb8870f80 in jk_is_input_event (sd=-1, timeout=40000, l=0x2b7cc3499fe8) at jk_connect.c:878\n#3  0x00002b7cb888c625 in ajp_get_reply (e=<value optimized out>, s=0x48d1fd10, l=0x2b7cc3499fe8, p=0x2b7cc3695770, op=0x48d1ea10) at jk_ajp_common.c:1923\n#4  0x00002b7cb888f948 in ajp_service (e=0x2b7cc36977b8, s=0x48d1fd10, l=0x2b7cc3499fe8, is_error=0x48d1eb1c) at jk_ajp_common.c:2356\n#5  0x00002b7cb887b99b in service (e=<value optimized out>, s=0x48d1fd10, l=0x2b7cc3499fe8, is_error=0x48d1fef8) at jk_lb_worker.c:1214\n#6  0x00002b7cb886d6ff in jk_handler (r=0x2b7cc378b968) at mod_jk.c:2521\n:\n(gdb) p *p\n$1 = {worker = 0x2b7cc365f1e0, pool = {size = 8192, pos = 144, \n     :\n      sd = -1, reuse = 0, endpoint = {rd = 8197, wr = 637, recoverable = 1, \n     :\n      last_access = 1390098131, last_errno = 32, last_op = 1}"}, {"count": 1, "tags": [], "creator": "rainer.jung@kippdata.de", "text": "Thanks for the analysis.\nPatch applied in 1567917.\nWill be part of 1.2.38.", "id": 173024, "time": "2014-02-13T13:49:49Z", "bug_id": 56133, "creation_time": "2014-02-13T13:49:49Z", "is_private": false, "attachment_id": null}]