[{"count": 0, "tags": [], "creator": "ssehic@gmail.com", "text": "There is a bug triggered in APR/apr_snprintf when mod_deflate is enabled\nresulting in an instant SIGSEGV. Apache 2.2.0 segfaults as soon as the response\nis sent back to the client.\n\nThe configuration is pretty basic; mod_deflate is simply enabled with\nSetOutputFilter DEFLATE in a <VirtualHost></VirtualHost>\n\nThis is on OpenBSD 3.8-i386.\n\nssehic@build-2-i386:/apache/core/bin$ sudo gdb httpd\nGNU gdb 6.3\nCopyright 2004 Free Software Foundation, Inc.\nGDB is free software, covered by the GNU General Public License, and you are\nwelcome to change it and/or distribute copies of it under certain conditions.\nType \"show copying\" to see the conditions.\nThere is absolutely no warranty for GDB.  Type \"show warranty\" for details.\nThis GDB was configured as \"i386-unknown-openbsd3.8\"...\n(gdb) run -X -d /apache/core\nStarting program: /apache/core/bin/httpd -X -d /apache/core\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x00407206 in apr_vformatter (flush_func=0x407544 <snprintf_flush>,\nvbuff=0xcfbf2b98, fmt=0x3c009cc3 \"s\", ap=0xcfbf6c84 \"\")\n    at /apache/source/httpd-2.2.0/srclib/apr/strings/apr_snprintf.c:968\n968                             s_len = strlen(s);\n(gdb) bt\n#0  0x00407206 in apr_vformatter (flush_func=0x407544 <snprintf_flush>,\nvbuff=0xcfbf2b98, fmt=0x3c009cc3 \"s\", \n    ap=0xcfbf6c84 \"\") at\n/apache/source/httpd-2.2.0/srclib/apr/strings/apr_snprintf.c:968\n#1  0x00407606 in apr_vsnprintf (buf=0x0, len=8115, format=0x3c009ca0 \"Zlib:\nCompressed %ld to %ld : URL %s\", \n    ap=0xcfbf6c78 \"\") at\n/apache/source/httpd-2.2.0/srclib/apr/strings/apr_snprintf.c:1353\n#2  0x1c031bc1 in log_error_core (file=0x3c009eea \"mod_deflate.c\", line=447,\nlevel=7, status=0, s=0x801f79c0, c=0x1fb3, \n    r=0x87a24050, pool=0x0, fmt=0x3c009ca0 \"Zlib: Compressed %ld to %ld : URL\n%s\", args=0xcfbf6c78 \"\") at log.c:562\n#3  0x1c031ee1 in ap_log_rerror (file=0x3c009eea \"mod_deflate.c\", line=447,\nlevel=7, status=0, r=0x87a24050, \n    fmt=0x3c009ca0 \"Zlib: Compressed %ld to %ld : URL %s\") at log.c:633\n#4  0x1c03df71 in deflate_out_filter (f=0x87a25be8, bb=0x87a25ef8) at\nmod_deflate.c:447\n#5  0x1c036cfb in ap_pass_brigade (next=0x73, bb=0xffffffff) at util_filter.c:526\n#6  0x1c029be5 in default_handler (r=0x87a24050) at core.c:3701\n#7  0x1c02e7ca in ap_run_handler (r=0x87a24050) at config.c:157\n#8  0x1c02ec8e in ap_invoke_handler (r=0x87a24050) at config.c:371\n#9  0x1c064ef7 in ap_process_request (r=0x87a24050) at http_request.c:258\n#10 0x1c062f79 in ap_process_http_connection (c=0x8a58f128) at http_core.c:171\n#11 0x1c0340e2 in ap_run_process_connection (c=0x8a58f128) at connection.c:43\n#12 0x1c06a2b4 in child_main (child_num_arg=0) at prefork.c:640\n#13 0x1c06a398 in make_child (s=0x89c17d70, slot=0) at prefork.c:680\n#14 0x1c06ade1 in ap_mpm_run (_pconf=0x7e846018, plog=0x7ff52018, s=0x89c17d70)\nat prefork.c:956\n#15 0x1c01ef44 in main (argc=4, argv=0xcfbf7004) at main.c:712\n(gdb) bt full\n#0  0x00407206 in apr_vformatter (flush_func=0x407544 <snprintf_flush>,\nvbuff=0xcfbf2b98, fmt=0x3c009cc3 \"s\", \n    ap=0xcfbf6c84 \"\") at\n/apache/source/httpd-2.2.0/srclib/apr/strings/apr_snprintf.c:968\n        print_something = YES\n        sp = 0xcfbf2bfe \"p\\n\"\n        bep = 0xcfbf4b92 \"@ \\022\"\n        cc = 30\n        i = 2\n        s = 0x2 <Address 0x2 out of bounds>\n        q = 0x0\n        s_len = 1\n        min_width = 0\n        precision = 0\n        adjust = RIGHT\n        pad_char = 32 ' '\n        prefix_char = 0 '\\0'\n        fp_num = 4.9406564584124654e-324\n        i_num = 0\n        ui_num = 115\n        num_buf =\n\"\\177\\f\\177\\022\u00d5\\a\\000\\000\u00d5\\a\\000\\000\\004<u. \u00ecv.P\u00f4v.\\230)\u00bf\u00cf\\222\\227z\\016\\210)\u00bf\u00cf\\020\\016\\000\\000 \u00ecv.\u00f0)\u00bf\u00cf\u00a5\u00ecv.\u00f0)\u00bf\u00cf\u00a8$\\224C\u00d6\u00deo\\n\\004<u.h+w.\u00c8)\u00bf\u00cf=\\230z\\016h+w.\\000\\000\\000\\000\u00f0)\u00bf\u00cf\\000\\000\\000\\000\u00b8)\u00bf\u00cf\\000\\000\\000\\000\\a\\230z\\016\u00e8\\b@\n\u00f0)\u00bf\u00cf+\\a\\004\\0008*\u00bf\u00cfP\\206A\\000\u00f0)\u00bf\u00cf\u00f0)\u00bf\u00cf@B\\017\\000\\000\\000\\000\\000|*\u00bf\u00cf\\004m4\\211o\u00e3z\\024\u00a8$\\224C,\\000\\000\\000\\035\\000\\000\\000\\f\\000\\000\\000\\005\\000\\000\\000\\v\\000\\000\\000i\\000\\000\\000\\001\\000\\000\\000R\\001\\000\\000\\000\\000\\000\\000\\020\\016\\000\\000\"...\n        char_buf = \"\u00bf\u00cf\"\n        var_type = IS_SHORT\n        alternate_form = NO\n        print_sign = NO\n        print_blank = NO\n        adjust_precision = NO\n        adjust_width = NO\n        is_negative = 0\n#1  0x00407606 in apr_vsnprintf (buf=0x0, len=8115, format=0x3c009ca0 \"Zlib:\nCompressed %ld to %ld : URL %s\", \n    ap=0xcfbf6c78 \"\") at\n/apache/source/httpd-2.2.0/srclib/apr/strings/apr_snprintf.c:1353\n        cc = 115\n        vbuff = {curpos = 0xcfbf2be0 \"Zlib: Compressed 0 to 0 : URL p\\n\", endpos\n= 0xcfbf4b92 \"@ \\022\"}\n#2  0x1c031bc1 in log_error_core (file=0x3c009eea \"mod_deflate.c\", line=447,\nlevel=7, status=0, s=0x801f79c0, c=0x1fb3, \n    r=0x87a24050, pool=0x0, fmt=0x3c009ca0 \"Zlib: Compressed %ld to %ld : URL\n%s\", args=0xcfbf6c78 \"\") at log.c:562\n        errstr = \"[Mon Dec 05 12:29:44 2005] [debug] mod_deflate.c(447): [client\n192.168.0.12]\n\\000p\\n \\005\\000&\\200a\u00fe%@L\u00bf\u00cf\\000\\220\u00ce\\203hL\u00bf\u00cfO\\001\\000\\000O\\001@\\000\\206\\001\\000\\000pL\u00bf\u00cf\\001\\000\\000\\000,\u00ddy\\016\\004<u.\u00c0\\r\\225~\\\\\u00e9\\a\\000\\230L\u00bf\u00cf\\000\u00efy\\016\u00c0\\r\\225~\\\\\u00e9\\a\\000 @\\221\\177L\\001\\000\\000v\\232\u00db\\033\\000\\220\u00a5\\212\u00f0\\237\u00a5\\212\\004<u.\u00c0\\r\\225~\\020!u.\u00c8L\u00bf\u00cf\\020\u00fcy\\016\u00b7\u00b7\u00c9\u00a1\\000\\000\\000\\000\"...\n        scratch = \"Zlib: Compressed 0 to 0 : URL\np\\n\\000\\220\u00ce\\203\u00d0\\223o*\\030,\u00bf\u00cf\u00c2|p\\n\\000\\220\u00ce\\203\u00d0\\223o*(,\u00bf\u00cfB}p\\n\\000\\000\\000\\000\u00d0\\223o*H,\u00bf\u00cf\\027\\016p\\n\\001\\000\\000\\000{\\000\\000\\000\\000\\220\u00ce\\203\u00e8\\b@\n\u00a8,\u00bf\u00cf\\020M\u00bf\u00cf\\210,\u00bf\u00cf\u00ef\u00ce@\\000\\f\\000\\000\\000\\020M\u00bf\u00cf{\\000\\000\\000\\220\n\u00f5\\177\\220,\u00bf\u00cf\u00f6b\\036<+\\a\\004\\0001681\u00b7\u00b7\u00c9\u00a1{\\000\\000\\000\u00b3\\004\\000\\000\u00e8\\b@\n{\\000\\000\\000\\020M\u00bf\u00cf\u00b8,\u00bf\u00cf\u00d8\u00ab@\\000\\220 \u00f5\\177\\020M\u00bf\u00cf\u00a8,\u00bf\u00cf\u00a8,\u00bf\u00cf\u00a8,\u00bf\u00cf{\\000\\000\\000\"...\n        len = 77\n        errstrlen = 3485428856\n        logf = (apr_file_t *) 0x7ff52090\n        referer = 0x0\n        level_and_mask = 7\n#3  0x1c031ee1 in ap_log_rerror (file=0x3c009eea \"mod_deflate.c\", line=447,\nlevel=7, status=0, r=0x87a24050, \n    fmt=0x3c009ca0 \"Zlib: Compressed %ld to %ld : URL %s\") at log.c:633\nNo locals.\n#4  0x1c03df71 in deflate_out_filter (f=0x87a25be8, bb=0x87a25ef8) at\nmod_deflate.c:447\n        buf = 0x7d05cfb8 \"\"\n        deflate_len = 2\n        e = (apr_bucket *) 0x0\n        r = (request_rec *) 0x87a24050\n        ctx = (deflate_ctx *) 0x87a25f80\n        zRC = 115\n        c = (deflate_filter_config *) 0x81891600\n#5  0x1c036cfb in ap_pass_brigade (next=0x73, bb=0xffffffff) at util_filter.c:526\n        e = (apr_bucket *) 0x0\n#6  0x1c029be5 in default_handler (r=0x87a24050) at core.c:3701\n        fsize = 0\n        c = (conn_rec *) 0x8a58f128\n        bb = (apr_bucket_brigade *) 0x87a25ef8\n        e = (apr_bucket *) 0x7caa81f0\n        d = (core_dir_config *) 0x87a25580\n        errstatus = 0\n        fd = (apr_file_t *) 0x87a25dc8\n        status = 0\n        bld_content_md5 = 0\n#7  0x1c02e7ca in ap_run_handler (r=0x87a24050) at config.c:157\n        pHook = (ap_LINK_handler_t *) 0x0\n        n = 2\n        rv = 0\n#8  0x1c02ec8e in ap_invoke_handler (r=0x87a24050) at config.c:371\n        handler = 0x7f673df0 \"text/html\"\n        result = -2019409840\n        old_handler = 0x0\n#9  0x1c064ef7 in ap_process_request (r=0x87a24050) at http_request.c:258\n        access_status = 115\n#10 0x1c062f79 in ap_process_http_connection (c=0x8a58f128) at http_core.c:171\n        r = (request_rec *) 0x87a24050\n        csd = (apr_socket_t *) 0x0\n#11 0x1c0340e2 in ap_run_process_connection (c=0x8a58f128) at connection.c:43\n        pHook = (ap_LINK_process_connection_t *) 0x0\n        n = 0\n        rv = 0\n#12 0x1c06a2b4 in child_main (child_num_arg=0) at prefork.c:640\n        current_conn = (conn_rec *) 0x8a58f128\n        csd = (void *) 0x8a58f050\n        ptrans = (apr_pool_t *) 0x8a58f018\n        allocator = (apr_allocator_t *) 0x8478bb80\n        status = 0\n        i = -1\n        lr = (ap_listen_rec *) 0x8a58f128\n        pollset = (apr_pollset_t *) 0x8a58d0e8\n        sbh = (ap_sb_handle_t *) 0x8a58d0e0\n        bucket_alloc = (apr_bucket_alloc_t *) 0x7caa8018\n        last_poll_idx = 0\n#13 0x1c06a398 in make_child (s=0x89c17d70, slot=0) at prefork.c:680\n        pid = 470195400\n#14 0x1c06ade1 in ap_mpm_run (_pconf=0x7e846018, plog=0x7ff52018, s=0x89c17d70)\nat prefork.c:956\n        index = -1983808144\n        remaining_children_to_start = -1983808144\n        rv = 0\n#15 0x1c01ef44 in main (argc=4, argv=0xcfbf7004) at main.c:712\n        exit_status = -809537608\n        c = 100 'd'\n        configtestonly = 0\n        confname = 0x3c00035e \"conf/httpd.conf\"\n        def_server_root = 0xcfbf7183 \"/apache/core\"\n        temp_error_log = 0x0\n        error = 0x0\n        process = (process_rec *) 0x84e7a098\n        server_conf = (server_rec *) 0x89c17d70\n        pglobal = (apr_pool_t *) 0x84e7a018\n        pconf = (apr_pool_t *) 0x7e846018\n        plog = (apr_pool_t *) 0x7ff52018\n        ptemp = (apr_pool_t *) 0x7d173018\n        pcommands = (apr_pool_t *) 0x81737018\n        opt = (apr_getopt_t *) 0x817370b0\n        rv = -809537680\n        mod = (module **) 0x89c17d70\n        optarg = 0xcfbf7183 \"/apache/core\"\n        signal_server = (apr_OFN_ap_signal_server_t *) 0x73\n(gdb) quit\nThe program is running.  Exit anyway? (y or n) y\n\nssehic@build-2-i386:/apache/core/bin$ ldd httpd:\n        Start    End      Type Ref Name\n        00000000 00000000 exe   1  httpd\n        04a9d000 24aa5000 rlib  1  /usr/lib/libz.so.4.1\n        00243000 2024e000 rlib  1  /usr/lib/libssl.so.10.0\n        04b81000 24baf000 rlib  1  /usr/lib/libcrypto.so.12.0\n        0334e000 23355000 rlib  1  /usr/lib/libm.so.2.0\n        0af7a000 2af7e000 rlib  1  /apache/core/lib/libaprutil-1.so.2.2\n        0dbd4000 2dbde000 rlib  2  /usr/local/lib/libexpat.so.4.0\n        0c9ba000 2c9bf000 rlib  2  /apache/core/lib/libapr-1.so.2.2\n        0af8b000 2af94000 rlib  3  /usr/lib/libpthread.so.6.1\n        01283000 212b4000 rlib  1  /usr/lib/libc.so.38.2\n        0057f000 0057f000 rtld  1  /usr/libexec/ld.so\n\nssehic@build-2-i386:/apache/core/bin$ ./httpd -lCompiled in modules:\n  core.c\n  mod_authn_file.c\n  mod_authn_default.c\n  mod_authz_host.c\n  mod_authz_groupfile.c\n  mod_authz_user.c\n  mod_authz_default.c\n  mod_auth_basic.c\n  mod_cache.c\n  mod_disk_cache.c\n  mod_filter.c\n  mod_deflate.c\n  mod_log_config.c\n  mod_env.c\n  mod_setenvif.c\n  mod_proxy.c\n  mod_proxy_connect.c\n  mod_proxy_ftp.c\n  mod_proxy_http.c\n  mod_proxy_ajp.c\n  mod_proxy_balancer.c\n  mod_ssl.c\n  prefork.c\n  http_core.c\n  mod_mime.c\n  mod_dir.c\n  mod_so.c", "id": 83414, "time": "2005-12-08T14:02:44Z", "bug_id": 37839, "creation_time": "2005-12-08T14:02:44Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "ssehic@gmail.com", "text": "After some additional testing, it seems like that bug is only triggered when\nrunning with \"LogLevel debug\"", "id": 83418, "time": "2005-12-08T15:28:03Z", "bug_id": 37839, "creation_time": "2005-12-08T15:28:03Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 37839, "text": "Can you print r->uri in the deflate_out_filter context?  I can't see why it\nwould be invalid.  Can you also do:\n\n  (gdb) ptype z_stream\n  (gdb) ptype uLong\n\nto check the types exposed by zlib.", "count": 2, "id": 83422, "time": "2005-12-08T15:50:44Z", "creator": "jorton@redhat.com", "creation_time": "2005-12-08T15:50:44Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 37839, "attachment_id": null, "text": "Sure, here we go:\n\nssehic@build-2-i386:/apache/core/bin$ sudo gdb httpd\nGNU gdb 6.3\nCopyright 2004 Free Software Foundation, Inc.\nGDB is free software, covered by the GNU General Public License, and you are\nwelcome to change it and/or distribute copies of it under certain conditions.\nType \"show copying\" to see the conditions.\nThere is absolutely no warranty for GDB.  Type \"show warranty\" for details.\nThis GDB was configured as \"i386-unknown-openbsd3.8\"...\n(gdb) b deflate_out_filter\nBreakpoint 1 at 0x1c03dc2d: file mod_deflate.c, line 221.\n(gdb) run -X -d /apache/core\nStarting program: /apache/core/bin/httpd -X -d /apache/core\n\nBreakpoint 1, deflate_out_filter (f=0x7c593340, bb=0x84459eb0) at mod_deflate.c:221\n221         request_rec *r = f->r;\n(gdb) p r->uri\n$1 = 0x0\n(gdb) c\nContinuing.\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x08793206 in apr_vformatter (flush_func=0x8793544 <snprintf_flush>,\nvbuff=0xcfbcded8, fmt=0x3c009cc3 \"s\", ap=0xcfbd1fc4 \"\")\n    at /apache/source/httpd-2.2.0/srclib/apr/strings/apr_snprintf.c:968\n968                             s_len = strlen(s);\n(gdb) ptype z_stream\ntype = struct z_stream_s {\n    Bytef *next_in;\n    uInt avail_in;\n    off_t total_in;\n    Bytef *next_out;\n    uInt avail_out;\n    off_t total_out;\n    char *msg;\n    struct internal_state *state;\n    alloc_func zalloc;\n    free_func zfree;\n    voidpf opaque;\n    int data_type;\n    uLong adler;\n    uLong reserved;\n}\n(gdb) ptype uLong\ntype = long unsigned int\n", "id": 83428, "time": "2005-12-08T16:43:50Z", "creator": "ssehic@gmail.com", "creation_time": "2005-12-08T16:43:50Z", "is_private": false}, {"id": 83429, "tags": [], "bug_id": 37839, "is_private": false, "count": 4, "text": "I'm afraid that someone has changed the zlib API for the copy of zlib you have:\n\n    off_t total_in;\n...\n    off_t total_out;\n\nboth those fields should be uLong.  So the varargs offsets will be broken and\nthe %s will hit garbarge.  If you compile with -Wall you should see a warning.\n\nIf this is as-packaged by OpenBSD that's pretty bad - upstream own the API not\nthe packager, please complain loudly to them.", "time": "2005-12-08T18:04:16Z", "creator": "jorton@redhat.com", "creation_time": "2005-12-08T18:04:16Z", "attachment_id": null}]