[{"count": 0, "tags": [], "bug_id": 24417, "attachment_id": null, "is_private": false, "id": 46831, "time": "2003-11-05T00:24:55Z", "creator": "uli@ritual.org", "creation_time": "2003-11-05T00:24:55Z", "text": "While rotatelogs allows to specify an offset to UTC, it doesn't take DST into account. This sucks if \nyou want to process your (e.g. daily) log file with a cron job immediately afterwards, since cron will \ntake DST into account.\n\nThe following patch allows to specify the keyword \"local\" instead of a numerical offset. In this case, \nrotatelogs will rotate according to the local time, including DST.\n\nExample:\n\n| rotatelogs /path/to/access_log.%Y%m%d 86400 local\n\nI have not yet updated the manpage accordingly; please tell me if I should do so (I'm no native \nEnglish speaker, though).\n\n\nHere's the patch:\n\n\n--- rotatelogs.c.ORIG   2003-02-03 18:32:09.000000000 +0100\n+++ rotatelogs.c        2003-11-04 19:06:30.000000000 +0100\n@@ -62,6 +62,10 @@\n  * Ported to APR by Mladen Turk <mturk@mappingsoft.com>\n  *\n  * 23 Sep 2001\n+ *\n+ * Modified to work with local time (including DST) by Uli Zappe <uli@ritual.org>\n+ * \n+ * 04 Nov 2003\n  */\n \n \n@@ -100,6 +104,7 @@\n     apr_size_t nRead, nWrite;\n     int use_strftime = 0;\n     int now = 0;\n+    int local = 0;\n     const char *szLogRoot;\n     apr_file_t *f_stdin, *nLogFD = NULL, *nLogFDprev = NULL;\n     apr_pool_t *pool;\n@@ -149,7 +154,8 @@\n     }\n     else {\n         if (argc >= 4) {\n-            utc_offset = atoi(argv[3]) * 60;\n+            if (strcmp (argv[3], \"local\") == 0) local = 1;\n+            else utc_offset = atoi(argv[3]) * 60;\n         }\n         tRotation = atoi(argv[2]);\n         if (tRotation <= 0) {\n@@ -169,7 +175,15 @@\n         if (apr_file_read(f_stdin, buf, &nRead) != APR_SUCCESS)\n             exit(3);\n         if (tRotation) {\n-            now = (int)(apr_time_now() / APR_USEC_PER_SEC) + utc_offset;\n+            int offset;\n+            apr_time_t _now = apr_time_now();\n+            if (local) {\n+                apr_time_exp_t exptime;\n+                apr_time_exp_lt (&exptime, _now);\n+                offset = exptime.tm_gmtoff;\n+            }\n+            else offset = utc_offset;\n+            now = (int)(_now / APR_USEC_PER_SEC) + offset;\n             if (nLogFD != NULL && now >= tLogEnd) {\n                 nLogFDprev = nLogFD;\n                 nLogFD = NULL;"}, {"count": 1, "tags": [], "bug_id": 24417, "attachment_id": 9232, "id": 47870, "time": "2003-11-21T21:19:17Z", "creator": "cmadams@hiwaay.net", "creation_time": "2003-11-21T21:19:17Z", "is_private": false, "text": "Created attachment 9232\nPatch for 2.0.48 to use localtime (including updated documentation)"}, {"count": 2, "tags": [], "creator": "uli@ritual.org", "attachment_id": null, "id": 47876, "creation_time": "2003-11-21T22:06:46Z", "time": "2003-11-21T22:06:46Z", "bug_id": 24417, "text": "Chris,\n\nI'm not sure why you moved the modification in the code of rotatelogs to the place you did. Are \nyou sure this will work, especially on days when DST is switched on or off? I don't have the \nopportunity to test this right now, but it's obviously important that the behavior is right on these \ndays.\n\nAnyway, the following is obviously wrong in your version of the patch:\n\n+            if (strcmp(argv[3], \"loc\") == 0) {\n+                use_local = 0;\n\nshould be\n\n+            if (strcmp(argv[3], \"loc\") == 0) {\n+                use_local = 1;\n\nor is there something I just didn't get?", "is_private": false}, {"count": 3, "tags": [], "creator": "cmadams@hiwaay.net", "attachment_id": null, "id": 48179, "creation_time": "2003-11-26T19:17:33Z", "time": "2003-11-26T19:17:33Z", "bug_id": 24417, "text": "Yes, you got the obvious typo.  I did fix this, but I didn't upload the right\nversion (and didn't catch it right away).\n\nI also updated the documentation in my patch to note that it does not affect the\nlog rotation time math (i.e. if you say \"86400\", it will still be rotated at\n00:00:00 UTC); it just affects the time formatting done with strftime(3) to use\nthe local time zone.  What I do is set my log rotation time to be 3600, and then\nuse a filename like \"access_log.%Y-%m-%d\" (so it re-determines the filename\nevery hour, but it only changes at 00:00:00 local time).\n\nI did it this way because the patch is much simpler (more likely to be\nacceptable), but I see how this could just make things more confusing, as it\nchanges the behavior of the option.  Sorry about that.\n", "is_private": false}, {"count": 4, "tags": [], "text": "Chris wrote:\n> I also updated the documentation in my patch to note that it does not affect\n> the log rotation time math (i.e. if you say \"86400\", it will still be rotated at\n> 00:00:00 UTC);\n\nBut that's exactly the behavior I wanted to avoid because it makes syncing with cron jobs so \ndifficult.\n\n> What I do is set my log rotation time to be 3600, and then\n> use a filename like \"access_log.%Y-%m-%d\" (so it re-determines the filename\n> every hour, but it only changes at 00:00:00 local time).\n\nWhich is kind of confusing. If you plan to rotate once a day, 86400 should work for you, even if you \nuse the \"local\" option.\n\n> I did it this way because the patch is much simpler (more likely to be\n> acceptable)\n\nWell, my patch isn't *that* complicated, is it? And it does exactly what it should, in an intuitive way. \nI think the foremost consideration should be what is simple for the *user*. ", "is_private": false, "id": 48186, "creator": "uli@ritual.org", "time": "2003-11-26T19:44:21Z", "bug_id": 24417, "creation_time": "2003-11-26T19:44:21Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 24417, "is_private": false, "count": 5, "id": 59278, "time": "2004-06-16T12:07:19Z", "creator": "trawick@apache.org", "creation_time": "2004-06-16T12:07:19Z", "text": "Ken Coar recently committed an equivalent feature to 2.1-dev, which I presume\nwill be backported to stable branch for a future 2.0.x release.  Please have a look:\n\nhttp://cvs.apache.org/viewcvs.cgi/httpd-2.0/support/rotatelogs.c?r1=1.32&r2=1.34\n"}, {"count": 6, "tags": [], "creator": "uli@ritual.org", "is_private": false, "text": "> Ken Coar recently committed an equivalent feature to 2.1-dev, which I presume\n> will be backported to stable branch for a future 2.0.x release.  Please have a look:\n\nKen's patch won't work correctly on the days when DST is switched on or off, because he puts the \ntest for the local time offset (utc_offset = lt.tm_gmtoff;) outside of the \"for (;;)\" loop. Therefore, the \ntime offset will only be set once after the start of the rotatelogs process, and will not be updated \nafter a switch of DST occurs.\n\nKen himself writes in his comment: \"NB: Using -l in an environment which changes the GMT offset \n(such as for BST or DST) can lead to unpredictable results!\", suggesting he has indeed not tested his \npatch on days when the switch occurs. However, unless you intend to use DST there's no point at all \nin using local time instead of a fixed offset from GMT.\n\n<Sigh> Why don't you just use the patch I committed? It's thoroughly tested, especially on days \nwhen the DST switch occurs, and proven to work in a production environment for almost two years \nnow.", "id": 59329, "time": "2004-06-16T16:19:40Z", "bug_id": 24417, "creation_time": "2004-06-16T16:19:40Z", "attachment_id": null}, {"count": 7, "tags": [], "text": "I don't know why the patch here wasn't used.  When Ken's patch was posted to the\ndeveloper's mailing list I pointed out this patch/PR.\n\nRegardless, I pointed out your recent comments here to Ken and he integrated\nyour comment.  See \n\nhttp://cvs.apache.org/viewcvs.cgi/httpd-2.0/support/rotatelogs.c\n\n(I'm just the middleman here ;) )\n", "attachment_id": null, "id": 59632, "creator": "trawick@apache.org", "time": "2004-06-20T21:12:06Z", "bug_id": 24417, "creation_time": "2004-06-20T21:12:06Z", "is_private": false}, {"count": 8, "tags": [], "text": "Jeff, thanks! As far as I can see, the new code by Ken should work. Therefore I close this report. :-)", "attachment_id": null, "id": 59640, "creator": "uli@ritual.org", "time": "2004-06-21T00:49:38Z", "bug_id": 24417, "creation_time": "2004-06-21T00:49:38Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 24417, "attachment_id": null, "is_private": false, "id": 59663, "time": "2004-06-21T11:03:29Z", "creator": "trawick@apache.org", "creation_time": "2004-06-21T11:03:29Z", "text": "Thanks for your review, and I'm sorry about the confused path to a solution for\nthis issue!\n"}]