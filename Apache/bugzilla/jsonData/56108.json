[{"count": 0, "tags": [], "creator": "mike@normi.net", "attachment_id": null, "text": "Currently, the SSL_CTX_set_tmp_dh_callback() function is used to define a callback to retrieve DH parameters for SSL connections. Unfortunately, as a side-effect of the OpenSSL implementation, this means that only 1024 bit DH keys are used [1].\n\nIt's probably better to provide the user with an option to explicitly set the DH parameters (generated using openssl dhparam), which makes it possible to use DH parameters over 1024 bits. SSL_CTX_set_tmp_dh() can be used for this.\n\n[1] https://groups.google.com/forum/#!topic/mailing.openssl.users/UmdbGRFsFmY", "id": 172896, "time": "2014-02-04T22:59:34Z", "bug_id": 56108, "creation_time": "2014-02-04T22:59:34Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "r.paasche@pripares.com", "text": "This would not change anything.\n\nThe real solution (based on mod_ssl) would to change the callbackmethod to:\n\nDH *SSL_callback_tmp_DH(SSL *ssl, int export, int keylen)\n{\n    EVP_PKEY *pkey;\n    int type;\n\n    pkey = SSL_get_privatekey(ssl);\n    type = pkey ? EVP_PKEY_type(pkey->type) : EVP_PKEY_NONE;\n\n    /*\n     * OpenSSL will call us with either keylen == 512 or keylen == 1024\n     * (see the definition of SSL_EXPORT_PKEYLENGTH in ssl_locl.h).\n     * Adjust the DH parameter length according to the size of the\n     * RSA/DSA private key used for the current connection.\n     */\n    if ((type == EVP_PKEY_RSA) || (type == EVP_PKEY_DSA)) {\n        keylen = EVP_PKEY_bits(pkey);\n    }\n\n    int idx;\n    switch (keylen) {\n        case 512:\n            idx = SSL_TMP_KEY_DH_512;\n        break;\n        case 2048:\n            idx = SSL_TMP_KEY_DH_2048;\n        break;\n        case 4096:\n            idx = SSL_TMP_KEY_DH_4096;\n        break;\n        case 1024:\n        default:\n            idx = SSL_TMP_KEY_DH_1024;\n        break;\n    }\n    return (DH *)SSL_temp_keys[idx];\n}", "count": 1, "id": 181586, "time": "2015-03-07T19:59:38Z", "bug_id": 56108, "creation_time": "2015-03-07T19:59:38Z", "is_private": false}, {"count": 2, "tags": [], "text": "Removed switch key, to handle more private keylenght (e.g. 3072 bits).\n\nDH *SSL_callback_tmp_DH(SSL *ssl, int export, int keylen)\n{\n    EVP_PKEY *pkey;\n    int type;\n\n    pkey = SSL_get_privatekey(ssl);\n    type = pkey ? EVP_PKEY_type(pkey->type) : EVP_PKEY_NONE;\n\n    /*\n     * OpenSSL will call us with either keylen == 512 or keylen == 1024\n     * (see the definition of SSL_EXPORT_PKEYLENGTH in ssl_locl.h).\n     * Adjust the DH parameter length according to the size of the\n     * RSA/DSA private key used for the current connection.\n     */\n    if ((type == EVP_PKEY_RSA) || (type == EVP_PKEY_DSA)) {\n        keylen = EVP_PKEY_bits(pkey);\n    }\n\n    int idx = SSL_TMP_KEY_DH_512;\n    if (keylen > 2048)\n    {\n        idx = SSL_TMP_KEY_DH_4096;\n    }\n    else if (keylen > 1024)\n    {\n        idx = SSL_TMP_KEY_DH_2048;\n    }\n    else if (keylen > 512)\n    {\n        idx = SSL_TMP_KEY_DH_1024;\n    }\n\n    return (DH *)SSL_temp_keys[idx];\n}", "attachment_id": null, "id": 181752, "creator": "r.paasche@pripares.com", "time": "2015-03-14T12:08:50Z", "bug_id": 56108, "creation_time": "2015-03-14T12:08:50Z", "is_private": false}, {"count": 3, "tags": [], "text": "I have ported the current mod_ssl code from httpd to tcnative with the following features:\n\n- by default use the same size for DH as the key used in the certificate. So certificate strength reflects in key exchange strengths.\n\n- optionally you can generate your own DH params using \"opsnssl dhparam\" and add them into the certificate file. We will find the data there automatically (if present) and use these params instead.\n\nA docs update will follow soon.\n\nI guess with these improvements we can fix this issue here as soon as the next tcnative 1.1.34 gets released.", "attachment_id": null, "id": 183090, "creator": "rainer.jung@kippdata.de", "time": "2015-05-23T15:41:35Z", "bug_id": 56108, "creation_time": "2015-05-23T15:41:35Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 56108, "attachment_id": null, "id": 186296, "creation_time": "2015-11-06T22:15:26Z", "time": "2015-11-06T22:15:26Z", "creator": "r.paasche@pripares.com", "text": "Is this part of tcnativ 1.2.x ?", "is_private": false}, {"count": 5, "tags": [], "bug_id": 56108, "text": "Yes. A release vote for the first public release 1.2.2 is in progress. The release should be available in a few days.", "id": 186314, "time": "2015-11-08T05:38:36Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2015-11-08T05:38:36Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "1983-01-06@gmx.net", "text": "Hi Rainer, 1.2.2 has been released (http://tomcat.apache.org/native-doc/miscellaneous/changelog.html). I cannot see the changes you have made. Has this been postponed to 1.2.3?", "count": 6, "id": 186352, "time": "2015-11-11T09:14:13Z", "bug_id": 56108, "creation_time": "2015-11-11T09:14:13Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 56108, "attachment_id": null, "id": 186353, "time": "2015-11-11T09:52:00Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2015-11-11T09:52:00Z", "is_private": false, "text": "It is in 1.2.2, but the change had already also been backported to the 1.1 branch for the forthcoming 1.1.34.\n\nThe changelog of 1.2.2 starts on top of 1.1 but unfirtunately not on top of the last released 1.1.33 but the 1.1. changelog as it was when 1.2.0 was cut.\n\nSo some changes are missing in the changelog for 1.2.2. Especially:\n\n    <update>\n      Unconditionally disable export Ciphers. Use the\n      configure flag --enable-insecure-export-ciphers\n      for a custom build supporting those insecure ciphers.\n      (rjung)\n    </update>\n    <update>\n      Improve ephemeral key handling for DH and ECDH.\n      Parameter strength is by default derived from the\n      certificate key strength. It can be overwritten\n      by embedding custom parameters in the certificate\n      file configured with <code>SSLCertificateFile</code>. (rjung)\n    </update>\n\nThe second one is the one you are looking for.\n\nIt works the same way as in Apache httpd mod_ssl.\n\nRegards,\n\nRainer"}, {"count": 8, "tags": [], "text": "Hi Rainer, it sounds like this fix is in 1.2.2, but missed in the changelog and will be in the upcoming 1.1.34.  Is this a correct summary?\n\nIf so, can the changelog for 1.2.2 be updated to include these notes?\n\nAlso, do you know when 1.1.34 is scheduled to be released?", "attachment_id": null, "id": 186365, "creator": "bcampolo@mmm.com", "time": "2015-11-11T18:18:26Z", "bug_id": 56108, "creation_time": "2015-11-11T18:18:26Z", "is_private": false}, {"count": 9, "tags": [], "creator": "1983-01-06@gmx.net", "attachment_id": null, "text": "We have recently upgraded to Tomcat 6.0.45 which has libtcnative 1.1.34 included. I scanned the endpoint with sslscan and I can confirm that DHE is now serverd with 2048 bits. Rainer, thank you very much for the patch. This is fixed for me.", "id": 189666, "time": "2016-03-23T12:44:00Z", "bug_id": 56108, "creation_time": "2016-03-23T12:44:00Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 56108, "attachment_id": null, "id": 189675, "time": "2016-03-23T18:47:58Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2016-03-23T18:47:58Z", "is_private": false, "text": "Thanks for the feedback, closing as fixed."}]