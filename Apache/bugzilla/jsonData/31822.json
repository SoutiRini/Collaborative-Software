[{"count": 0, "tags": [], "bug_id": 31822, "attachment_id": null, "text": "I use mod_proxy as reverse proxy with mod_deflate to compress www-pages and\nmod_mem_cache as cache\n\nMy backend http-server is Lotus Domino 6.0.3.\nProblem is that Apache somehow brokes images (gif/jpeg) for some unknown reason.\n\nIt does not depend on browser as this happens with MSIE 6 (all hotfixes, service\npacks included) and with Firefox 1.0 Preview version, also with squid as forward\nproxy, still images sometimes goes broken also happens with older Mozilla versions.\n\nIf i do not use reverse proxy everything works just fine, so i do not think\nLotus Domino brokes images in normal situation without reverse proxy (never\nhappened that Domino brokes images).\n\nWhat i have discovered that there is missing couple kilobytes from beginning of\nimage. Could this problem be related with combination of mod_mem_cache,\nmod_deflate and mod_proxy as reverse proxy. \n\nand when reloading page or waiting some time and reloading page it gets image ok.\n\nMy configuration for host is:\n# - COMPRESSION - #\n SetOutputFilter DEFLATE\n    BrowserMatch ^Mozilla/4         gzip-only-text/html\n    BrowserMatch ^Mozilla/4\\.0[678] no-gzip\n    BrowserMatch \\bMSI[E]           !no-gzip !gzip-only-text/html\n\n# do not compress images, pdf also nogo\n SetEnvIfNoCase Request_URI \\.(?:gif|jpe?g|png|pdf)$ no-gzip dont-vary\n         Header append      Vary                 User-Agent env=!dont-vary\n\nDeflateFilterNote  Input  instream\nDeflateFilterNote Output outstream\nDeflateFilterNote  Ratio     ratio\n# - COMPRESSION - #\n\n# - GLOBAL CACHE SETTINGS - #\n     CacheDefaultExpire 3600\nCacheIgnoreCacheControl Off\n   CacheIgnoreNoLastMod Off\n         CacheMaxExpire 3600\n\n<VirtualHost *:80>\n CacheForceCompletion 100\n               SetEnv force-proxy-request-1.0 1\n               SetEnv proxy-nokeepalive 1\n\n           ServerName www.xxxx.yy\n          ServerAdmin xxx@yyy.zz\n        ProxyRequests Off\n    ProxyPreserveHost On\n            ProxyPass /error/ !\n            ProxyPass / http://x.y.z.z/\n     ProxyPassReverse / http://x.y.z.z/\n          CacheEnable mem /\n                    # 128 MB cache\n           MCacheSize 131072\n MCacheMaxObjectCount 2500\n  MCacheMinObjectSize 1\n               # max. 50 kB obj. size\n  MCacheMaxObjectSize 51200\nCacheIgnoreCacheControl Off\n   CacheIgnoreNoLastMod Off\n         CacheMaxExpire 3600\n<Proxy *>\n   Order deny,allow\n   Allow from all\n</Proxy>\n\n CustomLog \"|/usr/sbin/cronolog /path/logfiles/z.y.z/z.y.x-access_log-%Y-%m-%d\"\ncombined\n</VirtualHost>", "id": 65418, "time": "2004-10-21T08:41:39Z", "creator": "pekka.panula@sofor.fi", "creation_time": "2004-10-21T08:41:39Z", "is_private": false}, {"count": 1, "tags": [], "creator": "nick@webthing.com", "attachment_id": null, "id": 65430, "time": "2004-10-21T12:16:19Z", "bug_id": 31822, "creation_time": "2004-10-21T12:16:19Z", "is_private": false, "text": "OK, that's a combo of three things on the httpd: proxy, deflate and mem_cache. \n \nI've used that combo with the exception of cache with no problems: can you\nconfirm whether proxy+deflate without cache works for you?  And what about\nproxy+cache+no-deflate?\n\nCan you get the httpd headers from a broken image?\n"}, {"count": 2, "tags": [], "bug_id": 31822, "attachment_id": null, "text": "Here is one case when image was broken, it says size: 22215, but right size is\n23663 bytes. I am now running without mem_cache so i can verify if mem_cache is\nbroken.\n\nGET /web/database.nsf/images/loka2_promot.gif/$FILE/loka2_promot.gif HTTP/1.1\nAccept: */*\nReferer:\nhttp://www.xyz.xx/web/database.nsf/sivut/etusivu-4?OpenDocument&cid=etusivunkuvat\nAccept-Language: fi\nAccept-Encoding: gzip, deflate\nIf-Modified-Since: Thu, 21 Oct 2004 07:36:28 GMT\nIf-None-Match: W/\"MTAtODA4RC1DMjI1NkYzNDAwMjlDQTJBLUMyMjU2RjMzMDA1NUM3MEUtMA==\"\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\nHost: www.xyz.xx\nConnection: Keep-Alive\n\n\nHTTP/1.1 200 OK\nDate: Thu, 21 Oct 2004 07:49:49 GMT\nServer: Apache/2.0.52\nLast-Modified: Wed, 20 Oct 2004 15:36:56 GMT\nContent-Type: image/gif\nContent-Length: 22215\nAccept-Ranges: bytes\nETag: W/\"MTAtODA4RC1DMjI1NkYyRTAwMzYwQkNFLUMyMjU2RjMzMDA1NUM3MEUtMA==\"\nAge: 1858\nKeep-Alive: timeout=15, max=90\nConnection: Keep-Alive", "id": 65432, "time": "2004-10-21T12:34:05Z", "creator": "pekka.panula@sofor.fi", "creation_time": "2004-10-21T12:34:05Z", "is_private": false}, {"count": 3, "tags": [], "text": "I disabled mod_mem_cache and after that i have not able to get broken images.\nI did leave one site with mod_mem_cache enabled and on that site i did get\nbroken images.\n\nSo it seems that mem_cache is somehow broken. There is missing small amount of\nbytes in beginning of images when this happens. ", "attachment_id": null, "bug_id": 31822, "id": 65482, "time": "2004-10-22T05:53:05Z", "creator": "pekka.panula@sofor.fi", "creation_time": "2004-10-22T05:53:05Z", "is_private": false}, {"count": 4, "tags": [], "creator": "trawick@apache.org", "attachment_id": null, "id": 65488, "time": "2004-10-22T09:49:48Z", "bug_id": 31822, "creation_time": "2004-10-22T09:49:48Z", "is_private": false, "text": "BTW, did you have this setup working properly with a prior version of Apache, or\nis 2.0.52 the first version you used with this setup?"}, {"count": 5, "tags": [], "bug_id": 31822, "attachment_id": null, "text": "If i remember correctly i started to use reverse proxy with v2.0.51 and upgraded\nto v2.0.52, but this picture problem also happened with that earlier version.", "id": 65489, "time": "2004-10-22T09:55:26Z", "creator": "pekka.panula@sofor.fi", "creation_time": "2004-10-22T09:55:26Z", "is_private": false}, {"count": 6, "tags": [], "creator": "pekka.panula@sofor.fi", "attachment_id": null, "id": 65820, "time": "2004-10-27T12:25:53Z", "bug_id": 31822, "creation_time": "2004-10-27T12:25:53Z", "is_private": false, "text": "I have not seen any missing pictures since i disabled mod_mem_proxy so can we\nassume that mod_mem_proxy is somehow broken.\n\nI think i enable now disk_cache and see if that makes any broken images."}, {"count": 7, "tags": [], "creator": "pekka.panula@sofor.fi", "text": "I did not work with mod_disk_cache. \nMy browsers (Firefox & IE) did not get any page after i enabled mod_disk_cache.\nAnd when i disabled mod_disk_cache it works ok. \n\nMy configuration for mod_disk_cache was:\n\n# - GLOBAL - #\n              CacheRoot /tmp/cache\n                # 512 MB disk cache\n              CacheSize 524288\n         CacheDirLevels 5\n         CacheDirLength 3\n     CacheDefaultExpire 3600\nCacheIgnoreCacheControl Off\n   CacheIgnoreNoLastMod Off\n         CacheMaxExpire 3600\n\n<VirtualHost *:80>\n CacheForceCompletion 100\n\n           ServerName www.xyz.xx\n          ServerAdmin xyz@xxx.yy\n        ProxyRequests Off\n    ProxyPreserveHost On\n            ProxyPass /error/ !\n            ProxyPass / http://x.x.x.x/\n     ProxyPassReverse / http://x.x.x.x/\n            CacheRoot /tmp/cache\n                # 128 MB disk cache\n            CacheSize 131072\n       CacheDirLevels 5\n       CacheDirLength 3\n\nCacheIgnoreCacheControl Off\n   CacheIgnoreNoLastMod Off\n         CacheMaxExpire 3600\n<Proxy *>\n   Order deny,allow\n   Allow from all\n</Proxy>\n\n CustomLog \"|/usr/sbin/cronolog\n/mnt/logfiles/www.xxx.yy/www.xxx.yy-access_log-%Y-%m-%d\" combined\n</VirtualHost>\n\n", "id": 65877, "time": "2004-10-28T05:53:17Z", "bug_id": 31822, "creation_time": "2004-10-28T05:53:17Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 31822, "attachment_id": null, "text": "Those sample headers are interesting:\n\nContent-Length: 22215  <=== can you confirm that's correct?  I prefer a URL I\ncan look at myself.\n\n\nIf-None-Match: W/\"MTAtODA4RC1DMjI1NkYzNDAwMjlDQTJBLUMyMjU2RjMzMDA1NUM3MEUtMA==\"\nETag: W/\"MTAtODA4RC1DMjI1NkYyRTAwMzYwQkNFLUMyMjU2RjMzMDA1NUM3MEUtMA==\"\n\nSo that's if-none-match, and the reply is yes-it-does-match-but-here-it-is-anyway.\nDoes it make any difference if you configure \"Header unset ETag\"?", "id": 65886, "time": "2004-10-28T09:08:05Z", "creator": "nick@webthing.com", "creation_time": "2004-10-28T09:08:05Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 31822, "attachment_id": null, "id": 65887, "time": "2004-10-28T09:10:49Z", "creator": "nick@webthing.com", "creation_time": "2004-10-28T09:10:49Z", "is_private": false, "text": "Oh, and the other one:\nRequestHeader unset If-none-match\n\nAnd if you can sniff whether the body is in fact being sent in the case of a\nmatch, as appears to be happening from the headers?"}, {"count": 10, "tags": [], "bug_id": 31822, "attachment_id": null, "text": "I am not unable to reproduce any broken images anymore, i have switched to use\nprefork MPM instead of Worker MPM. Allthough my test site is not under heavy\nload, but i think i can enable mod_mem_cache and see if it works better under\nprefork.", "id": 66277, "time": "2004-11-02T11:20:21Z", "creator": "pekka.panula@sofor.fi", "creation_time": "2004-11-02T11:20:21Z", "is_private": false}, {"count": 11, "tags": [], "creator": "pekka.panula@sofor.fi", "attachment_id": null, "id": 66337, "time": "2004-11-03T13:21:10Z", "bug_id": 31822, "creation_time": "2004-11-03T13:21:10Z", "is_private": false, "text": "I am now getting missing pictures, so prefork MPM did not helped.\n\nI try with \"RequestHeader unset If-none-match\" next to see if that would make\nany difference."}, {"count": 12, "tags": [], "bug_id": 31822, "attachment_id": null, "text": "\"RequestHeader unset If-none-match\" did not helped. I get broken images.\n", "id": 66507, "time": "2004-11-05T07:21:14Z", "creator": "pekka.panula@sofor.fi", "creation_time": "2004-11-05T07:21:14Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 31822, "attachment_id": null, "text": "Your comment showing headers still bothers me.  It should be a 304, not a 200. \nWhich modules are being used in that one?\n\nOh, and a real URL would still be much more helpful than pare speculation. \nPreferably a small (in byte size) image that shows the problem.", "id": 66511, "time": "2004-11-05T09:28:40Z", "creator": "nick@webthing.com", "creation_time": "2004-11-05T09:28:40Z", "is_private": false}, {"count": 14, "tags": [], "creator": "nick@webthing.com", "attachment_id": null, "id": 66517, "time": "2004-11-05T12:09:22Z", "bug_id": 31822, "creation_time": "2004-11-05T12:09:22Z", "is_private": false, "text": "I have no idea how I changed that to mpm_winnt ... accident with the fingers I\npresume.  Changing to mod_cache, which is looking the likeliest culprit."}, {"count": 15, "tags": [], "bug_id": 31822, "attachment_id": null, "text": "I just upgraded from apache 2.0.49 to apache 2.0.52 and I saw exactly the same\nproblem. (however, we don't use mod_deflate, just mod_proxy, mod_cache and\nmod_mem_cache)\nThe Content-Length for cached content is wrong and the _first_ few kilobytes of\nthe pages is missing. I've seen it on all cached content (html, jpg etc)\n\nGrepping through our access logs it would seem that later requests to unrelated\ncontent mess up earlier cached content.\n\nThe simplest sequence I could find in our access logs was this one:\n$ grep 11:25:31 access \nbbol.omroep.nl 145.58.10.75 18611 - [30/Dec/2004:11:25:31 +0100] \"GET\n/default.jsp HTTP/1.1\" 200 16603\nbbol.omroep.nl 145.58.10.75 1887 - [30/Dec/2004:11:25:31 +0100] \"GET / HTTP/1.1\"\n302 -\nbbol.omroep.nl 145.58.10.75 147 0 [30/Dec/2004:11:25:31 +0100] \"GET /default.jsp\nHTTP/1.1\" 200 8845\n\n( we use a slightly modified log format; commonvhost but the last field before\nthe date is the value of the Age header, so the first entry shows an uncached\nhit on /default.jsp. It's size is 16603 bytes (correct)\nThe last hit is a cached one. Its size is 8845 (wrong)\nThe middle hit may or may not have something to do with all this.\n\nSince both hits are more or less simultaneously it might be that while apache\nwas still sending the first hit it got the second request and found some race\ncondition in the cache inmplementation?\n", "id": 69077, "time": "2004-12-30T11:59:19Z", "creator": "Dick.Snippe@tech.omroep.nl", "creation_time": "2004-12-30T11:59:19Z", "is_private": false}, {"count": 16, "tags": [], "creator": "Dick.Snippe@tech.omroep.nl", "attachment_id": null, "id": 69080, "time": "2004-12-30T12:50:13Z", "bug_id": 31822, "creation_time": "2004-12-30T12:50:13Z", "is_private": false, "text": "I can repeat this bug in our test environment.\n\nHere are the exact headers:\n\n$ cat req\nGET /bbol/default.jsp HTTP/1.1\nHost: testsites.omroep.nl\nUser-Agent: Flap/0.1\nAccept: *\nConnection: close\n\n$ nc testsites 80 <req | head\nHTTP/1.1 200 OK\nDate: Thu, 30 Dec 2004 11:36:27 GMT\nServer: Apache-Coyote/1.1\nExpires: Thu, 30 Dec 2004 11:36:48 GMT\nLast-Modified: Thu, 30 Dec 2004 11:36:28 GMT\nContent-Type: text/html;charset=utf-8\nConnection: close\nTransfer-Encoding: chunked\n\n4c5\n\n$ nc testsites 80 <req1 | head\nHTTP/1.1 200 OK\nDate: Thu, 30 Dec 2004 11:36:30 GMT\nServer: Apache/2.0.52 (Unix) mod_ssl/2.0.52 OpenSSL/0.9.7e\nExpires: Thu, 30 Dec 2004 11:36:48 GMT\nLast-Modified: Thu, 30 Dec 2004 11:36:28 GMT\nContent-Type: text/html;charset=utf-8\nAge: 2\nContent-Length: 15947\nConnection: close\n\nThe access log shows:\ntestsites.omroep.nl 145.58.13.66 67348 - [30/Dec/2004:12:36:27 +0100] \"GET\n/bbol/default.jsp HTTP/1.1\" 200 17168\ntestsites.omroep.nl 145.58.13.66 2843 2 [30/Dec/2004:12:36:30 +0100] \"GET\n/bbol/default.jsp HTTP/1.1\" 200 15947\n\nI think its a bug in chunked transfer encoding. When the hit is not cached,\ntomcat uses chunked transfer encoding. When the hit is cached, no chunking is\ndone. HOWEVER: in the cached hit the original first chunk appears to be missing.\n\nThe chunked data looks like:\n\n---------cut here------------\nDate: Thu, 30 Dec 2004 11:40:10 GMT\nServer: Apache-Coyote/1.1\nExpires: Thu, 30 Dec 2004 11:40:30 GMT\nLast-Modified: Thu, 30 Dec 2004 11:40:10 GMT\nContent-Type: text/html;charset=utf-8\nConnection: close\nTransfer-Encoding: chunked\n\n4c5\n[chunk 1]\nb50\n[chunk 2]\netc. etc.\n---------cut here------------\n\nThe unchunked (cached) output looks like:\n---------cut here------------\nHTTP/1.1 200 OK\nDate: Thu, 30 Dec 2004 11:40:25 GMT\nServer: Apache/2.0.52 (Unix) mod_ssl/2.0.52 OpenSSL/0.9.7e\nExpires: Thu, 30 Dec 2004 11:40:30 GMT\nLast-Modified: Thu, 30 Dec 2004 11:40:10 GMT\nContent-Type: text/html;charset=utf-8\nAge: 15\nContent-Length: 15947\nConnection: close\n\n[chunk 2]\netc. etc.\n---------cut here------------\n\nso chunk1 was probably never cached.\n"}, {"count": 17, "tags": [], "creator": "Dick.Snippe@tech.omroep.nl", "text": "One more snippet of info:\n\nthis \"first chunk\" missing thing only happens when there was an expired entry in\nthe cache beforehand. It does not happen after a fresh (re)start of apache.\nI.e.\n\n1) (re)start apache -> mem cache is empty\n2) get (uncached) request -> the browser gets chunked, correct data\n3) get (cached) request -> the browser gets unchunked, correct data\n4) wait until content is expired\n5) get (uncached) request -> the browser gets chunked, correct data\n6) get (cached) request -> the browser gets unchunked, incorrect data\n", "id": 69081, "time": "2004-12-30T13:40:54Z", "bug_id": 31822, "creation_time": "2004-12-30T13:40:54Z", "is_private": false, "attachment_id": null}, {"count": 18, "tags": [], "bug_id": 31822, "attachment_id": null, "text": "The behaviour I'm seeing is a duplicate of bug #31385\nThe patch proposed there works for me.", "id": 69108, "time": "2004-12-30T22:23:32Z", "creator": "Dick.Snippe@tech.omroep.nl", "creation_time": "2004-12-30T22:23:32Z", "is_private": false}, {"count": 19, "tags": [], "creator": "pekka.panula@sofor.fi", "text": "(In reply to comment #18)\n> The behaviour I'm seeing is a duplicate of bug #31385\n> The patch proposed there works for me.\n\nI patched with patch from bug #31385 but i am seeing still missing pictures/very\nslow pages to load. There might be more cache related bugs than that one. So i\ndisabled mod_mem_cache again. I have noticed problems only with pictures, no\nhtml/css pages. \n\nHave you tried mod_cache with mod_deflate? Can anyone confirm that mod_deflate\nworks with mod_(mem_)cache?\n", "id": 69119, "time": "2004-12-31T16:05:11Z", "bug_id": 31822, "creation_time": "2004-12-31T16:05:11Z", "is_private": false, "attachment_id": null}]