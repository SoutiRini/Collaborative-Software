[{"count": 0, "tags": [], "bug_id": 53047, "attachment_id": null, "text": "When a JDBCRealm is created with the allRolesMode attribute set to \"authOnly\" a role table is still needed even though the documentation states: \"The alternative values are authOnly which means that the user must be authenticated but no check is made for assigned roles\". No check implies no role table needed. Hint: JDBCRealm.hasRole should probably always return true if the allRolesMode is set to \"authOnly\". The current workaround is to create a view over the user table with a fixed role name.", "id": 157701, "time": "2012-04-08T11:18:56Z", "creator": "dverbeek@hotmail.com", "creation_time": "2012-04-08T11:18:56Z", "is_private": false}, {"count": 1, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "id": 157741, "time": "2012-04-09T16:39:18Z", "bug_id": 53047, "creation_time": "2012-04-09T16:39:18Z", "is_private": false, "text": "So if you don't provide a userRoleTable, what do you get? NPE? SQLException?\n\nAre you using \"*\" as the user role in your <security-constraint>? If so, what do you have \"allRolesMode\" set to?"}, {"count": 2, "tags": [], "bug_id": 53047, "attachment_id": null, "id": 157770, "time": "2012-04-10T10:29:13Z", "creator": "dverbeek@hotmail.com", "creation_time": "2012-04-10T10:29:13Z", "is_private": false, "text": "When userRoleTable is not defined the JDBCRealm simply queries table \"null\".\nallRolesMode=\"authOnly\" ... It's in the title!\n\n<Realm className=\"org.apache.catalina.realm.JDBCRealm\" allRolesMode=\"authOnly\" digest=\"MD5\" driverName=\"org.postgresql.Driver\" connectionURL=\"jdbc:postgresql:mydb\" connectionName=\"myname\" connectionPassword=\"mypw\" userTable=\"tomcat_user\" userNameCol=\"login\" userCredCol=\"password\" userRoleTable=\"tomcat_role\" roleNameCol=\"role\" />\n\nApr 10, 2012 11:50:00 AM org.apache.catalina.realm.JDBCRealm getRoles\nSEVERE: Exception performing authentication\norg.postgresql.util.PSQLException: ERROR: relation \"tomcat_role\" does not exist\n\n<Realm className=\"org.apache.catalina.realm.JDBCRealm\" allRolesMode=\"authOnly\" digest=\"MD5\" driverName=\"org.postgresql.Driver\" connectionURL=\"jdbc:postgresql:mydb\" connectionName=\"myname\" connectionPassword=\"mypw\" userTable=\"tomcat_user\" userNameCol=\"login\" userCredCol=\"password\" />\n\nApr 10, 2012 12:02:55 PM org.apache.catalina.realm.JDBCRealm getRoles\nSEVERE: Exception performing authentication\norg.postgresql.util.PSQLException: ERROR: syntax error at or near \"null\"\n\n<security-constraint>\n   ...\n   <auth-constraint>\n      <description></description>\n      <role-name>*</role-name>\n   </auth-constraint>\n</security-constraint>"}, {"count": 3, "attachment_id": null, "creator": "chris@christopherschultz.net", "text": "(In reply to comment #2)\n> When userRoleTable is not defined the JDBCRealm simply queries table \"null\".\n> allRolesMode=\"authOnly\" ... It's in the title!\n\nDuh.\n\n> Apr 10, 2012 11:50:00 AM org.apache.catalina.realm.JDBCRealm getRoles\n> SEVERE: Exception performing authentication\n> org.postgresql.util.PSQLException: ERROR: relation \"tomcat_role\" does not exist\n\nCan you give the full stack trace, please?\n\n> Apr 10, 2012 12:02:55 PM org.apache.catalina.realm.JDBCRealm getRoles\n> SEVERE: Exception performing authentication\n> org.postgresql.util.PSQLException: ERROR: syntax error at or near \"null\"\n\nSame here, if it's different.\n\nAlso, can you try with DataSourceRealm? I know it's a bit more work to configure, but it might be a problem across both of these JDBC-based realms and we may as well fix it for both.", "id": 157790, "time": "2012-04-10T17:50:37Z", "bug_id": 53047, "creation_time": "2012-04-10T17:50:37Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "bug_id": 53047, "attachment_id": null, "id": 157791, "time": "2012-04-10T17:52:09Z", "creator": "chris@christopherschultz.net", "creation_time": "2012-04-10T17:52:09Z", "is_private": false, "text": "FWIW, JDBCRealm isn't appropriate for production use IMO. If you can, you should switch to DataSourceRealm which performs much better."}, {"count": 5, "attachment_id": null, "creator": "dverbeek@hotmail.com", "is_private": false, "id": 157792, "time": "2012-04-10T18:02:42Z", "bug_id": 53047, "creation_time": "2012-04-10T18:02:42Z", "tags": [], "text": "(In reply to comment #4)\n> FWIW, JDBCRealm isn't appropriate for production use IMO. If you can, you\n> should switch to DataSourceRealm which performs much better.\n\nSure, just using JDBCRealm for kickstarting and rapid prototyping my projects.\n\nThe stacktrace as requested:\n\nApr 10, 2012 11:44:38 AM org.apache.catalina.realm.JDBCRealm getRoles\nSEVERE: Exception performing authentication\norg.postgresql.util.PSQLException: ERROR: relation \"tomcat_role\" does not exist\n  Position: 18\n        at org.postgresql.core.v3.QueryExecutorImpl.receiveErrorResponse(QueryExecutorImpl.java:2103)\n        at org.postgresql.core.v3.QueryExecutorImpl.processResults(QueryExecutorImpl.java:1836)\n        at org.postgresql.core.v3.QueryExecutorImpl.execute(QueryExecutorImpl.java:257)\n        at org.postgresql.jdbc2.AbstractJdbc2Statement.execute(AbstractJdbc2Statement.java:512)\n        at org.postgresql.jdbc2.AbstractJdbc2Statement.executeWithFlags(AbstractJdbc2Statement.java:388)\n        at org.postgresql.jdbc2.AbstractJdbc2Statement.executeQuery(AbstractJdbc2Statement.java:273)\n        at org.apache.catalina.realm.JDBCRealm.getRoles(JDBCRealm.java:644)\n        at org.apache.catalina.realm.JDBCRealm.authenticate(JDBCRealm.java:436)\n        at org.apache.catalina.realm.JDBCRealm.authenticate(JDBCRealm.java:361)\n        at org.apache.catalina.authenticator.BasicAuthenticator.authenticate(BasicAuthenticator.java:181)\n        at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:528)\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:293)\n        at org.apache.coyote.http11.Http11AprProcessor.process(Http11AprProcessor.java:877)\n        at org.apache.coyote.http11.Http11AprProtocol$Http11ConnectionHandler.process(Http11AprProtocol.java:594)\n        at org.apache.tomcat.util.net.AprEndpoint$Worker.run(AprEndpoint.java:1675)\n        at java.lang.Thread.run(Thread.java:679)"}, {"count": 6, "tags": [], "bug_id": 53047, "attachment_id": null, "text": "It isn't quite that simple. The application may still make a call to isUserInRole().\n\nThere may well be a special case for each realm if all of the following are true:\n- AUTH_ONLY_MODE or STRICT_AUTH_ONLY_MODE\n- the Realm uses separate attributes to define the role store\n- the role store attributes are undefined\n\nIn this case, there is no need to look up the roles although an INFO log message on Realm start just to remind the admin what is going on wouldn't hurt.", "id": 159727, "time": "2012-06-05T23:15:12Z", "creator": "markt@apache.org", "creation_time": "2012-06-05T23:15:12Z", "is_private": false}, {"count": 7, "tags": [], "creator": "dverbeek@hotmail.com", "attachment_id": null, "id": 159744, "time": "2012-06-06T05:42:48Z", "bug_id": 53047, "creation_time": "2012-06-06T05:42:48Z", "is_private": false, "text": "(In reply to comment #6)\n> It isn't quite that simple. The application may still make a call to\n> isUserInRole().\n\nI suggest we define the result of that call as:\nAUTH_ONLY_MODE => true\nSTRICT_AUTH_ONLY_MODE => false\n\n> \n> There may well be a special case for each realm if all of the following are\n> true:\n> - AUTH_ONLY_MODE or STRICT_AUTH_ONLY_MODE\n> - the Realm uses separate attributes to define the role store\n> - the role store attributes are undefined\n\nHuh? #3 conflicts with #2.\n\n> In this case, there is no need to look up the roles although an INFO log\n> message on Realm start just to remind the admin what is going on wouldn't\n> hurt.\n\nWhy create log messages if it is configured not to use the roles table?"}, {"count": 8, "tags": [], "bug_id": 53047, "attachment_id": null, "id": 159770, "time": "2012-06-06T18:52:44Z", "creator": "markt@apache.org", "creation_time": "2012-06-06T18:52:44Z", "is_private": false, "text": "(In reply to comment #7)\n\n> I suggest we define the result of that call as:\n> AUTH_ONLY_MODE => true\n\nThe use of AUTH_ONLY mode doe snot preclude the user from being assigned a role and/or the web application testing for it.\n\n> STRICT_AUTH_ONLY_MODE => false\n\nWhile it is less likely, the same applies here too.\n\n> > - AUTH_ONLY_MODE or STRICT_AUTH_ONLY_MODE\n> > - the Realm uses separate attributes to define the role store\n> > - the role store attributes are undefined\n> \n> Huh? #3 conflicts with #2.\n\nNo they do. #2 means the Realm has the capability to define a separate role store. Not all realms do.\n\n#3 means that the above separate role store has not been defined.\n\n> Why create log messages if it is configured not to use the roles table?\n\nBecause it is sufficiently unusual that it is worth flagging up to an admin to confirm what is going on. It is just a single log message on Realm start."}, {"count": 9, "tags": [], "bug_id": 53047, "attachment_id": null, "id": 159771, "time": "2012-06-06T18:53:44Z", "creator": "markt@apache.org", "creation_time": "2012-06-06T18:53:44Z", "is_private": false, "text": "s/No they do./No they don't./"}, {"count": 10, "attachment_id": null, "creator": "markt@apache.org", "text": "In the end I opted to implement this for JDBCRealm and DatasourceRealm and without any logging on Realm start.\n\nThe fixed has been applied to trunk and 7.0.x and will be included in 7.0.28 onwards.\n\nThe fix has been proposed for 6.0.x.", "id": 159849, "time": "2012-06-09T20:38:59Z", "bug_id": 53047, "creation_time": "2012-06-09T20:38:59Z", "tags": [], "is_private": false}, {"count": 11, "tags": [], "bug_id": 53047, "attachment_id": null, "id": 160677, "time": "2012-07-16T20:10:37Z", "creator": "finkmani@googlemail.com", "creation_time": "2012-07-16T20:10:37Z", "is_private": false, "text": "I could not find the bug 53047 in the change log for 7.0.28 or 7.0.29. Is this still an issue? I need to implement the \"authOnly\" mode without checking any roles.\n\nGreetings from Germany\nManuel"}, {"count": 12, "tags": [], "text": "See comment #10\n\nThe changelog entry was missed. This has been fixed.\n\nhttp://svn.apache.org/viewvc?view=revision&revision=1348499\nhttp://svn.apache.org/viewvc?view=revision&revision=1366956", "is_private": false, "id": 160982, "creator": "markt@apache.org", "time": "2012-07-29T21:31:58Z", "bug_id": 53047, "creation_time": "2012-07-29T21:31:58Z", "attachment_id": null}, {"count": 13, "tags": [], "bug_id": 53047, "attachment_id": null, "id": 161706, "time": "2012-08-26T14:34:17Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2012-08-26T14:34:17Z", "is_private": false, "text": "Updated Tomcat 7 documentation for Realm in r1377445.\nThe documentation update is in 7.0.30 and later."}, {"count": 14, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "id": 161760, "time": "2012-08-28T00:16:39Z", "bug_id": 53047, "creation_time": "2012-08-28T00:16:39Z", "is_private": false, "text": "Fixed in Tomcat 6 with r1377888 + r1377917 (+ r1377918).\nIt will be in 6.0.36."}]