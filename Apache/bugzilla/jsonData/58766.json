[{"count": 0, "tags": [], "text": "Created attachment 33373\nthread dump\n\nAfter upgrading to Tomcat 8.0.29 (used Tomcat 7 before), starting from the second startup of the application, tomcat hangs when calling addWebapp.\n\nAt the first startup everything works OK. Just after stopping the service of my application and starting it again the problem will occur.\nI assume it's related to exploding the war file.\n\nThis happens on RedHat only (Suse works just fine).\n\nMoreover, when I start my application from script, rather than as a service, everything works well. \n\nAny idea what can I do to solve this?\n\nThanks.", "is_private": false, "id": 187111, "creator": "nitsan_daniel@bmc.com", "time": "2015-12-24T09:44:13Z", "bug_id": 58766, "creation_time": "2015-12-24T09:44:13Z", "attachment_id": 33373}, {"count": 1, "attachment_id": null, "bug_id": 58766, "text": "There is no evidence of a Tomcat bug in this report.\n\nPlease use the users mailing list to debug the problem you are seeing. If the conclusion from that is that there is a bug here then this issue can be re-opened and the necessary detail added.", "id": 187126, "time": "2015-12-26T08:49:17Z", "creator": "markt@apache.org", "creation_time": "2015-12-26T08:49:17Z", "tags": [], "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 58766, "is_private": false, "count": 2, "id": 187133, "time": "2015-12-26T23:49:13Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-12-26T23:49:13Z", "text": "Read about annotation scanning in this FAQ article:\nhttps://wiki.apache.org/tomcat/HowTo/FasterStartUp\n\nI agree with Mark that there is not enough evidence here.\n\nAnnotation scanning is expected to take notable time, -- as explained in the above FAQ entry.\n\nComments:\n\n1) If you can turn on debug logging and are able to provide an evidence that Tomcat performs the same work over and over, e.g. scans the same set of classes, this would be a valid issue.\n\nTomcat uses standard java.util.logging API as provided by Java Runtime. The Oracle JDK documentation describes how configure it. This configuration is available for standalone applications as well.\n\n2) A single thread dump does not say whether things change over time. The usual advice is to take several (3) dumps over time.\n\nhttps://wiki.apache.org/tomcat/FAQ/Troubleshooting_and_Diagnostics#Common_Troubleshooting_Scenario\n\n3) Current version of Tomcat 8 is 8.0.30.\n\n4) If you need help, ask on the Tomcat users' mailing list,\nhttps://wiki.apache.org/tomcat/FAQ/Tomcat_User"}, {"attachment_id": null, "tags": [], "bug_id": 58766, "is_private": false, "count": 3, "id": 187134, "time": "2015-12-27T07:27:34Z", "creator": "nitsan_daniel@bmc.com", "creation_time": "2015-12-27T07:27:34Z", "text": "The problem is not about Tomcat loading slowly.\nIt is just stuck.\n\nWe've committed several thread dumps, all show the same problem.\nMoreover, we've waiting for hours - tomcat won't return from this same method."}, {"count": 4, "tags": [], "bug_id": 58766, "is_private": false, "text": "It sounds like a duplicate of bug 57823.\n\n\nBy the way, regarding\norg.apache.catalina.startup.ContextConfig.processAnnotationsFile()\nmethod:\n\n1. This method needs debug logging. (There is none at the moment).\n2. The following condition needs first && second swapped:\n\n>> } else if (file.canRead() && file.getName().endsWith(\".class\")) {\n\nAs can be seen from stacktrace in Comment 0, the \"canRead()\" call is an I/O operation. This is more expensive than a filename check.\n\n\n> java.lang.Thread.State: RUNNABLE\n>   at java.io.UnixFileSystem.checkAccess(UnixFileSystem.java:-1)\n>   at java.io.File.canRead(File.java:768)\n>   at org.apache.catalina.startup.ContextConfig.processAnnotationsFile(ContextConfig.java:1992)\n>   at org.apache.catalina.startup.ContextConfig.processAnnotationsFile(ContextConfig.java:1988)\n>   at org.apache.catalina.startup.ContextConfig.processAnnotationsFile(ContextConfig.java:1988)\n>   <the same line (ContextConfig.java:1988) repeated a dozen of times...>", "id": 187137, "time": "2015-12-27T11:49:13Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-12-27T11:49:13Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 58766, "is_private": false, "text": "Created attachment 33377\nDebug logs", "id": 187141, "time": "2015-12-27T12:24:50Z", "creator": "nitsan_daniel@bmc.com", "creation_time": "2015-12-27T12:24:50Z", "attachment_id": 33377}, {"count": 6, "tags": [], "bug_id": 58766, "text": "(In reply to nitsan_daniel from comment #5)\n> Created attachment 33377 [details]\n> Debug logs\n\nIn tomcat.log.2:\n\nDec-27-2015 12:18:24 GMT DEBUG [org.apache.tomcat.util.scan.StandardJarScanner] [localhost-startStop-1] [DEBUG] - Scanning JAR [/WEB-INF/lib/perf4j-0.9.16.jar] from /WEB-INF/lib\n\nDec-27-2015 12:18:24 GMT DEBUG [org.apache.tomcat.util.scan.StandardJarScanner] [localhost-startStop-1] [DEBUG] - Scanning JAR [file:/opt/bmc/App_Visibility/portal/webapps/portal-console/WEB-INF/classes/] from classpath\n\nDec-27-2015 12:18:24 GMT DEBUG [org.apache.tomcat.util.scan.StandardJarScanner] [localhost-startStop-1] [DEBUG] - Scanning JAR [file:/] from classpath\n\nDec-27-2015 12:18:24 GMT DEBUG [org.apache.tomcat.util.scan.StandardJarScanner] [localhost-startStop-1] [DEBUG] - Scanning JAR [file:/opt/bmc/App_Visibility/common/lib/quartz-all-2.1.1.jar] from classpath\n\nThere is no hanging here (and I see no hanging in these debug logs), but \"file:/\" is certainly in class path.\n\nThus it is a duplicate of bug 57823\n\n*** This bug has been marked as a duplicate of bug 57823 ***", "id": 187143, "time": "2015-12-27T14:20:15Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-12-27T14:20:15Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 58766, "text": "How can this be the problem if it's working on the first start but fails starting from the second start and beyond.\nThe classpath is the same all the time.\nIf this was indeed the problem I would expect it to hang during the first start as well.", "id": 187165, "time": "2015-12-28T08:46:24Z", "creator": "nitsan_daniel@bmc.com", "creation_time": "2015-12-28T08:46:24Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 58766, "is_private": false, "text": "(In reply to nitsan_daniel from comment #7)\nMy guess:\n\nEither classpath is different between starts,\n\nor the current working directory is different between starts (as misconfigured classpath includes the current working directory),\n\nor some other reason (different file tree, e.g. some remote drives not mounted at boot time).", "id": 187175, "time": "2015-12-28T11:47:58Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-12-28T11:47:58Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 58766, "text": "We've found the our classpath starts with a colon (for instance, :/a.jar:/b.jar), after removing the leading colon Tomcat didn't scan [file:/] and the problem was resolved.", "count": 9, "id": 187206, "time": "2015-12-29T10:48:57Z", "creator": "nitsan_daniel@bmc.com", "creation_time": "2015-12-29T10:48:57Z", "is_private": false}, {"count": 10, "tags": [], "creator": "nitsan_daniel@bmc.com", "text": "Thank you guys for your help!", "id": 187207, "time": "2015-12-29T10:53:24Z", "bug_id": 58766, "creation_time": "2015-12-29T10:53:24Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "bug_id": 58766, "attachment_id": null, "is_private": false, "id": 187783, "time": "2016-01-18T03:41:34Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2016-01-18T03:41:34Z", "text": "(In reply to Konstantin Kolinko from comment #4)\n> It sounds like a duplicate of bug 57823.\n> \n> \n> By the way, regarding\n> org.apache.catalina.startup.ContextConfig.processAnnotationsFile()\n> method:\n> \n> 1. This method needs debug logging. (There is none at the moment).\n> 2. The following condition needs first && second swapped:\n> \n> >> } else if (file.canRead() && file.getName().endsWith(\".class\")) {\n> \n> As can be seen from stacktrace in Comment 0, the \"canRead()\" call is an I/O\n> operation. This is more expensive than a filename check.\n> \n\nThe above improvements were implemented and will be in 7.0.68, 8.0.31, 9.0.0.M2 onwards.\n(r1725165/r1725167/r1725170)"}]