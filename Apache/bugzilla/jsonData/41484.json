[{"count": 0, "tags": [], "bug_id": 41484, "attachment_id": null, "text": "Hi,\n\nI have a need to use caching to improve performance when delivering for example\nbanners. Since query-string parameters are used to associate unique\nmeta-information to each request mod_cache will treat each request as a new\nrequest. Since mod_cache is run as a quick handler it is not possible to use\nmod_rewrite to remove the query-string part of the request.\n\nI believe this should be considered a relevant scenario, and that an option to\ndisable this behaviour is motivated.\n\nI am including a patch for this below.\n\nKind regards,\nFredrik Widlund\n\n--- cache_storage.c.orig        Sun Jan 28 20:12:51 2007\n+++ cache_storage.c     Sun Jan 28 20:25:01 2007\n@@ -331,10 +331,16 @@\n apr_status_t cache_generate_key_default(request_rec *r, apr_pool_t* p,\n                                         char**key)\n {\n+    cache_server_conf *conf;\n     char *port_str, *hn, *lcs;\n     const char *hostname, *scheme;\n     int i;\n \n+    /* Get the module configuration. We need this for the CacheIgnoreQueryString\n+     * below */\n+    conf = (cache_server_conf *) ap_get_module_config(r->server->module_config,\n+                                                     &cache_module);\n+\n     /*\n      * Use the canonical name to improve cache hit rate, but only if this is\n      * not a proxy request or if this is a reverse proxy request.\n@@ -424,10 +430,14 @@\n         /* Use the server port */\n         port_str = apr_psprintf(p, \":%u\", ap_get_server_port(r));\n     }\n-\n-    /* Key format is a URI */\n-    *key = apr_pstrcat(p, scheme, \"://\", hostname, port_str,\n-                       r->parsed_uri.path, \"?\", r->args, NULL);\n+    \n+    /* Key format is a URI, optionally without the query-string */\n+    if (conf->ignorequerystring)\n+       *key = apr_pstrcat(p, scheme, \"://\", hostname, port_str,\n+                          r->parsed_uri.path, \"?\", NULL);\n+    else\n+       *key = apr_pstrcat(p, scheme, \"://\", hostname, port_str,\n+                          r->parsed_uri.path, \"?\", r->args, NULL);\n \n     return APR_SUCCESS;\n }\n--- mod_cache.c.orig    Sun Jan 28 20:32:48 2007\n+++ mod_cache.c Sun Jan 28 20:32:32 2007\n@@ -433,7 +433,8 @@\n         /* if a Expires header is in the past, don't cache it */\n         reason = \"Expires header already expired, not cacheable\";\n     }\n-    else if (r->args && exps == NULL) {\n+    else if (!conf->ignorequerystring &&\n+            r->parsed_uri.query && exps == NULL) {\n         /* if query string present but no expiration time, don't cache it\n          * (RFC 2616/13.9)\n          */\n@@ -889,6 +890,8 @@\n     ps->no_last_mod_ignore = 0;\n     ps->ignorecachecontrol = 0;\n     ps->ignorecachecontrol_set = 0;\n+    ps->ignorequerystring = 0;\n+    ps->ignorequerystring_set = 0;\n     ps->store_private = 0;\n     ps->store_private_set = 0;\n     ps->store_nostore = 0;\n@@ -929,6 +932,10 @@\n         (overrides->ignorecachecontrol_set == 0)\n         ? base->ignorecachecontrol\n         : overrides->ignorecachecontrol;\n+    ps->ignorequerystring  =\n+       (overrides->ignorequerystring_set == 0)\n+       ? base->ignorequerystring\n+       : overrides->ignorequerystring;\n     ps->store_private  =\n         (overrides->store_private_set == 0)\n         ? base->store_private\n@@ -970,6 +977,19 @@\n     return NULL;\n }\n \n+static const char *set_cache_ignore_querystring(cmd_parms *parms,\n+                                               void *dummy, int flag)\n+{\n+    cache_server_conf *conf;\n+    \n+    conf =\n+       (cache_server_conf *)ap_get_module_config(parms->server->module_config,\n+                                                 &cache_module);\n+    conf->ignorequerystring = flag;\n+    conf->ignorequerystring_set = 1;\n+    return NULL;\n+}\n+\n static const char *set_cache_store_private(cmd_parms *parms, void *dummy,\n                                            int flag)\n {\n@@ -1159,6 +1179,9 @@\n     AP_INIT_FLAG(\"CacheIgnoreCacheControl\", set_cache_ignore_cachecontrol,\n                  NULL, RSRC_CONF,\n                  \"Ignore requests from the client for uncached content\"),\n+    AP_INIT_FLAG(\"CacheIgnoreQueryString\", set_cache_ignore_querystring,\n+                NULL, RSRC_CONF,\n+                \"Ignore query-string when caching\"),\n     AP_INIT_FLAG(\"CacheStorePrivate\", set_cache_store_private,\n                  NULL, RSRC_CONF,\n                  \"Ignore 'Cache-Control: private' and store private content\"),\n--- mod_cache.h.orig    Sun Jan 28 20:26:16 2007\n+++ mod_cache.h Sun Jan 28 20:27:29 2007\n@@ -138,6 +138,9 @@\n     /** ignore client's requests for uncached responses */\n     int ignorecachecontrol;\n     int ignorecachecontrol_set;\n+    /** ignore query-string when caching */\n+    int ignorequerystring;\n+    int ignorequerystring_set;\n     /** ignore Cache-Control: private header from server */\n     int store_private;\n     int store_private_set;", "id": 98655, "time": "2007-01-28T12:52:34Z", "creator": "fredrik.widlund@qbrick.com", "creation_time": "2007-01-28T12:52:34Z", "is_private": false}, {"attachment_id": 19473, "tags": [], "creator": "fredrik.widlund@qbrick.com", "text": "Created attachment 19473\nPatch to add CacheIgnoreQueryString option", "count": 1, "id": 98657, "time": "2007-01-28T12:54:42Z", "bug_id": 41484, "creation_time": "2007-01-28T12:54:42Z", "is_private": false}, {"count": 2, "tags": [], "creator": "rpluem@apache.org", "text": "The patch looks good in general. Please fix the following things such that it\ncan be appplied:\n\n1. Provide a version of this patch against trunk.\n2. Provide a patch for the documentation (docs/manual/mod/mod_cache.xml) to\n   document the new directive.\n3. Provide the diff files in unix format (only LF at the end) if possible.\n   Otherwise just mention that they are in DOS format (CR-LF).", "id": 98961, "time": "2007-02-05T01:19:19Z", "bug_id": 41484, "creation_time": "2007-02-05T01:19:19Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "rpluem@apache.org", "text": "Forgot one thing:\n\nPlease put\n\nint ignorequerystring;\nint ignorequerystring_set;\n\nat the end of the cache_server_conf struct to avoid binary incompatibility and\nthus the need for a major bump. A patch that creates binary incompatibility\ncannot be backported to 2.2.x.\nPutting them to the end of the structure only requires a minor bump which can be\nbackported (include/ap_mmn.h).", "id": 98962, "time": "2007-02-05T01:26:55Z", "bug_id": 41484, "creation_time": "2007-02-05T01:26:55Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 41484, "text": "Created attachment 19527\nPatch against trunk adding IgnoreQueryString directive", "id": 99010, "time": "2007-02-06T05:00:41Z", "creator": "fredrik.widlund@qbrick.com", "creation_time": "2007-02-06T05:00:41Z", "is_private": false, "attachment_id": 19527}, {"count": 5, "tags": [], "bug_id": 41484, "text": "Created attachment 19528\nPatch against trunk adding documentation for IgnoreQueryString", "id": 99011, "time": "2007-02-06T05:02:18Z", "creator": "fredrik.widlund@qbrick.com", "creation_time": "2007-02-06T05:02:18Z", "is_private": false, "attachment_id": 19528}, {"count": 6, "attachment_id": null, "bug_id": 41484, "is_private": false, "id": 99013, "time": "2007-02-06T05:47:19Z", "creator": "fredrik.widlund@qbrick.com", "creation_time": "2007-02-06T05:47:19Z", "tags": [], "text": "1/2/3:\nDone\n\nKind regards,\nFredrik Widlund"}, {"count": 7, "tags": [], "bug_id": 41484, "attachment_id": null, "text": "Committed with some minor style fixes as r504183\n(http://svn.apache.org/viewvc?view=rev&revision=504183) to trunk. For future\npatches please ensure that they follow the style guide\n(http://httpd.apache.org/dev/styleguide.html) (especially no tabs). Thanks for\nsubmitting the patch.", "id": 99020, "time": "2007-02-06T07:59:07Z", "creator": "rpluem@apache.org", "creation_time": "2007-02-06T07:59:07Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 41484, "text": "Proposed for backport to 2.2.x as r535911\n(http://svn.apache.org/viewvc?view=rev&rev=535911).", "count": 8, "id": 102909, "time": "2007-05-07T08:48:47Z", "creator": "rpluem@apache.org", "creation_time": "2007-05-07T08:48:47Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 41484, "text": "Backported to 2.2.x as r539111 (http://svn.apache.org/viewvc?view=rev&rev=539111).", "id": 103318, "time": "2007-05-17T14:20:26Z", "creator": "rpluem@apache.org", "creation_time": "2007-05-17T14:20:26Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 41484, "is_private": false, "text": "I am pretty sure this was not committed to the 2.2.4 release. Is this version\nset correctly?", "id": 106186, "time": "2007-08-02T12:20:31Z", "creator": "thomas.vdvelde@gmail.com", "creation_time": "2007-08-02T12:20:31Z", "attachment_id": null}]