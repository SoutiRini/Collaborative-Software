[{"count": 0, "tags": [], "creator": "apache@fh.net", "text": "0. Description of problem\n\nWhen accessing a softlinked file >4GB residing on a CIFS share, the action fails. httpd will log the action properly in the access log, but will close the connection to remote without sending the file.\n\nThe mount itself was eliminiated from the probable issue points, since access to the file via ie (S)FTP, cp and such works flawlessly.\n\nThe same file residing on a local FS gives no problem to apache.\n\n\n1. Setup\n\nHP DL380G3 with RedHat EL4 (2.6.9-55.0.2.ELsmp)\nNAS Lacie 2TB\nApache 2.2.9\n\n\n2. Mount command\n\nmount -t cifs -o username=me,password=notme,rsize=32768,wsize=32768,r //192.168.1.250/source /nas/target\n\n\n3. Output of wget access to the file:\n\nvader:root:/tmp: wget http://www.nk.tc/4.7gb_mounted_file\n--16:14:14--  http://www.nk.tc/4.7gb_mounted_file\n           => `4.7gb_mounted_file'\nResolving www.nk.tc... 217.147.216.100\nConnecting to www.nk.tc|217.147.216.100|:80... connected.\nHTTP request sent, awaiting response...\n  HTTP/1.1 200 OK\n  Date: Thu, 16 Oct 2008 14:14:14 GMT\n  Server: Apache/2.2.9 (Unix) mod_ssl/2.2.9 OpenSSL/0.9.8e PHP/5.2.3\n  Last-Modified: Tue, 30 Sep 2008 04:04:48 GMT\n  ETag: \"4238c6b-117e5d961-4581515ac1800\"\n  Accept-Ranges: bytes\n  Content-Length: 4695906657\n  Keep-Alive: timeout=15, max=1000\n  Connection: Keep-Alive\n  Content-Type: text/plain\nLength: 4,695,906,657 (4.4G) [text/plain]\n\n 0% [                                                                                             ] 0             --.--K/s\n\n16:14:14 (0.00 B/s) - Connection closed at byte 0. Retrying.\n\n\n[Note: The above noted filesize is correct.]\n\n\n\n4. Access log entry of above wget action:\n\nvader - - [16/Oct/2008:16:14:15 +0200] \"GET /4.7gb_mounted_file HTTP/1.0\" 200 4695906657 \"-\" \"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1) [en]\"\n\n[Note: The above noted filesize is correct.]\n\n\n\n5. Configure options used to build the binary\n\n./configure --prefix=/usr/local/apache --with-mpm=mpmt_pthread --with-mpm=prefork --enable-rewrite --enable-authn-anon --enable-mime-magic --enable-expires --enable-headers --enable-unique-id --enable-ssl --with-ssl=/usr/local/openssl --disable-info --enable-suexec --with-suexec-caller=root --with-suexec-uidmin=100 --with-suexec-gidmin=100 --with-suexec-logfile=suexec.log --with-suexec-userdir=*cgi-bin* --enable-cgi --enable-vhost-alias --enable-file-cache --enable-cache --enable-disk-cache --enable-mem-cache --enable-deflate --enable-usertrack --enable-vhost-alias --enable-rewrite\n\n\n\n6. Output of apachectl\n\nvader:root:/usr/local/apache/conf: apachectl -V\nServer version: Apache/2.2.9 (Unix)\nServer built:   Aug 13 2008 14:52:17\nServer's Module Magic Number: 20051115:15\nServer loaded:  APR 1.3.0, APR-Util 1.3.0\nCompiled using: APR 1.3.0, APR-Util 1.3.0\nArchitecture:   32-bit\nServer MPM:     Prefork\n  threaded:     no\n    forked:     yes (variable process count)\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"/usr/local/apache\"\n -D SUEXEC_BIN=\"/usr/local/apache/bin/suexec\"\n -D DEFAULT_PIDLOG=\"logs/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_LOCKFILE=\"logs/accept.lock\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"\n\nvader:root:/usr/local/apache/conf: apachectl -l\nCompiled in modules:\n  core.c\n  mod_authn_file.c\n  mod_authn_anon.c\n  mod_authn_default.c\n  mod_authz_host.c\n  mod_authz_groupfile.c\n  mod_authz_user.c\n  mod_authz_default.c\n  mod_auth_basic.c\n  mod_file_cache.c\n  mod_cache.c\n  mod_disk_cache.c\n  mod_mem_cache.c\n  mod_include.c\n  mod_filter.c\n  mod_deflate.c\n  mod_log_config.c\n  mod_env.c\n  mod_mime_magic.c\n  mod_expires.c\n  mod_headers.c\n  mod_usertrack.c\n  mod_unique_id.c\n  mod_setenvif.c\n  mod_ssl.c\n  prefork.c\n  http_core.c\n  mod_mime.c\n  mod_status.c\n  mod_autoindex.c\n  mod_asis.c\n  mod_suexec.c\n  mod_cgi.c\n  mod_vhost_alias.c\n  mod_negotiation.c\n  mod_dir.c\n  mod_actions.c\n  mod_userdir.c\n  mod_alias.c\n  mod_rewrite.c\n  mod_so.c", "id": 121626, "time": "2008-10-16T07:45:33Z", "bug_id": 46027, "creation_time": "2008-10-16T07:45:33Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 46027, "attachment_id": null, "text": "Have you set EnableMMAP and EnableSendfile to off for this CIFS mount? It is known that these OS optimizations sometimes fail with network filesystems like NFS and CIFS. This is not bug in httpd but either in the OS drivers or the NAS protocol itself.", "id": 121628, "time": "2008-10-16T07:51:31Z", "creator": "rpluem@apache.org", "creation_time": "2008-10-16T07:51:31Z", "is_private": false}, {"count": 2, "text": "EnableMMAP did the trick.\n\nApologies for having opened a bug about it. I simply wasn\u00b4t aware of the feature and long hours googling didn\u00b4t results in any information.\n\nI have no testbed for other shares, but from what I see here with our environment, wouldn\u00b4t it be beneficial to have httpd disable memory mapping when accessing files on shares ?  Just my $0.02 ;)\n\nThanks again", "bug_id": 46027, "attachment_id": null, "id": 121649, "time": "2008-10-16T22:47:30Z", "creator": "apache@fh.net", "creation_time": "2008-10-16T22:47:30Z", "tags": [], "is_private": false}]