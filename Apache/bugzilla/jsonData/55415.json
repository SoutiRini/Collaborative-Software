[{"count": 0, "tags": [], "bug_id": 55415, "text": "1. Overview Description\n\n  If ProxyErrorOverride is On, proxy's not found error page should be\n  overridden by ErrorDocument 404. But actually a proxy loop occurs\n  if ErrorDocument 404 points to a url of FastCGI server script.\n\n  The following is my test environment for this issue.\n\n  - apache 2.4.6\n  - mod_proxy_fcgi (reverse proxy)\n  - php-fpm (PHP 5.5.1, FastCGI server)\n\n  And these directives were added to httpd.conf to forward requests for php scripts.\n\n  [ httpd.conf ]\n  ErrorDocument 404 /error.php\n  ProxyErrorOverride On\n  ProxyPassMatch ^/(.+\\.php)$ fcgi://localhost:9010/home/httpd/htdocs/$1\n\n  This is the content of error.php.\n\n  [ error.php ]\n  <?php\n  echo \"No such file.<br>\";\n\n  In the environment, when I accessed a url that does not exist,\n  I got the next message after a while without overriding by ErrorDocument 404.\n\n  [ error page ]\n  Not Found\n  The requested URL /xxx.php was not found on this server.\n  Additionally, a 500 Internal Server Error error was encountered\n  while trying to use an ErrorDocument to handle the request.\n  \n  And I got the following message in apache's error_log at the same time.\n\n  [ error_log ]\n  [Wed Aug 14 17:46:33.144561 2013] [proxy_fcgi:error] [pid 29478:tid 1111763264] [client 192.168.1.46:2322] AH01071: Got error 'Primary script unknown\\n'\n  [Wed Aug 14 17:46:37.258829 2013] [core:error] [pid 29478:tid 1111763264] [client 192.168.1.46:2322] AH00124: Request exceeded the limit of 10 internal redirects due to probable configuration error. Use 'LimitInternalRecursion' to increase the limit if necessary. Use 'LogLevel debug' to get a backtrace.\n\n  Besides, in access_log of FastCGI server, I got ten success messages for error.php.\n\n  [ access_log ]\n  192.168.1.46  [14/08/2013:17:46:33 +0900] \"GET /error.php\" 200 0.325 256 0.00% \"Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.95 Safari/537.36\"\n  ...\n  (10 times)\n\n  In short, even though each ErrorDocument's request is success,\n  it is repeated until reaching ProxyMaxForwards's default value(10). \n\n  I checked modules/proxy/mod_proxy_fcgi.c to find the cause of this behavior\n  and found that sending ErrorDocument is controlled by script_error_status in\n  dispatch().\n\n  First script_error_status is initialized with HTTP_OK in dispatch().\n\n  [ dispatch() ]\n  551     int script_error_status = HTTP_OK;\n\n  When you access a url that does not exist on FastCGI server,\n  r->status has been NotFound(404).\n\n  Next, only in case that ProxyErrorOverride is On and r->status is error,\n  r->status's value(404) is assigned to script_error_status and r->status\n  is set to HTTP_OK.\n\n  [ dispatch() ]\n  759                             if (conf->error_override &&\n  760                                 ap_is_HTTP_ERROR(r->status)) {\n  761                                 /*\n  762                                  * set script_error_status to discard\n  763                                  * everything after the headers\n  764                                  */\n  765                                 script_error_status = r->status;\n  766                                 /*\n  767                                  * prevent ap_die() from treating this as a\n  768                                  * recursive error, initially:\n  769                                  */\n  770                                 r->status = HTTP_OK;\n  771                             }\n\n  Because script_error_status(404) is not HTTP_OK, ap_die() is called\n  to send ErrorDocument.\n\n  [ dispatch() ]\n  865     if (script_error_status != HTTP_OK) {\n  866         ap_die(script_error_status, r); /* send ErrorDocument */\n  867     }\n\n  In ap_die() of modules/http/http_request.c, r->status is rewritten\n  with scrip_error_status's value(404).\n\n  [ ap_die() ]\n   76 AP_DECLARE(void) ap_die(int type, request_rec *r)\n  ...\n  144\n  145     r->status = type;\n  146\n\n  Because ErrorDocument points to local url, ap_internal_redirect() is called.\n\n  [ ap_die() ]\n  181         else if (custom_response[0] == '/') {\n  ...\n  200             r->method = \"GET\";\n  201             r->method_number = M_GET;\n  202             ap_internal_redirect(custom_response, r);\n  203             return;\n  204         }\n\n  r->status's value(404) is kept until this request reaches\n  to dispatch() of mod_proxy_fcgi.c.\n\n  Because dispatch() has no code that initializes r->status's value(404),\n  script_error_status's value will be 404 again and internal forwarding\n  is repeated until ProxyMaxForwards's value again.\n  \n  It seems that this is why the proxy loop occurs.\n\n2. Steps to Reproduce\n\n  1) Run FastCGI(php-fpm) server on localhost:9010.\n     Its document root is /home/httpd/htdocs.\n\n  2) Place error.php in the document root.\n     <?php\n     echo \"No such file.<br>\";\n  \n  3) Add these directives to httpd.conf.\n    ErrorDocument 404 /error.php\n    ProxyErrorOverride On\n    ProxyPassMatch ^/(.+\\.php)$ fcgi://localhost:9010/home/httpd/htdocs/$1\n  \n  4) Start or restart Apache2.\n  \n  5) Access a url that does not exist.\n    http://FQDN/not_exist.html\n    A proxy loop will be detected.\n\n3. Actual Results\n\n  A proxy loop occurs.\n\n4. Expected Results\n\n  FastCGI's not found error page is overrided by ErrorDocument 404.", "id": 169430, "time": "2013-08-14T09:29:51Z", "creator": "is_asf_bugzilla@yahoo.co.jp", "creation_time": "2013-08-14T09:29:51Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 55415, "is_private": false, "text": "Created attachment 30744\nPatch for mod_proxy_fcgi.c\n\nI attached my patch to resolve this problem.\nThis patch was generated against Apache 2.4.6.\n\nThank you for your consideration, \nYasuaki", "id": 169629, "time": "2013-08-21T06:52:22Z", "creator": "is_asf_bugzilla@yahoo.co.jp", "creation_time": "2013-08-21T06:52:22Z", "attachment_id": 30744}, {"attachment_id": null, "tags": [], "creator": "rhavenn@rhavenn.net", "text": "I can confirm this issue. Any plans on fixing this loop?\n\nSame exact config in a virtualhost with ErrorDocument set to a PHP file, ProxyErrorOverride On and ProxyPassMatch.", "count": 2, "id": 176987, "time": "2014-08-07T18:00:37Z", "bug_id": 55415, "creation_time": "2014-08-07T18:00:37Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 55415, "is_private": false, "text": "A workaround / fix for this is to set a sub-directory where ErrorOverride is disabled by using <Location > . For example:\n\nProxyErrorOverride On\nErrorDocument 404 /http_errors/404.php\n\n<Location /http_errors/>\n  ProxyErrorOverride Off\n</Location>", "id": 181736, "time": "2015-03-13T16:28:58Z", "creator": "rhavenn@rhavenn.net", "creation_time": "2015-03-13T16:28:58Z", "attachment_id": null}, {"attachment_id": 34048, "tags": [], "creator": "toscano.luca@gmail.com", "text": "Created attachment 34048\nApply ProxyErrorOverride logic only to initial requests", "count": 4, "id": 192452, "time": "2016-07-17T14:56:09Z", "bug_id": 55415, "creation_time": "2016-07-17T14:56:09Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 55415, "text": "Thanks a lot for the very precise bug report. I attached a patch that should solve the problem, namely breaking the loop that Yasuaki pointed out.\n\nYasuaki: I tried your patch with the current http-trunk but it didn't return the correct error code with ProxyErrorOverride On (200 instead of 404). Not sure if I am missing something, please let me know in case!", "id": 192453, "time": "2016-07-17T14:56:40Z", "creator": "toscano.luca@gmail.com", "creation_time": "2016-07-17T14:56:40Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 55415, "attachment_id": null, "text": "Proposed a change in httpd-trunk: http://svn.apache.org/r1753167\n\nWill also propose a backport after review.", "id": 192475, "time": "2016-07-18T08:03:54Z", "creator": "toscano.luca@gmail.com", "creation_time": "2016-07-18T08:03:54Z", "is_private": false}, {"count": 7, "tags": [], "creator": "toscano.luca@gmail.com", "attachment_id": null, "text": "Backported to 2.4.x with http://svn.apache.org/r1757671", "id": 193326, "time": "2016-08-25T12:58:01Z", "bug_id": 55415, "creation_time": "2016-08-25T12:58:01Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 55415, "attachment_id": null, "text": "Hi, I have updated Apache to 2.4.5 which has this fix incorporated. It works perfectly when I specify ProxyErrorOverride On and ErrorDocument 404 /404.php for example.\n\nHowever, Apache2 still seems to crash with concurrent requests are sent. I tried a stress test using JMeter with 300 concurrent queries over 3 seconds, and after the first 10 threads my server seems to conk out.\n\nMeanwhile, if I point JMeter to a non-404 PHP page (which is proxied through PHPFPM as well), I have no issues.\n\nJust wondering if error handling isn't as graceful as it seems?", "id": 198124, "time": "2017-04-02T16:53:07Z", "creator": "trenzterra@gmail.com", "creation_time": "2017-04-02T16:53:07Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 55415, "text": "(In reply to trenzterra from comment #8)\n> Hi, I have updated Apache to 2.4.5 which has this fix incorporated. It works\n> perfectly when I specify ProxyErrorOverride On and ErrorDocument 404\n> /404.php for example.\n> \n> However, Apache2 still seems to crash with concurrent requests are sent. I\n> tried a stress test using JMeter with 300 concurrent queries over 3 seconds,\n> and after the first 10 threads my server seems to conk out.\n> \n> Meanwhile, if I point JMeter to a non-404 PHP page (which is proxied through\n> PHPFPM as well), I have no issues.\n> \n> Just wondering if error handling isn't as graceful as it seems?\n\nThis sounds a bit strange, even if setting a 404.php page means effectively issuing two requests to the backend (the original php request that ends up in a 404 and the 404.php page itself). I have a couple of questions to expand the \"conk out\" description:\n\n1) What is the server-status when you observe httpd not working anymore? Do you notice any weird change in process/threads state?\n\n2) Which mpm are you running? What is the config used?\n\n3) Anything useful in the error.log? (Maybe even increasing the log verbosity with LogLevel if you can - https://httpd.apache.org/docs/2.4/mod/core.html#loglevel).\n\n4) Have you tried a more recent version of httpd to see if you are still able to reproduce? 2.4.5 is a bit old and it might carry performance problems that have been resolved during the recent years.\n\nThanks!", "id": 198144, "time": "2017-04-04T11:05:28Z", "creator": "toscano.luca@gmail.com", "creation_time": "2017-04-04T11:05:28Z", "is_private": false, "attachment_id": null}]