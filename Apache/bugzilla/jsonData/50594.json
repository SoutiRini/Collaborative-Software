[{"count": 0, "tags": [], "creator": "marcelo@tpn.com.br", "attachment_id": null, "id": 143364, "time": "2011-01-15T17:37:33Z", "bug_id": 50594, "creation_time": "2011-01-15T17:37:33Z", "is_private": false, "text": "I'm using an experimental mpm called peruser (http://www.peruser.org/).\n\nMy server is segfaulting, but I believe that there is some problem with apr_palloc, because the last 5 frames in backtrace are from original Apache source.\n\nI'm using Apache 2.2.16 version, but this problem also happened with Apache 2.2.17 and APR 1.4.2.\n\nHere is the backtrace:\n\n# gdb httpd /tmp/httpd.core\nGNU gdb 6.1.1 [FreeBSD]\nCopyright 2004 Free Software Foundation, Inc.\nGDB is free software, covered by the GNU General Public License, and you are\nwelcome to change it and/or distribute copies of it under certain conditions.\nType \"show copying\" to see the conditions.\nThere is absolutely no warranty for GDB.  Type \"show warranty\" for details.\nThis GDB was configured as \"amd64-marcel-freebsd\"...\nCore was generated by `httpd'.\nProgram terminated with signal 11, Segmentation fault.\nReading symbols from /lib/libm.so.5...done.\nLoaded symbols for /lib/libm.so.5\nReading symbols from /usr/local/lib/libpcre.so.0...done.\nLoaded symbols for /usr/local/lib/libpcre.so.0\nReading symbols from /usr/local/lib/libaprutil-1.so.3...done.\nLoaded symbols for /usr/local/lib/libaprutil-1.so.3\nReading symbols from /usr/local/lib/libdb-4.2.so.2...done.\nLoaded symbols for /usr/local/lib/libdb-4.2.so.2\nReading symbols from /usr/local/lib/libgdbm.so.3...done.\nLoaded symbols for /usr/local/lib/libgdbm.so.3\nReading symbols from /usr/local/lib/libexpat.so.6...done.\nLoaded symbols for /usr/local/lib/libexpat.so.6\nReading symbols from /usr/local/lib/libiconv.so.3...done.\nLoaded symbols for /usr/local/lib/libiconv.so.3\nReading symbols from /usr/local/lib/libapr-1.so.4...done.\nLoaded symbols for /usr/local/lib/libapr-1.so.4\nReading symbols from /lib/libcrypt.so.5...done.\nLoaded symbols for /lib/libcrypt.so.5\nReading symbols from /lib/libthr.so.3...done.\nLoaded symbols for /lib/libthr.so.3\nReading symbols from /lib/libc.so.7...done.\nLoaded symbols for /lib/libc.so.7\nReading symbols from /usr/local/libexec/apache22/mod_authn_file.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_authn_file.so\nReading symbols from /usr/local/libexec/apache22/mod_authn_dbm.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_authn_dbm.so\nReading symbols from /usr/local/libexec/apache22/mod_authn_anon.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_authn_anon.so\nReading symbols from /usr/local/libexec/apache22/mod_authn_default.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_authn_default.so\nReading symbols from /usr/local/libexec/apache22/mod_authn_alias.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_authn_alias.so\nReading symbols from /usr/local/libexec/apache22/mod_authz_host.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_authz_host.so\nReading symbols from /usr/local/libexec/apache22/mod_authz_groupfile.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_authz_groupfile.so\nReading symbols from /usr/local/libexec/apache22/mod_authz_user.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_authz_user.so\nReading symbols from /usr/local/libexec/apache22/mod_authz_dbm.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_authz_dbm.so\nReading symbols from /usr/local/libexec/apache22/mod_authz_owner.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_authz_owner.so\nReading symbols from /usr/local/libexec/apache22/mod_authz_default.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_authz_default.so\nReading symbols from /usr/local/libexec/apache22/mod_auth_basic.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_auth_basic.so\nReading symbols from /usr/local/libexec/apache22/mod_auth_digest.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_auth_digest.so\nReading symbols from /usr/local/libexec/apache22/mod_file_cache.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_file_cache.so\nReading symbols from /usr/local/libexec/apache22/mod_include.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_include.so\nReading symbols from /usr/local/libexec/apache22/mod_filter.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_filter.so\nReading symbols from /usr/local/libexec/apache22/mod_charset_lite.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_charset_lite.so\nReading symbols from /usr/local/libexec/apache22/mod_deflate.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_deflate.so\nReading symbols from /lib/libz.so.5...done.\nLoaded symbols for /lib/libz.so.5\nReading symbols from /usr/local/libexec/apache22/mod_log_config.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_log_config.so\nReading symbols from /usr/local/libexec/apache22/mod_logio.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_logio.so\nReading symbols from /usr/local/libexec/apache22/mod_env.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_env.so\nReading symbols from /usr/local/libexec/apache22/mod_mime_magic.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_mime_magic.so\nReading symbols from /usr/local/libexec/apache22/mod_expires.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_expires.so\nReading symbols from /usr/local/libexec/apache22/mod_headers.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_headers.so\nReading symbols from /usr/local/libexec/apache22/mod_setenvif.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_setenvif.so\nReading symbols from /usr/local/libexec/apache22/mod_version.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_version.so\nReading symbols from /usr/local/libexec/apache22/mod_mime.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_mime.so\nReading symbols from /usr/local/libexec/apache22/mod_status.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_status.so\nReading symbols from /usr/local/libexec/apache22/mod_autoindex.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_autoindex.so\nReading symbols from /usr/local/libexec/apache22/mod_asis.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_asis.so\nReading symbols from /usr/local/libexec/apache22/mod_cgi.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_cgi.so\nReading symbols from /usr/local/libexec/apache22/mod_vhost_alias.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_vhost_alias.so\nReading symbols from /usr/local/libexec/apache22/mod_negotiation.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_negotiation.so\nReading symbols from /usr/local/libexec/apache22/mod_dir.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_dir.so\nReading symbols from /usr/local/libexec/apache22/mod_actions.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_actions.so\nReading symbols from /usr/local/libexec/apache22/mod_alias.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_alias.so\nReading symbols from /usr/local/libexec/apache22/mod_rewrite.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_rewrite.so\nReading symbols from /usr/local/libexec/apache22/libphp5.so...done.\nLoaded symbols for /usr/local/libexec/apache22/libphp5.so\nReading symbols from /usr/local/lib/libxml2.so.5...done.\nLoaded symbols for /usr/local/lib/libxml2.so.5\nReading symbols from /usr/local/libexec/apache22/mod_rpaf-2.0.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_rpaf-2.0.so\nReading symbols from /usr/local/libexec/apache22/mod_log_rotate.so...done.\nLoaded symbols for /usr/local/libexec/apache22/mod_log_rotate.so\nReading symbols from /usr/local/lib/php/20090626/eaccelerator.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/eaccelerator.so\nReading symbols from /usr/local/lib/php/20090626/ioncube/ioncube_loader.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/ioncube/ioncube_loader.so\nReading symbols from /usr/local/lib/php/20090626/ixed.5.3.fre...done.\nLoaded symbols for /usr/local/lib/php/20090626/ixed.5.3.fre\nReading symbols from /usr/local/lib/php/20090626/bcmath.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/bcmath.so\nReading symbols from /usr/local/lib/php/20090626/bz2.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/bz2.so\nReading symbols from /usr/lib/libbz2.so.4...done.\nLoaded symbols for /usr/lib/libbz2.so.4\nReading symbols from /usr/local/lib/php/20090626/calendar.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/calendar.so\nReading symbols from /usr/local/lib/php/20090626/ctype.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/ctype.so\nReading symbols from /usr/local/lib/php/20090626/curl.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/curl.so\nReading symbols from /usr/local/lib/libcurl.so.6...done.\nLoaded symbols for /usr/local/lib/libcurl.so.6\nReading symbols from /usr/lib/libssl.so.6...done.\nLoaded symbols for /usr/lib/libssl.so.6\nReading symbols from /lib/libcrypto.so.6...done.\nLoaded symbols for /lib/libcrypto.so.6\nReading symbols from /usr/local/lib/php/20090626/dba.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/dba.so\nReading symbols from /usr/local/lib/php/20090626/dom.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/dom.so\nReading symbols from /usr/local/lib/php/20090626/exif.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/exif.so\nReading symbols from /usr/local/lib/php/20090626/filter.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/filter.so\nReading symbols from /usr/local/lib/php/20090626/ftp.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/ftp.so\nReading symbols from /usr/local/lib/php/20090626/gd.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/gd.so\nReading symbols from /usr/local/lib/libt1.so.5...done.\nLoaded symbols for /usr/local/lib/libt1.so.5\nReading symbols from /usr/local/lib/libfreetype.so.9...done.\nLoaded symbols for /usr/local/lib/libfreetype.so.9\nReading symbols from /usr/local/lib/libX11.so.6...done.\nLoaded symbols for /usr/local/lib/libX11.so.6\nReading symbols from /usr/local/lib/libXpm.so.4...done.\nLoaded symbols for /usr/local/lib/libXpm.so.4\nReading symbols from /usr/local/lib/libpng.so.6...done.\nLoaded symbols for /usr/local/lib/libpng.so.6\nReading symbols from /usr/local/lib/libjpeg.so.11...done.\nLoaded symbols for /usr/local/lib/libjpeg.so.11\nReading symbols from /usr/local/lib/libxcb.so.2...done.\nLoaded symbols for /usr/local/lib/libxcb.so.2\nReading symbols from /usr/local/lib/libXau.so.6...done.\nLoaded symbols for /usr/local/lib/libXau.so.6\nReading symbols from /usr/local/lib/libXdmcp.so.6...done.\nLoaded symbols for /usr/local/lib/libXdmcp.so.6\nReading symbols from /usr/local/lib/libpthread-stubs.so.0...done.\nLoaded symbols for /usr/local/lib/libpthread-stubs.so.0\nReading symbols from /usr/lib/librpcsvc.so.5...done.\nLoaded symbols for /usr/lib/librpcsvc.so.5\nReading symbols from /usr/local/lib/php/20090626/gettext.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/gettext.so\nReading symbols from /usr/local/lib/libintl.so.9...done.\nLoaded symbols for /usr/local/lib/libintl.so.9\nReading symbols from /usr/local/lib/php/20090626/gmp.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/gmp.so\nReading symbols from /usr/local/lib/libgmp.so.10...done.\nLoaded symbols for /usr/local/lib/libgmp.so.10\nReading symbols from /usr/local/lib/php/20090626/hash.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/hash.so\nReading symbols from /usr/local/lib/php/20090626/iconv.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/iconv.so\nReading symbols from /usr/local/lib/php/20090626/imagick.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/imagick.so\nReading symbols from /usr/local/lib/libMagickWand.so.4...done.\nLoaded symbols for /usr/local/lib/libMagickWand.so.4\nReading symbols from /usr/local/lib/libMagickCore.so.4...done.\nLoaded symbols for /usr/local/lib/libMagickCore.so.4\nReading symbols from /usr/local/lib/libjbig.so.1...done.\nLoaded symbols for /usr/local/lib/libjbig.so.1\nReading symbols from /usr/local/lib/liblcms.so.1...done.\nLoaded symbols for /usr/local/lib/liblcms.so.1\nReading symbols from /usr/local/lib/libtiff.so.4...done.\nLoaded symbols for /usr/local/lib/libtiff.so.4\nReading symbols from /usr/local/lib/libjasper.so.4...done.\nLoaded symbols for /usr/local/lib/libjasper.so.4\nReading symbols from /usr/local/lib/liblqr-1.so.3...done.\nLoaded symbols for /usr/local/lib/liblqr-1.so.3\nReading symbols from /usr/local/lib/libglib-2.0.so.0...done.\nLoaded symbols for /usr/local/lib/libglib-2.0.so.0\nReading symbols from /usr/local/lib/libfftw3.so.5...done.\nLoaded symbols for /usr/local/lib/libfftw3.so.5\nReading symbols from /usr/local/lib/libfpx.so.2...done.\nLoaded symbols for /usr/local/lib/libfpx.so.2\nReading symbols from /usr/local/lib/libfontconfig.so.1...done.\nLoaded symbols for /usr/local/lib/libfontconfig.so.1\nReading symbols from /usr/local/lib/libXext.so.6...done.\nLoaded symbols for /usr/local/lib/libXext.so.6\nReading symbols from /usr/local/lib/libXt.so.6...done.\nLoaded symbols for /usr/local/lib/libXt.so.6\nReading symbols from /usr/local/lib/libSM.so.6...done.\nLoaded symbols for /usr/local/lib/libSM.so.6\nReading symbols from /usr/local/lib/libICE.so.6...done.\nLoaded symbols for /usr/local/lib/libICE.so.6\nReading symbols from /usr/local/lib/libltdl.so.7...done.\nLoaded symbols for /usr/local/lib/libltdl.so.7\nReading symbols from /usr/lib/libstdc++.so.6...done.\nLoaded symbols for /usr/lib/libstdc++.so.6\nReading symbols from /lib/libgcc_s.so.1...done.\nLoaded symbols for /lib/libgcc_s.so.1\nReading symbols from /usr/local/lib/php/20090626/json.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/json.so\nReading symbols from /usr/local/lib/php/20090626/ldap.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/ldap.so\nReading symbols from /usr/local/lib/libldap-2.4.so.7...done.\nLoaded symbols for /usr/local/lib/libldap-2.4.so.7\nReading symbols from /usr/local/lib/liblber-2.4.so.7...done.\nLoaded symbols for /usr/local/lib/liblber-2.4.so.7\nReading symbols from /usr/local/lib/php/20090626/mbstring.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/mbstring.so\nReading symbols from /usr/local/lib/libonig.so.1...done.\nLoaded symbols for /usr/local/lib/libonig.so.1\nReading symbols from /usr/local/lib/php/20090626/mcrypt.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/mcrypt.so\nReading symbols from /usr/local/lib/libmcrypt.so.8...done.\nLoaded symbols for /usr/local/lib/libmcrypt.so.8\nReading symbols from /usr/local/lib/php/20090626/mysql.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/mysql.so\nReading symbols from /usr/local/lib/mysql/libmysqlclient.so.16...done.\nLoaded symbols for /usr/local/lib/mysql/libmysqlclient.so.16\nReading symbols from /usr/local/lib/php/20090626/mysqli.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/mysqli.so\nReading symbols from /usr/local/lib/php/20090626/openssl.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/openssl.so\nReading symbols from /usr/local/lib/php/20090626/pdf.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/pdf.so\nReading symbols from /usr/local/lib/libpdf.so.8...done.\nLoaded symbols for /usr/local/lib/libpdf.so.8\nReading symbols from /usr/local/lib/php/20090626/pdo.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/pdo.so\nReading symbols from /usr/local/lib/php/20090626/pdo_sqlite.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/pdo_sqlite.so\nReading symbols from /usr/local/lib/libsqlite3.so.8...done.\nLoaded symbols for /usr/local/lib/libsqlite3.so.8\nReading symbols from /usr/local/lib/php/20090626/pdo_mysql.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/pdo_mysql.so\nReading symbols from /usr/local/lib/php/20090626/posix.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/posix.so\nReading symbols from /usr/local/lib/php/20090626/session.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/session.so\nReading symbols from /usr/local/lib/php/20090626/pspell.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/pspell.so\nReading symbols from /usr/local/lib/libaspell.so.16...done.\nLoaded symbols for /usr/local/lib/libaspell.so.16\nReading symbols from /usr/local/lib/libpspell.so.16...done.\nLoaded symbols for /usr/local/lib/libpspell.so.16\nReading symbols from /usr/local/lib/php/20090626/simplexml.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/simplexml.so\nReading symbols from /usr/local/lib/php/20090626/soap.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/soap.so\nReading symbols from /usr/local/lib/php/20090626/sockets.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/sockets.so\nReading symbols from /usr/local/lib/php/20090626/sqlite.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/sqlite.so\nReading symbols from /usr/local/lib/php/20090626/tidy.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/tidy.so\nReading symbols from /usr/local/lib/libtidy-0.99.so.0...done.\nLoaded symbols for /usr/local/lib/libtidy-0.99.so.0\nReading symbols from /usr/local/lib/php/20090626/tokenizer.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/tokenizer.so\nReading symbols from /usr/local/lib/php/20090626/xml.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/xml.so\nReading symbols from /usr/local/lib/php/20090626/wddx.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/wddx.so\nReading symbols from /usr/local/lib/php/20090626/xmlreader.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/xmlreader.so\nReading symbols from /usr/local/lib/php/20090626/xmlrpc.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/xmlrpc.so\nReading symbols from /usr/local/lib/php/20090626/xmlwriter.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/xmlwriter.so\nReading symbols from /usr/local/lib/php/20090626/xsl.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/xsl.so\nReading symbols from /usr/local/lib/libexslt.so.8...done.\nLoaded symbols for /usr/local/lib/libexslt.so.8\nReading symbols from /usr/local/lib/libxslt.so.2...done.\nLoaded symbols for /usr/local/lib/libxslt.so.2\nReading symbols from /usr/local/lib/libgcrypt.so.17...done.\nLoaded symbols for /usr/local/lib/libgcrypt.so.17\nReading symbols from /usr/local/lib/libgpg-error.so.0...done.\nLoaded symbols for /usr/local/lib/libgpg-error.so.0\nReading symbols from /usr/local/lib/php/20090626/zip.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/zip.so\nReading symbols from /usr/local/lib/php/20090626/zlib.so...done.\nLoaded symbols for /usr/local/lib/php/20090626/zlib.so\nReading symbols from /libexec/ld-elf.so.1...done.\nLoaded symbols for /libexec/ld-elf.so.1\n#0  apr_palloc (pool=0x80fd13028, in_size=Variable \"in_size\" is not available.\n) at memory/unix/apr_pools.c:252\n252\t            if ((*ref = node->next) == NULL && i >= max_index) {\n[New Thread 8016041c0 (LWP 100225)]\n(gdb) bt\n#0  apr_palloc (pool=0x80fd13028, in_size=Variable \"in_size\" is not available.\n) at memory/unix/apr_pools.c:252\n#1  0x00000008010549f9 in apr_pstrmemdup (a=Variable \"a\" is not available.\n) at strings/apr_strings.c:107\n#2  0x000000000042c30b in ap_read_request (conn=0x80fd07298) at /usr/ports/www/apache22/work/httpd-2.2.16/server/protocol.c:649\n#3  0x0000000000444b43 in ap_process_http_connection (c=0x80fd07298) at /usr/ports/www/apache22/work/httpd-2.2.16/modules/http/http_core.c:183\n#4  0x0000000000440b02 in ap_run_process_connection (c=0x80fd07298) at /usr/ports/www/apache22/work/httpd-2.2.16/server/connection.c:43\n#5  0x0000000000450324 in process_socket (p=0x80fd07028, sock=0x80fd070a0, conn_id=1108, bucket_alloc=0x80fd0b028, pool=0x80fd05028) at /usr/ports/www/apache22/work/httpd-2.2.16/server/mpm/experimental/peruser/peruser.c:1363\n#6  0x000000000045191f in child_main (child_num_arg=Variable \"child_num_arg\" is not available.\n) at /usr/ports/www/apache22/work/httpd-2.2.16/server/mpm/experimental/peruser/peruser.c:2216\n#7  0x00000000004520e5 in make_child (s=0x80161a868, slot=1108) at /usr/ports/www/apache22/work/httpd-2.2.16/server/mpm/experimental/peruser/peruser.c:2534\n#8  0x0000000000452cca in ap_mpm_run (_pconf=Variable \"_pconf\" is not available.\n) at /usr/ports/www/apache22/work/httpd-2.2.16/server/mpm/experimental/peruser/peruser.c:2941\n#9  0x0000000000423b1a in main (argc=3, argv=0x7fffffffecf8) at /usr/ports/www/apache22/work/httpd-2.2.16/server/main.c:740\n(gdb) bt full\n#0  apr_palloc (pool=0x80fd13028, in_size=Variable \"in_size\" is not available.\n) at memory/unix/apr_pools.c:252\n\tactive = (apr_memnode_t *) 0x80fd13000\n\tnode = (apr_memnode_t *) 0x8000019d1\n\tmem = Variable \"mem\" is not available.\n(gdb) frame 0\n#0  apr_palloc (pool=0x80fd13028, in_size=Variable \"in_size\" is not available.\n) at memory/unix/apr_pools.c:252\n252\t            if ((*ref = node->next) == NULL && i >= max_index) {\n(gdb) list\n247\t            /* If we have found a node and it doesn't have any\n248\t             * nodes waiting in line behind it _and_ we are on\n249\t             * the highest available index, find the new highest\n250\t             * available index\n251\t             */\n252\t            if ((*ref = node->next) == NULL && i >= max_index) {\n253\t                do {\n254\t                    ref--;\n255\t                    max_index--;\n256\t                }\n(gdb) print node\n$1 = (apr_memnode_t *) 0x8000019d1\n(gdb) print node->next\nCannot access memory at address 0x8000019d1\n(gdb) frame 1\n#1  0x00000008010549f9 in apr_pstrmemdup (a=Variable \"a\" is not available.\n) at strings/apr_strings.c:107\n107\t    res = apr_palloc(a, n + 1);\n(gdb) list\n102\t    char *res;\n103\t\n104\t    if (s == NULL) {\n105\t        return NULL;\n106\t    }\n107\t    res = apr_palloc(a, n + 1);\n108\t    memcpy(res, s, n);\n109\t    res[n] = '\\0';\n110\t    return res;\n111\t}\n(gdb) frame 2\n#2  0x000000000042c30b in ap_read_request (conn=0x80fd07298) at /usr/ports/www/apache22/work/httpd-2.2.16/server/protocol.c:649\n649\t    r->protocol = apr_pstrmemdup(r->pool, pro, len);\n(gdb) list\n644\t    } else {\n645\t        r->assbackwards = 1;\n646\t        pro = \"HTTP/0.9\";\n647\t        len = 8;\n648\t    }\n649\t    r->protocol = apr_pstrmemdup(r->pool, pro, len);\n650\t\n651\t    /* XXX ap_update_connection_status(conn->id, \"Protocol\", r->protocol); */\n652\t\n653\t    /* Avoid sscanf in the common case */\n(gdb) print r\n$2 = (request_rec *) 0x80fd130a0\n(gdb) print r->pool\n$3 = (apr_pool_t *) 0x80fd13028\n(gdb) print r->pool->tag\n$4 = 0x455d0b \"request\"\n(gdb) print r->connection\n$5 = (conn_rec *) 0x80fd07298\n(gdb) print r->connection->pool\n$6 = (apr_pool_t *) 0x80fd07028\n(gdb) print r->connection->aborted\n$7 = 0\n(gdb) print r->protocol\n$8 = 0x0\n(gdb) frame 3\n#3  0x0000000000444b43 in ap_process_http_connection (c=0x80fd07298) at /usr/ports/www/apache22/work/httpd-2.2.16/modules/http/http_core.c:183\n183\t    while ((r = ap_read_request(c)) != NULL) {\n(gdb) list\n178\t     * Read and process each request found on our connection\n179\t     * until no requests are left or we decide to close.\n180\t     */\n181\t\n182\t    ap_update_child_status(c->sbh, SERVER_BUSY_READ, NULL);\n183\t    while ((r = ap_read_request(c)) != NULL) {\n184\t\n185\t        c->keepalive = AP_CONN_UNKNOWN;\n186\t        /* process the request if it was read without error */\n187\t\n(gdb) print c\n$9 = (conn_rec *) 0x80fd07298\n(gdb) print c->id\n$10 = 1108\n(gdb) quit"}, {"count": 1, "tags": [], "creator": "jlpoole56@gmail.com", "attachment_id": null, "id": 143380, "time": "2011-01-16T09:44:39Z", "bug_id": 50594, "creation_time": "2011-01-16T09:44:39Z", "is_private": false, "text": "Bug #50596 \"make test hangs on testprocmute\" may be related.  I read this bug and saw similarities to the problem I've been encountering.  I've been hampered with Apache failing at the outset with a segment fault.  My back trace pointed to the same function and hence I believe there may be a similarity between the bugs:\n\nplug bin # gdb httpd\nGNU gdb (Gentoo 7.0.1 p1) 7.0.1\nCopyright (C) 2009 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"armv5tel-softfloat-linux-gnueabi\".\nFor bug reporting instructions, please see:\n<http://bugs.gentoo.org/>...\nReading symbols from /var/tmp/apache/httpd/bin/httpd...done.\n(gdb) run\nStarting program: /var/tmp/apache/httpd/bin/httpd\n[Thread debugging using libthread_db enabled]\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x402600e4 in apr_palloc () from /usr/lib/libapr-1.so.0\n(gdb) bt\n#0  0x402600e4 in apr_palloc () from /usr/lib/libapr-1.so.0\n#1  0x4025a988 in apr_array_make () from /usr/lib/libapr-1.so.0\n#2  0x400ddb54 in apr_hook_sort_register () from /usr/lib/libaprutil-1.so.0\n#3  0x00051f74 in ap_hook_create_connection (pf=0x3f49c <core_create_conn>, aszPre=0x0, aszSucc=0x0,\n    nOrder=30) at connection.c:42\n#4  0x0003f838 in register_hooks (p=0xc50a8) at core.c:3985\n#5  0x000485e4 in ap_register_hooks (m=0xbaeec, p=0xc50a8) at config.c:431\n#6  0x00048974 in ap_add_module (m=0xbaeec, p=0xc50a8) at config.c:556\n#7  0x00048d64 in ap_setup_prelinked_modules (process=0xc3130) at config.c:701\n#8  0x00028be0 in main (argc=1, argv=0xbecac314) at main.c:487\n(gdb) info frame\nStack level 0, frame at 0xbecac098:\n pc = 0x402600e4 in apr_palloc; saved pc 0x4025a988\n called by frame at 0xbecac0b8\n Arglist at 0xbecac080, args:\n Locals at 0xbecac080, Previous frame's sp is 0xbecac098\n Saved registers:\n  r4 at 0xbecac080, r5 at 0xbecac084, r6 at 0xbecac088, r7 at 0xbecac08c, r8 at 0xbecac090,\n  lr at 0xbecac094\n(gdb) info locals\nNo symbol table info available.\n(gdb)"}, {"count": 2, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "is_private": false, "id": 143381, "time": "2011-01-16T10:07:23Z", "bug_id": 50594, "creation_time": "2011-01-16T10:07:23Z", "text": "(In reply to comment #1)\n> Bug #50596 \"make test hangs on testprocmute\" may be related.  I read this bug\n> and saw similarities to the problem I've been encountering.  \n\nI don't think there's any relation, your backtrace is during single-threaded server startup and 50594 is during setup of a new connection.  They just both happen to fail in APR memory allocation."}, {"count": 3, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "id": 143382, "time": "2011-01-16T10:13:02Z", "bug_id": 50594, "creation_time": "2011-01-16T10:13:02Z", "is_private": false, "text": "How often does it crash?  Can you get it to crash without the third-party modules (php/peruser)?  Does freebsd have any heap checking / debugging you can enable?"}, {"count": 4, "text": "> How often does it crash?\n\n~200 crashes per day, in a server with more than 1,000 vhosts.\n\n> Can you get it to crash without the third-party\nmodules (php/peruser)?\n\nI can't disable php to test because it's a production server. But, as you can see in core dump, the server crashes BEFORE request is processed.\n\n> Does freebsd have any heap checking / debugging you can\nenable?\n\nThis is happening in a production server, I'm afraid to enable debug and slow down the server.", "bug_id": 50594, "is_private": false, "id": 143408, "time": "2011-01-17T07:02:01Z", "creator": "marcelo@tpn.com.br", "creation_time": "2011-01-17T07:02:01Z", "tags": [], "attachment_id": null}, {"count": 5, "tags": [], "creator": "wrowe@apache.org", "attachment_id": null, "id": 143409, "time": "2011-01-17T07:13:52Z", "bug_id": 50594, "creation_time": "2011-01-17T07:13:52Z", "is_private": false, "text": "This would be a flaw in peruser's management of the pool scopes.  The fact\nthat it crashes in apr_palloc() indicates that the pool has become corrupt\nor is no longer valid, which is consistent with peruser's handling of it's\nconnection pool (the mpm controls pool lifetimes).  This could be due to\ncross-threading (not managing the allocator of memory across different\nthreads, or failing to set up a lock for the allocator to handle concurrent\nallocator accesses).\n\nIn any case, you will need to take this core to the maintainers of the\nperuser mpm for further assistance, there is little we can do for you here.\nIf there is a resolution, it would be helpful to update this bug just in case\nsomeone stumbles across it searching for the same issue."}]