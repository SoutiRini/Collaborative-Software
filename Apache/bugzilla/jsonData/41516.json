[{"count": 0, "tags": [], "creator": "dean.scothern@eduserv.org.uk", "attachment_id": null, "id": 98874, "time": "2007-02-01T09:40:10Z", "bug_id": 41516, "creation_time": "2007-02-01T09:40:10Z", "is_private": false, "text": "I've been trying to setup a surrogate cache using apache 2.2.4 and been having\nproblems caching certain urls even though they should be cacheable.\n\n(Its a simple arrangement with apache reverse proxying directly to one server.\napache = 10.20.22.46, other web server = 10.20.22.101)\n\nfor example:\nThis works:\n1) wget -S 'http://10.20.22.46/~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx'\n\n[Thu Feb 01 17:24:28 2007] [debug] cache_storage.c(431): cache_storage: generate\nkey /~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:24:28 2007] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:24:28 2007] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:24:28 2007] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //10.20.22.101/~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:24:28 2007] [debug] proxy_util.c(1378): [client 192.168.33.220]\nproxy: http: found worker http://10.20.22.101/ for\nhttp://10.20.22.101/%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:24:28 2007] [debug] mod_proxy.c(777): Running scheme http handler\n(attempt 0)\n[Thu Feb 01 17:24:28 2007] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://10.20.22.101/%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:24:28 2007] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (10.20.22.101)\n[Thu Feb 01 17:24:28 2007] [debug] proxy_util.c(1859): proxy: connecting\nhttp://10.20.22.101/%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx to\n10.20.22.101:80\n[Thu Feb 01 17:24:28 2007] [debug] proxy_util.c(1955): proxy: connected\n/%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx to 10.20.22.101:80\n[Thu Feb 01 17:24:28 2007] [debug] proxy_util.c(2050): proxy: HTTP: fam 2 socket\ncreated to connect to 10.20.22.101\n[Thu Feb 01 17:24:28 2007] [debug] proxy_util.c(2146): proxy: HTTP: connection\ncomplete to 10.20.22.101:80 (10.20.22.101)\n[Thu Feb 01 17:24:28 2007] [debug] mod_proxy_http.c(1448): proxy: start body send\n[Thu Feb 01 17:24:28 2007] [debug] mod_headers.c(663): headers:\nap_headers_output_filter()\n[Thu Feb 01 17:24:28 2007] [debug] cache_storage.c(431): cache_storage: generate\nkey /~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:24:28 2007] [debug] mod_cache.c(609): cache: Caching url:\n/~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:24:28 2007] [debug] mod_cache.c(615): cache: Removing\nCACHE_REMOVE_URL filter.\n[Thu Feb 01 17:24:28 2007] [debug] mod_disk_cache.c(954): disk_cache: Stored\nheaders for URL http://10.20.22.46:80/~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx?\n[Thu Feb 01 17:24:28 2007] [debug] mod_disk_cache.c(1043): disk_cache: Body for\nURL http://10.20.22.46:80/~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx? cached.\n[Thu Feb 01 17:24:28 2007] [debug] mod_proxy_http.c(1537): proxy: end body send\n[Thu Feb 01 17:24:28 2007] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (10.20.22.101)\n\nand the second get:\n[Thu Feb 01 17:25:23 2007] [debug] cache_storage.c(431): cache_storage: generate\nkey /~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:25:23 2007] [debug] mod_disk_cache.c(477): disk_cache: Recalled\ncached URL info header\nhttp://10.20.22.46:80/~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx?\n[Thu Feb 01 17:25:23 2007] [debug] mod_disk_cache.c(750): disk_cache: Recalled\nheaders for URL http://10.20.22.46:80/~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx?\n[Thu Feb 01 17:25:23 2007] [debug] mod_headers.c(663): headers:\nap_headers_output_filter()\n[Thu Feb 01 17:25:23 2007] [debug] mod_cache.c(263): cache: running CACHE_OUT filter\n[Thu Feb 01 17:25:23 2007] [debug] mod_cache.c(277): cache: serving\n/~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n\nAll well and good (I've added a extra debug line to show the key generated at\nthe end of cache-storage.c)\n\nUnfortunately if the url is url encoded I get the following:\n\nwget -S 'http://10.20.22.46/%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx'\n\n\n[Thu Feb 01 17:27:49 2007] [debug] cache_storage.c(431): cache_storage: generate\nkey /%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:27:49 2007] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:27:49 2007] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:27:49 2007] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //10.20.22.101/~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:27:49 2007] [debug] proxy_util.c(1378): [client 192.168.33.220]\nproxy: http: found worker http://10.20.22.101/ for\nhttp://10.20.22.101/%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:27:49 2007] [debug] mod_proxy.c(777): Running scheme http handler\n(attempt 0)\n[Thu Feb 01 17:27:49 2007] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://10.20.22.101/%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:27:49 2007] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (10.20.22.101)\n[Thu Feb 01 17:27:49 2007] [debug] proxy_util.c(1859): proxy: connecting\nhttp://10.20.22.101/%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx to\n10.20.22.101:80\n[Thu Feb 01 17:27:49 2007] [debug] proxy_util.c(1955): proxy: connected\n/%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx to 10.20.22.101:80\n[Thu Feb 01 17:27:49 2007] [debug] proxy_util.c(2050): proxy: HTTP: fam 2 socket\ncreated to connect to 10.20.22.101\n[Thu Feb 01 17:27:49 2007] [debug] proxy_util.c(2146): proxy: HTTP: connection\ncomplete to 10.20.22.101:80 (10.20.22.101)\n[Thu Feb 01 17:27:49 2007] [debug] mod_proxy_http.c(1448): proxy: start body send\n[Thu Feb 01 17:27:49 2007] [debug] mod_headers.c(663): headers:\nap_headers_output_filter()\n[Thu Feb 01 17:27:49 2007] [debug] cache_storage.c(431): cache_storage: generate\nkey /~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:27:49 2007] [debug] mod_cache.c(609): cache: Caching url:\n/%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:27:49 2007] [debug] mod_cache.c(615): cache: Removing\nCACHE_REMOVE_URL filter.\n[Thu Feb 01 17:27:49 2007] [debug] mod_disk_cache.c(954): disk_cache: Stored\nheaders for URL http://10.20.22.46:80/~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx?\n[Thu Feb 01 17:27:49 2007] [debug] mod_disk_cache.c(1043): disk_cache: Body for\nURL http://10.20.22.46:80/~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx? cached.\n[Thu Feb 01 17:27:49 2007] [debug] mod_proxy_http.c(1537): proxy: end body send\n[Thu Feb 01 17:27:49 2007] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (10.20.22.101)\n\nand the second time:\n[Thu Feb 01 17:29:05 2007] [debug] cache_storage.c(431): cache_storage: generate\nkey /%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:29:05 2007] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:29:05 2007] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:29:05 2007] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //10.20.22.101/~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:29:05 2007] [debug] proxy_util.c(1378): [client 192.168.33.220]\nproxy: http: found worker http://10.20.22.101/ for\nhttp://10.20.22.101/%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:29:05 2007] [debug] mod_proxy.c(777): Running scheme http handler\n(attempt 0)\n[Thu Feb 01 17:29:05 2007] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://10.20.22.101/%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:29:05 2007] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (10.20.22.101)\n[Thu Feb 01 17:29:05 2007] [debug] proxy_util.c(1859): proxy: connecting\nhttp://10.20.22.101/%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx to\n10.20.22.101:80\n[Thu Feb 01 17:29:05 2007] [debug] proxy_util.c(1955): proxy: connected\n/%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx to 10.20.22.101:80\n[Thu Feb 01 17:29:05 2007] [debug] proxy_util.c(2050): proxy: HTTP: fam 2 socket\ncreated to connect to 10.20.22.101\n[Thu Feb 01 17:29:05 2007] [debug] proxy_util.c(2146): proxy: HTTP: connection\ncomplete to 10.20.22.101:80 (10.20.22.101)\n[Thu Feb 01 17:29:05 2007] [debug] mod_proxy_http.c(1448): proxy: start body send\n[Thu Feb 01 17:29:05 2007] [debug] mod_headers.c(663): headers:\nap_headers_output_filter()\n[Thu Feb 01 17:29:05 2007] [debug] cache_storage.c(431): cache_storage: generate\nkey /~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:29:05 2007] [debug] mod_cache.c(609): cache: Caching url:\n/%7E/media/2B89E73DB97041B1A48D64BBE2126D10.ashx\n[Thu Feb 01 17:29:05 2007] [debug] mod_cache.c(615): cache: Removing\nCACHE_REMOVE_URL filter.\n[Thu Feb 01 17:29:05 2007] [debug] mod_disk_cache.c(954): disk_cache: Stored\nheaders for URL http://10.20.22.46:80/~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx?\n[Thu Feb 01 17:29:05 2007] [debug] mod_disk_cache.c(1043): disk_cache: Body for\nURL http://10.20.22.46:80/~/media/2B89E73DB97041B1A48D64BBE2126D10.ashx? cached.\n[Thu Feb 01 17:29:05 2007] [debug] mod_proxy_http.c(1537): proxy: end body send\n[Thu Feb 01 17:29:05 2007] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (10.20.22.101)\n\nAnd the url is not delivered from the cache. It appears to be that the url used\nfor comparison has been converted back to the non encoded type, but I got\nrapidly lost whilst trying to trace the logic. My C skills are very rusty.\n\nI'll be happy to supply more data and check any suggested fix.\n\nBest Regards"}, {"count": 1, "tags": [], "bug_id": 41516, "text": "\n\n*** This bug has been marked as a duplicate of 41475 ***", "id": 98879, "time": "2007-02-01T12:47:38Z", "creator": "rpluem@apache.org", "creation_time": "2007-02-01T12:47:38Z", "is_private": false, "attachment_id": null}]