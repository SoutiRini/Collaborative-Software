[{"count": 0, "tags": [], "bug_id": 12196, "text": "In Tomcat 4.1.9beta, request.getRemoteUser() no longer returns the remoteUser \nprovided via AJP.\n\nSetup:\n    Sun JDK 1.3.1\n    Tomcat 4.1.9\n    mod_jk\n    Microsoft IIS\n    Win2K\n\nI added a line\n\n    request.org.apache.jk.common.HandlerRequest.tomcatAuthentication = false \n\nto my conf/jk2.properties file, but although this does set the\ntomcatAuthentication property on HandlerRequest, the remote user is\nnot propagated to the HttpServletRequest that the servlet eventually\nreceives.\n\nThe discontinuity turned out to be in\norg.apache.coyote.tomcat4.CoyoteRequest where getRemoteUser is\nreturning the userPrincipal property, which has not been set. I\nmodified my getRemoteUser to return\ncoyoteRequest.getRemoteUser().toString() and this fixed my problem,\nbut perhaps there is a better fix, perhaps making a modification in\nCoyoteAdapter.postParseRequest?", "id": 22040, "time": "2002-08-30T16:07:54Z", "creator": "chris_j_davey@hotmail.com", "creation_time": "2002-08-30T16:07:54Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "text": "I've tried using the normal mod_jk (not mod_jk2) and haven't been able to find a\nway to set tomcatAuthentication=\"false\" on the Coyote connector.  Until the\nCoyote connector allows me to do this, I have to continue to use the old ajp13\nconnector in order to get a non-null value calling getRemoteUser() when using\nBASIC Authentication fronting Tomcat with Apache.  But the problem with that is\nthat I end up disabling any of the JMX management functions when configuring the\nserver with the admin app because JMX barfs when the old ajp13 connector is\nspecified even if I go straight to Tomcat through port 8080. it requires the\nCoyote connector to be specified instead.\n\nI would really like to be able to do both and fixing this bug is the answer.  I\nam raising the priority on this especially since it seems that a stable release\n(Tomcat-4.1.10) has been cut which has this bug.\n\nHere is what I have to use:\n\n<!-- Define an AJP 1.3 Connector on port 8009 -->\n<Connector className=\"org.apache.ajp.tomcat4.Ajp13Connector\"\n           port=\"8009\" minProcessors=\"5\" maxProcessors=\"75\"\n           acceptCount=\"10\" debug=\"0\" tomcatAuthentication=\"false\"/>\n\nHere is what I'd like to use:\n\n<!-- Define a Coyote/JK2 AJP 1.3 Connector on port 8009 -->\n<Connector className=\"org.apache.coyote.tomcat4.CoyoteConnector\"\n           port=\"8009\" minProcessors=\"5\" maxProcessors=\"75\"\n           enableLookups=\"true\" redirectPort=\"8443\"\n           acceptCount=\"10\" debug=\"0\" connectionTimeout=\"20000\"\n           useURIValidationHack=\"false\" tomcatAuthentication=\"false\"\n           protocolHandlerClassName=\"org.apache.jk.server.JkCoyoteHandler\"/>\n\nJake", "attachment_id": null, "id": 22379, "creator": "hoju@visi.com", "time": "2002-09-06T17:40:39Z", "bug_id": 12196, "creation_time": "2002-09-06T17:40:39Z", "is_private": false}, {"count": 2, "tags": [], "creator": "chris_j_davey@hotmail.com", "attachment_id": null, "text": "The problem contintues to exist in Tomcat 4.1.10. The diff below fixes the \nproblem (fix to org.apache.coyote.tomcat4.CoyoteRequest.getRemoteUser). I've \nalso tested with Apache, as opposed to IIS.\n\nNB in CATALINA_HOME/conf/jk2.properties the property \nrequest.tomcatAuthentication must be set to false. i.e.\n\nrequest.tomcatAuthentication=false\n\n====\n\ndiff CoyoteRequest.java CoyoteRequest.java.orig\n\n1623c1623,1629\n<         return coyoteRequest.getRemoteUser().toString();\n---\n>\n>         if (userPrincipal != null) {\n>             return (userPrincipal.getName());\n>         } else {\n>             return (null);\n>         }\n>", "id": 22442, "time": "2002-09-08T06:19:49Z", "bug_id": 12196, "creation_time": "2002-09-08T06:19:49Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 12196, "text": "Thanks for trying to help fix it, but your patch is wrong, as, among other\nthings, it doesn't attempt to patch getUserPrincipal.\n\nAlso:\n- return coyoteRequest.getRemoteUser().toString(): I'm not convinced this can\nreturn null\n- your patch would break standalone Tomcat (you must honour the userPrincipal field)\n\nI'll fix the bug on monday.", "id": 22446, "time": "2002-09-08T08:52:42Z", "creator": "remm@apache.org", "creation_time": "2002-09-08T08:52:42Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "text": "I've added code to expose the principal authenticated by the native webserver.\nPlease test it. The fix will be in Tomcat 4.1.11.", "id": 22486, "time": "2002-09-09T08:04:11Z", "bug_id": 12196, "creation_time": "2002-09-09T08:04:11Z", "is_private": false}, {"count": 5, "tags": [], "creator": "chris_j_davey@hotmail.com", "attachment_id": null, "text": "Tested Changes: works fine with Apache / AJP. Will test with IIS next week.", "id": 22575, "time": "2002-09-10T05:54:20Z", "bug_id": 12196, "creation_time": "2002-09-10T05:54:20Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 12196, "attachment_id": null, "id": 25349, "time": "2002-10-29T21:54:48Z", "creator": "ddexter@lincom-asg.com", "creation_time": "2002-10-29T21:54:48Z", "is_private": false, "text": "Configuration: Tomcat 4.1.14, JK 2.0.1, Ant 1.5.1, IIS 5.0, Windows 2000\n\nUsing these connector settings, I still get null when I call \nrequest.getRemoteUser().\n\n<!-- Define a Coyote/JK2 AJP 1.3 Connector on port 8009 -->\n<Connector className=\"org.apache.coyote.tomcat4.CoyoteConnector\"\n           port=\"8009\" minProcessors=\"5\" maxProcessors=\"75\"\n           enableLookups=\"true\" redirectPort=\"8443\"\n           acceptCount=\"10\" debug=\"0\" connectionTimeout=\"20000\"\n           useURIValidationHack=\"false\"\n           tomcatAuthentication=\"false\"\n           protocolHandlerClassName=\"org.apache.jk.server.JkCoyoteHandler\"/>\n\nThe ISAPI redirector I am using (isapi_redirector2.dll) is from\nhttp://jakarta.apache.org/builds/jakarta-tomcat-connectors/jk2/release/v2.0.1/\n\nUsing the old JK AJP 1.3 connector in Tomcat 4.0.x, request.getRemoteUser()\nwould return the remote users name as expected.\n"}, {"count": 7, "tags": [], "bug_id": 12196, "attachment_id": null, "id": 25382, "time": "2002-10-30T17:29:59Z", "creator": "ddexter@lincom-asg.com", "creation_time": "2002-10-30T17:29:59Z", "is_private": false, "text": "As mentioned in http://nagoya.apache.org/bugzilla/show_bug.cgi?id=14069\n\"You should use jk2.properties to set tomcatAuthentication. There's no\n\"tomcatAuthentication\" field on the CoyoteConnector class.\"\n\nSetting tomcatAuthentication=false in the jk2.properties file does not\nfix the problem of request.getRemoteUser() returning null when using the\nisapi_redirector2.dll with IIS 5.0.  I have also tried\ntomcatAuthentication=0 and tomcatAuthentication=1 with no success.\n\nI set tomcatAuthentication=false in the jk2.properties file, restarted\nthe \"Apache Tomcat 4.1\" service, and this was the settings in the\njk2.properties.save file:\n\n#AUTOMATICALLY GENERATED\n#Wed Oct 30 10:50:46 CST 2002\nsecure=false\ntomcatAuthentication=false\nsoTimeout=20000\nport=8009\njkHome=D\\:\\\\Tomcat4.1\nmaxThreads=75\nbacklog=10\ntimeout=20000\ntcpNoDelay=true\n\nI have \"Integrated Windows Authentication\" enabled, and anonymous access\ndisabled on the \"jakarta\" virtual directory that points to\n\"D:\\Tomcat4.1\\bin\" where the isapi_redirector2.dll file resides.\n\nThe Authenticaion header, as reported by tomcat 4.1.14, is\n\"Negotiate ELSKVI...slflSdf\" and request.getRemoteUser() returns null.\n\nUsing Tomcat 4.0.4, and the older JK isapi_redirect.dll, I am able to get\na remote username with the same IIS 5.0 settings.\n\nI have searched through the tomcat-dev and tomcat-user mailing list archives\nand I can not find any documentation on the use of the tomcatAuthentication\nparameter in the jk2.properties file, other than what was reported in\nBug 14069.\n\nIn addition, the JK2 documentation does not mention the use of the\ntomcatAuthentication parameter either.  I have checked the documentation for\nthe new JK 2.0.1 ISAPI redirector at\nhttp://jakarta.apache.org/builds/jakarta-tomcat-\nconnectors/jk2/release/v2.0.1/doc/\nAnd I have checked the Tomcat 4.1 JK documentation at\nhttp://jakarta.apache.org/tomcat/tomcat-4.1-doc/jk2/index.html\n\nThis bug (getRmoteUser() returning null) has been reported fixed since 4.1.11,\nbut only against an Apache/AJP setup.\n\nI believe that it is not fixed for a IIS5/AJP setup when using JK2.\n"}, {"count": 8, "tags": [], "creator": "hoju@visi.com", "attachment_id": null, "text": "I'm a bit confused about tomcatAuthentication=\"false\".  It existed as an option \nin the Coyote connector at least up to version 4.1.12.  Remy says the \nworkaround is to put tomcatAuthentication=\"false\" in the jk2.properties.  \nHowever, Dan Dexter has reported that this doesn't work and I am using mod_jk, \nnot jk2.  How do I make getRemoteUser() to work with mod_jk and the latest \nversions of Tomcat using the Coyote connector?\n\nJake", "id": 29813, "time": "2003-01-21T20:26:00Z", "bug_id": 12196, "creation_time": "2003-01-21T20:26:00Z", "is_private": false}, {"count": 9, "tags": [], "creator": "hoju@visi.com", "attachment_id": null, "text": "Note that what Remy says in bug 14069 is correct.  However, it may be slightly \nconfusing as to what the format is to add the tomcatAuthentication parameter to \njk2.properties.  Here is how it goes:\n\nrequest.tomcatAuthentication=false\n\nof course, use \"true\" or \"false\" depending on your needs.\n\nI've tested this in Tomcat-4.1.19 and it works great.  Note that this is valid \nfor both mod_jk and jk2.  I know it is a bit confusing to be adding config for \nmod_jk in jk2.properties, but it works so that is what to use.\n\nRe-resolving this bug as fixed!\n\nJake", "id": 29899, "time": "2003-01-22T17:24:22Z", "bug_id": 12196, "creation_time": "2003-01-22T17:24:22Z", "is_private": false}, {"count": 10, "tags": [], "creator": "gwailoh@earthlink.net", "attachment_id": null, "text": "Folks: Per Jacob Kjome's comment on 2003-01-22, this fix \n(\"request.tomcatAuthentication=false\" into jk2.properties) solves the problem \nwhen using IE browsers.  With Nescape 4.7 and 7.0, getRemoteUser() returns an \nempty String, \"\".  Looks like it needs to be reopened.", "id": 34276, "time": "2003-04-01T19:54:30Z", "bug_id": 12196, "creation_time": "2003-04-01T19:54:30Z", "is_private": false}, {"count": 11, "tags": [], "text": "Are you sure?\n\nIt works fine with recent builds of Mozilla and Phoenix.  Try updating to the\nlatest Netscape (7.2?) and see what you get.  If it works there and still\ndoesn't work in Netscape 7.0 and 4.7 then, apparently, there is a bug in earlier\nversions of Mozilla and the older 4.7.  That would really suck!\n\nJake", "attachment_id": null, "id": 34284, "creator": "hoju@visi.com", "time": "2003-04-01T22:24:11Z", "bug_id": 12196, "creation_time": "2003-04-01T22:24:11Z", "is_private": false}, {"count": 12, "tags": [], "creator": "gwailoh@earthlink.net", "attachment_id": null, "text": "Tested in Netscape 7.0.2, and 4.7.9, which are the latest of each branch \naccording to the Netscape site.  Didn't test Mozilla or Phoenix, which are \noutside the spec for the project I'm currently on.  With the 7.0.2 and 4.7.9 \nNetscapes, request.getRemoteUser() returns \"\".  The server is IIS 5.0 on Win2k \nServer set to \"Integrated Windows authentication\".  IE tests OK.  If there's \nany other info I can provide please let me know.", "id": 34285, "time": "2003-04-01T23:08:48Z", "bug_id": 12196, "creation_time": "2003-04-01T23:08:48Z", "is_private": false}, {"count": 13, "tags": [], "text": "Folks:\n\nI've done more testing and have additional info which may be helpful.  I found \nthat changing the IIS configuration fixed the problem, that is, enabled \nintegrated Windows authentication for Netscape browsers.\n\nInstead of disabling Anonymous access and enabling Basic/Integrated Windows \nAuthentication on the \"jakarta\" virtual directory which points to the location \nof the ISAPI redirector dll, I disabled Anonymous and enabled Basic/Integrated \nWindows Authentication on the entire Default Web Site, of which the \"jakarta\" \nvirtual directory is a component.  With this setting, OS authentication tests \nOK on Netscape 4.7.9 and 7.0.2.\n\nI don't frankly know whether this discovery should close this bug report.  I \nsuppose the answer depends on what IIS & the redirector dll are \"supposed\" to \ndo.  I suspect that many users will not want to enable OS authentication for \ntheir entire IIS-based site.\n\nAlso, although Integrated Windows Authentication now works, container-managed \nauthorization seems to fail on all browsers.  Is this the experience which the \nrest of you have had?\n\nI hope this info turns out to be useful!\n\n--Mark", "attachment_id": null, "id": 36722, "creator": "gwailoh@earthlink.net", "time": "2003-05-05T20:01:30Z", "bug_id": 12196, "creation_time": "2003-05-05T20:01:30Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 12196, "text": "I am also getting request.getRemoteUser() set to null.  Ironically \nrequest.getHeader(\"authorization\") is getting set to \"Basic \ndG9tY2F0OnRvbWNhdA==\" which translates to the proper login:password \ncombination.  I have tried jakarta-tomcat-5.0.7 and jakarta-tomcat-4.1.27 with \nthe same results.  I am using isapi_redirector2.dll v2.0.2 with IIS 5.1.  I \ndisabled Anonymous access, enabled Basic Authentication on the entire Default \nWeb Site and have request.tomcatAuthentication=false in my jk2.properties \nfile.  I am using IE 6.0 SP1.\n\n-Patrick", "id": 42775, "time": "2003-08-14T19:32:36Z", "creator": "patrick@qantel.com", "creation_time": "2003-08-14T19:32:36Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "text": "I was using Tomcat 4.1.24 with tomcatAuthentication=false just fine.  I tried \n4.1.29 with exactly the same configuration and getRemoteUser() returned null!", "attachment_id": null, "id": 47441, "creator": "jessh@ptc.com", "time": "2003-11-16T21:08:50Z", "bug_id": 12196, "creation_time": "2003-11-16T21:08:50Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 12196, "attachment_id": null, "id": 47500, "time": "2003-11-17T16:59:19Z", "creator": "jessh@ptc.com", "creation_time": "2003-11-17T16:59:19Z", "is_private": false, "text": "Ah!\n\nAt 4.1.29 someone did just what I and others have been requesting, but without a\nbig blazing notice to this effect.  They made tomcatAuthentication an attribute\non the Coyote connector (as it is on the AJP13 connector) and ignore this\nsetting in jk2.properties.\n\nOnce I placed this attribute on the Coyote connector element everything worked\nin 4.1.29 just as well as it had in 4.1.24."}, {"count": 17, "tags": [], "text": "This looks fixed. If not, please provide the exact config where it doesn't work. ", "attachment_id": null, "id": 47861, "creator": "funkman@joedog.org", "time": "2003-11-21T19:40:30Z", "bug_id": 12196, "creation_time": "2003-11-21T19:40:30Z", "is_private": false}]