[{"count": 0, "tags": [], "text": "There seems to be a bug that interferes with servlet-to-servlet communication, when Tomcat is running under IIS (Win 2000 Advanced), using JNI.  \r\n\r\nI'm attaching source for a pair of simple servlets that demonstrate the bug.  The first servlet (BadClient.java) opens a URLConnection to the second servlet (BadServer.java).   BadClient uses the URLConnection to open an output stream, then uses the output stream to print some text, which will be read by BadServer.  \r\n\r\nThe BadServer servlet then calls request.getReader to get a reader object, to read the text that was sent by BadClient. \r\n\r\nThis all works fine under Tomcat 3.2, when Tomcat is running stand-alone. But if Tomcat 3.2 is running inside IIS, using the JNI connector, there's a problem.   BadServer is never able to read any of the text sent by BadClient.   The whole process just seems to hang for exactly 1 minute... apparently, something times out after 1 minute, and BadClient stops trying to read the text.  Under JNI, the read call returns -1.  \r\n\r\n(Other servlets work fine under JNI.) \r\n\r\nThe two servlets go on and perform other tasks after that, with BadServer reading a local .GIF file, then sending it back to BadClient, which send the image back to the browser.  That part works; it's the first part that fails, as described above. \r\n\r\nI've tried various configurations of Tomcat -- using the JVM.DLL for classic, or hotspot, or server (Java 1.3).   No difference.  I've looked in the various log files for exceptions, and I don't see any.\r\n\r\nHere's the source for both servlets (around 100 lines each). If the formatting is messed up too badly, please let me know and I'll email a copy to anyone who wants to investigate the problem. \r\n\r\n// Here is all of BadClient.java (118 lines): \r\n// BadClient.java -- demonstrates behavior that works fine in Tomcat 3.2\r\n// but does not work when Tomcat runs under IIS using JNI\r\n// Used in conjunction with BadServer.java\r\nimport javax.servlet.*;\r\nimport javax.servlet.http.*;\r\nimport java.io.*;\r\nimport java.util.*;\r\nimport java.net.URLConnection;\r\nimport java.net.URL;\r\n\r\npublic class BadClient extends HttpServlet {\r\n\r\n\t// TODO:  Either modify the following string literal to represent\r\n\t// the URL of the BadServer servlet, or specify that URL\r\n\t// using an init parameter.\r\n\tString m_url = \"http://localhost:8100/test/servlet/BadServer\";\r\n\r\n\tpublic void init(ServletConfig config) throws ServletException {\r\n\t\tsuper.init(config);\r\n\t\ttry {\r\n\t\t\tString str = getInitParameter(\"url\"); \t\t//URL to 2nd servlet\r\n\t\t\tif (str != null) {\r\n\t\t\t\tm_url = str;\r\n\t\t\t}\r\n\t\t}\r\n\t\tcatch (Exception e) {\r\n\t\t\te.printStackTrace();\r\n\t\t}\r\n\t}\r\n\r\n\tpublic void service(HttpServletRequest request, HttpServletResponse res)\r\n\t\tthrows ServletException, IOException\r\n\t{\r\n\t\t// Open an URLConnection to the BadServer servlet.\r\n\t\tURL url = new URL(m_url);\r\n\t\tURLConnection urlConnection = url.openConnection();\r\n\t\turlConnection.setDoOutput(true);\r\n\t\turlConnection.setUseCaches(false);\r\n\t\turlConnection.setRequestProperty(\"Connection\", \"close\");\r\n\t\tOutputStream os = null;\r\n\t\ttry {\r\n\t\t\tos = urlConnection.getOutputStream();\r\n\r\n\t\t\t// Only use one of the following two statements:\r\n\t\t\t//PrintWriter pw = new PrintWriter(os);\r\n\t\t\tOutputStreamWriter pw = new OutputStreamWriter(os);\r\n\r\n\t\t\tSystem.out.println(\"BadClient: About to print text. Time:\" + new Date());\r\n\r\n\t\t\t// Send some text to the second servlet.  This is the part that\r\n\t\t\t// seems to fail when running on Tomcat 3.2 under IIS using JNI.\r\n\r\n\t\t\t// If using a PrintWriter, use the println method...\r\n\t\t\t/*\r\n\t\t\tif (pw.checkError()) {\r\n\t\t\t\tSystem.out.println(\"BadClient: will do println; checkError is true.\");\r\n\t\t\t}\r\n\t\t\tpw.println(\"This is some text sent from BadClient to BadServer.\");\r\n\t\t\tif (pw.checkError()) {\r\n\t\t\t\tSystem.out.println(\"BadClient: just did println; checkError is true.\");\r\n\t\t\t}\r\n\t\t\t*/\r\n\r\n\t\t\t// ...OR, If using an OutputStreamWriter, use this statement:\r\n\t\t\tpw.write(\"This is some text sent from BadClient to BadServer...\", 0, 50);\r\n\r\n\t\t\tSystem.out.println(\"BadClient: Sent text.  Time:\" + new Date());\r\n\r\n\t\t\tString foo = request.getParameter(\"skipflush\");\r\n\t\t\tif (foo != null && foo.length() > 0) {\r\n\t\t\t\tSystem.out.println(\"BadClient: Will SKIP the pw.flush...\");\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tpw.flush();\r\n\t\t\t}\r\n\r\n\t\t\tfoo = request.getParameter(\"skipclose\");\r\n\t\t\tif (foo != null && foo.length() > 0 ) {\r\n\t\t\t\tSystem.out.println(\"Will SKIP the pw.close... \");\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tpw.close();\r\n\t\t\t}\r\n\r\n\t\t\tSystem.out.println(\"BadClient:After flush & close. Time:\" + new Date());\r\n\t\t} catch (Exception e) {\r\n\t\t\tSystem.out.println(e.toString() );\r\n\t\t\te.printStackTrace();\r\n\t\t}\r\n\t\tos.close();\r\n\r\n\t\t// Fetch an image from the second servlet\r\n\t\tBufferedInputStream bin =\r\n\t\t\t\tnew BufferedInputStream( urlConnection.getInputStream() );\r\n\r\n\t\tDataInputStream dis = new DataInputStream(bin);\r\n\r\n\t\t// Read the text that precedes the image that we'll get back\r\n\t\tString s = dis.readUTF();\r\n\t\tSystem.out.println(\"BadClient: Read header from BadServer: {\" + s + \"}\");\r\n\r\n\t\tbyte[] buf = new byte[1024];\r\n\t\tint    count;\r\n\t\t// now pump the image data to the browser\r\n\t\tOutputStream outStream = res.getOutputStream();\r\n\t\twhile ((count = dis.read(buf)) != -1) {\r\n\t\t\toutStream.write(buf, 0, count);\r\n\t\t}\r\n\t\toutStream.flush();\r\n\t\tdis.close();\r\n\t\toutStream.close();\r\n\t}\r\n\r\n\tpublic String getServletInfo() {\r\n\t\treturn \"ClientServlet Info\";\r\n\t}\r\n}\r\n// end of BadClient.java \r\n\r\n//Here is all of BadServer.java (101 lines): \r\n\r\n// BadServer.java -- demonstrates behavior that works fine in Tomcat 3.2\r\n// but does not work if Tomcat is running under IIS with JNI.\r\n// Used in conjunction with BadClient.java\r\n\r\nimport javax.servlet.*;\r\nimport javax.servlet.http.*;\r\nimport java.io.*;\r\nimport java.util.*;\r\npublic class BadServer extends HttpServlet {\r\n\r\n\tpublic void init(ServletConfig config) throws ServletException {\r\n\t\tsuper.init(config);\r\n\t}\r\n\r\n\tpublic void doPost(HttpServletRequest request, HttpServletResponse res)\r\n\t\tthrows ServletException, IOException {\r\n\r\n\t\ttry {\r\n\t\t\tSystem.out.println(\"BadServer: will read text fromclient.:\" + new Date());\r\n\r\n\t\t\t// Read in the text sent by the client servlet.\r\n\r\n\t\t\t// Only make one of the following two calls:\r\n\t\t\tuseBufferedReader(request);\r\n\t\t\t//useInputStreamReader(request);\r\n\r\n\t\t\tSystem.out.println(\"BadServer: read text from the client.:\" + new Date());\r\n\t\t}\r\n\t\tcatch (Exception e) {\r\n\t\t\tSystem.out.println(e.toString() );\r\n\t\t\te.printStackTrace();\r\n\t\t}\r\n\r\n\t\t// Send the client back some text, followed by a GIF image\r\n\t\treturnFile(res);\r\n\t}\r\n\r\n\tvoid useInputStreamReader(HttpServletRequest request)\r\n\t\t\t\tthrows IOException {\r\n\r\n\t\tString buf = null;\r\n\t\tint i = 0;\r\n\t\ttry {\r\n\t\t\tInputStream is = request.getInputStream();\r\n\t\t\tInputStreamReader br = new InputStreamReader(is);\r\n\r\n\t\t\tchar[] cbuf = new char[1024];\r\n\t\t\ti = br.read(cbuf, 0, 50);\r\n\t\t\tbuf = new String(cbuf);\r\n\t\t} catch (Exception e) {\r\n\t\t\tSystem.out.println(e.toString() );\r\n\t\t\te.printStackTrace();\r\n\t\t}\r\n\t\tSystem.out.println(\"BadServer:read returned \" + i + \" chars:\" + buf);\r\n\t}\r\n\r\n\tvoid useBufferedReader(HttpServletRequest request)\r\n\t\t\t\tthrows IOException {\r\n\t\t//InputStream is = request.getInputStream();\r\n\t\t//BufferedReader br = new BufferedReader(new InputStreamReader(is));\r\n\r\n\t\tString buf = null;\r\n\t\tint i = 0;\r\n\t\ttry {\r\n\t\t\tBufferedReader br = request.getReader();\r\n\t\t\tchar[] cbuf = new char[1024];\r\n\t\t\ti = br.read(cbuf, 0, 50);  \r\n\t\t\tbuf = new String(cbuf);\r\n\t\t} catch (Exception e) {\r\n\t\t\tSystem.out.println(e.toString() );\r\n\t\t\te.printStackTrace();\r\n\t\t}\r\n\t\tSystem.out.println(\"BadServer:readLine returned \" + i + \" chars:\" + buf);\r\n\t}\r\n\r\n\tvoid returnFile(HttpServletResponse res)\r\n\t\t\tthrows ServletException, IOException {\r\n\r\n\t\t// TODO:  If necessary, modify the following to point to a local GIF file.\r\n\t\tFile f = new File(\"D:\\\\test.gif\");\r\n\r\n\t\tBufferedInputStream bin = new BufferedInputStream(new FileInputStream(f));\r\n\t\tBufferedOutputStream os = new BufferedOutputStream(res.getOutputStream());\r\n\t\tDataOutputStream dos = new DataOutputStream(os);\r\n\t\tdos.writeUTF(\"Some text sent from BadServer!\");\r\n\r\n\t\tbyte[] buf = new byte[1024];\r\n\t\tint nRead;\r\n\r\n\t\twhile( (nRead = bin.read(buf)) != -1 ) {\r\n\t\t\t\tos.write(buf, 0, nRead);\r\n\t\t}\r\n\t\tos.flush();\r\n\t\tbin.close();\r\n\t\tSystem.out.println(\"BadServer: Flushed OS.\");\r\n\t}\r\n\r\n\tpublic String getServletInfo() {\r\n\t\treturn \"SecondServlet Information\";\r\n\t}\r\n}\r\n// end of BadServer.java \r\n", "is_private": false, "bug_id": 276, "id": 253, "time": "2000-12-04T16:03:30Z", "creator": "dev@tomcat.apache.org", "creation_time": "2000-12-04T16:03:30Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "cmanolache@yahoo.com", "attachment_id": null, "id": 5640, "time": "2001-09-16T21:49:08Z", "bug_id": 276, "creation_time": "2001-09-16T21:49:08Z", "is_private": false, "text": "It's a difficult bug, but require a lot of work - and given that jk will be subject to some big changes in close future, I think we should resolve this after. Also, JNI is probably going to be enhanced in several ways, including the interface with tomcat - and that's likely to solve this bug too."}, {"count": 2, "tags": [], "creator": "cmanolache@yahoo.com", "text": "Closing the bug - its out of date. If the problem is still there \nwith the current versions - please reopen it.", "id": 23764, "time": "2002-10-02T18:37:03Z", "bug_id": 276, "creation_time": "2002-10-02T18:37:03Z", "is_private": false, "attachment_id": null}]