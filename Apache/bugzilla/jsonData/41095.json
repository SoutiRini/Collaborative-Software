[{"count": 0, "tags": [], "bug_id": 41095, "text": "When moving from Apache 1.3 to Apache 2.2.3, we found that Etags being \ngenerated for static files changed, thus leading to an increase in the \nbandwidth usage.\n\nWe are configured to use only size and modified file time in etag generated \n(\"FileETag MTime Size\" directive). Although file modification time and size \nhasn't changed, we found the etag was different. The size part of the Etag \ndidn't change while the modified time did.\n\nInvestigating the difference in the code, i found that Apache 2.2.3 was using \na file info structure returned by APR which keeps the file modified time in \nmicroseconds structure (64 bits wide) instead of the default Unix \nsystemstructure being in seconds (32 bits wide). \n\nIn modules/http/http_etag.c, Apache will cast the microseconds structure to a \nunsigned long before calling etag_ulong_to_hex\n=> this will simply truncate value to the first 32 bits before hexadecimal \nconversion when Apache 2 is compiled in 32 bits mode (default)\n=> some data is simply lost during this conversion and doesn't ensure Etag is \ndifferent if modification time is.\n\nTwo possibilities:\n-> implement an etag_aprtimet_to_hex function to be called\n-> convert back to seconds (simply devides by APR_USEC_PER_SEC) before calling\n\nSecond solution makes sure that Etag caculation is identical between Apache \n1.3 and 2.0: when migrating, this doesn't generated different Etags.\n\nSecond solution patch (tested in my test environment):\n--- http_etag.original.c        2006-07-12 05:38:44.000000000 +0200\n+++ http_etag.c 2006-12-01 15:23:03.727393000 +0100\n@@ -139,7 +139,7 @@\n             if (bits_added != 0) {\n                 *next++ = '-';\n             }\n-            next = etag_ulong_to_hex(next, (unsigned long)r->mtime);\n+            next = etag_ulong_to_hex(next, (unsigned long)(r-\n>mtime/APR_USEC_PER_SEC));\n         }\n         *next++ = '\"';\n         *next = '\\0';", "id": 96456, "time": "2006-12-01T06:41:14Z", "creator": "christian_boitel@yahoo.fr", "creation_time": "2006-12-01T06:41:14Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "text": "This is the same root cause as bug 40064 though the desired fix may differ.\n\n*** This bug has been marked as a duplicate of 40064 ***", "is_private": false, "id": 96457, "creator": "jorton@redhat.com", "time": "2006-12-01T07:56:13Z", "bug_id": 41095, "creation_time": "2006-12-01T07:56:13Z", "attachment_id": null}]