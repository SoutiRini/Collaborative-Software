[{"count": 0, "tags": [], "creator": "hartmut.keil@gmx.ch", "text": "Overview:\n \nFor a location a ssl ciphersuite is configured, let's say \"DES-CBC3-SHA\".\nAnd that ciphersuite is not contained in the ciphersuites configured for \nthe server or virtual host, lets say \"RC4-MD5:DES-CBC3-SHA\".\nIf that location will be accessed a renegotiation is triggered in \nssl_engine_kernel.c line 283 ff about the changed ciphersuite.\n\nBut if the client wants to resume the previous session the server i.e \nwill accept that. That means a reduced handshake will be made, and the \ncurrent cipher remains unchanged!\nFrom a openssl point of view it is correct, because openssl can not\nknow the reason for that renegotiation. (see also the ssl spec.)\nBut aware of that in openssl 0.9.7 a new flag\nSSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION has been introduced.\n\nSteps to reproduce:\n\no setup a apache as descriped above:\n  ssl caching enabled, and for example RC4-MD5,DES-CBC3-SHA\n  configured for the virtual host, and DES-CBC3-SHA configured\n  for the '/' location\no connect with a java client using JSSE 1.4\no in the error_log can be seen that there is still the initial\n  cipher RC4-MD5 used after the renegotiation.\n(a ssldump is attached bellow)\n\nThat scenario has been tested with different non-java clients\n(MSIE, Mozilla). The described problem does not arise, because \nthese client are not trying to resume during the renegotiation.\n\nPatch:\n*** ssl_engine_init.c.patched   Fri Oct  1 14:15:46 2004\n--- ssl_engine_init.c   Mon Jun  7 12:18:37 2004\n***************\n*** 439,450 ****\n       * Configure additional context ingredients\n       */\n      SSL_CTX_set_options(ctx, SSL_OP_SINGLE_DH_USE);\n-\n-     /* no resumtion for a active renegotiation */\n- #if (OPENSSL_VERSION_NUMBER >= 0x00907000)\n-       SSL_CTX_set_options(ctx, SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION);\n- #endif\n-\n  }\n\n  static void ssl_init_ctx_session_cache(server_rec *s,\n--- 439,444 ----\n\nssldump:\nNew TCP connection #1: adnpool01.zh.adnovum.ch(36320) <-> doug.adnovum.ch(44300)\n1 1  0.0119 (0.0119)  C>S SSLv2 compatible client hello\n  Version 3.1\n  cipher suites\n  TLS_RSA_WITH_RC4_128_MD5\n  SSL2_CK_RC4\n  TLS_RSA_WITH_RC4_128_SHA\n  Unknown value 0x2f\n  Unknown value 0x33\n  Unknown value 0x32\n  TLS_RSA_WITH_3DES_EDE_CBC_SHA\n  SSL2_CK_3DES\n  TLS_DHE_RSA_WITH_3DES_EDE_CBC_SHA\n  TLS_DHE_DSS_WITH_3DES_EDE_CBC_SHA\n  TLS_RSA_WITH_DES_CBC_SHA\n  SSL2_CK_DES\n  TLS_DHE_RSA_WITH_DES_CBC_SHA\n  TLS_DHE_DSS_WITH_DES_CBC_SHA\n  TLS_RSA_EXPORT_WITH_RC4_40_MD5\n  SSL2_CK_RC4_EXPORT40\n  TLS_RSA_EXPORT_WITH_DES40_CBC_SHA\n  TLS_DHE_RSA_EXPORT_WITH_DES40_CBC_SHA\n  TLS_DHE_DSS_EXPORT_WITH_DES40_CBC_SHA\n1 2  0.0153 (0.0034)  S>C  Handshake\n      ServerHello\n        Version 3.1\n        session_id[32]=\n          0e 5e de 9d 66 47 36 ed 52 ad 43 e5 3f e8 4b 65\n          96 d4 47 f2 e7 00 f0 0f 81 4f 91 54 3c 55 97 f4\n        cipherSuite         TLS_RSA_WITH_RC4_128_MD5\n        compressionMethod                   NULL\n1 3  0.0153 (0.0000)  S>C  Handshake\n      Certificate\n1 4  0.0153 (0.0000)  S>C  Handshake\n      ServerHelloDone\n1 5  0.1112 (0.0959)  C>S  Handshake\n      ClientKeyExchange\n1 6  0.1175 (0.0062)  C>S  ChangeCipherSpec\n1 7  0.1252 (0.0076)  C>S  Handshake\n      Finished\n1 8  0.1905 (0.0653)  S>C  ChangeCipherSpec\n1 9  0.1905 (0.0000)  S>C  Handshake\n      Finished\n1 10 0.2025 (0.0120)  C>S  application_data\n    ---------------------------------------------------------------\n    GET /index.html HTTP/1.1\n    User-Agent: httpunit-client\n    Accept-Encoding: gzip\n    Cache-Control: no-cache\n    Pragma: no-cache\n    Host: doug.adnovum.ch:44300\n    Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2\n    Connection: keep-alive\n\n    ---------------------------------------------------------------\n1 11 0.2051 (0.0025)  S>C  Handshake\n      HelloRequest\n1 12 0.2071 (0.0019)  C>S  Handshake\n      ClientHello\n        Version 3.1\n        resume [32]=\n          0e 5e de 9d 66 47 36 ed 52 ad 43 e5 3f e8 4b 65\n          96 d4 47 f2 e7 00 f0 0f 81 4f 91 54 3c 55 97 f4\n        cipher suites\n        TLS_RSA_WITH_RC4_128_MD5\n        TLS_RSA_WITH_RC4_128_SHA\n        Unknown value 0x2f\n        Unknown value 0x33\n        Unknown value 0x32\n        TLS_RSA_WITH_3DES_EDE_CBC_SHA\n        TLS_DHE_RSA_WITH_3DES_EDE_CBC_SHA\n        TLS_DHE_DSS_WITH_3DES_EDE_CBC_SHA\n        TLS_RSA_WITH_DES_CBC_SHA\n        TLS_DHE_RSA_WITH_DES_CBC_SHA\n        TLS_DHE_DSS_WITH_DES_CBC_SHA\n        TLS_RSA_EXPORT_WITH_RC4_40_MD5\n        TLS_RSA_EXPORT_WITH_DES40_CBC_SHA\n        TLS_DHE_RSA_EXPORT_WITH_DES40_CBC_SHA\n        TLS_DHE_DSS_EXPORT_WITH_DES40_CBC_SHA\n        compression methods\n                  NULL\n1 13 0.2113 (0.0042)  S>C  Handshake\n      ServerHello\n        Version 3.1\n        session_id[32]=\n          0e 5e de 9d 66 47 36 ed 52 ad 43 e5 3f e8 4b 65\n          96 d4 47 f2 e7 00 f0 0f 81 4f 91 54 3c 55 97 f4\n        cipherSuite         TLS_RSA_WITH_RC4_128_MD5\n        compressionMethod                   NULL\n1 14 0.2113 (0.0000)  S>C  ChangeCipherSpec\n1 15 0.2113 (0.0000)  S>C  Handshake\n      Finished\n1 16 0.2190 (0.0076)  C>S  ChangeCipherSpec\n1 17 0.2195 (0.0005)  C>S  Handshake\n      Finished\n1 18 0.3120 (0.0925)  S>C  application_data\n    ---------------------------------------------------------------\n    HTTP/1.1 200 OK\n    Date: Fri, 01 Oct 2004 12:27:19 GMT\n    Server: Apache\n    Content-Type: text/html\n    Content-Length: 383\n    Connection: close\n\n    ---------------------------------------------------------------\n1 19 0.3120 (0.0000)  S>C  application_data\n    ---------------------------------------------------------------\n    <!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.0 Transitional//EN\"\n\"http://www.w3.org/TR/REC-html40/loose.dtd\">\n    <HTML>\n    <HEAD>\n    <TITLE>Welcome</TITLE>\n    <LINK REL=\"STYLESHEET\" HREF=\"css/styles.css\" TYPE=\"text/css\"></HEAD>\n    <BODY BGCOLOR=\"#FFFFFF\">\n    <CENTER><H2>\n    <DIV align=right><IMG SRC=\"img/Nevis_f2.gif\" border=0 /></DIV>\n    Welcome to the Nevisweb Reverse Proxy\n    </H2></CENTER>\n    </BODY></HTML>\n    ---------------------------------------------------------------\n1 20 0.3134 (0.0014)  S>C  Alert\n    level           warning\n    value           close_notify\n1    0.3142 (0.0007)  S>C  TCP FIN\n1 21 0.3173 (0.0031)  C>S  Alert\n    level           warning\n    value           close_notify\n1    0.3176 (0.0003)  C>S  TCP FIN", "id": 64479, "time": "2004-10-01T14:30:11Z", "bug_id": 31505, "creation_time": "2004-10-01T14:30:11Z", "is_private": false, "attachment_id": null}, {"count": 1, "attachment_id": null, "bug_id": 31505, "is_private": false, "id": 64811, "time": "2004-10-08T07:24:59Z", "creator": "jorton@redhat.com", "creation_time": "2004-10-08T07:24:59Z", "tags": [], "text": "Thanks for reporting and fixing this, Hartmut. Since this is a security issue,\nit has been assigned CVE name CAN-2004-0885 for tracking purposes."}, {"count": 2, "attachment_id": null, "bug_id": 31505, "is_private": false, "id": 64822, "time": "2004-10-08T11:51:19Z", "creator": "jorton@redhat.com", "creation_time": "2004-10-08T11:51:19Z", "tags": [], "text": "OK, this patch is not of course sufficient to fix the security issue since it\nonly enforces the correct behaviour with OpenSSL 0.9.7.  To actually prevent\naccess with both 0.9.7 and 0.9.6, it's necessary to enhance SSL_hook_Access to\nreally check that the correct cipher suite has been negotiated."}, {"count": 3, "tags": [], "text": "To make it working also with OpenSSL 0.9.6 you have to use\nSSL_CTX_set_session_id_context(..) for disabling a sucessfull \ncache lookup.\nBut I would skipp supporting OpenSSL 0.9.6 for that special case,\nand just add the mentioned cipher check. That check would trigger \nfor OpenSSL 0.9.6 and we have a clear situation. ", "is_private": false, "bug_id": 31505, "id": 64826, "time": "2004-10-08T12:42:01Z", "creator": "hartmut.keil@gmx.ch", "creation_time": "2004-10-08T12:42:01Z", "attachment_id": null}, {"count": 4, "attachment_id": null, "bug_id": 31505, "is_private": false, "id": 64827, "time": "2004-10-08T12:49:36Z", "creator": "jorton@redhat.com", "creation_time": "2004-10-08T12:49:36Z", "tags": [], "text": "This is what I committed:\n\nhttp://cvs.apache.org/viewcvs.cgi/httpd-2.0/modules/ssl/ssl_engine_kernel.c?r1=1.110&r2=1.111\nhttp://cvs.apache.org/viewcvs.cgi/httpd-2.0/modules/ssl/ssl_engine_init.c?r1=1.128&r2=1.129\n\nso now with 0.9.6 you'll simply get a 403 if you try and access a\ndifferently-ciphersuite-protected resource with a client which tries to resume a\nsession during the renegotiation, and the ciphersuite in the resumed session is\nnot sufficient.\n\nWith 0.9.7 even with such a client, you shouldn't hit the check since OpenSSL\nwill refuse to resume the session.\n\nThis should have all bases covered, have I missed anything?"}, {"count": 5, "text": "Proposed for backport for the next 2.0 release.  For reference for those looking\nfor an equivalent mod_ssl 2.8 patch:\n\nhttp://marc.theaimsgroup.com/?l=apache-modssl&m=109724918128044&q=raw", "bug_id": 31505, "is_private": false, "id": 65044, "time": "2004-10-13T09:46:50Z", "creator": "jorton@redhat.com", "creation_time": "2004-10-13T09:46:50Z", "tags": [], "attachment_id": null}]