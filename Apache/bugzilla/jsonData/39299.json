[{"count": 0, "tags": [], "text": "Litmus test case copy_nodestcoll (a COPY request where the parent of the\ndestination resource does not exist) fails with status 500 (instead of 409).\n\nThe error log shows:\n\n[Thu Apr 13 14:37:58 2006] [error] [client 192.168.1.45] Could not MOVE/COPY\n/test/litmus/copysrc.  [500, #0]\n[Thu Apr 13 14:37:58 2006] [error] [client 192.168.1.45] (2)No such file or\ndirectory: Could not open file for writing  [500, #0]\n\nExcerpt from debug.log created by Litmus:\n\n******* Running test 5: copy_nodestcoll ********\nah_create, for WWW-Authenticate\nRunning pre_send hooks\nNot handling session.\nSending request headers:\nCOPY /test/litmus/copysrc HTTP/1.1^M\nHost: krusty^M\nUser-Agent: litmus/0.10.5 neon/0.25.4^M\nConnection: TE^M\nTE: trailers^M\nDepth: 0^M\nDestination: http://krusty/test/litmus/nonesuch/foo^M\nOverwrite: F^M\nX-Litmus: copymove: 5 (copy_nodestcoll)^M\n^M\nSending request-line and headers:\nRequest sent; retry is 1.\n[status-line] < HTTP/1.1 500 Internal Server Error^M\n[hdr] Date: Thu, 13 Apr 2006 12:37:58 GMT^M\nHeader Name: [date], Value: [Thu, 13 Apr 2006 12:37:58 GMT]\n[hdr] Server: Apache/2.0.55 (Unix) mod_ssl/2.0.55 OpenSSL/0.9.7b DAV/2 mod_jk/1.\n2.15^M\nHeader Name: [server], Value: [Apache/2.0.55 (Unix) mod_ssl/2.0.55 OpenSSL/0.9.7\nb DAV/2 mod_jk/1.2.15]\n[hdr] Vary: accept-language,accept-charset^M\nHeader Name: [vary], Value: [accept-language,accept-charset]\n[hdr] Accept-Ranges: bytes^M\nHeader Name: [accept-ranges], Value: [bytes]\n[hdr] Connection: close^M\nHeader Name: [connection], Value: [close]\n[hdr] Content-Type: text/html; charset=iso-8859-1^M\nHeader Name: [content-type], Value: [text/html; charset=iso-8859-1]\n[hdr] Content-Language: en^M\nHeader Name: [content-language], Value: [en]\n[hdr] ^M\nEnd of headers.\nReading 8192 bytes of response body.\nGot 1110 bytes.\nRead block (1110 bytes):\n...", "attachment_id": null, "bug_id": 39299, "id": 87905, "time": "2006-04-13T13:55:13Z", "creator": "julian.reschke@gmx.de", "creation_time": "2006-04-13T13:55:13Z", "is_private": false}, {"count": 1, "tags": [], "creator": "basant.kukreja@sun.com", "attachment_id": null, "is_private": false, "id": 99336, "time": "2007-02-13T10:24:16Z", "bug_id": 39299, "creation_time": "2007-02-13T10:24:16Z", "text": "I am able to reproduce the bug in 2.2.x branch"}, {"count": 2, "tags": [], "bug_id": 39299, "attachment_id": 19581, "id": 99342, "time": "2007-02-13T14:50:46Z", "creator": "basant.kukreja@sun.com", "creation_time": "2007-02-13T14:50:46Z", "is_private": false, "text": "Created attachment 19581\nFix for wrong HTTP return code.\n\nIf we send the COPY HTTP request and the destination points to a file whose\ndirectory doesn't exist then apache returned 500 error.\n\nIn this fix, we check the destination directory (do stat on it) and\nif we failed to stat on the directory then we return 409.\n\nHere is the request :\nCOPY /DAVtest/litmus/copysrc HTTP/1.1\nHost: lbasantk3.red.iplanet.com:4004\nUser-Agent: litmus/0.11 neon/0.25.5\nConnection: TE\nTE: trailers\nDepth: 0\nDestination: http://hostname.domainname:4004/DAVtest/litmus/nonesuch/foo\nOverwrite: F\nX-Litmus: copymove: 5 (copy_nodestcoll)\n\n\nNew response :\n--------------------------------------------------\nHTTP/1.1 409 Conflict\nDate: Tue, 13 Feb 2007 22:44:16 GMT\nServer: Apache/2.2.5-dev (Unix) DAV/2 mod_perl/2.0.4-dev Perl/v5.8.8\nContent-Length: 509\nContent-Type: text/html; charset=iso-8859-1\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>409 Conflict</title>\n</head><body>\n<h1>Conflict</h1>\n<p>The server encountered an internal error or\nmisconfiguration and was unable to complete\nyour request.</p>\n<p>Please contact the server administrator,\n you@example.com and inform them of the time the error occurred,\nand anything you might have done that may have\ncaused the error.</p>\n<p>More information about this error may be available\nin the server error log.</p>\n</body></html>\n--------------------------------------------------\nLog message in apache log file appears as \n[Tue Feb 13 14:44:16 2007] [error] [client 192.18.120.216] Could not MOVE/COPY\n/DAVtest/litmus/copysrc.  [409, #0]\n[Tue Feb 13 14:44:16 2007] [error] [client 192.18.120.216] (2)No such file or\ndirectory: /disk/apache/apache2/htdocs/DAVtest/litmus/nonesuch/  [409, #0]\n--------------------------------------------------"}, {"count": 3, "tags": [], "creator": "basant.kukreja@sun.com", "attachment_id": null, "is_private": false, "id": 99343, "time": "2007-02-13T14:52:14Z", "bug_id": 39299, "creation_time": "2007-02-13T14:52:14Z", "text": "Adding keyword PatchAvailable"}, {"count": 4, "tags": [], "creator": "basant.kukreja@sun.com", "attachment_id": null, "is_private": false, "id": 99980, "time": "2007-03-02T10:53:03Z", "bug_id": 39299, "creation_time": "2007-03-02T10:53:03Z", "text": "Suggested fix is incomplete.\n\nHere is the another issue (kind of extension to this bug ) related with this :\n\nFor configuration like :\n\nDavLockDB /disk/apache/apache2/var/DAVLockFs\n<Directory \"/disk/apache/apache2/htdocs/DAVtest\">\nOptions Indexes FollowSymLinks\nAllowOverride None\norder allow,deny\nallow from all\nAuthName \"SMA Development server\"\nAuthType Basic\nDAV On\n</Directory>\n\nIf the request is :\n\nCOPY /DAVtest/litmus/copysrc HTTP/1.1\nHost: myhostname.mydomain:4004\nUser-Agent: litmus/0.11 neon/0.25.5\nConnection: TE\nTE: trailers\nDepth: 0\nDestination: http://myhostname.mydomain:4004/DAVtest1/litmus/nonesuch/foo\nOverwrite: F\nX-Litmus: copymove: 5 (copy_nodestcoll)\n\nthen apache dies. Here is the stack trace :\n\n(gdb) c\nContinuing.\n\nProgram received signal SIGSEGV, Segmentation fault.\n[Switching to Thread -1221944416 (LWP 12041)]\n0x080bf0e0 in dav_get_resource (r=0x8635d18, label_allowed=0, use_checked_in=0,\nres_p=0xb72a9224)\n    at mod_dav.c:724\n724         err = (*conf->provider->repos->get_resource)(r, conf->dir,\n(gdb) where 10\n#0  0x080bf0e0 in dav_get_resource (r=0x8635d18, label_allowed=0,\nuse_checked_in=0, res_p=0xb72a9224)\n    at mod_dav.c:724\n#1  0x080c3012 in dav_method_copymove (r=0x8631d08, is_move=0) at mod_dav.c:2642\n#2  0x080c70f7 in dav_handler (r=0x8631d08) at mod_dav.c:4656\n#3  0x08080e31 in ap_run_handler (r=0x8631d08) at config.c:157\n#4  0x0808157b in ap_invoke_handler (r=0x8631d08) at config.c:372\n#5  0x080b767c in ap_process_request (r=0x8631d08) at http_request.c:258\n#6  0x080b41fe in ap_process_http_connection (c=0x84d3a40) at http_core.c:184\n#7  0x08089373 in ap_run_process_connection (c=0x84d3a40) at connection.c:43\n#8  0x08089786 in ap_process_connection (c=0x84d3a40, csd=0x84d3890) at\nconnection.c:178\n#9  0x080f25fc in process_socket (p=0x84d3858, sock=0x84d3890, my_child_num=0,\nmy_thread_num=0,\n    bucket_alloc=0x862fcc8) at worker.c:544\n(More stack frames follow...)\n(gdb) p conf\n$1 = (dav_dir_conf *) 0x84396f8\n(gdb) p conf->provider\n$2 = (const dav_provider *) 0x0\n(gdb)\n\nThe reason is :\n\n    conf = ap_get_module_config(r->per_dir_config, &dav_module);\n    /* assert: conf->provider != NULL */\n\n    /* resolve the resource */\n    err = (*conf->provider->repos->get_resource)(r, conf->dir,\n                                                 label, use_checked_in,\n                                                 res_p);\n\ndav_get_resource doesn't check if there is no provider in conf and try to access\nthe resource. This case also needs to be handled.\n\nRemoving the keyword PatchAvailable so that we can provide the fix\nfor this issue too.\n\n"}, {"count": 5, "tags": [], "creator": "basant.kukreja@sun.com", "attachment_id": 19673, "is_private": false, "id": 100109, "time": "2007-03-06T16:47:27Z", "bug_id": 39299, "creation_time": "2007-03-06T16:47:27Z", "text": "Created attachment 19673\nRevised patch.\n\nIn summary there were two issues with COPY method.\n(a) If Destination directory doesn't exist but it is still inside the DAV\ndirectory, apache returned 500. In this fix if destination directory doesn't\nexist, we return 409 Conflict.\n(b) If Destination directory doesn't fall under a DAV provider, apache crashes.\n\nIn this fix if Destination directory doesn't exist then 403 forbidden is\nreturned.\n\nHere are response code suggested by rfc 2518 :\nhttp://asg.web.cmu.edu/rfc/rfc2518.html#sec-8.8\n\n\nHere is how I did the testing :\n\nmy httpd.conf has following configuration :\n\n<Directory \"/disk/apache/apache2/htdocs/DAVtest\">\nOptions Indexes FollowSymLinks\nAllowOverride None\norder allow,deny\nallow from all\nAuthName \"SMA Development server\"\nAuthType Basic\nDAV On\n</Directory>\n\n<Directory \"/disk/apache/apache2/htdocs/DAVOtherTest\">\nOptions Indexes FollowSymLinks\nAllowOverride None\norder allow,deny\nallow from all\nAuthName \"SMA Development server\"\nAuthType Basic\nDAV On\n</Directory>\n\n\n---------------------------------------\nTest 1 : Destination is outside DAV collection.\n\nCOPY /DAVtest/litmus/copysrc HTTP/1.1\nHost: localhost:4004\nUser-Agent: litmus/0.11 neon/0.25.5\nConnection: TE\nTE: trailers\nDepth: 0\nDestination: http://localhost:4004/DAVtest1/litmus/nonesuch/foo\nOverwrite: F\nX-Litmus: copymove: 5 (copy_nodestcoll)\n\nResponse :\n\nDate: Wed, 07 Mar 2007 00:32:52 GMT\nServer: Apache/2.2.5-dev (Unix) mod_ssl/2.2.5-dev OpenSSL/0.9.8a DAV/2\nSVN/1.4.3 mod_perl/2.0.4-dev Perl/v5.8.8\nContent-Length: 178\nContent-Type: text/html\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>403 Forbidden</title>\n</head><body>\n<h1>Forbidden</h1>\n<p>Destination URI had an error.</p>\n</body></html>\n\n---------------------------------------\nTest 2 : Destination is inside DAV collection but it doesn't exists.\n\nCOPY /DAVtest/litmus/copysrc HTTP/1.1\nHost: localhost:4004\nUser-Agent: litmus/0.11 neon/0.25.5\nConnection: TE\nTE: trailers\nDepth: 0\nDestination: http://localhost:4004/DAVtest/litmus/nonesuch/foo\nOverwrite: F\nX-Litmus: copymove: 5 (copy_nodestcoll)\n\n\nDate: Wed, 07 Mar 2007 00:33:02 GMT\nServer: Apache/2.2.5-dev (Unix) mod_ssl/2.2.5-dev OpenSSL/0.9.8a DAV/2\nSVN/1.4.3 mod_perl/2.0.4-dev Perl/v5.8.8\nContent-Length: 509\nContent-Type: text/html; charset=iso-8859-1\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>409 Conflict</title>\n</head><body>\n<h1>Conflict</h1>\n<p>The server encountered an internal error or\nmisconfiguration and was unable to complete\nyour request.</p>\n<p>Please contact the server administrator,\n you@example.com and inform them of the time the error occurred,\nand anything you might have done that may have\ncaused the error.</p>\n<p>More information about this error may be available\nin the server error log.</p>\n</body></html>\n---------------------------------------\nTest 3 : Destination is in other DAV collection\n\nCOPY /DAVtest/litmus/copysrc HTTP/1.1\nHost: localhost:4004\nUser-Agent: litmus/0.11 neon/0.25.5\nConnection: TE\nTE: trailers\nDepth: 0\nDestination: http://localhost:4004/DAVOtherTest/foo\nOverwrite: F\nX-Litmus: copymove: 5 (copy_nodestcoll)\n\nDate: Wed, 07 Mar 2007 00:40:18 GMT\nServer: Apache/2.2.5-dev (Unix) mod_ssl/2.2.5-dev OpenSSL/0.9.8a DAV/2\nSVN/1.4.3 mod_perl/2.0.4-dev Perl/v5.8.8\nLocation: http://localhost:4004/DAVOtherTest/foo\nContent-Length: 192\nContent-Type: text/html\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>201 Created</title>\n</head><body>\n<h1>Created</h1>\n<p>Destination /DAVOtherTest/foo has been created.</p>\n</body></html>\n---------------------------------------"}, {"count": 6, "tags": [], "creator": "basant.kukreja@sun.com", "attachment_id": 19673, "is_private": false, "id": 100110, "time": "2007-03-06T16:51:47Z", "bug_id": 39299, "creation_time": "2007-03-06T16:51:47Z", "text": "Comment on attachment 19673\nRevised patch.\n\nIndex: modules/dav/fs/repos.c\n===================================================================\n--- modules/dav/fs/repos.c\t(revision 500367)\n+++ modules/dav/fs/repos.c\t(working copy)\n@@ -348,8 +348,19 @@\n     status = apr_file_open(&outf, dst, APR_WRITE | APR_CREATE | APR_TRUNCATE\n\t\t\t    | APR_BINARY, perms, p);\n     if (status != APR_SUCCESS) {\n+\t char *dirpath = NULL;\n+\t apr_finfo_t dir_finfo;\n+\t apr_status_t rv;\n\t apr_file_close(inf);\n\n+\t /* check if destination directory exists if not then return\n+\t  * HTTP_CONFLICT\n+\t  */\n+\t dirpath = ap_make_dirstr_parent(p, dst);\n+\t rv = apr_stat(&dir_finfo, dirpath, APR_FINFO_NORM, p);\n+\t if (rv != APR_SUCCESS)\n+\t     return dav_new_error(p, HTTP_CONFLICT, 0, dirpath);\n+\n\t return dav_new_error(p, MAP_IO2HTTP(status), 0,\n\t\t\t      \"Could not open file for writing\");\n     }\nIndex: modules/dav/main/mod_dav.c\n===================================================================\n--- modules/dav/main/mod_dav.c\t(revision 500367)\n+++ modules/dav/main/mod_dav.c\t(working copy)\n@@ -2637,6 +2637,10 @@\n\t return dav_error_response(r, lookup.rnew->status,\n\t\t\t\t   \"Destination URI had an error.\");\n     }\n+    if (!dav_get_provider(lookup.rnew)) {\n+\t return dav_error_response(r, HTTP_FORBIDDEN,\n+\t\t\t\t   \"Destination URI had an error.\");\n+    }\n\n     /* Resolve destination resource */\n     err = dav_get_resource(lookup.rnew, 0 /* label_allowed */,"}, {"count": 7, "tags": [], "text": "Created attachment 19674\nRevised Patch\n\nBy mistake I attached comments as patch previously. Sorry for that. (Is there a\nway to delete it?).", "attachment_id": 19674, "bug_id": 39299, "id": 100111, "time": "2007-03-06T16:54:37Z", "creator": "basant.kukreja@sun.com", "creation_time": "2007-03-06T16:54:37Z", "is_private": false}, {"count": 8, "tags": [], "text": "For me the 500 on COPY occurs when source file is not readable (-w--w---- for example) and the \ndestination is OK:\n\n[Thu Dec 13 19:20:50 2007] [error] [client 127.0.0.1] Could not \nMOVE/COPY /uploads/kermit-ui/dialog.diff.  [500, #0]\n[Thu Dec 13 19:20:50 2007] [error] [client 127.0.0.1] (13)Permission denied: Could not open file for \nreading  [500, #0]\n\n\nI think it should return 403 or something, but not 500.", "attachment_id": null, "bug_id": 39299, "id": 111782, "time": "2007-12-13T10:43:04Z", "creator": "malinowskirafal@wp.pl", "creation_time": "2007-12-13T10:43:04Z", "is_private": false}, {"count": 9, "tags": [], "creator": "michael@metaparadigm.com", "attachment_id": null, "text": "There is no need to perform the additional stat in the ENOENT case as the\npreceding apr_file_open has the APR_CREATE flag set. This means the ENOENT\nstatus will mean that an intermediate directory does not exist (man 2 open).\nAlthough it could also mean a dangling symlink in the intermediate path,\nthis is for all intents and purposes equivalent - it should still be a 409.\n\nAttaching a simpler patch shortly.\n\nAlthough the patch does not fix a second (independent) problem\n(COPY/MOVE from a non readable source should not return 500) I don't see\nwhy this is a reason why not to fix one of these bugs.\n\nThe original report for the litmus test is:\n(COPY/MOVE to a destination collection where an intermediate does not exist\nshould return 403) which is what the patch fixes.\n\nPerhaps a new bug should be created (COPY/MOVE from a non readable source\nshould not return 500) or this one left open and retitled - but can we\npossbily apply a fix for one of these bugs.\n", "id": 112510, "time": "2008-01-04T21:48:07Z", "bug_id": 39299, "creation_time": "2008-01-04T21:48:07Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 39299, "text": "Created attachment 21345\nrevised patch without additional apr_stat\n\nreformulate previous patch removing redundant apr_stat call and providing a\nmore informative error message.\n\nfixes the \"COPY/MOVE to a destination collection where an intermediate\ndirectory does not exist should return 409\" case. verified with litmus that it\nfixes the warning on the copy_nodestcoll test.\n\nthe mod_dav.c fragment fixes a related but distinct issue (COPY/MOVE to a\ndestination URI with no provider causes segfault) - not specifically tested but\nlimtus passes and so do general tests with OS X DAV client.\n\nCOPY/MOVE from a non readable source should not return 500 issue not addressed\nin this patch although I believe this is a separate bug.", "id": 112511, "time": "2008-01-04T22:04:02Z", "creator": "michael@metaparadigm.com", "creation_time": "2008-01-04T22:04:02Z", "is_private": false, "attachment_id": 21345}, {"count": 11, "tags": [], "creator": "sf@sfritsch.de", "attachment_id": null, "is_private": false, "id": 131823, "time": "2009-11-09T07:29:21Z", "bug_id": 39299, "creation_time": "2009-11-09T07:29:21Z", "text": "The segfault part is already fixed in trunk and 2.2.x as PR 44734.\n\nThe 500 instead of 409 part is fixed in trunk as r834073 and r834107"}, {"count": 12, "tags": [], "bug_id": 39299, "text": "Created attachment 26610\nmobile device error report\n\nerror created by blackberry.com", "id": 144003, "time": "2011-02-05T20:39:20Z", "creator": "cbr11ee@hotmail.co.uk", "creation_time": "2011-02-05T20:39:20Z", "is_private": false, "attachment_id": 26610}, {"count": 13, "tags": [], "bug_id": 39299, "attachment_id": null, "id": 198807, "time": "2017-05-16T23:06:11Z", "creator": "wiml@omnigroup.com", "creation_time": "2017-05-16T23:06:11Z", "is_private": false, "text": "(In reply to Stefan Fritsch from comment #11)\n> The segfault part is already fixed in trunk and 2.2.x as PR 44734.\n> \n> The 500 instead of 409 part is fixed in trunk as r834073 and r834107\n\nThis bug still exists in 2.4.25 (on MacOSX):\n\n% cadaver https://slenderpoke.local:8001/test2/\nAuthentication required for My Test Realm on server `slenderpoke.local':\nUsername: test2\nPassword: \ndav:/test2/> mkcol foo\nCreating `foo': succeeded.\ndav:/test2/> mkcol foo/bar\nCreating `foo/bar': succeeded.\ndav:/test2/> put httpd-bug39299.pl foo/bar/somefile\nUploading httpd-bug39299.pl to `/test2/foo/bar/somefile':\nProgress: [=============================>] 100.0% of 1158 bytes succeeded.\ndav:/test2/> mv foo/bar/somefile foo/baz/somefile\nMoving `/test2/foo/bar/somefile' to `/test2/foo/baz/somefile':  failed:\n500 Internal Server Error\n\nThe 2.4.x branch was branched from r1200449, so it should include r834073 and r834107."}, {"count": 14, "tags": [], "bug_id": 39299, "text": "The bug also still exists in httpd built from the trunk (r1795372):\n\n\ndav:/bugzilla39299/> mkcol fromcoll\nCreating `fromcoll': succeeded.\ndav:/bugzilla39299/> put testfile fromcoll/somefile\nUploading testfile to `/bugzilla39299/fromcoll/somefile':\nProgress: [=============================>] 100.0% of 18 bytes succeeded.\ndav:/bugzilla39299/> mv fromcoll/somefile tocoll/somefile\nMoving `/bugzilla39299/fromcoll/somefile' to `/bugzilla39299/tocoll/somefile':  failed:\n500 Internal Server Error\ndav:/bugzilla39299/> mkcol tocoll\nCreating `tocoll': succeeded.\ndav:/bugzilla39299/> mv fromcoll/somefile tocoll/somefile\nMoving `/bugzilla39299/fromcoll/somefile' to `/bugzilla39299/tocoll/somefile':  succeeded.\n\n\n[Tue May 16 23:15:33.225431 2017] [dav:error] [pid 69020:tid 123145307131904] [client 127.0.0.1:65432] Could not MOVE/COPY /bugzilla39299/fromcoll/somefile.  [500, #0]\n[Tue May 16 23:15:33.225463 2017] [dav:error] [pid 69020:tid 123145307131904] (2)No such file or directory: [client 127.0.0.1:65432] Could not rename resource.  [500, #0]", "id": 198808, "time": "2017-05-16T23:28:46Z", "creator": "wiml@omnigroup.com", "creation_time": "2017-05-16T23:28:46Z", "is_private": false, "attachment_id": null}]