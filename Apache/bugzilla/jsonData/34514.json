[{"count": 0, "tags": [], "bug_id": 34514, "text": "Hi there. I've recently updated to apache 2.0.54, compiled it and started it\nafter a period of time the apache did dies with those messages in the error_log.\n[Mon Apr 18 18:46:47 2005] [notice] Apache configured -- resuming normal operations\n[Tue Apr 19 03:19:18 2005] [error] server reached MaxClients setting, consider\nraising the MaxClients setting\n[Tue Apr 19 03:19:35 2005] [alert] (11)Resource temporarily unavailable:\napr_thread_create: unable to create listener thread\n[Tue Apr 19 03:19:35 2005] [alert] (11)Resource temporarily unavailable:\napr_thread_create: unable to create worker thread\n[Tue Apr 19 03:19:35 2005] [alert] (11)Resource temporarily unavailable:\napr_thread_create: unable to create worker thread\n[Tue Apr 19 03:19:35 2005] [alert] (11)Resource temporarily unavailable:\napr_thread_create: unable to create worker thread\n[Tue Apr 19 03:19:35 2005] [alert] (11)Resource temporarily unavailable:\napr_thread_create: unable to create worker thread\n[Tue Apr 19 03:19:35 2005] [alert] (11)Resource temporarily unavailable:\napr_thread_create: unable to create worker thread\n[Tue Apr 19 03:19:35 2005] [alert] (11)Resource temporarily unavailable:\napr_thread_create: unable to create listener thread\n[Tue Apr 19 03:19:50 2005] [alert] Child 16015 returned a Fatal error... Apache\nis exiting!\nI've no problems on the same servers with apache 2.0.53. So obviously the\nproblem is new. here is my configure options I use with the apache.\n\n#! /bin/sh\n#\n# Created by configure\n\n\"./configure\" \\\n\"--disable-autoindex\" \\\n\"--libdir=/usr/local/lib\" \\\n\"--disable-negotiation\" \\\n\"--with-mpm=worker\" \\\n\"--disable-userdir\" \\\n\"--disable-ssl\" \\\n\"--enable-include\" \\\n\"--enable-auth\" \\\n\"--enable-auth-digest\" \\\n\"--enable-vhost-alias\" \\\n\"--enable-access\" \\\n\"--enable-asis\" \\\n\"--enable-imap\" \\\n\"--enable-actions\" \\\n\"--disable-autoindex\" \\\n\"--enable-env\" \\\n\"--enable-setenvif\" \\\n\"--enable-mime\" \\\n\"--disable-charset-lite\" \\\n\"--enable-auth-digest\" \\\n\"--enable-log-config\" \\\n\"--enable-deflate\" \\\n\"--enable-http\" \\\n\"--enable-rewrite\" \\\n\"--enable-so\" \\\n\"--enable-dir\" \\\n\"--enable-nonportable-atomics=yes\" \\\n\"--sysconfdir=/usr/local/apache2/conf\" \\\n\"--sbindir=/usr/local/apache2/sbin\" \\\n\"--bindir=/usr/local/apache2/bin\" \\\n\"--enable-status\" \\\n\"$@\"\nIt happens two times with the same server for 1 day. Oh and yes the server is\nrunning fedora core 1. Another problem i did observed with apache was. That\napache was linked to libiconv.so after compiling and it did not find the\nlibabrary ( the library is in /usr/local/lib ). When i specify the\n--libdir=/usr/local/lib the problem goes away, but i guess this should not be\nthe primary behaviour. The strange thing about the second problem was that it\ndid not produce error messages when \"configuring and making\" and after\ncompilation it was linked to \"a missing\" library.\n\nHope the problems would be fixed soon.\n\nTons of regards, \nhip0\n-=-=", "id": 73788, "time": "2005-04-19T09:37:14Z", "creator": "hipo@design.bg", "creation_time": "2005-04-19T09:37:14Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "id": 73800, "time": "2005-04-19T14:57:36Z", "bug_id": 34514, "creation_time": "2005-04-19T14:57:36Z", "is_private": false, "text": "What configuration are you using for worker? (settings of MaxClients etc)\n\nw.r.t. the second problem you should just avoid having installing libiconv on a\nmodern Linux system, the libc includes an iconv implementation already."}, {"count": 2, "text": "Here are the MaxClients etc. settings.\nTimeout 10\nKeepAlive On\nMaxKeepAliveRequests 10\nKeepAliveTimeout 5\nMaxClients      300\nStartServers     5\nMinSpareServers 10\nMaxSpareServers 30\nStartServers    2\nMinSpareThreads 50\nMaxSpareThreads 150\nThreadsPerChild 25\nMaxRequestsPerChild  10000\nServerLimit 400\nUseCanonicalName Off\n\n\nIf you need something else just tell me. Hope that would help.", "bug_id": 34514, "attachment_id": null, "id": 73812, "time": "2005-04-19T16:01:51Z", "creator": "hipo@design.bg", "creation_time": "2005-04-19T16:01:51Z", "tags": [], "is_private": false}, {"count": 3, "text": "I reversed back to the old apache 2.0.53. And the same thing happened again. The\nonly thing i've changed to the server recently was the ulimits for all users so\nprobably the bug is concerning it. All users had soft limit of process spawn set\nto 300 and hard limit of process spawn set to 400. here is my output of ulimit -a;\n[root@fresh-ringtones logs]# ulimit -a\ncore file size        (blocks, -c) 0\ndata seg size         (kbytes, -d) unlimited\nfile size             (blocks, -f) unlimited\nmax locked memory     (kbytes, -l) unlimited\nmax memory size       (kbytes, -m) unlimited\nopen files                    (-n) 1024\npipe size          (512 bytes, -p) 8\nstack size            (kbytes, -s) 10240\ncpu time             (seconds, -t) unlimited\nmax user processes            (-u) 300\nvirtual memory        (kbytes, -v) unlimited\n[root@fresh-ringtones logs]# logout\n\nAnyway i think apache should not exit in a condition but rather, sleep for a\nperiod of time and then try to reinitialize it's childs or something. You\ndevelopers should know best.", "bug_id": 34514, "attachment_id": null, "id": 73886, "time": "2005-04-21T09:07:12Z", "creator": "hipo@design.bg", "creation_time": "2005-04-21T09:07:12Z", "tags": [], "is_private": false}, {"count": 4, "attachment_id": null, "bug_id": 34514, "is_private": false, "id": 74182, "time": "2005-04-27T18:52:16Z", "creator": "tygris@cablespeed.com", "creation_time": "2005-04-27T18:52:16Z", "tags": [], "text": "I have the same thing in a Debian SARGE install of Linux.  Relivant logs:\n\n[Wed Apr 27 12:17:15 2005] [notice] Apache/2.0.52 (Unix) mod_ssl/2.0.52 OpenSSL/\n0.9.7e DAV/2 mod_python/3.1.3 Python/2.3.5 configured -- resuming normal operati\nons                                                                             \n[Wed Apr 27 12:17:17 2005] [alert] (12)Cannot allocate memory: apr_thread_create\n: unable to create worker thread                                                \n[Wed Apr 27 12:17:28 2005] [alert] Child 32004 returned a Fatal error...\\nApache\n is exiting!                                                                    \n\nI'm also letting folks with the exchange4linux program is, because this\nversion's bundled with that."}, {"count": 5, "tags": [], "bug_id": 34514, "attachment_id": null, "id": 74211, "time": "2005-04-28T10:14:57Z", "creator": "hipo@design.bg", "creation_time": "2005-04-28T10:14:57Z", "is_private": false, "text": "Hi there. The problem is probably the ulimit limitations on your server.\ncheck out ulimit -a; and your limits.conf file. If that's the problem try\nraising the count for maximum processes. I tried that and ended completely\nremoving the process limits as it was in the beginning. The apache now works\nwith no problem. That's probably a bug apache developers need to take a look\nwhen they have a little extra time, because the problem is workaroundable."}, {"count": 6, "tags": [], "bug_id": 34514, "attachment_id": null, "id": 74236, "time": "2005-04-28T17:06:19Z", "creator": "jorton@redhat.com", "creation_time": "2005-04-28T17:06:19Z", "is_private": false, "text": "You can actually distinguish the two conditions by the error message:\n\n- kernel thread limit => \"Cannot allocate memory\" error\n- configured ulimit => \"Resource temporarily unavailable\" error\n"}, {"count": 7, "tags": [], "bug_id": 34514, "attachment_id": 14867, "id": 74237, "time": "2005-04-28T17:11:42Z", "creator": "jorton@redhat.com", "creation_time": "2005-04-28T17:11:42Z", "is_private": false, "text": "Created attachment 14867\ntreat thread creation as non-fatal\n\nI do wonder why this is a fatal error, and I'm not the first to do so.\tYou\ncould try the above patch which treats this as a transient problem and will not\nforce the server to exit.\n\nDelaying the exit of the child for 10 seconds *without* destroying all\npreviously created threads for this child seems pretty unfriendly, it must be\nsaid."}, {"count": 8, "tags": [], "bug_id": 34514, "text": "Here's a similar patch I've given people in the past:\n\nhttp://people.apache.org/~trawick/worker_mpm_pthread_create_resume.patch\n\nOne way that it differs is that it keeps the delay, but in the parent.\n\nWhat bothers me about these patches is that for 9 users out of ten that see this\n(in my experience), the problem is a showstopper configuration error that\nprevents even the first child process from starting up properly.  In that case,\nit is best for the web server to exit.  A better patch would still exit if the\nchildren created at startup couldn't initialize, but keep running if transient\nerrors were hit later.\n", "id": 74239, "time": "2005-04-28T17:24:00Z", "creator": "trawick@apache.org", "creation_time": "2005-04-28T17:24:00Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 34514, "text": "Here is yet another patch:\n\nhttp://people.apache.org/~gregames/thread_create_recovery.patch\n\ndesign:\n\n1. exit with APEXIT_CHILDSICK for thread create failures (same as other patches)\n2. add logic to the parent to decide how bad these errors really are.  if we\ncan't initialize a single worker process, just give up.  otherwise treat these\nas transient errors.\n3. nuke the 10 sec delays.  it's better to let the parent know what's happening\nright away. if the parent creates a fork-a-thon, the parent is broken.\n  ", "id": 74398, "time": "2005-05-03T20:51:51Z", "creator": "gregames@apache.org", "creation_time": "2005-05-03T20:51:51Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 34514, "text": "fix committed to 2.1 trunk, revision 168182", "id": 74456, "time": "2005-05-04T22:05:21Z", "creator": "gregames@apache.org", "creation_time": "2005-05-04T22:05:21Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "creator": "shane@bratnet.net", "attachment_id": null, "id": 74509, "time": "2005-05-06T04:32:51Z", "bug_id": 34514, "creation_time": "2005-05-06T04:32:51Z", "is_private": false, "text": "I have applied Greg's patch, and I still had the same problem. Here is a log \nfrom my server. I can repeate this almost daily, because I have a surge of \ntraffic in the mornings. Sugestions: \n\n\n[Thu May 05 06:35:05 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:05 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:05 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:05 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:05 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:05 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:05 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:05 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:05 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:05 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:05 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:05 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:05 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:09 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:09 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:10 2005] [error] (12)Cannot allocate memory: fork: Unable to \nfork new process\n[Thu May 05 06:35:10 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:10 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:10 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:20 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Thu May 05 06:35:21 2005] [alert] Child 19934 returned a Fatal error... \nApache is exiting!\n[Thu May 05 06:35:24 2005] [warn] child process 18126 still did not exit, \nsending a SIGTERM\n[Thu May 05 06:35:24 2005] [warn] child process 18173 still did not exit, \nsending a SIGTERM\n[ many many lines for other processes were deleted ]\n[Thu May 05 06:35:30 2005] [error] child process 18126 still did not exit, \nsending a SIGKILL\n[Thu May 05 06:35:30 2005] [error] child process 18173 still did not exit, \nsending a SIGKILL\n[ deleted many like repeated lines ]\n[Thu May 05 06:56:30 2005] [notice] Digest: generating secret for digest \nauthentication ...\n[Thu May 05 06:56:30 2005] [notice] Digest: done\n[Thu May 05 06:56:31 2005] [warn] pid file /usr/local/apache2/run/httpd.pid \noverwritten -- Unclean shutdown of previous Apache run?\n[Thu May 05 06:56:31 2005] [notice] Apache/2.0.54 (Unix) configured -- \nresuming normal operations\nThis file contains any messages produced by compilers while\nrunning configure, to aid debugging if configure makes a mistake.\n\n# config.log file data:\n\n$ ./configure --enable-so --with-mpm=worker --enable-expires --enable-headers -\n-enable-modules=all\n\n## --------- ##\n## Platform. ##\n## --------- ##\n\nhostname = xxxxx\nuname -m = i686\nuname -r = 2.4.21-27.ELsmp\nuname -s = Linux\nuname -v = #1 SMP Wed Dec 1 21:59:02 EST 2004\n\n# httpd.conf settings:\n\nServerLimit 128\nStartServers 2\nMaxClients 2050\nMinSpareThreads 25\nMaxSpareThreads 75\nThreadsPerChild 50\nMaxRequestsPerChild 0\n"}, {"count": 12, "tags": [], "creator": "trawick@apache.org", "attachment_id": null, "id": 74526, "time": "2005-05-06T13:36:42Z", "bug_id": 34514, "creation_time": "2005-05-06T13:36:42Z", "is_private": false, "text": "I just took a look at the latest worker.c with Greg's patch.  There are three\nplaces where threads are created in worker MPM, and Greg neglected to update one\nof the paths.\n\nHere is the code which is still unpatched:\n\n    rv = apr_thread_create(&start_thread_id, thread_attr, start_threads,\n                           ts, pchild);\n    if (rv != APR_SUCCESS) {\n        ap_log_error(APLOG_MARK, APLOG_ALERT, rv, ap_server_conf,\n                     \"apr_thread_create: unable to create worker thread\");\n        /* In case system resources are maxxed out, we don't want\n           Apache running away with the CPU trying to fork over and\n           over and over again if we exit. */\n        apr_sleep(apr_time_from_sec(10));\n        clean_child_exit(APEXIT_CHILDFATAL);\n    }\n\n    mpm_state = AP_MPMQ_RUNNING;\n\nDelete the line with apr_sleep() and change APEXIT_CHILDFATAL to APEXIT_CHILDSICK.\n"}, {"count": 13, "tags": [], "creator": "gregames@apache.org", "attachment_id": null, "text": "oops.  Jeff is correct.  I missed one in worker and the same one in event.  I\ncommitted the change to httpd-2.1 trunk as revision 168649.", "id": 74620, "time": "2005-05-09T16:48:45Z", "bug_id": 34514, "creation_time": "2005-05-09T16:48:45Z", "is_private": false}, {"count": 14, "tags": [], "creator": "shane@bratnet.net", "attachment_id": null, "id": 74625, "time": "2005-05-09T19:41:30Z", "bug_id": 34514, "creation_time": "2005-05-09T19:41:30Z", "is_private": false, "text": "After the fix from Jeff, I no longer crash, all I get now are warnings to the \nerror_log: Mostly the thread error. But the server does not go down.\n\n\n[Mon May 09 06:35:04 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Mon May 09 09:35:06 2005] [error] (12)Cannot allocate memory: fork: Unable to \nfork new process\n"}, {"count": 15, "text": "*** Bug 34980 has been marked as a duplicate of this bug. ***", "bug_id": 34514, "is_private": false, "id": 75122, "time": "2005-05-20T12:24:17Z", "creator": "trawick@apache.org", "creation_time": "2005-05-20T12:24:17Z", "tags": [], "attachment_id": null}, {"count": 16, "tags": [], "bug_id": 34514, "attachment_id": null, "id": 75222, "time": "2005-05-23T14:35:24Z", "creator": "inoue@ariel-networks.com", "creation_time": "2005-05-23T14:35:24Z", "is_private": false, "text": "I'm not sure this problem was resolved and my experience would be helpful.\n\n\nMy experience:\nI had the same errors as follows,\n[Tue May 10 16:18:20 2005] [alert] (12)Cannot allocate memory:\napr_thread_create: unable to create worker thread\n\n$ cat /etc/issue\nRed Hat Enterprise Linux AS release 3 (Taroon)\n\nI did 'export LD_ASSUME_KERNEL=2.4.1', and the errors have disappeared.\n# Before I reached to this resolution, I have checked ulimit and /proc/sys/ etc.\nand I found nothing wrong."}, {"count": 17, "tags": [], "text": "I just patched the worker.c file, but apache still goes down. I'm not sure if \nit's the same issue or whether this is a new problem.\n\n[Tue May 31 12:06:57 2005] [error] (12)Cannot allocate memory: fork: Unable to \nfork new process\n[Tue May 31 12:06:57 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Tue May 31 12:07:00 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Tue May 31 12:07:08 2005] [alert] Child 9900 returned a Fatal error... Apache \nis exiting!\n[Tue May 31 12:07:12 2005] [warn] child process 7822 still did not exit, \nsending a SIGTERM\n[Tue May 31 12:07:12 2005] [warn] child process 7825 still did not exit, \nsending a SIGTERM\n[Tue May 31 12:07:12 2005] [warn] child process 7893 still did not exit, \nsending a SIGTERM\n", "attachment_id": null, "bug_id": 34514, "id": 75673, "time": "2005-05-31T21:28:50Z", "creator": "oesterer@yahoo.com", "creation_time": "2005-05-31T21:28:50Z", "is_private": false}, {"count": 18, "tags": [], "bug_id": 34514, "attachment_id": null, "id": 75675, "time": "2005-05-31T21:34:10Z", "creator": "trawick@apache.org", "creation_time": "2005-05-31T21:34:10Z", "is_private": false, "text": "Make sure you got the original patch as well as the follow-up change which I\nmentioned.  The original patch was not complete.  From your error log snippet,\nI'd expect the complete fix to the problem discussed here is sufficient to keep\nApache running.\n\nThis fix will be in the next 2.0.x release."}, {"count": 19, "tags": [], "bug_id": 34514, "attachment_id": null, "id": 75677, "time": "2005-05-31T22:12:57Z", "creator": "oesterer@yahoo.com", "creation_time": "2005-05-31T22:12:57Z", "is_private": false, "text": "I updated lines 882, 963 and 1160 in worker.c to use APEXIT_CHILDSICK instead \nof APEXIT_CHILDFATAL. I also commented out the calls to wait 10 seconds \n[apr_sleep(apr_time_from_sec(10));], as the comment by Jeff suggested. But I \nwas not sure if this applies to all 3 locations or just the third one that was \ninitially missed.\n\nHowever apache still died twice after I patched it."}, {"count": 20, "tags": [], "creator": "trawick@apache.org", "attachment_id": null, "id": 75721, "time": "2005-06-01T13:17:24Z", "bug_id": 34514, "creation_time": "2005-06-01T13:17:24Z", "is_private": false, "text": "Andreas, I'm stumped.  The error log messages you show indicate that the child\nonly encountered a pthread_create failure\n\n[Tue May 31 12:06:57 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n[Tue May 31 12:07:00 2005] [alert] (12)Cannot allocate memory: \napr_thread_create: unable to create worker thread\n\nbut some child returned APEXIT_CHILDFATAL to the parent:\n\n[Tue May 31 12:07:08 2005] [alert] Child 9900 returned a Fatal error... Apache \nis exiting!\n\nThere are only the three locations you mentioned for the apr_thread_create\nfailure in worker.c.  I can only suggest that you confirm that you ran \"make\"\nand \"make install\" and restarted Apache after making the source code change ;)\n\n"}, {"count": 21, "text": "*** Bug 34980 has been marked as a duplicate of this bug. ***", "bug_id": 34514, "attachment_id": null, "id": 79536, "time": "2005-09-07T16:24:24Z", "creator": "jorton@redhat.com", "creation_time": "2005-09-07T16:24:24Z", "tags": [], "is_private": false}, {"count": 22, "tags": [], "bug_id": 34514, "text": "All the transient failures should now be non-fatal as of 2.0.55, so if you still\nsee problems with 2.0.55 please reopen and include the error_log entries on failure.\n\nThanks for the report.", "id": 81902, "time": "2005-10-28T17:46:23Z", "creator": "jorton@redhat.com", "creation_time": "2005-10-28T17:46:23Z", "is_private": false, "attachment_id": null}]