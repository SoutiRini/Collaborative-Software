[{"count": 0, "tags": [], "creator": "thomas.jarosch@intra2net.com", "attachment_id": null, "is_private": false, "id": 201669, "time": "2017-10-25T15:03:24Z", "bug_id": 61666, "creation_time": "2017-10-25T15:03:24Z", "text": "We have an autotest based automated test system that automatically tests various httpd and mod_proxy configurations. A few tests failed 100% of the time after updating from 2.4.25 to 2.4.29.\n\nAs soon as the script issues \n\nAs soon as a script issues a \"httpd reload\", this appears in the logs:\n\n[mpm_event:notice] [pid 2452:tid 3072501504] AH00494: SIGHUP received.  Attempting to restart\n(98)Address already in use: AH00072: make_sock: could not bind to address 0.0.0.0:80\n[mpm_event:alert] [pid 2452:tid 3072501504] no listening sockets available, shutting down\n\n\nI've tracked it down to this change in httpd 2.4.26:\n\n  *) Don't set SO_REUSEPORT unless ListenCoresBucketsRatio is greater\n     than zero.  [Eric Covener]\n\nCommit in questions is this one:\nhttps://github.com/apache/httpd/commit/d3e0ad6e2ba88f465765e0a8c315189c311583a5\n\nOnce I revert it, \"httpd reload\" works just fine.\n\nLooks like graceful shutdowns now cause trouble when doing httpd reloads?"}, {"count": 1, "tags": [], "bug_id": 61666, "is_private": false, "id": 201670, "creation_time": "2017-10-25T15:03:47Z", "time": "2017-10-25T15:03:47Z", "creator": "thomas.jarosch@intra2net.com", "text": "PS: There's no 2.4.29 version in bugzilla yet, 2.4.28 is the highest as of writing.", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 61666, "text": "Do you set ListenCoresBucketsRatio? Were you by any chance running tests work prior to 2.4.17 (prior to SO_REUSEPORT)?", "id": 201671, "time": "2017-10-25T16:23:05Z", "creator": "covener@gmail.com", "creation_time": "2017-10-25T16:23:05Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 61666, "text": "ListenCoresBucketsRatio is not explicitly set as far as I can tell.\n\nRelevant part of httpd.conf:\n-------------------\nTimeout 300\nKeepAliveTimeout 300\nGracefulShutdownTimeout 1800\n\n<IfModule mpm_event_module>\n  # MinSpareThreads         10\n  # MaxSpareThreads         250\n  #\n  # Number of concurrent connections is: ServerLimit * ThreadsPerChild\n  # Result: 160 * 5 -> 800\n  #\n  StartServers 1\n  ServerLimit 160\n  ThreadLimit 5\n  ThreadsPerChild 5\n  MaxConnectionsPerChild  5000\n</IfModule>\n\nListen 192.168.1.254:80\nListen 192.168.1.254:443\nListen 127.0.0.1:80\nListen 127.0.0.1:443\nListen 447\n-------------------\n\n\nI'll dig through our git history tomorrow at which pointed we switched from httpd 2.2.x to 2.4.x. There was also another switch later on from prefork mpm to the event mpm. 2.4.17 was released around September 2015, we'll see tomorrow.", "id": 201672, "attachment_id": null, "creator": "thomas.jarosch@intra2net.com", "creation_time": "2017-10-25T16:37:03Z", "time": "2017-10-25T16:37:03Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 61666, "text": "\n> Listen 192.168.1.254:80\n> Listen 192.168.1.254:443\n> Listen 127.0.0.1:80\n> Listen 127.0.0.1:443\n> Listen 447\n> -------------------\n\nInteresting, did you redact? This is not consistent with the failure msg (0.0.0.0:80 / 80)", "id": 201673, "time": "2017-10-25T16:46:45Z", "creator": "covener@gmail.com", "creation_time": "2017-10-25T16:46:45Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 61666, "is_private": false, "text": "(In reply to Eric Covener from comment #4)\n> > Listen 192.168.1.254:80\n> > Listen 192.168.1.254:443\n> > Listen 127.0.0.1:80\n> > Listen 127.0.0.1:443\n> > Listen 447\n> > -------------------\n> \n> Interesting, did you redact? This is not consistent with the failure msg\n> (0.0.0.0:80 / 80)\n\nsorry, I've grabbed the config from another VM while the original VM was executing a different test.\n\nThis is how the config looks like:\n\n----\nListen 80\nListen 447\n----\n\nThe thread limits etc. are identical.\n\nRegarding our upgrade history: We went straight from 2.0.64 to 2.4.7 in January 2014. The switch from the prefork mpm to the event mpm was done already with version 2.4.18 in June 2016.\n\nBut it looks like I hit the issue last night again while doing a stress test on mod_proxy with the reverted patch. It just doesn't appear every time.\nI'll now double check the patch was in there. If so, I 'll take version 2.4.27 instead of 2.4.29 to make sure we are not searching for a different issue.", "id": 201682, "time": "2017-10-26T08:41:11Z", "creator": "thomas.jarosch@intra2net.com", "creation_time": "2017-10-26T08:41:11Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 61666, "is_private": false, "id": 201687, "creation_time": "2017-10-26T12:13:47Z", "time": "2017-10-26T12:13:47Z", "creator": "jorton@redhat.com", "text": "For a config like:\n\nListen 127.0.0.1:80\nListen 80\n\nhttpd should fail to start by default.  This was true up to 2.4.16, but the behaviour accidentally regressed in 2.4.17 with the listener bucket code.  From 2.4.26 up it will fail again.\n\nIt's possible you had a config working with (2.4.17..25) which now fails, but this is not a regression.\n\nAlternatively, it's possible you have some unrelated issue.  Please provide output from:\n\nstrace -ebind ./bin/httpd", "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 61666, "text": "(In reply to Joe Orton from comment #6)\n> For a config like:\n> \n> Listen 127.0.0.1:80\n> Listen 80\n\nI don't think we are having a mix of \"Listen XX\" with an explicit IP address and one without on the same port number. That's a different thing.\n\nIn the first config I've posted, it's port 443 and *447*.\n(we use 447 to serve a different SSL cert)", "id": 201688, "time": "2017-10-26T12:35:48Z", "creator": "thomas.jarosch@intra2net.com", "creation_time": "2017-10-26T12:35:48Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 61666, "text": "All you've shown us is a conflict error message from :80.  If there is some issue here other than a config error you need to show full Listen config & strace output I indicated above.", "id": 201692, "attachment_id": null, "creator": "jorton@redhat.com", "creation_time": "2017-10-26T13:59:12Z", "time": "2017-10-26T13:59:12Z", "is_private": false}, {"count": 9, "tags": [], "creator": "thomas.jarosch@intra2net.com", "attachment_id": null, "is_private": false, "id": 201696, "time": "2017-10-26T16:32:50Z", "bug_id": 61666, "creation_time": "2017-10-26T16:32:50Z", "text": "(In reply to Joe Orton from comment #8)\n> All you've shown us is a conflict error message from :80.  If there is some\n> issue here other than a config error you need to show full Listen config &\n> strace output I indicated above.\n\nthe \"Listen\" lines have been provided in comment #5, here they are again:\n\nListen 80\nListen 447\n\n# strace -ebind httpd -f /etc/httpd/conf/httpd.conf \nbind(3, {sa_family=AF_NETLINK, pid=0, groups=00000000}, 12) = 0\nbind(3, {sa_family=AF_NETLINK, pid=0, groups=00000000}, 12) = 0\nbind(4, {sa_family=AF_NETLINK, pid=0, groups=00000000}, 12) = 0\nbind(5, {sa_family=AF_NETLINK, pid=0, groups=00000000}, 12) = 0\nbind(5, {sa_family=AF_NETLINK, pid=0, groups=00000000}, 12) = 0\nbind(5, {sa_family=AF_NETLINK, pid=0, groups=00000000}, 12) = 0\nbind(5, {sa_family=AF_NETLINK, pid=0, groups=00000000}, 12) = 0\nbind(3, {sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr(\"0.0.0.0\")}, 16) = 0\nbind(4, {sa_family=AF_INET, sin_port=htons(447), sin_addr=inet_addr(\"0.0.0.0\")}, 16) = 0\nbind(5, {sa_family=AF_NETLINK, pid=0, groups=00000000}, 12) = 0\n\nThe output is from httpd 2.4.29 + revert of the commit mentioned in comment #1.\n\n\nI've been running the mod_proxy tests on two machines in a loop all afternoon. So far no single failure. If I stick to vanilla httpd 2.4.29 or 2.4.27, it fails on \"httpd reload\". Note: This is no *startup* failure, httpd starts fine.\nThe graceful restart during \"httpd reload\" -> SIGHUP dies.\n\nWhat's the normal control flow once a SIGHUP is received in the event mpm?"}, {"count": 10, "tags": [], "creator": "thomas.jarosch@intra2net.com", "attachment_id": null, "is_private": false, "id": 201744, "time": "2017-10-27T17:06:01Z", "bug_id": 61666, "creation_time": "2017-10-27T17:06:01Z", "text": "Finally tracked it down:\n\nThe automated system changes the \"Listen\" directives for a few tests and issues a \"httpd reload\". While this worked fine in httpd 2.4.25, it stopped working once the SO_REUSEPORT handling was changed in 2.4.26+.\n\nI've adapted the tests to issue a \"httpd restart\" if the Listen directives change and a quick test finished without errors. I'll run the full testsuite over the weekend.\n\nHere's a diff of the config file before the \"httpd reload\":\n\n-Listen 172.18.0.1:80\n-Listen 172.18.0.1:443\n-Listen 192.168.2.1:80\n-Listen 192.168.2.1:443\n-Listen 127.0.0.1:80\n-Listen 127.0.0.1:443\n+Listen 80\n Listen 447\n\nSo Joe was on the right track in comment #6. Changing from \"Listen 127.0.0.1:80\" to just \"Listen 80\" is a pretty uncommon (stupid?) thing.\n\nFor me the matter is resolved, I've adapted the code and all should be fine.\nIf someone else ever stumbles upon this issue, we could think about a warning message in the error log that changing the Listen directives in this way is unsupported during a SIGHUP.\n\nMy thanks to everyone involved!\n\nHave a nice weekend,\nThomas"}, {"count": 11, "tags": [], "bug_id": 61666, "text": "(In reply to Thomas Jarosch from comment #10)\n> So Joe was on the right track in comment #6. Changing from \"Listen\n> 127.0.0.1:80\" to just \"Listen 80\" is a pretty uncommon (stupid?) thing.\n\nThat's a pretty interesting special case, at least I wasn't aware of it, so thanks a lot for reporting back!\n\nI documented this in r1816112\n\nhttps://httpd.apache.org/docs/trunk/bind.html#reload", "id": 202357, "time": "2017-11-23T09:00:26Z", "creator": "jorton@redhat.com", "creation_time": "2017-11-23T09:00:26Z", "is_private": false, "attachment_id": null}]