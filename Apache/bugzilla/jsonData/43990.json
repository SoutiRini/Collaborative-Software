[{"count": 0, "tags": [], "creator": "andreas@apache.org", "attachment_id": null, "id": 111246, "time": "2007-11-29T02:49:25Z", "bug_id": 43990, "creation_time": "2007-11-29T02:49:25Z", "is_private": false, "text": "The OneForm editor inserts images with absolute URLs instead of\nlenya-document:{uuid} URLs:\n\n<img src=\"/default/authoring/doctypes/logo.png\" title=\"Logo\" alt=\"Logo\"\nwidth=\"199\" height=\"63\"/>\n\nNon-proxy environment, standard Jetty."}, {"attachment_id": null, "tags": [], "bug_id": 43990, "text": "hmm, yes. i figured that when we're in edit mode, we need real URLs so that\neditors can display images (does not strictly apply to oneform, but i'm still\ndreaming of the Grand Unified Editor Usecase In The Sky). i thought that\nurl2uuid conversion was handled in the post-processing, but it seems it isn't...", "count": 1, "id": 111247, "time": "2007-11-29T02:54:55Z", "creator": "nettings@apache.org", "creation_time": "2007-11-29T02:54:55Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 43990, "attachment_id": null, "text": "(In reply to comment #1)\n> hmm, yes. i figured that when we're in edit mode, we need real URLs so that\n> editors can display images (does not strictly apply to oneform, but i'm still\n> dreaming of the Grand Unified Editor Usecase In The Sky).\n\nYes, that's OK from my POV.\n\n> i thought that\n> url2uuid conversion was handled in the post-processing, but it seems it isn't...\n\nI guess the OneForm editor doesn't have such a post-processing yet. Do you have\nthe time to take a look at it?\n", "id": 111250, "time": "2007-11-29T03:05:47Z", "creator": "andreas@apache.org", "creation_time": "2007-11-29T03:05:47Z", "is_private": false}, {"count": 3, "tags": [], "creator": "ragaller@apache.org", "is_private": false, "text": "Same problem in tinyMCE.\n\nThe bad aspect of this bug is, that if it's fixed later (after 2.0), a content migration from <img src... links to uuid-links would be necessary....", "id": 111655, "time": "2007-12-11T12:46:11Z", "bug_id": 43990, "creation_time": "2007-12-11T12:46:11Z", "attachment_id": null}, {"count": 4, "tags": [], "creator": "rfrovarp@apache.org", "is_private": false, "text": "I really hate to say this, but isn't this a blocker? Insert an image using one\nform, publish, view under live. You'll end up with this as the URL in the live page:\n\nhttp://localhost:8888/default/authoring/tutorial/test.png?lenya.module=svg&height=120&width=160\n\nIf you aren't proxying the authoring URLs through from live, the image won't be\nvisible from live. I've seen FCK do this. For some reason with FCK, just going\nback to the page and hitting save fixes the problem. Not sure why it doesn't\nalways do the translation from path to uuid.", "id": 111657, "time": "2007-12-11T12:56:25Z", "bug_id": 43990, "creation_time": "2007-12-11T12:56:25Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 43990, "attachment_id": null, "text": "(In reply to comment #3)\n> Same problem in tinyMCE.\n> \n> The bad aspect of this bug is, that if it's fixed later (after 2.0), a content\nmigration from <img src... links to uuid-links would be necessary....\n\nSaving the page would do the content migration. That's how it works with BXE,\nand usually FCK. That's how I fix the issue when FCK doesn't cooperate.", "id": 111658, "time": "2007-12-11T12:57:08Z", "creator": "rfrovarp@apache.org", "creation_time": "2007-12-11T12:57:08Z", "is_private": false}, {"count": 6, "tags": [], "creator": "andreas@apache.org", "attachment_id": null, "id": 111666, "time": "2007-12-11T14:12:23Z", "bug_id": 43990, "creation_time": "2007-12-11T14:12:23Z", "is_private": false, "text": "Should be fixed for the OneForm editor, at least for non-proxy, root-context\nenvironments. Please test. TIA!"}, {"count": 7, "tags": [], "bug_id": 43990, "attachment_id": null, "text": "(In reply to comment #1)\n> hmm, yes. i figured that when we're in edit mode, we need real URLs so that\n> editors can display images [...]\n\nDoes the image insertion code generate proxy-based URLs? If yes, we have to add\nanother processing step when saving the file (IncomingLinkRewriter).\n", "id": 111667, "time": "2007-12-11T14:14:15Z", "creator": "andreas@apache.org", "creation_time": "2007-12-11T14:14:15Z", "is_private": false}, {"count": 8, "tags": [], "creator": "andreas@apache.org", "is_private": false, "text": "(In reply to comment #6)\n> Should be fixed for the OneForm editor, at least for non-proxy, root-context\n> environments. Please test. TIA!\n\nShould now also work for proxy environments.\n\nTinyMCE isn't updated yet. Any volunteers? :)", "id": 111669, "time": "2007-12-11T14:39:06Z", "bug_id": 43990, "creation_time": "2007-12-11T14:39:06Z", "attachment_id": null}, {"count": 9, "tags": [], "creator": "andreas@apache.org", "is_private": false, "text": "Should be fixed for TinyMCE too, needs to be tested.", "id": 111672, "time": "2007-12-11T14:44:37Z", "bug_id": 43990, "creation_time": "2007-12-11T14:44:37Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 43990, "is_private": false, "count": 10, "id": 111683, "time": "2007-12-12T00:20:18Z", "creator": "ragaller@apache.org", "creation_time": "2007-12-12T00:20:18Z", "text": " (In reply to comment #9)\n> Should be fixed for TinyMCE too, needs to be tested.\n\nIn TinyMCE the image url I see is still the non-uuid one (after a switch to the trunk and a build clean-all)"}, {"count": 11, "tags": [], "bug_id": 43990, "attachment_id": null, "is_private": false, "id": 111684, "time": "2007-12-12T00:26:05Z", "creator": "ragaller@apache.org", "creation_time": "2007-12-12T00:26:05Z", "text": " (In reply to comment #8)\n> (In reply to comment #6)\n> > Should be fixed for the OneForm editor, at least for non-proxy, root-context\n> > environments. Please test. TIA!\n> \n> Should now also work for proxy environments.\n\nconfirmed here\n"}, {"count": 12, "tags": [], "creator": "andreas@apache.org", "is_private": false, "text": "(In reply to comment #10)\n>  (In reply to comment #9)\n> > Should be fixed for TinyMCE too, needs to be tested.\n> \n> In TinyMCE the image url I see is still the non-uuid one (after a switch to\n> the trunk and a build clean-all)\n\nIIUC TinyMCE should indeed show the non-UUID URL, but after saving it should be\nreplaced with the UUID-based one. Can you confirm this, or is it saved with\nnon-UUID URLs? BTW, you can just use the .xml extension in the browser URL box\nto get the document source.", "id": 111685, "time": "2007-12-12T01:07:02Z", "bug_id": 43990, "creation_time": "2007-12-12T01:07:02Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 43990, "text": "No, I can't confirm this - in the page source, the non-uuid reference is still used.", "count": 13, "id": 111686, "time": "2007-12-12T01:14:05Z", "creator": "ragaller@apache.org", "creation_time": "2007-12-12T01:14:05Z", "is_private": false}, {"count": 14, "tags": [], "creator": "andreas@apache.org", "attachment_id": null, "id": 111687, "time": "2007-12-12T01:15:43Z", "bug_id": 43990, "creation_time": "2007-12-12T01:15:43Z", "is_private": false, "text": "Unfortunately I can't test it at the moment, I always get \"onclick attribute not\nsupported\" errors when I save."}, {"count": 15, "tags": [], "bug_id": 43990, "attachment_id": null, "text": "I just tested and see the problem. TinyMCE keeps rewriting the image url to\nsomething like this: \n\nindex/test.jpg?lenya.module=svg&height=120&width=160\n\nWhen what is needed for the matcher is this:\n/default/authoring/index/test.jpg?lenya.module=svg&height=120&width=160\n\nSo the transform may be running, but it doesn't match and you can't force\nTinyMCE to have the proper URL as it keeps changing it to the first one.", "id": 111699, "time": "2007-12-12T07:02:12Z", "creator": "rfrovarp@apache.org", "creation_time": "2007-12-12T07:02:12Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 43990, "attachment_id": null, "text": "ui - think I found the option that is needed for this purpose:\n\nTinyMCE can be configured to use absolute image urls:\n\nhttp://wiki.moxiecode.com/index.php/TinyMCE:Configuration/relative_urls\n\nI just gave it a try by inserting \n\nrelative_urls : false, \n\ninto tiny_config.js;\n\nIt seems to work (link gets rewritten @ save) - but I'll have to do more testing before committing this.\n", "id": 111706, "time": "2007-12-12T08:09:24Z", "creator": "ragaller@apache.org", "creation_time": "2007-12-12T08:09:24Z", "is_private": false}, {"count": 17, "tags": [], "bug_id": 43990, "attachment_id": null, "text": "Mmmmh - setting relative_urls to false seems to work for image links but breaks internal links to other lenya pages (the end up having links in the page source like: /default/authoring/lenya-document:5d353320-a8ca-11dc-96fc-db94b5998549,lang=en).\n\nThere is also:\nhttp://wiki.moxiecode.com/index.php/TinyMCE:Configuration/document_base_url\n\n", "id": 111709, "time": "2007-12-12T08:18:40Z", "creator": "ragaller@apache.org", "creation_time": "2007-12-12T08:18:40Z", "is_private": false}, {"count": 18, "tags": [], "text": "This looks to be cleared up with the possible exception of TinyMCE. Could a user of that editor comment?", "is_private": false, "id": 114606, "creator": "rfrovarp@apache.org", "time": "2008-03-13T13:35:42Z", "bug_id": 43990, "creation_time": "2008-03-13T13:35:42Z", "attachment_id": null}, {"count": 19, "tags": [], "bug_id": 43990, "attachment_id": null, "text": "(In reply to comment #18)\n> This looks to be cleared up with the possible exception of TinyMCE. Could a\n> user of that editor comment?\n> \n\nTinyMCE seems to be currently broken - I tried to get it running by removing the (deprecated) menu.xsp and create a menu entry in xhtml/config/menu.xml like this:\n\n<item uc:usecase=\"tinymce.edit\"><i18n:text>With Tinymce</i18n:text></item>\n\nresults in a (usecase) error.\n\n\nReading the svn-history of the tinyMCE module, I think, that the current state still is: links have lenya-document:{UUID} syntax, image src attributes don't.\n\n", "id": 114651, "time": "2008-03-15T03:37:24Z", "creator": "ragaller@apache.org", "creation_time": "2008-03-15T03:37:24Z", "is_private": false}, {"count": 20, "tags": [], "text": "(In reply to comment #18)\n> This looks to be cleared up with the possible exception of TinyMCE. Could a\n> user of that editor comment?\n> \n\n... got tinymce running again\n\nImage references are still non-uuid:\n<img src=\"name.jpg\" />\n\n", "attachment_id": null, "id": 114652, "creator": "ragaller@apache.org", "time": "2008-03-15T08:44:48Z", "bug_id": 43990, "creation_time": "2008-03-15T08:44:48Z", "is_private": false}, {"count": 21, "tags": [], "creator": "rfrovarp@apache.org", "attachment_id": null, "id": 114656, "time": "2008-03-15T11:30:14Z", "bug_id": 43990, "creation_time": "2008-03-15T11:30:14Z", "is_private": false, "text": "What about the resulting saved source? When they're inserted they go in as non-uuid, but they should be converted to uuids when saved. If you change the extension of a file from html in your browser to xml you'll see the saved source. Or you can always look on the filesystem as well."}, {"count": 22, "tags": [], "bug_id": 43990, "attachment_id": null, "text": "(In reply to comment #21)\n> What about the resulting saved source? When they're inserted they go in as\n> non-uuid, but they should be converted to uuids when saved. If you change the\n> extension of a file from html in your browser to xml you'll see the saved\n> source. Or you can always look on the filesystem as well.\n> \n\nthe source is non-uuid", "id": 114657, "time": "2008-03-15T14:23:08Z", "creator": "ragaller@apache.org", "creation_time": "2008-03-15T14:23:08Z", "is_private": false}, {"count": 23, "tags": [], "creator": "andreas@apache.org", "text": "We could add a transformation step to transform the relative to absolute URIs:\n\nhttp://svn.apache.org/viewvc/lenya/branches/BRANCH_2_0_X/src/modules-core/linking/java/src/org/apache/lenya/cms/linking/RelativeToAbsoluteLinkRewriter.java?view=markup", "id": 126780, "time": "2009-05-05T06:04:38Z", "bug_id": 43990, "creation_time": "2009-05-05T06:04:38Z", "is_private": false, "attachment_id": null}, {"count": 24, "tags": [], "creator": "andreas@apache.org", "text": "Fixed in revision 771713. It would be great if someone could find the time to verify the fix. Thanks!", "id": 126784, "time": "2009-05-05T06:21:12Z", "bug_id": 43990, "creation_time": "2009-05-05T06:21:12Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 43990, "text": "I just tested the uuid image link behaviour inserting an image as child of features. Here are the result in the xml of the edited page. IIUC the behaviour is still broken.\n\n\nThe first time a freshly uploaded (from within timymce) image is inserted, non uuid style:\n<img alt=\"test-image\" height=\"133\" src=\"/default/authoring/features/test-image.jpg\" width=\"250\"/>\n\n\nThe second time the same image is inserted, things look correct:\n<img alt=\"test-image\" height=\"133\" src=\"lenya-document:a86b2740-3d7b-11de-a5c8-868a4fd960e2\" width=\"250\"/> \n\n\nWhen a page is reopened in tinymce svn parameters are added:\n<img alt=\"test-image\" height=\"133\" src=\"lenya-document:a86b2740-3d7b-11de-a5c8-868a4fd960e2?lenya.module=svg&amp;height=133&amp;width=250\" width=\"250\"/>", "count": 25, "id": 126917, "time": "2009-05-10T09:05:21Z", "creator": "ragaller@apache.org", "creation_time": "2009-05-10T09:05:21Z", "is_private": false}, {"count": 26, "tags": [], "bug_id": 43990, "attachment_id": null, "is_private": false, "id": 127456, "time": "2009-05-27T13:50:18Z", "creator": "andreas@apache.org", "creation_time": "2009-05-27T13:50:18Z", "text": "Does any of the TinyMCE users have the time to take a look at this issue?"}, {"count": 27, "tags": [], "creator": "andreas@apache.org", "text": "(In reply to comment #25)\n\n> When a page is reopened in tinymce svn parameters are added:\n> <img alt=\"test-image\" height=\"133\"\n> src=\"lenya-document:a86b2740-3d7b-11de-a5c8-868a4fd960e2?lenya.module=svg&amp;height=133&amp;width=250\"\n> width=\"250\"/>\n\nThe problem is that when the textarea for TinyMCE is filled, not the document source but the actual rendered page from the publication is used. This has several downsides:\n\n* <object> is converted to <img>\n* the svg module params are added\n* \u2026\n\nIMO the whole integration is a hack, but I don't see an immediate remedy :(", "id": 128884, "time": "2009-07-15T13:33:04Z", "bug_id": 43990, "creation_time": "2009-07-15T13:33:04Z", "is_private": false, "attachment_id": null}, {"count": 28, "tags": [], "creator": "andreas@apache.org", "text": "I just did some prototyping: Include the source instead of the assembled page. Seems to work fine if the source contains <img> as opposed to <object> elements.\n\n\n\nIndex: sitemap.xmap\n===================================================================\n--- sitemap.xmap\t(revision 794330)\n+++ sitemap.xmap\t(working copy)\n@@ -36,6 +36,13 @@\n   <map:pipelines>\n \n     <map:pipeline internal-only=\"yes\">\n+      \n+      <map:match pattern=\"content.xml\">\n+        <map:generate src=\"lenya-document:\"/>\n+        <map:transform type=\"uuid2url\"/>\n+        <map:transform src=\"xslt/extractContent.xsl\"/>\n+        <map:serialize type=\"xml\"/>\n+      </map:match>\n \n       <!-- when editing, the page should look exactly like the original, and since\n            we cannot know anything about the pipelines used for rendering, we must\n@@ -104,6 +111,7 @@\n             <map:call resource=\"style-cms-page\"/>\n           </map:otherwise>\n         </map:select>\n+        <map:transform type=\"include\"/>\n         <map:transform type=\"i18n\">      \n           <map:parameter name=\"locale\" value=\"{request:locale}\"/>\n         </map:transform>\nIndex: xslt/page2edit.xsl\n===================================================================\n--- xslt/page2edit.xsl\t(revision 794330)\n+++ xslt/page2edit.xsl\t(working copy)\n@@ -3,6 +3,7 @@\n   xmlns=\"http://www.w3.org/1999/xhtml\"\n   xmlns:xhtml=\"http://www.w3.org/1999/xhtml\"\n   xmlns:i18n=\"http://apache.org/cocoon/i18n/2.1\"\n+  xmlns:i=\"http://apache.org/cocoon/include/1.0\"\n   exclude-result-prefixes=\"#default i18n\"\n >\n \n@@ -212,7 +213,10 @@\n             <xsl:choose>\n               <!-- firefox bug workaround: prevent <textarea/> from collapsing if empty -->\n               <xsl:when test=\".//*\">\n+                <i:include src=\"cocoon:/content.xml\"/>\n+                <!--\n                 <xsl:apply-templates/>\n+                -->\n               </xsl:when>\n               <xsl:otherwise>\n                 <xsl:text>&#160;</xsl:text>", "id": 128887, "time": "2009-07-15T13:53:11Z", "bug_id": 43990, "creation_time": "2009-07-15T13:53:11Z", "is_private": false, "attachment_id": null}, {"count": 29, "tags": [], "bug_id": 43990, "attachment_id": null, "is_private": false, "id": 128888, "time": "2009-07-15T13:56:15Z", "creator": "andreas@apache.org", "creation_time": "2009-07-15T13:56:15Z", "text": "Rainer Schoepf: you could use the cleanup function in tiny_config.js to convert between <object> and <img>"}]