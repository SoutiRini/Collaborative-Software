[{"count": 0, "tags": [], "text": "For release 1.2.13 of jakarta-tomcat-connectors:\n\nProblem 1: the NSAPI plugin under <root>/jk/native/netscape/jk_nsapi_plugin.c \nfrees() the initial workers map structure, init_map, at the end of the jk_init\n(...) function.  As the jk_status.c worker uses the list of workers stored \nwithin this structure, when the jk_status worker is used by the NSAPI plugin, \nit attempts to read freed memory.\n\nProblem 2: the NSAPI plugin under <root>/jk/native/netscape/jk_nsapi_plugin.c \ndoes not use the uri_to_worker map within the jk_worker_env_t structure (as \nthis is done inside the netscape configuration files), however, the jk_status \nworker attempts to access the (uw_map) attached to the current jk_ws_service \nwithout a null check, thus causing the jk_status worker to attempt to \ndereference a null pointer.\n\nAttached is a diff output of the changes between the jk_nsapi_plugin.c supplied \nwithin the jakarta-tomcat-connectors-1.2.13-src package, and a modified version \nof this file which fixes this problem by adding a uri_to_worker map, and having \na static init_map structure:\n\n---\n56,57d55\n< static jk_map_t *init_map = NULL;\n< static jk_uri_worker_map_t *uw_map = NULL;\n89c87\n<     init_map = (jk_map_t *)init_d;\n---\n>     jk_map_t *init_map = (jk_map_t *)init_d;\n93,101c91\n<         if (uri_worker_map_alloc(&uw_map, NULL, logger)) {\n<             uw_map->fname = \"\";\n<             worker_env.uri_to_worker = uw_map;\n<             init_on_other_thread_is_ok = JK_TRUE;\n<         }\n<         else {\n<             jk_log(logger, JK_LOG_EMERG,\n<                    \"In init_workers_on_other_threads, failed\");\n<         }\n---\n>         init_on_other_thread_is_ok = JK_TRUE;\n227a218\n>     jk_map_t *init_map;\n271a263,264\n>\n>         jk_map_free(&init_map);\n289,292d281\n<     if (uw_map) {\n<         uri_worker_map_free(&uw_map, logger);\n<     }\n<\n297,300d285\n<\n<     if (init_map) {\n<         jk_map_free(&init_map);\n<     }\n410d394\n<     s->uw_map = uw_map;\n--", "attachment_id": null, "id": 77649, "creator": "brian.kavanagh@immi.gov.au", "time": "2005-07-26T09:30:11Z", "bug_id": 35862, "creation_time": "2005-07-26T09:30:11Z", "is_private": false}, {"attachment_id": 15776, "tags": [], "creator": "brian.kavanagh@immi.gov.au", "text": "Created attachment 15776\npatched jk_nsapi_plugin.c", "count": 1, "id": 77653, "time": "2005-07-26T09:38:14Z", "bug_id": 35862, "creation_time": "2005-07-26T09:38:14Z", "is_private": false}, {"count": 2, "text": "Patch committed and will be included in jk 1.2.16 onwards. Thanks for the patch.", "bug_id": 35862, "is_private": false, "id": 83896, "time": "2005-12-21T23:38:03Z", "creator": "markt@apache.org", "creation_time": "2005-12-21T23:38:03Z", "tags": [], "attachment_id": null}]