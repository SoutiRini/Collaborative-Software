[{"count": 0, "tags": [], "bug_id": 41867, "attachment_id": null, "id": 100486, "time": "2007-03-16T08:52:32Z", "creator": "imacat@mail.imacat.idv.tw", "creation_time": "2007-03-16T08:52:32Z", "is_private": false, "text": "Hi.  This is imacat from Taiwan.  I'm using the newest Apache 2.2.4.  I\nfound that <DirectoryMatch> matches not only directories, but also files.  The\nattached is a small piece of terminal log showing that <DirectoryMatch> matches\npartial part of the path, but not the directories.\n\n    Pleas tell me if I can be of any help, or if you need any more information.\n Thank you.\n\n======================\nimacat@rinse ~ % ls -l /tmp/apache/htdocs\ntotal 8\ndrwxr-xr-x  2 imacat users 4096 Mar 16 23:44 private\n-rw-r--r--  1 imacat users   40 Mar 16 23:40 privatedetective.txt\nimacat@rinse ~ % cat /tmp/apache/htdocs/privatedetective.txt\nSherlock Holmes is a private detective.\nimacat@rinse ~ % cat /tmp/apache/httpd.conf\nUser nobody\nGroup nogroup\nServerName localhost\nServerAdmin webmaster@localhost\nServerRoot /tmp/apache\nDocumentRoot /tmp/apache/htdocs\nPidFile /tmp/apache/httpd.pid\nLoadModule authz_host_module /usr/lib/apache2/mod_authz_host.so\nListen 50080\nErrorLog /tmp/apache/error_log\n\n<DirectoryMatch ^/tmp/apache/htdocs/private>\n  Order allow,deny\n</DirectoryMatch>\nimacat@rinse ~ % /usr/sbin/httpd -f /tmp/apache/httpd.conf\nimacat@rinse ~ % telnet localhost 50080\nTrying 127.0.0.1...\nConnected to localhost.\nEscape character is '^]'.\nGET /privatedetective.txt HTTP/1.1\nHost: localhost\nConnection: close\n\nHTTP/1.1 403 Forbidden\nDate: Fri, 16 Mar 2007 15:46:45 GMT\nServer: Apache/2.2.4 (Unix)\nContent-Length: 222\nConnection: close\nContent-Type: text/html; charset=iso-8859-1\n\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>403 Forbidden</title>\n</head><body>\n<h1>Forbidden</h1>\n<p>You don't have permission to access /privatedetective.txt\non this server.</p>\n</body></html>\nConnection closed by foreign host.\nimacat@rinse ~ % kill $(<//tmp/apache/httpd.pid)\nimacat@rinse ~ %"}, {"count": 1, "tags": [], "creator": "rahul.g.nair@gmail.com", "text": "Could not reproduce this in 2.3 trunk\nHere is what I tried,\n|pwd\n/space/store/apache.18.Jul/install\n|echo \"Hello\" > ./htdocs/apache_test.txt\n\nhttpd.conf:\n<DirectoryMatch ^/space/store/apache.18.Jul/install/htdocs/apache>\n    deny from all\n</DirectoryMatch>\n\n|telnet 0 8080      \nTrying 0.0.0.0...\nConnected to 0.\nEscape character is '^]'.\nGET /apache_test.txt HTTP/1.0\n\nHTTP/1.1 200 OK\nDate: Wed, 30 Jul 2008 10:29:30 GMT\nServer: Apache/2.3.0-dev (Unix)\nLast-Modified: Wed, 30 Jul 2008 10:28:38 GMT\nETag: \"60126-6-4533b384084df\"\nAccept-Ranges: bytes\nContent-Length: 6\nConnection: close\nContent-Type: text/plain\n\nHello\n", "id": 119114, "attachment_id": null, "bug_id": 41867, "creation_time": "2008-07-30T03:45:59Z", "time": "2008-07-30T03:45:59Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 41867, "attachment_id": null, "id": 119138, "time": "2008-07-30T12:09:19Z", "creator": "imacat@mail.imacat.idv.tw", "creation_time": "2008-07-30T12:09:19Z", "is_private": false, "text": "(In reply to comment #1)\n> Could not reproduce this in 2.3 trunk\n\nWell, I have confirmed that this issue still exists in 2.2.8.\nCould you please tell me how to obtain the 2.3 trunk, so that I can test it?  Thank you."}, {"count": 3, "tags": [], "bug_id": 41867, "text": "> Well, I have confirmed that this issue still exists in 2.2.8.\n> Could you please tell me how to obtain the 2.3 trunk, so that I can test it? \n> Thank you.\n\nget the tar ball from http://svn.apache.org/snapshots/httpd/ \n\n(Yes it exists in 2.2.8)", "id": 119139, "time": "2008-07-30T12:22:15Z", "creator": "rahul.g.nair@gmail.com", "creation_time": "2008-07-30T12:22:15Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "text": "Hi.  This is imacat from Taiwan.  Sorry for the reply delay.  It took me some time to let 2.3 run.\n\n(In reply to comment #3)\n> get the tar ball from http://svn.apache.org/snapshots/httpd/ \n\n    It does not work, for httpd_20080805161439.tar.gz.  The terminal log is below.  I used my test case and yours.  Both fails.  Did I fail to load some module?\n\n    Please tell me if there is any question, or if I could be of any help.  Thank you.\n\nimacat@rinse ~ % ls -l /tmp/apache/htdocs\ntotal 8\ndrwxr-xr-x 2 imacat users 4096 Aug  6 12:42 private\n-rw-r--r-- 1 imacat users   40 Aug  6 12:34 privatedetective.txt\nimacat@rinse ~ % cat /tmp/apache/htdocs/privatedetective.txt\nSherlock Holmes is a private detective.\nimacat@rinse ~ % cat /tmp/apache/httpd.conf\nDocumentRoot /tmp/apache/htdocs\nPidFile /tmp/apache/httpd.pid\nLoadModule access_compat_module /tmp/httpd-2.3/modules/aaa/.libs/mod_access_compat.so\nListen 50080\nErrorLog /tmp/apache/error_log\n\n<DirectoryMatch ^/tmp/apache/htdocs/private>\n  Deny from all\n</DirectoryMatch>\nimacat@rinse ~ % ls -l /tmp/httpd-2.3/CHANGES\n-rw-r--r-- 1 imacat users 18371 Aug  5 00:14 /tmp/httpd-2.3/CHANGES\nimacat@rinse ~ % /tmp/httpd-2.3/httpd -f /tmp/apache/httpd.conf\nimacat@rinse ~ % telnet localhost 50080\nTrying 127.0.0.1...\nConnected to localhost.\nEscape character is '^]'.\nGET /privatedetective.txt HTTP/1.1\nHost: localhost\nConnection: close\n\nHTTP/1.1 403 Forbidden\nDate: Wed, 06 Aug 2008 04:47:44 GMT\nServer: Apache/2.3.0-dev (Unix)\nContent-Length: 222\nConnection: close\nContent-Type: text/html; charset=iso-8859-1\n\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>403 Forbidden</title>\n</head><body>\n<h1>Forbidden</h1>\n<p>You don't have permission to access /privatedetective.txt\non this server.</p>\n</body></html>\nConnection closed by foreign host.\nimacat@rinse ~ % kill $(<//tmp/apache/httpd.pid)\nimacat@rinse ~ % cat /tmp/apache/error_log\n[Wed Aug 06 12:47:35 2008] [notice] Apache/2.3.0-dev (Unix) configured -- resuming normal operations\n[Wed Aug 06 12:47:44 2008] [error] [client 127.0.0.1] client denied by server configuration: /tmp/apache/htdocs/privatedetective.txt\n[Wed Aug 06 12:47:49 2008] [notice] caught SIGTERM, shutting down\nimacat@rinse ~ %\n\nimacat@rinse apache.18.Jul/install % pwd\n/space/store/apache.18.Jul/install\nimacat@rinse apache.18.Jul/install % echo \"Hello\" > ./htdocs/apache_test.txt\nimacat@rinse apache.18.Jul/install % cat httpd.conf\nDocumentRoot /space/store/apache.18.Jul/install/htdocs\nLoadModule access_compat_module /tmp/httpd-2.3/modules/aaa/.libs/mod_access_compat.so\nListen 8080\nPidFile /space/store/apache.18.Jul/install/httpd.pid\nErrorLog /space/store/apache.18.Jul/install/error_log\n<DirectoryMatch ^/space/store/apache.18.Jul/install/htdocs/apache>\n    deny from all\n</DirectoryMatch>\nimacat@rinse apache.18.Jul/install % /tmp/httpd-2.3/httpd -f $PWD/httpd.conf\nimacat@rinse apache.18.Jul/install % telnet 0 8080\nTrying 0.0.0.0...\nConnected to 0.\nEscape character is '^]'.\nGET /apache_test.txt HTTP/1.0\n\nHTTP/1.1 403 Forbidden\nDate: Wed, 06 Aug 2008 04:57:30 GMT\nServer: Apache/2.3.0-dev (Unix)\nContent-Length: 217\nConnection: close\nContent-Type: text/html; charset=iso-8859-1\n\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>403 Forbidden</title>\n</head><body>\n<h1>Forbidden</h1>\n<p>You don't have permission to access /apache_test.txt\non this server.</p>\n</body></html>\nConnection closed by foreign host.\nimacat@rinse apache.18.Jul/install % kill $(<httpd.pid)\nimacat@rinse apache.18.Jul/install % cat error_log\n[Wed Aug 06 12:57:19 2008] [notice] Apache/2.3.0-dev (Unix) configured -- resuming normal operations\n[Wed Aug 06 12:57:30 2008] [error] [client 127.0.0.1] client denied by server configuration: /space/store/apache.18.Jul/install/htdocs/apache_test.txt\n[Wed Aug 06 12:57:37 2008] [notice] caught SIGTERM, shutting down\nimacat@rinse apache.18.Jul/install %", "is_private": false, "id": 119468, "creator": "imacat@mail.imacat.idv.tw", "time": "2008-08-05T22:00:54Z", "bug_id": 41867, "creation_time": "2008-08-05T22:00:54Z", "attachment_id": null}, {"count": 5, "tags": [], "creator": "rahul.g.nair@gmail.com", "attachment_id": 22401, "text": "Created attachment 22401\nappend trailing slash to directory\n\nPlease try this patch and let me know if this does what you expect.\n(I was able to reproduce your problem, my earlier configuration was wrong.)", "id": 119544, "time": "2008-08-07T06:19:28Z", "bug_id": 41867, "creation_time": "2008-08-07T06:19:28Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 41867, "attachment_id": null, "id": 119545, "time": "2008-08-07T06:21:49Z", "creator": "rahul.g.nair@gmail.com", "creation_time": "2008-08-07T06:21:49Z", "is_private": false, "text": "The patch has the effect also that if you need to match \n/privatedirectory/ now, the regex to use will be \n\"^/xxxx/private.*\" rather than \"/xxxx/private\""}, {"count": 7, "tags": [], "bug_id": 41867, "attachment_id": null, "id": 119555, "time": "2008-08-07T11:44:47Z", "creator": "imacat@mail.imacat.idv.tw", "creation_time": "2008-08-07T11:44:47Z", "is_private": false, "text": "    Hi.  This is imacat from Taiwan.\n\n(In reply to comment #5)\n> Created an attachment (id=22401) [details]\n> Please try this patch and let me know if this does what you expect.\n\n    I suppose this patch works for this issue.  Maybe you could apply this patch to the 2.2, 2.0 and 1.3 branches.\n\n    However, the result is still not OK.  It now says \"couldn't check user\", where I do not know what it means at all.  This seems to be specific to the 2.3 branch, while 2.2 works fine.  I attached the log below.  Should I file a new bug on this?\n\nimacat@rinse ~ % ls -l /tmp/apache/htdocs\ntotal 8\ndrwxr-xr-x 2 imacat users 4096 Aug  6 12:42 private\n-rw-r--r-- 1 imacat users   40 Aug  6 12:34 privatedetective.txt\nimacat@rinse ~ % cat /tmp/apache/htdocs/privatedetective.txt\nSherlock Holmes is a private detective.\nimacat@rinse ~ % cat /tmp/apache/httpd.conf\nDocumentRoot /tmp/apache/htdocs\nPidFile /tmp/apache/httpd.pid\nListen 50080\nErrorLog /tmp/apache/error_log\nLoadModule access_compat_module /tmp/httpd-2.3-20080807161439/modules/aaa/.libs/mod_access_compat.so\n\n<DirectoryMatch ^/tmp/apache/htdocs/private>\n  Deny from all\n</DirectoryMatch>\nimacat@rinse ~ % ls -l /tmp/httpd-2.3-20080807161439/CHANGES\n-rw-r--r-- 1 imacat users 18559 Aug  8 00:14 /tmp/httpd-2.3-20080807161439/CHANGES\nimacat@rinse ~ % /tmp/httpd-2.3-20080807161439/httpd -f /tmp/apache/httpd.conf\nimacat@rinse ~ % telnet localhost 50080\nTrying 127.0.0.1...\nConnected to localhost.\nEscape character is '^]'.\nGET /privatedetective.txt HTTP/1.1\nHost: localhost\nConnection: close\n\nHTTP/1.1 500 Internal Server Error\nDate: Thu, 07 Aug 2008 18:37:18 GMT\nServer: Apache/2.3.0-dev (Unix)\nContent-Length: 538\nConnection: close\nContent-Type: text/html; charset=iso-8859-1\n\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>500 Internal Server Error</title>\n</head><body>\n<h1>Internal Server Error</h1>\n<p>The server encountered an internal error or\nmisconfiguration and was unable to complete\nyour request.</p>\n<p>Please contact the server administrator,\n [no address given] and inform them of the time the error occurred,\nand anything you might have done that may have\ncaused the error.</p>\n<p>More information about this error may be available\nin the server error log.</p>\n</body></html>\nConnection closed by foreign host.\nimacat@rinse ~ % kill $(</tmp/apache/httpd.pid)\nimacat@rinse ~ % cat /tmp/apache/error_log\n[Fri Aug 08 02:37:14 2008] [notice] Apache/2.3.0-dev (Unix) configured -- resuming normal operations\n[Fri Aug 08 02:37:18 2008] [crit] [client 127.0.0.1] configuration error:  couldn't check user: /privatedetective.txt\n[Fri Aug 08 02:37:24 2008] [notice] caught SIGTERM, shutting down\nimacat@rinse ~ %\n"}, {"count": 8, "tags": [], "bug_id": 41867, "attachment_id": null, "id": 119600, "time": "2008-08-08T04:38:16Z", "creator": "rahul.g.nair@gmail.com", "creation_time": "2008-08-08T04:38:16Z", "is_private": false, "text": "That is odd, I couldn't reproduce it, could you please post your httpd.conf in full (and logs with debug on)?\n"}, {"count": 9, "tags": [], "text": "    Hi.  This is imacat from Taiwan.\n\n(In reply to comment #8)\n> That is odd, I couldn't reproduce it, could you please post your httpd.conf in\n> full (and logs with debug on)?\n\n    I attached the terminal log below, including the httpd.conf, with \"LogLevel debug\".  Maybe I forgot to load some module or set some configuration?  Please tell me if you need any more information, or if I could be of any help.  Thank you.\n\nimacat@rinse ~ % ls -l /tmp/apache/htdocs\ntotal 8\ndrwxr-xr-x 2 imacat users 4096 Aug  6 12:42 private\n-rw-r--r-- 1 imacat users   40 Aug  6 12:34 privatedetective.txt\nimacat@rinse ~ % cat /tmp/apache/htdocs/privatedetective.txt\nSherlock Holmes is a private detective.\nimacat@rinse ~ % cat /tmp/apache/httpd.conf\nDocumentRoot /tmp/apache/htdocs\nPidFile /tmp/apache/httpd.pid\nListen 50080\nErrorLog /tmp/apache/error_log\nLogLevel debug\nLoadModule access_compat_module /tmp/httpd-2.3-20080807161439/modules/aaa/.libs/mod_access_compat.so\n\n<DirectoryMatch ^/tmp/apache/htdocs/private>\n  Deny from all\n</DirectoryMatch>\nimacat@rinse ~ % ls -l /tmp/httpd-2.3-20080807161439/CHANGES\n-rw-r--r-- 1 imacat users 18559 Aug  8 00:14 /tmp/httpd-2.3-20080807161439/CHANGES\nimacat@rinse ~ % /tmp/httpd-2.3-20080807161439/httpd -f /tmp/apache/httpd.conf\nimacat@rinse ~ % telnet localhost 50080\nTrying 127.0.0.1...\nConnected to localhost.\nEscape character is '^]'.\nGET /privatedetective.txt HTTP/1.1\nHost: localhost\nConnection: close\n\nHTTP/1.1 500 Internal Server Error\nDate: Fri, 08 Aug 2008 18:39:59 GMT\nServer: Apache/2.3.0-dev (Unix)\nContent-Length: 538\nConnection: close\nContent-Type: text/html; charset=iso-8859-1\n\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>500 Internal Server Error</title>\n</head><body>\n<h1>Internal Server Error</h1>\n<p>The server encountered an internal error or\nmisconfiguration and was unable to complete\nyour request.</p>\n<p>Please contact the server administrator,\n [no address given] and inform them of the time the error occurred,\nand anything you might have done that may have\ncaused the error.</p>\n<p>More information about this error may be available\nin the server error log.</p>\n</body></html>\nConnection closed by foreign host.\nimacat@rinse ~ % kill $(</tmp/apache/httpd.pid)\nimacat@rinse ~ % cat /tmp/apache/error_log\n[Sat Aug 09 02:39:54 2008] [notice] Apache/2.3.0-dev (Unix) configured -- resuming normal operations\n[Sat Aug 09 02:39:54 2008] [info] Server built: Aug  8 2008 02:14:45\n[Sat Aug 09 02:39:54 2008] [debug] prefork.c(960): AcceptMutex: sysvsem (default: sysvsem)\n[Sat Aug 09 02:39:59 2008] [crit] [client 127.0.0.1] configuration error:  couldn't check user: /privatedetective.txt\n[Sat Aug 09 02:40:02 2008] [info] removed PID file /tmp/apache/httpd.pid (pid=21062)\n[Sat Aug 09 02:40:02 2008] [notice] caught SIGTERM, shutting down\nimacat@rinse ~ %", "is_private": false, "id": 119633, "creator": "imacat@mail.imacat.idv.tw", "time": "2008-08-08T18:44:49Z", "bug_id": 41867, "creation_time": "2008-08-08T18:44:49Z", "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 41867, "attachment_id": null, "text": "It is failing at check userid (ap_run_check_user_id), are you sure that apache process has permissions to access the file?\n", "id": 119638, "time": "2008-08-09T04:55:10Z", "creator": "rahul.g.nair@gmail.com", "creation_time": "2008-08-09T04:55:10Z", "is_private": false}, {"count": 11, "tags": [], "text": "> [Sat Aug 09 02:39:59 2008] [crit] [client 127.0.0.1] configuration error: \n> couldn't check user: /privatedetective.txt\n> [Sat Aug 09 02:40:02 2008] [info] removed PID file /tmp/apache/httpd.pid\n> (pid=21062)\n\nIs this just an error from not starting with the default conf from trunk -- mod_authz_host/require all granted ", "is_private": false, "id": 119639, "creator": "covener@gmail.com", "time": "2008-08-09T05:40:30Z", "bug_id": 41867, "creation_time": "2008-08-09T05:40:30Z", "attachment_id": null}, {"count": 12, "tags": [], "creator": "imacat@mail.imacat.idv.tw", "text": "    Hi.  This is imacat from Taiwan.\n\n(In reply to comment #11)\n> > [Sat Aug 09 02:39:59 2008] [crit] [client 127.0.0.1] configuration error: \n> > couldn't check user: /privatedetective.txt\n> > [Sat Aug 09 02:40:02 2008] [info] removed PID file /tmp/apache/httpd.pid\n> > (pid=21062)\n> Is this just an error from not starting with the default conf from trunk --\n> mod_authz_host/require all granted \n\n    Sorry that I took several days to reply.  I really tried hard to get it working, but fails.  Could you please provide a sample httpd.conf that works for httpd 2.3, so that I can test?  Thank you very much for this.", "id": 119793, "attachment_id": null, "bug_id": 41867, "creation_time": "2008-08-13T10:08:56Z", "time": "2008-08-13T10:08:56Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 41867, "attachment_id": null, "id": 119794, "time": "2008-08-13T11:25:56Z", "creator": "rahul.g.nair@gmail.com", "creation_time": "2008-08-13T11:25:56Z", "is_private": false, "text": "Here is my conf\n==========================================================\nServerRoot \"/space/store/apache.06.Aug/install\"\n\nListen 8080\nLoadModule access_compat_module modules/mod_access_compat.so\nUser daemon\nGroup daemon\nServerName agneyam\nDocumentRoot \"/tmp/apache/htdocs\"\n<Directory />\n    Options FollowSymLinks\n    AllowOverride None\n    Require all denied\n</Directory>\n\n<Directory \"/tmp/apache/htdocs\">\n    Options Indexes FollowSymLinks\n    AllowOverride None\n    AuthzMergeRules Off\n</Directory>\n\n<DirectoryMatch ^/tmp/apache/htdocs/private>\n  Deny from all\n</DirectoryMatch>\n=========================================================="}, {"count": 14, "tags": [], "text": "    Hi.  This is imacat from Taiwan.\n\n(In reply to comment #13)\n> Here is my conf\n\n    Thank you for your hint.  I got an error \"Invalid command 'Require'\" with your httpd.conf.  The terminal log is attached below.  I searched Google and found nothing on this.  Could you please tell me what does it mean?  Thank you very much.\n\nimacat@rinse ~ % cat /tmp/apache/httpd.conf\nListen 8080\nLoadModule access_compat_module /tmp/apache/lib/mod_access_compat.so\nUser daemon\nGroup daemon\nServerName agneyam\nDocumentRoot \"/tmp/apache/htdocs\"\n<Directory />\n    Options FollowSymLinks\n    AllowOverride None\n    Require all denied\n</Directory>\n\n<Directory \"/tmp/apache/htdocs\">\n    Options Indexes FollowSymLinks\n    AllowOverride None\n    AuthzMergeRules Off\n</Directory>\n\n<DirectoryMatch ^/tmp/apache/htdocs/private>\n  Deny from all\n</DirectoryMatch>\nimacat@rinse ~ % /tmp/httpd-2.3-20080813101457/httpd -f /tmp/apache/httpd.conf\nSyntax error on line 10 of /tmp/apache/httpd.conf:\nInvalid command 'Require', perhaps misspelled or defined by a module not included in the server configuration\nimacat@rinse ~ %\n", "is_private": false, "id": 119809, "creator": "imacat@mail.imacat.idv.tw", "time": "2008-08-13T20:55:51Z", "bug_id": 41867, "creation_time": "2008-08-13T20:55:51Z", "attachment_id": null}, {"count": 15, "text": "It is provided by authz_core, I guess it may have been statically linked\nin my httpd.\nhttp://httpd.apache.org/docs/trunk/mod/mod_authz_core.html#require", "creator": "rahul.g.nair@gmail.com", "attachment_id": null, "id": 119819, "time": "2008-08-14T02:20:34Z", "bug_id": 41867, "creation_time": "2008-08-14T02:20:34Z", "tags": [], "is_private": false}, {"count": 16, "tags": [], "creator": "imacat@mail.imacat.idv.tw", "attachment_id": null, "text": "    Hi.  This is imacat from Taiwan.\n\n    I made several tests tonight.  This is the least httpd.conf to work.  As a result, I think this bug can be closed if the patch#22401 is applied in 2.0, 2.2 and 2.3 branches.\n\n    Please tell me if you need any more information, of if I could be of any help.  Thank you.\n\nimacat@rinse ~ % ls -l /tmp/apache/htdocs\ntotal 8\ndrwxr-xr-x 2 imacat users 4096 Aug  6 12:42 private\n-rw-r--r-- 1 imacat users   40 Aug  6 12:34 privatedetective.txt\nimacat@rinse ~ % cat /tmp/apache/htdocs/privatedetective.txt\nSherlock Holmes is a private detective.\nimacat@rinse ~ % cat /tmp/apache/httpd.conf\nUser imacat\nGroup nogroup\nDocumentRoot /tmp/apache/htdocs\nPidFile /tmp/apache/httpd.pid\nListen 50080\nErrorLog /tmp/apache/error_log\nLogLevel debug\nLoadModule authn_default_module modules/mod_authn_default.so\nLoadModule authz_default_module modules/mod_authz_default.so\nLoadModule access_compat_module modules/mod_access_compat.so\n\n<DirectoryMatch ^/tmp/apache/htdocs/private>\n  Deny from all\n</DirectoryMatch>\nimacat@rinse ~ % /tmp/apache-2.3-20080814101449/bin/httpd -l\nCompiled in modules:\n  core.c\n  prefork.c\n  http_core.c\n  mod_so.c\nimacat@rinse ~ % /tmp/apache-2.3-20080814101449/bin/httpd -f /tmp/apache/httpd.conf\nimacat@rinse ~ % telnet localhost 50080\nTrying 127.0.0.1...\nConnected to localhost.\nEscape character is '^]'.\nGET /privatedetective.txt HTTP/1.1\nHost: localhost\nConnection: close\n\nHTTP/1.1 200 OK\nDate: Thu, 14 Aug 2008 16:11:26 GMT\nServer: Apache/2.3.0-dev (Unix)\nLast-Modified: Wed, 06 Aug 2008 04:34:10 GMT\nETag: \"238f6a-28-453c3156c7480\"\nAccept-Ranges: bytes\nContent-Length: 40\nConnection: close\nContent-Type: text/plain\n\nSherlock Holmes is a private detective.\nConnection closed by foreign host.\nimacat@rinse ~ % kill $(</tmp/apache/httpd.pid)\nimacat@rinse ~ % cat /tmp/apache/error_log\n[Fri Aug 15 00:11:22 2008] [notice] Apache/2.3.0-dev (Unix) configured -- resuming normal operations\n[Fri Aug 15 00:11:22 2008] [info] Server built: Aug 14 2008 23:47:15\n[Fri Aug 15 00:11:22 2008] [debug] prefork.c(960): AcceptMutex: sysvsem (default: sysvsem)\nimacat@rinse ~ %", "id": 119839, "time": "2008-08-14T09:12:16Z", "bug_id": 41867, "creation_time": "2008-08-14T09:12:16Z", "is_private": false}, {"count": 17, "tags": [], "bug_id": 41867, "text": "Created attachment 32161\nanother approach\n\nAttached patch fixes the issue byt marking core_dir_config entries created by Directory/DirectoryMatch directives. In ap_directory_walk, the last core_dir_config entry is checked and if we are going to serve regular file, but the entry is created using Directory/DirectoryMatch, it is skipped.", "id": 178812, "time": "2014-10-29T09:13:11Z", "creator": "jkaluza@redhat.com", "creation_time": "2014-10-29T09:13:11Z", "is_private": false, "attachment_id": 32161}, {"count": 18, "tags": [], "creator": "jkaluza@redhat.com", "attachment_id": null, "text": "The benefit of my patch is that it keeps the backward compatibility with previous DirectoryMatch (So it does not suffer the problem mentioned in Comment 6).", "id": 178813, "time": "2014-10-29T09:14:31Z", "bug_id": 41867, "creation_time": "2014-10-29T09:14:31Z", "is_private": false}, {"count": 19, "tags": [], "bug_id": 41867, "attachment_id": 32163, "id": 178821, "time": "2014-10-29T11:08:54Z", "creator": "jkaluza@redhat.com", "creation_time": "2014-10-29T11:08:54Z", "is_private": false, "text": "Created attachment 32163\nanother approach v2"}, {"count": 20, "tags": [], "bug_id": 41867, "attachment_id": null, "id": 178842, "time": "2014-10-30T08:35:04Z", "creator": "jkaluza@redhat.com", "creation_time": "2014-10-30T08:35:04Z", "is_private": false, "text": "Committed in trunk in r1635428."}, {"count": 21, "tags": [], "creator": "wrowe@apache.org", "text": "Thanks again imacat for the report.  Your observations absolutely have merit and need to be addressed.  I've reverted the patch with the following notes, reproducing here for completeness...\n\nRevert r4635428 corresponding to PR41867.\n\nThe code reverted attempted to restrict comparisons of the r->filename\nto given DirectoryMatch blocks.\n\nr->filename was already a non-directory entity at this point, because we\nhave already fallen out of the } while (thisinfo.filetype == APR_DIR);\nblock above.\n\nThe addition of r->d_is_directory was redundant.  That is what is always\nreturned by ap_get_core_module_config(r->per_dir_config).\n\nNote modifying dir_config required an MMN major bump as this commit could\nhave realigned the offset of refs (had it been added to the end, this\nwould correspond to an mmn minor bump) and other fields packed into the\nsame bytes (this is undefined). Bump on revert to prevent unexpected crashes.", "id": 180458, "attachment_id": null, "bug_id": 41867, "creation_time": "2015-01-22T00:03:20Z", "time": "2015-01-22T00:03:20Z", "is_private": false}, {"count": 22, "text": "Hopefully, this will help somewhat, clearing the resolved bit.\n\nThe appropriate patch will track the length of all directory-related path segments for later comparison.  This snippet below is just a part of accomplishing this task; \n\n--- request.c   (revision 1653666)\n+++ request.c   (working copy)\n@@ -566,6 +566,8 @@\n     walk_cache_t *cache;\n     char *entry_dir;\n     apr_status_t rv;\n+    apr_size_t dir_len;\n+    char save_ch;\n     int cached;\n\n     /* XXX: Better (faster) tests needed!!!\n@@ -1169,6 +1170,9 @@\n                 return r->status = HTTP_FORBIDDEN;\n             }\n\n+            /* directory-path string length here for DirectoryMatch */\n+            dir_len = strlen(r->filename);\n+\n             ++seg;\n         } while (thisinfo.filetype == APR_DIR);\n\n\nthe optimizations earlier in the code would cause dir_len to remain unset on subrequests, owing to the fact that we don't 'parse twice' any identical path elements.  I just haven't had time to evaluate each of the 'continue'/'break' cases in the intervening code.\n\nProvided that the accumulated dir_len is correct, and that we ensure r->filename, at this stage of the game, is allocated one byte longer than the given string, then we can play this quick trick to always compare the path -including- any provided trailing slash against the directorymatch regular expression strings;\n\n@@ -1191,10 +1195,17 @@\n             }\n         }\n\n-        /*\n-         * Now we'll deal with the regexes, note we pick up sec_idx\n-         * where we left off (we gave up after we hit entry_core->r)\n+        /* Now we'll deal with the DirectoryMatch regex's\n+         *\n+         * First, shorten r->filename to dir_len, plus the trailing\n+         * slash when present\n          */\n+        save_ch = r->filename[dir_len + 1];\n+        r->filename[dir_len + 1] = '\\0';\n+\n+        /* Note we pick up sec_idx where we left off\n+         * (we gave up above once we hit entry_core->r)\n+         */\n         for (; sec_idx < num_sec; ++sec_idx) {\n\n             int nmatch = 0;\n@@ -1216,6 +1227,8 @@\n                 pmatch = apr_palloc(rxpool, nmatch*sizeof(ap_regmatch_t));\n             }\n\n+            /* r->filename here has been truncated to the directory path\n+             * component -including- trailing slash\n             if (ap_regexec(entry_core->r, r->filename, nmatch, pmatch, 0)) {\n                 continue;\n             }\n@@ -1268,6 +1281,8 @@\n             last_walk->matched = sec_ent[sec_idx];\n             last_walk->merged = now_merged;\n         }\n+        /* Restore filename  now that we have processed DirectoryMatch'es */\n+        r->filename[dir_len + 1] = save_ch;\n\n         if (rxpool) {\n             apr_pool_destroy(rxpool);\n\n\nI'll come back to this and invite everyone to beat me to completing this patch, and preventing the case described in #1 above.", "creator": "wrowe@apache.org", "attachment_id": null, "id": 180459, "time": "2015-01-22T00:11:03Z", "bug_id": 41867, "creation_time": "2015-01-22T00:11:03Z", "tags": [], "is_private": false}]