[{"count": 0, "tags": [], "creator": "vanhoofjo@telenet.be", "attachment_id": null, "text": "we noticed in our current setup on apache 2.2 that a ProxyPass to a https backend with ProxyRemote * always create a new TCP connection when a new request arrives , although http keepalive is activated \n\nwe also noticed this problem is resolved when we upgrade to apache 2.4 with the same setup\n\nafter some testing with a while bunch of different apache versions and patches we've discovered that r1227642 ( http://svn.apache.org/viewvc?view=revision&amp;revision=1227642 ) , which was put in branch 2.4 via r1227645 ( http://svn.apache.org/viewvc?view=revision&revision=1227645 ) seems to solve this keepalive problem in this particular config\n\nwe've tested following patch on a 2.2 (diff from 2.2-head)\n----------------------\n\n--- proxy_util.c        2016-07-28 02:55:34.000000000 +0200\n+++ proxy_util.c        2016-08-02 21:16:59.000000000 +0200\n@@ -2183,19 +2183,17 @@\n                            uri->fragment ? uri->fragment : \"\", NULL);\n     }\n     /*\n-     * Make sure that we pick the the correct and valid worker.\n-     * If a single keepalive connection triggers different workers,\n-     * then we have a problem (we don't select the correct one).\n-     * Do an expensive check in this case, where we compare the\n-     * the hostnames associated between the two.\n+     * Figure out if our passed in proxy_conn_rec has a usable\n+     * address cached.\n      *\n-     * TODO: Handle this much better...\n+     * TODO: Handle this much better...\n+     *\n+     * XXX: If generic workers are ever address-reusable, we need\n+     *      to check host and port on the conn and be careful about\n+     *      spilling the cached addr from the worker.\n      */\n     if (!conn->hostname || !worker->is_address_reusable ||\n-         worker->disablereuse ||\n-         (r->connection->keepalives &&\n-         (r->proxyreq == PROXYREQ_PROXY || r->proxyreq == PROXYREQ_REVERSE) &&\n-         (strcasecmp(conn->hostname, uri->hostname) != 0) ) ) {\n+         worker->disablereuse) {\n         if (proxyname) {\n             conn->hostname = apr_pstrdup(conn->pool, proxyname);\n             conn->port = proxyport;\n----------------------\n\nthis patch seems to solve the keepalive issue on a 2.2, although i am not 100% sure if it will break other stuff, should this patch be committed to the 2.2-branch ?", "id": 192858, "time": "2016-08-03T11:33:41Z", "bug_id": 59935, "creation_time": "2016-08-03T11:33:41Z", "is_private": false}]