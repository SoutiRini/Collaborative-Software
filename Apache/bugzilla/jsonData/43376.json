[{"count": 0, "tags": [], "bug_id": 43376, "is_private": false, "id": 108109, "creation_time": "2007-09-13T01:47:16Z", "time": "2007-09-13T01:47:16Z", "creator": "hearace@163.com", "text": "I create a ppt file with some macro code.  Then I edit the ppt file by a java \napplication. The java code is below:\npublic class Test {\n\tpublic static void main(String[] args){\n\t\tSystem.out.println(\"Start\");\n\t\tString data = \"test abc\";\n\t\ttry {\n\t\t\tFileInputStream fis = new FileInputStream\n(\"d:\\\\test\\\\temp.ppt\");\n\t\t\tHSLFSlideShow hss = new HSLFSlideShow(fis);\n\t\t\tSlideShow ss = new SlideShow(hss);\n\t\t\tSlide slide = ss.getSlides()[0];\n\t\t\tTextBox shape = new TextBox();\n\t\t\tshape.setText(data);\n\t\t\tshape.setAnchor(new java.awt.Rectangle(50, 50, 500, \n300));  \n//\t\t\tslide.addShape(shape);\n\n\t\t\tFileOutputStream fos = new FileOutputStream\n(\"d:\\\\test\\\\result.ppt\");\n\t\t\thss.write(fos);\n\t\t\t//ss.write(fos);\n\t\t} catch (FileNotFoundException e) {\n\t\t\t// TODO Auto-generated catch block\n\t\t\te.printStackTrace();\n\t\t} catch (IOException e) {\n\t\t\t// TODO Auto-generated catch block\n\t\t\te.printStackTrace();\n\t\t}\n\t\t\n\t\tSystem.out.println(\"End\");\n\t}\n}\n\nWhen I try to run the macro in the new ppt file \"result.ppt\", the error \"File \nnot found\" occured.\n\nMy Enviroument likes below:\nOS: Windows xp Simple Chinese Edition\nJDK: 1.4.2\npoi: 3.0.1-FINAL-20070705\nOffice: ppt file is created by office xp & 2003 (I tried two ppt file create \nby different office edition)", "attachment_id": null}, {"count": 1, "tags": [], "creator": "apache@gagravarr.org", "attachment_id": null, "text": "It's possible the macros are stored in another stream, and we're not writing it\nback out again\n\nCould you upload a sample file, so we can take a look?", "id": 108113, "time": "2007-09-13T02:34:25Z", "bug_id": 43376, "creation_time": "2007-09-13T02:34:25Z", "is_private": false}, {"count": 2, "tags": [], "creator": "hearace@163.com", "attachment_id": 20822, "id": 108181, "time": "2007-09-13T18:19:41Z", "bug_id": 43376, "creation_time": "2007-09-13T18:19:41Z", "is_private": false, "text": "Created attachment 20822\nthis is the template file"}, {"attachment_id": 20823, "tags": [], "bug_id": 43376, "text": "Created attachment 20823\nhere is the result file Generated by java", "count": 3, "id": 108182, "time": "2007-09-13T18:21:59Z", "creator": "hearace@163.com", "creation_time": "2007-09-13T18:21:59Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 43376, "attachment_id": null, "id": 108262, "time": "2007-09-17T03:27:34Z", "creator": "hearace@163.com", "creation_time": "2007-09-17T03:27:34Z", "is_private": false, "text": "(In reply to comment #1)\n> It's possible the macros are stored in another stream, and we're not writing \nit\n> back out again\n> Could you upload a sample file, so we can take a look?\n\nHi, Nick Burch\n\nCould you please give some explanation about the problem such as why this \nhappen etc? Could you please tell me the target day to fix this defect? \nBecause it's very important for my project.\n\nThank you!"}, {"count": 5, "tags": [], "bug_id": 43376, "attachment_id": null, "is_private": false, "id": 108279, "time": "2007-09-17T09:33:22Z", "creator": "apache@gagravarr.org", "creation_time": "2007-09-17T09:33:22Z", "text": "On closer inspection, it appears that the macros aren't in a different stream.\nSo, it isn't a case of us loosing OLE2 streams - all the OLE2 streams in the\nsource document are ending up in the final one. (That said, it is now possible\nto ask HSLF to preserve all OLE2 nodes, much as you have been able to do with HSSF)\n\nHowever, the PowerPoint stream is shrinking in size, so some data is getting\nlost. Your best bet is to compare the two files using the\norg.apache.poi.hslf.dev tools, and try to spot where your data is going missing.\nMy guess is that we're not re-serialising one of the key records properly.\n\nIf you can figure out exactly where the data loss is occuring, then hopefully we\ncan fix it"}, {"count": 6, "tags": [], "bug_id": 43376, "attachment_id": null, "id": 108286, "time": "2007-09-17T11:54:21Z", "creator": "yegor@dinom.ru", "creation_time": "2007-09-17T11:54:21Z", "is_private": false, "text": "How interesting!\n\nI was sure it's a lost POIFS entry. In Word and Excel macros do live\nin POIFS! It turns out PPT is a different case (:.\n \nHere is what I've found:\nIn PPT macros are stored in ExOleObjStg root-level records. I changed the macro\ncode, saved the ppt and compared it with the original. \nThe only difference was in ExOleObjStg. Thanks to Trejkaz, now we have accessors\nto this data.\n\nHere is a test code to dump ExOleObjStg in filesystem:\n\n        FileInputStream fis = new FileInputStream(\"temp.ppt\");\n        HSLFSlideShow hss = new HSLFSlideShow(fis);\n\n        ObjectData[] obj = hss.getEmbeddedObjects();\n        for (int i = 0; i < obj.length; i++) {\n            FileOutputStream out = new FileOutputStream(\"objdata-\" + (i+1) +\n\".dat\");\n            InputStream is = obj[i].getData();\n            byte[] chunk = new byte[16184];\n            int count;\n            while ((count = is.read(chunk)) >=0 ) {\n              out.write(chunk,0,count);\n            }\n            out.close();\n        }\n\nLook at it in a text editor and see that \"it is about macros\" :).\nIt looks like this data has a reference (offset) to the owning slide. If I don't\nchange anything, just re-save the ppt then the macros are there.\nIf I add a shape the macros are lost. So the task is to find this place\nand update the link.\n\nI don't know how to parse this abracadabra. Any ideas?\n AFAIK, VBA macros are stored as \"p-code + s-code\" where p-code is compiled VBA\ncode and s-code is the source. That is ExOleObjStg contains both compiled and\nsource VBA code. \n\nUseful links are \nhttp://www.virushelpmunic.de/konferenz/1999/makroviren/ (In German)\nhttp://www.uinc.ru/articles/46/ (In Russian)\n\nThey are about Word and Excel and I hope these ideas are applicable to PPT.\n\n\nRegards,\nYegor"}, {"attachment_id": null, "tags": [], "creator": "hearace@163.com", "text": "Can this problem be fixed?", "count": 7, "id": 108737, "time": "2007-09-28T00:20:21Z", "bug_id": 43376, "creation_time": "2007-09-28T00:20:21Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 43376, "is_private": false, "id": 108738, "creation_time": "2007-09-28T00:40:11Z", "time": "2007-09-28T00:40:11Z", "creator": "yegor@dinom.ru", "text": "Unfortunately not. At least not in foreseeable future. \nWe know where PowerPoint stores macro code and what causes it to be lost after\nedit. To fix it we need to decode ExOleObjStg and it is a big task. If you want\nto be a volunteer - you are very much welcome. I can explain basic principles of\nhacking ppt format and help you.\n\n\nRegards,\nYegor", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 43376, "is_private": false, "id": 185994, "creation_time": "2015-10-26T21:32:30Z", "time": "2015-10-26T21:32:30Z", "creator": "dominik.stadler@gmx.at", "text": "This is unsolved and unresponded for a long time, therefore closing this as WONTFIX for now. If you have plans to work on this, please discuss on the dev-mailing list first.", "attachment_id": null}]