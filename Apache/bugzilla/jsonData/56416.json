[{"count": 0, "tags": [], "creator": "david.lander@telus.com", "attachment_id": null, "text": "According to http connector documentation, JVM defaults will be respected for socket linger options.  \nhttps://tomcat.apache.org/tomcat-7.0-doc/config/http.html\n\nSeems that linger is being set to false regardless of JVM default.\n\nSetting priority to CRITICAL because on certain Solaris versions, calls to set linger cause performance problems and SocketExceptions.  I am experiencing this on my application.  See JVM bug.  http://bugs.java.com/view_bug.do?bug_id=6799574\n\nReproducable steps:\n1)  Within server.xml, configure NIO http connector without an explicit linger setting:\n    <Connector port=\"8080\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\"\n               connectionTimeout=\"20000\"\n               redirectPort=\"8443\" />\n\n\n2)  Start Tomcat.  \n\nResult: Linger is set to false for http nio connectors regardless of JVM default. \n\nExpected:  Linger parameter is not set on sockets.  JVM defaults are used.\nWithin setProperties method of SocketProperties.java,\nbreakpoint on line 194 should not be hit for http nio connector\nsocket.setSoLinger(soLingerOn.booleanValue(), soLingerTime.intValue()); \n\n\n\nProblem is that in the Http11NioProtocol constructor, a hard coded default value is set: \n\n    public Http11NioProtocol() {\n        .... \n        setSoLinger(Constants.DEFAULT_CONNECTION_LINGER);  // -1\n        ....  \n    }\n\nAny Java program can change the default socket factory for that JVM.  Tomcat cannot assume any particular default value for linger.  As per Tomcat's documentation, Tomcat should not be setting linger on the underlying socket unless it is specified within server.xml.\n\nI suspect that this applies to other connectors as well e.g. AJP.", "id": 174644, "time": "2014-04-16T16:11:20Z", "bug_id": 56416, "creation_time": "2014-04-16T16:11:20Z", "is_private": false}, {"count": 1, "text": "Fixed in 8.0.x for 8.0.6 onwards and in 7.0.x for 7.0.54 onwards.", "creator": "markt@apache.org", "attachment_id": null, "id": 174836, "time": "2014-04-24T11:38:27Z", "bug_id": 56416, "creation_time": "2014-04-24T11:38:27Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "Removing the default broke lots of stuff.\n\nFurther explicitly disabling socket linger is a sensible default for a web server.\n\nThe docs will be updated to reflect the actual default.\n\nA possible work around for Solaris is to specify values for socket linger that Solaris finds acceptable.", "id": 174840, "time": "2014-04-24T13:33:08Z", "bug_id": 56416, "creation_time": "2014-04-24T13:33:08Z", "is_private": false}, {"count": 3, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "Docs updated for 8.0.x for 8.0.6 and 7.0.x for 7.0.54.", "id": 174841, "time": "2014-04-24T13:38:24Z", "bug_id": 56416, "creation_time": "2014-04-24T13:38:24Z", "is_private": false}, {"count": 4, "tags": [], "text": "Mark,\n\nOn my end we have the following scenario:\n1)  Start Tomcat\n2)  Tomcat binds to port and starts loading webapps\n3)  My web app has a servlet for which load-on-startup is set to True.  Tomcat starts to load the servlet.\n4)  While Tomcat is loading the servlet, client establishes a TCP connection and sends a TCP request.\n5)  Tomcat is still loading the load-on-startup servlet, so the TCP request sits in the OS buffer.\n6)  Client gets fed up and closes the TCP connection.\n7)  Tomcat finishes loading the load-on-startup servlet.  \n8)  Tomcat Acceptor thread starts accepting TCP requests that have built up in the OS buffer\n9) Tomcat tries to set various properties on the socket.\n\nThe problem is that the CLIENT HAS ALREADY CLOSED THE CONNECTION (SEE STEP 7)\n\nResult:  SocketExceptions in Tomcat log file.\n\nShould the above be logged in a separate bug or do you have any other insight.  \n\nThanks,\nDavid", "attachment_id": null, "id": 174842, "creator": "david.lander@telus.com", "time": "2014-04-24T13:52:12Z", "bug_id": 56416, "creation_time": "2014-04-24T13:52:12Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 56416, "attachment_id": null, "id": 174843, "time": "2014-04-24T13:55:06Z", "creator": "markt@apache.org", "creation_time": "2014-04-24T13:55:06Z", "is_private": false, "text": "(In reply to David from comment #4)\n> On my end we have the following scenario:\n\n<snip/>\n\nBugzilla is not a support forum. This question belongs on the Tomcat users mailing list."}, {"count": 6, "tags": [], "bug_id": 56416, "text": "(In reply to David from comment #4)\n\nFirst, that would better be tracked as a separate issue.\n\nSecond, it cannot be said much without knowing your Tomcat version and stacktrace of the error.\n\nJioEndpoint and AprEndpoint implementations of setSocketOptions() log socket exceptions at debug level (the latter logs all errors at debug level).\n\nNioEndpoint, Nio2Endpoint implementations of setSocketOptions() may need a fix.", "id": 174845, "time": "2014-04-24T15:43:57Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-04-24T15:43:57Z", "is_private": false, "attachment_id": null}]