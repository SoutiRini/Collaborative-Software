[{"count": 0, "tags": [], "bug_id": 60339, "attachment_id": null, "is_private": false, "id": 194814, "time": "2016-11-04T10:08:40Z", "creator": "515951184@163.com", "creation_time": "2016-11-04T10:08:40Z", "text": "POI XWPF usage anchor tag add position picture failure. \nUsing inline is ok, but using anchor can not open word, prompt /word/document.xml line 2, col ...\n\ndocx4j is ok.\n\n//========================================\n// code: @see org.apache.poi.xwpf.usermodel.XWPFRun#addPicture\n//========================================\nXWPFDocument doc = new XWPFDocument();\nXWPFParagraph p = doc.createParagraph();\nXWPFRun r = p.createRun();\n\nString relationId = doc.addPictureData(new FileInputStream(filename), XWPFDocument.PICTURE_TYPE_PNG);\n\nString xml = readFile(\"doc.xml\");\nxml = xml.replaceAll(\"embed=\\\"rId3\\\"\", \"embed=\\\"\" + relationId + \"\\\"\");\n\nCTDrawing drawing = r.getCTR().addNewDrawing();\ndrawing.set(XmlToken.Factory.parse(xml, DEFAULT_XML_OPTIONS));\n\nCTPicture pic = getCTPictures(drawing).get(0);\n\nXWPFPicture xwpfPicture = new XWPFPicture(pic, r);\nr.getEmbeddedPictures().add(xwpfPicture);\n\n... \npublic List<CTPicture> getCTPictures(XmlObject o) {\n        List<CTPicture> pictures = new ArrayList<CTPicture>();\n        XmlObject[] picts = o.selectPath(\"declare namespace pic='\" \n            + CTPicture.type.getName().getNamespaceURI() + \"' .//pic:pic\");\n        for (XmlObject pict : picts) {\n            if (pict instanceof XmlAnyTypeImpl) {\n                // Pesky XmlBeans bug - see Bugzilla #49934\n                try {\n                    pict = CTPicture.Factory.parse(pict.toString(), \n                        DEFAULT_XML_OPTIONS);\n                } catch (XmlException e) {\n                    throw new POIXMLException(e);\n                }\n            }\n            if (pict instanceof CTPicture) {\n                pictures.add((CTPicture) pict);\n            }\n        }\n        return pictures;\n}\n\n//==============================\n// doc.xml:\n//==============================\n<anchor allowOverlap=\"true\" layoutInCell=\"false\" locked=\"false\" behindDoc=\"false\" relativeHeight=\"0\" simplePos=\"false\" distR=\"0\" distL=\"0\" distB=\"0\" distT=\"0\">\n\t<simplePos y=\"0\" x=\"0\"/>\n\t<positionH relativeFrom=\"margin\">\n\t\t<align>right</align>\n\t</positionH>\n\t<positionV relativeFrom=\"page\">\n\t\t<posOffset>360000</posOffset>\n\t</positionV>\n\t<extent cy=\"4997254\" cx=\"5732145\"/>\n\t<effectExtent b=\"0\" r=\"0\" t=\"0\" l=\"0\"/>\n\t<wrapNone/>\n\t<docPr descr=\"Picture Alt\" name=\"Picture Hit\" id=\"0\"/>\n\t<cNvGraphicFramePr>\n\t\t<a:graphicFrameLocks noChangeAspect=\"true\" xmlns:a=\"http://schemas.openxmlformats.org/drawingml/2006/main\" />\n\t</cNvGraphicFramePr>\n\t<a:graphic xmlns:a=\"http://schemas.openxmlformats.org/drawingml/2006/main\">\n\t\t<a:graphicData uri=\"http://schemas.openxmlformats.org/drawingml/2006/picture\" xmlns:a=\"http://schemas.openxmlformats.org/drawingml/2006/main\">\n\t\t\t<pic:pic xmlns:pic=\"http://schemas.openxmlformats.org/drawingml/2006/picture\">\n\t\t\t\t<pic:nvPicPr>\n\t\t\t\t\t<pic:cNvPr name=\"Picture Hit\" id=\"1\"/>\n\t\t\t\t\t<pic:cNvPicPr/>\n\t\t\t\t</pic:nvPicPr>\n\t\t\t\t<pic:blipFill>\n\t\t\t\t\t<a:blip r:embed=\"rId3\"/>\n\t\t\t\t\t<a:stretch>\n\t\t\t\t\t\t<a:fillRect/>\n\t\t\t\t\t</a:stretch>\n\t\t\t\t</pic:blipFill>\n\t\t\t\t<pic:spPr>\n\t\t\t\t\t<a:xfrm>\n\t\t\t\t\t\t<a:off y=\"0\" x=\"0\"/>\n\t\t\t\t\t\t<a:ext cy=\"4997254\" cx=\"5732145\"/>\n\t\t\t\t\t</a:xfrm>\n\t\t\t\t\t<a:prstGeom prst=\"rect\">\n\t\t\t\t\t\t<a:avLst/>\n\t\t\t\t\t</a:prstGeom>\n\t\t\t\t</pic:spPr>\n\t\t\t</pic:pic>\n\t\t</a:graphicData>\n\t</a:graphic>\n</anchor>"}, {"count": 1, "tags": [], "bug_id": 60339, "attachment_id": null, "is_private": false, "id": 195501, "time": "2016-12-15T06:22:17Z", "creator": "515951184@163.com", "creation_time": "2016-12-15T06:22:17Z", "text": "The problem has been resolved.\nBy reference docx4j project, it is found that XML is missing a namespace prefix.\nResolved by modify doc.xml."}]