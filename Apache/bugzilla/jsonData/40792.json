[{"count": 0, "tags": [], "bug_id": 40792, "text": "It seems that there is a bug in the error handling code in the lb worker.\n\nI was using a modjk/tomcat configuration with a lb worker and two ajp13 workers.\nOne of the ajp13 workers was marked disabled and stopped.  The other tomcat\nworker returned a 500 HTTP response for one user of the system.  This caused the\nfollowing log messages from modjk code:\n\n[Mon Oct 16 13:39:16 2006] [info] ajp_process_callback::jk_ajp_common.c (1375):\nConnection aborted or network problems\n[Mon Oct 16 13:39:16 2006] [info] ajp_service::jk_ajp_common.c (1719): Receiving\nfrom tomcat failed, because of client error without recovery\n in send loop 0\n[Mon Oct 16 13:39:16 2006] [info] service::jk_lb_worker.c (677): unrecoverable\nerror 400, request failed. Client failed in the middle of requ\nest, we can't recover to another instance.\n[Mon Oct 16 13:39:16 2006] [info] jk_handler::mod_jk.c (1970): Aborting\nconnection for worker=lb\n\nThe error caused other users at the time to receive 503 error from apache\nbecause modjk considered no workers to be OK. After awhile (about 1 minute)\nmodjk recognized that the Tomcat worker was ok and started working again.\n\nIn looking at the code, it appears that the problem might be that the worker's\nbusy flag is not cleared in this snippet of code:\n\n(from jk_lb_worker.c: line 666 revision 1.89)\nelse if (service_stat == JK_CLIENT_ERROR) {\n  /*\n   * Clent error !!!\n   * Since this is bad request do not fail over.\n   */\n  rec->s->errors++;\n  rec->s->in_error_state = JK_FALSE;\n  rec->s->in_recovering = JK_FALSE;\n  rec->s->error_time = 0;\n  *is_error = is_service_error;\n\n  jk_log(l, JK_LOG_INFO,\n       \"unrecoverable error %d, request failed.\"\n       \" Client failed in the middle of request,\"\n                           \" we can't recover to another instance.\",\n                           is_service_error);\n       JK_TRACE_EXIT(l);\n       return JK_CLIENT_ERROR;\n }\n\nThe JK_WORKER_IN_ERROR and JK_WORKER_USABLE macros check the is_busy flag so it\nseems that not clearing it could cause a problem.", "id": 94953, "time": "2006-10-18T16:57:35Z", "creator": "ken@i2rd.com", "creation_time": "2006-10-18T16:57:35Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 40792, "attachment_id": null, "id": 94956, "time": "2006-10-18T21:28:01Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2006-10-18T21:28:01Z", "is_private": false, "text": "Which version of mod_jk?"}, {"count": 2, "tags": [], "bug_id": 40792, "attachment_id": null, "id": 94977, "time": "2006-10-19T07:21:27Z", "creator": "ken@i2rd.com", "creation_time": "2006-10-19T07:21:27Z", "is_private": false, "text": "modjk 1.2.13\n\napache 2.0.55"}, {"count": 3, "tags": [], "bug_id": 40792, "text": "Please update to 1.2.19. There have been a lot of bug fixes since 1.2.13.\nIf the bug can still be observed with 1.2.19 please reopen this ticket and I \nwill investigate.", "id": 94985, "time": "2006-10-19T11:45:50Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2006-10-19T11:45:50Z", "is_private": false, "attachment_id": null}]