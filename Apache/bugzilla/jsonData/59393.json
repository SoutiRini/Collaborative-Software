[{"count": 0, "tags": [], "text": "when set comment for Multiple cell included cell \"A1\", always got a Exception:\njava.lang.IllegalArgumentException: \nMultiple cell comments in one cell are not allowed, cell: A1\n\nif don't set comment for cell \"A1\", Exception will not happen.\n\nif only set comment for cell \"A1\", Exception will not happen.", "attachment_id": null, "id": 190630, "creator": "stone_me_06@163.com", "time": "2016-04-28T16:03:05Z", "bug_id": 59393, "creation_time": "2016-04-28T16:03:05Z", "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 59393, "is_private": false, "id": 190637, "time": "2016-04-28T19:35:24Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2016-04-28T19:35:24Z", "tags": [], "text": "Can you share some of your code, ideally as self-sufficient unit-test that allows others to reproduce the problem? This will make it much easier for other to take a look.\n\nIf you are able we also gladly accept patch-submissions if you can figure out where it fails in Apache POI."}, {"count": 2, "tags": [], "text": "Created attachment 33825\nCode to reappear the bug.", "attachment_id": 33825, "id": 190740, "creator": "stone_me_06@163.com", "time": "2016-05-05T04:33:08Z", "bug_id": 59393, "creation_time": "2016-05-05T04:33:08Z", "is_private": false}, {"count": 3, "tags": [], "text": "(In reply to Dominik Stadler from comment #1)\n> Can you share some of your code, ideally as self-sufficient unit-test that\n> allows others to reproduce the problem? This will make it much easier for\n> other to take a look.\n> \n> If you are able we also gladly accept patch-submissions if you can figure\n> out where it fails in Apache POI.\n\nI made a test cases as (attachment 33825 ) to reproduce the problem.", "is_private": false, "id": 190741, "creator": "stone_me_06@163.com", "time": "2016-05-05T05:11:27Z", "bug_id": 59393, "creation_time": "2016-05-05T05:11:27Z", "attachment_id": null}, {"count": 4, "tags": [], "creator": "onealj@apache.org", "attachment_id": null, "id": 190777, "time": "2016-05-09T03:04:10Z", "bug_id": 59393, "creation_time": "2016-05-09T03:04:10Z", "is_private": false, "text": "This would require some restructuring of the way comments are added to a cell.\n\nRight now the order to add a comment is: [1]\n1. Create an anchor for the comment (that is, the box that displays the comment with a yellow-background).\n2. Create a comment on the sheet drawing patriarch and set the anchor from step 1\n3. Add author and comment string to comment object\n4. Assign the comment to a cell in the sheet (prior to this the comment is parentless).\n\nThe problem occurs in step 2, since in order to create the comment, the comment cell address is needed. The cell address is temporarily set as CellAddress(anchor.getRow1(), anchor.getCol1()) until it's set again by step 4 above. [2]:\n> return XSSFComment(comments, comments.newComment(ref), vmlShape);\n\nThe \"Multiple cell comments in one cell are not allowed\" error that you saw was POI proactively avoiding a corrupt workbook. Though adding a cell comment to the drawing without adding it to a cell also produces a corrupt workbook. Any rewrite will need to address these issues, while considering backwards compatibility, and hopefully make adding a cell comment easier (such as Sheet.addCellComment(CellAddress address, String comment[, String author[, ClientAnchor anchor]])). I'm open to suggestions; patches greatly appreciated.\n\nIn the mean time, to fix your problem, you should make row1 and col1 of the anchor match the address of the cell that will hold the comment before you create the comment:\n\n    anchor.setRow1(0);\n    anchor.setCol1(0);\n    Comment comment1 = drawing.createCellComment(anchor);\n    RichTextString richTextString1 = helper.createRichTextString(\"comment1\");\n    comment1.setString(richTextString1);\n    cell1.setCellComment(comment1);\n\n    anchor.setRow1(0);\n    anchor.setCol1(1);\n    Comment comment2 = drawing.createCellComment(anchor);\n    RichTextString richTextString2 = helper.createRichTextString(\"comment2\");\n    comment2.setString(richTextString2);\n    cell2.setCellComment(comment2);\n\n    anchor.setRow1(0);\n    anchor.setCol1(2);\n    Comment comment3 = drawing.createCellComment(anchor);\n    RichTextString richTextString3 = helper.createRichTextString(\"comment3\");\n    comment3.setString(richTextString3);\n    cell3.setCellComment(comment3);\n\n[1] https://poi.apache.org/spreadsheet/quick-guide.html#CellComments\n[2] https://svn.apache.org/viewvc/poi/trunk/src/ooxml/java/org/apache/poi/xssf/usermodel/XSSFDrawing.java?revision=1731980&view=markup#l302"}, {"count": 5, "tags": [], "bug_id": 59393, "attachment_id": null, "text": "Added disabled unit test in r1742868.", "id": 190778, "time": "2016-05-09T03:49:40Z", "creator": "onealj@apache.org", "creation_time": "2016-05-09T03:49:40Z", "is_private": false}]