[{"count": 0, "tags": [], "text": "I've discovered a problem with formulas spanning multiple sheets, specifically, the sum operation.\n\nI've got a workbook I need to build that contains 35 sheets.  I need to have a sum operation that spans all the sheets.  I tried to use SUM(sheet1:sheet35!A1) syntax, but setCellFormula throws an error with this syntax.  I have confirmed that his syntax is valid for Excel, because I can enter it in manually\n\nI am successfully able to use the SUM(sheet1!A1,sheet2!a1,...) syntax, but this will not work for my problem, because SUM allows a maximum of 30 arguments.  I could compute two sums, and then sum the results as a workaround, but for the number of items I need to calculate, this can get really messy.\n\nIs this syntax [SUM(sheet1:sheet35!A1)] going to be supported in a future build, or is there a workaround to avoid the error being thrown?\n\nThanks,\nThomas Lane", "attachment_id": null, "bug_id": 48703, "id": 134340, "time": "2010-02-08T11:05:36Z", "creator": "thomas.lane.ctr@offutt.af.mil", "creation_time": "2010-02-08T11:05:36Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 48703, "attachment_id": null, "id": 135450, "time": "2010-03-18T22:40:21Z", "creator": "dave.sprague@trintech.com", "creation_time": "2010-03-18T22:40:21Z", "is_private": false, "text": "I've discovered an issue (that appears to be similar to this issue) within an application that we have build (using POI 3.6). I can provide examples as needed, but is this specific issue slated for inclusion within POI 3.7?\n\nThanks,\n\nDave Sprague\nDirector, Product Management\nTrintech"}, {"count": 2, "tags": [], "bug_id": 48703, "text": "I've discovered an issue (that appears to be similar to this issue) within an application that we have build (using POI 3.6). I can provide examples as needed, but is this specific issue slated for inclusion within POI 3.7?\n\nThanks,\n\nDave Sprague\nDirector, Product Management\nTrintech", "id": 135451, "time": "2010-03-18T22:40:39Z", "creator": "dave.sprague@trintech.com", "creation_time": "2010-03-18T22:40:39Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "text": "Trintech is supplying a zip file with examples. Please review file entitled\n23255 Deferred revenue.xls to determine if this issue is related.", "attachment_id": null, "bug_id": 48703, "id": 135691, "time": "2010-03-26T21:14:12Z", "creator": "dave.sprague@trintech.com", "creation_time": "2010-03-26T21:14:12Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 48703, "attachment_id": 25195, "id": 135692, "time": "2010-03-26T21:14:45Z", "creator": "dave.sprague@trintech.com", "creation_time": "2010-03-26T21:14:45Z", "is_private": false, "text": "Created attachment 25195\nTrintech_POI examples.zip"}, {"count": 5, "tags": [], "text": "Anyone look at this?  Seems that the multisheet reference is being parsed as a Ref3DPtg, which is wrong.  Actually, I don't even see a Ptg type that would correspond to this kind of reference with multiple sheets in it.", "attachment_id": null, "bug_id": 48703, "id": 146491, "time": "2011-05-20T20:09:37Z", "creator": "peter.esbensen@thehartford.com", "creation_time": "2011-05-20T20:09:37Z", "is_private": false}, {"count": 6, "tags": [], "text": "Are you able to use BiffViewer to identify what Ptg / Ptgs excel is using to encode this?", "attachment_id": null, "bug_id": 48703, "id": 146493, "time": "2011-05-20T20:14:31Z", "creator": "apache@gagravarr.org", "creation_time": "2011-05-20T20:14:31Z", "is_private": false}, {"count": 7, "tags": [], "text": "It is coming in as 0x3A, which POI maps to Ref3DPtg.  \n\nMicrosoft's documents for PtgRef3d have the following:  \n\"The PtgRef3doperand specifies a reference to a single cell on one or more sheets.\n\nIf the formula containing this structure is part of a revision as specified in the Formulas overview, then there MUST be a RevExtern in the RgbExtra corresponding to this PtgRef3d, which specifies those sheets.\"\n\nhttp://msdn.microsoft.com/en-us/library/dd921344(v=office.12).aspx\n\nIs that the piece that's missing?  Does POI parse those \"RevExtern\" structs?", "attachment_id": null, "bug_id": 48703, "id": 146551, "time": "2011-05-23T17:56:06Z", "creator": "peter.esbensen@thehartford.com", "creation_time": "2011-05-23T17:56:06Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 48703, "attachment_id": null, "id": 146556, "time": "2011-05-23T19:13:08Z", "creator": "apache@gagravarr.org", "creation_time": "2011-05-23T19:13:08Z", "is_private": false, "text": "Any chance someone could upload a very small file produced with Excel that contains a cross-sheet sum? (They current example file is a bit big for unit testing with)"}, {"count": 9, "tags": [], "bug_id": 48703, "text": "(In reply to comment #7)\n> Is that the piece that's missing?  Does POI parse those \"RevExtern\" structs?\n\nI don't think it does yet. The first step would likely be to work up a patch to read these from existing files, then we can look at what'd be needed to write them.", "id": 146557, "time": "2011-05-23T19:15:31Z", "creator": "apache@gagravarr.org", "creation_time": "2011-05-23T19:15:31Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 48703, "text": "Created attachment 27048\nmultiple sheet SUM spanning, made with Excel.  Both SUM syntaxes are shown", "id": 146558, "time": "2011-05-23T19:28:56Z", "creator": "thomas.lane.ctr@offutt.af.mil", "creation_time": "2011-05-23T19:28:56Z", "is_private": false, "attachment_id": 27048}, {"count": 11, "tags": [], "bug_id": 48703, "attachment_id": null, "id": 146565, "time": "2011-05-23T20:04:24Z", "creator": "thomas.lane.ctr@offutt.af.mil", "creation_time": "2011-05-23T20:04:24Z", "is_private": false, "text": "(In reply to comment #8)\n> Any chance someone could upload a very small file produced with Excel that\n> contains a cross-sheet sum? (They current example file is a bit big for unit\n> testing with)\n\nI uploaded a small file for you."}, {"count": 12, "tags": [], "bug_id": 48703, "attachment_id": null, "id": 146566, "time": "2011-05-23T20:25:54Z", "creator": "apache@gagravarr.org", "creation_time": "2011-05-23T20:25:54Z", "is_private": false, "text": "Could you do the file as a .xls too? \n\nFor the .xlsx file, the formula is stored nice and simply, which is good!\n      <c r=\"B2\">\n        <f>SUM(Sheet1:Sheet4!C1)</f>\n        <v>20</v>\n      </c>"}, {"count": 13, "tags": [], "creator": "thomas.themel@mirai-solutions.com", "attachment_id": 27126, "text": "Created attachment 27126\nXLS version of attachment 27048, created with Excel 2010", "id": 146929, "time": "2011-06-07T13:46:38Z", "bug_id": 48703, "creation_time": "2011-06-07T13:46:38Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 48703, "text": "(In reply to comment #13)\n> Created attachment 27126 [details]\n> XLS version of attachment 27048 [details], created with Excel 2010\n\nThis seems to be another XLSX file, we really need a XLS (binary, OLE2) file", "id": 147835, "time": "2011-07-08T15:18:36Z", "creator": "apache@gagravarr.org", "creation_time": "2011-07-08T15:18:36Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "bug_id": 48703, "attachment_id": null, "text": "(In reply to comment #14)\n> (In reply to comment #13)\n> > Created attachment 27126 [details]\n> > XLS version of attachment 27048 [details], created with Excel 2010\n> \n> This seems to be another XLSX file, we really need a XLS (binary, OLE2) file\n\nJust a reminder that we need a .xls (old style binary) test file for this, before we can look into it more", "id": 150090, "time": "2011-10-03T17:30:43Z", "creator": "apache@gagravarr.org", "creation_time": "2011-10-03T17:30:43Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 48703, "text": "*** Bug 51941 has been marked as a duplicate of this bug. ***", "id": 150094, "time": "2011-10-03T18:42:09Z", "creator": "apache@gagravarr.org", "creation_time": "2011-10-03T18:42:09Z", "is_private": false, "attachment_id": null}, {"count": 17, "tags": [], "bug_id": 48703, "text": "Created attachment 27680\n.xls file showing the type of formulas which can't be evaluated\n\nHere is an .xls attachement showing the bug.\nTry to evaluate the formula on sheet1 and you should see the error", "id": 150102, "time": "2011-10-03T20:16:06Z", "creator": "mikkel@westenholz.com", "creation_time": "2011-10-03T20:16:06Z", "is_private": false, "attachment_id": 27680}, {"count": 18, "tags": [], "creator": "apache@gagravarr.org", "attachment_id": null, "text": "Looking at the supplied file, BiffViewer sees it as:\n\n[FORMULA]\n    .row    = 0x0000\n    .col    = 0x0000\n    .xfindex= 0x000F\n  .value         = 4.0\n  .options   = 0x0000\n    .alwaysCalc= false\n    .calcOnLoad= false\n    .shared    = false\n  .zero      = 0xFC002006\n    Ptg[0]=org.apache.poi.ss.formula.ptg.Ref3DPtg [sheetIx=0 ! A1]R\n    Ptg[1]=org.apache.poi.ss.formula.ptg.AttrPtg [sum ].\n[/FORMULA]\n\nIf you fetch the Cell Formula back in POI, you get just: SUM(Sheet2!A1)\n\nSo, it looks like our handling of Ref3DPtg isn't coping with the multiple sheets case. Someone will need to fix that first, then when we can correctly handle the formula string, we can look at the evaluation. Finally, how XSSF formulas are evaluated can be sorted based on this.\n\nI've added disabled unit tests for HSSF and XSSF in r1242807, they should hopefully help someone with working on the issue", "id": 153674, "time": "2012-02-10T15:03:36Z", "bug_id": 48703, "creation_time": "2012-02-10T15:03:36Z", "is_private": false}, {"count": 19, "tags": [], "bug_id": 48703, "text": "After debugging this issues - the fix for the old binary format is not that hard. The InternalWorkbook already contains these external references and they are already created during leading. So the fix becomes the following:\n\n1. Handle the parsing of the formula format (now it think it is a named range)\n2. Correctly use the external indices (now it just uses the first sheet index)\n3. Iterate over in the evaluation routine (now it only does over a single sheet).\n4. Fix for creating new formulae that span multiple sheets.\n\nUnfortunately, this does not work with the ooxml as there are no such external indices (points 2/4 and 3 as a result of the missing indices).\n\nSo far I have a produced almost working fix for the binary files but not for the ooxml files. However, I am asking if anyone has any insights how to solve this for the ooxml files format.", "id": 164138, "time": "2012-12-18T19:58:36Z", "creator": "rado.georgiev@ontario.ca", "creation_time": "2012-12-18T19:58:36Z", "is_private": false, "attachment_id": null}, {"count": 20, "tags": [], "creator": "yegor@dinom.ru", "attachment_id": null, "text": "> \n> So far I have a produced almost working fix for the binary files but not for\n> the ooxml files. However, I am asking if anyone has any insights how to\n> solve this for the ooxml files format.\n\nIf you already implemented (4) and can create formulas spannig across multiple sheets then the OOXML part is almost done .  The only thing you need to to parse the formula string into Ptg[] and then re-use functionality from HSSF. \n\nI will be happy to help  with this task. Please go ahead and submit a patch for the binary format and I will try to figure out what to do with ooxml.  \n\nYegor", "id": 164161, "time": "2012-12-20T07:31:08Z", "bug_id": 48703, "creation_time": "2012-12-20T07:31:08Z", "is_private": false}, {"count": 21, "tags": [], "creator": "rado.georgiev@ontario.ca", "attachment_id": null, "text": "I have added a patch to fix this for the HSSF formulae (not XSSF). If I anyone wants to look into it they are welcome to.\n\nBug 55906", "id": 171821, "time": "2013-12-18T20:27:52Z", "bug_id": 48703, "creation_time": "2013-12-18T20:27:52Z", "is_private": false}, {"count": 22, "tags": [], "bug_id": 48703, "text": "As of r1613654 this is now supported, for both HSSF and XSSF.", "id": 176695, "time": "2014-07-26T15:31:22Z", "creator": "apache@gagravarr.org", "creation_time": "2014-07-26T15:31:22Z", "is_private": false, "attachment_id": null}, {"count": 23, "tags": [], "creator": "onealj@apache.org", "attachment_id": null, "text": "I removed the @Ignore decoration from these tests in r1765544 so that this stays fixed.", "id": 194538, "time": "2016-10-19T07:39:52Z", "bug_id": 48703, "creation_time": "2016-10-19T07:39:52Z", "is_private": false}]