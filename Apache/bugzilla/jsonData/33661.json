[{"count": 0, "tags": [], "bug_id": 33661, "text": "Dunno when this bug was introduced, but I think it has sth. do woth link\nrewriting and assets.\n\nThis is caused by a wrong rewritten URL on doc load.\n\nLooking at the @src of images inserted with bxe for a given page X and an image\nz.jpg:\n\n<img src=\"X/z.jpg\"/>\n\nKupu atm inserts @src :\n\n<img src=\"/CONTEXT_PREFIX/PUB/AREA/....\">\n\nI tried to change the kupu usecase using the same url scheme as bxe, but it\nlately fails when using the pub library feature in kupu.\n\nI need some help to fix it.", "id": 71277, "time": "2005-02-20T15:36:30Z", "creator": "roku@apache.org", "creation_time": "2005-02-20T15:36:30Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 33661, "text": "Ok, I fixed it for the page image library locally.\nTo fix it for the pub lib we need to tweak content2edit.xsl in kupu.\nMaybe I can handle it....", "id": 71278, "time": "2005-02-20T15:41:36Z", "creator": "roku@apache.org", "creation_time": "2005-02-20T15:41:36Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 33661, "attachment_id": null, "id": 71279, "time": "2005-02-20T15:44:15Z", "creator": "roku@apache.org", "creation_time": "2005-02-20T15:44:15Z", "is_private": false, "text": "sorry it is not contant2edit.xsl but kupusave.xsl"}, {"count": 3, "tags": [], "bug_id": 33661, "text": "Ok, I think I fixed it. Should I check it in?\nAbout 6 files (xslts and xmap) files are affected. I also would need to check in\nsome kupu stuff.\n\nWDYT? Otherwise we can insert images into kupu.....", "id": 71280, "time": "2005-02-20T16:24:17Z", "creator": "roku@apache.org", "creation_time": "2005-02-20T16:24:17Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "roku@apache.org", "text": "Ok, ich check it in, since I made the tag anymway. We can still decide if I\nshould re-tag", "id": 71281, "time": "2005-02-20T16:25:02Z", "bug_id": 33661, "creation_time": "2005-02-20T16:25:02Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "roku@apache.org", "is_private": false, "count": 5, "id": 71283, "time": "2005-02-20T18:09:14Z", "bug_id": 33661, "creation_time": "2005-02-20T18:09:14Z", "text": "fixed"}, {"count": 6, "tags": [], "creator": "mamuxx@gmail.com", "attachment_id": null, "text": "It still hapens on second level of documents. I mean, try to insert an image\npreviously uploaded to page on for example\nhttp://olr.kbs.uni-hannover.de:8888/default/authoring/tutorial/new_doctype.html\nIf you save the document the image dissapear.\n", "id": 71382, "time": "2005-02-23T10:16:29Z", "bug_id": 33661, "creation_time": "2005-02-23T10:16:29Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 33661, "attachment_id": null, "text": "The remaining problem seems to be that in the original document (index_xx.xml)\nin the data attribute of the <object> tag the document path is inserted, though\nit shouldn't if I get it right.\n\nIf an image is inserted into a subpage, the tag will be\n\n<object data=\"subpage/picture.gif\" ...>\n\nwhile it should be just \n\n<object data=\"picture.gif\" ...>\n\nWhen this is rendered into an <img> tag then it needs to be prefixed, i.e. it\nshould be\n\n<img src=\"subpage/picture.gif\">\n", "id": 71460, "time": "2005-02-24T15:31:34Z", "creator": "tschlabach@apache.org", "creation_time": "2005-02-24T15:31:34Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 33661, "text": "(In reply to comment #7)\n> The remaining problem seems to be that in the original document (index_xx.xml)\n> in the data attribute of the <object> tag the document path is inserted, though\n> it shouldn't if I get it right.\n\ncorrect. lenya currently does not handle the \"insert assets from another page\"\ncase well.", "id": 71500, "time": "2005-02-24T23:44:55Z", "creator": "gregor@apache.org", "creation_time": "2005-02-24T23:44:55Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "mamuxx@gmail.com", "is_private": false, "count": 9, "id": 71642, "time": "2005-02-28T22:28:30Z", "bug_id": 33661, "creation_time": "2005-02-28T22:28:30Z", "text": "I think have fixed it with this two patches:\n\nIndex: usecase-kupu.xmap\n===================================================================\n--- usecase-kupu.xmap   (revision 155679)\n+++ usecase-kupu.xmap   (working copy)\n@@ -189,6 +189,7 @@\n           <map:transform\nsrc=\"{fallback:resources/kupu/apache-lenya/lenya/pageassets2kupulibrary.xsl}\">\n             <map:parameter name=\"iconUrl\"\nvalue=\"{page-envelope:context-prefix}/{global:resourceIconUrl}\"/>\n             <map:parameter name=\"resource-path-url\"\nvalue=\"{page-envelope:document-id}/\"/>\n+            <map:parameter name=\"nodeid\" value=\"{page-envelope:document-node-id}\"/>\n           </map:transform>\n           <map:serialize type=\"xml\"/>\n         </map:match>\n\n\n\nIndex: pageassets2kupulibrary.xsl\n===================================================================\n--- pageassets2kupulibrary.xsl  (revision 9371)\n+++ pageassets2kupulibrary.xsl  (working copy)\n@@ -15,6 +15,7 @@\n\n <xsl:param name=\"iconUrl\"/>\n <xsl:param name=\"resource-path-url\"/>\n+<xsl:param name=\"nodeid\"/>\n\n <xsl:template match=\"/\">\n   <collection>\n@@ -31,7 +32,7 @@\n <xsl:template match=\"li:asset\">\n   <xsl:if test=\"(contains(dc:source, '.jpg') or contains(dc:source, '.gif') or\ncontains(dc:source, '.png') or contains(dc:source, '.swf'))\">\n     <xsl:variable name=\"resource-url\">\n-      <xsl:value-of select=\"concat(substring-after($resource-path-url, '/'),\ndc:source)\"/>\n+      <xsl:value-of select=\"concat(concat($nodeid, '/'), dc:source)\"/>\n     </xsl:variable>\n\n     <resource id=\"{$resource-url}\">\n\ni expect it was useful"}, {"count": 10, "tags": [], "bug_id": 33661, "attachment_id": null, "id": 71644, "time": "2005-02-28T22:54:51Z", "creator": "mamuxx@gmail.com", "creation_time": "2005-02-28T22:54:51Z", "is_private": false, "text": "excuse my mistake (it's my first patch...), i forget removing useless\nresource-path-url param\n\nIndex: usecase-kupu.xmap\n===================================================================\n--- usecase-kupu.xmap   (revision 155696)\n+++ usecase-kupu.xmap   (working copy)\n@@ -188,7 +188,7 @@\n           <map:generate src=\"{fallback:content/info/assets.xsp}\"\ntype=\"serverpages\"/>\n           <map:transform\nsrc=\"{fallback:resources/kupu/apache-lenya/lenya/pageassets2kupulibrary.xsl}\">\n             <map:parameter name=\"iconUrl\"\nvalue=\"{page-envelope:context-prefix}/{global:resourceIconUrl}\"/>\n-            <map:parameter name=\"resource-path-url\"\nvalue=\"{page-envelope:document-id}/\"/>\n+            <map:parameter name=\"nodeid\" value=\"{page-envelope:document-node-id}\"/>\n           </map:transform>\n           <map:serialize type=\"xml\"/>\n         </map:match>\n\nIndex: pageassets2kupulibrary.xsl\n===================================================================\n--- pageassets2kupulibrary.xsl  (revision 9532)\n+++ pageassets2kupulibrary.xsl  (working copy)\n@@ -14,7 +14,7 @@\n  >\n\n <xsl:param name=\"iconUrl\"/>\n-<xsl:param name=\"resource-path-url\"/>\n+<xsl:param name=\"nodeid\"/>\n\n <xsl:template match=\"/\">\n   <collection>\n@@ -31,7 +31,7 @@\n <xsl:template match=\"li:asset\">\n   <xsl:if test=\"(contains(dc:source, '.jpg') or contains(dc:source, '.gif') or\ncontains(dc:source, '.png') or contains(dc:source, '.swf'))\">\n     <xsl:variable name=\"resource-url\">\n-      <xsl:value-of select=\"concat(substring-after($resource-path-url, '/'),\ndc:source)\"/>\n+      <xsl:value-of select=\"concat(concat($nodeid, '/'), dc:source)\"/>\n     </xsl:variable>\n\n     <resource id=\"{$resource-url}\">\n"}, {"count": 11, "tags": [], "bug_id": 33661, "attachment_id": null, "id": 71662, "time": "2005-03-01T12:44:43Z", "creator": "tschlabach@apache.org", "creation_time": "2005-03-01T12:44:43Z", "is_private": false, "text": "(In reply to comment #10)\n> excuse my mistake (it's my first patch...), i forget removing useless\n> resource-path-url param\n\nNever mind. Thank you for helping out with this. I had this on my agenda and it\nwould have taken me a long time to figure out where I would need to change this.\nAs you can see from my comment above, I was on the wrong track. I thought there\nmust be no nodeid/picture.gif in both cases in the first place.\n\nI have successfully applied and tested your patch, so it would be ready to being\ncommitted. I just have one little problem left, then I will commit it.\nUnfortunately it did not make it for 1.2.2 which was released yesterday.\n"}, {"count": 12, "tags": [], "creator": "tschlabach@apache.org", "text": "(In reply to comment #10)\n> excuse my mistake (it's my first patch...), i forget removing useless\n> resource-path-url param\n\nThe patch is applied to 1.2.3-dev in SVN.\n\nAs Lenya integration in 1.4 is broken anyway and the patch did not really fit\n(the usecase look different) I did not touch 1.4 but will investigate this\nfurther. I will open a new bug for that and close this one as 1.2.3-dev works\nfine now.\n\nOne last thing to Miguel: You'd make our life a bit easier of you upload a patch\nas an attachment to the bug rather than pasting it into a comment. If you paste\nit into a comment we need to get it from there via cut & paste which sometimes\nleads to problems applying the patch. On some platform for example, cut and\npaste from a brower to an editor messes with spaces and tabs.\n", "id": 71669, "time": "2005-03-01T18:33:44Z", "bug_id": 33661, "creation_time": "2005-03-01T18:33:44Z", "is_private": false, "attachment_id": null}]