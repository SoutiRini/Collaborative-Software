[{"count": 0, "attachment_id": null, "creator": "mercuron@gmx.ch", "text": "If an Image in org/apache/xmlgraphics/image/loader/cache/ImageCache.java expires a ConcurrentModificationException will be thrown.\n\nThe cause is method \"private void doInvalidURIHouseKeeping()\" which loops over the Map \"this.invalidURIs\" and then tries to remove an element from this map in method \"private boolean removeInvalidURIIfExpired(String uri, long timestamp)\".\n\n\nTo reproduce the error you can add the following method to ImageCacheTestCase.\n\n    public void testImageCacheHouseKeeping() {\n        ImageCache imageCache = new ImageCache(new TimeStampProvider(), new DefaultExpirationPolicy(1));\n        imageCache.registerInvalidURI(\"invalid\");\n        imageCache.registerInvalidURI(\"invalid2\");\n        try {\n            Thread.sleep(1200);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        imageCache.doHouseKeeping();\n    }\n\nStacktrace:\nCaused by: java.util.ConcurrentModificationException\n\tat java.util.HashMap$HashIterator.nextEntry(HashMap.java:793)\n\tat java.util.HashMap$EntryIterator.next(HashMap.java:834)\n\tat java.util.HashMap$EntryIterator.next(HashMap.java:832)\n\tat org.apache.xmlgraphics.image.loader.cache.ImageCache.doInvalidURIHouseKeeping(ImageCache.java:294)\n\tat org.apache.xmlgraphics.image.loader.cache.ImageCache.doHouseKeeping(ImageCache.java:287)\n\tat org.apache.xmlgraphics.image.loader.cache.ImageCache.considerHouseKeeping(ImageCache.java:277)\n\tat org.apache.xmlgraphics.image.loader.cache.ImageCache.registerInvalidURI(ImageCache.java:206)\n\tat org.apache.xmlgraphics.image.loader.cache.ImageCache.needImageInfo(ImageCache.java:129)\n\tat org.apache.xmlgraphics.image.loader.ImageManager.getImageInfo(ImageManager.java:112)\n\tat org.apache.fop.fo.flow.ExternalGraphic.bind(ExternalGraphic.java:81)\n\tat org.apache.fop.fo.FObj.processNode(FObj.java:123)\n\tat org.apache.fop.fo.FOTreeBuilder$MainFOHandler.startElement(FOTreeBuilder.java:282)\n\tat org.apache.fop.fo.FOTreeBuilder.startElement(FOTreeBuilder.java:171)\n\tat org.apache.xalan.transformer.TransformerIdentityImpl.startElement(TransformerIdentityImpl.java:1072)\n\tat org.apache.xerces.parsers.AbstractSAXParser.startElement(Unknown Source)\n\tat org.apache.xerces.parsers.AbstractXMLDocumentParser.emptyElement(Unknown Source)\n\tat org.apache.xerces.xinclude.XIncludeHandler.emptyElement(Unknown Source)\n\tat org.apache.xerces.impl.XMLNSDocumentScannerImpl.scanStartElement(Unknown Source)\n\tat org.apache.xerces.impl.XMLDocumentFragmentScannerImpl$FragmentContentDispatcher.dispatch(Unknown Source)\n\tat org.apache.xerces.impl.XMLDocumentFragmentScannerImpl.scanDocument(Unknown Source)\n\tat org.apache.xerces.parsers.XML11Configuration.parse(Unknown Source)\n\tat org.apache.xerces.parsers.XML11Configuration.parse(Unknown Source)\n\tat org.apache.xerces.parsers.XMLParser.parse(Unknown Source)\n\tat org.apache.xerces.parsers.AbstractSAXParser.parse(Unknown Source)\n\tat org.apache.xerces.jaxp.SAXParserImpl$JAXPSAXParser.parse(Unknown Source)\n\tat org.apache.xalan.transformer.TransformerIdentityImpl.transform(TransformerIdentityImpl.java:484)", "id": 130508, "time": "2009-09-18T03:31:12Z", "bug_id": 47868, "creation_time": "2009-09-18T03:31:12Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "text": "http://svn.apache.org/viewvc?rev=816640&view=rev\n\nFixed. Thanks for the report and the testcase!", "is_private": false, "bug_id": 47868, "id": 130515, "time": "2009-09-18T07:16:55Z", "creator": "max@berger.name", "creation_time": "2009-09-18T07:16:55Z", "attachment_id": null}]