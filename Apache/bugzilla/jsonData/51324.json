[{"count": 0, "tags": [], "bug_id": 51324, "attachment_id": 27114, "text": "Created attachment 27114\nThe line that causes doFlush to be stuck at true if it gets an exception\n\nFirst time opening a bug, please forgive me if this report isn't perfect!\n\nI recently ran into an issue where OutputBuffer's doFlush gets stuck to true.\n\nIn OutputBuffer.doFlush(boolean) it sets doFlush = true, then calls bb.flushBuffer, then sets doFlush = false.\n\nI issue I ran into was bb.flushBuffer eventually calls OutputBuffer.realWriteBytes.  The realWriteBytes eventually calls coyoteResponse.doWrite.  If coyoteResponse.doWrite throws an IOException, then it rethrows a ClientAbortException.\n\nWhat I am seeing is my client disconnecting early, and causing the doWrite to throw a SocketException of \"Broken pipe\".  That broken pipe causes a ClientAbortException to be thrown. \n\nWhen that is thrown, the error is bubbled up and doFlush is stuck as \"true\".  The next time the processor is used, it calls the recycle() method in OutputBuffer. However, the recycle doesn't reset doFlush so its still set to true.\n\nI imagine there are quite a few ways to fix this, but the two obvious ones that come to mind are:\n\n- Have recycle() set doFlush back to false\n\nor \n\n- Have throw a finally in try/catch/finally in OutputBuffer.doFlush so doFlush is set back to false when an Exception is catch", "id": 146872, "time": "2011-06-05T05:17:12Z", "creator": "bow.ruggeri@service-now.com", "creation_time": "2011-06-05T05:17:12Z", "is_private": false}, {"count": 1, "tags": [], "text": "Created attachment 27122\nPatch", "attachment_id": 27122, "id": 146911, "creator": "jnorris10@gmail.com", "time": "2011-06-07T06:12:53Z", "bug_id": 51324, "creation_time": "2011-06-07T06:12:53Z", "is_private": false}, {"count": 2, "attachment_id": null, "creator": "jnorris10@gmail.com", "text": "I'm also experiencing this problem.  Attached is a patch implementing both of Bow's suggestions.", "id": 146912, "time": "2011-06-07T06:14:27Z", "bug_id": 51324, "creation_time": "2011-06-07T06:14:27Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 51324, "attachment_id": null, "text": "Thanks for the patch. This has been fixed in 7.0.x and will be included in 7.0.16 onwards.", "id": 146930, "time": "2011-06-07T14:00:47Z", "creator": "markt@apache.org", "creation_time": "2011-06-07T14:00:47Z", "is_private": false}, {"count": 4, "tags": [], "text": "Proposed for backport to 6.0 and 5.5.", "attachment_id": null, "id": 147738, "creator": "knst.kolinko@gmail.com", "time": "2011-07-05T08:59:07Z", "bug_id": 51324, "creation_time": "2011-07-05T08:59:07Z", "is_private": false}, {"count": 5, "tags": [], "text": "Fixed in 6.0.x and included in 6.0.33 onwards", "is_private": false, "id": 148067, "creator": "markt@apache.org", "time": "2011-07-21T16:29:04Z", "bug_id": 51324, "creation_time": "2011-07-21T16:29:04Z", "attachment_id": null}]