[{"count": 0, "tags": [], "text": "Libraries compatible with Java 8 or older may also contain module-info.class compiled for Java 9. Tomcat logs the following message for such libraries:\n\nSEVERE: Unable to process Jar entry [module-info.class] from Jar [file:...../javax.json-1.1.0-M1.jar] for annotations\norg.apache.tomcat.util.bcel.classfile.ClassFormatException: Invalid byte tag in constant pool: 19\nat org.apache.tomcat.util.bcel.classfile.Constant.readConstant(Constant.java:97)\nat org.apache.tomcat.util.bcel.classfile.ConstantPool.<init>(ConstantPool.java:54)\nat org.apache.tomcat.util.bcel.classfile.ClassParser.readConstantPool(ClassParser.java:174)\nat org.apache.tomcat.util.bcel.classfile.ClassParser.parse(ClassParser.java:83)\nat org.apache.catalina.startup.ContextConfig.processAnnotationsStream(ContextConfig.java:2053)\nat org.apache.catalina.startup.ContextConfig.processAnnotationsJar(ContextConfig.java:2000)\nat org.apache.catalina.startup.ContextConfig.processAnnotationsUrl(ContextConfig.java:1970)\nat org.apache.catalina.startup.ContextConfig.processAnnotations(ContextConfig.java:1923)\nat org.apache.catalina.startup.ContextConfig.webConfig(ContextConfig.java:1163)\nat org.apache.catalina.startup.ContextConfig.configureStart(ContextConfig.java:775)\nat org.apache.catalina.startup.ContextConfig.lifecycleEvent(ContextConfig.java:299)\nat org.apache.catalina.util.LifecycleBase.fireLifecycleEvent(LifecycleBase.java:94)\nat org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:5087)\nat org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:150)\nat org.apache.catalina.core.ContainerBase$StartChild.call(ContainerBase.java:1419)\nat org.apache.catalina.core.ContainerBase$StartChild.call(ContainerBase.java:1409)\nat java.util.concurrent.FutureTask.run(FutureTask.java:266)\nat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\nat java.lang.Thread.run(Thread.java:745)", "is_private": false, "id": 196695, "creator": "katzyn@gmail.com", "time": "2017-02-04T08:08:13Z", "bug_id": 60688, "creation_time": "2017-02-04T08:08:13Z", "attachment_id": null}, {"count": 1, "text": "It is not that \"Tomcat should skip or ..\". It is that the underlying byte code parsing library (Apache Commons BCEL) does not know what is the meaning of entries with code \"19\" in a constant pool.\n\nIt knows what \"18\" means (CONSTANT_InvokeDynamic), bot not about \"19\".\n\nhttp://svn.apache.org/viewvc/commons/proper/bcel/tags/BCEL_6_0/src/main/java/org/apache/bcel/classfile/Constant.java?view=markup#l127\n\nhttp://svn.apache.org/viewvc/commons/proper/bcel/tags/BCEL_6_0/src/main/java/org/apache/bcel/Const.java?view=markup#l280\n\n\nThis needs\n- a reference to a class file format specification (JVM specification) for the actual meaning of that code and\n\nI expect the specs to be published here, but there is none for Java 9 yet:\nhttp://docs.oracle.com/javase/specs/\n\n- a bug report against BCEL library.\n\nhttp://commons.apache.org/proper/commons-bcel/", "bug_id": 60688, "attachment_id": null, "id": 196696, "time": "2017-02-04T10:57:52Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2017-02-04T10:57:52Z", "tags": [], "is_private": false}, {"count": 2, "attachment_id": null, "bug_id": 60688, "is_private": false, "id": 196697, "time": "2017-02-04T11:05:06Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2017-02-04T11:05:06Z", "tags": [], "text": "> \n> This needs\n> - a reference to a class file format specification (JVM specification) for\n> the actual meaning of that code and\n> \n> I expect the specs to be published here, but there is none for Java 9 yet:\n> http://docs.oracle.com/javase/specs/\n> \n> - a bug report against BCEL library.\n> \n> http://commons.apache.org/proper/commons-bcel/\n\n\nAlthough Tomcat code can be updated independently of BCEL, we must know what the code \"19\" means and thus how many bytes to skip (for the simple case if it can be ignored).\n\nhttp://svn.apache.org/viewvc/tomcat/trunk/java/org/apache/tomcat/util/bcel/classfile/Constant.java?revision=1757132&view=markup#l59"}, {"attachment_id": null, "tags": [], "creator": "katzyn@gmail.com", "is_private": false, "count": 3, "id": 196699, "time": "2017-02-04T12:20:22Z", "bug_id": 60688, "creation_time": "2017-02-04T12:20:22Z", "text": "19 is CONSTANT_Module and 20 is CONSTANT_Package.\n\nI don't see a reason to scan module-info for annotations at all. @WebServlet, @WebFilter, or @WebListener is not expected here anyway."}, {"count": 4, "text": "This comes under general Java 9 support.\n\nAt the moment Java 9 support is a moving target so it is only being implemented in trunk (9.0.x). Once Java 9 stabilises, expect to see support back-ported to the other Tomcat versions.\n\nThe proposal for these new constants is here:\nhttp://cr.openjdk.java.net/~mr/jigsaw/spec/lang-vm.html\n\nLooks like we just need to skip 2 bytes. The change needs to be implemented in Commons BCEL first and then back-ported to Tomcat.", "bug_id": 60688, "attachment_id": null, "id": 196765, "time": "2017-02-06T15:20:23Z", "creator": "markt@apache.org", "creation_time": "2017-02-06T15:20:23Z", "tags": [], "is_private": false}, {"count": 5, "tags": [], "creator": "markt@apache.org", "is_private": false, "id": 196975, "attachment_id": null, "bug_id": 60688, "creation_time": "2017-02-13T20:50:21Z", "time": "2017-02-13T20:50:21Z", "text": "BCEL updated and back-port complete.\n\nFixed in:\n- trunk for 9.0.0.M18 onwards\n- 8.5.x for 8.5.12 onwards\n- 8.0.x for 8.0.42 onwards\n- 7.0.x for 7.0.76 onwards"}]