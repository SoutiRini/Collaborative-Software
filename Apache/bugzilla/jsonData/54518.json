[{"count": 0, "tags": [], "bug_id": 54518, "attachment_id": null, "text": "mod_rewrite is supposed to append to the Vary HTTP response header any HTTP request headers used in RewriteCond statements.\n\nThis doesn't seem to work.\n\nRelevant conf:\n\n<Directory ${docroot}/js>\n  ExpiresActive On\n  ExpiresDefault \"access plus 30 minutes\"\n\n  SetEnvIf Via AkamaiGHost VIA_AKAMAI_EDGE # ch.8 of Edge Server Config Guide\n# Only set Edge-Control if via Akamai Edge server, so as to\n# not increase size of response to non-Akamai clients\n  Header set Edge-Control max-age=1800 env=VIA_AKAMAI_EDGE\n\n  FileETag MTime Size\n\n  RewriteEngine On\n  RewriteCond %{HTTP:Accept-Encoding} (^|,)\\s*(x-)?gzip(?!\\s*;\\s*qs\\s*=\\s*0([.]0{0,3})?(\\s|,|$))\n  RewriteRule (.*)[.]js$ $1.js.gz\n</Directory>\n\nAnd the response headers I get back:\n\nHTTP/1.1 200 OK\nDate: Fri, 01 Feb 2013 21:41:30 GMT\nServer: Apache/2.4.3\nLast-Modified: Wed, 09 Jan 2013 16:57:50 GMT\nETag: \"1a27-4d2ddf660ff80\"\nAccept-Ranges: bytes\nContent-Length: 6695\nCache-Control: max-age=1800\nExpires: Fri, 01 Feb 2013 22:11:30 GMT\nP3P: CP=\"CAO DSP COR CURa ADMa DEVa PSAa PSDa IVAi IVDi CONi OUR OTRi IND PHY ONL UNI FIN COM NAV INT DEM STA\"\nContent-Type: application/javascript\nContent-Encoding: application/gzip\n\n\nI have a workaround of adding these two lines to the Directory section:\n\nSetEnvIf Accept-Encoding (^|,)\\s*(x-)?gzip(?!\\s*;\\s*qs\\s*=\\s*0([.]0{0,3})?(\\s|,|$)) VARY_ACCEPT_ENCODING\nHeader append Vary Accept-Encoding env=VARY_ACCEPT_ENCODING\n\nThen I get back:\n\nHTTP/1.1 200 OK\nDate: Fri, 01 Feb 2013 21:42:53 GMT\nServer: Apache/2.4.3\nLast-Modified: Wed, 09 Jan 2013 16:57:50 GMT\nETag: \"1a27-4d2ddf660ff80\"\nAccept-Ranges: bytes\nContent-Length: 6695\nCache-Control: max-age=1800\nExpires: Fri, 01 Feb 2013 22:12:53 GMT\nVary: Accept-Encoding\nP3P: CP=\"CAO DSP COR CURa ADMa DEVa PSAa PSDa IVAi IVDi CONi OUR OTRi IND PHY ONL UNI FIN COM NAV INT DEM STA\"\nContent-Type: application/javascript\nContent-Encoding: application/gzip\n\nBut adding these extra two lines of config should not be necessary, because mod_rewrite is supposed to do it. I see the code in the module (high-level part pasted below), but it doesn't seem to be doing it.\n\n        ctx->vary = NULL;\n        rc = apply_rewrite_rule(p, ctx);\n\n        if (rc) {\n            /* Regardless of what we do next, we've found a match. Check to see\n             * if any of the request header fields were involved, and add them\n             * to the Vary field of the response.\n             */\n            if (ctx->vary) {\n                apr_table_merge(r->headers_out, \"Vary\", ctx->vary);\n            }\n\nThe rewrite rule itself is working; the response has the content-encoded application/gzip file of 6695 bytes.  When I do a request with no Accept-Encoding: gzip header, I get the uncompressed file and response:\n\nHTTP/1.1 200 OK\nDate: Fri, 01 Feb 2013 21:41:06 GMT\nServer: Apache/2.4.3\nLast-Modified: Wed, 09 Jan 2013 16:57:48 GMT\nETag: \"523d-4d2ddf6427b00\"\nAccept-Ranges: bytes\nContent-Length: 21053\nCache-Control: max-age=1800\nExpires: Fri, 01 Feb 2013 22:11:06 GMT\nP3P: CP=\"CAO DSP COR CURa ADMa DEVa PSAa PSDa IVAi IVDi CONi OUR OTRi IND PHY ONL UNI FIN COM NAV INT DEM STA\"\nContent-Type: application/javascript\n\nIt's just the adding of the Vary header which is not working in the mod_rewrite module.", "id": 164996, "time": "2013-02-01T22:09:12Z", "creator": "daniel.lescohier@cnet.com", "creation_time": "2013-02-01T22:09:12Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 54518, "attachment_id": null, "text": "In directory context, action flags AND a substitution together don't work because it is not carried forward for the \"internal redirect\" used to change the URL.\n\nOutput headers specifically are not preserved across an \"internal redirect\".\n\nYour best bet is configuring this outside of <Directory> context.", "id": 164997, "time": "2013-02-01T22:53:02Z", "creator": "covener@gmail.com", "creation_time": "2013-02-01T22:53:02Z", "is_private": false}, {"count": 2, "attachment_id": null, "creator": "daniel.lescohier@cnet.com", "is_private": false, "id": 165060, "time": "2013-02-04T20:37:00Z", "bug_id": 54518, "creation_time": "2013-02-04T20:37:00Z", "tags": [], "text": "I moved all my RewriteRules (and RewriteConds) out of Directory context, and edited them for the server context, and it now works.\n\nI see now that Directory context runs in a totally different phase of request processing; the fixup phase instead of the uri2name phase, and that the fixup phase processing does an ap_internal_redirect if you rewrite the url, and therefore the request parsing phase is done over again in the subrequest, and from what you said, response headers are reset for the subrequest.\n\nI would guess that this would mean that in Directory context, not only setting the Vary header from RewriteCond's %{HTTP:header} processing wouldn't work, but probably also the cookie|CO flag and perhaps the type|T flag would not work.\n\nI think it'd be a good idea to add documentation about this to:\n\n 1. RewriteCond's %{HTTP:header} documentation.\n 2. RewriteRule's \"Per-directory Rewrites\" documentation.\n 3. RewriteRule's flags documentation for each flag that won't work in Directory context."}]