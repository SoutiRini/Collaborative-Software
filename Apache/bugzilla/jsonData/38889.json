[{"count": 0, "tags": [], "creator": "srevilak@speakeasy.net", "attachment_id": null, "is_private": false, "id": 86582, "time": "2006-03-07T21:48:53Z", "bug_id": 38889, "creation_time": "2006-03-07T21:48:53Z", "text": "I've been trying out the new version of mod_jk (1.2.15) \n\nI've been working on upgrading our mod_jk from 1.2.9 to 1.2.15.  (We\nuse mod_jk primarily on Linux, in conjunction with apache 2.0.53 and\ntomcat 5.5.15).\n\nDuring testing, I noticed several cases of JkMount mappings going to\nthe wrong set of workers.  By `wrong', I mean `not the same workers as\n1.2.9 would have chosen'; this behavior is reproducible with both the\napache 1.3 and 2.0 versions of mod_jk\n\nHere is an example:\n\n  Given JkMount directives:\n\n  JkMount /k/*     worker_k\n  JkMount /s/*     worker_s\n  JkMount /m/*     worker_m\n  JkMount /h/*     worker_h\n  JkMount /*.jsp   worker_default\n\nThese mount points effectively represent 5 different applications\nunder a single VirtualHost; and they're handled by 5 different groups\nof tomcats.\n\n\nI'll make a request for the uri \"/this-uri-wont-match\". Here is the\nportion of JkLogFile that attempts matching:\n\n\n  [Tue Mar 07 16:20:40 2006] [16809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (449): \nAttempting to map URI '/this-uri-wont-match' from 5 maps\n  [Tue Mar 07 16:20:40 2006] [16809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (461): \nAttempting to map context URI '/*.jsp'\n  [Tue Mar 07 16:20:40 2006] [16809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (461): \nAttempting to map context URI '/k/*'\n  [Tue Mar 07 16:20:40 2006] [16809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (461): \nAttempting to map context URI '/s/*'\n  [Tue Mar 07 16:20:40 2006] [16809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (461): \nAttempting to map context URI '/m/*'\n  [Tue Mar 07 16:20:40 2006] [16809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (461): \nAttempting to map context URI '/h/*'\n\n\nI see that the code is attempting a `longest-pattern-first' match.\nHowever, the side effect of this is uri's like\n\n  /m/some.jsp\n  /h/some-other.jsp\n  /s/yet-another.jsp\n      ....\n\nbecome unreachable.  Because mod_jk 1.2.15 uses pattern length, and\nnot *configuration file* order, there are circumstances where it will\nnever match the desired servlet container.\n\n\nCommenting out the call to worker_qsort() (line 297 of\njk_uri_worker_map.c -- diff attached) makes the issue go away.\n\n\nWould it be possible to go back to matching based on configuration\nfile order?"}, {"count": 1, "tags": [], "bug_id": 38889, "attachment_id": 17844, "is_private": false, "id": 86583, "time": "2006-03-07T21:50:31Z", "creator": "srevilak@speakeasy.net", "creation_time": "2006-03-07T21:50:31Z", "text": "Created attachment 17844\nPatch to jk_uri_worker_map.c"}, {"attachment_id": null, "tags": [], "bug_id": 38889, "is_private": false, "count": 2, "id": 86606, "time": "2006-03-08T16:47:42Z", "creator": "srevilak@speakeasy.net", "creation_time": "2006-03-08T16:47:42Z", "text": "I see what mod_jk is doing in attempting to match the longest uri\npattern first.  The Servlet specification 2.4 (section SRV.11.1) says\n\n   The container will recursively try tomatch the longest\n   path-prefix. This is done by stepping down the path tree a\n   directory at a time, using the / character as a path\n   separator. The longest match determines the servlet selected.\n\nThis definitely favors a longest match.  However, I think it also\nimplies that 'longest' means 'most uri path elements'.  I'd like to\nsubmit a patch that brings mod_jk closer to this behavior.\n\nI'll attach the patch to this issue.  Below are some JkLogFile\nexamples to demonstrate what the patch does.\n\n\t\t\t\t* * *\n\n\nFor what follows, I've set up an apache configuration with this list\nof workers defined:\n\n\n  JkMount /*.jsp                  worker_default\n  JkMount /a/*                    worker_a\n  JkMount /a/1/*                  worker_a1\n  JkMount /a/1/2/*                worker_a12\n  JkMount /golly-gee-batman/*     worker_golly\n\n\nThis is the order in which the JkMount directives appear in the httpd\nconfiguration -- the goal is to verify that `most path elements' gets\npreference.  The first two samples of log output show a stock mod_jk\n1.2.15; subsequent examples show a patched mod_jk 1.2.15.\n\n\n\t\t\t\t* * *\n\n# (unpatched mod_jk-1.2.15)\n#\n# Here, we submit a non-matching URI, just to see the iteration\n# order that mod_jk will use when attempting to locate a worker for\n# the request.\n\n[Wed Mar 08 10:49:22 2006] [18652:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (449): \nAttempting to map URI '/not-found' from 5 maps\n[Wed Mar 08 10:49:22 2006] [18652:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (461): \nAttempting to map context URI '/golly-gee-batman/*'\n[Wed Mar 08 10:49:22 2006] [18652:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (461): \nAttempting to map context URI '/a/1/2/*'\n[Wed Mar 08 10:49:22 2006] [18652:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (461): \nAttempting to map context URI '/*.jsp'\n[Wed Mar 08 10:49:22 2006] [18652:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (461): \nAttempting to map context URI '/a/1/*'\n[Wed Mar 08 10:49:22 2006] [18652:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (461): \nAttempting to map context URI '/a/*'\n\n\n# (unpatched mod_jk-1.2.15)\n#\n# Here, we have a request for /a/1/foo.jsp.  Log entries below show\n# thie request being mapped to '/*.jsp', not '/a/1/*'\n#\n[Wed Mar 08 10:52:56 2006] [18653:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (449): \nAttempting to map URI '/a/1/foo.jsp' from 5 maps\n[Wed Mar 08 10:52:56 2006] [18653:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (461): \nAttempting to map context URI '/golly-gee-batman/*'\n[Wed Mar 08 10:52:56 2006] [18653:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (461): \nAttempting to map context URI '/a/1/2/*'\n[Wed Mar 08 10:52:56 2006] [18653:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (461): \nAttempting to map context URI '/*.jsp'\n[Wed Mar 08 10:52:56 2006] [18653:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (475): \nFound a wildchar match worker_default -> /*.jsp\n\n\n\t\t\t\t* * *\n\n\n# (patched mod_jk-1.2.15)\n#\n# Here is the same \"/not-found\" request, made against mod_jk-1.2.15,\n# with the submitted patch.  Note that the matching order reflects\n# the number of uri path elements in the JkMount directive.\n#\n[Wed Mar 08 11:31:15 2006] [20808:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (487): \nAttempting to map URI '/not-found' from 5 maps\n[Wed Mar 08 11:31:15 2006] [20808:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/a/1/2/*'\n[Wed Mar 08 11:31:15 2006] [20808:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/a/1/*'\n[Wed Mar 08 11:31:15 2006] [20808:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/golly-gee-batman/*'\n[Wed Mar 08 11:31:15 2006] [20808:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/a/*'\n[Wed Mar 08 11:31:15 2006] [20808:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/*.jsp'\n\n\n# (patched mod_jk-1.2.15)\n#\n#  Request for '/a/1/2/foo.jsp'\n#\n[Wed Mar 08 11:32:29 2006] [20809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (487): \nAttempting to map URI '/a/1/2/foo.jsp' from 5 maps\n[Wed Mar 08 11:32:29 2006] [20809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/a/1/2/*'\n[Wed Mar 08 11:32:29 2006] [20809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (513): \nFound a wildchar match worker_a12 -> /a/1/2/*\n\n\n# (patched mod_jk-1.2.15)\n#\n# Request for '/a/1/foo.jsp'\n#\n#\n[Wed Mar 08 11:33:20 2006] [20808:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (487): \nAttempting to map URI '/a/1/foo.jsp' from 5 maps\n[Wed Mar 08 11:33:20 2006] [20808:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/a/1/2/*'\n[Wed Mar 08 11:33:20 2006] [20808:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/a/1/*'\n[Wed Mar 08 11:33:20 2006] [20808:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (513): \nFound a wildchar match worker_a1 -> /a/1/*\n\n\n\n# (patched mod_jk-1.2.15)\n#\n# Request for '/a/foo.jsp'\n#\n#\n[Wed Mar 08 11:34:01 2006] [20809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (487): \nAttempting to map URI '/a/foo.jsp' from 5 maps\n[Wed Mar 08 11:34:01 2006] [20809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/a/1/2/*'\n[Wed Mar 08 11:34:01 2006] [20809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/a/1/*'\n[Wed Mar 08 11:34:01 2006] [20809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/golly-gee-batman/*'\n[Wed Mar 08 11:34:01 2006] [20809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/a/*'\n[Wed Mar 08 11:34:01 2006] [20809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (513): \nFound a wildchar match worker_a -> /a/*\n\n\n# (patched mod_jk-1.2.15)\n#\n# Request for '/golly-gee-batman/foo.jsp'\n#\n#\n[Wed Mar 08 11:34:53 2006] [20808:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (487): \nAttempting to map URI '/golly-gee-batman/foo.jsp' from 5 maps\n[Wed Mar 08 11:34:53 2006] [20808:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/a/1/2/*'\n[Wed Mar 08 11:34:53 2006] [20808:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/a/1/*'\n[Wed Mar 08 11:34:53 2006] [20808:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/golly-gee-batman/*'\n[Wed Mar 08 11:34:53 2006] [20808:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (513): \nFound a wildchar match worker_golly -> /golly-gee-batman/*\n\n\n# (patched mod_jk-1.2.15)\n#\n# Request for '/foo.jsp'\n#\n[Wed Mar 08 11:35:27 2006] [20809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (487): \nAttempting to map URI '/foo.jsp' from 5 maps\n[Wed Mar 08 11:35:27 2006] [20809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/a/1/2/*'\n[Wed Mar 08 11:35:27 2006] [20809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/a/1/*'\n[Wed Mar 08 11:35:27 2006] [20809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/golly-gee-batman/*'\n[Wed Mar 08 11:35:27 2006] [20809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/a/*'\n[Wed Mar 08 11:35:27 2006] [20809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (499): \nAttempting to map context URI '/*.jsp'\n[Wed Mar 08 11:35:27 2006] [20809:0000] [debug] map_uri_to_worker::jk_uri_worker_map.c (513): \nFound a wildchar match worker_default -> /*.jsp\n\n\n"}, {"count": 3, "tags": [], "creator": "srevilak@speakeasy.net", "attachment_id": 17848, "text": "Created attachment 17848\njk_uri_worker_map.c patch to order matching based on # of uri path elements", "id": 86607, "time": "2006-03-08T16:49:47Z", "bug_id": 38889, "creation_time": "2006-03-08T16:49:47Z", "is_private": false}, {"count": 4, "attachment_id": null, "creator": "mturk@apache.org", "text": "Commited.\nThanks!", "id": 86902, "time": "2006-03-16T08:10:39Z", "bug_id": 38889, "creation_time": "2006-03-16T08:10:39Z", "tags": [], "is_private": false}]