[{"count": 0, "tags": [], "text": "With 'ProxyErrorOverride On', mod_proxy incorrectly fails to pass the WWW-\nAuthenticate header through to the client on 401 responses from the origin \nserver.\n\nIt seems the problem is that ap_send_error_response() clears \nr->headers_out, while ap_proxy_http_process_response() does not copy \nthe WWW-Authenticate header into r->err_headers_out.\n\nA patch which fixes this follows.\n\n(Note re the second passage of the patch: If we don't discard the request body \nthat accompanied the 401 response, it is still there on the socket when auth \nsucceeds... and is therefore prepended, in it's raw chunked glory, when the \nactual content page from the origin server is served to the client.  Thus we \nmust discard the request body prior to exiting from \nap_proxy_http_process_response() on 401 responses with ProxyErrorOverride On.\n\nNote that this patch appears to correct the problem, but has NOT yet received \nextensive testing.\n\n*** modules/proxy/proxy_http.c.orig     Thu Sep 19 14:47:51 2002\n--- modules/proxy/proxy_http.c  Thu Sep 19 17:38:36 2002\n***************\n*** 863,868 ****\n--- 863,879 ----\n              }\n          }\n  \n+       if ((r->status == 401) && (conf->error_override != 0)) {\n+           const char *buf;\n+           const char *wa = \"WWW-Authenticate\";\n+           if (buf = apr_table_get(r->headers_out, wa)) {\n+               apr_table_set(r->err_headers_out, wa, buf);\n+           } else {\n+               ap_log_error(APLOG_MARK, APLOG_DEBUG, 0, r->server,\n+                            \"proxy: origin server sent 401 without w-a \nheader\");\n+           }\n+       }\n+ \n          r->sent_bodyct = 1;\n          /* Is it an HTTP/0.9 response? If so, send the extra data */\n          if (backasswards) {\n***************\n*** 969,974 ****\n--- 980,986 ----\n               */\n              int status = r->status;\n              r->status = HTTP_OK;\n+           ap_discard_request_body(rp);\n              return status;\n          }\n      } else", "is_private": false, "bug_id": 12911, "id": 23233, "time": "2002-09-23T00:31:53Z", "creator": "rreiner@fscinternet.com", "creation_time": "2002-09-23T00:31:53Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 12911, "attachment_id": null, "id": 35238, "time": "2003-04-15T16:38:53Z", "creator": "minfrin@sharp.fm", "creation_time": "2003-04-15T16:38:53Z", "is_private": false, "text": "Patch already applied to v2.0 and v2.1."}]