[{"count": 0, "tags": [], "bug_id": 53869, "text": "Created attachment 29372\nPatch for JspContextWrapper.java\n\nJspContextWrapper.getServletContext, JspContextWrapper.findAttribute and JspContextWrapper.getELContext take much time because there are many cascaded tag files. \n\nFor example:\n <tag1>\n <tag2>\n <tag3>\n <tag4/>\n </tag3>\n </tag2>\n </tag1>\n\nWhen calling JspContextWrapper(tag4).getServletContext from tag4, it will call JspContextWrapper(tag3).getServletContext --> JspContextWrapper(tag2).getServletContext --> JspContextWrapper(tag1).getServletContext --> PageContext.getServletContext.\n\nIf the root PageContext can be held in JspConextWrapper, those page,session,application scopes calling can go directy to this root PageContext.\n\nPlease check out the attached diff file (JspContextWrapper.diff) to get more detail about this change.", "id": 162153, "time": "2012-09-13T13:56:24Z", "creator": "xshao@ebay.com", "creation_time": "2012-09-13T13:56:24Z", "is_private": false, "attachment_id": 29372}, {"count": 1, "tags": [], "bug_id": 53869, "is_private": false, "text": "Created attachment 29373\nTime taken percentage from one sample page", "id": 162154, "time": "2012-09-13T13:57:20Z", "creator": "xshao@ebay.com", "creation_time": "2012-09-13T13:57:20Z", "attachment_id": 29373}, {"count": 2, "tags": [], "bug_id": 53869, "text": "Can somebody please take a look at this patch?", "id": 162257, "time": "2012-09-18T19:56:01Z", "creator": "jgawor@gmail.com", "creation_time": "2012-09-18T19:56:01Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "markt@apache.org", "is_private": false, "count": 3, "id": 163006, "time": "2012-10-28T21:08:17Z", "bug_id": 53869, "creation_time": "2012-10-28T21:08:17Z", "text": "Please provide a test case that demonstrates the difference. The test case doesn't need to compare the old and new. As long as it generates timing information for the current implementation then both implementations may be tested in turn."}, {"count": 4, "tags": [], "bug_id": 53869, "text": "Created attachment 29586\nOld JspContextWrapper", "id": 163367, "time": "2012-11-12T05:56:09Z", "creator": "xshao@ebay.com", "creation_time": "2012-11-12T05:56:09Z", "is_private": false, "attachment_id": 29586}, {"attachment_id": 29587, "tags": [], "bug_id": 53869, "is_private": false, "count": 5, "id": 163368, "time": "2012-11-12T05:56:42Z", "creator": "xshao@ebay.com", "creation_time": "2012-11-12T05:56:42Z", "text": "Created attachment 29587\nTest case comparison for performance tuning"}, {"attachment_id": null, "tags": [], "creator": "xshao@ebay.com", "is_private": false, "count": 6, "id": 163369, "time": "2012-11-12T05:59:17Z", "bug_id": 53869, "creation_time": "2012-11-12T05:59:17Z", "text": "Hi Mark.\n\nI added the test case.\nHere is a result of this case:\n\nDuration:422\nDurationOld:748\nDuration:203\nDurationOld:717\nDuration:187\nDurationOld:702\nDuration:187\nDurationOld:686"}, {"count": 7, "tags": [], "text": "1. This change in JspContextWrapper constructor means that it will create EL context regardless of whether it will be used or not:\n\n+ this.elContext = rootJspCtxt.getELContext();\n\nSee PageContextImpl.getELContext(), JspApplicationContextImpl.createELContext(..).\n\nThe EL Context creation operation involves using a PrivilegedAction and firing an event through listeners. It is not cheap.\n\nI think this change in behaviour is undesireable.\n\n\n2. I do not expect much from your proposed optimization. Using a delegation is a common pattern. Replacing 4 chained redirects with 1 redirect is not much of a change.\n\n3. If someone extends JspContextWrapper, its behaviour will be broken by this change. (Is it a concern? Would anyone extend it? Isn't it Jasper internals?)", "is_private": false, "bug_id": 53869, "id": 163371, "time": "2012-11-12T08:56:28Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2012-11-12T08:56:28Z", "attachment_id": null}, {"count": 8, "text": "To get performance improvements above has required 5 levels of nesting and 10^7 iterations. That works out to around 50 nanoseconds per request.\n\nI am far from convinced that the test case used to justify this changes represents a typical use case.\n\nI share Konstantin's concerns regarding the ELContext.\n\nI do not believe folks would be extending JspContextWrapper.\n\nWithout a better justification for this change, I am leaning towards WONTFIX.", "creator": "markt@apache.org", "is_private": false, "id": 163402, "time": "2012-11-12T22:28:43Z", "bug_id": 53869, "creation_time": "2012-11-12T22:28:43Z", "tags": [], "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 53869, "text": "Created attachment 29604\nScreenshot from JProfiler\n\nActually, There are 8-level tag files cascaded in our page. You can refer this screenshot.\nIn this screenshot. Index.jsp was hit 80 times.  It has almost 10000 ELs in runtime. In this situation, JspContextWrapper.findAttribute becomes a big one of EL evaluation.", "id": 163515, "time": "2012-11-19T02:04:08Z", "creator": "xshao@ebay.com", "creation_time": "2012-11-19T02:04:08Z", "is_private": false, "attachment_id": 29604}, {"count": 10, "tags": [], "bug_id": 53869, "text": "Actually, There are 8-level tag files cascaded in our page. You can refer this screenshot.\nIn this screenshot. Index.jsp was hit 80 times.  It has almost 10000 ELs in runtime. In this situation, JspContextWrapper.findAttribute becomes a big one of EL evaluation.", "id": 163567, "attachment_id": null, "creator": "xshao@ebay.com", "creation_time": "2012-11-21T08:36:40Z", "time": "2012-11-21T08:36:40Z", "is_private": false}, {"count": 11, "tags": [], "creator": "markt@apache.org", "text": "The test case used to evaluate this patch is flawed. It fails to take account of the call to rootJspCtxt.getELContext() and does not compare the performance of the new implementation for a simple JSP page that does not use EL and does not have nested tags. When these additional issues are taken into consideration the proposed patch significantly impacts performance for these simple pages. Performance (as measured by this test case) is 1.5 to 2 times slower for simple pages.\n\nHowever, it is not all doom and gloom. A small tweak to the proposed patch to use lazy instantiation for the EL context and performance is (as near as makes no difference) back to where it was for simple pages and still noticeably improved for the more complex case.", "id": 164888, "time": "2013-01-25T12:02:25Z", "bug_id": 53869, "creation_time": "2013-01-25T12:02:25Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 53869, "text": "The modified patch has been applied to trunk and will be included in 7.0.36 onwards.", "id": 164889, "time": "2013-01-25T12:08:43Z", "creator": "markt@apache.org", "creation_time": "2013-01-25T12:08:43Z", "is_private": false, "attachment_id": null}]