[{"count": 0, "attachment_id": null, "bug_id": 57209, "is_private": false, "id": 179091, "time": "2014-11-13T22:40:58Z", "creator": "jasonmcintosh@carfax.com", "creation_time": "2014-11-13T22:40:58Z", "tags": [], "text": "JNDIRealm without connectionPassword/connectionName on role lookups - role search as user does not work as intended.  If you want to search the system as the logged in user for roles:\n\nuserBase = DC=Company,DC=com\nuserSearch = (&(objectCategory=person)(sAMAccountName={0}))\nuserSubTree = true\n\nThis works fine and you can bind as a user, but searching fails.  Search fails because there's no user credentials to bind with and binding anonymously is disabled.  If you have isRoleSearchAsUser turned on the expectation\n\nprotected User getUser(DirContext context, String username, String credentials, int curUserPattern) \ndoes not add the binding user credentials for searching.  A VERY simple fix around line 1297 is to do the following so that searches work with the bound user:\n\n\n  // Use pattern or search for user entry\n            if (userPatternFormatArray != null && curUserPattern >= 0) {\n                user = getUserByPattern(context, username, credentials, attrIds, curUserPattern);\n            }\n            else {\n                if (isRoleSearchAsUser()) {\n                    userCredentialsAdd(context, username, credentials);\n                }\n                user = getUserBySearch(context, username, attrIds);\n            }\n\nThere's probably a cleaner way to do this, but this is how I've managed to get things working at this point.  I'd imagine a property \"userSearchDNPattern\" could be added so that you can specify the pattern for the DN to bind with.  And switch the \"userCredentialsAdd\" to use that userSearchDNPattern\" instead.  With the above fix binding as a user and role lookups now work.  Another option is to change \"roleSearchAsUser\" to something that says \"do all operatins with the authenticated user, assuming he's authorized\""}, {"id": 179742, "tags": [], "bug_id": 57209, "attachment_id": null, "count": 1, "text": "I think the answer here is to change roleSearchAsUser to searchAsUser and then do as you suggest. There will need to be appropriate deprecation and support for both in parallel.\n\nI'll start work on a patch.", "time": "2014-12-12T19:39:51Z", "creator": "markt@apache.org", "creation_time": "2014-12-12T19:39:51Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 57209, "attachment_id": null, "is_private": false, "id": 179743, "time": "2014-12-12T20:04:51Z", "creator": "markt@apache.org", "creation_time": "2014-12-12T20:04:51Z", "text": "On reflection a new attribute userSearchAsUser seems more appropriate."}, {"count": 3, "attachment_id": null, "bug_id": 57209, "is_private": false, "id": 179756, "time": "2014-12-14T13:11:33Z", "creator": "markt@apache.org", "creation_time": "2014-12-14T13:11:33Z", "tags": [], "text": "The new attribute has been added to trunk, 8.0.x (for 8.0.16 onwards) and 7.0.x (for 7.0.58 onwards)."}]