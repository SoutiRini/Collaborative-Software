[{"count": 0, "tags": [], "bug_id": 58116, "text": "Created attachment 32892\nCometProcessor servlets must not be cached as Servlet or NoSuchMethodException will be thrown.\n\nThe fix for https://bz.apache.org/bugzilla/show_bug.cgi?id=57281 caused a regression with Tomcat running with a SecurityManager, CometProcessor servlets throw an exception when serving a request.\n\nPlease find proposed fix in patch file.", "id": 183965, "time": "2015-07-08T20:47:49Z", "creator": "johno@sulake.com", "creation_time": "2015-07-08T20:47:49Z", "is_private": false, "attachment_id": 32892}, {"count": 1, "tags": [], "bug_id": 58116, "text": "javax.servlet.ServletException: Servlet execution threw an exception\n        java.security.AccessController.doPrivileged(Native Method)\n        org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:103)\n        org.apache.catalina.ha.session.JvmRouteBinderValve.invoke(JvmRouteBinderValve.java:218)\n        org.apache.catalina.ha.tcp.ReplicationValve.invoke(ReplicationValve.java:333)\n        org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:423)\n        org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1079)\n        org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:620)\n        org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1753)\n        org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1712)\n        java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n        java.lang.Thread.run(Thread.java:745)\nroot cause\n \njava.lang.NoSuchMethodException: javax.servlet.Servlet.event(org.apache.catalina.comet.CometEvent)\n        java.lang.Class.getMethod(Class.java:1670)\n        org.apache.catalina.security.SecurityUtil.createMethodAndCacheIt(SecurityUtil.java:380)\n        org.apache.catalina.security.SecurityUtil.doAsPrivilege(SecurityUtil.java:161)\n        java.security.AccessController.doPrivileged(Native Method)\n        org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:103)\n        org.apache.catalina.ha.session.JvmRouteBinderValve.invoke(JvmRouteBinderValve.java:218)\n        org.apache.catalina.ha.tcp.ReplicationValve.invoke(ReplicationValve.java:333)\n        org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:423)\n        org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1079)\n        org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:620)\n        org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1753)\n        org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1712)\n        java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n        java.lang.Thread.run(Thread.java:745)", "id": 183966, "time": "2015-07-08T23:12:52Z", "creator": "johno@sulake.com", "creation_time": "2015-07-08T23:12:52Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "text": "Would be nice if the fix could be backported to Tomcat 7.", "is_private": false, "id": 183980, "creator": "johno@sulake.com", "time": "2015-07-10T08:06:53Z", "bug_id": 58116, "creation_time": "2015-07-10T08:06:53Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 58116, "attachment_id": null, "text": "1. This is reproducible with examples webapp (comet chat example)\n\n2. I think the same issue exists with Filter and CometFilter. I do not have an example though. It needs a fix.\n\n3. The patch looks as a working one (as CometProcessor extends Servlet interface)\n\nBut I wonder whether there is a better fix. It is known what methods belong to Servlet interface and what belong to CometProcessor.  The same with Filter and CometFilter.\n\nNote: Tomcat trunk is not affected, as Comet API has been removed from Tomcat 9 onwards.", "id": 184190, "time": "2015-07-27T20:38:49Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-07-27T20:38:49Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 58116, "attachment_id": null, "id": 184222, "time": "2015-07-29T17:35:32Z", "creator": "markt@apache.org", "creation_time": "2015-07-29T17:35:32Z", "is_private": false, "text": "I agree it certainly looks as if a better fix should be possible but having looked at this for a little while I don't see anything obvious. A cleaner final solution may be possible with a more invasive refactoring but given that Comet has been removed from Tomcat 9 onwards I think the proposed patch is the way to go (with a similar solution for filters)."}, {"count": 5, "tags": [], "text": "Thanks for the patch. It has been applied (with a minor tweak for more specific generics and an extension for CometFilter) to 8.0.x (for4 8.0.25 onwards) and 7.0.x (for 7.0.64 onwards).", "attachment_id": null, "bug_id": 58116, "id": 184223, "time": "2015-07-29T17:55:24Z", "creator": "markt@apache.org", "creation_time": "2015-07-29T17:55:24Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 58116, "attachment_id": 32944, "id": 184224, "time": "2015-07-29T18:05:06Z", "creator": "johno@sulake.com", "creation_time": "2015-07-29T18:05:06Z", "is_private": false, "text": "Created attachment 32944\nComet SecurityManager patch\n\nAttaching new patch which addresses the same problem with CometFilter."}, {"count": 7, "tags": [], "text": "Beat me to it, thanks a lot Konstantin and Mark!", "attachment_id": null, "bug_id": 58116, "id": 184225, "time": "2015-07-29T18:06:13Z", "creator": "johno@sulake.com", "creation_time": "2015-07-29T18:06:13Z", "is_private": false}]