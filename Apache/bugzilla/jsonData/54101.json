[{"count": 0, "tags": [], "bug_id": 54101, "attachment_id": 29549, "id": 163203, "time": "2012-11-05T16:10:23Z", "creator": "framelio@gmail.com", "creation_time": "2012-11-05T16:10:23Z", "is_private": false, "text": "Created attachment 29549\nPatch for socket support on mod_proxy\n\nCurrently mod_proxy and mod_proxy_fcgi doesn't support for a UNIX socket backend.\n\nSpeaking about FCGI protocol and PHP, generally many PHP-FPM server configurations are using a socket backend instead of the standard TCP connection.\n\nNGINXx supports it and the mod_fastcgi too with the config:\nFastCgiExternalServer /cgi-bin/php-path -socket /path/to/socket/php-fpm.sock\n\nA proposed patch and solution can be found here:\nhttp://www.gossamer-threads.com/lists/apache/dev/416627\n\nThe example config format proposed is the following:\n\nProxyPass fcgi://socket=%2ftmp%2fphp-fpm.sock/local/htdocs/ \n\nI tested the patch on the version 2.4.3 and it works, even if the patch file should be slightly adapted to the latest changed in the Apache HTTPD code."}, {"count": 1, "tags": [], "bug_id": 54101, "attachment_id": 29995, "text": "Created attachment 29995\nUnix domain socket support for mod_proxy (patch)\n\nI updated my patch to resolve a problem on BSD systems. This patch was generated against Apache 2.4.4.\n\nBelow is my original announcement on the Apache dev mailing list:\n\nThe attached patch adds support for Unix domain sockets (UDS) to \nmod_proxy. This is very beneficial when configuring a reverse proxy \nusing mod_proxy_fcgi to connect to PHP-FPM. In some tests with ab \nthere was over 20% improvement in the request rate when using a UDS \ninstead of TCP. \n\nSince remote servers in mod_proxy are configured with a URL, I took \nthe idea from this page on how to represent a UDS as a URL: \nhttp://daniel.haxx.se/blog/2008/04/14/http-over-unix-domain-sockets/ \n\nSo the host portion of the URL contains \"socket=\" followed by the URI \nencoded socket path (upper case characters must be encoded too). Below \nare a couple of examples where PHP-FPM's socket is /tmp/php-fpm.sock \nand the document root is /local/htdocs: \n\nProxyPass fcgi://socket=%2ftmp%2fphp-fpm.sock/local/htdocs/ \n\nRewriteRule (.*\\.php) fcgi://socket=\\%2ftmp\\%2fphp-fpm.sock/local/htdocs/$1 [P,L] \n\nThe following are not contained in the patch: \n* bump MMN due to mod_proxy.h changes \n* assign APLOGNO numbers \n* detection of AF_UNIX support in configure \n\nThanks for your consideration, \nBlaise", "id": 165496, "time": "2013-02-26T21:43:57Z", "creator": "blaise.tarr@gmail.com", "creation_time": "2013-02-26T21:43:57Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 54101, "attachment_id": null, "text": "Not had a chance to review the patch, but a definite +1 in principle.", "id": 165497, "time": "2013-02-26T23:35:46Z", "creator": "minfrin@sharp.fm", "creation_time": "2013-02-26T23:35:46Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 54101, "attachment_id": null, "text": "+1 for stable implementation in the next http 2.4.x releases", "id": 165504, "time": "2013-02-27T09:55:12Z", "creator": "dheeg@plusline.de", "creation_time": "2013-02-27T09:55:12Z", "is_private": false}, {"count": 4, "tags": [], "creator": "jim@apache.org", "text": "Will fold into trunk for testing and enhancement. Thx", "id": 165570, "time": "2013-03-01T15:52:30Z", "bug_id": 54101, "creation_time": "2013-03-01T15:52:30Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 54101, "attachment_id": null, "text": "Would it be possible to fix it to support RewriteRule in <Directory></Directory> block (now RewriteRule only works if not in Directory section, if it is placed in Directory block, then it does not replace %2f to / well (leaves f instead of /)). Now there is no any other way to use it in Directory block, because ProxyPassMatch does not work there too (https://issues.apache.org/bugzilla/show_bug.cgi?id=54616).", "id": 165595, "time": "2013-03-03T11:21:04Z", "creator": "phpfpm1@gmail.com", "creation_time": "2013-03-03T11:21:04Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 54101, "attachment_id": null, "id": 165818, "time": "2013-03-14T01:15:57Z", "creator": "luyanfei78@163.com", "creation_time": "2013-03-14T01:15:57Z", "is_private": false, "text": "There's one problem haven't solved by this patch. The function proxy_fcgi_canon in mod_proxy_fcgi.c will modify proxy url.\nfcgi://socket=%2ftmp%2fphp-fpm.sock/local/htdocs/ \nthis url will become\nfcgi://socket=%2ftmp%2fphp-fpm.sock:8000/local/htdocs/ \nSo, it's  important to use nocanon in ProxyPass. If you choose ProxyPassMatch, then your proxy url will always be changed."}, {"count": 7, "attachment_id": null, "bug_id": 54101, "text": "+1 for stable implementation, waiting for this so long. It's critical to use with php-fpm", "id": 166178, "time": "2013-03-27T13:38:56Z", "creator": "ubunciak@gmail.com", "creation_time": "2013-03-27T13:38:56Z", "tags": [], "is_private": false}, {"count": 8, "tags": [], "creator": "phpfpm1@gmail.com", "text": "Please check https://issues.apache.org/bugzilla/show_bug.cgi?id=54616#c7. It is related to this bug.", "id": 166846, "time": "2013-04-25T10:21:12Z", "bug_id": 54101, "creation_time": "2013-04-25T10:21:12Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 54101, "attachment_id": null, "text": "I see the patch already included in trunk but the part in which the  PROXY_WORKER_MAX_HOSTNAME_SIZE and PROXY_WORKER_MAX_NAME_SIZE were increased is not there (I realized that after get a \"ProxyPass worker name (fcgi://uds=%2fsome%2fsocket.sock/tmp/somedirectory too long)\"). Was that dropped intentionally?", "id": 169896, "time": "2013-09-04T07:53:41Z", "creator": "ryotakatsuki@gmail.com", "creation_time": "2013-09-04T07:53:41Z", "is_private": false}, {"count": 10, "attachment_id": null, "creator": "peter.boling@gmail.com", "text": "This will allow Phusion Passenger Standalone to be reverse proxied by Apache as a unix domain socket!  Right now Apache can only reverse proxy over TCP, but Nginx can reverse proxy to a socket, making it the better performer for Ruby apps using this setup, and making me jealous, since I have an all Apache infrastructure.\n\nAny chance of backporting this to 2.2 stable?", "id": 170177, "time": "2013-09-19T17:16:01Z", "bug_id": 54101, "creation_time": "2013-09-19T17:16:01Z", "tags": [], "is_private": false}, {"count": 11, "tags": [], "bug_id": 54101, "text": "I second this, 64 bytes is not sufficiently long. It is prohibitively short when, for example, using Amazon AWS long hostnames for back end systems\n\nHave I missed a reason why it needs to be so short? According to wikipedia (and I fully appreciate this is very unprofessional to quote WP)\n\nhttp://en.wikipedia.org/wiki/Hostname\n\nEach label must be between 1 and 63 characters long,[2] and the entire hostname (including the delimiting dots) has a maximum of 255 characters\n\nCan we assume that the backend can be FQDN not just a single host? 255 characters would seem a minimum for a FQDN. 64 is only sufficient for a single hostname.\n\n\n(In reply to ryotakatsuki from comment #9)\n> I see the patch already included in trunk but the part in which the \n> PROXY_WORKER_MAX_HOSTNAME_SIZE and PROXY_WORKER_MAX_NAME_SIZE were increased\n> is not there (I realized that after get a \"ProxyPass worker name\n> (fcgi://uds=%2fsome%2fsocket.sock/tmp/somedirectory too long)\"). Was that\n> dropped intentionally?", "id": 170389, "time": "2013-10-02T14:06:57Z", "creator": "apachehttpd@intrepid.cx", "creation_time": "2013-10-02T14:06:57Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 54101, "attachment_id": null, "text": "+1 for adding this or similar capability to support PHP-FPM.", "id": 170520, "time": "2013-10-09T20:15:45Z", "creator": "marc+apache@zampettis.com", "creation_time": "2013-10-09T20:15:45Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 54101, "attachment_id": null, "text": "Does the patch work on latest 2.4.7 release?\nIt hasn't been included, but I can always manually patch it if there are no dependencies.", "id": 171456, "time": "2013-11-27T01:53:37Z", "creator": "me@nileshgr.com", "creation_time": "2013-11-27T01:53:37Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 54101, "text": "(In reply to me from comment #13)\n> Does the patch work on latest 2.4.7 release?\n> It hasn't been included, but I can always manually patch it if there are no\n> dependencies.\n\nAppears the patch does not work with 2.4.7\n\npatching file mod_proxy.h\nHunk #1 succeeded at 236 (offset 4 lines).\nHunk #2 succeeded at 308 (offset 4 lines).\npatching file proxy_util.c\nHunk #2 succeeded at 2028 (offset 7 lines).\nHunk #3 succeeded at 2045 (offset 7 lines).\nHunk #4 FAILED at 2156.\nHunk #5 succeeded at 2403 (offset 19 lines).\nHunk #6 succeeded at 2471 (offset 19 lines).\nHunk #7 succeeded at 2607 (offset 19 lines).\n1 out of 7 hunks FAILED -- saving rejects to file proxy_util.c.rej", "id": 171514, "time": "2013-11-30T19:38:41Z", "creator": "diemuzi@gmail.com", "creation_time": "2013-11-30T19:38:41Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "creator": "me@nileshgr.com", "attachment_id": null, "id": 171515, "time": "2013-12-01T02:22:17Z", "bug_id": 54101, "creation_time": "2013-12-01T02:22:17Z", "is_private": false, "text": "Damn, guess I need to use mod FastCGI till the next major version release. \nThankfully someone was kind enough to release a 2.4 compatible version https://github.com/ByteInternet/libapache-mod-fastcgi"}, {"count": 16, "tags": [], "bug_id": 54101, "attachment_id": null, "text": "Hope this will be fixed in some future minor release of 2.4.x\nVery crucial for my production env to switch on apache 2.4, but I'm using PHP-FPM with unix-sockets and definitely won't go with TCP sockets.\nBefore that's done will stay on apache 2.2 and/or nginx.", "id": 172055, "time": "2014-01-03T07:49:46Z", "creator": "d.iskandarov@gmail.com", "creation_time": "2014-01-03T07:49:46Z", "is_private": false}, {"count": 17, "tags": [], "creator": "jbiosca@ozongo.com", "text": "Its a pity we had a patch, it was not implemented into development and now it doesn't work anymore.\n\nStuck in 2.2.. And trying nginx.", "id": 172538, "time": "2014-01-20T12:30:54Z", "bug_id": 54101, "creation_time": "2014-01-20T12:30:54Z", "is_private": false, "attachment_id": null}, {"count": 18, "tags": [], "bug_id": 54101, "attachment_id": null, "text": "(In reply to Jose from comment #17)\n> Its a pity we had a patch, it was not implemented into development and now\n> it doesn't work anymore.\n> \n> Stuck in 2.2.. And trying nginx.\n\nThis support has been in trunk/2.5 since early last year.  The patch being considered for backport to 2.4.x is heree:\n\nhttp://people.apache.org/~jim/patches/uds-2.4.patch\n\nThe latest status on it is here:\n\nhttps://svn.apache.org/repos/asf/httpd/httpd/branches/2.4.x/STATUS\n\nOf course, as it ages, there may be cosmetic breakage of the diff.  Any feedback is welcome.", "id": 172542, "time": "2014-01-20T13:11:32Z", "creator": "covener@gmail.com", "creation_time": "2014-01-20T13:11:32Z", "is_private": false}, {"count": 19, "tags": [], "bug_id": 54101, "text": "Created attachment 31232\nPatch for 2.4.x (or 2.4.7)\n\nThis patch is the same as http://people.apache.org/~jim/patches/uds-2.4.patch (modulo CHANGES/manual/ap_mmn.h) working with current 2.4.x (and 2.4.7).", "id": 172544, "time": "2014-01-20T13:19:19Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-01-20T13:19:19Z", "is_private": false, "attachment_id": 31232}, {"count": 20, "tags": [], "creator": "vrodic@gmail.com", "attachment_id": null, "id": 173998, "time": "2014-03-21T15:38:19Z", "bug_id": 54101, "creation_time": "2014-03-21T15:38:19Z", "is_private": false, "text": "It seems that this patch has landed  in 2.4.8/2.4.9.\n\nBut I'm not sure how to use it with ProxyPassMatch\n\nI've tried the example above (fcgi://socket=%2ftmp%2fphp-fpm.sock/local/htdocs/ ) but that didn't work."}, {"count": 21, "tags": [], "bug_id": 54101, "text": "I did a test and the correct syntax for ProxyPassMatch is\n\nProxyPassMatch ^/(.*\\.php(/.*)?)$ unix:/path/to/socket.sock|fcgi://localhost/path/to/docroot/\n\nThe host localhost doesn't really matter, you can put whatever.", "id": 174010, "attachment_id": null, "creator": "framelio@gmail.com", "creation_time": "2014-03-22T15:55:29Z", "time": "2014-03-22T15:55:29Z", "is_private": false}, {"count": 22, "attachment_id": null, "bug_id": 54101, "text": "(In reply to Francesco from comment #21)\n> I did a test and the correct syntax for ProxyPassMatch is\n> \n> ProxyPassMatch ^/(.*\\.php(/.*)?)$\n> unix:/path/to/socket.sock|fcgi://localhost/path/to/docroot/\n> \n> The host localhost doesn't really matter, you can put whatever.\n\nThat works now. Although if I put $1 (as described at http://wiki.apache.org/httpd/PHP-FPM), it fails with a 503.", "id": 174026, "time": "2014-03-23T02:29:44Z", "creator": "me@nileshgr.com", "creation_time": "2014-03-23T02:29:44Z", "tags": [], "is_private": false}, {"count": 23, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "id": 176290, "time": "2014-07-08T11:41:18Z", "bug_id": 54101, "creation_time": "2014-07-08T11:41:18Z", "is_private": false, "text": "in 2.4.7"}, {"count": 24, "tags": [], "bug_id": 54101, "attachment_id": null, "text": "The proper syntax in my case Apache/2.4.6 (Linux/SUSE)\nis unix:///var/run/php-fpm.sock|fcgi://127.0.0.1:9000/srv/www/$1\nWith a triple slash, otherwise apache complain of ProxyPass URL must be absolute!", "id": 178526, "time": "2014-10-17T00:43:25Z", "creator": "admin@seisho.us", "creation_time": "2014-10-17T00:43:25Z", "is_private": false}]