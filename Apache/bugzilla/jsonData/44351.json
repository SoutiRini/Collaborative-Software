[{"count": 0, "tags": [], "creator": "charles.goyard@orange-ftgroup.com", "attachment_id": null, "text": "Hi,\n\nThere's a file descriptor leak in httpd under Linux when using mod_rewrite's\nRewriteMap with prg (external process).\n\nThe first prg gets 3 fds (stdin, stdout, stderr).\nThe second one gets 5 fds (stdin, stdout, stderr + 2 pipes).\nThe third one gets 7 fds (stdin, stdout, stderr + 2 pipes + 2 pipes).\nand so on.\n\nApache 2.2 spawns one process per prg.\nApache 2.0 spawns one process per prg and per vhost.\n\nUnder 2.0 with 85 vhosts and 6 external prg (my setup) gets thousands of fds,\nleading to an out of file descriptor error.\nThis is highly limited with Apache 2.2 but the bug still exists.\n\nWith Linux you can get the fd information under /proc/<pid>/fd/.\n\nHere is how I build Apache and a minimalistic httpd.conf that lets one reproduce\nthe problem.\n\n./configure --with-mpm=prefork --disable-maintainer-mode --disable-access\n--disable-auth --disable-include --disable-autoindex --disable-asis\n--disable-cgi --disable-negotiation --disable-dir --disable-imap\n--disable-actions --disable-userdir --disable-proxy-ftp --disable-proxy-connect\n--disable-setenvif --disable-env --disable-mime --disable-so --disable-alias\n--enable-headers --enable-proxy --enable-proxy-http --enable-rewrite\n--enable-ssl --enable-status\n\n\nLockFile    var/httpd.lock\nPidFile     var/httpd.pid\nUser  httpd\nGroup httpd\nListen *:80\n\nRewriteEngine On\nRewriteLock var/lbsync.lock\nRewriteMap pool1 prg:/usr/local/lb/lb_1\nRewriteMap pool2 prg:/usr/local/lb/lb_2\nRewriteMap pool3 prg:/usr/local/lb/lb_3\n\n<VirtualHost *>\n        ServerName      www.try1.com\n        RewriteEngine On\n\n        RewriteRule . http://${pool1:%{ENV:addr}}/$1\n        RewriteOptions  inherit\n\n</VirtualHost>\n\n<VirtualHost *>\n        ServerName      www.try2.com\n        RewriteEngine On\n\n        RewriteRule . http://${pool2:%{ENV:addr}}/$1\n        RewriteOptions  inherit\n\n</VirtualHost>\n<VirtualHost *>\n        ServerName      www.try3.com\n        RewriteEngine On\n\n        RewriteRule . http://${pool3:%{ENV:addr}}/$1\n        RewriteOptions  inherit\n\n</VirtualHost>\n<VirtualHost *>\n        ServerName      www.try4.com\n        RewriteEngine On\n        RewriteRule . http://${pool1:%{ENV:addr}}/$1\n        RewriteOptions  inherit\n\n</VirtualHost>\n<VirtualHost *>\n        ServerName      www.try5.com\n        RewriteRule . http://${pool1:%{ENV:addr}}/$1\n        RewriteOptions  inherit\n\n</VirtualHost>\n\nRegards,\n\nCharles", "id": 113407, "time": "2008-02-04T05:14:09Z", "bug_id": 44351, "creation_time": "2008-02-04T05:14:09Z", "is_private": false}]