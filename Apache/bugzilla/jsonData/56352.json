[{"count": 0, "tags": [], "bug_id": 56352, "text": "Following the \"tomcat-connectors-1.2.39-windows-x86_64-iis does not work\" thread on users list, from April 2rd\n\nhttp://marc.info/?t=139644507500004&r=1&w=2\nhttp://tomcat.markmail.org/message/sb7vbobngdqig5v6\n\nIt boils down to the following:\nThe following works:\n\n> worker.ajp13w.host=127.0.0.1\n\nThe following does not work:\n\n> worker.ajp13w.host=localhost\n\nand connector tries to connect to 0.0.0.0:\njk_open_socket::jk_connect.c (735): connect to 0.0.0.0:8009 failed (errno=49)\n\n------------\nLooking at svn history, I see that implementation of method jk_resolve() was changed in r1529803 for the case when APR library is not available.\n\nReviewing the code of jk_resolve() in jk_connect.c, I see the following issue:\nline 484\n[[[\n freeaddrinfo(ai_list);\n ...\n memcpy(&(saddr->sa), ai->ai_addr, ai->ai_addrlen);\n]]]\n\nThe \"ai\" variable is a pointer to the chosen item in \"ai_list\" linked list of addresses returned by getaddrinfo(). The bug is that freeaddrinfo(ai_list) is called too early, before the information is copied away.\n\n\nAlso, the following on lines 436-441:\n[[[\n#if JK_HAVE_IPV6\n        if (prefer_ipv6)\n            hints.ai_family = JK_INET6;\n        else\n#endif\n            hints.ai_family = JK_INET;\n]]]\nAs \"hints\" is a structure that is passed to getaddrinfo() method, I would expect those assignments to use AF_INET, AF_INET6. I suspect that this is non-issue, as those defines should be defined as equal to AF_xx constants anyway, but other code later uses AF_xx constants, so I expect the AF_xx ones to be used here as well.\n(\"if (ai->ai_family == AF_INET6)\")", "id": 174306, "time": "2014-04-05T14:21:57Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-04-05T14:21:57Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "knst.kolinko@gmail.com", "is_private": false, "id": 174307, "attachment_id": 31484, "bug_id": 56352, "creation_time": "2014-04-05T14:27:41Z", "time": "2014-04-05T14:27:41Z", "text": "Created attachment 31484\n2014-04-05_jk_56352_jkresolve_v1.patch\n\nPatch for the issue (not tested)."}, {"count": 2, "tags": [], "creator": "mturk@apache.org", "attachment_id": null, "is_private": false, "id": 174323, "time": "2014-04-07T11:03:24Z", "bug_id": 56352, "creation_time": "2014-04-07T11:03:24Z", "text": "The patch does nothing. JK_INET6 is defined as AF_INET6\nThe only thing that can be is the location of freeaddrinfo(ai_list);\nIt's a clear bug."}, {"count": 3, "tags": [], "bug_id": 56352, "text": "The reason is probably in the missing\n127.0.0.1 localhost\nentry in the host file. Since the resolve code is now a copy from APR, the same behaviour exists with HTTPD for example.\n\nHowever there is still a bug with freeaddrinfo, so this could cause more serious problems.", "id": 174325, "time": "2014-04-07T11:50:37Z", "creator": "mturk@apache.org", "creation_time": "2014-04-07T11:50:37Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "knst.kolinko@gmail.com", "text": "(In reply to Mladen Turk from comment #2)\n> The patch does nothing. JK_INET6 is defined as AF_INET6\n\nOK. Good to know. I am just saying that it looks odd.\n\n> The only thing that can be is the location of freeaddrinfo(ai_list);\n> It's a clear bug.\n\nThank you for fixing.\n\n(In reply to Mladen Turk from comment #3)\n> The reason is probably in the missing\n> 127.0.0.1 localhost\n> entry in the host file. Since the resolve code is now a copy from APR, the\n> same behaviour exists with HTTPD for example.\n\nIf it fails to resolve the host name, I would expect some different behaviour rather than an attempt to connect to 0.0.0.0.\n\n(Just for a record: Apparently, adding such entry did not help\nhttp://markmail.org/message/pgzhzuwozcvxzab7", "count": 4, "id": 174365, "time": "2014-04-08T11:08:58Z", "bug_id": 56352, "creation_time": "2014-04-08T11:08:58Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "jessica-aileen.alten@liag-hannover.de", "is_private": false, "count": 5, "id": 174591, "time": "2014-04-15T13:10:02Z", "bug_id": 56352, "creation_time": "2014-04-15T13:10:02Z", "text": "The problem seems to be solved with the new 1.2.40 release!"}, {"count": 6, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "text": "Thanks for confirming. Closing.", "id": 174593, "time": "2014-04-15T13:12:15Z", "bug_id": 56352, "creation_time": "2014-04-15T13:12:15Z", "is_private": false}]