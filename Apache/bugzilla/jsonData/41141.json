[{"count": 0, "tags": [], "bug_id": 41141, "text": "The authorization using DBD/PGSQL is broken at least in version 2.2.3.\nDebugging the code I foigured out, that in dbd_setup_lock a failure\nreturn code is generated if srv->mutex contains the NULL value. This\nis incorrect, because the NULL value may also be assigned in success\ncases if no mutexes are required (see: dbd_setup_init in the same\nsource file). I've created the following patch which works fine for\nme:\n\n\n*** ./modules/database/mod_dbd.c.fcs    Sun Dec 10 12:19:47 2006\n--- ./modules/database/mod_dbd.c        Sun Dec 10 12:22:01 2006\n***************\n*** 388,416 ****\n      /* several threads could be here at the same time, all trying to\n       * initialize the reslist because dbd_setup_init failed to do so\n       */\n!     if (!svr->mutex) {\n!         /* we already logged an error when the mutex couldn't be created */\n!         return APR_EGENERAL;\n      }\n\n-     rv = apr_thread_mutex_lock(svr->mutex);\n-     if (rv != APR_SUCCESS) {\n-         ap_log_perror(APLOG_MARK, APLOG_CRIT, rv, pool,\n-                       \"DBD: Failed to acquire thread mutex\");\n-         return rv;\n-     }\n-\n      if (!svr->dbpool) {\n          rv2 = dbd_setup(s->process->pool, svr);\n      }\n\n!     rv = apr_thread_mutex_unlock(svr->mutex);\n!     if (rv != APR_SUCCESS) {\n!         ap_log_perror(APLOG_MARK, APLOG_CRIT, rv, pool,\n!                       \"DBD: Failed to release thread mutex\");\n!         if (rv2 == APR_SUCCESS) {\n!             rv2 = rv;\n!         }\n      }\n      return rv2;\n  }\n--- 388,415 ----\n      /* several threads could be here at the same time, all trying to\n       * initialize the reslist because dbd_setup_init failed to do so\n       */\n!     if (svr->mutex) {\n!       rv = apr_thread_mutex_lock(svr->mutex);\n!       if (rv != APR_SUCCESS) {\n!           ap_log_perror(APLOG_MARK, APLOG_CRIT, rv, pool,\n!                         \"DBD: Failed to acquire thread mutex\");\n!           return rv;\n!       }\n      }\n\n      if (!svr->dbpool) {\n          rv2 = dbd_setup(s->process->pool, svr);\n      }\n\n!     if (svr->mutex) {\n!       rv = apr_thread_mutex_unlock(svr->mutex);\n!       if (rv != APR_SUCCESS) {\n!           ap_log_perror(APLOG_MARK, APLOG_CRIT, rv, pool,\n!                         \"DBD: Failed to release thread mutex\");\n!           if (rv2 == APR_SUCCESS) {\n!               rv2 = rv;\n!           }\n!       }\n      }\n      return rv2;\n  }", "id": 96705, "time": "2006-12-10T04:26:44Z", "creator": "jens@strawberry.com", "creation_time": "2006-12-10T04:26:44Z", "is_private": false, "attachment_id": null}, {"count": 1, "attachment_id": null, "bug_id": 41141, "text": "dbd_setup_lock is only ever called if dbd_setup_init failed at server\ninitialisation.  That's basically so it can recover if the database was down at\napache startup time.\n\nCan you explain how a problem arises for you?  Is it after the database has gone\ndown and been restarted?\n\nBTW, there may be a bug, but your patch is definitely broken, as it's not\nthread-safe.", "id": 96708, "time": "2006-12-10T05:50:56Z", "creator": "nick@webthing.com", "creation_time": "2006-12-10T05:50:56Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 41141, "text": "Hi,\n\npsql authentication is working properly in apache 2.2.2.\nBecause of difficulties with php 5.2.0 - they finally boiled down\nto another apache problem issue 41142 - I upgraded to version 2.2.3.\n\nIt turned out, that in version 2.2.3 apache was not able any more to\nauthenticate against the PostgreSQL database. Using a debugger I \nfigured out, that\n\n    dbd_setup_init did *not* fail. dbd_setup returns APR_SUCESS. This\n        return value is returned by dbd_setup_init in the second if\n        statement.\n\n    Therefor srv->mutex was still NULL\n\n    dbd_setup_lock was called afterwards. It failed because of srv->mutex.\n\nThe postgres database was setup when apache 2.2.2 was running. It was\nnot modified since then. After applying my patch, apache including the\nauthentication seemd ok for me again.\n\nI had another look at the code right now. I turns out, that dbd_setup_lock\nis called if svr->dbpool is NULL. However db_setup returns APR_SUCCESS,\nthus apr_reslist_create obviously returns APR_SUCCESS. The later function\nfor my understanding should setup svr->dbpool. And it does so. \n\nSo at the moment I'm stucked ... the only explanation would be some side\neffect overriding svr->dbpool ...\n\nJens\n\n    ", "id": 96731, "time": "2006-12-10T23:45:40Z", "creator": "jens@strawberry.com", "creation_time": "2006-12-10T23:45:40Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "nick@webthing.com", "text": "Ah, OK.  I think this is probably a side-effect of the fact that inheritance\nbetween the main server config and <VirtualHost>s isn't working correctly.\n\nCan you test-drive it with mod_dbd from /trunk/ ?  That would be useful.", "id": 96738, "time": "2006-12-11T02:59:37Z", "bug_id": 41141, "creation_time": "2006-12-11T02:59:37Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 41141, "text": "(In reply to comment #3)\n> Ah, OK.  I think this is probably a side-effect of the fact that inheritance\n> between the main server config and <VirtualHost>s isn't working correctly.\n> \n> Can you test-drive it with mod_dbd from /trunk/ ?  That would be useful.\n\n\nI may try that. Could you please point me to the trunk download page\nor send the according files via mail to me? I had a look at the apache\nhome page but did not find any link to the development zone ... maybe\nI'm too blind to see it ;-)", "id": 96742, "time": "2006-12-11T06:03:13Z", "creator": "jens@strawberry.com", "creation_time": "2006-12-11T06:03:13Z", "is_private": false, "attachment_id": null}, {"text": "As you only need to exchange the file mod_dbd.c \nhttp://svn.apache.org/viewvc/httpd/httpd/trunk/modules/database/mod_dbd.c?view=co\nshould be of sufficient help. For more please have a look at the \"Source\nRepository Information\" section of http://httpd.apache.org/dev/.", "tags": [], "bug_id": 41141, "attachment_id": null, "count": 5, "id": 96773, "time": "2006-12-11T13:18:30Z", "creator": "rpluem@apache.org", "creation_time": "2006-12-11T13:18:30Z", "is_private": false}, {"count": 6, "tags": [], "creator": "jens@strawberry.com", "attachment_id": null, "id": 96839, "time": "2006-12-12T13:17:24Z", "bug_id": 41141, "creation_time": "2006-12-12T13:17:24Z", "is_private": false, "text": "Hi,\n\nI've tried the patch from issue 39985 and the mod_dbd.c\ntrunk verion now. Both do not work.\n\nThe development tree and all information about how I built\nand configured apache are on one of my public servers now.\nThere's also a compiler and debugger installed.\n\nI may grant access to the server to you to have a look at\nthe situation ... if this would be an approach pls. contact\nme personally by mail for the login data.\n\nJens"}, {"count": 7, "attachment_id": null, "bug_id": 41141, "text": "2.2.6 has some major mod_dbd fixes.  Does it fix this problem for you?", "id": 107956, "time": "2007-09-10T04:36:14Z", "creator": "nick@webthing.com", "creation_time": "2007-09-10T04:36:14Z", "tags": [], "is_private": false}, {"count": 8, "attachment_id": null, "bug_id": 41141, "text": "No response since Comment 7; assuming fixed.", "id": 113849, "time": "2008-02-18T00:52:15Z", "creator": "nick@webthing.com", "creation_time": "2008-02-18T00:52:15Z", "tags": [], "is_private": false}]