[{"count": 0, "tags": [], "creator": "ide@nlm.nih.gov", "attachment_id": null, "text": "request.getServerPort() currently returns the socket port instead\nof the port specified by the user.  (These can be different if a \nload balancer or firewall is redirecting ports.)\n\n\nSee line 465 of mod_jk.c (Revision 1.26)\n\nMy C code is a bit rusty, but I replaced that line:\n\ns->server_port     = htons( r->connection->local_addr.sin_port );\n\nwith:\n\n/* Pick default values for port of 80/443.  */\n/* Then use the values from HOST header if they are available. */\n\n    {\n    const char *host_header;\n    int port = 80;\t/* good default if no HOST header */\n    int is_ssl = 0;\n    char parsed_server[256];\n    int parsed=0;\n    host_header = ap_table_get(r->headers_in, \"Host\");\n    if(conf->ssl_enable) {\n            char *ssl_temp;\n            ssl_temp = (char *)ap_table_get(r->subprocess_env,\nconf->https_indicator);\n            if(ssl_temp && !strcasecmp(ssl_temp, \"on\")) {\n                is_ssl = 1;\n                port = 443;   /* good default if no HOST hdr and ssl */\n            }\n    }\n\n    if (host_header)    /* get the port from Host: if possible */\n        {\n        int tmp_port;\n        const char *s = strchr(host_header, ':');\n        if (s != NULL) {\n            ++s;        /* past the colon */\n            if (sscanf (s,\"%d\", &tmp_port) == 1) port = tmp_port;\n        }\n        }\n\n/** set the good port value */\n    s->server_port = port;\n    }\n\nBy the way, I believe the Apache <VirtualHost> logic has the same problem.", "id": 21751, "time": "2002-08-26T19:39:31Z", "bug_id": 12052, "creation_time": "2002-08-26T19:39:31Z", "is_private": false}, {"text": "This component is now deprecated. If you still experience this issue, please \nupgrade to the Coyote JK2 connector.\n\nNo further work will take place against this bug report.\n\n", "tags": [], "creator": "markt@apache.org", "attachment_id": null, "count": 1, "id": 59516, "time": "2004-06-18T18:43:21Z", "bug_id": 12052, "creation_time": "2004-06-18T18:43:21Z", "is_private": false}]