[{"attachment_id": null, "tags": [], "creator": "kgrindley@ll.mit.edu", "is_private": false, "count": 0, "id": 125640, "time": "2009-03-19T18:53:32Z", "bug_id": 46880, "creation_time": "2009-03-19T18:53:32Z", "text": "When submitting a POST, usually a large post, sometimes the re-negotiation fails with the following error.\n\n[Thu Mar 19 21:35:58 2009] [info] Initial (No.1) HTTPS request received for child 0 (server locus.example.com:443)\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_kernel.c(426): Changed client verification type will force renegotiation\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_io.c(1478): [client 155.34.228.80] filling buffer\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_io.c(1800): OpenSSL: read 5/5 bytes from BIO#2aca86a7bc20 [mem: 2aca78e95010] (BIO dump follows)\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_io.c(1747): +-------------------------------------------------------------------------+\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_io.c(1772): | 0000: 17 03 01 04 40                                   ....@            |\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_io.c(1778): +-------------------------------------------------------------------------+\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_io.c(1800): OpenSSL: read 1088/1088 bytes from BIO#2aca86a7bc20 [mem: 2aca78e95015] (BIO dump follows)\n[...snip...]\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_io.c(1529): [client 155.34.228.80] total of 4324 bytes in buffer, eos=1\n[Thu Mar 19 21:35:58 2009] [info] Requesting connection re-negotiation\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_kernel.c(616): Performing full renegotiation: complete handshake protocol\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_kernel.c(1752): OpenSSL: Handshake: start\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop: SSL renegotiate ciphers\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop: SSLv3 write hello request A\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop: SSLv3 flush data\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop: SSLv3 write hello request C\n[Thu Mar 19 21:35:58 2009] [info] Awaiting re-negotiation handshake\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_kernel.c(1752): OpenSSL: Handshake: start\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop: before accept initialization\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_io.c(1811): OpenSSL: I/O error, 5 bytes expected to read on BIO#2aca86a7bc20 [mem: 2aca78e95010]\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_kernel.c(1789): OpenSSL: Exit: error in SSLv3 read client hello B\n[Thu Mar 19 21:35:58 2009] [error] Re-negotiation handshake failed: Not accepted by client!?\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_io.c(1572): [client 155.34.228.80] read from buffered SSL brigade, mode 0, 8192 bytes\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_io.c(1647): [client 155.34.228.80] buffered SSL brigade exhausted\n\nseems to fail 4 out of 5 times.  sometimes realoading will cause the reneg. to complete and the post is passed to the CGI.\n\nnote I'm running a larger SSL reneg buffer of 800meg. (i need to be able to accept large posts via client certificate authentication)"}, {"count": 1, "tags": [], "creator": "jorton@redhat.com", "text": "1) 800meg is um, seriously large.  I can't recommend enough that you rejig the webapp to ensure that the first request to the client-cert-required area is a GET rather than a POST-with-large-body.\n\n2) if you're using the patched 2.2.3 RHEL packages please file bugs in RH bugzilla in the first instance.  The debug message \"filling buffer\" should include a suffix \", max size N bytes\" if you are using the SSLRenegBufferSize patch, which is confusing.\n\nwhat this:\n\n[Thu Mar 19 21:35:58 2009] [debug] ssl_engine_io.c(1529): [client\n155.34.228.80] total of 4324 bytes in buffer, eos=1\n\nmeans is that mod_ssl read an end-of-file (eos=1) from the client after reading ~4K of data.  What client is being used?  It may be necessary to look at packet traces to determine what is going on here.", "id": 125648, "time": "2009-03-20T06:23:38Z", "bug_id": 46880, "creation_time": "2009-03-20T06:23:38Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "kgrindley@ll.mit.edu", "text": "Joe,\n\nThanks for the reply.  I'm going to file a series of tickets in the RH bugzilla as i think i've identified two broken items in the RH release of 2.2.3 related to SSL and buffer sizes.\n\nI decided it would be best for all parties to see if this was a bug in the latest version of apache or not, so I downloaded 2.2.11 from apache.org and spun an RPM.  So far, all the issues I was having have evaporated.  So I think this is on RH's plate to fix.\n\nThanks again,\nKarl", "id": 125649, "time": "2009-03-20T06:32:11Z", "bug_id": 46880, "creation_time": "2009-03-20T06:32:11Z", "is_private": false, "attachment_id": null}]