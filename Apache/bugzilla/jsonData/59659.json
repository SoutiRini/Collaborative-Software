[{"count": 0, "attachment_id": null, "bug_id": 59659, "is_private": false, "id": 191377, "time": "2016-06-03T07:32:48Z", "creator": "janmika7@gmail.com", "creation_time": "2016-06-03T07:32:48Z", "tags": [], "text": "Tested on tomee 7.0.0. using tomcat-websocket.jar version 8.5.2.\nI found it during the long-term using of WebSockets. After several page switches and re-openings some WsSessions  were not  removed even after the client session finished. It was difficult to reproduce. But here is how to do it more predictably:\n\nOpen the HTML page defined below and several time click reload current page. If error occurs on Java side (it means that wsError occurs) the WsSession will not be removed from GC. I tested it mostly with Firefox but it work also on IE 11 etc. JDK 1.7.0_51 64 bit was used.\n\n\n\nHTML code:\n\n<!DOCTYPE html>\n<html>\n<head>\n\t<meta charset=\"UTF-8\">\n\t<title>WebSocket Test</title>\n\t<script>\n\t\tvar ws = null;\n\t\tvar i=0;\n\t\tvar myVar = setInterval(myTimer, 10);\n\t\tfunction myTimer() {\n\t\t\tif(ws) return;\n\t\t\tws = new WebSocket(\"ws://localhost:8080/WsMemoryLeak/ws\");\n\t\t\tconsole.log(\"reconnecting \" + i++);\n            ws.onopen = function() {\n               //ws.send(\"Message to send\");\n               console.log(\"onocpen \" + i++);\n               ws.close();\n               ws = null;\n            };\n\t\t\t\t\n            ws.onmessage = function (evt) { \n               var received_msg = evt.data;\n               console.log(\"onmessage \" + evt.data);\n            };\n\t\t\t\t\n            ws.onclose = function(){\n           \t console.log(\"onclose\");\n            };\n\n\t\t}\n\t\twindow.onbeforeunload = function(){\n\t\t\tif(ws) ws.close();\n\t\t}\n\t</script>\n</head>\n<body>\n\t<h2>WebSocket test</h2>\n</body>\n\nJava Code:\n\nimport java.io.IOException;\nimport java.util.Iterator;\nimport java.util.concurrent.atomic.AtomicInteger;\n\nimport javax.websocket.MessageHandler;\nimport javax.websocket.OnClose;\nimport javax.websocket.OnError;\nimport javax.websocket.OnOpen;\nimport javax.websocket.Session;\nimport javax.websocket.server.ServerEndpoint;\n\nimport org.apache.tomcat.websocket.WsSession;\n\n\n@ServerEndpoint(value = \"/ws\")\npublic class MyWebsocket {\n    private static final AtomicInteger count  = new AtomicInteger (0);\n    @OnOpen\n    public void wsOpen(Session session){\n        WsSession s = (WsSession) session;\n        int c = count.incrementAndGet();\n        System.out.println(\"WS Opened \" + c);\n    }\n    \n    @OnError\n    public void wsError(Session session, Throwable t){\n        System.out.println(\"WS Error \");\n        try {\n            WsSession s = (WsSession) session;\n            s.close();\n        } catch (IOException e) {}\n    }\n    \n    @OnClose\n    public void wsClosed(Session session){\n        int c = count.decrementAndGet();\n        System.out.println(\"WS Closed \" + c);\n        try {\n            session.close();\n        } catch (IOException e) {}\n    }\n}"}, {"attachment_id": null, "tags": [], "bug_id": 59659, "text": "Thanks for the report. This was introduced in the connector refactoring so 8.0.x and earlier are not affected.\n\nIt has been fixed in 9.0.x for 9.0.0.M7 onwards and 8.5.x for 8.5.3 onwards.", "count": 1, "id": 191424, "time": "2016-06-06T16:30:00Z", "creator": "markt@apache.org", "creation_time": "2016-06-06T16:30:00Z", "is_private": false}]