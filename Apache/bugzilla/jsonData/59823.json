[{"count": 0, "tags": [], "creator": "arjan.tijms@gmail.com", "attachment_id": null, "text": "When a JASPIC SAM is (programmatically) installed and subsequently HttpServletRequest#authenticate() is called the SAM is not actually being invoked.\n\nAccording to 3.9.3 of the JASPIC 1.1 spec the SAM should be invoked.\n\nI added a new test to the Java EE 7 samples project for this: https://github.com/javaee-samples/javaee7-samples/tree/master/jaspic/programmatic-authentication\n\nTo reproduce:\n\n* Deploy .war in submodule to Tomcat 9.0.0.M8\n* Request http://localhost:8080/jaspic-programmatic-authentication/public/authenticate\n\nThe result is:\n\nThis is a public servlet \nbefore web username: null\nbefore web user has role \"architect\": false\nrequest.authenticate outcome: false\nafter web username: null\nafter web user has role \"architect\": false\n\nBut should be:\n\nThis is a public servlet \nbefore web username: null\nbefore web user has role \"architect\": false\nrequest.authenticate outcome: true\nafter web username: test\nafter web user has role \"architect\": true", "id": 192217, "time": "2016-07-07T17:12:18Z", "bug_id": 59823, "creation_time": "2016-07-07T17:12:18Z", "is_private": false}, {"count": 1, "tags": [], "text": "Thanks for the report. This is fixed in 9.0.x for 9.0.0.M10 onwards and 8.5.x for 8.5.5. onwards.", "attachment_id": null, "bug_id": 59823, "id": 192887, "time": "2016-08-04T16:42:01Z", "creator": "markt@apache.org", "creation_time": "2016-08-04T16:42:01Z", "is_private": false}, {"count": 2, "tags": [], "creator": "arjan.tijms@gmail.com", "attachment_id": null, "is_private": false, "id": 192889, "time": "2016-08-04T17:41:28Z", "bug_id": 59823, "creation_time": "2016-08-04T17:41:28Z", "text": "Thanks for the fix Mark! :)\n\nP.s.\n\nJust wondering, as it's not clearly described in the JASPIC spec at all, but what did you use for the return values of request.authenticate?\n  \nI noticed before that GlassFish returns false when either authentication is in progress (SEND_CONTINUE returned from SAM), authentication failed or the unauthenticated caller principal was set.\n \nJBoss however returns false when authentication is in progress, but throws exception when authentication fails or the unauthenticated caller principal was set.\n\nThe only thing upon which they agree is that true is returned when authentication succeeded (non null caller principal set)."}, {"count": 3, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 192891, "time": "2016-08-04T18:54:10Z", "bug_id": 59823, "creation_time": "2016-08-04T18:54:10Z", "is_private": false, "text": "true if AuthStatus.SUCCESS, otherwise false including AuthException (which is caught and logged)."}, {"count": 4, "text": ">true if AuthStatus.SUCCESS\n\nIs that also when a null is passed to the CallerPrincipalCallback? \n\nSince in that case the container will establish this unauthenticated identity (see http://docs.oracle.com/javaee/7/api/javax/security/auth/message/callback/CallerPrincipalCallback.html). This means HttpServletRequest.getUserPrincipal() will return a null.\n\nBut the JavaDoc for the return value of HttpServletRequest#authenticate says \"true when non-null values were or have been established as the values returned by getUserPrincipal, getRemoteUser, and getAuthType.\"", "creator": "arjan.tijms@gmail.com", "is_private": false, "id": 192933, "time": "2016-08-05T20:46:26Z", "bug_id": 59823, "creation_time": "2016-08-05T20:46:26Z", "tags": [], "attachment_id": null}, {"count": 5, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 193050, "time": "2016-08-11T21:59:17Z", "bug_id": 59823, "creation_time": "2016-08-11T21:59:17Z", "text": "It was. It isn't any more."}, {"count": 6, "tags": [], "creator": "arjan.tijms@gmail.com", "attachment_id": null, "id": 193051, "time": "2016-08-11T22:45:56Z", "bug_id": 59823, "creation_time": "2016-08-11T22:45:56Z", "is_private": false, "text": ">It was. It isn't any more.\n\nGreat! Does it return false now or is an exception thrown? (i.e. does it behave like GlassFish or like JBoss?)\n\nJBoss' behaviour is not because of some kind of bug or oversight btw. Stuart at the time said to have read the Servlet and JASPIC specs multiple times for this case and was convinced it mandated an exception to be thrown when a null principal was set."}, {"count": 7, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 193063, "time": "2016-08-12T08:41:29Z", "bug_id": 59823, "creation_time": "2016-08-12T08:41:29Z", "is_private": false, "text": "It returns false."}, {"count": 8, "tags": [], "creator": "arjan.tijms@gmail.com", "is_private": false, "text": ">It returns false.\n\nOk thanks ;)\n\nI'll start a topic for this on the Servlet/JASPIC mailing lists, see if the outcome requirements can be clarified. For now I can't add a test for this either since I'm not 100% sure what the outcome should be.", "id": 193064, "time": "2016-08-12T08:47:36Z", "bug_id": 59823, "creation_time": "2016-08-12T08:47:36Z", "attachment_id": null}]