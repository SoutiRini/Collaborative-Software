[{"count": 0, "tags": [], "text": "Client -> Proxy -> WebServer without client auth = OK\nClient -> Proxy -> WebServer with client auth & SSLProxyMachineCertificateFile =KO\n\nApache compiled fron sources:\n./configure --prefix=/usr/local/apache2 --enable-module=most --enable-shared=max --enable-rewrite --enable-unique-id --enable-proxy-http --enable-proxy --enable-proxy-connect --enable-ssl\n\nServer version: Apache/2.2.24 (Unix)\nServer built:   Mar 14 2013 17:46:34\nServer's Module Magic Number: 20051115:31\nServer loaded:  APR 1.4.2, APR-Util 1.3.9\nCompiled using: APR 1.4.2, APR-Util 1.3.9\nArchitecture:   32-bit\nServer MPM:     Prefork\n  threaded:     no\n    forked:     yes (variable process count)\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"/usr/local/apache2\"\n -D SUEXEC_BIN=\"/usr/local/apache2/bin/suexec\"\n -D DEFAULT_PIDLOG=\"logs/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_LOCKFILE=\"logs/accept.lock\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"\n\nroot# ldd /usr/local/apache2/bin/httpd\n    linux-gate.so.1 =>  (0xb7771000)\n    libssl.so.0.9.8 => /usr/lib/i686/cmov/libssl.so.0.9.8 (0xb771f000)\n    libcrypto.so.0.9.8 => /usr/lib/i686/cmov/libcrypto.so.0.9.8 (0xb75c7000)\n    libm.so.6 => /lib/libm.so.6 (0xb75a0000)\n    libaprutil-1.so.0 => /usr/lib/libaprutil-1.so.0 (0xb7580000)\n    libdb-4.8.so => /usr/lib/libdb-4.8.so (0xb741a000)\n    libapr-1.so.0 => /usr/lib/libapr-1.so.0 (0xb73ec000)\n    libpthread.so.0 => /lib/libpthread.so.0 (0xb73d3000)\n    libc.so.6 => /lib/libc.so.6 (0xb728e000)\n    libdl.so.2 => /lib/libdl.so.2 (0xb7289000)\n    libz.so.1 => /usr/lib/libz.so.1 (0xb7275000)\n    /lib/ld-linux.so.2 (0xb7772000)\n    libuuid.so.1 => /lib/libuuid.so.1 (0xb7271000)\n    librt.so.1 => /lib/librt.so.1 (0xb7268000)\n    libcrypt.so.1 => /lib/libcrypt.so.1 (0xb7236000)\n    libexpat.so.1 => /usr/lib/libexpat.so.1 (0xb720f000)\n\n\nError Log\n[Thu Mar 14 18:45:22 2013] [info] mod_unique_id: using ip addr 192.168.0.77\n[Thu Mar 14 18:45:23 2013] [info] Init: Seeding PRNG with 136 bytes of entropy\n[Thu Mar 14 18:45:23 2013] [info] Loading certificate & private key of SSL-aware server\n[Thu Mar 14 18:45:23 2013] [debug] ssl_engine_pphrase.c(470): unencrypted RSA private key - pass phrase not required\n[Thu Mar 14 18:45:23 2013] [info] Init: Generating temporary RSA private keys (512/1024 bits)\n[Thu Mar 14 18:45:23 2013] [info] Init: Generating temporary DH parameters (512/1024 bits)\n[Thu Mar 14 18:45:23 2013] [info] Init: Initializing (virtual) servers for SSL\n[Thu Mar 14 18:45:23 2013] [info] Configuring server for SSL protocol\n[Thu Mar 14 18:45:23 2013] [debug] ssl_engine_init.c(471): Creating new SSL context (protocols: SSLv3, TLSv1)\n[Thu Mar 14 18:45:23 2013] [debug] ssl_engine_init.c(706): Configuring permitted SSL ciphers [HIGH:MEDIUM:!aNULL:!MD5]\n[Thu Mar 14 18:45:23 2013] [debug] ssl_engine_init.c(420): Configuring TLS extension handling\n[Thu Mar 14 18:45:23 2013] [debug] ssl_engine_init.c(837): Configuring RSA server certificate\n[Thu Mar 14 18:45:23 2013] [warn] RSA server certificate CommonName (CN) `proxy.company.com' does NOT match server name!?\n[Thu Mar 14 18:45:23 2013] [debug] ssl_engine_init.c(876): Configuring RSA server private key\n[Thu Mar 14 18:45:23 2013] [info] mod_ssl/2.2.24 compiled against Server: Apache/2.2.24, Library: OpenSSL/0.9.8o\n[Thu Mar 14 18:45:23 2013] [info] mod_unique_id: using ip addr 192.168.0.77\n[Thu Mar 14 18:45:24 2013] [info] Init: Seeding PRNG with 136 bytes of entropy\n[Thu Mar 14 18:45:24 2013] [info] Loading certificate & private key of SSL-aware server\n[Thu Mar 14 18:45:24 2013] [debug] ssl_engine_pphrase.c(470): unencrypted RSA private key - pass phrase not required\n[Thu Mar 14 18:45:24 2013] [info] Init: Generating temporary RSA private keys (512/1024 bits)\n[Thu Mar 14 18:45:24 2013] [info] Init: Generating temporary DH parameters (512/1024 bits)\n[Thu Mar 14 18:45:24 2013] [debug] ssl_scache_shmcb.c(253): shmcb_init allocated 512000 bytes of shared memory\n[Thu Mar 14 18:45:24 2013] [debug] ssl_scache_shmcb.c(272): for 511952 bytes (512000 including header), recommending 32 subcaches, 133 indexes each\n[Thu Mar 14 18:45:24 2013] [debug] ssl_scache_shmcb.c(306): shmcb_init_memory choices follow\n[Thu Mar 14 18:45:24 2013] [debug] ssl_scache_shmcb.c(308): subcache_num = 32\n[Thu Mar 14 18:45:24 2013] [debug] ssl_scache_shmcb.c(310): subcache_size = 15996\n[Thu Mar 14 18:45:24 2013] [debug] ssl_scache_shmcb.c(312): subcache_data_offset = 2144\n[Thu Mar 14 18:45:24 2013] [debug] ssl_scache_shmcb.c(314): subcache_data_size = 13852\n[Thu Mar 14 18:45:24 2013] [debug] ssl_scache_shmcb.c(316): index_num = 133\n[Thu Mar 14 18:45:24 2013] [info] Shared memory session cache initialised\n[Thu Mar 14 18:45:24 2013] [info] Init: Initializing (virtual) servers for SSL\n[Thu Mar 14 18:45:24 2013] [info] Configuring server for SSL protocol\n[Thu Mar 14 18:45:24 2013] [debug] ssl_engine_init.c(471): Creating new SSL context (protocols: SSLv3, TLSv1)\n[Thu Mar 14 18:45:24 2013] [debug] ssl_engine_init.c(706): Configuring permitted SSL ciphers [HIGH:MEDIUM:!aNULL:!MD5]\n[Thu Mar 14 18:45:24 2013] [debug] ssl_engine_init.c(420): Configuring TLS extension handling\n[Thu Mar 14 18:45:24 2013] [debug] ssl_engine_init.c(837): Configuring RSA server certificate\n[Thu Mar 14 18:45:24 2013] [warn] RSA server certificate CommonName (CN) `proxy.company.com' does NOT match server name!?\n[Thu Mar 14 18:45:24 2013] [debug] ssl_engine_init.c(876): Configuring RSA server private key\n[Thu Mar 14 18:45:24 2013] [info] mod_ssl/2.2.24 compiled against Server: Apache/2.2.24, Library: OpenSSL/0.9.8o\n[Thu Mar 14 18:45:24 2013] [warn] pid file /usr/local/apache2/logs/httpd.pid overwritten -- Unclean shutdown of previous Apache run?\n[Thu Mar 14 18:45:24 2013] [debug] proxy_util.c(1820): proxy: grabbed scoreboard slot 1 in child 5507 for worker proxy:reverse\n[Thu Mar 14 18:45:24 2013] [debug] proxy_util.c(1936): proxy: initialized single connection worker 1 in child 5507 for (*)\n[Thu Mar 14 18:45:24 2013] [notice] Apache/2.2.24 (Unix) mod_ssl/2.2.24 OpenSSL/0.9.8o configured -- resuming normal operations\n[Thu Mar 14 18:45:24 2013] [info] Server built: Mar 14 2013 17:46:34\n[Thu Mar 14 18:45:24 2013] [debug] prefork.c(1023): AcceptMutex: sysvsem (default: sysvsem)\n[Thu Mar 14 18:45:24 2013] [debug] proxy_util.c(1820): proxy: grabbed scoreboard slot 1 in child 5509 for worker proxy:reverse\n[Thu Mar 14 18:45:24 2013] [debug] proxy_util.c(1839): proxy: worker proxy:reverse already initialized\n[Thu Mar 14 18:45:24 2013] [debug] proxy_util.c(1820): proxy: grabbed scoreboard slot 1 in child 5510 for worker proxy:reverse\n[Thu Mar 14 18:45:24 2013] [debug] proxy_util.c(1839): proxy: worker proxy:reverse already initialized\n[Thu Mar 14 18:45:24 2013] [debug] proxy_util.c(1936): proxy: initialized single connection worker 1 in child 5509 for (*)\n[Thu Mar 14 18:45:24 2013] [debug] proxy_util.c(1936): proxy: initialized single connection worker 1 in child 5510 for (*)\n[Thu Mar 14 18:45:24 2013] [debug] proxy_util.c(1820): proxy: grabbed scoreboard slot 1 in child 5511 for worker proxy:reverse\n[Thu Mar 14 18:45:24 2013] [debug] proxy_util.c(1820): proxy: grabbed scoreboard slot 1 in child 5508 for worker proxy:reverse\n[Thu Mar 14 18:45:24 2013] [debug] proxy_util.c(1839): proxy: worker proxy:reverse already initialized\n[Thu Mar 14 18:45:24 2013] [debug] proxy_util.c(1839): proxy: worker proxy:reverse already initialized\n[Thu Mar 14 18:45:24 2013] [debug] proxy_util.c(1936): proxy: initialized single connection worker 1 in child 5511 for (*)\n[Thu Mar 14 18:45:24 2013] [debug] proxy_util.c(1936): proxy: initialized single connection worker 1 in child 5508 for (*)\n[Thu Mar 14 18:45:35 2013] [debug] proxy_util.c(1820): proxy: grabbed scoreboard slot 1 in child 5514 for worker proxy:reverse\n[Thu Mar 14 18:45:35 2013] [debug] proxy_util.c(1839): proxy: worker proxy:reverse already initialized\n[Thu Mar 14 18:45:35 2013] [debug] proxy_util.c(1936): proxy: initialized single connection worker 1 in child 5514 for (*)\n[Thu Mar 14 18:45:41 2013] [notice] child pid 5510 exit signal Segmentation fault (11)\n\n(gdb) backtrace\n#0  0xb7ef6ff8 in EVP_PKEY_cmp () from /usr/lib/i686/cmov/libcrypto.so.0.9.8\n#1  0xb7f21cb6 in X509_check_private_key () from /usr/lib/i686/cmov/libcrypto.so.0.9.8\n#2  0xb7fcd1ed in ?? () from /usr/lib/i686/cmov/libssl.so.0.9.8\n#3  0xb7fa9150 in ssl3_send_client_certificate () from /usr/lib/i686/cmov/libssl.so.0.9.8\n#4  0xb7facb37 in ssl3_connect () from /usr/lib/i686/cmov/libssl.so.0.9.8\n#5  0xb7fc424a in SSL_connect () from /usr/lib/i686/cmov/libssl.so.0.9.8\n#6  0xb7fb5b33 in ssl23_connect () from /usr/lib/i686/cmov/libssl.so.0.9.8\n#7  0xb7fc424a in SSL_connect () from /usr/lib/i686/cmov/libssl.so.0.9.8\n#8  0x080c8043 in ssl_io_filter_connect ()\n#9  0x080c8d35 in ssl_io_filter_output ()\n#10 0x08093466 in ap_pass_brigade ()\n#11 0x080b402e in pass_brigade ()\n#12 0x080b483c in stream_reqbody_cl ()\n#13 0x080b5ec5 in ap_proxy_http_request ()\n#14 0x080b7b82 in proxy_http_handler ()\n#15 0x080a7fd0 in proxy_run_scheme_handler ()\n#16 0x080a4d7a in proxy_handler ()\n#17 0x08087497 in ap_run_handler ()\n#18 0x08087bc2 in ap_invoke_handler ()\n#19 0x080dc0d2 in ap_process_request ()\n#20 0x080d90e5 in ap_process_http_connection ()\n#21 0x0808f477 in ap_run_process_connection ()\n#22 0x0808f88b in ap_process_connection ()\n#23 0x080fdc32 in child_main ()\n#24 0x080fdd33 in make_child ()\n#25 0x080fe2ce in ap_mpm_run ()\n#26 0x08071239 in main ()\n\nThanks for help,\nTell me if you want more.\nAlain", "attachment_id": null, "id": 165845, "creator": "alain@coreit.fr", "time": "2013-03-14T18:08:46Z", "bug_id": 54698, "creation_time": "2013-03-14T18:08:46Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 54698, "attachment_id": null, "text": "What are the contents of the file referenced by SSLProxyMachineCertificateFile? Does the private key appear before the certificate? If so, it might be the same issue as reported in bug 52212 (which hasn't been backported to 2.2.x yet, but as a workaround, you can swap the order of the private key and the cert in the SSLProxyMachineCertificateFile).", "id": 165879, "time": "2013-03-16T07:38:53Z", "creator": "asfbugz@velox.ch", "creation_time": "2013-03-16T07:38:53Z", "is_private": false}, {"count": 2, "tags": [], "creator": "alain@coreit.fr", "attachment_id": null, "id": 165885, "time": "2013-03-17T06:09:10Z", "bug_id": 54698, "creation_time": "2013-03-17T06:09:10Z", "is_private": false, "text": "Thank you for the answer, this issue was solved by users forum, this is because of passphrase on private key.\n\nOn documentation, this is written:\nCurrently there is no support for encrypted private keys\n\nWas not clear for me, may be you could add \"private key with passphrase are not supported\" as it is usually described.\n\nThanks, you can close.\nAlain"}, {"count": 3, "tags": [], "text": "(In reply to comment #2)\n> Thank you for the answer, this issue was solved by users forum, this is\n> because of passphrase on private key.\n\nAre you sure that this was the only/real cause of the problem? There's actually code which should detect encrypted private keys (see bug 24030 and http://svn.apache.org/viewvc/httpd/httpd/branches/2.2.x/modules/ssl/ssl_engine_init.c?r1=101154&r2=101878).\n\nIn your particular case, was the private key encrypted *and* appearing before the cert? (That would make it a duplicate of bug 52212, then.)", "attachment_id": null, "id": 165886, "creator": "asfbugz@velox.ch", "time": "2013-03-17T07:55:30Z", "bug_id": 54698, "creation_time": "2013-03-17T07:55:30Z", "is_private": false}, {"count": 4, "tags": [], "creator": "alain@coreit.fr", "attachment_id": null, "id": 165887, "time": "2013-03-17T08:36:14Z", "bug_id": 54698, "creation_time": "2013-03-17T08:36:14Z", "is_private": false, "text": "I don't see any duplicate in 24030 or 52212, my environment was:\n- certfile with certificate on top of file and private key at the bottom\n- private key with passphrase\n\nIn your previous message, I understood normally such config does not provide segfault, right?"}, {"count": 5, "tags": [], "text": "(In reply to comment #4)\n> In your previous message, I understood normally such config does not provide\n> segfault, right?\n\nIt should not, yes - the purpose of the fix in r101878 (applied in 2003, i.e. well before 2.2.0 was released in December 2005) was to avoid segfaults in this case... but perhaps it was incomplete (or has become incomplete, due to other changes in mod_ssl over the years).\n\nCan you provide the exact PEM headers/footers (BEGIN/END liens) in the SSLProxyMachineCertificateFile you're using (simply leave out the Base64 encoded stuff).", "attachment_id": null, "id": 165889, "creator": "asfbugz@velox.ch", "time": "2013-03-17T09:12:28Z", "bug_id": 54698, "creation_time": "2013-03-17T09:12:28Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 54698, "attachment_id": null, "text": "I'm not sure I did get you correctly.\n\nBelow are headers in the file:\n-----BEGIN CERTIFICATE-----\n.............\n-----END CERTIFICATE-----\n\n-----BEGIN RSA PRIVATE KEY-----\nProc-Type: 4,ENCRYPTED\nDEK-Info: DES-EDE3-CBC,960B7FA319D6C029\n............\n-----END RSA PRIVATE KEY-----\n\nBelow is the certificate:\nCertificate:\n    Data:\n        Version: 3 (0x2)\n        Serial Number: 118 (0x76)\n        Signature Algorithm: sha1WithRSAEncryption\n        Issuer: C=FR, ST=Is\\xE8re, L=Grenoble, O=companyname, CN=servername.companyname.com/emailAddress=admin@companyname.com\n        Validity\n            Not Before: Mar 15 16:13:37 2013 GMT\n            Not After : Mar 13 16:13:37 2023 GMT\n        Subject: C=FR, ST=Is\\xE8re, L=Grenoble, O=companyname, CN=proxy.companyname.com\n        Subject Public Key Info:\n            Public Key Algorithm: rsaEncryption\n            RSA Public Key: (2048 bit)\n                Modulus (2048 bit):\n                    ..............................\n                Exponent: 65537 (0x10001)\n        X509v3 extensions:\n            X509v3 Basic Constraints: \n                CA:FALSE\n            Netscape Cert Type: \n                SSL Client, S/MIME, Object Signing\n            Netscape Comment: \n                TinyCA Generated Certificate\n            X509v3 Subject Key Identifier: \n                .........................................\n            X509v3 Authority Key Identifier: \n                .........................................\n                DirName:/C=FR/ST=Is\\xE8re/L=Grenoble/O=companyname/CN=servername.companyname.com/emailAddress=admin@companyname.com\n                serial:00\n\n            X509v3 Issuer Alternative Name: \n                <EMPTY>\n\n            X509v3 Subject Alternative Name: \n                email:webmaster.companyname.com\n            X509v3 Key Usage: \n                Digital Signature, Key Encipherment\n    Signature Algorithm: sha1WithRSAEncryption\n        .............................................", "id": 165901, "time": "2013-03-17T15:33:48Z", "creator": "alain@coreit.fr", "creation_time": "2013-03-17T15:33:48Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 54698, "attachment_id": null, "id": 166024, "time": "2013-03-20T06:37:46Z", "creator": "asfbugz@velox.ch", "creation_time": "2013-03-20T06:37:46Z", "is_private": false, "text": "(In reply to comment #6)\n> I'm not sure I did get you correctly.\n> \n> Below are headers in the file:\n\nThanks, this looks fine. I think it's indeed a problem of the fix from 2003 not being complete enough.\n\nCould you try the following patch with 2.2.24?\n\nhttp://svn.apache.org/viewvc/httpd/httpd/trunk/modules/ssl/ssl_engine_init.c?r1=1358168&r2=1375445&view=patch\n\nWith this additional patch, an encrypted private key should no longer cause segfaults when making an SSL proxy connection with client auth, but instead fail at startup with an \"incomplete client cert configured for SSL proxy (missing or encrypted private key?)\" message.\n\nBased on whether your tests are successful, I would then propose this patch for backporting to 2.2.x (and 2.4.x)."}, {"count": 8, "tags": [], "bug_id": 54698, "attachment_id": null, "text": "Compilation failed:\n...................\n/usr/share/apr-1.0/build/libtool --silent --mode=compile i486-linux-gnu-gcc -pthread    -D_REENTRANT -D_GNU_SOURCE -D_LARGEFILE64_SOURCE    -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/srclib/pcre -I. -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/os/unix -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/server/mpm/prefork -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/http -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/filters -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/proxy -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/include -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/generators -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/mappers -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/database -I/usr/include/apr-1.0 -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/proxy/../generators -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/ssl -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/dav/main  -prefer-non-pic -static -c ssl_engine_dh.c && touch ssl_engine_dh.lo\n/usr/share/apr-1.0/build/libtool --silent --mode=compile i486-linux-gnu-gcc -pthread    -D_REENTRANT -D_GNU_SOURCE -D_LARGEFILE64_SOURCE    -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/srclib/pcre -I. -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/os/unix -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/server/mpm/prefork -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/http -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/filters -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/proxy -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/include -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/generators -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/mappers -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/database -I/usr/include/apr-1.0 -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/proxy/../generators -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/ssl -I/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/dav/main  -prefer-non-pic -static -c ssl_engine_init.c && touch ssl_engine_init.lo\nssl_engine_init.c: In function \u2018ssl_init_proxy_certs\u2019:\nssl_engine_init.c:1064: error: \u2018SSLLOG_MARK\u2019 undeclared (first use in this function)\nssl_engine_init.c:1064: error: (Each undeclared identifier is reported only once\nssl_engine_init.c:1064: error: for each function it appears in.)\nssl_engine_init.c:1065: error: expected \u2018)\u2019 before string constant\nssl_engine_init.c:1067: warning: passing argument 3 of \u2018ssl_log_ssl_error\u2019 makes integer from pointer without a cast\nssl_private.h:728: note: expected \u2018int\u2019 but argument is of type \u2018struct server_rec *\u2019\nssl_engine_init.c:1067: error: too few arguments to function \u2018ssl_log_ssl_error\u2019\nssl_engine_init.c:1068: error: too many arguments to function \u2018ssl_die\u2019\nmake[3]: *** [ssl_engine_init.lo] Error 1\nmake[3]: Leaving directory `/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/ssl'\nmake[2]: *** [install-recursive] Error 1\nmake[2]: Leaving directory `/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules/ssl'\nmake[1]: *** [install-recursive] Error 1\nmake[1]: Leaving directory `/root/httpd-2.2.24-PATCH/httpd-2.2.24/modules'\nmake: *** [install-recursive] Error 1\n\nI verified the patch, looks good:\ndiff -u /root/httpd-2.2.24/modules/ssl/ssl_engine_init.c ssl_engine_init.c\n--- /root/httpd-2.2.24/modules/ssl/ssl_engine_init.c\t2012-10-07 08:39:16.000000000 +0200\n+++ ssl_engine_init.c\t2013-03-20 19:39:48.000000000 +0100\n@@ -1051,7 +1051,7 @@\n     for (n = 0; n < ncerts; n++) {\n         X509_INFO *inf = sk_X509_INFO_value(sk, n);\n \n-        if (!inf->x509 || !inf->x_pkey) {\n+        if (!inf->x509 || !inf->x_pkey || !inf->x_pkey->dec_pkey) {\n             sk_X509_INFO_free(sk);\n             ap_log_error(APLOG_MARK, APLOG_STARTUP, 0, s,\n                          \"incomplete client cert configured for SSL proxy \"\n@@ -1059,6 +1059,15 @@\n             ssl_die();\n             return;\n         }\n+        \n+        if (X509_check_private_key(inf->x509, inf->x_pkey->dec_pkey) != 1) {\n+            ssl_log_xerror(SSLLOG_MARK, APLOG_STARTUP, 0, ptemp, s, inf->x509,\n+                           APLOGNO(02326) \"proxy client certificate and \"\n+                           \"private key do not match\");\n+            ssl_log_ssl_error(SSLLOG_MARK, APLOG_ERR, s);\n+            ssl_die(s);\n+            return;\n+        }\n     }\n \n     ap_log_error(APLOG_MARK, APLOG_DEBUG, 0, s,\n@@ -1070,7 +1079,11 @@\n         return;\n     }\n \n-    /* Load all of the CA certs and construct a chain */\n+    /* If SSLProxyMachineCertificateChainFile is configured, load all\n+     * the CA certs and have OpenSSL attempt to construct a full chain\n+     * from each configured end-entity cert up to a root.  This will\n+     * allow selection of the correct cert given a list of root CA\n+     * names in the certificate request from the server.  */\n     pkp->ca_certs = (STACK_OF(X509) **) apr_pcalloc(p, ncerts * sizeof(sk));\n     sctx = X509_STORE_CTX_new();", "id": 166042, "time": "2013-03-20T18:51:29Z", "creator": "alain@coreit.fr", "creation_time": "2013-03-20T18:51:29Z", "is_private": false}, {"count": 9, "tags": [], "text": "Created attachment 30091\n2.2.x backport of the fixes from PR 52212\n\n(In reply to comment #8)\n> I verified the patch, looks good:\n\nMy bad, sorry. 2.2 doesn't have ssl_log_xerror etc. Can you try the patch I'm just attaching now instead?\n\nIt would also be interesting to test what happens when you put a deliberately \"wrong\" private key into the file (i.e., one which doesn't match the cert's public key).", "attachment_id": 30091, "id": 166068, "creator": "asfbugz@velox.ch", "time": "2013-03-21T05:47:16Z", "bug_id": 54698, "creation_time": "2013-03-21T05:47:16Z", "is_private": false}, {"count": 10, "tags": [], "creator": "alain@coreit.fr", "attachment_id": null, "id": 166119, "time": "2013-03-24T05:42:09Z", "bug_id": 54698, "creation_time": "2013-03-24T05:42:09Z", "is_private": false, "text": "looks better. Thanks.\n\n1st case: Cert and key do not match\n\n[Sat Mar 23 08:03:38 2013] [debug] ssl_engine_init.c(876): Configuring RSA server private key\n[Sat Mar 23 08:03:38 2013] [debug] ssl_engine_init.c(471): Creating new SSL context (protocols: SSLv2, SSLv3, TLSv1)\nproxy client certificate and private key do not match\n[Sat Mar 23 08:03:38 2013] [error] SSL Library Error: 185073780 error:0B080074:x509 certificate routines:X509_check_private_key:key values mismatch\n\n2nd case: Cert and key with pass\n\n[Sat Mar 23 08:27:37 2013] [info] [client 192.168.0.53] SSL Proxy connect failed\n[Sat Mar 23 08:27:37 2013] [info] SSL Library Error: 336151571 error:14094413:SSL routines:SSL3_READ_BYTES:sslv3 alert unsupported certificate\n[Sat Mar 23 08:27:37 2013] [info] [client 192.168.0.53] Connection closed to child 0 with abortive shutdown (server servername.companyname.com:443)\n[Sat Mar 23 08:27:37 2013] [info] [client 10.8.0.10] Connection closed to child 1 with standard shutdown (server servername.companyname.com:443)"}, {"count": 11, "tags": [], "bug_id": 54698, "attachment_id": null, "text": "(In reply to comment #10)\n\nThanks for your tests.\n\n> 2nd case: Cert and key with pass\n> \n> [Sat Mar 23 08:27:37 2013] [info] [client 192.168.0.53] SSL Proxy connect\n> failed\n> [Sat Mar 23 08:27:37 2013] [info] SSL Library Error: 336151571\n> error:14094413:SSL routines:SSL3_READ_BYTES:sslv3 alert unsupported\n> certificate\n> [Sat Mar 23 08:27:37 2013] [info] [client 192.168.0.53] Connection closed to\n> child 0 with abortive shutdown (server servername.companyname.com:443)\n> [Sat Mar 23 08:27:37 2013] [info] [client 10.8.0.10] Connection closed to\n> child 1 with standard shutdown (server servername.companyname.com:443)\n\nThis is a bit puzzling - I was expecting a somewhat different behavior... is there no log message saying \"incomplete client cert configured for SSL proxy (missing or encrypted private key?)\" when you are starting/restarting httpd with a passphrase-protected private key?", "id": 166125, "time": "2013-03-24T12:55:16Z", "creator": "asfbugz@velox.ch", "creation_time": "2013-03-24T12:55:16Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 54698, "attachment_id": 30108, "text": "Created attachment 30108\nApache Debug Log\n\n when private key is pass protected and with patch applied", "id": 166186, "time": "2013-03-27T21:20:47Z", "creator": "alain@coreit.fr", "creation_time": "2013-03-27T21:20:47Z", "is_private": false}, {"count": 13, "tags": [], "text": "Sorry my comment disappeared from previous message, here it is:\n\nThis is the Debug log Apache on the proxy.\n\nproxy.companyname.com = 192.168.0.77 = proxy apache\nservername.companyname.com = 192.168.0.53 = web server", "attachment_id": null, "id": 166187, "creator": "alain@coreit.fr", "time": "2013-03-27T21:24:34Z", "bug_id": 54698, "creation_time": "2013-03-27T21:24:34Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 54698, "attachment_id": 30138, "text": "Created attachment 30138\n2.2.x backport of the fixes from PR 52212, amended\n\n(In reply to comment #12)\n> Created attachment 30108 [details]\n> Apache Debug Log\n> \n>  when private key is pass protected and with patch applied\n\nThanks, meanwhile I found that the check(s) for an encrypted private key are not sufficient for OpenSSL 0.9.8 - I'm attaching an updated patch. Would you mind testing the following combinations with this version of the patch?\n\na) with encrypted (i.e. passphrase-protected) private key\n\nb) with non-matching private key\n\nc) with unencrypted, matching private key\n\nWith a) and b), httpd should now fail to start/restart.", "id": 166348, "time": "2013-04-03T06:53:38Z", "creator": "asfbugz@velox.ch", "creation_time": "2013-04-03T06:53:38Z", "is_private": false}, {"count": 15, "tags": [], "bug_id": 54698, "attachment_id": 30180, "text": "Created attachment 30180\nproxy-error.log_wrong-private-key\n\nPR54698_2.2.x_v2.patch\n-> apache proxy log when cert with wrong private key and", "id": 166540, "time": "2013-04-11T21:03:51Z", "creator": "alain@coreit.fr", "creation_time": "2013-04-11T21:03:51Z", "is_private": false}, {"count": 16, "tags": [], "text": "Created attachment 30181\nproxy-error.log_cert-with-keypass\n\nPR54698_2.2.x_v2.patch\n-> apache proxy log when cert with key pass", "attachment_id": 30181, "id": 166541, "creator": "alain@coreit.fr", "time": "2013-04-11T21:06:05Z", "bug_id": 54698, "creation_time": "2013-04-11T21:06:05Z", "is_private": false}, {"count": 17, "tags": [], "bug_id": 54698, "attachment_id": null, "text": "Thanks for the patch,\nbelow are my tests:\n\na) with encrypted (i.e. passphrase-protected) private key\n-> see attached log  proxy-error.log_cert-with-keypass\n-> I don't agree, apache didn't fail to start ... or did I mismix the keys ???\n\nb) with non-matching private key\n-> see attached log   proxy-error.log_wrong-private-key\n-> I agree, apache failed to start\n\nc) with unencrypted, matching private key\n-> OK, no log provided", "id": 166542, "time": "2013-04-11T21:11:01Z", "creator": "alain@coreit.fr", "creation_time": "2013-04-11T21:11:01Z", "is_private": false}, {"count": 18, "tags": [], "bug_id": 54698, "attachment_id": null, "text": "(In reply to comment #17)\n> below are my tests:\n> \n> a) with encrypted (i.e. passphrase-protected) private key\n> -> see attached log  proxy-error.log_cert-with-keypass\n> -> I don't agree, apache didn't fail to start ... or did I mismix the keys\n> ???\n\nThis is strange... you are using an encrypted key in the format shown in comment 6, is that correct?\n\nAre you sure that patch v2 applied cleanly? Specifically, in ssl_engine_init.c, do lines 1054 ff. look like this?\n\n        if (!inf->x509 || !inf->x_pkey || !inf->x_pkey->dec_pkey ||\n            inf->enc_data) {\n            sk_X509_INFO_free(sk);\n            ap_log_error(APLOG_MARK, APLOG_STARTUP, 0, s,\n                         \"incomplete client cert configured for SSL proxy \"\n                         \"(missing or encrypted private key?)\");\n\n(note the line with \"inf->enc_data\")", "id": 166546, "time": "2013-04-12T05:06:09Z", "creator": "asfbugz@velox.ch", "creation_time": "2013-04-12T05:06:09Z", "is_private": false}, {"count": 19, "tags": [], "bug_id": 54698, "attachment_id": null, "id": 166547, "time": "2013-04-12T06:33:00Z", "creator": "alain@coreit.fr", "creation_time": "2013-04-12T06:33:00Z", "is_private": false, "text": "Yes, I am using key like in comment 6\nYes, I verified, patch is applied correctly\n\nI will recheck, maybe I mixed the keys. I will regenerate keys and retest. Waiting for non working hours to do the test."}, {"count": 20, "tags": [], "bug_id": 54698, "attachment_id": null, "text": "Sorry, you were right, apache server does not start in the case of pass phrase protection, below is the error_log of the proxy. I guess I mixed the keys in the previous test.\n\n[Sat Apr 13 07:24:04 2013] [info] mod_unique_id: using ip addr 192.168.0.77\n[Sat Apr 13 07:24:05 2013] [info] Init: Seeding PRNG with 136 bytes of entropy\n[Sat Apr 13 07:24:05 2013] [info] Loading certificate & private key of SSL-aware server\n[Sat Apr 13 07:24:05 2013] [debug] ssl_engine_pphrase.c(470): unencrypted RSA private key - pass phrase not required\n[Sat Apr 13 07:24:05 2013] [info] Init: Generating temporary RSA private keys (512/1024 bits)\n[Sat Apr 13 07:24:05 2013] [info] Init: Generating temporary DH parameters (512/1024 bits)\n[Sat Apr 13 07:24:05 2013] [info] Init: Initializing (virtual) servers for SSL\n[Sat Apr 13 07:24:05 2013] [debug] ssl_engine_init.c(471): Creating new SSL context (protocols: SSLv2, SSLv3, TLSv1)\nincomplete client cert configured for SSL proxy (missing or encrypted private key?)", "id": 166564, "time": "2013-04-13T05:30:33Z", "creator": "alain@coreit.fr", "creation_time": "2013-04-13T05:30:33Z", "is_private": false}, {"count": 21, "tags": [], "bug_id": 54698, "attachment_id": null, "text": "Thanks for verifying.\n\nFix committed to trunk with r1467593.\n\nBackports for 2.2.x and 2.4.x (including fixes for PR 52212, see comment 1) proposed with r1467594.", "id": 166571, "time": "2013-04-13T11:30:45Z", "creator": "asfbugz@velox.ch", "creation_time": "2013-04-13T11:30:45Z", "is_private": false}, {"count": 22, "tags": [], "bug_id": 54698, "attachment_id": null, "text": "Commit for 2.4.x: r1476685. To appear in 2.4.5.", "id": 166986, "time": "2013-05-01T06:20:46Z", "creator": "asfbugz@velox.ch", "creation_time": "2013-05-01T06:20:46Z", "is_private": false}, {"count": 23, "tags": [], "text": "Fixed in 2.4.6 and 2.2.25, respectively.", "attachment_id": null, "id": 170266, "creator": "asfbugz@velox.ch", "time": "2013-09-25T13:14:06Z", "bug_id": 54698, "creation_time": "2013-09-25T13:14:06Z", "is_private": false}]