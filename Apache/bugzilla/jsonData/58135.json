[{"count": 0, "tags": [], "text": "Created attachment 32903\nerror.log at debug level\n\nI have a python script which generates dynamic web pages and I want to use mod_cache (and mod_cache_disk) to speed up the access to this page. The python program uses the \"If-Modified-Since\", \"Last-Modified\" and the \"Cache-Control\" headers. Revalidation is very fast for the python program, therefore I set the response header\n\"Cache-Control\" to  \"must-revalidate, max-age=5\".\n\nmod_cache works as expected as long as the client does not send itself the \"If-Modified-Since\" header. In my tests below, mod_cache has cached version of an URL (Last-Modified: Mon, 13 Jul 2015 07:33:49 GMT). The client tries the revalidate a stale version (If-Modified-Since: Thu, 09 Jul 2015 20:26:45 GMT). The problem is that mod_cache ask to the python script if the version from the 9 July can be revalidate (instead of its own more recent version from the 13 July).\n\nIn my set-up, the client always send the \"If-Modified-Since\" header and therefore the cached version from mod_cache is (almost) never used. I am wondering if mod_cache should not try to revalidate to most recent version (either from client or from cache).\n\nI have tried apache 2.4.10 and 2.4.12 (in a docker container based on ubuntu 15.04). The tests I made were performed inside the container. For what is worth, I include my configurations files (cache_disk.conf and 000-default.conf).\n\nAny help would be greatly appreciated.\n\n\n\n\n## empty cache\n# htcacheclean  -p /var/cache/apache2/mod_cache_disk -r -l 1                                                 \n\n## verify that cache is empty\n# htcacheclean  -p /var/cache/apache2/mod_cache_disk -A     \n\n## make first request\n# curl --verbose  'http://localhost/Python/web/wms?request=GetCapabilities&service=WMS&version=1.3.0'   > out\n* Connected to localhost (::1) port 80 (#0)\n> GET /Python/web/wms?request=GetCapabilities&service=WMS&version=1.3.0 HTTP/1.1\n> User-Agent: curl/7.38.0\n> Host: localhost\n> Accept: */*\n>\n< HTTP/1.1 200 OK\n< Date: Tue, 14 Jul 2015 06:34:42 GMT\n* Server Apache/2.4.10 (Ubuntu) is not blacklisted\n< Server: Apache/2.4.10 (Ubuntu)\n< Last-Modified: Mon, 13 Jul 2015 07:33:49 GMT\n< Vary: Accept-Encoding\n< X-Cache: MISS from 172.17.1.37\n< X-Cache-Detail: \"cache miss: attempting entity save\" from 172.17.1.37\n< Transfer-Encoding: chunked\n< Content-Type: text/xml\n<\n\n## verify that first request is cached\n# htcacheclean  -p /var/cache/apache2/mod_cache_disk -A                                                      \nhttp://localhost:80/Python/web/wms?request=GetCapabilities&service=WMS&version=1.3.0 422 3697448 200 0 1436855683140502 1436855688140502 1436855682866721 1436855683140502 1 0\n\n## make second request (after 5 seconds)\n# curl --verbose  'http://localhost/Python/web/wms?request=GetCapabilities&service=WMS&version=1.3.0'   > out\n* Hostname was NOT found in DNS cache\n* Connected to localhost (::1) port 80 (#0)\n> GET /Python/web/wms?request=GetCapabilities&service=WMS&version=1.3.0 HTTP/1.1\n> User-Agent: curl/7.38.0\n> Host: localhost\n> Accept: */*\n>\n< HTTP/1.1 200 OK\n< Date: Tue, 14 Jul 2015 06:34:59 GMT\n* Server Apache/2.4.10 (Ubuntu) is not blacklisted\n< Server: Apache/2.4.10 (Ubuntu)\n< Last-Modified: Mon, 13 Jul 2015 07:33:49 GMT\n< Vary: Accept-Encoding\n< Cache-Control: must-revalidate, max-age=5\n< X-Cache: REVALIDATE from 172.17.1.37\n< X-Cache-Detail: \"conditional cache hit: entity refreshed\" from 172.17.1.37\n< Content-Length: 3697448\n< Content-Type: text/xml\n<\n\n## Yah! Cache is revalitated\n\n# htcacheclean  -p /var/cache/apache2/mod_cache_disk -A                                                      \nhttp://localhost:80/Python/web/wms?request=GetCapabilities&service=WMS&version=1.3.0 472 3697448 200 0 1436855699443390 1436855704443390 1436855699441708 1436855699443390 1 0\n\n## Make request when the users sends a \"If-Modified-Since\" header. Client (curl) has a stale copy, but the more recient version of the mod_cache can be revalidated.\n\n# curl --verbose 'http://localhost/Python/web/wms?request=GetCapabilities&service=WMS&version=1.3.0'  -H 'If-Modified-Since: Thu, 09 Jul 2015 20:26:45 GMT' > out\n* Connected to localhost (::1) port 80 (#0)\n> GET /Python/web/wms?request=GetCapabilities&service=WMS&version=1.3.0 HTTP/1.1\n> User-Agent: curl/7.38.0\n> Host: localhost\n> Accept: */*\n> If-Modified-Since: Thu, 09 Jul 2015 20:26:45 GMT\n>\n< HTTP/1.1 200 OK\n< Date: Tue, 14 Jul 2015 06:35:32 GMT\n* Server Apache/2.4.10 (Ubuntu) is not blacklisted\n< Server: Apache/2.4.10 (Ubuntu)\n< Last-Modified: Mon, 13 Jul 2015 07:33:49 GMT\n< Vary: Accept-Encoding\n< X-Cache: MISS from 172.17.1.37\n< X-Cache-Detail: \"cache miss: attempting entity save\" from 172.17.1.37\n< Transfer-Encoding: chunked\n< Content-Type: text/xml\n\n## Unfortunatetly, a cache miss.\n\n\n\nroot@1ce49e006c40:/var/oceanbrowser# cat /etc/apache2/mods-enabled/cache_disk.conf\n<IfModule mod_cache_disk.c>\n   # This path must be the same as the one in /etc/default/apache2\n   CacheRoot /var/cache/apache2/mod_cache_disk\n\n   # Enable the X-Cache header\n   CacheHeader on\n\n   # Enable the X-Cache-Detail header\n   CacheDetailHeader on\n\n   # The maximum size (in bytes) of a document to be placed in the cache\n   # GetCapabilities can be quite large, maximum here is 10 MB\n   CacheMaxFileSize 10000000\n\n   # The result of CacheDirLevels * CacheDirLength must not be higher than\n   # 20. Moreover, pay attention on file system limits. Some file systems\n   # do not support more than a certain number of inodes and\n   # subdirectories (e.g. 32000 for ext3)\n   CacheDirLevels 2\n   CacheDirLength 1\n\n</IfModule>root@1ce49e006c40:/var/oceanbrowser# cat /etc/apache2/sites-enabled/000-default.conf\n<VirtualHost *:80>\n    # The ServerName directive sets the request scheme, hostname and port that\n    # the server uses to identify itself. This is used when creating\n    # redirection URLs. In the context of virtual hosts, the ServerName\n    # specifies what hostname must appear in the request's Host: header to\n    # match this virtual host. For the default virtual host (this file) this\n    # value is not decisive as it is used as a last resort host regardless.\n    # However, you must set it for any further virtual host explicitly.\n    #ServerName www.example.com\n\n    ServerAdmin webmaster@localhost\n    DocumentRoot /var/www\n\n    # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,\n    # error, crit, alert, emerg.\n    # It is also possible to configure the loglevel for particular\n    # modules, e.g.\n    #LogLevel info ssl:warn\n\n    # For debugging\n    LogLevel debug\n\n    ErrorLog ${APACHE_LOG_DIR}/error.log\n    CustomLog ${APACHE_LOG_DIR}/access.log combined\n \n        # Enable cache\n        <IfModule mod_cache.c>\n          CacheEnable disk /\n        </IfModule>\n\n        CustomLog ${APACHE_LOG_DIR}/cache-access.log common\n        CustomLog ${APACHE_LOG_DIR}/cache-cached-requests.log common env=cache-hit\n        CustomLog ${APACHE_LOG_DIR}/cache-uncached-requests.log common env=cache-miss\n        CustomLog ${APACHE_LOG_DIR}/cache-revalidated-requests.log common env=cache-revalidate\n        CustomLog ${APACHE_LOG_DIR}/cache-invalidated-requests.log common env=cache-invalidate\n\n    # For most configuration files from conf-available/, which are\n    # enabled or disabled at a global level, it is possible to\n    # include a line for only one particular virtual host. For example the\n    # following line enables the CGI configuration for this host only\n    # after it has been globally disabled with \"a2disconf\".\n    #Include conf-available/serve-cgi-bin.conf\n\n        <Directory /var/oceanbrowser/apache>\n           Require all granted\n        </Directory>\n\n        WSGIDaemonProcess gher-diva.phys.ulg.ac.be processes=8 threads=15\n        WSGIProcessGroup gher-diva.phys.ulg.ac.be\n        WSGIScriptAlias / /var/oceanbrowser/apache/divaonweb.wsgi\n        WSGIApplicationGroup %{GLOBAL}\n\n</VirtualHost>\n\n# vim: syntax=apache ts=4 sw=4 sts=4 sr noet", "attachment_id": 32903, "bug_id": 58135, "id": 184020, "time": "2015-07-14T12:16:28Z", "creator": "barth.alexander@gmail.com", "creation_time": "2015-07-14T12:16:28Z", "is_private": false}]