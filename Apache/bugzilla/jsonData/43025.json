[{"count": 0, "tags": [], "creator": "Bjorn.Wiberg@uadm.uu.se", "attachment_id": null, "text": "The RETURN_DATUM macro of srclib/apr-util/dbm/apr_dbm_gdbm.c copies the fetched\ndatum structure, which will constitute the \"result\" of a e.g. a GDBM RewriteMap\nlookup.\n\nHowever, no calculations or settings of the dsize member of the apr_datum_t\nstructure appears to be performed or stored!\n\nThis has the following implication:\n\nWhen mod_rewrite's do_expand() calls apr_pstrmemdup() in order to create a\n\"working copy\" of the fetched GDBM value for a key, apr_pstrmemdup() is fed the\ndsize value of the apr_datum_t structure -- which is uninitialized and hence\nincorrect -- potentially causing excessive memory usage.\n\nIn our case, one such rewrite consumes approximately 800 MB of memory because of\nthe bogus dsize value:\n\n---8<---\n(gdb) step\n108     in strings/apr_strings.c\n(gdb) where\n#0  apr_pstrmemdup (a=0x305c9880, s=0x30556d58 \"wiki\", n=808929792)\n    at strings/apr_strings.c:108\n#1  0xd8c945d0 in do_expand (\n    input=0x303cab78 \"${itwiki_pag\\e_\\exists:/|NONE}\", ctx=0x3055e818)\n    at mod_rewrite.c:1308\n#2  0xd8c9557c in apply_rewrite_list (r=0x3055d238, rewriterules=0x303691e0, \n    perdir=0x0) at mod_rewrite.c:3493\n#3  0xd8c96084 in hook_uri2file (r=0x3055d238) at mod_rewrite.c:4225\n#4  0x100226e0 in ap_run_translate_name (r=0x3055d238) at request.c:66\n#5  0x10025678 in ap_process_request_internal (r=0x3055d238) at request.c:141\n#6  0x10038518 in ap_process_request (r=0x3055d238) at http_request.c:256\n#7  0x1003792c in ap_process_http_connection (c=0x3054e110) at http_core.c:184\n#8  0x10034ce8 in ap_run_process_connection (c=0x3054e110) at connection.c:43\n#9  0x1002f240 in child_main (child_num_arg=811374720) at prefork.c:640\n#10 0x1002f458 in make_child (s=0x30003680, slot=0) at prefork.c:680\n#11 0x10030090 in ap_mpm_run (_pconf=0x2ff22884, plog=0x30556d58, s=0x300195c0)\n    at prefork.c:956\n#12 0x100010a4 in main (argc=7, argv=0x2ff22a40) at main.c:717\n--->8---\n\nNotice n=808929792 (bytes). When stepping further, that amount of memory gets\nallocated...\n\n\nSuggested fix: Something along the lines of RETURN_DATUM in\nsrclib/apr-util/dbm/apr_dbm_sdbm.c where dsize gets set. Perhaps:\n\n#define RETURN_DATUM(poutput, rd) (*(poutput) = *(apr_datum_t *)&(rd) ;\n(poutput)->dsize = strlen((poutput)->dptr))\n\n...although you're better at that.\n\nBest regards,\nBj\u00f6rn", "id": 106298, "time": "2007-08-03T08:43:27Z", "bug_id": 43025, "creation_time": "2007-08-03T08:43:27Z", "is_private": false}, {"count": 1, "tags": [], "text": "This is a APR bug in vt_sdbm_fetch, will post a patch soon.", "attachment_id": null, "id": 106301, "creator": "davi@apache.org", "time": "2007-08-03T09:10:03Z", "bug_id": 43025, "creation_time": "2007-08-03T09:10:03Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 43025, "attachment_id": 20590, "id": 106304, "time": "2007-08-03T09:47:02Z", "creator": "davi@apache.org", "creation_time": "2007-08-03T09:47:02Z", "is_private": false, "text": "Created attachment 20590\nThe last two arguments to APR_DBM_FETCH were inverted.\n\nThe last two arguments to APR_DBM_FETCH were inverted, causing the datum of\nthe key to be used as the return datum and vice-versa.\n\nCould you test the attached patch? Thanks."}, {"count": 3, "tags": [], "text": "Please note that it is in the GDBM source code that dsize does not get set, and\nthat it is with GDBM that we have been experiencing problems. So a patch would\nbe needed for apr_db_gdbm.c and its RETURN_DATUM macro (please see my initial\nmessage).\n\nEven though you may have spotted a bug in the SDBM code at the same time. :-)\n\nWe're not using SDBM for the RewriteMaps so I'm afraid we don't have the ability\nto test that map type. I'd be happy to try a corrected version with regard to\nGDBM, though.\n\nMany thanks in advance!\n\nBest regards,\nBj\u00f6rn", "attachment_id": null, "id": 106307, "creator": "Bjorn.Wiberg@uadm.uu.se", "time": "2007-08-03T13:57:39Z", "bug_id": 43025, "creation_time": "2007-08-03T13:57:39Z", "is_private": false}, {"count": 4, "tags": [], "creator": "davi@apache.org", "attachment_id": null, "text": "(In reply to comment #3)\n> Please note that it is in the GDBM source code that dsize does not get set,\n> and that it is with GDBM that we have been experiencing problems.\n\nOk, somehow I saw sdbm, sorry.\n\n> So a patch would be needed for apr_db_gdbm.c and its RETURN_DATUM macro\n> (please see my initial message).\n\nNow I see. But your patch is wrong because the stored data doesn't\nhave to be nul terminated, or it may have nuls in any position.\n\n> Even though you may have spotted a bug in the SDBM code at the same time. :-)\n\nYes, it seems so.", "id": 106308, "time": "2007-08-03T14:18:07Z", "bug_id": 43025, "creation_time": "2007-08-03T14:18:07Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 43025, "text": "Created attachment 20591\nExplicitly copy dptr and dsize fields.\n\nCould you try this patch? Thanks!", "id": 106309, "time": "2007-08-03T14:20:30Z", "creator": "davi@apache.org", "creation_time": "2007-08-03T14:20:30Z", "is_private": false, "attachment_id": 20591}, {"attachment_id": null, "tags": [], "bug_id": 43025, "text": "Upon closer inspection, it appears that APR_DBM_FETCH (in apr_dbm_gdbm.c), which\nexpands to a gdbm_fetch() call, should fill in rd.dsize correctly. Possibly\nsomething strange with the value for the certain key for which we encountered\nproblems -- I think I'll have to investigate that further (probably on Monday). \nI'll try the GDBM patch you supplied, then, too.\n\nPlease stay tuned.\n\nBest regards,\nBj\u00f6rn", "count": 6, "id": 106311, "time": "2007-08-03T15:06:52Z", "creator": "Bjorn.Wiberg@uadm.uu.se", "creation_time": "2007-08-03T15:06:52Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 43025, "attachment_id": null, "id": 106381, "time": "2007-08-06T07:27:29Z", "creator": "Bjorn.Wiberg@uadm.uu.se", "creation_time": "2007-08-06T07:27:29Z", "is_private": false, "text": "Hi again!\n\nI have done some additional debugging. The cause seems to be a type mismatch\nbetween the dsize fields of the apr_datum_t struct (dsize is an apr_size_t) and\nthe result_datum_t = (GDBM) datum struct (dsize is an int).\n\nSuggesting changing the RETURN_DATUM macro to:\n\n#define RETURN_DATUM(poutput, rd) ((poutput)->dptr = (rd).dptr, (poutput)->dsize\n= (apr_size_t) (rd).dsize)\n\nWill hopefully try that one tomorrow.\n\nBest regards,\nBj\u00f6rn"}, {"count": 8, "tags": [], "creator": "Bjorn.Wiberg@uadm.uu.se", "attachment_id": 20610, "text": "Created attachment 20610\nExplicitly copy dptr and dsize fields (with explicit type cast for dsize)", "id": 106436, "time": "2007-08-07T04:40:48Z", "bug_id": 43025, "creation_time": "2007-08-07T04:40:48Z", "is_private": false}, {"attachment_id": 20611, "tags": [], "bug_id": 43025, "text": "Created attachment 20611\nGDB output before (without) patch and after (with) patch\n\nNotice the value of pvalue->dsize. Should be 4 (bytes).\nIt appears that the patch cures the problem.", "count": 9, "id": 106437, "time": "2007-08-07T04:42:49Z", "creator": "Bjorn.Wiberg@uadm.uu.se", "creation_time": "2007-08-07T04:42:49Z", "is_private": false}, {"count": 10, "attachment_id": null, "creator": "Bjorn.Wiberg@uadm.uu.se", "text": "All OK when using the patch. Suggesting upstream propagation. :-)\n\nThank you for your help!\n\nBest regards,\nBj\u00f6rn", "id": 106438, "time": "2007-08-07T04:50:08Z", "bug_id": 43025, "creation_time": "2007-08-07T04:50:08Z", "tags": [], "is_private": false}, {"count": 11, "tags": [], "bug_id": 43025, "attachment_id": null, "id": 106447, "time": "2007-08-07T05:48:34Z", "creator": "davi@apache.org", "creation_time": "2007-08-07T05:48:34Z", "is_private": false, "text": "Ok, thanks for the patch! Also the patch fixes another potential problem\nsince gdbm uses int type for the dsize field and APR uses size_t (unsigned\nlong), those structures (datum, apr_datum_t) might have different sizes\nand alignment (especially on 64 bit platforms)."}, {"count": 12, "tags": [], "text": "Exactly -- the differing field types between GDBM and apr_dbm_gdbm.c caused the\nincorrect dsize value (which was then passed on and used by Apache for\nallocating working space for the string etc.).\n\nBest regards,\nBj\u00f6rn", "attachment_id": null, "bug_id": 43025, "id": 106449, "time": "2007-08-07T06:21:57Z", "creator": "Bjorn.Wiberg@uadm.uu.se", "creation_time": "2007-08-07T06:21:57Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 43025, "text": "Shouldn't this be merged with head soon? Attaching patch for Apache 2.2.6.\n\nThanks in advance!\n\nBest regards,\nBj\u00f6rn", "count": 13, "id": 107940, "time": "2007-09-10T01:02:39Z", "creator": "Bjorn.Wiberg@uadm.uu.se", "creation_time": "2007-09-10T01:02:39Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 43025, "text": "Created attachment 20786\nExplicitly copy dptr and dsize fields (with explicit type cast for dsize)\n\nPatch for srclib/apr-util/dbm/apr_dbm_gdbmc.c of Apache 2.2.6", "id": 107941, "time": "2007-09-10T01:03:43Z", "creator": "Bjorn.Wiberg@uadm.uu.se", "creation_time": "2007-09-10T01:03:43Z", "is_private": false, "attachment_id": 20786}, {"count": 15, "tags": [], "creator": "davi@apache.org", "attachment_id": null, "text": "Patch committed to the 1.2.x branch in revision 584323:\n\nhttp://svn.apache.org/viewvc?view=rev&revision=584323", "id": 109316, "time": "2007-10-12T16:37:35Z", "bug_id": 43025, "creation_time": "2007-10-12T16:37:35Z", "is_private": false}, {"count": 16, "tags": [], "creator": "Bjorn.Wiberg@uadm.uu.se", "attachment_id": null, "text": "Please also note comment #1 and #2 (regarding SDBM), which should probably be\nmade into a separate bug.\n\nThank you for all your help.\n\nBest regards,\nBj\u00f6rn", "id": 109321, "time": "2007-10-12T20:18:11Z", "bug_id": 43025, "creation_time": "2007-10-12T20:18:11Z", "is_private": false}, {"count": 17, "tags": [], "creator": "davi@apache.org", "attachment_id": null, "text": "The argument order is right, those macros are really confusing. I ended\nup removing the macros cleaning up the dbm code on trunk.\n\nThanks for using APR.", "id": 109322, "time": "2007-10-12T21:18:28Z", "bug_id": 43025, "creation_time": "2007-10-12T21:18:28Z", "is_private": false}]