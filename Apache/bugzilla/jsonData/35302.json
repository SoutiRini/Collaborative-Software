[{"count": 0, "tags": [], "creator": "Tim.Whittington@orionhealth.com", "attachment_id": null, "id": 76244, "time": "2005-06-10T00:30:01Z", "bug_id": 35302, "creation_time": "2005-06-10T00:30:01Z", "is_private": false, "text": "When a service fails in the ISAPI ExtensionProc, IIS just drops the connection.\nThe behaviour then differs between browsers - IE shows a generic 'Unable to\nconnect to server' page, Firefox displays a blank window.\n\nIt is desirable for many of our clients to be able to tell the user what is\ngoing on, and point them in the direction of technical support.\n\nThis patch adds the ability to configure an error page to use when the endpoint\nservice in ExtensionProc fails.\n\nThe error page is a URL (absolute or relative) that is sent as a 302 to the\nclient when the service fails.\n\nContents of the patch:\n - Added a new optional error_page configuration property for the ISAPI redirector\n - Added a buffer for the page URL and a pointer that serves as a flag (i.e. if\nit's NULL there is no error page, otherwise it points to the buffer)\n - Modified ExtensionProc to send the redirect on service failure"}, {"count": 1, "tags": [], "creator": "Tim.Whittington@orionhealth.com", "attachment_id": 15361, "id": 76245, "time": "2005-06-10T00:31:04Z", "bug_id": 35302, "creation_time": "2005-06-10T00:31:04Z", "is_private": false, "text": "Created attachment 15361\nError page support for ISAPI redirector\n\nPatch against jk_isapi_plugin.c r1.49"}, {"count": 2, "tags": [], "bug_id": 35302, "text": "Comment on attachment 15361\nError page support for ISAPI redirector\n\nIndex: jk/native/iis/jk_isapi_plugin.c\n===================================================================\nRCS file:\n/home/cvspublic/jakarta-tomcat-connectors/jk/native/iis/jk_isapi_plugin.c,v\nretrieving revision 1.49\ndiff -u -r1.49 jk_isapi_plugin.c\n--- jk/native/iis/jk_isapi_plugin.c\t18 May 2005 18:04:53 -0000\t1.49\n+++ jk/native/iis/jk_isapi_plugin.c\t9 Jun 2005 23:21:35 -0000\n@@ -20,6 +20,7 @@\n  * Author:\t Larry Isaacs <larryi@apache.org>\t\t\t    *\n  * Author:\t Ignacio J. Ortega <nacho@apache.org>\t\t\t    *\n  * Author:\t Mladen Turk <mturk@apache.org> \t\t\t    *\n+ * Author:\t Tim Whittington <tim.whittington@orionhealth.com>\t    *\n  * Version:\t $Revision: 1.49 $\t\t\t\t\t    *\n  ***************************************************************************/\n\n@@ -69,6 +70,8 @@\n #define URI_SELECT_UNPARSED_VERB    (\"unparsed\")\n #define URI_SELECT_ESCAPED_VERB     (\"escaped\")\n\n+#define ERROR_PAGE_TAG \t     (\"error_page\")\n+\n #define BAD_REQUEST\t -1\n #define BAD_PATH\t -2\n #define MAX_SERVERNAME  128\n@@ -133,6 +136,8 @@\n static int log_level = JK_LOG_EMERG_LEVEL;\n static char worker_file[MAX_PATH * 2];\n static char worker_mount_file[MAX_PATH * 2] = {0};\n+static char error_page_buf[INTERNET_MAX_URL_LENGTH] = {0};\n+static char *error_page = NULL;\n\n #define URI_SELECT_OPT_PARSED\t     0\n #define URI_SELECT_OPT_UNPARSED     1\n@@ -1017,9 +1022,26 @@\n\t\t\t\t\"service() returned OK\");\n\t\t     }\n\t\t     else {\n-\t\t\t lpEcb->dwHttpStatusCode = is_error;\n\t\t\t jk_log(logger, JK_LOG_ERROR,\n\t\t\t\t\"service() failed\");\n+\n+\t\t\t /** Try to redirect the client to a page explaining\nthe ISAPI redirector is down */\n+\t\t\t if (error_page) {\n+\t\t\t     int len_of_error_page = strlen(error_page);\n+\t\t\t     if (!lpEcb->ServerSupportFunction(lpEcb->ConnID,\n+\t\t\t\t\t\t\t      \nHSE_REQ_SEND_URL_REDIRECT_RESP,\n+\t\t\t\t\t\t\t       error_page,\n+\t\t\t\t\t\t\t      \n(LPDWORD)&len_of_error_page,\n+\t\t\t\t\t\t\t       (LPDWORD)NULL))\n{\n+\t\t\t\t jk_log(logger, JK_LOG_ERROR,\n+\t\t\t\t     \"HttpExtensionProc error, Error page\nredirect failed\\n\");\n+\t\t\t\t lpEcb->dwHttpStatusCode = is_error;\n+\t\t\t     }\n+\t\t\t }\n+\t\t\t else {\n+\t\t\t     lpEcb->dwHttpStatusCode = is_error;\n+\t\t\t }\n+\n\t\t     }\n\t\t     e->done(&e, logger);\n\t\t }\n@@ -1139,6 +1161,9 @@\n\t jk_log(logger, JK_LOG_DEBUG, \"Using worker mount file %s.\",\n\t\tworker_mount_file);\n\t jk_log(logger, JK_LOG_DEBUG, \"Using uri select %d.\",\nuri_select_option);\n+\t if (error_page) {\n+\t     jk_log(logger, JK_LOG_DEBUG, \"Using error page '%s'.\\n\",\nerror_page);\n+\t }\n     }\n     if (uri_worker_map_alloc(&uw_map, NULL, logger)) {\n\t rc = JK_FALSE;\n@@ -1256,7 +1281,11 @@\n\t\t ok = JK_FALSE;\n\t     }\n\t }\n-\n+\t tmp = jk_map_get_string(map, ERROR_PAGE_TAG, NULL);\n+\t if (tmp) {\n+\t     strcpy(error_page_buf, tmp);\n+\t     error_page = error_page_buf;\n+\t }\n     }\n     else {\n\t rc = RegOpenKeyEx(HKEY_LOCAL_MACHINE,\n@@ -1322,6 +1351,12 @@\n\t\t ok = JK_FALSE;\n\t     }\n\t }\n+\t if (get_registry_config_parameter(hkey,\n+\t\t\t\t\t   ERROR_PAGE_TAG, \n+\t\t\t\t\t   tmpbuf, sizeof(tmpbuf))) {\n+\t     strcpy(error_page_buf, tmpbuf);\n+\t     error_page = error_page_buf;\n+\t }\n\n\t RegCloseKey(hkey);\n     }", "id": 76250, "time": "2005-06-10T01:25:25Z", "creator": "Tim.Whittington@orionhealth.com", "creation_time": "2005-06-10T01:25:25Z", "is_private": false, "attachment_id": 15361}, {"count": 3, "tags": [], "bug_id": 35302, "attachment_id": null, "text": "Current error display works yust fine both for IIS and Firefox,\neither when it come to 500, 503 or any other error message.\nThere was error in load balancer that caused to return the 200 and\nstill error page that might cause the issue you are addressing.\nAnyhow it works now.", "id": 76948, "time": "2005-07-03T11:24:39Z", "creator": "mturk@apache.org", "creation_time": "2005-07-03T11:24:39Z", "is_private": false}, {"count": 4, "tags": [], "text": "To clarify why this patch is useful (this is the way we use the functionality).\n\nWe usually deploy several applications to a single website, requiring multiple\nISAPI redirectors.\nThere are a couple of cases where the connection from the web server to the\nTomcat engine can fail:\n 1. The ISAPI redirector isn't installer properly as a filter\n 2. The Extension side of things fails to communicate with Tomcat\n\nWe handle these errors on a site by:\n 1. Putting a static page on the web server with the same name as the default\nresource indicating a web server misconfiguration. If the filter doesn't work,\nthen this page is served.\n 2. Sending a redirect to a designated static error page indicating that Tomcat\ncouldn't be reached when the Extension fails to communicate with Tomcat. \n\nCase 2 is what this patch addresses. It allows us to distinguish between generic\n500 errors and those caused by the ISAPI redirector, and further allows us to\ndistinguish between failures to different back-end applications.", "attachment_id": null, "bug_id": 35302, "id": 80347, "time": "2005-09-23T00:02:57Z", "creator": "Tim.Whittington@orionhealth.com", "creation_time": "2005-09-23T00:02:57Z", "is_private": false}]