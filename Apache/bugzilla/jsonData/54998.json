[{"count": 0, "tags": [], "text": "Apache 2.4.4 always terminates SSL connections using an abortive/unclean shutdown instead of a standard/clean shutdown. This is probably a bug that has been introduced in Apache 2.4.x, because it works using Apache 2.2.x.\n\nThis can bee seen in Wireshark, but it can also be tested using the \"openssl s_client\" utility. Please refer to the attached file for more information.\n\nI have tested this with the Apache versions 2.4.4 and 2.2.24 (with OpenSSL version 1.0.1e). Both Apache versions log that they will terminate the SSL connection using a standard shutdown. Apache 2.2.24 performs a standard shutdown, but Apache 2.4.4 performs an unclean shutdown.", "attachment_id": null, "bug_id": 54998, "id": 167324, "time": "2013-05-21T12:20:51Z", "creator": "apache-bugzilla@michael-kaufmann.ch", "creation_time": "2013-05-21T12:20:51Z", "is_private": false}, {"count": 1, "tags": [], "text": "Created attachment 30305\nAdditional information about this issue", "is_private": false, "id": 167325, "creator": "apache-bugzilla@michael-kaufmann.ch", "time": "2013-05-21T12:22:12Z", "bug_id": 54998, "creation_time": "2013-05-21T12:22:12Z", "attachment_id": 30305}, {"count": 2, "tags": [], "bug_id": 54998, "attachment_id": null, "is_private": false, "id": 175007, "time": "2014-05-03T20:06:33Z", "creator": "tim.kosse@filezilla-project.org", "creation_time": "2014-05-03T20:06:33Z", "text": "I confirm that this bug exists in Apache 2.4.9 as shipped in Debian Jessie as of today.\n\nThe workaround for me is to use mod_gnutls, it does not suffer from this problem."}, {"count": 3, "tags": [], "creator": "tim.kosse@filezilla-project.org", "text": "Created attachment 31593\nProposed patch that fixes this bug.\n\nI figured out what seems to be the problem: The closure alert is being generated, but is stuck in some buffers without ever making it to the wire, let alone the peer. Flushing the output BIO seems to solve the problem.\n\nThe attached patch fixes the bug for me. The patch has been created against the 2.4.x branch.\n\nCurrent trunk (rev 1592635) is also affected by this bug. I've tested that this patch also applies to trunk and fixes the problem there.\n\n\n\nAs testcase I used the following command:\n(echo -e \"GET / HTTP/1.0\\n\\n\"; sleep 1) | gnutls-cli --insecure -p 443 127.0.0.1 --crlf\n\nIf the bug occurs, gnutls-cli will at the end display a fatal error:\n*** Fatal error: The TLS connection was non-properly terminated.\n*** Server has terminated the connection abnormally.", "id": 175037, "time": "2014-05-05T21:38:31Z", "bug_id": 54998, "creation_time": "2014-05-05T21:38:31Z", "is_private": false, "attachment_id": 31593}, {"count": 4, "tags": [], "bug_id": 54998, "is_private": false, "text": "Thank you for the patch, but unfortunately it does not work for HTTP 1.1 connections with keep-alive. To test this, send a HTTP 1.1 request and then wait until Apache closes the connection:\n\n(echo -e \"GET / HTTP/1.1\\nHost: localhost\\n\\n\"; sleep 100) | gnutls-cli --insecure -p 443 127.0.0.1 --crlf", "id": 175193, "time": "2014-05-14T07:34:28Z", "creator": "apache-bugzilla@michael-kaufmann.ch", "creation_time": "2014-05-14T07:34:28Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 54998, "is_private": false, "text": "Strange, you're not even requesting keep-alive using the Connection: keep-alive request header.", "id": 175223, "time": "2014-05-14T20:13:15Z", "creator": "tim.kosse@filezilla-project.org", "creation_time": "2014-05-14T20:13:15Z", "attachment_id": null}, {"count": 6, "attachment_id": null, "creator": "apache_bugzilla@valgronda.com", "is_private": false, "id": 175231, "time": "2014-05-14T21:25:20Z", "bug_id": 54998, "creation_time": "2014-05-14T21:25:20Z", "tags": [], "text": "With HTTP/1.1 keep-alive is the expected default behavior, hence you don't have to specify a \"Connection: keep-alive\" header.\n\nhttp://tools.ietf.org/html/rfc2616#section-8.1.2"}, {"count": 7, "tags": [], "bug_id": 54998, "is_private": false, "text": "Thanks nada, my mistake.\n\nI've just tried my patch with keep-alive enabled and could not spot anything unusual, the client did receive the closure alert after expiration of the keep-alive interval.", "id": 175235, "time": "2014-05-15T06:01:19Z", "creator": "tim.kosse@filezilla-project.org", "creation_time": "2014-05-15T06:01:19Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 54998, "is_private": false, "text": "With your patch:\n- it works using the worker MPM\n- but it does not work using the event MPM.\n\nWithout your patch, it does not work (the MPM does not matter).\n\nSo I think that the patch is OK and should be applied to trunk. But I also think that another patch for the event MPM is needed.\n\nI have tested like this:\n\n(echo -e -n \"GET / HTTP/1.1\\r\\nHost: localhost\\r\\n\\r\\n\"; sleep 100) | gnutls-cli --insecure -p 443 127.0.0.1", "id": 175354, "time": "2014-05-20T14:07:08Z", "creator": "apache-bugzilla@michael-kaufmann.ch", "creation_time": "2014-05-20T14:07:08Z", "attachment_id": null}, {"count": 9, "tags": [], "text": "For me it works with the event MPM. httpd -V shows that the Server MPM is event.", "attachment_id": null, "id": 175395, "creator": "tim.kosse@filezilla-project.org", "time": "2014-05-22T18:46:41Z", "bug_id": 54998, "creation_time": "2014-05-22T18:46:41Z", "is_private": false}, {"count": 10, "attachment_id": 31650, "creator": "ylavic.dev@gmail.com", "text": "Created attachment 31650\nShutdown connection with EOC when keepalive expires\n\nMichael, can you try with the attached patch, on top of Tim's?", "id": 175400, "time": "2014-05-22T21:31:42Z", "bug_id": 54998, "creation_time": "2014-05-22T21:31:42Z", "tags": [], "is_private": false}, {"count": 11, "tags": [], "text": "Hello Yann,\n\nI have a question on your patch \"Shutdown connection ...\":\n\nIn the following excerpt from the patch to server/connection.c, \nwhat is the point in casting the result of the ap_shutdown_conn function to void?\n\n\n90 \tAP_CORE_DECLARE(void) ap_flush_conn(conn_rec *c)\n\n91 \t{\n\n92 \t    (void)ap_shutdown_conn(c, 1);\n\n93 \t}\n\n\nI can see that it doesn't hurt anything.\nBut does it serve some purpose?\n\nThanks,\n\nMike Rumph", "attachment_id": null, "id": 175402, "creator": "mike.rumph@oracle.com", "time": "2014-05-22T22:54:18Z", "bug_id": 54998, "creation_time": "2014-05-22T22:54:18Z", "is_private": false}, {"count": 12, "tags": [], "text": "(In reply to Mike Rumph from comment #11)\n> In the following excerpt from the patch to server/connection.c, \n> what is the point in casting the result of the ap_shutdown_conn function to\n> void?\n\nI usually do this to signify/remind (at least myself) somehow that a result is lost. It serves no other interest here.", "attachment_id": null, "bug_id": 54998, "id": 175403, "time": "2014-05-22T23:27:33Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-05-22T23:27:33Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 54998, "attachment_id": null, "id": 175409, "time": "2014-05-23T07:29:18Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-05-23T07:29:18Z", "is_private": false, "text": "(In reply to Yann Ylavic from comment #12)\n> I usually do this to signify/remind (at least myself) somehow that a result\n> is lost. It serves no other interest here.\n\nMore exactly it means I chose to lose the result on purpose (in this particular situation, I had no -ABI compatible- choice).\n\nI use casts to force things (when needed), and make implicit ones explicit only when to notify an intended (but still noteworthy) behaviour: truncation, expansion, lost result, could do better but works...\n\nWhether that one is noteworthy is disputable though, probably more for the review than the commit (if any).\nAs soon as things become more serious, I usually add a comment ;)"}, {"count": 14, "tags": [], "bug_id": 54998, "attachment_id": null, "id": 175466, "time": "2014-05-26T12:15:48Z", "creator": "apache-bugzilla@michael-kaufmann.ch", "creation_time": "2014-05-26T12:15:48Z", "is_private": false, "text": "With both patches together, it works :-) Thank you very much, Tim & Yann!\n\nWould it be possible to include these patches in a future version of Apache 2.4 ?"}, {"count": 15, "attachment_id": null, "creator": "ylavic.dev@gmail.com", "text": "Committed in r1601184 and r1601185.\nI will propose 2.4.x backport once reviewed.", "id": 175731, "time": "2014-06-07T23:00:09Z", "bug_id": 54998, "creation_time": "2014-06-07T23:00:09Z", "tags": [], "is_private": false}, {"count": 16, "tags": [], "text": "Created attachment 31697\nSend and flush the SSL close notify (proposed 2.4.x backport)\n\nPlease note that r1601184 is a slightly different version than Tim's patch.\nThe flush is done by SSL_smart_shutdown() instead of ssl_filter_io_shutdown() so to flush the close notify before waiting for the client's one should \"ssl-accurate-shutdown\" be set.\n\nI did some testing but obviously the more testers the better.\nAttached is the proposed backport (modulo CHANGES/MMN).", "attachment_id": 31697, "bug_id": 54998, "id": 175732, "time": "2014-06-07T23:21:28Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-06-07T23:21:28Z", "is_private": false}, {"count": 17, "tags": [], "bug_id": 54998, "attachment_id": 31718, "id": 175809, "time": "2014-06-14T10:02:54Z", "creator": "tim.kosse@filezilla-project.org", "creation_time": "2014-06-14T10:02:54Z", "is_private": false, "text": "Created attachment 31718\nProposed 2.4.x backport with additional fix for compile error\n\nUnfortunately the latest patch did not compile, as ssl->wbio is not directly accessible, as the type of ssl is incomplete.\nI've updated the patch to instead use SSH_get_wbio(ssl)\n\nWith the compile error fixed, the patched version works fine for me."}, {"count": 18, "tags": [], "text": "> SSH_get_wbio(ssl)\nOops, typo. Of course the patch uses SSL_get_wbio(ssl)", "is_private": false, "id": 175810, "creator": "tim.kosse@filezilla-project.org", "time": "2014-06-14T10:05:39Z", "bug_id": 54998, "creation_time": "2014-06-14T10:05:39Z", "attachment_id": null}, {"count": 19, "tags": [], "text": "(In reply to Tim Kosse from comment #17)\n> Unfortunately the latest patch did not compile, as ssl->wbio is not directly\n> accessible, as the type of ssl is incomplete.\n> I've updated the patch to instead use SSH_get_wbio(ssl)\n\nYes, fixed by r1601274 but I forgot to update this PR, sorry for that.\n\n> \n> With the compile error fixed, the patched version works fine for me.\n\nThanks for testing anyway, the 2.4.x backport is proposed in r1601697, waiting for votes. I'll update here if/when done.", "attachment_id": null, "id": 175813, "creator": "ylavic.dev@gmail.com", "time": "2014-06-14T22:06:24Z", "bug_id": 54998, "creation_time": "2014-06-14T22:06:24Z", "is_private": false}, {"count": 20, "tags": [], "creator": "stefan@huehner.org", "attachment_id": null, "id": 181535, "time": "2015-03-05T16:34:39Z", "bug_id": 54998, "creation_time": "2015-03-05T16:34:39Z", "is_private": false, "text": "Hi Yann,\n\ni am a bit unclear on 2.4.x backport status.\n\n\nfrom 2.4x/CHANGES file looks like this is fixed.\n\nhttps://svn.apache.org/viewvc/httpd/httpd/branches/2.4.x/CHANGES?revision=1664365&view=markup\n\nalso your backport proposal is removed from STATUS:\nhttps://svn.apache.org/viewvc/httpd/httpd/branches/2.4.x/STATUS?r1=1650956&r2=1651078&diff_format=h\n\nI see it in: full changes: for 2.4.10 \nhttp://www.apache.org/dist/httpd/CHANGES_2.4\n\nBut not in 2.4.10 changelog\nhttp://www.apache.org/dist/httpd/CHANGES_2.4.10"}, {"count": 21, "tags": [], "text": "Hi Stefan,\n\nI don't know how that's possible but indeed CHANGES_2.4.10 and CHANGES_2.4 do not match.\n\nThe code has been merged though :\n\nBoth in r1651077:\n  *) event: Send the SSL close notify alert when the KeepAliveTimeout\n     expires. PR54998. [Yann Ylavic] \n\n  *) mod_ssl: Ensure that the SSL close notify alert is flushed to the client.\n     PR54998. [Tim Kosse <tim.kosse filezilla-project.org>, Yann Ylavic] \n\nIn r1651080:\n  *) mod_proxy: Shutdown (eg. SSL close notify) the backend connection before\n     closing. [Yann Ylavic] \n\nSo they are all in 2.4.10, I'll try to figure out the CHANGES_2.4.10 issue.\n\nThanks for noticing.", "is_private": false, "id": 181536, "creator": "ylavic.dev@gmail.com", "time": "2015-03-05T16:59:54Z", "bug_id": 54998, "creation_time": "2015-03-05T16:59:54Z", "attachment_id": null}, {"count": 22, "attachment_id": null, "creator": "ylavic.dev@gmail.com", "text": "Err, 2.4.10's revision is r1610759 so prior to these merges, which occured before 2.4.11 (r1652259).\nSomething is somehow buggy in CHANGES_2.4*.\n\nSince 2.4.11 was not released, the changes are effective in 2.4.12.", "id": 181538, "time": "2015-03-05T17:10:01Z", "bug_id": 54998, "creation_time": "2015-03-05T17:10:01Z", "tags": [], "is_private": false}]