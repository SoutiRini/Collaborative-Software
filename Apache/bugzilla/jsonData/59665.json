[{"count": 0, "tags": [], "bug_id": 59665, "text": "Created attachment 33914\nPatch which sets the value of bspos\n\nSince POI 3.10, the setSheetOrder method on HSSFWorkbook corrupts internal state when used to move a sheet to the end of the workbook. Specifically, such a move results in the value of bspos in the WorkbookRecordList being reduced by one from the correct value, with the result that all future uses of that field to locate records get the wrong record.\n\nFor example, the following code\n\n============\nimport org.apache.poi.hssf.usermodel.HSSFSheet;\nimport org.apache.poi.hssf.usermodel.HSSFWorkbook;\n\npublic class Demo {\n\n  public static void main(String ... args) throws Exception {\n    final HSSFWorkbook test = new HSSFWorkbook();\n    test.createSheet(\"A\");\n    for (int i=0; i<70; i++) {\n      test.setSheetOrder(\"A\", 0);\n    }\n  }\n}\n============\n\nwill throw an exception after 62 iterations:\n\nException in thread \"main\" java.lang.ArrayIndexOutOfBoundsException: -1\n    at java.util.ArrayList.elementData(ArrayList.java:418)\n    at java.util.ArrayList.get(ArrayList.java:431)\n    at org.apache.poi.hssf.model.WorkbookRecordList.get(WorkbookRecordList.java:50)\n    at org.apache.poi.hssf.model.InternalWorkbook.setSheetOrder(InternalWorkbook.java:649)\n    at org.apache.poi.hssf.usermodel.HSSFWorkbook.setSheetOrder(HSSFWorkbook.java:489)\n    at Demo.main(Demo.java:10)\n\n\nThis happens because the removal of the bound sheet record in InternalWorkbook#setSheetOrder reduces the value of bspos by one, but when the record is added back, the position it is placed in is after what is now the last bound sheet record, so bspos is not incremented. Each iteration then reduces bspos by one, until it results in POI trying to fetch records from outside the bounds of the list.\n\nThis behaviour was introduced by the fix for Bug 50298 in commit https://svn.apache.org/repos/asf/poi/trunk@1516313. Before that, POI did not reorder the records in this scenario.\n\nPlease find attached a patch which sets the value of bspos following the sheet move, which fixes the observed issue.", "id": 191409, "time": "2016-06-06T12:12:32Z", "creator": "msww-asfbugs@corefiling.co.uk", "creation_time": "2016-06-06T12:12:32Z", "is_private": false, "attachment_id": 33914}, {"count": 1, "tags": [], "creator": "dtn-asfbugs@corefiling.co.uk", "is_private": false, "text": "Patch looks believable to me, but it would be good to have review from someone more familiar with HSSF.", "id": 191410, "time": "2016-06-06T12:20:58Z", "bug_id": 59665, "creation_time": "2016-06-06T12:20:58Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "dominik.stadler@gmx.at", "attachment_id": null, "text": "Looks reasonable, applied via r1753038, thanks for the patch!", "id": 192439, "time": "2016-07-17T09:28:48Z", "bug_id": 59665, "creation_time": "2016-07-17T09:28:48Z", "is_private": false}]