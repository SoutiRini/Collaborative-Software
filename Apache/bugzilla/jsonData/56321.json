[{"count": 0, "tags": [], "creator": "marco.laponder@kewill.com", "is_private": false, "text": "When the contextDestroyed accesses a static method on a class which has not been loaded yet, the rest of the contextDestroyed code is not executed,e.g.,:\n\npackage contexttest;\n\nimport javax.servlet.ServletContextEvent;\nimport javax.servlet.ServletContextListener;\n\npublic class ContextTest implements ServletContextListener {\n\n\tpublic void contextDestroyed(ServletContextEvent arg0) {\n\t\tSystem.out.println(\"Context Destroyed\");\n\t\tMyTest.testStatic();\n\t\tSystem.out.println(\"Context Destroyed Done\");\n\t\t\n\t}\n\n\tpublic void contextInitialized(ServletContextEvent arg0) {\n\t\tSystem.out.println(\"Context Initialized\");\n\t}\n\n}\n\npackage contexttest;\n\npublic class MyTest {\n\n\tpublic static void testStatic(){\n\t\tSystem.out.println(\"My static method call\");\n\t}\n}\n\nWhen I created a war based on this code, and copy this war to the tomcat web apps directory, it logs 'Context Initialized' as expected.\n\nWhen I remove the war it logs:\nContext Destroyed\nMy static method call\nContext Destroyed Done\n\nas expected. However when I copy the war to web apps, wait till it is initialized, and then touch the war (to simulate the update of a the war). It logs for the destroy event only:\n\n'Context Destroyed'\n\nSo the static method call and the 'Context Destroyed Done' is missing. \n\nWhen I execute the above on tomcat 7.0.42 it behaves as I would expect, so no difference between removing a war or updating the war.", "id": 174127, "time": "2014-03-27T10:43:45Z", "bug_id": 56321, "creation_time": "2014-03-27T10:43:45Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 56321, "attachment_id": 31446, "id": 174128, "time": "2014-03-27T10:44:55Z", "creator": "marco.laponder@kewill.com", "creation_time": "2014-03-27T10:44:55Z", "is_private": false, "text": "Created attachment 31446\ntest project"}, {"count": 2, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "id": 174137, "time": "2014-03-27T16:49:04Z", "bug_id": 56321, "creation_time": "2014-03-27T16:49:04Z", "is_private": false, "text": "Are you sure the log hasn't just been buffered? Tomcat doesn't kill threads like that.\n\nCan you post a thread dump after \"Context Destroyed\" has been printed?"}, {"count": 3, "attachment_id": null, "bug_id": 56321, "is_private": false, "id": 174142, "time": "2014-03-27T19:48:00Z", "creator": "markt@apache.org", "creation_time": "2014-03-27T19:48:00Z", "tags": [], "text": "The test is using stdout. It is unlikely to be buffered for any noticeable length of time.\n\nI can reproduce this on 7.0.x. Odd. Trying on 8.0.x..."}, {"attachment_id": null, "tags": [], "bug_id": 56321, "text": "OK. Found the problem.\n\nDeleting the WAR triggered a code path the undeployed the app and then deleted the expanded directory so the new class was available to load during undeployment. Updating the WAR triggered a code path that deleted the expanded directory and then undeployed the app. That meant the new class was not available to load at the point.\n\nI've fixed this my making the process consistent (undeploy then delete).\n\nThis has been fixed in 8.0.x for 8.0.6 onwards and 7.0.x for 7.0.54 onwards.", "count": 4, "id": 174146, "time": "2014-03-27T20:13:55Z", "creator": "markt@apache.org", "creation_time": "2014-03-27T20:13:55Z", "is_private": false}, {"count": 5, "attachment_id": null, "bug_id": 56321, "is_private": false, "id": 175626, "time": "2014-06-04T09:22:29Z", "creator": "yohei_hina@dwango.co.jp", "creation_time": "2014-06-04T09:22:29Z", "tags": [], "text": "Is this bug fixed?\n\nI can reproduce this on 7.0.54...."}, {"attachment_id": 31688, "tags": [], "bug_id": 56321, "text": "Created attachment 31688\ncontexttest.war\n\nWAR file, build from java files in \"test project\"\nCompiled with JDK 1.5 (can be used to test Tomcat 6, if anyone is interested)", "count": 6, "id": 175627, "time": "2014-06-04T11:25:46Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-06-04T11:25:46Z", "is_private": false}, {"count": 7, "attachment_id": null, "bug_id": 56321, "text": "(In reply to Yohei Hina from comment #5)\n> Is this bug fixed?\n\nYes.\nUsing the test war attached to this issue, the scenario in the Description above, current Tomcat 7.0.x and Java 7u55 on Windows, I see that it works correctly.\n\n[[[\nJun 04, 2014 3:29:30 PM org.apache.catalina.startup.HostConfig undeploy\nINFO: Undeploying context [/contexttest]\nContext Destroyed\nMy static method call\nContext Destroyed Done\nJun 04, 2014 3:29:30 PM org.apache.catalina.startup.HostConfig deployWAR\nINFO: Deploying web application archive ******\\webapps\\contexttest.war\nContext Initialized\nJun 04, 2014 3:29:30 PM org.apache.catalina.startup.HostConfig deployWAR\nINFO: Deployment of web application archive ******\\webapps\\contexttest.war has finished in 131 ms\n]]]\n\nThe commit for this issue is r1582454 (r1582453 for Tomcat 8).", "id": 175628, "time": "2014-06-04T11:32:27Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-06-04T11:32:27Z", "tags": [], "is_private": false}, {"count": 8, "tags": [], "text": "*** Bug 57122 has been marked as a duplicate of this bug. ***", "attachment_id": null, "id": 178645, "creator": "knst.kolinko@gmail.com", "time": "2014-10-21T12:42:52Z", "bug_id": 56321, "creation_time": "2014-10-21T12:42:52Z", "is_private": false}]