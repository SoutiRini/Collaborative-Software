[{"count": 0, "tags": [], "bug_id": 43480, "attachment_id": null, "is_private": false, "id": 108616, "time": "2007-09-26T03:00:52Z", "creator": "clive.nicholson@brent.gov.uk", "creation_time": "2007-09-26T03:00:52Z", "text": "We periodically receive the following in the Catalina log and I think this \noccurs when an empty cookie header is received at the server (e.g. \"Cookie:\"). \nI believe these empty cookie headers are coming from web browsers that have \nthe \"Google Web Accelerator\" installed.\n\n2007-09-26 09:07:36 Ajp13Processor[8009][4] process: finish\njava.lang.NullPointerException\n\tat java.util.StringTokenizer.<init>(StringTokenizer.java:146)\n\tat org.apache.tomcat.util.http.Cookies.processCookieHeader\n(Cookies.java:415)\n\tat org.apache.tomcat.util.http.Cookies.processCookies(Cookies.java:216)\n\tat org.apache.tomcat.util.http.Cookies.getCookieCount(Cookies.java:161)\n\tat org.apache.ajp.tomcat4.Ajp13Request.addCookies\n(Ajp13Request.java:193)\n\tat org.apache.ajp.tomcat4.Ajp13Request.setAjpRequest\n(Ajp13Request.java:155)\n\tat org.apache.ajp.tomcat4.Ajp13Processor.process\n(Ajp13Processor.java:449)\n\tat org.apache.ajp.tomcat4.Ajp13Processor.run(Ajp13Processor.java:585)\n\tat java.lang.Thread.run(Thread.java:534)\n\nPlease note the following: I believe the empty cookie headers were causing our \nDomino web server to crash in the \"jk2_requtil_getCookieByName()\" function. To \nresolve this problem I amended the 'workers2.Properties' file to \nset 'stickySession=0'. This appears to have stopped the web server crashes but \ncreated the issue above. An example of headers that caused the server to crash \npreviously is shown below:\n\nGET /servlet/ep.ext?\nextId=155777&byPostcode=y&byStreet=y&byHouseNumber=Y&byAddress=y&st=PRS \nHTTP/1.1\nAccept-Language: en-gb,en-us;q=0.5\nUser-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR \n1.1.4322; .NET CLR 2.0.50727)\nAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-\nshockwave-flash, application/vnd.ms-excel, application/vnd.ms-powerpoint, \napplication/msword, */*\nReferer: \nhttp://www.brent.gov.uk/registrar.nsf/24878f4b00d4f0f68025663c006c7944/79335ab1\n0394dc1280256f79003d613d?OpenDocument\nHost: www.brent.gov.uk\nX-moz: prefetch\nCookie: \nX-Forwarded-For: 82.153.25.44\nAccept-Encoding: gzip"}, {"count": 1, "tags": [], "bug_id": 43480, "attachment_id": null, "text": "This is in the \"deprecated\" processCookieHeader. I'd like to have this function\nremoved (for bunches of reasons) in but I'll have to see how Ajp uses it.", "id": 108647, "time": "2007-09-26T09:47:50Z", "creator": "john@sourcelabs.com", "creation_time": "2007-09-26T09:47:50Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 43480, "attachment_id": null, "is_private": false, "id": 108672, "time": "2007-09-26T14:58:55Z", "creator": "john@sourcelabs.com", "creation_time": "2007-09-26T14:58:55Z", "text": "Notes:\n1. tomcat4.ajp.* doesn't the setBytes method of MessageBytes in Ajp13Request\nwhen adding header/value pairs.\n2. This means the header value(s) never get a type of T_BYTES\n3. Cookie processing always defaults to the simple StringTokenizer version.\n\nPossible Solutions:\n1. Do a simple check for null strings in the StringTokenizer version of\nprocessCookieHeader.\n2. Convert(!) the string to byte [], making sure no wackiness occurs with the\ncharacter set and use the more modern processCookieHeaders.\n3. Look into the possibility of having Ajp13Request, et. al use setBytes (The\nproblem with this is that the header/value pair is actually set in HttpRequestBase)\n\nI am leaning towards option 1, because it is low-impact. The cons are that we\nstill have a code path engaged with the deprecated parser. I still need to\nreplicate this also.\n\nAny input?"}, {"count": 3, "tags": [], "creator": "clive.nicholson@brent.gov.uk", "attachment_id": null, "text": "We can recreate the problem by using wget to issue a command like:\n\nwget --header \"Cookie:\" url\n\nWould this problem still occur if we used the Coyote connector or if we \nupgraded to Tomcat 5?\n\nPlease do not spend too much time on this problem if it isn't a quick fix as \nat the moment it isn't causing us too mnay problems.", "id": 108727, "time": "2007-09-27T09:22:51Z", "bug_id": 43480, "creation_time": "2007-09-27T09:22:51Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 43480, "text": "I don't see any errors in the logs when I run wget --header \"Cookie:\" url using:\n- Tomcat 4.1.36\n- Coyote connector\n- mod_proxy_ajp\n- httpd 2.2.4\n\nI know this differs quite a bit from your config. I would try the Coyote\nconnector in the first instance as it is just a config change rather than an\nupgrade.\n\nI am marking this as fixed in the latest 4.1.x release.", "id": 108958, "time": "2007-10-03T16:15:02Z", "creator": "markt@apache.org", "creation_time": "2007-10-03T16:15:02Z", "is_private": false, "attachment_id": null}]