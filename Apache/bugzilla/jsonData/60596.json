[{"count": 0, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "text": "Reviewing SendFile support in DefaultServlet,\nthe feature is implemented with the following code in current trunk:\n\n// method DefaultServlet.checkSendfile()\n\n        if (sendfileSize > 0\n            && resource.isFile()\n            && length > sendfileSize\n            && (resource.getCanonicalPath() != null)\n            && (Boolean.TRUE.equals(request.getAttribute(Globals.SENDFILE_SUPPORTED_ATTR)))\n            && (request.getClass().getName().equals(\"org.apache.catalina.connector.RequestFacade\"))\n            && (response.getClass().getName().equals(\"org.apache.catalina.connector.ResponseFacade\"))) {\n            request.setAttribute(Globals.SENDFILE_FILENAME_ATTR, resource.getCanonicalPath());\n\n\nNotes:\n\n1. It is better to check for request.getAttribute(Globals.SENDFILE_SUPPORTED_ATTR) flag first.\n\nCalling resource.isFile() and resource.getCanonicalPath() incurs I/O processing that is not needed when send file feature is disabled on a Connector.\n\n2. resource.getCanonicalPath() is calculated twice. First time to check that it is not null, second time to set SENDFILE_FILENAME_ATTR attribute.\n\n\nIn general, all this activity will be followed by File I/O, so performance improvement may be small compared to the rest of I/O.\n\nDuplicate evaluation of getCanonicalPath() is not a matter for Tomcat 7 and earlier, as in the old JNDI implementation of resources the value of canonical path is cached (see org.apache.naming.resources.FileResourceAttributes.getCanonicalPath()).", "id": 196114, "time": "2017-01-17T14:34:01Z", "bug_id": 60596, "creation_time": "2017-01-17T14:34:01Z", "is_private": false}, {"count": 1, "text": "Fixed in Tomcat 9 by r1779718 to be in 9.0.0.M18.\nFixed in Tomcat 8.5 by r1779719 to be in 8.5.12.\nFixed in Tomcat 8.0 by r1779721 to be in 8.0.42.", "creator": "knst.kolinko@gmail.com", "attachment_id": null, "id": 196265, "time": "2017-01-21T10:53:40Z", "bug_id": 60596, "creation_time": "2017-01-21T10:53:40Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "text": "Not an issue for Tomcat 7 and earlier, as\n- existence check (entry.resource != null) does not involve I/O\n- FileResourceAttributes.getCanonicalPath() caches its value\n\nClosing as FIXED.", "id": 196266, "time": "2017-01-21T10:59:23Z", "bug_id": 60596, "creation_time": "2017-01-21T10:59:23Z", "is_private": false}]