[{"count": 0, "tags": [], "text": "the sitetree area links (\"authoring\", \"trash\" etc.) do not correctly maintain\nthe proxy settings if the proxy contains a sub-directory in addition to a host name.\n\ni.e. my authoring proxy is \"https://foo.bar/baz\". all document links are\ncorrect, but the authoring link will end up as https://foo.bar/<pub>/authoring\ninstead of https://foo.bar/baz/<pub>/authoring", "attachment_id": null, "bug_id": 43429, "id": 108417, "time": "2007-09-19T12:40:48Z", "creator": "nettings@apache.org", "creation_time": "2007-09-19T12:40:48Z", "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 43429, "is_private": false, "id": 109561, "time": "2007-10-22T14:04:37Z", "creator": "nettings@apache.org", "creation_time": "2007-10-22T14:04:37Z", "tags": [], "text": "somewhere between september and mid-october 2007, something changed and broke\nthe sitetree generation code for proxied environments. if you are using a proxy,\nall you get for a sitetree is the top pseudo-node with the name of the\npublication. everything else has vanished. this is a must-fix before 2.0.\n"}, {"count": 2, "tags": [], "text": "the latest breakage seems to occur only for ssl proxies:\nthe sitetree script takes a weird parameter \"AREA_BASE_PATH\" that is supposed to\nbe .../authoring or .../live. it is built by the sitemap thus:\n\n<map:parameter \n  name=\"areaBasePath\"\n  value=\"{proxy:/{request:{page-envelope:publication-id}/{page-envelope:area}}\"\n/>\n\nthis kind of falls apart in an ssl context, because the proxy module has no way\nof knowing we are currently in a https://... request - the generated\nareaBasePath will always be http:// for some reason.\ncan anyone suggest a nice way to fix this?\n\n", "attachment_id": null, "bug_id": 43429, "id": 109568, "time": "2007-10-22T15:02:30Z", "creator": "nettings@apache.org", "creation_time": "2007-10-22T15:02:30Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 43429, "is_private": false, "count": 3, "id": 109569, "time": "2007-10-22T15:07:09Z", "creator": "nettings@apache.org", "creation_time": "2007-10-22T15:07:09Z", "text": "hmm. when i work around this issue by hard-coding the correct \"https://...\" URI\nin the sitemap, the tree appears, but it does not open its sub-trees - only the\nfirst level is visible.\noff to bed for now...."}, {"count": 4, "tags": [], "text": "i tried to configure the proxy transformer for relative urls, and found that\napparently there is such option for the proxy input module, which is used to\nprepare the parameters for the sitetree javascript...\nthe input module has no way of knowing we're in an SSL session iiuc, so we would\nneed an additional attribute {proxy:ssl:<URL>} or something like that. wdot?", "is_private": false, "id": 109588, "creator": "nettings@apache.org", "time": "2007-10-23T05:28:43Z", "bug_id": 43429, "creation_time": "2007-10-23T05:28:43Z", "attachment_id": null}, {"count": 5, "tags": [], "text": "i came across an NPE that is reproducible on zones:\n\ntry to call the sitetree module directly by entering\nhttp://lenya.zones.apache.org:9999/modules/sitetree/default/authoring/sitetree.xml\n\nyou will get \n\nCaused by: java.lang.NullPointerException\n\tat\norg.apache.lenya.cms.cocoon.transformation.AccessControlSitetreeTransformer.setup(AccessControlSitetreeTransformer.java:117)\n\n\ni don't think this is the root cause of the bug i'm seeing, but it might be\nrelated to changes by andreas of 5 weeks ago - andreas, if you have a minute,\ncould you have a look?\n\n", "is_private": false, "id": 109590, "creator": "nettings@apache.org", "time": "2007-10-23T06:34:38Z", "bug_id": 43429, "creation_time": "2007-10-23T06:34:38Z", "attachment_id": null}, {"count": 6, "tags": [], "creator": "andreas@apache.org", "attachment_id": null, "id": 109794, "time": "2007-10-26T07:13:26Z", "bug_id": 43429, "creation_time": "2007-10-26T07:13:26Z", "is_private": false, "text": "(In reply to comment #2)\n> the latest breakage seems to occur only for ssl proxies:\n> the sitetree script takes a weird parameter \"AREA_BASE_PATH\" that is supposed to\n> be .../authoring or .../live. it is built by the sitemap thus:\n> \n> <map:parameter \n>   name=\"areaBasePath\"\n>   value=\"{proxy:/{request:{page-envelope:publication-id}/{page-envelope:area}}\"\n> />\n> \n> this kind of falls apart in an ssl context, because the proxy module has no way\n> of knowing we are currently in a https://... request - the generated\n> areaBasePath will always be http:// for some reason.\n> can anyone suggest a nice way to fix this?\n\nYou could use mod_proxy_ajp, see\nhttp://lenya.zones.apache.org/docu/docs/2_0_x/tutorials/proxy/proxy.html (note\nat the bottom).\n"}, {"count": 7, "tags": [], "bug_id": 43429, "is_private": false, "text": "(In reply to comment #5)\n> i came across an NPE that is reproducible on zones:\n> \n> try to call the sitetree module directly by entering\n> http://lenya.zones.apache.org:9999/modules/sitetree/default/authoring/sitetree.xml\n> \n> you will get \n> \n> Caused by: java.lang.NullPointerException\n> \tat\n>\norg.apache.lenya.cms.cocoon.transformation.AccessControlSitetreeTransformer.setup(AccessControlSitetreeTransformer.java:117)\n> \n> \n> i don't think this is the root cause of the bug i'm seeing, but it might be\n> related to changes by andreas of 5 weeks ago - andreas, if you have a minute,\n> could you have a look?\n\nYou can't call the sitetree this way, because the transformer needs the correct\npublication context to resolve the access controller. You can use\n\nhttp://lenya.zones.apache.org:9999/default/authoring/sitetree.xml?lenya.module=sitetree\n\ninstead.\n", "id": 109795, "time": "2007-10-26T07:17:15Z", "creator": "andreas@apache.org", "creation_time": "2007-10-26T07:17:15Z", "attachment_id": null}, {"count": 8, "attachment_id": null, "bug_id": 43429, "is_private": false, "id": 109797, "time": "2007-10-26T07:18:24Z", "creator": "andreas@apache.org", "creation_time": "2007-10-26T07:18:24Z", "tags": [], "text": "(In reply to comment #0)\n> the sitetree area links (\"authoring\", \"trash\" etc.) do not correctly maintain\n> the proxy settings if the proxy contains a sub-directory in addition to a host\nname.\n\nI can confirm this problem, these links were broken with all (non-trivial) proxy\nsettings. I committed a patch, it works for me with mod_proxy_ajp now. Please\ntest. TIA!\n\n"}, {"count": 9, "tags": [], "bug_id": 43429, "attachment_id": null, "id": 109798, "time": "2007-10-26T07:25:37Z", "creator": "andreas@apache.org", "creation_time": "2007-10-26T07:25:37Z", "is_private": false, "text": "(In reply to comment #4)\n> i tried to configure the proxy transformer for relative urls, and found that\n> apparently there is such option for the proxy input module, which is used to\n> prepare the parameters for the sitetree javascript...\n> the input module has no way of knowing we're in an SSL session iiuc, so we would\n> need an additional attribute {proxy:ssl:<URL>} or something like that. wdot?\n\nThe proxy module uses request.isSecure() to determine if we're in an SSL session:\n\nLinkRewriter rewriter = new OutgoingLinkRewriter(this.manager, session,\nrequest.getRequestURI(), request.isSecure(), false, false);\n\nThis doesn't work with plain mod_proxy, though - you have to use mod_jk or\nmod_proxy_ajp."}, {"attachment_id": null, "tags": [], "bug_id": 43429, "is_private": false, "count": 10, "id": 109880, "time": "2007-10-29T07:52:20Z", "creator": "nettings@apache.org", "creation_time": "2007-10-29T07:52:20Z", "text": "(In reply to comment #7)\n> (In reply to comment #5)\n> > i came across an NPE that is reproducible on zones:\n> > try to call the sitetree module directly by entering\nhttp://lenya.zones.apache.org:9999/modules/sitetree/default/authoring/sitetree.xml\n> > you will get \n> > Caused by: java.lang.NullPointerException\n> \n> You can't call the sitetree this way, because the transformer needs the correct\n> publication context to resolve the access controller. You can use\n> \n>\nhttp://lenya.zones.apache.org:9999/default/authoring/sitetree.xml?lenya.module=sitetree\n\nthen why does the module have this matcher? imnsho, all matchers that can and\nshould not be requested directly by a browser should be in internal pipelines.\nor is there a technical reason?\n"}, {"count": 11, "tags": [], "creator": "andreas@apache.org", "attachment_id": null, "id": 109885, "time": "2007-10-29T08:10:16Z", "bug_id": 43429, "creation_time": "2007-10-29T08:10:16Z", "is_private": false, "text": "(In reply to comment #10)\n> then why does the module have this matcher? imnsho, all matchers that can and\n> should not be requested directly by a browser should be in internal pipelines.\n\nYes, I guess we can declare this one as internal too.\n\n> or is there a technical reason?\n\nNone that I'm aware of.\n\n"}, {"count": 12, "tags": [], "bug_id": 43429, "attachment_id": null, "id": 110318, "time": "2007-11-08T04:16:49Z", "creator": "nettings@apache.org", "creation_time": "2007-11-08T04:16:49Z", "is_private": false, "text": "i have now changed my proxy setup to use mod_proxy_ajp, and everything works for\nme. please reopen if you encounter problems. thanks to andreas for the fix!"}, {"count": 13, "attachment_id": null, "bug_id": 43429, "is_private": false, "id": 110659, "time": "2007-11-16T15:58:23Z", "creator": "nettings@apache.org", "creation_time": "2007-11-16T15:58:23Z", "tags": [], "text": "the insertLink usecase does not display sitetree sub-nodes, only top-level\n(tested on jetty6 with proxy test scaffold in non-root context).\nmight as well be a bug in the usecase, but for now i'm putting it here as a\nreminder. should be trivial to fix since andreas squashed the underlying issue a\nwhile ago..."}, {"count": 14, "tags": [], "text": "(In reply to comment #13)\n> the insertLink usecase does not display sitetree sub-nodes, only top-level\n> (tested on jetty6 with proxy test scaffold in non-root context).\n\nLooks good with OneForm, Tomcat, non-root context.\n", "attachment_id": null, "id": 110698, "creation_time": "2007-11-19T00:52:55Z", "time": "2007-11-19T00:52:55Z", "creator": "andreas@apache.org", "bug_id": 43429, "is_private": false}, {"count": 15, "tags": [], "text": "Can't reproduce it with BXE either (Tomcat, non-root context).", "attachment_id": null, "bug_id": 43429, "id": 110699, "time": "2007-11-19T00:54:54Z", "creator": "andreas@apache.org", "creation_time": "2007-11-19T00:54:54Z", "is_private": false}, {"count": 16, "tags": [], "text": "J\u00f6rn, does this problem persist in your setup?", "attachment_id": null, "id": 111008, "creation_time": "2007-11-23T06:52:15Z", "time": "2007-11-23T06:52:15Z", "creator": "andreas@apache.org", "bug_id": 43429, "is_private": false}, {"count": 17, "tags": [], "text": "Do we need to address this for 2.0?", "is_private": false, "id": 111675, "creator": "andreas@apache.org", "time": "2007-12-11T14:49:09Z", "bug_id": 43429, "creation_time": "2007-12-11T14:49:09Z", "attachment_id": null}, {"count": 18, "tags": [], "text": "Looks like the issue was cleared up. I am not seeing any problems with 2.0.1, Tomcat 6, mod_proxy_ajp. Reopen if there are still issues.", "attachment_id": null, "id": 114605, "creation_time": "2008-03-13T13:28:08Z", "time": "2008-03-13T13:28:08Z", "creator": "rfrovarp@apache.org", "bug_id": 43429, "is_private": false}]