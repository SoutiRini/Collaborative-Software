[{"count": 0, "tags": [], "text": "This issue is similar to https://bz.apache.org/bugzilla/show_bug.cgi?id=59635 but it is happending in another location of the code.   Please refer to the following stack.  \n\ncompressedPayload.limit() is zero because of the compressedPayload.flip() call.\n\nSep 04, 2017 11:10:08 PM org.glassfish.jersey.server.ServerRuntime$Responder writeResponse\nSEVERE: Error while closing the output stream in order to commit response.\njava.lang.IllegalArgumentException\n\tat java.nio.Buffer.limit(Unknown Source)\n\tat org.apache.tomcat.websocket.PerMessageDeflate.sendMessagePart(PerMessageDeflate.java:374)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessage(WsRemoteEndpointImplBase.java:341)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase$TextMessageSendHandler.write(WsRemoteEndpointImplBase.java:803)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.sendStringByCompletion(WsRemoteEndpointImplBase.java:212)\n\tat org.apache.tomcat.websocket.WsRemoteEndpointAsync.sendText(WsRemoteEndpointAsync.java:47)\n\tat org.atmosphere.container.version.JSR356WebSocket.write(JSR356WebSocket.java:73)\n\tat org.atmosphere.websocket.WebSocket.write(WebSocket.java:255)\n\tat org.atmosphere.websocket.WebSocket.write(WebSocket.java:46)\n\tat org.atmosphere.cpr.AtmosphereResponseImpl$Stream.write(AtmosphereResponseImpl.java:980)\n\tat org.glassfish.jersey.servlet.internal.ResponseWriter$NonCloseableOutputStreamWrapper.write(ResponseWriter.java:325)\n\tat java.io.ByteArrayOutputStream.writeTo(Unknown Source)\n\tat org.glassfish.jersey.message.internal.CommittingOutputStream.flushBuffer(CommittingOutputStream.java:307)\n\tat org.glassfish.jersey.message.internal.CommittingOutputStream.commit(CommittingOutputStream.java:261)\n\tat org.glassfish.jersey.message.internal.CommittingOutputStream.close(CommittingOutputStream.java:276)\n\tat org.glassfish.jersey.message.internal.OutboundMessageContext.close(OutboundMessageContext.java:877)\n\tat org.glassfish.jersey.server.ContainerResponse.close(ContainerResponse.java:412)\n\tat org.glassfish.jersey.server.ServerRuntime$Responder.writeResponse(ServerRuntime.java:784)\n\tat org.glassfish.jersey.server.ServerRuntime$Responder.processResponse(ServerRuntime.java:444)\n\tat org.glassfish.jersey.server.ServerRuntime$Responder.process(ServerRuntime.java:434)\n\tat org.glassfish.jersey.server.ServerRuntime$2.run(ServerRuntime.java:329)\n\tat org.glassfish.jersey.internal.Errors$1.call(Errors.java:271)\n\tat org.glassfish.jersey.internal.Errors$1.call(Errors.java:267)\n\tat org.glassfish.jersey.internal.Errors.process(Errors.java:315)\n\tat org.glassfish.jersey.internal.Errors.process(Errors.java:297)\n\tat org.glassfish.jersey.internal.Errors.process(Errors.java:267)\n\tat org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:321)\n\tat org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:305)\n\tat org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:1154)\n\tat org.glassfish.jersey.servlet.WebComponent.serviceImpl(WebComponent.java:473)\n\tat org.glassfish.jersey.servlet.WebComponent.service(WebComponent.java:427)\n\tat org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:388)\n\tat org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:341)\n\tat org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:228)\n\tat com.apriori.async.ws.config.AsyncServletContainer.service(AsyncServletContainer.java:108)\n\tat org.atmosphere.util.AtmosphereFilterChain.doFilter(AtmosphereFilterChain.java:135)\n\tat org.atmosphere.util.AtmosphereFilterChain.invokeFilterChain(AtmosphereFilterChain.java:96)\n\tat org.atmosphere.handler.ReflectorServletProcessor$FilterChainServletWrapper.service(ReflectorServletProcessor.java:337)\n\tat org.atmosphere.handler.ReflectorServletProcessor.onRequest(ReflectorServletProcessor.java:175)\n\tat org.atmosphere.cpr.AsynchronousProcessor.action(AsynchronousProcessor.java:223)\n\tat org.atmosphere.cpr.AsynchronousProcessor.suspended(AsynchronousProcessor.java:115)\n\tat org.atmosphere.container.Servlet30CometSupport.service(Servlet30CometSupport.java:67)\n\tat org.atmosphere.cpr.AtmosphereFramework.doCometSupport(AtmosphereFramework.java:2287)\n\tat org.atmosphere.websocket.DefaultWebSocketProcessor.dispatch(DefaultWebSocketProcessor.java:593)\n\tat org.atmosphere.websocket.DefaultWebSocketProcessor.open(DefaultWebSocketProcessor.java:224)\n\tat org.atmosphere.container.JSR356Endpoint.onOpen(JSR356Endpoint.java:264)\n\tat org.apache.tomcat.websocket.server.WsHttpUpgradeHandler.init(WsHttpUpgradeHandler.java:133)\n\tat org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:914)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1457)\n\tat org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\n\tat org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n\tat java.lang.Thread.run(Unknown Source)", "is_private": false, "id": 200668, "creator": "email.wtam@gmail.com", "time": "2017-09-05T13:29:23Z", "bug_id": 61491, "creation_time": "2017-09-05T13:29:23Z", "attachment_id": null}, {"count": 1, "attachment_id": null, "bug_id": 61491, "is_private": false, "id": 200719, "time": "2017-09-06T19:16:43Z", "creator": "markt@apache.org", "creation_time": "2017-09-06T19:16:43Z", "tags": [], "text": "From the stack trace, this appears to be a duplicate of bug 59635.\n\nAre you sure compressedPayload.limit() is zero? 1, 2 and 3 are also possibilities.\n\nWhat is really needed here is a test case. Can you provide the String that was being sent at the time?\n\nI'll take another look at the code but a reliable test case would make this a lot simpler."}, {"count": 2, "tags": [], "text": "I've managed to reproduce this.\n\nIt is triggered by a zero length message after a non-zero length message when the compression context is retained between messages.\n\nI'm starting to think about a fix.", "is_private": false, "id": 200734, "creator": "markt@apache.org", "time": "2017-09-07T19:21:34Z", "bug_id": 61491, "creation_time": "2017-09-07T19:21:34Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 61491, "attachment_id": null, "text": "Fixed in:\n- trunk for 9.0.0.M27 onwards\n- 8.5.x for 8.5.21 onwards\n- 8.0.x for 8.0.47 onwards\n- 7.0.x for 7.0.82 onwards", "id": 200747, "time": "2017-09-08T09:07:07Z", "creator": "markt@apache.org", "creation_time": "2017-09-08T09:07:07Z", "is_private": false}]