[{"attachment_id": null, "tags": [], "creator": "jouvin@lal.in2p3.fr", "text": "From quite a long time we had regular error message in main Apache error log \nfile with apr_accept complaining about too many open files. I recently tried \nto troubleshoot the problem with version 2.0.54. And I upgraded today to \n2.0.55. This report is based on detailed observation with 2.0.55.\n\nWe collect different statistics about httpd processes twice per hour. We are \nrunning Apache with worker MPM. In normal conditions, we have only one slave \nhttpd running (with a max of 35 threads, 10 spare threads, almost all idle).\n\nIt appears that the number of file descriptors used by httpd slave process is \nincreasing permanently, never reaching a \"stable\" value. It starts at 230 and \nincreases at a rate that looks proportionnal to the number of requests. When \nthe server is not very busy this means at least an increment of 5 per minutes. \nThe hard limit of 4096 is reached in less than a day...\n\nIf looking with lsof at the files opened by httpd, it appears a large number \nof file descriptor not linked to a file (probably a network connection) and \naround half this number of file descriptors to /etc/hosts and /etc/ipnodes \n(both). For example :\n\n1539 file descriptors not linked to a file\n 593 etc/hosts\n 603 etc/ipnodes\n\nOur Apache server loads PHP, mod_python and Subversion server, in addition to \nmodules provided by Apache. From what I have seen in the logs, during low \nrequest rate period, there is almost exclusively pure HTML requests. I have \nalso validated that doing Subversion transactions, even large ones, have no \neffect on the number of file descriptors used. Thus I suspect the problem is \nin core Apache.\n\nAny idea on the reason of the problems or possible troubleshooting strategy ?\n\nThanks in advance.\n\nMichel", "count": 0, "id": 83267, "time": "2005-12-05T23:31:41Z", "bug_id": 37802, "creation_time": "2005-12-05T23:31:41Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 37802, "is_private": false, "text": "(In reply to comment #0)\n\n[..cut..]\n \n> If looking with lsof at the files opened by httpd, it appears a large number \n> of file descriptor not linked to a file (probably a network connection) and \n> around half this number of file descriptors to /etc/hosts and /etc/ipnodes \n> (both). For example :\n> \n> 1539 file descriptors not linked to a file\n\nIf they are network connections they should be shown as such. See example from\nmy Linux box:\n\nssh        1299 ruediger    3u  IPv4       8156                TCP euler.heimnet\nz.de:32773->cerberus.heimnetz.de:ssh (ESTABLISHED)\n\nWhat is the type of these descriptors (in the above example it is IPv4)?\n\n>  593 etc/hosts\n>  603 etc/ipnodes\n\nHm, I am not quite sure if httpd opens these files directly. These files are\noften opened by some libc functions. Maybe a bug in the libc of your OS?\n\n> \n> Our Apache server loads PHP, mod_python and Subversion server, in addition to \n> modules provided by Apache. From what I have seen in the logs, during low \n\nPlease try to check if the described behaviour also happens without any 3rd\nparty modules loaded (Yes, I know this hurts :-)).\n\n[..cut..]\n\n", "id": 83269, "time": "2005-12-06T00:20:43Z", "creator": "rpluem@apache.org", "creation_time": "2005-12-06T00:20:43Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 37802, "attachment_id": null, "id": 83270, "time": "2005-12-06T00:55:54Z", "creator": "jouvin@lal.in2p3.fr", "creation_time": "2005-12-06T00:55:54Z", "is_private": false, "text": "It was also my guess that ipnodes, hosts... are not opened directly by Apache. \nWhat's not clear for me is if Apache can be responsible of having them kept \nopen or if this is an indication of an OS bug.\n\nThere is almost no active net connection to httpd, according to netstat (and \nbetween 1\u00e0 and 20 in FIN_WAIT2 state). What worries me is that this number of \nfile descriptors used never decrease.\n\nHere is the kind of entry I get reported by lsof. May be I am wrong thinking \nthey are related to a network connection. In fact, lsof is not able to find \nany information about the file descriptor type. And looking at these entries, \nthey are all about the same file structure address.\n\nhttpd   1349886 apache   21                                    can't read file \nstruct from 0xc00001670069986a\n\n\nMichel"}, {"count": 3, "tags": [], "creator": "jouvin@lal.in2p3.fr", "text": "Looking more carefully at lsof output, it appears that the file structure \naddress that is reopened a lot of times is the same as for file descriptor 1. \nFD 1 is stdout if I am right. Strange, isn'it ?\n\nMichel", "id": 83316, "time": "2005-12-06T15:45:42Z", "bug_id": 37802, "creation_time": "2005-12-06T15:45:42Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 37802, "is_private": false, "count": 4, "id": 83330, "time": "2005-12-06T22:30:23Z", "creator": "rpluem@apache.org", "creation_time": "2005-12-06T22:30:23Z", "text": "(In reply to comment #2)\n> It was also my guess that ipnodes, hosts... are not opened directly by Apache. \n> What's not clear for me is if Apache can be responsible of having them kept \n> open or if this is an indication of an OS bug.\n\nI don't think that httpd can keep them open intentionally.\n\n> \n> There is almost no active net connection to httpd, according to netstat (and \n> between 1\u00e0 and 20 in FIN_WAIT2 state). What worries me is that this number of \n> file descriptors used never decrease.\n\n[..cut..]\n\n> \n> httpd   1349886 apache   21                                    can't read file \n> struct from 0xc00001670069986a\n\nSorry maybe stupid question, but did you run lsof either as the user running\napache or as root? \n\n[..cut..]\n\n"}, {"count": 5, "tags": [], "bug_id": 37802, "attachment_id": null, "id": 174851, "time": "2014-04-24T17:01:02Z", "creator": "takashi.asfbugzilla@tks.st", "creation_time": "2014-04-24T17:01:02Z", "is_private": false, "text": "silent for 8 years and 2.0 retired"}]