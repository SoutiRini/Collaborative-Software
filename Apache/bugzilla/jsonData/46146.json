[{"count": 0, "tags": [], "bug_id": 46146, "is_private": false, "text": "The code intended to inflate gzipped content bodies appears to have an unimplemented edge case which I believe renders it unusable for most scenarios.\n\nThe problem is in the code to verify decompressed data by comparing the CRC value and length with that provided by the client in the last eight bytes of the request. If the gzip stream has been completely decompressed but the verification bytes are still on the wire, it looks like the decompression will fail as if the CRC or length were invalid:\n\n  /* Is the remaining 8 bytes already in the avail stream? */\n  if (ctx->stream.avail_in >= 8) {\n    ...\n  }\n  else {\n    /* FIXME: We need to grab the 8 verification bytes\n    * from the wire! */\n  inflateEnd(&ctx->stream);\n  return APR_EGENERAL;\n}\n\nI'm trying to get some traction on implementing gzipped bodies in Firefox ( https://bugzilla.mozilla.org/show_bug.cgi?id=463089 ), but I'm unlikely to get anywhere if the only server which supports it fails on valid requests that happen to be a certain length.", "id": 122188, "time": "2008-11-04T13:48:46Z", "creator": "greenreaper@hotmail.com", "creation_time": "2008-11-04T13:48:46Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 46146, "attachment_id": 30285, "id": 167222, "time": "2013-05-15T15:26:41Z", "creator": "ksacry@gmail.com", "creation_time": "2013-05-15T15:26:41Z", "is_private": false, "text": "Created attachment 30285\nPatch for bug 46146 where mod_deflate does not wait for all the validation data before trying to validate the input\r\nPatch is for 2.2.24\n\nThis is a patch for 2.2.4"}, {"count": 2, "text": "Just uploaded a patch that fixes this for 2.2.4.\nMostly borowed from inflate_out_filter", "bug_id": 46146, "is_private": false, "id": 167223, "time": "2013-05-15T15:29:19Z", "creator": "ksacry@gmail.com", "creation_time": "2013-05-15T15:29:19Z", "tags": [], "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 46146, "attachment_id": null, "id": 167224, "time": "2013-05-15T15:32:26Z", "creator": "ksacry@gmail.com", "creation_time": "2013-05-15T15:32:26Z", "is_private": false, "text": "Sorry, meant to say 2.2.24, not 2.2.4"}, {"count": 4, "tags": [], "bug_id": 46146, "attachment_id": null, "is_private": false, "id": 167343, "time": "2013-05-21T23:07:57Z", "creator": "mike.rumph@oracle.com", "creation_time": "2013-05-21T23:07:57Z", "text": "The following error message in the attached patch has a slight spelling error:\n\"Zlib: didn't recieve valid gzip magic bytes\"\n\n'recieve' should be 'receive'."}, {"count": 5, "tags": [], "bug_id": 46146, "attachment_id": 30314, "id": 167361, "time": "2013-05-22T19:31:32Z", "creator": "ksacry@gmail.com", "creation_time": "2013-05-22T19:31:32Z", "is_private": false, "text": "Created attachment 30314\nnew patch with spelling fixed\n\nThanks to Mike Rumph for pointing out the spelling error"}, {"count": 6, "tags": [], "bug_id": 46146, "attachment_id": 31259, "id": 172751, "time": "2014-01-28T16:28:01Z", "creator": "christian.nols@mcl-technologies.com", "creation_time": "2014-01-28T16:28:01Z", "is_private": false, "text": "Created attachment 31259\nPatch proposal\n\nPatch proposal tested on Apache 2.4.4\n\nMove the CRC/Length check only after the 8 validation bytes are received.\nUse the internal validation buffer for storage.\n\nTest scenario.\nI had two specific file upload that were causing the issue.\nTransfer in chunked encoding and 6 bytes where in the last chunk.\nThe problem was systematic and is now solved.\n\nI cannot attach the problematic files (customer data) and a custom HTTPClient is required to do the deflate/chunking."}, {"count": 7, "text": "*** Bug 52492 has been marked as a duplicate of this bug. ***", "bug_id": 46146, "is_private": false, "id": 172753, "time": "2014-01-28T16:28:48Z", "creator": "christian.nols@mcl-technologies.com", "creation_time": "2014-01-28T16:28:48Z", "tags": [], "attachment_id": null}, {"count": 8, "tags": [], "creator": "ylavic.dev@gmail.com", "attachment_id": null, "id": 172757, "time": "2014-01-28T18:36:35Z", "bug_id": 46146, "creation_time": "2014-01-28T18:36:35Z", "is_private": false, "text": "There are multiples patches in Bug 55666 which address this too..."}, {"count": 9, "text": "*** Bug 55666 has been marked as a duplicate of this bug. ***", "bug_id": 46146, "is_private": false, "id": 173522, "time": "2014-02-27T16:11:33Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-02-27T16:11:33Z", "tags": [], "attachment_id": null}, {"count": 10, "text": "Thanks for the patches, commited in r1572668 with a similar approach to Christian's one, and with related commits onto the other input/output filters.", "bug_id": 46146, "attachment_id": null, "id": 173538, "time": "2014-02-28T12:16:27Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-02-28T12:16:27Z", "tags": [], "is_private": false}, {"count": 11, "tags": [], "bug_id": 46146, "attachment_id": null, "text": "Commits are from the pacthes staged in Bug 55666.", "id": 173539, "time": "2014-02-28T12:18:29Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-02-28T12:18:29Z", "is_private": false}, {"count": 12, "tags": [], "creator": "t_guerin@hotmail.com", "attachment_id": null, "is_private": false, "id": 174581, "time": "2014-04-15T10:24:06Z", "bug_id": 46146, "creation_time": "2014-04-15T10:24:06Z", "text": "Hi,\nthanks a lot for the fix, I'm PUTting gzipped files and the upload would not work on some files (on 2.2.x and 2.4.x). So in its current state, sending gzipped content is indeed unusable; I really apreciate that work is being done in this area.\n\nHowever, the patches introduced here unfortunately result in a situation that is in fact worse with some files (I have attached one):\n- before the patches\n  * with version 2.2.x, I get an error 500 and a message \"Could not get next bucket brigade  [500, #0]\" in the error log. There is no file on the server. BUT if I retry several times (between 1 and 9 times, this varies), the file gets correctly written.\n  * with version 2.4.x, I get an error 500 and a warning \"AH01396: Verification data not available (bug?)\", then an error \"An error occurred while reading the request body (URI: /uploads/curl.xml)  [500, #0]\". There is no file on the server. BUT if I retry several times (more than 20 times, again this varies), the file gets written, but is truncated (its size varies)\n  * with trunk, (before this patch is applied),  I get an error 400 and a warning \"AH01396: Verification data not available (bug?)\", then an error \"An error occurred while reading the request body (URI: /uploads/curl.xml)  [400, #0]\". There is no file on the server. I haven't tried multiple times.\n- after the patches, there is no message in the error log and a code 201 is returned BUT the written file is truncated. Its size is always the same.\n\nI have tested version 2.2.27 and 2.4.9 both on Windows & Debian, but the trunk has only been tested on Debian.\n\nThz gzip stream is created via a Java program, but the error can be reproduced with the command 'gzip -n myFile.xml'\n\nTo reproduce the problem:\ncurl -H \"Content-Encoding: gzip\" --upload-file raw.xml http://localhost/uploads/\n\n(with raw.xml being the result of the gzip command)\n\nI will attach both the xml file (curl.xml) and its gzipped version (gzip.xml).\nAlmost any small alteration to the xml file (like adding/removing a space) solves the problem.\n\nI have added the comment to this bug, because its fix results (in my opinion) in things being unfotunately worse, but if you think that this belongs in a separate bug, I'll create one.\nHope this helps."}, {"count": 13, "tags": [], "creator": "t_guerin@hotmail.com", "attachment_id": 31526, "id": 174582, "time": "2014-04-15T10:26:18Z", "bug_id": 46146, "creation_time": "2014-04-15T10:26:18Z", "is_private": false, "text": "Created attachment 31526\nfiles to reproduce the problem described in comment #12"}, {"count": 14, "tags": [], "creator": "t_guerin@hotmail.com", "attachment_id": 31527, "id": 174583, "time": "2014-04-15T10:27:59Z", "bug_id": 46146, "creation_time": "2014-04-15T10:27:59Z", "is_private": false, "text": "Created attachment 31527\nfile to reproduce the problem described in comment #12 (gzip)"}, {"count": 15, "tags": [], "bug_id": 46146, "attachment_id": null, "text": "Thanks for reporting, could you include your mod_deflate configuration?", "id": 174585, "time": "2014-04-15T11:09:47Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-04-15T11:09:47Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 46146, "attachment_id": null, "is_private": false, "id": 174588, "time": "2014-04-15T11:35:35Z", "creator": "t_guerin@hotmail.com", "creation_time": "2014-04-15T11:35:35Z", "text": "Sorry, forgot to mention that I used WebDav:\n\nDavLockDB \"/usr/local/apache2/var/DavLock\"\n\nAlias /uploads \"/usr/local/apache2/uploads\"\n<Directory \"/usr/local/apache2/uploads\">\n    Dav On\n    Order Allow,Deny\n    Allow from all\n    Options Indexes FollowSymLinks\n    SetInputFilter DEFLATE\n</Directory>\n\n(with of course mod_deflate, mod_dav and mod_dav_fs enabled)"}, {"attachment_id": 31528, "tags": [], "bug_id": 46146, "is_private": false, "count": 17, "id": 174595, "time": "2014-04-15T14:06:34Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-04-15T14:06:34Z", "text": "Created attachment 31528\nDelay filter removal after we provide (not read) the EOS\n\nCould you please try the attached patch?\nI can't reproduce anymore with it applied.\nThanks again Thierry for the test case."}, {"count": 18, "tags": [], "creator": "t_guerin@hotmail.com", "attachment_id": null, "id": 174599, "time": "2014-04-15T15:24:17Z", "bug_id": 46146, "creation_time": "2014-04-15T15:24:17Z", "is_private": false, "text": "bug fixed, fantastic! Thanks a lot for your (lightning-fast) help.\n\nDo you think that this will be backported to the 2.2.x branch? (I suppose it will be backported to the 2.4.x (correct me if I'm wrong))"}, {"attachment_id": null, "tags": [], "creator": "ylavic.dev@gmail.com", "is_private": false, "count": 19, "id": 174600, "time": "2014-04-15T15:51:57Z", "bug_id": 46146, "creation_time": "2014-04-15T15:51:57Z", "text": "(In reply to Thierry Gu\u00e9rin from comment #18)\n> Do you think that this will be backported to the 2.2.x branch? (I suppose it\n> will be backported to the 2.4.x (correct me if I'm wrong))\n\nThe whole bundle for this and Bug 55666 is already proposed for backport in 2.4, waiting for more votes.\n\nOnce/if accepted, I will propose a 2.2 backport too."}, {"attachment_id": null, "tags": [], "creator": "ylavic.dev@gmail.com", "is_private": false, "count": 20, "id": 175966, "time": "2014-06-21T22:54:54Z", "bug_id": 46146, "creation_time": "2014-06-21T22:54:54Z", "text": "Backported to upcoming 2.4.10."}]