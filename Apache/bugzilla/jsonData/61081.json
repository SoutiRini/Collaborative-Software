[{"count": 0, "tags": [], "creator": "felipe@felipegasper.com", "text": "Currently there is no way to associate an SSL certificate with a specific FQDN unless that FQDN is the only one on its virtual host. We have longstanding user expectations of specific patterns of FQDN/vhost grouping, though, so we can\u2019t switch to that without a great deal of pain for ourselves and our customers.\n\nWe could use Include and mimic the behavior, but that would increase the load time on machines that serve many thousands of vhosts.\n\nThe situation is aggravated by the fact that all other SSL-enabled services that we deploy--Exim, Dovecot, ProFTPd, and our own application--make it simple to associate an SSL certificate with a specific FQDN. So we\u2019re having to maintain two separate SSL datastores and trying not to have our end users worry about the complexities of Apache\u2019s model versus everyone else\u2019s, but it doesn\u2019t always work.\n\nHas there been any discussion of a simple FQDN-to-certificate index in the config, as an alternative to vhost-based SNI?\n\ne.g.:\n\n-----------------\n<NameBasedSNI>\n    <Name example.com www.example.com>\n        CertificateChainFile /path/to/certs/chain\n        CertificateKeyFile /path/to/key\n    </Name>\n    <Name somealias.com www.somealias.com>\n        CertificateChainFile /path/to/certs/chain\n        CertificateKeyFile /path/to/key\n    </Name>\n    <Name mail.somealias.com>\n        CertificateChainFile /path/to/certs/chain\n        CertificateKeyFile /path/to/key\n    </Name>\n    <Name *.somealias.com>\n        CertificateChainFile /path/to/certs/chain\n        CertificateKeyFile /path/to/key\n    </Name>\n</NameBasedSNI>\n\n\u2026 then there would just be the normal vhost configuration:\n\n<VirtualHost 1.2.3.4:443>\n    ServerName example.com\n    ServerAlias www.example.com somealias.com www.somealias.com\n    #...\n</VirtualHost>\n-----------------\n\nThis would allow applications like ours to treat Apache the same way as other services: there could just be a single datastore of certificates, indexed by domain, rather than having to maintain Apache\u2019s as a \u201cspecial exception\u201d.\n\nWhile this is just our own particular deployment, it\u2019s also one that powers probably millions of sites. It also seems to me that decoupling the SNI from the delivered content would be a better design?\n\nThank you for your consideration!", "id": 198742, "time": "2017-05-09T14:32:36Z", "bug_id": 61081, "creation_time": "2017-05-09T14:32:36Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "text": "(In reply to felipe from comment #0)\n> Currently there is no way to associate an SSL certificate with a specific\n> FQDN unless that FQDN is the only one on its virtual host.\n\nIs this true? The code looks like it scans ServerAlias entries (ssl_util_vhost_matches) to use the SNI name to map to an SSL vhost config.", "is_private": false, "id": 198743, "creator": "covener@gmail.com", "time": "2017-05-09T15:06:46Z", "bug_id": 61081, "creation_time": "2017-05-09T15:06:46Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 61081, "attachment_id": null, "id": 198744, "time": "2017-05-09T15:11:52Z", "creator": "felipe@felipegasper.com", "creation_time": "2017-05-09T15:11:52Z", "is_private": false, "text": "(In reply to Eric Covener from comment #1)\n> (In reply to felipe from comment #0)\n> > Currently there is no way to associate an SSL certificate with a specific\n> > FQDN unless that FQDN is the only one on its virtual host.\n> \n> Is this true? The code looks like it scans ServerAlias entries\n> (ssl_util_vhost_matches) to use the SNI name to map to an SSL vhost config.\n\nThis associates the certificate with the vhost, not with an individual FQDN. So all FQDNs on the vhost have to share a single certificate.\n\nWhat I\u2019m proposing is a means to decouple the vhost logic from SNI matching: if there\u2019s a matching NameBasedSNI entry for the cert/key, then use that; otherwise, do business as usual."}, {"count": 3, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "id": 198745, "time": "2017-05-09T15:24:21Z", "bug_id": 61081, "creation_time": "2017-05-09T15:24:21Z", "is_private": false, "text": "(In reply to felipe from comment #2)\n> (In reply to Eric Covener from comment #1)\n> > (In reply to felipe from comment #0)\n> > > Currently there is no way to associate an SSL certificate with a specific\n> > > FQDN unless that FQDN is the only one on its virtual host.\n> > \n> > Is this true? The code looks like it scans ServerAlias entries\n> > (ssl_util_vhost_matches) to use the SNI name to map to an SSL vhost config.\n> \n> This associates the certificate with the vhost, not with an individual FQDN.\n> So all FQDNs on the vhost have to share a single certificate.\n> \n> What I\u2019m proposing is a means to decouple the vhost logic from SNI matching:\n> if there\u2019s a matching NameBasedSNI entry for the cert/key, then use that;\n> otherwise, do business as usual.\n\nI see, I think that is reasonable, but I would suggest avoiding new container/section construct for it.  In a proprietary SSL plugin, that uses\nnamed certificates rather than paths, it was just repeated\n\"SSLSNIMap hostname label\".\n\nThe interaction with current ssl-vhost-config selection by SNI would need to be sorted out too.  Documenting the status quo would be a good start!"}, {"count": 4, "attachment_id": null, "creator": "felipe@felipegasper.com", "text": "(In reply to Eric Covener from comment #3)\n> \n> I see, I think that is reasonable, but I would suggest avoiding new\n> container/section construct for it.  In a proprietary SSL plugin, that uses\n> named certificates rather than paths, it was just repeated\n> \"SSLSNIMap hostname label\".\n\nHowever it seems most reasonably implemented in the config would be fine with me. :)\n\nIt seems like right before ssl_find_vhost() is where this would happen?\n\n> \n> The interaction with current ssl-vhost-config selection by SNI would need to\n> be sorted out too.  Documenting the status quo would be a good start!\n\nI think just having a fallback would suffice?", "id": 198746, "time": "2017-05-09T15:37:33Z", "bug_id": 61081, "creation_time": "2017-05-09T15:37:33Z", "tags": [], "is_private": false}, {"count": 5, "tags": [], "text": "Incidentally, lighttpd\u2019s SNI functionality is per-domain, not per-vhost:\n\n$SERVER[\"socket\"] == \":443\" {\n    ssl.engine  = \"enable\" \n    ssl.pemfile = \"/etc/lighttpd/ssl/the-default-domain.com.pem\" \n    $HTTP[\"host\"] == \"www.example.org\" {\n        ssl.pemfile = \"/etc/lighttpd/www.example.org.pem\" \n    }\n    $HTTP[\"host\"] == \"mail.example.org\" {\n        ssl.pemfile = \"/etc/lighttpd/mail.example.org.pem\" \n    }\n}", "is_private": false, "id": 198751, "creator": "felipe@felipegasper.com", "time": "2017-05-10T00:11:25Z", "bug_id": 61081, "creation_time": "2017-05-10T00:11:25Z", "attachment_id": null}]