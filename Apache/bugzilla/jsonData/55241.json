[{"count": 0, "tags": [], "text": "It looks like issue #53173 is not fixed completely. Recently we had a similar issue under Tomcat 7.0.34 / BIO connector when Acceptor thread hung forever on LimitLatch:\n\n\"http-bio-63.215.91.155-8443-Acceptor-0\" daemon prio=10 tid=0x0000000001656800 nid=0x540c waiting on condition [0x00007fb64aa2f000]\n   java.lang.Thread.State: WAITING (parking)\n\tat sun.misc.Unsafe.park(Native Method)\n\t- parking to wait for  <0x0000000763e49970> (a org.apache.tomcat.util.threads.LimitLatch$Sync)\n\tat java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:834)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:994)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1303)\n\tat org.apache.tomcat.util.threads.LimitLatch.countUpOrAwait(LimitLatch.java:115)\n\tat org.apache.tomcat.util.net.AbstractEndpoint.countUpOrAwaitConnection(AbstractEndpoint.java:718)\n\tat org.apache.tomcat.util.net.JIoEndpoint$Acceptor.run(JIoEndpoint.java:210)\n\tat java.lang.Thread.run(Thread.java:722)\n\nTomcat is run with maxThreads=\"1000\" and maxConnections=\"1000\"\nThis can be reproduced via the following scenario in our environment:\n1. Start tcpkill in the following way to kill the connection from client to Tomcat for requests larger than 2000:\ntcpkill host <host> and port 8185 and greater 2000\n2. Access Tomcat several times. As soon as the number of ClientAbortException errors reaches the number of threads (or connections), Acceptor thread blocks in WAITING state and Tomcat stops accepting new connections", "is_private": false, "id": 168510, "creation_time": "2013-07-11T13:10:13Z", "time": "2013-07-11T13:10:13Z", "creator": "kudryashov@gmail.com", "bug_id": 55241, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 55241, "attachment_id": null, "id": 168523, "time": "2013-07-11T20:48:15Z", "creator": "markt@apache.org", "creation_time": "2013-07-11T20:48:15Z", "is_private": false, "text": "I have tested this with the latest Tomcat 7.0.x code and with trunk on both Windows and Linux and am unable to reproduce it.\n\nIf you still see this issue with the latest 7.0.x release feel free to re-open this issue but you'll need to add enough information for the issue to be reproduced.\n\nWhat might help is if you have a stack trace of the ClientAbortException as reported by Tomcat as it might show a code path where the socket isn't getting removed from the count once it closes."}, {"count": 2, "tags": [], "bug_id": 55241, "text": "Created attachment 30619\ntcp dump for reproduction\n\nReproduced on Tomcat/7.0.42\n\n8185 - is port of tomcat.\nConnection is established and in the middle of communication packet len=7300 is sent from tomcat to client. This packet is blocked by tcpkill expression \"host 89.113.129.49 and port 8185 and greater 2000\". This blocking action are creating ClientAbortException.", "id": 168740, "time": "2013-07-23T18:35:52Z", "creator": "vyacheslav.gusev@gmail.com", "creation_time": "2013-07-23T18:35:52Z", "is_private": false, "attachment_id": 30619}, {"count": 3, "tags": [], "bug_id": 55241, "is_private": false, "text": "For easier reproduce we use 5 threads in executor. Here head of our server.xml\n\n<Server port=\"${SHUTDOWN_PORT}\" shutdown=\"SHUTDOWN\">\n\n  <Listener className=\"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener\"/>\n\n  <GlobalNamingResources/>\n\n  <Service name=\"${target}\">\n\n     <Executor name=\"common_executor\"\n               maxThreads=\"5\"\n\t\tminSpareThreads=\"1\"\n     />\n\n     <Connector port=\"${HTTPS_PORT}\"\n               address=\"${HTTP_ADDR}\"\n               executor=\"common_executor\"\n               enableLookups=\"false\"\n               disableUploadTimeout=\"true\"\n               acceptCount=\"5\"\n               connectionTimeout=\"10000\"\n               keepAliveTimeout=\"0\"\n               maxKeepAliveRequests=\"-1\"\n\t       scheme=\"https\" secure=\"true\"\n               clientAuth=\"false\" SSLEnabled=\"true\" sslProtocol=\"TLS\"\n               keystorePass=\"keystorepass\"\n               keystoreFile=\"keystore.p12\"\n               keystoreType=\"PKCS12\"\n    />\n\n\n\nAfter 5 ClientAbortExeptions we stuck.", "id": 168741, "time": "2013-07-23T18:38:36Z", "creator": "vyacheslav.gusev@gmail.com", "creation_time": "2013-07-23T18:38:36Z", "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 55241, "text": "Re-open to see if there is enough information to reproduce this. The stacktrace from a ClientAbortException may be helpful.\n\nNote: Using SSL & Executor", "id": 168744, "time": "2013-07-23T19:35:14Z", "creator": "markt@apache.org", "creation_time": "2013-07-23T19:35:14Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "creator": "vyacheslav.gusev@gmail.com", "is_private": false, "id": 168755, "attachment_id": null, "bug_id": 55241, "creation_time": "2013-07-24T10:44:38Z", "time": "2013-07-24T10:44:38Z", "text": "\nClientAbortException:  java.net.SocketException: Connection reset\n\tat org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:406)\n\tat org.apache.tomcat.util.buf.ByteChunk.flushBuffer(ByteChunk.java:480)\n\tat org.apache.tomcat.util.buf.ByteChunk.append(ByteChunk.java:310)\n\tat org.apache.catalina.connector.OutputBuffer.writeByte(OutputBuffer.java:450)\n\tat org.apache.catalina.connector.CoyoteOutputStream.write(CoyoteOutputStream.java:77)\n\tat java.io.DataOutputStream.writeInt(DataOutputStream.java:200)\n\tat gft.chart.impl.QuotesResponse.storeObject(QuotesResponse.java:38)\n\tat common.util.storable.StorableOutputStream.writeStorableCursor(StorableOutputStream.java:117)\n\tat common.util.storable.StorableOutputStream.writeSingle(StorableOutputStream.java:71)\n\tat common.util.storable.StorableOutputStream.writeObject(StorableOutputStream.java:58)\n\tat common.util.rif.RequestResponseSerializer.serializeResponse(RequestResponseSerializer.java:88)\n\tat common.gateway.HttpGateway.finalizeRequestProcessing(HttpGateway.java:494)\n\tat common.gateway.HttpGateway.processRemoteInvocation(HttpGateway.java:440)\n\tat common.gateway.HttpGateway.doPost(HttpGateway.java:154)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:647)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:728)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:305)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:222)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:123)\n\tat org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:502)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:99)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1023)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:589)\n\tat org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:310)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:722)\nCaused by: java.net.SocketException: Connection reset\n\tat java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:113)\n\tat java.net.SocketOutputStream.write(SocketOutputStream.java:153)\n\tat sun.security.ssl.OutputRecord.writeBuffer(OutputRecord.java:377)\n\tat sun.security.ssl.OutputRecord.write(OutputRecord.java:363)\n\tat sun.security.ssl.SSLSocketImpl.writeRecordInternal(SSLSocketImpl.java:830)\n\tat sun.security.ssl.SSLSocketImpl.writeRecord(SSLSocketImpl.java:801)\n\tat sun.security.ssl.AppOutputStream.write(AppOutputStream.java:122)\n\tat org.apache.coyote.http11.InternalOutputBuffer.realWriteBytes(InternalOutputBuffer.java:215)\n\tat org.apache.tomcat.util.buf.ByteChunk.flushBuffer(ByteChunk.java:480)\n\tat org.apache.tomcat.util.buf.ByteChunk.append(ByteChunk.java:366)\n\tat org.apache.coyote.http11.InternalOutputBuffer$OutputStreamOutputBuffer.doWrite(InternalOutputBuffer.java:240)\n\tat org.apache.coyote.http11.filters.IdentityOutputFilter.doWrite(IdentityOutputFilter.java:84)\n\tat org.apache.coyote.http11.AbstractOutputBuffer.doWrite(AbstractOutputBuffer.java:192)\n\tat org.apache.coyote.Response.doWrite(Response.java:517)\n\tat org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:401)\n\t... 30 more\nException in thread \"tomcat-exec-7\" java.lang.InternalError: response serialization failed: null\n\tat common.util.rif.RequestResponseSerializer.serializeResponse(RequestResponseSerializer.java:91)\n\tat common.gateway.HttpGateway.finalizeRequestProcessing(HttpGateway.java:494)\n\tat common.gateway.HttpGateway.processRemoteInvocation(HttpGateway.java:440)\n\tat common.gateway.HttpGateway.doPost(HttpGateway.java:154)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:647)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:728)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:305)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:222)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:123)\n\tat org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:502)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:99)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1023)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:589)\n\tat org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:310)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:722)"}, {"attachment_id": null, "tags": [], "creator": "vyacheslav.gusev@gmail.com", "text": "Reproduced also with APR. NOT reproduced with NIO.\n\nHere is APR ClientAbortException stack trace.\n\n\n\n\nClientAbortException:  java.io.IOException\n        at org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:388)\n        at org.apache.tomcat.util.buf.ByteChunk.flushBuffer(ByteChunk.java:462)\n        at org.apache.tomcat.util.buf.ByteChunk.append(ByteChunk.java:310)\n        at org.apache.catalina.connector.OutputBuffer.writeByte(OutputBuffer.java:432)\n        at org.apache.catalina.connector.CoyoteOutputStream.write(CoyoteOutputStream.java:77)\n        at java.io.DataOutputStream.writeInt(DataOutputStream.java:200)\n        at gft.chart.impl.QuotesResponse.storeObject(QuotesResponse.java:38)\n        at common.util.storable.StorableOutputStream.writeStorableCursor(StorableOutputStream.java:117)\n        at common.util.storable.StorableOutputStream.writeSingle(StorableOutputStream.java:71)\n        at common.util.storable.StorableOutputStream.writeObject(StorableOutputStream.java:58)\n        at common.util.rif.RequestResponseSerializer.serializeResponse(RequestResponseSerializer.java:88)\n        at common.gateway.HttpGateway.finalizeRequestProcessing(HttpGateway.java:494)\n        at common.gateway.HttpGateway.processRemoteInvocation(HttpGateway.java:440)\n        at common.gateway.HttpGateway.doPost(HttpGateway.java:154)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:647)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:728)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:305)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:222)\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:123)\n        at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:472)\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:99)\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:407)\n        at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1004)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:589)\n        at org.apache.tomcat.util.net.AprEndpoint$SocketWithOptionsProcessor.run(AprEndpoint.java:1780)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:722)\nCaused by: java.io.IOException\n        at org.apache.coyote.http11.InternalAprOutputBuffer.flushBuffer(InternalAprOutputBuffer.java:205)\n        at org.apache.coyote.http11.InternalAprOutputBuffer.access$100(InternalAprOutputBuffer.java:37)\n        at org.apache.coyote.http11.InternalAprOutputBuffer$SocketOutputBuffer.doWrite(InternalAprOutputBuffer.java:235)\n        at org.apache.coyote.http11.filters.IdentityOutputFilter.doWrite(IdentityOutputFilter.java:84)\n        at org.apache.coyote.http11.AbstractOutputBuffer.doWrite(AbstractOutputBuffer.java:192)\n        at org.apache.coyote.Response.doWrite(Response.java:505)\n        at org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:383)\n        ... 30 more\nException in thread \"tomcat-exec-5\" java.lang.InternalError: response serialization failed: null\n        at common.util.rif.RequestResponseSerializer.serializeResponse(RequestResponseSerializer.java:91)\n        at common.gateway.HttpGateway.finalizeRequestProcessing(HttpGateway.java:494)\n        at common.gateway.HttpGateway.processRemoteInvocation(HttpGateway.java:440)\n        at common.gateway.HttpGateway.doPost(HttpGateway.java:154)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:647)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:728)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:305)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:222)\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:123)\n        at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:472)\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:99)\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:407)\n        at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1004)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:589)\n        at org.apache.tomcat.util.net.AprEndpoint$SocketWithOptionsProcessor.run(AprEndpoint.java:1780)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:722)", "count": 6, "id": 168762, "time": "2013-07-24T14:33:53Z", "bug_id": 55241, "creation_time": "2013-07-24T14:33:53Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 55241, "is_private": false, "text": "One last piece, please provide a full thread dump from the Tomcat instance once the acceptor has stopped accepting new connections. A thread dump from when you are using just 5 threads in the executor is fine - in fact it is preferred.", "id": 168815, "time": "2013-07-26T13:39:16Z", "creator": "markt@apache.org", "creation_time": "2013-07-26T13:39:16Z", "attachment_id": null}, {"count": 8, "tags": [], "creator": "vyacheslav.gusev@gmail.com", "text": "Created attachment 30634\nThread stack of hanged tomcat connector", "id": 168830, "attachment_id": 30634, "bug_id": 55241, "creation_time": "2013-07-26T18:56:36Z", "time": "2013-07-26T18:56:36Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 55241, "attachment_id": null, "id": 168938, "time": "2013-07-30T08:20:47Z", "creator": "markt@apache.org", "creation_time": "2013-07-30T08:20:47Z", "is_private": false, "text": "Thanks for the additional information. This does point towards a Tomcat bug. I'm currently lookng at the stack trace to see if that provides any clues as to what is going wrong."}, {"count": 10, "tags": [], "bug_id": 55241, "is_private": false, "text": "Your code is throwing java.lang.InternalError which is a sub-class of java.lang.VirtualMachineError\n\nThe javadoc states that VirtualMachineError is:\n<quote>\nThrown to indicate that the Java Virtual Machine is broken or has run out of resources necessary for it to continue operating.\n</quote>\n\nTomcat handles application code throwing any Throwablte with two exceptions:\n- OutOfMemoryError\n- VirtualMachineError\nas both of these are considered fatal to the JVM.\n\nIn this case the application should not be throwing java.lang.InternalError as the JVM is neither broken nor has it run out of resources.\n\nThe reason I could not repeat this is that your steps to reproduce generates a ClientAbortException which is correctly handled. My test did not generate a java.lang.InternalError\n\nThat NIO did not exhibit the problem was due to a bug in the NIO connector (now fixed) that incorrectly swallowed VirtualMachineErrors.", "id": 168942, "time": "2013-07-30T09:05:06Z", "creator": "markt@apache.org", "creation_time": "2013-07-30T09:05:06Z", "attachment_id": null}]