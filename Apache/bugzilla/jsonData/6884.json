[{"count": 0, "tags": [], "bug_id": 6884, "attachment_id": null, "id": 11478, "time": "2002-03-05T19:22:29Z", "creator": "gary.mullenschultz@kingland.com", "creation_time": "2002-03-05T19:22:29Z", "is_private": false, "text": "Our application stopped working when we migrated from 4.0.1 to 4.0.2; we would \nget NoClassDefFoundErrors thrown for one of our classes.\n\nThis class resides in a jar file inside WEB-INF/lib.  As it turns out, we had \npackaged some J2SE classes (com.sun.jndi and javax.security) in that jar.\n\nI understand the meaning of section 9.7.2 of the servlet 2.3 spec; however, I \nthink the current implementation needs to do one (or more) of the following so \nthat folks understand what's going on when they get this error:\n\n1. Log an error of some kind.  Even setting the loader to debug=\"99\" did not \nresult in an error message; validateJarFile just returns false and the jar does \nnot get loaded.\n2. Throw an exception indicating that the jar cannot be loaded, and indicate \nthe guilty class in question.\n3. Load \"acceptable\" classes from the jar file, but not the offending ones.\n\nThis is a very difficult problem to debug for someone unfamiliar with the \nTomcat source code.\n\nThanks for a great product, Gary"}, {"count": 1, "tags": [], "bug_id": 6884, "attachment_id": null, "id": 11480, "time": "2002-03-05T19:39:21Z", "creator": "remm@apache.org", "creation_time": "2002-03-05T19:39:21Z", "is_private": false, "text": "This part of the code has been reworked since. 4.0.4 b1 should fix most\nproblems, except if your JAR includes servlet API classes. I'll add the logging\ncode you suggest."}, {"count": 2, "tags": [], "creator": "bob@jadn.com", "attachment_id": null, "is_private": false, "id": 17415, "time": "2002-06-07T16:45:52Z", "bug_id": 6884, "creation_time": "2002-06-07T16:45:52Z", "text": "\nI checked 4.1.3 and it also has this issue. The patch at the bottom adds\nlogging.  Although looking at the class, I am concerned that\nWebappClassLoader.java only checks for one class \"javax.servlet.Servlet.class\"\n\nPerahaps it would be wiser to loop through the jar's contents and reject it\nif anything startsWith(\"javax/servlet/\") ?\n\n\nIndex:\njakarta-tomcat-4.0/catalina/src/share/org/apache/catalina/loader/WebappClassLoader.java\n===================================================================\nRCS file:\n/home/cvspublic/jakarta-tomcat-4.0/catalina/src/share/org/apache/catalina/loader/WebappClassLoader.java,v\nretrieving revision 1.39\ndiff -u -r1.39 WebappClassLoader.java\n---\njakarta-tomcat-4.0/catalina/src/share/org/apache/catalina/loader/WebappClassLoader.java    \n22 May 2002 23:35:52 -0000       1.39\n+++\njakarta-tomcat-4.0/catalina/src/share/org/apache/catalina/loader/WebappClassLoader.java    \n7 Jun 2002 16:35:48 -0000\n@@ -1994,6 +1994,7 @@\n                 log(\" Checking for \" + name);\n             JarEntry jarEntry = jarFile.getJarEntry(name);\n             if (jarEntry != null) {\n+                log(\"validateJarFile(\"+jarfile+\") - jar not loaded. See Servlet\nSpec 2.3, section 9.7.2. Offending class: \" + name);\n                 jarFile.close();\n                 return (false);\n             }\n\n"}, {"count": 3, "attachment_id": null, "creator": "remm@apache.org", "text": "I applied the patch.", "id": 17449, "time": "2002-06-08T23:36:18Z", "bug_id": 6884, "creation_time": "2002-06-08T23:36:18Z", "tags": [], "is_private": false}]