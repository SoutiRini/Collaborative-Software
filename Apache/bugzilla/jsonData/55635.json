[{"count": 0, "tags": [], "creator": "vivanv@mail.ru", "attachment_id": null, "id": 170461, "time": "2013-10-07T09:06:08Z", "bug_id": 55635, "creation_time": "2013-10-07T09:06:08Z", "is_private": false, "text": "mod_remoteip remove first not trusted IP(Client IP) from RemoteIPHeader\n\nhttpd.conf\nRemoteIPHeader X-Forwarded-For\nRemoteIPInternalProxy 172.20.106.70\nRemoteIPTrustedProxy 87.250.250.203\n\nLogFormat \"%h %a %{c}a %{X-Forwarded-For}i %l %u %t \\\"%m\\\" \\\"%r&\\\" \\\"%q&\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" pid=%{pid}P tid=%{tid}P time_ms=%D\" combined\nCustomLog \"|/import/home/ivan.voronin/tmp/tmp/apache_project/distrib/apache2/bin/rotatelogs logs/access_log.%Y.%m.%d 86400\" combined\n\n<Location /test>\n\tOrder Deny,Allow\n\tDeny from all\n\tAllow from localhost 127.0.0.1 1.1.1.1\n</Location>\n\nGET http://srv2-x64rh6-01:1280/test/1.xml\n\n[no cookies]\n\nRequest Headers:\nConnection: keep-alive\nX-Forwarded-For: 1.1.1.2, 1.1.1.1, 87.245.198.54, 87.250.250.203\nAccept: */*\nHost: srv2-x64rh6-01:1280\nUser-Agent: Apache-HttpClient/4.1.2 (java 1.5)\n\naccess_log.2013.10.07:\nivoronin.net.billing.ru 87.245.198.54 172.20.106.70 1.1.1.2, 1.1.1.1 - - [07/Oct/2013:12:44:00 +0400] \"GET\" \"GET /test/1.xml HTTP/1.1&\" \"&\" 403 212 \"-\" \"Apache-HttpClient/4.1.2 (java 1.5)\" pid=27844 tid=140346537215744 time_ms=3111\n\nAs you can see, mod_remoteip removed 87.245.198.54 from X-Forwarded-For (RemoteIPHeader).\nThis is not the behavior as documented because 87.245.198.54 is not configured to be \"trusted\".\nSo, it's not possible to pass correct Client IP to backend if the mod_remoteip is used."}, {"count": 1, "tags": [], "text": "Hello Ivan,\n\nThanks for reporting this.\n\nI have been trying to replicate your setup, but I am getting different results.\nI am using httpd trunk on a Linux system.\nPerhaps you are running a different version of httpd?\n\nI've made a few changes that should still be equivalent.\n\n1)  I changed the LogFormat as follows to make the log entries a little easier for me to read:\n\nLogFormat \"%h %a %{c}a xf=\\\"%{X-Forwarded-For}i\\\" %l %u %t \\\"%m\\\" \\\"%r&\\\" \\\"%q&\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" pid=%{pid}P tid=%{tid}P time_ms=%D\" combined\n\n2)  I am using curl instead of Apache HTTP Client similar to the following:\n\ncurl -v -H \"X-Forwarded-For: 1.1.1.2, 1.1.1.1, 87.245.198.54, 87.250.250.203\" http://srv2-x64rh6-01:1280/test/1.xml \n\n3)  I changed the value of RemoteIPInternalProxy to match my own client server. (which is also a private network IP like yours)\n\n4)  The rest of the addresses are exactly the same as yours.\n\nThe result I am getting is equivalent to the following changes to your results:\n\naccess_log.2013.10.07:\nivoronin.net.billing.ru 1.1.1.2 172.20.106.70 xf=\"-\" - - [07/Oct/2013:12:44:00 +0400] \"GET\" \"GET /test/1.xml HTTP/1.1&\" \"&\" 403 212 \"-\" \"Apache-HttpClient/4.1.2 (java 1.5)\" pid=27844 tid=140346537215744 time_ms=3111\n\nIn other words, the client IP is changed to the first IP address in the X-Forwarded-For list and the X-Forwarded-For header is cleared.\n\nIf I change the Allow to \"Allow from localhost 127.0.0.1 1.1.1.2\", I get the following equivalent result:\n\naccess_log.2013.10.07:\nivoronin.net.billing.ru 1.1.1.2 172.20.106.70 xf=\"1.1.1.2\" - - [07/Oct/2013:12:44:00 +0400] \"GET\" \"GET /test/1.xml HTTP/1.1&\" \"&\" 403 212 \"-\" \"Apache-HttpClient/4.1.2 (java 1.5)\" pid=27844 tid=140346537215744 time_ms=3111\n\nTake care,\n\nMike Rumph", "attachment_id": null, "id": 171464, "creator": "mike.rumph@oracle.com", "time": "2013-11-27T16:17:08Z", "bug_id": 55635, "creation_time": "2013-11-27T16:17:08Z", "is_private": false}, {"count": 2, "tags": [], "creator": "vivanv@mail.ru", "attachment_id": null, "text": "Hello Mike,\n\nYou got the similar results.\nThe X-Forwarded-For must be \"1.1.1.2, 1.1.1.1, 87.245.198.54\", because \"87.245.198.54\" is not trusted.\nBut you got \"-\" in first case and \"1.1.1.2\" in another.\n\nI think that it's a bug because it's not possible to pass real Client IP to server behind this Apache server.\n\nBest regards,\nIvan Voronin.", "id": 171477, "time": "2013-11-28T08:12:11Z", "bug_id": 55635, "creation_time": "2013-11-28T08:12:11Z", "is_private": false}, {"count": 3, "tags": [], "text": "Hello Ivan,\n\nI have been studying the mod_remoteip documentation and code to try to make sense of the results that we are seeing.\nI think that I finally understand the results that you are getting.\nAnd it appears to me at this point that your results are as they should be according to the documentation at the following link:\n- http://httpd.apache.org/docs/trunk/mod/mod_remoteip.html \n\nI will try to explain this, but it is not easy.\nHere is how I see it now:\n\nmod_remoteip processes the contents of X-Forwarded-For from right to left in cycles of a while loop after your RemoteIPInternalProxy and RemoteIPTrustedProxy proxies are added to a proxy match list.\n\nCycle 1:\nThe code begins with X-Forwarded-For equal to \"1.1.1.2, 1.1.1.1, 87.245.198.54, 87.250.250.203\" and the client IP is equal to \"172.20.106.70\".\nThe client IP is compared against the proxy match list.\n172.20.106.70 is listed as an internal proxy.\nSo its view of the X-Forwarded-For list is trusted.\nSo 87.250.250.203 is interpreted as a valid useragent IP address.\nSo 87.250.250.203 becomes the client IP and is removed from the X-Forwarded-For list.\n\nCycle 2:\nX-Forwarded-For is equal to \"1.1.1.2, 1.1.1.1, 87.245.198.54\" and the client IP is equal to \"87.250.250.203\".\n87.250.250.203 is listed as a trusted proxy.\nSo its view of the X-Forwarded-For list is trusted.\nSo 87.245.198.54 is interpreted as a valid useragent IP address.\nSo 87.245.198.54 becomes the client IP and is removed from the X-Forwarded-For list.\n\nCycle 3:\nX-Forwarded-For is equal to \"1.1.1.2, 1.1.1.1\" and the client IP is equal to \"87.245.198.54\".\n87.245.198.54 is not an internal or trusted proxy.\nSo the cycles stop.\n\nFinal mod_remoteip result\":\nX-Forwarded-For is equal to \"1.1.1.2, 1.1.1.1\" and the client IP is equal to \"87.245.198.54\".\n\nAnd this is the result that you are seeing.\n\nI think the key point here is that RemoteIPInternalProxy and RemoteIPTrustedProxy refer to trusted proxies not trusted clients.\nAs a trusted proxy it can be relied upon to have added a trusted client IP to the end of the X-Forwarded-For list before forwarding the request on to the backend server.\n\nNow I think that what should happen next is for mod_proxy to take over.\nIf mod_proxy is properly configured and 87.245.198.54 is accepted as an allowed client IP, then mod_proxy should add 87.245.198.54 to the end of X-Forwarded-For.\nThis is what is not happening.\n\nIt could be because you do not have 87.245.198.54 included in the \"Allow from\" directive.\nYou could also take a look at the ProxyAddHeaders directive.\n- http://httpd.apache.org/docs/trunk/mod/mod_proxy.html#proxyaddheaders\nWhat proxy directives are you using in your configuration?\n\nThis bug is related to bug 55637.\nAnd I will try to update that bug report with an explanation as well.\n\nI hope that this analysis is helpful.\n\nTake care,\n\nMike Rumph", "attachment_id": null, "id": 171552, "creator": "mike.rumph@oracle.com", "time": "2013-12-03T23:10:18Z", "bug_id": 55635, "creation_time": "2013-12-03T23:10:18Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 55635, "attachment_id": null, "text": "You have made a claim in comment #1 that...\n\naccess_log.2013.10.07:\nivoronin.net.billing.ru 87.245.198.54 172.20.106.70 1.1.1.2, 1.1.1.1 - - [07/Oct/2013:12:44:00 +0400] \"GET\" \"GET /test/1.xml HTTP/1.1&\" \"&\" 403 212 \"-\" \"Apache-HttpClient/4.1.2 (java 1.5)\" pid=27844 tid=140346537215744 time_ms=3111\n\nis inaccurate.  It is the correct result.  The processed request is presented \nby the IP 87.245.198.54, which claims it is forwarding for 1.1.1.2, 1.1.1.1\nwhile the internal proxy 172.20.106.70 and trusted extranet proxy 87.250.250.203\nare both 'erased' from the x-forwarded-for and apparent IP address of the req\n(except as presented by the connection's IP address).\n\nThe 1.1.1.2 and 1.1.1.1 IP addresses are not presented as the user-agent's IP\naddress *because* the 87.245.198.54 host is *not* trusted.\n\nAn IP address would never simultaniously appear to be the user agent's IP addr\nwhile also appearing in the X-Forwarded-For list.  Such combinations make no sense.\n\nThis behavior is by design.", "id": 171696, "time": "2013-12-11T21:58:26Z", "creator": "wrowe@apache.org", "creation_time": "2013-12-11T21:58:26Z", "is_private": false}]