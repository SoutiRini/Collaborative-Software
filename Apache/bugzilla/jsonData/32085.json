[{"attachment_id": null, "tags": [], "bug_id": 32085, "text": "Red Hat Enterprise ES 3\n\nApache 2.0.52 compiled with the following configuration:\n\nCFLAGS=\"-O3\" ./configure \\\n  --prefix=/usr/local/apache2 \\\n  --enable-ssl \\\n  --enable-so \\\n  --enable-rewrite=shared \\\n  --enable-expires \\\n  --enable-info \\\n  --enable-deflate \\\n  --enable-ldap \\\n  --enable-auth-ldap \\\n  --with-ldap \\\n  --with-ssl=/usr\n\nPHP 4.3.8 is compiled as a DSL and has Oracle 10g client libraries linked in.\n\nI have the following in my envvars file:\n\nexport ORACLE_SID=dpndb\nexport ORACLE_BASE=/u01/app/oracle\nexport ORACLE_HOME=/u01/app/oracle/product/10.1.0/client_1\nexport TNS_ADMIN=/u01/app/oracle/product/10.1.0/client_1/network/admin\nexport TWO_TASK=/u01/app/oracle/product/10.1.0/client_1/network/admin\nexport NLS_LANG=\"English_America.WE8ISO8859P1\"\n\nexport LD_LIBRARY_PATH=\"$ORACLE_HOME/lib:/usr/local/apache2/lib:$LD_LIBRARY_PATH\"\nexport LD_PRELOAD=/u01/app/oracle/product/10.1.0/client_1/lib/libclntsh.so.10.1\n\nThis setup works great until I attempt to add LDAP authentication support.  Here\nis the test addition I have made to my httpd.conf file:\n\nLDAPSharedCacheSize 200000\nLDAPCacheEntries 1024\nLDAPCacheTTL 600\nLDAPOpCacheEntries 1024\nLDAPOpCacheTTL 600\n\n<Location /ldap-status>\n  SetHandler ldap-status\n  Order deny,allow\n  Deny from all\n  Allow from digitalpath.net\n  AuthType basic\n  AuthName \"LDAP Login\"\n  AuthLDAPEnabled on\n  AuthLDAPURL \"ldap://hostname.net/dc=ldap,dc=domain,dc=net?uid\"\n  AuthLDAPAuthoritative on\n  require valid-user\n</Location>\n\nWhen I attempt to do anything from apachectl (start, stop, configtest), I get\nthe following:\n\n[root@webdev bin]# ./apachectl configtest\n./apachectl: line 99: 18206 Segmentation fault      $HTTPD -t\n\nIf I run httpd -t by itself from the prompt, I get \"Syntax OK\".  If I bypass the\napachectl script completely and stop my httpd server with httpd -k stop and\nstart it up again with httpd -k start -DSSL everything works properly, including\nthe mod_auth_ldap authentication.\n\nAs soon as I remove the above LDAP configuration entries from httpd.conf,\napachectl once again works correctly.\n\nHowever!  If I leave the LDAP configuration in my httpd.conf as it is listed\nabove, edit my envvars file and remove the LD_PRELOAD line, apachectl does *not*\nsegfault and I can once again use it to manage my httpd process.\n\nPerhaps there is something I do not understand about LD_PRELOAD ... but it seems\nodd that apachectl (or httpd to be exact) Segfaults because of the combination\nof it and the LDAP config options in httpd.conf.\n\nI have tried adding /usr/lib/libldap.so.2 to my LD_PRELOAD line to no avail.", "count": 0, "id": 66551, "time": "2004-11-05T18:23:33Z", "creator": "rayvd@digitalpath.net", "creation_time": "2004-11-05T18:23:33Z", "is_private": false}, {"count": 1, "text": "Does it work if you take Oracle out of the picture?\n\nexport LD_PRELOAD=/u01/app/oracle/product/10.1.0/client_1/lib/libclntsh.so.10.1\n\notherwise, can you get a backtrace?\n\nulimit -c unlimited\n./apachectl configtest\ngdb ./bin/httpd core.*\n(gdb) bt full", "bug_id": 32085, "is_private": false, "id": 66756, "time": "2004-11-11T20:19:44Z", "creator": "jorton@redhat.com", "creation_time": "2004-11-11T20:19:44Z", "tags": [], "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 32085, "text": "If I remove the LD_PRELOAD line, both Oracle (PHP) and mod_auth_ldap appear to\nwork correctly and I no longer get the segfault when running apachectl.\n\nI guess I could just leave the LD_PRELOAD out, however php.net and others have\nit listed in their example setup configurations...\n\nNevertheless, I will post a backtrace here shortly.", "count": 2, "id": 66757, "time": "2004-11-11T20:47:56Z", "creator": "rayvd@digitalpath.net", "creation_time": "2004-11-11T20:47:56Z", "is_private": false}, {"count": 3, "tags": [], "creator": "rayvd@digitalpath.net", "text": "Here is the backtrace:\n\n(gdb) bt full\n#0  0xb6757041 in apr_pstrdup (a=0x80e50a8, s=0x6a626f28 <Address 0x6a626f28 out\nof bounds>) at apr_strings.c:76\n        res = 0x6a626f28 <Address 0x6a626f28 out of bounds>\n#1  0x0806b710 in mod_auth_ldap_parse_url (cmd=0xbfffa410, config=0x8164df8, \n    url=0x8164ed0\n\"ldap://chico-ldap1.digitalpath.net/dc=ldap,dc=digitalpath,dc=net?uid\") at\nmod_auth_ldap.c:758\n        i = 0\n        result = 0\n        urld = (LDAPURLDesc *) 0xb6165070\n#2  0x0809ee38 in invoke_cmd (cmd=0x80d6500, parms=0xbfffa410,\nmconfig=0x8164df8, args=0x814ae6e \"\")\n    at config.c:675\n        w = 0x8164ed0\n\"ldap://chico-ldap1.digitalpath.net/dc=ldap,dc=digitalpath,dc=net?uid\"\n        w2 = 0xb633a06c \" pj\ufffd\\200\ufffdk\ufffd\"\n        w3 = 0xb7510ea0 \"(objectClass=*)\"\n        errmsg = 0x80d6500 \"q\ufffd\\v\\b \ufffd\\006\\b\"\n#3  0x0809f760 in ap_walk_config_sub (current=0x814ae08, parms=0xbfffa410,\nsection_vector=0x81648d0)\n    at config.c:1059\n        retval = 0x0\n        mod = (module *) 0x80d6640\n#4  0x0809e590 in ap_walk_config (current=0x814ae08, parms=0xbfffa410,\nsection_vector=0x81648d0)\n    at config.c:1098\n        errmsg = 0x0\n        oldconfig = (ap_conf_vector_t *) 0x8164168\n#5  0x080ae7cc in urlsection (cmd=0xbfffa410, mconfig=0x8164388, arg=0x8164a54\n\"\") at core.c:1778\n        errmsg = 0x0\n        endp = 0x8164a68 \"\"\n        old_overrides = 150\n        old_path = 0x0\n        conf = (core_dir_config *) 0x8164a68\n        r = (regex_t *) 0x0\n        thiscmd = (const command_rec *) 0x80d2fb8\n        new_url_conf = (ap_conf_vector_t *) 0x81648d0\n        err = 0x0\n#6  0x0809ee38 in invoke_cmd (cmd=0x80d2fb8, parms=0xbfffa410, mconfig=0x8164388, \n    args=0x814ac40 \"/ldap-status>\") at config.c:675\n        w = 0x80d2fb8 \"\ufffd\\020\\r\\b\ufffd\ufffd\\n\\b\"\n        w2 = 0xb633a06c \" pj\ufffd\\200\ufffdk\ufffd\"\n        w3 = 0xb7510ea0 \"(objectClass=*)\"\n        errmsg = 0x80d2fb8 \"\ufffd\\020\\r\\b\ufffd\ufffd\\n\\b\"\n#7  0x0809f760 in ap_walk_config_sub (current=0x814ac20, parms=0xbfffa410,\nsection_vector=0x8164168)\n    at config.c:1059\n        retval = 0x0\n        mod = (module *) 0x80d8140\n#8  0x0809e590 in ap_walk_config (current=0x814ac20, parms=0xbfffa410,\nsection_vector=0x8164168)\n    at config.c:1098\n        errmsg = 0x0\n        oldconfig = (ap_conf_vector_t *) 0x81247b8\n#9  0x080aed0c in virtualhost_section (cmd=0xbfffa410, dummy=0x8125868, \n    arg=0x814a980 \"p\ufffd\\024\\b\ufffd\ufffd\\024\\b\\030\\005\\025\\b\u0229\\024\\b\") at core.c:2004\n        main_server = (server_rec *) 0x80eb000\n        s = (server_rec *) 0x8163f30\n        errmsg = 0x0\n        endp = 0x8126ad8 \"/usr/local/apache2/conf/httpd.conf\"\n        p = (apr_pool_t *) 0x80e50a8\n        err = 0x0\n#10 0x0809ee38 in invoke_cmd (cmd=0x80d2fd0, parms=0xbfffa410, mconfig=0x8125868, \n    args=0x814a9a0 \"65.164.104.249:80>\") at config.c:675\n        w = 0x80d2fd0 \"T\\021\\r\\b`\ufffd\\n\\b\"\n        w2 = 0xb633a06c \" pj\ufffd\\200\ufffdk\ufffd\"\n        w3 = 0xb7510ea0 \"(objectClass=*)\"\n        errmsg = 0x80d2fd0 \"T\\021\\r\\b`\ufffd\\n\\b\"\n#11 0x0809f760 in ap_walk_config_sub (current=0x814a980, parms=0xbfffa410,\nsection_vector=0x81247b8)\n    at config.c:1059\n        retval = 0x0\n        mod = (module *) 0x80d8140\n#12 0x0809e7b8 in ap_process_config_tree (s=0xb7510ea0, conftree=0x8126dd0,\np=0x80e50a8, ptemp=0x0)\n    at config.c:1098\n        errmsg = 0x0\n        parms = {info = 0x0, override = 95, limited = -1, limited_xmethods =\n0x0, xlimited = 0x0, \n  config_file = 0x0, directive = 0x814ae08, pool = 0x80e50a8, temp_pool =\n0x8121198, server = 0x8163f30, \n  path = 0x8164a58 \"/ldap-status\", cmd = 0x80d6500, context = 0x81648d0,\nerr_directive = 0x0}\n#13 0x080a13c6 in main (argc=2, argv=0xbfffa554) at main.c:538\n        c = 116 't'\n        configtestonly = 1\n        confname = 0x80ce81f \"conf/httpd.conf\"\n        def_server_root = 0x80cef53 \"/usr/local/apache2\"\n        temp_error_log = 0x0\n        server_conf = (server_rec *) 0x80eb000\n        pglobal = (apr_pool_t *) 0x80e30a0\n        pconf = (apr_pool_t *) 0x80e50a8\n        plog = (apr_pool_t *) 0x811f190\n        ptemp = (apr_pool_t *) 0x8121198\n        pcommands = (apr_pool_t *) 0x80e70b0\n        opt = (apr_getopt_t *) 0x80e7148\n        rv = 0\n        mod = (module **) 0x80eb000\n        optarg = 0x0\n        signal_server = (apr_OFN_ap_signal_server_t *) 0xb7510ea0 <__nan_union+36>\n\nThanks.", "id": 66759, "time": "2004-11-11T20:51:41Z", "bug_id": 32085, "creation_time": "2004-11-11T20:51:41Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "jorton@redhat.com", "is_private": false, "text": "If it works without the LD_PRELOAD go with that; the segfault looks like random\nmemory corruption so it could be some genuine httpd/apr-util/OpenLDAP bug which\nis just getting triggerred by chance but it's hard to tell.\n\nBTW I think it's still recommended to not use gcc -O3, -O2 is \"safer\".", "id": 66794, "time": "2004-11-12T14:05:42Z", "bug_id": 32085, "creation_time": "2004-11-12T14:05:42Z", "attachment_id": null}]