[{"count": 0, "tags": [], "bug_id": 57629, "attachment_id": null, "is_private": false, "id": 181291, "time": "2015-02-24T11:41:26Z", "creator": "lorenzo.caenazzo@emaze.net", "creation_time": "2015-02-24T11:41:26Z", "text": "With reference ( https://bz.apache.org/bugzilla/show_bug.cgi?id=56725#c7 )\nI want to POST/PUT a large amount of data (60MB+) but, following the tips on BUG #56725, I've configured my client to send an Expect: 100-continue.\nI think my server needs to authenticate the client BEFORE sending the \"100 Continue\" response.\n\nThis is what i get:\n\n-> PUT /put/URL HTTP/1.1\n-> Content-Type: application/json;charset=UTF-8\n-> Content-Length: 69748665\n-> Host: localhost:8084\n-> Connection: Keep-Alive\n-> User-Agent: Apache-HttpClient/4.3.6 (java 1.5)\n-> Expect: 100-continue\n-> Accept-Encoding: gzip,deflate\n\n<- HTTP/1.1 100 Continue\n\n<- HTTP/1.1 401 Unauthorized\n<- Server: Apache-Coyote/1.1\n<- Set-Cookie: JSESSIONID=00655E5BBBAB2F993D735F5A5B392FB5; Path=/put/; HttpOnly\n<- WWW-Authenticate: Basic realm=\"Spring Security Application\"\n<- Content-Type: text/html;charset=utf-8\n<- Content-Language: en\n<- Content-Length: 1104\n<- Date: Tue, 24 Feb 2015 10:00:08 GMT\n<- Connection: close\n\n<- <!DOCTYPE html><html><head><title>Apache Tomcat/8.0.18 - Error report</title><style type=\"text/css\">H1 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:22px;} H2 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:16px;} H3 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:14px;} BODY {font-family:Tahoma,Arial,sans-serif;color:black;background-color:white;} B {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;} P {font-family:Tahoma,Arial,sans-serif;background:white;color:black;font-size:12px;}A {color : black;}A.name {color : black;}.line {height: 1px; background-color: #525D76; border: none;}</style> </head><body><h1>HTTP Status 401 - Full authentication is required to access this resource</h1><div class=\"line\"></div><p><b>type</b> Status report</p><p><b>message</b> <u>Full authentication is required to access this resource</u></p><p><b>description</b> <u>This request requires HTTP authentication.</u></p><hr class=\"line\"><h3>Apache Tomcat/8.0.18</h3></body></html>\n\n-> DATA (truncated by connection reset)\n\nAnd this is what I expect:\n\n-> PUT /put/URL HTTP/1.1\n-> Content-Type: application/json;charset=UTF-8\n-> Content-Length: 69748665\n-> Host: localhost:8084\n-> Connection: Keep-Alive\n-> User-Agent: Apache-HttpClient/4.3.6 (java 1.5)\n-> Expect: 100-continue\n-> Accept-Encoding: gzip,deflate\n\n<- HTTP/1.1 401 Unauthorized\n<- Server: Apache-Coyote/1.1\n<- Set-Cookie: JSESSIONID=00655E5BBBAB2F993D735F5A5B392FB5; Path=/put/; HttpOnly\n<- WWW-Authenticate: Basic realm=\"Spring Security Application\"\n<- Content-Type: text/html;charset=utf-8\n<- Content-Language: en\n<- Content-Length: 1104\n<- Date: Tue, 24 Feb 2015 10:00:08 GMT\n<- Connection: close\n\n<- ERROR_PAGE\n\n-> PUT /put/URL HTTP/1.1\n-> Content-Type: application/json;charset=UTF-8\n-> Content-Length: 69748665\n-> Host: localhost:8084\n-> Authorization: Basic cGFzc3dvcmQK==\n-> Connection: Keep-Alive\n-> User-Agent: Apache-HttpClient/4.3.6 (java 1.5)\n-> Expect: 100-continue\n-> Accept-Encoding: gzip,deflate\n\n<- HTTP/1.1 100 Continue\n\n-> DATA"}, {"attachment_id": null, "tags": [], "bug_id": 57629, "is_private": false, "count": 1, "id": 181328, "time": "2015-02-25T14:13:05Z", "creator": "markt@apache.org", "creation_time": "2015-02-25T14:13:05Z", "text": "This is only going to work if Tomcat does the authentication otherwise, as you have observed, Tomcat sends the 100 response before passing the request/response to the application for processing.\n\nOne of the aims for Tomcat 9 is to implement JASPIC which would allow libraries like Spring Security to plug into Tomcat's authentication mechanism allowing for the behaviour you are looking for.\n\nThe other option would be to add an option to the Context to delegate sending of the 100 response to the application. There are security concerns around expectation handling but as long as Tomcat's current handling stays in place I don't believe this would create any issues. The down side is that if the application does not send the 100 continue response then the client may wait for an unknown period of time before sending the request body any way.\n\nIf you think such an option (to delegate the sending of 100 response) would be useful, we can move this issue to an enhancement. If not, it will get resolved as WONTFIX."}, {"count": 2, "tags": [], "bug_id": 57629, "text": "ok,\nI think the responability to send 100-continue header is not of \"contained\" application.\n\nBut if the container send a 100 header I expect which it not closes the soket if the body of the request is \"big\". Maybe if Tomcat send a 100 continue header it must take and discard (in some case) the request body. Because the client receve the 100 header and say \"ok now I can send a lot of data!\" but after a while the server hang up the connection. What do you think?\n\nP.S.\nfor now I've implemented a preemptive authentication method.", "id": 181352, "time": "2015-02-26T16:03:27Z", "creator": "lorenzo.caenazzo@emaze.net", "creation_time": "2015-02-26T16:03:27Z", "is_private": false, "attachment_id": null}, {"count": 3, "attachment_id": null, "bug_id": 57629, "text": "Tomcat will swallow the request body up to maxSwallowSize after which Tomcat will close the connection.\n\nMost clients will not read the response until the body is fully sent so if maxSwallowSize < request body size then the client will just see a closed connection. You can increase maxSwallowSize to avoid this (at the cost of pointlessly reading more data).", "id": 181353, "time": "2015-02-26T16:31:23Z", "creator": "markt@apache.org", "creation_time": "2015-02-26T16:31:23Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "text": "Does this currently work when Tomcat /is/ managing the authentication and authorization? If so, then I agree with WONTFIX.", "is_private": false, "id": 181354, "creator": "chris@christopherschultz.net", "time": "2015-02-26T16:57:27Z", "bug_id": 57629, "creation_time": "2015-02-26T16:57:27Z", "attachment_id": null}, {"count": 5, "attachment_id": null, "bug_id": 57629, "text": "Yes. You get the right 4xx response along with a Connection: close header.", "id": 181356, "time": "2015-02-26T18:40:59Z", "creator": "markt@apache.org", "creation_time": "2015-02-26T18:40:59Z", "tags": [], "is_private": false}]