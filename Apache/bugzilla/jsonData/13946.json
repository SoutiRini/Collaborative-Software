[{"count": 0, "tags": [], "bug_id": 13946, "attachment_id": null, "text": "Hi!\nUsing apache as a reverse proxy with mod_mem_cache, when using simple HTTP/1.0 \nrequests to files, sometimes (when the object in the cache is expired) the \nproxy does weird requisitions:\n\nThe request:\nGET /index.html HTTP/1.0\nHost: 10.0.0.2\n\nDocument cached:\n[Fri Oct 25 18:52:07 2002] [debug] mod_cache.c(118): cache: URL /index.html is \nbeing handled by mem\n[Fri Oct 25 18:52:07 2002] [debug] mod_cache.c(232): cache: fresh cache - add \ncache_out filter and handle request\n[Fri Oct 25 18:52:07 2002] [debug] mod_cache.c(357): cache: running CACHE_OUT \nfilter\n[Fri Oct 25 18:52:07 2002] [debug] mod_cache.c(366): cache: serving cached \nversion of /index.html\n\nAfter the document expires:\n[Fri Oct 25 18:59:00 2002] [debug] proxy_http.c(109): proxy: HTTP: \ncanonicalising URL //10.0.0.2/proxy:http://10.0.0.2/index.html\n[Fri Oct 25 18:59:00 2002] [debug] mod_proxy.c(461): Trying to run \nscheme_handler\n[Fri Oct 25 18:59:00 2002] [debug] proxy_http.c(1061): proxy: HTTP: serving \nURL http://10.0.0.2/proxy:http://10.0.0.2/index.html\n[Fri Oct 25 18:59:00 2002] [debug] proxy_http.c(221): proxy: HTTP connecting \nhttp://10.0.0.2/proxy:http://10.0.0.2/index.html to 10.0.0.2:80\n\nand after a few mseconds:\n[Fri Oct 25 18:59:00 2002] [debug] mod_cache.c(118): cache: URL /index.html is \nbeing handled by mem\n[Fri Oct 25 18:59:00 2002] [debug] mod_cache.c(203): cache: no cache - add \ncache_in filter and DECLINE\n\nHere is a piece of my httpd.conf file:\nProxyRequests Off\nProxyVia Full\nProxyTimeout 30\nProxyReceiveBufferSize 16384\nProxyMaxForwards 10\nCacheEnable mem /\nCacheDefaultExpire 10\nCacheMaxExpire 30\nCacheLastModifiedFactor 0.1\nCacheMaxStreamingBuffer 65536 \nMCacheSize 524288\nMCacheMaxObjectCount 32768\nMCacheMinObjectSize 1 \nMCacheMaxObjectSize 100000\nMCacheRemovalAlgorithm GDSF\nRewriteEngine   on\nRewriteRule     ^(.*)$     $1 [P,L]", "id": 25148, "time": "2002-10-24T19:45:36Z", "creator": "ftrentini@uolinc.com", "creation_time": "2002-10-24T19:45:36Z", "is_private": false}, {"count": 1, "tags": [], "creator": "rederpj@remulak.net", "attachment_id": null, "id": 27449, "time": "2002-12-05T02:07:08Z", "bug_id": 13946, "creation_time": "2002-12-05T02:07:08Z", "is_private": false, "text": "Can you specify where you think the problem is in the log you attached?\n\nIf you are concerned about the \"no cache - add cache_in filter and DECLINE\" part\nof the message, that is perfectly normal. This simply indicates that the cache\nhandler has noticed that new, cacheable content is arriving. It inserts the\ncache_in filter into the filter chain so that the caching code can store the new\ncontent as it flows through, but it returns \"declined\" to indicate that the\ncache handler didn't process the response.\n\nI'm going to wait a few days for a clarification on this. If there isn't\nsomething I've missed here then I'll go ahead and close this PR at that point."}, {"count": 2, "tags": [], "bug_id": 13946, "attachment_id": null, "text": "Having received no response to the contrary, I have to assume that this was not\nactually a problem after all. I'm closing it now. It can be re-opened if someone\ndisagrees.", "id": 27561, "time": "2002-12-09T21:03:06Z", "creator": "rederpj@remulak.net", "creation_time": "2002-12-09T21:03:06Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 13946, "is_private": false, "text": "Hi, sorry for the delay.\nWell, the error is right here:\n---\n[Fri Oct 25 18:59:00 2002] [debug] proxy_http.c(221): proxy: HTTP connecting \nhttp://10.0.0.2/proxy:http://10.0.0.2/index.html to 10.0.0.2:80\n---\n\nit tries to get the URL http://10.0.0.2/proxy:http://10.0.0.2/index.html, \ngenerating errors. it only happens when using mod_proxy with mod_rewrite. it \nlooks like mod_rewrite appends the \"http://10.0.0.2/proxy:\" string, in the \nexample, but *only* when the document expires from the cache.\n", "id": 27562, "time": "2002-12-09T21:51:26Z", "creator": "ftrentini@uolinc.com", "creation_time": "2002-12-09T21:51:26Z", "attachment_id": null}, {"count": 4, "tags": [], "creator": "rederpj@remulak.net", "attachment_id": null, "id": 27563, "time": "2002-12-09T22:13:53Z", "bug_id": 13946, "creation_time": "2002-12-09T22:13:53Z", "is_private": false, "text": "Does the server return an error to the client or does the server succeed in\nretrieving and returning the page from the proxy machine? In other words, is it\njust a logging issue or does it actually fail to retrieve the page after it expires?\n\nI don't see a log entry indicating that the page isn't found, and the only entry\nin the log from the cache code indicates that it is inserting the\ncache_in_filter to handle the page returned from the proxy.\n\nThanks for any additional info you can provide."}, {"count": 5, "attachment_id": null, "bug_id": 13946, "text": "in all these requests, the server returns an error to the client.", "id": 27565, "time": "2002-12-09T22:22:31Z", "creator": "ftrentini@uolinc.com", "creation_time": "2002-12-09T22:22:31Z", "tags": [], "is_private": false}, {"count": 6, "tags": [], "creator": "rederpj@remulak.net", "attachment_id": null, "id": 27567, "time": "2002-12-09T23:20:19Z", "bug_id": 13946, "creation_time": "2002-12-09T23:20:19Z", "is_private": false, "text": "What is the error returned to the client and what error(s) get logged into the\nserver's error_log or access_log?"}, {"count": 7, "tags": [], "bug_id": 13946, "attachment_id": null, "is_private": false, "id": 29850, "time": "2003-01-22T10:43:07Z", "creator": "minfrin@sharp.fm", "creation_time": "2003-01-22T10:43:07Z", "text": "This seems to be a mod_cache bug"}, {"count": 8, "tags": [], "creator": "ftrentini@uolinc.com", "attachment_id": null, "text": "hi there,\nthe bug persists in httpd-2.0.44. Here is some piece of the error_log:\n\n[Tue Jan 28 15:48:23 2003] [error] [client 200.164.36.73] proxy: URI cannot be \nparsed: http://xxx.com.brproxy:http//xxx.com.br/imagens/pix.gif returned \nby /imagens/pix.gif\n[Tue Jan 28 15:48:23 2003] [error] [client 200.207.161.223] proxy: URI cannot \nbe parsed: http://xxx.com.brproxy:http//xxx.com.br/beach/t3.jpg returned \nby /beach/t3.jpg, referer: http://xxx.com.br/beach/left.html\n[Tue Jan 28 15:48:23 2003] [error] [client 200.191.233.186] proxy: URI cannot \nbe parsed: http://yyy.com.brproxy:http//yyy.com.br/imagens/b.gif returned \nby /imagens/b.gif, referer: http://yyy.com.br/\n", "id": 30190, "time": "2003-01-28T18:05:18Z", "bug_id": 13946, "creation_time": "2003-01-28T18:05:18Z", "is_private": false}, {"count": 9, "attachment_id": null, "bug_id": 13946, "text": "another error:\n\naccess_log:\n200.174.198.133 - - [28/Jan/2003:15:47:18 - 0200] \"GET /js/video.js HTTP/1.1\" \n400 498 \"http://xxx.com.br/\" \"Mozilla/4.0 (compatible; MSIE 6.0; Windows 98)\"\n\nerror_log:\n[Tue Jan 28 15:47:18 2003] [error] [client 200.174.198.133] proxy: URI cannot \nbe parsed: http://xxx.com.brproxy:http//xxx.com.br/js/video.js returned \nby /js/video.js, referer: http://xxx.com.br/\n\nIt *only* happens with mod_rewrite with reverse proxy.", "id": 30191, "time": "2003-01-28T18:10:28Z", "creator": "ftrentini@uolinc.com", "creation_time": "2003-01-28T18:10:28Z", "tags": [], "is_private": false}, {"count": 10, "attachment_id": 4670, "bug_id": 13946, "text": "Created attachment 4670\nPatch to solve the probem", "id": 30441, "time": "2003-01-31T19:36:18Z", "creator": "eider@bol.com.br", "creation_time": "2003-01-31T19:36:18Z", "tags": [], "is_private": false}, {"count": 11, "tags": [], "creator": "eider@bol.com.br", "attachment_id": null, "id": 30442, "time": "2003-01-31T19:41:06Z", "bug_id": 13946, "creation_time": "2003-01-31T19:41:06Z", "is_private": false, "text": "A did attach a patch to solve this bug. It is caused when the mod_rewrite \nreprocess the request after mod_proxy return it."}, {"count": 12, "attachment_id": 4671, "bug_id": 13946, "text": "Created attachment 4671\nPatch fix, now generated by a diff -u", "id": 30443, "time": "2003-01-31T20:06:17Z", "creator": "eider@bol.com.br", "creation_time": "2003-01-31T20:06:17Z", "tags": [], "is_private": false}, {"count": 13, "tags": [], "bug_id": 13946, "is_private": false, "text": "Let's not mark this as resolved/fixed until a fix is actually committed... \notherwise the patch might get lost.  :)\n\nThanks,\nCliff", "id": 30444, "time": "2003-01-31T21:07:05Z", "creator": "jwoolley@apache.org", "creation_time": "2003-01-31T21:07:05Z", "attachment_id": null}, {"count": 14, "tags": [], "bug_id": 13946, "is_private": false, "text": "Is this fixed now or not? :-)", "id": 38136, "time": "2003-06-01T17:48:55Z", "creator": "nd@perlig.de", "creation_time": "2003-06-01T17:48:55Z", "attachment_id": null}, {"count": 15, "tags": [], "creator": "rederpj@remulak.net", "is_private": false, "text": "I'm currently looking into porting the old patch to the current code, verifying\nthe patch, and committing it to cvs. I am not convinced that this part of the\npatch needs to be present since we aren't seeing \"proxy:proxy:\" which is what\nthis if statement would prevent...\n\n@@ -2082,6 +2098,7 @@\n             rewritelog(r, 2, \"[per-dir %s] forcing proxy-throughput with %s\",\n                        perdir, r->filename);\n         }\n+        if (strncasecmp(\"proxy:\",r->filename,6))\n         r->filename = apr_pstrcat(r->pool, \"proxy:\", r->filename, NULL);\n         return 1;\n     }", "id": 40280, "time": "2003-07-09T18:03:03Z", "bug_id": 13946, "creation_time": "2003-07-09T18:03:03Z", "attachment_id": null}, {"count": 16, "attachment_id": 7229, "bug_id": 13946, "text": "Created attachment 7229\nUpdated version of Fabio's patch from above. (current 2.1-dev branch)", "id": 40364, "time": "2003-07-10T19:12:49Z", "creator": "rederpj@remulak.net", "creation_time": "2003-07-10T19:12:49Z", "tags": [], "is_private": false}, {"count": 17, "attachment_id": null, "bug_id": 13946, "text": "I have tested the updated patch and committed it to the Apache 2.1-dev branch. I\nwill submit it for a vote to backport to the 2.0-stable branch. Thank you for\nyour efforts in identifying and fixing this bug.", "id": 40649, "time": "2003-07-14T16:51:54Z", "creator": "rederpj@remulak.net", "creation_time": "2003-07-14T16:51:54Z", "tags": [], "is_private": false}, {"count": 18, "attachment_id": null, "bug_id": 13946, "text": "Perhaps I'm missing something... The provided config:\n\nProxyRequests Off\nProxyVia Full\nProxyTimeout 30\nProxyReceiveBufferSize 16384\nProxyMaxForwards 10\nCacheEnable mem /\nCacheDefaultExpire 10\nCacheMaxExpire 30\nCacheLastModifiedFactor 0.1\nCacheMaxStreamingBuffer 65536 \nMCacheSize 524288\nMCacheMaxObjectCount 32768\nMCacheMinObjectSize 1 \nMCacheMaxObjectSize 100000\nMCacheRemovalAlgorithm GDSF\nRewriteEngine   on\nRewriteRule     ^(.*)$     $1 [P,L]\n\ncreates an infinite loop (proxying to itself), doesn't it? Why is this useful?", "id": 42881, "time": "2003-08-18T00:03:01Z", "creator": "nd@perlig.de", "creation_time": "2003-08-18T00:03:01Z", "tags": [], "is_private": false}, {"count": 19, "attachment_id": null, "bug_id": 13946, "text": "updating PRs to add PatchAvailable keyword\nFor updated information on submitting patches, see\nhttp://httpd.apache.org/dev/patches.html\n", "id": 47878, "time": "2003-11-21T22:13:35Z", "creator": "trawick@apache.org", "creation_time": "2003-11-21T22:13:35Z", "tags": [], "is_private": false}, {"count": 20, "tags": [], "creator": "chip@force-elite.com", "attachment_id": null, "text": "Can you test this on 2.0.54? Lots of things in both proxy and cache have been\nchanged since this was last reported.", "id": 75898, "time": "2005-06-03T02:36:25Z", "bug_id": 13946, "creation_time": "2005-06-03T02:36:25Z", "is_private": false}, {"count": 21, "tags": [], "bug_id": 13946, "attachment_id": null, "is_private": false, "id": 92052, "time": "2006-08-08T20:28:37Z", "creator": "nick@webthing.com", "creation_time": "2006-08-08T20:28:37Z", "text": "No activity after a very long time in NEEDINFO; assuming expired."}]