[{"count": 0, "tags": [], "bug_id": 61437, "text": "Created attachment 35244\nlogs_2017-08-17.zip\n\nSmoke-testing examples webapp of Tomcat 8.0.46 Release Candidate\n\nConfiguration:\nJava 7u80, configured connector to use NIO protocol\n\nSteps to reproduce:\n1. Start Tomcat with SecurityManager enabled\n> catalina.bat start -security\n\n2. Go to 'Examples' page, click on Websocket examples\n\nhttp://localhost:8080/examples/\nhttp://localhost:8080/examples/websocket/index.xhtml\n\n3. Open 4 websocket examples in new browser tabs\nhttp://localhost:8080/examples/websocket/echo.xhtml\nhttp://localhost:8080/examples/websocket/chat.xhtml\nhttp://localhost:8080/examples/websocket/snake.xhtml\nhttp://localhost:8080/examples/websocket/drawboard.xhtml\n\nResult: Snake and Drawboard examples fail immediately, printing \"WebSocket connection closed\" messages into their log areas.\n\nIn catalina.2017-08-17.log there is exception:\n\n[[[\n java.security.AccessControlException: access denied (\"java.lang.RuntimePermission\" \"accessClassInPackage.org.apache.catalina.webresources\")\n\tat java.security.AccessControlContext.checkPermission(AccessControlContext.java:372)\n\tat java.security.AccessController.checkPermission(AccessController.java:559)\n\tat java.lang.SecurityManager.checkPermission(SecurityManager.java:549)\n\tat java.lang.SecurityManager.checkPackageAccess(SecurityManager.java:1525)\n\tat sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:305)\n\tat java.lang.ClassLoader.loadClass(ClassLoader.java:412)\n\tat java.lang.ClassLoader.loadClass(ClassLoader.java:358)\n\tat org.apache.catalina.webresources.StandardRoot.isPackedWarFile(StandardRoot.java:651)\n\tat org.apache.catalina.webresources.CachedResource.validateResource(CachedResource.java:96)\n\tat org.apache.catalina.webresources.Cache.getResource(Cache.java:69)\n\tat org.apache.catalina.webresources.StandardRoot.getResource(StandardRoot.java:216)\n\tat org.apache.catalina.webresources.StandardRoot.getResource(StandardRoot.java:206)\n\tat org.apache.catalina.webresources.FileResource.getCodeBase(FileResource.java:224)\n\tat org.apache.catalina.loader.WebappClassLoaderBase.findClassInternal(WebappClassLoaderBase.java:2499)\n\tat org.apache.catalina.loader.WebappClassLoaderBase.findClass(WebappClassLoaderBase.java:859)\n\tat org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1302)\n\tat org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1167)\n\tat websocket.snake.SnakeAnnotation.onOpen(SnakeAnnotation.java:78)\n]]]\n\nThis is followed by\njava.lang.NoClassDefFoundError: websocket/snake/SnakeTimer\n\nIn localhost.2017-08-17.log there is\njava.lang.ClassNotFoundException: websocket.drawboard.DrawboardEndpoint$3\n\n\nA zip with log files is attached.", "id": 200354, "time": "2017-08-17T10:25:45Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2017-08-17T10:25:45Z", "is_private": false, "attachment_id": 35244}, {"count": 1, "tags": [], "text": "If I start by visiting one of plain Servlet examples - \"Hello world\", and go to WebSockets examples after that - all works successfully.\n\nI mean. the following sequence of visits.\n\nhttp://localhost:8080/examples/\nhttp://localhost:8080/examples/servlets/\nhttp://localhost:8080/examples/servlets/servlet/HelloWorldExample\n\nhttp://localhost:8080/examples/websocket/index.xhtml\nhttp://localhost:8080/examples/websocket/echo.xhtml\nhttp://localhost:8080/examples/websocket/chat.xhtml\nhttp://localhost:8080/examples/websocket/snake.xhtml\nhttp://localhost:8080/examples/websocket/drawboard.xhtml\n\nIf I run without SecurityManager, all runs successfully as well.", "attachment_id": null, "bug_id": 61437, "id": 200355, "time": "2017-08-17T10:34:15Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2017-08-17T10:34:15Z", "is_private": false}, {"count": 2, "tags": [], "text": "> StandardRoot.isPackedWarFile(StandardRoot.java:651)\n\nThe code there is\n[[[\n    protected boolean isPackedWarFile() {\n        return main instanceof WarResourceSet && preResources.isEmpty() && postResources.isEmpty();\n    }\n]]]\n\nIf I configure JreMemoryLeakPreventionListener in server.xml to preload WarResourceSet class, this issue does not happen.\n\n\nThis is: to work-around this issue, add the following attribute to JreMemoryLeakPreventionListener configured in conf/server.xml:\n\n[[[\n    classesToInitialize=\"org.apache.catalina.webresources.WarResourceSet\"\n]]]", "attachment_id": null, "bug_id": 61437, "id": 200357, "time": "2017-08-17T10:45:52Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2017-08-17T10:45:52Z", "is_private": false}, {"count": 3, "tags": [], "creator": "markt@apache.org", "text": "Good catch.\n\nFixed in:\n- 8.0.x for 8.0.47 onwards", "id": 200403, "time": "2017-08-21T16:02:40Z", "bug_id": 61437, "creation_time": "2017-08-21T16:02:40Z", "is_private": false, "attachment_id": null}]