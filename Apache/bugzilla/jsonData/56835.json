[{"count": 0, "tags": [], "bug_id": 56835, "attachment_id": null, "text": "Tested on 3.10-FINAL and 3.11 nightly 2014-07-21 (nothing special about this build, I just happened to have it on my system)\n\nIf I use POI to add two comments to the same cell in an XSSFWorkbook, after writing the workbook to disk, when I open the file in Microsoft Excel, I receive the following error dialog:\n\nMicrosoft Excel\n\"Excel found unreadable content in 'add_two_comments_to_one_cell_test.xlsx'. Do you want to recover the contents of this workbook? If you trust the source of this workbook, click Yes.\"\nYes | No\n\nRepairs to 'add_two_comments_to_one_cell_test.xlsx'.\nExcel was able to open the file by repairing or removing the unreadable content.\nRemoved Records: Comments from /xl/comments1.xml.part (Comments)\n\nUpon opening the repaired file, only the first comment appears to be in the workbook. The second comment was removed in the repair process.\n\nSince Microsoft Excel can't handle multiple comments in the same cell (comments with the same Col1 and Row1), should POI should raise an error or warning when trying to add a second comment to a cell?\n\nJava code to reproduce the issue (translated from Jython)\n\nclass TestWriteTwoCommentsToOneCell {\n    public static void main(String[] args) throws Exception {\n        Workbook wb = new XSSFWorkbook();\n        Cell cell = wb.createSheet('Sheet1').createRow(0).createCell(0);\n\n        addCommentToCell(cell, \"First comment\", \"Apache POI\");\n        addCommentToCell(cell, \"Second comment\", \"Apache POI\");\n\n        FileOutputStream out = new FileOutputStream(\"add_two_comments_to_one_cell_test.xlsx\");\n        wb.write(out);\n        out.close();\n    }\n\n    public void addComment(Cell cell, String commentText, String author) {\n        //http://poi.apache.org/spreadsheet/quick-guide.html#CellComments\n        Sheet sheet = cell.getSheet();\n        Row row = cell.getRow();\n        Drawing drawing = sheet.createDrawingPatriarch();\n\n        // When the comment box is visible, have it show in a 1x3 space\n        ClientAnchor anchor = factory.createClientAnchor();\n        anchor.setCol1(cell.getColumnIndex());\n        anchor.setCol2(cell.getColumnIndex()+1);\n        anchor.setRow1(row.getRowNum());\n        anchor.setRow2(row.getRowNum()+3);\n\n        // Create the comment and set the text+author\n        Comment comment = drawing.createCellComment(anchor);\n        RichTextString str = factory.createRichTextString(commentText);\n        comment.setString(str);\n        comment.setAuthor(author);\n\n        // Assign the comment to the cell\n        cell.setCellComment(comment);\n    }\n}", "id": 177043, "time": "2014-08-10T10:07:36Z", "creator": "onealj@apache.org", "creation_time": "2014-08-10T10:07:36Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 56835, "attachment_id": null, "id": 177044, "creation_time": "2014-08-10T10:11:01Z", "time": "2014-08-10T10:11:01Z", "creator": "apache@gagravarr.org", "text": "As per the javadocs, you should only call createDrawingPatriarch once, and only if your file doesn't already have any drawings / comments\n\nWhat happens if you correct that part?", "is_private": false}, {"count": 2, "tags": [], "bug_id": 56835, "attachment_id": null, "id": 177052, "creation_time": "2014-08-10T13:34:38Z", "time": "2014-08-10T13:34:38Z", "creator": "onealj@apache.org", "text": "The JavaDocs http://poi.apache.org/apidocs/org/apache/poi/xssf/usermodel/XSSFSheet.html#createDrawingPatriarch() and source code http://svn.apache.org/viewvc/poi/trunk/src/ooxml/java/org/apache/poi/xssf/usermodel/XSSFSheet.java?revision=1614684&view=markup line 415 indicate createDrawingPatriarch searches the workbook for the drawing object for the sheet if a drawing has already been created.\n\nI don't get an Unreadable content error from Microsoft Excel if I run the following code:\n\nRow row = wb.createSheet(\"Sheet1\").createRow(0);\nCell cell1 = row.createCell(0);\nCell cel21 = row.createCell(1);\n\naddCommentToCell(cell1, \"First comment\", \"Apache POI\");\naddCommentToCell(cell2, \"Second comment\", \"Apache POI\");\n\nI don't think this is a problem with createDrawingPartiarch()\n\nI think inside drawing.createCellComment(anchor) a check needs to be made if a cell comment already exists in the same drawing with the same Row1 and Column1 as anchor.\nsvn.apache.org/viewvc/poi/trunk/src/ooxml/java/org/apache/poi/xssf/usermodel/XSSFDrawing.java?revision=1511789&view=markup Line 288\n\nIf you agree I will try to put together a patch.", "is_private": false}, {"count": 3, "tags": [], "bug_id": 56835, "attachment_id": 31904, "id": 177093, "creation_time": "2014-08-12T01:39:07Z", "time": "2014-08-12T01:39:07Z", "creator": "onealj@apache.org", "text": "Created attachment 31904\npatch that raises IllegalArgumentException if comment already exists in cell\n\nThis patch raises an IllegalArgumentException if comment already exists in (anchor.getRow1(), anchor.getCol1())\n\nThis eliminates the chance that a cell has multiple comments, which is currently not supported in Microsoft Excel.", "is_private": false}, {"count": 4, "tags": [], "bug_id": 56835, "attachment_id": 31905, "id": 177094, "creation_time": "2014-08-12T01:40:18Z", "time": "2014-08-12T01:40:18Z", "creator": "onealj@apache.org", "text": "Created attachment 31905\npatch\n\nAdding attachment as a patch", "is_private": false}, {"count": 5, "tags": [], "bug_id": 56835, "text": "Thanks for the patch, this is applied with r1633397.", "id": 178649, "time": "2014-10-21T15:16:37Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2014-10-21T15:16:37Z", "is_private": false, "attachment_id": null}]