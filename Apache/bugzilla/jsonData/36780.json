[{"count": 0, "tags": [], "bug_id": 36780, "attachment_id": null, "id": 80362, "time": "2005-09-23T14:21:36Z", "creator": "sybspublicadress@gmx.de", "creation_time": "2005-09-23T14:21:36Z", "is_private": false, "text": "we are using Windows XP resp. Windows 2000 with  Apache/2.0.54 (Win32)\nmod_ssl/2.0.54 OpenSSL/0.9.7g mod_python/3.1.3 Python/2.3.5 (httpd.conf see\nappendix)\n\nApache crashes while processing a request whose connection has been forcibly\nclosed by the IExplorer. This occurs while the request handler tries to write a\nlarge amount of data for the answer.\n\nApache crashes in  following scenario: Apache is processing a request. Our\nhandler tries to write a large amount of data ( in our case  ~960000 bytes) to\nthe request. To do this apache calls the function apr_brigade_write. If the\namount of data is large a transient bucket with the user data address will be\ncreated. \n\n----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\napr_brigade.c:\nAPU_DECLARE(apr_status_t) apr_brigade_write(apr_bucket_brigade *b,\n                                            apr_brigade_flush flush,\n                                            void *ctx,\n                                            const char *str, apr_size_t nbyte)\n{\n ...\n    if (nbyte > remaining) {\n        /* either a buffer bucket exists but is full,\n         * or no buffer bucket exists and the data is too big\n         * to buffer.  In either case, we should flush.  */\n        if (flush) {\n            e = apr_bucket_transient_create(str, nbyte, b->bucket_alloc);\n            APR_BRIGADE_INSERT_TAIL(b, e);\n           return flush(b, ctx);\n           ...\n----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n\nThis bucket will be send to the next filters. In our case Mod_Deflate fragments\nit in a loop to 8000 byte pieces and send it to the next filter \n\n----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n(mod_deflate.c / line 553 : \nstatic apr_status_t deflate_out_filter(ap_filter_t *f,\n                                       apr_bucket_brigade *bb)\n{\n   ...\n        while (ctx->stream.avail_in != 0) {\n            if (ctx->stream.avail_out == 0) {\n                apr_status_t rv;\n\n                ctx->stream.next_out = ctx->buffer;\n                len = c->bufferSize - ctx->stream.avail_out;\n\n                b = apr_bucket_heap_create((char *)ctx->buffer, len,\n                                           NULL, f->c->bucket_alloc);\n                APR_BRIGADE_INSERT_TAIL(ctx->bb, b);\n                ctx->stream.avail_out = c->bufferSize;\n                /* Send what we have right now to the next filter. */\n                rv = ap_pass_brigade(f->next, ctx->bb);\n                if (rv != APR_SUCCESS) {\n                    return rv;\n                }\n            }\n----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n\nAt last SSL tries to write on the connection. But in the meantime IExplorer has\nclosed the connection (e.g. because the user trigger a further request in the\nsame frame). Thus SSL_Write fails:\n\nerror.log (loglevel info):\n----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n[Thu Aug 25 13:20:19 2005] [info] Subsequent (No.142) HTTPS request received for\nchild 0 (server PDDEKA-W1165:443)\n[Thu Aug 25 13:20:20 2005] [info] Subsequent (No.134) HTTPS request received for\nchild 1 (server PDDEKA-W1165:443)\n[Thu Aug 25 13:20:20 2005] [info] (OS 10054)An existing connection was forcibly\nclosed by the remote host.  : core_output_filter: writing data to the network\n[Thu Aug 25 13:20:20 2005] [info] (620019)APR does not understand this error\ncode: SSL output filter write failed.\n----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n\nThe processing aborts. But unfortunately the transient buckets of apr_bucket.c\nwill not deleted. Because this bucket resp. its brigade will be referenced in\nthe ctx and this will be processed later at the finalizing of the request:\nIn succession of the call of ap_finalize_request_protocol(r) of this request\nap_old_write_filter  will be called. \n\n----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\nprotocol.c:\nAP_CORE_DECLARE_NONSTD(apr_status_t) ap_old_write_filter(\n    ap_filter_t *f, apr_bucket_brigade *bb)\n{\n    old_write_filter_ctx *ctx = f->ctx;\n\n    AP_DEBUG_ASSERT(ctx);\n\n    if (ctx->bb != 0) {\n        /* whatever is coming down the pipe (we don't care), we\n         * can simply insert our buffered data at the front and\n         * pass the whole bundle down the chain.\n         */\n        APR_BRIGADE_CONCAT(ctx->bb, bb);\n        bb = ctx->bb;\n        ctx->bb = NULL;\n    }\n\n    return ap_pass_brigade(f->next, bb);\n}\n----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n\nBecause ctx->bb contains the \"transient\" bucket containing a data address which\nno more exists the processing of the bucket crashes.\n\n\nFollowing solution does solve our problem:\n----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\napr_brigade.c:\nAPU_DECLARE(apr_status_t) apr_brigade_write(apr_bucket_brigade *b,\n                                            apr_brigade_flush flush,\n                                            void *ctx,\n                                            const char *str, apr_size_t nbyte)\n{\n ...\n    if (nbyte > remaining) {\n        /* either a buffer bucket exists but is full,\n         * or no buffer bucket exists and the data is too big\n         * to buffer.  In either case, we should flush.  */\n        if (flush) {\n            apr_status_t rv = 0;\n\n            e = apr_bucket_transient_create(str, nbyte, b->bucket_alloc);\n            APR_BRIGADE_INSERT_TAIL(b, e);\n            rv = flush(b, ctx);\n\n            if (rv != APR_SUCCESS) {\n              apr_bucket_delete(e);\n              apr_brigade_cleanup(b);\n            }\n            return rv;\n...\n----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n\nAppendix: httpd.conf\n----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\nTimeout 300\nKeepAlive On\nMaxKeepAliveRequests 0\nKeepAliveTimeout 90\n<IfModule mpm_winnt.c>\nThreadsPerChild 100\nMaxRequestsPerChild  0\nWin32DisableAcceptEx ON\n</IfModule>\nLoadModule access_module modules/mod_access.so\nLoadModule alias_module modules/mod_alias.so\nLoadModule dir_module modules/mod_dir.so\nLoadModule headers_module modules/mod_headers.so\nLoadModule include_module modules/mod_include.so\nLoadModule log_config_module modules/mod_log_config.so\nLoadModule mime_module modules/mod_mime.so\nLoadModule negotiation_module modules/mod_negotiation.so\nLoadModule setenvif_module modules/mod_setenvif.so\nLoadModule deflate_module modules/mod_deflate.so\n<IfDefine SSL>\nLoadModule ssl_module modules/mod_ssl.so\n</IfDefine>\nLoadModule python_module modules/mod_python.so\nUseCanonicalName Off\nAddType application/x-javascript .js\n<Directory \"/\">\n    AddOutputFilterByType DEFLATE text/html text/plain text/css\napplication/x-javascript\n    Header append Vary User-Agent env=!dont-vary\n    AllowOverride None\n    Order allow,deny\n    Allow from all\n</Directory>\nDirectoryIndex index.html index.html.var\nAccessFileName .htaccess\n<Files ~ \"^\\.ht\">\n    Order allow,deny\n    Deny from all\n</Files>\nTypesConfig conf/mime.types\nDefaultType text/plain\nHostnameLookups Off\nLogLevel info\nLogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\" combined\nLogFormat \"%h %l %u %t \\\"%r\\\" %>s %b\" common\nLogFormat \"%{Referer}i -> %U\" referer\nLogFormat \"%{User-agent}i\" agent\nServerTokens Full\nServerSignature On\nAddLanguage da .dk\nAddLanguage nl .nl\nAddLanguage en .en\nAddLanguage et .et\nAddLanguage fr .fr\nAddLanguage de .de\nAddLanguage he .he\nAddLanguage el .el\nAddLanguage it .it\nAddLanguage ja .ja\nAddLanguage pl .po\nAddLanguage ko .ko\nAddLanguage pt .pt\nAddLanguage nn .nn\nAddLanguage no .no\nAddLanguage pt-br .pt-br\nAddLanguage ltz .ltz\nAddLanguage ca .ca\nAddLanguage es .es\nAddLanguage sv .sv\nAddLanguage cs .cz .cs\nAddLanguage ru .ru\nAddLanguage zh-CN .zh-cn\nAddLanguage zh-TW .zh-tw\nAddLanguage hr .hr\nLanguagePriority en da nl et fr de el it ja ko no pl pt pt-br ltz ca es sv tw\nForceLanguagePriority Prefer Fallback\nAddDefaultCharset ISO-8859-1\nAddCharset ISO-8859-1  .iso8859-1 .latin1\nAddCharset ISO-8859-2  .iso8859-2 .latin2 .cen\nAddCharset ISO-8859-3  .iso8859-3 .latin3\nAddCharset ISO-8859-4  .iso8859-4 .latin4\nAddCharset ISO-8859-5  .iso8859-5 .latin5 .cyr .iso-ru\nAddCharset ISO-8859-6  .iso8859-6 .latin6 .arb\nAddCharset ISO-8859-7  .iso8859-7 .latin7 .grk\nAddCharset ISO-8859-8  .iso8859-8 .latin8 .heb\nAddCharset ISO-8859-9  .iso8859-9 .latin9 .trk\nAddCharset ISO-2022-JP .iso2022-jp .jis\nAddCharset ISO-2022-KR .iso2022-kr .kis\nAddCharset ISO-2022-CN .iso2022-cn .cis\nAddCharset Big5        .Big5       .big5\nAddCharset WINDOWS-1251 .cp-1251   .win-1251\nAddCharset CP866       .cp866\nAddCharset KOI8-r      .koi8-r .koi8-ru\nAddCharset KOI8-ru     .koi8-uk .ua\nAddCharset ISO-10646-UCS-2 .ucs2\nAddCharset ISO-10646-UCS-4 .ucs4\nAddCharset UTF-8       .utf8\nAddCharset GB2312      .gb2312 .gb\nAddCharset utf-7       .utf7\nAddCharset utf-8       .utf8\nAddCharset big5        .big5 .b5\nAddCharset EUC-TW      .euc-tw\nAddCharset EUC-JP      .euc-jp\nAddCharset EUC-KR      .euc-kr\nAddCharset shift_jis   .sjis\nAddType application/x-tar .tgz\nAddType image/x-icon .ico\nAddHandler type-map var\nBrowserMatch \"Mozilla/2\" nokeepalive\nBrowserMatch \"MSIE 4\\.0b2;\" nokeepalive downgrade-1.0 force-response-1.0\nBrowserMatch \"RealPlayer 4\\.0\" force-response-1.0\nBrowserMatch \"Java/1\\.0\" force-response-1.0\nBrowserMatch \"JDK/1\\.0\" force-response-1.0\nBrowserMatch \"Microsoft Data Access Internet Publishing Provider\" redirect-carefully\nBrowserMatch \"^WebDrive\" redirect-carefully\nBrowserMatch \"^WebDAVFS/1.[012]\" redirect-carefully\nBrowserMatch \"^gnome-vfs\" redirect-carefully\n<IfModule mod_ssl.c>\n    Include conf/ssl.conf\n</IfModule>"}, {"count": 1, "tags": [], "bug_id": 36780, "text": "Interesting report and great analysis, thanks a lot.\n\nI don't think it's necessarily correct to fix this in apr_brigade_write.\n\nIf you instead change the core_output_filter to add a call to:\n\n  apr_brigade_cleanup(b);\n\non the error path, does that work too?", "id": 80364, "time": "2005-09-23T14:59:06Z", "creator": "jorton@redhat.com", "creation_time": "2005-09-23T14:59:06Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 36780, "attachment_id": null, "id": 80380, "time": "2005-09-23T16:46:28Z", "creator": "sybspublicadress@gmx.de", "creation_time": "2005-09-23T16:46:28Z", "is_private": false, "text": "Thanks for the quick answer.\nCould you please state your solution more precisely? Where exactly should i add \nthe apr_brigade_cleanup call in core_output_filter. Sorry for inconvenience, \nbut i am not an Apache specialist.\n\n\n"}, {"count": 3, "tags": [], "text": "Created attachment 16502\npatch against 2.0.x for core_output_filter\n\nWell if we gave out badges you'd win an \"I'm an Apache expert\" badge for\ntracking down a bug like this ;)\n\nAttached is a patch against 2.0.x to implement what I suggested; don't forget\nto revert your apr_brigade_write() change when testing this out.", "attachment_id": 16502, "id": 80381, "creator": "jorton@redhat.com", "time": "2005-09-23T16:52:46Z", "bug_id": 36780, "creation_time": "2005-09-23T16:52:46Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 36780, "text": "Birgit excellent report. This is what the guys love here :-).\nJoe, I had a look in the core output filter and apr_brigade_destroy(b) is called\na few lines above (4255 for 2.0.54, 4285 in 291543) regardless of the value of\nrv. So does the call of apr_brigade_cleanup in your patch really change things?\nSorry, I am not so deep in the details of the filters, but isn't the core output\nfilter the very last one in the chain? If so I guess we do not see the original\nbrigade / buckets here because they have been transformed by mod_deflate and\nmod_ssl on their way.\nBirgit does this crash also happen without mod_deflate and mod_ssl (This is not\na solution proposal, I just try to narrow things :-))?\n", "id": 80465, "time": "2005-09-26T06:39:44Z", "creator": "ruediger.pluem@vodafone.com", "creation_time": "2005-09-26T06:39:44Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 36780, "text": "Created attachment 16524\npatch against 2.0.x for buffer_output\n\nI tried solve it after the return from apr_brigade_write. Reminder: Don't\nforget to revert your apr_brigade_write() change when testing this out.", "id": 80466, "time": "2005-09-26T07:13:09Z", "creator": "ruediger.pluem@vodafone.com", "creation_time": "2005-09-26T07:13:09Z", "is_private": false, "attachment_id": 16524}, {"count": 6, "tags": [], "text": "Ah, good point too.\n\nBut then this problem is not not really specific to the old_write_filter.  It is\na problem which is intrisic to the way that apr_brigade_write/ap_f* work.\n\nIf the ap_filter_flush() call fails, the transient bucket which is left in the\nbrigade may *immediately* fall out of scope; it is never really save for ap_f*\nto leave that bucket in the brigade.\n\nSo maybe the best place to fix this is in ap_filter_flush().\n", "attachment_id": null, "bug_id": 36780, "id": 80472, "time": "2005-09-26T12:34:43Z", "creator": "jorton@redhat.com", "creation_time": "2005-09-26T12:34:43Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 36780, "attachment_id": null, "id": 80473, "time": "2005-09-26T12:54:38Z", "creator": "sybspublicadress@gmx.de", "creation_time": "2005-09-26T12:54:38Z", "is_private": false, "text": "The patch in core_output_filter doesn't solve the problem but the patch in \nserver.c does it :)\nThis crash doesn't happen without mod_deflate and mod_ssl in my test program. \nBut i think it is more diffcult to create the error case without mod_deflate \nand mod_ssl. "}, {"count": 8, "tags": [], "bug_id": 36780, "text": "Birgit, do you mean my patch? I was confused because it patches protocol.c.\nJoe, seems reasonable to me to fix this in ap_filter_flush. What should be the\napproach?\nDestroy the bucket brigade if ap_pass_brigade does not return APR_SUCCESS? Or\nshould we only remove and destroy the transient bucket (this seems a bit tricky\nto me and I am currently very unsure about the sideeffects)?\nBTW: I would guess that this problem also occurs on the trunk.\nSo should we also be aware of APR_EAGAIN in preparation for the async IO branch?", "id": 80475, "time": "2005-09-26T13:49:20Z", "creator": "ruediger.pluem@vodafone.com", "creation_time": "2005-09-26T13:49:20Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "text": "Created attachment 16530\npatch against trunk for ap_filter_flush\n\nThis is what I'd propose.  I'm going to write a test case for this to reproduce\nthe bug and confirm the fix.", "is_private": false, "bug_id": 36780, "id": 80476, "time": "2005-09-26T14:15:41Z", "creator": "jorton@redhat.com", "creation_time": "2005-09-26T14:15:41Z", "attachment_id": 16530}, {"count": 10, "tags": [], "bug_id": 36780, "attachment_id": null, "id": 80477, "time": "2005-09-26T14:51:40Z", "creator": "sybspublicadress@gmx.de", "creation_time": "2005-09-26T14:51:40Z", "is_private": false, "text": "oh, sorry I meant server/protocol.c resp. your patch R\u00fcdiger solves the problem.\n"}, {"count": 11, "tags": [], "bug_id": 36780, "text": "The patch in server/util_filter.c of ap_filter_flush works too.", "id": 80482, "time": "2005-09-26T16:17:38Z", "creator": "sybspublicadress@gmx.de", "creation_time": "2005-09-26T16:17:38Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 36780, "text": "*** Bug 39738 has been marked as a duplicate of this bug. ***", "id": 109243, "time": "2007-10-11T06:22:41Z", "creator": "jorton@redhat.com", "creation_time": "2007-10-11T06:22:41Z", "is_private": false, "attachment_id": null}, {"count": 13, "tags": [], "text": "*** Bug 43533 has been marked as a duplicate of this bug. ***", "attachment_id": null, "bug_id": 36780, "id": 109245, "time": "2007-10-11T06:26:54Z", "creator": "jorton@redhat.com", "creation_time": "2007-10-11T06:26:54Z", "is_private": false}, {"count": 14, "tags": [], "creator": "noah@hd.se", "attachment_id": null, "text": "(In reply to comment #13)\n> *** Bug 43533 has been marked as a duplicate of this bug. ***\n\n\nI applied Joe's patch in comment 9 but I'm still getting crashes.\n\n\nWe do use mod_deflate and mod_ssl but I don't think we've got much traffic on\nthe SSL site.\n\nWe too get a lot of \"core_output_filter: writing data to the network .. broken\npipe\" log messages if that's interesting in any way.\n\n\n\n------------\ncrashdump[3845]: Thread 17 Crashed:\ncrashdump[3845]: 0   httpd                      0x00004780 bndm + 120\n(mod_include.c:317)\ncrashdump[3845]: 1   httpd                      0x0000a0e0 find_start_sequence +\n136 (mod_include.c:2388)\ncrashdump[3845]: 2   httpd                      0x0000bab0 send_parsed_content +\n1288 (mod_include.c:3054)\ncrashdump[3845]: 3   httpd                      0x0000dbd8 includes_filter +\n1468 (mod_include.c:3591)\ncrashdump[3845]: 4   httpd                      0x00068e10 ap_pass_brigade + 236\n(util_filter.c:512)\n--\ncrashdump[10232]: Thread 1 Crashed:\ncrashdump[10232]: 0   httpd                     0x00004780 bndm + 120\n(mod_include.c:317)\ncrashdump[10232]: 1   httpd                     0x0000a0e0 find_start_sequence +\n136 (mod_include.c:2388)\ncrashdump[10232]: 2   httpd                     0x0000bab0 send_parsed_content +\n1288 (mod_include.c:3054)\ncrashdump[10232]: 3   httpd                     0x0000dbd8 includes_filter +\n1468 (mod_include.c:3591)\ncrashdump[10232]: 4   httpd                     0x00068e10 ap_pass_brigade + 236\n(util_filter.c:512)\n--\ncrashdump[12500]: Thread 13 Crashed:\ncrashdump[12500]: 0   httpd                     0x00004780 bndm + 120\n(mod_include.c:317)\ncrashdump[12500]: 1   httpd                     0x0000a0e0 find_start_sequence +\n136 (mod_include.c:2388)\ncrashdump[12500]: 2   httpd                     0x0000bab0 send_parsed_content +\n1288 (mod_include.c:3054)\ncrashdump[12500]: 3   httpd                     0x0000dbd8 includes_filter +\n1468 (mod_include.c:3591)\ncrashdump[12500]: 4   httpd                     0x00068e10 ap_pass_brigade + 236\n(util_filter.c:512)\n--\ncrashdump[13586]: Thread 10 Crashed:\ncrashdump[13586]: 0   <<00000000>>      0xffff8a2c __memcpy + 652\n(cpu_capabilities.h:189)\ncrashdump[13586]: 1   libz.1.dylib              0x911156bc read_buf + 144\ncrashdump[13586]: 2   libz.1.dylib              0x911155b8 fill_window + 256\ncrashdump[13586]: 3   libz.1.dylib              0x91117300 deflate_fast + 64\ncrashdump[13586]: 4   libz.1.dylib              0x91114c34 deflate + 2148\n--\ncrashdump[13589]: Thread 4 Crashed:\ncrashdump[13589]: 0   libz.1.dylib              0x911116d8 crc32_big + 72\ncrashdump[13589]: 1   mod_deflate.so            0x0060e4b8 deflate_out_filter +\n4336 (mod_deflate.c:545)\ncrashdump[13589]: 2   httpd                     0x00068e10 ap_pass_brigade + 236\n(util_filter.c:512)\ncrashdump[13589]: 3   httpd                     0x0005121c\nap_sub_req_output_filter + 216 (request.c:1539)\ncrashdump[13589]: 4   httpd                     0x00068e10 ap_pass_brigade + 236\n(util_filter.c:512)\n--\ncrashdump[14742]: Thread 12 Crashed:\ncrashdump[14742]: 0   httpd                     0x0000ab28 find_tail + 184\n(mod_include.c:2675)\ncrashdump[14742]: 1   httpd                     0x0000c38c send_parsed_content +\n3556 (mod_include.c:3201)\ncrashdump[14742]: 2   httpd                     0x0000dbd8 includes_filter +\n1468 (mod_include.c:3591)\ncrashdump[14742]: 3   httpd                     0x00068e10 ap_pass_brigade + 236\n(util_filter.c:512)\ncrashdump[14742]: 4   httpd                     0x0004a5a8 default_handler +\n1888 (core.c:3648)\n", "id": 109270, "time": "2007-10-11T11:52:35Z", "bug_id": 36780, "creation_time": "2007-10-11T11:52:35Z", "is_private": false}, {"count": 15, "tags": [], "bug_id": 36780, "text": "(In reply to comment #14)\n> (In reply to comment #13)\n> > *** Bug 43533 has been marked as a duplicate of this bug. ***\n> \n> \n> I applied Joe's patch in comment 9 but I'm still getting crashes.\n\nNoticed I forgot to apply \"patch against 2.0.x for buffer_output\". Did that too\nbut I'm still experiencing the same crashes.", "id": 109286, "attachment_id": null, "creator": "noah@hd.se", "creation_time": "2007-10-11T16:26:30Z", "time": "2007-10-11T16:26:30Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 36780, "attachment_id": 24087, "id": 129401, "time": "2009-08-03T03:48:48Z", "creator": "jorton@redhat.com", "creation_time": "2009-08-03T03:48:48Z", "is_private": false, "text": "Created attachment 24087\nfix for 2.2.x\n\nAttached proposed backport of fix for 2.2.x."}, {"count": 17, "tags": [], "bug_id": 36780, "text": "Fixed in trunk:\n\nr583817\nr583830\n\nFixed in 2.2.x:\n\nr800333", "id": 129406, "time": "2009-08-03T05:34:40Z", "creator": "jorton@redhat.com", "creation_time": "2009-08-03T05:34:40Z", "is_private": false, "attachment_id": null}]