[{"count": 0, "tags": [], "bug_id": 38655, "attachment_id": null, "is_private": false, "id": 85812, "time": "2006-02-15T13:51:01Z", "creator": "youichi_kato@justsystem.co.jp", "creation_time": "2006-02-15T13:51:01Z", "text": "Version: java xml-security 1.3.0.\nOS:      all (actuary, I am using Windows-XP)\n\n- Problem\n when xml data has many namespaces, Canonicalizer#canonicalizeSubtree() throws\nexception.\n\n- Reproduce:\n[java code]\n  public static String toString(final Node n) throws Exception {\n    ByteArrayOutputStream baos = new ByteArrayOutputStream();\n    Canonicalizer c14n =\nCanonicalizer.getInstance(Canonicalizer.ALGO_ID_C14N_OMIT_COMMENTS);\n    byte[] serBytes = c14n.canonicalizeSubtree(n);\n    ...\n  }\n\n[using XML data]\n  <?xml version=\"1.0\"?>\n  <wiki\n      xmlns:generated-command=\"http://foo.com/command\"\n    xmlns:generated-event=\"http://foo.com/event\"\n    xmlns:command=\"http://foo.com/command\"\n    xmlns:ui=\"http://foo.com/ui\"\n    xmlns:event=\"http://foo.com/event\"\n    xmlns:instruction=\"http://foo/instruction\"\n    xmlns:directory=\"http://foo.com/io/directory\"\n    xmlns:function=\"http://foo.com/function\"\n    xmlns=\"http://www.w3.org/1999/xhtml\"\n    xmlns:ctrl=\"http://foo.com/controls\"\n    xmlns:wiki=\"http://foo.com/samples/wiki\">\n  <wiki:content>\n    <wiki:paragraph />\n  </wiki:content>\n</wiki>\n\n- Result\n java.lang.ArrayIndexOutOfBoundsException: 23\n    at org.apache.xml.security.c14n.implementations.SymbMap.index(Unknown Source)\n    at org.apache.xml.security.c14n.implementations.SymbMap.get(Unknown Source)\n    at\norg.apache.xml.security.c14n.implementations.NameSpaceSymbTable.addMappingAndRender(Unknown\nSource)\n    at\norg.apache.xml.security.c14n.implementations.Canonicalizer20010315.handleAttributesSubtree(Unknown\nSource)\n    at\norg.apache.xml.security.c14n.implementations.CanonicalizerBase.canonicalizeSubTree(Unknown\nSource)\n    at\norg.apache.xml.security.c14n.implementations.CanonicalizerBase.engineCanonicalizeSubTree(Unknown\nSource)\n    at\norg.apache.xml.security.c14n.implementations.CanonicalizerBase.engineCanonicalizeSubTree(Unknown\nSource)\n    at org.apache.xml.security.c14n.Canonicalizer.canonicalizeSubtree(Unknown\nSource)\n    ...\n\n- My Solution\nxml-security-1_3_0\\src\\org\\apache\\xml\\security\\c14n\\implementations\\NameSpaceSymbTable.java\nline 359,\n\nprotected int index(Object obj) {\n  Object[] set = keys;\n  int length = set.length;\n  //abs of index\n  int index = (obj.hashCode() & 0x7fffffff) % length;\n  Object cur = set[index];\n  \n  if (cur == null || (cur.equals( obj))) {\n    return index;\n  }\n  do {\n    index=index==length? 0:++index;  // <--- Why ?\n    cur = set[index];\n  } while (cur != null && (!cur.equals(obj)));\n  return index;\n}\n\nwhen \"index == length-1\", \"index==length? 0:++index\" is evaluated length, \nit is OutOfBounds!\nI edited the code to \"(index+1) % length\" , it works good."}, {"count": 1, "tags": [], "bug_id": 38655, "attachment_id": null, "is_private": false, "id": 87675, "time": "2006-04-07T16:31:08Z", "creator": "raul-info@r-bg.com", "creation_time": "2006-04-07T16:31:08Z", "text": "Thanks for the pointing the problem.  Your solution was good but it will be slow\nin a loop(division is a slow operation in several architectures).\n\nNow is fixed in SVN.\n\n"}, {"count": 2, "tags": [], "creator": "raul-info@r-bg.com", "attachment_id": null, "text": "Closing old bugs.", "id": 91978, "time": "2006-08-06T18:04:10Z", "bug_id": 38655, "creation_time": "2006-08-06T18:04:10Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 38655, "attachment_id": null, "id": 109379, "time": "2007-10-16T02:47:48Z", "creator": "f.merighi@cineca.it", "creation_time": "2007-10-16T02:47:48Z", "is_private": false, "text": "Same bug appears in jre 1.6.0_03 and previous. Any suggestion?"}, {"count": 4, "tags": [], "bug_id": 38655, "attachment_id": null, "is_private": false, "id": 109382, "time": "2007-10-16T03:05:13Z", "creator": "raul-info@r-bg.com", "creation_time": "2007-10-16T03:05:13Z", "text": "Can you post an example of the problem. The tests are working for this case.\n\nRegards,"}, {"count": 5, "text": "- Environment: Java version: 1.6.0_03 (suspected on all OS, but currently \ntested on Windows XP)\n\n- Problem: when sign an xml document with more than one namespace, XML \nSignature throws an exception caused by the Canonicalizer\n\n- Reproduce:\n\npublic static void main(String args[]) throws Exception {\n\tDocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();\n\tdbf.setNamespaceAware(true);\n\tDocument doc = dbf.newDocumentBuilder().parse(\n\t\t\tnew FileInputStream(args[0]));\n\tXMLSignatureFactory fac = XMLSignatureFactory.getInstance(\"DOM\");\n\tDigestMethod digestMethod = fac.newDigestMethod(\n\t\t\t\"http://www.w3.org/2000/09/xmldsig#sha1\", null);\n\t\n\tSignedInfo signedInfo = fac.newSignedInfo(fac.newCanonicalizationMethod\n(\n\t\t\t\"http://www.w3.org/TR/2001/REC-xml-c14n-20010315\",\n\t\t\t(C14NMethodParameterSpec) null), fac.newSignatureMethod\n(\n\t\t\t\t\t\"http://www.w3.org/2000/09/xmldsig#rsa-\nsha1\", null), Collections.singletonList(fac.newReference(\"\", digestMethod, \nnull,\n\t\t\t\"http://www.w3.org/2000/09/xmldsig#object\", null)));\n\t\n\tDOMSignContext signContext = new DOMSignContext( \nKeyPairGenerator.getInstance(\"RSA\").generateKeyPair().getPrivate(), doc\n\t\t\t.getDocumentElement());\n\tfac.newXMLSignature(signedInfo, null).sign(signContext);\n}\n\nWith XML input:\n\n<?xml version=\"1.0\"?>\n  <wiki\n      xmlns:generated-command=\"http://foo.com/command\"\n    xmlns:generated-event=\"http://foo.com/event\"\n    xmlns:command=\"http://foo.com/command\"\n    xmlns:ui=\"http://foo.com/ui\"\n    xmlns:event=\"http://foo.com/event\"\n    xmlns:instruction=\"http://foo/instruction\"\n    xmlns:directory=\"http://foo.com/io/directory\"\n    xmlns:function=\"http://foo.com/function\"\n    xmlns=\"http://www.w3.org/1999/xhtml\"\n    xmlns:ctrl=\"http://foo.com/controls\"\n    xmlns:wiki=\"http://foo.com/samples/wiki\">\n  <wiki:content>\n    <wiki:paragraph />\n  </wiki:content>\n</wiki>\n\n- Result:\n\nException in thread \"main\" javax.xml.crypto.dsig.XMLSignatureException: \njava.lang.ArrayIndexOutOfBoundsException: 23\n\tat org.jcp.xml.dsig.internal.dom.DOMReference.transform(Unknown Source)\n\tat org.jcp.xml.dsig.internal.dom.DOMReference.digest(Unknown Source)\n\tat org.jcp.xml.dsig.internal.dom.DOMXMLSignature.digestReference\n(Unknown Source)\n\tat org.jcp.xml.dsig.internal.dom.DOMXMLSignature.sign(Unknown Source)\n\tat CanonicalizerTest.main(CanonicalizerTest.java:32)\nCaused by: java.lang.ArrayIndexOutOfBoundsException: 23\n\tat \ncom.sun.org.apache.xml.internal.security.c14n.implementations.SymbMap.index\n(Unknown Source)\n\tat \ncom.sun.org.apache.xml.internal.security.c14n.implementations.SymbMap.get\n(Unknown Source)\n\tat \ncom.sun.org.apache.xml.internal.security.c14n.implementations.NameSpaceSymbTabl\ne.addMappingAndRender(Unknown Source)\n\tat \ncom.sun.org.apache.xml.internal.security.c14n.implementations.Canonicalizer2001\n0315.handleAttributesSubtree(Unknown Source)\n\tat \ncom.sun.org.apache.xml.internal.security.c14n.implementations.CanonicalizerBase\n.canonicalizeSubTree(Unknown Source)\n\tat \ncom.sun.org.apache.xml.internal.security.c14n.implementations.CanonicalizerBase\n.engineCanonicalizeSubTree(Unknown Source)\n\tat \ncom.sun.org.apache.xml.internal.security.c14n.implementations.CanonicalizerBase\n.engineCanonicalize(Unknown Source)\n\tat \ncom.sun.org.apache.xml.internal.security.signature.XMLSignatureInput.updateOutp\nutStream(Unknown Source)\n\t... 5 more\n\n\nThis bug is critical for XML Signature: i've submitted it to Java Developer \nBug Report too.\n", "bug_id": 38655, "attachment_id": null, "id": 109462, "time": "2007-10-18T08:22:27Z", "creator": "f.merighi@cineca.it", "creation_time": "2007-10-18T08:22:27Z", "tags": [], "is_private": false}, {"text": "(In reply to comment #5)\n> - Environment: Java version: 1.6.0_03 (suspected on all OS, but currently \n> tested on Windows XP)\n> \n> This bug is critical for XML Signature: i've submitted it to Java Developer \n> Bug Report too.\n\nThis bug has been fixed in the Apache 1.4 release of XMLSec. It has not been\nfixed in Sun's implementation that is bundled with JDK 6 (which is based on\nApache XMLSec 1.3). So you are correct to report it via Sun's JDC, however I am\nchanging this back to closed as it is fixed in the Apache 1.4 release.\n\n", "tags": [], "creator": "sean.mullan@oracle.com", "attachment_id": null, "count": 6, "id": 109556, "time": "2007-10-22T11:40:59Z", "bug_id": 38655, "creation_time": "2007-10-22T11:40:59Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 38655, "is_private": false, "text": "Thank you very much, \nBest Regards", "id": 109659, "time": "2007-10-23T08:41:14Z", "creator": "f.merighi@cineca.it", "creation_time": "2007-10-23T08:41:14Z", "attachment_id": null}]