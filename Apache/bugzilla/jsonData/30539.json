[{"count": 0, "tags": [], "bug_id": 30539, "attachment_id": null, "text": "I have a specific mod_jk2 2.0.4 configuration which maps 2 different port\nnumbers (running different Apache 2.0.49 virtual hosts) to 2 different Tomcat\n5.0.24 services.\n\nI managed to do this by using the following workers2.properties configuration (I\nprovide relevant directives only):\n\n--- BEGIN SNIP ---\n\n[ajp13:localhost:8009]\nchannel=channel.socket:localhost:8009\ngroup=ajp13:localhost:8009\n\n[ajp13:localhost:8010]\nchannel=channel.socket:localhost:8010\ngroup=ajp13:localhost:8010\n\n[channel.socket:localhost:8009]\nport=8009\nhost=localhost\ngroup=ajp13:localhost:8009\n \n[channel.socket:localhost:8010]\nport=8010\nhost=localhost\ngroup=ajp13:localhost:8010\n\n# URI mappings\n[uri:*:80/*.jsp]\ngroup=ajp13:localhost:8009\n\n[uri:*:443/*.jsp]\ngroup=ajp13:localhost:8009\n\n# mapping from the second Apache virtual host (running on secret port XXXX)\n# to the second Tomcat service:\n\n[uri:*:XXXX/*.jsp]\ngroup=ajp13:localhost:8010\n\n--- END SNIP ---\n\nThis configuration works fine, but there's a security problem we've recently\ndiscovered that I suspect to be the mod_jk2's fault:\n\nIf a HTTP client requests a JSP page and supplies a \"Host:\" HTTP header, and\nprovides a port there, and the port is not valid (that is, it's not 80, 443, or\nXXXX), then Apache spills out the JSP file's source instead of putting it\nthrough mod_jk2 to be serviced by Tomcat!\n\nThis can be easily reproduced with livehttpheaders extension for Mozilla.\n\nSteps to reproduce:\n1) install the livehttpheaders extension in Mozilla:\nhttp://livehttpheaders.mozdev.org/\n2) open the livehttpheaders window (Tools->Web Development->Live HTTP Headers)\n3) load a JSP page from Apache, it should display normally\n4) select the URL line over \"GET XXXX.jsp\" line in the livehttpheaders window\n5) click \"Replay...\"\n6) change the \"Host:\" header to use an invalid port number, e.g. \"Host:\nwww.example.com:1234\"\n7) click \"Replay\" - In my case, I received the source of JSP page (as text/plain).\n\n\nI've tried remedying the problem by supplying additional \"catch-all\" URI\nmappings at the end of workers2.properties, using various patterns:\n\"[uri:*.jsp]\", or \"[uri:*:*.jsp]\", but none of them has helped - it seemed that\nApache was just bypassing mod_jk2 and _ANY_ URI mappings when the Host header\ncontained an invalid port.\n\nSo as a temporary workaround I've prepared the following access control\nmechanism in Apache:\n\n--- BEGIN SNIP ---\n# If the \"Host:\" header specifies a port, deny access to JSP files by setting a\ncustom env variable:\nSetEnvIfNoCase Host \\: HOST_PORT_DENIED=yes\n# The ports 80, 443 and XXXX are valid, unset the custom env variable for them:\nSetEnvIfNoCase Host \\:80$ !HOST_PORT_DENIED\nSetEnvIfNoCase Host \\:443$ !HOST_PORT_DENIED\nSetEnvIfNoCase Host \\:XXXX$ !HOST_PORT_DENIED\n\n# deny access to JSP based on custom env variable presence:\n<Files \"*.jsp\">\n  Order Allow,Deny\n  Allow from all\n  Deny from env=HOST_PORT_DENIED\n</Files>\n--- END SNIP ---\n\nThis, however, is only a workaround. Ideally, requests with \"Host:\" header\nspecifying a port on which Apache doesn't listen, should be denied (IMHO), or at\nleast passed through mod_jk2 and its URI mappings.", "id": 61708, "time": "2004-08-09T11:57:40Z", "creator": "aleksander.adamowski.apache@altkom.pl", "creation_time": "2004-08-09T11:57:40Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 30539, "text": "For the record, the issue has been discovered by Pawe\u0142 Sawicki\n(pawel.sawicki@altkom.pl).", "id": 61714, "time": "2004-08-09T13:46:31Z", "creator": "aleksander.adamowski.apache@altkom.pl", "creation_time": "2004-08-09T13:46:31Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 30539, "text": "Shouldn't this then be an httpd bug?", "id": 67083, "time": "2004-11-17T22:03:04Z", "creator": "yoavs@computer.org", "creation_time": "2004-11-17T22:03:04Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 30539, "attachment_id": null, "text": "As of November 15, 2004, JK2 is no longer supported. All bugs related to JK2 \nwill be marked as WONTFIX. In its place, some of its features have been \nbackported to jk1. Most of those features will be seen in 1.2.7, which is \nslated for release on November 30th, 2004.\n\nAnother alternative is the ajp addition to mod_proxy which will be part of \napache 2.\n\nFor more information on the Tomat connectors docs at\nhttp://jakarta.apache.org/tomcat/connectors-doc/\n", "id": 67554, "time": "2004-11-29T19:50:13Z", "creator": "yoavs@computer.org", "creation_time": "2004-11-29T19:50:13Z", "is_private": false}]