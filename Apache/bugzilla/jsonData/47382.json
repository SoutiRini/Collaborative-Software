[{"count": 0, "attachment_id": null, "bug_id": 47382, "text": "When running the Apache Harmony build on a z/OS machine I hit a problem loading one of our properties files. We do something along the lines of:\n\n <loadproperties srcfile=\"${basedir}/make/depends.properties\">\n   ...\n </loadproperties> \n\nHowever, on z/OS the depends.properties file is checked out as EBCDIC automatically by svn so I tried adding the encoding attribute to this task:\n\n <loadproperties srcfile=\"${basedir}/make/depends.properties.ascii\" encoding=\"ISO-8859-1\">\n   ...\n </loadproperties> \n\nUnfortunately this also failed to load the relevant properties. I had a dig into the loadproperties task code and see that when an encoding is specified it does something along the lines of:\n\n instream = new InputStreamReader(bis, encoding);\n String text = crh.readFully(instream);\n ByteArrayInputStream tis = new ByteArrayInputStream(text.getBytes(encoding));\n\nWe end up failing to read the file because the specified encoding should *not* be passed to getBytes(). What happens at the moment is:\n - The first 2 lines read the properties file from the specified encoding converting it to the default Java encoding (UTF-16?).\n - The third line converts the text into a byte array specifying the encoding to be converted from. However, \"text\" has already been converted into the default Java encoding, and when getBytes() converts it from EBCDIC->UTF-16 again we end up with garbage.\n\nThe second getBytes() call should specify the encoding we expect it to convert _from_, which is the Java default encoding here.", "id": 128016, "time": "2009-06-17T05:51:59Z", "creator": "oliver.deakin@googlemail.com", "creation_time": "2009-06-17T05:51:59Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 47382, "attachment_id": null, "id": 128017, "time": "2009-06-17T05:52:39Z", "creator": "oliver.deakin@googlemail.com", "creation_time": "2009-06-17T05:52:39Z", "is_private": false, "text": "In the 2nd loadproperties snippet above, \"depends.properties.ascii\" should read \"depends.properties\"."}, {"count": 2, "attachment_id": null, "bug_id": 47382, "text": "Copy-paste mistake - For clarity, that snippet should read\n\n <loadproperties srcfile=\"${basedir}/make/depends.properties\"\nencoding=\"IBM-1047\">\n   ...\n </loadproperties>", "id": 128018, "time": "2009-06-17T05:56:25Z", "creator": "oliver.deakin@googlemail.com", "creation_time": "2009-06-17T05:56:25Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "creator": "bodewig@apache.org", "attachment_id": null, "text": "fixed in svn revision 786506\n\nThanks!", "id": 128094, "time": "2009-06-19T06:46:13Z", "bug_id": 47382, "creation_time": "2009-06-19T06:46:13Z", "is_private": false}, {"count": 4, "tags": [], "creator": "oliver.deakin@googlemail.com", "attachment_id": null, "text": "Hi Stefan - thanks for looking at this so quickly! \n\nI just had a look at the change you made to call text.getBytes() without the encoding specified and Im pretty sure that will also fail. If an encoding is not specified, getBytes() defaults to converting from the default system encoding to the Java default encoding.\n\nSo in my case calling text.getBytes() is the same as calling text.getBytes(\"IBM-1047\"), and will still try and convert text again from EBCDIC->UTF-16. I think you need to explicitly specify that text is already in UTF-16 to getBytes i.e. text.getBytes(\"UTF-16\"). (Im assuming that UTF-16 is the correct encoding here)\n\nThat said, I havn't tested the change yet locally - does the test you added pass?", "id": 128097, "time": "2009-06-19T06:56:27Z", "bug_id": 47382, "creation_time": "2009-06-19T06:56:27Z", "is_private": false}, {"count": 5, "tags": [], "creator": "bodewig@apache.org", "attachment_id": null, "text": "Hi Oliver, yes, the test passes on my local system (where the default encoding most likely is some variant of iso-8859-15)", "id": 128101, "time": "2009-06-19T07:03:47Z", "bug_id": 47382, "creation_time": "2009-06-19T07:03:47Z", "is_private": false}, {"count": 6, "attachment_id": null, "bug_id": 47382, "text": "The stream is passed to properties.load(InputStream) which explicitly expects it to be iso-8859-1 encoded, I\u00c4ve adapted to code in svn revision 786515\n\nThe real solution would involve Properties.load(Reader) which has been added in Java 6 (and thus can be used in Ant in about five years, or so 8-).", "id": 128102, "time": "2009-06-19T07:10:44Z", "creator": "bodewig@apache.org", "creation_time": "2009-06-19T07:10:44Z", "tags": [], "is_private": false}, {"count": 7, "attachment_id": null, "bug_id": 47382, "text": "Brilliant, thanks Stefan! That looks good to me - what is the best way for me to verify this is fixed? Are there nightly builds I can pick up?", "id": 128103, "time": "2009-06-19T07:15:18Z", "creator": "oliver.deakin@googlemail.com", "creation_time": "2009-06-19T07:15:18Z", "tags": [], "is_private": false}, {"count": 8, "tags": [], "bug_id": 47382, "text": "The links on Ant's site are broken (and I'm not familiar enough with Teamcity to fix them reliably):\n\nhttp://teamcity.jetbrains.com/viewType.html?tab=buildTypeStatusDiv&buildTypeId=bt130\n\nworks for me.  This isn't built continously (unlike the other Ant builds on TeamCity) so you'll have to wait a day to get the result.", "id": 128105, "time": "2009-06-19T07:36:54Z", "creator": "bodewig@apache.org", "creation_time": "2009-06-19T07:36:54Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 47382, "text": "Thanks Stefan - Ill keep an eye on it and check the fix as soon as possible.", "id": 128106, "time": "2009-06-19T07:39:43Z", "creator": "oliver.deakin@googlemail.com", "creation_time": "2009-06-19T07:39:43Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 47382, "text": "I've tested on the 1.8.0 release and this bug appears to be fixed now. Thanks Stefan!", "id": 137348, "time": "2010-06-04T05:54:07Z", "creator": "oliver.deakin@googlemail.com", "creation_time": "2010-06-04T05:54:07Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "creator": "bodewig@apache.org", "attachment_id": null, "text": "Thanks for confirming this, Oliver.", "id": 137616, "time": "2010-06-14T09:12:36Z", "bug_id": 47382, "creation_time": "2010-06-14T09:12:36Z", "is_private": false}]