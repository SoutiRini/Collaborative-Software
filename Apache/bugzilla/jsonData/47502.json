[{"count": 0, "tags": [], "bug_id": 47502, "text": "Clustering fails on serializing javax.security.auth.subject. See stack below.\n\nI looked a little into the Tomcat code. In ./java/org/apache/catalina/connector/Request.java on line 1752 Tomcat puts the 'javax.security.auth.subject' on the session if you use a securitymanager. This is the MemoryUser in my case I think.\n\nI must use the securitymanager because I use RMI.\n\nIs there a solution possible by making the MemoryUser serializable or by not putting it in the session as an attribute. Mark Thomas <markt_at_apache_dot_org> suggested a note on the session at the Tomcat user-mailinglist. I've never seen notes on sessions.\n\nThe MemoryUser comes from the security-constraint in my web.xml.\n\n\nJul 8, 2009 5:53:52 PM org.apache.catalina.ha.session.DeltaSession writeObject\nSEVERE: Cannot serialize session attribute javax.security.auth.subject for session 9C533E0EB4A79ED5B206B8F5A5DB09AD\njava.io.NotSerializableException: org.apache.catalina.users.MemoryUser\n    at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1156)\n    at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:326)\n    at java.util.LinkedList.writeObject(LinkedList.java:943)\n    at sun.reflect.GeneratedMethodAccessor216.invoke(Unknown Source)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n    at java.lang.reflect.Method.invoke(Method.java:597)\n    at java.io.ObjectStreamClass.invokeWriteObject(ObjectStreamClass.java:945)\n    at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1461)\n    at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1392)\n    at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1150)\n    at java.io.ObjectOutputStream.access$300(ObjectOutputStream.java:143)\n    at java.io.ObjectOutputStream$PutFieldImpl.writeFields(ObjectOutputStream.java:1668)\n    at java.io.ObjectOutputStream.writeFields(ObjectOutputStream.java:454)\n    at javax.security.auth.Subject$SecureSet.writeObject(Subject.java:1281)\n    at sun.reflect.GeneratedMethodAccessor215.invoke(Unknown Source)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n    at java.lang.reflect.Method.invoke(Method.java:597)\n    at java.io.ObjectStreamClass.invokeWriteObject(ObjectStreamClass.java:945)\n    at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1461)\n    at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1392)\n    at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1150)\n    at java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1509)\n    at java.io.ObjectOutputStream.defaultWriteObject(ObjectOutputStream.java:416)\n    at java.util.Collections$SynchronizedCollection.writeObject(Collections.java:1602)\n    at sun.reflect.GeneratedMethodAccessor214.invoke(Unknown Source)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n    at java.lang.reflect.Method.invoke(Method.java:597)\n    at java.io.ObjectStreamClass.invokeWriteObject(ObjectStreamClass.java:945)\n    at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1461)\n    at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1392)\n    at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1150)\n    at java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1509)\n    at java.io.ObjectOutputStream.defaultWriteObject(ObjectOutputStream.java:416)\n    at javax.security.auth.Subject.writeObject(Subject.java:919)\n    at sun.reflect.GeneratedMethodAccessor213.invoke(Unknown Source)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n    at java.lang.reflect.Method.invoke(Method.java:597)\n    at java.io.ObjectStreamClass.invokeWriteObject(ObjectStreamClass.java:945)\n    at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1461)\n    at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1392)\n    at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1150)\n    at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:326)\n    at org.apache.catalina.ha.session.DeltaSession.writeObject(DeltaSession.java:714)\n    at org.apache.catalina.ha.session.DeltaSession.writeObjectData(DeltaSession.java:475)\n    at org.apache.catalina.ha.session.DeltaSession.writeObjectData(DeltaSession.java:472)\n    at org.apache.catalina.ha.session.DeltaManager.serializeSessions(DeltaManager.java:733)\n    at org.apache.catalina.ha.session.DeltaManager.sendSessions(DeltaManager.java:1513)\n    at org.apache.catalina.ha.session.DeltaManager.handleGET_ALL_SESSIONS(DeltaManager.java:1479)\n    at org.apache.catalina.ha.session.DeltaManager.messageReceived(DeltaManager.java:1310)\n    at org.apache.catalina.ha.session.DeltaManager.messageDataReceived(DeltaManager.java:1093)\n    at org.apache.catalina.ha.session.ClusterSessionListener.messageReceived(ClusterSessionListener.java:87)\n    at org.apache.catalina.ha.tcp.SimpleTcpCluster.messageReceived(SimpleTcpCluster.java:901)\n    at org.apache.catalina.ha.tcp.SimpleTcpCluster.messageReceived(SimpleTcpCluster.java:882)\n    at org.apache.catalina.tribes.group.GroupChannel.messageReceived(GroupChannel.java:269)\n    at org.apache.catalina.tribes.group.ChannelInterceptorBase.messageReceived(ChannelInterceptorBase.java:79)\n    at org.apache.catalina.tribes.group.ChannelInterceptorBase.messageReceived(ChannelInterceptorBase.java:79)\n    at org.apache.catalina.tribes.group.interceptors.TcpFailureDetector.messageReceived(TcpFailureDetector.java:110)\n    at org.apache.catalina.tribes.group.ChannelInterceptorBase.messageReceived(ChannelInterceptorBase.java:79)\n    at org.apache.catalina.tribes.group.ChannelCoordinator.messageReceived(ChannelCoordinator.java:241)\n    at org.apache.catalina.tribes.transport.ReceiverBase.messageDataReceived(ReceiverBase.java:225)\n    at org.apache.catalina.tribes.transport.nio.NioReplicationTask.drainChannel(NioReplicationTask.java:188)\n    at org.apache.catalina.tribes.transport.nio.NioReplicationTask.run(NioReplicationTask.java:91)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n    at java.lang.Thread.run(Thread.java:619)", "id": 128666, "time": "2009-07-09T05:57:29Z", "creator": "ronald-lists@klop.ws", "creation_time": "2009-07-09T05:57:29Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "text": "StandardSession excludes the session attribute named javax.security.auth.subject from being serialized. DeltaSession does not. \n\nHere's what StandardSession excludes from serializing:\n    protected static final String[] excludedAttributes = {\n        Globals.SUBJECT_ATTR\n    };\n\n\nOf course ... I suspect (without a deeper code dive) that excluding this from serialization might mean that you are not logged in across the whole cluster.\n\nHow to test ...\n\nHere is the existing code in DeltaSession.writeObject\n        for (int i = 0; i < keys.length; i++) {\n            Object value = null;\n            value = attributes.get(keys[i]);\n            if (value == null)\n                continue;\n            else if (value instanceof Serializable) {\n                saveNames.add(keys[i]);\n                saveValues.add(value);\n            }\n        }\n\ntry changing it to (so we are excluding it from serialization) \n        for (int i = 0; i < keys.length; i++) {\n            Object value = null;\n            value = attributes.get(keys[i]);\n            if (value == null || exclude(keys[i]))\n                continue;\n            else if (value instanceof Serializable) {\n                saveNames.add(keys[i]);\n                saveValues.add(value);\n            }\n        }\n\n\nHERE is the patch ...\nIndex: java/org/apache/catalina/ha/session/DeltaSession.java\n===================================================================\n--- java/org/apache/catalina/ha/session/DeltaSession.java       (revision 833086)\n+++ java/org/apache/catalina/ha/session/DeltaSession.java       (working copy)\n@@ -731,7 +731,7 @@\n         for (int i = 0; i < keys.length; i++) {\n             Object value = null;\n             value = attributes.get(keys[i]);\n-            if (value == null)\n+            if (value == null || exclude(keys[i]))\n                 continue;\n             else if (value instanceof Serializable) {\n                 saveNames.add(keys[i]);", "is_private": false, "id": 131734, "creator": "funkman@apache.org", "time": "2009-11-05T10:10:32Z", "bug_id": 47502, "creation_time": "2009-11-05T10:10:32Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 47502, "attachment_id": null, "id": 131736, "time": "2009-11-05T10:29:10Z", "creator": "funkman@apache.org", "creation_time": "2009-11-05T10:29:10Z", "is_private": false, "text": "changing status to NEEDINFO based on last comment"}, {"count": 3, "attachment_id": null, "bug_id": 47502, "text": "This session attribute used when running under a security manager. Authentication is handled separately. The patch looks good to me.\n\nI've applied it to trunk and proposed it for 6.0.x", "id": 132566, "time": "2009-12-01T16:33:25Z", "creator": "markt@apache.org", "creation_time": "2009-12-01T16:33:25Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "text": "This has been fixed in 6.0.x and will be included in 6.0.21 onwards.", "attachment_id": null, "id": 132839, "creator": "markt@apache.org", "time": "2009-12-15T11:09:16Z", "bug_id": 47502, "creation_time": "2009-12-15T11:09:16Z", "is_private": false}]