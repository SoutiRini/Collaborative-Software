[{"count": 0, "tags": [], "bug_id": 56017, "text": "If I try to shiftrows that contains comments nad open excel document in Excel I get a popup warning Message \"Unreadable content...\" that says that comments were deleted.\n\nHow to reproduce:\nCreate new Excel 2007 Document, in first cell (A1) add comment (any text).\n\nRun code:\n\nFileInputStream inputStream = null;\nFileOutputStream outputStream = null;\nXSSFWorkbook book = null;\n\ntry {\n\tinputStream = new FileInputStream(\"c://1//Test.xlsx\");\n\tbook = new XSSFWorkbook(inputStream);\n\n\tXSSFSheet sheet = book.getSheetAt(0);\n\n\tsheet.shiftRows(0, 1, 1);\n\n\toutputStream = new FileOutputStream(\"c://1//Test.xlsx\");\n\tbook.write(outputStream);\n\toutputStream.close();\n\n}", "id": 172413, "time": "2014-01-16T10:04:58Z", "creator": "yevsjunk@gmail.com", "creation_time": "2014-01-16T10:04:58Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "yevsjunk@gmail.com", "attachment_id": 31215, "text": "Created attachment 31215\nTest file - before running the code", "id": 172414, "time": "2014-01-16T10:27:21Z", "bug_id": 56017, "creation_time": "2014-01-16T10:27:21Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 56017, "attachment_id": null, "id": 172857, "time": "2014-02-02T10:40:48Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2014-02-02T10:40:48Z", "is_private": false, "text": "I have added a test-case in r1563587 and r1563588 which runs this, I fixed a problem with comment-refs which only affected the in-memory state of comments, as I don't have a Windows-machine with Excel at hand to verify/reproduce the problem, so I am not sure if it is fixed in latest trunk or not..."}, {"count": 3, "tags": [], "bug_id": 56017, "attachment_id": null, "id": 172929, "time": "2014-02-06T18:49:46Z", "creator": "yevsjunk@gmail.com", "creation_time": "2014-02-06T18:49:46Z", "is_private": false, "text": "Thanks, I will test it latter.\nMeanwhile, I made some work around in shiftRows method  of XSSFSheet...\n\nAnyway, will the next POI release include the fix to the issue?"}, {"count": 4, "tags": [], "creator": "j.brauge@qualiac.com", "attachment_id": null, "text": "This bug persists in 3.10 final release and 3.11 dev.\nIs there a target release for a fix ?\nBest regards.", "id": 174791, "time": "2014-04-23T08:04:39Z", "bug_id": 56017, "creation_time": "2014-04-23T08:04:39Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 56017, "text": "In: org.apache.poi.xssf.usermodel.XSSFSheet\n\nI believe line:\n2451            if(rownum < startRow || rownum > endRow) continue;\n\nShould be above:\n2439            if(sheetComments != null){\n\n\nThe exception I was getting started here:\n2445                        ref = new CellReference(rownum + n, ref.getCol());\n\nLooks as though it's trying to update the comments table with the new cell references after the rows are shifted, but the iterator is over all rows and the check for the shifted range is after this block. Therefore, an attempt could be made for a negative row value. Fixed the issue for me anyway and hope it helps.", "id": 175645, "time": "2014-06-05T01:54:44Z", "creator": "danielyoung.private@gmail.com", "creation_time": "2014-06-05T01:54:44Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "creator": "danielyoung.private@gmail.com", "attachment_id": null, "text": "In: org.apache.poi.xssf.usermodel.XSSFSheet\n\nI believe line:\n2451            if(rownum < startRow || rownum > endRow) continue;\n\nShould be above:\n2439            if(sheetComments != null){\n\n\nThe exception I was getting started here:\n2445                        ref = new CellReference(rownum + n, ref.getCol());\n\nLooks as though it's trying to update the comments table with the new cell references after the rows are shifted, but the iterator is over all rows and the check for the shifted range is after this block. Therefore, an attempt could be made for a negative row value. I would assume if you do not get an exception the workbook may corrupt. Fixed the issue for me anyway and hope it helps.", "id": 175646, "time": "2014-06-05T01:58:30Z", "bug_id": 56017, "creation_time": "2014-06-05T01:58:30Z", "is_private": false}, {"text": "In the shiftRows method when it adjusts comments/rowheight it does all rows(!) in the current sheet. It doesn't always cause exception or error when opening xlsx, but always makes worse all of comments.\nFor example:\nif I call it: sheet.shiftRows(3, 4, 20, true, false);\nthen it shift all comments on 0, 1, and 2 rows too instead of leave in peace.\n\nIt's a simply, but annoying bug. Please fix it asap!", "tags": [], "creator": "mandm.ss@gmail.com", "attachment_id": null, "count": 7, "id": 178546, "time": "2014-10-17T14:35:47Z", "bug_id": 56017, "creation_time": "2014-10-17T14:35:47Z", "is_private": false}, {"count": 8, "tags": [], "creator": "merlusha@gmail.com", "attachment_id": 32431, "text": "Created attachment 32431\nBroken excel 2010 file", "id": 180751, "time": "2015-02-04T13:44:39Z", "bug_id": 56017, "creation_time": "2015-02-04T13:44:39Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 56017, "attachment_id": null, "id": 180753, "time": "2015-02-04T14:51:50Z", "creator": "merlusha@gmail.com", "creation_time": "2015-02-04T14:51:50Z", "is_private": false, "text": "I was able to reproduce this bug with Excel 2010. (poi 3.11 Final)\nMy further investigation shows that problem lies in following code:\n\nXSSFSheet.java:2567\n\nif(sheetComments != null){\n                //TODO shift Note's anchor in the associated /xl/drawing/vmlDrawings#.vml\n                CTCommentList lst = sheetComments.getCTComments().getCommentList();\n                for (CTComment comment : lst.getCommentArray()) {\n                    String oldRef = comment.getRef();\n                    CellReference ref = new CellReference(oldRef);\n                    if(ref.getRow() == rownum){\n                        ref = new CellReference(rownum + n, ref.getCol());\n                        comment.setRef(ref.formatAsString());\n                        sheetComments.referenceUpdated(oldRef, comment);\n                    }\n                }\n            }\nI looked at /xl/drawing/vmlDrawings#.vml and note's anchor was not shifted.\nSo I updated this file manually and was able to open excel file without problem.\nCan somebody implement this TODO??"}, {"count": 10, "tags": [], "bug_id": 56017, "text": "I believe we should add above:\nif(sheetComments != null){\n\n  if(n>0 & rownum < startRow)  continue;\n  if(n<0 & rownum < startRow+n) continue;\n\nThis solves problem only if comments are above shifted rows.\nHowever if comments are below shifted rows the problem is present.\nCellReference for all comments which are below shifted rows are set up to the last row.\nAttached you can find patch with included fix for\ncomments which are above shifted rows.", "id": 181296, "time": "2015-02-24T14:20:13Z", "creator": "merlusha@gmail.com", "creation_time": "2015-02-24T14:20:13Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "creator": "merlusha@gmail.com", "attachment_id": 32517, "text": "Created attachment 32517\nProposed patch for comments above shifted rows", "id": 181297, "time": "2015-02-24T14:21:35Z", "bug_id": 56017, "creation_time": "2015-02-24T14:21:35Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 56017, "attachment_id": null, "id": 181787, "time": "2015-03-15T20:56:09Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2015-03-15T20:56:09Z", "is_private": false, "text": "I gave this a try and ended up changing the implementation of XSSFSheet.shiftRows() quite a bit, see r1666843. \n\nThe current code did not handle a few things well, e.g. removing comments in overwritten rows and cases where comments are moved around. Moving the comments while still iterating caused cases where comments where moved multiple times, messing up things.\n\nAlso XSSFComment.setRow() was prone to a xmlbeans bug when resetting row-nunmbers. \n\nA few new test-cases now verify the most common cases, please report new bugs with sample code if there are still cases that are handled incorrectly."}]