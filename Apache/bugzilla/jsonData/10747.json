[{"count": 0, "tags": [], "creator": "ast@domdv.de", "attachment_id": null, "id": 19426, "time": "2002-07-12T16:50:28Z", "bug_id": 10747, "creation_time": "2002-07-12T16:50:28Z", "is_private": false, "text": "mod_proxy issues the SIZE command for ftp transfers to determine the size\nof the object to be transferred and sends this as the Content-Length to the\nclient. Unfortunately 'smart' ftp servers use the current transfer type\nto determine the file size. In case of the default type which is ASCII after\nlogin these servers include a LF to CRLF conversion in the length \ncalculation.\nThe result is a hanging transfer as the amount of bytes advertised in the\nContent-Length header is larger than the amount of bytes delivered by the\nftp server.\n\nExample with a command line ftp client:\n\n$ runsocks ftp ftp.hu-berlin.de\nConnected to vinus.rz.hu-berlin.de.\n220-===========================================================================\n220-               Welcome to the Humboldt-University of Berlin\n220-                             ftp.hu-berlin.de\n220-===========================================================================\n220-\n220 ftp.hu-berlin.de FTP server ready.\nName (ftp.hu-berlin.de:ast): ftp\n331 Guest login ok, send your complete e-mail address as password.\nPassword:\n230-\n230-All logins and traffic are logged and analysed, if you\n230-do not accept this policy, do not log in!\n230-\n230-hello user at p5084739E.dip.t-dialin.net\n230-local time is Fri Jul 12 17:52:31 2002\n230-session number 95 in this class\n230-current session limit 120\n230-\n230-contact: ftpadm@rz.hu-berlin.de\n230-\n230 Guest login ok, access restrictions apply.\nRemote system type is UNIX.\nUsing binary mode to transfer files.\nftp> quote SIZE \n/pub/www/opera/linux/602/final/en/qt_shared/opera-6.02-20020701.2-shared-qt.i386.tar.bz2\n213 2824953\nftp> bin\n200 Type set to I.\nftp> quote SIZE \n/pub/www/opera/linux/602/final/en/qt_shared/opera-6.02-20020701.2-shared-qt.i386.tar.bz2\n213 2814231\nftp> bye\n221-You have transferred 0 bytes in 0 files.\n221-Total traffic for this session was 1057 bytes in 0 transfers.\n221-Thank you for using the FTP service on ftp.hu-berlin.de.\n221 Goodbye.\n$\n\nThus mod_proxy must set the transfer type prior to issuing of the SIZE\ncommand to assert, that the SIZE command returns the proper object size.\nThe following one line patch asserts this:\n\n--- proxy_ftp.c.orig    Fri Jul 12 18:19:04 2002\n+++ proxy_ftp.c Fri Jul 12 18:22:50 2002\n@@ -1072,6 +1072,7 @@\n         get_dirlisting = 1;\n     }\n     else {\n+        ftp_set_TYPE(r, ctrl, xfer_type);\n         ap_bvputs(ctrl, \"SIZE \", path, CRLF, NULL);\n         ap_bflush(ctrl);\n         ap_log_error(APLOG_MARK, APLOG_DEBUG | APLOG_NOERRNO, r->server, \n\"FTP: SIZE %s\", path);"}, {"count": 1, "tags": [], "bug_id": 10747, "text": "If this logic is still true, it remains an issue.", "id": 145326, "time": "2011-03-27T18:00:09Z", "creator": "wrowe@apache.org", "creation_time": "2011-03-27T18:00:09Z", "is_private": false, "attachment_id": null}]