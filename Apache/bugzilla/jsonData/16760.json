[{"count": 0, "tags": [], "bug_id": 16760, "text": "The usage of a wrapped response which is derived from \nHttpServletResponseWrapper is no longer possible with Tomcat 4.1.18. In Tomcat \n4.1.12 however, the following coding works fine:\n\n// -- Response wrapper class\nclass ResponseWrapper extends HttpServletResponseWrapper {\n  private PrintWriter printWriter;\n  private ReplaceContentOutputStream outputStream;\n\n  public ResponseWrapper(HttpServletResponse response) throws IOException {\n    super(response);\n\n    this.outputStream = new ReplaceContentOutputStream(response.getOutputStream\n());\n    this.printWriter = new PrintWriter(this.outputStream);\n  }\n    \n  public ServletOutputStream getOutputStream() throws IOException {\n    return this.outputStream;\n  }\n\n  public PrintWriter getWriter() throws IOException {\n    return this.printWriter;\n  }\n}\n\n// -- Wrapped output stream\nclass ReplaceContentOutputStream extends ServletOutputStream {\n  private OutputStream outputStream;\n  private ByteArrayOutputStream byteArrayOutputStream;\n  private boolean closed = false;\n  private boolean transformOnCloseOnly = false;\n\n  public ReplaceContentOutputStream(OutputStream outputStream) {\n    this.outputStream = outputStream;\n    this.byteArrayOutputStream = new ByteArrayOutputStream();\n  }\n\n  public void write(int i) throws IOException {\n    this.byteArrayOutputStream.write(i);\n  }\n\n  public void close() throws IOException {\n    if (!closed) {\n      processStream();\n      this.outputStream.close();\n      closed = true;\n    }\n  }\n\n  public void flush() throws IOException {\n    if (this.byteArrayOutputStream.size() != 0) {\n      if (!this.transformOnCloseOnly) {\n        processStream();\n        this.byteArrayOutputStream = new ByteArrayOutputStream();\n      }\n    }\n  }\n\n  public byte[] replaceContent(byte[] bytes) throws IOException {\n    String newString = new String(bytes);\n    int replacePosition = newString.indexOf(\"<%placeholder%>\");\n\n    if (replacePosition != -1) {\n      newString = newString.substring(0, replacePosition) + \"replaced\" + \nnewString.substring(replacePosition + \"<%placeholder%>\".length());\n    }\n\n    return newString.getBytes();\n  }\n\n  public void processStream() throws IOException {\n    byte[] bytes = replaceContent(this.byteArrayOutputStream.toByteArray());\n    this.outputStream.write(bytes);\n  }\n\n  public void setTransformOnCloseOnly() {\n    this.transformOnCloseOnly = true;\n  }\n}\n\nThe filter itself is set up to process each request on *.jsp. When the wrapped \nresponse is passed in to the doFilter method, neither getServletOutputStream() \nnor getWriter() is called (extract from doFilter()):\n\n...\nResponseWrapper wrappedResponse = new ResponseWrapper(this.response);\nthis.filterChain.doFilter(this.request, wrappedResponse);\nwrappedResponse.getOutputStream().close();\n...\n\nThus, the wrapped response itself is entirely empty.", "id": 30657, "attachment_id": null, "creator": "bernd.krannich@gmx.de", "creation_time": "2003-02-04T15:06:35Z", "time": "2003-02-04T15:06:35Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 16760, "attachment_id": null, "is_private": false, "id": 30658, "time": "2003-02-04T15:12:34Z", "creator": "remm@apache.org", "creation_time": "2003-02-04T15:12:34Z", "text": "You have to use the container provided writer, or make sure you flush your\ncustom writer (and yes, Jasper's flushing behavior did change since 4.1.12)."}]