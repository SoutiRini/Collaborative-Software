[{"count": 0, "tags": [], "bug_id": 31567, "text": "I get 505 HTTP error when invoking soap request from .NET client.\nThis problem never apeared in 4.x Tomcat versions, I think it was introduced in\n5.x versions of Tomcat.\nI'm using Axis 1.1 on the server side.\n\nThe problem seems to apear when client makes second request with user credantials.\nOn the server basic authorization is set.\n\nBelow is a trace of soap a requests:\n\n******************** First request from client *********************************\nPOST /axis/services/Version HTTP/1.1\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; MS Web Services Client Protocol\n1.1.4322.573)\nContent-Type: text/xml; charset=utf-8\nSOAPAction: \"\"\nContent-Length: 545\nExpect: 100-continue\nConnection: Keep-Alive\nHost: 127.0.0.1\n\n<?xml version=\"1.0\" encoding=\"utf-8\"?><soap:Envelope\nxmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\"\nxmlns:soapenc=\"http://schemas.xmlsoap.org/soap/encoding/\"\nxmlns:tns=\"http://localhost:8081/axis/services/Version\"\nxmlns:types=\"http://localhost:8081/axis/services/Version/encodedTypes\"\nxmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\nxmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"><soap:Body\nsoap:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"><q1:getVersion\nxmlns:q1=\"http://axis.apache.org\" /></soap:Body></soap:Envelope>\n\n********************* Response from server after first request\n****************************\n\nHTTP/1.1 401 Unauthorized\nWWW-Authenticate: Basic realm=\"APS Webservices\"\nContent-Type: text/html;charset=utf-8\nContent-Length: 954\nDate: Wed, 06 Oct 2004 17:27:08 GMT\nServer: Apache-Coyote/1.1\n\n<html><head><title>Apache Tomcat/5.0.28 - Error report</title><style><!--H1\n{font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:22px;}\nH2\n{font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:16px;}\nH3\n{font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:14px;}\nBODY {font-family:Tahoma,Arial,sans-serif;color:black;background-color:white;} B\n{font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;} P\n{font-family:Tahoma,Arial,sans-serif;background:white;color:black;font-size:12px;}A\n{color : black;}A.name {color : black;}HR {color : #525D76;}--></style>\n</head><body><h1>HTTP Status 401 - </h1><HR size=\"1\"\nnoshade=\"noshade\"><p><b>type</b> Status report</p><p><b>message</b>\n<u></u></p><p><b>description</b> <u>This request requires HTTP authentication\n().</u></p><HR size=\"1\" noshade=\"noshade\"><h3>Apache\nTomcat/5.0.28</h3></body></html>\n\n****************** Second request from client with Authorization set\n********************\n\nPOST /axis/services/Version HTTP/1.1\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; MS Web Services Client Protocol\n1.1.4322.573)\nContent-Type: text/xml; charset=utf-8\nSOAPAction: \"\"\nAuthorization: Basic YXBzOnRlc3Q=\nContent-Length: 545\nExpect: 100-continue\nHost: localhost:8081\n\n<?xml version=\"1.0\" encoding=\"utf-8\"?><soap:Envelope\nxmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\"\nxmlns:soapenc=\"http://schemas.xmlsoap.org/soap/encoding/\"\nxmlns:tns=\"http://localhost:8081/axis/services/Version\"\nxmlns:types=\"http://localhost:8081/axis/services/Version/encodedTypes\"\nxmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\nxmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"><soap:Body\nsoap:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"><q1:getVersion\nxmlns:q1=\"http://axis.apache.org\" /></soap:Body></soap:Envelope>\n\n******************* Response from server after second request\n******************************\n\nHTTP/1.1 505 HTTP Version Not Supported\nDate: Wed, 06 Oct 2004 17:27:08 GMT\nServer: Apache-Coyote/1.1\nConnection: close", "id": 64706, "time": "2004-10-06T17:33:42Z", "creator": "pedrow@go2.pl", "creation_time": "2004-10-06T17:33:42Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 31567, "attachment_id": null, "text": "- Capture the exact request bytes\n- Open a telnet 127.0.0.1 8080 (with the default config)\n- Send the bytes\nIf it still breaks, attach the said bytes to the bug report as a file, so that I\ncan reproduce it.\n\nMy understanding of the issue is that this your client is broken: it requires an\nexpectation, which is not fulfilled (401), but sends the request body anyway\n(lol). Tomcat will use your request body as the first line of the next request,\nand then of course send a 505.\n\nSolution if my theory is correct: add the user-agent as a restricted user agent\nso that keep alive isn't used (or disable keep alive).", "id": 64709, "time": "2004-10-06T18:00:51Z", "creator": "remm@apache.org", "creation_time": "2004-10-06T18:00:51Z", "is_private": false}, {"count": 2, "tags": [], "creator": "pedrow@go2.pl", "attachment_id": null, "id": 64736, "time": "2004-10-07T10:18:24Z", "bug_id": 31567, "creation_time": "2004-10-07T10:18:24Z", "is_private": false, "text": "I found out that the problem is with first request from .NET soap client.\nAfter this first request following ones are okay because they don't contain\nfirst part which doesn't have user credantials. I never had this problem with\nsame client but with Tomcats 4.x.\n\nFirst shot contains actually two requests this is the trace of those requests:\n\nPOST /axis/services/Version HTTP/1.1\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; MS Web Services Client Protocol\n1.1.4322.573)\nContent-Type: text/xml; charset=utf-8\nSOAPAction: \"\"\nContent-Length: 545\nExpect: 100-continue\nConnection: Keep-Alive\nHost: 127.0.0.1\n\n<?xml version=\"1.0\" encoding=\"utf-8\"?><soap:Envelope\nxmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\"\nxmlns:soapenc=\"http://schemas.xmlsoap.org/soap/encoding/\"\nxmlns:tns=\"http://127.0.0.1:8081/axis/services/Version\"\nxmlns:types=\"http://127.0.0.1:8081/axis/services/Version/encodedTypes\"\nxmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\nxmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"><soap:Body\nsoap:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"><q1:getVersion\nxmlns:q1=\"http://axis.apache.org\" /></soap:Body></soap:Envelope>POST\n/axis/services/Version HTTP/1.1\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; MS Web Services Client Protocol\n1.1.4322.573)\nContent-Type: text/xml; charset=utf-8\nSOAPAction: \"\"\nAuthorization: Basic YXBzOnRlc3Q=\nContent-Length: 545\nExpect: 100-continue\nHost: 127.0.0.1:8081\n\n<?xml version=\"1.0\" encoding=\"utf-8\"?><soap:Envelope\nxmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\"\nxmlns:soapenc=\"http://schemas.xmlsoap.org/soap/encoding/\"\nxmlns:tns=\"http://127.0.0.1:8081/axis/services/Version\"\nxmlns:types=\"http://127.0.0.1:8081/axis/services/Version/encodedTypes\"\nxmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\nxmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"><soap:Body\nsoap:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"><q1:getVersion\nxmlns:q1=\"http://axis.apache.org\" /></soap:Body></soap:Envelope>\n\n\n\n*** Below is trace of response from server that I get using telnet *********\n\n\n\nHTTP/1.1 401 Unauthorized\nWWW-Authenticate: Basic realm=\"APS Webservices\"\nContent-Type: text/html;charset=utf-8\nContent-Length: 954\nDate: Thu, 07 Oct 2004 09:07:08 GMT\nServer: Apache-Coyote/1.1\n\n<html><head><title>Apache Tomcat/5.0.28 - Error report</title><style><!--H1\n{font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:22px;}\nH2\n{font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:16px;}\nH3\n{font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:14px;}\nBODY {font-family:Tahoma,Arial,sans-serif;color:black;background-color:white;} B\n{font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;} P\n{font-family:Tahoma,Arial,sans-serif;background:white;color:black;font-size:12px;}A\n{color : black;}A.name {color : black;}HR {color : #525D76;}--></style>\n</head><body><h1>HTTP Status 401 - </h1><HR size=\"1\"\nnoshade=\"noshade\"><p><b>type</b> Status report</p><p><b>message</b>\n<u></u></p><p><b>description</b> <u>This request requires HTTP authentication\n().</u></p><HR size=\"1\" noshade=\"noshade\"><h3>Apache\nTomcat/5.0.28</h3></body></html>HTTP/1.1 505 HTTP Version Not Supported\nDate: Thu, 07 Oct 2004 09:07:08 GMT\nServer: Apache-Coyote/1.1\nConnection: close"}, {"count": 3, "tags": [], "bug_id": 31567, "attachment_id": null, "text": "I'm no expert at HTTP, but shouldn't Tomcat drop the TCP-connection after \nhaving sent the initial \"401 Unauthorized\"-resonse? \n\nThis would cause .NET to do its re-post (with included authorization data in \nthe HTTP Header) in a new TCP connection. \n\nIn other words Tomcat should not use keep alive after a 401 Unauthorized. I \nthink this is how IIS (and Tomcat 4.x i suspect) behaves. \n", "id": 67234, "time": "2004-11-19T16:52:11Z", "creator": "per.thornstrand@omxgroup.com", "creation_time": "2004-11-19T16:52:11Z", "is_private": false}, {"count": 4, "tags": [], "creator": "yoavs@computer.org", "is_private": false, "text": "Changing to a connector component.", "id": 67237, "time": "2004-11-19T16:58:42Z", "bug_id": 31567, "creation_time": "2004-11-19T16:58:42Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 31567, "text": "This is invalid, please do not reopen.", "id": 67239, "time": "2004-11-19T18:11:23Z", "creator": "remm@apache.org", "creation_time": "2004-11-19T18:11:23Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 31567, "text": "Sorry for reopening. \n\nShouldn't Tomcat somehow ignore the body of the first message? \n\nDoesn't the .NET Framework handle this correctly when it:\n1. Posts soap message \n2. Receives 401 Unauthorized\n3. Reposts and this time includes authorization data (since it was requested)\n\n", "id": 67322, "time": "2004-11-22T10:09:15Z", "creator": "per.thornstrand@omxgroup.com", "creation_time": "2004-11-22T10:09:15Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "creator": "remm@apache.org", "is_private": false, "text": "This report is invalid, please do not reopen it. The M$ client obviously misuses\nexpectations.\nThe solution is to either set this user-agent as restricted so that it uses\nHTTP/1.0, or to disable keep-alive.", "id": 67328, "time": "2004-11-22T12:25:40Z", "bug_id": 31567, "creation_time": "2004-11-22T12:25:40Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 31567, "text": "Can you please be more specific?  What is wrong with the requests from the\nclient?   I can't tell if you have issue with data on the original or second\nrequest.  \n\nThe client does not know that it will be challenged until it sends the original\nrequest and receives the 401.  Furthermore, the HTTP spec RFC 2616 Section\n10.4.2 states: - \"The client MAY repeat the request with a suitable\nAuthorization header field.\"  It does not indicate that the request should not\ncontain data.  \n\nIf you could point us to the specification that these requests violate that\nwould help a lot.", "id": 68864, "time": "2004-12-22T22:29:45Z", "creator": "wpoziombka@budweiser.com", "creation_time": "2004-12-22T22:29:45Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 31567, "attachment_id": null, "text": "One additional comment it almost seems that Tomcat is not honoring the\nContent-Length header.  If I read this correctly, you use the first line of the\nbody original request as the first line of the second request.  Shouldn't you\ndiscard the content specified by Content-Length.", "id": 68866, "time": "2004-12-22T22:35:48Z", "creator": "wpoziombka@budweiser.com", "creation_time": "2004-12-22T22:35:48Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 31567, "attachment_id": null, "text": "(In reply to comment #8)\n> Can you please be more specific?  What is wrong with the requests from the\n> client?   I can't tell if you have issue with data on the original or second\n> request.  \nThe orignal request. See RFC 2616 Section 8.2.3.\n\nAnd, like Remy has said many times, this is invalid, so please stop wasting \neverybody's time by reopening it.", "id": 68875, "time": "2004-12-22T23:12:32Z", "creator": "william.barker@wilshire.com", "creation_time": "2004-12-22T23:12:32Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 31567, "attachment_id": null, "text": "Sorry to waste your time.  Many thanks, this is the answer I was looking for. \nIt was not clear from the earlier responses.", "id": 68879, "time": "2004-12-22T23:38:10Z", "creator": "wpoziombka@budweiser.com", "creation_time": "2004-12-22T23:38:10Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 31567, "attachment_id": null, "text": "(In reply to comment #10)\n> > Can you please be more specific?  What is wrong with the requests from the\n> > client?   I can't tell if you have issue with data on the original or \nsecond\n> > request.  \n> The orignal request. See RFC 2616 Section 8.2.3.\n> And, like Remy has said many times, this is invalid, so please stop wasting \n> everybody's time by reopening it.\n\nHello folks,\n\n I'm having a problem similar to the piotr's one, but in a different context \nand concluded that the .net client does not have a bad behavior. Tomcat on the \nother side isn't behaving improperly, but could behave better. Here goes:\n\nOn section 8.2.3 it states that a client does not need to wait indefinitively \nfor a server to respond with an 100 Continue message before starting to send \nit's body content of a request with the expect header. The M$ does it, and I \nbelieve they do it for performance reasons (perhaps it's a: \"we ask if we can, \nbut let's starting sending while the response does not come back, we win time \nif the response is positive\") while the spec says that it's ok to do that \nbecause of the compatibility with older implementations of HTTP.\n\nIt also says that if the server starts to receive data from the client, he may \nommit the 100 continue response message. Plus, it also says that, when the \nserver refuses an request with the expect header, and already received data it \nMAY close the transport connection or it MAY to continue read and then discard \nthe rest of the request.\n\nSo, TOMCAT doesn't do either, but does half of the second MAY.\nNow, if 505 error occurs because of the data on input stream (the body of the \nprevious request) that is understood as a new request, I believe that the SPEC \nis not very clear about the issue and perhaps it should be more 'rule-\nenforcing'. In that case I believe that the server SHOULD close the transport \nconnection OR it SHOULD read all data AND then discard it.\n\nSince TOMCAT already reads it (i supose it is the origin of the 505 error), I \nbelieve it also should discard it. That would be great for me, since I \nwouldn't need to add a if-command in my code :)\n\nBest regards,\nMiguel Figueiredo\n", "id": 70468, "time": "2005-02-03T17:02:24Z", "creator": "mfigueiredo@maisis.pt", "creation_time": "2005-02-03T17:02:24Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 31567, "attachment_id": null, "id": 70470, "time": "2005-02-03T17:14:43Z", "creator": "remm@apache.org", "creation_time": "2005-02-03T17:14:43Z", "is_private": false, "text": "It is obviously implied that the client MUST (caps as per the spec) wait a\nreasonable amount of time (Tomcat will return the 401 response nearly\ninstantaneaously). If it does not, then there's absolutely no point in using\nexpectations, and they should just remove the header.\n\nThe spec is great and all, but there's little possibility to determine, if a\nclient announces an expectation but doesn't use it (which isn't explicitely\nforbidden), if more data is subsequent pipelined requests, or if it's the body\nwhich was incorrectly sent. I believe Tomcat's behavior is the intended one. If\nyou want the other behavior, you have one line of code to remove\n(inputBuffer.setSwallowInput(false); in Http11Processor), or add 401 as a\ndisconnect status code.\n\nTomcat reads the rest of the stream as the next request, so the last part of\nyour comment isn't accurate."}]