[{"attachment_id": null, "tags": [], "bug_id": 61353, "text": "It's possible to perform a buffer overflow in escape_sgml_chars for very short strings that contain mostly characters that require escaping because the temporary buffer allocation is not large enough.\n\n$ tclsh\n% package require rivetlib\n2.2.3\n% puts [::rivet::escape_sgml_chars \"&\"]\nalloc: invalid block: 0x80214f620: ef ef 3b\nAbort trap (core dumped)\n\n\nIn Rivet_EscapeSgmlCharsCmd, the following buffer allocation is done, however the worst case escapement will require 6 characters if the input string consisted of entirely double-quote characters.\n\nnewString = (char *)Tcl_Alloc( (unsigned)origLength * 3 + 1 );", "count": 0, "id": 200075, "time": "2017-07-27T15:41:23Z", "creator": "jlawson-apache@bovine.net", "creation_time": "2017-07-27T15:41:23Z", "is_private": false}, {"count": 1, "tags": [], "creator": "jlawson-apache@bovine.net", "attachment_id": null, "text": "This appears to still be an issue in Rivet 2.3.4", "id": 200076, "time": "2017-07-27T16:15:47Z", "bug_id": 61353, "creation_time": "2017-07-27T16:15:47Z", "is_private": false}, {"count": 2, "tags": [], "creator": "jlawson-apache@bovine.net", "attachment_id": null, "id": 200077, "time": "2017-07-27T16:20:15Z", "bug_id": 61353, "creation_time": "2017-07-27T16:20:15Z", "is_private": false, "text": "This was originally reported by Karl to the mailing list in December 2016 and reportedly fixed, however I don't see any changes to the offending Tcl_Alloc line in the Rivet 2.3.4 release:\n \nhttps://mail-archives.apache.org/mod_mbox/tcl-rivet-dev/201612.mbox/%3Cd2334aef-4c18-5824-d74d-fa8763180097@biol.unipr.it%3E"}, {"count": 3, "tags": [], "creator": "jlawson-apache@bovine.net", "attachment_id": null, "text": "It looks like this is the commit that was intended to fix this bug:\n\nsvn diff -c r1773063\n\nHowever that commit was to Rivet_EscapeStringCmd, not Rivet_EscapeSgmlCharsCmd.\n\nI think Rivet_EscapeStringCmd can safely stay at (origLength * 3 + 1), but Rivet_EscapeSgmlCharsCmd is the one that needs to be (origLength * 6 + 1).", "id": 200087, "time": "2017-07-28T01:12:09Z", "bug_id": 61353, "creation_time": "2017-07-28T01:12:09Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 61353, "attachment_id": 35186, "text": "Created attachment 35186\nchange allocation size on correct function", "id": 200088, "time": "2017-07-28T07:15:22Z", "creator": "jlawson-apache@bovine.net", "creation_time": "2017-07-28T07:15:22Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 61353, "attachment_id": null, "id": 200097, "time": "2017-07-28T09:08:26Z", "creator": "mxmanghi@apache.org", "creation_time": "2017-07-28T09:08:26Z", "is_private": false, "text": "Thank you Jeff, it's my fault. Karl pointed out the right function but I misread its name and patched the allocation in the other one. Having a patch for that like the one you provided has been very helpful\n\nthe patch is now in the repository, I will prepare a new release candidate tonight"}, {"attachment_id": null, "tags": [], "creator": "jlawson-apache@bovine.net", "text": "okay thanks, confirmed the diff made it into Rivet 2.3.4rc2", "count": 6, "id": 200101, "time": "2017-07-28T18:03:24Z", "bug_id": 61353, "creation_time": "2017-07-28T18:03:24Z", "is_private": false}]