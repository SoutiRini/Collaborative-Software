[{"count": 0, "text": "Created attachment 32959\njstack info\n\nJmeter hang when testing javasampler with num_threads>6000 , because HashMap.put() from multiple threads.\n\nAs the following\uff0cknowing the thread hang at HashMap.put();\nlook into the process's jstack info(full content attached)\uff1a\n\n\n2015-08-05 14:48:48\nFull thread dump OpenJDK (Taobao) 64-Bit Server VM (20.0-b12-internal mixed mode):\n\n\"Attach Listener\" daemon prio=10 tid=0x00007f078fd5a000 nid=0x4204 waiting on condition [0x0000000000000000]\n   java.lang.Thread.State: RUNNABLE\n\n\"\u7ebf??\u7ec4 1-2788\" prio=10 tid=0x00007f07e0111000 nid=0x5fad runnable [0x00007f079d99d000]\n   java.lang.Thread.State: RUNNABLE\n    at java.util.HashMap.put(HashMap.java:374)\n    at java.util.HashSet.add(HashSet.java:200)\n    at org.apache.jmeter.protocol.java.sampler.JavaSampler.createJavaClient(JavaSampler.java:227)\n    at org.apache.jmeter.protocol.java.sampler.JavaSampler.sample(JavaSampler.java:190)\n    at org.apache.jmeter.threads.JMeterThread.process_sampler(JMeterThread.java:431)\n    at org.apache.jmeter.threads.JMeterThread.run(JMeterThread.java:258)\n    at java.lang.Thread.run(Thread.java:662)\n\n\"pool-1-thread-1\" prio=10 tid=0x00007f0848a90800 nid=0x5c43 waiting on condition [0x00007f07ebca4000]\n   java.lang.Thread.State: TIMED_WAITING (sleeping)\n    at java.lang.Thread.sleep(Native Method)\n    at io.netty.util.HashedWheelTimer$Worker.waitForNextTick(HashedWheelTimer.java:461)\n    at io.netty.util.HashedWheelTimer$Worker.run(HashedWheelTimer.java:360)\n    at java.lang.Thread.run(Thread.java:662)\n\n\"\u7ebf\u7a0b\u7ec4 1-1847\" prio=10 tid=0x00007f083c96b800 nid=0x5b54 runnable [0x00007f07f9178000\n...", "bug_id": 58209, "attachment_id": 32959, "id": 184319, "time": "2015-08-05T07:11:23Z", "creator": "g7n3f@126.com", "creation_time": "2015-08-05T07:11:23Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 58209, "attachment_id": null, "text": "Invoking HashMap.put() from multiple threads casue jmeter hanging\n\nI think the solution is:\nchange java file \uff1asrc/protocol/java/org/apache/jmeter/protocol/java/sampler/JavaSampler.java    at line 60 \n\n   //private static final Set<JavaSampler> TEAR_DOWN_SET = new HashSet<JavaSampler>();\n    private static final Set<JavaSampler> TEAR_DOWN_SET =  Collections.newSetFromMap(new ConcurrentHashMap<JavaSampler,Boolean>());", "id": 184320, "time": "2015-08-05T07:25:18Z", "creator": "g7n3f@126.com", "creation_time": "2015-08-05T07:25:18Z", "is_private": false}, {"count": 2, "tags": [], "creator": "sebb@apache.org", "attachment_id": null, "id": 184421, "time": "2015-08-08T16:57:51Z", "bug_id": 58209, "creation_time": "2015-08-08T16:57:51Z", "is_private": false, "text": "Thanks very much for the report.\nThe fix has been applied and will be in the next release of JMeter\n\nURL: http://svn.apache.org/r1694819\nLog:\nJMeter hang when testing javasampler because HashMap.put() is called from multiple threads without sync.\nBugzilla Id: 58209\n\nModified:\n    jmeter/trunk/src/protocol/java/org/apache/jmeter/protocol/java/sampler/JavaSampler.java\n    jmeter/trunk/xdocs/changes.xml"}]