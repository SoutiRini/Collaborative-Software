[{"count": 0, "tags": [], "bug_id": 50589, "text": "I've been using Apache's mod_proxy module recently when I came across a bug.\n\nAddresses of the form:\nwww.zappos.com/donald-j-pliner-womens-boots~2\n\nwere being converted to\nwww.zappos.com/donald-j-pliner-womens-boots%7E2\n\nWhen the Zappos servers see a url with %7E in them it will respond\nwith an HTTP 301 Moved Permanently to the same url with a decoded ~.\nTshark dump follows:\n\nHypertext Transfer Protocol\n   HTTP/1.1 301 Moved Permanently\\r\\n\n       [Expert Info (Chat/Sequence): HTTP/1.1 301 Moved Permanently\\r\\n]\n           [Message: HTTP/1.1 301 Moved Permanently\\r\\n]\n           [Severity level: Chat]\n           [Group: Sequence]\n       Request Version: HTTP/1.1\n       Response Code: 301\n   Server: nginx/0.8.34\\r\\n\n   Content-Type: text/html\\r\\n\n   Content-Length: 185\\r\\n\n       [Content length: 185]\n   Location: /donald-j-pliner-womens-boots~2\\r\\n\n   X-Core-Value: 6. Build Open and Honest Relationships With Communication\\r\\n\n   X-Recruiting: If you're reading this, maybe you should be working\nat Zappos instead.  Check out jobs.zappos.com\\r\\n\n   Vary: Accept-Encoding\\r\\n\n   Date: Fri, 14 Jan 2011 00:33:56 GMT\\r\\n\n   Connection: close\\r\\n\n   \\r\\n\nLine-based text data: text/html\n   <html>\\r\\n\n   <head><title>301 Moved Permanently</title></head>\\r\\n\n   <body bgcolor=\"white\">\\r\\n\n   <center><h1>301 Moved Permanently</h1></center>\\r\\n\n   <hr><center>nginx/0.8.34</center>\\r\\n\n   </body>\\r\\n\n   </html>\\r\\n\n\n\nBecause mod_proxy will always escape ~ into %7E this will quickly lead\nto an infinite redirect loop (luckily most applications will get the\nhint quickly).\n\nI dug into why this is and came up with the following message:\nhttp://marc.info/?l=apache-bugdb&m=99926707930303&w=2\n\nDigging further I even found a commit to the Apache 2.2 branch:\nhttp://svn.apache.org/viewvc/httpd/httpd/branches/2.2.x/modules/proxy/proxy_util.c?view=log&pathrev=571456\n\nHowever, when I looked for a similar change in Apache 2.0.64 I notice\nit was not present\nhttp://svn.apache.org/viewvc/httpd/httpd/branches/2.0.x/modules/proxy/proxy_util.c?revision=563329&view=markup\nline 137\n\nI assume it just never got back-ported.\n\nI went to file a bug on the Apache website, but it suggested I ping\nthis mailing list first (http://httpd.apache.org/bug_report.html)\n\nWhile Zappos' redirection is non-standard, forcing the URLEncoding of\nthe tilde character is not in keeping with RFC 2396 which supersedes\nRFC 1738 and specifically states:\n\n2.3. Unreserved Characters\n\n  Data characters that are allowed in a URI but do not have a reserved\n  purpose are called unreserved.  These include upper and lower case\n  letters, decimal digits, and a limited set of punctuation marks and\n  symbols.\n\n     unreserved  = alphanum | mark\n\n     mark        = \"-\" | \"_\" | \".\" | \"!\" | \"~\" | \"*\" | \"'\" | \"(\" | \")\"\n\n  Unreserved characters can be escaped without changing the semantics\n  of the URI, but this should not be done unless the URI is being used\n  in a context that does not allow the unescaped character to appear.\n\nThere for, I would recommend a similar change to Apache 2.0.x's\nproxy_util.c in keeping with Apache 2.2.x's revision 571436.\n\nSpecifically, line 137, which reads:\n\n   allowed = \"$-_.+!*'(),;:@&=\";\n\nshould read:\n\n   allowed = \"~$-_.+!*'(),;:@&=\";", "id": 143350, "time": "2011-01-14T21:40:41Z", "creator": "tzenes@gmail.com", "creation_time": "2011-01-14T21:40:41Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "nick@webthing.com", "attachment_id": null, "is_private": false, "id": 143353, "time": "2011-01-15T06:56:49Z", "bug_id": 50589, "creation_time": "2011-01-15T06:56:49Z", "text": "There are a lot of issues with 2.0 mod_proxy.  The recommended solution is to upgrade to 2.2 or later.  Do you have a good reason to use 2.0?"}, {"count": 2, "tags": [], "bug_id": 50589, "attachment_id": null, "text": "(In reply to comment #1)\n> There are a lot of issues with 2.0 mod_proxy.  The recommended solution is to\n> upgrade to 2.2 or later.  Do you have a good reason to use 2.0?\n\n2.2 is incompatible with my code base without major rewriting\n\nFor the time being I've made the change to my copy of 2.0.64 and recompiled.\n\nSince this seems like a relatively minor fix I figured I would report it in case someone else has the same issue.\n\nIts rather frustrating to find that some sites completely break when using Apache as a reverse proxy.", "id": 143365, "time": "2011-01-15T21:52:20Z", "creator": "tzenes@gmail.com", "creation_time": "2011-01-15T21:52:20Z", "is_private": false}, {"count": 3, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "text": "resolving as WONTFIX to reflect the maintenance realities of 2.0, much less mod_proxy in 2.0.", "id": 148464, "time": "2011-08-07T16:19:55Z", "bug_id": 50589, "creation_time": "2011-08-07T16:19:55Z", "is_private": false}]