[{"attachment_id": null, "tags": [], "creator": "chip@force-elite.com", "is_private": false, "count": 0, "id": 90232, "time": "2006-06-15T05:23:14Z", "bug_id": 39815, "creation_time": "2006-06-15T05:23:14Z", "text": "mod_dav_fs currently writes a file to disk as it is created on disk.\n\nIt does not atomically create the file from the upload.  It is hard for external\nprocesses to tell when the upload is complete."}, {"count": 1, "tags": [], "bug_id": 39815, "text": "Created attachment 18472\nattempted fix for 2.2.x", "id": 90233, "time": "2006-06-15T05:23:54Z", "creator": "chip@force-elite.com", "creation_time": "2006-06-15T05:23:54Z", "is_private": false, "attachment_id": 18472}, {"count": 2, "tags": [], "bug_id": 39815, "attachment_id": null, "id": 90243, "time": "2006-06-15T11:58:30Z", "creator": "rooneg@electricjellyfish.net", "creation_time": "2006-06-15T11:58:30Z", "is_private": false, "text": "This looks reasonable to me, although I haven't actually tested it.  Only two\ncomments.\n\n1) The fpath variable could be const, and is declared with different spacing\naround the * than everything else in the file.\n\n2) You could move the declaration of fpath and rv into the blocks where they're\nused, although I'm not sure if that style is used in this code or not, so no big\ndeal."}, {"attachment_id": null, "tags": [], "creator": "jorton@redhat.com", "is_private": false, "count": 3, "id": 90244, "time": "2006-06-15T12:34:19Z", "bug_id": 39815, "creation_time": "2006-06-15T12:34:19Z", "text": "ISTR from Greg trying this before that it breaks locking (because the lock is\nkeyed off the inode); have you tried a litmus run with this?"}, {"count": 4, "tags": [], "bug_id": 39815, "attachment_id": null, "id": 125842, "time": "2009-03-27T06:27:06Z", "creator": "tiwoc@arcor.de", "creation_time": "2009-03-27T06:27:06Z", "is_private": false, "text": "(In reply to comment #3)\n> ISTR from Greg trying this before that it breaks locking (because the lock is\n> keyed off the inode); have you tried a litmus run with this?\n\nI tried litmus and got errors after applying the patch. In fact, locking does not work (first failed test: \"DELETE of locked resource should fail\"). I am looking into this issue now."}, {"count": 5, "tags": [], "bug_id": 39815, "attachment_id": null, "id": 127958, "time": "2009-06-16T04:39:14Z", "creator": "tiwoc@arcor.de", "creation_time": "2009-06-16T04:39:14Z", "is_private": false, "text": "I'm sorry, but I could not find a quick fix. Someone with a stronger experience in Apache programming (or more spare time available) may come up with a solution, though."}, {"count": 6, "tags": [], "bug_id": 39815, "text": "This bug can also cause data loss: When something goes wrong with a PUT request that replaces a file, the old file will be deleted.\n\n\nI see three possible solutions:\n\n1) Create a new hook that is called in dav_notify_created() to update the lock key. This breaks mod_dav's API compatibility and cannot be done in 2.2\n\n2) Use a temp file that is moved over the old file as in Paul's patch, and switch the lock key from inode to filename.\n\n3) Use a temp file that is copied over the old file. This is slow and doesn't solve the problem completely.\n\n\nI would vote for 2), in order to get this into 2.2.", "id": 128647, "time": "2009-07-08T13:51:25Z", "creator": "sf@sfritsch.de", "creation_time": "2009-07-08T13:51:25Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "creator": "sf@sfritsch.de", "attachment_id": 23956, "text": "Created attachment 23956\nalso disable inode keyed locks and cleanup the tempfile if something goes wrong\n\nSwitching to filenames in the lock keys is simple and fixes the litmus failures. Are there some numbers on what impact this has on performance?\n\nI have also added some code to remove the tmpfile when the new file is not committed.\n\nFor the case that a file is opened seekable and the file existed before, the file should probably not be deleted on error.", "id": 128733, "time": "2009-07-10T10:10:30Z", "bug_id": 39815, "creation_time": "2009-07-10T10:10:30Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 39815, "attachment_id": null, "text": "solution 2) commited to trunk as r834049", "id": 131816, "time": "2009-11-09T05:14:41Z", "creator": "sf@sfritsch.de", "creation_time": "2009-11-09T05:14:41Z", "is_private": false}, {"count": 9, "tags": [], "text": "fixed in 2.4.1", "is_private": false, "id": 154187, "creator": "sf@sfritsch.de", "time": "2012-02-26T16:40:49Z", "bug_id": 39815, "creation_time": "2012-02-26T16:40:49Z", "attachment_id": null}]