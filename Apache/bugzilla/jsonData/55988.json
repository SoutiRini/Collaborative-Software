[{"attachment_id": null, "tags": [], "bug_id": 55988, "text": "Starting with Oracle Java 1.8.0 B108, JSSE supports server-side cipher ordering [1]. Server-side cipher ordering is useful for enabling Forward Secrecy and for preventing certain attacks. Appropriate JSSE parameter is called useCipherSuitesOrder [2].\n\nIs it possible to add that same attribute to Tomcat JSSE connectors?\n\nThe problem is that parameter useCipherSuitesOrder is only available starting with Java 1.8 B108, while Tomcat 8 requires only Java 1.7. Therefore the proposal is, if Tomcat 8:\n\n(a) runs using Java 1.7 / 1.8 pre-B108, parameter useCipherSuitesOrder would be ignored, and if \n(b) runs using Java 1.8 B108+, JSSE parameter useCipherSuitesOrder would be appropriately set.\n\nIt might be a precedence to support parameter from non-required version of Java, albeit -- due to the usefulness of such configuration option -- it might be worthwhile considering.\n\nNote that similar attribute already exists for APR connector -- SSLHonorCipherOrder.\n\n-Ognjen\n\n[1] https://bugs.openjdk.java.net/browse/JDK-7188657\n[2] http://download.java.net/jdk8/docs/api/javax/net/ssl/SSLParameters.html#setUseCipherSuitesOrder-boolean-", "count": 0, "id": 172282, "time": "2014-01-11T14:45:34Z", "creator": "ognjen.d.blagojevic@gmail.com", "creation_time": "2014-01-11T14:45:34Z", "is_private": false}, {"count": 1, "tags": [], "creator": "ognjen.d.blagojevic@gmail.com", "attachment_id": 31198, "id": 172283, "time": "2014-01-11T16:43:11Z", "bug_id": 55988, "creation_time": "2014-01-11T16:43:11Z", "is_private": false, "text": "Created attachment 31198\nProof of concept patch\n\nHere is initial patch to prove the concept. This patch will always try to set parameter useCipherSuitesOrder using reflection.\n\nTo test it:\n\n(1) Install JDK 1.8.0 EA (must be B108+, tested with B121) [1]\n(2) Install Java 7 JCE Unlimited Strength (it also works with JDK 1.8.0 EA) [2]\n(3) Apply patch, build Tomcat\n(4) Add JSSE Connector configuration to server.xml:\n\n    <Connector port=\"443\" \n               protocol=\"org.apache.coyote.http11.Http11Protocol\"\n               SSLEnabled=\"true\"\n               maxThreads=\"150\" \n               scheme=\"https\" \n               secure=\"true\"\n               clientAuth=\"false\" \n               sslProtocol=\"TLS\" \n               ciphers=\"TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384,\n                        TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,\n                        TLS_DHE_RSA_WITH_AES_256_CBC_SHA,\n                        TLS_DHE_RSA_WITH_AES_128_CBC_SHA,\n                        TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA,\n                        TLS_RSA_WITH_AES_256_CBC_SHA256,\n                        TLS_RSA_WITH_AES_256_CBC_SHA,\n                        SSL_RSA_WITH_3DES_EDE_CBC_SHA\" />\n\n(5) Start Tomcat. Forward Secrecy is enabled (on all clients that support it)\n\n-Ognjen\n\n[1] https://jdk8.java.net/download.html\n[2] http://www.oracle.com/technetwork/java/javase/downloads/jce-7-download-432124.html"}, {"count": 2, "tags": [], "creator": "ognjen.d.blagojevic@gmail.com", "attachment_id": 31272, "id": 172808, "time": "2014-01-30T12:20:23Z", "bug_id": 55988, "creation_time": "2014-01-30T12:20:23Z", "is_private": false, "text": "Created attachment 31272\nPatch to add useCipherSuitesOrder to BIO and NIO connectors\n\nFully functional patch. Here is an example how to use it for BIO (with OpenJDK 1.8.0 B108+ and JCE Unlimited Strength):\n\n    <Connector port=\"443\" \n               protocol=\"org.apache.coyote.http11.Http11Protocol\"\n               SSLEnabled=\"true\"\n               maxThreads=\"150\" scheme=\"https\" secure=\"true\"\n               clientAuth=\"false\" sslProtocol=\"TLS\" \n               useCipherSuitesOrder=\"true\"\n               ciphers=\"TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384,\n                        TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,\n                        TLS_DHE_RSA_WITH_AES_256_CBC_SHA,\n                        TLS_DHE_RSA_WITH_AES_128_CBC_SHA,\n                        SSL_RSA_WITH_3DES_EDE_CBC_SHA\" />\n\n\nTo test NIO, just replace Http11Protocol with Http11NioProtocol.\n\n---\n\nYou may test Forward Secrecy using \n\n  https://www.ssllabs.com/ssltest/\n\nIt should report \"Forward Secrecy -- Yes (with most browsers)\"\n\n---\n\nNote: If you try the same with JDK that does not support javax.net.SSLParameters.setUseCipherSuitesOrder(boolean) method, it will log:\n\nWARNING [main] org.apache.tomcat.util.net.jsse.JSSESocketFactory.configureUseCipherSuitesOrder Method setUseCipherSuitesOrder is not supported by the SSL engine"}, {"count": 3, "text": "APR connector has the \"SSLHonorCipherOrder\" attribute. Tomcat has a history of using different SSL-configuration attributes for APR versus other connector types. I would, however, prefer to make the configuration option more clear to the user like \"useServerCipherSuitesOrder\"... as it stands, the option doesn't really make it clear that the server is in control.\n\nAny objections?", "creator": "chris@christopherschultz.net", "is_private": false, "id": 172816, "time": "2014-01-30T16:42:47Z", "bug_id": 55988, "creation_time": "2014-01-30T16:42:47Z", "tags": [], "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 55988, "attachment_id": null, "text": "(In reply to Christopher Schultz from comment #3)\n> I would, however, prefer to make the configuration option\n> more clear to the user like \"useServerCipherSuitesOrder\"... as it stands,\n> the option doesn't really make it clear that the server is in control.\n> \n> Any objections?\n\nNo objections. Do I need to provide a new patch with the name you proposed?", "id": 172818, "time": "2014-01-30T22:15:40Z", "creator": "ognjen.d.blagojevic@gmail.com", "creation_time": "2014-01-30T22:15:40Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 55988, "attachment_id": null, "text": "Not necessary.", "id": 172819, "time": "2014-01-31T01:27:20Z", "creator": "chris@christopherschultz.net", "creation_time": "2014-01-31T01:27:20Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 55988, "attachment_id": null, "id": 174067, "time": "2014-03-25T13:17:48Z", "creator": "ognjen.d.blagojevic@gmail.com", "creation_time": "2014-03-25T13:17:48Z", "is_private": false, "text": "Just a gentle reminder. If you have some free time to review the patch, it would be great."}, {"attachment_id": null, "tags": [], "creator": "remm@apache.org", "is_private": false, "count": 7, "id": 174069, "time": "2014-03-25T13:45:07Z", "bug_id": 55988, "creation_time": "2014-03-25T13:45:07Z", "text": "Ok, since you asked for it, here's a review:\n- I don't think this feature justifies a big blob of ugly code, so this should wait for Java 8.\n- Regardless of what APR may or may not do, it should be a boolean for the Java connectors, not a String."}, {"count": 8, "tags": [], "bug_id": 55988, "attachment_id": null, "text": "(In reply to Remy Maucherat from comment #7)\n> Ok, since you asked for it, here's a review:\n> - I don't think this feature justifies a big blob of ugly code, so this\n> should wait for Java 8.\n\nI'm not sure I'd call this a big ball of ugly code. The only thing that makes it ugly is the fact that we can't have a compilation dependency on Java 8 -- which is where this feature is actually implemented.\n\n> - Regardless of what APR may or may not do, it should be a boolean for the\n> Java connectors, not a String.\n\nWhile the class member is a String, it's treated as a boolean. Ognjen was simply following precedent set for example by \"clientAuth\".", "id": 174070, "time": "2014-03-25T15:05:57Z", "creator": "chris@christopherschultz.net", "creation_time": "2014-03-25T15:05:57Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 55988, "text": "Yes, the reflection code is ugly by design, it's not like it could look better (although maybe it could use introspection util ?), but the logging shouldn't be there (if some Java 8 features are to be used, there should be a static Java 8 flag somewhere that would avoid trying the reflection). About the \"String\" this is because the attributes are set using the introspection utils reflection, so that looks ok actually [= like the rest].\n\nI still don't see why this should be added right now, the Java 8 support doesn't look good overall.", "count": 9, "id": 174072, "time": "2014-03-25T15:41:40Z", "creator": "remm@apache.org", "creation_time": "2014-03-25T15:41:40Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 55988, "attachment_id": null, "text": "(In reply to Remy Maucherat from comment #9)\n> I still don't see why this should be added right now, the Java 8 support\n> doesn't look good overall.\n\nBecause:\n\na. is is a useful security feature, and as such it should be subject of consideration even if the small number of users may benefit from it, and\n\nb. Oracle Java 1.8.0 is released a week ago, so its adoption is only going to increase, not shrink.", "id": 174091, "time": "2014-03-26T00:36:17Z", "creator": "ognjen.d.blagojevic@gmail.com", "creation_time": "2014-03-26T00:36:17Z", "is_private": false}, {"count": 11, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "id": 175472, "time": "2014-05-26T18:24:20Z", "bug_id": 55988, "creation_time": "2014-05-26T18:24:20Z", "is_private": false, "text": "Ognjen, I have a couple of further comments about your proposed patch. I'm leaning towards adding this to Tomcat 8 but not back-porting unless there is significant demand.\n\n1. Most of the 2 configureUseCipherSuitesOrder methods is the same. Consider re-factoring the bulk of that method into a superclass utility method and then extract the SSLParameters object from either SSLEngine or Socket in the subclasses.\n\n2. Since this is a security-related configuration, consider failing totally when server-side ordering is requested but can't be enforced -- e.g. the reflection fails for any reason. You have it logging a warning but continuing which I think isn't appropriate in this case."}, {"count": 12, "tags": [], "bug_id": 55988, "attachment_id": null, "id": 175473, "time": "2014-05-26T18:26:22Z", "creator": "chris@christopherschultz.net", "creation_time": "2014-05-26T18:26:22Z", "is_private": false, "text": "(In reply to Ognjen Blagojevic from comment #4)\n> No objections. Do I need to provide a new patch with the name you proposed?\n\nIf you like my suggestions above, you could make all 3 changes at once and propose a new patch. That would be nice ;)"}, {"attachment_id": null, "tags": [], "bug_id": 55988, "text": "getting as many clients to choose a forward-secret cipher even if their makers didn't think of putting forward-secret ciphers highest priority is important in today's world of massive eaves-dropping.\n\nPlease implement this feature also for non-APR connectors A.S.A.P. - I think it is even worthwhile to backport to Tomcat 7!", "count": 13, "id": 180609, "time": "2015-01-28T07:18:19Z", "creator": "hauser@acm.org", "creation_time": "2015-01-28T07:18:19Z", "is_private": false}, {"count": 14, "text": "Ognjen, if you are still willing to produce a patch, consider writing it against trunk, which will require Java 8 so won't need the reflection. If we decide to back-port to Tomcat 8, the reflection can be re-introduced.\n\nAre you still able to update the patch?\n\n(In reply to Ralf Hauser from comment #13)\n> Please implement this feature also for non-APR connectors A.S.A.P. - I think\n> it is even worthwhile to backport to Tomcat 7!\n\nThis enhancement request is specifically targeted towards the non-APR connectors. The APR connector already supports this capability via the SSLHonorCipherOrder setting.", "bug_id": 55988, "is_private": false, "id": 180622, "time": "2015-01-28T14:49:16Z", "creator": "chris@christopherschultz.net", "creation_time": "2015-01-28T14:49:16Z", "tags": [], "attachment_id": null}, {"count": 15, "text": "Chris,\n\n(In reply to Christopher Schultz from comment #14)\n> Ognjen, if you are still willing to produce a patch, consider writing it\n> against trunk, which will require Java 8 so won't need the reflection. If we\n> decide to back-port to Tomcat 8, the reflection can be re-introduced.\n\nOk. I will attach patch for Tomcat 9. As you suggested:\n\n1. Parameter name is useServerCipherSuitesOrder insted of useCipherSuitesOrder.\n2. Code is deduplicated / moved to superclass.\n\nTo test it:\n\n(1) Install JDK 1.8.0\n(2) Install Java 8 JCE Unlimited Strength\n(3) Apply patch, build Tomcat\n(4) Add JSSE Connector configuration to server.xml:\n\n    <Connector port=\"443\" \n               protocol=\"org.apache.coyote.http11.Http11NioProtocol\"\n               SSLEnabled=\"true\"\n               maxThreads=\"150\" \n               scheme=\"https\" \n               secure=\"true\"\n               clientAuth=\"false\" \n               sslProtocol=\"TLS\" \n               useServerCipherSuitesOrder=\"true\"\n               ciphers=\"TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384,   \n                        TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,      \n                        TLS_DHE_RSA_WITH_AES_256_CBC_SHA,        \n                        TLS_DHE_RSA_WITH_AES_128_CBC_SHA,        \n                        SSL_RSA_WITH_3DES_EDE_CBC_SHA\" \n />\n\n(5) Start Tomcat. Forward Secrecy is enabled (on all clients that support it)\n\nTo test with NIO2, just replace Http11NioProtocol with Http11Nio2Protocol.\n\n-Ognjen", "bug_id": 55988, "is_private": false, "id": 180631, "time": "2015-01-29T00:50:14Z", "creator": "ognjen.d.blagojevic@gmail.com", "creation_time": "2015-01-29T00:50:14Z", "tags": [], "attachment_id": null}, {"count": 16, "tags": [], "bug_id": 55988, "attachment_id": 32407, "text": "Created attachment 32407\nPatch to add useServerCipherSuitesOrder to NIO and NIO2 connectors", "id": 180632, "time": "2015-01-29T00:52:05Z", "creator": "ognjen.d.blagojevic@gmail.com", "creation_time": "2015-01-29T00:52:05Z", "is_private": false}, {"count": 17, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "id": 181361, "time": "2015-02-27T01:38:47Z", "bug_id": 55988, "creation_time": "2015-02-27T01:38:47Z", "is_private": false, "text": "Fixed in trunk in r1662614.\n\nI'll start preparing a patch for Tomcat 8."}, {"attachment_id": null, "tags": [], "creator": "chris@christopherschultz.net", "is_private": false, "count": 18, "id": 181362, "time": "2015-02-27T02:50:01Z", "bug_id": 55988, "creation_time": "2015-02-27T02:50:01Z", "text": "Fixed in Tomcat 8.0.x in r1662627.\nWill be in Tomcat 8.0.21."}, {"count": 19, "text": "Support for BIO connector added in Tomcat 8.0.x in r1662632.", "creator": "chris@christopherschultz.net", "is_private": false, "id": 181363, "time": "2015-02-27T04:06:13Z", "bug_id": 55988, "creation_time": "2015-02-27T04:06:13Z", "tags": [], "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "chris@christopherschultz.net", "is_private": false, "count": 20, "id": 181364, "time": "2015-02-27T04:14:56Z", "bug_id": 55988, "creation_time": "2015-02-27T04:14:56Z", "text": "Fixed in Tomcat 7.0.x in r1662633.\nWill be in Tomcat 7.0.60."}, {"count": 21, "tags": [], "creator": "ognjen.d.blagojevic@gmail.com", "attachment_id": null, "id": 182133, "time": "2015-03-26T23:01:09Z", "bug_id": 55988, "creation_time": "2015-03-26T23:01:09Z", "is_private": false, "text": "Refactoring in r1662994 broke the support for 7.0.x. It introduced several issues:\n\n1. Inverted if condition in AbstractEndpoint.testServerCipherSuitesOrderSupport (fixed in r1669346).\n\n\n2. Steps in AbstractEndpoint.configureUseServerCipherSuitesOrder:\n\n  (a) SSLParameters sslParameters = engine.getSSLParameters();\n  (b) sslParameters.setUseCipherSuitesOrder(boolean)\n  (c) engine.setSSLParamters(sllParameters)\n\nwere refactored omitting step (c).\n\n\n3. Steps in JSSESocketFactory.configureUseServerCipherSuitesOrder:\n\n  (a) SSLParameters sslParameters = socket.getSSLParameters();\n  (b) sslParameters.setUseCipherSuitesOrder(boolean)\n  (c) socket.setSSLParamters(sllParameters)\n\nwere refactored omitting step (c).\n\nI'm preparing the patch for issues 2. and 3.\n\n-Ognjen"}, {"count": 22, "tags": [], "bug_id": 55988, "attachment_id": 32611, "text": "Created attachment 32611\nPatch to add setters for SSLParameters", "id": 182134, "time": "2015-03-26T23:09:19Z", "creator": "ognjen.d.blagojevic@gmail.com", "creation_time": "2015-03-26T23:09:19Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 55988, "text": "Thanks for the patch.\nThe fix will be available for 7.0.61 onwards.", "count": 23, "id": 182137, "time": "2015-03-27T07:50:10Z", "creator": "violetagg@apache.org", "creation_time": "2015-03-27T07:50:10Z", "is_private": false}, {"count": 24, "tags": [], "creator": "ognjen.d.blagojevic@gmail.com", "attachment_id": null, "id": 182159, "time": "2015-03-27T20:12:49Z", "bug_id": 55988, "creation_time": "2015-03-27T20:12:49Z", "is_private": false, "text": "7.0.61 works as expected. Thank you."}, {"count": 25, "tags": [], "bug_id": 55988, "attachment_id": null, "text": "see also bug 53481 for SSLHonorCipherOrder (alias for the honorCipherOrder) as per http://tomcat.apache.org/tomcat-9.0-doc/config/http.html#SSL_Support_-_SSLHostConfig\n\nsomehow with the current debian stable (tomcat 8.0.14)\n\nhttps://www.ssllabs.com/ssltest/analyze.html?d=www.privasphere.com&hideResults=on \n\nstill claims \"Cipher Suites (sorted by strength as the server has no preference...\"", "id": 191948, "time": "2016-06-25T13:45:07Z", "creator": "hauser@acm.org", "creation_time": "2016-06-25T13:45:07Z", "is_private": false}]