[{"count": 0, "tags": [], "creator": "dtn-asfbugs@corefiling.co.uk", "attachment_id": null, "id": 174162, "time": "2014-03-28T16:28:27Z", "bug_id": 56328, "creation_time": "2014-03-28T16:28:27Z", "is_private": false, "text": "Summary: FormulaParser is hard-coded to assume a maximum of 65536 rows\n\nUnfortunately, this means that formulae attempting to reference rows at larger numbers (possible in Excel 2007 and greater) will not parse, failing with \n\norg.apache.poi.ss.formula.FormulaParseException: Cell reference expected after sheet name at index ...\n\nThe fix is to change the constant on line 722, which currently looks like:\n\nif (i<1 || i>65536) {\n\nA review for other hard-coding of 65536 might be an idea at this point too. I can see it in several other parts of the codebase including AreaRange."}, {"count": 1, "tags": [], "creator": "apache@gagravarr.org", "text": "Any chance you could both:\n * Grep to find some more places with that in? (Check org.apache.poi.ss and .xssf, it's fine to have it in .hssf classes)\n * See if you can work up a patch which checks the kind of workbook it is, and does the range check based on that? (We've got the constants in SpreadsheetVersion)\n\nBonus marks if you can get it done before the CoreFiling Friday pub trip time ;-)", "id": 174163, "time": "2014-03-28T17:00:39Z", "bug_id": 56328, "creation_time": "2014-03-28T17:00:39Z", "is_private": false, "attachment_id": null}, {"count": 2, "attachment_id": 31456, "bug_id": 56328, "is_private": false, "id": 174164, "time": "2014-03-28T17:46:22Z", "creator": "dtn-asfbugs@corefiling.co.uk", "creation_time": "2014-03-28T17:46:22Z", "tags": [], "text": "Created attachment 31456\nPatch to fix FormulaParser using SpreadsheetVersion\n\nProblematic references:\n\n./org/apache/poi/ss/formula/FormulaParser.java:\t\t\tif (i<1 || i>65536) {\n\n./org/apache/poi/ss/util/AreaReference.java:            // Represented internally as x$1 to x$65536\n./org/apache/poi/ss/util/AreaReference.java:        return new AreaReference(start + \"$1:\" + end + \"$65536\");\n\nThe attached patch fixes FormulaParser, which turned out to be trivial as there's already a SpreadsheetVersion in scope.\n\nFixing AreaReference is a little more involved as the information needs passing through to the right point. So I think I'll save that treat for next week - happy weekend."}, {"count": 3, "attachment_id": null, "bug_id": 56328, "text": "Thanks for that David, applied in r1582892.\n\nIf you could do a patch for AreaRange, that'd be great. Also, if you could knock up a quick junit test case which tries to parse a formula with a row >65536, and tries it with HSSF + XSSF, to check it's invalid for HSSF but valid for XSSF, that'd be great!", "id": 174167, "time": "2014-03-28T21:55:34Z", "creator": "apache@gagravarr.org", "creation_time": "2014-03-28T21:55:34Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "bug_id": 56328, "attachment_id": null, "text": "This can be a good reference for writing a complete unit test:\nhttp://superuser.com/questions/366468/what-is-the-maximum-allowed-rows-in-a-microsoft-excel-xls-or-xlsx", "id": 174171, "time": "2014-03-29T19:17:54Z", "creator": "yaniv@kundas.net", "creation_time": "2014-03-29T19:17:54Z", "is_private": false}, {"count": 5, "tags": [], "creator": "dtn-asfbugs@corefiling.co.uk", "attachment_id": 32737, "id": 182996, "time": "2015-05-15T15:36:45Z", "bug_id": 56328, "creation_time": "2015-05-15T15:36:45Z", "is_private": false, "text": "Created attachment 32737\nPatch to add tests and fix AreaReference\n\nThe attached patch adds tests for FormulaParser showing the original bug is fixed.\n\nIt also improves the situation with AreaReference and adds tests for that. Unfortunately there are rather more references to AreaReference than I have time to fix (it now needs a SpreadsheetVersion upon construction), but I've improved things considerably and deprecated the old constructor which doesn't supply enough information."}, {"count": 6, "attachment_id": null, "bug_id": 56328, "text": "Fixed an NPE in my patch (caught by the existing tests). Added some more tests and committed in r1685101, r1685104\n\nFixed.", "id": 183485, "time": "2015-06-12T15:29:35Z", "creator": "dtn-asfbugs@corefiling.co.uk", "creation_time": "2015-06-12T15:29:35Z", "tags": [], "is_private": false}]