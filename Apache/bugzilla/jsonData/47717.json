[{"count": 0, "tags": [], "bug_id": 47717, "text": "org.apache.jasper.compiler.ErrorDispatcher.createJavacError sometimes throws a NPE when the page argument is null.\n\nI don't really know what exactly the circumstance is that leads to this situation (except that my code is resulting in a JspException) but the result is the jsp error is not reported and the failure swallowed.\n\nFWIW here is the call stack from my debugger, after trapping the NPE:\n\norg.apache.jasper.compiler.ErrorDispatcher.createJavacError(java.lang.String, org.apache.jasper.compiler.Node$Nodes, java.lang.StringBuffer, int, org.apache.jasper.JspCompilationContext) line: 527\t\norg.apache.jasper.servlet.JspServletWrapper.handleJspException(java.lang.Exception) line: 490\t\norg.apache.jasper.servlet.JspServletWrapper.service(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse, boolean) line: 398\t\norg.apache.jasper.servlet.JspServlet.serviceJspFile(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse, java.lang.String, java.lang.Throwable, boolean) line: 342\t\norg.apache.jasper.servlet.JspServlet.service(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse) line: 267\t\norg.apache.jasper.servlet.JspServlet(javax.servlet.http.HttpServlet).service(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 831\t\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 290\t\norg.apache.catalina.core.ApplicationFilterChain.doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 206\t\norg.apache.catalina.core.ApplicationDispatcher.invoke(javax.servlet.ServletRequest, javax.servlet.ServletResponse, org.apache.catalina.core.ApplicationDispatcher$State) line: 646\t\norg.apache.catalina.core.ApplicationDispatcher.processRequest(javax.servlet.ServletRequest, javax.servlet.ServletResponse, org.apache.catalina.core.ApplicationDispatcher$State) line: 436\t\norg.apache.catalina.core.ApplicationDispatcher.doForward(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 374\t\norg.apache.catalina.core.ApplicationDispatcher.forward(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 302\t\norg.springframework.web.servlet.view.JstlView(org.springframework.web.servlet.view.InternalResourceView).renderMergedOutputModel(java.util.Map, javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse) line: 236\t\norg.springframework.web.servlet.view.JstlView(org.springframework.web.servlet.view.AbstractView).render(java.util.Map, javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse) line: 257\t\norg.springframework.web.servlet.DispatcherServlet.render(org.springframework.web.servlet.ModelAndView, javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse) line: 1183\t\norg.springframework.web.servlet.DispatcherServlet.doDispatch(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse) line: 902\t\norg.springframework.web.servlet.DispatcherServlet.doService(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse) line: 807\t\norg.springframework.web.servlet.DispatcherServlet(org.springframework.web.servlet.FrameworkServlet).processRequest(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse) line: 571\t\norg.springframework.web.servlet.DispatcherServlet(org.springframework.web.servlet.FrameworkServlet).doPost(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse) line: 511\t\norg.springframework.web.servlet.DispatcherServlet(javax.servlet.http.HttpServlet).service(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse) line: 738\t\norg.springframework.web.servlet.DispatcherServlet(javax.servlet.http.HttpServlet).service(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 831\t\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 290\t\norg.apache.catalina.core.ApplicationFilterChain.doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 206\t\ncom.wrycan.xms.web.servlet.filter.TransactionManagerFilter.doFilterInternal(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse, javax.servlet.FilterChain) line: 48\t\ncom.wrycan.xms.web.servlet.filter.TransactionManagerFilter(org.springframework.web.filter.OncePerRequestFilter).doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse, javax.servlet.FilterChain) line: 76\t\norg.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(javax.servlet.Filter, javax.servlet.ServletRequest, javax.servlet.ServletResponse, javax.servlet.FilterChain) line: 236\t\norg.springframework.web.filter.DelegatingFilterProxy.doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse, javax.servlet.FilterChain) line: 167\t\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 235\t\norg.apache.catalina.core.ApplicationFilterChain.doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 206\t\ncom.wrycan.xms.web.servlet.filter.RequestLoggingFilter(org.springframework.web.filter.AbstractRequestLoggingFilter).doFilterInternal(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse, javax.servlet.FilterChain) line: 156\t\ncom.wrycan.xms.web.servlet.filter.RequestLoggingFilter(org.springframework.web.filter.OncePerRequestFilter).doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse, javax.servlet.FilterChain) line: 76\t\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 235\t\norg.apache.catalina.core.ApplicationFilterChain.doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 206\t\ncom.atlassian.seraph.filter.SecurityFilter.doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse, javax.servlet.FilterChain) line: 182\t\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 235\t\norg.apache.catalina.core.ApplicationFilterChain.doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 206\t\ncom.atlassian.seraph.filter.LoginFilter.doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse, javax.servlet.FilterChain) line: 177\t\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 235\t\norg.apache.catalina.core.ApplicationFilterChain.doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 206\t\ncom.wrycan.xms.web.servlet.filter.SettingsConfigFilter.doFilterInternal(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse, javax.servlet.FilterChain) line: 42\t\ncom.wrycan.xms.web.servlet.filter.SettingsConfigFilter(org.springframework.web.filter.OncePerRequestFilter).doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse, javax.servlet.FilterChain) line: 76\t\norg.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(javax.servlet.Filter, javax.servlet.ServletRequest, javax.servlet.ServletResponse, javax.servlet.FilterChain) line: 236\t\norg.springframework.web.filter.DelegatingFilterProxy.doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse, javax.servlet.FilterChain) line: 167\t\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 235\t\norg.apache.catalina.core.ApplicationFilterChain.doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 206\t\norg.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse, javax.servlet.FilterChain) line: 96\t\norg.springframework.web.filter.CharacterEncodingFilter(org.springframework.web.filter.OncePerRequestFilter).doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse, javax.servlet.FilterChain) line: 76\t\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 235\t\norg.apache.catalina.core.ApplicationFilterChain.doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 206\t\norg.apache.catalina.core.StandardWrapperValve.invoke(org.apache.catalina.connector.Request, org.apache.catalina.connector.Response) line: 233\t\norg.apache.catalina.core.StandardContextValve.invoke(org.apache.catalina.connector.Request, org.apache.catalina.connector.Response) line: 191\t\norg.apache.catalina.core.StandardHostValve.invoke(org.apache.catalina.connector.Request, org.apache.catalina.connector.Response) line: 128\t\norg.apache.catalina.valves.ErrorReportValve.invoke(org.apache.catalina.connector.Request, org.apache.catalina.connector.Response) line: 102\t\norg.apache.catalina.core.StandardEngineValve.invoke(org.apache.catalina.connector.Request, org.apache.catalina.connector.Response) line: 109\t\norg.apache.catalina.connector.CoyoteAdapter.service(org.apache.coyote.Request, org.apache.coyote.Response) line: 293\t\norg.apache.coyote.http11.Http11Processor.process(java.net.Socket) line: 849\t\norg.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(java.net.Socket) line: 583\t\norg.apache.tomcat.util.net.JIoEndpoint$Worker.run() line: 454\t\njava.lang.Thread.run() line: 619", "id": 129827, "time": "2009-08-20T14:21:43Z", "creator": "Eric.J.Schwarzenbach.C88@alumni.upenn.edu", "creation_time": "2009-08-20T14:21:43Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "text": "I believe the NPE is this:\n        page.visit(errVisitor);\n\nWhich is caused by\n                JavacErrorDetail detail = ErrorDispatcher.createJavacError(\n                        jspFrame.getMethodName(),\n                        this.ctxt.getCompiler().getPageNodes(),\n                        null,\n                        javaLineNumber,\n                        ctxt);\n\nSo one wonders ... why is this.ctxt.getCompiler().getPageNodes() null?\n\nIt could be that compilation is done in 2 passes. And the first pass is validation. So if this fails - then getPageNodes would be null.\n\nSo the easy fix may be this (not sure if its the right fix)...\n\nIndex: java/org/apache/jasper/compiler/ErrorDispatcher.java\n===================================================================\n--- java/org/apache/jasper/compiler/ErrorDispatcher.java        (revision 833114)\n+++ java/org/apache/jasper/compiler/ErrorDispatcher.java        (working copy)\n@@ -524,7 +524,8 @@\n         JavacErrorDetail javacError;\n         // Attempt to map javac error line number to line in JSP page\n         ErrorVisitor errVisitor = new ErrorVisitor(lineNum);\n-        page.visit(errVisitor);\n+        if (page!=null)\n+            page.visit(errVisitor);\n         Node errNode = errVisitor.getJspSourceNode();\n         if ((errNode != null) && (errNode.getStart() != null)) {\n             // If this is a scriplet node then there is a one to one mapping", "is_private": false, "bug_id": 47717, "id": 131742, "time": "2009-11-05T11:49:49Z", "creator": "funkman@apache.org", "creation_time": "2009-11-05T11:49:49Z", "attachment_id": null}, {"count": 2, "attachment_id": null, "creator": "markt@apache.org", "is_private": false, "id": 132801, "time": "2009-12-14T02:31:54Z", "bug_id": 47717, "creation_time": "2009-12-14T02:31:54Z", "tags": [], "text": "You will see this if the JSP was compiled, Tomcat restarted and then the JSP requested. Since the new Tomcat instance didn't compile the JSP, pageNodes will be null - hence the NPE.\n\nThis is handled by falling back to the error handling that does not display the relevant JSP line numbers. This error page should show:\n- the exception and any root cause\n- the line number of the Java file where the error occurred\n\nIt shouldn't be too hard to look in the Java file and manually trace the error back to the appropriate line in the JSP.\n\nThis could be handled more cleanly rather than relying on the NPE but I can't find any bug here.\n\nIf you have a JSP that triggers this where the appropriate stack traces are not shown in the browser then please feel free to re-open this bug and attach your JSP so we can investigate further."}]