[{"count": 0, "tags": [], "bug_id": 43081, "text": "graceful-stop on Event MPM in 2.2.x doesn't seem to work on busy machines.  It\ndoes *stop*, but it doesn't debind from the listening ports quickly enough to\nstart up httpd again right away, sometimes taking up to 2 minutes.\n\nEvery time I've seen it eventually stop, but it is still listening to the main\nsockets for a long time.  I suspect we just need to call socket_close in one\nmore place, and make sure the socket gets removed from the main pollset.", "id": 106563, "time": "2007-08-09T19:41:13Z", "creator": "chip@force-elite.com", "creation_time": "2007-08-09T19:41:13Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "text": "\n2.2.x\n\nconfig:\n\nStartServers          1\nMaxClients          2\nMinSpareThreads      1\nMaxSpareThreads      2\nThreadsPerChild      2\nMaxRequestsPerChild   0\nTimeout 6000\n\nOn this config there are two worker threads.\n\nMake two workers busy.\n(e.g. start two telnet and request\n GET / HTTP/1.1\n Host: localhost\n X-DUMMY: foo\nand leave it)\n\nListener thread is waiting for new connections and/or new requests from keep-\nalive on apr_pollset_poll\n\n#2  0x0016dc28 in apr_pollset_poll (pollset=0x8e8a218, timeout=1000,\n    num=0xb574b35c, descriptors=0xb574b360)\n    at /home/saki/httpd-2.2.4/srclib/apr/poll/unix/epoll.c:239\n#3  0x0808fffd in listener_thread (thd=0x8e80400, dummy=0x8eae550)\n    at /home/saki/httpd-2.2.x/server/mpm/experimental/event/event.c:894\n\n\nIf you perform  a graceful-stop now, the listener thread will stop listening \nimmediately.\n\n\nMake one more connection.\n(e.g. access from your webbrowser)\n\nThe listener thread is waiting for a idle worker.\n\n\n#3  0x08093091 in ap_queue_info_wait_for_idler (queue_info=0x8e802f0)\n    at /home/saki/httpd-2.2.x/server/mpm/experimental/event/fdqueue.c:157\n#4  0x0808fcfd in get_worker (have_idle_worker_p=0xb574b364)\n    at /home/saki/httpd-2.2.x/server/mpm/experimental/event/event.c:773\n#5  0x080903d4 in listener_thread (thd=0x8e80400, dummy=0x8eae550)\n    at /home/saki/httpd-2.2.x/server/mpm/experimental/event/event.c:912\n\n\nEven if you perform a graceful-stop now, the listener thread won't stop \nlistening.\n\n$ ./apachectl graceful-stop && ./apachectl start\n(98)Address already in use: make_sock: could not bind to address 0.0.0.0:80\nno listening sockets available, shutting down\nUnable to open logs\n\n$./apachectl start\n(98)Address already in use: make_sock: could not bind to address 0.0.0.0:80\nno listening sockets available, shutting down\nUnable to open logs\n", "attachment_id": null, "id": 108903, "creator": "takashi.asfbugzilla@tks.st", "time": "2007-10-02T07:54:47Z", "bug_id": 43081, "creation_time": "2007-10-02T07:54:47Z", "is_private": false}, {"count": 2, "attachment_id": null, "creator": "takashi.asfbugzilla@tks.st", "text": "To solve this issue, make get_worker able to timeout...?", "id": 108904, "time": "2007-10-02T08:15:56Z", "bug_id": 43081, "creation_time": "2007-10-02T08:15:56Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 43081, "text": "Created attachment 20906\nfor trunk\n\ninterrupt get_worker on ST_GRACEFUL", "id": 108906, "time": "2007-10-02T09:41:35Z", "creator": "takashi.asfbugzilla@tks.st", "creation_time": "2007-10-02T09:41:35Z", "is_private": false, "attachment_id": 20906}, {"count": 4, "tags": [], "bug_id": 43081, "attachment_id": null, "id": 108924, "time": "2007-10-02T17:03:24Z", "creator": "takashi.asfbugzilla@tks.st", "creation_time": "2007-10-02T17:03:24Z", "is_private": false, "text": "(In reply to comment #3)\n> Created an attachment (id=20906) [edit]\n> for trunk\n> interrupt get_worker on ST_GRACEFUL\n\nThis patch is for this issue,\nbut it may prevent bug 43359 from being solved."}, {"count": 5, "tags": [], "creator": "gregames@apache.org", "text": "I see the same thing with the worker MPM, using Takashi's recipe to make the listener wait on a worker.  I was able to unblock the listener thread with a patch similar to Takashi's, but that still did not make the server release the listening port. ", "id": 117680, "attachment_id": null, "bug_id": 43081, "creation_time": "2008-06-13T13:53:58Z", "time": "2008-06-13T13:53:58Z", "is_private": false}, {"count": 6, "attachment_id": null, "creator": "gregames@apache.org", "text": "I tweaked the patch so that it will work for all calls to wakeup_listener() for both the worker and event MPMs and commit to trunk, rev. 668826.  Thanks for the patch and the debugging effort.", "id": 117770, "time": "2008-06-17T14:04:32Z", "bug_id": 43081, "creation_time": "2008-06-17T14:04:32Z", "tags": [], "is_private": false}, {"count": 7, "attachment_id": null, "creator": "gregames@apache.org", "text": "p.s. the failure I saw after my first attempt to patch it was due to a 3rd\nparty daemon that inherited the listening socket and didn't know to close it.", "id": 117773, "time": "2008-06-17T14:14:36Z", "bug_id": 43081, "creation_time": "2008-06-17T14:14:36Z", "tags": [], "is_private": false}]