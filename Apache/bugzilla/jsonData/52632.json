[{"count": 0, "tags": [], "bug_id": 52632, "text": "On Mac OS X 10.7 (Lion), running the default ant command (with no shell ANT_HOME set) gives me:\n$ ant\nError: JAVA_HOME is not defined correctly.\n  We cannot execute /System/Library/Frameworks/JavaVM.framework/Home/bin/java\n\n\nBelow is a patch that fixes the problem. Your ant shell script correctly calculates JAVACMD in the following line:\n    JAVACMD=`which java 2> /dev/null `\nBut was unable to get to this point because the JAVA_HOME had been incorrectly hard-coded for Darwin (Mac OS X).\n\n--- /opt/local/share/java/apache-ant/bin/ant.orig\t2012-02-09 12:02:30.000000000 -0500\n+++ /opt/local/share/java/apache-ant/bin/ant\t2012-02-09 12:02:53.000000000 -0500\n@@ -83,11 +83,7 @@\n mingw=false;\n case \"`uname`\" in\n   CYGWIN*) cygwin=true ;;\n-  Darwin*) darwin=true\n-           if [ -z \"$JAVA_HOME\" ] ; then\n-             JAVA_HOME=/System/Library/Frameworks/JavaVM.framework/Home\n-           fi\n-           ;;\n+  Darwin*) darwin=true ;;\n   MINGW*) mingw=true ;;\n esac", "id": 153630, "time": "2012-02-09T17:12:39Z", "creator": "ashirazi@codesherpas.com", "creation_time": "2012-02-09T17:12:39Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "ashirazi@codesherpas.com", "attachment_id": null, "text": "If the ant script must set a JAVA_HOME, I would suggest basing it on the calculated JAVACMD. For example:\n\nif [ -L \"$JAVACMD\" ]; then JAVA_HOME=`readlink \"$JAVACMD\"`/../..; else JAVA_HOME=\"$JAVA_CMD\"/../..; fi", "id": 153633, "time": "2012-02-09T19:02:51Z", "bug_id": 52632, "creation_time": "2012-02-09T19:02:51Z", "is_private": false}, {"count": 2, "tags": [], "creator": "bodewig@apache.org", "attachment_id": null, "text": "Actually JAVA_HOME on a Mac is set mostly for jikes later down inside the script (just look for the only other place that references darwin).  I don't think simply going two levels up from wherever java is locates is going to help, maybe we just don't set JAVA_HOME unless there is an executable java where we expect to find it as well.\n\nWhere is the java executable in Lion (and where would we find the runtime libs that used to be in /System/Library/Frameworks/JavaVM.framework/Classes)?", "id": 153692, "time": "2012-02-12T07:27:46Z", "bug_id": 52632, "creation_time": "2012-02-12T07:27:46Z", "is_private": false}, {"count": 3, "tags": [], "text": "Just checked with a co-worker who is using Lion: /System/Library/Frameworks/JavaVM.framework/Home exists, as does /System/Library/Frameworks/JavaVM.framework/Home/bin/java and the later is executable.  I'm puzzled.\n\nAs for your suggested workaround, I'd rather check whether /System/Library/Frameworks/JavaVM.framework/Home/bin/java is executable before setting JAVA_HOME and not set it at all otherwise.", "attachment_id": null, "id": 153990, "creator": "bodewig@apache.org", "time": "2012-02-21T15:11:46Z", "bug_id": 52632, "creation_time": "2012-02-21T15:11:46Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 52632, "text": "Another co-worker pointed me at http://trac.macports.org/ticket/35786 and http://developer.apple.com/library/mac/#DOCUMENTATION/Darwin/Reference/ManPages/man1/java_home.1.html", "id": 161655, "time": "2012-08-24T06:52:33Z", "creator": "bodewig@apache.org", "creation_time": "2012-08-24T06:52:33Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 52632, "attachment_id": null, "id": 161684, "time": "2012-08-24T18:51:47Z", "creator": "ashirazi@codesherpas.com", "creation_time": "2012-08-24T18:51:47Z", "is_private": false, "text": "Keep in mind that you want to configure JAVA_HOME and JAVACMD using the same mechanisms.\n\nJAVA_HOME=\"`/usr/libexec/java_home`\"\nJAVACMD=\"$JAVA_HOME/bin/java\"\n\nor\n\nJAVACMD=\"`which java 2> /dev/null `\"\nJAVA_HOME=\"$JAVACMD/../..\"\n# Note I have left out logic to identify and follow symlinks here\n\nThe point is they should be consistent, since the java configured on the path may be different from that configured OS-wide."}, {"count": 6, "tags": [], "text": "Oh, and for the record:\n$ /usr/libexec/java_home                                          \n/System/Library/Java/JavaVirtualMachines/1.6.0.jdk/Contents/Home\n\nThis is different from what your colleague has configured.\n\nAll the more reason to try to derive JAVA_HOME/JAVACMD from a known executable (preferable the one on the PATH).", "attachment_id": null, "id": 161686, "creator": "ashirazi@codesherpas.com", "time": "2012-08-24T18:56:01Z", "bug_id": 52632, "creation_time": "2012-08-24T18:56:01Z", "is_private": false}, {"count": 7, "attachment_id": null, "creator": "bodewig@apache.org", "text": "I've ported Tomcat's look up algorithm with svn revision 1434680", "id": 164695, "time": "2013-01-17T14:18:59Z", "bug_id": 52632, "creation_time": "2013-01-17T14:18:59Z", "tags": [], "is_private": false}]