[{"count": 0, "tags": [], "creator": "shamil.bahirov@gmail.com", "text": "This is basically same issue but with a test project provided that you can debug\nhttps://bz.apache.org/bugzilla/show_bug.cgi?id=57736\n\nWhat happens is javax.crypto.JarVerifier.verifySingleJar complains about unsigned content which in fact there's not such content in the jar but for some reason all WAR resources appear as jar's content\n\njava.util.jar.JarException: jar:file:/C:/Users/bahisha/work/apache-tomcat-8.0.36/webapps/test.war!/WEB-INF/lib/bcprov-jdk16-1.46.jar has unsigned entries - WEB-INF/lib/bcprov-jdk16-1.46.jar", "id": 193510, "time": "2016-09-06T12:35:56Z", "bug_id": 60087, "creation_time": "2016-09-06T12:35:56Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 60087, "attachment_id": 34206, "text": "Created attachment 34206\ntest war zip part 1", "id": 193511, "time": "2016-09-06T12:38:55Z", "creator": "shamil.bahirov@gmail.com", "creation_time": "2016-09-06T12:38:55Z", "is_private": false}, {"count": 2, "tags": [], "creator": "shamil.bahirov@gmail.com", "attachment_id": 34207, "id": 193512, "time": "2016-09-06T12:39:21Z", "bug_id": 60087, "creation_time": "2016-09-06T12:39:21Z", "is_private": false, "text": "Created attachment 34207\ntest war zip part 2"}, {"count": 3, "tags": [], "creator": "rpc1@mail.ru", "text": "I reproduced error on Tomcat 8.0.x with unpackWARs=\"false\".\nError because of the getLocation(), which returns codeBaseURL for resource file.\nLocation URL is \njar:file:/some_path/webapps/test.war!/WEB-INF/lib/bcprov-jdk16-1.46.jar, but\n((JarURLConnection)url.openConnection()).getJarFile() connects to the test.war instead bcprov-jdk16-1.46.jar, because the test.war before separator '!/'.\nWe need jar:war: path to access resource inside of test.war file (because it doesn't unpack). This is example of the URL which have to be used in given test:\njar:war:file:/some_path/webapps/test.war*/WEB-INF/lib/bcprov-jdk16-1.46.jar!/\n\nI looked at sources and notice that getLocation() returns AbstractArchiveResource.codeBaseUrl field, for war resources this field generates in constructor JarWarResource, I changed constructor of JarWarResource for codeBaseUrl:\nbefore codeBaseUrl=\"jar:\" + baseUrl + \"!/\" + archivePath\nafter  codeBaseUrl=\"jar:war:\" + baseUrl + \"*/\" + archivePath+\"!/\"\n\nI rebuilt tomcat and tried attached test, everything works fine, \nBut I have doubts in solution correctness, because codeBaseUrl uses in WebappClassLoaderBase.getPermissions() function, which gets permissions for codeSource. In current version, for codeSource /some_path/webapps/test.war!/WEB-INF/lib/bcprov-jdk16-1.46.jar, getPermissions returns permission collection for test.war,  but after changes of codeBaseURL getPermissions() returns permissions for bcprov-jdk16-1.46.jar which\nlocated in war archive.\n\nCould somebody confirm that changing JarWarResource's constructor is a right solution?", "id": 194082, "time": "2016-09-29T11:35:51Z", "bug_id": 60087, "creation_time": "2016-09-29T11:35:51Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "markt@apache.org", "text": "Unfortunately, it doesn't appear to be as clear cut as I would like.\n\nIf we look at how the JRE constructs a code path for a JAR, it returns a \"file:\" URL to the JAR, not a \"jar:\" URL. Therefore, if Tomcat is to be consistent with that, the current behavior is correct.\n\nHowever, the JarVerifier accepts either a \"file:\" or \"jar:\" URL for a JAR and ignores the possibility of JARs in WARs etc entirely.\n\nReturning \"jar:\" URLs and \"jar:war:\" URLs would fix JarVerifier but might break other functionality. I need to do some more testing with the security manager.", "id": 194103, "time": "2016-09-30T11:48:46Z", "bug_id": 60087, "creation_time": "2016-09-30T11:48:46Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "text": "This has been fixed in the following branches:\n- 9.0.x for 9.0.0.M11 onwards\n- 8.5.x for 8.5.6 onwards\n- 8.0.x for 8.0.38 onwards\n\n7.0.x and earlier versions were not affected.\n\nFixing this required refactoring of the web resources handling to use the Tomcat specific 'war:file:...' URL protocol to refer to WAR files and their contents rather than the standard 'jar:file:...' form. A side-effect of the refactoring is that when using packed WARs, it is now possible to reference a WAR and/or specific JARs within a WAR in the security policy file used when running under a SecurityManager.", "attachment_id": null, "bug_id": 60087, "id": 194145, "time": "2016-10-05T10:58:11Z", "creator": "markt@apache.org", "creation_time": "2016-10-05T10:58:11Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 60087, "text": "This solution has introduced a new issue resolving resources url.\nI've made a project to test this behaviour https://github.com/didiez/tomcat-bug-60087\n\nRun the main-app to see the problem. If built changing tomcat.version to 8.5.5 everything works as expected.", "id": 195083, "attachment_id": null, "creator": "diegodiez.ddr@gmail.com", "creation_time": "2016-11-19T15:43:12Z", "time": "2016-11-19T15:43:12Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 60087, "attachment_id": null, "text": "(In reply to Diego D\u00edez Ricondo from comment #6)\n> This solution has introduced a new issue resolving resources url.\n> I've made a project to test this behaviour\n> https://github.com/didiez/tomcat-bug-60087\n> \n> Run the main-app to see the problem. If built changing tomcat.version to\n> 8.5.5 everything works as expected.\n\nUpdate the status in favor to the archives.\nThis has been fixed:\nhttps://bz.apache.org/bugzilla/show_bug.cgi?id=60391", "id": 195128, "time": "2016-11-21T21:00:02Z", "creator": "violetagg@apache.org", "creation_time": "2016-11-21T21:00:02Z", "is_private": false}]