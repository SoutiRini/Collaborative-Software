[{"count": 0, "tags": [], "bug_id": 57347, "text": "This problem applies to TC 8 and 9:\n\nI get AJP responses with status code 200 but wrong reason phrase \"ACT\" instead of \"OK\".\n\nThe problem is due to the MessageBytes tmpMB being used in AbstractAjpProcessor first in prepareResponse() for processing the request, then in prepareResponse() for setting the reason phrase.\n\nDuring prepareRequest() only the byte (ByteChunk) functionality of tmpMB is used, during prepareResponse() the String functionality. Now appending the reason phrase to the AJP message is done using AjpMessage.appendBytes(). This function has changed between TC 7 and TC 8 to support multiple charsets (r1630910).\n\nIn TC 7 when the MessageBytes is of type T_STR, which is the case here, the append does:\n\n            appendString(mb.toString());\n\nAfter the change in TC 8 it calls\n\n            mb.toBytes();\n\nand then uses the ByteChunk in mb. The implementation of mb.toBytes() checks, whether the ByteChunk already set before (isSet) and then doesn't do the string to ByteChunk conversion. Since the MessageBytes tmpMB was used before to read request headers and attributes, it already has a ByteChunk set, so the conversion is skipped and the old value of the ByteChunk is used. As a result the value of the last part read from the request - in my case the string \"ACT\" is appended as the status reason phrase.\n\nI suggest to not change the behavior in AjpMessage.appendBytes() but instead recycle the tmpMB MessageBytes before using it in AjpProcessor.prepareResponse() (TC 9) resp. AbstractAjpProcessor.prepareResponse() (TC 8).\n\n--- java/org/apache/coyote/ajp/AjpProcessor.java        (revision 1645245)\n+++ java/org/apache/coyote/ajp/AjpProcessor.java        (working copy)\n@@ -1388,6 +1388,7 @@\n\n         response.setCommitted(true);\n\n+        tmpMB.recycle();\n         responseMsgPos = -1;\n         responseMessage.reset();\n         responseMessage.appendByte(Constants.JK_AJP13_SEND_HEADERS);\n\nRegards,\n\nRainer", "id": 179748, "time": "2014-12-13T15:41:57Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2014-12-13T15:41:57Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 57347, "text": "Fixed for TC 9 and TC 8 (8.0.16) with r1645247 resp. r1645248.", "id": 179749, "time": "2014-12-13T16:17:27Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2014-12-13T16:17:27Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 57347, "text": "*** Bug 57443 has been marked as a duplicate of this bug. ***", "id": 180298, "attachment_id": null, "creator": "sys.viktor@gmail.com", "creation_time": "2015-01-14T15:59:42Z", "time": "2015-01-14T15:59:42Z", "is_private": false}]