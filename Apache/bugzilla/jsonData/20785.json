[{"count": 0, "attachment_id": null, "creator": "cahya@mail.com", "is_private": false, "id": 38869, "time": "2003-06-15T09:37:47Z", "bug_id": 20785, "creation_time": "2003-06-15T09:37:47Z", "tags": [], "text": "I use mod_proxy for reverse proxy https connection, it is running fine \nwith apache 2.0.43 , but when I upgrade it to 2.0.46, more than 50% of the \nhttps connetions will fail, httpd child process is just died.\n2.0.44 and 2.0.45 have the same problem, their child process is just died in\nmore than 50% https connections. I tried also to upgrade openssl\nto the latest version 0.9.7b, and recompile apache, but it doesn't help,\nsince maybe it is not openssl's bug. and this behaviour is resproducible in\nanother server, I tried it here with redhat 7.0 and gentoo 1.4. both of them\nhave the same problem with apache 2.0.44,2.0.45 and 2.0.46 no mater which\nopenssl version and have a stable connection with 2.0.43.\n \nhere is my config:\n\nNameVirtualHost xxx.5.131.41:443\nSSLProxyEngine on\n<VirtualHost xxx.5.131.41:443>\n        ServerName iniskp.mydomain.org\n        ProxyPass               /       https://iniskp.mydomain.org/\n        ProxyPassReverse        /       https://iniskp.mydomain.org/\n        LogLevel        debug\n        SSLEngine on\n        SSLCertificateFile conf/ssl/server.crt\n        SSLCertificateKeyFile conf/ssl/server.key\n</VirtualHost>\n\nAnd here is the error log when the connections failed:\n\n.....\n[Fri Jun 13 18:18:52 2003] [debug] ssl_engine_io.c(1462):\n+-------------------------------------------------------------------------+\n[Fri Jun 13 18:18:52 2003] [debug] proxy_http.c(109): proxy: HTTP:\ncanonicalising URL //iniskp.mydomain.org/\n[Fri Jun 13 18:18:52 2003] [debug] mod_proxy.c(459): Trying to run scheme_handler\n[Fri Jun 13 18:18:52 2003] [debug] proxy_http.c(1076): proxy: HTTP: serving URL\nhttps://iniskp.mydomain.org/\n[Fri Jun 13 18:18:52 2003] [debug] proxy_http.c(221): proxy: HTTP connecting\nhttps://iniskp.mydomain.org/ to iniskp.mydomain.org:443\n[Fri Jun 13 18:18:52 2003] [debug] proxy_util.c(1203): proxy: HTTP: fam 2 socket\ncreated to connect to iniskp.mydomain.org\n[Fri Jun 13 18:18:52 2003] [debug] proxy_http.c(370): proxy: socket is connected\n[Fri Jun 13 18:18:52 2003] [debug] proxy_http.c(404): proxy: connection complete\nto xxx.5.67.95:443 (iniskp.mydomain.org)\n[Fri Jun 13 18:18:52 2003] [info] Connection to child 3 established (server\niniskp.mydomain.org:443, client xxx.5.67.95)\n[Fri Jun 13 18:18:52 2003] [info] Seeding PRNG with 136 bytes of entropy\n[Fri Jun 13 18:18:52 2003] [debug] ssl_engine_kernel.c(1766): OpenSSL:\nHandshake: start\n[Fri Jun 13 18:18:52 2003] [debug] ssl_engine_kernel.c(1774): OpenSSL: Loop:\nbefore/connect initialization\n[Fri Jun 13 18:18:52 2003] [debug] ssl_engine_kernel.c(1774): OpenSSL: Loop:\nSSLv2/v3 write client hello A\n[Fri Jun 13 18:18:52 2003] [debug] ssl_engine_io.c(1484): OpenSSL: read 0/7\nbytes from BIO#8194ea0 [mem: 81a1c98] (BIO dump follows)\n[Fri Jun 13 18:18:52 2003] [debug] ssl_engine_io.c(1431):\n+-------------------------------------------------------------------------+\n[Fri Jun 13 18:18:52 2003] [debug] ssl_engine_io.c(1462):\n+-------------------------------------------------------------------------+\n[Fri Jun 13 18:18:52 2003] [info] SSL Proxy connect failed\n[Fri Jun 13 18:18:52 2003] [info] Connection to child 3 closed with abortive\nshutdown(server iniskp.mydomain.org:443, client xxx.5.67.95)\n.....\n\nAnd here is a successfull connection right after above connection:\n\n.....\n[Fri Jun 13 18:18:53 2003] [debug] proxy_http.c(109): proxy: HTTP:\ncanonicalising URL //iniskp.mydomain.org/\n[Fri Jun 13 18:18:53 2003] [debug] mod_proxy.c(459): Trying to run scheme_handler\n[Fri Jun 13 18:18:53 2003] [debug] proxy_http.c(1076): proxy: HTTP: serving URL\nhttps://iniskp.mydomain.org/\n[Fri Jun 13 18:18:53 2003] [debug] proxy_http.c(221): proxy: HTTP connecting\nhttps://iniskp.mydomain.org/ to iniskp.mydomain.org:443\n[Fri Jun 13 18:18:53 2003] [debug] proxy_util.c(1203): proxy: HTTP: fam 2 socket\ncreated to connect to iniskp.mydomain.org\n[Fri Jun 13 18:18:53 2003] [debug] proxy_http.c(370): proxy: socket is connected\n[Fri Jun 13 18:18:53 2003] [debug] proxy_http.c(404): proxy: connection complete\nto 161.5.67.95:443 (iniskp.mydomain.org)\n[Fri Jun 13 18:18:53 2003] [info] Connection to child 5 established (server\niniskp.mydomain.org:443, client xxx.5.67.95)\n[Fri Jun 13 18:18:53 2003] [info] Seeding PRNG with 136 bytes of entropy\n[Fri Jun 13 18:18:53 2003] [debug] ssl_engine_kernel.c(1766): OpenSSL:\nHandshake: start\n[Fri Jun 13 18:18:53 2003] [debug] ssl_engine_kernel.c(1774): OpenSSL: Loop:\nbefore/connect initialization\n[Fri Jun 13 18:18:53 2003] [debug] ssl_engine_kernel.c(1774): OpenSSL: Loop:\nSSLv2/v3 write client hello A\n[Fri Jun 13 18:18:53 2003] [debug] ssl_engine_io.c(1484): OpenSSL: read 7/7\nbytes from BIO#8194ea0 [mem: 81a3ca0] (BIO dump follows)\n[Fri Jun 13 18:18:53 2003] [debug] ssl_engine_io.c(1431):\n+-------------------------------------------------------------------------+\n[Fri Jun 13 18:18:53 2003] [debug] ssl_engine_io.c(1456): | 0000: 16 03 01 03 68\n02                                ....h.           |\n[Fri Jun 13 18:18:53 2003] [debug] ssl_engine_io.c(1460): | 0007 - <SPACES/NULS>\n.....\n\nThe difference is in \"ssl_engine_io() : OpenSSL: read 0/7 bytes from ...\" if it\nis failed and \"ssl_engine_io() : OpenSSL: read 7/7 bytes from ...\" if it is\nsuccessfull."}, {"count": 1, "tags": [], "text": "I am Katsumi Ishii. \nI belong to Hitachi System and Service,Inc.\n\nSorry in strage English.\n\nI use mod_proxy and mod_ssl for reverse proxy https connection. \nLess than 50% of the https connetions will fail.\n\nhere is my environment.\n    OS      : HP-UX 11i\n    Apache  : 2.0.47\n    OpenSSL : 0.9.7b\n\nand here is error log when the connections failed :\n+------------------------------------------------------------------------------+\n[Wed Sep 10 10:18:53 2003] [debug] ssl_engine_kernel.c(1766): OpenSSL: \nHandshake: start\n[Wed Sep 10 10:18:53 2003] [debug] ssl_engine_kernel.c(1774): OpenSSL: Loop: \nbefore/connect initialization\n[Wed Sep 10 10:18:53 2003] [debug] ssl_engine_kernel.c(1774): OpenSSL: Loop: \nSSLv2/v3 write client hello A\n[Wed Sep 10 10:18:53 2003] [debug] ssl_engine_io.c(1484): OpenSSL: read 0/7 \nbytes from BIO#400db538 [mem: 40119ca8] (BIO dump follows)\n[Wed Sep 10 10:18:53 2003] [debug] ssl_engine_io.c(1431): +---------------------\n----------------------------------------------------+\n[Wed Sep 10 10:18:53 2003] [debug] ssl_engine_io.c(1462): +---------------------\n----------------------------------------------------+\n[Wed Sep 10 10:18:53 2003] [info] SSL Proxy connect failed\n[Wed Sep 10 10:18:53 2003] [info] Connection to child 1 closed with abortive \nshutdown(server www.zzbojinfo.boj.or.jp:443, client 10.253.253.134)\n+------------------------------------------------------------------------------+\n\nI changed my config and tried test, but it doesn't help.\n\nThen I changed source(srclib/apr/network_io/unix/sendrecv.c) for output debug \nlog,\n and I tried test.\n\nI found errno=11 in debug log. \nSystemcall(read) set 11[EAGAIN] in \"errno\".\n\nI amended source(srclib/apr/network_io/unix/sendrecv.c), then I avoided this \nproblem.\n\nhere is chaged source.\n+------------------------------------------------------------------------------+\n*** sendrecv.c.org      Fri May 30 21:50:39 2003\n--- sendrecv.c          Wed Sep 10 10:21:50 2003\n***************\n*** 109,114 ****\n--- 109,115 ----\n  {\n      apr_ssize_t rv;\n      apr_status_t arv;\n+     int roopCnt;\n\n      if (sock->netmask & APR_INCOMPLETE_READ) {\n          sock->netmask &= ~APR_INCOMPLETE_READ;\n***************\n*** 115,123 ****\n          goto do_select;\n      }\n\n      do {\n          rv = read(sock->socketdes, buf, (*len));\n!     } while (rv == -1 && errno == EINTR);\n\n      if (rv == -1 && (errno == EAGAIN || errno == EWOULDBLOCK) &&\n          apr_is_option_set(sock->netmask, APR_SO_TIMEOUT)) {\n--- 116,129 ----\n          goto do_select;\n      }\n\n+     roopCnt=0;\n      do {\n          rv = read(sock->socketdes, buf, (*len));\n!         if (rv == -1 && (errno == EINTR || errno == EAGAIN)) {\n!             apr_sleep(5000);\n!         }\n!         roopCnt++;\n!     } while ((rv == -1 && (errno == EINTR || errno == EAGAIN)) && roopCnt < \n10);\n\n      if (rv == -1 && (errno == EAGAIN || errno == EWOULDBLOCK) &&\n          apr_is_option_set(sock->netmask, APR_SO_TIMEOUT)) {\n+------------------------------------------------------------------------------+\n", "attachment_id": null, "bug_id": 20785, "id": 44012, "time": "2003-09-11T01:13:19Z", "creator": "katsu-ishii@hitachi-system.co.jp", "creation_time": "2003-09-11T01:13:19Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 20785, "text": "could you please post a unified diff instead (diff -u)", "id": 47457, "time": "2003-11-17T01:31:25Z", "creator": "mads@apache.org", "creation_time": "2003-11-17T01:31:25Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 20785, "attachment_id": null, "text": "This is probably a duplicate of bug 19242 which was fixed in 2.0.48 - please\nreopen if there are still problems in 2.0.48.\n\n*** This bug has been marked as a duplicate of 19242 ***", "id": 47491, "time": "2003-11-17T11:53:11Z", "creator": "jorton@redhat.com", "creation_time": "2003-11-17T11:53:11Z", "is_private": false}]