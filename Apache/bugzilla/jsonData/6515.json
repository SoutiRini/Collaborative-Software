[{"count": 0, "tags": [], "creator": "paul.fu@ssmb.com.au", "text": "In respect to included content, Section 8.3 of the servlet 2.2 specification\nstates: \"The included servlet cannot set headers or call any method that affects\nthe headers of the response. Any attempt to do so should be ignored.\"\n\nIn the FileHandler class of\norg.apache.tomcat.modules.generators.StaticInterceptor, the response headers for\ncontent type, content length and date are always set, even if it is a\nsub-request - the setting of the response headers should be conditional on the\nrequest being a top level request\n\nIn the 3.3.x nightly builds, the following patch needs to be applied.\n--- src/share/org/apache/tomcat/modules/generators/StaticInterceptor.java     \nFri Feb 15 22:23:08 2002\n+++ StaticInterceptor.java      Mon Feb 18 13:36:38 2002\n@@ -324,6 +324,7 @@\n \n        File file = new File( absPath );\n        // If we are included, the If-Modified-Since isn't for us.\n+       // Nor is the setting of response headers\n        if( ! res.isIncluded() ) {\n            MessageBytes imsMB=req.getMimeHeaders().getValue(\"If-Modified-Since\");\n \n@@ -340,20 +341,20 @@\n \n \n            }\n-       }\n-       if( debug>0) log( \"After paranoic checks = \" + absPath);\n+           if( debug>0) log( \"After paranoic checks = \" + absPath);\n \n-        String mimeType=ctx.getMimeMap().getContentTypeFor(absPath);\n+            String mimeType=ctx.getMimeMap().getContentTypeFor(absPath);\n \n-       if (mimeType == null) {\n-           mimeType = \"text/plain\";\n-       }\n-       if( debug>0) log( \"Serving  \" + absPath);\n+           if (mimeType == null) {\n+               mimeType = \"text/plain\";\n+           }\n+           if( debug>0) log( \"Serving  \" + absPath);\n \n-       res.setContentType(mimeType);\n-       res.setContentLength((int)file.length());\n+           res.setContentType(mimeType);\n+           res.setContentLength((int)file.length());\n \n-       setDateHeader(res, \"Last-Modified\", file.lastModified());\n+           setDateHeader(res, \"Last-Modified\", file.lastModified());\n+       }\n \n        FileInputStream in=null;\n        try {\n\n// end patch", "id": 10840, "time": "2002-02-18T02:40:21Z", "bug_id": 6515, "creation_time": "2002-02-18T02:40:21Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 6515, "attachment_id": null, "text": "The problem is more general than just StaticInterceptor.  Checking the code, \nonly the Last-Modified header was getting through.  That hole has now been \nclosed in the CVS HEAD, and will appear in 3.3.1-RC1.", "id": 10841, "time": "2002-02-18T03:46:33Z", "creator": "william.barker@wilshire.com", "creation_time": "2002-02-18T03:46:33Z", "is_private": false}]