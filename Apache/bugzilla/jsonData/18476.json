[{"count": 0, "text": "When copy is used with filtering, the line\nendings get modified from the line endings\nin the file to the native line endings.\nAlso, if a file does not end with a line\nending, one is added by the task.\n\nThis behaviour is tested by unit test:\n.testcases/org.apache.tools.ant.taskdefs#testFilterChain.\n\nI can (sort of) understand the reason when using\nfilter sets, also this behaviour has been present\nsince filterchains were added in 2001, so it should\nnot be changed for filter sets.\n\nHowever for filter chains (and for different\nencodings), I think that the code\nshould retain the line endings.\n\nI am included a patch to do this, tested locally\nbut not with the different encodings.\n\nTo do the same for filtersets would involve\ncoping the algorithm from taskdefs.optional.ReplaceRegExp.", "bug_id": 18476, "attachment_id": null, "id": 34079, "time": "2003-03-28T18:15:34Z", "creator": "peter.reilly@corvil.com", "creation_time": "2003-03-28T18:15:34Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 18476, "attachment_id": 5556, "text": "Created attachment 5556\nModify FileUtils#copyFile to retain line endings when used with filterchains", "id": 34081, "time": "2003-03-28T18:17:54Z", "creator": "peter.reilly@corvil.com", "creation_time": "2003-03-28T18:17:54Z", "is_private": false}, {"count": 2, "tags": [], "creator": "umagesh@apache.org", "attachment_id": null, "id": 35132, "time": "2003-04-14T18:24:27Z", "bug_id": 18476, "creation_time": "2003-04-14T18:24:27Z", "is_private": false, "text": "Peter,\nPlease provide testcases - the tests should fail before the patch is applied\nand must pass afterwards."}, {"count": 3, "tags": [], "bug_id": 18476, "is_private": false, "id": 35150, "attachment_id": null, "creator": "peter.reilly@corvil.com", "creation_time": "2003-04-15T00:03:37Z", "time": "2003-04-15T00:03:37Z", "text": ">>Please provide testcases - the tests should fail before the patch is applied\n>>and must pass afterwards.\n\nMagesh,\n\nOk, - but some of the current tests rely on the current behaviour.\n(I think as well as testcases/org.apache.tools.ant.taskdefs#testFilterChain)\n\nPeter\n"}, {"count": 4, "tags": [], "bug_id": 18476, "attachment_id": null, "text": "It appears like a bug to me even though the existing testcases don't consider\nit so.  We can change the flawed testcases as well, can't we? :-)", "id": 35151, "time": "2003-04-15T00:30:23Z", "creator": "umagesh@apache.org", "creation_time": "2003-04-15T00:30:23Z", "is_private": false}, {"count": 5, "tags": [], "creator": "peter.reilly@corvil.com", "attachment_id": 5850, "id": 35283, "time": "2003-04-15T23:38:57Z", "bug_id": 18476, "creation_time": "2003-04-15T23:38:57Z", "is_private": false, "text": "Created attachment 5850\nmods to unit tests, and patch to fileutils"}, {"count": 6, "tags": [], "creator": "peter.reilly@corvil.com", "attachment_id": 5851, "id": 35284, "time": "2003-04-15T23:41:46Z", "bug_id": 18476, "creation_time": "2003-04-15T23:41:46Z", "is_private": false, "text": "Created attachment 5851\nsrc/testcases/org/apache/tools/ant/filters/NoNewLineTest.java"}, {"count": 7, "tags": [], "creator": "peter.reilly@corvil.com", "attachment_id": null, "id": 35286, "time": "2003-04-16T00:26:58Z", "bug_id": 18476, "creation_time": "2003-04-16T00:26:58Z", "is_private": false, "text": "Ok, got the unit test and patches to current tests\nid 5850:\nThis contains patches against the following files:\nsrc/etc/testcases/filters/build.xml\n   add test target for no end of line adding for copy/filterchain\nsrc/etc/testcases/filters/input/stripjavacomments.test\n   add nl to end of this file so that it matches expected output\n   (magic of cvs will pick the correct nl form for the platform)\nsrc/testcases/org/apache/tools/ant/types/CommandlineJavaTest.java\n   add nl to end of this file so that it matches expected output\nsrc/main/org/apache/tools/ant/util/FileUtils.java\n   reissue of patch\n\nid 5851:\nThe unit test for checking if the copy/filterchain does\nnot add a new line (it uses testNoAddNewLine target in build.xml)\n\nWithout the change to fileutils all the enabled tests pass except nonewlinetest\nWith the change all the enabled tests pass\n\nI have not been able to fix the head/tail unit tests.\nHowever I have a number of observations (testing under linux, after patch)\n\n1) the number of lines for tail is incorrect if the file ends\n   in a new-line\n\ninput: \"line 1\\nline 2\\nline 3\\n\"\ntail l=2 -> just gives \"line3\\n\"\ninput: \"line 1\\nline 2\\nline 3\"\ntail l=2 -> gives \"line 2\\nline 3\"\n\n2) the skip attribute does not work for linux for tail\ninput: \"line 1\\nline 2\\nline 3\\n\"\ntail l=-1 s=1 -> gives \"line 1\\nline 2\\nline \"\ninput: \"line 1\\nline 2\\nline 3\"\ntail l=-1 s=1 -> gives \"line 1\\nline \"\n\n3) the filter does not deal with mac files (the code only looks for \\n).\n\n\nPeter"}, {"count": 8, "tags": [], "creator": "peter.reilly@corvil.com", "is_private": false, "text": "I meant to say for 2) above that\nthis is most likely an off-by-one problem\nwhere the original testing was done on\ndos (where new line is \\r\\n and the \\r\nneeds to be removed with \\n).\nPeter", "id": 35287, "time": "2003-04-16T00:32:28Z", "bug_id": 18476, "creation_time": "2003-04-16T00:32:28Z", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 18476, "attachment_id": 5897, "text": "Created attachment 5897\npatches for head/tail fixes", "id": 35602, "time": "2003-04-18T21:33:30Z", "creator": "peter.reilly@corvil.com", "creation_time": "2003-04-18T21:33:30Z", "is_private": false}, {"count": 10, "text": "I have made a patch to modify head and tail filter to use linetokenizer\nfrom tokenfilter. LineTokenizer tokenizes files using  \\r, \\n or \\r\\n, so\nit should work with dos, unix and mac for head and tail filter.\nMake a change to linetokenizer to optionally include the lineending with\nthe line. Made a similar change to stringtokenizer.\nAlso when head and tail filters where used a filterreader\nwith paramaters, only the first parameter was used.\n\nThe head and tail tests now pass on linux, but I have not tested on\ndos (or mac).\n\nThis patch is in addition to 5850 and 5851.\n\nThe changes are:\ndocs/manual/CoreTypes/filterchain.html:\n   document new attribute to linetokenizer and to stringtokenizer\nsrc/etc/testcases/filters/input/head-tail.test\n   add a new line to end of file\nsrc/main/org/apache/tools/ant/filters/HeadFilter.java\n   use linetokenizer\n   use all parameters\nsrc/main/org/apache/tools/ant/filters/TailFilter.java\n   use linetokenizer\n   use all parameters\nsrc/main/org/apache/tools/ant/filters/TokenFilter.java\n   add includeDelims attribute to linetokenizer and to stringtokenizer\nsrc/testcases/org/apache/tools/ant/filters/HeadTailTest.java\n   add tests to test use of filterreader with head and tail filter\n\nPeter", "bug_id": 18476, "attachment_id": null, "id": 35604, "time": "2003-04-18T21:47:35Z", "creator": "peter.reilly@corvil.com", "creation_time": "2003-04-18T21:47:35Z", "tags": [], "is_private": false}, {"count": 11, "tags": [], "creator": "peter.reilly@corvil.com", "attachment_id": null, "id": 35605, "time": "2003-04-18T21:51:44Z", "bug_id": 18476, "creation_time": "2003-04-18T21:51:44Z", "is_private": false, "text": "Minor errata on 5897:\nI left in a unused member variable in tailfilter - bufferPos.\nPeter"}, {"count": 12, "tags": [], "bug_id": 18476, "attachment_id": 5898, "text": "Created attachment 5898\ntailfilter: remove unused member variable, comment \"linelist\"", "id": 35606, "time": "2003-04-18T21:57:00Z", "creator": "peter.reilly@corvil.com", "creation_time": "2003-04-18T21:57:00Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 18476, "text": "After applying the patch:\nHeadTailTest fails on Windows.  The result file contains Unix style line-\nendings (\\n) instead of \\r\\n and therefore the expected files and the resultant\nfiles don't match.  Haven't dug intto the code yet...", "id": 35713, "attachment_id": null, "creator": "umagesh@apache.org", "creation_time": "2003-04-21T18:01:14Z", "time": "2003-04-21T18:01:14Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 18476, "attachment_id": null, "text": "I have not seen that problem, but remember that I made the\npatch on linux.\nI have now tested on windows but have run out of time today to\nmake a patch on windows (needed to download cvsnt instead of cygwin\ncvs as the latter treated the files as unix, and it takes a long\ntime to cvs ant on a modem).\n\nOn doing this I found another bug in the tests.\nin testHeadTail, the expected outout is now incorrect (\nit should be \"Line  3\\r\\nLine  4\\r\\n\").\n\nAll the tests thus passed, except the last test.\n\nI could not understand why the unix tests passed so I rebooted\ninto linux and found the problem - the file names used in\nthe test where of a different case to the files on the filesystem\n(head-tail.headtail.test as against head-tail.headTail.test). So\non unix the test was comparing two non-existent files!\n\nIf you could apply the patches to all the files except the head-tail.test\nfile, and add a new line using an editor to the head-tail.test, the\nline ending problem (\\n instead of \\r\\n) may be resolved.\n\nAlso I see that I included the wrong patched file (CommandlineJavaTest.java)\nin patch 5850. The file should have been\nsrc/etc/testcases/taskdefs/copy.filterset, and the change was to add a\nnew line to the end of the file. Sorry..., I will make a new patch tomorrow\nfrom windows.\n\nPeter", "id": 35738, "time": "2003-04-22T00:07:32Z", "creator": "peter.reilly@corvil.com", "creation_time": "2003-04-22T00:07:32Z", "is_private": false}, {"count": 15, "tags": [], "creator": "umagesh@apache.org", "is_private": false, "text": "ok - first of all, thanks for the patch.  I have applied it.\n\nI had to modify StripJavaComments.java to retain proper line endings.\n\nI had to disable a couple of tests for now: testFilterReaderHeadLinesSkip and\ntestFilterReaderTailLinesSkip - reason is these targets have not been defined in\nhead-tail.xml.  I also do not have the two 'expected' files:\nhead-tail.filterReaderHeadLinesSkip.test\nhead-tail.filterReaderTailLinesSkip.test\n\n", "id": 35814, "time": "2003-04-22T18:30:46Z", "bug_id": 18476, "creation_time": "2003-04-22T18:30:46Z", "attachment_id": null}, {"count": 16, "tags": [], "bug_id": 18476, "attachment_id": 5966, "text": "Created attachment 5966\npatches for headtail unit tests and stripjavacomments", "id": 35833, "time": "2003-04-22T23:30:28Z", "creator": "peter.reilly@corvil.com", "creation_time": "2003-04-22T23:30:28Z", "is_private": false}, {"count": 17, "tags": [], "bug_id": 18476, "text": "snap!\nI was just about to submit the changes under windows.\n\nI have added a new patch against current cvs to fix\nthe unit tests and to provide an alternative fix for stripjavacomments.\n\nThe patched files are:\nsrc/etc/testcases/filters/head-tail.xml:\n  add the targets for the filterreader tests\nsrc/testcases/org/apache/tools/ant/filters/HeadTailTest.java\n  fix the result and expected filenames, I had them mixed up\n  before, and the test succeeded as two non-existant files were matched\nsrc/main/org/apache/tools/ant/filters/StripJavaComments.java\n  I initially had the same logic as your fix, but realized that\n  the code would not work under mac line endings. Looking at the\n  code, I released that \\r, or \\n where all that is needed to terminate\n  the the \\\\ comment - tested this on windows.\n\nCheers,\n  Peter.\n\nPS. I have had difficulty in getting the following unit tests to work on\nwindows:\n   CopyTest - trancoding test - result not as expected\n   ZipTest  - last test - unable to delete a file\n   XMLCatalogTest - most of the tests fail\n   FileUnitTests - to/from uri and testRemoveLeadingPath\nPeter", "id": 35834, "attachment_id": null, "creator": "peter.reilly@corvil.com", "creation_time": "2003-04-22T23:35:35Z", "time": "2003-04-22T23:35:35Z", "is_private": false}, {"count": 18, "tags": [], "bug_id": 18476, "attachment_id": null, "text": "I hadn't considered Mac.  I will apply your patch tomorrow.  Thanks, once again!", "id": 35836, "time": "2003-04-22T23:40:19Z", "creator": "umagesh@apache.org", "creation_time": "2003-04-22T23:40:19Z", "is_private": false}, {"count": 19, "tags": [], "creator": "umagesh@apache.org", "is_private": false, "text": "Patch applied.  Thanks.", "id": 35904, "time": "2003-04-23T15:31:30Z", "bug_id": 18476, "creation_time": "2003-04-23T15:31:30Z", "attachment_id": null}]