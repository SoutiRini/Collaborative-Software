[{"count": 0, "tags": [], "bug_id": 15077, "attachment_id": null, "text": "Hi\n\nDynamic reloading of a servlet (with or without SingleThreadModel interface) \nleads to a NullPointerException in  \norg.apache.catalina.core.StandardWrapper.allocate(StandardWrapper.java:686). It \nseems that the instancePool stack is not properly constructed when the \nallocated method is call during a reload. The servlet has nothing really \nspecial except that it is a second level derivation of HttpServlet and is \nactivated thru RequestDispatcher.forward().\n\n2002-12-04 17:42:38 StandardContext[/primer]: Le rechargement de ce contexte a \nd\u00e9marr\u00e9\n2002-12-04 17:42:38 MYSERVLET01 : MYSERVLET00: DESTROYED\n2002-12-04 17:42:38 MYSERVLET01 : MYSERVLET00: DESTROYED\n2002-12-04 17:42:38 MYSERVLET00 : MYSERVLET00: DESTROYED\n2002-12-04 17:42:38 MYSERVLET00 : MYSERVLET00: DESTROYED\n2002-12-04 17:42:38 StandardContext[/primer]: Sending application stop events\n2002-12-04 17:42:38 StandardContext[/primer]: Stopping filters\n2002-12-04 17:42:38 WebappLoader[/primer]: Deploying class repositories to work \ndirectory C:\\Program Files\\Apache Group\\Tomcat 4.1.16\n\\work\\Standalone\\localhost\\primer\n2002-12-04 17:42:38 WebappLoader[/primer]: Deploy class files /WEB-INF/classes \nto C:\\IWK\\MyApp\\Primer\\WEB-INF\\classes\n2002-12-04 17:42:38 WebappLoader[/primer]: Deploy JAR /WEB-INF/lib/myapp.jar to \nC:\\IWK\\MyApp\\Primer\\WEB-INF\\lib\\myapp.jar\n2002-12-04 17:42:38 WebappLoader[/primer]: Deploy JAR /WEB-INF/lib/percobol.jar \nto C:\\IWK\\MyApp\\Primer\\WEB-INF\\lib\\percobol.jar\n2002-12-04 17:42:38 WebappLoader[/primer]: Reloading checks are enabled for \nthis Context\n2002-12-04 17:42:38 NamingContextListener[/Standalone/localhost/primer]: \nCreating JNDI naming context\n2002-12-04 17:42:38 NamingContextListener[/Standalone/localhost/primer]:   \nResource parameters for UserTransaction = null\n2002-12-04 17:42:38 StandardContext[/primer]: Configuring application event \nlisteners\n2002-12-04 17:42:38 StandardContext[/primer]: Sending application start events\n2002-12-04 17:42:38 StandardContext[/primer]: Starting filters\n2002-12-04 17:42:38 StandardWrapper[/primer:default]: Chargement du conteneur \n(container) de servlet default\n2002-12-04 17:42:38 StandardWrapper[/primer:invoker]: Chargement du conteneur \n(container) de servlet invoker\n2002-12-04 17:42:38 StandardManager[/primer]: Alimentation de la classe du \ng\u00e9n\u00e9rateur de nombre al\u00e9atoire java.security.SecureRandom\n2002-12-04 17:42:38 StandardManager[/primer]: L'alimentation du g\u00e9n\u00e9rateur de \nnombre al\u00e9atoire est termin\u00e9\n2002-12-04 17:42:38 StandardContext[/primer]: Le rechargement de ce contexte \nest termin\u00e9\n2002-12-04 17:42:39 StandardContext[/primer]: Mapping contextPath='/primer' \nwith requestURI='/primer/kix' and relativeURI='/kix'\n2002-12-04 17:42:39 StandardContext[/primer]:   Trying exact match\n2002-12-04 17:42:39 StandardContext[/primer]:  Mapped to servlet 'MyApp \nExecutive' with servlet path '/kix' and path info 'null' and update=true\n2002-12-04 17:42:39 StandardWrapperValve[MyApp Executive]: Exception lors de \nlallocation pour la servlet {0}\njava.lang.NullPointerException\n\tat org.apache.catalina.core.StandardWrapper.allocate\n(StandardWrapper.java:686)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke\n(StandardWrapperValve.java:214)\n\tat \norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNex\nt(StandardPipeline.java:643)\n\tat org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:480)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat org.apache.catalina.core.StandardContextValve.invoke\n(StandardContextValve.java:191)\n\tat \norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNex\nt(StandardPipeline.java:643)\n\tat org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:480)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat org.apache.catalina.core.StandardContext.invoke\n(StandardContext.java:2407)\n\tat org.apache.catalina.core.StandardHostValve.invoke\n(StandardHostValve.java:180)\n\tat \norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNex\nt(StandardPipeline.java:643)\n\tat org.apache.catalina.valves.ErrorDispatcherValve.invoke\n(ErrorDispatcherValve.java:170)\n\tat \norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNex\nt(StandardPipeline.java:641)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke\n(ErrorReportValve.java:172)\n\tat \norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNex\nt(StandardPipeline.java:641)\n\tat org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:480)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat org.apache.catalina.core.StandardEngineValve.invoke\n(StandardEngineValve.java:174)\n\tat \norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNex\nt(StandardPipeline.java:643)\n\tat org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:480)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat org.apache.coyote.tomcat4.CoyoteAdapter.service\n(CoyoteAdapter.java:223)\n\tat org.apache.coyote.http11.Http11Processor.process\n(Http11Processor.java:431)\n\tat \norg.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.processConnectio\nn(Http11Protocol.java:386)\n\tat org.apache.tomcat.util.net.TcpWorkerThread.runIt\n(PoolTcpEndpoint.java:537)\n\tat org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run\n(ThreadPool.java:533)\n\tat java.lang.Thread.run(Thread.java:536)", "id": 27416, "time": "2002-12-04T17:28:35Z", "creator": "francis.andre@easynet.fr", "creation_time": "2002-12-04T17:28:35Z", "is_private": false}, {"count": 1, "tags": [], "text": "This is a cosmetic issue. I've modified it, and servlets should now return that\nthey're not available when accessed during a webapp reload.", "is_private": false, "bug_id": 15077, "id": 27464, "time": "2002-12-05T13:35:28Z", "creator": "remm@apache.org", "creation_time": "2002-12-05T13:35:28Z", "attachment_id": null}, {"count": 2, "tags": [], "text": "Hi\n\nI had working on this issue some days before I checked your answer and I found \na bypass. I din't really check if it could be useful or if it is full correct, \nbut it works for me.\n\nAnyway, here is the fix which consists in resetting the singleThreadModel to \nfalse when unloading the instance.\n\nRegards\n\n\nIndex: StandardWrapper.java\n===================================================================\nRCS file: /home/cvspublic/jakarta-tomcat-\n4.0/catalina/src/share/org/apache/catalina/core/StandardWrapper.java,v\nretrieving revision 1.44\ndiff -u -r1.44 StandardWrapper.java\n--- StandardWrapper.java\t10 Dec 2002 12:47:05 -0000\t1.44\n+++ StandardWrapper.java\t11 Dec 2002 17:14:50 -0000\n@@ -1176,6 +1145,7 @@\n             nInstances = 0;\n         }\n \n+\t\tsingleThreadModel = false;\n         unloading = false;\n         fireContainerEvent(\"unload\", this);\n \n", "attachment_id": null, "bug_id": 15077, "id": 27669, "time": "2002-12-11T17:31:36Z", "creator": "francis.andre@easynet.fr", "creation_time": "2002-12-11T17:31:36Z", "is_private": false}, {"count": 3, "tags": [], "creator": "francis.andre@e-xmlmedia.fr", "attachment_id": null, "id": 30901, "time": "2003-02-07T15:19:53Z", "bug_id": 15077, "creation_time": "2003-02-07T15:19:53Z", "is_private": false, "text": "Hi\n\nI have tried the Apache Tomcat/4.1.18-LE-jdk14 and the problem is still \nhappening. I have applied the patch I suggested you in my previous comment and \nthe reloading is working fine.\n\nregards\n\n\n2003-02-07 15:59:37 KIX Executive: >>>> DESTROY\n2003-02-07 15:59:38 KIX Executive: <<<< DESTROY\n2003-02-07 15:59:38 WebappLoader[/primer]: Deploying class repositories to work \ndirectory C:\\Program Files\\Apache Group\\Tomcat 4.1.18\n\\work\\Standalone\\localhost\\primer\n2003-02-07 15:59:38 WebappLoader[/primer]: Deploy class files /WEB-INF/classes \nto C:\\IWK\\KIX\\KIX\\WEB-INF\\classes\n2003-02-07 15:59:38 WebappLoader[/primer]: Deploy JAR /WEB-INF/lib/percobol.jar \nto C:\\IWK\\KIX\\KIX\\WEB-INF\\lib\\percobol.jar\n2003-02-07 15:59:38 WebappLoader[/primer]: Reloading checks are enabled for \nthis Context\n2003-02-07 15:59:38 StandardWrapper[/primer:default]: Chargement du conteneur \n(container) de servlet default\n2003-02-07 15:59:38 StandardWrapper[/primer:invoker]: Chargement du conteneur \n(container) de servlet invoker\n2003-02-07 15:59:38 StandardManager[/primer]: Alimentation de la classe du \ng\u00e9n\u00e9rateur de nombre al\u00e9atoire java.security.SecureRandom\n2003-02-07 15:59:38 StandardManager[/primer]: L'alimentation du g\u00e9n\u00e9rateur de \nnombre al\u00e9atoire est termin\u00e9\n2003-02-07 15:59:38 StandardContext[/primer]: Le rechargement de ce contexte \nest termin\u00e9\n2003-02-07 16:00:37 KIX Executive: >>>> INIT\n2003-02-07 16:00:37 KIX Executive: MAPSET :WEB-INF\\maps\n2003-02-07 16:00:37 KIX Executive: VSAM_HOME :C:/tmp/database\n2003-02-07 16:00:38 KIX Executive: <<<< INIT\n2003-02-07 16:00:39 KIX Executive: ID 100D70A3D4C1122B6C63C584AAE528FA, new: \ntrue\n2003-02-07 16:00:39 KIX Executive: Created: Fri Feb 07 16:00:38 CET 2003\n2003-02-07 16:00:39 KIX Executive: Last Accessed: Fri Feb 07 16:00:38 CET 2003\n2003-02-07 16:00:39 KIX Executive: TRANSID :null\n2003-02-07 16:00:39 KIX Executive: AID     :ENTER\n2003-02-07 16:00:39 KIX Executive: COMMAND :menu\n2003-02-07 16:00:39 KIX Executive: PROGRAM : INVMENU\n2003-02-07 16:00:39 ApplicationDispatcher[/primer] Exception d'allocation pour \nla servlet INVMENU Kixlet\njava.lang.NullPointerException\n\tat org.apache.catalina.core.StandardWrapper.allocate\n(StandardWrapper.java:686)\n\tat org.apache.catalina.core.ApplicationDispatcher.invoke\n(ApplicationDispatcher.java:653)\n\tat org.apache.catalina.core.ApplicationDispatcher.doForward\n(ApplicationDispatcher.java:432)\n\tat org.apache.catalina.core.ApplicationDispatcher.forward\n(ApplicationDispatcher.java:356)\n\tat com.pac.kixlet.KIXExecutive.doPost(KIXExecutive.java:306)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:760)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:853)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter\n(ApplicationFilterChain.java:247)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter\n(ApplicationFilterChain.java:193)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke\n(StandardWrapperValve.java:260)\n\tat \norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNex\nt(StandardPipeline.java:643)\n\tat org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:480)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat org.apache.catalina.core.StandardContextValve.invoke\n(StandardContextValve.java:191)\n\tat \norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNex\nt(StandardPipeline.java:643)\n\tat org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:480)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat org.apache.catalina.core.StandardContext.invoke\n(StandardContext.java:2407)\n\tat org.apache.catalina.core.StandardHostValve.invoke\n(StandardHostValve.java:180)\n\tat \norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNex\nt(StandardPipeline.java:643)\n\tat org.apache.catalina.valves.ErrorDispatcherValve.invoke\n(ErrorDispatcherValve.java:170)\n\tat \norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNex\nt(StandardPipeline.java:641)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke\n(ErrorReportValve.java:172)\n\tat \norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNex\nt(StandardPipeline.java:641)\n\tat org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:480)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat org.apache.catalina.core.StandardEngineValve.invoke\n(StandardEngineValve.java:174)\n\tat \norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNex\nt(StandardPipeline.java:643)\n\tat org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:480)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat org.apache.coyote.tomcat4.CoyoteAdapter.service\n(CoyoteAdapter.java:223)\n\tat org.apache.coyote.http11.Http11Processor.process\n(Http11Processor.java:432)\n\tat \norg.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.processConnectio\nn(Http11Protocol.java:386)\n\tat org.apache.tomcat.util.net.TcpWorkerThread.runIt\n(PoolTcpEndpoint.java:534)\n\tat org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run\n(ThreadPool.java:530)\n\tat java.lang.Thread.run(Thread.java:536)\n"}, {"count": 4, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "id": 36319, "time": "2003-04-29T20:35:23Z", "bug_id": 15077, "creation_time": "2003-04-29T20:35:23Z", "is_private": false, "text": "The fix will be in 4.1.25. I found that your patch (which I had forgotten; \nmaybe I thought it could be risky originally, and chose not to apply it) is \nidentical to my fix.\n\n*** This bug has been marked as a duplicate of 17292 ***"}]