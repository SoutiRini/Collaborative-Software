[{"count": 0, "tags": [], "bug_id": 45507, "attachment_id": null, "text": "On a stock build of apache, No modules loaded,\nrequest for a pdf file multiple times, once in a while\nthe response does not contain response headers.\n\nNote that the same behavior is visible on Apache/2.2.8 also (did not check 2.2.9)\n\nHere is what I did,\n|uname -a\nSunOS agneyam 5.11 snv_84 sun4u sparc SUNW,Sun-Blade-1000\n|file htdocs/test.pdf\nhtdocs/test.pdf:    Adobe Portable Document Format (PDF)  v1.2\n|(echo \"GET /test.pdf HTTP/1.0\\n\\n\";sleep5)|telnet 0 8080 > o\n|cat o\nTrying 0.0.0.0...\nConnected to 0.\nEscape character is '^]'.\nGET /test.pdf HTTP/1.0\n\n\u00db\u00df\u00de~}>^#\u00f5\u00a5\u00e6cuV\u00ea\u00e3\n\n*Note the absence of headers*.\nThis happens only once in 10 times.\n\nOther times, it gives me back the correct response.\n\n|(echo \"GET /test.pdf HTTP/1.0\\n\\n\";sleep 5) | telnet 0 8080\n                        \nTrying 0.0.0.0...\nConnected to 0.\nEscape character is '^]'.\nHTTP/1.1 200 OK\nDate: Wed, 30 Jul 2008 17:08:57 GMT\nServer: Apache/2.3.0-dev (Unix)\nLast-Modified: Wed, 30 Jul 2008 17:01:10 GMT\nETag: \"616bb-139-45340b40cdf90\"\nAccept-Ranges: bytes\nContent-Length: 313\nConnection: close\nContent-Type: application/pdf\n\n\u00db\u00df\u00de~}>^#\u00f5\u00a5\u00e6cuV\u00ea\u00e3\n                \u00efD~\n&\u00a4<\u00bd\u00ae\u00f6\u00b9@j\u00cb(\u00dfo\u00dc\u00a9h\u00d7SZ;\u00f0\u00ca2\u00eb=_?[\u00c9\u00cc\nConnection to 0 closed by foreign host.\n\n\n|bin/httpd -V\nServer version: Apache/2.3.0-dev (Unix)\nServer built:   Jul 30 2008 21:26:59\nServer's Module Magic Number: 20080722:0\nServer loaded:  APR 1.4.0-dev, APR-UTIL 1.4.0-dev\nCompiled using: APR 1.4.0-dev, APR-UTIL 1.4.0-dev\nArchitecture:   32-bit\nServer MPM:     Prefork\n  threaded:     no\n    forked:     yes (variable process count)\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_FCNTL_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"/space/store/apache.30.Jul/install\"\n -D SUEXEC_BIN=\"/space/store/apache.30.Jul/install/bin/suexec\"\n -D DEFAULT_PIDLOG=\"logs/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_LOCKFILE=\"logs/accept.lock\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"\n|cat logs/error_log\n[Wed Jul 30 22:26:46 2008] [notice] Apache/2.3.0-dev (Unix) configured -- resuming normal operations\n[Wed Jul 30 22:26:46 2008] [info] Server built: Jul 30 2008 21:26:59\n[Wed Jul 30 22:26:46 2008] [debug] prefork.c(960): AcceptMutex: fcntl (default: fcntl)\n\nAlso stock httpd.conf with only these changes from what the make install provided.\n\n|diff -u conf/httpd.conf.orig conf/httpd.conf\n--- conf/httpd.conf.orig        Wed Jul 30 22:35:07 2008\n+++ conf/httpd.conf     Wed Jul 30 22:30:46 2008\n@@ -37,7 +37,7 @@\n # prevent Apache from glomming onto all bound IP addresses.\n #\n #Listen 12.34.56.78:80\n-Listen 80\n+Listen 8080\n \n #\n # Dynamic Shared Object (DSO) Support\n@@ -94,7 +94,7 @@\n #\n # If your host doesn't have a registered DNS name, enter its IP address here.\n #\n-#ServerName www.example.com:80\n+ServerName agneyam\n \n #\n # DocumentRoot: The directory out of which you will serve your\n\nThe same does not happen at all when using a text file instead.", "id": 119127, "time": "2008-07-30T10:23:22Z", "creator": "rahul.g.nair@gmail.com", "creation_time": "2008-07-30T10:23:22Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 45507, "text": "truss :\n|truss -p 20322\naccept(4, 0xFFBFE530, 0xFFBFE51C, SOV_DEFAULT) (sleeping...)\naccept(4, 0xFFBFE530, 0xFFBFE51C, SOV_DEFAULT)  = 12\ngetsockname(12, 0x001ADEF0, 0x001ADEDC, SOV_DEFAULT) = 0\nfcntl(12, F_GETFL)                              = 2\nfcntl(12, F_SETFL, FWRITE|FNONBLOCK)            = 0\nread(12, 0x001B1E70, 8000)                      Err#11 EAGAIN\npollsys(0xFFBFE104, 1, 0xFFBFE080, 0x00000000)  = 1\nread(12, \" G E T   / t e s t . p d\".., 8000)    = 28\nstat64(\"/space/store/apache.30.Jul/install/htdocs/test.pdf\", 0xFFBFE138) = 0\ngetpid()                                        = 20322 [20321]\nopen(\"/space/store/apache.30.Jul/install/htdocs/test.pdf\", O_RDONLY|O_LARGEFILE) = 13\nsetsockopt(12, tcp, TCP_CORK, 0xFFBFE294, 4, SOV_DEFAULT) = 0\nwritev(12, 0xFFBFE2BC, 1)                       = 261\nsendfilev64(1, 12, 0x001AE7D0, 1, 0xFFBFE1A0)   = 313\nwrite(9, \" 1 2 7 . 0 . 0 . 1   -  \".., 76)      = 76\nshutdown(12, SHUT_WR, SOV_DEFAULT)              = 0\npollsys(0xFFBFE3B4, 1, 0xFFBFE330, 0x00000000)  = 1\nread(12, 0xFFBFE4A8, 512)                       = 0\nclose(12)                                       = 0\nread(7, 0xFFBFE6A3, 1)                          Err#11 EAGAIN\nclose(13)                                       = 0\naccept(4, 0xFFBFE530, 0xFFBFE51C, SOV_DEFAULT) (sleeping...)\n", "id": 119137, "attachment_id": null, "creator": "rahul.g.nair@gmail.com", "creation_time": "2008-07-30T11:57:35Z", "time": "2008-07-30T11:57:35Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 45507, "text": "(In reply to comment #1)\n\nIs this a truss of a case where no headers are sent?\n\n> truss :\n> |truss -p 20322\n> accept(4, 0xFFBFE530, 0xFFBFE51C, SOV_DEFAULT) (sleeping...)\n> accept(4, 0xFFBFE530, 0xFFBFE51C, SOV_DEFAULT)  = 12\n> getsockname(12, 0x001ADEF0, 0x001ADEDC, SOV_DEFAULT) = 0\n> fcntl(12, F_GETFL)                              = 2\n> fcntl(12, F_SETFL, FWRITE|FNONBLOCK)            = 0\n> read(12, 0x001B1E70, 8000)                      Err#11 EAGAIN\n> pollsys(0xFFBFE104, 1, 0xFFBFE080, 0x00000000)  = 1\n> read(12, \" G E T   / t e s t . p d\".., 8000)    = 28\n> stat64(\"/space/store/apache.30.Jul/install/htdocs/test.pdf\", 0xFFBFE138) = 0\n> getpid()                                        = 20322 [20321]\n> open(\"/space/store/apache.30.Jul/install/htdocs/test.pdf\",\n> O_RDONLY|O_LARGEFILE) = 13\n> setsockopt(12, tcp, TCP_CORK, 0xFFBFE294, 4, SOV_DEFAULT) = 0\n> writev(12, 0xFFBFE2BC, 1)                       = 261\n> sendfilev64(1, 12, 0x001AE7D0, 1, 0xFFBFE1A0)   = 313\n> write(9, \" 1 2 7 . 0 . 0 . 1   -  \".., 76)      = 76\n> shutdown(12, SHUT_WR, SOV_DEFAULT)              = 0\n> pollsys(0xFFBFE3B4, 1, 0xFFBFE330, 0x00000000)  = 1\n> read(12, 0xFFBFE4A8, 512)                       = 0\n> close(12)                                       = 0\n> read(7, 0xFFBFE6A3, 1)                          Err#11 EAGAIN\n> close(13)                                       = 0\n> accept(4, 0xFFBFE530, 0xFFBFE51C, SOV_DEFAULT) (sleeping...)\n> \n\nFrom a first glance looks good to me. Maybe some issue with writev and sendfilev64 not working well together or could this be caused by a bug with TCP_CORK? What version of Solaris are you using? So far I know TCP_CORK only on the Linux platform.\n", "id": 119140, "time": "2008-07-30T12:31:00Z", "creator": "rpluem@apache.org", "creation_time": "2008-07-30T12:31:00Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "rahul.g.nair@gmail.com", "attachment_id": null, "text": "Yes, it is the case when no headers are sent,\n\nSolaris 11 sparc\n|uname -a\nSunOS agneyam 5.11 snv_84 sun4u sparc SUNW,Sun-Blade-1000\n", "id": 119141, "time": "2008-07-30T12:44:42Z", "bug_id": 45507, "creation_time": "2008-07-30T12:44:42Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 45507, "attachment_id": null, "text": "(In reply to comment #1)\n> truss :\n> |truss -p 20322\n> accept(4, 0xFFBFE530, 0xFFBFE51C, SOV_DEFAULT) (sleeping...)\n> accept(4, 0xFFBFE530, 0xFFBFE51C, SOV_DEFAULT)  = 12\n> getsockname(12, 0x001ADEF0, 0x001ADEDC, SOV_DEFAULT) = 0\n> fcntl(12, F_GETFL)                              = 2\n> fcntl(12, F_SETFL, FWRITE|FNONBLOCK)            = 0\n> read(12, 0x001B1E70, 8000)                      Err#11 EAGAIN\n> pollsys(0xFFBFE104, 1, 0xFFBFE080, 0x00000000)  = 1\n> read(12, \" G E T   / t e s t . p d\".., 8000)    = 28\n> stat64(\"/space/store/apache.30.Jul/install/htdocs/test.pdf\", 0xFFBFE138) = 0\n> getpid()                                        = 20322 [20321]\n> open(\"/space/store/apache.30.Jul/install/htdocs/test.pdf\",\n> O_RDONLY|O_LARGEFILE) = 13\n> setsockopt(12, tcp, TCP_CORK, 0xFFBFE294, 4, SOV_DEFAULT) = 0\n> writev(12, 0xFFBFE2BC, 1)                       = 261\n\nThis is exactly the size of the headers. So writev says that it wrote the headers to the network. I suspect an OS problem somewhere between TCP_CORK, writev and sendfilev64. Can you please test this on older Solaris versions\n(8, 9, 10) if available and see if this is reproducible there? \n\n> sendfilev64(1, 12, 0x001AE7D0, 1, 0xFFBFE1A0)   = 313\n", "id": 119146, "time": "2008-07-30T13:31:33Z", "creator": "rpluem@apache.org", "creation_time": "2008-07-30T13:31:33Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 45507, "attachment_id": 22333, "text": "Created attachment 22333\na binary file that reproduces the bug\n\nThe bug seems to be connected with the size of the file\nin that it is reproducible in Solaris 11 (i86 & sparc) And Linux (ubuntu)\nwith a small size file but not with a large one.\n\n|du  htdocs/test.pdf                                                                                                                       \n2 htdocs/test.pdf\n\n\n|uname -a\nLinux vaishnavam 2.6.24-19-generic #1 SMP Wed Jun 18 14:43:41 UTC 2008 i686 GNU/Linux\n|./bin/httpd -V\nServer version: Apache/2.3.0-dev (Unix)\nServer built:   Jul 22 2008 15:05:28\nServer's Module Magic Number: 20080528:1\nServer loaded:  APR 1.4.0-dev, APR-UTIL 1.4.0-dev\nCompiled using: APR 1.4.0-dev, APR-UTIL 1.4.0-dev\nArchitecture:   32-bit\nServer MPM:     Prefork\n  threaded:     no\n    forked:     yes (variable process count)\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"/space/store/apache.22.Jul/install\"\n -D SUEXEC_BIN=\"/space/store/apache.22.Jul/install/bin/suexec\"\n -D DEFAULT_PIDLOG=\"logs/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_LOCKFILE=\"logs/accept.lock\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"\n|(echo \"GET /test.pdf HTTP/1.0\\n\\n\";sleep 5)|telnet 0 8080\nTrying 0.0.0.0...\nConnected to 0.\nEscape character is '^]'.\n\ufffd\ufffd}>^#\ufffd\ufffd\ufffd\ufffduV\ufffd\n             \ufffd\ufffd~\ufffd&\ufffd<\ufffd\ufffd\ufffd\ufffd\ufffdj\u02c7(\u07d5o\u0729\ufffdh\ufffdZ;\ufffd2\ufffd_\ufffd?[\u0247\ufffd\ufffd\nConnection closed by foreign host.\n\nA little more info:\n================================================================\nI commented these out in apr, cleaned,rebuilt and ran again,\n\n./include/arch/unix/apr_private.h:/* Define if TCP_CORK is defined in netinet/tcp.h */\n./include/arch/unix/apr_private.h:/*#define HAVE_TCP_CORK 1*/\n./include/arch/unix/apr_private.h:/* Define if TCP_NODELAY and TCP_CORK can be enabled at the same time */\n./include/apr.h:/*#define APR_TCP_NOPUSH_FLAG       TCP_CORK*/\n\nit is reproducible again.\n\n|truss -p 16007\naccept(4, 0xFFBFE530, 0xFFBFE51C, SOV_DEFAULT) (sleeping...)\naccept(4, 0xFFBFE530, 0xFFBFE51C, SOV_DEFAULT)  = 12\ngetsockname(12, 0x001ADEF0, 0x001ADEDC, SOV_DEFAULT) = 0\nfcntl(12, F_GETFL)                              = 2\nfcntl(12, F_SETFL, FWRITE|FNONBLOCK)            = 0\nread(12, 0x001B1E70, 8000)                      Err#11 EAGAIN\npollsys(0xFFBFE104, 1, 0xFFBFE080, 0x00000000)  = 1\nread(12, \" G E T   / t e s t . p d\".., 8000)    = 28\nstat64(\"/space/store/apache.30.Jul/install/htdocs/test.pdf\", 0xFFBFE138) = 0\ngetpid()                                        = 16007 [16006]\nopen(\"/space/store/apache.30.Jul/install/htdocs/test.pdf\", O_RDONLY|O_LARGEFILE) = 13\nwritev(12, 0xFFBFE2BC, 1)                       = 261\nsendfilev64(1, 12, 0x001AE7D0, 1, 0xFFBFE1A0)   = 313\nwrite(9, \" 1 2 7 . 0 . 0 . 1   -  \".., 76)      = 76\nshutdown(12, SHUT_WR, SOV_DEFAULT)              = 0\npollsys(0xFFBFE3B4, 1, 0xFFBFE330, 0x00000000)  = 1\nread(12, 0xFFBFE4A8, 512)                       = 0\nclose(12)                                       = 0\nread(7, 0xFFBFE6A3, 1)                          Err#11 EAGAIN\nclose(13)                                       = 0\naccept(4, 0xFFBFE530, 0xFFBFE51C, SOV_DEFAULT) (sleeping...)\n\n(I am uploading a small test.pdf which reproduces this,\nThe pdf is not a valid pdf (truncated to small length\nit to make it reproduce the bug)\n)", "id": 119147, "time": "2008-07-30T13:32:07Z", "creator": "rahul.g.nair@gmail.com", "creation_time": "2008-07-30T13:32:07Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 45507, "attachment_id": null, "text": "Please try to connect via an ethernet and try if a pdf file with size 1199 fails and if a pdf file with 1200 bytes or larger succeeds. If this is not the case please check if the behaviour flips over between 1459 and 1460 bytes file size.", "id": 119155, "time": "2008-07-30T14:16:34Z", "creator": "rpluem@apache.org", "creation_time": "2008-07-30T14:16:34Z", "is_private": false}, {"count": 7, "attachment_id": null, "creator": "rahul.g.nair@gmail.com", "text": "Really sorry for the spurious alert, It is not a bug with apache,\n\nThe binary test file that I was using contained two \nchars 0xff 0xf2, this is an escape char for telnet. which cut off\nall data before that point.\n\nThus though it received all headers, it did not print them when it received\n0xff 0xf2\n\n\nhttp://lists.freebsd.org/pipermail/freebsd-bugs/2003-May/000725.html\n\n", "id": 119181, "time": "2008-07-31T06:32:16Z", "bug_id": 45507, "creation_time": "2008-07-31T06:32:16Z", "tags": [], "is_private": false}]