[{"count": 0, "tags": [], "bug_id": 55972, "attachment_id": null, "is_private": false, "id": 172154, "time": "2014-01-07T21:09:18Z", "creator": "mike.rumph@oracle.com", "creation_time": "2014-01-07T21:09:18Z", "text": "In the remoteip_modify_request() function in mod_remoteip.c the wrong IP addresses are used to populate the proxy_ips field.\nreq->useragent_ip should be used instead of c->client_ip."}, {"count": 1, "tags": [], "creator": "mike.rumph@oracle.com", "attachment_id": 31180, "id": 172157, "time": "2014-01-07T21:27:13Z", "bug_id": 55972, "creation_time": "2014-01-07T21:27:13Z", "is_private": false, "text": "Created attachment 31180\nPatch to populate the proxy_ips field with correct IP addresses.\n\nI have attached a patch against mod_remoteip.c in httpd trunk.\nThis patch will populate the proxy_ips field with correct IP addresses.\nThis test gives us a long list to view in the simplest way.\n\nThe patch can be verified with the following setup which are variations from bug 55635:\n\nLogFormat \"%h %a %{c}a xf=\\\"%{X-Forwarded-For}i\\\" %l %u %t \\\"%r\\\" %>s %b\" forward\nCustomLog \"logs/access_log\" forward\nLogLevel debug mod_remoteip.c:trace1\n\n<Location /test>\n        Order Deny,Allow\n        Deny from all\n        Allow from localhost 127.0.0.1 1.1.1.1\n</Location>\n\nRemoteIPHeader X-Forwarded-For\n\nDo not include any RemoteIPInternalProxy, RemoteIPInternalProxyList, RemoteIPTrustedProxy or RemoteIPTrustProxyList.\nThis will cause mod_remoteip to take the default of treating the client IP and all IP addresses in X-Forwarded-For as external trusted proxies.\n\n- $ curl -v -H \"X-Forwarded-For: 1.1.1.2, 1.1.1.1, 87.245.198.54, 87.250.250.203\" http://10.1.2.3:8080/test/ \n\n- $ tail logs/access_log\nmy_host 1.1.1.2 10.1.2.3 xf=\"-\" - - [07/Jan/2014:11:03:54 -0800] \"GET /test/ HTTP/1.1\" 403 207\n\n- $ tail logs/error_log\n\nSimilar records to the following will be seen in the error log.\n\nBefore the fix:\n[Tue Jan 07 11:03:54.053043 2014] [remoteip:trace1] [pid 3456:tid 1108416832] mod_remoteip.c(404): [client 1.1.1.2:59017] Using 1.1.1.2 as client's IP by proxies 10.1.2.3, 10.1.2.3, 10.1.2.3, 10.1.2.3\n\n\nAfter the fix:\n[Tue Jan 07 12:38:22.488850 2014] [remoteip:trace1] [pid 20135:tid 1107126592] mod_remoteip.c(405): [client 1.1.1.2:52291] Using 1.1.1.2 as client's IP by proxies 10.1.2.3, 87.250.250.203, 87.245.198.54, 1.1.1.1"}, {"count": 2, "tags": [], "bug_id": 55972, "attachment_id": null, "is_private": false, "id": 172889, "time": "2014-02-04T21:04:30Z", "creator": "mike.rumph@oracle.com", "creation_time": "2014-02-04T21:04:30Z", "text": "Committed to trunk in r1564475 and proposed for httpd 2.4.x."}, {"count": 3, "tags": [], "creator": "mike.rumph@oracle.com", "is_private": false, "id": 173307, "attachment_id": null, "bug_id": 55972, "creation_time": "2014-02-17T16:56:55Z", "time": "2014-02-17T16:56:55Z", "text": "Backported to httpd 2.4.8 by r1569003."}]