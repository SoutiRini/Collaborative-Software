[{"count": 0, "tags": [], "text": "Created attachment 21986\nSource code for JMeter SMTP-Sampler\n\nFor a project, we have extended an existing implementation of a JMeter SMTP-Sampler (initially coded by Luca Maragnani, found at http://www.beolink.org/index/jmeter-plug-in). The sampler has meanwhile the following features: \n- SSL / StartTLS / \"Plaintext\" - sending-support for SMTP\n- Multiple recipients, including \"To\", \"CC\" and \"BCC\"\n- Multiple attachments\n- and more\n\nWe furthermore think about an option to be able to send an \".eml\"-file via the sampler, but this could at most be an additional feature for a future version. \n\nAdditionally, we have not implemented any cryptographic functionality by now. It would certainly be a valuable enhancement to implement e.g. BouncyCastle X.509 or PGP-support. \n\nPLEASE NOTE: \n- Do not use this sampler to send mass e-mails!\n- Have a look at the license-file (can be found under /src/)", "is_private": false, "bug_id": 45053, "id": 116871, "time": "2008-05-21T00:54:46Z", "creator": "michael.tschannen@zhaw.ch", "creation_time": "2008-05-21T00:54:46Z", "attachment_id": 21986}, {"count": 1, "tags": [], "creator": "michael.tschannen@zhaw.ch", "attachment_id": null, "text": "Please don't get frightened because of the \"license-note\" above - naturally, we are developing all our samplers (including this one) under apache license as all JMeter-parts!", "id": 116874, "time": "2008-05-21T01:35:24Z", "bug_id": 45053, "creation_time": "2008-05-21T01:35:24Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 45053, "attachment_id": 22055, "id": 117247, "time": "2008-06-02T06:12:53Z", "creator": "haeberling@privasphere.com", "creation_time": "2008-06-02T06:12:53Z", "is_private": false, "text": "Created attachment 22055\nSource code for JMeter SMTP-Sampler (with enhancements)\n\nSome enhancements and fixes for the SMTP-Sampler code:\n\n- adds support for sending eml files\n- adds a log of the smtp session to the sampler result\n- jmeter.smtpsampler.protocol.SendMailCommand.execute() used PipedInputStreams in a way that could lead to a deadlock. This was fixed."}, {"count": 3, "tags": [], "creator": "hauser@acm.org", "text": "... and no longer only compiles/runs with java6", "id": 117248, "time": "2008-06-02T06:15:48Z", "bug_id": 45053, "creation_time": "2008-06-02T06:15:48Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "hauser@acm.org", "attachment_id": null, "text": "see also bug 25355", "id": 119489, "time": "2008-08-06T05:22:27Z", "bug_id": 45053, "creation_time": "2008-08-06T05:22:27Z", "is_private": false}, {"count": 5, "tags": [], "creator": "moreira@privasphere.com", "attachment_id": null, "is_private": false, "id": 137005, "time": "2010-05-21T04:53:43Z", "bug_id": 45053, "creation_time": "2010-05-21T04:53:43Z", "text": "There has been no comments on this Bug for almost 2 years. I would like to see the proposed changes in JMeter.\n\nI have tested it with SVN Head revision 946591 and it works as expected. I have moved the packages to a path similar to the Mail Reader Sampler classes, so it should be simple to add this to the current version of JMeter."}, {"count": 6, "attachment_id": 25469, "creator": "moreira@privasphere.com", "text": "Created attachment 25469\nSource code for SMTP sampler", "id": 137006, "time": "2010-05-21T04:57:00Z", "bug_id": 45053, "creation_time": "2010-05-21T04:57:00Z", "tags": [], "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 45053, "is_private": false, "count": 7, "id": 137007, "time": "2010-05-21T05:12:39Z", "creator": "sebb@apache.org", "creation_time": "2010-05-21T05:12:39Z", "text": "There is a slight problem with the file headers - they contain Copyright lines which need to be removed/moved:\n\nhttp://www.apache.org/legal/src-headers.html#header-existingcopyright\n\nSo we need permission from Luca Maragnani & Michael Tschannen (or their agents) to change the source files accordingly."}, {"count": 8, "tags": [], "text": "Permission granted (I don't work on this project anymore but feel free to use my part of the source code), if you need to remove the copyright statement please do so.", "is_private": false, "id": 137008, "creator": "michael.tschannen@zhaw.ch", "time": "2010-05-21T05:20:20Z", "bug_id": 45053, "creation_time": "2010-05-21T05:20:20Z", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 45053, "text": "E-mail correspondence from Luca Maragnani:\n\n> From:  \tLuca Maragnani (luca.maragnani@gmail.com)\n> Sent: \tFriday, October 02, 2009 7:21:14 AM\n>\n> Hi Kevin,\n>\n> I'm glad that the plugin is of your interest: certainly you can remove the\ncopyright statement in order to include the code into jmeter source tree.\n>\n> Bye,\n> Luca", "id": 137010, "time": "2010-05-21T05:56:13Z", "creator": "moreira@privasphere.com", "creation_time": "2010-05-21T05:56:13Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "text": "Thanks for the very prompt responses  - it will take a bit longer (!) to add the code to SVN and test it, but hopefully there will be some progress next week.", "attachment_id": null, "bug_id": 45053, "id": 137012, "time": "2010-05-21T06:02:59Z", "creator": "sebb@apache.org", "creation_time": "2010-05-21T06:02:59Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 45053, "text": "Created attachment 25470\nSource code for SMTP sampler witho Apache license\n\nI have removed the install certificate feature since it contained SUN Microsystems copyright. We may opt to integrate it once more in the future with an alternative code that does not have license problems.", "id": 137015, "time": "2010-05-21T06:19:22Z", "creator": "moreira@privasphere.com", "creation_time": "2010-05-21T06:19:22Z", "is_private": false, "attachment_id": 25470}, {"count": 12, "tags": [], "creator": "hauser@acm.org", "text": "see also bug 38387 comment 8 for how to be robust against absent bc*.jar", "id": 137101, "time": "2010-05-25T07:40:43Z", "bug_id": 45053, "creation_time": "2010-05-25T07:40:43Z", "is_private": false, "attachment_id": null}, {"attachment_id": 25482, "tags": [], "bug_id": 45053, "is_private": false, "count": 13, "id": 137104, "time": "2010-05-25T08:55:51Z", "creator": "moreira@privasphere.com", "creation_time": "2010-05-25T08:55:51Z", "text": "Created attachment 25482\nThis patch contains a SMTPSampler with a graceful failure presentation at the GUI level when the bouncy castle jar is not present."}, {"count": 14, "tags": [], "creator": "moreira@privasphere.com", "text": "Sebb, do we have progress on this bug? I have some time that I can invest on any required changes on this code.\n\nRegards", "id": 137231, "time": "2010-05-31T07:59:21Z", "bug_id": 45053, "creation_time": "2010-05-31T07:59:21Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "text": "Latest patch looks mostly OK.\n\nNot sure why the sampler has the \"Check for failure\" option. This seems out of place for a sample.\n\nThere a few other tweaks that need to be made, but these can be done later.\n\nAs for Bug 38387, it would be very helpful to have a patch for component_reference.xml and some unit tests, though that may be quite hard.", "attachment_id": null, "bug_id": 45053, "id": 137285, "time": "2010-06-02T13:44:35Z", "creator": "sebb@apache.org", "creation_time": "2010-06-02T13:44:35Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 45053, "is_private": false, "count": 16, "id": 137292, "time": "2010-06-03T02:42:01Z", "creator": "moreira@privasphere.com", "creation_time": "2010-06-03T02:42:01Z", "text": "Could you point an existing junit test that I could use as example for the new tests?"}, {"attachment_id": null, "tags": [], "bug_id": 45053, "is_private": false, "count": 17, "id": 137952, "time": "2010-06-28T14:06:55Z", "creator": "sebb@apache.org", "creation_time": "2010-06-28T14:06:55Z", "text": "Any chance you could provide a short description for compononent_reference.xml?\n\nI can do the screnshot, but having the text would be very useful."}, {"count": 18, "tags": [], "creator": "moreira@privasphere.com", "text": "Will be working on it today. Sorry for delay, got flooded with work the last weeks.", "id": 137986, "time": "2010-06-29T10:22:09Z", "bug_id": 45053, "creation_time": "2010-06-29T10:22:09Z", "is_private": false, "attachment_id": null}, {"count": 19, "attachment_id": 25658, "creator": "moreira@privasphere.com", "text": "Created attachment 25658\nScreenshot", "id": 137993, "time": "2010-06-29T12:10:39Z", "bug_id": 45053, "creation_time": "2010-06-29T12:10:39Z", "tags": [], "is_private": false}, {"count": 20, "tags": [], "text": "Created attachment 25659\nSMTP Documentation Patch", "is_private": false, "bug_id": 45053, "id": 137995, "time": "2010-06-29T12:14:16Z", "creator": "moreira@privasphere.com", "creation_time": "2010-06-29T12:14:16Z", "attachment_id": 25659}, {"count": 21, "tags": [], "creator": "moreira@privasphere.com", "text": "Documentation patch is done. If need anything else let me know. I believe that the original author is also willing to put some time into this patch:\n\n>Hi Luciana,\n>I confirm you can remove the copyright note in order to include the source\n>code into JMeter distribution.\n\n>Since there were many tentative to achieve this result, don't hesitate to\n>contact me in case of any problem. I would be really glad to give a little\n>contribute to the project.\n\n>Regards.\n>Luca\n\nI will call his attention to this rfe via e-mail once again since he is not registered in the bugzilla platform.", "id": 137997, "time": "2010-06-29T12:17:56Z", "bug_id": 45053, "creation_time": "2010-06-29T12:17:56Z", "is_private": false, "attachment_id": null}, {"count": 22, "tags": [], "creator": "sebb@apache.org", "text": "I've started working on adding the code, however I have come across a serious problem:\n\nThe SendMailCommand code currently changes the value of the \"javax.net.ssl.trustStore\" system property at run-time. This will cause problems when running multiple threads.\n\nSome other way will have to be found to handle this.\n\nAny suggestions?", "id": 138011, "time": "2010-06-29T14:42:31Z", "bug_id": 45053, "creation_time": "2010-06-29T14:42:31Z", "is_private": false, "attachment_id": null}, {"count": 23, "attachment_id": null, "creator": "hauser@acm.org", "is_private": false, "id": 138013, "time": "2010-06-29T16:23:42Z", "bug_id": 45053, "creation_time": "2010-06-29T16:23:42Z", "tags": [], "text": "not particularly beautiful, but can avoid side-effects on other takers of the \"javax.net.ssl.trustStore\" :\n\nExtend java.lang.InheritableThreadLocal and set the variable there.\nAnd obviously in the right place, also take it from there again..."}, {"attachment_id": null, "tags": [], "bug_id": 45053, "text": "(In reply to comment #23)\n> not particularly beautiful, but can avoid side-effects on other takers of the\n> \"javax.net.ssl.trustStore\" :\n> \n> Extend java.lang.InheritableThreadLocal and set the variable there.\n\nUseful to know.\n\n> And obviously in the right place, also take it from there again...\n\nNot sure that's possible. The code does not read the property so I assume it must be read by one of the libraries.", "count": 24, "id": 138015, "time": "2010-06-29T17:16:36Z", "creator": "sebb@apache.org", "creation_time": "2010-06-29T17:16:36Z", "is_private": false}, {"count": 25, "attachment_id": null, "creator": "moreira@privasphere.com", "is_private": false, "id": 138016, "time": "2010-06-29T17:21:25Z", "bug_id": 45053, "creation_time": "2010-06-29T17:21:25Z", "tags": [], "text": "The clean approach for this is to have a SocketFactory implementation with built in TrustManager that will check the certificate based on the truststore.\n\nTo understand it better look at the class TrustAllSSLSocketFactory written by Luca. We need to do the same idea but accepting only certificates that are n the truststore."}, {"count": 26, "tags": [], "creator": "sebb@apache.org", "attachment_id": null, "text": "The SendMailCommand class also calls:\n\nSecurity.setProperty(\"ssl.SocketFactory.provider\",...)\n\nwhich again will affect all threads.\n\nThe code needs to be changed to set the socket factory for the specific sampler only.\n\nSimilar code is used in the HttpSamplers, but I'm not sure those classes are directly usable here - they may well be http-specific.\n\nI think the best approach would be to commit the code with the current restrictions and then fix it, because most of it seems to be working.", "id": 138056, "time": "2010-07-01T08:08:57Z", "bug_id": 45053, "creation_time": "2010-07-01T08:08:57Z", "is_private": false}, {"count": 27, "attachment_id": null, "creator": "sebb@apache.org", "text": "Another issue - the code does not seem to need Bouncy Castle, so I removed the code which checks for it.", "id": 138057, "time": "2010-07-01T08:11:22Z", "bug_id": 45053, "creation_time": "2010-07-01T08:11:22Z", "tags": [], "is_private": false}, {"count": 28, "tags": [], "text": "(In reply to comment #26)\n> The SendMailCommand class also calls:\n> \n> Security.setProperty(\"ssl.SocketFactory.provider\",...)\n> \n> which again will affect all threads.\n\nRemoved, as the prepareMessage() method already sets the appropriate property.", "is_private": false, "id": 138062, "creator": "sebb@apache.org", "time": "2010-07-01T14:46:35Z", "bug_id": 45053, "creation_time": "2010-07-01T14:46:35Z", "attachment_id": null}, {"count": 29, "attachment_id": null, "creator": "sebb@apache.org", "text": "The cbUseLocalTrustStore tooltip currently just says \"Please note:\"\n\nI assume that there was supposed to be something else in the message?\nAny idea what it was?", "id": 138112, "time": "2010-07-03T06:28:46Z", "bug_id": 45053, "creation_time": "2010-07-03T06:28:46Z", "tags": [], "is_private": false}, {"count": 30, "tags": [], "creator": "sebb@apache.org", "attachment_id": null, "is_private": false, "id": 138113, "time": "2010-07-03T06:54:35Z", "bug_id": 45053, "creation_time": "2010-07-03T06:54:35Z", "text": "Also, the trust settings are assymetrical.\n\n\"Use SSL\" can be used with \"Trust All\" and \"Use Local\", whereas \nStartTLS disables \"Trust All\" yet allows \"Use Local\".\n\nSurely if StartTLS can \"Use Local\" it should also be able to \"Trust All\"?\nOtherwise maybe it should not use either?"}, {"count": 31, "tags": [], "creator": "moreira@privasphere.com", "attachment_id": null, "is_private": false, "id": 138153, "time": "2010-07-05T03:28:57Z", "bug_id": 45053, "creation_time": "2010-07-05T03:28:57Z", "text": "I don\u00a3t see any reason for this behaviour with the trustAll x Local keystore.\n\nIf you look in the code of SendMailCommand, trustAllCerts is independent of start TLS.\n\n        if (useStartTLS) {\n            props.put(\"mail.smtp.starttls.enable\", \"true\");\n            //props.put(\"mail.debug\", \"true\");\n        }\n\n        if (trustAllCerts && protocol.equalsIgnoreCase(\"smtps\")) {\n            props.setProperty(\"mail.smtps.socketFactory.class\",\n                    TRUST_ALL_SOCKET_FACTORY);\n            props.setProperty(\"mail.smtps.socketFactory.fallback\", \"false\");\n        }\n\nTo me this is a clear GUI bug."}, {"attachment_id": 25702, "tags": [], "bug_id": 45053, "is_private": false, "count": 32, "id": 138156, "time": "2010-07-05T04:03:27Z", "creator": "moreira@privasphere.com", "creation_time": "2010-07-05T04:03:27Z", "text": "Created attachment 25702\nSmall patch to fix the described bug on TrustAllCerts. It also fixes the layout to completely fill the space."}, {"attachment_id": null, "tags": [], "bug_id": 45053, "is_private": false, "count": 33, "id": 138160, "time": "2010-07-05T06:31:59Z", "creator": "sebb@apache.org", "creation_time": "2010-07-05T06:31:59Z", "text": "OK, thanks for confirming. Applied to SVN:\n\nURL: http://svn.apache.org/viewvc?rev=960528&view=rev\nLog:\nBug 45053 - SMTP-Sampler for JMeter\n+ Fix trustAllCerts so it applies also to StartTLS option"}, {"count": 34, "tags": [], "creator": "sebb@apache.org", "is_private": false, "text": "Finally worked out how to use properties to control LocalTrustStore for both SSL and StartTLS. Requires JavaMail 1.4.2+\n\nURL: http://svn.apache.org/viewvc?rev=960899&view=rev\nLog:\nNew screenshot. SMTP sampler no longer thread-hostile\n\nModified:\n   jakarta/jmeter/trunk/docs/images/screenshots/smtp_sampler.png\n   jakarta/jmeter/trunk/xdocs/images/screenshots/smtp_sampler.png\n   jakarta/jmeter/trunk/xdocs/usermanual/component_reference.xml\n\nI think this is all complete now, so will close the bug.\n\nIf there are any further issues, please raise a new issue.", "id": 138215, "time": "2010-07-06T12:14:13Z", "bug_id": 45053, "creation_time": "2010-07-06T12:14:13Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 45053, "text": "Hello Sebb,\n\nSorry to reopen this bug, but I attempted to run some test scripts with the code fresh from svn and I got this error. I tried to connect using local keystore and truts all certificates, both gave me the same error\n\nThread Name: SigSvc_Pass_Mail 1-1\nSample Start: 2010-07-07 15:20:27 CEST\nLoad time: 5151\nLatency: 0\nSize in bytes: -1\nSample Count: 1\nError Count: 1\nResponse code: 500\nResponse message: MessagingException: Server certificate not trusted - perhaps you have to restart JMeter!\njavax.mail.MessagingException: Can't send command to SMTP host;\n  nested exception is:\n\tjavax.net.ssl.SSLHandshakeException: sun.security.validator.ValidatorException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target\n\nResponse headers:\n\n\nSampleResult fields:\nContentType: \nDataEncoding: null\n\nI used this script many times before to connect to the same server I am trying now and had no troubles.Any ideas of what could be happening?", "count": 35, "id": 138252, "time": "2010-07-07T09:26:50Z", "creator": "moreira@privasphere.com", "creation_time": "2010-07-07T09:26:50Z", "is_private": false}, {"count": 36, "tags": [], "text": "The code now requires JavaMail 1.4.2+ (and comes with JavaMail 1.4.3).\n\nPreviously JMeter nightly was using the Geronimo mail implementation - however that does not (yet) support all the mail properties now used by JMeter.\n\nMake sure that you delete the geronimo javamail and activation jars from the lib directory. \n\nTry also enabling debug - this should show if you are using Geronimo or the JavaMail from Oracle(Sun).", "is_private": false, "bug_id": 45053, "id": 138254, "time": "2010-07-07T10:15:16Z", "creator": "sebb@apache.org", "creation_time": "2010-07-07T10:15:16Z", "attachment_id": null}, {"count": 37, "tags": [], "creator": "moreira@privasphere.com", "is_private": false, "text": "Thx a lot, it fixed my problem :)\n\nI will close the bug again.", "id": 138255, "time": "2010-07-07T11:07:33Z", "bug_id": 45053, "creation_time": "2010-07-07T11:07:33Z", "attachment_id": null}, {"count": 38, "tags": [], "creator": "sebb@apache.org", "is_private": false, "text": "OK, no problem, thanks for confirming it's OK.\n\nIt was probably because I added a .ssl prefix to the socketFactory.class property.\nThis was needed to support TrustAll with StartTLS.\nWithout it, the mail implementation tried to use the SSL socketfactory to create the initial non-SSL socket - and failed.\n\ni.e. TrustAll needs mail.smtp.ssl.socketFactory.class, and will not work with mail.smtp.socketFactory.class\n\nFor consistency, for SSL mode I also used the mail.smtps.ssl.socketFactory.class property. This requires Javamail 1.4.2+.\n\nI suppose I could have omitted the .ssl here as smtps always uses SSL sockets - in which case your test case would have worked with SSL+TrustAll on Geronimo.\n\nBut Geronimo does not support the \"mail.smtps[.ssl].socketFactory\" property so it would not have worked with SSL+Local truststore.", "id": 138258, "time": "2010-07-07T11:30:49Z", "bug_id": 45053, "creation_time": "2010-07-07T11:30:49Z", "attachment_id": null}]