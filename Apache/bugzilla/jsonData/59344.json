[{"count": 0, "text": "Hi,\n\nCurrently Tomcat accepts PEM encoded certificates when using the APR connector with OpenSSL only. I'd like to suggest extending the PEM files support to the JSSE connector too. That would make it easier to switch between configurations with the same certificate format, or reusing the certificates generated by letsencrypt as is without importing them into a PKCS12/JKS keystore.\n\nI got a quick look at the code and I think this could be implemented by creating an in-memory KeyStore in JSSEUtil.getKeyManagers() and initializing it with the certificate chain and the private key loaded from the PEM files.", "bug_id": 59344, "is_private": false, "id": 190329, "time": "2016-04-18T07:22:13Z", "creator": "ebourg@apache.org", "creation_time": "2016-04-18T07:22:13Z", "tags": [], "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 59344, "attachment_id": 33788, "id": 190449, "time": "2016-04-21T14:02:13Z", "creator": "ebourg@apache.org", "creation_time": "2016-04-21T14:02:13Z", "is_private": false, "text": "Created attachment 33788\nPEM support implementation\n\nHere is a patch implementing this feature:\n- SSLHostConfigCertificate is modified to accept certificateFile, certificateChainFile and certificateKeyFile with JSSE\n- The HTTP connector documentation is updated accordingly\n- A new package private class org.apache.tomcat.util.net.jsse.PEMFile is added to handle the PEM file parsing and decoding. It supports PKCS#8 private keys only.\n- JSSEUtil.getKeyManagers() is modified to create an in-memory keystore initialized with the PEM files when the certificateFile is specified.\n- TesterSupport is modified to make it possible to initialize SSL with PEM files even when the APR connector isn't used.\n- TestSsl is extended to test SSL with plain text and encrypted keys. It is missing a test with a certificate chain file to cover all the cases (the test certificate being self signed it has no intermediary CA)."}, {"count": 2, "text": "Oh ok, that was unexpected. I'm a bit sceptical about the usefulness since JSSE is mostly useless in 9 (no ALPN), but if it works, why not.\n\nAbout the documentation, more changes are needed and it shouldn't be changed this way. I would like to keep the two configuration types clearly separate, so a host configuration should use either OpenSSL or JSSE configuration types, but not a mix of both.\n\nNote: you apparently missed the possibility to use JSSE with OpenSSL, which is basically the recommended setup now. It supports both JSSE and OpenSSL configuration types.", "bug_id": 59344, "is_private": false, "id": 190451, "time": "2016-04-21T14:31:35Z", "creator": "remm@apache.org", "creation_time": "2016-04-21T14:31:35Z", "tags": [], "attachment_id": null}, {"attachment_id": 33789, "tags": [], "bug_id": 59344, "is_private": false, "count": 3, "id": 190452, "time": "2016-04-21T14:31:41Z", "creator": "ebourg@apache.org", "creation_time": "2016-04-21T14:31:41Z", "text": "Created attachment 33789\nPEM support implementation\n\nUpdated TestSsl to match the changes made in r1740324."}, {"count": 4, "tags": [], "bug_id": 59344, "attachment_id": null, "text": "Thank you for the review Remy. My use case is mostly for HTTP/1.1, I agree this feature is less interesting for HTTP/2, until Java 9 is available and supports ALPN I guess.\n\nThe patch supports a configuration like this one:\n\n  <Connector port=\"8443\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\"\n             SSLEnabled=\"true\">\n    <SSLHostConfig>\n      <Certificate certificateKeyFile=\"conf/privkey-encrypted.pem\"\n                   certificateKeyPassword=\"secret\"\n                   certificateFile=\"conf/cert.pem\"\n                   certificateChainFile=\"conf/chain.pem\"/>\n    </SSLHostConfig>\n  </Connector>\n\nThat's similar to the parameters accepted for the HTTP/2 connector. Are you suggesting a different set of parameters for this case?", "id": 190455, "time": "2016-04-21T14:49:52Z", "creator": "ebourg@apache.org", "creation_time": "2016-04-21T14:49:52Z", "is_private": false}, {"count": 5, "tags": [], "text": "Unless you have a tomcat-native phobia, I think you should just install it. Then Tomcat will use OpenSSL and you would be better off than with JSSE.\n\nI'm quite sure you didn't try it since your testsuite changes break that.", "is_private": false, "bug_id": 59344, "id": 190458, "time": "2016-04-21T16:03:08Z", "creator": "remm@apache.org", "creation_time": "2016-04-21T16:03:08Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "ebourg@apache.org", "is_private": false, "count": 6, "id": 190460, "time": "2016-04-21T16:24:31Z", "bug_id": 59344, "creation_time": "2016-04-21T16:24:31Z", "text": "Indeed, I've never had the need for tomcat-native so far. I'm going to check the regression with OpenSSL."}, {"count": 7, "tags": [], "text": "It's only a testsuite issue, so I'll look it up eventually. Otherwise the patch interacts properly with the OpenSSL support.\n\nTo run the tests with OpenSSL, you can add this in build.properties:\ntest.sslImplementation=org.apache.tomcat.util.net.openssl.OpenSSLImplementation", "attachment_id": null, "bug_id": 59344, "id": 190461, "time": "2016-04-21T16:45:05Z", "creator": "remm@apache.org", "creation_time": "2016-04-21T16:45:05Z", "is_private": false}, {"count": 8, "tags": [], "text": "On Windows 7 I copied openssl.exe in the base directory and tcnative-1.dll into bin/native and then ran:\n\n   ant test-apr -Dtest.openssl.path=openssl.exe -Dtest.name=**/*Ssl*\n\nand the tests passed.\n\nWith:\n\n   ant test-nio -Dtest.openssl.path=openssl.exe -Dtest.sslImplementation=org.apache.tomcat.util.net.openssl.OpenSSLIm\nplementation -Dtest.name=**/*Ssl*\n\nI get a SSLException \"Error initializing SSL context\" caused by \"Invalid Server SSL Protocol (error:140A90F1:SSL routines:SSL_CTX_new:unable to load ssl2 md5 routines)\". Is this the error you encountered?", "is_private": false, "bug_id": 59344, "id": 190462, "time": "2016-04-21T17:05:41Z", "creator": "ebourg@apache.org", "creation_time": "2016-04-21T17:05:41Z", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 59344, "attachment_id": null, "is_private": false, "id": 190463, "time": "2016-04-21T17:21:57Z", "creator": "remm@apache.org", "creation_time": "2016-04-21T17:21:57Z", "text": "Yes, that's the test error."}, {"count": 10, "tags": [], "bug_id": 59344, "attachment_id": 33792, "id": 190468, "time": "2016-04-21T19:36:08Z", "creator": "ebourg@apache.org", "creation_time": "2016-04-21T19:36:08Z", "is_private": false, "text": "Created attachment 33792\nPEM support implementation\n\nTesterSupport.initSslWithPEM() now sets the sslImplementationName connector attribute when the test.sslImplementation property is set. This fixes the exception with the testSimpleSslWith*PEM() tests."}, {"count": 11, "tags": [], "text": "This does create a side effect on the configuration checking though, which becomes rather messy. Basically, all connectors can now use the OpenSSL style, but they cannot mix and match for the certificate definition.\n\nSo I now agree that the OpenSSL type should be removed from CertificateKeyFile, CertificateFile and CertificateChainFile, but I'll add an extra check to cause an error if for example both CertificateKeystorePassword and CertificateChainFile are defined.", "attachment_id": null, "id": 190538, "creator": "remm@apache.org", "time": "2016-04-25T14:36:12Z", "bug_id": 59344, "creation_time": "2016-04-25T14:36:12Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 59344, "is_private": false, "count": 12, "id": 190558, "time": "2016-04-26T09:34:03Z", "creator": "remm@apache.org", "creation_time": "2016-04-26T09:34:03Z", "text": "I have committed r1740969, with some additions to avoid configuration errors.\n\nI have not committed the new tests yet since the mixing with the OpenSSL flag still looks a bit suspicious. Also the documentation is not updated, so the BZ remains open."}, {"count": 13, "text": "The docs doesn't look too bad.\nThe feature will be in 9M5 and 8.5.1, but you really should look into using OpenSSL if you want to do something useful with these new Tomcats.", "bug_id": 59344, "is_private": false, "id": 190566, "time": "2016-04-26T17:12:25Z", "creator": "remm@apache.org", "creation_time": "2016-04-26T17:12:25Z", "tags": [], "attachment_id": null}, {"count": 14, "tags": [], "bug_id": 59344, "attachment_id": null, "id": 190594, "time": "2016-04-27T10:13:39Z", "creator": "ebourg@apache.org", "creation_time": "2016-04-27T10:13:39Z", "is_private": false, "text": "Thank you Remy, that's perfect."}]