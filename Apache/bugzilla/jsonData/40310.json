[{"count": 0, "attachment_id": null, "creator": "ianabel@mxtelecom.com", "is_private": false, "id": 92499, "time": "2006-08-24T16:15:58Z", "bug_id": 40310, "creation_time": "2006-08-24T16:15:58Z", "tags": [], "text": "With an apahce proxying requests over ajp to a backend tomcat, the following \nsequence of events is possible:\n\nUser1 requests /badger, and sends headers.\nRequest hits apache, filters into ap_proxy_ajp_request in mod_proxy_ajp.c\nUser1 terminates connection with extreme prejudice.\nApache sends headers to tomcat.\nTomcat takes it's time.\nApache tries to read the rest of the request body with ap_get_brigade, \nmod_proxy_ajp.c:174. This fails as the underlying socket cannot recv any more.\nSo ap_proxy_ajp_request returns 500 immediatly. conn->close++ is not called so \nthe connection is not touched, merely put back in the available connections.\nApache now fails int he output filters trying to send the status 500 error \nmessage.\n\nNow user2 connects, requests /moose, apache takes the above connection from the \npool and sends the headers down the pipe to the tomcat.\nThe tomcat now returns /badger, as that's finally finished processing. \nApache in ajp_read_header reads the SEND_BODY_CHUNK message, and processes it. \nThen repeats reading messages until the END_RESPONSE message.\n\nWhereupon apache has successfully served /badger to someone who requested /\nmoose. \n\nNeedless to say this is a critical flaw with the ajp connection handling."}, {"count": 1, "tags": [], "bug_id": 40310, "attachment_id": 18750, "text": "Created attachment 18750\nPatch that attempts to fix the bug\n\nThis patch _should_, if my understanding of the bug is correct , fix it.", "id": 92500, "time": "2006-08-24T16:17:49Z", "creator": "ianabel@mxtelecom.com", "creation_time": "2006-08-24T16:17:49Z", "is_private": false}, {"count": 2, "tags": [], "text": "Well spotted! Committed to trunk as r434483\n(http://svn.apache.org/viewvc?view=rev&revision=434483). Thanks for the patch.", "attachment_id": null, "id": 92505, "creator": "rpluem@apache.org", "time": "2006-08-24T19:52:49Z", "bug_id": 40310, "creation_time": "2006-08-24T19:52:49Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 40310, "attachment_id": null, "id": 92507, "time": "2006-08-24T19:58:31Z", "creator": "rpluem@apache.org", "creation_time": "2006-08-24T19:58:31Z", "is_private": false, "text": "Proposed for backport to 2.2.x as r434488\nhttp://svn.apache.org/viewvc?view=rev&revision=434488)."}, {"count": 4, "tags": [], "bug_id": 40310, "is_private": false, "text": "I'd like to add that in our shop we witnessed this exact same problem with\nApache 2.2.3 and mod_jk 1.2.19, not mod_proxy_ajp.  Will the fix being applied\ncure this problem when using mod_jk or is a seperate patch going to be applied\nto that module as well?\n\nThanks.", "id": 97651, "time": "2007-01-04T10:52:34Z", "creator": "hatfield@uga.edu", "creation_time": "2007-01-04T10:52:34Z", "attachment_id": null}, {"count": 5, "tags": [], "text": "No this will not cure mod_jk. Bugs for mod_jk should not be further handled in\nthis report. Please open a new report with Product: Tomcat 5 and Component:\nNative:JK.\nBTW: The fix for the original bug will be part of 2.2.4 as it has been backported.", "is_private": false, "id": 97652, "creator": "rpluem@apache.org", "time": "2007-01-04T11:40:34Z", "bug_id": 40310, "creation_time": "2007-01-04T11:40:34Z", "attachment_id": null}, {"count": 6, "tags": [], "text": "The problem is still not fixed correctly in 2.2.4 (the worker is marked errored\nand connection retried but that is wrong):\n+++\nFri Mar 16 08:27:06 2007] [error] [client 71.140.198.6] proxy: error processing\nbody, referer: https://xxx.yyy.zzz/site/checkout/ship_method.html\n[Fri Mar 16 08:27:06 2007] [error] proxy: got bad response (5) from\n64.85.80.16:8009 (app4)\n[Fri Mar 16 08:27:06 2007] [error] proxy: BALANCER: (balancer://appservers). All\nworkers are in error state for route (app4-engine1)\n+++\nI have fixed it in trunk.", "attachment_id": null, "id": 100520, "creator": "jfclere@gmail.com", "time": "2007-03-17T11:44:58Z", "bug_id": 40310, "creation_time": "2007-03-17T11:44:58Z", "is_private": false}, {"count": 7, "tags": [], "creator": "jfclere@gmail.com", "attachment_id": 19772, "id": 100794, "time": "2007-03-22T09:41:29Z", "bug_id": 40310, "creation_time": "2007-03-22T09:41:29Z", "is_private": false, "text": "Created attachment 19772\npatch for 2.2.x\n\nI will commit it in the 2.2.x branch if noone complains."}, {"count": 8, "tags": [], "bug_id": 40310, "is_private": false, "text": "Fix backported to 2.2.x as r553593\n(http://svn.apache.org/viewvc?view=rev&revision=553593)", "id": 106874, "time": "2007-08-17T13:07:58Z", "creator": "rpluem@apache.org", "creation_time": "2007-08-17T13:07:58Z", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 40310, "attachment_id": null, "text": "Here's a report for the same symptom with httpd-2.2.11:\n\nhttp://www.tomcatexpert.com/blog/2010/06/16/deciding-between-modjk-modproxyhttp-and-modproxyajp#comment-207\n\nMeanwhile, I just experienced the same with httpd-2.4.2\n\nI can't rule out the possibility of bug in my application code, misbehaving proxy server, etc. However, the mixed up response only happens with mod_proxy_ajp, not mod_proxy_http.", "id": 161453, "time": "2012-08-16T01:41:31Z", "creator": "sokann@gmail.com", "creation_time": "2012-08-16T01:41:31Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 40310, "attachment_id": null, "is_private": false, "id": 161455, "time": "2012-08-16T06:02:04Z", "creator": "sokann@gmail.com", "creation_time": "2012-08-16T06:02:04Z", "text": "I have logged a separate issue: bug 53727"}]