[{"count": 0, "tags": [], "text": "NullPointerException is thrown when the session is created. \nThe following are the error messages. \n\n** localhost.xxxx-xx-xx.log **\njava.lang.NullPointerException\n        at org.apache.catalina.tribes.tipis.AbstractReplicatedMap.size\n(AbstractReplicatedMap.java:989)\n        at org.apache.catalina.session.ManagerBase.add(ManagerBase.java:741)\n        at org.apache.catalina.session.StandardSession.setId\n(StandardSession.java:368)\n        at org.apache.catalina.ha.session.DeltaSession.setId\n(DeltaSession.java:243)\n        at org.apache.catalina.session.ManagerBase.createSession\n(ManagerBase.java:829)\n        at org.apache.catalina.session.StandardManager.createSession\n(StandardManager.java:291)\n        at org.apache.catalina.connector.Request.doGetSession\n(Request.java:2312)\n        at org.apache.catalina.connector.Request.getSession(Request.java:2075)\n        at org.apache.catalina.connector.RequestFacade.getSession\n(RequestFacade.java:833)\n        at org.apache.catalina.connector.RequestFacade.getSession\n(RequestFacade.java:844)\n        .........\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:690)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:803)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter\n(ApplicationFilterChain.java:290)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter\n(ApplicationFilterChain.java:206)\n        at org.apache.catalina.core.StandardWrapperValve.invoke\n(StandardWrapperValve.java:230)\n        at org.apache.catalina.core.StandardContextValve.invoke\n(StandardContextValve.java:175)\n        at org.apache.catalina.core.StandardHostValve.invoke\n(StandardHostValve.java:128)\n        at org.apache.catalina.ha.tcp.ReplicationValve.invoke\n(ReplicationValve.java:347)\n        at org.apache.catalina.valves.ErrorReportValve.invoke\n(ErrorReportValve.java:104)\n        at org.apache.catalina.core.StandardEngineValve.invoke\n(StandardEngineValve.java:109)\n        at org.apache.catalina.connector.CoyoteAdapter.service\n(CoyoteAdapter.java:261)\n        at org.apache.jk.server.JkCoyoteHandler.invoke\n(JkCoyoteHandler.java:190)\n        at org.apache.jk.common.HandlerRequest.invoke(HandlerRequest.java:283)\n        at org.apache.jk.common.ChannelSocket.invoke(ChannelSocket.java:767)\n        at org.apache.jk.common.ChannelSocket.processConnection\n(ChannelSocket.java:697)\n        at org.apache.jk.common.ChannelSocket$SocketConnection.runIt\n(ChannelSocket.java:889)\n        at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run\n(ThreadPool.java:686)\n        at java.lang.Thread.run(Thread.java:595)\n\n\n[Environment]\n  use BackupManager in Tomcat6.0.13.\n  <Manager className=\"org.apache.catalina.ha.session.BackupManager\" ... />\n\nI think org.apache.catalina.tribes.tipis.AbstractReplicatedMap.size() is not \nthread safe.\nAfter creating the session. (ManagerBase.java:829))\nTo update maxActive, the size of the session map is gotten.\nAnd org.apache.catalina.tribes.tipis.AbstractReplicatedMap.size() is as \nfollows. \n\n  public int size() {\n      //todo, implement a counter variable instead\n      //only count active members in this node\n      int counter = 0;\n      Iterator it = super.entrySet().iterator();\n      while (it.hasNext() ) {\n          Map.Entry e = (Map.Entry) it.next();\n          if ( e != null ) {\n              MapEntry entry = (MapEntry) super.get(e.getKey());\n              if (entry.isPrimary() && entry.getValue() != null) counter++; \n          }\n      }\n      return counter;\n  }\n\n\nWhile a certain Thread executes AbstractReplicatedMap.size()  \nanother Thread executes AbstractReplicatedMap.remove() by session.invalidate() \nand the session time-out. \n\nWhen the session is removed from the sessions by another thread after Iterator \nis gotten (line:984) \nentry(Session) acquired as follows might become Null. \n  \n  MapEntry entry = (MapEntry) super.get(e.getKey());\n\nTherefore, NullPointerException is thrown in the next line(line:989). \n\nIf Servlet that does only request.getSession() and session.invalidate() is \nexecuted by a high load,\nNullPointerExceprtion is immediately thrown. \n\n    public void doGet(HttpServletRequest request,\n        HttpServletResponse response) throws ServletException, IOException {\n        HttpSession session = request.getSession();\n        session.invalidate();\n    }", "attachment_id": null, "id": 105026, "creator": "keiichi.fujino@gmail.com", "time": "2007-07-03T03:05:26Z", "bug_id": 42803, "creation_time": "2007-07-03T03:05:26Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 42803, "attachment_id": null, "text": "Thanks for the report, I have mitigated the NPE, I do intend to change that\nalgorithm a bit in the future to be smarter than it is right now. ", "id": 105028, "time": "2007-07-03T06:30:46Z", "creator": "fhanik@apache.org", "creation_time": "2007-07-03T06:30:46Z", "is_private": false}]