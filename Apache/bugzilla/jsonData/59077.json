[{"count": 0, "attachment_id": null, "creator": "kenneth.gendron@gmail.com", "text": "Suppose you have a datasource, \"jdbc/ds\" below, that for whatever reason the backing database is down and cannot be connected to.  When Tomcat starts up it attempts to create the pooled datasource \"jdbc/dspool\"; however, due to the pseudo-random nature of how Tomcat creates resources the \"jdbc/ds\" datasource is not yet created.  This does not pose a problem to the DataSourceFactory class since the performJNDILookup method does not throw an exception, but fails with only a log message.  Tomcat does not retry to create the pooled datasource, and proceeds on, failing later on for \"URL cannot be found\", or some such error.  Below is the server.xml configuration portion.\n\n<Resource name=\"jdbc/automationora\"\n              auth=\"Container\"\n              type=\"javax.sql.DataSource\"\n              username=\"automation\"\n              password=\"automation\"\n              factory=\"automation.sql.oracle.OracleDataSourceFactory\"\n              url=\"jdbc:oracle:thin:@(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=localhost)(PORT=1521))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=XE)))\"\n              connectionProperties=\"oracle.jdbc.ReadTimeout=60000;\"/>\n    <Resource name=\"jdbc/automation\"\n              auth=\"Container\"\n              type=\"javax.sql.DataSource\"\n              factory=\"org.apache.tomcat.jdbc.pool.DataSourceFactory\"\n              dataSourceJNDI=\"automationora\"\n              maxActive=\"5\"\n              maxIdle=\"5\"\n              minIdle=\"5\"\n              maxWait=\"-1\"\n              initialSize=\"0\"\n              testOnBorrow=\"true\"\n              validationQuery=\"select 1 from dual\"/>\n\nIf, however, the performJNDILookup were modified to allow an Exception, namely a NamingException to be thrown, then it could be modified slightly to allow Tomcat to retry.  Below, when the method fails to find the data source in the initial context, it could throw the resulting NamingException.  Tomcat would then continue with the other resources, creating them, then come back and recreate the pooled datasource.\n\n    public void performJNDILookup(Context context, PoolConfiguration poolProperties) throws NamingException {\n        Object jndiDS = null;\n        try {\n            if (context!=null) {\n                jndiDS = context.lookup(poolProperties.getDataSourceJNDI());\n            } else {\n                log.warn(\"dataSourceJNDI property is configued, but local JNDI context is null.\");\n            }\n        } catch (NamingException e) {\n            log.debug(\"The name \\\"\"+poolProperties.getDataSourceJNDI()+\"\\\" can not be found in the local context.\");\n        }\n        if (jndiDS==null) {\n            try {\n                context = new InitialContext();\n                jndiDS = context.lookup(poolProperties.getDataSourceJNDI());\n            } catch (NamingException e) {\n                log.warn(\"The name \\\"\"+poolProperties.getDataSourceJNDI()+\"\\\" can not be found in the InitialContext.\");\n                throw e;\n            }\n        }\n        if (jndiDS!=null) {\n            poolProperties.setDataSource(jndiDS);\n        }\n    }", "id": 188852, "time": "2016-02-26T18:52:52Z", "bug_id": 59077, "creation_time": "2016-02-26T18:52:52Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 59077, "attachment_id": null, "id": 189019, "time": "2016-03-02T13:06:24Z", "creator": "markt@apache.org", "creation_time": "2016-03-02T13:06:24Z", "is_private": false, "text": "Correct product."}, {"count": 2, "tags": [], "bug_id": 59077, "attachment_id": null, "text": "Sorry to ask, but does this mean its by design, or should be fixed?", "id": 189184, "time": "2016-03-07T00:34:19Z", "creator": "kenneth.gendron@gmail.com", "creation_time": "2016-03-07T00:34:19Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 59077, "attachment_id": null, "id": 189186, "time": "2016-03-07T01:44:57Z", "creator": "chris@christopherschultz.net", "creation_time": "2016-03-07T01:44:57Z", "is_private": false, "text": "(In reply to Kenneth Gendron from comment #2)\n> Sorry to ask, but does this mean its by design, or should be fixed?\n\nI believe Mark changed the \"product\" field in the bug report and made a comment to that effect. It's not a comment on the validity of the bug report itself."}]