[{"count": 0, "tags": [], "text": "Hi,\nI have a problem since I have updated my Tomcat from version 8.0.32 to version 8.0.33.\n\nI have a java maven project based on Wicket MVC, Atmosphere and Tomcat.\n\nAfter the update to Tomcat 8.0.33 I get an IllegalArgumentException when I am sending an empty atmosphere message. The reason for this exception seems to be located in PerMessageDeflate.sendMessagePart(). I compared the method between both versions and found out that a change was made where the message is checked if it is empty. \nFollowing bug report should match to this change: https://bz.apache.org/bugzilla/show_bug.cgi?id=59189\n\nLine 324 in PerMessageDeflate was changed from\n\"uncompressedPart.getPayload().limit() == 0\"\nto\n\"uncompressedPart.getPayload().limit() == 0 && uncompressedPart.isFin() && deflater.getBytesRead() == 0)\"\n\nIt seems that now our empty message isn't handled like an empty message anymore, leeding to the following IllegalArgumentException:\n\njava.lang.IllegalArgumentException\n\tat java.nio.Buffer.limit(Buffer.java:275) ~[?:1.8.0_74]\n\tat org.apache.tomcat.websocket.PerMessageDeflate.sendMessagePart(PerMessageDeflate.java:373) ~[tomcat-websocket.jar:8.0.33]\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessage(WsRemoteEndpointImplBase.java:300) ~[tomcat-websocket.jar:8.0.33]\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase$TextMessageSendHandler.write(WsRemoteEndpointImplBase.java:759) ~[tomcat-websocket.jar:8.0.33]\n\tat org.apache.tomcat.websocket.WsRemoteEndpointImplBase.sendStringByCompletion(WsRemoteEndpointImplBase.java:216) ~[tomcat-websocket.jar:8.0.33]\n\tat org.apache.tomcat.websocket.WsRemoteEndpointAsync.sendText(WsRemoteEndpointAsync.java:47) ~[tomcat-websocket.jar:8.0.33]\n\tat org.atmosphere.container.version.JSR356WebSocket.write(JSR356WebSocket.java:73) ~[atmosphere-runtime-2.2.7.jar:2.2.7]\n\tat org.atmosphere.websocket.WebSocket.write(WebSocket.java:254) ~[atmosphere-runtime-2.2.7.jar:2.2.7]\n\tat org.atmosphere.websocket.WebSocket.write(WebSocket.java:219) ~[atmosphere-runtime-2.2.7.jar:2.2.7]\n\tat org.atmosphere.websocket.WebSocket.write(WebSocket.java:47) ~[atmosphere-runtime-2.2.7.jar:2.2.7]\n\tat org.atmosphere.cpr.AtmosphereResponse$2.write(AtmosphereResponse.java:531) ~[atmosphere-runtime-2.2.7.jar:2.2.7]\n\tat org.atmosphere.handler.AbstractReflectorAtmosphereHandler.onStateChange(AbstractReflectorAtmosphereHandler.java:148) ~[atmosphere-runtime-2.2.7.jar:2.2.7]\n\tat org.atmosphere.cpr.DefaultBroadcaster.invokeOnStateChange(DefaultBroadcaster.java:1074) [atmosphere-runtime-2.2.7.jar:2.2.7]\n\tat org.atmosphere.cpr.DefaultBroadcaster.prepareInvokeOnStateChange(DefaultBroadcaster.java:1094) [atmosphere-runtime-2.2.7.jar:2.2.7]\n\tat org.atmosphere.cpr.DefaultBroadcaster.executeAsyncWrite(DefaultBroadcaster.java:899) [atmosphere-runtime-2.2.7.jar:2.2.7]\n\tat org.atmosphere.cpr.DefaultBroadcaster$3.run(DefaultBroadcaster.java:520) [atmosphere-runtime-2.2.7.jar:2.2.7]\n\tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) [?:1.8.0_74]\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266) [?:1.8.0_74]\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_74]\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_74]\n\tat java.lang.Thread.run(Thread.java:745) [?:1.8.0_74]", "is_private": false, "bug_id": 59635, "id": 191259, "time": "2016-05-25T15:07:37Z", "creator": "l.kasparek@laudert.de", "creation_time": "2016-05-25T15:07:37Z", "attachment_id": null}, {"text": "Bug 59189 is unlikely to be related to this report.\n\nBug 58414, r1703948 and r1732900 look more likely to be related.\n\nGiven that the unit tests pass and the Autobahn tests pass, this looks like some form of edge case. A simple test case that demonstrates the problem would be very helpful. I'll continue to look into this but if I can't reproduce this or discover the problem via code inspection, a test case will be required.", "tags": [], "bug_id": 59635, "is_private": false, "count": 1, "id": 191271, "time": "2016-05-26T13:31:45Z", "creator": "markt@apache.org", "creation_time": "2016-05-26T13:31:45Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "l.kasparek@laudert.de", "is_private": false, "id": 191315, "attachment_id": 33901, "bug_id": 59635, "creation_time": "2016-05-30T14:09:21Z", "time": "2016-05-30T14:09:21Z", "text": "Created attachment 33901\ntest case for described problem\n\nThanks for the quick response,\n\nI have created a small wicket-atmosphere-quickstart that represents the described problem.\n\nIt is a simple Wicket application, having one Homepage.\nIn WicketApplication.java I am setting the EventBus to use Websockets.\nAlso I am setting the max size per session to 20 kilobytes. This is important for the test case. \n\nThe quickstart is a maven project, so you can simply deploy the war to your tomcat.\n\nHow to recreate the exception:\n- Open multible tabs, ca. 10 (by opening multiple tabs, the session limit of 20 kilobytes will overfill and the pages will be removed from Wicket's Pagestore)\n- now simply click \"Sent Message\"\n\nThe exception will occur after the message \"Could not find a page with id '30' for session with id 'xxx' in the page stores. It will be unregistered\", but only in Tomcat 8.0.0.33-35."}, {"count": 3, "tags": [], "creator": "markt@apache.org", "is_private": false, "id": 191413, "attachment_id": null, "bug_id": 59635, "creation_time": "2016-06-06T12:52:41Z", "time": "2016-06-06T12:52:41Z", "text": "The provided test case works without error with 9.0.x, 8.5.x, 8.0.x and the 8.0.33 tag."}, {"count": 4, "tags": [], "text": "Since the test case works fine for you, I made a video. \nThe video shows exactly what I'm doing to avoid ambiguities or misunderstandings.\n\nThe video is too big to upload it here, so I have uploaded the video to following link: https://drive.google.com/file/d/0B4yjMTnPKTzWampXSEdTS0NWQmc/view?usp=sharing\nThe quality of the video should be better when you download it.\n\nIn the video I am starting a local Tomcat instance in my IntelliJ IDE.\nIt builds the project and deploys the war to my tomcat that runs on my localhost.\n\nIn the video you can also see that the described exception doesn't occur in Tomcat 8.0.32. \nI also tested newer versions and I still have the same behavior.\n\nThanks for your efforts.", "attachment_id": null, "id": 191443, "creator": "l.kasparek@laudert.de", "time": "2016-06-07T12:33:47Z", "bug_id": 59635, "creation_time": "2016-06-07T12:33:47Z", "is_private": false}, {"count": 5, "tags": [], "creator": "remm@apache.org", "is_private": false, "id": 191444, "attachment_id": null, "bug_id": 59635, "creation_time": "2016-06-07T12:45:11Z", "time": "2016-06-07T12:45:11Z", "text": "A video is not a usable test case. Please don't reopen a report or a NEEDINFO issue without one."}, {"text": "The video was meant to be an additional instruction to the test case I have almost attached because the exception didn't occur when Mark tested it.", "tags": [], "bug_id": 59635, "is_private": false, "count": 6, "id": 191445, "time": "2016-06-07T12:57:58Z", "creator": "l.kasparek@laudert.de", "creation_time": "2016-06-07T12:57:58Z", "attachment_id": null}]