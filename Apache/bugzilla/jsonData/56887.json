[{"count": 0, "tags": [], "text": "Created attachment 31942\nPatch: remove names referencing removed sheet\n\nSummary: [PATCH] Remove names pointing at a sheet when the sheet is deleted\n\nSee attached patch.\n\nIf a Name is scoped to a particular worksheet, then onSheetDelete removes the name when the sheet is removed.\n\nIf the Name is however global, but points at the sheet being deleted (so that Name.getSheetName refers to the deleted sheet), the Name is not removed.\n\nIt'd be preferable if the Name was also removed in this case. Patch including unit test attached.", "is_private": false, "id": 177367, "creator": "dtn-asfbugs@corefiling.co.uk", "time": "2014-08-26T11:33:51Z", "bug_id": 56887, "creation_time": "2014-08-26T11:33:51Z", "attachment_id": 31942}, {"count": 1, "tags": [], "text": "Could you confirm what the behaviour is in Microsoft Excel when you delete a sheet with a global name pointing to it?", "is_private": false, "id": 177368, "creator": "apache@gagravarr.org", "time": "2014-08-26T11:51:19Z", "bug_id": 56887, "creation_time": "2014-08-26T11:51:19Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 56887, "attachment_id": null, "is_private": false, "id": 177371, "time": "2014-08-26T12:44:16Z", "creator": "dtn-asfbugs@corefiling.co.uk", "creation_time": "2014-08-26T12:44:16Z", "text": "Excel leaves the name intact but replaces references to DeletedSheetName with #REF!\n\nI had previously thought that POI's current behaviour was leading to workbooks which Excel refused to open without repairing. However, I'm struggling to reproduce that, so perhaps this should be left as-is."}, {"count": 3, "tags": [], "text": "I'm somewhat minded to say we ought to do the same\n\nThat might also be what we already effectively do for HSSF, since that stores sheet references in formulas (like names) differently and by index\n\nCould you tweak your unit test to try for .xls / hssf too, so we can verify what happens there?", "attachment_id": null, "id": 177372, "creator": "apache@gagravarr.org", "time": "2014-08-26T13:04:01Z", "bug_id": 56887, "creation_time": "2014-08-26T13:04:01Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 56887, "attachment_id": null, "is_private": false, "id": 191552, "time": "2016-06-11T03:12:06Z", "creator": "onealj@apache.org", "creation_time": "2016-06-11T03:12:06Z", "text": "From o.a.p.hssf.model.InternalWorkbook#removeSheet:\n>> Within NameRecords, it's ok to have the formula\n>>  part point at deleted sheets. It's also ok to\n>>  have the ExternSheetNumber point at deleted\n>>  sheets.\n>> However, the sheet index must be adjusted, or\n>>  excel will break. (Sheet index is either 0 for\n>>  global, or 1 based index to sheet)\n\nLooks like the Names cleanup may need to span HSSFWorkbook and InternalWorkbook since HSSFWorkbook maintains a data structure for HSSFNames."}]