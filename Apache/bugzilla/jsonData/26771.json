[{"count": 0, "tags": [], "creator": "bugzilla77@free.fr", "attachment_id": null, "is_private": false, "id": 51921, "time": "2004-02-08T15:58:29Z", "bug_id": 26771, "creation_time": "2004-02-08T15:58:29Z", "text": "Here's a patch that updates the mod_status (untouched since 1998).\nClosed html tags, now validated html 4.01T, sortable table columns, ergonomics\n(readability).\n\nSome javascript comes from GNU licence v2. Anyones knows how to deal with this ?\n(right to use ?)\n\n\ndiff -u apache_1.3.27/src/modules/standard/mod_status.c\napache_1.3.27_perso/src/modules/standard/mod_status.c\n--- apache_1.3.27/src/modules/standard/mod_status.c\t2002-03-13\n22:05:34.000000000 +0100\n+++ apache_1.3.27_perso/src/modules/standard/mod_status.c\t2004-02-08\n16:58:05.000000000 +0100\n@@ -94,6 +94,8 @@\n  *          extended STATUS is enabled) [George Burgyan/Jim J.]\n  * 10.8.98  Allow for extended status info at runtime (no more STATUS)\n  *          [Jim J.]\n+ * 08.2.04  Fixed unclosed tags. Added stylesheet and javascript sorting ability\n+ *          on table display. Readability enhancements [Cartegnie Francois]\n  */\n \n #define CORE_PRIVATE\n@@ -343,10 +345,95 @@\n     ap_hard_timeout(\"send status info\", r);\n \n     if (!short_report) {\n-\tap_rputs(DOCTYPE_HTML_3_2\n-\t\t \"<HTML><HEAD>\\n<TITLE>Apache Status</TITLE>\\n</HEAD><BODY>\\n\",\n+\tap_rputs(DOCTYPE_HTML_4_0T\n+\t\t \"<HTML><HEAD>\\n<TITLE>Apache Status</TITLE>\\n\",\n \t\t r);\n-\tap_rputs(\"<H1>Apache Server Status for \", r);\n+\n+    if (!no_table_report) {\n+\tap_rputs(\"<STYLE TYPE=\\\"text/css\\\"><!--\\n\\\n+\t\tBODY,TD,TH,P{font-family: Verdana, Arial, Helvetica, sans-serif;font-size:\n10pt;}\\n\\\n+\t\tTD {background:#FFFFFF; padding:2px;}\\n\\\n+\t\tPRE {font-family: Courier, Courier New; letter-spacing:2pt;}\\n\\\n+\t\tTD.tab {text-align:center; text-decoration: underline; font-weight:\nbold;border:none;}\\n\\\n+\t\tTD.tab:hover {text-decoration: none; cursor:pointer;}\\n\\\n+\t\tTABLE.stats {background:#F0F0F0; text-decoration: none; width:100%;}\\n\\\n+\t\tTD.numeric {text-align:right;}\n+\t\tTD.centered {text-align:center;}\n+\t\t//--></STYLE>\\n\",r);\n+\t\t\n+\n+\t\tap_rputs(\"<script type=\\\"text/javascript\\\"><!--\\n\\\n+\t\tvar _tabLast=null;\\n\\\n+\t\tfunction _rObj (s,ar) {\\n\\\n+\t\t this.s = s;\\n\\\n+\t\t this.ar = ar;\\n\\\n+\t\t}\\n\\\n+\t\tfunction _tabCreateArray(obj,st){\\n\\\n+\t\t\tvar tb=obj.parentNode.parentNode;\\n\\\n+\t\t\tvar rw=obj.parentNode.parentNode.rows;\\n\\\n+\t\t\tvar _nRows=rw.length;\\n\\\n+\t\t\tvar _tabS=new Array(_nRows-1);\\n\\\n+\t\t\tvar _nCells = rw.item(0).cells.length;\\n\\\n+\t\t\tfor(var i=1;i<_nRows;i++){\\n\\\n+\t\t\t\tvar _raw = rw.item(i).cells.item(obj.cellIndex).innerHTML;\\n\\\n+\t\t\t\t\t\tif (st==1) {\\n\\\n+\t\t\t\t\t_raw = _raw.replace((new RegExp('\\\\\\\\\\\\(','gi')), '');\\n\\\n+\t\t\t\t   if (_raw.indexOf(\\\":\\\") != -1) { _raw = _raw.substring(2,99); }\\n\\\n+\t\t\t\t if (_raw.search(new RegExp(\\\"[TGMk]\\\",\\\"i\\\"))) {\\n\\\n+\t\t\t\t  if (_raw.indexOf(\\\"T\\\") != -1) { _raw = parseFloat(_raw) * 1024 * 1024 *\n1024 * 1024; } \\n\\\n+\t\t\t\t  else {\\n\\\n+\t\t\t\t\tif (_raw.indexOf(\\\"G\\\") != -1) { _raw = parseFloat(_raw) * 1024 * 1024 *\n1024; } \\n\\\n+\t\t\t\t\telse {\\n\\\n+\t\t\t\t\t\t if (_raw.indexOf(\\\"M\\\") != -1) { _raw = parseFloat(_raw) * 1024 * 1024;\n} \\n\\\n+\t\t\t\t\t\t else {\\n\\\n+\t\t\t\t\t\t\tif (_raw.indexOf(\\\"k\\\") != -1) { _raw = parseFloat(_raw) * 1024; }\\n\\\n+\t\t\t\t\t\t }\\n\\\n+\t\t\t\t\t}\\n\\\n+\t\t\t      }\\n\\\n+\t\t\t\t}}\\n\\\n+\t\t\t\t\t_tabS[i-1]= new _rObj(_raw,rw.item(i).cloneNode(true));\\n\\\n+\t\t\t}\\n\\\n+\t\t\tif (st==1) { _tabS.sort(_cmpFloat); }\\n\\\n+\t\t\telse { _tabS.sort(_cmpTxt); }\\n\\\n+\t\t\tif (!_tabMode) {_tabS.reverse()}\t\t\t\\n\\\n+\t\t\tfor(var i=0;i<_nRows-1;i++){\\n\\\n+\t\t\t\t\tvar tr = _tabS[i].ar.cloneNode(true);\\n\\\n+\t\t\t\t\tvar oChild=tb.rows.item(i+1);\\n\\\n+\t\t\t\t\tif (i % 2 == 0) { tr.className = 'dl-1'; } \\n\\\n+\t\t\t\t               else { tr.className = 'dl-2'; }\\n\\\n+\t\t\t\t\ttb.replaceChild(tr,oChild);\\n\\\n+\t\t\t}\\n\\\n+\t\t\\n\\\n+\t\t}\\n\\\n+\t\tfunction _cmpTxt(a,b) {\\n\\\n+\t\t\tif (_tabMode) {\\n\\\n+\t\t\t\tif (a.s==\\\"\\\") { if (b.s !=\\\"\\\") { return 1;} }\\n\\\n+\t\t\t\tif (b.s==\\\"\\\") { if (a.s !=\\\"\\\") { return -1;} }\\n\\\n+\t\t\t}\\n\\\n+\t\t\tif (a.s.toUpperCase() < b.s.toUpperCase()) {return -1;}\\n\\\n+\t\t\tif (a.s.toUpperCase() > b.s.toUpperCase()) {return 1;}\\n\\\n+\t\t\treturn 0;\\n\\\n+\t\t}\\n\\\n+\t\tfunction _cmpFloat(a,b) {\\n\\\n+\t\t\tif (!_tabMode) {\\n\\\n+\t\t\t\tif (a.s==\\\"\\\") { if (b.s !=\\\"\\\") { return -1;} }\\n\\\n+\t\t\t\tif (b.s==\\\"\\\") { if (a.s !=\\\"\\\") { return 1;} }\\n\\\n+\t\t\t}\\n\\\n+\t\t\tif (isNaN(parseFloat(a.s))) {return 1;}\\n\\\n+\t\t\tif (isNaN(parseFloat(b.s))) {return -1;}\\n\\\n+\t\t\treturn (parseFloat(b.s) - parseFloat(a.s));\\n\\\n+\t\t}\\n\\\n+\t\tfunction _tabSort(obj,st){\\n\\\n+\t\t\tif (_tabLast==obj) {_tabMode=!(_tabMode);} \\n\\\n+\t\t\telse {_tabMode=true;}\\n\\\n+\t\t\t_tabCreateArray(obj,st);\\n\\\n+\t\t\t_tabLast=obj;\\n\\\n+\t\t\treturn _tabMode;\\n\\\n+\t\t}\\n\\\n+\t\t//--></script>\\n\", r);\n+    }\n+        \n+\tap_rputs(\"</HEAD><BODY>\\n<H1>Apache Server Status for \", r);\n \tap_rvputs(r, ap_get_server_name(r), \"</H1>\\n\\n\", NULL);\n \tap_rvputs(r, \"Server Version: \",\n \t  ap_get_server_version(), \"<br>\\n\", NULL);\n@@ -448,7 +535,7 @@\n \tap_rputs(\"\\n\", r);\n     else {\n \tap_rputs(\"</PRE>\\n\", r);\n-\tap_rputs(\"Scoreboard Key: <br>\\n\", r);\n+\tap_rputs(\"<P>Scoreboard Key: <br>\\n\", r);\n \tap_rputs(\"\\\"<B><code>_</code></B>\\\" Waiting for Connection, \\n\", r);\n \tap_rputs(\"\\\"<B><code>S</code></B>\\\" Starting up, \\n\", r);\n \tap_rputs(\"\\\"<B><code>R</code></B>\\\" Reading Request,<BR>\\n\", r);\n@@ -457,8 +544,8 @@\n \tap_rputs(\"\\\"<B><code>D</code></B>\\\" DNS Lookup,<BR>\\n\", r);\n \tap_rputs(\"\\\"<B><code>L</code></B>\\\" Logging, \\n\", r);\n \tap_rputs(\"\\\"<B><code>G</code></B>\\\" Gracefully finishing, \\n\", r);\n-\tap_rputs(\"\\\"<B><code>.</code></B>\\\" Open slot with no current process<P>\\n\", r);\n-\tap_rputs(\"<P>\\n\", r);\n+\tap_rputs(\"\\\"<B><code>.</code></B>\\\" Open slot with no current process\\n\", r);\n+\tap_rputs(\"</P>\\n\", r);\n \tif (!ap_extended_status) {\n \t    int j = 0;\n \t    ap_rputs(\"PID Key: <br>\\n\", r);\n@@ -482,13 +569,13 @@\n     if (ap_extended_status) {\n \tif (!short_report) {\n \t    if (no_table_report)\n-\t\tap_rputs(\"<p><hr><h2>Server Details</h2>\\n\\n\", r);\n+\t\tap_rputs(\"<p><hr><h2>Server Details</h2>\\n\\n</p>\", r);\n \t    else\n #ifdef NO_TIMES\n \t\t/* Allow for OS/2 not having CPU stats */\n-\t\tap_rputs(\"<p>\\n\\n<table\nborder=0><tr><th>Srv<th>PID<th>Acc<th>M\\n<th>SS<th>Req<th>Conn<th>Child<th>Slot<th>Client<th>VHost<th>Request</tr>\\n\\n\",\nr);\n+\t\tap_rputs(\"<p>\\n\\n<table class=\\\"stats\\\"><tr><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,0);\\\">Srv</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,1);\\\">PID</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,0);\\\">Acc</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,0);\\\">M\\n</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,1);\\\">SS</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,1);\\\">Req</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,1);\\\">Conn</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,1);\\\">Child</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,1);\\\">Slot</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,0);\\\">Client</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,0);\\\">VHost</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,0);\\\">Request</td></tr>\\n\\n\", r);\n #else\n-\t\tap_rputs(\"<p>\\n\\n<table\nborder=0><tr><th>Srv<th>PID<th>Acc<th>M<th>CPU\\n<th>SS<th>Req<th>Conn<th>Child<th>Slot<th>Client<th>VHost<th>Request</tr>\\n\\n\",\nr);\n+\t\tap_rputs(\"<p>\\n\\n<table class=\\\"stats\\\"><tr><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,0);\\\">Srv</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,1);\\\">PID</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,0);\\\">Acc</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,0);\\\">M</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,1);\\\">CPU\\n</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,1);\\\">SS</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,1);\\\">Req</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,1);\\\">Conn</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,1);\\\">Child</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,1);\\\">Slot</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,0);\\\">Client</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,0);\\\">VHost</td><td class=\\\"tab\\\"\nonClick=\\\"_tabSort(this,0);\\\">Request</td></tr>\\n\\n\", r);\n #endif\n \t}\n \n@@ -609,53 +696,53 @@\n \t\t    else {\t\t/* !no_table_report */\n \t\t\tif (score_record.status == SERVER_DEAD)\n \t\t\t    ap_rprintf(r,\n-\t\t\t\t\"<tr><td><b>%d-%d</b><td>-<td>%d/%lu/%lu\",\n+\t\t\t\t\"<tr><td class=\\\"numeric\\\"><b>%d-%d</b></td><td class=\\\"numeric\\\">-</td><td\nclass=\\\"numeric\\\">%d/%lu/%lu</td>\",\n \t\t\t\ti, (int) ps_record.generation,\n \t\t\t\t(int) conn_lres, my_lres, lres);\n \t\t\telse\n \t\t\t    ap_rprintf(r,\n-\t\t\t\t\"<tr><td><b>%d-%d</b><td>%d<td>%d/%lu/%lu\",\n+\t\t\t\t\"<tr><td class=\\\"numeric\\\"><b>%d-%d</b></td><td\nclass=\\\"numeric\\\">%d</td><td class=\\\"numeric\\\">%d/%lu/%lu</td>\",\n \t\t\t\ti, (int) ps_record.generation,\n \t\t\t\t(int) ps_record.pid, (int) conn_lres,\n \t\t\t\tmy_lres, lres);\n \n \t\t\tswitch (score_record.status) {\n \t\t\tcase SERVER_READY:\n-\t\t\t    ap_rputs(\"<td>_\", r);\n+\t\t\t    ap_rputs(\"<td class=\\\"centered\\\">_</td>\", r);\n \t\t\t    break;\n \t\t\tcase SERVER_STARTING:\n-\t\t\t    ap_rputs(\"<td><b>S</b>\", r);\n+\t\t\t    ap_rputs(\"<td class=\\\"centered\\\"><b>S</b></td>\", r);\n \t\t\t    break;\n \t\t\tcase SERVER_BUSY_READ:\n-\t\t\t    ap_rputs(\"<td><b>R</b>\", r);\n+\t\t\t    ap_rputs(\"<td class=\\\"centered\\\"><b>R</b></td>\", r);\n \t\t\t    break;\n \t\t\tcase SERVER_BUSY_WRITE:\n-\t\t\t    ap_rputs(\"<td><b>W</b>\", r);\n+\t\t\t    ap_rputs(\"<td class=\\\"centered\\\"><b>W</b></td>\", r);\n \t\t\t    break;\n \t\t\tcase SERVER_BUSY_KEEPALIVE:\n-\t\t\t    ap_rputs(\"<td><b>K</b>\", r);\n+\t\t\t    ap_rputs(\"<td class=\\\"centered\\\"><b>K</b></td>\", r);\n \t\t\t    break;\n \t\t\tcase SERVER_BUSY_LOG:\n-\t\t\t    ap_rputs(\"<td><b>L</b>\", r);\n+\t\t\t    ap_rputs(\"<td class=\\\"centered\\\"><b>L</b></td>\", r);\n \t\t\t    break;\n \t\t\tcase SERVER_BUSY_DNS:\n-\t\t\t    ap_rputs(\"<td><b>D</b>\", r);\n+\t\t\t    ap_rputs(\"<td class=\\\"centered\\\"><b>D</b></td>\", r);\n \t\t\t    break;\n \t\t\tcase SERVER_DEAD:\n-\t\t\t    ap_rputs(\"<td>.\", r);\n+\t\t\t    ap_rputs(\"<td class=\\\"centered\\\">.</td>\", r);\n \t\t\t    break;\n \t\t\tcase SERVER_GRACEFUL:\n-\t\t\t    ap_rputs(\"<td>G\", r);\n+\t\t\t    ap_rputs(\"<td class=\\\"centered\\\">G</td>\", r);\n \t\t\t    break;\n \t\t\tdefault:\n-\t\t\t    ap_rputs(\"<td>?\", r);\n+\t\t\t    ap_rputs(\"<td class=\\\"centered\\\">?</td>\", r);\n \t\t\t    break;\n \t\t\t}\n #ifdef NO_TIMES\n \t\t\t/* Allow for OS/2 not having CPU stats */\n-\t\t\tap_rprintf(r, \"\\n<td>%.0f<td>%ld\",\n+\t\t\tap_rprintf(r, \"\\n<td class=\\\"numeric\\\">%.0f</td><td class=\\\"numeric\\\">%ld</td>\",\n #else\n-\t\t\tap_rprintf(r, \"\\n<td>%.2f<td>%.0f<td>%ld\",\n+\t\t\tap_rprintf(r, \"\\n<td class=\\\"numeric\\\">%.2f</td><td\nclass=\\\"numeric\\\">%.0f</td><td class=\\\"numeric\\\">%ld</td>\",\n \t\t\t    (score_record.times.tms_utime +\n \t\t\t     score_record.times.tms_stime +\n \t\t\t     score_record.times.tms_cutime +\n@@ -667,15 +754,15 @@\n \t\t\t    difftime(nowtime, score_record.last_used),\n #endif\n \t\t\t    (long) req_time);\n-\t\t\tap_rprintf(r, \"<td>%-1.1f<td>%-2.2f<td>%-2.2f\\n\",\n+\t\t\tap_rprintf(r, \"<td class=\\\"numeric\\\">%-1.1f</td><td\nclass=\\\"numeric\\\">%-2.2f</td><td class=\\\"numeric\\\">%-2.2f</td>\\n\",\n \t\t\t   (float) conn_bytes / KBYTE, (float) my_bytes / MBYTE,\n \t\t\t    (float) bytes / MBYTE);\n \t\t\tif (score_record.status == SERVER_BUSY_READ)\n \t\t\t    ap_rprintf(r,\n-\t\t\t     \"<td>?<td nowrap>?<td nowrap>..reading.. </tr>\\n\\n\");\n+\t\t\t     \"<td class=\\\"centered\\\">?</td><td class=\\\"centered\\\" nowrap>?</td><td\nnowrap>..reading.. </td></tr>\\n\\n\");\n \t\t\telse\n \t\t\t    ap_rprintf(r,\n-\t\t\t     \"<td>%s<td nowrap>%s<td nowrap>%s</tr>\\n\\n\",\n+\t\t\t     \"<td class=\\\"centered\\\">%s</td><td class=\\\"centered\\\" nowrap>%s</td><td\nnowrap>%s</td></tr>\\n\\n\",\n \t\t\t     ap_escape_html(r->pool, score_record.client),\n \t\t\t     vhost ? ap_escape_html(r->pool, \n \t\t\t\tvhost->server_hostname) : \"(unavailable)\",\n@@ -687,33 +774,33 @@\n \n \tif (!(short_report || no_table_report)) {\n #ifdef NO_TIMES\n-\t    ap_rputs(\"</table>\\n \\\n+\t    ap_rputs(\"</table></p>\\n \\\n <hr> \\\n <table>\\n \\\n-<tr><th>Srv<td>Child Server number - generation\\n \\\n-<tr><th>PID<td>OS process ID\\n \\\n-<tr><th>Acc<td>Number of accesses this connection / this child / this slot\\n \\\n-<tr><th>M<td>Mode of operation\\n \\\n-<tr><th>SS<td>Seconds since beginning of most recent request\\n \\\n-<tr><th>Req<td>Milliseconds required to process most recent request\\n \\\n-<tr><th>Conn<td>Kilobytes transferred this connection\\n \\\n-<tr><th>Child<td>Megabytes transferred this child\\n \\\n-<tr><th>Slot<td>Total megabytes transferred this slot\\n \\\n+<tr><th>Srv</th><td>Child Server number - generation</td></tr>\\n \\\n+<tr><th>PID</th><td>OS process ID</td></tr>\\n \\\n+<tr><th>Acc</th><td>Number of accesses this connection / this child / this\nslot</td></tr>\\n \\\n+<tr><th>M</th><td>Mode of operation</td></tr>\\n \\\n+<tr><th>SS</th><td>Seconds since beginning of most recent request</td></tr>\\n \\\n+<tr><th>Req</th><td>Milliseconds required to process most recent\nrequest</td></tr>\\n \\\n+<tr><th>Conn</th><td>Kilobytes transferred this connection</td></tr>\\n \\\n+<tr><th>Child</th><td>Megabytes transferred this child</td></tr>\\n \\\n+<tr><th>Slot</th><td>Total megabytes transferred this slot</td></tr>\\n \\\n </table>\\n\", r);\n #else\n \t    ap_rputs(\"</table>\\n \\\n <hr> \\\n <table>\\n \\\n-<tr><th>Srv<td>Child Server number - generation\\n \\\n-<tr><th>PID<td>OS process ID\\n \\\n-<tr><th>Acc<td>Number of accesses this connection / this child / this slot\\n \\\n-<tr><th>M<td>Mode of operation\\n \\\n-<tr><th>CPU<td>CPU usage, number of seconds\\n \\\n-<tr><th>SS<td>Seconds since beginning of most recent request\\n \\\n-<tr><th>Req<td>Milliseconds required to process most recent request\\n \\\n-<tr><th>Conn<td>Kilobytes transferred this connection\\n \\\n-<tr><th>Child<td>Megabytes transferred this child\\n \\\n-<tr><th>Slot<td>Total megabytes transferred this slot\\n \\\n+<tr><th>Srv</th><td>Child Server number - generation</td></tr>\\n \\\n+<tr><th>PID</th><td>OS process ID</td></tr>\\n \\\n+<tr><th>Acc</th><td>Number of accesses this connection / this child / this\nslot</td></tr>\\n \\\n+<tr><th>M</th><td>Mode of operation</td></tr>\\n \\\n+<tr><th>CPU</th><td>CPU usage, number of seconds</td></tr>\\n \\\n+<tr><th>SS</th><td>Seconds since beginning of most recent request</td></tr>\\n \\\n+<tr><th>Req</th><td>Milliseconds required to process most recent\nrequest</td></tr>\\n \\\n+<tr><th>Conn</th><td>Kilobytes transferred this connection</td></tr>\\n \\\n+<tr><th>Child</th><td>Megabytes transferred this child</td></tr>\\n \\\n+<tr><th>Slot</th><td>Total megabytes transferred this slot</td></tr>\\n \\\n </table>\\n\", r);\n #endif\n \t}"}, {"count": 1, "tags": [], "creator": "nd@perlig.de", "attachment_id": null, "id": 51923, "time": "2004-02-08T16:33:05Z", "bug_id": 26771, "creation_time": "2004-02-08T16:33:05Z", "is_private": false, "text": "First: I don't see this happen in 1.3, sorry. Many scripts out there will rely\non the current format. Anyway it may be an enhancement request for 2.2.\n\nFurthermore, we cannot redistribute GPL'd stuff in our code, since this would\nnot be compliant with the Apache License (from our side).\n\nThanks for using Apache."}]