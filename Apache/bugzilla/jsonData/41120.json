[{"count": 0, "text": "If you define an external filter and the actual filter does not exist, or for\ninstance is not executable, then the data sent back to the browser becomes\ncorrupted.\n\nUsing a build of httpd 2.2.3 on solaris 9, all content was removed (headers\nstill present) resulting in a blank page. When processing content served by a\nbackend tomcat server (using mod_proxy_ajp) the content was (apprently\narbitrarily) missing a certain number of bytes from the begining.\n\nThe only error in the error_log file was as follows:\n\n[Wed Dec 06 16:30:27 2006] [error] [client 10.0.3.19] (32)Broken pipe:\nef_unified_filter() failed\n\nDroppping a valid filter onto the file system results in an immediate fix.\n\nSample configuration/filter:\n\nExtFilterDefine testfilter cmd=\"/var/tmp/filter.pl\"\n<Location />\n  SetOutputFilter testfilter\n</Location>\n\nAnd simply make sure the file /var/tmp/filter.pl does not exist. URLs should\nstop working. Then put the following in /var/tmp/filter.pl:\n\n#!/usr/local/bin/perl\n\nuse strict;\n\nwhile (<STDIN>)\n{\n  print;\n}\n\nMake it executable. Now URLs should be served correctly.", "bug_id": 41120, "attachment_id": null, "id": 96595, "time": "2006-12-07T02:34:21Z", "creator": "stimmins@wiley.co.uk", "creation_time": "2006-12-07T02:34:21Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 41120, "attachment_id": null, "is_private": false, "id": 96601, "time": "2006-12-07T04:07:11Z", "creator": "trawick@apache.org", "creation_time": "2006-12-07T04:07:11Z", "text": "You could experiment with a code change like this (several lines after call to\ninit_filter_instance()):\n\nstatic apr_status_t ef_output_filter(ap_filter_t *f, apr_bucket_brigade *bb)\n{\n    request_rec *r = f->r;\n    ef_ctx_t *ctx = f->ctx;\n    apr_status_t rv;\n\n    if (!ctx) {\n        if ((rv = init_filter_instance(f)) != APR_SUCCESS) {\n            /* return rv; */\n            ap_log_rerror(APLOG_MARK, APLOG_ERR, 0, f->r,\n                          \"mod_ext_filter: ignoring error, sending unfiltered\ndata\");\n            f->etx->noop = 1;\n        }\n        ctx = f->ctx;\n    }\n    if (ctx->noop) {\n        ap_remove_output_filter(f);\n        return ap_pass_brigade(f->next, bb);\n    }\n\nThis doesn't seem so useful in the grand scheme of things.  It seems to me\nrather rare that somebody would\n\n*) implement/configure a filter\n*) not test it immediately after configuration to ensure that it actually worked\n*) desire for data to be sent unfiltered if the filter can't be started\n\nI wonder if this scenario was confusing because of how the error was handled?\nMaybe the output filter was called again even after it returned an error the\nfirst time, and that led to the garbled output instead of no output?\n\nThat seems unlikely, but I don't see how else you'd be missing just the first\npart of the response.  If it can happen then this patch might help:\n\nIndex: mod_ext_filter.c\n===================================================================\n--- mod_ext_filter.c\t(revision 482178)\n+++ mod_ext_filter.c\t(working copy)\n@@ -67,6 +67,7 @@\n     ef_dir_t *dc;\n     ef_filter_t *filter;\n     int noop;\n+    apr_status_t perm_error;\n #if APR_FILES_AS_SOCKETS\n     apr_pollset_t *pollset;\n #endif\n@@ -855,10 +856,15 @@\n \n     if (!ctx) {\n         if ((rv = init_filter_instance(f)) != APR_SUCCESS) {\n+            f->ctx->perm_error = rv;\n             return rv;\n         }\n         ctx = f->ctx;\n     }\n+    else if (ctx->perm_error != 0) {\n+        return ctx->perm_error;\n+    }\n+    \n     if (ctx->noop) {\n         ap_remove_output_filter(f);\n         return ap_pass_brigade(f->next, bb);"}, {"count": 2, "tags": [], "creator": "nick@webthing.com", "is_private": false, "text": "Fixed in trunk in r731358.\n\nThis would actually not have happened with DebugLevel 2 in ExtFilterOptions.  But relying on debug is not acceptable, particularly where an external program might fail to start for other reasons such as system too busy.  So I've made the startup check unconditional, and added a configuration option to abort or continue without the filter.", "id": 123744, "time": "2009-01-04T12:53:54Z", "bug_id": 41120, "creation_time": "2009-01-04T12:53:54Z", "attachment_id": null}, {"count": 3, "attachment_id": null, "bug_id": 41120, "text": "Fix backported to 2.2 in r732586", "id": 123851, "time": "2009-01-07T17:40:11Z", "creator": "nick@webthing.com", "creation_time": "2009-01-07T17:40:11Z", "tags": [], "is_private": false}]