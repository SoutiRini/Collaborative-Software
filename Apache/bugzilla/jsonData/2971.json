[{"count": 0, "tags": [], "text": "The <sql> task does not seem to release the memory after the task is \ncompleted.  When running the <sql> task numberous times from the same VM, an \nout of memory error occurs.  Here is the <sql> target:\n\n<sql driver=\"${db.driver}\" url=\"${db.url}\"\nuserid=\"${db.user}\" password=\"${db.pwd}\" autocommit=\"true\" onerror=\"continue\">\n<classpath>\n<fileset dir=\"lib\" includes=\"j2ee.jar,jdbc_sql7.jar,jdbc_oracle8.jar,jdbc_db2-\n7.jar,jconn2.jar\"/>\n</classpath>\n<transaction src=\"blank-file.sql\"/>  <-just a blank file\n</sql> \n\n${db.driver}:\ncom.inet.tds.TdsDriver (mssql 7.0)\nCOM.ibm.db2.jdbc.net.DB2Driver (DB2 version 7)\noracle.jdbc.driver.OracleDriver (Oracle 81)\n\n${db.url}:\njdbc:inetdae7:localhost?database=dbname (mssql 7.0)\njdbc:db2://localhost/dbname (DB2 version 7)\njdbc:oracle:thin:@localhost:dbname (Oracle 81)\n\nWith an oracle driver, the out of memory error occurs after 38 <sql> calls.\nWith an mssql driver, the out of memory error occurs after 379 <sql> calls.\nWith an db2 driver, the out of memory error occurs after 124 <sql> calls.\nNote: the number of <sql> calls may vary depending on the computer", "attachment_id": null, "id": 4241, "creator": "stephen.wong@everypath.com", "time": "2001-08-02T11:34:19Z", "bug_id": 2971, "creation_time": "2001-08-02T11:34:19Z", "is_private": false}, {"count": 1, "tags": [], "creator": "conor@apache.org", "attachment_id": null, "text": "What VM?\n\nI have run some real SQL, not a blank file and I can see freeMemory going up \nand down, so at a very gross view, it doesn't appear to be leaking (Oracle). \nHow are you calling the <sql> multiple times?\n\n", "id": 4258, "time": "2001-08-03T09:34:49Z", "bug_id": 2971, "creation_time": "2001-08-03T09:34:49Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 2971, "attachment_id": null, "id": 4361, "time": "2001-08-08T06:13:32Z", "creator": "stephen.wong@everypath.com", "creation_time": "2001-08-08T06:13:32Z", "is_private": false, "text": "Here is how I set up my build.xml to call the <sql> target.\n\n<project name=\"build.xml\" default=\"run\"\tbasedir=\".\">\n\n<target name=\"run-sql-task>\n\n<sql driver=\"${db.driver}\" url=\"${db.url}\" userid=\"${db.user}\" \npassword=\"${db.pwd}\" autocommit=\"true\" onerror=\"continue\">\n\n<classpath>\n<fileset dir=\"lib\" includes=\"j2ee.jar,jdbc_sql7.jar,jdbc_oracle8.jar,jdbc_db2-\n7.jar,jconn2.jar\"/>\n</classpath>\n<transaction src=\"blank-file.sql\"/>  <-just a blank file\n\n</sql> \n</target>\n<target name=\"run\">\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<antcall target=\"run-sql-task\" />\n\t<!-- runs out of memory after 38 calls with an oracle driver-->\n</target>\n</project>\n"}, {"count": 3, "tags": [], "creator": "bodewig@apache.org", "attachment_id": null, "text": "well, I'd blame the OutOfMemory on <antcall>, not <sql>, especially on the\nAntClassLoader associated with each <sql> task in your subbuilds.\n\nCould you please try that with a recent nightly build, we've fixed some potential\nmemory leaks.", "id": 4362, "time": "2001-08-08T06:21:18Z", "bug_id": 2971, "creation_time": "2001-08-08T06:21:18Z", "is_private": false}, {"count": 4, "tags": [], "creator": "stephen.wong@everypath.com", "attachment_id": null, "text": "I used the nightly build from August 8, 2001 and the out of memory problem \nstill occurs. I used both jakarta-ant-1.4alpha-src.zip and jakarta-ant-1.4alpha-\nbin.zip (from 2001-08-08) and got the same results.  ", "id": 4386, "time": "2001-08-08T12:11:31Z", "bug_id": 2971, "creation_time": "2001-08-08T12:11:31Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 2971, "text": "I have verified that this will fail with out of memory. It is not due to the \nantcalls since I ran an inlined version which also failed. Investigating.", "id": 4623, "time": "2001-08-19T00:26:51Z", "creator": "conor@apache.org", "creation_time": "2001-08-19T00:26:51Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 2971, "text": "I have done some further research. The issue appears to be related to the \nloaidng of the driver in the classloader which does not seem to be garbage \ncollected. Not easy to figure that one through. \n\nIn the meantime, I tried a workaround/optimisation where the drivers are cache \nbased on the classpath/drivername. This prevents the out of memory error and \nalso makes the creation of the connection, etc much faster. I'll probably \ncommit that after 1.4 is released.", "id": 4624, "time": "2001-08-19T05:39:47Z", "creator": "conor@apache.org", "creation_time": "2001-08-19T05:39:47Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "creator": "sbailliez@apache.org", "attachment_id": null, "text": "We just bumped into this here.\nIt shows up with the Oracle OCI driver that loads each time a native lib.\n\nConor, what's the status of the patch you are mentioning ?", "id": 8209, "time": "2001-11-23T04:07:13Z", "bug_id": 2971, "creation_time": "2001-11-23T04:07:13Z", "is_private": false}, {"count": 8, "tags": [], "creator": "sbailliez@apache.org", "attachment_id": null, "text": "Should be fixed in CVS HEAD or wait for the next nightly build.\n\nI did a naive fix where I'm caching the loader based on the driver name.\nIt would be better to use a combination of driver name/classpath but I have \nrarely seen the need to run different versions of a driver in the same run, so \nthis should not be such an issue.\n\nI tested with mysql and everything goes well with 5000 calls in 160 secs. \nRoughly it is 10-15 times faster than without caching.\n\nI will commit a simple testcase to make it easy for people to run such tests.", "id": 9135, "time": "2001-12-21T14:59:40Z", "bug_id": 2971, "creation_time": "2001-12-21T14:59:40Z", "is_private": false}, {"count": 9, "tags": [], "creator": "sbailliez@apache.org", "attachment_id": null, "text": "*** Bug 9840 has been marked as a duplicate of this bug. ***", "id": 17739, "time": "2002-06-13T14:53:28Z", "bug_id": 2971, "creation_time": "2002-06-13T14:53:28Z", "is_private": false}]