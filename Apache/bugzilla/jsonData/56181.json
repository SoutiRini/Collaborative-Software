[{"count": 0, "tags": [], "text": "When clients connect to Tomcat through a proxy or load balancer that adds a remoteIpHeader (eg. \"x-forwarded-for\") and the attribute \"enableLookups\" is set to \"true\", the expected behavior is that hostname of the clients is resolved by Tomcat.\n\nHowever it is not, if the method getRemoteHost() is called on a HttpServletRequest object, the IP is always returned, not the hostname.\n\nIn the classes org.apache.catalina.valves.RemoteIpValve and org.apache.catalina.filters.RemoteIpFilter we see that the IP is set to the Hostname field without any option to do the reverse DNS lookup:\n\nrequest.setRemoteAddr(remoteIp);\nrequest.setRemoteHost(remoteIp);\n\n\nInstead the pseudo code could be something like:\n\nrequest.setRemoteAddr(remoteIp);\n\nif(enableRemoteIpLookups == true){\n    request.setRemoteHost(InetAddress.getByName(remoteIp).getHostName());\n}\n\n\nPerhaps, instead of using \"enableLookups\" to indicate the reverse DNS lookup wants to be done for requests passing through a proxy it should be better to have a new Tomcat attribute for this (like enableRemoteIpLookups), because perhaps you do not want to lookups of the proxies IP but just the remoteIp (x-forwarded-for).\n\nNote, this issue applies also to Tomcat 8.", "is_private": false, "id": 173439, "creator": "yannart@gmail.com", "time": "2014-02-23T17:22:49Z", "bug_id": 56181, "creation_time": "2014-02-23T17:22:49Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 56181, "attachment_id": null, "id": 173441, "time": "2014-02-23T23:12:01Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-02-23T23:12:01Z", "is_private": false, "text": "For reference - discussion thread on the users list (Feb 20)\nhttp://tomcat.markmail.org/thread/2c4jo2ryqv74zgpp\n\nChanging severity to 'enhancement'."}, {"count": 2, "text": "I don't see any reason to differentiate between proxied and non-proxied clients.", "creator": "markt@apache.org", "is_private": false, "id": 173454, "time": "2014-02-24T17:42:38Z", "bug_id": 56181, "creation_time": "2014-02-24T17:42:38Z", "tags": [], "attachment_id": null}, {"count": 3, "attachment_id": null, "bug_id": 56181, "is_private": false, "id": 173458, "time": "2014-02-25T01:19:21Z", "creator": "yannart@gmail.com", "creation_time": "2014-02-25T01:19:21Z", "tags": [], "text": "The only reason to differentiate between proxied and non-proxied clients is if you want to do reverse DNS lookup only for proxied clients and not for the non-proxied clients (if for example we know it is always the Load Balancer or the Proxy IP) for performance reasons."}]