[{"count": 0, "tags": [], "bug_id": 48520, "attachment_id": null, "text": "Since Apache 2.2.12 (up to 2.2.14) Apache mod_substitute only applies the changes to first match. Using Apache 2.2.11 (compilation flags below) works as expected: all the substitutions are applied, and using Apache 2.2.12 and more modern only apply the change to the first match.\n\n<Location /xml/>\n  ProxyPassReverse /\n  AddOutputFilterByType SUBSTITUTE text/html\n  Substitute \"s|http://.*/something.asp\\?c=client-.*?&(.*)|/otherthing/?$1|i\"\n  Substitute \"s|/bla/something.asp\\?c=client-.*?&(.*)|/otherthing/?$1|i\"\n  Substitute \"s|/foo/something.asp\\?c=sportsnetwork&(.*)|/scores/?$1|i\"\n  RequestHeader   unset   Accept-Encoding\n</Location>\n\nUndoing change introduced in r755190 (http://svn.apache.org/viewvc?view=revision&revision=755190) to Apache 2.2.14 (patch attached) solves the issue.\n\nconfigure parameters used for the compilation is described below (the same for 2.2.14, except for the prefix)\n\n\"./configure\" \\\n\"--prefix=/usr/local/apache-2.2.11\" \\\n\"--with-mpm=worker\" \\\n\"--enable-suexec\" \\\n\"--with-suexec\" \\\n\"--with-suexec-caller=apache\" \\\n\"--with-suexec-uidmin=500\" \\\n\"--with-suexec-gidmin=100\" \\\n\"--enable-pie\" \\\n\"--enable-mods-shared=all\" \\\n\"--enable-ssl\" \\\n\"--with-ssl\" \\\n\"--enable-distcache\" \\\n\"--enable-proxy\" \\\n\"--enable-cache\" \\\n\"--enable-mem-cache\" \\\n\"--enable-file-cache\" \\\n\"--enable-disk-cache\" \\\n\"--enable-ldap\" \\\n\"--enable-authnz-ldap\" \\\n\"--enable-cgid\" \\\n\"--enable-authn-anon\" \\\n\"--enable-authn-alias\" \\\n\"--disable-imagemap\" \\\n\"--with-mpm=prefork\" \\", "id": 133508, "time": "2010-01-11T09:30:29Z", "creator": "pablo@docecosas.com", "creation_time": "2010-01-11T09:30:29Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 48520, "attachment_id": null, "id": 133511, "time": "2010-01-11T09:46:41Z", "creator": "rpluem@apache.org", "creation_time": "2010-01-11T09:46:41Z", "is_private": false, "text": "Can you please provide an example string and what is the current behaviour and what you expect as behaviour?\nWhat do mean by \"only the first match\"? Only the first Substitute directive is honored? Or do you mean that if the search pattern occurs multiple times it is only replaced the first time?"}, {"count": 2, "tags": [], "bug_id": 48520, "text": "Created attachment 24883\nDirectory with a test HTML that shows the wrong behaviour in mod_substitute", "id": 133827, "attachment_id": 24883, "creator": "pablo@docecosas.com", "creation_time": "2010-01-22T02:12:42Z", "time": "2010-01-22T02:12:42Z", "is_private": false}, {"text": "Created attachment 24884\nPatch to httpd-2.2.14 that solves the issue", "tags": [], "bug_id": 48520, "attachment_id": 24884, "count": 3, "id": 133828, "time": "2010-01-22T02:13:44Z", "creator": "pablo@docecosas.com", "creation_time": "2010-01-22T02:13:44Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 48520, "attachment_id": null, "id": 133830, "time": "2010-01-22T02:18:41Z", "creator": "pablo@docecosas.com", "creation_time": "2010-01-22T02:18:41Z", "is_private": false, "text": "Adding the supplied test HTML to the docroot directory and this configuration to the default httpd.conf in httpd-2.2.14 you should expect to see all the links pointing to /scores/ but only the first one gets substituted.\n\n<Location /test_sub/>\n  AddOutputFilterByType SUBSTITUTE text/html\n  Substitute \"s|http://.*/merge/tsnform.aspx\\?c=client-.*?&(.*)|/scores/?$1|i\"\n  Substitute \"s|/merge/tsnform.aspx\\?c=client-.*?&(.*)|/scores/?$1|i\"\n  Substitute \"s|/merge/tsnform.aspx\\?c=sportsnetwork&(.*)|/scores/?$1|i\"\n  Substitute \"s|http://images.sportsnetwork.com/(.*)|/scores/resources/images/$1|i\"\n  Substitute \"s|http://.*/fury/(.*)|/scores/resources/fury/$1|i\"\n  #Substitute \"s|/xml/(.*)|/scores/resources/xml/$1|i\"\n  Substitute \"s|/images/(.*)|/scores/resources/images/$1|i\"\n  RequestHeader   unset   Accept-Encoding\n\n</Location>\n\nApplying the suggested patch or using httpd-2.2.11 shows the expected behaviour: all the links are substituted."}, {"count": 5, "tags": [], "text": "(In reply to comment #3)\n> Created an attachment (id=24884) [details]\n> Patch to httpd-2.2.14 that solves the issue\n\nThis patch is wrong (actually it is a revert of r755190) which would cause a regression that can result in an endless loop.", "is_private": false, "id": 133835, "creator": "rpluem@apache.org", "time": "2010-01-22T04:05:08Z", "bug_id": 48520, "creation_time": "2010-01-22T04:05:08Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 48520, "text": "(In reply to comment #4)\n> Adding the supplied test HTML to the docroot directory and this configuration\n> to the default httpd.conf in httpd-2.2.14 you should expect to see all the\n> links pointing to /scores/ but only the first one gets substituted.\n> \n> <Location /test_sub/>\n>   AddOutputFilterByType SUBSTITUTE text/html\n>   Substitute \"s|http://.*/merge/tsnform.aspx\\?c=client-.*?&(.*)|/scores/?$1|i\"\n>   Substitute \"s|/merge/tsnform.aspx\\?c=client-.*?&(.*)|/scores/?$1|i\"\n>   Substitute \"s|/merge/tsnform.aspx\\?c=sportsnetwork&(.*)|/scores/?$1|i\"\n>   Substitute\n> \"s|http://images.sportsnetwork.com/(.*)|/scores/resources/images/$1|i\"\n>   Substitute \"s|http://.*/fury/(.*)|/scores/resources/fury/$1|i\"\n>   #Substitute \"s|/xml/(.*)|/scores/resources/xml/$1|i\"\n>   Substitute \"s|/images/(.*)|/scores/resources/images/$1|i\"\n>   RequestHeader   unset   Accept-Encoding\n> \n> </Location>\n> \n> Applying the suggested patch or using httpd-2.2.11 shows the expected\n> behaviour: all the links are substituted.\n\nAs everything in your testfile is in one line the result is as expected as your regular expressions are just plain wrong. They should be\n\n   Substitute \"s|http://.*/merge/tsnform.aspx\\?c=client-.*?&(.*)\\\"|/scores/?$1|i\"\n   Substitute \"s|/merge/tsnform.aspx\\?c=client-.*?&(.*)\\\"|/scores/?$1|i\"\n   Substitute \"s|/merge/tsnform.aspx\\?c=sportsnetwork&(.*)\\\"|/scores/?$1|i\"\n   Substitute\n \"s|http://images.sportsnetwork.com/(.*)\\\"|/scores/resources/images/$1|i\"\n   Substitute \"s|http://.*/fury/(.*)\\\"|/scores/resources/fury/$1|i\"\n   #Substitute \"s|/xml/(.*)\\\"|/scores/resources/xml/$1|i\"\n   Substitute \"s|/images/(.*)\\\"|/scores/resources/images/$1|i\"", "id": 133836, "time": "2010-01-22T04:49:39Z", "creator": "rpluem@apache.org", "creation_time": "2010-01-22T04:49:39Z", "is_private": false, "attachment_id": null}]