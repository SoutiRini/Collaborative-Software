[{"count": 0, "tags": [], "text": "Auto reconnect option in apr_dbd_mysql is set to 1:\n\n#if MYSQL_VERSION_ID >= 50013\n    my_bool do_reconnect = 1;\n#endif\n\nThis forces mysql_ping(), which is called by dbd_mysql_check_conn(), to reconnect if connection to MySQL server was lost.\n\nBut lost connection also means that all prepared statements are lost. And because statements are prepared only when dbd_construct() is called, one can not use prepared statements any more.\n\nI think we should set do_reconnect to 0 by default.", "is_private": false, "id": 118702, "creator": "mkevac@gmail.com", "time": "2008-07-16T04:49:53Z", "bug_id": 45407, "creation_time": "2008-07-16T04:49:53Z", "attachment_id": null}, {"count": 1, "tags": [], "text": "dbd_construct() is from mod_dbd\n\nAnyway. There are no way to know if mysql_ping() reconnected to MySQL server or if connection was just fine.\n\nSo we don't know if we should prepare statements one more time.", "attachment_id": null, "id": 118703, "creator": "mkevac@gmail.com", "time": "2008-07-16T04:53:17Z", "bug_id": 45407, "creation_time": "2008-07-16T04:53:17Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 45407, "attachment_id": null, "is_private": false, "id": 118860, "time": "2008-07-21T02:09:46Z", "creator": "bojan@rexursive.com", "creation_time": "2008-07-21T02:09:46Z", "text": "I think dbd_construct() should remember if it successfully prepared that statement in the past (i.e. if the statement was generally good). When _pselect() fails and we had a good prepared statement, then this means that prepared statement was lost due to reconnect, so it should be prepared again.\n\nDoes that make sense?"}, {"count": 3, "attachment_id": null, "creator": "mkevac@gmail.com", "is_private": false, "id": 118866, "time": "2008-07-21T04:28:24Z", "bug_id": 45407, "creation_time": "2008-07-21T04:28:24Z", "tags": [], "text": "Well, this will probably work, but I think that it is not so good solution.\n\nFirst, when pselect() fails, it gives error 2013 (CR_SERVER_LOST), but connection exists and select() works well. This is a little bit confusing and it is not clear for user whether he should reconnect or he just needs to prepare statements one more time.\n\nSecond, thing you are talking about should be implemented not only in mod_dbd, but also in modules, that prepare statements by themself, but use mod_dbd for pools and easy API. It's not good design I think.\n\nWhat do you think?"}, {"count": 4, "attachment_id": null, "creator": "bojan@rexursive.com", "text": ">First, when pselect() fails, it gives error 2013 (CR_SERVER_LOST), but connection exists and select() works well.\n\nI think this is the key here. It is obvious that if select() works (or if apr_dbd_check_conn() is OK) that connectivity of that particular prepared statement is the problem (i.e. because the connection for which it was prepared was lost). So, the logical thing to do it to prepare the statement again. No?", "id": 118867, "time": "2008-07-21T04:35:54Z", "bug_id": 45407, "creation_time": "2008-07-21T04:35:54Z", "tags": [], "is_private": false}, {"count": 5, "tags": [], "bug_id": 45407, "text": "It is obvious if you know about this. But if someone sees error 'connection lost' and he does not that this can possibly be error with prepared statement, his first step will be to reconnect or invalidate reslist element.\n\nAnyway, that's not the point. Let's say that we know that if pselect() returns 'connection lost' error, we should prepare statements one more time.\n\nThere are two types of prepared statements.\nFirst, ones from DBDPrepare (mod_dbd). Second, statements that were prepared with apr library in modules that use mod_dbd or in modules that don't use mod_dbd at all.\n\nmod_dbd does not know anything about statements that were prepared in other modules. So feature 'if pselect gives error, prepare one more time' should be implemented in mod_dbd and in all modules, that use apr_dbd_mysql.\n\nThis 'lot of coding in a lot of places' can be avoided with just turning off reconnect. Maybe not by default, but there should be option.\n\nIn this case, after connection lost, mysql_ping will not reconnect and it will return error. apr_reslist element will be invalidated and new connection will be created and statements will be prepared (in dbd_construct). It is not large overhead, becaule mysql_ping reconnects anyway.", "id": 118869, "time": "2008-07-21T04:57:08Z", "creator": "mkevac@gmail.com", "creation_time": "2008-07-21T04:57:08Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 45407, "is_private": false, "text": "> Maybe not by default, but there should be option.\n\nI think this is what we should do. MySQL DBD driver understand some options, we can teach it to understand this too.", "id": 118870, "time": "2008-07-21T05:08:12Z", "creator": "bojan@rexursive.com", "creation_time": "2008-07-21T05:08:12Z", "attachment_id": null}, {"count": 7, "tags": [], "creator": "bojan@rexursive.com", "attachment_id": 22294, "id": 118882, "time": "2008-07-21T16:39:59Z", "bug_id": 45407, "creation_time": "2008-07-21T16:39:59Z", "is_private": false, "text": "Created attachment 22294\nIntroduce reconnection option to MySQL DBD driver"}, {"attachment_id": null, "tags": [], "bug_id": 45407, "text": "Does the patch work for you? In your connection string you should say reconnect=0.", "count": 8, "id": 118883, "time": "2008-07-21T16:40:52Z", "creator": "bojan@rexursive.com", "creation_time": "2008-07-21T16:40:52Z", "is_private": false}, {"count": 9, "attachment_id": null, "creator": "mkevac@gmail.com", "text": "Yes. It works as it should. Thank you.\n\nI think that information about problem with reconnect, prepared statements and explanation how to avoid it should be in mod_dbd documentation on httpd.apache.org. What should I do to initiate documentation change process? Open bug?", "id": 118888, "time": "2008-07-21T23:28:06Z", "bug_id": 45407, "creation_time": "2008-07-21T23:28:06Z", "tags": [], "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 45407, "text": "Excellent, thanks for testing.\n\nYes, open a bug for httpd to get this documented.\n\nI'll commit the patch to the trunk and if there are no objections by other developers, I'll backport it to 1.3.x.", "count": 10, "id": 118889, "time": "2008-07-21T23:39:57Z", "creator": "bojan@rexursive.com", "creation_time": "2008-07-21T23:39:57Z", "is_private": false}, {"count": 11, "tags": [], "text": "This fix should fix bug 39329 as well, as far as I read it. Or am I misunderstanding something?", "is_private": false, "id": 119559, "creator": "peter@poeml.de", "time": "2008-08-07T13:24:17Z", "bug_id": 45407, "creation_time": "2008-08-07T13:24:17Z", "attachment_id": null}, {"count": 12, "tags": [], "text": "Maybe. I think this is something for folks playing with mod_dbd and MySQL to test.", "attachment_id": null, "id": 119575, "creator": "bojan@rexursive.com", "time": "2008-08-07T16:10:01Z", "bug_id": 45407, "creation_time": "2008-08-07T16:10:01Z", "is_private": false}, {"count": 13, "attachment_id": null, "creator": "gpetme@gmail.com", "text": "I have run into this problem on RHEL 4, running Apache 2.2.10 and MySQL 5.0.67. The patch doesn't seem to fix the problem for me.\n\nI tried using reconnect=0 in my database connection string. The relevant part of my configuration is below (the DBDParams is all on one line, just in case it wraps).\n\n<VirtualHost *:80>\n\n   DBDriver mysql\n   DBDParams host=localhost,port=3306,user=my_db_user,pass=my_db_pass,dbname=auth_db,reconnect=0,sock=/var/lib/mysql/mysql.sock\n   DBDPersist on\n\n   <Directory /path/to/protected/files>\n      AllowOverride None\n      Order allow,deny\n      Allow from all\n      AuthName \"protected\"\n      AuthType Digest\n      AuthDigestProvider dbd\n      Require valid-user\n      AuthDBDUserRealmQuery \"SELECT digest FROM users WHERE username = %s AND realm = %s\" \n   </Directory>\n\n</VirtualHost>\n\nIs there something I can provide to give more information? Or, does my configuration above need to be adjusted?\n\nThanks in advance for any help you can provide.\n\nGreg", "id": 123182, "time": "2008-12-08T15:26:44Z", "bug_id": 45407, "creation_time": "2008-12-08T15:26:44Z", "tags": [], "is_private": false}]