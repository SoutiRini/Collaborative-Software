[{"count": 0, "tags": [], "bug_id": 10539, "attachment_id": null, "id": 19097, "time": "2002-07-07T23:51:18Z", "creator": "fredrikv@biotech.kth.se", "creation_time": "2002-07-07T23:51:18Z", "is_private": false, "text": "Problem:\n========\nThe reply to PROPFIND queries returns \"dummytoken\" as lock token \ninstead of the correct lock token. This confuses Adobe Golive 6.0 \nand Macromedia Dreamweaver MX and they can't be used for editing \nresources on a Tomcat 4 server.\n\nThe behaviour is observed on Tomcat 4.x (4.0.4-4.1.7b).\n\n\nDiscussion:\n===========\nThis issue has been discussed at least once before, see URL\nhttp://faqchest.dynhost.com/prgm/tomcat-l/tmct-01/tmct-0111/tmct-011114/tmct0111\n0721_30463.html\nwhere, Remy Maucherat says\n>the behavior is correct (servers are allowed to obsfucate \n>lock-tokens returned by a PROPFIND)\n\nI guess this is based on section 13.8 that states:\n>13.8 lockdiscovery Property\n[---]\n>Description: The lockdiscovery property returns a listing of who has\n>a lock, \nwhat type of lock he has, the timeout type and the time\n>remaining on the \ntimeout, and the associated lock token.  The server\n>is free to withhold any or \nall of this information if the requesting\n>principal does not have sufficient \naccess rights to see the requested\n>data.\n\nAs I understand it, the server can only refuse to show the lock token\nif the user is not authenticated. Now, even when using the right \ncredentials, the lock token is not returned by Tomcat.\n\nThere is one other applicable example 13.8.1 in the RFC that returns \nthe correct token, and as Golive and Dreamweaver does not work at all\nwith the dummy token enabled, I suggest changing Tomcat's reply to the\ncorrect lock token for PROPFIND queries.\n\nThe main reason I can see for providing a dummy token would be that \nanybody listening can unlock it if the correct token is used. This is \ncovered in RFC2518 section 6.3:\n>Having a lock token provides no special access rights. Anyone can\n>find out \nanyone else's lock token by performing lock discovery.\n>Locks MUST be enforced \nbased upon whatever authentication mechanism\n>is used by the server, not based \non the secrecy of the token values.\n\n\nSolution:\n=========\nChange WebdavServlet.java to return the correct lock token every time.\nFor example, the change can be done according to this diff -u file:\n(not tested because I can't build Tomcat from sources)\n\n--- WebdavServlet.java\tSun Jul  7 23:37:28 2002\n+++ WebdavServlet.java.orig\t\nSun Jul  7 22:35:29 2002\n@@ -2667,7 +2667,7 @@\n          * append an XML \nfragment to the given XML writer.\n          */\n         public void toXML(XMLWriter generatedXML) {\n-            toXML(generatedXML, true);\n+            toXML(generatedXML, false);\n         }\n\nAlternatively, there should be a possibility to set the behaviour \n(dummytoken=no/yes) in a configuration file. As this problem is \nquite convoluted to find, the default should be not to use dummies.\n\n\nExample:\n========\nUsing Golive 6.0 and Tomcat 4.1.7-beta (as recorded by httpsniffer.pl)\nThe file /davtest/test.txt contains a short text and was locked by the\nsame application in the last transaction when the correct lock token\nwas returned. Now it does a PROPFIND when I'm trying to unlock the file.\n\n>> Query\n --> C05 --> S06 ==== (60) Request <PROPFIND /davtest/test.txt HTTP/1.0>\n --> C05 --> S06 PROPFIND /davtest/test.txt HTTP/1.0\n --> C05 --> S06 accept-language: en_US\n --> C05 --> S06 depth: 0\n --> C05 --> S06 Mime-Version: 1.0\n --> C05 --> S06 Content-Type: text/xml\n --> C05 --> S06 Content-Length: 332\n --> C05 --> S06 Host: localhost:80\n --> C05 --> S06 Connection: keep-alive\n --> C05 --> S06 Keep-Alive: 300\n --> C05 --> S06 Accept: */*\n --> C05 --> S06 ==== Body 332 bytes\n --> C05 --> S06   Body  => <?xml version=\"1.0\" encoding=\"utf-8\" ?><D:propfind \nxmlns:D=\"DAV:\"><D:prop \nxmlns:AGL=\"http://ns.adobe.com/golive/5.0/\"><D:creationdate/><D:displayname/><D:\ngetcontentlanguage/><D:getcontentlength/><D:getcontenttype/><D:getetag/><D:getla\nstmodified/><D:lockdiscovery/><D:resourcetype/><D:source/><D:supportedlock/></D:\nprop></D:propfind>\n\n\n<< Reply\n <-- C05 <-- S06 ==== (60) Response 207 to <PROPFIND /davtest/test.txt HTTP/1.0>\n <-- C05 <-- S06 HTTP/1.1 207 Multi-Status\n <-- C05 <-- S06 Content-Type: text/xml; charset=UTF-8\n <-- C05 <-- S06 Connection: close\n <-- C05 <-- S06 Date: Sun, 07 Jul 2002 20:04:18 GMT\n <-- C05 <-- S06 Server: Apache Tomcat/4.1.7 (HTTP/1.1 Connector)\n <-- C05 <-- S06 ==== Body 1031 bytes\n <-- C05 <-- S06   Body  => <?xml version=\"1.0\" encoding=\"utf-8\" ?>\n<multistatus xmlns=\"DAV:\"><response><href>/davtest/test.txt</href>\n<propstat><prop><creationdate>2002-07-07T19:47:44Z</creationdate>\n<displayname><![CDATA[test.txt]]></displayname>\n<getcontentlanguage>sv_SE</getcontentlanguage>\n<getcontentlength>24</getcontentlength>\n<getcontenttype>text/plain</getcontenttype>\n<getetag>24-1026071264185</getetag>\n<getlastmodified>Sun, 07 Jul 2002 19:47:44 GMT</getlastmodified>\n<lockdiscovery><activelock><locktype><write/></locktype>\n<lockscope><exclusive/></lockscope>\n<depth>0</depth>\n<owner>fredrikv</owner>\n<timeout>Second-604799</timeout>\n<locktoken><href>opaquelocktoken:dummytoken</href>\n</locktoken>\n</activelock>\n</lockdiscovery>\n<resourcetype/><source></source>\n<supportedlock><lockentry><lockscope><exclusive/></lockscope><locktype><write/><\n/locktype></lockentry><lockentry><lockscope><shared/></lockscope><locktype><writ\ne/></locktype></lockentry></supportedlock>\n</prop>\n<status>HTTP/1.1 200 OK</status>\n</propstat>\n</response>\n</multistatus>\n\n\n\t/Fredrik"}, {"count": 1, "tags": [], "creator": "remm@apache.org", "is_private": false, "text": "The lock token is only returned when setting the token. It is legal to obsfucate\nthe token for security reasons. The client should hang on to the token it got\nwhen locking.", "id": 19135, "time": "2002-07-08T19:39:47Z", "bug_id": 10539, "creation_time": "2002-07-08T19:39:47Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "julian.reschke@gmx.de", "attachment_id": null, "text": "First of all, even if there is a legitimate reason not to reveal the lock token \n(which?) upon PROPFIND, there are some more considerations.\n\n1) \"opaquelocktoken:dummytoken\" does not conform the opaquelocktoken URI syntax \ndefined by RFC2518. So if the server doesn't want to reveal the token but \nchooses to include one in DAV:lockdiscovery, it should generate a legal one (it \njust needs to be a URI that will never work for UNLOCK).\n\n2) There's also the option not to return the locktoken in DAV:lockdiscovery. \nSee: <http://lists.w3.org/Archives/Public/w3c-dist-auth/2003JulSep/0185.html>\n", "id": 46043, "time": "2003-10-22T11:44:18Z", "bug_id": 10539, "creation_time": "2003-10-22T11:44:18Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 10539, "attachment_id": null, "is_private": false, "id": 46047, "time": "2003-10-22T12:00:43Z", "creator": "remm@apache.org", "creation_time": "2003-10-22T12:00:43Z", "text": "*** Bug 21284 has been marked as a duplicate of this bug. ***"}, {"count": 4, "tags": [], "text": "\n\n*** This bug has been marked as a duplicate of 27100 ***", "is_private": false, "bug_id": 10539, "id": 59542, "time": "2004-06-18T23:54:05Z", "creator": "markt@apache.org", "creation_time": "2004-06-18T23:54:05Z", "attachment_id": null}]