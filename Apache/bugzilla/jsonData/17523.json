[{"count": 0, "tags": [], "bug_id": 17523, "attachment_id": null, "id": 32148, "time": "2003-02-28T13:06:14Z", "creator": "ivanfm@users.sourceforge.net", "creation_time": "2003-02-28T13:06:14Z", "is_private": false, "text": "Problem occur when I start tomcat (with securityManager) and try to \nrun one servlet that uses Session, I got ClassNotFound Exception.\n\nIf I load one jsp page that uses session it works and then the session \nwill work for the servlets too.\n\nWhy this ? \nThe Class needed is inside \nserver/lib/tomcat-coyote.jar\n\nThis lib are not available to applications. \n\nI don't know why it works for JSP as it is inside\ncommon/lib/jasper-compiler.jar\ncommon/lib/jasper-runtime.jar\n\nAnd in my mind I have read in some place, the classes in common also \ncan't access classes in server/lib.\n\nProbably the solution for this is to include in\norg/apache/catalina/startup/SecurityClassLoad.java\nor\norg/apache/coyote/tomcat4/CoyoteRequest.java\n\nto load the class :\norg/apache/coyote/tomcat4/CoyoteRequest$PrivilegedGetSession\n\n\nI don't have here the correct environment to build Tomcat and\ntest one of this solutions.\n\n\n\n\n\nTest Servlet\n-------------------------------------------------------------\nimport java.io.IOException;\nimport java.io.PrintWriter;\nimport javax.servlet.ServletException;\nimport javax.servlet.http.HttpServlet;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\n\npublic class TS extends HttpServlet {\n\n\n\n   public void doGet(HttpServletRequest request,\n                     HttpServletResponse response)\n       throws ServletException, IOException {\n       PrintWriter pw = new PrintWriter(response.getWriter());\n       pw.println(\"<p>Teste\");\n       pw.println(\"<p>\");\n       pw.println(request.getSession(false));\n       pw.println(\"<p>\");\n       pw.println(request.getSession(true));\n   }\n}\n\n------------------------------------------------------------------------\n\njavax.servlet.ServletException: Invoker service() exception\n\tat\norg.apache.catalina.servlets.InvokerServlet.serveRequest(InvokerServlet.java:524)\n\tat\norg.apache.catalina.servlets.InvokerServlet.doGet(InvokerServlet.java:180)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:740)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:853)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:247)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.access$000(ApplicationFilterChain.java:98)\n\tat\norg.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:176)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:172)\n\tat\norg.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:260)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n\tat\norg.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n\tat\norg.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat\norg.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n\tat\norg.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n\tat\norg.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat\norg.apache.catalina.core.StandardContext.invoke(StandardContext.java:2415)\n\tat\norg.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:180)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n\tat\norg.apache.catalina.valves.ErrorDispatcherValve.invoke(ErrorDispatcherValve.java:170)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:641)\n\tat\norg.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:172)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:641)\n\tat\norg.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n\tat\norg.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat\norg.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:174)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n\tat\norg.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n\tat\norg.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat\norg.apache.coyote.tomcat4.CoyoteAdapter.service(CoyoteAdapter.java:223)\n\tat\norg.apache.coyote.http11.Http11Processor.process(Http11Processor.java:432)\n\tat\norg.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.processConnection(Http11Protocol.java:386)\n\tat\norg.apache.tomcat.util.net.TcpWorkerThread.runIt(PoolTcpEndpoint.java:534)\n\tat\norg.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:530)\n\tat java.lang.Thread.run(Thread.java:536)\n\nroot cause\n\njava.lang.NoClassDefFoundError:\norg/apache/coyote/tomcat4/CoyoteRequest$PrivilegedGetSession\n\tat\norg.apache.coyote.tomcat4.CoyoteRequest.getSession(CoyoteRequest.java:1728)\n\tat\norg.apache.coyote.tomcat4.CoyoteRequestFacade.getSession(CoyoteRequestFacade.java:365)\n\tat\njavax.servlet.http.HttpServletRequestWrapper.getSession(HttpServletRequestWrapper.java:260)\n\tat TS.doGet(TS.java:18)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:740)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:853)\n\tat\norg.apache.catalina.servlets.InvokerServlet.serveRequest(InvokerServlet.java:466)\n\tat\norg.apache.catalina.servlets.InvokerServlet.doGet(InvokerServlet.java:180)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:740)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:853)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:247)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.access$000(ApplicationFilterChain.java:98)\n\tat\norg.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:176)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:172)\n\tat\norg.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:260)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n\tat\norg.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n\tat\norg.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat\norg.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n\tat\norg.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n\tat\norg.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat\norg.apache.catalina.core.StandardContext.invoke(StandardContext.java:2415)\n\tat\norg.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:180)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n\tat\norg.apache.catalina.valves.ErrorDispatcherValve.invoke(ErrorDispatcherValve.java:170)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:641)\n\tat\norg.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:172)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:641)\n\tat\norg.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n\tat\norg.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat\norg.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:174)\n\tat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\n\tat\norg.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n\tat\norg.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n\tat\norg.apache.coyote.tomcat4.CoyoteAdapter.service(CoyoteAdapter.java:223)\n\tat\norg.apache.coyote.http11.Http11Processor.process(Http11Processor.java:432)\n\tat\norg.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.processConnection(Http11Protocol.java:386)\n\tat\norg.apache.tomcat.util.net.TcpWorkerThread.runIt(PoolTcpEndpoint.java:534)\n\tat\norg.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:530)\n\tat java.lang.Thread.run(Thread.java:536)"}, {"count": 1, "tags": [], "bug_id": 17523, "attachment_id": null, "id": 33714, "time": "2003-03-24T20:38:47Z", "creator": "ruvinsky@yahoo.com", "creation_time": "2003-03-24T20:38:47Z", "is_private": false, "text": "This is definitely a security-related bug.  I verified this to be a problem \neven on Tomcat 4.1.24.  The key to this is that \nCoyoteRequest$PrivilegedGetSession likely needs to be preloaded by the Tomcat \n[non-webapp] classloader.  At runtime, your servlet calls getSession, and \nCoyoteRequest attempts to load PrivilegedGetSession w/o enough permissions.  \nThe predecessor to CoyoteRequest had the same issue so its implementation of \nPrivilegedGetSession got preloaded during server initialization.\n\nThis bug gets masked when you access the admin webapp (for example) before \naccessing your untrusted servlet since the admin webapp has more runtime \nsecurity permissions than your untrusted servlet.\n\njava.lang.NoClassDefFoundError: \norg/apache/coyote/tomcat4/CoyoteRequest$PrivilegedGetSession\n\tat org.apache.coyote.tomcat4.CoyoteRequest.getSession\n(CoyoteRequest.java:1728)\n\tat org.apache.coyote.tomcat4.CoyoteRequestFacade.getSession\n(CoyoteRequestFacade.java:365)"}, {"count": 2, "tags": [], "bug_id": 17523, "text": "I hit this problem too.  After several hours, I realized that a workaround is \nto include the following in catalina.policy:\n\n\n        // needed to overcome Tomcat bug with Coyote\n        // http://nagoya.apache.org/bugzilla/show_bug.cgi?id=17523\n        // org.apache.coyote.tomcat4.CoyoteRequest.PrivilegedGetSession\n\nGrant {\n        permission \njava.lang.RuntimePermission \"defineClassInPackage.org.apache.coyote.tomcat4\";\n        permission \njava.lang.RuntimePermission \"defineClassInPackage.org.apache.coyote.tomcat4.*\";\n\n}\n\nHope this helps anyone else who hits this frustrating issue.", "id": 49761, "attachment_id": null, "creator": "wglass@forio.com", "creation_time": "2003-12-28T08:31:53Z", "time": "2003-12-28T08:31:53Z", "is_private": false}, {"count": 3, "tags": [], "creator": "Larry.Isaacs@sas.com", "attachment_id": null, "id": 51474, "time": "2004-01-30T15:06:49Z", "bug_id": 17523, "creation_time": "2004-01-30T15:06:49Z", "is_private": false, "text": "Thanks to Glenn Nielsen's update to \norg.apache.catalina.startup.SecurityClassLoad, this bug is fixed in Tomcat \n4.1.28 and later."}]