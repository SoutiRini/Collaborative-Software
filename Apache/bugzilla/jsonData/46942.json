[{"count": 0, "attachment_id": null, "bug_id": 46942, "text": "Description of problem:\n\nOn httpd graceful restart httpd error log show up this:\n[Tue Mar 31 12:50:42 2009] [error] [client 127.1.2.3] (43)Identifier removed: apr_global_mutex_lock(rewrite_log_lock) failed\n[Tue Mar 31 12:50:42 2009] [error] [client 127.1.2.3] (43)Identifier removed: apr_global_mutex_unlock(rewrite_log_lock) failed\n\n\nVersion-Release number of selected component (if applicable):\n\nSame Error show up in 2.2.11 upstream apache httpd release\n\n\nSteps to Reproduce:\n\n0. Build test apache: ./configure --prefix=/tmp/httpd-2.2.11 --enable-mods-shared=most --enable-ssl --enable-proxy\n1. Create directory /tmp/foo\n2. Add (this) minimal server config foo-httpd.conf:\n   --%<--\n     ServerRoot \"/tmp/foo\"\n     DocumentRoot \"/tmp/foo\"\n     PidFile /tmp/foo/httpd.pid\n     LoadModule dir_module /tmp/httpd-2.2.11/modules/mod_dir.so\n     LoadModule rewrite_module /tmp/httpd-2.2.11/modules/mod_rewrite.so\n     User nobody\n     Group nobody\n     ErrorLog  foo-error_log\n     RewriteLog foo-rewrite.log\n\n     RewriteLogLevel 1\n\n     Listen 127.1.2.3:8765\n     <VirtualHost 127.1.2.3:8765>\n         ServerName foo.bar\n         RewriteEngine On\n         RewriteOptions Inherit\n     </VirtualHost>\n   --%<--\n3. Start server: /tmp/httpd-2.2.11/bin/httpd -f /tmp/foo/foo-httpd.conf -k start\n4. Do graceful restart: /tmp/httpd-2.2.11/bin/httpd -f /tmp/foo/foo-httpd.conf -k graceful\n5. Find the apr_global_mutex_lock errors in /tmp/foo/foo-error_log\n  \nAdditional info:\n  The error messages vanish if \n    the RewriteLogLevel is set to 0\n  or \n    the RewriteOptions Inherit ist _not_ set\n\nKind Regards,\nRoland", "id": 125900, "time": "2009-03-31T04:27:03Z", "creator": "roland.friedwagner@wu-wien.ac.at", "creation_time": "2009-03-31T04:27:03Z", "tags": [], "is_private": false}, {"count": 1, "text": "I think I've figured out what's going on (with some help from Greg Ames).  Not sure yet how to fix it.\n\nThe global mutex used by mod_rewrite to serialize writing to the rewrite log is created in post_config().  So when the parent starts its graceful restart and cleans up the old configuration, it's going to clean up - destroy - that global mutex.  Children still finishing up requests now have a reference to a mutex that no longer exists, hence attempts to lock the mutex fail.\n\nI think the worst effect of this is the possibility that a few rewritelog messages get intermingled in the log, which isn't too important.  Still, it would be nice to figure out a way to make this work right.  Maybe somebody who knows how modules work better than I knows how to do this.", "bug_id": 46942, "attachment_id": null, "id": 127814, "time": "2009-06-10T13:07:17Z", "creator": "poirier@pobox.com", "creation_time": "2009-06-10T13:07:17Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 46942, "attachment_id": null, "text": "Ah, this was reported directly to us too - I took a look, and I can't see what the point of the logging serialisation is at all:\n\nhttp://marc.info/?l=apache-httpd-dev&m=124282193217344&w=2", "id": 127857, "time": "2009-06-11T01:01:27Z", "creator": "jorton@redhat.com", "creation_time": "2009-06-11T01:01:27Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 46942, "attachment_id": 23792, "text": "Created attachment 23792\nRemove global mod_rewrite log lock\n\nI like it!  The Gordian knot solution.\n\nHere's a patch against trunk to remove the lock.", "id": 127862, "time": "2009-06-11T04:36:01Z", "creator": "poirier@pobox.com", "creation_time": "2009-06-11T04:36:01Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 46942, "text": "Fixed in trunk as r783734.", "id": 127867, "time": "2009-06-11T05:20:14Z", "creator": "rpluem@apache.org", "creation_time": "2009-06-11T05:20:14Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 46942, "text": "2.2.12 / r792910", "count": 5, "id": 149395, "time": "2011-09-17T16:00:37Z", "creator": "sf@sfritsch.de", "creation_time": "2011-09-17T16:00:37Z", "is_private": false}]