[{"count": 0, "tags": [], "creator": "Alexander_Pircher@yahoo.de", "attachment_id": 23071, "id": 123716, "time": "2009-01-02T16:52:43Z", "bug_id": 46467, "creation_time": "2009-01-02T16:52:43Z", "is_private": false, "text": "Created attachment 23071\nGNU-Debugger-Output.txt\n\nDESCRIPTION:\nThe Apache-childs begin to segfault once Apache reaches 130 childs. This can\nbe reproduced every time by setting MinSpareServers to a value higher than 130.\nIt has been tested with 2.2.11, 2.2.10 and 2.2.9 which all have the same\nbehaviour. 2.0.63 is working fine.\n\nThe error_log contains:\n...\n[Sat Jan 03 01:32:34 2009] [notice] child pid 672 exit signal Segmentation fault (11)\n[Sat Jan 03 01:32:34 2009] [notice] child pid 673 exit signal Segmentation fault (11)\n[Sat Jan 03 01:32:34 2009] [notice] child pid 674 exit signal Segmentation fault (11)\n...\n\nAttached is the output of the gdb of one coredump.\n\nCONFIGURATION:\n./configure --prefix=/usr/local/bin/httpd --enable-suexec --with-suexec --enable-mods-shared=all --disable-imagemap\n\nFollowing lines have been added to httpd.conf:\n# ---------------------------------------------\n<IfModule prefork.c>\nStartServers      32\nMinSpareServers  200\nMaxSpareServers  400\nServerLimit      1600\nMaxClients       1600\nMaxRequestsPerChild  4000\n</IfModule>\n\nCoreDumpDirectory /tmp\n# ---------------------------------------------"}, {"count": 1, "tags": [], "bug_id": 46467, "is_private": false, "text": "Please provide the following information:\n\n- Kernel version\n- glibc version\n- Your httpd.conf\n- Your ulimits (ulimit -a)\n\nPlease execute the following steps with gdb when you have loaded your core dump:\n\nframe 1\np num_listensocks", "id": 123720, "time": "2009-01-03T01:31:12Z", "creator": "rpluem@apache.org", "creation_time": "2009-01-03T01:31:12Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "Alexander_Pircher@yahoo.de", "text": "Created attachment 23075\nhttpd.conf", "id": 123725, "time": "2009-01-03T13:26:32Z", "bug_id": 46467, "creation_time": "2009-01-03T13:26:32Z", "is_private": false, "attachment_id": 23075}, {"count": 3, "tags": [], "creator": "Alexander_Pircher@yahoo.de", "attachment_id": null, "id": 123726, "time": "2009-01-03T13:27:57Z", "bug_id": 46467, "creation_time": "2009-01-03T13:27:57Z", "is_private": false, "text": "- Kernel version\n2.6.27.9-159 (x86_64)\n\n- glibc version\n2.9\n\n- Your httpd.conf\nDefault httpd.conf installed during installation with the lines above added.\nAttached is my httpd.conf\n\n- Your ulimits (ulimit -a)\nI have already tried set the limits as high as possible, the current settings are:\ncore file size          (blocks, -c) unlimited\ndata seg size           (kbytes, -d) unlimited\nscheduling priority             (-e) unlimited\nfile size               (blocks, -f) unlimited\npending signals                 (-i) unlimited\nmax locked memory       (kbytes, -l) unlimited\nmax memory size         (kbytes, -m) unlimited\nopen files                      (-n) 1000000\npipe size            (512 bytes, -p) 8\nPOSIX message queues     (bytes, -q) unlimited\nreal-time priority              (-r) 0\nstack size              (kbytes, -s) unlimited\ncpu time               (seconds, -t) unlimited\nmax user processes              (-u) unlimited\nvirtual memory          (kbytes, -v) unlimited\nfile locks                      (-x) unlimited\n\n- gdb steps\n(gdb) frame 1\n#1  0x00000000004494b6 in child_main (child_num_arg=<value optimized out>) at prefork.c:532\n532             (void) apr_pollset_add(pollset, &pfd);\n(gdb) p num_listensocks\n$1 = 1\n"}, {"count": 4, "tags": [], "creator": "Alexander_Pircher@yahoo.de", "attachment_id": null, "id": 123727, "time": "2009-01-03T14:02:23Z", "bug_id": 46467, "creation_time": "2009-01-03T14:02:23Z", "is_private": false, "text": "An additional note which may be important. I have just tested it with the first 2.2-release of Apache 2.2.0 and got the same behaviour.\n"}, {"count": 5, "tags": [], "bug_id": 46467, "attachment_id": null, "text": "Ruediger, is apr_pollset_create() failing due to some kernel limit?\n\nAlex, you could confirm that by running with this tiny patch\n\nIndex: server/mpm/prefork/prefork.c\n===================================================================\n--- server/mpm/prefork/prefork.c\t(revision 731724)\n+++ server/mpm/prefork/prefork.c\t(working copy)\n@@ -485,7 +485,12 @@\n \n     /* Set up the pollfd array */\n     /* ### check the status */\n-    (void) apr_pollset_create(&pollset, num_listensocks, pchild, 0);\n+    status = apr_pollset_create(&pollset, num_listensocks, pchild, 0);\n+    if (status != APR_SUCCESS) {\n+        ap_log_error(APLOG_MARK, APLOG_EMERG, status, ap_server_conf,\n+                     \"Couldn't initialize pollset in child\");\n+        clean_child_exit(APEXIT_CHILDFATAL);\n+    }\n \n\nand seeing if you get the new message.  If you do, you might be able to work around whatever is causing the apr_pollset_create() failure by setting \"apr_cv_epoll=no\" when you configure.  (none of this tested ;) )\n", "id": 123807, "time": "2009-01-06T14:20:16Z", "creator": "trawick@apache.org", "creation_time": "2009-01-06T14:20:16Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 46467, "attachment_id": null, "text": "(In reply to comment #5)\n> Ruediger, is apr_pollset_create() failing due to some kernel limit?\n\nI don't know. I guess your patch will be very helpful in detecting why the creation of the pollset fails. IMHO the main difference between 2.0.63 and 2.2.x is that epoll is used and I had the idea that we might be out of fd's, but this does not seem to be the case.\n\n", "id": 123808, "time": "2009-01-06T14:29:27Z", "creator": "rpluem@apache.org", "creation_time": "2009-01-06T14:29:27Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 46467, "attachment_id": null, "text": "The epoll_create failure looks like some kind of weird kernel bug; strace output looks like the below:\n\nread(9, \"\\2\\0\\0\\0\\1\\0\\0\\0\\0\\0\\0\\0\"..., 12) = 12\nread(9, \"\"..., 0) = 0\nclose(9) = 0\nsetgroups(1, [48]) = 0\ngeteuid() = 0\nsetuid(48) = 0\nepoll_create(1) = -1 EMFILE (Too many open files)\n--- SIGSEGV (Segmentation fault) @ 0 (0) ---\n\nthe fact that an fd was closed right before epoll_create() seems like sufficient evidence for this, and it's not some global fd limit being hit since that would produce ENFILE.", "id": 123819, "time": "2009-01-07T02:09:33Z", "creator": "jorton@redhat.com", "creation_time": "2009-01-07T02:09:33Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 46467, "attachment_id": null, "text": "Bleh, this is annoying :(  It's a new tunable setting.  If you do\n\necho 1024 >  /proc/sys/fs/epoll/max_user_instances\n\nwhere 1024 is some value larger than MaxClients, then it works.\n\nhttp://lkml.indiana.edu/hypermail/linux/kernel/0812.0/01183.html", "id": 123820, "time": "2009-01-07T02:17:10Z", "creator": "jorton@redhat.com", "creation_time": "2009-01-07T02:17:10Z", "is_private": false}, {"text": "So I guess this transforms into a documentation bug and we should document it somewhere. Maybe add a platform specific section for Linux, like the one for Windows (http://httpd.apache.org/docs/2.2/en/platform/windows.html)?", "tags": [], "bug_id": 46467, "attachment_id": null, "count": 9, "id": 123836, "time": "2009-01-07T08:48:03Z", "creator": "rpluem@apache.org", "creation_time": "2009-01-07T08:48:03Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 46467, "attachment_id": null, "text": "At least the segfault is now fixed in trunk (r732414) by Jeff's patch. Instead an error message is logged and the child exits.", "id": 123839, "time": "2009-01-07T12:11:01Z", "creator": "rpluem@apache.org", "creation_time": "2009-01-07T12:11:01Z", "is_private": false}, {"count": 11, "tags": [], "creator": "rpluem@apache.org", "text": "Patch proposed for backport to 2.2.x as r732465.", "id": 123840, "time": "2009-01-07T12:18:07Z", "bug_id": 46467, "creation_time": "2009-01-07T12:18:07Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "creator": "Alexander_Pircher@yahoo.de", "attachment_id": null, "id": 123843, "time": "2009-01-07T15:04:11Z", "bug_id": 46467, "creation_time": "2009-01-07T15:04:11Z", "is_private": false, "text": "I can confirm that the patch is working in 2.2.11 and that raising max_user_instances solves the problem. Thanks for your efforts!\n\nThis may affect the worker-MPM as well if you have more than 128 workers which\nis probably very unlikely.\n\nA specific documentation-section for Linux would be a good idea.\n"}, {"text": "I'm going to see if we can either get the default setting raised or whether this can be turned into an rlimit which we can bump manually.", "tags": [], "bug_id": 46467, "attachment_id": null, "count": 13, "id": 123857, "time": "2009-01-08T03:15:41Z", "creator": "jorton@redhat.com", "creation_time": "2009-01-08T03:15:41Z", "is_private": false}, {"count": 14, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "id": 123901, "time": "2009-01-09T06:27:51Z", "bug_id": 46467, "creation_time": "2009-01-09T06:27:51Z", "is_private": false, "text": "*** Bug 46501 has been marked as a duplicate of this bug. ***"}, {"count": 15, "tags": [], "creator": "sf@sfritsch.de", "text": "Created attachment 23105\nadd more error logging for apr_pollset_create and apr_pollset_add\n\nCONNECT in mod_proxy and mod_cgi also use apr_pollset_create. Therefore it is possible that this problem also occurs in worker or event mpm.\n\nThere is now also the new max_user_watches limit that may affect apr_pollset_add (though the default seems high enough).\n\nHere is a patch that does some more error checking for these calls.", "id": 123937, "time": "2009-01-11T08:48:40Z", "bug_id": 46467, "creation_time": "2009-01-11T08:48:40Z", "is_private": false, "attachment_id": 23105}, {"text": "Fixed in r733698.", "tags": [], "bug_id": 46467, "attachment_id": null, "count": 16, "id": 123957, "time": "2009-01-12T06:46:58Z", "creator": "nick@webthing.com", "creation_time": "2009-01-12T06:46:58Z", "is_private": false}, {"count": 17, "tags": [], "bug_id": 46467, "attachment_id": null, "is_private": false, "id": 123963, "time": "2009-01-12T08:32:00Z", "creator": "sf@sfritsch.de", "creation_time": "2009-01-12T08:32:00Z", "text": "Please look at the patch I submitted. At least mpm_worker and mod_cgi need to be changed, too."}, {"count": 18, "tags": [], "bug_id": 46467, "attachment_id": null, "is_private": false, "id": 124728, "time": "2009-02-09T04:37:20Z", "creator": "jorton@redhat.com", "creation_time": "2009-02-09T04:37:20Z", "text": "FWIW, there's a thread on the kernel list about this and so far as I can tell the decision was to remove the default limits again:\n\nhttp://lkml.indiana.edu/hypermail/linux/kernel/0901.3/01806.html"}, {"count": 19, "tags": [], "bug_id": 46467, "attachment_id": null, "is_private": false, "id": 124731, "time": "2009-02-09T06:36:25Z", "creator": "werner@aloah-from-hell.de", "creation_time": "2009-02-09T06:36:25Z", "text": "Hi Everybody, \n\nseems like they've removed this setting in Kernel 2.6.28.4 which I've installed today: \n\nserver:# ls /proc/sys/fs/epoll/\nmax_user_watches\n\nSo, max_user_instances is gone and so is the problem :-) \n\ncheers,\nWerner Detter\n\n"}, {"count": 20, "tags": [], "creator": "trawick@apache.org", "attachment_id": null, "id": 125570, "time": "2009-03-15T08:58:16Z", "bug_id": 46467, "creation_time": "2009-03-15T08:58:16Z", "is_private": false, "text": "*** Bug 46856 has been marked as a duplicate of this bug. ***"}, {"count": 21, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "id": 128797, "time": "2009-07-13T09:03:24Z", "bug_id": 46467, "creation_time": "2009-07-13T09:03:24Z", "is_private": false, "text": "*** Bug 47519 has been marked as a duplicate of this bug. ***"}, {"count": 22, "tags": [], "bug_id": 46467, "attachment_id": null, "text": "(In reply to comment #16)\n> Fixed in r733698.\n\nNick, why worker and beos wasn't fixed, too? \n\nAlso apr_pollset_create() can fail if apr build on system that supports epoll_create1() (with recent glibc/linux kernel for example) but run on a system which doesn't support it (older linux kernel)", "id": 129717, "time": "2009-08-16T12:40:52Z", "creator": "arekm@maven.pl", "creation_time": "2009-08-16T12:40:52Z", "is_private": false}, {"count": 23, "tags": [], "creator": "arekm@maven.pl", "attachment_id": 24140, "id": 129719, "time": "2009-08-16T12:46:10Z", "bug_id": 46467, "creation_time": "2009-08-16T12:46:10Z", "is_private": false, "text": "Created attachment 24140\nworker beos (not tested)"}, {"text": "Committed Stefans patch as r804764 to trunk. It contains even more checks. BEOS support isn't present on trunk any longer hence no changes there.", "tags": [], "bug_id": 46467, "attachment_id": null, "count": 24, "id": 129720, "time": "2009-08-16T13:30:59Z", "creator": "rpluem@apache.org", "creation_time": "2009-08-16T13:30:59Z", "is_private": false}, {"count": 25, "tags": [], "creator": "arekm@maven.pl", "text": "Hope to see it backported to 2.2.x.", "id": 129792, "time": "2009-08-19T10:52:27Z", "bug_id": 46467, "creation_time": "2009-08-19T10:52:27Z", "is_private": false, "attachment_id": null}, {"count": 26, "tags": [], "creator": "jwezel@compumaster.de", "text": "(In reply to comment #25)\n> Hope to see it backported to 2.2.x.\n\nYes, me too!", "id": 131908, "time": "2009-11-12T11:03:35Z", "bug_id": 46467, "creation_time": "2009-11-12T11:03:35Z", "is_private": false, "attachment_id": null}]