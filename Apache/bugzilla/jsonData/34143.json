[{"count": 0, "tags": [], "creator": "srevilak@speakeasy.net", "text": "I am writing to report a bug in mod_jk 1.2.9.  If multiple occurrences\nof `worker.list' appear in workers.properties, the first worker entry\nis dropped from occurrences 2...N of `worker.list'\n\nThis bug is readily reproducible under apache 1.3.31 on Mac OSX\n\n  Darwin oatmeal.ma.runwaynine.com 7.8.0 Darwin Kernel Version 7.8.0: Wed Dec 22 14:26:17 PST \n2004; root:xnu/\\\nxnu-517.11.1.obj~1/RELEASE_PPC  Power Macintosh powerpc\n\nAnd also under apache 2.0.53 on Linux\n\n  Linux bauer.ma.runwaynine.com 2.6.9-1.667smp #1 SMP Tue Nov 2 14:59:52 EST 2004 i686 i686 \ni386 GNU/Linux\n\n\nBefore providing a test case, it would probably be helpful for me to\ndescribe our setup, in order to explain the motiviation behind why\nwe've arranged things the way we have.\n\nWe have a single apache VirtualHost with three different sets of\nJkMounts\n\n  JkMount /a/*   worker_a_lb\n  JkMount /b/*   worker_b_lb\n  JkMount /c/*   worker_c_lb\n\na, b, c are different applications.  Each runs on its own set of\nTomcat instances (`a' balances across 3 ajp13 workers, `b' balances across 12\najp13 workers, and `c' balances across 15 ajp13 workers).  We don't use\nmultiple contexts within a single servlet container; the loads for\nthese applications vary too much, as do their memory requirements.  `c'\nis particularly memory hungry.\n\nFor monitoring purposes, we also provide JkMounts for the individual\najp13 workers.  Expanding the list above:\n\n  JkMount /a/*    worker_a_lb\n  JkMount /a-1/*  worker1_a\n  JkMount /a-2/*  worker2_a\n  JkMount /a-3/*  worker3_a\n\n  JkMount /b/*    worker_b_lb\n  JkMount /b-1/*  worker1_b\n  JkMount /b-2/*  worker2_b\n    ...\n  JkMount /c/*    worker_c_lb\n  JkMount /c-1/*  worker1_c\n  JkMount /c-2/*  worker2_c\n    ...\n\nThus, one can use the load-balanced mount point to check the overall\nresponsiveness of the applications; as well as testing each servlet\ncontainer individually.\n\n\nworkers.properties looks like this:\n\n  worker.list=worker_a_lb, worker1_a, worker2_a, worker3_a\n  # definitions for individual ajp13 workers\n  worker.worker_a_lb.type=lb\n  worker.worker_a_lb.balanced_workers=worker1_a, worker2_a, worker3_a\n\n  worker.list=worker_b_lb, worker1_b, worker2_b, worker3_b, [...]\n  # definitions for individual ajp13 workers\n  worker.worker_b_lb.type=lb\n  worker.worker_b_lb.balanced_workers=worker1_b, worker2_b, worker3_b, [...]\n\nBreaking things up like this makes the configuration easier to edit:\nthe complete worker.list (dozens of entries long) can be split up into\ngroups, as opposed to having to put everything in a single\n`worker.list'.\n\nThis form of configuration file arrangement has worked with mod_jk\n1.2.2 through 1.2.5.  I haven't tried 1.2.6 - 1.2.8.\n\nThe problem:\n\n  - the first time worker.list appears, all of the workers are usable\n\n  - the second time worker.list appears, the first worker in the\n    second occurrence is dropped.  In the example above,\n    `worker_b_lb' will be dropped.\n\nI've tried moving the non-lb workers out of worker.list, and using the\nnew `balance_worker' directive.  While that makes the ajp13 workers\naccessible to the `lb' worker, they aren't usable by themselves in\nJkMount directives (HTTP/500 in apache, \"Could not find a worker\" in\nJkLogFile).\n\n\nThe simplest reproducible case:\n\n  -------------------------------- workers.properties ---------------\n  worker.list=worker_a_lb\n  worker.list=worker1_a\n\n  worker.worker1_a.type=ajp13\n  worker.worker1_a.host=localhost\n  worker.worker1_a.port=8080\n  worker.worker1_a.lbfactor=2.0\n\n  worker.worker_a_lb.type=lb\n  worker.worker_a_lb.balanced_workers=worker1_a\n  --------------------------------------------------------------------\n\n  -------------------- srm.conf --------------------------------------\n  JkMount /a/*    worker_a_lb\n  JkMount /a-1/*    worker1_a\n  --------------------------------------------------------------------\n\nThis fails with mod_jk 1.2.9, but works with mod_jk 1.2.5 (both with\napache 1.3.33 on MacOSX, and with apache-2.0.53 on linux).\n\nWith 1.2.9, neither /a/, nor /a-1/ will work.  Under mod_jk 1.2.5, both work.\n\nThe tomcat version in use is 5.0.28.", "id": 12432, "attachment_id": null, "bug_id": 34143, "creation_time": "2005-03-23T07:11:03Z", "time": "2005-03-23T07:11:03Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 34143, "attachment_id": 14545, "id": 5875, "time": "2005-03-23T14:11:06Z", "creator": "srevilak@speakeasy.net", "creation_time": "2005-03-23T14:11:06Z", "is_private": false, "text": "Created attachment 14545\nPATCH: small change to jk_map.c fixes problem\n\nSmall patch to jk_map_get_string_list, to include '*' as a separator character."}, {"count": 2, "tags": [], "bug_id": 34143, "attachment_id": null, "id": 5876, "time": "2005-03-23T14:14:33Z", "creator": "srevilak@speakeasy.net", "creation_time": "2005-03-23T14:14:33Z", "is_private": false, "text": "I think I've found the problem.  In jk_map.c, jk_map_read_property() uses '*' as a separator character \nwhen a property appears multiple times (as did worker.list in my original report).  \njk_map_get_string_list() wasn't interpreting '*' as a separator.  So\n\nworker.list=worker_lb\nworker.list=worker_1\n\nEnded up setting a worker whose name was 'worker_lb*worker_1'\n\nPatch #1 appears to fix this.\n"}, {"count": 3, "tags": [], "creator": "srevilak@speakeasy.net", "text": "Created attachment 14548\nPATCH: jk_map.c\n\nEarlier patch submission missed a strtok().  Resubmitting corrected patch.", "id": 72763, "attachment_id": 14548, "bug_id": 34143, "creation_time": "2005-03-23T19:39:02Z", "time": "2005-03-23T19:39:02Z", "is_private": false}, {"count": 4, "tags": [], "text": "This is not a critical bug.\nYour patch will not work for JkWorkerProperty directives.\nInstead inside jk_map_read_property the \"char *sep = '*'\",\nshould probably be changed to \"char *sep = ','\".\nThis would make sense because multiple directives will end as\nstandard list.\n\nCan you try to change the code and see if it works.\nI simply don't have time to play with this 'syntactic sugar'\ntype of problems :)\n\nRegards,\nMladen.\n", "attachment_id": null, "id": 72833, "creator": "mturk@apache.org", "time": "2005-03-25T07:38:31Z", "bug_id": 34143, "creation_time": "2005-03-25T07:38:31Z", "is_private": false}, {"count": 5, "tags": [], "creator": "srevilak@runwaynine.com", "attachment_id": null, "text": "Sure, I should be able to try the separator char changes early next week. ", "id": 72896, "time": "2005-03-26T16:59:43Z", "bug_id": 34143, "creation_time": "2005-03-26T16:59:43Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 34143, "attachment_id": null, "id": 73164, "time": "2005-03-31T23:53:01Z", "creator": "srevilak@speakeasy.net", "creation_time": "2005-03-31T23:53:01Z", "is_private": false, "text": "Okay, taking another crack at this.\n\nIn response to Mladen's suggestion, I changed the default separator\ncharacter in jk_map_read_property() to `,'.\n\nThe one place where I did find `*' used as a tokenization character\nwas in jk_util.c's jk_parse_sysprops().  There, the use of * as a\nseparator is probably a better choice than a comma; it's not unusual\nfor a comma to be contained within the value of a java system\nproperty.  (for example, \"-Dhttps.protocols=SSLv3,SSLv2Hello\")\n\nWith this patch, jk_map_read_property() now special-cases `*' as a\nseparator for sysprops; much in the same way as it special cases path\nseparators and command line separators.\n\nI've tested this on apache-1.3.33 and apache-2.0.53 with my original\ncase:\n\n  -------------------------------- workers.properties ---------------\n  worker.list=worker_a_lb\n  worker.list=worker1_a\n\n  worker.worker1_a.type=ajp13\n  worker.worker1_a.host=localhost\n  worker.worker1_a.port=8080\n  worker.worker1_a.lbfactor=2.0\n\n  worker.worker_a_lb.type=lb\n  worker.worker_a_lb.balanced_workers=worker1_a\n  --------------------------------------------------------------------\n\n  -------------------- srm.conf --------------------------------------\n  JkMount /a/*    worker_a_lb\n  JkMount /a-1/*    worker1_a\n  --------------------------------------------------------------------\n\nas well as with an srm.conf-only variant:\n\n  -------------------- srm.conf --------------------------------------\n  JkWorkerProperty  worker.list=worker_lb\n  JkWorkerProperty  worker.list=worker_1\n  JkWorkerProperty  worker.worker_1.type=ajp13\n  JkWorkerProperty  worker.worker_1.host=localhost\n  JkWorkerProperty  worker.worker_1.port=8080\n  JkWorkerProperty  worker.worker_1.lbfactor=2.0\n  JkWorkerProperty  worker.worker_lb.type=lb\n  JkWorkerProperty  worker.worker_lb.balanced_workers=worker_1\n\n  JkMount /a/*    worker_a_lb\n  JkMount /a-1/*    worker1_a\n  --------------------------------------------------------------------\n\nIt seems to do the right thing.\n\nI'm not set up to do JNI, so unfortunately, I wasn't able to test\nwith a JNI worker.\n\n"}, {"count": 7, "tags": [], "creator": "srevilak@speakeasy.net", "attachment_id": 14605, "text": "Created attachment 14605\nrevised patch for handling parsing of workers.properties", "id": 73165, "time": "2005-03-31T23:54:38Z", "bug_id": 34143, "creation_time": "2005-03-31T23:54:38Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 34143, "text": "Fixed in the CVS.", "id": 73619, "time": "2005-04-13T14:06:55Z", "creator": "mturk@apache.org", "creation_time": "2005-04-13T14:06:55Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "text": "Reopen to correct status.", "attachment_id": null, "id": 112380, "creator": "rainer.jung@kippdata.de", "time": "2008-01-01T16:15:32Z", "bug_id": 34143, "creation_time": "2008-01-01T16:15:32Z", "is_private": false}]