[{"count": 0, "tags": [], "creator": "hauser@acm.org", "attachment_id": null, "is_private": false, "id": 196236, "time": "2017-01-20T08:55:16Z", "bug_id": 60614, "creation_time": "2017-01-20T08:55:16Z", "text": "until deb stable tc8.0.14 (till nov2016), the following server.xml worked\n<Server...\n  <Service ...\n    <Connector...\n    <Engine..\n      <Realm .../>\n      <Host ...>\n        <Valve .../>\n        <Context ...\n          <Resource name=\"jdbc/x... />\n          <ResourceParams name=\"jdbc/x.../> \n          <Resource name=\"jdbc/y... />\n          <ResourceParams name=\"jdbc/y.../> \n          <Resource name=\"jdbc/z... />\n          <ResourceParams name=\"jdbc/z.../> \n          <Environment name=\"logging-context\" .../>\n        </Context>\n      </Host>\n      <Host ...>\n        ...\n      </Host>\n    </Engine>\n  </Service>\n  <Service>\n     ...\n  </Service>\n  ...\n</Server>\n\nAfter moving to 8.5.9, this no longer works (bug 60611).\nI understand, that the above as per CVE-2016-6797 is no longer supposed to work.\n\nI tried to adapt as \n\n<Server...\n  <Service ...\n    <Connector...\n    <Engine..\n      <Realm .../>\n      <Host ...>\n        <Valve .../>\n        <Context ...\n          <Environment name=\"logging-context\" .../>\n        </Context>\n      </Host>\n      <Host ...>\n        ...\n      </Host>\n    </Engine>\n  </Service>\n  <Service>\n     ...\n  </Service>\n  ...\n  <GlobalNamingResources>\n    <Resource name=\"jdbc/x... />\n    <ResourceParams name=\"jdbc/x.../> \n    <Resource name=\"jdbc/y... />\n    <ResourceParams name=\"jdbc/y.../> \n    <Resource name=\"jdbc/z... />\n    <ResourceParams name=\"jdbc/z.../> \n  </GlobalNamingResources>\n</Server>\n\nhttp://svn.apache.org/repos/asf/tomcat/tc8.5.x/tags/TOMCAT_8_5_9/java/org/apache/catalina/startup/Catalina.java\n\nshows in createStartDigester() in the first position after \"Server\"\n\n        digester.addObjectCreate(\"Server/GlobalNamingResources\",\n                                 \"org.apache.catalina.deploy.NamingResourcesImpl\");\n\nbut also \n        // Add RuleSets for nested elements\n        digester.addRuleSet(new NamingRuleSet(\"Server/GlobalNamingResources/\"));\nso, it should be possible to also add it in the end?\n\nhttp://svn.apache.org/repos/asf/tomcat/tc8.5.x/tags/TOMCAT_8_5_9/conf/server.xml has a <GlobalNamingResources> element before the <Service> but after <Listener> ???  (and without <ResourceParams )\n\nPlease add corresponding hints to\n1) https://tomcat.apache.org/tomcat-8.5-doc/config/index.html\n2) https://tomcat.apache.org/tomcat-8.5-doc/jndi-resources-howto.html#web.xml_configuration\n3) https://tomcat.apache.org/tomcat-8.5-doc/config/globalresources.html#Resource_Definitions\n\n\nToo bad, there is no DTD for validation :(  (bug 5145#c2 -  >15yrs)\n        \n(the <GlobalNamingResources> exists since a while bug 33360)"}, {"attachment_id": null, "tags": [], "creator": "hauser@acm.org", "is_private": false, "count": 1, "id": 196241, "time": "2017-01-20T11:11:09Z", "bug_id": 60614, "creation_time": "2017-01-20T11:11:09Z", "text": "- moving the <GlobalNamingResources> before the <Service> didn't help\n- removing the <ResourceParams> as per the cited sample server.xml also didn't help\n\n4) Is there a Test-Class where I could out of eclipse just load the server.xml and see how tomcat.dbcp.dbcp2.BasicDataSource ?"}, {"attachment_id": null, "tags": [], "creator": "hauser@acm.org", "is_private": false, "count": 2, "id": 196396, "time": "2017-01-25T13:36:28Z", "bug_id": 60614, "creation_time": "2017-01-25T13:36:28Z", "text": "some further thoughts:\n\n10) first I thought having \n        factory =\"org.apache.commons.dbcp.BasicDataSourceFactory\"\n    is the problem, as it is trying to instantiate an\n     org.apache.tomcat.dbcp.dbcp2.BasicDataSource, but it wasn't \n11) I ended up parsing the server.xml file out of the servlets where I needed the\n    BasicDataSources myself and doing a \n     org.apache.commons.dbcp.BasicDataSourceFactory.createDataSource(Properties properties)\n    ugly work-around, but appears to work"}, {"count": 3, "tags": [], "text": "The changes for CVE-2016-6797 only affected the use of ResourceLink to make global resources available to individual web application. It did not affect the direct definition of a resource within a web application.\n\nThis looks like an issue with the Debian distro. The users@ list is the best place to flush that out if you want feedback from the Tomcat community before opening a Debian bug.\n\nIf the users@ discussion identifies a Tomcat bug, this issue can be re-opened.", "is_private": false, "bug_id": 60614, "id": 196398, "time": "2017-01-25T13:43:02Z", "creator": "markt@apache.org", "creation_time": "2017-01-25T13:43:02Z", "attachment_id": null}]