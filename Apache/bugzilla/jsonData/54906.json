[{"count": 0, "tags": [], "creator": "apache@neworld.us", "text": "Created attachment 30240\nPatch to catch ConcurrentModificationException while iterating over a collection\n\nThis is related to bug 54497. A common exception seen in 7.0.33 during stop is a ConcurrentModification in loadedByThisOrChild.\n\njava.util.concurrent.ExecutionException: org.apache.catalina.LifecycleException: Failed to stop component [StandardEngine[Tomcat].StandardHost[localhost].StandardContext[/mobile/login/oauth]]\n\tat java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:252)\n\tat java.util.concurrent.FutureTask.get(FutureTask.java:111)\n\tat org.apache.catalina.core.ContainerBase.stopInternal(ContainerBase.java:1179)\n\tat org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:232)\n\tat org.apache.catalina.core.ContainerBase$StopChild.call(ContainerBase.java:1575)\n\tat org.apache.catalina.core.ContainerBase$StopChild.call(ContainerBase.java:1564)\n\tat java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:166)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:722)\nCaused by: org.apache.catalina.LifecycleException: Failed to stop component [StandardEngine[Tomcat].StandardHost[localhost].StandardContext[/mobile/login/oauth]]\n\tat org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:236)\n\t... 7 more\nCaused by: org.apache.catalina.LifecycleException: Failed to stop component [WebappLoader[/mobile/login/oauth]]\n\tat org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:236)\n\tat org.apache.catalina.core.StandardContext.stopInternal(StandardContext.java:5521)\n\tat org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:232)\n\t... 7 more\nCaused by: java.util.ConcurrentModificationException\n\tat java.util.Vector$Itr.checkForComodification(Vector.java:1156)\n\tat java.util.Vector$Itr.next(Vector.java:1133)\n\tat org.apache.catalina.loader.WebappClassLoader.loadedByThisOrChild(WebappClassLoader.java:2599)\n\tat org.apache.catalina.loader.WebappClassLoader.checkThreadLocalMapForLeaks(WebappClassLoader.java:2515)\n\tat org.apache.catalina.loader.WebappClassLoader.checkThreadLocalsForLeaks(WebappClassLoader.java:2455)\n\tat org.apache.catalina.loader.WebappClassLoader.clearReferences(WebappClassLoader.java:1996)\n\tat org.apache.catalina.loader.WebappClassLoader.stop(WebappClassLoader.java:1902)\n\tat org.apache.catalina.loader.WebappLoader.stopInternal(WebappLoader.java:661)\n\tat org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:232)\n\t... 9 more\n\nThe fix for 54497 stops the exception from failing the stop but it still fails the rest of the ThreadLocal leak check. It would be better if ConcurrentModificationException was caught in loadedByThisOrChild and only that one check fails.", "id": 166942, "time": "2013-04-29T19:25:04Z", "bug_id": 54906, "creation_time": "2013-04-29T19:25:04Z", "is_private": false, "attachment_id": 30240}, {"count": 1, "tags": [], "bug_id": 54906, "text": "loadedByThisOrChild() is called by more than just the thread load code so I used your patch but with a dedicated error message rather than re-using an existing one.\n\nThe fix has been applied to trunk and 7.0.x and will be included in 7.0.40 onwards.", "id": 167038, "time": "2013-05-04T21:54:21Z", "creator": "markt@apache.org", "creation_time": "2013-05-04T21:54:21Z", "is_private": false, "attachment_id": null}]