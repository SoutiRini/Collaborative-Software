[{"count": 0, "tags": [], "bug_id": 49427, "attachment_id": null, "is_private": false, "id": 137565, "time": "2010-06-11T06:05:19Z", "creator": "aimoto321@gmail.com", "creation_time": "2010-06-11T06:05:19Z", "text": "[Symptom]\nI used LimitRequestBody directive and then sent POST request which\nsize is over the value of LimitRequestBody.\nI expected the response of Status 413 with the body which is set for the status.\nHowever I got the Status 413 with the body including not only 413, but also 500.\n\n\n[Operation]\n=== httpd.conf ==\nErrorDocument 413 \"413 Error!!\"\nErrorDocument 500 \"500 Error!!\"\nLimitRequestBody 10000\n\n=== HTTP ACCESS ===\n[root@localhost bin]# telnet 127.0.0.1 80\nTrying 127.0.0.1...\nConnected to localhost.localdomain (127.0.0.1).\nEscape character is '^]'.\nPOST /cgi-bin/print.cgi HTTP/1.1\nHost: test\nContent-Length: 10001\n\nHTTP/1.1 413 Request Entity Too Large\nDate: Fri, 04 Jun 2010 07:16:56 GMT\nServer: Apache/2.2.15 (Unix)\nConnection: close\nContent-Type: text/html; charset=iso-8859-1\n\n413 Error!!500 Error!!Connection closed by foreign host.\n[root@localhost bin]#\n\n=== access_log ===\n127.0.0.1 - - [04/Jun/2010:16:16:56 +0900] \"POST /cgi-bin/print.cgi HTTP/1.1\" 500 22\n\n=== error_log ===\n[Fri Jun 04 16:16:56 2010] [error] [client 127.0.0.1] Requested content-length of 10001 is larger than the configured limit of 10000\n[Fri Jun 04 16:16:56 2010] [error] [client 127.0.0.1] (-3)Unknown error 4294967293: Error reading request entity data\n\n\n\n[Analysis]\nIt happens when you use mod_cgid / mod_cgi and LimitRequestBody.\nIt might caused by the following mod_cgi's code :\n\n--- L.836-843 in mod_cgi.c ---\n\n        rv = ap_get_brigade(r->input_filters, bb, AP_MODE_READBYTES,\n                            APR_BLOCK_READ, HUGE_STRING_LEN);\n\n        if (rv != APR_SUCCESS) {\n            ap_log_rerror(APLOG_MARK, APLOG_ERR, rv, r,\n                          \"Error reading request entity data\");\n            return HTTP_INTERNAL_SERVER_ERROR;\n        }\n-------------------------------------------------\n\nExceeding LimitRequestBody AP_FILTER_ERROR occurs in ap_get_brigade().\nApache put Status 413's body into the response at that time.\n\nHowever following code returns HTTP_INTERNAL_SERVER_ERROR.\nIt means that Apache adds Status 500's body to the response.\n\nI think the code might be like following :\n\n-------------------------------------------------\n\n        rv = ap_get_brigade(r->input_filters, bb, AP_MODE_READBYTES,\n                            APR_BLOCK_READ, HUGE_STRING_LEN);\n\n        if (rv != APR_SUCCESS) {\n\t\tif (rv == AP_FILTER_ERROR)\n\t\t\treturn rv;\n\t\telse\n\t\t\treturn HTTP_INTERNAL_SERVER_ERROR;\n        }\n-------------------------------------------------\n\nI mention only mod_cgi, but mod_cgid includes the same issue."}]