[{"count": 0, "tags": [], "bug_id": 48824, "attachment_id": null, "text": "I'm running an Apache/2.2.14(Unix) + mod_ssl/2.2.14 + mpm_worker as reverse proxy. Everything with SSL worked fine so far (including verifying clientcerts). Now, I wanted Apache to use some certs when talking to the backends.\n\nI'm experiencing the same issue on 2.2.12, and the following information refers to this .12 version.\n\n---$ /usr/sbin/apache2 -V\n\nServer version: Apache/2.2.12 (Ubuntu)\nServer built:   Nov 12 2009 22:49:46\nServer's Module Magic Number: 20051115:23\nServer loaded:  APR 1.3.8, APR-Util 1.3.9\nCompiled using: APR 1.3.8, APR-Util 1.3.9\nArchitecture:   32-bit\nServer MPM:     Prefork\n  threaded:     no\n    forked:     yes (variable process count)\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"\"\n -D SUEXEC_BIN=\"/usr/lib/apache2/suexec\"\n -D DEFAULT_PIDLOG=\"/var/run/apache2.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_LOCKFILE=\"/var/run/apache2/accept.lock\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"/etc/apache2/mime.types\"\n -D SERVER_CONFIG_FILE=\"/etc/apache2/apache2.conf\"\n \n---My minimal httpd.conf:\n\nLoadModule ssl_module /usr/lib/apache2/modules/mod_ssl.so\nUser www-data\nGroup www-data\nServerRoot /tmp/\nDocumentRoot /\nServerName localhost\nSSLSessionCache shm:tmp/ssl_memcache_gcache_data(512000)\nSSLProxyEngine On\nSSLProxyMachineCertificateFile /tmp/cert_bundle.pem\nPidFile /tmp/apache.pid\nLogLevel debug\n# same issue when \"warn\"\nErrorLog error.log\nListen *:60000\n<VirtualHost *:60000>\n</VirtualHost>\n\n---The error.log:\n\n...\n[Fri Feb 26 15:59:31 2010] [info] Init: Seeding PRNG with 0 bytes of entropy\n[Fri Feb 26 15:59:31 2010] [info] Init: Generating temporary RSA private keys (512/1024 bits)\n[Fri Feb 26 15:59:31 2010] [info] Init: Generating temporary DH parameters (512/1024 bits)\n[Fri Feb 26 15:59:31 2010] [info] Init: Initializing (virtual) servers for SSL\n[Fri Feb 26 15:59:31 2010] [debug] ssl_engine_init.c(414): Creating new SSL context (protocols: SSLv2, SSLv3, TLSv1)\n[Fri Feb 26 15:59:31 2010] [debug] ssl_engine_init.c(962): loaded 2 client certs for SSL proxy\n[Fri Feb 26 15:59:31 2010] [debug] ssl_engine_init.c(414): Creating new SSL context (protocols: SSLv2, SSLv3, TLSv1)\n[Fri Feb 26 15:59:31 2010] [debug] ssl_engine_init.c(962): loaded 2 client certs for SSL proxy\n[Fri Feb 26 15:59:31 2010] [info] mod_ssl/2.2.12 compiled against Server: Apache/2.2.12, Library: OpenSSL/0.9.8g\n\n---$ strace /usr/sbin/apache2 -f /tmp/httpd.conf -k start -X\n\n...\ntime(NULL)                              = 1267196371\ngettimeofday({1267196371, 499570}, NULL) = 0\nwrite(2, \"[Fri Feb 26 15:59:31 2010] [info\"..., 91) = 91\nsemget(IPC_PRIVATE, 1, IPC_CREAT|0600)  = 884756\nsemctl(884756, 0, IPC_64|SETVAL, 0xbf9fda48) = 0\ngeteuid32()                             = 1000\ngettimeofday({1267196371, 499894}, NULL) = 0\nwrite(2, \"[Fri Feb 26 15:59:31 2010] [info\"..., 79) = 79\ngettimeofday({1267196371, 500032}, NULL) = 0\nwrite(2, \"[Fri Feb 26 15:59:31 2010] [debu\"..., 117) = 117\nopen(\"/tmp/cert_bundle.pem\", O_RDONLY|O_LARGEFILE) = 6\nfstat64(6, {st_mode=S_IFREG|0644, st_size=8975, ...}) = 0\nmmap2(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb7750000\nread(6, \"\\nCertificate:\\n    Data:\\n        \"..., 4096) = 4096\nread(6, \"AkEAzJqe7AJ9Z/8+69qmp1efjkxGtUPL\"..., 4096) = 4096\nread(6, \"lJapNxFZONG+4dqDQ+Ne9A9NLp5lGLym\"..., 4096) = 783\nread(6, \"\", 4096)                       = 0\nclose(6)                                = 0\nmunmap(0xb7750000, 4096)                = 0\ngettimeofday({1267196371, 501361}, NULL) = 0\nwrite(2, \"[Fri Feb 26 15:59:31 2010] [debu\"..., 95) = 95\ngettimeofday({1267196371, 501498}, NULL) = 0\nwrite(2, \"[Fri Feb 26 15:59:31 2010] [debu\"..., 117) = 117\nopen(\"/tmp/cert_bundle.pem\", O_RDONLY|O_LARGEFILE) = 6\nfstat64(6, {st_mode=S_IFREG|0644, st_size=8975, ...}) = 0\nmmap2(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb7750000\nread(6, \"\\nCertificate:\\n    Data:\\n        \"..., 4096) = 4096\nread(6, \"AkEAzJqe7AJ9Z/8+69qmp1efjkxGtUPL\"..., 4096) = 4096\nread(6, \"lJapNxFZONG+4dqDQ+Ne9A9NLp5lGLym\"..., 4096) = 783\nread(6, \"\", 4096)                       = 0\nclose(6)                                = 0\nmunmap(0xb7750000, 4096)                = 0\ngettimeofday({1267196371, 502821}, NULL) = 0\nwrite(2, \"[Fri Feb 26 15:59:31 2010] [debu\"..., 95) = 95\ngettimeofday({1267196371, 502969}, NULL) = 0\nwrite(2, \"[Fri Feb 26 15:59:31 2010] [info\"..., 113) = 113\n--- SIGSEGV (Segmentation fault) @ 0 (0) ---\n+++ killed by SIGSEGV +++\n\n---GDB-Backtrace (sorry, no -g):\n\n$ gdb --args /usr/sbin/apache2 -f /tmp/httpd.conf -k start -X\nGNU gdb (GDB) 7.0-ubuntu\nCopyright (C) 2009 Free Software Foundation, Inc...\nReading symbols from /usr/sbin/apache2...(no debugging symbols found)...done.\n(gdb) r\nStarting program: /usr/sbin/apache2 -f /tmp/httpd.conf -k start -X\n[Thread debugging using libthread_db enabled]\nProgram received signal SIGSEGV, Segmentation fault.\n0x00390a8f in CRYPTO_add_lock () from /lib/i686/cmov/libcrypto.so.0.9.8\n(gdb) bt\n#0  0x00390a8f in CRYPTO_add_lock () from /lib/i686/cmov/libcrypto.so.0.9.8\n#1  0x0041e9ad in asn1_do_lock () from /lib/i686/cmov/libcrypto.so.0.9.8\n#2  0x0041b2f4 in ?? () from /lib/i686/cmov/libcrypto.so.0.9.8\n#3  0x0041b4e8 in ASN1_item_free () from /lib/i686/cmov/libcrypto.so.0.9.8\n#4  0x00415317 in X509_CRL_free () from /lib/i686/cmov/libcrypto.so.0.9.8\n#5  0x0041560d in X509_INFO_free () from /lib/i686/cmov/libcrypto.so.0.9.8\n#6  0x003f8c28 in sk_pop_free () from /lib/i686/cmov/libcrypto.so.0.9.8\n#7  0x002ed878 in ?? () from /usr/lib/apache2/modules/mod_ssl.so\n#8  0x00c4aed8 in ?? () from /usr/lib/libapr-1.so.0\n#9  0x00c49ffe in apr_pool_clear () from /usr/lib/libapr-1.so.0\n#10 0x0083f8fd in main () from /usr/sbin/apache2\n(gdb)\n\n---My SSLProxyMachineCertificateFile contains:\n\nCertificate:\n    Data:\n        Version: 3 (0x2)\n        Signature Algorithm: md5WithRSAEncryption\n        Issuer: C=lk, ST=lkj, L=lkj, O=lkj, OU=lkj, CN=ca\nasd/emailAddress=lkj@$\n        Validity\n            Not Before: Feb 16 16:00:00 2010 GMT\n            Not After : Feb 16 16:00:00 2011 GMT\n        Subject: C=lk, ST=lkj, O=lkj, OU=lkj, CN=cert 2\nccert/emailAddress=lkj@$\n        Subject Public Key Info:\n            Public Key Algorithm: rsaEncryption\n            RSA Public Key: (1024 bit)\n                Modulus (1024 bit):\n                    00:d5:83:0f:03:5e:a9:b6:08:16:2e:c2:7d:1e:b7:\n                    ...\n                    28:b2:55:e3:df:64:ed:8e:0b\n                Exponent: 65537 (0x10001)\n        X509v3 extensions:\n                    ...other stuff\n    Signature Algorithm: md5WithRSAEncryption\n        74:e8:8d:3f:57:0a:33:94:37:7b:bc:31:b9:81:71:5c...\n-----BEGIN CERTIFICATE-----\nTLSdtQnWynaZERayZO2BOXmAvd/m8xIkqM3ffmiLJbIwGu5vNBu3AvhQv2CJM...\n-----END CERTIFICATE-----\n-----BEGIN RSA PRIVATE KEY-----\nMIICXAIBAAKBgQDVgw8DXqm2CBYuwn0et9N5rO8uwSDPdiaFMSJisyxcW0S9+...\n-----END RSA PRIVATE KEY-----\n+one other cert directly following (same issue when using only one cert)\n\nRead about segfault for missing a private key or loglevel debug, but that doesn't seem to fit here.\n\nThanks in advance:\n\tFlorian Schr\u00f6der", "id": 134923, "time": "2010-02-26T16:00:06Z", "creator": "s9flschr@stud.uni-saarland.de", "creation_time": "2010-02-26T16:00:06Z", "is_private": false}, {"count": 1, "tags": [], "text": "Created attachment 25068\nThe used certfile\n\nThere are two certificates inside, for now. Same issue appears if it contains only a single one.", "attachment_id": 25068, "bug_id": 48824, "id": 134954, "time": "2010-02-28T22:49:31Z", "creator": "s9flschr@stud.uni-saarland.de", "creation_time": "2010-02-28T22:49:31Z", "is_private": false}, {"count": 2, "tags": [], "text": "Found out that this is a duplicate of #39915: \n\nThere (back in 2006), a patch was developed that was claimed to propose for 2.2.x.\nBUT: I was curious and looked into my sources and found out, that this one-line-patch wasn't included. I adapted it for my version and it works now.\n\nHow can this be??\n\n*** This bug has been marked as a duplicate of bug 39915 ***", "attachment_id": null, "bug_id": 48824, "id": 135047, "time": "2010-03-04T13:08:32Z", "creator": "s9flschr@stud.uni-saarland.de", "creation_time": "2010-03-04T13:08:32Z", "is_private": false}]