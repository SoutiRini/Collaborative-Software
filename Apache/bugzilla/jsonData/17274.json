[{"count": 0, "tags": [], "text": "(this is the copy of an email I posted on the mod_ldap list and the Apache users\nlist - two emails actually, I replied to myself - I hope nobody will mind, I\nalready spent time diagnosing the bug, I just had no time to follow a bug report\ntill now :-)\n\nI can confirm that this problem is a bug related to how mod_ldap handles the\nbehaviour of the AD server.\nWhen a bind has succeeded, the module keeps the session open for any following\nrequest. However, when the first bind (with AuthLDAPBindDN) was successful, and\nthen the second (with login/wrong password) failed, the module considers the\nsession is still bound, while the AD server thinks it has no permission anymore.\nSo, on the next search, the AD server replies with a 'Success' with no entry,\nthat the module interprets as a 'User not unique'.\n\nSince I don't mind the module establishing a new session everytime, I made sure\nthat it's killed after every search.\n\nIf I have the time, I'll try to make a more consistent patch\n\nIS this the right mailing list to post it or should it go to an Apache one now\nthat this module has been included ?\n\nMy quick fix:\n$ diff mod_auth_ldap.c~  mod_auth_ldap.c\n279c279\n<     util_ldap_connection_close(ldc);\n---\n>     util_ldap_connection_destroy(ldc);\n\n\nLaurent Blume wrote:\n\n> I snooped the packets, and I did notice something weird:\n>\n> When there is a successful authentication (login and password are ok on the\nfirst try), the conversation between the Apache server and the LDAP server goes\nlike this:\n>  - new TCP session established;\n>  - bind request with the AuthLDAPBindDN and AuthLDAPBindPassword;\n>  - bind result: success;\n>  - search request with the Base DN, attribute name, and the login entered as\nthe attribute value;\n>  - search result: success, containing only one value;\n>  - bind request with the DN in the value just received;\n>  - bind result: success;\n>  - TCP session ends;\n>\n> All those steps are repeated every time.\n>\n> When the login password is wrong for the first try, it goes like this:\n>  - new TCP session established;\n>  - bind request with the AuthLDAPBindDN and AuthLDAPBindPassword;\n>  - bind result: success;\n>  - search request with the Base DN, attribute name, and the login entered as\nthe attribute value;\n>  - search result: success, containing only one value;\n>  - bind request with the DN in the value just received;\n>  - bind result: Invalid credentials;\n>\n> The main difference being, _the TCP session is not closed_.\n> When there is another try with the same login, whatever the password is, there\nis no new TCP session, it continues in the same, right after the bind result,\nlike this:\n>  - search request with the Base DN, attribute name, and the login entered as\nthe attribute value;\n>  - search result: success, containing no value;\n>\n> Nothing else, the TCP session is still *not* closed, it continues with the\nsame values for every try.\n>\n>  From what I understand, since the last Bind request failed, the AD server\nconsiders the client has no authorization. Its behaviour in that case is to\nreply with a Success, but with no value returned. 0 being different from 1, the\nmodule interprets this as 'User is not unique'.\n> I haven't used any other LDAP server so far, but I've seen that AD is\ndifferent in that it requires authentication before allowing a search.\n> Actually, a server allowing an anonymous search would probably work in my\ncase, so I guess it's AD particular behaviour that is not correctly handled.\n>\n> I've started to look at the sources to get a better understanding on what goes\non, but my C days are a bit far in my past, I'm not sure I'll be able to fix that.", "attachment_id": null, "bug_id": 17274, "id": 31733, "time": "2003-02-21T10:14:27Z", "creator": "laurent@elanor.org", "creation_time": "2003-02-21T10:14:27Z", "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 17274, "is_private": false, "id": 31737, "time": "2003-02-21T10:58:43Z", "creator": "apachebugs@kyon.de", "creation_time": "2003-02-21T10:58:43Z", "tags": [], "text": "i have exactly the same problem with openldap 2.0.25, apache 2.0.44 and freebsd 4.7. the quick fix solved the problem for me. i agree that the problem seems to be that the module assumes that the session can be used for authentication attempts again, which is not be permitted by the ldap servers access control."}, {"count": 2, "tags": [], "creator": "cuentas@imarte.net", "attachment_id": null, "text": "I have the same problem, I'm using:\nhttpd-2.0.44 against ms active directory (ms w2k)\n", "id": 36420, "time": "2003-04-30T22:50:23Z", "bug_id": 17274, "creation_time": "2003-04-30T22:50:23Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 17274, "attachment_id": null, "id": 47811, "time": "2003-11-21T17:22:01Z", "creator": "trawick@apache.org", "creation_time": "2003-11-21T17:22:01Z", "is_private": false, "text": "I'm going through the bug db to make sure patches are findable.  Please see \nhttp://httpd.apache.org/dev/patches.html\n"}, {"count": 4, "tags": [], "creator": "jc@thp.org", "text": "I have this problem in my production mandrake 9.2 server, and would love to just\nget a fixed binary - is this being fixed in the actual binaries, or will this\njust continue to be a sourcecode patch?", "id": 54739, "time": "2004-03-26T13:31:00Z", "bug_id": 17274, "creation_time": "2004-03-26T13:31:00Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "creator": "jrduncans@stephenduncanjr.com", "is_private": false, "text": "Seeing this on Windows 200 SP4 Active Directory, using Apache HTTP Server 2.0.49\non Windows.  \n\nWhen incorrect password is input, error log logs:\n\n[*date*] [warn] [client *ipaddress*] [832] auth_ldap authenticate: user\n*username* authentication failed; URI *uri* [ldap_simple_bind_s() to check user\ncredentials failed][Invalid Credentials]\n\nSubsequent attempt to login with correct password cause this error in the logs:\n\n[*date] [warn] [client *ipaddress*] [832] auth_ldap authenticate: user\n*username* authentication failed; URI *uri* [User not found][No Such Object]", "id": 55309, "time": "2004-04-05T13:42:06Z", "bug_id": 17274, "creation_time": "2004-04-05T13:42:06Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 17274, "attachment_id": null, "id": 57750, "time": "2004-05-20T23:01:41Z", "creator": "minfrin@sharp.fm", "creation_time": "2004-05-20T23:01:41Z", "is_private": false, "text": "Please try the patch at http://nagoya.apache.org/bugzilla/show_bug.cgi?id=27748\nand tell me if it fixes this problem. This patch has been applied to v2.1.0-dev,\nand awaits backporting to v2.0.50-dev.\n"}, {"count": 7, "attachment_id": null, "bug_id": 17274, "text": "I applied the patch to 2.0.49, built it with similar options.\nIt now authenticates correctly against the AD server, even when entering invalid\nlogin/password combinations first.\n\nSo it seems to fix the problem for me.", "id": 57810, "time": "2004-05-21T15:15:31Z", "creator": "laurent@elanor.org", "creation_time": "2004-05-21T15:15:31Z", "tags": [], "is_private": false}, {"count": 8, "attachment_id": null, "bug_id": 17274, "is_private": false, "id": 57837, "time": "2004-05-21T16:36:00Z", "creator": "minfrin@sharp.fm", "creation_time": "2004-05-21T16:36:00Z", "tags": [], "text": "Sweet, thanks :)"}, {"count": 9, "tags": [], "creator": "joshua@idx.com.au", "attachment_id": null, "text": "Does 2.0.53 fix this problem?? \nI was using 2.0.47 and it has the same problem...\n\nI couldnt change the source,\n\nfrom:\n<     util_ldap_connection_close(ldc);\n\nto\n>     util_ldap_connection_destroy(ldc);\n\n\n It would give compile errors\n\n\n\n\nthanks\n\nJoshua", "id": 70687, "time": "2005-02-09T07:15:08Z", "bug_id": 17274, "creation_time": "2005-02-09T07:15:08Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 17274, "attachment_id": null, "text": "This was fixed in v2.0.51 - can you confirm whether this is still broken, and\nreopen if so?", "id": 76336, "time": "2005-06-13T12:18:53Z", "creator": "minfrin@sharp.fm", "creation_time": "2005-06-13T12:18:53Z", "is_private": false}]