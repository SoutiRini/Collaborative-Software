[{"count": 0, "tags": [], "creator": "jim@riggs.me", "text": "As discussed at ApacheConNA 2017 in Miami a couple of weeks ago and followed up on the mailing list (http://marc.info/?l=apache-httpd-dev&m=149554902825812), here is a patch to add a new type/status to balancer members: R - hot spare. These workers will be treated as drop-in replacements for unusable workers without all workers needing to be unavailable (as for H - hot standby). This allows for maintaining a consistent number of available workers in the balancer.\n\n\"Normal\" workers always take precedence over spares. For each \"normal\" worker that is unusable (failed, stopped, disabled, unreachable, etc.), though, a spare will be added to the list of available workers to try to maintain the desired number of members.\n\nThe find_best_by(requests|busyness|traffic) functions were 99% duplicated code. I combined all of that logic into a single ap_proxy_balancer_usable_workers() function in proxy_util.c. (Is that the best place for it?) That function contains all of the logic for iterating through lbsets and returning an array of the available workers that the lbmethod should choose from, whether they be normal workers, spares, or hot standbys. Thus, the lbmethods only need to worry about their specific heuristics for choosing the best worker, not determining which workers are available and which is best.\n\nBalancer-manager management is implemented. AND, I even updated the xml documentation(!!!).\n\nI did not implement hot spare support in mod_lbmethod_heartbeat, as it seems all but dead...and maybe should be deprecated and removed due to hcheck? I do have some code stubs if we really want to add it, though.", "id": 198992, "time": "2017-05-31T17:33:59Z", "bug_id": 61140, "creation_time": "2017-05-31T17:33:59Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "jim@riggs.me", "text": "Created attachment 35021\nhot spare functionality\n\nFor those who like to see a Github-type view, see https://github.com/jhriggs/httpd/pull/1/files.", "id": 198993, "time": "2017-05-31T17:38:01Z", "bug_id": 61140, "creation_time": "2017-05-31T17:38:01Z", "is_private": false, "attachment_id": 35021}, {"count": 2, "tags": [], "creator": "jim@riggs.me", "attachment_id": 35022, "is_private": false, "id": 199008, "time": "2017-06-01T20:38:11Z", "bug_id": 61140, "creation_time": "2017-06-01T20:38:11Z", "text": "Created attachment 35022\npatch v2\n\nFix superfluous ap_proxy_retry_worker_fn"}, {"count": 3, "tags": [], "creator": "jim@riggs.me", "text": "Created attachment 35023\npatch v3\n\nGrr...missed the prototype.", "id": 199009, "time": "2017-06-01T20:46:58Z", "bug_id": 61140, "creation_time": "2017-06-01T20:46:58Z", "is_private": false, "attachment_id": 35023}, {"count": 4, "text": "Created attachment 35024\ncallback patch\n\n- use a callback and baton to the lbmethod in\n  ap_proxy_balancer_get_best_worker() (previously\n  ap_proxy_balancer_usable_workers()) so that we can find the best worker in\n  flight while iterating rather than returning an array of usable workers that\n  has to then in turn be iterated\n\n- consider a draining worker unusable and suitable for replacement by a spare\n\n(I continue to push these to my fork on github, so visual diff/PR can still be seen @ https://github.com/jhriggs/httpd/pull/1/files.)", "creator": "jim@riggs.me", "is_private": false, "id": 199010, "time": "2017-06-02T03:19:59Z", "bug_id": 61140, "creation_time": "2017-06-02T03:19:59Z", "tags": [], "attachment_id": 35024}, {"count": 5, "tags": [], "bug_id": 61140, "attachment_id": 35025, "text": "Created attachment 35025\ncallback patch v2\n\nPrevious callback patch was mistakenly not against trunk.", "id": 199011, "time": "2017-06-02T03:22:39Z", "creator": "jim@riggs.me", "creation_time": "2017-06-02T03:22:39Z", "is_private": false}]