[{"count": 0, "tags": [], "bug_id": 57265, "attachment_id": null, "id": 179299, "time": "2014-11-26T11:24:30Z", "creator": "jaroslav@kamenik.cz", "creation_time": "2014-11-26T11:24:30Z", "is_private": false, "text": "We have moved Tomcat 8 server behind the nginx balancing server and have started  experiencing this problem:\n\norg.apache.tomcat.util.net.NioEndpoint$NioBufferHandler@2001a157\n26-Nov-2014 11:37:04.476 SEVERE [http-nio-8443-ClientPoller-0] org.apache.tomcat.util.net.NioEndpoint$Poller.processSendfile \n java.lang.IllegalArgumentException: You can only read using the application read buffer provided by the handler.\nat org.apache.tomcat.util.net.SecureNioChannel.write(SecureNioChannel.java:489)\nat sun.nio.ch.FileChannelImpl.transferToArbitraryChannel(FileChannelImpl.java:534)\nat sun.nio.ch.FileChannelImpl.transferTo(FileChannelImpl.java:583)\nat org.apache.tomcat.util.net.NioEndpoint$Poller.processSendfile(NioEndpoint.java:1200)\nat org.apache.tomcat.util.net.NioEndpoint$Poller.processKey(NioEndpoint.java:1122)\nat org.apache.tomcat.util.net.NioEndpoint$Poller.run(NioEndpoint.java:1087)\nat java.lang.Thread.run(Thread.java:745)\n\n\nProblem occurres irregularly when loading lots of scripts refencenced by homepage.\nIt seems to be ok with useSendfile=false. I have tried to add some slow logging (with flushing output) to code and it lowers occurrence rate, so it looks like some race condition problem."}, {"count": 1, "tags": [], "bug_id": 57265, "attachment_id": null, "is_private": false, "id": 179487, "time": "2014-12-03T18:45:36Z", "creator": "markt@apache.org", "creation_time": "2014-12-03T18:45:36Z", "text": "Just to confirm my reading of the stacktrace, you are using Sendfile with SSL, right?\n\nIs that is the case, are you sure using Sendfile is providing any benefit?"}, {"count": 2, "tags": [], "text": "Hard to see how this could happen. A possible fix is:\nhttps://github.com/markt-asf/tomcat/commit/9b18a9f97b88572b34f88c456b04d519b8480827", "is_private": false, "id": 179507, "creator": "markt@apache.org", "time": "2014-12-04T13:34:10Z", "bug_id": 57265, "creation_time": "2014-12-04T13:34:10Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "markt@apache.org", "is_private": false, "id": 179529, "creation_time": "2014-12-05T11:57:10Z", "time": "2014-12-05T11:57:10Z", "bug_id": 57265, "text": "Looking at this again.\n\nMaking the sendFile flag volatile isn't going to help since it is always correctly set to the true in the same thread where it is read and found to be false (which triggers the stack trace below).", "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 57265, "attachment_id": null, "id": 179536, "time": "2014-12-05T13:36:42Z", "creator": "markt@apache.org", "creation_time": "2014-12-05T13:36:42Z", "is_private": false, "text": "I've applied a possible fix to trunk, 8.0.x (for 8.0.16 onwards) and 7.0.x (for 7.0.58 onwards).\n\nIf this doesn't fix the issue, please feel free to re-open this and provide an updated stack trace."}, {"count": 5, "tags": [], "creator": "jwojcik@liaison.com", "is_private": false, "id": 181219, "creation_time": "2015-02-20T19:29:04Z", "time": "2015-02-20T19:29:04Z", "bug_id": 57265, "text": "This bug still appears using the NIO connector and SSL.  Using Non-SSL, the bug is fixed.\n\nWe are using tomcat version 7.0.59.\n\nCan you apply your fix to SSL?", "attachment_id": null}, {"count": 6, "tags": [], "text": "*** Bug 58011 has been marked as a duplicate of this bug. ***", "attachment_id": null, "id": 183379, "creator": "markt@apache.org", "time": "2015-06-09T09:04:31Z", "bug_id": 57265, "creation_time": "2015-06-09T09:04:31Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 57265, "is_private": false, "count": 7, "id": 183380, "time": "2015-06-09T09:05:20Z", "creator": "markt@apache.org", "creation_time": "2015-06-09T09:05:20Z", "text": "The previous fix applied equally to HTTP and HTTPS. I'll do another code review."}, {"count": 8, "tags": [], "text": "I've looked at this several times now. The only explanation I can come up with is that a previous update of the sendFile flag in a previous processing thread is delayed and applied at just the wrong moment which breaks the current processing thread. Making sendfile volatile should therefore fix this.\n\nI have applied this fix to trunk (9.0.x), 8.0.x (for 8.0.24 onwards) and 7.0.x (for 7.0.63 onwards). If you see this issue after updating to one of the above releases (or later) please re-open and provide an updated stack trace.", "attachment_id": null, "id": 183382, "creator": "markt@apache.org", "time": "2015-06-09T09:57:48Z", "bug_id": 57265, "creation_time": "2015-06-09T09:57:48Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 57265, "attachment_id": null, "id": 185115, "time": "2015-09-11T13:57:20Z", "creator": "stephenclark@fico.com", "creation_time": "2015-09-11T13:57:20Z", "is_private": false, "text": "I've am experiencing this problem in Linux with Tomcat 8.0.26 using Sendfile with SSH.\n\nHere is the stacktrace:\n\n11-Sep-2015 13:16:46.377 SEVERE [http-nio-443-ClientPoller-0] org.apache.tomcat.util.net.NioEndpoint$Poller.processSendfile \n java.lang.IllegalArgumentException: You can only read using the application read buffer provided by the handler.\n\tat org.apache.tomcat.util.net.SecureNioChannel.write(SecureNioChannel.java:498)\n\tat sun.nio.ch.FileChannelImpl.transferToArbitraryChannel(FileChannelImpl.java:524)\n\tat sun.nio.ch.FileChannelImpl.transferTo(FileChannelImpl.java:573)\n\tat org.apache.tomcat.util.net.NioEndpoint$Poller.processSendfile(NioEndpoint.java:1193)\n\tat org.apache.tomcat.util.net.NioEndpoint$Poller.processKey(NioEndpoint.java:1122)\n\tat org.apache.tomcat.util.net.NioEndpoint$Poller.run(NioEndpoint.java:1087)\n\tat java.lang.Thread.run(Thread.java:744)\n\nI am using the following version of Java:\n\njava version \"1.7.0_51\"\nJava(TM) SE Runtime Environment (build 1.7.0_51-b13)\nJava HotSpot(TM) 64-Bit Server VM (build 24.51-b03, mixed mode)\n\nPlease let me know if I can provide you with any more information."}, {"count": 10, "tags": [], "creator": "markt@apache.org", "is_private": false, "id": 185122, "creation_time": "2015-09-11T20:05:45Z", "time": "2015-09-11T20:05:45Z", "bug_id": 57265, "text": "A few questions:\n- How easily can you reproduce this?\n- Do you have a test case you can share?\n- Are you are able to apply a patch to Tomcat to test a possible fix?\n- Are you able to test with a custom Tomcat build we provide to test a possible fix?", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 57265, "is_private": false, "count": 11, "id": 185296, "time": "2015-09-16T15:57:17Z", "creator": "stephenclark@fico.com", "creation_time": "2015-09-16T15:57:17Z", "text": "(In reply to Mark Thomas from comment #10)\n> A few questions:\n> - How easily can you reproduce this?\n> - Do you have a test case you can share?\n> - Are you are able to apply a patch to Tomcat to test a possible fix?\n> - Are you able to test with a custom Tomcat build we provide to test a\n> possible fix?\n\n- It is an intermittent problem, so we can't reproduce it at will.\n- Unfortunately not.  It is happening as part of our commercial web application that is using ExtJS.  This means that there are some large Javascript files to download when loading the web page\n- Yes, I can apply a patch to Tomcat to test\n- Yes, We can test with a custom Tomcat build\n\nDo you think this problem could be caused by a lack of memory?  Our software is running in a VM and there can sometimes be issues hitting a memory ceiling.  I was wondering if this could cause the problem"}, {"count": 12, "tags": [], "text": "(In reply to Steve Clark from comment #11)\n> (In reply to Mark Thomas from comment #10)\n> > A few questions:\n> > - How easily can you reproduce this?\n> > - Do you have a test case you can share?\n> > - Are you are able to apply a patch to Tomcat to test a possible fix?\n> > - Are you able to test with a custom Tomcat build we provide to test a\n> > possible fix?\n> \n> - It is an intermittent problem, so we can't reproduce it at will.\n> - Unfortunately not.  It is happening as part of our commercial web\n> application that is using ExtJS.  This means that there are some large\n> Javascript files to download when loading the web page\n> - Yes, I can apply a patch to Tomcat to test\n> - Yes, We can test with a custom Tomcat build\n> \n> Do you think this problem could be caused by a lack of memory?  Our software\n> is running in a VM and there can sometimes be issues hitting a memory\n> ceiling.  I was wondering if this could cause the problem\n\nI've just talked to some members of the team and when the issue occurs on their machines they have plenty of free memory so I don't think that this issue is related to a lack of free memory.", "attachment_id": null, "id": 185298, "creator": "stephenclark@fico.com", "time": "2015-09-16T16:12:20Z", "bug_id": 57265, "creation_time": "2015-09-16T16:12:20Z", "is_private": false}, {"count": 13, "tags": [], "text": "I think JF ran into this issue with his SSL testing, so he can test. IMO the most likely is a concurrent channel close (it would flip the sendFile flag), could a simple connection error cause that ?\n\nI don't understand the setting of the sendFile flag to false in a processSendfile finally (the flag could remain until the end of the sendfile instead). This is not going to fix the root cause, but can I make that change in trunk since it would simplify ?\n\nAlso, couldn't the code preventing writing arbitrary buffers be removed ? IMO it's not particularly useful and the sendFile flag could be removed.", "is_private": false, "id": 185299, "creator": "remm@apache.org", "time": "2015-09-16T16:47:10Z", "bug_id": 57265, "creation_time": "2015-09-16T16:47:10Z", "attachment_id": null}, {"count": 14, "tags": [], "text": "I've back-ported one on Remy's fixes to 8.0.x. Please could you try the 8.0.27-dev build available from http://people.apache.org/~markt/dev/v8.0.27-dev/ and let us know if that fixes the issues or not.\n\nNote: This is a dev / snapshot build for testing only. It is NOT an official release.", "attachment_id": null, "id": 185385, "creator": "markt@apache.org", "time": "2015-09-21T14:40:38Z", "bug_id": 57265, "creation_time": "2015-09-21T14:40:38Z", "is_private": false}, {"count": 15, "tags": [], "text": "We really need a test case that reproduces this otherwise we aren't doing much more than guesing what the problem might be.", "is_private": false, "id": 185386, "creator": "markt@apache.org", "time": "2015-09-21T15:08:59Z", "bug_id": 57265, "creation_time": "2015-09-21T15:08:59Z", "attachment_id": null}, {"count": 16, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "text": "According to Jean-Fr\u00e9d\u00e9ric testing, the exception disappeared for him (no ab errors, and performance is rather good with the poller count setting, so all ok apparently). However it would need a sync to be clearly fully eliminated, which is clearly not worth it ! I would prefer removing the sendfile flag from the channel, actively checking the buffer used is not particularly useful IMO.", "id": 185414, "time": "2015-09-22T07:56:30Z", "bug_id": 57265, "creation_time": "2015-09-22T07:56:30Z", "is_private": false}, {"count": 17, "tags": [], "bug_id": 57265, "attachment_id": null, "id": 185415, "time": "2015-09-22T08:13:11Z", "creator": "markt@apache.org", "creation_time": "2015-09-22T08:13:11Z", "is_private": false, "text": "+1"}, {"count": 18, "tags": [], "bug_id": 57265, "attachment_id": null, "is_private": false, "id": 185417, "time": "2015-09-22T08:51:03Z", "creator": "remm@apache.org", "creation_time": "2015-09-22T08:51:03Z", "text": "Cleanup done and ported in 7.0.65 and 8.0.27, so it is supposed to be fixed."}, {"count": 19, "tags": [], "bug_id": 57265, "attachment_id": null, "id": 185454, "time": "2015-09-23T12:06:49Z", "creator": "stephenclark@fico.com", "creation_time": "2015-09-23T12:06:49Z", "is_private": false, "text": "(In reply to Remy Maucherat from comment #18)\n> Cleanup done and ported in 7.0.65 and 8.0.27, so it is supposed to be fixed.\n\nThanks.  I have tried with version 8.0.27 that I built from the trunk today and have not been able to replicate the issue so far (I guess this is because the code no longer throws the exception I was seeing!).\n\nIs there an ETA for the 8.0.27 release build?"}, {"count": 20, "tags": [], "bug_id": 57265, "attachment_id": null, "is_private": false, "id": 185455, "time": "2015-09-23T12:37:07Z", "creator": "markt@apache.org", "creation_time": "2015-09-23T12:37:07Z", "text": "I'm running through the unit tests now making sure they pass on all platforms. Once a get a clean run on all three (Windows, OSX, Linux) I'll be tagging 8.0.27 (assuming no new bugs show up between now and when I get a clean run(."}]