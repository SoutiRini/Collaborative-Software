[{"count": 0, "attachment_id": null, "creator": "mhn4dev@googlemail.com", "text": "I found the following ArrayIndexOutOfBoundsException in my logfile.\nIt occurred directly after login into my webApp without any further user interaction. Unfortunately it is not reproducible at all.\n\nI am not sure whether Jasper is the right component. However the class  JJTELParserState is in the jasper-el.jar.\n\nEnvironment:\nTomcat 6.0.32 \nFacelets 1.1.14\nMyfaces 1.2.9\n\nSCHWERWIEGEND: Error Rendering View[/facelets/myview.xhtml]\njava.lang.ArrayIndexOutOfBoundsException: -1\n\tat java.util.ArrayList.remove(ArrayList.java:390)\n\tat org.apache.el.parser.JJTELParserState.closeNodeScope(JJTELParserState.java:108)\n\tat org.apache.el.parser.ELParser.CompositeExpression(ELParser.java:74)\n\tat org.apache.el.lang.ExpressionBuilder.createNodeInternal(ExpressionBuilder.java:115)\n\tat org.apache.el.lang.ExpressionBuilder.build(ExpressionBuilder.java:172)\n\tat org.apache.el.lang.ExpressionBuilder.createValueExpression(ExpressionBuilder.java:216)\n\tat org.apache.el.ExpressionFactoryImpl.createValueExpression(ExpressionFactoryImpl.java:68)\n\tat com.sun.facelets.el.ELText$ELTextVariable.apply(ELText.java:161)\n\tat com.sun.facelets.compiler.AttributeInstruction.apply(AttributeInstruction.java:60)\n\tat com.sun.facelets.compiler.UIInstructionHandler.apply(UIInstructionHandler.java:95)\n\tat com.sun.facelets.tag.CompositeFaceletHandler.apply(CompositeFaceletHandler.java:47)\n\tat com.sun.facelets.tag.jstl.core.IfHandler.apply(IfHandler.java:54)\n\tat com.sun.facelets.tag.CompositeFaceletHandler.apply(CompositeFaceletHandler.java:47)\n\tat com.sun.facelets.tag.jsf.ComponentHandler.applyNextHandler(ComponentHandler.java:360)\n\tat com.sun.facelets.tag.jsf.ComponentHandler.apply(ComponentHandler.java:190)\n\tat com.sun.facelets.tag.CompositeFaceletHandler.apply(CompositeFaceletHandler.java:47)\n\tat com.sun.facelets.tag.jsf.ComponentHandler.applyNextHandler(ComponentHandler.java:360)\n\tat com.sun.facelets.tag.jsf.ComponentHandler.apply(ComponentHandler.java:190)\n\tat com.sun.facelets.tag.CompositeFaceletHandler.apply(CompositeFaceletHandler.java:47)\n\tat com.sun.facelets.tag.jsf.ComponentHandler.applyNextHandler(ComponentHandler.java:360)\n\tat org.apache.myfaces.custom.aliasbean.AliasBeansScopeTagHandler.applyNextHandler(AliasBeansScopeTagHandler.java:52)\n\tat com.sun.facelets.tag.jsf.ComponentHandler.apply(ComponentHandler.java:190)\n\tat com.sun.facelets.tag.CompositeFaceletHandler.apply(CompositeFaceletHandler.java:47)\n\tat com.sun.facelets.tag.ui.CompositionHandler.apply(CompositionHandler.java:124)\n\tat com.sun.facelets.compiler.NamespaceHandler.apply(NamespaceHandler.java:49)\n\tat com.sun.facelets.compiler.EncodingHandler.apply(EncodingHandler.java:39)\n\tat com.sun.facelets.impl.DefaultFacelet.include(DefaultFacelet.java:248)\n\tat com.sun.facelets.impl.DefaultFacelet.include(DefaultFacelet.java:294)\n\tat com.sun.facelets.impl.DefaultFacelet.include(DefaultFacelet.java:273)\n\tat com.sun.facelets.impl.DefaultFaceletContext.includeFacelet(DefaultFaceletContext.java:140)\n\tat com.sun.facelets.tag.ui.IncludeHandler.apply(IncludeHandler.java:66)\n\tat com.sun.facelets.tag.ui.DefineHandler.applyDefinition(DefineHandler.java:64)\n\tat com.sun.facelets.tag.ui.CompositionHandler.apply(CompositionHandler.java:136)\n\tat com.sun.facelets.impl.DefaultFaceletContext$TemplateManager.apply(DefaultFaceletContext.java:337)\n\tat com.sun.facelets.impl.DefaultFaceletContext.includeDefinition(DefaultFaceletContext.java:307)\n\tat com.sun.facelets.tag.ui.InsertHandler.apply(InsertHandler.java:68)\n\tat com.sun.facelets.tag.CompositeFaceletHandler.apply(CompositeFaceletHandler.java:47)\n\tat com.sun.facelets.tag.jsf.ComponentHandler.applyNextHandler(ComponentHandler.java:360)\n\tat com.sun.facelets.tag.jsf.ComponentHandler.apply(ComponentHandler.java:190)\n\tat com.sun.facelets.tag.CompositeFaceletHandler.apply(CompositeFaceletHandler.java:47)\n\tat com.sun.facelets.tag.jsf.ComponentHandler.applyNextHandler(ComponentHandler.java:360)\n\tat com.sun.facelets.tag.jsf.ComponentHandler.apply(ComponentHandler.java:190)\n\tat com.sun.facelets.tag.CompositeFaceletHandler.apply(CompositeFaceletHandler.java:47)\n\tat com.sun.facelets.tag.ui.CompositionHandler.apply(CompositionHandler.java:124)\n\tat com.sun.facelets.compiler.NamespaceHandler.apply(NamespaceHandler.java:49)\n\tat com.sun.facelets.compiler.EncodingHandler.apply(EncodingHandler.java:39)\n\tat com.sun.facelets.impl.DefaultFacelet.include(DefaultFacelet.java:248)\n\tat com.sun.facelets.impl.DefaultFacelet.include(DefaultFacelet.java:294)\n\tat com.sun.facelets.impl.DefaultFacelet.include(DefaultFacelet.java:273)\n\tat com.sun.facelets.impl.DefaultFaceletContext.includeFacelet(DefaultFaceletContext.java:140)\n\tat com.sun.facelets.tag.ui.CompositionHandler.apply(CompositionHandler.java:116)\n\tat com.sun.facelets.compiler.NamespaceHandler.apply(NamespaceHandler.java:49)\n\tat com.sun.facelets.compiler.EncodingHandler.apply(EncodingHandler.java:39)\n\tat com.sun.facelets.impl.DefaultFacelet.apply(DefaultFacelet.java:95)\n\tat com.sun.facelets.FaceletViewHandler.buildView(FaceletViewHandler.java:596)\n\tat com.sun.facelets.FaceletViewHandler.renderView(FaceletViewHandler.java:651)\n\tat org.ajax4jsf.application.ViewHandlerWrapper.renderView(ViewHandlerWrapper.java:100)\n\tat org.ajax4jsf.application.AjaxViewHandler.renderView(AjaxViewHandler.java:176)\n\tat org.apache.myfaces.lifecycle.RenderResponseExecutor.execute(RenderResponseExecutor.java:41)\n\tat org.apache.myfaces.lifecycle.LifecycleImpl.render(LifecycleImpl.java:140)\n\tat org.apache.myfaces.custom.ppr.PPRLifecycleWrapper.render(PPRLifecycleWrapper.java:84)\n\tat javax.faces.webapp.FacesServlet.service(FacesServlet.java:187)\n\tat com.foo..client.web.servlets.FacesServletWrapper.service(FacesServletWrapper.java:125)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n\tat org.ajax4jsf.webapp.BaseXMLFilter.doXmlFilter(BaseXMLFilter.java:206)\n\tat org.ajax4jsf.webapp.BaseFilter.handleRequest(BaseFilter.java:290)\n\tat org.ajax4jsf.webapp.BaseFilter.processUploadsAndHandleRequest(BaseFilter.java:388)\n\tat org.ajax4jsf.webapp.BaseFilter.doFilter(BaseFilter.java:515)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n\tat org.apache.myfaces.webapp.filter.ExtensionsFilter.doFilter(ExtensionsFilter.java:392)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n\tat com.foo..client.web.filters.LoginFilter.doFilter(LoginFilter.java:219)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n\tat com.foo..client.web.filters.CacheFilter.doFilter(CacheFilter.java:110)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n\tat com.foo..client.web.filters.EncodingFilter.doFilter(EncodingFilter.java:54)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n\tat com.foo..client.web.filters.TimerFilter.doFilter(TimerFilter.java:80)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)\n\tat org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:470)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:298)\n\tat org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:859)\n\tat org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:588)\n\tat org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489)\n\tat java.lang.Thread.run(Thread.java:662)", "id": 145883, "time": "2011-04-20T05:42:42Z", "bug_id": 51088, "creation_time": "2011-04-20T05:42:42Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 51088, "attachment_id": null, "text": "Without the ability to reproduce the error, this issue is likely to be eventually resolved as WONTFIX. Any further information (such as the expression that was being parsed) would be very helpful.\n\nThe code where this error occurs is in auto-generated code from JJTree/JavaCC. Tomcat is using the latest version. I don't see any way that this could be a concurrency issue since none of the objects involved are shared (they are all created in the current thread).\n\nThe bug may be in Tomcat's parser definition (e.g. not handling invalid correctly), JJTree, JavaCC or Tomcat's (less likely in my view) use of the resulting code.", "id": 146135, "time": "2011-05-05T09:13:32Z", "creator": "markt@apache.org", "creation_time": "2011-05-05T09:13:32Z", "is_private": false}, {"count": 2, "tags": [], "creator": "mhn4dev@googlemail.com", "attachment_id": null, "text": "Mark, I can't provide more information unfortunately. I don't know which expression caused the error and I did not see it anymore in any app log.\n\nI'll update this ticket as soon as I see it again", "id": 146279, "time": "2011-05-12T08:11:48Z", "bug_id": 51088, "creation_time": "2011-05-12T08:11:48Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 51088, "attachment_id": null, "text": "> Unfortunately it is not reproducible at all.\n\na) Some rarely executed if-branch in [/facelets/myview.xhtml]?\n\nRare things are not that rare. I do not see any other reports of such an issue with JJTELParserState.\n\nb) Concurrency? As Mark noted in Comment 1 this is unlikely.\n\nExpressionBuilder.java:115 is creating a new ELParser for a String and parsing it. That parsing should be thread safe.\n\n>                n = (new ELParser(new StringReader(expr)))\n>                        .CompositeExpression();\n\nc) Unexpected JVM Error? E.g. OutOfMemoryError.\n\nThe ELParser.java:74 is inside a finally{} block, so if this happened during exception processing the original error might be lost. I think the following cascade of errors is possible, where original error is masked by two others:\n\n1. Exception at ELParser.java:74 (jjtree.closeNodeScope(jjtn000, true);) is possible only if jjtc000 is true.\n2. I think that before it at ELParser.java:60 (jjtree.clearNodeScope(jjtn000);) call failed with a RuntimeException e.g. for the same wrong index reasons as 1. and failed to set jjtc000 to false.\n3. The 2. is inside a catch(Throwable) block and it might be triggered by an OutOfMemoryError,  (or by another RuntimeException at the lower layer, because the same catch(Throwable)+finally handling is everywhere in that generated code).\n\nI think c) is feasible.", "id": 146316, "time": "2011-05-13T22:46:16Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2011-05-13T22:46:16Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 51088, "attachment_id": null, "text": "a) can be excluded (no rarely executed if-branch)\nc) could be possible indeed (although an OOM did not occur, but maybe another RuntimeException)", "id": 146349, "time": "2011-05-16T09:32:16Z", "creator": "mhn4dev@googlemail.com", "creation_time": "2011-05-16T09:32:16Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 51088, "text": "I think Konstantin is along the right lines here.\n\nThe more I look at the generated code, the more there is I don't like (like the exception handling) but I like the idea of writing it myself from scratch even less.\n\nSince this issue can't be reproduced, the best we can do is include the expression that triggered the issue in the exception message. I have made this change to 7.0.x and will propose the same change for 6.0.x.", "id": 147607, "time": "2011-06-29T13:57:47Z", "creator": "markt@apache.org", "creation_time": "2011-06-29T13:57:47Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 51088, "attachment_id": null, "text": "The improved exception handling as been added to 6.0.x and will be included in 6.0.33 onwards.\n\nThere isn't a resolution for \"not enough information to figure out where the problem is\", so I'm resolving this as WONTFIX. If more information emerges from the improved error handling, this issue can always be re-opened.", "id": 147699, "time": "2011-07-02T12:13:08Z", "creator": "markt@apache.org", "creation_time": "2011-07-02T12:13:08Z", "is_private": false}]