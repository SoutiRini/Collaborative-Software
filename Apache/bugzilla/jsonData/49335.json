[{"count": 0, "tags": [], "bug_id": 49335, "attachment_id": null, "text": "Windows XP 64 bit, fully patched\nhttpd 2.2.15\nmod_jk 1.2.30\nTomcat 7.0.0-RC3\n\nI have been unable to get mod_jk to pass SSL certificate information to Tomcat. The set-up works since if I switch my JkMount for a ProxyPass (using mod_proxy_ajp) Tomcat receives the client certificate information. I am therefore sure that the SSL authentication is correctly set-up in httpd.\n\nRunning the mod_jk log at debug level shows mod_jk recognises that this is an SSL request but fails to pass on the client certificate.", "id": 137084, "time": "2010-05-24T18:39:16Z", "creator": "markt@apache.org", "creation_time": "2010-05-24T18:39:16Z", "is_private": false}, {"count": 1, "tags": [], "text": "Is it reproducible in 7.0 RC3 only, or in 6.0.x as well?\n\nIs Tomcat running with 32-bit or 64-bit JRE? Is Tomcat-Native used?\n\nDoes this certificate fit into a single AJP packet, along with other request headers? Sure that it does fit, because otherwise there must be an error logged.\n\nI wonder, how the AJP packet created by mod_jk differs from the one created by mod_proxy_ajp.\n\n\nIn mod_jk the place where SSL certificate is appended to the packet is\nnative\\common\\jk_ajp_common.c\n-- look for SC_A_SSL_CERT there\n\nIn mod_proxy_ajp of Apache 2.2.x the SSL certificates are appended in\nmodules\\proxy\\ajp_header.c\n-- look for SC_A_SSL_CERT there\n\nBy quick look the code there looks quite similar, but there might be a difference on how information on the presence of a certificate is obtained.\n\nWhat JkOptions directives are used in the configuration?\nI see that mod_jk can send a whole certificate chain if +ForwardSSLCertChain option is used (off by default). It looks that mod_proxy_ajp cannot send the certificate chain.", "is_private": false, "bug_id": 49335, "id": 137088, "time": "2010-05-24T20:03:24Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2010-05-24T20:03:24Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 49335, "text": "(In reply to comment #1)\n> Is it reproducible in 7.0 RC3 only, or in 6.0.x as well?\nBoth. Given that the mod_jk logs showed that no certificate was being sent, this is expected. \n\n> Is Tomcat running with 32-bit or 64-bit JRE? Is Tomcat-Native used?\nNot relevant. This isn't an AJP connector issue.\n\n> Does this certificate fit into a single AJP packet, along with other request\n> headers? Sure that it does fit, because otherwise there must be an error\n> logged.\nYes, else a) there would be an error and b) mod_proxy_ajp wouldn't work either.\n\n> What JkOptions directives are used in the configuration?\nThe bare minimum:\nJkWorkersFile\tconf/workers.properties\nJkShmFile\tlogs/mod_jk.shm\nJkLogFile\tlogs/mod_jk.log\n\nNon-SSL requests work without issue.\n\nThe relevant parts of the SSL virtual host are:\n<Location /bugs-tc5/bug37869.jsp >\n\tSSLVerifyClient\trequire\n</Location>\n\nThis works:\nProxyPass /bugs-tc5/bug37869.jsp ajp://localhost:8009/bugs-tc5/bug37869.jsp\n\nThis fails:\nJkMount /bugs-tc5/bug37869.jsp worker1\n\nThat JSP is configured on the Tomcat side to require SSL, require a specific client certificate and to display the DN of the supplied cert.\n\nWith mod_proxy_ajp everything works.\n\nWith mod_jk no certificate is present in the request received by Tomcat. This has been verified a) bu reviewing the mod_jk logs, b) debugging Tomcat parsing the AJP request.", "id": 137091, "time": "2010-05-25T04:20:52Z", "creator": "markt@apache.org", "creation_time": "2010-05-25T04:20:52Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 49335, "attachment_id": null, "text": "The solution should be: add \"SSLOptions +ExportCertData\", and if you want to get information like SSL session id, etc. in addition also add \"SSLOptions +StdEnvVars\". Confirmed by code inspection and by testing.\n\nmod_proxy gets the data directly from mod_ssl through an ssl variable lookup. mod_jk uses the export to environment feature of mod_ssl, which has to be activated explicitely.\n\nI added a note about that to the docs pages \"Apache Reference\" and \"Reverse Proxy HowTo\". See r948029.\n \nPlease reopen, if it does still not work. Thanks for the report.", "id": 137105, "time": "2010-05-25T08:57:52Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2010-05-25T08:57:52Z", "is_private": false}, {"count": 4, "tags": [], "text": "That sounds like it. I had SSLOptions +StdEnvVars but not SSLOptions +ExportCertData\"\n\nI'll test this when I am back in front of that machine and re-open if I still have an issue.", "is_private": false, "id": 137106, "creator": "markt@apache.org", "time": "2010-05-25T09:28:47Z", "bug_id": 49335, "creation_time": "2010-05-25T09:28:47Z", "attachment_id": null}]