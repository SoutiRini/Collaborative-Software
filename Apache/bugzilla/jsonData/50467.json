[{"count": 0, "tags": [], "bug_id": 50467, "attachment_id": null, "id": 142653, "time": "2010-12-13T14:02:35Z", "creator": "hugg@fasterlight.com", "creation_time": "2010-12-13T14:02:35Z", "is_private": false, "text": "We've been running Tomcat 6.0.29 on FC8 2.6.21 with tens of thousands of long polling threads which usually work fine. Every few days though we will experience a sudden lockup of the NIO connector and it has to be restarted. These have been seen to be accompanied by the following stack trace:\n\nException in thread \"http-8082-ClientPoller-0\" java.lang.NullPointerException\n\tat org.apache.tomcat.util.net.NioEndpoint$Poller.run(NioEndpoint.java:1620)\n\tat java.lang.Thread.run(Thread.java:662)\n\nLooking at the source it seems the issue is likely to be a race condition where access() is called on a null attachment, probably while it's in the process of being cancelled:\n\n                    while (iterator != null && iterator.hasNext()) {\n                        SelectionKey sk = (SelectionKey) iterator.next();\n                        KeyAttachment attachment = (KeyAttachment)sk.attachment();\n/*NPE*/                 attachment.access();\n                        iterator.remove();\n                        processKey(sk, attachment);\n                    }//while"}, {"count": 1, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "id": 142682, "time": "2010-12-14T14:05:10Z", "bug_id": 50467, "creation_time": "2010-12-14T14:05:10Z", "is_private": false, "text": "Steven, would it be possible for you to upgrade to the latest (6.0.29) Tomcat version? I seem to recall a recent fix to the NIO connector that fixes some threading issues, though I can't seem to find a reference for it at the moment."}, {"count": 2, "tags": [], "bug_id": 50467, "attachment_id": null, "id": 142683, "time": "2010-12-14T14:06:43Z", "creator": "chris@christopherschultz.net", "creation_time": "2010-12-14T14:06:43Z", "is_private": false, "text": "Ooh, sorry. I misread your version number. Duh."}, {"count": 3, "tags": [], "bug_id": 50467, "attachment_id": null, "id": 142796, "creation_time": "2010-12-16T17:06:55Z", "time": "2010-12-16T17:06:55Z", "creator": "hugg@fasterlight.com", "text": "I haven't reproduced it, but I would imagine that inserting a Thread.sleep() after the call to key.attach(null) in cancelledKey() might do it.\n\nFor now I have just put a null check in the above loop like so:\n\n                        if (attachment != null)\n                        {\n                            attachment.access();\n                            iterator.remove();\n                            processKey(sk, attachment);\n                        } else {\n                            log.warn(\"NioEndpoint: Attachment was null\");\n                            iterator.remove();\n                        }\n\nNot sure if that is correct, but better than the alternative ;)", "is_private": false}, {"count": 4, "tags": [], "creator": "markt@apache.org", "text": "The null check seems reasonable to me.\n\nI have fixed this in 7.0.x and it will be included in 7.0.6 onwards.\n\nI have also proposed the fix for 6.0.x.", "id": 143084, "time": "2011-01-05T08:53:41Z", "bug_id": 50467, "creation_time": "2011-01-05T08:53:41Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 143185, "time": "2011-01-07T13:40:10Z", "bug_id": 50467, "creation_time": "2011-01-07T13:40:10Z", "is_private": false, "text": "Fixed in 6.0.x and will be included in 6.0.30 onwards."}]