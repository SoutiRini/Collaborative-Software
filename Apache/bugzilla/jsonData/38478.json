[{"count": 0, "tags": [], "text": "Description:\n\nConsider the following situation:\n\na) a client performs the initial SSL handshake\n\nb) the client is sending an incomplete request\n   (or noting at all)\n\nc) the client is starting a SSL renegotiation \n   (not triggered by the server. Due to security reasons\n   that is okay)\n\nd) The client is sending only the SSL 'ClientHello'\n   (or the server can only the 'ClientHello')\n\ne) after the configured timeout apache is closing the \n   connection. \n\nIn step e) there is a free memory read than can crash the the server:\n\nIn 'ssl_io_filter_output(..)' the function 'ssl_io_filter_connect(..)'\nwill be called for checking the state of the SSL. And thereby the SSL \nstruct (and the BIOS) will be freed due to the incomplete renegotiation\nhandshake. \nAnd in 'ssl_io_filter_output(..)' it will be not checked again, if the \nSSL struct has been freed.\nIn so in 'bio_filter_out_flush(..)' the already freed BIOS will be accessed\n\n\nLog:\nThe error_log for that situation looks like:\n[Wed Feb 01 16:04:17 2006] [info] [client 192.168.5.137] Connection to child 9\nestablished (server adnpool01.zh.adnovum.ch:44301)\n[Wed Feb 01 16:04:17 2006] [info] Seeding PRNG with 136 bytes of entropy\n[Wed Feb 01 16:04:17 2006] [debug] ssl_engine_kernel.c(1749): OpenSSL:\nHandshake: start\n[Wed Feb 01 16:04:17 2006] [debug] ssl_engine_kernel.c(1757): OpenSSL: Loop:\nbefore/accept initialization\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_io.c(1775): OpenSSL: read 11/11\nbytes from BIO#239438 [mem: 255ce8] (BIO dump follows)\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_io.c(1722):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_io.c(1747): | 0000: 80 4d 01 03 01\n00 24                             .M....$          |\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_io.c(1751): | 0011 - <SPACES/NULS>\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_io.c(1753):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_io.c(1775): OpenSSL: read 68/68\nbytes from BIO#239438 [mem: 255cf3] (BIO dump follows)\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_io.c(1722):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_io.c(1747): | 0000: 00 00 66 00 00\n65 00 00-64 00 00 60 00 00 05 00  ..f..e..d..`.... |\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_io.c(1747): | 0010: 00 04 00 00 03\n00 00 18-00 00 17 08 00 80 01 00  ................ |\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_io.c(1747): | 0020: 80 02 00 80 95\n99 f8 0a-86 4e 2d 3e f5 0e 89 ca  .........N->.... |\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_io.c(1747): | 0030: 15 8f d9 5b 97\n24 d6 05-d7 81 12 08 2d 03 c2 e7  ...[.$......-... |\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_io.c(1747): | 0040: 93 c2 f3 b1  \n                                   ....             |\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_io.c(1753):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_kernel.c(1757): OpenSSL: Loop:\nSSLv3 read client hello A\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_kernel.c(1757): OpenSSL: Loop:\nSSLv3 write server hello A\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_kernel.c(1757): OpenSSL: Loop:\nSSLv3 write certificate A\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_kernel.c(1757): OpenSSL: Loop:\nSSLv3 write server done A\n[Wed Feb 01 16:04:23 2006] [debug] ssl_engine_kernel.c(1757): OpenSSL: Loop:\nSSLv3 flush data\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1775): OpenSSL: read 5/5\nbytes from BIO#239438 [mem: 255ce8] (BIO dump follows)\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1722):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1747): | 0000: 16 03 01 00 86\n                                  .....            |\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1753):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1775): OpenSSL: read 134/134\nbytes from BIO#239438 [mem: 255ced] (BIO dump follows)\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1722):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1747): | 0000: 10 00 00 82 00\n80 04 6c-6b 61 9b ac ad 9f 00 5c  .......lka.....\\ |\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1747): | 0010: b4 93 78 0d 43\n9e e1 da-62 c6 be e2 a0 77 fd 33  ..x.C...b....w.3 |\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1747): | 0020: 99 f8 b0 f3 dc\nab 77 21-05 b9 0f 69 76 0d aa 33  ......w!...iv..3 |\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1747): | 0030: 5c 67 7c 37 3f\n7a bf 87-cb f5 62 1e 6e 2f 32 18  \\g|7?z....b.n/2. |\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1747): | 0040: c3 08 60 44 23\n6e 73 e4-9d ef 37 3c d9 de 15 04  ..`D#ns...7<.... |\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1747): | 0050: 27 dd 1c da 04\n6c da dd-7f 75 d2 5e f3 ac 86 db  '....l...u.^.... |\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1747): | 0060: 29 b7 68 04 fa\nb3 e3 8b-8d 48 da 49 94 d1 40 ee  ).h......H.I..@. |\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1747): | 0070: 00 47 01 80 15\n0e 84 df-c3 4d 64 46 10 83 d2 e5  .G.......MdF.... |\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1747): | 0080: da cb cc c6 fc\n62                                .....b           |\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1753):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_kernel.c(1757): OpenSSL: Loop:\nSSLv3 read client key exchange A\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1775): OpenSSL: read 5/5\nbytes from BIO#239438 [mem: 255ce8] (BIO dump follows)\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1722):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1747): | 0000: 14 03 01 00 01\n                                  .....            |\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1753):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1775): OpenSSL: read 1/1\nbytes from BIO#239438 [mem: 255ced] (BIO dump follows)\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1722):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1747): | 0000: 01           \n                                   .                |\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1753):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1775): OpenSSL: read 5/5\nbytes from BIO#239438 [mem: 255ce8] (BIO dump follows)\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1722):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1747): | 0000: 16 03 01     \n                                   ...              |\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1751): | 0005 - <SPACES/NULS>\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1753):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1775): OpenSSL: read 32/32\nbytes from BIO#239438 [mem: 255ced] (BIO dump follows)\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1722):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1747): | 0000: 1b 15 00 3d be\nd2 ef 1d-b9 32 2c 50 08 b0 ea ee  ...=.....2,P.... |\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1747): | 0010: 3a 55 21 bf c7\nde 54 50-cd 05 b5 6d fa 77 b7 e4  :U!...TP...m.w.. |\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_io.c(1753):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_kernel.c(1757): OpenSSL: Loop:\nSSLv3 read finished A\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_kernel.c(1757): OpenSSL: Loop:\nSSLv3 write change cipher spec A\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_kernel.c(1757): OpenSSL: Loop:\nSSLv3 write finished A\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_kernel.c(1757): OpenSSL: Loop:\nSSLv3 flush data\n[Wed Feb 01 16:04:35 2006] [debug] ssl_engine_kernel.c(1753): OpenSSL:\nHandshake: done\n[Wed Feb 01 16:04:35 2006] [info] Connection: Client IP: 192.168.5.137,\nProtocol: TLSv1, Cipher: RC4-MD5 (128/128 bits)\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_io.c(1775): OpenSSL: read 5/5\nbytes from BIO#239438 [mem: 255ce8] (BIO dump follows)\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_io.c(1722):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_io.c(1747): | 0000: 16 03 01 00 4d\n                                  ....M            |\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_io.c(1753):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_io.c(1775): OpenSSL: read 77/77\nbytes from BIO#239438 [mem: 255ced] (BIO dump follows)\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_io.c(1722):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_io.c(1747): | 0000: 15 f1 9d 00 28\neb b2 57-75 12 3a 22 6d c4 c7 27  ....(..Wu.:\"m..' |\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_io.c(1747): | 0010: 7b 93 72 dd 3c\nb5 bd e5-44 80 da b5 8a 88 b7 ea  {.r.<...D....... |\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_io.c(1747): | 0020: 53 2e 03 f4 3c\na5 41 64-b5 ac 56 2a cb 2e 2b 9e  S...<.Ad..V*..+. |\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_io.c(1747): | 0030: be 6d 06 92 ba\n4c 3d 61-4b 91 cb ce 35 cf c3 82  .m...L=aK...5... |\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_io.c(1747): | 0040: 44 4b 5c 84 2f\n3a 17 7e-e9 2e e1 0c db           DK\\./:.~.....    |\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_io.c(1753):\n+-------------------------------------------------------------------------+\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_kernel.c(1749): OpenSSL:\nHandshake: start\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_kernel.c(1757): OpenSSL: Loop:\nbefore accept initialization\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_kernel.c(1757): OpenSSL: Loop:\nSSLv3 read client hello A\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_kernel.c(1757): OpenSSL: Loop:\nSSLv3 write server hello A\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_kernel.c(1757): OpenSSL: Loop:\nSSLv3 write certificate A\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_kernel.c(1757): OpenSSL: Loop:\nSSLv3 write server done A\n[Wed Feb 01 16:04:42 2006] [debug] ssl_engine_kernel.c(1757): OpenSSL: Loop:\nSSLv3 flush data\n[Wed Feb 01 16:06:42 2006] [debug] ssl_engine_io.c(1786): OpenSSL: I/O error, 5\nbytes expected to read on BIO#239438 [mem: 255ce8]\n[Wed Feb 01 16:06:42 2006] [debug] ssl_engine_kernel.c(1786): OpenSSL: Exit:\nerror in SSLv3 read client certificate A\n[Wed Feb 01 16:06:42 2006] [info] [client 192.168.5.137] (70007)The timeout\nspecified has expired: SSL input filter read failed.\n[Wed Feb 01 16:07:15 2006] [debug] ssl_engine_io.c(1786): OpenSSL: I/O error, 5\nbytes expected to read on BIO#239438 [mem: 255ce8]\n[Wed Feb 01 16:07:15 2006] [debug] ssl_engine_kernel.c(1786): OpenSSL: Exit:\nerror in SSLv3 read client certificate A\n[Wed Feb 01 16:07:23 2006] [info] [client 192.168.5.137] (70014)End of file\nfound: SSL handshake interrupted by system [Hint: Stop button pressed in browser?!]\n[Wed Feb 01 16:07:28 2006] [info] [client 192.168.5.137] Connection closed to\nchild 9 with abortive shutdown (server adnpool01.zh.adnovum.ch:44301)\n\n\nHow to reproduce:\nThe situation can be reproduced with 'openssl -s_client' with some \nmodifications.\n\n\nFix:\nFrom our point of view, the problem or bug is, that 'ssl_io_filter_connect(..)'\nis returning APR_SUCCESS also there is an SSL error and even the SSL struct \nhas been freed.\nThe fix is simply to return APR_EGENERAL if there are SSL errors:\n\nIndex: httpd-2.2.X/modules/ssl//ssl_engine_io.c\n===================================================================\nRCS file:\n/opt/projects/CVSROOT/navajo/src/org/apache/httpd-2.2.X/modules/ssl/ssl_engine_io.c,v\nretrieving revision 1.1\ndiff -c -r1.1 ssl_engine_io.c\n*** httpd-2.2.X/modules/ssl//ssl_engine_io.c    2005/12/08 14:50:46 1.1\n--- httpd-2.2.X/modules/ssl//ssl_engine_io.c    2006/02/01 15:42:52\n***************\n*** 1100,1106 ****\n              inctx->rc = APR_EGENERAL;\n          }\n\n!         return ssl_filter_io_shutdown(filter_ctx, c, 1);\n      }\n\n      /*\n--- 1100,1107 ----\n              inctx->rc = APR_EGENERAL;\n          }\n\n!       ssl_filter_io_shutdown(filter_ctx, c, 1);\n!         return APR_EGENERAL;\n      }\n\n      /*", "attachment_id": null, "id": 85310, "creation_time": "2006-02-01T16:50:10Z", "time": "2006-02-01T16:50:10Z", "creator": "hartmut.keil@gmx.ch", "bug_id": 38478, "is_private": false}, {"count": 1, "tags": [], "bug_id": 38478, "attachment_id": null, "text": "Since there is no feedback, and I think that should be fixed\nI changed the severity to major ", "id": 85858, "time": "2006-02-16T16:45:45Z", "creator": "hartmut.keil@gmx.ch", "creation_time": "2006-02-16T16:45:45Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 38478, "text": "Thanks for the report, Hartmut.\n\nThe error handling here is completely broken.  ssl_io_filter_connect() is\nreturning a mixture of APR status codes, HTTP error codes, and once even an\nOpenSSL error code!?!  ssl_io_filter_shutdown() has a redundant return value\nwhich is always APR_SUCCESS, so that should always be ignored; there are several\nmore callers like this.  And finally, ssl_io_filter_error() is expecting an\napr_status_t and then interpreting it as an HTTP error code.  This is going to\ntake a little time to sort out.", "id": 85879, "attachment_id": null, "creator": "jorton@redhat.com", "creation_time": "2006-02-17T13:05:08Z", "time": "2006-02-17T13:05:08Z", "is_private": false}, {"count": 3, "tags": [], "text": "I agree with you, about the implementation of  ssl_io_filter_connect(), etc.\nand that it will take a while to clean it up. (Let me know if I can help you)\n\nThe other question is to make some point patch availabel? That could \nbe required, since the server can be crashed quite easy. And maybe will, due to\nthe fact that the vulnerability is now public.\n", "attachment_id": null, "id": 85969, "creator": "hartmut.keil@gmx.ch", "time": "2006-02-20T20:13:36Z", "bug_id": 38478, "creation_time": "2006-02-20T20:13:36Z", "is_private": false}]