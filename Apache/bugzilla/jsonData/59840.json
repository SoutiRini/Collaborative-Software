[{"count": 0, "tags": [], "creator": "k.j.chernov@gmail.com", "attachment_id": null, "id": 192283, "time": "2016-07-11T02:18:36Z", "bug_id": 59840, "creation_time": "2016-07-11T02:18:36Z", "is_private": false, "text": "SunOS 5.10 Generic_150401-20 i86pc\n\nHi.\n\nAfter turning on mod_http2 and enabling h2 protocol, I've noticed child crashes approx. once per day:\n\n[2016-07-08 21:07:10.035281] [core:notice] [pid 15804:tid 1] AH00051: child pid 1617 exit signal Segmentation fault (11), possible coredump in /pub/apache/cores\n[2016-07-09 18:13:12.624654] [core:notice] [pid 15804:tid 1] AH00051: child pid 675 exit signal Segmentation fault (11), possible coredump in /pub/apache/cores\n\nGot two core dumps for now:\n$ mdb core.apache.httpd.1617.1467990419 \nLoading modules: [ ld.so.1 libc.so.1 libuutil.so.1 ]\n> ::stack\nlibcrypto.so.1.0.0`X509_get_ext_d2i()\nmod_ssl.so`modssl_var_extract_san_entries+0x56()\nmod_ssl.so`ssl_hook_Fixup+0x1b9()\nap_run_fixups+0x61()\nap_process_request_internal+0xd08()\nap_process_async_request+0x6f7()\nap_process_request+0x24()\nmod_http2.so`h2_task_process_request+0x3fd()\nmod_http2.so`h2_task_process_conn+0x228()\nap_run_process_connection+0x61()\nmod_http2.so`h2_task_do+0x5e2()\nmod_http2.so`execute+0x50()\nlibapr-1.so.0.5.2`dummy_worker+0x30()\nlibc.so.1`_thr_setup+0x5b()\nlibc.so.1`_lwp_start()\n\n$ mdb core.apache.httpd.675.1468066381 \nLoading modules: [ ld.so.1 libc.so.1 libuutil.so.1 ]\n> ::stack\nlibcrypto.so.1.0.0`X509_get_subject_name()\nmod_ssl.so`ssl_hook_Fixup+0x19f()\nap_run_fixups+0x61()\nap_process_request_internal+0xd08()\nap_process_async_request+0x6f7()\nap_process_request+0x24()\nmod_http2.so`h2_task_process_request+0x3fd()\nmod_http2.so`h2_task_process_conn+0x228()\nap_run_process_connection+0x61()\nmod_http2.so`h2_task_do+0x5e2()\nmod_http2.so`execute+0x50()\nlibapr-1.so.0.5.2`dummy_worker+0x30()\nlibc.so.1`_thr_setup+0x5b()\nlibc.so.1`_lwp_start()\n> \n\nTested with both 2.4.18/2.4.23, openssl 1.0.2g/1.0.2h.\n\nIf there's anything more I can do -- will be glad to help."}, {"count": 1, "tags": [], "creator": "stefan@eissing.org", "text": "Thanks for the report. There seem to be issues with concurrent access to SSL variables when SSLOptions StdEnvVars is active.\n\nI have to check back with the mod_ssl devs on how to best mitigate this issue. For now, you may try removing the 'StdEnvVars' option - if your application can live with it - and test if that fixes the issue.", "id": 192286, "time": "2016-07-11T10:19:45Z", "bug_id": 59840, "creation_time": "2016-07-11T10:19:45Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 59840, "text": "Thanks for the advice!\n\nI removed StdEnvVars from the SSLOptions, will see if there are any changes.", "id": 192311, "attachment_id": null, "creator": "k.j.chernov@gmail.com", "creation_time": "2016-07-12T03:39:44Z", "time": "2016-07-12T03:39:44Z", "is_private": false}, {"count": 3, "tags": [], "creator": "k.j.chernov@gmail.com", "text": "Got another segfault yesterday, though I'm not sure whether it is related to the original problem:\n\n[2016-07-12 23:58:06.817849] [core:notice] [pid 15804:tid 1] AH00051: child pid 29484 exit signal Segmentation fault (11), possible coredump in /pub/apache/cores\n\n$ mdb core.apache.httpd.29484.1468346277 \n> ::stack\nmod_http2.so`h2_brigade_mem_size+0x2e()\nmod_http2.so`h2_conn_io_pass+0x33b()\nmod_http2.so`on_send_data_cb+0xa45()\nlibnghttp2.so.14.8.0`nghttp2_session_mem_send_internal+0x165()\nlibnghttp2.so.14.8.0`nghttp2_session_send+0x59()\nmod_http2.so`h2_session_send+0x68()\nmod_http2.so`h2_session_process+0x1863()\nmod_http2.so`h2_conn_run+0x56()\nmod_http2.so`h2_h2_process_conn+0x1122()\nap_run_process_connection+0x61()\nprocess_socket+0x4ab()\nworker_thread+0x351()\nlibapr-1.so.0.5.2`dummy_worker+0x30()\nlibc.so.1`_thr_setup+0x5b()\nlibc.so.1`_lwp_start()", "id": 192337, "time": "2016-07-13T01:25:09Z", "bug_id": 59840, "creation_time": "2016-07-13T01:25:09Z", "is_private": false, "attachment_id": null}, {"count": 4, "text": "Unless we are talking about memory corruption, the second one is unrelated. Since this is the first one of that kind, I am unsure of the reason. \n\nHas this ever happened since?", "bug_id": 59840, "attachment_id": null, "id": 192654, "time": "2016-07-26T14:05:02Z", "creator": "stefan@eissing.org", "creation_time": "2016-07-26T14:05:02Z", "tags": [], "is_private": false}, {"count": 5, "attachment_id": null, "bug_id": 59840, "text": "Stefan,\n\nafter upgrading to 2.4.23 and turning on http2 module I've got several segfaults, even though the number of them reduced after I turned off StdEnvVars. Before upgrade, I was using 2.4.18 without http2, and never had a segfault.\n\nHere are the backtraces (not mentioning one from my last comment):\n$ mdb core.apache.httpd.1407.1468993750 \nLoading modules: [ ld.so.1 libc.so.1 libuutil.so.1 ]\n> ::stack\nlibc.so.1`_read+0xa()\nap_mpm_podx_check+0x38()\nchild_main+0x418()\nmake_child+0x143()\nperform_idle_server_maintenance+0x67f()\nserver_main_loop+0x346()\nevent_run+0x320()\nap_run_mpm+0x71()\nmain+0xe89()\n_start+0x6c()\n\n$ mdb core.apache.httpd.14988.1469184078 \nLoading modules: [ ld.so.1 libc.so.1 libuutil.so.1 ]\n> ::stack\nlibc.so.1`_read+0xa()\nap_mpm_podx_check+0x38()\nchild_main+0x418()\nmake_child+0x143()\nperform_idle_server_maintenance+0x67f()\nserver_main_loop+0x346()\nevent_run+0x320()\nap_run_mpm+0x71()\nmain+0xe89()\n_start+0x6c()\n\n$ mdb core.apache.httpd.23206.1469009815 \nLoading modules: [ ld.so.1 libc.so.1 libuutil.so.1 ]\n> ::stack\nmod_deflate.so`deflate_out_filter+0x2301()\nmod_filter.so`filter_harness+0x1dc()\nap_pass_brigade+0xbc()\nend_output_stream+0xb8()\nap_finalize_request_protocol+0x32()\nap_die_r+0x32()\nap_process_async_request+0x793()\nap_process_request+0x24()\nmod_http2.so`h2_task_process_request+0x3fd()\nmod_http2.so`h2_task_process_conn+0x228()\nap_run_process_connection+0x61()\nmod_http2.so`h2_task_do+0x5e2()\nmod_http2.so`execute+0x50()\nlibapr-1.so.0.5.2`dummy_worker+0x30()\nlibc.so.1`_thr_setup+0x5b()\nlibc.so.1`_lwp_start()\n\nI've also included pstack output.\n\nIf there's any info I can provide to make things more clear, I'll be glad to do so.", "id": 192655, "time": "2016-07-26T14:18:31Z", "creator": "k.j.chernov@gmail.com", "creation_time": "2016-07-26T14:18:31Z", "tags": [], "is_private": false}, {"count": 6, "tags": [], "creator": "k.j.chernov@gmail.com", "attachment_id": 34074, "id": 192656, "time": "2016-07-26T14:19:39Z", "bug_id": 59840, "creation_time": "2016-07-26T14:19:39Z", "is_private": false, "text": "Created attachment 34074\npstack output of coredumps"}, {"count": 7, "tags": [], "creator": "stefan@eissing.org", "text": "These are all very weird places. I would ask you to disable h2 for the time being and check if 2.4.23 runs as stable on your platform as 2.4.18 did. Let's just verify that there not something else here going on.", "id": 192690, "time": "2016-07-28T12:45:45Z", "bug_id": 59840, "creation_time": "2016-07-28T12:45:45Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 59840, "attachment_id": null, "text": "Stefan,\n\nthanks for the reply, I'll disable h2 tomorrow and leave it disabled for about a week.", "id": 192695, "time": "2016-07-28T14:59:07Z", "creator": "k.j.chernov@gmail.com", "creation_time": "2016-07-28T14:59:07Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 59840, "text": "There were no segfaults since 29/07/2016 (the date when I disabled http2 module).\nI assume the problem is not caused by 2.4.23 itself :(", "count": 9, "id": 192950, "time": "2016-08-08T01:02:39Z", "creator": "k.j.chernov@gmail.com", "creation_time": "2016-08-08T01:02:39Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 59840, "text": "Right after enabling http2 again, got a few more segfaults :(\n\nHere's the latest one (+2 more with the same backtraces as in my previous comments):\n> ::stack\nlibaprutil-1.so.0.5.4`apr_brigade_cleanup+0x43()\nlibaprutil-1.so.0.5.4`brigade_cleanup+0x18()\nlibapr-1.so.0.5.2`run_cleanups+0x3c()\nlibapr-1.so.0.5.2`apr_pool_destroy+0x57()\neor_bucket_destroy+0x2a()\nlibaprutil-1.so.0.5.4`apr_brigade_cleanup+0x60()\nap_process_request_after_handler+0xc6()\nap_process_async_request+0x79f()\nap_process_request+0x24()\nmod_http2.so`h2_task_process_request+0x3fd()\nmod_http2.so`h2_task_process_conn+0x228()\nap_run_process_connection+0x61()\nmod_http2.so`h2_task_do+0x5e2()\nmod_http2.so`execute+0x50()\nlibapr-1.so.0.5.2`dummy_worker+0x30()\nlibc.so.1`_thr_setup+0x5b()\nlibc.so.1`_lwp_start()", "id": 193105, "time": "2016-08-15T02:49:14Z", "creator": "k.j.chernov@gmail.com", "creation_time": "2016-08-15T02:49:14Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "creator": "stefan@eissing.org", "text": "Thanks Konstantin. At least it's clear that http2 is the culprit and the backtrace points to connection shutdown. Have do analyze that a bit more...", "id": 193325, "time": "2016-08-25T12:45:56Z", "bug_id": 59840, "creation_time": "2016-08-25T12:45:56Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "creator": "stefan@eissing.org", "attachment_id": null, "id": 193383, "time": "2016-08-29T07:53:11Z", "bug_id": 59840, "creation_time": "2016-08-29T07:53:11Z", "is_private": false, "text": "Konstantin,\n\nare you able to build a new mod_http2 for testing? The current state of branch 2.4.x contains a cleanup fix that might address the issues you observe.\n\nAs an alternative, you can also you the github release at https://github.com/icing/mod_h2/releases/tag/v1.6.1 if you have apxs and autoconf on your system."}, {"count": 13, "tags": [], "creator": "k.j.chernov@gmail.com", "attachment_id": null, "id": 193387, "time": "2016-08-29T10:04:28Z", "bug_id": 59840, "creation_time": "2016-08-29T10:04:28Z", "is_private": false, "text": "Hi.\n\nWill it be enough to replace mod_http2 folder contents from https://github.com/apache/httpd/tree/trunk/modules/http2 and recompile the Apache?"}, {"attachment_id": null, "tags": [], "bug_id": 59840, "text": "I've replaced modules/http2 from https://github.com/apache/httpd/tree/2.4.x (hopefully, this link is correct) and rebuilt the apache with the rest of the sources left unchanged, then replaced single mod_http2.so on prod environment.\n\nWill see if there are any changes.", "count": 14, "id": 193396, "time": "2016-08-30T07:13:16Z", "creator": "k.j.chernov@gmail.com", "creation_time": "2016-08-30T07:13:16Z", "is_private": false}, {"count": 15, "tags": [], "creator": "k.j.chernov@gmail.com", "text": "After more than a week of stable work, there were 3 segfaults yesterday, all with the same stack:\n> ::stack\nlibc.so.1`_read+0xa()\nap_mpm_podx_check+0x38()\nchild_main+0x418()\nmake_child+0x143()\nperform_idle_server_maintenance+0x67f()\nserver_main_loop+0x346()\nevent_run+0x320()\nap_run_mpm+0x71()\nmain+0xe89()\n_start+0x6c()\n\nI'm not really sure they are somehow connected to mod_http2, though without mod_http2 there are no segfaults at all.", "id": 193500, "time": "2016-09-06T01:20:05Z", "bug_id": 59840, "creation_time": "2016-09-06T01:20:05Z", "is_private": false, "attachment_id": null}, {"count": 16, "tags": [], "bug_id": 59840, "attachment_id": null, "text": "(In reply to Konstantin J. Chernov from comment #15)\n> After more than a week of stable work, there were 3 segfaults yesterday, all\n> with the same stack:\n> > ::stack\n> libc.so.1`_read+0xa()\n> ap_mpm_podx_check+0x38()\n> child_main+0x418()\n> make_child+0x143()\n> perform_idle_server_maintenance+0x67f()\n> server_main_loop+0x346()\n> event_run+0x320()\n> ap_run_mpm+0x71()\n> main+0xe89()\n> _start+0x6c()\n> \n> I'm not really sure they are somehow connected to mod_http2, though without\n> mod_http2 there are no segfaults at all.\n\nThat is not the crashing thread, there must be some other that looks a little more suspicious.", "id": 193501, "time": "2016-09-06T01:38:59Z", "creator": "covener@gmail.com", "creation_time": "2016-09-06T01:38:59Z", "is_private": false}, {"count": 17, "tags": [], "text": "Created attachment 34203\ncore.apache.httpd.12673.1473072482.stack", "is_private": false, "id": 193502, "creation_time": "2016-09-06T03:02:39Z", "time": "2016-09-06T03:02:39Z", "creator": "k.j.chernov@gmail.com", "bug_id": 59840, "attachment_id": 34203}, {"count": 18, "tags": [], "creator": "k.j.chernov@gmail.com", "text": "I've attached full pstack of one of three coredumps: core.apache.httpd.12673.1473072482.stack\nHopefully it will give more valuable info.", "id": 193503, "time": "2016-09-06T03:03:21Z", "bug_id": 59840, "creation_time": "2016-09-06T03:03:21Z", "is_private": false, "attachment_id": null}, {"count": 19, "tags": [], "creator": "stefan@eissing.org", "attachment_id": null, "id": 193537, "time": "2016-09-07T03:02:53Z", "bug_id": 59840, "creation_time": "2016-09-07T03:02:53Z", "is_private": false, "text": "Hmm, I do not see it. Someone with better eyes than me?"}, {"count": 20, "tags": [], "creator": "covener@gmail.com", "text": "(In reply to Stefan Eissing from comment #19)\n> Hmm, I do not see it. Someone with better eyes than me?\n\nt94 is suspicious", "id": 193538, "time": "2016-09-07T03:08:43Z", "bug_id": 59840, "creation_time": "2016-09-07T03:08:43Z", "is_private": false, "attachment_id": null}, {"count": 21, "tags": [], "creator": "k.j.chernov@gmail.com", "text": "Created attachment 34222\nthree more full pstack outputs", "id": 193557, "time": "2016-09-08T00:47:13Z", "bug_id": 59840, "creation_time": "2016-09-08T00:47:13Z", "is_private": false, "attachment_id": 34222}, {"count": 22, "tags": [], "creator": "stefan@eissing.org", "text": "Just for completeness since I did not ask yet: do you see anything in the error logs from mod_http2. Any warning?", "id": 193642, "time": "2016-09-12T08:45:22Z", "bug_id": 59840, "creation_time": "2016-09-12T08:45:22Z", "is_private": false, "attachment_id": null}, {"count": 23, "tags": [], "bug_id": 59840, "attachment_id": null, "id": 193669, "time": "2016-09-13T07:17:41Z", "creator": "k.j.chernov@gmail.com", "creation_time": "2016-09-13T07:17:41Z", "is_private": false, "text": "I've looked through the logs: out of 5 crashes we had during the last week, there were only one crash that corresponds with the warning from mod_http2:\n[2016-09-10 14:34:41.832137] [http2:warn] [pid 10635:tid 91] [C:AB0Zx5UDdAA] AH03198: h2_mplx(172): release, waiting for 87865 seconds now for 1 h2_workers to return, have still 21 tasks outstanding\n\nBut that was not written by the process(PID/TID) that crashed, as the messages from this pid/tid appears further in the logs."}]