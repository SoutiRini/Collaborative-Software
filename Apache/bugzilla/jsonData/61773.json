[{"count": 0, "tags": [], "creator": "zhangxj@shterm.com", "attachment_id": 35534, "id": 202197, "time": "2017-11-17T04:57:30Z", "bug_id": 61773, "creation_time": "2017-11-17T04:57:30Z", "is_private": false, "text": "Created attachment 35534\nAttachment is the test code and the server.xml\n\nWhen more than 10000 times of HTTPS websocket, Tomcat cannot respond to requesting HTTPS requests.\n\nBy checking the Nio2Endpoint code, blocking when the number of requests will exceed 10000. Maybe the abnormal release of Https leads to this problem.\n\nI use Tomcat's chat examples to test it. Only HTTPs has problems, and HTTP is normal. Tomcat 8.5.23 is also normal."}, {"count": 1, "tags": [], "text": "Blocked at Nio2Endpoint$Acceptor.countUpOrAwaitConnection.Thread information below.\n\n\"http-nio2-8443-Acceptor-0\" #182 daemon prio=5 os_prio=0 tid=0x00007fe20c1ea000 nid=0xe85 waiting on condition [0x00007fe125be0000]\n   java.lang.Thread.State: WAITING (parking)\n\tat sun.misc.Unsafe.park(Native Method)\n\t- parking to wait for  <0x00000000a70c0578> (a org.apache.tomcat.util.threads.LimitLatch$Sync)\n\tat java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:997)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1304)\n\tat org.apache.tomcat.util.threads.LimitLatch.countUpOrAwait(LimitLatch.java)\n\tat org.apache.tomcat.util.net.AbstractEndpoint.countUpOrAwaitConnection(AbstractEndpoint.java)\n\tat org.apache.tomcat.util.net.Nio2Endpoint$Acceptor.run(Nio2Endpoint.java:715)\n\tat java.lang.Thread.run(Thread.java:745)", "is_private": false, "bug_id": 61773, "id": 202198, "time": "2017-11-17T05:29:33Z", "creator": "zhangxj@shterm.com", "creation_time": "2017-11-17T05:29:33Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "is_private": false, "id": 202199, "time": "2017-11-17T06:02:21Z", "bug_id": 61773, "creation_time": "2017-11-17T06:02:21Z", "text": "Please use the user list http://tomcat.apache.org/lists.html#tomcat-users to get support on this issue."}, {"count": 3, "tags": [], "creator": "zhangxj@shterm.com", "attachment_id": null, "id": 202213, "time": "2017-11-18T07:04:38Z", "bug_id": 61773, "creation_time": "2017-11-18T07:04:38Z", "is_private": false, "text": "After further testing, it is found that when Connector is configured with Http2NioProtocol, Websocket closes and AbstractEndpoint.countDownConnection cannot be called.\nDetails of closing Websocket connection are as follows:\n1, when the WebSocket is closed by the client, it first calls the Nio2Channel.close method. This method calls SocketChannel.close and calls Nio2Channel.isOpen back to false\n\n2, the last call to the Nio2Endpoint.closeSocket method, the release of Socket. This method is called AbstractEndpoint.countDownConnection if Nio2Channel.isOpen returns true, but the first step is to call the SocketChannel.close method, it returns false, leading to the call to AbstractEndpoint.countDownConnection, the number of connections appear unable to release, and cannot receive the new request when opened Websocket over 10000.\n\nSo, I guess the problem is on the Nio2Endpoint.closeSocket implementation.\n\nPlease see logs for testing.\n\n\n\nStep 1 log:\n\n-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|           STACK | thread_name=\"http-nio2-8080-exec-5\" thread_id=0x10;is_daemon=true;priority=5;                                                                          |\n|                 |     @org.apache.tomcat.util.net.Nio2Channel.isOpen(Nio2Channel.java:96)                                                                                |\n|                 |         at org.apache.tomcat.util.net.Nio2Channel.close(Nio2Channel.java:84)                                                                           |\n|                 |         at org.apache.coyote.http11.upgrade.Nio2ServletOutputStream.doClose(Nio2ServletOutputStream.java:196)                                          |\n|                 |         at org.apache.coyote.http11.upgrade.AbstractServletOutputStream.close(AbstractServletOutputStream.java:140)                                    |\n|                 |         at org.apache.tomcat.websocket.server.WsRemoteEndpointImplServer.doClose(WsRemoteEndpointImplServer.java:139)                                  |\n|                 |         at org.apache.tomcat.websocket.WsRemoteEndpointImplBase.close(WsRemoteEndpointImplBase.java:667)                                               |\n|                 |         at org.apache.tomcat.websocket.server.WsHttpUpgradeHandler$WsWriteListener.onError(WsHttpUpgradeHandler.java:234)                              |\n|                 |         at org.apache.coyote.http11.upgrade.AbstractServletOutputStream.onError(AbstractServletOutputStream.java:239)                                  |\n|                 |         at org.apache.coyote.http11.upgrade.Nio2ServletOutputStream$1.failed(Nio2ServletOutputStream.java:74)                                          |\n|                 |         at org.apache.coyote.http11.upgrade.Nio2ServletOutputStream$1.failed(Nio2ServletOutputStream.java:51)                                          |\n|                 |         at sun.nio.ch.Invoker.invokeUnchecked(Invoker.java:128)                                                                                        |\n|                 |         at sun.nio.ch.Invoker.invokeDirect(Invoker.java:157)                                                                                           |\n|                 |         at sun.nio.ch.UnixAsynchronousSocketChannelImpl.implWrite(UnixAsynchronousSocketChannelImpl.java:736)                                          |\n|                 |         at sun.nio.ch.AsynchronousSocketChannelImpl.write(AsynchronousSocketChannelImpl.java:382)                                                      |\n|                 |         at sun.nio.ch.AsynchronousSocketChannelImpl.write(AsynchronousSocketChannelImpl.java:399)                                                      |\n|                 |         at org.apache.tomcat.util.net.Nio2Channel.write(Nio2Channel.java:161)                                                                          |\n|                 |         at org.apache.coyote.http11.upgrade.Nio2ServletOutputStream.doWriteInternal(Nio2ServletOutputStream.java:153)                                  |\n|                 |         at org.apache.coyote.http11.upgrade.Nio2ServletOutputStream.doWrite(Nio2ServletOutputStream.java:97)                                           |\n|                 |         at org.apache.coyote.http11.upgrade.AbstractServletOutputStream.writeInternal(AbstractServletOutputStream.java:165)                            |\n|                 |         at org.apache.coyote.http11.upgrade.AbstractServletOutputStream.write(AbstractServletOutputStream.java:132)                                    |\n|                 |         at org.apache.tomcat.websocket.server.WsRemoteEndpointImplServer.onWritePossible(WsRemoteEndpointImplServer.java:98)                           |\n|                 |         at org.apache.tomcat.websocket.server.WsRemoteEndpointImplServer.doWrite(WsRemoteEndpointImplServer.java:79)                                   |\n|                 |         at org.apache.tomcat.websocket.WsRemoteEndpointImplBase.writeMessagePart(WsRemoteEndpointImplBase.java:453)                                    |\n|                 |         at org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessage(WsRemoteEndpointImplBase.java:341)                                        |\n|                 |         at org.apache.tomcat.websocket.WsRemoteEndpointImplBase.startMessageBlock(WsRemoteEndpointImplBase.java:273)                                   |\n|                 |         at org.apache.tomcat.websocket.WsSession.sendCloseMessage(WsSession.java:600)                                                                  |\n|                 |         at org.apache.tomcat.websocket.WsSession.doClose(WsSession.java:490)                                                                           |\n|                 |         at org.apache.tomcat.websocket.server.WsHttpUpgradeHandler.onError(WsHttpUpgradeHandler.java:149)                                              |\n|                 |         at org.apache.tomcat.websocket.server.WsHttpUpgradeHandler.access$300(WsHttpUpgradeHandler.java:47)                                            |\n|                 |         at org.apache.tomcat.websocket.server.WsHttpUpgradeHandler$WsReadListener.onError(WsHttpUpgradeHandler.java:206)                               |\n|                 |         at org.apache.coyote.http11.upgrade.AbstractServletInputStream.onError(AbstractServletInputStream.java:216)                                    |\n|                 |         at org.apache.coyote.http11.upgrade.Nio2ServletInputStream$1.failed(Nio2ServletInputStream.java:82)                                            |\n|                 |         at org.apache.coyote.http11.upgrade.Nio2ServletInputStream$1.failed(Nio2ServletInputStream.java:51)                                            |\n|                 |         at sun.nio.ch.Invoker.invokeUnchecked(Invoker.java:128)                                                                                        |\n|                 |         at sun.nio.ch.Invoker$2.run(Invoker.java:218)                                                                                                  |\n|                 |         at sun.nio.ch.AsynchronousChannelGroupImpl$1.run(AsynchronousChannelGroupImpl.java:112)                                                        |\n|                 |         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)                                                             |\n|                 |         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)                                                             |\n|                 |         at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:-1)                                                          |\n|                 |         at java.lang.Thread.run(Thread.java:748)                                                                                                   \n\nStep 2 log:\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+\n|           STACK | thread_name=\"http-nio2-8080-exec-8\" thread_id=0x13;is_daemon=true;priority=5;                                                                          |\n|                 |     @org.apache.tomcat.util.net.Nio2Channel.isOpen(Nio2Channel.java:96)                                                                                |\n|                 |         at org.apache.tomcat.util.net.Nio2Endpoint.closeSocket(Nio2Endpoint.java:649)                                                                  |\n|                 |         at org.apache.tomcat.util.net.Nio2Endpoint$SocketProcessor.doRun(Nio2Endpoint.java:1102)                                                       |\n|                 |         at org.apache.tomcat.util.net.Nio2Endpoint$SocketProcessor.run(Nio2Endpoint.java:1056)                                                         |\n|                 |         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)                                                             |\n|                 |         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)                                                             |\n|                 |         at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:-1)                                                          |\n|                 |         at java.lang.Thread.run(Thread.java:748)                                                                                                       |\n+-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+"}, {"count": 4, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 202309, "time": "2017-11-21T15:01:26Z", "bug_id": 61773, "creation_time": "2017-11-21T15:01:26Z", "is_private": false, "text": "Thanks for the additional information.\n\nI have been able to reproduce this with NIO2 with both http and https connections. I did this by connecting to the WebSocket chat example and then closing the browser while monitoring the current connection count via JMX. For every new chat Window, the connection count increased by 2 but only decreased by one when the window closed.\n\nThis only affects NIO2 on Tomcat 8.0.x.\n\nThis has been fixed in 8.0.x trunk and will be included in 8.0.48 onwards."}]