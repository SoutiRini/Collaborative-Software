[{"count": 0, "tags": [], "bug_id": 42497, "attachment_id": null, "text": "According to the HTTP spec, if a server includes an ETag header when it sends a\nfile, it must also include the ETag when it sends a 304 (not-modified) response\nfor that file. Tomcat does not do this for static files - if you request a\nstatic file and get a 200 response, the response has an ETag header; but if you\nget a 304 resopnse, the ETag is omitted.\n\nTo reproduce:\n- In a browser, request a static file from Tomcat (e.g. http://localhost/tomcat.gif)\n- Make sure you get a 200 response (force reload or clear browser cache)\n- Examine the response headers (using a browser plugin or whatever) - note that\nthere is an ETag header\n- Request the same file again, getting a 304 (not-modified) response from Tomcat\n- Examine the response headers - note there is no ETag\nThe 304 response should include an ETag header, because the 200 response had one.\n\nSpec reference: RFC 2616 section 10.3.5 says:\n\"304 Not Modified\n[...]\nThe response MUST include the following header fields:\n[...]\n      - ETag and/or Content-Location, if the header would have been sent\n        in a 200 response to the same request\"", "id": 103555, "time": "2007-05-23T09:00:19Z", "creator": "len.popp@gmail.com", "creation_time": "2007-05-23T09:00:19Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 42497, "is_private": false, "text": "Created attachment 20251\nRequest and response headers showing the problem\n\nI have attached a log file from Firefix LiveHTTPHeaders showing the problem.\nA static file is requested twice. The first response is a 200 with an ETag\nheader,\nthe second response is a 304 without an ETag header.", "id": 103556, "time": "2007-05-23T09:03:45Z", "creator": "len.popp@gmail.com", "creation_time": "2007-05-23T09:03:45Z", "attachment_id": 20251}, {"count": 2, "tags": [], "bug_id": 42497, "is_private": false, "text": "I see how to fix this, but I'm not set up to compile Tomcat so someone else will\nhave to make the change and test it.\n\nIn org.apache.catalina.servlets.DefaultServlet, the serveResource method sets an\nETag header when it serves a file with a 200 or 206 response. To get it to add\nthe ETag to 304 responses, this needs to be added:\n response.setHeader(\"ETag\", getETag(resourceAttributes));\nin two places where a a status of 304 (SC_NOT_MODIFIED) is set, in the methods\ncheckIfModifiedSince and checkIfNoneMatch.", "id": 103965, "time": "2007-06-01T07:43:20Z", "creator": "len.popp@gmail.com", "creation_time": "2007-06-01T07:43:20Z", "attachment_id": null}, {"count": 3, "attachment_id": null, "bug_id": 42497, "text": "(I've changed the Component to \"Catalina\" because none of the more specific\nComponents seem appropriate. If that's wrong, please correct it.)", "id": 103966, "time": "2007-06-01T07:45:44Z", "creator": "len.popp@gmail.com", "creation_time": "2007-06-01T07:45:44Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 103988, "time": "2007-06-01T18:01:51Z", "bug_id": 42497, "creation_time": "2007-06-01T18:01:51Z", "is_private": false, "text": "Thanks for the patch. It has been applied to svn and will be in 5.5.24 and\n6.0.14 onwards."}, {"count": 5, "attachment_id": null, "bug_id": 42497, "text": "Tested OK in 5.5.24 release candidate.", "id": 104454, "time": "2007-06-15T15:50:45Z", "creator": "len.popp@gmail.com", "creation_time": "2007-06-15T15:50:45Z", "tags": [], "is_private": false}]