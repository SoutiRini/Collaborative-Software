[{"count": 0, "tags": [], "bug_id": 35897, "attachment_id": null, "text": "Shouldn't a more specific exception (e.g. PasswordProtectedFileException) be\nthrown? And not only for doc files\nbut also for ppt and xls locally i have patched the code(for local use)\nwith my findings that record type 49 indicates also password protected\nfile for xls and 51432 is for ppt files. But this is only an assumtion\ncause i was just checking what king of record fails when loading office\ndocuments.", "id": 77723, "time": "2005-07-27T16:35:13Z", "creator": "akurtakov@gmail.com", "creation_time": "2005-07-27T16:35:13Z", "is_private": false}, {"count": 1, "tags": [], "creator": "akurtakov@gmail.com", "text": "Created attachment 15796\nPassword protected doc file", "id": 77724, "time": "2005-07-27T16:36:18Z", "bug_id": 35897, "creation_time": "2005-07-27T16:36:18Z", "is_private": false, "attachment_id": 15796}, {"count": 2, "tags": [], "bug_id": 35897, "attachment_id": 15797, "text": "Created attachment 15797\nPassword protected ppt file", "id": 77725, "time": "2005-07-27T16:37:09Z", "creator": "akurtakov@gmail.com", "creation_time": "2005-07-27T16:37:09Z", "is_private": false}, {"count": 3, "tags": [], "creator": "akurtakov@gmail.com", "attachment_id": 15798, "id": 77726, "time": "2005-07-27T16:37:36Z", "bug_id": 35897, "creation_time": "2005-07-27T16:37:36Z", "is_private": false, "text": "Created attachment 15798\nPassword protected xls file"}, {"count": 4, "tags": [], "bug_id": 35897, "attachment_id": null, "is_private": false, "id": 84759, "time": "2006-01-19T00:29:54Z", "creator": "trejkaz@trypticon.org", "creation_time": "2006-01-19T00:29:54Z", "text": "I'm getting OutOfMemoryError when I read password-protected documents.  Is this\nwhat you're talking about?\n\nWould you mind attaching the code that detects when a file is password\nprotected?  I would have a use for something like this even if POI doesn't\ncommit it. :-)"}, {"count": 5, "tags": [], "creator": "apache@gagravarr.org", "attachment_id": null, "id": 90855, "time": "2006-07-04T10:41:50Z", "bug_id": 35897, "creation_time": "2006-07-04T10:41:50Z", "is_private": false, "text": "We now throw an exception in the case of encrypted powerpoint documents.\n\nOpenOffice seem to have some docs on protected excel files (eg\nhttp://specs.openoffice.org/appwide/interoperability/Import_Password_Protected_MS_Office_Files.sxw)\nif anyone wants to contribute some detection code."}, {"count": 6, "tags": [], "bug_id": 35897, "attachment_id": 27101, "text": "Created attachment 27101\nA little hack which detects encrypted XLS files\n\nThis is based on an observation taken from the Excel Spec (page 119):\n\nIf you type a protection password (File menu, Save As command, Options dialog box), the FILEPASS record appears in the BIFF file. The wProtPass field contains the encrypted password. All records after FILEPASS are encrypted\n\nThe patch looks for the FilePass record. If it's found, all subsequent RecordFormatExceptions are interpreted as encryption failures.\n\nThis doesn't cover the per-sheet passwords, only the per-file passwords. It seems to work for me. Is there a better way?", "id": 146800, "time": "2011-06-01T16:12:33Z", "creator": "antoni.mylka@aduna-software.com", "creation_time": "2011-06-01T16:12:33Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 35897, "attachment_id": 27102, "text": "Created attachment 27102\nA password-protected XLS file submitted by a user of the Aperture Framework\n\nAttached the password-hello.xls file. It's a password-protected XLS file referred in my unit test in the previous patch. It has been submitted by \"cbamfort\", a user of the Aperture Framework to the Aperture issue:\n\nhttp://sourceforge.net/tracker/?func=detail&aid=3088113&group_id=150969&atid=779503", "id": 146801, "time": "2011-06-01T16:15:13Z", "creator": "antoni.mylka@aduna-software.com", "creation_time": "2011-06-01T16:15:13Z", "is_private": false}, {"count": 8, "tags": [], "creator": "trejkaz@trypticon.org", "attachment_id": null, "id": 172255, "time": "2014-01-10T04:41:35Z", "bug_id": 35897, "creation_time": "2014-01-10T04:41:35Z", "is_private": false, "text": "Bumping this to ask: can HSSF at least throw EncryptedDocumentException for encrypted documents?\n\nCurrently, this is what I'm seeing:\n\norg.apache.poi.hssf.record.RecordFormatException: HSSF does not currently support XOR obfuscation\n    at org.apache.poi.hssf.record.FilePassRecord.<init>(FilePassRecord.java:52)\n    at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\n    at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:57)\n    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\n    at java.lang.reflect.Constructor.newInstance(Constructor.java:525)\n    at org.apache.poi.hssf.record.RecordFactory$ReflectionConstructorRecordCreator.create(RecordFactory.java:57)\n\nThis is thrown from the FilePassRecord constructor.\n\nThe hack Antoni has described above seems to rely on FilePassRecord being successfully constructed, so I guess that won't help.\n\nAt the moment, our code is catching EncryptedDocumentException, but then these cases fall through the cracks, because the wrong exception has been thrown."}, {"count": 9, "tags": [], "bug_id": 35897, "attachment_id": 31194, "text": "Created attachment 31194\nXOR encryption example (password \"abc\")\n\nAttaching a sample I constructed.", "id": 172256, "time": "2014-01-10T06:04:40Z", "creator": "trejkaz@trypticon.org", "creation_time": "2014-01-10T06:04:40Z", "is_private": false}, {"count": 10, "tags": [], "creator": "trejkaz@trypticon.org", "attachment_id": 31195, "id": 172257, "time": "2014-01-10T06:06:24Z", "bug_id": 35897, "creation_time": "2014-01-10T06:06:24Z", "is_private": false, "text": "Created attachment 31195\nProposed patch for XOR encryption detection\n\nAttaching the patch we're using here to work around it. The only thing I'm not sure about is the means we're using to propagate the exception. Perhaps the code there should just propagate all RuntimeExceptions."}, {"count": 11, "tags": [], "creator": "trejkaz@trypticon.org", "attachment_id": null, "id": 172258, "time": "2014-01-10T06:10:18Z", "bug_id": 35897, "creation_time": "2014-01-10T06:10:18Z", "is_private": false, "text": "Someone else trying to make test data for this issue also hit the error:\n\"Unknown encryption info: 4\"\n\nI wasn't sure if that was a problem or a legitimate value, so I left it alone."}, {"count": 12, "tags": [], "text": "applied with r1557281\n+ Junit4 modifications to support expected exceptions\n\nI leave it open for now, as I would prefer to have that XOR encryption and maybe CryptoAPI also to be implemented ...", "attachment_id": null, "bug_id": 35897, "id": 172278, "time": "2014-01-10T23:37:49Z", "creator": "kiwiwings@apache.org", "creation_time": "2014-01-10T23:37:49Z", "is_private": false}, {"count": 13, "tags": [], "text": "Hi.  I am getting org.apache.poi.hssf.record.RecordFormatException: Unknown encryption info 4\nwhen opening up this the attached file test1.xls\n\nThe thing is, if I use Excel (the UI itself) I and supply the password, it will open.  Or, if I resave it using a DIFFERENT password in Excel, it will open.\n\nI am thinking this file (sent to me) was created by a non-Excel program, probably some other library.  But if Excel can open it, why can POI?  I am guessing it is an encryption type (what is type 4?)", "attachment_id": null, "bug_id": 35897, "id": 173836, "time": "2014-03-14T21:32:39Z", "creator": "nina.staats@gmail.com", "creation_time": "2014-03-14T21:32:39Z", "is_private": false}, {"count": 14, "tags": [], "creator": "nina.staats@gmail.com", "text": "Created attachment 31389\nfile will open in excel with password, just not in POI. encrypt type is unrecognized.\n\nthe password is \"freedom\"", "id": 173837, "time": "2014-03-14T21:37:12Z", "bug_id": 35897, "creation_time": "2014-03-14T21:37:12Z", "is_private": false, "attachment_id": 31389}, {"count": 15, "tags": [], "creator": "apache@gagravarr.org", "attachment_id": null, "id": 173844, "time": "2014-03-15T08:35:09Z", "bug_id": 35897, "creation_time": "2014-03-15T08:35:09Z", "is_private": false, "text": "You can look up the details of the FilePass record in http://msdn.microsoft.com/en-us/library/dd952596%28v=office.12%29.aspx at section 2.4.117 - FilePass\n\nThat says valid values for the encryption info are 0-3 only, and not 4!\n\nAny chance you could find out where the file came from, and what encryption they think they'd set on it?"}, {"count": 16, "tags": [], "text": "This could be a coincidence, but...\n\nhttp://msdn.microsoft.com/en-us/library/dd952596%28v=office.12%29.aspx\nSays the 0x0002 and 0x0003 values refer to\nRC4 CryptoAPI encryption header structure[MS-OFFCRYPTO], 2.3.5.1\n\nBut if you look that one up:\nhttp://msdn.microsoft.com/en-us/library/dd922755(v=office.12).aspx\nEncryptionVersionInfo (4 bytes): A Version structure (section 2.1.4) that specifies the encryption version used to create the document and the encryption version required to open the document. Version.vMajor MUST be 0x0002, 0x0003, or 0x0004<22>\n\nThe note says:\n\n<22> Section 2.3.5.1: Applications in the 2007 Office system earlier than Service Pack 2 set a Version.vMajor value of 0x0003. Versions with Service Pack 2 and Office 2010 set a Version.vMajor value of 0x004. Office 2003 applications set a Version.vMajor version of 0x0002.\n\nSo I guess it's just a newer format?", "is_private": false, "bug_id": 35897, "id": 173869, "time": "2014-03-17T11:43:25Z", "creator": "trejkaz@trypticon.org", "creation_time": "2014-03-17T11:43:25Z", "attachment_id": null}, {"count": 17, "tags": [], "creator": "apache@gagravarr.org", "attachment_id": null, "id": 173870, "time": "2014-03-17T11:49:03Z", "bug_id": 35897, "creation_time": "2014-03-17T11:49:03Z", "is_private": false, "text": "If we're able to create a file using Excel (any version) that generates the value of 4, then we can ask the Microsoft docs team to investigate and update the docs.\n\nThe OP has indicated that they think the latest problematic file (0x4) was generated by something other than Excel, in which case it isn't Microsoft's problem!\n\nSo, if someone is able to recreate a file with 0x4 using Excel please upload it + let us know!\n\n(For now, someone could try changing the if block to accept 2, 3 or 4, and see what happens...)"}, {"count": 18, "tags": [], "creator": "nina.staats@gmail.com", "text": "(In reply to Trejkaz (pen name) from comment #16)\n> This could be a coincidence, but...\n> \n> http://msdn.microsoft.com/en-us/library/dd952596%28v=office.12%29.aspx\n> Says the 0x0002 and 0x0003 values refer to\n> RC4 CryptoAPI encryption header structure[MS-OFFCRYPTO], 2.3.5.1\n> \n> But if you look that one up:\n> http://msdn.microsoft.com/en-us/library/dd922755(v=office.12).aspx\n> EncryptionVersionInfo (4 bytes): A Version structure (section 2.1.4) that\n> specifies the encryption version used to create the document and the\n> encryption version required to open the document. Version.vMajor MUST be\n> 0x0002, 0x0003, or 0x0004<22>\n> \n> The note says:\n> \n> <22> Section 2.3.5.1: Applications in the 2007 Office system earlier than\n> Service Pack 2 set a Version.vMajor value of 0x0003. Versions with Service\n> Pack 2 and Office 2010 set a Version.vMajor value of 0x004. Office 2003\n> applications set a Version.vMajor version of 0x0002.\n> \n> So I guess it's just a newer format?\n\nI am wondering as Trejkaz states, that this is just RC4 encryption, but it's a different version number, which gives us 4 instead of 0-3.  I will download POI source and see if I can just change that line of code - that type=4 just does RC4 decryption and see if that works.  Worth at shot.  If it does, I'll post it up here.", "id": 173872, "time": "2014-03-17T13:58:29Z", "bug_id": 35897, "creation_time": "2014-03-17T13:58:29Z", "is_private": false, "attachment_id": null}, {"count": 19, "tags": [], "text": "also, the funny thing about this file is, if I use Aspose.Cells for Java, it opens just fine. So apparently the dudes at Aspose know what to do with this encryption type=4, since THEIR library works.  (pooey!) Aspose costs $1000 and there is no way I can afford that. \n\nIt also opens in Excel just fine (the UI).  POI just doesn't open it. \n\nPOI serves all my needs, once the file is opened (like I resaved it unencrypted in Excel) I can read the entire file with POI perfectly.  It's just opening it when it's encrypted is the problem.", "attachment_id": null, "bug_id": 35897, "id": 173873, "time": "2014-03-17T14:04:39Z", "creator": "nina.staats@gmail.com", "creation_time": "2014-03-17T14:04:39Z", "is_private": false}, {"count": 20, "tags": [], "bug_id": 35897, "attachment_id": null, "is_private": false, "id": 173879, "time": "2014-03-17T18:05:11Z", "creator": "nina.staats@gmail.com", "creation_time": "2014-03-17T18:05:11Z", "text": "I just found out, they are using VBA's Workbook.SaveAs(...) where that method call takes in a password.  They are not setting any special encryption type.  So it's whatever VBA defaults it's encryption type to."}, {"count": 21, "tags": [], "creator": "apache@gagravarr.org", "attachment_id": null, "id": 173881, "time": "2014-03-17T18:54:18Z", "bug_id": 35897, "creation_time": "2014-03-17T18:54:18Z", "is_private": false, "text": "Any chance you could get a short self-contained block of VBA which when run creates a file with the problem? I can then forward that to the Microsoft docs team, and ask them to update [MS-XLS] to cover this case"}, {"count": 22, "tags": [], "bug_id": 35897, "attachment_id": null, "text": "(In reply to Nick Burch from comment #21)\n> Any chance you could get a short self-contained block of VBA which when run\n> creates a file with the problem? I can then forward that to the Microsoft\n> docs team, and ask them to update [MS-XLS] to cover this case\n\nso sorry, I cannot.  I was just told:\n\n\"They encrypt on our end using standard Microsoft Excel 2013 password protection (on the workbook level, saved as an excel 2003 file).  And if it helps, all workbooks are created with VBA using the Workbook.SaveAs method.  The default password is added at that point.  Nothing else such as coding is being done.\"\n\nIt is an external company sending me this file and I don't even have permission to TALK to their developers - just a mid level manager dude.  They will not send me code I am sure of it.", "id": 173889, "time": "2014-03-17T21:43:17Z", "creator": "nina.staats@gmail.com", "creation_time": "2014-03-17T21:43:17Z", "is_private": false}, {"count": 23, "tags": [], "creator": "nina.staats@gmail.com", "attachment_id": null, "id": 173890, "time": "2014-03-17T22:08:56Z", "bug_id": 35897, "creation_time": "2014-03-17T22:08:56Z", "is_private": false, "text": "Ok, I downloaded the POI source 3.10-FINAL and built it.  Made the change in FilePassRecord.java to do the _encryptionType=3 stuff if the type is actually 4.  Then I get  _minorVersionNo=2 instead of 1, which 1 is the only thing it supports.  So I change the code to do the same as _minorVersionNo=1 if I get a 2... and it doesn't decrypt.  I get a \"Supplied password is invalid for docId/saltData/saltHash\"\n\nThis is probably because the _saltData and _saltHash is somewhere else for this file type?  I dunno.  I will attached the new FilePassRecord.java and the code that reads the excel file (ExcelFileReader.java) which I wrote."}, {"count": 24, "tags": [], "text": "Created attachment 31398\nfile reader - java class to test reading of the test1.xls file\n\nthis is just the ExcelFileReader - a class the tries to read the previously attached test1.xls file.  Tries to read it using POI-3.10-FINAL version", "is_private": false, "bug_id": 35897, "id": 173891, "time": "2014-03-17T22:12:16Z", "creator": "nina.staats@gmail.com", "creation_time": "2014-03-17T22:12:16Z", "attachment_id": 31398}, {"count": 25, "tags": [], "creator": "nina.staats@gmail.com", "attachment_id": 31399, "id": 173892, "time": "2014-03-17T22:14:16Z", "bug_id": 35897, "creation_time": "2014-03-17T22:14:16Z", "is_private": false, "text": "Created attachment 31399\nThis is a POI file in org.apache.poi.hssf.record that attempts to do encrytionType=1 if we get a 4.\n\nThis is the modified file in the 3.10-FINAL source that:\n\n1. does a RC4 (3) if we get a 4.\n2. does a _minorVersionNo=1 when we get a _minorVersionNo=2 (treats them as the same)"}, {"text": "I've dropped the Microsoft docs team an email to ask about it, I'll report back when I hear from them. Since this does look to be something that new copies of Excel can generate, with any luck they'll be able to get the documentation updated to cover this new case, then we can update POI based on that to support it!", "tags": [], "bug_id": 35897, "attachment_id": null, "count": 26, "id": 173900, "time": "2014-03-18T15:06:17Z", "creator": "apache@gagravarr.org", "creation_time": "2014-03-18T15:06:17Z", "is_private": false}, {"count": 27, "tags": [], "creator": "nina.staats@gmail.com", "attachment_id": null, "id": 173914, "time": "2014-03-18T20:38:45Z", "bug_id": 35897, "creation_time": "2014-03-18T20:38:45Z", "is_private": false, "text": "Hey, I just found out that yes, they are using VBA to do this.  and the actual call is:\n\nWorkbook.SaveAs FileName:=strDir & strFileName, FileFormat:=xlExcel8, password:=\"freedom\"\n\n(password changed for opsec of course)\nthe strDir and strFileName are just the directory and filename that they write out my file.\n\nAt least now we know what the FileFormat is.  Hope that helps!\n\nYou dudes are awesome by the way - I never dreamed yall would be this responsive and quick to action!"}, {"count": 28, "tags": [], "bug_id": 35897, "attachment_id": null, "is_private": false, "id": 174679, "time": "2014-04-17T14:02:07Z", "creator": "apache@gagravarr.org", "creation_time": "2014-04-17T14:02:07Z", "text": "I've heard back from the Microsoft docs team:\n\n> Thank you for bringing this to our attention.  I have researched this with\nour Documentation product group, and they are planning to address this as a\nchange to the documentation in a future release of the document.\n\nNo ETA yet on that fix, but hopefully it'll get clarified reasonably soon, and we can then make the appropriate changes"}, {"count": 29, "tags": [], "bug_id": 35897, "attachment_id": null, "text": "*** Bug 56564 has been marked as a duplicate of this bug. ***", "id": 175457, "time": "2014-05-26T09:04:11Z", "creator": "apache@gagravarr.org", "creation_time": "2014-05-26T09:04:11Z", "is_private": false}, {"count": 30, "tags": [], "text": "If this helps, I managed to create an excel 97-03 file (.xls) with encryptionType = 4 by creating a new spreadsheet in Excel 2013, populating with some random data, password protecting it, and saving as \"Excel 97-03 (.xls)\". I can attach it if needed.\n\nAlso, I see that the documentation has been updated under this link:\n\nhttp://msdn.microsoft.com/en-us/library/dd952596%28v=office.12%29.aspx\n\nwhich reads that 0x2, 0x3 and 0x4 all indicate CryptoAPI headers.", "attachment_id": null, "bug_id": 35897, "id": 178878, "time": "2014-11-01T03:07:57Z", "creator": "koxta@koxta.net", "creation_time": "2014-11-01T03:07:57Z", "is_private": false}, {"count": 31, "tags": [], "creator": "apache@gagravarr.org", "attachment_id": null, "id": 178970, "time": "2014-11-04T23:24:07Z", "bug_id": 35897, "creation_time": "2014-11-04T23:24:07Z", "is_private": false, "text": "As it's now in the Microsoft docs, in r1636776 I have updated FilePassRecord to tread 4 the same as 2 & 3, along with adding a unit test for it.\n\nSince we can't currently handle the RC4 CryptoAPI encryption header structure, the test file with type 4 will trigger an EncryptedDocumentException, but at least it's cleaner"}, {"count": 32, "tags": [], "bug_id": 35897, "attachment_id": null, "text": "Based on FilePassRecord code,it appears that poi does NOT handle 2,3 or 4 (all of them are RC4 CryptoAPI encryption header structure). Any workarounds.\n\nAs an interesting aside, when I google around, I don't see anyone having reported the EncryptedDocumentException: HSSF does not currently support CryptoAPI encryption. Does that mean there are no documents out in real world there with 2 or 3?", "id": 179016, "time": "2014-11-10T03:18:31Z", "creator": "bearbalu@hotmail.com", "creation_time": "2014-11-10T03:18:31Z", "is_private": false}, {"count": 33, "tags": [], "creator": "bearbalu@hotmail.com", "attachment_id": null, "id": 179020, "time": "2014-11-10T06:22:13Z", "bug_id": 35897, "creation_time": "2014-11-10T06:22:13Z", "is_private": false, "text": "BTW, the Excel files i have are not password protected. There is worksheet level protection of certain cells. When I open the file in my Excel 2010 and resave it, the issue goes away. Presumably, it is some other configuration of Excel that creates these files?"}, {"count": 34, "tags": [], "text": "Created attachment 32208\n[PATCH] Support for \"Office Binary Document RC4 Encryption\" decryption\n\nThis is a patch for bearbalus files.\nCurrently I don't have shareable input files.\nSo I'll apply this, when I have the encryption code ready.", "is_private": false, "bug_id": 35897, "id": 179146, "time": "2014-11-16T22:20:17Z", "creator": "kiwiwings@apache.org", "creation_time": "2014-11-16T22:20:17Z", "attachment_id": 32208}, {"count": 35, "tags": [], "bug_id": 35897, "attachment_id": 32220, "text": "Created attachment 32220\n[PATCH] Support for \"Office Binary Document RC4 Encryption\"\n\nThis is a preview of the commit coming soon.\nThe generated files open successfully in Excel Viewer and Word Viewer.\nI'll probably add another few lines of javadocs in the final ...\n\nAndi.", "id": 179228, "time": "2014-11-22T02:00:53Z", "creator": "kiwiwings@apache.org", "creation_time": "2014-11-22T02:00:53Z", "is_private": false}, {"count": 36, "tags": [], "bug_id": 35897, "attachment_id": 32258, "text": "Created attachment 32258\n[PATCH] Support for \"Office Binary Document RC4 Encryption\" (read/write) and CryptoAPI for HSLF (read-only)\n\nThis is a combined patch for:\n- Office Binary Document RC4 Encryption (read/write)\n- HSLF CryptoAPI (read-only)\n\nI'll apply it after 3.11-final is out - maybe with write support for hslf cryptoapi\nBecause of bugzilla upload restriction, the test file need to be downloaded from http://blogs.msdn.com/b/openspecification/archive/2009/05/08/dominic-salemno.aspx", "id": 179495, "time": "2014-12-04T00:57:12Z", "creator": "kiwiwings@apache.org", "creation_time": "2014-12-04T00:57:12Z", "is_private": false}, {"count": 37, "tags": [], "bug_id": 35897, "attachment_id": null, "text": "As far as I see the latest patch from Andi is applied, so I am closing this as FIXED, please open new bugs for any remaining problems as this one has quite a long history and many changes were done to the code in the meantime.", "id": 188456, "time": "2016-02-15T21:08:07Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2016-02-15T21:08:07Z", "is_private": false}]