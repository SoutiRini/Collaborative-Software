[{"count": 0, "tags": [], "bug_id": 41717, "text": "Currently, tomcat does not support proper log rotation for\nthe standard output and error files produced when -outfile\nand -errfile are used at startup. The following patch\n1) upgrades jsvc-unix.c to support proper log rotation using SIGUSR1\n2) fixes a minor bug with arguments.c where the -procname argument\n   can't be used because it was added after the check for the end\n   of arguments\n3) someminor warnings due to missing or incorrect function declarations.\n\n===================== cut here =======================\ndiff -ru jsvc-src/native/arguments.c jsvc-src-logrotate/native/arguments.c\n--- jsvc-src/native/arguments.c 2005-05-17 06:13:39.000000000 -0700\n+++ jsvc-src-logrotate/native/arguments.c       2007-02-27 12:00:37.000000000 -0800\n@@ -186,16 +186,17 @@\n         } else if (strstr(argv[x],\"-ea\")==argv[x]) {\n             args->opts[args->onum++]=strdup(argv[x]);\n\n-        } else if (strstr(argv[x],\"-\")==argv[x]) {\n-            log_error(\"Invalid option %s\",argv[x]);\n-            return(NULL);\n-\n         } else if (strcmp(argv[x],\"-procname\") == 0) {\n             args->procname = optional(argc, argv, x++);\n             if(args->procname == NULL) {\n               log_error(\"Invalid process name specified\");\n               return (NULL);\n             }\n+\n+        } else if (strstr(argv[x],\"-\")==argv[x]) {\n+            log_error(\"Invalid option %s\",argv[x]);\n+            return(NULL);\n+\n         } else {\n             args->clas=strdup(argv[x]);\n             break;\n@@ -248,7 +249,6 @@\n     }\n\n     if (log_debug_flag==true) {\n-        char *temp;\n\n         log_debug(\"+-- DUMPING PARSED COMMAND LINE ARGUMENTS --------------\");\n\ndiff -ru jsvc-src/native/dso.h jsvc-src-logrotate/native/dso.h\n--- jsvc-src/native/dso.h       2005-05-17 06:13:39.000000000 -0700\n+++ jsvc-src-logrotate/native/dso.h     2007-02-27 10:52:18.000000000 -0800\n@@ -25,3 +25,4 @@\n dso_handle dso_link(const char *pth);\n bool dso_unlink(dso_handle lib);\n void *dso_symbol(dso_handle lib, const char *nam);\n+char *dso_error(void);\ndiff -ru jsvc-src/native/java.c jsvc-src-logrotate/native/java.c\n--- jsvc-src/native/java.c      2005-05-17 06:13:39.000000000 -0700\n+++ jsvc-src-logrotate/native/java.c    2007-02-27 10:53:55.000000000 -0800\n@@ -45,7 +45,7 @@\n     else main_shutdown();\n }\n /* Automaticly restart when the JVM crashes */\n-static void java_abort123()\n+static void java_abort123(void)\n {\n     exit(123);\n }\ndiff -ru jsvc-src/native/jsvc-unix.c jsvc-src-logrotate/native/jsvc-unix.c\n--- jsvc-src/native/jsvc-unix.c 2005-05-17 06:13:39.000000000 -0700\n+++ jsvc-src-logrotate/native/jsvc-unix.c       2007-02-27 14:34:01.000000000 -0800\n@@ -39,7 +39,9 @@\n static bool doreload=false;\n static void (*handler_int)(int)=NULL;\n static void (*handler_hup)(int)=NULL;\n+static void (*handler_usr1)(int)=NULL;\n static void (*handler_trm)(int)=NULL;\n+static void set_output(char *, char *, uid_t, gid_t);\n\n static void handler(int sig) {\n     switch (sig) {\n@@ -74,6 +76,12 @@\n             break;\n         }\n\n+        case SIGUSR1: {\n+            log_debug(\"Caught SIGUSR1: Reopening logs\");\n+            set_output(NULL,NULL,-1,-1);\n+            break;\n+        }\n+\n         default: {\n             log_debug(\"Caught unknown signal %d\",sig);\n             break;\n@@ -232,6 +240,9 @@\n #endif\n static void controller(int sig) {\n     switch (sig) {\n+        case SIGUSR1:\n+            log_debug(\"Reopening logs\");\n+            set_output(NULL,NULL,-1,-1);\n         case SIGTERM:\n         case SIGINT:\n         case SIGHUP:\n@@ -514,6 +525,7 @@\n\n     /* Install signal handlers */\n     handler_hup=signal_set(SIGHUP,handler);\n+    handler_usr1=signal_set(SIGUSR1,handler);\n     handler_trm=signal_set(SIGTERM,handler);\n     handler_int=signal_set(SIGINT,handler);\n     controlled = getpid();\n@@ -565,7 +577,25 @@\n /**\n  *  Redirect stdin, stdout, stderr.\n  */\n-static void set_output(char *outfile, char *errfile) {\n+static void set_output(char *outfile_arg, char *errfile_arg,\n+                       uid_t uid_arg, gid_t gid_arg) {\n+    static char *outfile=NULL;\n+    static char *errfile=NULL;\n+    static uid_t uid=0;\n+    static gid_t gid=0;\n+    if (outfile_arg!=NULL) {\n+      outfile=(char *)realloc((void *)outfile, strlen(outfile_arg)+1);\n+      strcpy(outfile,outfile_arg);\n+    }\n+    if (errfile_arg!=NULL) {\n+      errfile=(char *)realloc((void *)errfile, strlen(errfile_arg)+1);\n+      strcpy(errfile,errfile_arg);\n+    }\n+    if (uid_arg != -1)\n+      uid = uid_arg;\n+    if (gid_arg != -1)\n+      gid = gid_arg;\n+\n     freopen(\"/dev/null\", \"r\", stdin);\n     log_debug(\"redirecting stdout to %s and stderr to %s\",outfile,errfile);\n\n@@ -579,10 +609,12 @@\n     }\n     if(strcmp(outfile, \"&2\") != 0) {\n       loc_freopen(outfile, \"a\", stdout);\n+      chown(outfile,uid,gid);\n     }\n\n     if(strcmp(errfile,\"&1\") != 0) {\n       loc_freopen(errfile, \"a\", stderr);\n+      chown(errfile,uid,gid);\n     } else {\n       close(2);\n       dup(1);\n@@ -678,7 +710,7 @@\n #endif\n     }\n\n-    set_output(args->outfile, args->errfile);\n+    set_output(args->outfile, args->errfile,uid,gid);\n\n     /* We have to fork: this process will become the controller and the other\n        will be the child */\n@@ -693,6 +725,7 @@\n        SetTerm(cygwincontroller);\n #endif\n         signal(SIGHUP,controller);\n+        signal(SIGUSR1,controller);\n         signal(SIGTERM,controller);\n         signal(SIGINT,controller);", "id": 99865, "time": "2007-02-27T15:19:28Z", "creator": "mike@pictage.com", "creation_time": "2007-02-27T15:19:28Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 41717, "attachment_id": null, "text": "jsvc is not maintained by the Tomcat team. It is part of the Jakarta commons\ndaemon component.\n\nBugs can be reported at: http://issues.apache.org/jira/browse/DAEMON\n\nA quick look at the source shows at least one of your changes has already been\nmade. The best way forward would be to create a JIRA issue against DAEMON with\nan updated patch.\n\nI am marking this as invalid only because the component is wrong and there isn't\na way to transfer issues from bugzilla to Jira.", "id": 99872, "time": "2007-02-27T19:12:35Z", "creator": "markt@apache.org", "creation_time": "2007-02-27T19:12:35Z", "is_private": false}]