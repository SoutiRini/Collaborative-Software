[{"count": 0, "attachment_id": null, "bug_id": 28130, "text": "Hi all\n\nI am looking at the code of LineLayoutManager and TextLayoutManager, in order \nto see why text justification doesn't work, and I think I have found some \ninconsistencies (or maybe I am just misunderstanding the code).\n\nThe LineLayoutManager.makeLineBreak() method calculates two adjustment factors:\n- \"ipdAdjust\", defined \"stretch or shrink factor\" by a comment\n- \"dAdjust\", defined \"space adjustment\"; it is calculated only if text-\nalign=\"justify\"\nThey are both calculated using the \"actual\" width of the line (given by the \ninline objects) and the \"target\" width (the width that the line shall have); \nactual and target are MinOptMax objects.\n\nThe ipdAdjust factor, if I have not mistaken its role, should be used when the \nactual width has different .min, .opt and .max values (in simple situations \nthey are equal one another).\nEvery number y in the range [actual.min, actual.max] can be written as\n    y = actual.opt + (actual.opt - actual.min)*x\n        if actual.min <= y <= actual.opt, with -1 <= x <= 0\nor  y = actual.opt + (actual.max - actual.opt)*x\n        if actual.opt <= y <= actual.max, with  0 <= x <= 1\nIf target.opt is in the range [actual.min, actual.max], meaning that there is \na possible actual width perfectly filling the line , then ipdAdjust is its \ncorresponding \"x\" factor. Otherwise, the actual width is chosen which is \nnearest to target.opt: actual.min or actual.max.\n\nmaybe-error 1: it seems to me that there is an error in this part of the code \n(comments added where the supposed error is):\n\n  int targetWith = target.opt;\n  int realWidth = actual.opt;\n  if (actual.opt > targetWith) {\n      if (actual.opt - targetWith < (actual.opt - actual.min)) {\n          ipdAdjust = -(actual.opt - targetWith)\n                          / (float)(actual.opt - actual.min);\n          realWidth = targetWith;\n      } else {\n          ipdAdjust = -1;\n          realWidth = actual.max; /* <- error?*/\n          // targetWith is closer to actual.min than to actual.max\n          // and -1 corresponds to actual.min\n          //\n          // targetWith\n          //    |\n          // ---o-----------------------------------\n          //            ^     ^            ^\n          // actual.min |     | actual.opt | actual.max\n      }\n  } else {\n      if (targetWith - actual.opt < actual.max - actual.opt) {\n          ipdAdjust = (targetWith - actual.opt)\n                          / (float)(actual.max - actual.opt);\n          realWidth = targetWith;\n      } else {\n          ipdAdjust = 1;\n          realWidth = actual.min; /* <- error?*/\n          // targetWith is closer to actual.max than to actual.min\n          // and 1 corresponds to actual.max\n          //\n          //                             targetWith\n          //                                     |\n          // ------------------------------------o--\n          //            ^     ^            ^\n          // actual.min |     | actual.opt | actual.max\n\n      }\n  }\n\nmaybe-error 2: the dAdjust formula is now:\n  dAdjust = (targetWith - realWidth) / realWidth;\nand in my tests its value is always 0.0.\nAdding an explicit cast to float, the value is right:\n  dAdjust = (float)(targetWith - realWidth) / realWidth;\n\nThese adjustment factors are then stored in a LayoutContext object and given \nto the TextLayoutManager addAreas method, which should:\nI) re-compute the \"real\" width using the ipdAdjustment factor\nII) re-create the difference between real and target width using the \nspaceAdjustment factor\nIII) divide that difference by the number of spaces\n...\n\nmaybe-error 3: now, the TextLayoutManager uses only the space adjustment, and \nthe recreated difference (called iAdjust) differs from the original one.\n\nI'm going to attach:\n- a simple fo file with a justified block of text\n- a patch which simply adds a few System.err.println to the old code, to show \nthe computed adjustments and difference to fill\n- a patch with the proposed changes and System.err.println to show the newly \ncomputed adjustments\n\nAnyway, there must be something else that goes wrong, because the resulting \npdf is still not justified.\n\nBye\n    Luca", "id": 55065, "time": "2004-04-01T15:55:22Z", "creator": "lfurini@cs.unibo.it", "creation_time": "2004-04-01T15:55:22Z", "tags": [], "is_private": false}, {"attachment_id": 11083, "tags": [], "creator": "lfurini@cs.unibo.it", "text": "Created attachment 11083\nonly a block of justified text to see the calculated adjustments", "count": 1, "id": 55067, "time": "2004-04-01T15:57:16Z", "bug_id": 28130, "creation_time": "2004-04-01T15:57:16Z", "is_private": false}, {"attachment_id": 11084, "tags": [], "bug_id": 28130, "text": "Created attachment 11084\na few println in the old code to show the calculated adjustments", "count": 2, "id": 55068, "time": "2004-04-01T15:58:26Z", "creator": "lfurini@cs.unibo.it", "creation_time": "2004-04-01T15:58:26Z", "is_private": false}, {"count": 3, "tags": [], "creator": "lfurini@cs.unibo.it", "text": "Created attachment 11085\nproposed changes to the formulas and some println", "id": 55069, "attachment_id": 11085, "bug_id": 28130, "creation_time": "2004-04-01T15:59:26Z", "time": "2004-04-01T15:59:26Z", "is_private": false}, {"count": 4, "text": "Excellent work. Text justification is one of FOP development priorities. \nPriorities for layout work are defined here:\n\nhttp://xml.apache.org/fop/design/layout.html#status-todo\n\nI went through a similar thought process to you when I analysed the code in \nText and Line LMs. I'm taking a closer look at your patch now.\n\nI believe the reason why justification still doesnt work after correcting the \nissues you've found is because TextLM.addAreas doesnt create separate areas \nfor each word - it creates one big area in some cases for whole line, so there \nis no opportunity to add space adjust for justification.\n\nYour patch looks like it is the first piece of the puzzle to get Justification \nworking\n\n", "bug_id": 28130, "attachment_id": null, "id": 55137, "time": "2004-04-02T09:58:43Z", "creator": "bowditch_chris@hotmail.com", "creation_time": "2004-04-02T09:58:43Z", "tags": [], "is_private": false}, {"count": 5, "tags": [], "creator": "bowditch_chris@hotmail.com", "text": "Patch applied, many thanks.", "id": 55140, "time": "2004-04-02T10:40:05Z", "bug_id": 28130, "creation_time": "2004-04-02T10:40:05Z", "is_private": false, "attachment_id": null}, {"count": 6, "attachment_id": null, "bug_id": 28130, "text": "Hi again\n\nI have tried to make PDFRenderer use the adjustment factor without splitting \nthe text in different areas, and it seems it now works (except when \nhyphenation is done, but that's another bug).\nOnly a quick note: as the pdf operator controlling space adjust (Tw) can take \na float, space adjustment could be stored as double instead of casting it into \nan int.\n\nI am going to attach the suggested patch.\n\nBye\n    Luca", "id": 55311, "time": "2004-04-05T13:54:08Z", "creator": "lfurini@cs.unibo.it", "creation_time": "2004-04-05T13:54:08Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "creator": "lfurini@cs.unibo.it", "text": "Created attachment 11134\npatch to pdf renderer, so that it uses the adjustment factor", "id": 55312, "time": "2004-04-05T13:56:18Z", "bug_id": 28130, "creation_time": "2004-04-05T13:56:18Z", "is_private": false, "attachment_id": 11134}, {"count": 8, "tags": [], "text": "Hi Luca,\n\nthanks for your new suggested patch. Since this bug is closed I have created a \nnew bug for your new patch.\n\nhttp://issues.apache.org/bugzilla/show_bug.cgi?id=28208", "attachment_id": null, "id": 55318, "creator": "bowditch_chris@hotmail.com", "time": "2004-04-05T14:07:11Z", "bug_id": 28130, "creation_time": "2004-04-05T14:07:11Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 28130, "text": "batch transition pre-FOP1.0 resolved+fixed bugs to closed+fixed", "id": 156226, "time": "2012-04-01T07:05:44Z", "creator": "gadams@apache.org", "creation_time": "2012-04-01T07:05:44Z", "is_private": false, "attachment_id": null}]