[{"count": 0, "tags": [], "creator": "darron.wood@fmr.com", "attachment_id": null, "is_private": false, "id": 54244, "time": "2004-03-18T22:22:31Z", "bug_id": 27791, "creation_time": "2004-03-18T22:22:31Z", "text": "It looks like mod_cache isn't discarding expired content in cache.  I increased \nthe LogLevel to debug and below is what I see in the log file when the content \nis expired in cache.  It appears that mod_cache sees it is expired, then goes \nto revalidate the content from the application server but never caches the new \nversion. If I run snoop on my Apache Reverse Proxy server while the content is \nexpired in cache I see the request go to the application server when it is \nrequested and the copy in cache never gets updated and the expiration date is \nnot reset.\n\n\n[Thu Mar 18 11:16:14 2004] [info] disk_cache: Serving Cached URL \nserver.com/infocenter/images/file.gif?\n[Thu Mar 18 11:16:14 2004] [info] disk_cache: Served headers for URL \nserver.com/infocenter/images/file.gif?\n[Thu Mar 18 11:16:14 2004] [debug] mod_cache.c(259): cache: stale cache - test \nconditional\n[Thu Mar 18 11:16:14 2004] [debug] mod_cache.c(263): cache: conditional - add \ncache_in filter and DECLINE\n[Thu Mar 18 11:16:14 2004] [debug] proxy_http.c(109): proxy: HTTP: \ncanonicalising URL //serverx.com:8100/infocenter/images/file.gif\n[Thu Mar 18 11:16:14 2004] [debug] mod_proxy.c(459): Trying to run \nscheme_handler\n[Thu Mar 18 11:16:14 2004] [debug] proxy_http.c(1076): proxy: HTTP: serving URL \nhttp://serverx.com:8100/infocenter/images/file.gif\n[Thu Mar 18 11:16:14 2004] [debug] proxy_http.c(221): proxy: HTTP connecting \nhttp://serverx.com:8100/infocenter/images/file.gif to serverx.com:8100\n[Thu Mar 18 11:16:14 2004] [debug] proxy_util.c(1203): proxy: HTTP: fam 2 \nsocket created to connect to serverx.com\n[Thu Mar 18 11:16:14 2004] [debug] proxy_http.c(370): proxy: socket is connected\n[Thu Mar 18 11:16:14 2004] [debug] proxy_http.c(404): proxy: connection \ncomplete to xx.xx.xxx.xx:8100 (serverx.com)\n[Thu Mar 18 11:16:14 2004] [debug] proxy_http.c(979): proxy: header only\n[Thu Mar 18 11:16:14 2004] [debug] mod_cache.c(436): cache: running CACHE_IN \nfilter"}, {"count": 1, "tags": [], "bug_id": 27791, "text": "I just tested this in 2.0.49 and the same issue exists in this version also.  \nI'm updating this bug to reflect that it also exists in 2.0.49.", "id": 55456, "time": "2004-04-07T14:21:01Z", "creator": "darron.wood@fmr.com", "creation_time": "2004-04-07T14:21:01Z", "is_private": false, "attachment_id": null}, {"count": 2, "attachment_id": 11169, "creator": "darron.wood@fmr.com", "is_private": false, "id": 55462, "time": "2004-04-07T15:09:00Z", "bug_id": 27791, "creation_time": "2004-04-07T15:09:00Z", "tags": [], "text": "Created attachment 11169\nmodified mod_cache.c file that is delivered with 2.0.49"}, {"count": 3, "attachment_id": 11170, "creator": "darron.wood@fmr.com", "text": "Created attachment 11170\nmodified mod_disk_cache.c file that is delivered with 2.0.49", "id": 55463, "time": "2004-04-07T15:11:08Z", "bug_id": 27791, "creation_time": "2004-04-07T15:11:08Z", "tags": [], "is_private": false}, {"count": 4, "attachment_id": null, "creator": "darron.wood@fmr.com", "text": "I modified the mod_cache.c and mod_disk_cache.c files that are delievered with \n2.0.49 and caching appears to be working now.  I've attached the modified \nmod_cache.c and mod_disk_cache.c files from 2.0.49 to this bug.  Could someone \ncheck out the changes I made and see if those are OK?", "id": 55465, "time": "2004-04-07T15:14:25Z", "bug_id": 27791, "creation_time": "2004-04-07T15:14:25Z", "tags": [], "is_private": false}, {"count": 5, "attachment_id": 11176, "creator": "darron.wood@fmr.com", "is_private": false, "id": 55489, "time": "2004-04-07T18:49:53Z", "bug_id": 27791, "creation_time": "2004-04-07T18:49:53Z", "tags": [], "text": "Created attachment 11176\nPatch for mod_disk_cache.c"}, {"count": 6, "tags": [], "text": "Created attachment 11177\nPatch for mod_cache.c", "is_private": false, "bug_id": 27791, "id": 55492, "time": "2004-04-07T18:50:34Z", "creator": "darron.wood@fmr.com", "creation_time": "2004-04-07T18:50:34Z", "attachment_id": 11177}, {"count": 7, "tags": [], "creator": "darron.wood@fmr.com", "attachment_id": null, "text": "Attached diff output for both mod_cache.c and mod_disk_cache.c.", "id": 55494, "time": "2004-04-07T18:52:17Z", "bug_id": 27791, "creation_time": "2004-04-07T18:52:17Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 27791, "text": "I have installed the patches provided in this PR on Apache 2.0.49 and done \nextensive load testing. As far as I can tell, the cache now behaves correctly \n(both mem_cache and disk_cache). Expired files are updated. Thanks Darron, for \nproviding the fixes.", "id": 58794, "time": "2004-06-05T14:35:33Z", "creator": "asmorgrav@yahoo.no", "creation_time": "2004-06-05T14:35:33Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 27791, "text": "I may have rejoyced a little to quickly there...\n\nThe problem was mostly fixed by the patch provided. Unfortunately, there seems \nto be another problem.\n\nOn a reverse proxy, centuri, we have both disk cache and mem cache activated. \nThe memory cache activated first and is only supposed to cache elements of size \nsmaller than 10,000 bytes. The disk cache takes care of anything not cached by \nthe memory cache.\n\nSomehow, at one point a file of size smaller than 10,000 bytes ends up being \ncached by the disk cache. Don't ask me why (maybe the mem cache was filled up \nand the element ended up on disk?) - it's beyond the point. Eventually, the \nfile in disk cache ends up stale. At than point, when the element (style.css) \nis requested, the disk cache responds that it is stale and a proxy request is \nissued to the backend server. The fresh element ends up being cached in memory, \nand the stale entry remains in the disk cache...\n\nThe logs below should clearly show what happens. mod_disk_cache does not appear \nto log the element as stale, but I know that the disk cache contains a stale \ncopy of styles.css because I looked it up. Removing the element from the disk \ncache also removes the symptoms.\n\nPlease find below the log trace of two requests for the same element style.css \non the reverse proxy centuri:3080. The backend server is backend:7010. The two \nrequests are separated by some CRs.\n\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(66): proxy: HTTP: \ncanonicalising URL //centuri:3080/html/styles.css\n[Mon Jun 07 08:48:57 2004] [debug] mod_proxy.c(416): Trying to run \nscheme_handler\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(1042): proxy: HTTP: serving URL \nhttp://centuri:3080/html/styles.css\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(178): proxy: HTTP connecting \nhttp://centuri:3080/html/styles.css to centuri.gsi.fr:3080\n[Mon Jun 07 08:48:57 2004] [debug] proxy_util.c(1160): proxy: HTTP: fam 2 \nsocket created to connect to centuri\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(327): proxy: socket is connected\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(361): proxy: connection \ncomplete to 150.175.10.189:3080 (centuri)\n[Mon Jun 07 08:48:57 2004] [debug] mod_cache.c(344): cache: stale cache - test \nconditional\n[Mon Jun 07 08:48:57 2004] [debug] mod_cache.c(391): cache: nonconditional - no \ncached etag/lastmods - add cache_in and DECLINE\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(66): proxy: HTTP: \ncanonicalising URL //backend:7010/html/styles.css\n[Mon Jun 07 08:48:57 2004] [debug] mod_proxy.c(416): Trying to run \nscheme_handler\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(1042): proxy: HTTP: serving URL \nhttp://backend:7010/html/styles.css\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(178): proxy: HTTP connecting \nhttp://backend:7010/html/styles.css to backend:7010\n[Mon Jun 07 08:48:57 2004] [debug] proxy_util.c(1160): proxy: HTTP: fam 2 \nsocket created to connect to backend\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(327): proxy: socket is connected\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(361): proxy: connection \ncomplete to backend:7010 (backend)\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(877): proxy: start body send\n[Mon Jun 07 08:48:57 2004] [debug] mod_cache.c(532): cache: running CACHE_IN \nfilter\n[Mon Jun 07 08:48:57 2004] [debug] mod_cache.c(790): cache: Caching \nurl: /html/styles.css\n[Mon Jun 07 08:48:57 2004] [info] mem_cache: Cached url: \ncenturi/html/styles.css?\n[Mon Jun 07 08:48:57 2004] [debug] mod_headers.c(521): headers: \nap_headers_output_filter()\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(936): proxy: end body send\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(877): proxy: start body send\n[Mon Jun 07 08:48:57 2004] [debug] mod_headers.c(521): headers: \nap_headers_output_filter()\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(936): proxy: end body send\n\n\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(66): proxy: HTTP: \ncanonicalising URL //centuri:3080/html/styles.css\n[Mon Jun 07 08:48:57 2004] [debug] mod_proxy.c(416): Trying to run \nscheme_handler\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(1042): proxy: HTTP: serving URL \nhttp://centuri:3080/html/styles.css\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(178): proxy: HTTP connecting \nhttp://centuri:3080/html/styles.css to centuri.gsi.fr:3080\n[Mon Jun 07 08:48:57 2004] [debug] proxy_util.c(1160): proxy: HTTP: fam 2 \nsocket created to connect to centuri\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(327): proxy: socket is connected\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(361): proxy: connection \ncomplete to 150.175.10.189:3080 (centuri)\n[Mon Jun 07 08:48:57 2004] [debug] mod_cache.c(344): cache: stale cache - test \nconditional\n[Mon Jun 07 08:48:57 2004] [debug] mod_cache.c(391): cache: nonconditional - no \ncached etag/lastmods - add cache_in and DECLINE\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(66): proxy: HTTP: \ncanonicalising URL //backend:7010/html/styles.css\n[Mon Jun 07 08:48:57 2004] [debug] mod_proxy.c(416): Trying to run \nscheme_handler\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(1042): proxy: HTTP: serving URL \nhttp://backend:7010/html/styles.css\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(178): proxy: HTTP connecting \nhttp://backend:7010/html/styles.css to backend:7010\n[Mon Jun 07 08:48:57 2004] [debug] proxy_util.c(1160): proxy: HTTP: fam 2 \nsocket created to connect to backend\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(327): proxy: socket is connected\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(361): proxy: connection \ncomplete to backend:7010 (backend)\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(877): proxy: start body send\n[Mon Jun 07 08:48:57 2004] [debug] mod_cache.c(532): cache: running CACHE_IN \nfilter\n[Mon Jun 07 08:48:57 2004] [debug] mod_cache.c(790): cache: Caching \nurl: /html/styles.css\n[Mon Jun 07 08:48:57 2004] [info] mem_cache: Cached url: \ncenturi/html/styles.css?\n[Mon Jun 07 08:48:57 2004] [debug] mod_headers.c(521): headers: \nap_headers_output_filter()\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(936): proxy: end body send\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(877): proxy: start body send\n[Mon Jun 07 08:48:57 2004] [debug] mod_headers.c(521): headers: \nap_headers_output_filter()\n[Mon Jun 07 08:48:57 2004] [debug] proxy_http.c(936): proxy: end body send\n\n\nAnd the cache configuration:\n\n            MCacheMaxObjectSize 10000\n            MCacheSize          70000\n            CacheEnable         mem /\n\n            CacheRoot           /apache/cache\n            CacheSize           150000\n            CacheEnable         disk /\n\n", "id": 58850, "time": "2004-06-07T17:20:04Z", "creator": "asmorgrav@yahoo.no", "creation_time": "2004-06-07T17:20:04Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "creator": "bjorn@exoweb.net", "attachment_id": null, "is_private": false, "id": 61168, "time": "2004-07-27T04:00:50Z", "bug_id": 27791, "creation_time": "2004-07-27T04:00:50Z", "text": "If this bug only affects you when you have both disk and mem cache enabled, I\nsay we should apply the patches above and make a new bug request for the\nmem+disk cacheing bug."}, {"count": 11, "tags": [], "bug_id": 27791, "text": "I agree. I'll create a new bug report. Should the status of the present be \nchanged to FIXED?", "id": 61229, "time": "2004-07-28T14:19:06Z", "creator": "asmorgrav@yahoo.no", "creation_time": "2004-07-28T14:19:06Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 27791, "text": "This may also fix 30278. So I mark 30278 dependent on this bug.", "id": 62120, "time": "2004-08-18T11:56:47Z", "creator": "ruediger.pluem@vodafone.com", "creation_time": "2004-08-18T11:56:47Z", "is_private": false, "attachment_id": null}, {"count": 13, "attachment_id": null, "creator": "asmorgrav@yahoo.no", "is_private": false, "id": 65889, "time": "2004-10-28T09:34:58Z", "bug_id": 27791, "creation_time": "2004-10-28T09:34:58Z", "tags": [], "text": "I just tested Apache 2.0.52. It seems to me like this problem does not exist in \nthat version."}, {"count": 14, "tags": [], "creator": "frederic.leger@i-bp.banquepopulaire.fr", "attachment_id": null, "text": "Seems to still present in 2.0.52 on win32", "id": 70307, "time": "2005-02-01T17:54:15Z", "bug_id": 27791, "creation_time": "2005-02-01T17:54:15Z", "is_private": false}, {"count": 15, "tags": [], "creator": "chip@force-elite.com", "attachment_id": null, "is_private": false, "id": 75918, "time": "2005-06-03T03:25:20Z", "bug_id": 27791, "creation_time": "2005-06-03T03:25:20Z", "text": "Can you test on 2.0.54?"}, {"count": 16, "tags": [], "creator": "tyamadajp@list.rakugaki.org", "attachment_id": null, "is_private": false, "id": 89778, "time": "2006-06-05T14:57:55Z", "bug_id": 27791, "creation_time": "2006-06-05T14:57:55Z", "text": "I'm having similar issue with both 2.0.55 and SVN snapshot. It seems Apache \nfails to re-cache cachable content when mod_mem_cache is used (it doesn't \nhappen with mod_cache + mod_disk_cache).\n\nI have posted report of my investigation to 30370 (I didn't notice this report \nexisted when I posted) - does it explain the issue? Though patch isn't \navailable yet, I was able to fix the issue with the workaround I described in \nthe posting.\n\n- http://issues.apache.org/bugzilla/show_bug.cgi?id=30370\n"}, {"count": 17, "attachment_id": null, "creator": "terry@permeance.com.au", "text": "I recommend downloading 2.0.59 because older versions seem to be incomplete and \nnot production-ready. \n\nIf you a forced to run an older version of httpd then you can try compiling the \n2.0.59 source code and just using the mod_cache.so and mod_disk_cache.so files:\n\n./configure --prefix=/tmp/httpd-2.0.59 --enable-cache=shared --enable-disk-\ncache=shared --enable-mem-cache=shared \nmake \nmake install \n\nWe are running 2.0.52 httpd with 2.0.59 mod_cache without any problems...", "id": 105920, "time": "2007-07-24T18:53:40Z", "bug_id": 27791, "creation_time": "2007-07-24T18:53:40Z", "tags": [], "is_private": false}]