[{"count": 0, "tags": [], "bug_id": 32848, "attachment_id": null, "text": "SSLv3 draft (5.6.4) and RFC2246 (7.4.4) describe the capability to provide a\nlist a CA distinguished names for defining a desired authorization space. This\nis currently not possible with mod_ssl.\n\nEven though OpenSSL SSL contexts have both a certificate store for client\nauthentication and a stack of CA names for the CertificateRequest handshake\nmessage, they are both created from the same set of certificates. This is ok\nwhen the list of trusted roots is also the issuer of the client certificates.\n\nPROBLEM\n=======\nWhen the trusted roots issue subordinate (intermediate) CA certificates which in\nturn issue end entity certificates, there is the possibility that some and not\nall of the intermediate CA certificates are acceptable for the trusted root.\nHowever, if the trusted root is used for the CertificateRequest handshake\nmessage, all of its intermediate CA's are acceptable. Of course, if the trusted\nroot is left out, the certificate chain cannot be verified.\n\nFIX\n===\nSeparate and independent control of the CertificateRequest handshake message.\nCurrently, the SSLCACertificateFile and SSLCACertificatePath are used to both\ndefine the trust list for client authentication and create the list of CA\ndistinguished names for the CertificateRequest message. By adding a new\ndirective to mod_ssl (SSLCADNRequestPath, SSLCADNRequestFile) that, only when\npresent, will specifically define the set of certificates to derive the\nclient_CA distinguished names in the exact same way as SSLCACertificate*. In\nthis case SSLCACertificate* will only define the trust list. When not present,\nSSLCACertificate* does double duty as normal. This makes the fix downwardly\ncompatible with existing SSL configurations.\n\nPATCH\n=====\ndiff -ru httpd-2.0.52-pristine/modules/ssl/mod_ssl.c\nhttpd-2.0.52-patch3/modules/ssl/mod_ssl.c\n--- httpd-2.0.52-pristine/modules/ssl/mod_ssl.c\tMon Aug 23 10:18:54 2004\n+++ httpd-2.0.52-patch3/modules/ssl/mod_ssl.c\tTue Dec 14 11:27:21 2004\n@@ -111,10 +111,16 @@\n                 \"(`/path/to/file' - PEM encoded)\")\n     SSL_CMD_ALL(CACertificatePath, TAKE1,\n                 \"SSL CA Certificate path \"\n-                \"(`/path/to/dir' - contains PEM encoded files)\")\n+                \"(`/path/to/dir' - contains PEM encoded files for client\nauthentication)\")\n     SSL_CMD_ALL(CACertificateFile, TAKE1,\n                 \"SSL CA Certificate file \"\n-                \"(`/path/to/file' - PEM encoded)\")\n+                \"(`/path/to/file' - PEM encoded for client authentication)\")\n+    SSL_CMD_ALL(CADNRequestPath, TAKE1,\n+                \"SSL CA Distinguished Name path \"\n+                \"(`/path/to/dir' - symlink hashes to PEM of acceptable CA names\nto request)\")\n+    SSL_CMD_ALL(CADNRequestFile, TAKE1,\n+                \"SSL CA Distinguished Name file \"\n+                \"(`/path/to/file' - PEM encoded to derive acceptable CA names\nto request)\")\n     SSL_CMD_SRV(CARevocationPath, TAKE1,\n                 \"SSL CA Certificate Revocation List (CRL) path \"\n                 \"(`/path/to/dir' - contains PEM encoded files)\")\n================================================================================================\ndiff -ru httpd-2.0.52-pristine/modules/ssl/mod_ssl.h\nhttpd-2.0.52-patch3/modules/ssl/mod_ssl.h\n--- httpd-2.0.52-pristine/modules/ssl/mod_ssl.h\tFri Aug 27 04:03:24 2004\n+++ httpd-2.0.52-patch3/modules/ssl/mod_ssl.h\tTue Dec 14 11:27:26 2004\n@@ -442,6 +442,20 @@\n     const char  *ca_cert_path;\n     const char  *ca_cert_file;\n \n+    /*\n+     * Acceptable CA names for certificateRequest message. (RFC2246) \n+     * These two were added to support specifying a CA name\n+     * list that may or may not include a self-signed root CA.\n+     * This allows the ability to create a limited authorization\n+     * space given the (possible) growth of complex trust hierarchies.\n+     *\n+     * For backward compatibility, if SSLCADNRequest* is not specified\n+     * the default behavior of using SSLCACertificate* for both trust\n+     * and certificateRequest (client_CA list) will occur.\n+     */\n+    const char  *ca_name_path;\n+    const char  *ca_name_file;\n+\n     const char  *cipher_suite;\n \n     /* for client or downstream server authentication */\n@@ -502,6 +516,8 @@\n     int           nVerifyDepth;\n     const char   *szCACertificatePath;\n     const char   *szCACertificateFile;\n+    const char   *szCADNRequestPath;\n+    const char   *szCADNRequestFile;\n     const char   *szUserName;\n } SSLDirConfigRec;\n \n@@ -534,6 +550,8 @@\n const char  *ssl_cmd_SSLCertificateChainFile(cmd_parms *, void *, const char *);\n const char  *ssl_cmd_SSLCACertificatePath(cmd_parms *, void *, const char *);\n const char  *ssl_cmd_SSLCACertificateFile(cmd_parms *, void *, const char *);\n+const char  *ssl_cmd_SSLCADNRequestPath(cmd_parms *, void *, const char *);\n+const char  *ssl_cmd_SSLCADNRequestFile(cmd_parms *, void *, const char *);\n const char  *ssl_cmd_SSLCARevocationPath(cmd_parms *, void *, const char *);\n const char  *ssl_cmd_SSLCARevocationFile(cmd_parms *, void *, const char *);\n const char  *ssl_cmd_SSLVerifyClient(cmd_parms *, void *, const char *);\n================================================================================================\ndiff -ru httpd-2.0.52-pristine/modules/ssl/ssl_engine_config.c\nhttpd-2.0.52-patch3/modules/ssl/ssl_engine_config.c\n--- httpd-2.0.52-pristine/modules/ssl/ssl_engine_config.c\tMon Aug 23 10:18:54 2004\n+++ httpd-2.0.52-patch3/modules/ssl/ssl_engine_config.c\tTue Dec 14 11:27:47 2004\n@@ -122,6 +122,8 @@\n \n     mctx->auth.ca_cert_path   = NULL;\n     mctx->auth.ca_cert_file   = NULL;\n+    mctx->auth.ca_name_path   = NULL; /* added to support separate control */\n+    mctx->auth.ca_name_file   = NULL; /* of certificate request message.   */\n     mctx->auth.cipher_suite   = NULL;\n     mctx->auth.verify_depth   = UNSET;\n     mctx->auth.verify_mode    = SSL_CVERIFY_UNSET;\n@@ -217,6 +219,8 @@\n \n     cfgMergeString(auth.ca_cert_path);\n     cfgMergeString(auth.ca_cert_file);\n+    cfgMergeString(auth.ca_name_path);\n+    cfgMergeString(auth.ca_name_file);\n     cfgMergeString(auth.cipher_suite);\n     cfgMergeInt(auth.verify_depth);\n     cfgMerge(auth.verify_mode, SSL_CVERIFY_UNSET);\n@@ -286,6 +290,8 @@\n \n     dc->szCACertificatePath    = NULL;\n     dc->szCACertificateFile    = NULL;\n+    dc->szCADNRequestPath      = NULL;\n+    dc->szCADNRequestFile      = NULL;\n     dc->szUserName             = NULL;\n \n     return dc;\n@@ -323,6 +329,8 @@\n \n     cfgMergeString(szCACertificatePath);\n     cfgMergeString(szCACertificateFile);\n+    cfgMergeString(szCADNRequestPath);\n+    cfgMergeString(szCADNRequestFile);\n     cfgMergeString(szUserName);\n \n     return mrg;\n@@ -825,6 +833,32 @@\n     sc->server->auth.ca_cert_file = arg;\n \n     return NULL;\n+}\n+\n+const char *ssl_cmd_SSLCADNRequestPath(cmd_parms *cmd, void *dcfg, const char\n*arg) {\n+    SSLSrvConfigRec *sc = mySrvConfig(cmd->server);\n+    const char *err;\n+\n+    if ((err = ssl_cmd_check_dir(cmd, &arg))) {\n+        return err;\n+    }\n+\n+    sc->server->auth.ca_name_path = arg;\n+\n+    return NULL;\n+}\n+\n+const char *ssl_cmd_SSLCADNRequestFile(cmd_parms *cmd, void *dcfg, const char\n*arg) {\n+    SSLSrvConfigRec *sc = mySrvConfig(cmd->server);\n+    const char *err;\n+\n+    if ((err = ssl_cmd_check_file(cmd, &arg))) {\n+        return err;\n+    }\n+\n+    sc->server->auth.ca_name_file = arg;\n+\n+    return NULL;\n }\n \n const char *ssl_cmd_SSLCARevocationPath(cmd_parms *cmd,\n================================================================================================\ndiff -ru httpd-2.0.52-pristine/modules/ssl/ssl_engine_init.c\nhttpd-2.0.52-patch3/modules/ssl/ssl_engine_init.c\n--- httpd-2.0.52-pristine/modules/ssl/ssl_engine_init.c\tMon Jun  7 05:18:37 2004\n+++ httpd-2.0.52-patch3/modules/ssl/ssl_engine_init.c\tThu Dec  9 19:04:04 2004\n@@ -532,12 +532,20 @@\n             ssl_die();\n         }\n \n-        ca_list = ssl_init_FindCAList(s, ptemp,\n+\tif (mctx->auth.ca_name_file || mctx->auth.ca_name_path) {\n+\t    ap_log_error(APLOG_MARK, APLOG_DEBUG, 0, s,\n+\t\t      \"Configuring certificateRequest message\");\n+\n+            ca_list = ssl_init_FindCAList(s, ptemp,\n+                                      mctx->auth.ca_name_file,\n+                                      mctx->auth.ca_name_path);\n+\t} else\n+            ca_list = ssl_init_FindCAList(s, ptemp,\n                                       mctx->auth.ca_cert_file,\n                                       mctx->auth.ca_cert_path);\n         if (!ca_list) {\n             ap_log_error(APLOG_MARK, APLOG_ERR, 0, s,\n-                    \"Unable to determine list of available \"\n+                    \"Unable to determine list of acceptable \"\n                     \"CA certificates for client authentication\");\n             ssl_die();\n         }\n@@ -556,7 +564,7 @@\n             ap_log_error(APLOG_MARK, APLOG_WARNING, 0, s,\n                          \"Init: Oops, you want to request client \"\n                          \"authentication, but no CAs are known for \"\n-                         \"verification!?  [Hint: SSLCACertificate*]\");\n+                         \"verification!?  [Hint: SSLCACertificate*,\nSSLCADNRequest*]\");\n         }\n     }\n }\n@@ -1123,7 +1131,7 @@\n \n         if ((rv = apr_dir_open(&dir, ca_path, ptemp)) != APR_SUCCESS) {\n             ap_log_error(APLOG_MARK, APLOG_ERR, rv, s,\n-                    \"Failed to open SSLCACertificatePath `%s'\",\n+                    \"Failed to open Certificate Path `%s'\",\n                     ca_path);\n             ssl_die();\n         }\n================================================================================================\ndiff -ru httpd-2.0.52-pristine/modules/ssl/ssl_engine_kernel.c\nhttpd-2.0.52-patch3/modules/ssl/ssl_engine_kernel.c\n--- httpd-2.0.52-pristine/modules/ssl/ssl_engine_kernel.c\tMon Aug 23 10:18:55 2004\n+++ httpd-2.0.52-patch3/modules/ssl/ssl_engine_kernel.c\tThu Dec  9 19:04:04 2004\n@@ -470,11 +470,22 @@\n         /* SSL_free will free cert_store */\n         SSL_set_cert_store(ssl, cert_store);\n \n-        if (!(ca_list = ssl_init_FindCAList(r->server, r->pool,\n-                                            ca_file, ca_path)))\n+\t/*\n+\t * If no per-dir CADNRequest* is defined, the per-dir\n+\t * CACertificate* takes on its default double-duty.\n+\t */\n+        if (MODSSL_CFG_NE(szCADNRequestFile) ||\n+            MODSSL_CFG_NE(szCADNRequestPath))\n         {\n+            ca_file = MODSSL_CFG_CA(szCADNRequestFile);\n+            ca_path = MODSSL_CFG_CA(szCADNRequestPath);\n+\t}\n+\n+        if (!(ca_list = ssl_init_FindCAList(r->server, r->pool, \n+                                           ca_file, ca_path)))\n+        {\n             ap_log_error(APLOG_MARK, APLOG_ERR, 0, r->server,\n-                         \"Unable to determine list of available \"\n+                         \"Unable to determine list of acceptable \"\n                          \"CA certificates for client authentication\");\n \n             return HTTP_FORBIDDEN;", "id": 69013, "time": "2004-12-27T16:57:12Z", "creator": "tim.taylor@dfas.mil", "creation_time": "2004-12-27T16:57:12Z", "is_private": false}, {"count": 1, "tags": [], "creator": "jorton@redhat.com", "is_private": false, "text": "Thanks for the submission. A trimmed-down version of this patch has been\ncommitted to the trunk for future httpd 2.1/2.2 releases.\n\nhttp://svn.apache.org/viewcvs?view=rev&rev=125165 [viewcvs currently accessible]\n\nDid you have a docs update for this too, BTW?\n", "id": 69680, "time": "2005-01-14T15:02:39Z", "bug_id": 32848, "creation_time": "2005-01-14T15:02:39Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "tim.taylor@dfas.mil", "text": "I had not done the doc but I can certainly do so. I assume that when I am done,\nthat I should attach here as was done with the code.", "id": 69805, "time": "2005-01-18T16:31:56Z", "bug_id": 32848, "creation_time": "2005-01-18T16:31:56Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "text": "That or just send it to docs@httpd.apache.org; ideally as a diff against the XML\nsource.  If it's hassle then just sending in some unformatted text would be great.", "attachment_id": null, "id": 69807, "creator": "jorton@redhat.com", "time": "2005-01-18T16:43:22Z", "bug_id": 32848, "creation_time": "2005-01-18T16:43:22Z", "is_private": false}, {"count": 4, "tags": [], "creator": "tim.taylor@dfas.mil", "text": "Created attachment 14160\ndocumentation patch to mod_ssl.xml", "id": 70417, "time": "2005-02-02T22:31:33Z", "bug_id": 32848, "creation_time": "2005-02-02T22:31:33Z", "is_private": false, "attachment_id": 14160}]