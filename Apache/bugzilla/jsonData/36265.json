[{"count": 0, "tags": [], "bug_id": 36265, "attachment_id": null, "id": 78675, "time": "2005-08-18T23:23:13Z", "creator": "sb48109@yahoo.com", "creation_time": "2005-08-18T23:23:13Z", "is_private": false, "text": "This happens with DB2 version 8.1, and the 8.1 db2jdbc drivers (from IBM I believe).\n\nWhen executing a file with simple sql create table commands, I got:\nCreateTables:\n     [echo] Creating tables for user **** in\njdbc:db2://database:50000/user:deferPrepares=false;\ndriver=com.ibm.db2.jcc.DB2Driver \n      [sql] Executing file: creates.sql\n      [sql] Failed to execute:   CREATE TABLE ACCRUAL_RULE ( ACCRUAL_RULE      \n                      VARCHAR( 80)  )\n\nBUILD FAILED\nbuild.xml:2963: com.ibm.db2.jcc.b.SQLException: A result has opened by the\nprevious getResultSet() or getUpdateCount() call, Need to call getMoreResults()\n\nHere is the stack trace of the exception:\n\tat com.ibm.db2.jcc.b.ce.getResultSet(ce.java:491)\n\tat org.apache.tools.ant.taskdefs.SQLExec.execSQL(SQLExec.java:501)\n\tat org.apache.tools.ant.taskdefs.SQLExec.runStatements(SQLExec.java:470)\n\tat\norg.apache.tools.ant.taskdefs.SQLExec$Transaction.runTransaction(SQLExec.java:664)\n\nIt appears that the implementation of the sql task does not follow closely the\njdbc spec; according to\nhttp://java.sun.com/j2se/1.4.2/docs/api/java/sql/Statement.html#execute(java.lang.String),\nexecute() returns whether a ResultSet is available (and getMoreResults() is\nsimilar).\n\nTherefore one should not call getResultSet() when execute() or hasMoreResult()\nhas returned false. Similarly, calling getUpdateCount() when execute() or\ngetMoreResults() returned true does not make sense. With the modification below,\nwhich I believe follows these rules, the problem went away.\n\nIn SQLExec, I replaced:\n\n====== BEGIN EXISTING CODE\n\n            ret = statement.execute(sql);\n            updateCount = statement.getUpdateCount();\n            resultSet = statement.getResultSet();\n            do {\n                if (!ret) {\n                    if (updateCount != -1) {\n                        updateCountTotal += updateCount;\n                    }\n                } else {\n                    if (print) {\n                        printResults(resultSet, out);\n                    }\n                }\n                ret = statement.getMoreResults();\n                if (ret) {\n                    updateCount = statement.getUpdateCount();\n                    resultSet = statement.getResultSet();\n                }\n            } while (ret);\n\n====================  BEGIN REPLACEMENT CODE\n            boolean ret;\n            int updateCount = 0, updateCountTotal = 0;\n\n            ret = statement.execute(sql);\n            do {\n                if (!ret) {\n                    updateCount = statement.getUpdateCount();\n                    if (updateCount != -1) {\n                        updateCountTotal += updateCount;\n                    }\n                } else {\n                    resultSet = statement.getResultSet();\n                    if (print) {\n                        printResults(resultSet, out);\n                    }\n                }\n                ret = statement.getMoreResults();\n            } while (ret);\n\n==================== END REPLACEMENT CODE"}, {"count": 1, "tags": [], "creator": "bodewig@apache.org", "text": "svn rev 675909", "id": 118549, "time": "2008-07-11T03:32:03Z", "bug_id": 36265, "creation_time": "2008-07-11T03:32:03Z", "is_private": false, "attachment_id": null}]