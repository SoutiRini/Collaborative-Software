[{"count": 0, "tags": [], "text": "I have a CometProcessor servlet which sends responses via the OutputStream and I see a lot of these errors.\n\njava.lang.NullPointerException\n\tat org.apache.coyote.http11.InternalNioOutputBuffer.addToBB(InternalNioOutputBuffer.java:217)\n\tat org.apache.coyote.http11.InternalNioOutputBuffer.commit(InternalNioOutputBuffer.java:209)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.action(AbstractHttp11Processor.java:757)\n\tat org.apache.coyote.Response.action(Response.java:170)\n\tat org.apache.coyote.Response.sendHeaders(Response.java:350)\n\tat org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:330)\n\tat org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:306)\n\tat org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:101)\n\tat com.enaikoon.inviu.api.AjaxServlet$AjaxEventSender.sendAjaxEvents(AjaxServlet.java:471)\n\tat com.enaikoon.inviu.api.AjaxServlet$AjaxEventSender.run(AjaxServlet.java:409)\n\tat java.lang.Thread.run(Thread.java:680)\n\nThe relevant code is this:\n\n\nfinal ObjectNode data = buildAjaxEvents(lastId, ajaxEvents);\nfinal byte[] buf = data.toString().getBytes(\"UTF-8\");\n\n// connection contains the CometEvent and the \n// request and respons objects from the BEGIN \n// event\nfinal HttpServletResponse response = connection.response;\nresponse.setStatus(200);\nresponse.setContentType(\"application/json\");\nresponse.setCharacterEncoding(\"UTF-8\");\nresponse.setContentLength(buf.length);\nresponse.addHeader(\"X-inviu-server\", VERSION);\nOutputStream os = response.getOutputStream();\ntry {\n    if (buf.length > 0) {\n        os.write(buf);\n        os.flush();  // <-- LOTS OF NPEs\n    }\n    log.debug(\"AJAX-SEND: %s\", data);\n} catch (NullPointerException ex) {\n    log.error(\"AJAX-SEND: NPE while sending\");\n    ex.printStackTrace();\n}\n\nDoes that ring a bell?", "is_private": false, "bug_id": 52611, "id": 153512, "time": "2012-02-06T21:46:45Z", "creator": "frank.schroeder@gmail.com", "creation_time": "2012-02-06T21:46:45Z", "attachment_id": null}, {"count": 1, "attachment_id": null, "bug_id": 52611, "is_private": false, "id": 153513, "time": "2012-02-06T21:54:29Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2012-02-06T21:54:29Z", "tags": [], "text": "(In reply to comment #0)\n> Does that ring a bell?\n\nNo.\n\nWithout seeing the full picture a little can be said. (Or you can search the mailing list archives if you are curious if anyone have encountered this).\n\nIf it is indeed a bug, please prepare and attach a working example that reproduces the issue.\n\nAlso read about RECYCLE_FACADES property in the docs. That is to exclude obvious multithreading programing errors.\n\n\nIf you just want help, ask on the users@ mailing list. Bugzilla is a wrong place for questions."}, {"count": 2, "tags": [], "text": "The NPE is triggered by the socket being null which only happens after the output buffer has been recycled. That suggests the response object is being retained and used after it is no longer valid.\n\nThe odds are that this is an application bug so please follow up on the users mailing list. If the conclusion of that discussion is that there is a Tomcat biug here then fell free to re-open this issue and provide the exact details of how to reproduce it and/or a detailed explanation of why there is a bug.", "is_private": false, "bug_id": 52611, "id": 153542, "time": "2012-02-07T09:58:18Z", "creator": "markt@apache.org", "creation_time": "2012-02-07T09:58:18Z", "attachment_id": null}]