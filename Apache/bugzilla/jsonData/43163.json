[{"count": 0, "tags": [], "bug_id": 43163, "attachment_id": null, "text": "It is possible to produce locked documents (checked out documents /\nsitetree.xml) when using the workflow overview with a single user:\n\nprocedure to reproduce the error:\n- login with alice\n- import example content\n- click on authoring in site tab\n- click on workflow overview\n\nperform various operations - and with a good chance you get into a situation\nwhere the usecase cannot be executed. I'm sorry for the fuzzy statements here;\nI'm trying to find out when exactly the error occurs - seems not so easy to\ntrack this down to a defined procedure.\n\nYou get (either for the sitetree (as shown here) or for documents):\n\nException during commit or rollback:\norg.apache.lenya.cms.repository.RepositoryException: The node [node\nlenya://lenya/pubs/default/content/live/sitetree.xml] is already checked out by\nanother session! (see logfiles for details)\n\nA wild guess: The workflow overview makes it possible to fire a new request\nbefore the previous request is finished. This results in a new thread and for\neach thread a new session. These sessions can block one another (????)", "id": 106895, "time": "2007-08-19T04:48:01Z", "creator": "ragaller@apache.org", "creation_time": "2007-08-19T04:48:01Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 43163, "attachment_id": null, "text": "(In reply to comment #0)\n\n> A wild guess: The workflow overview makes it possible to fire a new request\n> before the previous request is finished. This results in a new thread and for\n> each thread a new session. These sessions can block one another (????)\n\nYes, I think this is the case. Unfortunately I don't see how this can be\nchanged. In a multi-threaded environment which allows to modify the same\nresources by different threads you'll always run into locking issues. Did you\nend up with a corrupted repository? Otherwise I'd say this is a limitation of\nthe architecture and we can't do anything about it in the short term.", "id": 107218, "time": "2007-08-24T04:09:02Z", "creator": "andreas@apache.org", "creation_time": "2007-08-24T04:09:02Z", "is_private": false}, {"count": 2, "tags": [], "creator": "andreas@apache.org", "text": "BTW, to improve the situation for the user we could add some javascript magic\nthat disables all submit buttons as soon as one is clicked. This will at least\nprevent the user from firing multiple simultaneous requests.", "id": 107219, "time": "2007-08-24T04:11:20Z", "bug_id": 43163, "creation_time": "2007-08-24T04:11:20Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 43163, "is_private": false, "count": 3, "id": 107223, "time": "2007-08-24T05:40:19Z", "creator": "ragaller@apache.org", "creation_time": "2007-08-24T05:40:19Z", "text": "(In reply to comment #1)\n\n> Yes, I think this is the case. Unfortunately I don't see how this can be\n> changed. In a multi-threaded environment which allows to modify the same\n> resources by different threads you'll always run into locking issues. Did you\n> end up with a corrupted repository?\n\nmmh - not really corrupted, but hard to unlock in a way that it can be used\nagain. The \u00abforce checkin\u00bb is not sufficient to recover.\n\n(In reply to comment #2)\nYour javascript proposal sounds good to me; it will calm down the fast clickers\n(including myself ;-)) and preserves the nice overview."}, {"count": 4, "tags": [], "bug_id": 43163, "attachment_id": null, "text": "(In reply to comment #3)\n>> Did you end up with a corrupted repository?\n> \n> mmh - not really corrupted, but hard to unlock in a way that it can be used\n> again. The \u00abforce checkin\u00bb is not sufficient to recover.\n\nStrange, the nodes should actually not be checked out in this case. It would be\nnice to have a web/jmeter test to reproduce the error ...", "id": 107226, "time": "2007-08-24T07:32:14Z", "creator": "andreas@apache.org", "creation_time": "2007-08-24T07:32:14Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 43163, "is_private": false, "id": 107375, "creation_time": "2007-08-29T04:32:52Z", "time": "2007-08-29T04:32:52Z", "creator": "andreas@apache.org", "text": "(In reply to comment #4)\n> (In reply to comment #3)\n> >> Did you end up with a corrupted repository?\n> > \n> > mmh - not really corrupted, but hard to unlock in a way that it can be used\n> > again. The \u00abforce checkin\u00bb is not sufficient to recover.\n> \n> Strange, the nodes should actually not be checked out in this case. It would be\n> nice to have a web/jmeter test to reproduce the error ...\n\nI could reproduce the problem.\n\nI moved the check-in to the finally block (rev. 570759), so at least the stale\nchecked-out nodes shouldn't occur anymore. I'll investigate further how the\nexception is caused.", "attachment_id": null}, {"count": 6, "tags": [], "creator": "andreas@apache.org", "text": "Interesting - it always seems to occur with the live sitetree. And the check-out\nis quite old, so it doesn't seem to be a concurrency problem:\n\nSocketListener0-8 ERROR core.manager - Start 39e5dfd0-5624-11dc-b16d-b864c1ac5dc2\nSocketListener0-8 ERROR core.manager - End   39e5dfd0-5624-11dc-b16d-b864c1ac5dc2\nSocketListener0-8 ERROR core.manager - Start 39e14bf0-5624-11dc-b16d-b864c1ac5dc2\nSocketListener0-8 ERROR core.manager - End   39e14bf0-5624-11dc-b16d-b864c1ac5dc2\nSocketListener0-8 ERROR core.manager - Start 3c4be350-5624-11dc-b16d-b864c1ac5dc2\nSocketListener0-8 ERROR core.manager - End   3c4be350-5624-11dc-b16d-b864c1ac5dc2\nSocketListener0-8 ERROR core.manager - Start 3c472860-5624-11dc-b16d-b864c1ac5dc2\nSocketListener0-8 ERROR core.manager - End   3c472860-5624-11dc-b16d-b864c1ac5dc2\nSocketListener0-9 ERROR core.manager - Start 3c9d5eb0-5624-11dc-b16d-b864c1ac5dc2\nSocketListener0-9 ERROR core.manager - End   3c9d5eb0-5624-11dc-b16d-b864c1ac5dc2\nSocketListener0-9 ERROR core.manager - Start 3c98f1e0-5624-11dc-b16d-b864c1ac5dc2\nSocketListener0-9 ERROR core.manager - End   3c98f1e0-5624-11dc-b16d-b864c1ac5dc2\nSocketListener0-9 ERROR core.manager - Start 3e2229f0-5624-11dc-b16d-b864c1ac5dc2\nSocketListener0-9 ERROR usecases.workflow - Could not commit/rollback usecase\n[workflow.publish]: \norg.apache.lenya.cms.repository.RepositoryException:\norg.apache.lenya.cms.repository.RepositoryException: The node [node\nlenya://lenya/pubs/default/content/live/dbb138d0-561c-11dc-8807-d3d4bfbc35be/de]\nis already checked out by session [39555fa0-5624-11dc-b16d-b864c1ac5dc2]\n(current time: 1188387457776)!", "id": 107376, "time": "2007-08-29T04:40:18Z", "bug_id": 43163, "creation_time": "2007-08-29T04:40:18Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 43163, "is_private": false, "id": 107379, "creation_time": "2007-08-29T04:47:09Z", "time": "2007-08-29T04:47:09Z", "creator": "andreas@apache.org", "text": "The live sitetree is apparently not in the identity map and therefore not\nchecked in properly.", "attachment_id": null}, {"count": 8, "tags": [], "creator": "andreas@apache.org", "text": "(In reply to comment #6)\n> Interesting - it always seems to occur with the live sitetree.\n\nNo, document nodes are also affected.", "id": 107382, "time": "2007-08-29T05:03:09Z", "bug_id": 43163, "creation_time": "2007-08-29T05:03:09Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "creator": "andreas@apache.org", "text": "I have the feeling that this issue is related to the removal of the live nodes\nduring deactivation.", "id": 107384, "time": "2007-08-29T05:05:49Z", "bug_id": 43163, "creation_time": "2007-08-29T05:05:49Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "creator": "andreas@apache.org", "attachment_id": null, "id": 107385, "time": "2007-08-29T05:10:41Z", "bug_id": 43163, "creation_time": "2007-08-29T05:10:41Z", "is_private": false, "text": "The entry list is not emptied in SourceNodeRCML.delete() ..."}, {"count": 11, "tags": [], "bug_id": 43163, "attachment_id": null, "text": "(In reply to comment #10)\n> The entry list is not emptied in SourceNodeRCML.delete() ...\n\nThat seemed to be the cause. The problem was that the last check-out entry was\nstill active, even though the RCML has been removed. The issue should be\nresolved in revision 570775.", "id": 107386, "time": "2007-08-29T05:17:06Z", "creator": "andreas@apache.org", "creation_time": "2007-08-29T05:17:06Z", "is_private": false}]