[{"count": 0, "tags": [], "bug_id": 61251, "text": "Created attachment 35097\nXWPF OOM bug\n\nHi guys\n\nI have a OOM when opening one particular docx file. \n\nPOI Versions I tried:\n3.15\n3.16\n3.17-beta1\n\nThe code is simple:\n\n        InputStream in = new FileInputStream(new File(path));\n        XWPFDocument document = new XWPFDocument(in);\n\nException details:\n\njava.lang.OutOfMemoryError: GC overhead limit exceeded\n\tat org.apache.xerces.dom.DeferredDocumentImpl.getNodeObject(Unknown Source)\n\tat org.apache.xerces.dom.DeferredElementNSImpl.synchronizeData(Unknown Source)\n\tat org.apache.xerces.dom.ElementNSImpl.getNamespaceURI(Unknown Source)\n\tat org.apache.xmlbeans.impl.store.Locale.loadNode(Locale.java:1420)\n\tat org.apache.xmlbeans.impl.store.Locale.loadNodeChildren(Locale.java:1403)\n\tat org.apache.xmlbeans.impl.store.Locale.loadNode(Locale.java:1445)\n\tat org.apache.xmlbeans.impl.store.Locale.loadNodeChildren(Locale.java:1403)\n\tat org.apache.xmlbeans.impl.store.Locale.loadNode(Locale.java:1445)\n\tat org.apache.xmlbeans.impl.store.Locale.loadNodeChildren(Locale.java:1403)\n\tat org.apache.xmlbeans.impl.store.Locale.loadNode(Locale.java:1445)\n\tat org.apache.xmlbeans.impl.store.Locale.loadNodeChildren(Locale.java:1403)\n\tat org.apache.xmlbeans.impl.store.Locale.loadNode(Locale.java:1445)\n\tat org.apache.xmlbeans.impl.store.Locale.loadNodeChildren(Locale.java:1403)\n\tat org.apache.xmlbeans.impl.store.Locale.loadNode(Locale.java:1445)\n\tat org.apache.xmlbeans.impl.store.Locale.loadNodeChildren(Locale.java:1403)\n\tat org.apache.xmlbeans.impl.store.Locale.loadNode(Locale.java:1445)\n\tat org.apache.xmlbeans.impl.store.Locale.parseToXmlObject(Locale.java:1385)\n\tat org.apache.xmlbeans.impl.store.Locale.parseToXmlObject(Locale.java:1370)\n\tat org.apache.xmlbeans.impl.schema.SchemaTypeLoaderBase.parse(SchemaTypeLoaderBase.java:370)\n\tat org.apache.poi.POIXMLTypeLoader.parse(POIXMLTypeLoader.java:144)\n\tat org.openxmlformats.schemas.wordprocessingml.x2006.main.DocumentDocument$Factory.parse(Unknown Source)\n\tat org.apache.poi.xwpf.usermodel.XWPFDocument.onDocumentRead(XWPFDocument.java:152)\n\tat org.apache.poi.POIXMLDocument.load(POIXMLDocument.java:190)\n\tat org.apache.poi.xwpf.usermodel.XWPFDocument.<init>(XWPFDocument.java:119)", "id": 199576, "time": "2017-07-05T14:16:52Z", "creator": "bsevryukov@gmail.com", "creation_time": "2017-07-05T14:16:52Z", "is_private": false, "attachment_id": 35097}, {"count": 1, "tags": [], "bug_id": 61251, "attachment_id": null, "text": "Thank you for opening this issue.\n\nDo you want to modify the document, or are you only interested in text/metadata extraction?  If extraction only, I added a SAX parser in Apache Tika, which is far more efficient than our DOM parser.", "id": 199577, "time": "2017-07-05T14:29:24Z", "creator": "tallison@mitre.org", "creation_time": "2017-07-05T14:29:24Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 61251, "text": "I think POI uses more memory if you use the InputStream constructors.\nCould you try creating an OPCPackage based on the File?\nhttps://poi.apache.org/apidocs/org/apache/poi/openxml4j/opc/OPCPackage.html\nAnd then create the XWPFDocument based on the OPCPackage?", "count": 2, "id": 199578, "time": "2017-07-05T14:31:31Z", "creator": "fanningpj@yahoo.com", "creation_time": "2017-07-05T14:31:31Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 61251, "text": "Y, agreed, PJ.  I'm not having any trouble parsing this with Tika and our usual DOM parser even with -Xmx128m, and we use the OPCPackage from the file.  I am able to replicate with -Xmx64m.", "count": 3, "id": 199579, "time": "2017-07-05T14:37:32Z", "creator": "tallison@mitre.org", "creation_time": "2017-07-05T14:37:32Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 61251, "attachment_id": null, "text": "Still getting OOM with\n\nfinal OPCPackage in = OPCPackage.open(new File(path));\nXWPFDocument document = new XWPFDocument(in);\n\nAm I doing it right?", "id": 199580, "time": "2017-07-05T14:44:44Z", "creator": "bsevryukov@gmail.com", "creation_time": "2017-07-05T14:44:44Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 61251, "attachment_id": null, "text": "@bsevryukov your code is correct.\nAs Tim highlights, it seems that you need to increase your Xmx setting.\nThe approach using OPCPackage will use less memory but XWPFDocument is not based on streaming the document - so the larger the docx, the more memory XWPFDocument needs.", "id": 199581, "time": "2017-07-05T14:50:28Z", "creator": "fanningpj@yahoo.com", "creation_time": "2017-07-05T14:50:28Z", "is_private": false}, {"count": 6, "attachment_id": null, "creator": "bsevryukov@gmail.com", "text": "Thanks PJ. Increasing Xmx size helped. \n\nThank you guys for the fast response.", "id": 199582, "time": "2017-07-05T14:55:12Z", "bug_id": 61251, "creation_time": "2017-07-05T14:55:12Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "creator": "dominik.stadler@gmx.at", "attachment_id": null, "text": "Fixed based on latest comment.", "id": 199595, "time": "2017-07-05T20:56:28Z", "bug_id": 61251, "creation_time": "2017-07-05T20:56:28Z", "is_private": false}]