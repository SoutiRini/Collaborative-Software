[{"count": 0, "tags": [], "bug_id": 57173, "text": "Created attachment 32176\ncomplete console output\n\nAfter updating Tomcat from version 7.0.54 to 7.0.56 the following exception occurs during startup:\n---------------------------------------\n...\nOkt 30, 2014 2:00:45 PM org.apache.catalina.startup.ContextConfig processAnnotationsJar\nSEVERE: Unable to process Jar entry [com/ctc/wstx/api/ReaderConfig.class] from Jar [jar:jndi:/localhost/ssms-gui/WEB-INF/lib/woodstox-core-asl-4.1.2.jar!/] for annotations\njava.io.EOFException\n        at org.apache.tomcat.util.bcel.classfile.FastDataInputStream.readUnsignedShort(FastDataInputStream.java:120)\n        at org.apache.tomcat.util.bcel.classfile.Utility.swallowFieldOrMethod(Utility.java:75)\n        at org.apache.tomcat.util.bcel.classfile.ClassParser.readMethods(ClassParser.java:235)\n        at org.apache.tomcat.util.bcel.classfile.ClassParser.parse(ClassParser.java:92)\n        at org.apache.catalina.startup.ContextConfig.processAnnotationsStream(ContextConfig.java:2071)\n        at org.apache.catalina.startup.ContextConfig.processAnnotationsJar(ContextConfig.java:1947)\n        at org.apache.catalina.startup.ContextConfig.processAnnotationsUrl(ContextConfig.java:1913)\n        at org.apache.catalina.startup.ContextConfig.processAnnotations(ContextConfig.java:1898)\n        at org.apache.catalina.startup.ContextConfig.webConfig(ContextConfig.java:1330)\n        at org.apache.catalina.startup.ContextConfig.configureStart(ContextConfig.java:889)\n        at org.apache.catalina.startup.ContextConfig.lifecycleEvent(ContextConfig.java:386)\n        at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:117)\n        at org.apache.catalina.util.LifecycleBase.fireLifecycleEvent(LifecycleBase.java:90)\n        at org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:5380)\n        at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:150)\n        at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:901)\n        at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:877)\n        at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:649)\n        at org.apache.catalina.startup.HostConfig.deployWAR(HostConfig.java:1083)\n        at org.apache.catalina.startup.HostConfig$DeployWar.run(HostConfig.java:1879)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source)\n        at java.util.concurrent.FutureTask$Sync.innerRun(Unknown Source)\n        at java.util.concurrent.FutureTask.run(Unknown Source)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\n        at java.lang.Thread.run(Unknown Source)\n...\n---------------------------------------\n\nThis exception occurs for several JAR files and did not happen with tomcat 7.0.54. Complete console output attached.", "id": 178869, "time": "2014-10-31T12:30:26Z", "creator": "peter.sammer@kobil.com", "creation_time": "2014-10-31T12:30:26Z", "is_private": false, "attachment_id": 32176}, {"count": 1, "tags": [], "bug_id": 57173, "text": "1. Is this issue reproducible or just happened once?\n\n2. Please verify that your copy of woodstox-core-asl-4.1.2.jar is a correct one, not truncated or otherwise tampered with.\n\nI am unable to reproduce any issues with my copy of the library.\nIt has size 478\u00a0935 bytes, md5 ba7562cc58d6652e7d8e6095ad6e2940, sha1 b8df430ddc4947bc7b68af5ed09b8c1c5b527553.\n\n(There is a testcase org.apache.tomcat.util.bcel.TesterPerformance that performs parsing of all classes in a Jar. I also tried to put the library into a web application.)\n\n3. A library can be excluded from annotation scanning. See\nhttps://wiki.apache.org/tomcat/HowTo/FasterStartUp", "id": 178881, "time": "2014-11-01T11:40:41Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-11-01T11:40:41Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 57173, "text": "What is the version of Java runtime that you are using?\n(So that one could actually reproduce the issue)\n\n\nThoughts:\n1) FastDataInputStream.fillNew() shall check that this.in.read() is not -1.\n\n2) FastDataInputStream.readUnsignedShort() expects that fillNew() call will read at least 2 bytes, but read() can actually return after reading 1 byte (I think it may depend on internal implementation of zip inflater thus my question on the version of Java that OP is using), so some looping is needed like in FastDataInputStream.readFully(..)/skipBytes().\n\nThere is also a question of whether FastDataInputStream with such changes remains faster than the original DataInputStream.", "id": 178903, "time": "2014-11-02T18:47:05Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-11-02T18:47:05Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 57173, "attachment_id": null, "text": "To your questions:\n> 1. Is this issue reproducible or just happened once?\n\nIt is reproducible with every startup of tomcat.\n\n\n> 2. Please verify that your copy of woodstox-core-asl-4.1.2.jar is a correct one, not truncated or otherwise tampered with.\n> I am unable to reproduce any issues with my copy of the library.\n> It has size 478 935 bytes, md5 ba7562cc58d6652e7d8e6095ad6e2940, sha1 b8df430ddc4947bc7b68af5ed09b8c1c5b527553.\n> (There is a testcase org.apache.tomcat.util.bcel.TesterPerformance that performs parsing of all classes in a Jar. I also tried to put the library into a web application.)\n\nI double checked the file. It is the correct one. Attached you can find a copy of my JAR (zipped).\n\n\n> 3. A library can be excluded from annotation scanning. See\n> https://wiki.apache.org/tomcat/HowTo/FasterStartUp\n\nThank you, but I was aware of that. It would be OK for the \"woodstox\" library, but not for the \"trinidad-impl-2.1.1-ks1.jar\" which is also failing.\n\n\n> What is the version of Java runtime that you are using?\n> (So that one could actually reproduce the issue)\n\nWe are currently using a rather old JVM:\njava version \"1.7.0_25\"\nJava(TM) SE Runtime Environment (build 1.7.0_25-b17)\nJava HotSpot(TM) 64-Bit Server VM (build 23.25-b01, mixed mode)\n\nIs there any difference, if I would use a newer one?", "id": 178907, "time": "2014-11-03T07:17:16Z", "creator": "peter.sammer@kobil.com", "creation_time": "2014-11-03T07:17:16Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 57173, "attachment_id": 32181, "text": "Created attachment 32181\nwoodstox JAR of my installation", "id": 178908, "time": "2014-11-03T07:18:20Z", "creator": "peter.sammer@kobil.com", "creation_time": "2014-11-03T07:18:20Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 57173, "text": "I tried with a newer JVM, but got the same exceptions:\n-----\njava version \"1.7.0_72\"\nJava(TM) SE Runtime Environment (build 1.7.0_72-b14)\nJava HotSpot(TM) 64-Bit Server VM (build 24.72-b04, mixed mode)", "id": 178909, "time": "2014-11-03T07:35:54Z", "creator": "peter.sammer@kobil.com", "creation_time": "2014-11-03T07:35:54Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "creator": "violetagg@apache.org", "is_private": false, "text": "I can reproduce the issue:\n\n\nSEVERE: Unable to process Jar entry [ch/qos/logback/core/status/Status.class] from Jar [jar:jndi:/localhost/no-manifest/WEB-INF/lib/com.springsource.ch.qos.logback.core-0.9.18.jar!/] for annotations\njava.io.EOFException\n\tat org.apache.tomcat.util.bcel.classfile.FastDataInputStream.readInt(FastDataInputStream.java:145)\n\tat org.apache.tomcat.util.bcel.classfile.ClassParser.readID(ClassParser.java:200)\n\n\nSetup:\n- tomcat 7.0.56 with default settings\n- only unpackWARs is set to false\n\n      <Host name=\"localhost\"  appBase=\"webapps\"\n            unpackWARs=\"false\" autoDeploy=\"true\">\n\n\nIf unpackWARs is set to true there are no problems.\n\nThe problem does not appear in 7.0.55 and appear in 7.0.56 and tc7.0.x.", "id": 178920, "time": "2014-11-03T18:26:50Z", "bug_id": 57173, "creation_time": "2014-11-03T18:26:50Z", "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 57173, "text": "In my installation unpackWARs is also set to false:\n\n<Host appBase=\"webapps\" autoDeploy=\"false\" name=\"localhost\" unpackWARs=\"false\">", "id": 178936, "time": "2014-11-04T07:12:23Z", "creator": "peter.sammer@kobil.com", "creation_time": "2014-11-04T07:12:23Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 57173, "text": "In our Tomcat-7.0.56 installation we're experiencing the same annotations-check problem. I've tried to set unpackWar to true but that doesn't seem to be the problem in our case. \nAlthough we're getting these exceptions our applications don't seem to have any trouble with it.", "id": 178989, "time": "2014-11-06T09:27:06Z", "creator": "auke.poortman@anachron.com", "creation_time": "2014-11-06T09:27:06Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 57173, "attachment_id": 32195, "text": "Created attachment 32195\n2014-11-08_tc8_57173_test_v1.patch\n\nModification of TesterPerformance test that uses an InputStream that reads only one byte at each read() call.", "id": 179003, "time": "2014-11-08T01:17:21Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-11-08T01:17:21Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 57173, "text": "Created attachment 32196\n2014-11-08_tc8_57173_test_v2.patch\n\nModification of TesterPerformance test that uses an InputStream that reads a random count of bytes on each read() call. The count of bytes ranges from 1 up to requested length.", "id": 179004, "time": "2014-11-08T01:18:36Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-11-08T01:18:36Z", "is_private": false, "attachment_id": 32196}, {"count": 11, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "text": "Steps to run the tests:\n1. Apply patch (attachment 32195 or attachment 32196)\n2. Put some jars into /tmp/jira-libs\n3. Run org.apache.tomcat.util.bcel.TesterPerformance test\n\nWith patch 1 the test fails in readInt() call when reading the signature of the class file. With patch 2 the test fails randomly in some read[Int,UnsignedInt] etc. method.\n\nThus FastDataInputStream is broken.", "id": 179005, "time": "2014-11-08T01:26:38Z", "bug_id": 57173, "creation_time": "2014-11-08T01:26:38Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 57173, "attachment_id": null, "text": "Fixed in trunk by r1637501.\nI disabled mark() method, as I see that the current implementation of fillNew() method is not compatible with it. It does not take into account the marker position.\n\nIn my test with trunk and JDK 8u25 the \"FastDataInputStream\" is faster by 2%. That is not much of a difference. Reverting r1625504 is an option.", "id": 179006, "time": "2014-11-08T02:12:09Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-11-08T02:12:09Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 57173, "attachment_id": null, "id": 179253, "time": "2014-11-24T12:59:20Z", "creator": "markt@apache.org", "creation_time": "2014-11-24T12:59:20Z", "is_private": false, "text": "*** Bug 57251 has been marked as a duplicate of this bug. ***"}, {"count": 14, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 179280, "time": "2014-11-25T15:25:46Z", "bug_id": 57173, "creation_time": "2014-11-25T15:25:46Z", "text": "*** Bug 57260 has been marked as a duplicate of this bug. ***"}, {"count": 15, "tags": [], "bug_id": 57173, "text": "We are seeing lots of these regressions. I am going to revert r1625504.", "id": 179281, "time": "2014-11-25T15:27:47Z", "creator": "markt@apache.org", "creation_time": "2014-11-25T15:27:47Z", "is_private": false, "attachment_id": null}, {"count": 16, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "The performance improvement that triggered this regression has been reverted from from trunk, 8.0.x (for 8.0.16 onwards) and 7.0.x (for 7.0.58 onwards) and will not be reapplied.", "id": 179284, "time": "2014-11-25T15:49:26Z", "bug_id": 57173, "creation_time": "2014-11-25T15:49:26Z", "is_private": false}, {"count": 17, "tags": [], "bug_id": 57173, "text": "Thanks for the fast response!", "id": 179285, "time": "2014-11-25T15:54:30Z", "creator": "florian.schaefer.extern@asideas.de", "creation_time": "2014-11-25T15:54:30Z", "is_private": false, "attachment_id": null}]