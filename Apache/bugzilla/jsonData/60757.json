[{"attachment_id": null, "tags": [], "bug_id": 60757, "is_private": false, "count": 0, "id": 197191, "time": "2017-02-21T15:24:48Z", "creator": "dr2370@att.com", "creation_time": "2017-02-21T15:24:48Z", "text": "I am running Apache/2.4.25 on FreeBSD install from ports.  I have tried GET and HEAD... both with the request_status expression and the {hc('body') !~ /Maintenance/} on the check.  When I check the access logs on the api1-7 servers... I never see it getting the requests.  I can remove the status.php page... or put it in Maintenance Mode and it still shows Init Ok on the balancer-manager.  Is there still a bug with the health checks inside virtual hosts definitions?  I thought that was fixed in 2.4.24.\n\nThanks\n\nHere is my virtual host config from the httpd.conf...\n\n<VirtualHost 192.168.1.89:8088>\n  ProxyRequests Off\n  ServerName host.example.com\n  \n  ProxyHCExpr ok23 {%{REQUEST_STATUS} =~ /^[23]/}\n  ProxyHCExpr maint {hc('body') !~ /Maintenance/}\n\n  <Proxy *>\n    Order deny,allow\n    Allow from all\n  </Proxy>\n\n  ProxyPass /balancer-manager !\n  ProxyPass /server-status !\n  \n  ProxyPass / balancer://mycluster/\n  ProxyPassReverse / http://192.168.1.91/\n  ProxyPassReverse / http://192.168.1.92/\n  ProxyPassReverse / http://192.168.1.93/\n  ProxyPassReverse / http://192.168.1.94/\n  ProxyPassReverse / http://192.168.1.95/\n  ProxyPassReverse / http://192.168.1.96/\n  ProxyPassReverse / http://192.168.1.97/\n  \n  <Proxy balancer://mycluster>\n    ProxySet lbmethod=bybusyness\n    BalancerMember http://192.168.1.91 route=api1 hcmethod=GET hcuri=/status.php hcexpr=ok23 hcinterval=10\n    BalancerMember http://192.168.1.92 route=api2 hcmethod=GET hcuri=/status.php hcexpr=ok23 hcinterval=10\n    BalancerMember http://192.168.1.93 route=api3 hcmethod=GET hcuri=/status.php hcexpr=ok23 hcinterval=10\n    BalancerMember http://192.168.1.94 route=api4 hcmethod=GET hcuri=/status.php hcexpr=ok23 hcinterval=10\n    BalancerMember http://192.168.1.95 route=api5 hcmethod=GET hcuri=/status.php hcexpr=ok23 hcinterval=10\n    BalancerMember http://192.168.1.96 route=api6 hcmethod=GET hcuri=/status.php hcexpr=ok23 hcinterval=10\n    BalancerMember http://192.168.1.97 route=api7 hcmethod=GET hcuri=/status.php hcexpr=ok23 hcinterval=10\n  </Proxy>\n\n  <Location /balancer-manager>\n    SetHandler balancer-manager\n    Order deny,allow\n    Allow from all\n  </Location>\n</VirtualHost>"}, {"attachment_id": null, "tags": [], "bug_id": 60757, "is_private": false, "count": 1, "id": 197230, "time": "2017-02-23T13:45:50Z", "creator": "jim@apache.org", "creation_time": "2017-02-23T13:45:50Z", "text": "I would turn on debugging on the Apache httpd side and follow the error.log entries for the module. That will tell you when/if/how mod_proxy_hcheck is sending the requests and checking for health."}, {"count": 2, "text": "Ok I changed the LogLevel from warn to debug and did a apachectl restart.\n\nHere is what I get when I do a tail -f -n 10000 /var/log/httpd-error.log | grep -i hcheck\n\n[Thu Feb 23 07:47:15.466584 2017] [proxy_hcheck:debug] [pid 53928] mod_proxy_hcheck.c(994): AH03265: watchdog callback registered (_proxy_hcheck_)\n[Thu Feb 23 07:47:15.485753 2017] [proxy_hcheck:debug] [pid 53929] mod_proxy_hcheck.c(994): AH03265: watchdog callback registered (_proxy_hcheck_)\n[Thu Feb 23 07:47:15.485847 2017] [watchdog:debug] [pid 53929] mod_watchdog.c(513): AH02978: Watchdog: Looking for child (_proxy_hcheck_).\n[Thu Feb 23 07:47:15.486172 2017] [watchdog:debug] [pid 53929] mod_watchdog.c(538): AH02979: Watchdog: Created child worker thread (_proxy_hcheck_).\n[Thu Feb 23 07:47:15.488651 2017] [watchdog:debug] [pid 53930] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 07:47:15.488753 2017] [watchdog:debug] [pid 53930] mod_watchdog.c(157): AH02972: Singleton Watchdog (_proxy_hcheck_) running\n[Thu Feb 23 07:47:15.488868 2017] [proxy_hcheck:debug] [pid 53930] mod_proxy_hcheck.c(857): AH03258: _proxy_hcheck_ watchdog started.\n[Thu Feb 23 07:47:15.489591 2017] [watchdog:debug] [pid 53931] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 07:47:15.494248 2017] [watchdog:debug] [pid 53932] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 07:47:15.494651 2017] [watchdog:debug] [pid 53933] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 07:47:15.494940 2017] [watchdog:debug] [pid 53934] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 07:47:15.494966 2017] [proxy_hcheck:debug] [pid 53930] mod_proxy_hcheck.c(871): AH03313: apr_thread_pool_create() with 16 threads succeeded\n[Thu Feb 23 07:47:15.495132 2017] [watchdog:debug] [pid 53935] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 07:47:15.496698 2017] [watchdog:debug] [pid 53936] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 07:47:15.497852 2017] [watchdog:debug] [pid 53937] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 07:47:15.498257 2017] [watchdog:debug] [pid 53938] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 07:47:15.498483 2017] [watchdog:debug] [pid 53939] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 07:47:15.499660 2017] [watchdog:debug] [pid 53940] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 07:47:15.500192 2017] [watchdog:debug] [pid 53941] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 07:47:15.500396 2017] [watchdog:debug] [pid 53943] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 07:47:15.501017 2017] [watchdog:debug] [pid 53944] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 07:47:15.500613 2017] [watchdog:debug] [pid 53942] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n\nI have been tailing the file for a few minutes now... and nothing else has been added to it.\n\nThanks", "creator": "dr2370@att.com", "is_private": false, "id": 197232, "time": "2017-02-23T13:54:54Z", "bug_id": 60757, "creation_time": "2017-02-23T13:54:54Z", "tags": [], "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 60757, "is_private": false, "count": 3, "id": 197233, "time": "2017-02-23T14:07:09Z", "creator": "jim@apache.org", "creation_time": "2017-02-23T14:07:09Z", "text": "Try the TRACE level just on mod_proxy_hcheck, but yeah, something looks wonky."}, {"attachment_id": null, "tags": [], "bug_id": 60757, "text": "How do I enable TRACE on mod_proxy_hcheck?", "count": 4, "id": 197234, "time": "2017-02-23T14:22:22Z", "creator": "dr2370@att.com", "creation_time": "2017-02-23T14:22:22Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 60757, "is_private": false, "text": "You can do this in 2.4 via the per-module function described in https://httpd.apache.org/docs/2.4/logs.html\n\neg\nLogLevel proxy_hcheck:TRACE2", "id": 197235, "time": "2017-02-23T14:31:07Z", "creator": "jim@apache.org", "creation_time": "2017-02-23T14:31:07Z", "attachment_id": null}, {"count": 6, "tags": [], "creator": "dr2370@att.com", "attachment_id": null, "text": "Ok to help isolate the problem... \n\n1. I put the proxy server in Maintenance Mode.  So no traffic is being handled by the server.\n2. I removed all health checks on the servers except 97 to try and keeps things easier to read.  \n\nThe logs look like the checks are being sent.\n\n[Thu Feb 23 08:52:37.805706 2017] [proxy_hcheck:trace2] [pid 45984] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 08:52:39.948377 2017] [proxy_hcheck:trace2] [pid 45984] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 08:52:42.094132 2017] [proxy_hcheck:trace2] [pid 45984] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 08:52:44.240959 2017] [proxy_hcheck:trace2] [pid 45984] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 08:52:46.380819 2017] [proxy_hcheck:trace2] [pid 45984] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n\nAfter I made that change and restarted Apache I also started a wireshark capture.  And it confirms there is no traffic leaving the proxy going to .97 on those intervals.", "id": 197239, "time": "2017-02-23T15:00:53Z", "bug_id": 60757, "creation_time": "2017-02-23T15:00:53Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 60757, "attachment_id": null, "is_private": false, "id": 197241, "time": "2017-02-23T16:01:16Z", "creator": "jim@apache.org", "creation_time": "2017-02-23T16:01:16Z", "text": "Also enable for mod_proxy and watchdog"}, {"count": 8, "tags": [], "creator": "dr2370@att.com", "text": "Like this?\n\nLogLevel proxy_hcheck:TRACE2\nLogLevel proxy:TRACE2\nLogLevel watchdog:TRACE2\n\nor\n\nLogLevel proxy_hcheck:TRACE2 proxy:TRACE2 watchdog:TRACE2\n\nThanks", "id": 197242, "time": "2017-02-23T16:05:03Z", "bug_id": 60757, "creation_time": "2017-02-23T16:05:03Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 60757, "is_private": false, "count": 9, "id": 197248, "time": "2017-02-23T17:04:27Z", "creator": "jim@apache.org", "creation_time": "2017-02-23T17:04:27Z", "text": "Both ways should work fine."}, {"attachment_id": null, "tags": [], "bug_id": 60757, "is_private": false, "count": 10, "id": 197249, "time": "2017-02-23T17:10:23Z", "creator": "dr2370@att.com", "creation_time": "2017-02-23T17:10:23Z", "text": "Ok added...\n\nLogLevel proxy_hcheck:TRACE2\nLogLevel proxy:TRACE2\nLogLevel watchdog:TRACE2\n\nto the httpd.conf and restarted Apache.  Here is the tail of the error.log file.\n\n[Thu Feb 23 11:08:41.443646 2017] [proxy:debug] [pid 48110] proxy_util.c(1819): AH00927: initializing worker proxy:reverse local\n[Thu Feb 23 11:08:41.443753 2017] [proxy:debug] [pid 48106] proxy_util.c(1870): AH00931: initialized single connection worker in child 48106 for (*)\n[Thu Feb 23 11:08:41.443816 2017] [proxy:debug] [pid 48099] proxy_util.c(1870): AH00931: initialized single connection worker in child 48099 for (*)\n[Thu Feb 23 11:08:41.443810 2017] [watchdog:debug] [pid 48109] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 11:08:41.443940 2017] [proxy:debug] [pid 48110] proxy_util.c(1870): AH00931: initialized single connection worker in child 48110 for (*)\n[Thu Feb 23 11:08:41.444049 2017] [proxy:debug] [pid 48109] proxy_util.c(1777): AH00925: initializing worker proxy:reverse shared\n[Thu Feb 23 11:08:41.444077 2017] [proxy:debug] [pid 48109] proxy_util.c(1819): AH00927: initializing worker proxy:reverse local\n[Thu Feb 23 11:08:41.444272 2017] [proxy:debug] [pid 48109] proxy_util.c(1870): AH00931: initialized single connection worker in child 48109 for (*)\n[Thu Feb 23 11:08:41.444367 2017] [watchdog:debug] [pid 48112] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 11:08:41.444413 2017] [watchdog:debug] [pid 48111] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 11:08:41.444536 2017] [proxy:debug] [pid 48112] proxy_util.c(1777): AH00925: initializing worker proxy:reverse shared\n[Thu Feb 23 11:08:41.444558 2017] [proxy:debug] [pid 48112] proxy_util.c(1819): AH00927: initializing worker proxy:reverse local\n[Thu Feb 23 11:08:41.444624 2017] [proxy:debug] [pid 48111] proxy_util.c(1777): AH00925: initializing worker proxy:reverse shared\n[Thu Feb 23 11:08:41.444646 2017] [proxy:debug] [pid 48111] proxy_util.c(1819): AH00927: initializing worker proxy:reverse local\n[Thu Feb 23 11:08:41.444662 2017] [proxy:debug] [pid 48112] proxy_util.c(1870): AH00931: initialized single connection worker in child 48112 for (*)\n[Thu Feb 23 11:08:41.444869 2017] [proxy:debug] [pid 48111] proxy_util.c(1870): AH00931: initialized single connection worker in child 48111 for (*)\n[Thu Feb 23 11:08:41.445051 2017] [watchdog:debug] [pid 48113] mod_watchdog.c(585): AH02981: Watchdog: Created worker thread (_proxy_hcheck_).\n[Thu Feb 23 11:08:41.445223 2017] [proxy:debug] [pid 48113] proxy_util.c(1777): AH00925: initializing worker proxy:reverse shared\n[Thu Feb 23 11:08:41.445244 2017] [proxy:debug] [pid 48113] proxy_util.c(1819): AH00927: initializing worker proxy:reverse local\n[Thu Feb 23 11:08:41.445320 2017] [proxy:debug] [pid 48113] proxy_util.c(1870): AH00931: initialized single connection worker in child 48113 for (*)\n[Thu Feb 23 11:08:43.518238 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:08:45.658571 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:08:47.797292 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:08:49.933575 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:08:52.079295 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:08:54.217768 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:08:56.362560 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:08:58.509137 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:00.650713 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:02.791724 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:04.926078 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:07.065940 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:09.211893 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:11.354459 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:13.515087 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:15.661700 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:17.802227 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:19.943065 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:22.086451 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:24.201581 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:26.346077 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:28.485516 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:30.626117 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:32.768680 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:34.910136 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:37.056353 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:39.194622 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:41.340963 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:43.481381 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:45.619863 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:47.762859 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog.\n[Thu Feb 23 11:09:49.905427 2017] [proxy_hcheck:trace2] [pid 48099] mod_proxy_hcheck.c(886): Run of _proxy_hcheck_ watchdog."}, {"attachment_id": null, "tags": [], "bug_id": 60757, "is_private": false, "count": 11, "id": 197250, "time": "2017-02-23T20:24:38Z", "creator": "jim@apache.org", "creation_time": "2017-02-23T20:24:38Z", "text": "The Virtualhost itself is active, right? I am not seeing in the snippet where httpd is even creating the check workers...\n\nSo far, have not been able to recreate here"}, {"attachment_id": null, "tags": [], "bug_id": 60757, "is_private": false, "count": 12, "id": 197251, "time": "2017-02-23T20:33:58Z", "creator": "jim@apache.org", "creation_time": "2017-02-23T20:33:58Z", "text": "Hold on... I think I can recreate... trying as we speak"}, {"attachment_id": null, "tags": [], "bug_id": 60757, "text": "Yep. Patched in trunk and proposed for backport. Thx for the report and the testing!", "count": 13, "id": 197252, "time": "2017-02-23T22:16:18Z", "creator": "jim@apache.org", "creation_time": "2017-02-23T22:16:18Z", "is_private": false}, {"count": 14, "tags": [], "creator": "dr2370@att.com", "text": "Awesome.  Thanks", "id": 197253, "time": "2017-02-23T22:19:35Z", "bug_id": 60757, "creation_time": "2017-02-23T22:19:35Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 60757, "is_private": false, "count": 15, "id": 198663, "time": "2017-05-04T11:32:29Z", "creator": "saviz.izadpanah@highq.com", "creation_time": "2017-05-04T11:32:29Z", "text": "Any update on when we can expect this fix in 2.4.25 or newer version (2.4.26)? We have what appears to be the same exact problem. We cannot use mod_proxy_hcheck as the health check URI is not being called at all."}, {"count": 16, "tags": [], "creator": "toscano.luca@gmail.com", "attachment_id": null, "id": 198665, "time": "2017-05-04T11:53:18Z", "bug_id": 60757, "creation_time": "2017-05-04T11:53:18Z", "is_private": false, "text": "IIUC this bug has been backported to the 2.4.x branch with svn.apache.org/r1792905, so it should be easy to add it on top of 2.4.25.\n\nThe next release (.26) should be out sometimes during the next couple of months (being conservative, might happen sooner)."}]