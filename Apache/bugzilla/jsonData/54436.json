[{"count": 0, "tags": [], "bug_id": 54436, "text": "Created attachment 29858\nExample of failing poi if GETPIVOTDATA function exists\n\nOverview:\n\nIf excel file (in my case xlsx) contains GETPIVOTDATA function, then the simple row shifting in workbook will throw an exception:\nException in thread \"main\" java.lang.ArrayIndexOutOfBoundsException: -1\n\tat org.apache.poi.ss.formula.ptg.AbstractFunctionPtg.getParameterClass(AbstractFunctionPtg.java:160)\n\tat org.apache.poi.ss.formula.OperandClassTransformer.transformFunctionNode(OperandClassTransformer.java:277)\n\tat org.apache.poi.ss.formula.OperandClassTransformer.transformNode(OperandClassTransformer.java:134)\n\tat org.apache.poi.ss.formula.OperandClassTransformer.transformFormula(OperandClassTransformer.java:87)\n\tat org.apache.poi.ss.formula.FormulaParser.getRPNPtg(FormulaParser.java:1580)\n\tat org.apache.poi.ss.formula.FormulaParser.parse(FormulaParser.java:177)\n\tat org.apache.poi.xssf.usermodel.helpers.XSSFRowShifter.shiftFormula(XSSFRowShifter.java:186)\n\tat org.apache.poi.xssf.usermodel.helpers.XSSFRowShifter.updateRowFormulas(XSSFRowShifter.java:156)\n\tat org.apache.poi.xssf.usermodel.helpers.XSSFRowShifter.updateSheetFormulas(XSSFRowShifter.java:143)\n\tat org.apache.poi.xssf.usermodel.helpers.XSSFRowShifter.updateFormulas(XSSFRowShifter.java:136)\n\tat org.apache.poi.xssf.usermodel.XSSFSheet.shiftRows(XSSFSheet.java:2364)\nThis happens due to broken metadata in the \"functionMetadata.txt\" where columns \"Return Class\" and \"Parameter classes\" for GETPIVOTDATA functions are omitted:\n358\tGETPIVOTDATA\t2\t30\t\t\t\t\n\nCause the source \"excelfileformat.odt\" file doesn't contain this information. \n\nModifying the metadata for this formula fixes the problem.\nWorking solution is:\n358\tGETPIVOTDATA\t2\t30\tV\tV R ...\t\t\n\nExample files are attached.", "id": 164670, "time": "2013-01-16T14:31:01Z", "creator": "solid.danil@gmail.com", "creation_time": "2013-01-16T14:31:01Z", "is_private": false, "attachment_id": 29858}, {"count": 1, "attachment_id": null, "creator": "lantushenkoao@mail.ru", "is_private": false, "id": 165567, "time": "2013-03-01T14:26:19Z", "bug_id": 54436, "creation_time": "2013-03-01T14:26:19Z", "tags": [], "text": "Experienced the same problem. Proposed solution works for me. It would be great to have it as generic change instead of patching poi jar each time...."}, {"count": 2, "tags": [], "creator": "solid.danil@gmail.com", "attachment_id": 30007, "id": 165573, "time": "2013-03-01T17:22:55Z", "bug_id": 54436, "creation_time": "2013-03-01T17:22:55Z", "is_private": false, "text": "Created attachment 30007\nGetpivotdata function bug patch\n\nAttached patch"}, {"count": 3, "tags": [], "text": "Comment on attachment 30007\nGetpivotdata function bug patch\n\nIndex: src/resources/main/org/apache/poi/ss/formula/function/functionMetadata.txt\n===================================================================\n--- src/resources/main/org/apache/poi/ss/formula/function/functionMetadata.txt\t(revision 1451559)\n+++ src/resources/main/org/apache/poi/ss/formula/function/functionMetadata.txt\t(working copy)\n@@ -274,7 +274,7 @@\n 353\tNUMBERSTRING\t2\t2\tV\tV V\t\t\n 354\tROMAN\t1\t2\tV\tV V\t\t\n # New Built-In Sheet Functions in BIFF8\n-358\tGETPIVOTDATA\t2\t30\t\t\t\t\n+358\tGETPIVOTDATA\t2\t30\tV\tV R ...\t\t\n 359\tHYPERLINK\t1\t2\tV\tV V\t\t\n 360\tPHONETIC\t1\t1\tV\tR\t\t\n 361\tAVERAGEA\t1\t30\tV\tR ...", "is_private": false, "id": 165574, "creator": "solid.danil@gmail.com", "time": "2013-03-01T17:28:47Z", "bug_id": 54436, "creation_time": "2013-03-01T17:28:47Z", "attachment_id": 30007}, {"count": 4, "tags": [], "text": "Created attachment 30008\nGetpivotdata function bug patch txt format\n\nPrevious patch.tar.gz can't be downloaded or viewed.", "is_private": false, "id": 165575, "creator": "solid.danil@gmail.com", "time": "2013-03-01T17:35:31Z", "bug_id": 54436, "creation_time": "2013-03-01T17:35:31Z", "attachment_id": 30008}, {"count": 5, "attachment_id": null, "creator": "yegor@dinom.ru", "is_private": false, "id": 165583, "time": "2013-03-02T12:06:16Z", "bug_id": 54436, "creation_time": "2013-03-02T12:06:16Z", "tags": [], "text": "Patch applied in r1451875\n\nThe metadata is fixed but you still be getting exceptions because GETPIVOTDATA is not implemented in current version of POI. If you need to evaluate workbooks with this function you need to implement it and register via WorkbookEvaluator#registerFunction, see http://poi.apache.org/spreadsheet/eval-devguide.html\n\nI could not reproduce the problem with the test from the attached archive. The code throws a exception but a different one:\n\njava.lang.IllegalArgumentException: firstMovedIndex, lastMovedIndex out of order\n\tat org.apache.poi.ss.formula.FormulaShifter.<init>(FormulaShifter.java:56)\n\tat org.apache.poi.ss.formula.FormulaShifter.createForRowShift(FormulaShifter.java:81)\n\tat org.apache.poi.xssf.usermodel.XSSFSheet.shiftRows(XSSFSheet.java:2361)\n\nI confirmed it with POI-3.9 and trunk. \n\nThe simplest test for this fix is to evaluate all formulas in the workbook:\n\n workbook.getCreationHelper().createFormulaEvaluator().evaluateAll();\n\nWithout this fix it fails with ArrayIndexOutOfBoundsException and with the patch applied it passes OK. \n\nRegards,\nYegor"}]