[{"count": 0, "tags": [], "bug_id": 37469, "attachment_id": null, "text": "1. Create a httpd.conf with 1500 websites. Every VirtualHost section should be \nlike this:\n\n<VirtualHost xxxx>\nServerName testXXX\nServerAlias testXXX.com\nServerAdmin webmaster@testXXX.com\nDocumentRoot /home/testXXX/public_html\nScriptAlias /cgi-local/ /home/testXXX/public_html/cgi-local/\nSetEnv LOG_SUBDIR testXXX\nSuexecUserGroup testXXX testXXX\nJkMount /*.jsp ajp13\nJkMount /servlet/* ajp13\n</VirtualHost>\n<VirtualHost xxxx:443>\nServerName testXXX\nServerAlias testXXX.com\nServerAdmin webmaster@testXXX.com\nDocumentRoot /home/testXXX/public_html\nScriptAlias /cgi-local/ /home/testXXX/public_html/cgi-local/\nSetEnv LOG_SUBDIR testXXX\nSuexecUserGroup testXXX testXXX\nJkMount /*.jsp ajp13\nJkMount /servlet/* ajp13\n</VirtualHost>\n\n2. create a simple script:\n\n#!/usr/bin/perl\n\nprint \"Content-Type: text/html\\n\\n\";\nprint \"Test!!\";\n\n3. execute on the web\n  \nActual results:\n\nIn a Dual Xeon, zero load, it takes 2 seconds to run.\n\nI did some straces:\n\nstrace -T -f -p xxxxx\n\n[pid 30864] read(4, \"\", 4096)           = 0 <0.000022>\n[pid 30864] close(4)                    = 0 <0.000016>\n[pid 30864] read(3, \"\", 4096)           = 0 <0.000014>\n[pid 30864] close(3)                    = 0 <0.000012>\n[pid 30864] write(1, \"Content-Type: text/html\\n\\nTest\"..., 72) = 72 <0.000020>\n[pid 30785] <... poll resumed> [{fd=26, events=POLLIN, revents=POLLIN}, {fd=28, \nevents=POLLIN}], 2, 30000) = 1 <2.120682>\n\nIn \"LogLevel debug\", I see: \n\n[Fri Nov 11 12:55:50 2005] [25756:39072] [debug] jk_cleanup_shmem::mod_jk.c \n(1761): Shmem cleanup\n[Fri Nov 11 12:55:53 2005] [25756:39072] [debug] jk_cleanup_shmem::mod_jk.c \n(1761): Shmem cleanup\n\n(> 2 seconds !!)\n\nIf I remove all the JkMount mapping, the CGI execution is very fast. So there \nis definitely an issue with mod_jk. \n\nwith mod_jk -> more than 2 seconds\nwithout mod_jk -> a few milliseconds\n\nOBS: Those tests were done in a server without load. I simply turn apache \n2.0.52 on and requested the CGI execution. \n\nI can test any patch.", "id": 82393, "time": "2005-11-11T17:36:26Z", "creator": "reweiner@yahoo.com", "creation_time": "2005-11-11T17:36:26Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 37469, "text": "What version of mod_jk and what Apache version (httpd -V)\nas well as OS.\nThe messages you see are caused by recycling the child process\nso that's why they took 2 seconds.\n\nThe question is why the child dies, so please provide more info\nabout apache version, mpm used and OS.", "id": 82395, "time": "2005-11-11T18:04:28Z", "creator": "mturk@apache.org", "creation_time": "2005-11-11T18:04:28Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "text": "I\u00b4m using RedHat AS 3.0\n\nhttpd -V\nServer version: Apache/2.0.46\nServer built:   Sep  6 2005 11:21:32\nServer's Module Magic Number: 20020903:4\nArchitecture:   32-bit\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses disabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D HTTPD_ROOT=\"/etc/httpd\"\n -D SUEXEC_BIN=\"/usr/sbin/suexec\"\n -D DEFAULT_PIDLOG=\"logs/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_LOCKFILE=\"logs/accept.lock\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"\n\nLatest mod_jk - 1.2.15 (I tested on 1.2.14 and it\u00b4s the same)\n\nLet me know if you need something else.\n", "attachment_id": null, "bug_id": 37469, "id": 82397, "time": "2005-11-11T18:10:22Z", "creator": "reweiner@yahoo.com", "creation_time": "2005-11-11T18:10:22Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 37469, "attachment_id": null, "id": 82398, "time": "2005-11-11T18:27:27Z", "creator": "mturk@apache.org", "creation_time": "2005-11-11T18:27:27Z", "is_private": false, "text": "Can you post your workers.properties file and global JkXXXX directives.\n\nAlso, set the 'JkLogLevel debug' to httpd.conf,\nand post the mod_jk.log for:\n> apachectrl start\n> apachectrl stop\n\nOne other question, is it working with 500 vhosts?"}, {"count": 4, "tags": [], "bug_id": 37469, "attachment_id": 16949, "text": "Created attachment 16949\ndebug file for mod_jk", "id": 82402, "time": "2005-11-11T19:07:37Z", "creator": "reweiner@yahoo.com", "creation_time": "2005-11-11T19:07:37Z", "is_private": false}, {"count": 5, "tags": [], "creator": "reweiner@yahoo.com", "attachment_id": null, "id": 82403, "time": "2005-11-11T19:08:01Z", "bug_id": 37469, "creation_time": "2005-11-11T19:08:01Z", "is_private": false, "text": "workers.properties, only the uncomment part:\n\nworker.list=ajp13\nworker.ajp13.port=8009\nworker.ajp13.host=localhost\nworker.ajp13.type=ajp13\nworker.ajp13.lbfactor=1\nworker.ajp13.cachesize=10\nworker.ajp13.cache_timeout=600\nworker.ajp13.socket_keepalive=0\nworker.ajp13.socket_timeout=300\n\nIt works with 1500 ;)). But then CGI works very slowly as described in this \nissue.\n\nI\u00b4m attaching the debug log. I turned the server on, executed the cgi script \nand the turned it off.\n"}, {"count": 6, "tags": [], "text": "Your log statements look inconsistent to me:\n\n[pid 30864] write(1, \"Content-Type: text/html\\n\\nTest\"..., 72) = 72 <0.000020>\n\nSo PID 30864 correctly writes your CGI output after a very short time.\nThe next entry\n\n[pid 30785] <... poll resumed> [{fd=26, events=POLLIN, revents=POLLIN}, {fd=28, \nevents=POLLIN}], 2, 30000) = 1 <2.120682>\n\ncomes from a totally different process 30785 and for me it does NOT mean, that\nthe request took 2 seconds.\n\n[Fri Nov 11 12:55:50 2005] [25756:39072] [debug] jk_cleanup_shmem::mod_jk.c \n(1761): Shmem cleanup\n[Fri Nov 11 12:55:53 2005] [25756:39072] [debug] jk_cleanup_shmem::mod_jk.c \n(1761): Shmem cleanup\n\nThese two messages come from PID 25756 which is again another process.\nFurthermore the PID is numerically very different from the PIDs above, so it\nseems that this process has not been started/forked around the same time as the\nother two ones.\n\nYou can add %P to apaches log format to log the PID which processed the request\nand %T to get the request duration in seconds.\n\nNevertheless I find it strange, that the same PID and thread id logs a cleanup\ntwo times.", "attachment_id": null, "id": 82404, "creator": "rainer.jung@kippdata.de", "time": "2005-11-11T19:20:57Z", "bug_id": 37469, "creation_time": "2005-11-11T19:20:57Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 37469, "attachment_id": null, "text": "I just looked at your mod_jk.log. Again the PID of the process doing two\ncleanups in a row is not contained in the startup log lines. I guess it's the\nforked CGI process, that does the jk cleanup. I think that's not to be expected\n- Mladen, what do you think?\n\n", "id": 82405, "time": "2005-11-11T19:34:21Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2005-11-11T19:34:21Z", "is_private": false}, {"count": 8, "tags": [], "text": "The log I send is different from the first post (I did another test when you \nasked). Also when I did the strace, I had to choose a child process and then \nhit the web a couple of times, till it uses the one I chose. Sorry, if it looks \ninconsistent. If you want I can try to provide a log with the right PIDs, but \nthey will look exactly as what I posted.\n\nThanks again.", "attachment_id": null, "id": 82406, "creator": "reweiner@yahoo.com", "time": "2005-11-11T19:35:29Z", "bug_id": 37469, "creation_time": "2005-11-11T19:35:29Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 37469, "attachment_id": null, "text": "25756 is the forked CGI process. On the test perl script change print line to:\n\nprint \"Test - PID process $$ !!\";\n\nand you\u00b4ll see that this is the process that calls jk_cleanup_shmem (!? - \nweird...)\n\n", "id": 82419, "time": "2005-11-12T19:58:06Z", "creator": "reweiner@yahoo.com", "creation_time": "2005-11-12T19:58:06Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 37469, "attachment_id": null, "text": "*** Bug 37470 has been marked as a duplicate of this bug. ***", "id": 82585, "time": "2005-11-16T20:15:25Z", "creator": "yoavs@computer.org", "creation_time": "2005-11-16T20:15:25Z", "is_private": false}, {"count": 11, "tags": [], "creator": "mturk@apache.org", "text": "Fixed in the SVN. See:\nhttp://svn.apache.org/viewcvs?rev=386604&view=rev", "id": 86961, "time": "2006-03-17T10:40:39Z", "bug_id": 37469, "creation_time": "2006-03-17T10:40:39Z", "is_private": false, "attachment_id": null}]