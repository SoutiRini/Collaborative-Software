[{"count": 0, "tags": [], "text": "In a vanilla apache2.2.x configuration if I only load mod_authz_host and none of\nthe other mod_auth* modules, every graceful restart causes ~1Mb leak in the\nparent process.\n\nSteps to reproduce:\nGentoo:\n1. In /etc/apache2/httd.conf comment out all \"LoadModule auth*\" directives except \nLoadModule authz_host_module modules/mod_authz_host.so\n\nUbuntu Feisty:\n1. In /etc/apache2/mods-enabled rename auth*.load files except authz_host.load\nto auth*.load.not\n\n2. Start apache\n3. Track apache parent process: top -d1 -p $(pgrep -o apache)\n4. Hit apache instances with graceful restarts:\nfor i in $(seq 150); do echo $i; kill -USR1 $(pgrep -o apache); sleep 2 done\n\nIn this case the parent will leak ~1Mb per restart. If however in each of the\nconfigurations mod_auth_digest.so is also loaded the leak is only about 150-200K\nor so per graceful restart. This is on a server with 0 load. In my case it\ncaused apache instances that were restarted every 55 minutes to grow up to 300Mb\nin a week.\n\nTested on:\n1. gentoo (64 bit dual proc AMD): \nLinux host1 2.6.16-gentoo-r9 #7 SMP Fri Mar 16 17:35:26 UTC 2007 x86_64 AMD\nOpteron(tm) Processor 248 AuthenticAMD GNU/Linux\n\nServer version: Apache/2.2.4 (Unix)\nServer built:   Jun 26 2007 19:29:33\nServer's Module Magic Number: 20051115:4\nServer loaded:  APR 1.2.8, APR-Util 1.2.8\nCompiled using: APR 1.2.8, APR-Util 1.2.8\nArchitecture:   64-bit\nServer MPM:     Prefork\n  threaded:     no\n    forked:     yes (variable process count)\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"/usr\"\n -D SUEXEC_BIN=\"/usr/sbin/suexec\"\n -D DEFAULT_PIDLOG=\"/var/run/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_LOCKFILE=\"/var/run/accept.lock\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"/etc/apache2/mime.types\"\n -D SERVER_CONFIG_FILE=\"/etc/apache2/httpd.conf\"\n\n2. Ubuntu Feisty (32 bit Intel core duo):\nLinux host2 2.6.20-16-generic #2 SMP Thu Jun 7 20:19:32 UTC 2007 i686 GNU/Linux\n\nServer version: Apache/2.2.3\nServer built:   Jan 15 2007 18:14:50\nServer's Module Magic Number: 20051115:3\nServer loaded:  APR 1.2.7, APR-Util 1.2.7\nCompiled using: APR 1.2.7, APR-Util 1.2.7\nArchitecture:   32-bit\nServer MPM:     Prefork\n  threaded:     no\n    forked:     yes (variable process count)\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"\"\n -D SUEXEC_BIN=\"/usr/lib/apache2/suexec\"\n -D DEFAULT_PIDLOG=\"/var/run/apache2.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_LOCKFILE=\"/var/run/apache2/accept.lock\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"/etc/apache2/mime.types\"\n -D SERVER_CONFIG_FILE=\"/etc/apache2/apache2.conf\"", "is_private": false, "id": 104743, "creator": "amohanty@myrealbox.com", "time": "2007-06-26T15:35:39Z", "bug_id": 42749, "creation_time": "2007-06-26T15:35:39Z", "attachment_id": null}, {"count": 1, "tags": [], "text": "Sorry but I cannot reproduce this behaviour. So my closest guess for now would\nbe that Gentoo / Ubuntu added further patches to their httpd binaries that cause\nthis behaviour or that you are using a 3rd party module that causes this. Please\ncheck if you can reproduce this behaviour if you compile httpd by yourself from\nthe sources at httpd.apache.org.", "attachment_id": null, "id": 104752, "creator": "rpluem@apache.org", "time": "2007-06-27T01:36:25Z", "bug_id": 42749, "creation_time": "2007-06-27T01:36:25Z", "is_private": false}, {"count": 2, "tags": [], "text": "It appears you are correct. A base install from source using:\n\n./configure --prefix=/opt --enable-modules=all --enable-mods-shared=all\n--enable-so --with-included-apr\n\ndoes not display this behaviour. I failed to mention that we do use mod_python\nand as soon as I throw in mod_python the mix, the behaviour is back. \n\nOh well, time to file a bug against mod_python I guess.\n\nThanks.", "is_private": false, "id": 104774, "creator": "amohanty@myrealbox.com", "time": "2007-06-27T09:59:22Z", "bug_id": 42749, "creation_time": "2007-06-27T09:59:22Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 42749, "attachment_id": null, "id": 104777, "time": "2007-06-27T11:35:16Z", "creator": "rpluem@apache.org", "creation_time": "2007-06-27T11:35:16Z", "is_private": false, "text": "Thanks for your feedback. Based on your reply I mark this report as invalid."}]