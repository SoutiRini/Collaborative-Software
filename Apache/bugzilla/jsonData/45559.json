[{"count": 0, "tags": [], "text": "Created attachment 22382\nstrace output when apache segfaults\n\nHi,\n\nSince we've upgraded to apache 2.0.63 we're experiencing random segmentation faults at apache startup. Disabling certain modules (php and jk) and lowering the number of configured threads lead to a decreased 'chance' of crashing. Still however, it shouldn't be the modules problem since they work fine on 2.0.61 .\n\nldd of bin/httpd on 2.0.61:\n\n        libz.so.1 => /usr/lib/libz.so.1 (0x009fc000)\n        libssl.so.4 => /lib/libssl.so.4 (0x00f26000)\n        libcrypto.so.4 => /lib/libcrypto.so.4 (0x00715000)\n        libgssapi_krb5.so.2 => /usr/kerberos/lib/libgssapi_krb5.so.2 (0x00bae000)\n        libkrb5.so.3 => /usr/kerberos/lib/libkrb5.so.3 (0x002bb000)\n        libcom_err.so.3 => /usr/kerberos/lib/libcom_err.so.3 (0x004ab000)\n        libk5crypto.so.3 => /usr/kerberos/lib/libk5crypto.so.3 (0x0094a000)\n        libresolv.so.2 => /lib/libresolv.so.2 (0x004cb000)\n        libaprutil-0.so.0 => /usr/local/apache/lib/libaprutil-0.so.0 (0x00ceb000)\n        libexpat.so.0 => /usr/lib/libexpat.so.0 (0x00111000)\n        libapr-0.so.0 => /usr/local/apache/lib/libapr-0.so.0 (0x00bff000)\n        librt.so.1 => /lib/tls/librt.so.1 (0x006f0000)\n        libm.so.6 => /lib/tls/libm.so.6 (0x00131000)\n        libcrypt.so.1 => /lib/libcrypt.so.1 (0x00f64000)\n        libnsl.so.1 => /lib/libnsl.so.1 (0x00abc000)\n        libpthread.so.0 => /lib/tls/libpthread.so.0 (0x00343000)\n        libdl.so.2 => /lib/libdl.so.2 (0x004f2000)\n        libc.so.6 => /lib/tls/libc.so.6 (0x00153000)\n        /lib/ld-linux.so.2 => /lib/ld-linux.so.2 (0x006d2000)\n\n\nldd of bin/httpd on 2.0.63:\n\n        libz.so.1 => /usr/lib/libz.so.1 (0x00698000)\n        libaprutil-0.so.0 => /usr/local/apache/lib/libaprutil-0.so.0 (0x00275000)\n        libexpat.so.0 => /usr/lib/libexpat.so.0 (0x007d5000)\n        libapr-0.so.0 => /usr/local/apache/lib/libapr-0.so.0 (0x0053d000)\n        librt.so.1 => /lib/tls/librt.so.1 (0x00d21000)\n        libm.so.6 => /lib/tls/libm.so.6 (0x00111000)\n        libcrypt.so.1 => /lib/libcrypt.so.1 (0x00eb5000)\n        libnsl.so.1 => /lib/libnsl.so.1 (0x00bf0000)\n        libpthread.so.0 => /lib/tls/libpthread.so.0 (0x002b4000)\n        libdl.so.2 => /lib/libdl.so.2 (0x00afc000)\n        libc.so.6 => /lib/tls/libc.so.6 (0x00133000)\n        /lib/ld-linux.so.2 => /lib/ld-linux.so.2 (0x00dc2000)", "attachment_id": 22382, "id": 119401, "creation_time": "2008-08-05T06:30:39Z", "time": "2008-08-05T06:30:39Z", "creator": "mguardiola@asp4all.nl", "bug_id": 45559, "is_private": false}, {"count": 1, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "id": 119419, "time": "2008-08-05T11:36:59Z", "bug_id": 45559, "creation_time": "2008-08-05T11:36:59Z", "is_private": false, "text": "Please provide a backtrace of the crashed process.\nRegarding the ldd output: Your 2.0.63 is not compiled with mod_ssl and SSL support."}, {"count": 2, "tags": [], "creator": "mguardiola@asp4all.nl", "attachment_id": null, "id": 119450, "time": "2008-08-05T16:03:05Z", "bug_id": 45559, "creation_time": "2008-08-05T16:03:05Z", "is_private": false, "text": "Both versions are configured and compiled in exactly the same way, with ssl support, with the following configure parameters:\n\n./configure --enable-so --prefix=/usr/local/apache --enable-mods-shared=\"proxy ssl deflate rewrite headers expires\" --enable-vhost-alias\n\nmodules/mod_ssl.so is present after compiling. LoadModule ssl_module modules/mod_ssl.so works, https works fine. The script below shows how I tested this repeatedly. \n\n----\nfor version in 61 63; do\n  cd /export/redhatsrc/TARS\n  rm -Rf httpd-2.0.$version\n  rm -Rf httpd-2.0.$version.tar.gz\n  echo wget; wget -q http://archive.apache.org/dist/httpd/httpd-2.0.$version.tar.gz\n  echo tar; tar xzf httpd-2.0.$version.tar.gz\n  cd httpd-2.0.$version\n  echo confgure; ./configure --enable-so --prefix=/usr/local/apache --enable-mods-shared=\"proxy ssl deflate rewrite headers expires\" --enable-vhost-alias > /dev/null\n  echo make; make > /dev/null\n  echo 2.0.$version:\n  ldd .libs/httpd\n  echo \"\"\ndone\n----\n\nwget\ntar\nconfigure\nconfig.status: WARNING:  apr-config.in seems to ignore the --datarootdir setting\nmake\nlibtool: link: warning: `-version-info' is ignored for programs\n2.0.61:\n        libz.so.1 => /usr/lib/libz.so.1 (0x00671000)\n        libssl.so.4 => /lib/libssl.so.4 (0x0057b000)\n        libcrypto.so.4 => /lib/libcrypto.so.4 (0x00829000)\n        libgssapi_krb5.so.2 => /usr/kerberos/lib/libgssapi_krb5.so.2 (0x00111000)\n        libkrb5.so.3 => /usr/kerberos/lib/libkrb5.so.3 (0x00131000)\n        libcom_err.so.3 => /usr/kerberos/lib/libcom_err.so.3 (0x00ee8000)\n        libk5crypto.so.3 => /usr/kerberos/lib/libk5crypto.so.3 (0x0018f000)\n        libresolv.so.2 => /lib/libresolv.so.2 (0x00d17000)\n        libaprutil-0.so.0 => /usr/local/apache/lib/libaprutil-0.so.0 (0x00c16000)\n        libexpat.so.0 => /usr/lib/libexpat.so.0 (0x009ef000)\n        libapr-0.so.0 => /usr/local/apache/lib/libapr-0.so.0 (0x007da000)\n        librt.so.1 => /lib/tls/librt.so.1 (0x00955000)\n        libm.so.6 => /lib/tls/libm.so.6 (0x00c6e000)\n        libcrypt.so.1 => /lib/libcrypt.so.1 (0x00eb2000)\n        libnsl.so.1 => /lib/libnsl.so.1 (0x001a1000)\n        libpthread.so.0 => /lib/tls/libpthread.so.0 (0x001b6000)\n        libdl.so.2 => /lib/libdl.so.2 (0x001e2000)\n        libc.so.6 => /lib/tls/libc.so.6 (0x006a0000)\n        /lib/ld-linux.so.2 => /lib/ld-linux.so.2 (0x00b26000)\n\nwget\ntar\nconfigure\nconfig.status: WARNING:  apr-config.in seems to ignore the --datarootdir setting\nmake\nlibtool: link: warning: `-version-info' is ignored for programs\n2.0.63:\n        libz.so.1 => /usr/lib/libz.so.1 (0x00584000)\n        libaprutil-0.so.0 => /usr/local/apache/lib/libaprutil-0.so.0 (0x00ddf000)\n        libexpat.so.0 => /usr/lib/libexpat.so.0 (0x005b2000)\n        libapr-0.so.0 => /usr/local/apache/lib/libapr-0.so.0 (0x003e4000)\n        librt.so.1 => /lib/tls/librt.so.1 (0x00162000)\n        libm.so.6 => /lib/tls/libm.so.6 (0x00a8b000)\n        libcrypt.so.1 => /lib/libcrypt.so.1 (0x00c53000)\n        libnsl.so.1 => /lib/libnsl.so.1 (0x0018d000)\n        libpthread.so.0 => /lib/tls/libpthread.so.0 (0x00111000)\n        libdl.so.2 => /lib/libdl.so.2 (0x00a0d000)\n        libc.so.6 => /lib/tls/libc.so.6 (0x00eae000)\n        /lib/ld-linux.so.2 => /lib/ld-linux.so.2 (0x00298000)\n--\n\n\nSee below for the backtrace, attempt #3 segfaults.\n\n# gdb ./httpd 2>&1 | tee gdb-httpd.txt\nGNU gdb Red Hat Linux (6.3.0.0-1.138.el3rh)\nCopyright 2004 Free Software Foundation, Inc.\nGDB is free software, covered by the GNU General Public License, and you are\nwelcome to change it and/or distribute copies of it under certain conditions.\nType \"show copying\" to see the conditions.\nThere is absolutely no warranty for GDB.  Type \"show warranty\" for details.\nThis GDB was configured as \"i386-redhat-linux-gnu\"...(no debugging symbols found)\nUsing host libthread_db library \"/lib/tls/libthread_db.so.1\".\n\n(gdb) run -X\nStarting program: /usr/local/apache/bin/httpd -X\n(no debugging symbols found)\n[Thread debugging using libthread_db enabled]\n[New Thread -1218524736 (LWP 29662)]\n[Wed Aug 06 00:39:16 2008] [warn] NameVirtualHost *:80 has no VirtualHosts\n\nProgram received signal SIGTERM, Terminated.\n[Switching to Thread -1218524736 (LWP 29662)]\n0x00174d7c in accept () from /lib/tls/libpthread.so.0\n(gdb) run -X\nThe program being debugged has been started already.\nStart it from the beginning? (y or n) y\nStarting program: /usr/local/apache/bin/httpd -X\n(no debugging symbols found)\n[Thread debugging using libthread_db enabled]\n[New Thread -1218516544 (LWP 29691)]\n[Wed Aug 06 00:39:47 2008] [warn] NameVirtualHost *:80 has no VirtualHosts\n\nProgram received signal SIGTERM, Terminated.\n[Switching to Thread -1218516544 (LWP 29691)]\n0x008f6d7c in accept () from /lib/tls/libpthread.so.0\n(gdb) run -X\nThe program being debugged has been started already.\nStart it from the beginning? (y or n) y\nStarting program: /usr/local/apache/bin/httpd -X\n(no debugging symbols found)\n[Thread debugging using libthread_db enabled]\n[New Thread -1218528832 (LWP 29734)]\n[Wed Aug 06 00:41:06 2008] [warn] NameVirtualHost *:80 has no VirtualHosts\n\nProgram received signal SIGSEGV, Segmentation fault.\n[Switching to Thread -1218528832 (LWP 29734)]\n0x00360e2a in ERR_reason_error_string () from /lib/libcrypto.so.4\n(gdb) bt\n#0  0x00360e2a in ERR_reason_error_string () from /lib/libcrypto.so.4\n#1  0x0035d55e in lh_insert () from /lib/libcrypto.so.4\n#2  0x0035fd3b in ERR_set_implementation () from /lib/libcrypto.so.4\n#3  0x003603c3 in ERR_load_ERR_strings () from /lib/libcrypto.so.4\n#4  0x00a92fd3 in ERR_load_SSL_strings () from /lib/libssl.so.4\n#5  0x00a8a26e in SSL_load_error_strings () from /lib/libssl.so.4\n#6  0x00df78f6 in ssl_init_SSLLibrary (s=0x97d0848) at ssl_engine_init.c:63\n#7  0x00df7c56 in ssl_init_Module (p=0x97cc0a8, plog=0x9804188, ptemp=0x980d1a8, base_server=0x97d0848) at ssl_engine_init.c:226\n#8  0x0807d798 in ap_run_post_config ()\n#9  0x08082192 in main ()\n(gdb)\n\n"}, {"count": 3, "tags": [], "creator": "rpluem@apache.org", "text": "Please try bt full instead of bt. Looks like a crash in the openssl library.\nRegarding the differences in your ldd output, this seems to be caused by http://svn.apache.org/viewvc?view=rev&revision=607260 and works as designed.", "id": 119480, "time": "2008-08-06T02:27:40Z", "bug_id": 45559, "creation_time": "2008-08-06T02:27:40Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 45559, "text": "Hi,\n\nSee below for the bt full. \n\n# gdb ./httpd 2>&1 | tee gdb-httpd.txt\nGNU gdb Red Hat Linux (6.3.0.0-1.138.el3rh)\nCopyright 2004 Free Software Foundation, Inc.\nGDB is free software, covered by the GNU General Public License, and you are\nwelcome to change it and/or distribute copies of it under certain conditions.\nType \"show copying\" to see the conditions.\nThere is absolutely no warranty for GDB.  Type \"show warranty\" for details.\nThis GDB was configured as \"i386-redhat-linux-gnu\"...(no debugging symbols found)\nUsing host libthread_db library \"/lib/tls/libthread_db.so.1\".\n\n(gdb) run -X\nStarting program: /usr/local/apache/bin/httpd -X\n(no debugging symbols found)\n[Thread debugging using libthread_db enabled]\n[New Thread -1218532928 (LWP 10559)]\n[Wed Aug 06 15:16:01 2008] [warn] NameVirtualHost *:80 has no VirtualHosts\n\nProgram received signal SIGSEGV, Segmentation fault.\n[Switching to Thread -1218532928 (LWP 10559)]\n0x00281e2a in ERR_reason_error_string () from /lib/libcrypto.so.4\n(gdb) bt full\n#0  0x00281e2a in ERR_reason_error_string () from /lib/libcrypto.so.4\nNo symbol table info available.\n#1  0x0027e55e in lh_insert () from /lib/libcrypto.so.4\nNo symbol table info available.\n#2  0x00280d3b in ERR_set_implementation () from /lib/libcrypto.so.4\nNo symbol table info available.\n#3  0x002813c3 in ERR_load_ERR_strings () from /lib/libcrypto.so.4\nNo symbol table info available.\n#4  0x00b15fd3 in ERR_load_SSL_strings () from /lib/libssl.so.4\nNo symbol table info available.\n#5  0x00b0d26e in SSL_load_error_strings () from /lib/libssl.so.4\nNo symbol table info available.\n#6  0x001248f6 in ssl_init_SSLLibrary (s=0x90dd848) at ssl_engine_init.c:63\nNo locals.\n#7  0x00124c56 in ssl_init_Module (p=0x90d90a8, plog=0x9111188, ptemp=0x911a1a8, base_server=0x90dd848) at ssl_engine_init.c:226\n        mc = (SSLModConfigRec *) 0x9191150\n        sc = (SSLSrvConfigRec *) 0x9191150\n        s = (server_rec *) 0x0\n#8  0x0807d798 in ap_run_post_config ()\nNo symbol table info available.\n#9  0x08082192 in main ()\nNo symbol table info available.\n(gdb) c\nContinuing.\n\nProgram terminated with signal SIGSEGV, Segmentation fault.\nThe program no longer exists.\n(gdb) quit\n", "id": 119492, "time": "2008-08-06T06:18:11Z", "creator": "mguardiola@asp4all.nl", "creation_time": "2008-08-06T06:18:11Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "id": 119518, "time": "2008-08-06T11:58:09Z", "bug_id": 45559, "creation_time": "2008-08-06T11:58:09Z", "is_private": false, "text": "Sorry no real idea what it is. SSL_load_error_strings does not take any input parameters, so this smells like something weird is going on inside openssl. Mind to report this to the openssl bugtracker?"}, {"count": 6, "tags": [], "creator": "mguardiola@asp4all.nl", "text": "I could do that. I'm not sure though if openssl will handle bugs regarding an 'old' version patched by RedHat. I'd first have to see if this problem happens with the latest version of openssl as well, if this isn't the case then it could be RedHat's problem. Then RedHat maybe doesn't care because they're not shipping 2.0.63 . What a cruel world we live in.\n\nThings that would make me think it's an issue with apache is that versions prior to 2.0.63 work like a charm, as does our other software that is linked to openssl. Also strange and that 2.0.63 crashes 'most of the time' instead of always. However, the thing that works in favour of apache is that we dont have this problem on RHEL4. RHEL3 and RHEL4 got the same version of openssl though, 0.9.7a (patched). Although RedHat perhaps didn't patch them identically.\n\nDo you have an idea what changes in 2.0.63 regarding the aproach of using the openssl libraries could cause this ? If it's a bug in openssl, maybe it's already out there.. ?", "id": 119526, "time": "2008-08-06T14:47:51Z", "bug_id": 45559, "creation_time": "2008-08-06T14:47:51Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "creator": "wrowe@apache.org", "text": "Could you please set a breakpoint at ssl_engine_init.c:63\n\nconfirm if this segfaults on the first time you continue into this line,\nor if the segfault is on a subsequent call to this line?", "id": 119841, "time": "2008-08-14T12:18:29Z", "bug_id": 45559, "creation_time": "2008-08-14T12:18:29Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "mguardiola@asp4all.nl", "attachment_id": null, "id": 119864, "time": "2008-08-15T13:08:45Z", "bug_id": 45559, "creation_time": "2008-08-15T13:08:45Z", "is_private": false, "text": "Looks like the segfault happens on the second call, indeed seems to have to do with line 63. See below:\n\n# gdb ./httpd\nGNU gdb Red Hat Linux (6.3.0.0-1.138.el3rh)\nCopyright 2004 Free Software Foundation, Inc.\nGDB is free software, covered by the GNU General Public License, and you are\nwelcome to change it and/or distribute copies of it under certain conditions.\nType \"show copying\" to see the conditions.\nThere is absolutely no warranty for GDB.  Type \"show warranty\" for details.\nThis GDB was configured as \"i386-redhat-linux-gnu\"...Using host libthread_db library \"/lib/tls/libthread_db.so.1\".\n\n(gdb) b ssl_engine_init.c:63\nNo source file named ssl_engine_init.c.\nMake breakpoint pending on future shared library load? (y or [n]) y\nBreakpoint 1 (ssl_engine_init.c:63) pending.\n(gdb) run -X\nStarting program: /usr/local/apache/bin/httpd -X\n[Thread debugging using libthread_db enabled]\n[New Thread -1218512448 (LWP 7139)]\nBreakpoint 2 at 0x1539ea: file ssl_engine_init.c, line 63.\nPending breakpoint \"ssl_engine_init.c:63\" resolved\n[Fri Aug 15 21:41:56 2008] [warn] NameVirtualHost *:80 has no VirtualHosts\n[Switching to Thread -1218512448 (LWP 7139)]\n\nBreakpoint 2, ssl_init_SSLLibrary (s=0x83f8f20) at ssl_engine_init.c:63\n63          SSL_load_error_strings();\n(gdb) c\nContinuing.\nwarning: Temporarily disabling breakpoints for unloaded shared library \"/usr/local/apache/modules/mod_ssl.so\"\nBreakpoint 2 at 0x1569ea: file ssl_engine_init.c, line 63.\n\nBreakpoint 2, ssl_init_SSLLibrary (s=0x83f8848) at ssl_engine_init.c:63\n63          SSL_load_error_strings();\n(gdb) c\nContinuing.\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x0021fe2a in ERR_reason_error_string () from /lib/libcrypto.so.4\n(gdb) c\nContinuing.\n\nProgram terminated with signal SIGSEGV, Segmentation fault.\nThe program no longer exists.\n(gdb) quit\n\n----------------\n\n# gdb ./httpd\nGNU gdb Red Hat Linux (6.3.0.0-1.138.el3rh)\nCopyright 2004 Free Software Foundation, Inc.\nGDB is free software, covered by the GNU General Public License, and you are\nwelcome to change it and/or distribute copies of it under certain conditions.\nType \"show copying\" to see the conditions.\nThere is absolutely no warranty for GDB.  Type \"show warranty\" for details.\nThis GDB was configured as \"i386-redhat-linux-gnu\"...Using host libthread_db library \"/lib/tls/libthread_db.so.1\".\n\n(gdb) b ssl_engine_init.c:63\nNo source file named ssl_engine_init.c.\nMake breakpoint pending on future shared library load? (y or [n]) y\nBreakpoint 1 (ssl_engine_init.c:63) pending.\n(gdb) b ssl_engine_init.c:64\nNo source file named ssl_engine_init.c.\nMake breakpoint pending on future shared library load? (y or [n]) y\nBreakpoint 2 (ssl_engine_init.c:64) pending.\n(gdb) run -X\nStarting program: /usr/local/apache/bin/httpd -X\n[Thread debugging using libthread_db enabled]\n[New Thread -1218528832 (LWP 7222)]\nBreakpoint 3 at 0xb259ea: file ssl_engine_init.c, line 63.\nPending breakpoint \"ssl_engine_init.c:63\" resolved\nBreakpoint 4 at 0xb259f2: file ssl_engine_init.c, line 64.\nPending breakpoint \"ssl_engine_init.c:64\" resolved\n[Fri Aug 15 21:48:52 2008] [warn] NameVirtualHost *:80 has no VirtualHosts\n[Switching to Thread -1218528832 (LWP 7222)]\n\nBreakpoint 3, ssl_init_SSLLibrary (s=0x8130f20) at ssl_engine_init.c:63\n63          SSL_load_error_strings();\n(gdb) c\nContinuing.\n\nBreakpoint 4, ssl_init_SSLLibrary (s=0x8130f20) at ssl_engine_init.c:64\n64          SSL_library_init();\n(gdb) c\nContinuing.\nwarning: Temporarily disabling breakpoints for unloaded shared library \"/usr/local/apache/modules/mod_ssl.so\"\nBreakpoint 3 at 0xc519ea: file ssl_engine_init.c, line 63.\nBreakpoint 4 at 0xc519f2: file ssl_engine_init.c, line 64.\n\nBreakpoint 3, ssl_init_SSLLibrary (s=0x8130848) at ssl_engine_init.c:63\n63          SSL_load_error_strings();\n(gdb) c\nContinuing.\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x00e81e2a in ERR_reason_error_string () from /lib/libcrypto.so.4\n(gdb) c\nContinuing.\n\nProgram terminated with signal SIGSEGV, Segmentation fault.\nThe program no longer exists.\n(gdb) quit\n"}, {"count": 9, "tags": [], "bug_id": 45559, "attachment_id": null, "id": 119868, "time": "2008-08-15T17:04:15Z", "creator": "wrowe@apache.org", "creation_time": "2008-08-15T17:04:15Z", "is_private": false, "text": "I thought this looked familiar, thanks for testing.\n\nEither upgrade to the current OpenSSL, or hound redhat for a \"patched\" update\nto their one-off release of OpenSSL.  Either way, this is not an httpd issue.\n\n"}]