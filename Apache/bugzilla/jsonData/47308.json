[{"count": 0, "attachment_id": null, "bug_id": 47308, "is_private": false, "id": 127583, "time": "2009-06-03T03:39:06Z", "creator": "fujino.keiichi@oss.ntt.co.jp", "creation_time": "2009-06-03T03:39:06Z", "tags": [], "text": "I use Tomcat6.0.20.\n\nThe fix of Revision 757582(http://svn.apache.org/viewvc?view=rev&revision=757582)\nis applied to Tomcat6.0.20. \nThis fix means that Tomcat6.0.20 always disabled LoopbackMode.\n\nTherefore, it is not possible to join in the membership \nwhen the cluster is composed of two or more Tomcat on the same machine. \n\nI think that options for loopbackMode is better.\n\nI made patch.\n\nMcastService's patch.\n\nIndex: java/org/apache/catalina/tribes/membership/McastService.java\n===================================================================\n--- java/org/apache/catalina/tribes/membership/McastService.java\t(revision 763870)\n+++ java/org/apache/catalina/tribes/membership/McastService.java\t(working copy)\n@@ -230,6 +230,9 @@\n         properties.setProperty(\"recoverySleepTime\", String.valueOf(recoverySleepTime));\n     }\n \n+    public void setLocalLoopbackDisabled(boolean localLoopbackDisabled) {\n+        properties.setProperty(\"localLoopbackDisabled\", String.valueOf(localLoopbackDisabled));\n+    }\n \n     /**\n      * @deprecated use getPort()\n@@ -360,7 +363,8 @@\n                                     java.net.InetAddress.getByName(properties.getProperty(\"mcastAddress\")),\n                                     ttl,\n                                     soTimeout,\n-                                    this);\n+                                    this,\n+                                    Boolean.valueOf(properties.getProperty(\"localLoopbackDisabled\",\"true\")).booleanValue());\n         String value = properties.getProperty(\"recoveryEnabled\",\"true\");\n         boolean recEnabled = Boolean.valueOf(value).booleanValue() ;\n         impl.setRecoveryEnabled(recEnabled);        \n\n\n\nMcastServiceImpl's patch.\n\n\nIndex: java/org/apache/catalina/tribes/membership/McastServiceImpl.java\n===================================================================\n--- java/org/apache/catalina/tribes/membership/McastServiceImpl.java\t(revision 763870)\n+++ java/org/apache/catalina/tribes/membership/McastServiceImpl.java\t(working copy)\n@@ -135,7 +135,13 @@\n      * Add the ability to turn on/off recovery\n      */\n     protected boolean recoveryEnabled = true;\n+\n     /**\n+     * disable/enable local loopback message\n+     */\n+    protected boolean localLoopbackDisabled = true;\n+\n+    /**\n      * Create a new mcast service impl\n      * @param member - the local member\n      * @param sendFrequency - the time (ms) in between pings sent out\n@@ -144,6 +150,7 @@\n      * @param bind - the bind address (not sure this is used yet)\n      * @param mcastAddress - the mcast address\n      * @param service - the callback service\n+     * @param disableLoopbackMode - disable loopbackMode\n      * @throws IOException\n      */\n     public McastServiceImpl(\n@@ -155,7 +162,8 @@\n         InetAddress mcastAddress,\n         int ttl,\n         int soTimeout,\n-        MembershipListener service)\n+        MembershipListener service,\n+        boolean localLoopbackDisabled)\n     throws IOException {\n         this.member = member;\n         this.address = mcastAddress;\n@@ -166,6 +174,7 @@\n         this.timeToExpiration = expireTime;\n         this.service = service;\n         this.sendFrequency = sendFrequency;\n+        this.localLoopbackDisabled = localLoopbackDisabled;\n         init();\n     }\n \n@@ -199,7 +208,7 @@\n         } else {\n             socket = new MulticastSocket(port);\n         }\n-        socket.setLoopbackMode(true); //hint that we don't need loop back messages\n+        socket.setLoopbackMode(localLoopbackDisabled); //hint that we don't need loop back messages\n         if (mcastBindAddress != null) {\n\n\n\n\nAnd the localLoopbackDisabled attribute is specified for < Membership > of server.xml. \n\nexample.\n<Membership className=\"org.apache.catalina.tribes.membership.McastService\"\n     --another attribute-- \n     localLoopbackDisabled=\"false\" />\n\nRegards."}, {"count": 1, "tags": [], "creator": "fhanik@apache.org", "attachment_id": null, "text": "This is correct, we will revert the previous patch\nThanks for the report", "id": 127587, "time": "2009-06-03T05:44:19Z", "bug_id": 47308, "creation_time": "2009-06-03T05:44:19Z", "is_private": false}, {"count": 2, "tags": [], "creator": "fhanik@apache.org", "text": "Fixed in trunk, simple revert of previous commit proposed for 6.0 to go back to previous behavior", "id": 128061, "time": "2009-06-18T10:02:35Z", "bug_id": 47308, "creation_time": "2009-06-18T10:02:35Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "text": "*** Bug 47419 has been marked as a duplicate of this bug. ***", "is_private": false, "bug_id": 47308, "id": 128251, "time": "2009-06-24T15:31:30Z", "creator": "markt@apache.org", "creation_time": "2009-06-24T15:31:30Z", "attachment_id": null}]