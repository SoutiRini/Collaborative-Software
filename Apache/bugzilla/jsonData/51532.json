[{"count": 0, "tags": [], "creator": "rstoski@haesoft.com", "text": "Migrating from Tomcat 6.0.29 to 7.0.19 a large performance hit was noticed on pages containing lots of custom tags. Page rendering time jumped by an order of magnitude.\n\nProfiling the webapp through Netbeans, we narrowed down the problem to the getJarFile() method inside org.apache.jasper.compiler.ParseController. Screenshots of the Profiler Hotspots and Call Tree from both versions of Tomcat are available here: http://imgur.com/a/ZmeWM\n\nThe URL path used to load the JAR file has changed from Tomcat 6. Below are the values as output by the debugger:\nTomcat 6: \"file:/C:/svn/[PATH_TO_PROJECT]/server/target/snapshot/WEB-INF/lib/[OUR_JAR].jar!/\"\nTomcat 7: \"jndi:/localhost/snapshot/WEB-INF/lib/[OUR_JAR].jar!/\"\n\nA comparison of the getJarFile() methods shows few differences aside from the URL path that could contribute to the problem:\nTomcat 7: org.apache.jasper.compiler.JarURLResource\npublic JarFile getJarFile() throws IOException {\n    URL jarFileUrl = new URL(\"jar:\" + jarUrl + \"!/\");\n    JarURLConnection conn = (JarURLConnection) jarFileUrl.openConnection();\n    conn.setUseCaches(false);\n    conn.connect();\n    return conn.getJarFile();\n}\n\nTomcat 6: org.apache.japser.compiler.ParserController\nprivate JarFile getJarFile(URL jarFileUrl) throws IOException {\n    JarFile jarFile = null;\n\n    if (jarFileUrl != null) {\n        JarURLConnection conn = (JarURLConnection) jarFileUrl.openConnection();\n        conn.setUseCaches(false);\n        conn.connect();\n        jarFile = conn.getJarFile();\n    }\n\n    return jarFile;\n}", "id": 148021, "time": "2011-07-19T21:47:15Z", "bug_id": 51532, "creation_time": "2011-07-19T21:47:15Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 51532, "text": "For reference, thread on @users before opening this issue:\nhttp://tomcat.markmail.org/thread/ol7lvks3ex4xikp5\nhttp://marc.info/?t=131110739400005&r=1&w=2", "id": 148022, "time": "2011-07-19T22:18:17Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2011-07-19T22:18:17Z", "is_private": false, "attachment_id": null}, {"count": 2, "attachment_id": null, "creator": "markt@apache.org", "is_private": false, "id": 148046, "time": "2011-07-20T19:41:30Z", "bug_id": 51532, "creation_time": "2011-07-20T19:41:30Z", "tags": [], "text": "There is a problem with the handling of dependencies in JARs that causes JSPs with dependencies in JAR files to be recompiled on every access. I didn't check if it was as a result of the dependency changes or the JAR performance changes. Either way, it was almost certainly my fault.\n\nI have fixed this in 7.0.x and it will be in 7.0.20 onwards. If you are willing to build Tomcat from svn (simple to do - ask on the users list if you need pointers) and confirm that this fixes the issue for you that would be very useful."}, {"count": 3, "tags": [], "creator": "rstoski@haesoft.com", "text": "I've redeployed our webapps against a build of trunk (revision 1148915). JSPs appear to be caching properly and long access times on initial requests for JSPs has been resolved as well.\n\nThanks!", "id": 148049, "time": "2011-07-20T21:44:37Z", "bug_id": 51532, "creation_time": "2011-07-20T21:44:37Z", "is_private": false, "attachment_id": null}]