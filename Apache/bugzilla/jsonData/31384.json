[{"attachment_id": null, "tags": [], "creator": "marc.stern@approach.be", "is_private": false, "count": 0, "id": 64096, "time": "2004-09-23T09:55:21Z", "bug_id": 31384, "creation_time": "2004-09-23T09:55:21Z", "text": "The environment variables created by modssl are not passed back to a forward\nrequest. This prevent to retrieve the user's certificate when Apache is used as\nreverse proxy. This is a major issue for user's authentication.\n\nPatch:\n\ndiff -aur httpd-2.0.49/modules/metadata/mod_headers.c\nhttpd-ocsp/modules/metadata/mod_headers.c\n--- httpd-2.0.49/modules/metadata/mod_headers.c\t2004-02-09 21:53:19.000000000 +0100\n+++ httpd-ocsp/modules/metadata/mod_headers.c\t2004-08-13 12:10:45.000000000 +0200\n@@ -70,6 +70,7 @@\n #include \"apr_hash.h\"\n #define APR_WANT_STRFUNC\n #include \"apr_want.h\"\n+#include \"apr_optional.h\"\n \n #include \"httpd.h\"\n #include \"http_config.h\"\n@@ -128,6 +129,14 @@\n     apr_array_header_t *fixup_out;\n } headers_conf;\n \n+/* Pointer to ssl_var_lookup, if available. */\n+APR_DECLARE_OPTIONAL_FN(char *, ssl_var_lookup,\n+                        (apr_pool_t *, server_rec *,\n+                         conn_rec *, request_rec *,\n+                         char *));\n+static APR_OPTIONAL_FN_TYPE(ssl_var_lookup) *header_ssl_lookup = NULL;\n+\n+\n module AP_MODULE_DECLARE_DATA headers_module;\n \n /*\n@@ -146,9 +155,27 @@\n {\n     return apr_psprintf(r->pool, \"t=%\" APR_TIME_T_FMT, r->request_time);\n }\n+/* to also get the variables from mod_ssl */\n+static const char *header_request_ssl_var(request_rec *r, char *name)\n+{\n+    const char *val;\n+\n+    ap_log_error( APLOG_MARK, APLOG_DEBUG, 0, r->server, \"Getting env. var.\n'%s' from mod_sll\", name );\n+\n+    if ( !header_ssl_lookup) return NULL;\n+\n+    val = header_ssl_lookup(r->pool, r->server, r->connection, r, name);\n+    if ( !val || !val[0] ) return NULL;\n+    \n+    ap_log_error( APLOG_MARK, APLOG_DEBUG, 0, r->server, \"Getting env. var.\nfrom mod_sll: '%s'='%s'\", name, val );\n+\n+    return val;\n+}\n static const char *header_request_env_var(request_rec *r, char *a)\n {\n     const char *s = apr_table_get(r->subprocess_env,a);\n+    /* to also get the variables from mod_ssl */\n+    if ( !s ) s = header_request_ssl_var(r, a);\n \n     if (s)\n         return s;\n@@ -573,9 +600,18 @@\n     return OK;\n }\n \n+/* to also get the variables from mod_ssl */\n+static int header_post_config(apr_pool_t *pconf, apr_pool_t *plog,\n+                              apr_pool_t *ptemp, server_rec *s)\n+{\n+    header_ssl_lookup = APR_RETRIEVE_OPTIONAL_FN(ssl_var_lookup);\n+    return OK;\n+}\n+\n static void register_hooks(apr_pool_t *p)\n {\n     ap_hook_pre_config(header_pre_config,NULL,NULL,APR_HOOK_MIDDLE);\n+    ap_hook_post_config(header_post_config,NULL,NULL,APR_HOOK_MIDDLE); /* to\nalso get the variables from mod_ssl */\n     ap_hook_insert_filter(ap_headers_insert_output_filter, NULL, NULL,\nAPR_HOOK_LAST);\n     ap_hook_fixups(ap_headers_fixup, NULL, NULL, APR_HOOK_LAST);\n     ap_register_output_filter(\"FIXUP_HEADERS_OUT\", ap_headers_output_filter,"}, {"count": 1, "tags": [], "bug_id": 31384, "attachment_id": null, "is_private": false, "id": 64098, "time": "2004-09-23T10:11:10Z", "creator": "jorton@redhat.com", "creation_time": "2004-09-23T10:11:10Z", "text": "This is already done on HEAD:\n\nhttp://cvs.apache.org/viewcvs.cgi/httpd-2.0/modules/metadata/mod_headers.c?r1=1.49&r2=1.50\n\nand is pending some tweaks for inclusion in 2.0."}]