[{"text": "We seem to have found a case where 2 clicks from a browser cause 3 requests to \nbe processed by the servlet.  The steps to reproduce are:\n- Set up the servlet and JSP files as below\n- Start with the HTML file\n- Click the Submit button once, wait 1 second (first request will not be \ncomplete) and then click it again\n- You'll see 2 requests (correct) in the Apache log and 3 requests (incorrect) \nprocessed in catalina.out\n\nWe found this while doing some debugging on our application.  This was done on \na Solaris Intel machine running Apache 2.0.48 and the 2.0.4 JK connectors using \nthe CoyoteConnector config in server.xml.\n\nA couple of things that seem to be necessary for this:\n- The flush must be set to true in the jsp:include directive\n- There must be some kind of output in the including page before the include \ndirective\n\nLog I captured -> request 3 seems to be spawned after request 1 completes\n---------------\nWebappClassLoader:   Resource '/WEB-\nINF/classes/ServletJSPForwardAndIncludeTest.class' was modified; Date is now: \nFri Oct 15 21:33:15 EDT 2004 Was: Fri Oct 15 20:42:29 EDT 2004\nRequest: org.apache.coyote.tomcat4.CoyoteRequestFacade@c03865 reqNum=1: Start\nRequest: org.apache.coyote.tomcat4.CoyoteRequestFacade@c03865 reqNum=1: Sleep\nRequest: org.apache.coyote.tomcat4.CoyoteRequestFacade@1b69954 reqNum=2: Start\nRequest: org.apache.coyote.tomcat4.CoyoteRequestFacade@1b69954 reqNum=2: Forward\nRequest: org.apache.coyote.tomcat4.CoyoteRequestFacade@1b69954 reqNum=2: Finish\nRequest: org.apache.coyote.tomcat4.CoyoteRequestFacade@c03865 reqNum=1: Forward\nRequest: org.apache.coyote.tomcat4.CoyoteRequestFacade@c03865 reqNum=1: Finish\nRequest: org.apache.coyote.tomcat4.CoyoteRequestFacade@da416 reqNum=3: Start\nRequest: org.apache.coyote.tomcat4.CoyoteRequestFacade@da416 reqNum=3: Sleep\nRequest: org.apache.coyote.tomcat4.CoyoteRequestFacade@da416 reqNum=3: Forward\nRequest: org.apache.coyote.tomcat4.CoyoteRequestFacade@da416 reqNum=3: Finish\nOct 15, 2004 9:33:53 PM org.apache.jk.server.JkCoyoteHandler action\nSEVERE: Error in action code \njava.net.SocketException: Broken pipe\n        at java.net.SocketOutputStream.socketWrite0(Native Method)\n        at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:92)\n        at java.net.SocketOutputStream.write(SocketOutputStream.java:136)\n        at org.apache.jk.common.ChannelSocket.send(ChannelSocket.java:457)\n        at org.apache.jk.common.ChannelSocket.invoke(ChannelSocket.java:654)\n        at org.apache.jk.server.JkCoyoteHandler.action(JkCoyoteHandler.java:472)\n        at org.apache.coyote.Response.action(Response.java:226)\n        at org.apache.coyote.Response.finish(Response.java:348)\n        at org.apache.coyote.tomcat4.OutputBuffer.close(OutputBuffer.java:324)\n        at org.apache.coyote.tomcat4.CoyoteResponse.finishResponse\n(CoyoteResponse.java:486)\n        at org.apache.coyote.tomcat4.CoyoteAdapter.service\n(CoyoteAdapter.java:200)\n        at org.apache.jk.server.JkCoyoteHandler.invoke(JkCoyoteHandler.java:324)\n        at org.apache.jk.common.HandlerRequest.invoke(HandlerRequest.java:395)\n        at org.apache.jk.common.ChannelSocket.invoke(ChannelSocket.java:673)\n        at org.apache.jk.common.ChannelSocket.processConnection\n(ChannelSocket.java:615)\n        at org.apache.jk.common.SocketConnection.runIt(ChannelSocket.java:786)\n        at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run\n(ThreadPool.java:683)\n        at java.lang.Thread.run(Thread.java:534)\nOct 15, 2004 9:33:53 PM org.apache.jk.server.JkCoyoteHandler action\nSEVERE: Error in action code \njava.net.SocketException: Broken pipe\n        at java.net.SocketOutputStream.socketWrite0(Native Method)\n        at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:92)\n        at java.net.SocketOutputStream.write(SocketOutputStream.java:136)\n        at org.apache.jk.common.ChannelSocket.send(ChannelSocket.java:457)\n        at org.apache.jk.common.ChannelSocket.invoke(ChannelSocket.java:654)\n        at org.apache.jk.server.JkCoyoteHandler.action(JkCoyoteHandler.java:472)\n        at org.apache.coyote.Response.action(Response.java:226)\n        at org.apache.coyote.Response.finish(Response.java:348)\n        at org.apache.jk.server.JkCoyoteHandler.invoke(JkCoyoteHandler.java:329)\n        at org.apache.jk.common.HandlerRequest.invoke(HandlerRequest.java:395)\n        at org.apache.jk.common.ChannelSocket.invoke(ChannelSocket.java:673)\n        at org.apache.jk.common.ChannelSocket.processConnection\n(ChannelSocket.java:615)\n        at org.apache.jk.common.SocketConnection.runIt(ChannelSocket.java:786)\n        at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run\n(ThreadPool.java:683)\n        at java.lang.Thread.run(Thread.java:534)\n\nServletJSPForwardAndIncludeTest  \n---------------\n/*\n * Created on Oct 15, 2004\n */\n\nimport java.io.*;\nimport javax.servlet.*;\nimport javax.servlet.http.*;\n\n/**\n * @author rbaily\n */\npublic class ServletJSPForwardAndIncludeTest  extends HttpServlet {\n\tstatic int requestNum = 0;\n\n\tpublic void doGet(HttpServletRequest req, HttpServletResponse res)\n\tthrows ServletException, IOException\n\t{\n\t\tdoPost(req, res);\n\t}\n\t\n\tpublic void doPost(HttpServletRequest req, HttpServletResponse res)\n\tthrows ServletException, IOException\n\t{\n\t\trequestNum += 1;\n\t\tint myReq = requestNum;\n\t\tString id = \"Request: \" + req.toString() + \" reqNum=\" + myReq \n+ \": \";\n\t\tSystem.out.println( id + \"Start\" );\n\t\tif (myReq % 2 == 1) {\n\t\t\t\tSystem.out.println( id + \"Sleep\" );\n\t\t\t\ttry {\n\t\t\t\t\tThread.sleep( 5000 );\n\t\t\t\t} catch (InterruptedException e) {\n\t\t\t\t\tSystem.out.println( id \n+ \"Interrupted\" );\n\t\t\t\t}\n\t\t}\n\t\tString page = \"/includes_file.jsp\";\n\t\tRequestDispatcher rd = getServletContext().getRequestDispatcher\n(page);\n\t\tSystem.out.println( id + \"Forward\" );\n\t\trd.forward( req, res );\n\t\tSystem.out.println( id + \"Finish\" );\n\t}\n}\n\nincludes_file.jsp\n---------------\nThere has to be text above the included file\n<jsp:include page=\"included_file.jsp\" flush=\"true\" />\nThis is the file that includes another one\n\nincluded_file.jsp\n---------------\nThis is the included file\n\ninclude_test.html\n---------------\n<form action=\"servlet/ServletJSPForwardAndIncludeTest\">\n<input type=submit value=\"Submit\">\n</form>", "tags": [], "bug_id": 31741, "is_private": false, "count": 0, "id": 65220, "time": "2004-10-16T01:57:25Z", "creator": "rbaily@servicebench.com", "creation_time": "2004-10-16T01:57:25Z", "attachment_id": null}, {"text": "This does not seem to be an issue in Tomcat 5.0.28.  The output I got is below \nand seems to be correct.\n----------\nRequest: org.apache.coyote.tomcat5.CoyoteRequestFacade@29ac reqNum=1: Start\nRequest: org.apache.coyote.tomcat5.CoyoteRequestFacade@29ac reqNum=1: Sleep\nRequest: org.apache.coyote.tomcat5.CoyoteRequestFacade@b0095d reqNum=2: Start\nRequest: org.apache.coyote.tomcat5.CoyoteRequestFacade@b0095d reqNum=2: Forward\nRequest: org.apache.coyote.tomcat5.CoyoteRequestFacade@b0095d reqNum=2: Finish\nRequest: org.apache.coyote.tomcat5.CoyoteRequestFacade@29ac reqNum=1: Forward\nRequest: org.apache.coyote.tomcat5.CoyoteRequestFacade@29ac reqNum=1: Finish", "tags": [], "bug_id": 31741, "is_private": false, "count": 1, "id": 65298, "time": "2004-10-19T04:13:53Z", "creator": "rbaily@servicebench.com", "creation_time": "2004-10-19T04:13:53Z", "attachment_id": null}, {"count": 2, "tags": [], "text": "This works as expected if tested directly with Tomcat 4.1.x from CVS HEAD (no\nApache).\n\nEither this is a Tomcat 4 bug that has been fixed in 4.1.31 or a JK2 bug. I\nsuspect that a JK2 bug is most likely. However, JK2 is no longer supported (see\ntext below so i am marking this as WONTFIX).\n\nJK2 Support Information follows:\n\nAs of November 15, 2004, JK2 is no longer supported. All bugs related to JK2 \nwill be marked as WONTFIX. In its place, some of its features have been \nbackported to jk1. Most of those features will be seen in 1.2.7, which is \nslated for release on November 30th, 2004.\n\nAnother alternative is the ajp addition to mod_proxy which will be part of \napache 2.\n\nFor more information on the Tomat connectors docs at\nhttp://jakarta.apache.org/tomcat/connectors-doc/", "is_private": false, "bug_id": 31741, "id": 69130, "time": "2005-01-01T20:38:52Z", "creator": "markt@apache.org", "creation_time": "2005-01-01T20:38:52Z", "attachment_id": null}]