[{"count": 0, "tags": [], "creator": "matt@warnertechnology.com", "text": "If an HTTP request is split into two packets and, due to network congestion (or\nanything else), the second packet arrives significantly later than the first (5\nor more seconds), we have a situation where Apache tries to send data down a\nclosed connection. This happens because Apache first parses the HTTP header,\nthen opens a connection to the backend server (without sending any data), then\nparses the HTTP body, and then tries to send everything at once to the backend\nserver.\n\nWhen the delay between HTTP header and HTTP body exceeds the timeout of the\nbackend server (5 seconds in my case), the backend server closes the connection.\nWhen Apache sends the data to the backend server, it gets a reset from the app\nserver, which results in a 502 error being sent back to the web browser.\n\nPer the truss output, below, you can see that the header is processed, the\nconnection is opened, and then the body is parsed. After that, the data is sent\nto the backend server (unsuccessfully).\n\nEither mod_proxy should wait to open the connection to the backend server until\nafter it's processed the body, or Apache should at least check the state of the\nconnection before sending data. Or maybe if it gets a reset, it tries again.\n\n** NOTE INCOMING POST FROM CLIEN\n2030/24:\t 0.0006\tread(61, \" P O S T   /<OMITTED>\".., 8000)\t= 128\n2030/24:\t 0.0006\tpollsys(0xFFFFFFFF6B7FB6A8, 1, 0xFFFFFFFF6B7FB5E0, 0x00000000) = 1\n2030/24:\t\tfd=61 ev=POLLIN rev=POLLIN\n2030/24:\t\ttimeout: 300.000000000 sec\n2030/24:\t 0.0005\tread(61, \" H o s t :   <OMITTED>\".., 8000)\t= 177\n2030/24:\t 0.6335\tpollsys(0xFFFFFFFF6B7FB6A8, 1, 0xFFFFFFFF6B7FB5E0, 0x00000000) = 1\n2030/24:\t\tfd=61 ev=POLLIN rev=POLLIN\n2030/24:\t\ttimeout: 300.000000000 sec\n2030/24:\t 0.0005\tread(61, \"\\r\\n\", 8000)\t\t\t\t= 2\n2030/24:\t 0.0117\topen(\"/dev/udp\", O_RDONLY)\t\t\t= 62\n2030/24:\t 0.0005\tioctl(62, SIOCGLIFNUM, 0xFFFFFFFF6B7FB174)\t= 0\n2030/24:\t 0.0003\tclose(62)\t\t\t\t\t= 0\n2030/24:\t 0.0007\topen(\"/etc/default/nss\", O_RDONLY|O_LARGEFILE)\t= 62\n2030/24:\t 0.0004\tfcntl(62, F_DUPFD, 0x00000100)\t\t\t= 256\n2030/24:\t 0.0002\tclose(62)\t\t\t\t\t= 0\n2030/24:\t 0.0002\tread(256, \" #   i d e n t\\t \" @ ( #\".., 1024)\t= 1024\n2030/24:\t 0.0002\tread(256, \" y   t h o s e\\n # f u n\".., 1024)\t= 211\n2030/24:\t 0.0004\tread(256, 0x10071B5C4, 1024)\t\t\t= 0\n2030/24:\t 0.0002\tclose(256)\t\t\t\t\t= 0\n2030/24:\t 0.0004\tso_socket(PF_INET, SOCK_STREAM, IPPROTO_TCP, \"\", SOV_DEFAULT) = 62\n2030/24:\t 0.0003\tsetsockopt(62, tcp, TCP_NODELAY, 0xFFFFFFFF6B7FB66C, 4,\nSOV_DEFAULT) = 0\n\n** NOW APACHE OPENS A CONNECTION TO THE BACKEND SERVER\n\n2030/24:\t 0.0003\tfcntl(62, F_GETFL)\t\t\t\t= 2\n2030/24:\t 0.0001\tfcntl(62, F_SETFL, FWRITE|FNONBLOCK)\t\t= 0\n2030/24:\t 0.0005\tconnect(62, 0x100310CA8, 16, SOV_DEFAULT)\tErr#150 EINPROGRESS\n2030/24:\t\tAF_INET  name = 10.10.5.10  port = 7929\n2030/24:\t 0.0067\tpollsys(0xFFFFFFFF6B7FB5A8, 1, 0xFFFFFFFF6B7FB4E0, 0x00000000) = 1\n2030/24:\t\tfd=62 ev=POLLOUT rev=POLLOUT\n2030/24:\t\ttimeout: 300.000000000 sec\n2030/24:\t 0.0003\tgetsockopt(62, SOL_SOCKET, SO_ERROR, 0xFFFFFFFF6B7FB668,\n0xFFFFFFFF6B7FB66C, SOV_DEFAULT) = 0\n2030/24:\t 0.0004\tgetsockname(62, 0x100310E48, 0x100310E28, SOV_DEFAULT) = 0\n2030/24:\t\tAF_INET  name = 10.10.4.10  port = 44706\n2030/24:\tpollsys(0xFFFFFFFF6B7FB338, 1, 0xFFFFFFFF6B7FB270, 0x00000000)\n(sleeping...)\n2030/24:\t\tfd=61 ev=POLLIN rev=0xFFFFB49C\n2030/24:\t\ttimeout: 300.000000000 sec\n\n** NOTE THE DELAY IN RECEIVING THE BODY: 14.49 SECONDS\n\n2030/24:\t14.4911\tpollsys(0xFFFFFFFF6B7FB338, 1, 0xFFFFFFFF6B7FB270, 0x00000000) = 1\n2030/24:\t\tfd=61 ev=POLLIN rev=POLLIN\n2030/24:\t\ttimeout: 300.000000000 sec\n\n** HERE'S THE BODY\n\n2030/24:\t 0.0005\tread(61, \" j _ u s e r n a m e = \".., 8000)\t= 52\n2030/24:\t 0.0009\twritev(62, 0xFFFFFFFF6B7FB650, 14)\t\t= 480\n\n** HERE'S WHERE APACHE TRIES TO WRITE TO THE BACKEND CONNECTION WHICH\n** HAS ALREADY EXPIRED AND CLOSED\n\n2030/24:\t\tiov_base = 0x1006FA5C0  iov_len = 38\n2030/24:\t   P O S T   /<SOME PATH. DELETED FOR THIS EXAMPLE>\n\n** THE BACKEND SERVER SENDS US A RESET\n\n2030/24:\t 0.0009\tread(62, 0x10071B0C8, 8000)\t\t\tErr#131 ECONNRESET\n\n** A PROXY ERROR IS THROWN BACK TO THE WEB BROWSER/CLIENT\n\n2030/24:\t 0.0007\twrite(28, 0xFFFFFFFF6B7F7680, 203)\t\t= 203\n2030/24:\t   [ T h u   O c t   1 1   1 4 : 3 3 : 0 3   2 0 0 7 ]   [ e r r o\n2030/24:\t   r ]   [ c l i e n t   1 0 . 1 0 . 4 . 1 0 ]   ( 1 3 1 ) C o n n\n2030/24:\t   e c t i o n   r e s e t   b y   p e e r :   p r o x y :   e r r\n2030/24:\t   o r   r e a d i n g   s t a t u s   l i n e   f r o m   r e m o\n2030/24:\t   t e   s e r v e r   XX ,   r e f e r e r :   SOMEURL\\n\n2030/24:\t 0.0006\twrite(28, 0xFFFFFFFF6B7F75A0, 184)\t\t= 184\n2030/24:\t   [ T h u   O c t   1 1   1 4 : 3 3 : 0 3   2 0 0 7 ]   [ e r r o\n2030/24:\t   r ]   [ c l i e n t   1 0 . 1 0 . 4 . 1 0 ]   p r o x y :   E r\n2030/24:\t   r o r   r e a d i n g   f r o m   r e m o t e   s e r v e r   r\n2030/24:\t   e t u r n e d   b y   A_URL,   r e f e r e r :   SOME_URL\\n\n2030/24:\t 0.0004\tclose(62)\t\t\t\t\t= 0\n2030/24:\t 0.0006\tbrk(0x10071FD60)\t\t\t\t= 0\n2030/24:\t 0.0002\tbrk(0x100723D60)\t\t\t\t= 0\n2030/24:\t 0.0006\twritev(61, 0xFFFFFFFF6B7FB930, 2)\t\t= 576\n2030/24:\t\tiov_base = 0x10071D0D8  iov_len = 154\n2030/24:\t   H T T P / 1 . 1   5 0 2   P r o x y   E r r o r\\r\\n D a t e :  \n2030/24:\t   T h u ,   1 1   O c t   2 0 0 7   2 1 : 3 2 : 4 7   G M T\\r\\n V\n2030/24:\t   a r y :   A c c e p t - E n c o d i n g\\r\\n C o n t e n t - L e\n2030/24:\t   n g t h :   4 2 2\\r\\n C o n t e n t - T y p e :   t e x t / h t\n2030/24:\t   m l ;   c h a r s e t = i s o - 8 8 5 9 - 1\\r\\n\\r\\n\n2030/24:\t\tiov_base = 0x10071B0C8  iov_len = 422\n2030/24:\t   < ! D O C T Y P E   H T M L   P U B L I C   \" - / / I E T F / /\n2030/24:\t   D T D   H T M L   2 . 0 / / E N \" >\\n < h t m l > < h e a d >\\n\n2030/24:\t   < t i t l e > 5 0 2   P r o x y   E r r o r < / t i t l e >\\n <\n2030/24:\t   / h e a d > < b o d y >\\n < h 1 > P r o x y   E r r o r < / h 1\n2030/24:\t   >\\n < p > T h e   p r o x y   s e r v e r   r e c e i v e d   a\n2030/24:\t   n   i n v a l i d\\r\\n r e s p o n s e   f r o m   a n   u p s t\n2030/24:\t   r e a m   s e r v e r . < b r   / >\\r\\n T h e   p r o x y   s e\n2030/24:\t   r v e r   c o u l d   n o t   h a n d l e   t h e   r e q u e s\n2030/24:\t   t   < e m > < a   h r e f = \"A_URL\" > P O S T & n b s p ; URL< / a >\n< / e m > . < p >\\n R e a s o n :   < s t\n2030/24:\t   r o n g > E r r o r   r e a d i n g   f r o m   r e m o t e   s\n2030/24:\t   e r v e r < / s t r o n g > < / p > < / p >\\n < / b o d y > < /\n2030/24:\t   h t m l >\\n", "id": 109284, "time": "2007-10-11T16:12:06Z", "bug_id": 43607, "creation_time": "2007-10-11T16:12:06Z", "is_private": false, "attachment_id": null}, {"count": 1, "attachment_id": 21565, "bug_id": 43607, "is_private": false, "id": 113901, "time": "2008-02-19T14:28:30Z", "creator": "nick@webthing.com", "creation_time": "2008-02-19T14:28:30Z", "tags": [], "text": "Created attachment 21565\nquick&dirty hack to try patching it\n\nCan you test-drive the attached patch (against 2.2.8) with\nSetEnv fix43607 1\nin your proxy's scope?\n\n(Don't try this on a server that matters.  This patch will want extensive\ncleaning if it works, and scrapping if it doesn't)"}, {"count": 2, "tags": [], "creator": "nick@webthing.com", "text": "marking NEEDINFO pending feedback", "id": 113902, "time": "2008-02-19T14:29:19Z", "bug_id": 43607, "creation_time": "2008-02-19T14:29:19Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "matt@warnertechnology.com", "text": "This was occurring in a production environment, so testing the patch will be a \nproblem. I will have to try to create a test environment and then duplicate the \npacket loss/retransmission scenario that first brought this to our attention. \nThat may not happen for a while.", "id": 113983, "time": "2008-02-21T14:11:31Z", "bug_id": 43607, "creation_time": "2008-02-21T14:11:31Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "nick@webthing.com", "is_private": false, "id": 113991, "creation_time": "2008-02-21T15:12:01Z", "time": "2008-02-21T15:12:01Z", "bug_id": 43607, "text": "OK, reverting to NEW, to maximise the chances of it getting attention from\nanyone (including you or me) who might take an interest.", "attachment_id": null}, {"count": 5, "tags": [], "creator": "nick@webthing.com", "text": "There are several recent proxy fixes that could affect this, including a race condition that got fixed in 2.2.10 (pr#37770).  Does this still exist in 2.2.11?", "id": 123712, "time": "2009-01-02T10:41:08Z", "bug_id": 43607, "creation_time": "2009-01-02T10:41:08Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "creator": "polarys@gmail.com", "text": "I can confirm that this bug still exists in 2.2.11.  We proxy requests to Jetty and under certain conditions, Jetty reduces the socket timeout for incoming connections to 2 seconds.  This means if a client (such as Apache) connects and does not send it any data within 2 seconds, it will close the socket.\n\nBy splitting an HTTP request into multiple packets (first packet contains HTTP headers and part of the POST body, second packet contains the rest of POST body), and making sure there is more than 2 seconds delay between the two packets, Apache/mod_prozy will always return a 502 response (and the request is never sent to Jetty).", "id": 129572, "time": "2009-08-07T15:47:49Z", "bug_id": 43607, "creation_time": "2009-08-07T15:47:49Z", "is_private": false, "attachment_id": null}]