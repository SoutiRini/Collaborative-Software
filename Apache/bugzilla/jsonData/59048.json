[{"count": 0, "tags": [], "bug_id": 59048, "attachment_id": null, "text": "POI version 3.12 works OK. \nBut 3.13 and 3.14-beta1 gives the same failure\n\njava.lang.ClassCastException: org.apache.poi.openxml4j.util.ZipSecureFile$ThresholdInputStream cannot be cast to java.util.zip.ZipFile$RAFStream\n\n\n---- \nThe error occurs every time we try to open simple excel files (xlsx, created with MS Excel)\nThe app runs on Android 5.1.1, Samsung Galaxy Note (SM-P605).\nDeveloped with Android Studio 2.0, beta 5, targetSdkVersion 22, minSdkVersion 21.\n\nIt is a little bit tricky to get POI to run on Android since Android lacks the package javax.xml.stream/**\nThe following project is very similar to how we have succeeded. https://github.com/andruhon/android5xlsx\n\n\nWe have been using POI 3.11 with the same excel files for a while on Android 4 as well without problems.\n----\nThe class org.apache.poi.openxml4j.util.ZipSecureFile seems to have been introduced for bugfix 50090 - 'zip' bomb prevention.\n---\nThe row number mentioned in the Android Studio logcat window, does not seem to indicate correct line numbers in ZipSecureFile.java compared to \nhttps://svn.apache.org/viewvc/poi/trunk/src/ooxml/java/org/apache/poi/openxml4j/util/ZipSecureFile.java?view=markup&pathrev=1687148\n\nIt's in a read statement that the exception occurs, but the latest test (with POI 3.14-beta1 indicates ZipSecureFile.java:208 and earlier tests with 3.13 indicates ZipSecureFile.java:162. \nSee the logs below.\n\n\n/Mats\n\n----\nLogs (when testing with POI version 3.14-beta1)\njava.lang.RuntimeException: An error occured while executing doInBackground()\n    at android.os.AsyncTask$3.done(AsyncTask.java:304)\n    at java.util.concurrent.FutureTask.finishCompletion(FutureTask.java:355)\n    at java.util.concurrent.FutureTask.setException(FutureTask.java:222)\n    at java.util.concurrent.FutureTask.run(FutureTask.java:242)\n    at android.os.AsyncTask$SerialExecutor$1.run(AsyncTask.java:231)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1112)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:587)\n    at java.lang.Thread.run(Thread.java:818)\n Caused by: java.lang.ClassCastException: org.apache.poi.openxml4j.util.ZipSecureFile$ThresholdInputStream cannot be cast to java.util.zip.ZipFile$RAFStream\n    at java.util.zip.InflaterInputStream.fill(InflaterInputStream.java:191)\n    at java.util.zip.InflaterInputStream.read(InflaterInputStream.java:153)\n    at java.util.zip.ZipFile$ZipInflaterInputStream.read(ZipFile.java:538)\n    at libcore.io.Streams.readSingleByte(Streams.java:41)\n    at java.util.zip.InflaterInputStream.read(InflaterInputStream.java:130)\n    at org.apache.poi.openxml4j.util.ZipSecureFile$ThresholdInputStream.read(ZipSecureFile.java:208)\n    at org.kxml2.io.KXmlParser.setInput(KXmlParser.java:1642)\n    at org.apache.harmony.xml.parsers.DocumentBuilderImpl.parse(DocumentBuilderImpl.java:111)\n    at javax.xml.parsers.DocumentBuilder.parse(DocumentBuilder.java:107)\n    at org.apache.poi.util.DocumentHelper.readDocument(DocumentHelper.java:96)\n    at org.apache.poi.openxml4j.opc.internal.ContentTypeManager.parseContentTypesFile(ContentTypeManager.java:377)\n    at org.apache.poi.openxml4j.opc.internal.ContentTypeManager.<init>(ContentTypeManager.java:103)\n    at org.apache.poi.openxml4j.opc.internal.ZipContentTypeManager.<init>(ZipContentTypeManager.java:54)\n    at org.apache.poi.openxml4j.opc.ZipPackage.getPartsImpl(ZipPackage.java:190)\n    at org.apache.poi.openxml4j.opc.OPCPackage.getParts(OPCPackage.java:696)\n    at org.apache.poi.openxml4j.opc.OPCPackage.open(OPCPackage.java:259)\n    at org.apache.poi.ss.usermodel.WorkbookFactory.create(WorkbookFactory.java:284)\n    at org.apache.poi.ss.usermodel.WorkbookFactory.create(WorkbookFactory.java:252)\n    at org.apache.poi.ss.usermodel.WorkbookFactory.create(WorkbookFactory.java:231)\n\n-----\nLogs with POI 3.13.\n  java.lang.RuntimeException: An error occured while executing doInBackground()\n      at android.os.AsyncTask$3.done(AsyncTask.java:304)\n      at java.util.concurrent.FutureTask.finishCompletion(FutureTask.java:355)\n      at java.util.concurrent.FutureTask.setException(FutureTask.java:222)\n      at java.util.concurrent.FutureTask.run(FutureTask.java:242)\n      at android.os.AsyncTask$SerialExecutor$1.run(AsyncTask.java:231)\n      at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1112)\n      at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:587)\n      at java.lang.Thread.run(Thread.java:818)\n   Caused by: java.lang.ClassCastException: org.apache.poi.openxml4j.util.ZipSecureFile$ThresholdInputStream cannot be cast to java.util.zip.ZipFile$RAFStream\n      at java.util.zip.InflaterInputStream.fill(InflaterInputStream.java:191)\n      at java.util.zip.InflaterInputStream.read(InflaterInputStream.java:153)\n      at java.util.zip.ZipFile$ZipInflaterInputStream.read(ZipFile.java:538)\n      at libcore.io.Streams.readSingleByte(Streams.java:41)\n      at java.util.zip.InflaterInputStream.read(InflaterInputStream.java:130)\n      at org.apache.poi.openxml4j.util.ZipSecureFile$ThresholdInputStream.read(ZipSecureFile.java:162)\n      at org.kxml2.io.KXmlParser.setInput(KXmlParser.java:1642)\n      at org.apache.harmony.xml.parsers.DocumentBuilderImpl.parse(DocumentBuilderImpl.java:111)\n      at javax.xml.parsers.DocumentBuilder.parse(DocumentBuilder.java:107)\n      at org.apache.poi.util.DocumentHelper.readDocument(DocumentHelper.java:96)\n      at org.apache.poi.openxml4j.opc.internal.ContentTypeManager.parseContentTypesFile(ContentTypeManager.java:377)\n      at org.apache.poi.openxml4j.opc.internal.ContentTypeManager.<init>(ContentTypeManager.java:103)\n      at org.apache.poi.openxml4j.opc.internal.ZipContentTypeManager.<init>(ZipContentTypeManager.java:54)\n      at org.apache.poi.openxml4j.opc.ZipPackage.getPartsImpl(ZipPackage.java:190)\n      at org.apache.poi.openxml4j.opc.OPCPackage.getParts(OPCPackage.java:684)\n      at org.apache.poi.openxml4j.opc.OPCPackage.open(OPCPackage.java:254)\n      at org.apache.poi.ss.usermodel.WorkbookFactory.create(WorkbookFactory.java:282)\n      at org.apache.poi.ss.usermodel.WorkbookFactory.create(WorkbookFactory.java:250)\n      at org.apache.poi.ss.usermodel.WorkbookFactory.create(WorkbookFactory.java:229)", "id": 188694, "time": "2016-02-22T22:40:12Z", "creator": "mats@forsen.se", "creation_time": "2016-02-22T22:40:12Z", "is_private": false}, {"count": 1, "tags": [], "creator": "dominik.stadler@gmx.at", "attachment_id": null, "id": 191364, "time": "2016-06-01T19:57:14Z", "bug_id": 59048, "creation_time": "2016-06-01T19:57:14Z", "is_private": false, "text": "In order to test how POI can be used successfully on Android, I have created a sample project poi-on-android at https://github.com/centic9/poi-on-android which uses a different approach than https://github.com/andruhon/android5xlsx. It works by first building a shaded jar from a specific version of POI with all required dependencies included and some relocations being done to avoid errors because of javax....\n\nI then use this in an Android sample application to show that it can be used to do work on Excel documents. Basic creating, writing and reading .xlsx files works for me. \n\nCan you try this approach to see if this allows your use-case as well?\n\nYou can probably run the Gradle target \"shadowJar\" and then use the resulting file \"poishadow/build/libs/poishadow-all.jar\" in your application instead of your own built jars of POI."}, {"text": "No update for several months, therefore I am closing this as WORKSFORME now with the links to the sample project which provides a shadow-jar of POI which should be suitable for most actions an Android. Please report new bugs if it still does not work for you.", "tags": [], "bug_id": 59048, "attachment_id": null, "count": 2, "id": 194338, "time": "2016-10-11T19:36:57Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2016-10-11T19:36:57Z", "is_private": false}]