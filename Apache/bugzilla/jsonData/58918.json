[{"count": 0, "tags": [], "bug_id": 58918, "text": "I use a JNDI datasource and put the mysql Connector/J driver in the $CATALINA_HOME/lib. When I undeploy a web application, I got a warning:\n24-Jan-2016 20:26:52.254 WARNING [http-nio-8080-exec-5] org.apache.catalina.loader.WebappClassLoaderBase.clearReferencesThreads The web application [] appears to have started a thread named [Abandoned connection cleanup thread] but has failed to stop it. This is very likely to create a memory leak. Stack trace of thread:\n java.lang.Object.wait(Native Method)\n java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:143)\n com.mysql.jdbc.AbandonedConnectionCleanupThread.run(AbandonedConnectionCleanupThread.java:43)\n\nThe reason is that Tomcat didn't set the thread context ClassLoader before initializing JNDI datasources, so the mysql driver gets a WebappClassLoader as its context ClassLoader. And then the [Abandoned connection cleanup thread] (created by mysql Connector/J) keeps a reference of the WebappClassLoader. This causes a memory leak.\n\nThe suggest is to set the thread context ClassLoader to the container ClassLoader before initializing JNDI datasources. So they will get the container's ClassLoader as the context ClassLoader. Because JNDI datasources are global, they shouldn't be initialized with a ClassLoader of a webapp.\n\nI found a mailing list archive which tells the same bug: <https://mail-archives.apache.org/mod_mbox/tomcat-users/201305.mbox/%3C51A8C44D.8040509@christopherschultz.net%3E>.\n\nSorry for my English;)", "id": 187937, "time": "2016-01-24T13:43:46Z", "creator": "yushijinhun@gmail.com", "creation_time": "2016-01-24T13:43:46Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "text": "This is a (well known, long standing) MySQL bug.\n\nTomcat is correctly setting the thread context class loader to the web application class loader.\n\nMySQL is creating a thread without setting an appropriate class loader. Given the nature of the thread, it should set to the class loader used to load the AbandonedConnectionCleanupThread class.", "is_private": false, "id": 187939, "creator": "markt@apache.org", "time": "2016-01-24T14:10:28Z", "bug_id": 58918, "creation_time": "2016-01-24T14:10:28Z", "attachment_id": null}, {"count": 2, "attachment_id": null, "creator": "chris@christopherschultz.net", "text": "For reference:\n\nhttp://bugs.mysql.com/bug.php?id=65909\nhttp://bugs.mysql.com/bug.php?id=68556\nhttp://bugs.mysql.com/bug.php?id=69526\nhttp://bugs.mysql.com/bug.php?id=73876\n\nOracle seems determined not to fix this bug.", "id": 187976, "time": "2016-01-26T21:14:23Z", "bug_id": 58918, "creation_time": "2016-01-26T21:14:23Z", "tags": [], "is_private": false}]