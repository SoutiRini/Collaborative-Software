[{"count": 0, "tags": [], "bug_id": 26439, "attachment_id": null, "text": "I'm using a rewritemap directive on a front-end apache proxy to call a simple \nperl script to load balance across 4 back-end servers in a way similar to that \nsuggested in the apache.org rewrite guide.\n\nI've subjected the setup to high load (approx 70 transactions a second) and \nApache will proxy fine to the back-end servers for a while, then \nintermittently the back-end servers begin returning 404s because the rewritten \nURLs have been corrupted.  Then the URLs come good, then they go bad.  It's \nintermittent and ONLY under high loads (I'm using siege).  It sounds a little \nsimilar to case 25520, but in my case, the problem is more than just logging \nbecause the rewrite destinations don't recognize the rewritten corrupted URLs.\n\nI'm using the Worker MPM - I haven't tried anything else.  \u00cd build Apache from \nsource on a Redhat 9 SMP machine with all recent updates (including glibc) \napplied.\n\nI include below an example bad rewrite, the relevant rewrite directives and \nthe perl script in question.  I'm not an Apache hacker so sorry if this case \nis not technical enough.\n\nhttpd.conf\n===========\n\n<VirtualHost *:80>\n    ProxyVia On\n    RewriteEngine On\n    RewriteLog    /jrcapps/apache/apache/logs/rewrite.log\n    RewriteLogLevel 9\n    RewriteMap    lb      prg:/jrcapps/apache/apache/bin/loadbalance.pl\n    RewriteRule   /\n(.*)   /VirtualHostBase/http/139.191.42.53:80/VirtualHostRoot/$1\n    RewriteRule   ^/(.+)$ ${lb:$1}           [P,L]\n</VirtualHost>\n\n\nloadbalance.pl\n==============\n\n#!/usr/bin/perl\n##\n##  loadbalance.pl -- load balancing script\n##\n \n$| = 1;\n \n@names   = (\n                \"eejnet-zope1:8080\",\n                \"eejnet-zope2:8080\",\n                \"eejnet-zope1:8081\",\n                \"eejnet-zope2:8081\"\n        );\n \n$numserv = scalar(@names);\n \n$cnt = 0;\nwhile (<STDIN>) {\n    $cnt = (($cnt+1) % $numserv);\n    $server = $names[$cnt-1];\n    print \"http://$server/$_\";\n}\n\n##EOF##\n\n\nrewite.log example 1\n====================\n\n127.0.0.1 - - [26/Jan/2004:15:41:52 +0100] [localhost/sid#820a278]\n[rid#8243558/initial] (2) init rewrite engine with requested uri /\n\n(ok)\n\n127.0.0.1 - - [26/Jan/2004:15:41:52 +0100] [localhost/sid#820a278]\n[rid#8243558/initial] (3) applying pattern '/(.*)' to uri '/'\n\n(ok)\n\n127.0.0.1 - - [26/Jan/2004:15:41:52 +0100] [localhost/sid#820a278]\n[rid#8243558/initial] (2) rewrite / -\n> /VirtualHostBase/http/139.191.42.53:80/VirtualHostRoot/127.0.0.1 - - \n[26/Jan/2004:15:41:52 +0100] [localhost/sid#820a278][rid#8243558/initial] (3) \napplying pattern '^/(.+)$' to \nuri '/VirtualHostBase/http/139.191.42.53:80/VirtualHostRoot/'\n\n(ok)\n\n127.0.0.1 - - [26/Jan/2004:15:41:52 +0100] [localhost/sid#820a278]\n[rid#82695f0/initial] (5) map lookup OK: map=lb \nkey=VirtualHostBase/http/139.191.42.53:80/VirtualHostRoot/ -> \nval=http://eejnet-zope2:8081/VirtualHostBase/http/139.191.42.53:lotot\n\n(not ok)\n\n127.0.0.1 - - [26/Jan/2004:15:41:52 +0100] [localhost/sid#820a278]\n[rid#82695f0/initial] (2) \nrewrite /VirtualHostBase/http/139.191.42.53:80/VirtualHostRoot/ -> \nhttp://eejnet-zope2:8081/VirtualHostBase/http/139.191.42.53:lotot\n\n(not ok)\n\n127.0.0.1 - - [26/Jan/2004:15:41:52 +0100] [localhost/sid#820a278]\n[rid#82695f0/initial] (2) forcing proxy-throughput with http://eejnet-\nzope2:8081/VirtualHostBase/http/139.191.42.53:lotot\n\n(not ok)\n\n127.0.0.1 - - [26/Jan/2004:15:41:52 +0100] [localhost/sid#820a278]\n[rid#82695f0/initial] (1) go-ahead with proxy request proxy:http://eejnet-\nzope2:8081/VirtualHostBase/http/139.191.42.53:lotot [OK]\n\n\nrewite.log example 2\n====================\n\n127.0.0.1 - - [26/Jan/2004:15:41:51 +0100] [localhost/sid#820a278]\n[rid#82695f0/initial] (2) init rewrite engine with requested uri /\n\n(ok)\n\n127.0.0.1 - - [26/Jan/2004:15:41:51 +0100] [localhost/sid#820a278]\n[rid#82695f0/initial] (3) applying pattern '/(.*)' to uri '/'\n\n(ok)\n\n127.0.0.1 - - [26/Jan/2004:15:41:51 +0100] [localhost/sid#820a278]\n[rid#82695f0/initial] (2) rewrite / -\n> /VirtualHostBase/http/139.191.42.53:80/VirtualHostRoot/127.0.0.1 - - \n[26/Jan/2004:15:41:51 +0100] [localhost/sid#820a278][rid#82695f0/initial] (3) \napplying pattern '^/(.+)$' to \nuri '/VirtualHostBase/http/139.191.42.53:80/VirtualHostRoot/'\n\n(ok)\n\n127.0.0.1 - - [26/Jan/2004:15:41:51 +0100] [localhost/sid#820a278]\n[rid#82695f0/initial] (5) map lookup OK: map=lb \nkey=VirtualHostBase/http/139.191.42.53:80/VirtualHostRoot/ -> \nval=http://eejnet-zope1:8081/VirtualHostBase/http/139.191.42rulotot\n\n(not ok)\n\n127.0.0.1 - - [26/Jan/2004:15:41:51 +0100] [localhost/sid#820a278]\n[rid#82695f0/initial] (2) \nrewrite /VirtualHostBase/http/139.191.42.53:80/VirtualHostRoot/ -> \nhttp://eejnet-zope1:8081/VirtualHostBase/http/139.191.42rulotot\n\n(not ok)\n\n127.0.0.1 - - [26/Jan/2004:15:41:51 +0100] [localhost/sid#820a278]\n[rid#82695f0/initial] (2) forcing proxy-throughput with http://eejnet-\nzope1:8081/VirtualHostBase/http/139.191.42rulotot\n\n(not ok)\n\n127.0.0.1 - - [26/Jan/2004:15:41:51 +0100] [localhost/sid#820a278]\n[rid#82695f0/initial] (1) go-ahead with proxy request proxy:http://eejnet-\nzope1:8081/VirtualHostBase/http/139.191.42rulotot [OK]", "id": 51195, "time": "2004-01-26T16:20:13Z", "creator": "nick@nickbower.com", "creation_time": "2004-01-26T16:20:13Z", "is_private": false}, {"count": 1, "tags": [], "text": "I don't see a RewriteLock directive which, according to the documentation,\nis crucial in this situation.", "is_private": false, "id": 51202, "creator": "slive@apache.org", "time": "2004-01-26T18:16:54Z", "bug_id": 26439, "creation_time": "2004-01-26T18:16:54Z", "attachment_id": null}, {"count": 2, "attachment_id": null, "creator": "nick@nickbower.com", "text": "Argh - appologies as it is pretty clear in the mod_rewrite docs.  I'll try \nimplementing RewriteLock tomorrow and post an update.\n\nI should mention that in my defence though ;) the rewrite guide does provide \njust the following for the section \"Proxy Throughput Round Robin\" (under Load \nBalancing) so could maybe be ammended as it's where I lifted the example from.\n\nRewriteEngine on\nRewriteMap    lb      prg:/path/to/lb.pl\nRewriteRule   ^/(.+)$ ${lb:$1}           [P,L]\n", "id": 51209, "time": "2004-01-26T21:31:38Z", "bug_id": 26439, "creation_time": "2004-01-26T21:31:38Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 26439, "attachment_id": null, "text": "The implementation of RewriteLock fixed the problem.  Thanks.", "id": 51230, "time": "2004-01-27T08:11:04Z", "creator": "nick@nickbower.com", "creation_time": "2004-01-27T08:11:04Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 26439, "attachment_id": null, "id": 51238, "time": "2004-01-27T11:37:28Z", "creator": "nd@perlig.de", "creation_time": "2004-01-27T11:37:28Z", "is_private": false, "text": "I've added a warning (in 2.1) if external rewrite maps are used but no\nRewriteLock directive was configured.\n\nThanks for your feedback."}]