[{"count": 0, "tags": [], "bug_id": 59426, "attachment_id": null, "id": 190714, "time": "2016-05-04T05:46:56Z", "creator": "dbetz@df.eu", "creation_time": "2016-05-04T05:46:56Z", "is_private": false, "text": "I have an easy rewrite Rule, which rewrites everything to /index.php, when the filename or directory doesnt exist.\n\nRewriteEngine On\nRewriteBase /\nRewriteRule ^index\\.php$ - [L]\nRewriteCond %{REQUEST_FILENAME} !-f\nRewriteCond %{REQUEST_FILENAME} !-d\nRewriteRule . /index.php [L]\n\n\nSometimes and really random i become an bad request error 400 back.\nAfter debugging a litte bit i found, that there were changes made with the \"context docroot\"\n\nHere are the rewrite logs from an failed and from an working request:\nFAILED:\nrewrite '2014/tree/' -> '/index.php'\ntrying to replace prefix /www/471639_96450/gn2-hosting.de/host260161/host260155/danielbaer.eu/ with / trying to replace context docroot  with context prefix internal redirect with index.php [INTERNAL REDIRECT]\n\nWORKING:\nrewrite '2014/tree/' -> '/index.php'\ntrying to replace prefix /www/471639_96450/gn2-hosting.de/host260161/host260155/danielbaer.eu/ with / trying to replace context docroot \\xa0/\\xde\\v\\xd8/\\xde\\v\\x901\\xde\\v with context prefix internal redirect with /index.php [INTERNAL REDIRECT]\n\n\nIt doesnt work, when when ap_context_document_root(r) is empty, but not NULL.\nSometimes it gives me strange docroot folders back like \\xa0/\\xde\\v\\xd8/\\xde\\v\\x901\\xde\\v\n\nIn 2.4.19 ( i think ) a new option in mod_rewrite was added and i think there could be an error there:\n            /* No base URL, or r->filename wasn't still under dconf->directory\n             * or, r->filename wasn't still under the document root.\n             * If there's a context document root AND a context prefix, and\n             * the context document root is a prefix of r->filename, replace.\n             * This allows a relative substitution on a path found by mod_userdir\n             * or mod_alias without baking in a RewriteBase.\n             */\n            if (tmpfilename == r->filename &&\n                !(dconf->options & OPTION_IGNORE_CONTEXT_INFO)) {\n                if ((ccp = ap_context_document_root(r)) != NULL) {\n                    const char *prefix = ap_context_prefix(r);\n                    if (prefix != NULL) {\n                        rewritelog((r, 2, dconf->directory, \"trying to replace \"\n                                    \"context docroot %s with context prefix %s\",\n                                    ccp, prefix));\n                        r->filename = subst_prefix_path(r, r->filename,\n                                ccp, prefix);\n                    }\n                }\n            }\n\nAfter adding \"RewriteOptions IgnoreContextInfo\" the random errors are gone.\n\nThe setup is a little bit \"special\". I have an modified mod_vhost_ldap and mod_fastcgi.\nThe Documentroot, SuexecUserGroup, PHP Version, etc. comes from mod_vhost_ldap and switches the FastCGI Socket for every domain and php version in the VirtualHost.\n\nYesterday it failed in an bad request about 240 times from 150.000 requests.\nNot often, but often enough, so that our customers cry :)\n\nHeres the relevant part of my httpd.conf. mod_http2 isnt enabled, but i can give it an try\n\n<IfDefine FCGI>\n  LoadModule fastcgi_module     mod_fastcgi.so\n  LoadModule vhost_ldap_module  mod_vhost_ldap.so\n\n  LDAPSharedCacheSize 2000000\n  LDAPCacheEntries 4096\n  LDAPCacheTTL 5\n  LDAPOpCacheEntries 4096\n  LDAPOpCacheTTL 5\n\n  FastCgiExternalServer /etc/httpd/fastcgi/php-fcgi-starter -flush -socket /etc/httpd/fastcgi/php5-53LATEST -idle-timeout 3600\n  Action php-fastcgi /php/php-fcgi-starter\n\n\n</IfDefine>\n\n<VirtualHost IP:80>\n  ServerName server.hostname\n  SuexecUserGroup domcgi nobody\n  DocumentRoot /kunden/shadow/htdocs/\n\n   ScriptAlias /php/ /etc/httpd/fastcgi/\n\n    VhostLDAPEnabled on\n    VhostLDAPUrl \"ldap://localhost/sid=2542,sec=hosting,o=xxxxx,c=de\"\n    VhostLdapBindDN \"cn=readonly,sid=2542,sec=hosting,o=xxxxx,c=de\"\n    VhostLDAPBindPassword \"noone\"\n  </IfDefine>\n\n\n</virtualhost>"}]