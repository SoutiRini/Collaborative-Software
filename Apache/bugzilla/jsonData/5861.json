[{"count": 0, "tags": [], "bug_id": 5861, "attachment_id": null, "text": "Hi,\n\nusing Tomcat 4.0.1 in conjunction with mod_jk and Ajp13 connections I got the\nfollowing problem:\n\nOne of my clients sends the following http request to my Apache server (just\nchanged server name)\n\nGET http://someserver.com/somewhere/somefile.html HTTP/1.1\nAccept: */*\nUA-OS: Windows CE (POCKET PC) - Version 3.0\nUA-color: color16\nHost: someserver.com\nUser-Agent: Mozilla/2.0 (compatible; MSIE 3.02; Windows CE; PPC; 240x320)\nProxy-Connection: Keep-Alive\nThis request will be forwarded via mod_jk and an Ajp13 connection to my tomcat\ninstance. Executing this request will result in a \"hanging\" connection (no\nresponse, but connection won't be closed). If you remove \"UA-color: color16\" from\nthe request above, everything works fine.\n\nI took a look at catalina.out and detected that everytime I execute the query\nabove the following exeception is thrown:\n\njava.lang.NumberFormatException\n        at org.apache.tomcat.util.buf.Ascii.parseInt(Ascii.java:188)\n        at org.apache.tomcat.util.buf.ByteChunk.getInt(ByteChunk.java:439)\n        at org.apache.tomcat.util.buf.MessageBytes.getInt(MessageBytes.java:565)\n        at org.apache.ajp.Ajp13.decodeRequest(Ajp13.java:393)\n        at org.apache.ajp.Ajp13.receiveNextRequest(Ajp13.java:309)\n        at org.apache.ajp.tomcat4.Ajp13Processor.process(Ajp13Processor.java:339)\n        at org.apache.ajp.tomcat4.Ajp13Processor.run(Ajp13Processor.java:424)\n        at java.lang.Thread.run(Thread.java:484)\nI took a look at line 393 from Ajp13.java (from the jakarta-tomcat-connectors)\nand detected the following:\nBecause UA-color has 8 characters hId is set to 8 which is equal to\nSC_REQ_CONTENT_LENGTH. Therefore the if condition in line 392 is true and the\ncontent length is expected as header value. Therefore everything works fine if I\nuse UA-colors (9 Characters) or an integer value for UA-color in my request.\nLines 369-401 from Ajp13.java\n            // Header names are encoded as either an integer code starting\n            // with 0xA0, or as a normal string (in which case the first\n            // two bytes are the length).\n            int isc = msg.peekInt();\n            int hId = isc & 0xFF;\n \n            MessageBytes vMB=null;\n            isc &= 0xFF00;\n            if(0xA000 == isc) {\n                msg.getInt(); // To advance the read position \n                hName = headerTransArray[hId - 1]; \n                vMB= headers.addValue(hName); \n            } else { \n                // XXX Not very elegant  \n                vMB = msg.addHeader(headers); \n                if (vMB == null) {       \n                    return 500; // wrong packet\n                } \n            } \n             \n            msg.getMessageBytes(vMB);\n            // set content length, if this is it...\n            if (hId == SC_REQ_CONTENT_LENGTH) {\n                int contentLength = (vMB == null) ? -1 : vMB.getInt(); // 393\n                req.setContentLength(contentLength);\n            } else if (hId == SC_REQ_CONTENT_TYPE) {\n                ByteChunk bchunk = vMB.getByteChunk();\n                req.contentType().setBytes(bchunk.getBytes(),\n                                           bchunk.getOffset(),\n                                           bchunk.getLength());\n            }\n        }\n\nFrom my point of view the mistake seems to be to check the if condition in line\n392 even if isc & 0xFF00 isn't 0xA000 (Which is not the case, as I saw in a\nsnoop). Because of this I would propose the following patch to solve the problem:\n--- jakarta-tomcat-connectors/jk/java/org/apache/ajp/Ajp13.java.orig\tWed Oct 10 08:35:22 2001\n+++ jakarta-tomcat-connectors/jk/java/org/apache/ajp/Ajp13.java\tTue Jan 15 10:34:37 2002\n@@ -378,26 +378,30 @@\n                 msg.getInt(); // To advance the read position\n                 hName = headerTransArray[hId - 1];\n \n\tvMB= headers.addValue(hName);\n+\n+                msg.getMessageBytes(vMB);\n+\n+                // set content length, if this is it...\n+                if (hId == SC_REQ_CONTENT_LENGTH) {\n+                    int contentLength = (vMB == null) ? -1 : vMB.getInt();\n+                    req.setContentLength(contentLength);\n+                } else if (hId == SC_REQ_CONTENT_TYPE) {\n+                    ByteChunk bchunk = vMB.getByteChunk();\n+                    req.contentType().setBytes(bchunk.getBytes(),\n+                                               bchunk.getOffset(),\n+                                               bchunk.getLength());\n+                }\n+\n             } else {\n \n\t// XXX Not very elegant\n \n\tvMB = msg.addHeader(headers);\n \n\tif (vMB == null) {\n                     return 500; // wrong packet\n                 }\n-            }\n-\n-            msg.getMessageBytes(vMB);\n \n-            // set content length, if this is it...\n-            if (hId == SC_REQ_CONTENT_LENGTH) {\n-                int contentLength = (vMB == null) ? -1 : vMB.getInt();\n-                req.setContentLength(contentLength);\n-            } else if (hId == SC_REQ_CONTENT_TYPE) {\n-                ByteChunk bchunk = vMB.getByteChunk();\n-                req.contentType().setBytes(bchunk.getBytes(),\n-                                           bchunk.getOffset(),\n-                                           bchunk.getLength());\n+                msg.getMessageBytes(vMB);\n             }\n+\n         }\n \n \tbyte attributeCode;\n\nIs this ok? Any comments?\nBest regards\nR\u00fcdiger Pl\u00fcm", "id": 9658, "time": "2002-01-15T06:28:27Z", "creator": "ruediger.pluem@vodafone-telecommerce.de", "creation_time": "2002-01-15T06:28:27Z", "is_private": false}, {"count": 1, "tags": [], "creator": "nick@digivis.com", "attachment_id": 1073, "id": 9933, "time": "2002-01-25T22:52:46Z", "bug_id": 5861, "creation_time": "2002-01-25T22:52:46Z", "is_private": false, "text": "Created attachment 1073\nA JSP test which will cause the NumberFormatException when directed at a Tomcat server. Tested against 4.0.1 final."}, {"count": 2, "tags": [], "bug_id": 5861, "text": "i have tested and committed the patch provided in the HEAD of the j-t-c \nrepository.", "id": 9936, "time": "2002-01-26T05:02:10Z", "creator": "seguin@motive.com", "creation_time": "2002-01-26T05:02:10Z", "is_private": false, "attachment_id": null}]