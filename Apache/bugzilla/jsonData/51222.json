[{"count": 0, "tags": [], "creator": "jxz164@hotmail.com", "attachment_id": 27026, "is_private": false, "id": 146433, "time": "2011-05-18T19:38:43Z", "bug_id": 51222, "creation_time": "2011-05-18T19:38:43Z", "text": "Created attachment 27026\nJava code and sample xls file to extract cell foreground color of Excel 2007 file\n\nI am using poi 3.8 beta 2 to extract the foreground fill color of cells for Excel 2007 xlsx spreadsheet. I found that the color is wrong for the attached xlsx file.\n\nSpecifically, please look at cells A4 and A5. In Excel 2007, the foreground color in hex for A4 is EEECE1, and for A5 is 1F497D.\n\nHowever, through the poi library, the colors are reversed (A4 gets 1F497D and A5 gets EEECE1).\n\nI am also attaching the java code so that you can reproduce this problem.\n\nThanks,"}, {"count": 1, "tags": [], "creator": "apache@gagravarr.org", "attachment_id": null, "is_private": false, "id": 146495, "time": "2011-05-20T20:50:08Z", "bug_id": 51222, "creation_time": "2011-05-20T20:50:08Z", "text": "There seems to be an issue with how we look up colours in the themes table. I've added a unit test in r1125559 that shows the issue. A4 references theme 2, A5 references theme 5, and in the themes table the colours look to be the wrong way around.\n\nMore investigation is needed to figure out why the themes appear to be the wrong way round in the file"}, {"count": 2, "tags": [], "creator": "apache@gagravarr.org", "attachment_id": null, "is_private": false, "id": 146496, "time": "2011-05-20T21:01:12Z", "bug_id": 51222, "creation_time": "2011-05-20T21:01:12Z", "text": "Having read the spec again, I'm with POI on this one. The file really does seem to be requesting the colours in the wrong order!\n\nThere's presumably something somewhere the inverts a meaning of something, or swaps something round, but I've no idea what or where, and everything I've read says we're doing the right thing..."}, {"count": 3, "tags": [], "creator": "mick.sear@succeed.co.uk", "attachment_id": null, "is_private": false, "id": 151530, "time": "2011-11-15T21:42:18Z", "bug_id": 51222, "creation_time": "2011-11-15T21:42:18Z", "text": "I've also had this problem.  3.8 beta 4 seems to invert black and white.\n\nI tested with 3.8 beta 4, which shows the problem, and 3.7, which is correct.\n\n@Test\n\tpublic void testXSSFColor(){\n\t\t//Ver 3.8beta4 of poi-xml seems buggy\n\t\tColor c = new Color(0,0,0);\n\t\tXSSFColor c2 = new XSSFColor(c);\n\t\t\n\t\t//Actually, ver 3.7 seems wrong too - Shouldn't ARGB black be FF000000?\n\t\t//3.8 beta 4 returns FFFFFFFF\n\t\t//3.7 returns 000000\n\t\tassertTrue(c2.getARGBHex().equals(\"000000\"));\n\t\t\n\t\tColor c3 = new Color(255,255,255);\n\t\tXSSFColor c4 = new XSSFColor(c3);\n\t\t//3.8 beta 4 returns FF000000\n\t\t//3.7 returns FFFFFF\n\t\tassertTrue(c4.getARGBHex().equals(\"FFFFFF\"));\n\t}\n\nNet result is that if you specify new new XSSFColor(Color(0,0,0)) as the font colour, you get white text."}, {"count": 4, "tags": [], "creator": "rgettman@corelogic.com", "attachment_id": 29832, "is_private": false, "id": 164531, "time": "2013-01-09T20:52:43Z", "bug_id": 51222, "creation_time": "2013-01-09T20:52:43Z", "text": "Created attachment 29832\nThemes.xlsx - Shows colors in theme number order"}, {"count": 5, "tags": [], "creator": "rgettman@corelogic.com", "attachment_id": 29834, "is_private": false, "id": 164533, "time": "2013-01-09T20:53:26Z", "bug_id": 51222, "creation_time": "2013-01-09T20:53:26Z", "text": "Created attachment 29834\npatch.tar.gz \u2013 Changed files, changed test cases, new files"}, {"count": 6, "tags": [], "creator": "rgettman@corelogic.com", "attachment_id": null, "text": "I believe I have the explanation for why these specific colors get reversed.  This also explains why black and white get reversed in Bugs 51236, 52079, and 53274.\n\nWhenever certain Theme colors are used, the following colors get swapped in POI:\n- FFFFFF and 000000 (white and black) (themes 0 and 1, respectively)\n- EEECE1 and 1F497D (tan and dark blue) (themes 2 and 3, respectively)\n\nHere is an excerpt from a typical \u201ctheme1.xml\u201d file from an .xlsx file:\n\n<a:clrScheme name=\"Office\">\n  <a:dk1><a:sysClr val=\"windowText\" lastClr=\"000000\"/></a:dk1>\n  <a:lt1><a:sysClr val=\"window\" lastClr=\"FFFFFF\"/></a:lt1>\n  <a:dk2><a:srgbClr val=\"1F497D\"/></a:dk2>\n  <a:lt2><a:srgbClr val=\"EEECE1\"/></a:lt2>\n  <a:accent1><a:srgbClr val=\"4F81BD\"/></a:accent1>\n  <a:accent2><a:srgbClr val=\"C0504D\"/></a:accent2>\n  <a:accent3><a:srgbClr val=\"9BBB59\"/></a:accent3>\n  <a:accent4><a:srgbClr val=\"8064A2\"/></a:accent4>\n  <a:accent5><a:srgbClr val=\"4BACC6\"/></a:accent5>\n  <a:accent6><a:srgbClr val=\"F79646\"/></a:accent6>\n  <a:hlink><a:srgbClr val=\"0000FF\"/></a:hlink>\n  <a:folHlink><a:srgbClr val=\"800080\"/></a:folHlink>\n</a:clrScheme>\n\nHowever, theme 0 is NOT black, it\u2019s white, and theme 1 is NOT white, it\u2019s black.  Additionally, theme 2 is NOT dark blue, it\u2019s tan, and theme 3 is NOT tan, it\u2019s dark blue.  (The other theme colors are in order.) \nI\u2019ve attached a spreadsheet \u201cThemes.xlsx\u201d that contains one cell per row, with text cells colored in theme color order (0-11).\n\nChanging the order of the color elements in the color scheme in theme1.xml does not affect the colors of the text in the resultant spreadsheet.  Therefore, Excel is not taking the theme number as an array index into the list of theme colors; it must be mapping the theme number to specific theme color elements:\n- 0 => a:lt1 (LISTED SECOND in theme1.xml!)\n- 1 => a:dk1 (LISTED FIRST!)\n- 2 => a:lt2 (LISTED FOURTH!)\n- 3 => a:dk2 (LISTED THIRD!)\n- 4 => a:accent1\n- 5 => a:accent2\n- 6 => a:accent3\n- 7 => a:accent4\n- 8 => a:accent5\n- 9 => a:accent6\n- 10 => a:hlink\n- 11 => a:folHlink\n\nPOI versions 3.8 and 3.9 applied a fix to this issue in XSSFColor.java and ThemesTable.java that is incorrect, namely, using the \u201ccorrectRGB\u201d method in XSSFColor.java, which flips black and white.  But the fix itself is incorrect.  It did not resolve the issue or explain why black and white get reversed.\n\nI have attached a patch that makes the following changes to resolve the above issues:\n- src/ooxml/java/org/apache/poi/xssf/usermodel/XSSFColor.java: Removed the flawed \u201ccorrectRGB\u201d method, and removed all calls to it.  (It was private, so all calls to it were only in XSSFColor.java.)\n- src/ooxml/java/org/apache/poi/xssf/model/ThemesTables.java: Introduced a Map of theme numbers to XSSFColors.  Created a new private method \u201ccacheThemeColors\u201d that is called by the constructors to initialize the Map.  Moved the logic that extracts the XSSFColor from the theme color element to a new private method \u201cgetXSSFColor\u201d.  The existing method \u201cgetThemeColor\u201d now accesses the Map to retrieve an XSSFColor.\n- src/ooxml/testcases/org/apache/poi/xssf/usermodel/TestXSSFColor.java: Changed a few incorrect \u201cassertEquals\u201d statements.  When tinting white darker, the black/white flip no longer occurs, so white (255, 255, 255) gets tinted darker to (165, 165, 165), not to (0, 0, 0); the byte array is really [-91, -91, -91].  Later, when assigning the color black, now the correct byte array [0, 0, 0] is passed in instead of [-1, -1, -1], and the ARGB string is expected to be \u201cFF000000\u201d instead of \u201cFFFFFFFF\u201d.\n- src/ooxml/testcases/org/apache/poi/xssf/usermodel/extensions/TestXSSFCellFill.java: This attempted to verify a tinted theme color, dark blue (dk2), but the RGB codes in the test were for tan (lt2).  These values are now corrected.\n- src/ooxml/testcases/org/apache/poi/xssf/model/TestThemesTable.java: A new JUnit test for ThemesTable.java.\n- test-data/spreadsheet/Themes.xlsx: This new spreadsheet is the same as the one mentioned above.  It helps test ThemesTable.java in TestThemesTable.java.", "id": 164534, "time": "2013-01-09T20:54:26Z", "bug_id": 51222, "creation_time": "2013-01-09T20:54:26Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 51222, "attachment_id": null, "id": 164857, "time": "2013-01-24T00:33:14Z", "creator": "rgettman@corelogic.com", "creation_time": "2013-01-24T00:33:14Z", "is_private": false, "text": "I guess I needed to set the status of this bug too."}, {"count": 8, "tags": [], "text": "This doesn't appear to have been fixed yet, merely has a patch available, so re-opening and tagging as such", "is_private": false, "bug_id": 51222, "id": 171532, "time": "2013-12-02T17:25:00Z", "creator": "apache@gagravarr.org", "creation_time": "2013-12-02T17:25:00Z", "attachment_id": null}, {"count": 9, "tags": [], "creator": "jason.gessel@smartsheet.com", "attachment_id": null, "text": "Is there a target release for incorporating this patch?", "id": 177146, "time": "2014-08-13T17:20:06Z", "bug_id": 51222, "creation_time": "2014-08-13T17:20:06Z", "is_private": false}, {"count": 10, "tags": [], "creator": "apache@gagravarr.org", "attachment_id": null, "text": "It would be good if someone could try the patch, and confirm:\n * Does it apply cleanly?\n * Do all existing unit tests pass?\n * Do new unit tests pass?\n * Do new unit tests cover all of the changed functionality, and all cases?\n * Does Excel then show the right thing?\n\nIf any of those are a no, then more work is needed before it can be applied", "id": 177148, "time": "2014-08-13T19:03:40Z", "bug_id": 51222, "creation_time": "2014-08-13T19:03:40Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 51222, "attachment_id": null, "id": 177449, "time": "2014-08-29T22:22:43Z", "creator": "kiwiwings@apache.org", "creation_time": "2014-08-29T22:22:43Z", "is_private": false, "text": "Applied with some modifications in r1621393\n\n> * Does it apply cleanly?\n> * Do all existing unit tests pass?\n> * Do new unit tests pass?\nJenkins will tell us ;)\n\n> * Do new unit tests cover all of the changed functionality, and all cases?\nThere are 12 (indexed) theme attributes, which are tested -> yes\n\n> * Does Excel then show the right thing?\nThe TestThemesTable test can be used to generate themed and fixed color cells side-by-side, which looks good."}, {"count": 12, "tags": [], "creator": "yoann.rodiere@openwide.fr", "attachment_id": null, "text": "*** Bug 52079 has been marked as a duplicate of this bug. ***", "id": 192315, "time": "2016-07-12T07:26:28Z", "bug_id": 51222, "creation_time": "2016-07-12T07:26:28Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 51222, "attachment_id": null, "id": 192317, "time": "2016-07-12T07:27:27Z", "creator": "yoann.rodiere@openwide.fr", "creation_time": "2016-07-12T07:27:27Z", "is_private": false, "text": "*** Bug 51236 has been marked as a duplicate of this bug. ***"}]