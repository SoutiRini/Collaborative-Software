[{"count": 0, "attachment_id": 27285, "bug_id": 51511, "is_private": false, "id": 147923, "time": "2011-07-14T21:54:50Z", "creator": "timw@apache.org", "creation_time": "2011-07-14T21:54:50Z", "tags": [], "text": "Created attachment 27285\nPatch to correct memcache pool ttl\n\nThe ttl parameter to apr_memcache_server_create is documented as:\n\n\"time to live in seconds of a client connection\"\n\nSubversion (in my case 1.6.11, but still the same in trunk), calls this with the value 50.\n\nThis parameter is passed directly to apr_reslist_create without modification, however the ttl parameter to apr_reslist_create is a \t\tapr_interval_time_t microseconds value.\n\nThe net result of this is that connections to memcache are closed immediately after they are returned to the pool by the Subversion process. \nIt seems that the pool is using a 50 microsecond TTL value, and closing any connection pretty much immediately after use.\n\nOn our Subversion server, we observe port exhaustion, with > 30,000 TCP sockets to the memcache port in TIME_WAIT (unless we turn on very aggressive time_wait reuse/recycle options).\n\nA tcpdump capture on that server reveals every connection is closed with a memcache quit command, and tracing back through the code this is only called from the conn_clean pool cleanup handler.\n\nPatching apr_memcache_server_create to multiply the TTL by 1,000,000 fixes the issue on our server (as observed by the number of TIME_WAIT sockets and connections to memcached).\n\nPatch against 1.3.9 (which should apply cleanly against trunk) is attached."}, {"count": 1, "tags": [], "text": "committed to apr trunk and apr-util 1.5.x and 1.4.x branches\nthanks!", "attachment_id": null, "bug_id": 51511, "id": 162417, "time": "2012-09-26T14:49:46Z", "creator": "trawick@apache.org", "creation_time": "2012-09-26T14:49:46Z", "is_private": false}, {"count": 2, "tags": [], "text": "The change has been reverted.\n\nThe documentation had been previously fixed to indicate that ttl is in microseconds instead of seconds.", "attachment_id": null, "bug_id": 51511, "id": 162440, "time": "2012-09-27T20:14:27Z", "creator": "trawick@apache.org", "creation_time": "2012-09-27T20:14:27Z", "is_private": false}]