[{"count": 0, "tags": [], "text": "In shared mode:\n* calcMode.4=all active threads (shared)\n* calcMode.5=all active threads in current thread group (shared)\nalways has a previousTime of 0 for all threads.\n\nThis causes the first run of each thread to not use the \"shared\" times.\n\nI've provided a patch, with unit tests.\n\nA summary of the changes are below\n\nConstantThroughputTimer\n* Changed threadGroupsInfoMap from Map to ConcurrentHashMap (it was using a ConcurrentHashMap implementation but exposing it as a Map) and putIfAbsent() is needed\n* increased serialVersionUID as internal structure has changed.\n* Moved ThroughputInfo to its own class and gave it a rewrite\n* add constants for calc modes.\n* increased MILLISEC_PER_MIN to protected visibility\n* replaced previousTime with an instance of ThroughputInfo (this unifies the Timer for all use cases)\n* added documentation where it was missing\n* delay() delegates to throughputInfo\n* deleted calculateCurrentTarget() - the comment indicated it was only used in test code and it no longer is\n* renamed calculateDelay to calculateDelayForMode\n* moved implementationd details of calculateSharedDelay to ThroughputInfo\n* reset no longer resets class variables this is done in testEnded\n* reset calls setCalcMode() to ensure that sharing of ThroughputInfo instances are done correctly for the shared modes\n\nThroughputInfo\n* uses a static class SystemClock (which delegates to System.currentTimeMillis) to allow for unit testing\n* previousTime from ConstantThroughputTimer renamed to lastScheduledTime\n* lastScheduledTime is guarded by \"this\" instead of a Mutex.\n* ConstantThroughputTimer.calculateSharedDelay and ConstantThroughputTimer.delay did the same things but with a different implementation, this is unified into calculateDelay()\n\n== Testing == \n* MockJMeterContext created that delegates all calls to an instance of JMeterContext, used to switch out the current context when \"activated\" as unit testing doesn't setup threads needed for ThreadLocal context variables.\n* Created a simulation class to make creating scenarios from a file possible\n* Created ConstantThroughputTimerTest with some more thorough testing scenarios\n* Created ConstantThroughputTimerTestData which holds all the test data needed to hide the complexity of setting up unit tests\n* Upgraded PackageTest to use SimulationClock instead of relying on Thread.sleep and timing to test\n* SimulationClock to control SystemClock timings during test\n* SimulationEvent defines what offset the event occurs at and the expected delay\n* simulator_mode*.txt files for each mode to run a test scenario for.", "is_private": false, "bug_id": 51480, "id": 147786, "time": "2011-07-06T01:05:46Z", "creator": "baerrach@gmail.com", "creation_time": "2011-07-06T01:05:46Z", "attachment_id": null}, {"count": 1, "tags": [], "text": "Created attachment 27262\nFix with unit tests", "is_private": false, "bug_id": 51480, "id": 147787, "time": "2011-07-06T01:06:40Z", "creator": "baerrach@gmail.com", "creation_time": "2011-07-06T01:06:40Z", "attachment_id": 27262}, {"count": 2, "tags": [], "bug_id": 51480, "attachment_id": null, "text": "Thanks for your works.\n\nBut, your patch doesn't works very well with the svn trunk. \nThere have some errors (when apply patch) with \n* ConstantThroughputTimer.java\n* PackageTest.java\n\nI have modified some things to get all patch elements in my eclipse source code.\n\nBut now, when I try to run ant tests, I have some errors:\n     [java] There were 3 failures:\n     [java] 1) testTimer1(org.apache.jmeter.timers.PackageTest)junit.framework.AssertionFailedError: Expected delay of approx 500 expected:<500.0> but was:<2000.0>\n     [java] \tat org.apache.jmeter.timers.PackageTest.testTimer1(PackageTest.java:50)\n     [java] \tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n     [java] \tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n     [java] \tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n     [java] \tat org.apache.jorphan.test.AllTests.main(AllTests.java:225)\n     [java] 2) testTimer2(org.apache.jmeter.timers.PackageTest)junit.framework.AssertionFailedError: expected:<1> but was:<1001>\n     [java] \tat org.apache.jmeter.timers.PackageTest.testTimer2(PackageTest.java:61)\n     [java] \tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n     [java] \tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n     [java] \tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n     [java] \tat org.apache.jorphan.test.AllTests.main(AllTests.java:225)\n     [java] 3) testTimer3(org.apache.jmeter.timers.PackageTest)junit.framework.AssertionFailedError: expected:<10> but was:<19>\n     [java] \tat org.apache.jmeter.timers.PackageTest.testTimer3(PackageTest.java:74)\n     [java] \tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n     [java] \tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n     [java] \tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n     [java] \tat org.apache.jorphan.test.AllTests.main(AllTests.java:225)\n     [java] FAILURES!!!\n\nPlease could you send a new patch (tested it before on a fresh svn trunk & ant tests). Thanks.", "id": 147922, "time": "2011-07-14T20:15:38Z", "creator": "milamber@apache.org", "creation_time": "2011-07-14T20:15:38Z", "is_private": false}, {"count": 3, "tags": [], "creator": "baerrach@gmail.com", "text": "It looks like the patch doesn't apply cleanly on\norg.apache.jmeter.timers.ConstantThroughputTimer \nand \norg.apache.jmeter.timers.PackageTest\n\nDont know why.\n\nresupplying patch and these two files individually.\n\nI also needed to update the build.xml to copy across the simulation files.", "id": 147927, "time": "2011-07-15T07:28:15Z", "bug_id": 51480, "creation_time": "2011-07-15T07:28:15Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 51480, "attachment_id": 27287, "text": "Created attachment 27287\nTrunk Patch", "id": 147928, "time": "2011-07-15T07:28:43Z", "creator": "baerrach@gmail.com", "creation_time": "2011-07-15T07:28:43Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 51480, "attachment_id": 27288, "text": "Created attachment 27288\nConstantThroughputTimer.java", "id": 147929, "time": "2011-07-15T07:29:02Z", "creator": "baerrach@gmail.com", "creation_time": "2011-07-15T07:29:02Z", "is_private": false}, {"count": 6, "tags": [], "creator": "baerrach@gmail.com", "attachment_id": 27289, "id": 147930, "time": "2011-07-15T07:29:20Z", "bug_id": 51480, "creation_time": "2011-07-15T07:29:20Z", "is_private": false, "text": "Created attachment 27289\nPackageTest.java"}, {"count": 7, "tags": [], "creator": "milamber@apache.org", "attachment_id": null, "id": 147954, "time": "2011-07-17T10:13:21Z", "bug_id": 51480, "creation_time": "2011-07-17T10:13:21Z", "is_private": false, "text": "Thanks for new submission. The new patch file is good (including ConstantThroughputTimer and PackageTest).\n\nant tests works fine now.\n\nI've create a simple test script, mode 4 works fine, but mode 5 don't start.\n\nMessage is :\nUncaught Exception java.lang.Error: java.lang.reflect.InvocationTargetException. See log file for details.\n\nLog file :\n2011/07/17 10:50:01 ERROR - jmeter.testbeans.TestBeanHelper: This should never happen. java.lang.reflect.InvocationTargetException\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:616)\n\tat org.apache.jmeter.testbeans.TestBeanHelper.invokeOrBailOut(TestBeanHelper.java:157)\n\tat org.apache.jmeter.testbeans.TestBeanHelper.prepare(TestBeanHelper.java:90)\n\tat org.apache.jmeter.engine.StandardJMeterEngine.notifyTestListenersOfStart(StandardJMeterEngine.java:205)\n\tat org.apache.jmeter.engine.StandardJMeterEngine.run(StandardJMeterEngine.java:341)\n\tat java.lang.Thread.run(Thread.java:636)\nCaused by: java.lang.NullPointerException\n\tat java.util.concurrent.ConcurrentHashMap.putIfAbsent(ConcurrentHashMap.java:924)\n\tat org.apache.jmeter.timers.ConstantThroughputTimer.setCalcMode(ConstantThroughputTimer.java:138)\n\t... 9 more\n\nUncaught Exception java.lang.Error: java.lang.reflect.InvocationTargetException. See log file for details.\n2011/07/17 10:50:01 ERROR - jmeter.JMeter: Uncaught exception:  java.lang.Error: java.lang.reflect.InvocationTargetException\n\tat org.apache.jmeter.testbeans.TestBeanHelper.invokeOrBailOut(TestBeanHelper.java:166)\n\tat org.apache.jmeter.testbeans.TestBeanHelper.prepare(TestBeanHelper.java:90)\n\tat org.apache.jmeter.engine.StandardJMeterEngine.notifyTestListenersOfStart(StandardJMeterEngine.java:205)\n\tat org.apache.jmeter.engine.StandardJMeterEngine.run(StandardJMeterEngine.java:341)\n\tat java.lang.Thread.run(Thread.java:636)\n\n\n\nPlease, for new submission, detab your source code. See:\nhttp://wiki.apache.org/jakarta-jmeter/JMeterEclipse"}, {"count": 8, "tags": [], "text": "Created attachment 27293\nSimple test script\n\nTG3 don't works.", "is_private": false, "bug_id": 51480, "id": 147955, "time": "2011-07-17T10:14:33Z", "creator": "milamber@apache.org", "creation_time": "2011-07-17T10:14:33Z", "attachment_id": 27293}, {"count": 9, "tags": [], "bug_id": 51480, "attachment_id": null, "text": "Looking into it.\n\nAs an aside, where is the documentation on how to run JMeter?\nThe ant task run_gui fails becaose of missing property files ${basedir}/bin/\n* jmeter.properties\n* saveservice.properties\n* upgrade.properties\n\nI've had to copy these in and update the run_gui target to include\n      <classpath>\n        ...\n        <path refid=\"run.classpath\"/>\nwhere\n  <path id=\"run.classpath\">\n    <fileset dir=\"${dest.jar}\" includes=\"*.jar\"/>\n  </path>", "id": 147964, "time": "2011-07-18T04:31:02Z", "creator": "baerrach@gmail.com", "creation_time": "2011-07-18T04:31:02Z", "is_private": false}, {"count": 10, "tags": [], "creator": "baerrach@gmail.com", "attachment_id": null, "id": 147965, "time": "2011-07-18T04:34:04Z", "bug_id": 51480, "creation_time": "2011-07-18T04:34:04Z", "is_private": false, "text": "Looks like ConstantThroughputTimer:133\n        case CALC_MODE_5_ALL_ACTIVE_THREADS_IN_CURRENT_THREAD_GROUP_SHARED:\n            final org.apache.jmeter.threads.AbstractThreadGroup group = JMeterContextService\n                    .getContext().getThreadGroup();\n\nis returning null for group\n2011/07/18 14:00:37 INFO  - jmeter.timers.ConstantThroughputTimer: group = null \n\nI didn't notice this, because my real JMeter tests are all CALC_MODE_4_ALL_ACTIVE_THREADS_SHARED\n\nWhat's the correct way to check is we are in running mode?"}, {"count": 11, "tags": [], "bug_id": 51480, "attachment_id": null, "text": "Using\n  JMeterContextService.getContext().isSamplingStarted\n\nStandardJMeterEngine.run() seems to set this value when starting.", "id": 147966, "time": "2011-07-18T05:06:06Z", "creator": "baerrach@gmail.com", "creation_time": "2011-07-18T05:06:06Z", "is_private": false}, {"count": 12, "tags": [], "creator": "baerrach@gmail.com", "text": "ConstantThroughputTimer.setCalcMode becomes:\n\n    /**\n     * Setting this has the side effect of sharing <code>throughputInfo</code> if the mode is\n     * <em>shared</em> and sampling has started.\n     *\n     * @param mode\n     *            the delay calculation mode\n     */\n    public void setCalcMode(String mode) {\n        this.calcMode = mode;\n        // TODO find better way to get modeInt\n        this.modeInt = ConstantThroughputTimerBeanInfo.getCalcModeAsInt(calcMode);\n\n        if (JMeterContextService.getContext().isSamplingStarted()) {\n            switch (modeInt) {\n            case CALC_MODE_4_ALL_ACTIVE_THREADS_SHARED:\n                throughputInfo = allThreadsInfo;\n                break;\n\n            case CALC_MODE_5_ALL_ACTIVE_THREADS_IN_CURRENT_THREAD_GROUP_SHARED:\n                final org.apache.jmeter.threads.AbstractThreadGroup group = JMeterContextService\n                        .getContext().getThreadGroup();\n                /*\n                 * Share the first thread's throughputInfo\n                 */\n                threadGroupsInfoMap.putIfAbsent(group, throughputInfo);\n                throughputInfo = threadGroupsInfoMap.get(group);\n                break;\n            }\n        }\n    }\n\nBut my ant tests are no longer working...", "id": 147968, "time": "2011-07-18T05:27:04Z", "bug_id": 51480, "creation_time": "2011-07-18T05:27:04Z", "is_private": false, "attachment_id": null}, {"count": 13, "tags": [], "creator": "baerrach@gmail.com", "attachment_id": null, "id": 148516, "time": "2011-08-10T00:54:50Z", "bug_id": 51480, "creation_time": "2011-08-10T00:54:50Z", "is_private": false, "text": "Sorry, work has been busy.\nMilamber, where did we get to with this?"}, {"count": 14, "tags": [], "creator": "graham@ham1.co.uk", "attachment_id": null, "id": 202485, "time": "2017-11-30T11:37:58Z", "bug_id": 51480, "creation_time": "2017-11-30T11:37:58Z", "is_private": false, "text": "Is this still an issue?"}]