[{"count": 0, "tags": [], "bug_id": 52774, "attachment_id": null, "is_private": false, "id": 154260, "time": "2012-02-26T20:11:19Z", "creator": "jerome.grandjanny@laposte.net", "creation_time": "2012-02-26T20:11:19Z", "text": "This kind of configuration is for an outgoing proxy which filters advertisments requests. It worked in 2.2.13 but not in 2.2.14 :\n\nListen 127.0.0.1:81\n<VirtualHost 127.0.0.1:81>\n    ProxyRequests On\n    RewriteEngine On\n    RewriteRule /advertising/ - [forbidden]\n    ... other generic ads filtering rules ...\n</VirtualHost>\n\nIn 2.2.14, it seems that mod_proxy processes the request before mod_rewrite can even do its job and RewriteRules are not processed at all. In previous versions, RewriteRules were processed first, then, the request was processed by mod_proxy if it passed all the ads filtering rules."}, {"count": 1, "attachment_id": null, "creator": "covener@gmail.com", "is_private": false, "id": 154264, "time": "2012-02-26T20:41:20Z", "bug_id": 52774, "creation_time": "2012-02-26T20:41:20Z", "tags": [], "text": "Not seeing any relevant changes.  per-vhost scope rewriterules should have taken precedence for the full life of 2.2.  Can you post a verbatim configuration and evidence that you're hitting the right vhost (custom log, RewriteLog, etc)"}, {"count": 2, "tags": [], "creator": "jerome.grandjanny@laposte.net", "is_private": false, "id": 154383, "creation_time": "2012-02-29T20:26:07Z", "time": "2012-02-29T20:26:07Z", "bug_id": 52774, "text": "Yes, here is a verbatim minimal configuration file allowing to show the issue :\n\n    ServerRoot \"/etc/apache2\"\n    User  www-data\n    Group www-data\n\n    LoadModule proxy_module /usr/lib/apache2/modules/mod_proxy.so\n    LoadModule proxy_http_module /usr/lib/apache2/modules/mod_proxy_http.so\n    LoadModule rewrite_module /usr/lib/apache2/modules/mod_rewrite.so\n\n    ErrorLog /var/log/apache2/error.log\n    LogLevel debug\n    CustomLog /var/log/apache2/access.log \"%h %l %u %t \\\"%r\\\" %>s %b\"\n    RewriteLog /var/log/apache2/rewrite.log\n    RewriteLogLevel 9\n\n    Listen 127.0.0.1:81\n    ServerName localhost\n    ProxyRequests On\n    RewriteEngine On\n    RewriteRule /ads/ - [forbidden]\n\nThis is intended to be an outgoing proxy which blocks any request having the string /ads/ in the URL.\n\n1) Expected behavior :\n   -------------------\n     Request 1 : GET http://pubs.lemonde.fr/RealMedia/ads/click_lx.ads/INTERNATIONAL-LEMONDE/articles_international/exclu/tall/L50/L50/306065288/x21/OasDefault/lm_ysl_06010_rg02_sp/ibm_emagazine_rg01_sp.html/576879454745394f676c554142765042 HTTP/1.0\n     Response 1 : HTTP/1.1 403 Forbidden\n\n     Request 2 : GET http://www.hpmuseum.org HTTP/1.O\n     Response 2 : HTTP/1.1 200 Ok\n\n     Explanation : when the request contains the string /ads/, the RewriteRule immediately rejects it. For any other request, the RewriteRule is not triggered and the request is proxyied by mod_proxy.\n\n2) Actual behavior :\n   -----------------\n     Request 1 : Same as below\n     Response 1 : HTTP/1.1 302 Found\n     Content of access.log : 127.0.0.1 - - [29/Feb/2012:20:56:36 +0100] \"GET http://pubs.lemonde.fr/RealMedia/ads/click_lx.ads/INTERNATIONAL-LEMONDE/articles_international/exclu/tall/L50/L50/306065288/x21/OasDefault/lm_ysl_06010_rg02_sp/ibm_emagazine_rg01_sp.html/576879454745394f676c554142765042 HTTP/1.0\" 302 399\n     Content of rewrite.log : empty\n\n3) Verification with the line \"ProxyRequests On\" commented out :\n   -------------------------------------------------------------\n     Request 1 : Same as below\n     Response 1 : HTTP/1.1 403 Forbidden\n     Content of access.log : 127.0.0.1 - - [29/Feb/2012:20:57:56 +0100] \"GET http://pubs.lemonde.fr/RealMedia/ads/click_lx.ads/INTERNATIONAL-LEMONDE/articles_international/exclu/tall/L50/L50/306065288/x21/OasDefault/lm_ysl_06010_rg02_sp/ibm_emagazine_rg01_sp.html/576879454745394f676c554142765042 HTTP/1.0\" 403 398\n     Content of rewrite.log :\n        127.0.0.1 - - [29/Feb/2012:20:57:56 +0100] [pubs.lemonde.fr/sid#203f78e8][rid#2047d960/initial] (2) init rewrite engine with requested uri /RealMedia/ads/click_lx.ads/INTERNATIONAL-LEMONDE/articles_international/exclu/tall/L50/L50/306065288/x21/OasDefault/lm_ysl_06010_rg02_sp/ibm_emagazine_rg01_sp.html/576879454745394f676c554142765042\n        127.0.0.1 - - [29/Feb/2012:20:57:56 +0100] [pubs.lemonde.fr/sid#203f78e8][rid#2047d960/initial] (3) applying pattern '/ads/' to uri '/RealMedia/ads/click_lx.ads/INTERNATIONAL-LEMONDE/articles_international/exclu/tall/L50/L50/306065288/x21/OasDefault/lm_ysl_06010_rg02_sp/ibm_emagazine_rg01_sp.html/576879454745394f676c554142765042'\n        127.0.0.1 - - [29/Feb/2012:20:57:56 +0100] [pubs.lemonde.fr/sid#203f78e8][rid#2047d960/initial] (2) forcing responsecode 403 for /RealMedia/ads/click_lx.ads/INTERNATIONAL-LEMONDE/articles_international/exclu/tall/L50/L50/306065288/x21/OasDefault/lm_ysl_06010_rg02_sp/ibm_emagazine_rg01_sp.html/576879454745394f676c554142765042\n\nThis show that, in the first configuration, rewrite_mod doesn't have a chance to process the request before mod_proxy. In the \"verification\" configuration, we see that the RewriteRule works perfectly when mod_proxy is not sollicited.\n\nIn the real life, I use this kind of configuration with a bunch of RewriteRules and RewriteConds to eliminate advertisments from my navigations. It was working nice for years and years on many systems until my Ubuntu updated Apache Httpd to 2.2.14 and then it was broken.\n\nThanks for your time,\nBest regards,\nJerome.", "attachment_id": null}, {"count": 3, "tags": [], "text": "(In reply to comment #0)\n> This kind of configuration is for an outgoing proxy which filters advertisments\n> requests. It worked in 2.2.13 but not in 2.2.14 :\n\n(In reply to comment #2)\n> and RewriteConds to eliminate advertisments from my navigations. It was working\n> nice for years and years on many systems until my Ubuntu updated Apache Httpd\n> to 2.2.14 and then it was broken.\n\nThanks for the test case.\n\nWere you really using 2.2.13 before, or just the version which Ubuntu previously provided?\n\nAnd when saying \"2.2.14\", are you referring to a vanilla httpd 2.2.14 deployment, or actually something like 2.2.14-5ubuntuXYZ?", "attachment_id": null, "bug_id": 52774, "id": 154471, "time": "2012-03-03T08:48:36Z", "creator": "asfbugz@velox.ch", "creation_time": "2012-03-03T08:48:36Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 52774, "attachment_id": null, "is_private": false, "id": 154546, "time": "2012-03-05T19:48:12Z", "creator": "jerome.grandjanny@laposte.net", "creation_time": "2012-03-05T19:48:12Z", "text": "(In reply to comment #3)\n> (In reply to comment #0)\n> > This kind of configuration is for an outgoing proxy which filters advertisments\n> > requests. It worked in 2.2.13 but not in 2.2.14 :\n> \n> (In reply to comment #2)\n> > and RewriteConds to eliminate advertisments from my navigations. It was working\n> > nice for years and years on many systems until my Ubuntu updated Apache Httpd\n> > to 2.2.14 and then it was broken.\n> \n> Thanks for the test case.\n> \n> Were you really using 2.2.13 before, or just the version which Ubuntu\n> previously provided?\n> \n> And when saying \"2.2.14\", are you referring to a vanilla httpd 2.2.14\n> deployment, or actually something like 2.2.14-5ubuntuXYZ?\n\nYes, indeed, I was not aware that Ubuntu did its own cooking with Apache versions.\n\nwhen I type :\n        apache2ctl -v\nI get :\n        Server version: Apache/2.2.14 (Ubuntu)\n        Server built:   Feb 14 2012 18:09:18\n\nAnd when I type :\n        cd /root/.synaptic/log\n        fgrep 'apache2 ' *.log\nI get :\n        2010-10-05.192601.log:apache2 (2.2.14-5ubuntu8.2)\n        2010-10-28.115159.log:apache2 (2.2.14-5ubuntu8.2) to 2.2.14-5ubuntu8.3\n        2010-11-27.173910.log:apache2 (2.2.14-5ubuntu8.3) to 2.2.14-5ubuntu8.4\n        2011-09-02.191300.log:apache2 (2.2.14-5ubuntu8.4) to 2.2.14-5ubuntu8.6\n        2011-11-14.190709.log:apache2 (2.2.14-5ubuntu8.6) to 2.2.14-5ubuntu8.7\n        2012-02-20.111132.log:apache2 (2.2.14-5ubuntu8.7) to 2.2.14-5ubuntu8.8\n\nObviously, my configuration broke on 2012-02-20."}, {"count": 5, "attachment_id": null, "creator": "asfbugz@velox.ch", "is_private": false, "id": 154606, "time": "2012-03-07T08:21:36Z", "bug_id": 52774, "creation_time": "2012-03-07T08:21:36Z", "tags": [], "text": "(In reply to comment #4)\n>         2012-02-20.111132.log:apache2 (2.2.14-5ubuntu8.7) to 2.2.14-5ubuntu8.8\n> \n> Obviously, my configuration broke on 2012-02-20.\n\nThe reason is most likely this (from http://changelogs.ubuntu.com/changelogs/pool/main/a/apache2/apache2_2.2.14-5ubuntu8.8/changelog):\n\n  * SECURITY UPDATE: another mod_proxy reverse proxy exposure\n    - debian/patches/216_CVE-2011-4317.dpatch: validate additional URIs in\n      modules/mappers/mod_rewrite.c, modules/proxy/mod_proxy.c,\n      server/protocol.c.\n    - CVE-2011-4317\n\nI'm tentatively setting the version to 2.2.22, as this is the official release with the fix for CVE-2011-4317 (see r1235443)."}, {"count": 6, "tags": [], "creator": "rainer.jung@kippdata.de", "is_private": false, "id": 155272, "creation_time": "2012-03-24T11:28:20Z", "time": "2012-03-24T11:28:20Z", "bug_id": 52774, "text": "I can confirm the behaviour for a vanilla 2.2.22. Since the URL does not start with a \"/\", we return DECLINED in hook_uri2file().\n\nThis was added as part of a fix for CVE-2011-4317 in r1235443.", "attachment_id": null}, {"count": 7, "attachment_id": 28547, "creator": "petr.sumbera@oracle.com", "is_private": false, "id": 157219, "time": "2012-04-05T15:30:21Z", "bug_id": 52774, "creation_time": "2012-04-05T15:30:21Z", "tags": [], "text": "Created attachment 28547\nExample of possible fix.\n\nIn original fix for CVE-2011-3368 there was following note:\n\nFrom RFC -    /* RFC 2616:\n     *   Request-URI    = \"*\" | absoluteURI | abs_path | authority\n\nBut in both fixes for CVE-2011-3368 and CVE-2011-4317 there was no code allowing \nabsoluteURI which is used in case of poxing.\n\nPlease see attached diff file which in my case solved this issue (probably the same fix should go also into mod_proxy.c).\n\nAny comments?"}, {"count": 8, "tags": [], "bug_id": 52774, "attachment_id": null, "id": 158961, "time": "2012-05-10T19:48:58Z", "creator": "jerome.grandjanny@laposte.net", "creation_time": "2012-05-10T19:48:58Z", "is_private": false, "text": "Hello,\n\nI installed a fresh vanilla Apache 2.2.22 with Petr's patch and now it works as I expected.\nThanks to Petr."}, {"count": 9, "tags": [], "bug_id": 52774, "attachment_id": null, "id": 159341, "time": "2012-05-26T13:00:41Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2012-05-26T13:00:41Z", "is_private": false, "text": "*** Bug 53286 has been marked as a duplicate of this bug. ***"}, {"count": 10, "attachment_id": null, "creator": "g.russell@napier.ac.uk", "is_private": false, "id": 159350, "time": "2012-05-26T16:35:29Z", "bug_id": 52774, "creation_time": "2012-05-26T16:35:29Z", "tags": [], "text": "Bug 53286 is about http CONNECT not proxy:, and the diff patch here seems to only help proxy not CONNECT. It certainly doesn't seem to help in my bug. \nThe only link I can see between these bugs is that they relate to the same code change in 2.2.22. In CONNECT the uri does not start with http or https, but it can be still perfectly valid. \n\nJoining the bugs together just seems really confusing to me. \n\nHowever if joining them means we get nearer a fix then I am all for it!\n\nI also note Rainer's comments in apache devel. I don't subscribe to that list. But note my bug report has nothing to do with the [p] option so using that as a test would not help.  You probably need a global modrewrite flag as another user suggested in order for the average user to feel safe while being flexible for the experienced user. \n\nSo if you want to join the bugs that's fine but do read the other bug report and don't forget the CONNECT method in your fix. \n\nThanks."}, {"count": 11, "attachment_id": null, "creator": "g.russell@napier.ac.uk", "is_private": false, "id": 159351, "time": "2012-05-26T16:55:07Z", "bug_id": 52774, "creation_time": "2012-05-26T16:55:07Z", "tags": [], "text": "Very sorry Rainer. On second thoughts checking the uri only on a [P] rather than every time would indeed fix 53286. It would also fix this report and seems to me to be a better fix for CVE-2011-3368. Vote +1 if I am allowed to vote... Put up a patch and I will happily test it in my config."}, {"count": 12, "tags": [], "bug_id": 52774, "attachment_id": 28842, "text": "Created attachment 28842\nPatch for CVE-2011-4317 effecting only rewriterule proxy\n\nI had a few hours spare today and wrote a patch on 2.2.22.\nThis would appear to allow both continued use of rewriterule in proxy and connect conditions, while enforcing a rule for [P] type modrewrite.\n\nUnfortunately I could not test the problems of CVE-2011-4317 in these changes as they seem for me to be blocked early in the process (perhaps due to me using an rpms from fedora). Could someone validate that the problem URIs are still blocked?\n\nThe previous CVE-2011-4317 fix ignored modrewrite when the URI was invalid, and this caused my config to allow requests which would have otherwise been blocked (as I use [F] rewriterule for security). I think this patch is better as it make the request FORBIDDEN if a [p] rule was the one that matched and the URI is not safe.\n\nThe previous rule ignored proxy in .htaccess files. I assume this was already thought through? As per the previous fix I ignore this.\n\nI had to add an extra flag to one of the functions to indicate that a proxy modrewrite was used. Just using a match on \"proxy:\" incorrectly trapped simple rewrite rules involving the CONNECT method.\n\nI hope this is useful to you...", "id": 159390, "time": "2012-05-28T12:18:18Z", "creator": "g.russell@napier.ac.uk", "creation_time": "2012-05-28T12:18:18Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 52774, "attachment_id": 28843, "id": 159400, "time": "2012-05-28T16:11:47Z", "creator": "g.russell@napier.ac.uk", "creation_time": "2012-05-28T16:11:47Z", "is_private": false, "text": "Created attachment 28843\nPatch v2 for CVE-2011-4317 effecting only rewriterule proxy\n\nHad another little play, and this patch is another approach by extending ACTION_ to include ACTION_FORBIDDEN. Less parameters and cleaner, but only if you dont mind ACTION being extended in this way.\n\nAdded it into .htaccess too.\n\nAgain, I have been unable to test to see if this actually does block the CVE issue, but I cannot see any reason why it wouldnt deal with the issue. Maybe someone can check and amend as necessary? I am not a mod_rewrite.c expert so this patch could have side-effects, but it seems ok and works for me."}, {"count": 14, "attachment_id": null, "creator": "jorton@redhat.com", "is_private": false, "id": 160398, "time": "2012-07-02T13:26:17Z", "bug_id": 52774, "creation_time": "2012-07-02T13:26:17Z", "tags": [], "text": "See list discussion here:\n\nhttp://comments.gmane.org/gmane.comp.apache.devel/48357\n\nI have added a new RewriteOption, \"AllowAnyURI\", in r1356115 which IMO resolves this issue.  Other opinions are available! :)"}, {"count": 15, "tags": [], "bug_id": 52774, "attachment_id": null, "id": 160587, "time": "2012-07-11T12:39:29Z", "creator": "petr.sumbera@oracle.com", "creation_time": "2012-07-11T12:39:29Z", "is_private": false, "text": "(In reply to comment #14)\n> I have added a new RewriteOption, \"AllowAnyURI\", in r1356115 which IMO\n> resolves this issue.  Other opinions are available! :)\n\nDoesn't mean \"AllowAnyURI\" option actually \"allow CVE-2011-3368/CVE-2011-4317\"?\n\nAnd is following statement correct?\n\n\"Declining, request-URI 'http://blahblah' is not a URL-path\"\n\nI believe http://blahblah is valid URL path.\n\nAnd what is problem with the patch I proposed? Is it vulnerable for CVE-2011-3368/CVE-2011-4317? I hope not.\n\nI think I just don't understand it.. :-)"}, {"count": 16, "tags": [], "text": "(In reply to comment #15)\n> (In reply to comment #14)\n> > I have added a new RewriteOption, \"AllowAnyURI\", in r1356115 which IMO\n> > resolves this issue.  Other opinions are available! :)\n> \n> Doesn't mean \"AllowAnyURI\" option actually \"allow\n> CVE-2011-3368/CVE-2011-4317\"?\n\nIf you write a rule that captures/substitutes unsafely, and opts into non-path arguments, yes.\n\n> \n> And is following statement correct?\n> \n> \"Declining, request-URI 'http://blahblah' is not a URL-path\"\n> \n> I believe http://blahblah is valid URL path.\n\nThe path is 1 component of a URL, we use the term \"URL-path\" for that component.\n\n> And what is problem with the patch I proposed? Is it vulnerable for\n> CVE-2011-3368/CVE-2011-4317? I hope not.\n> \n> I think I just don't understand it.. :-)\n\nIMO it is too narrow and does not force the user to opt in to the input sometimes not being a URL path (as it had been documented)", "attachment_id": null, "bug_id": 52774, "id": 160589, "time": "2012-07-11T12:46:34Z", "creator": "covener@gmail.com", "creation_time": "2012-07-11T12:46:34Z", "is_private": false}, {"count": 17, "tags": [], "bug_id": 52774, "attachment_id": null, "text": "Applied to 2.4.x in r1359687.\nReleased with 2.4.3.\nApplied to 2.2.x with r1375113.", "id": 161589, "time": "2012-08-21T16:28:53Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2012-08-21T16:28:53Z", "is_private": false}]