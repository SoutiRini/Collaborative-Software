[{"count": 0, "tags": [], "bug_id": 39593, "is_private": false, "text": "I have Apache 2.2.2 with mod_ssl, mod_proxy (and mod_proxy_http) and mod_cache\n(both mem & disk) on a RedHat EL4 U3 box. I have SSL termination enabled on my\n_default_:443 vhost and proxypass to HTTP on a backend Apache server. Files\nretrieved from the proxy endpoint are 100% cache miss in mod_cache. Relevant\nvhost configuration stanza looks like:\n\nSSLProxyEngine On\nProxyRequests Off\nProxyPass /s5/ http://rcdev1ws14/\nCacheEnable disk /\nCacheEnable disk http://rcdev1ws14/\nCacheEnable mem /\nCacheEnable mem http://rcdev1ws14/\nCacheRoot /var/run/httpd/cache\nCacheDirLength 1\nCacheDirLevels 1\nMCacheSize 20480\n# The following are me getting increasingly desparate to make mod_cache hit\nCacheIgnoreCacheControl On\nCacheStorePrivate On\nCacheStoreNoStore On\nCacheIgnoreHeaders User-Agent Accept Max-Forwards X-Forwarded-For\nX-Forwarded-Host X-Forwarded-Server Cookie Vary\n\nWhat's interesting is that the same configuration directives on my _default_:80\nvhost works properly. The cache hits.\n\nI added additional debugging statements to mod_cache (inline diff included\nbelow). Requesting the same file twice in a row, I grabbed the debug logs and\nhave included them below (removed ssl_engine_io and ssl_engine_shmcb class\nmessages, as they appear to be useless for current purposes). Notice that URL\ncanonicalisation is occurring AFTER mod_disk_cache attempts to look up the file\nin cache, but then stores the file using a key generated from the canonicalised\nURL. Clearly this must be the problem's root cause. I'm unclear about what needs\nto be changed, though.\n\n<<EndOfLogOutput\n[Tue May 16 14:07:20 2006] [info] [client 172.16.0.44] Connection to child 2\nestablished (server rcdev1ws18:443)\n[Tue May 16 14:07:20 2006] [info] Seeding PRNG with 648 bytes of entropy\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1752): OpenSSL:\nHandshake: start\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nbefore/accept initialization\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 read client hello A\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 write server hello A\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 write certificate A\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 write server done A\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 flush data\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 read client key exchange A\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 read finished A\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 write change cipher spec A\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 write finished A\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 flush data\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1598): Inter-Process\nSession Cache: request=SET status=OK\nid=150FA988C7DB59F6F35666ECF91FD055478CC00399AEA87E4E6E803D8A275A10 timeout=300s\n(session caching)\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1756): OpenSSL:\nHandshake: done\n[Tue May 16 14:07:20 2006] [info] Connection: Client IP: 172.16.0.44, Protocol:\nTLSv1, Cipher: RC4-SHA (128/128 bits)\n[Tue May 16 14:07:20 2006] [info] Initial (No.1) HTTPS request received for\nchild 2 (server rcdev1ws18:443)\n[Tue May 16 14:07:20 2006] [error] disk_cache: Failed to open file\n/var/run/httpd/cache/b/DgKJmDvOggzqD69@NEvzQ.header.\n[Tue May 16 14:07:20 2006] [debug] cache_storage.c(311): cache_select(): Decline\nto serve from provider (null).\n[Tue May 16 14:07:20 2006] [debug] cache_storage.c(311): cache_select(): Decline\nto serve from provider (null).\n[Tue May 16 14:07:20 2006] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /s5/images/login.gif\n[Tue May 16 14:07:20 2006] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /s5/images/login.gif\n[Tue May 16 14:07:20 2006] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //rcdev1ws14/images/login.gif\n[Tue May 16 14:07:20 2006] [debug] proxy_util.c(1378): [client 172.16.0.44]\nproxy: http: found worker http://rcdev1ws14/ for http://rcdev1ws14/images/login.gif\n[Tue May 16 14:07:20 2006] [debug] mod_proxy.c(756): Running scheme http handler\n(attempt 0)\n[Tue May 16 14:07:20 2006] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://rcdev1ws14/images/login.gif\n[Tue May 16 14:07:20 2006] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (rcdev1ws14)\n[Tue May 16 14:07:20 2006] [debug] proxy_util.c(1858): proxy: connecting\nhttp://rcdev1ws14/images/login.gif to rcdev1ws14:80\n[Tue May 16 14:07:20 2006] [debug] proxy_util.c(1951): proxy: connected\n/images/login.gif to rcdev1ws14:80\n[Tue May 16 14:07:20 2006] [debug] proxy_util.c(2141): proxy: HTTP: connection\ncomplete to 172.16.100.164:80 (rcdev1ws14)\n[Tue May 16 14:07:20 2006] [debug] mod_proxy_http.c(1448): proxy: start body send\n[Tue May 16 14:07:20 2006] [debug] mod_cache.c(602): cache: Caching url:\n/s5/images/login.gif\n[Tue May 16 14:07:20 2006] [debug] mod_cache.c(608): cache: Removing\nCACHE_REMOVE_URL filter.\n[Tue May 16 14:07:20 2006] [debug] mod_disk_cache.c(959): disk_cache: Stored\nheaders for URL http://rcdev1ws18:80/s5/images/login.gif?\n[Tue May 16 14:07:20 2006] [debug] mod_disk_cache.c(1048): disk_cache: Body for\nURL http://rcdev1ws18:80/s5/images/login.gif? cached.\n[Tue May 16 14:07:20 2006] [debug] mod_proxy_http.c(1537): proxy: end body send\n[Tue May 16 14:07:20 2006] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (rcdev1ws14)\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1770): OpenSSL: Write:\nSSL negotiation finished successfully\n[Tue May 16 14:07:20 2006] [info] [client 172.16.0.44] Connection closed to\nchild 2 with standard shutdown (server rcdev1ws18:443)\n[Tue May 16 14:07:20 2006] [info] [client 172.16.0.44] Connection to child 4\nestablished (server rcdev1ws18:443)\n[Tue May 16 14:07:20 2006] [info] Seeding PRNG with 648 bytes of entropy\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1752): OpenSSL:\nHandshake: start\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nbefore/accept initialization\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 read client hello A\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 write server hello A\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 write certificate A\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 write server done A\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 flush data\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 read client key exchange A\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 read finished A\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 write change cipher spec A\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 write finished A\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1760): OpenSSL: Loop:\nSSLv3 flush data\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1598): Inter-Process\nSession Cache: request=SET status=OK\nid=E086C9A9C157DF5AC6383786D1E5D270DA92C697B085ACBE65F239390CED592E timeout=300s\n(session caching)\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1756): OpenSSL:\nHandshake: done\n[Tue May 16 14:07:20 2006] [info] Connection: Client IP: 172.16.0.44, Protocol:\nTLSv1, Cipher: RC4-SHA (128/128 bits)\n[Tue May 16 14:07:20 2006] [info] Initial (No.1) HTTPS request received for\nchild 4 (server rcdev1ws18:443)\n[Tue May 16 14:07:20 2006] [error] disk_cache: Failed to open file\n/var/run/httpd/cache/b/DgKJmDvOggzqD69@NEvzQ.header.\n[Tue May 16 14:07:20 2006] [debug] cache_storage.c(311): cache_select(): Decline\nto serve from provider (null).\n[Tue May 16 14:07:20 2006] [debug] cache_storage.c(311): cache_select(): Decline\nto serve from provider (null).\n[Tue May 16 14:07:20 2006] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /s5/images/login.gif\n[Tue May 16 14:07:20 2006] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /s5/images/login.gif\n[Tue May 16 14:07:20 2006] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //rcdev1ws14/images/login.gif\n[Tue May 16 14:07:20 2006] [debug] proxy_util.c(1378): [client 172.16.0.44]\nproxy: http: found worker http://rcdev1ws14/ for http://rcdev1ws14/images/login.gif\n[Tue May 16 14:07:20 2006] [debug] mod_proxy.c(756): Running scheme http handler\n(attempt 0)\n[Tue May 16 14:07:20 2006] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://rcdev1ws14/images/login.gif\n[Tue May 16 14:07:20 2006] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (rcdev1ws14)\n[Tue May 16 14:07:20 2006] [debug] proxy_util.c(1858): proxy: connecting\nhttp://rcdev1ws14/images/login.gif to rcdev1ws14:80\n[Tue May 16 14:07:20 2006] [debug] proxy_util.c(1951): proxy: connected\n/images/login.gif to rcdev1ws14:80\n[Tue May 16 14:07:20 2006] [debug] proxy_util.c(2141): proxy: HTTP: connection\ncomplete to 172.16.100.164:80 (rcdev1ws14)\n[Tue May 16 14:07:20 2006] [debug] mod_proxy_http.c(1448): proxy: start body send\n[Tue May 16 14:07:20 2006] [debug] mod_cache.c(602): cache: Caching url:\n/s5/images/login.gif\n[Tue May 16 14:07:20 2006] [debug] mod_cache.c(608): cache: Removing\nCACHE_REMOVE_URL filter.\n[Tue May 16 14:07:20 2006] [debug] mod_disk_cache.c(959): disk_cache: Stored\nheaders for URL http://rcdev1ws18:80/s5/images/login.gif?\n[Tue May 16 14:07:20 2006] [debug] mod_disk_cache.c(1048): disk_cache: Body for\nURL http://rcdev1ws18:80/s5/images/login.gif? cached.\n[Tue May 16 14:07:20 2006] [debug] mod_proxy_http.c(1537): proxy: end body send\n[Tue May 16 14:07:20 2006] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (rcdev1ws14)\n[Tue May 16 14:07:20 2006] [debug] ssl_engine_kernel.c(1770): OpenSSL: Write:\nSSL negotiation finished successfully\n[Tue May 16 14:07:20 2006] [info] [client 172.16.0.44] Connection closed to\nchild 4 with standard shutdown (server rcdev1ws18:443)\nEndOfLogOutput\n\n--- mod_disk_cache.c 2006-04-21 18:53:06.000000000 -0700\n+++ mod_disk_cache.c.new        2006-05-16 13:32:12.000000000 -0700\n@@ -389,6 +389,7 @@\n     flags = APR_READ|APR_BINARY|APR_BUFFERED;\n     rc = apr_file_open(&dobj->hfd, dobj->hdrsfile, flags, 0, r->pool);\n     if (rc != APR_SUCCESS) {\n+        ap_log_error(APLOG_MARK, APLOG_ERR, 0, r->server, \"disk_cache: Failed t\no open file %s.\", dobj->hdrsfile);\n         return DECLINED;\n     }   \n\n@@ -404,6 +405,7 @@\n         apr_file_read_full(dobj->hfd, &expire, len, &len);\n\n         if (expire < r->request_time) {\n+            ap_log_error(APLOG_MARK, APLOG_ERR, 0, r->server, \"disk_cache: File\n %s in cache has expired.\", dobj->hdrsfile);\n             return DECLINED;\n         }   \n\n@@ -426,6 +428,7 @@\n         flags = APR_READ|APR_BINARY|APR_BUFFERED;\n         rc = apr_file_open(&dobj->hfd, dobj->hdrsfile, flags, 0, r->pool);\n         if (rc != APR_SUCCESS) {\n+            ap_log_error(APLOG_MARK, APLOG_ERR, 0, r->server, \"disk_cache: Fail\ned to open file %s.\", dobj->hdrsfile);\n             return DECLINED;\n         }   \n     }   \n@@ -457,6 +460,7 @@\n #endif\n     rc = apr_file_open(&dobj->fd, dobj->datafile, flags, 0, r->pool);\n     if (rc != APR_SUCCESS) {\n+        ap_log_error(APLOG_MARK, APLOG_ERR, 0, r->server, \"disk_cache: Failed\nto open file %s.\", dobj->datafile);\n         /* XXX: Log message */\n         return DECLINED;\n     }\n@@ -470,6 +474,7 @@\n     rc = file_cache_recall_mydata(dobj->hfd, info, dobj, r);\n     if (rc != APR_SUCCESS) {\n         /* XXX log message */\n+        ap_log_error(APLOG_MARK, APLOG_ERR, 0, r->server, \"disk_cache: Failed\nto retrieve file %s bytes.\", dobj->hdrsfile);\n         return DECLINED;\n     }\n\n--- cache_storage.c  2006-04-21 18:53:06.000000000 -0700\n+++ cache_storage.c.new 2006-05-16 13:32:28.000000000 -0700\n@@ -195,6 +195,9 @@\n             \n             if (list->provider->recall_headers(h, r) != APR_SUCCESS) {\n                 /* TODO: Handle this error */\n+                ap_log_error(APLOG_MARK, APLOG_DEBUG, APR_SUCCESS,\n+                             r->server,\n+                             \"cache_select(): Failed to recall_headers for\nprovider %s.\", list->provider_name);\n                 return DECLINED;\n             }\n\n@@ -305,6 +308,9 @@\n         }\n         case DECLINED: {\n             /* try again with next cache type */\n+            ap_log_error(APLOG_MARK, APLOG_DEBUG, APR_SUCCESS, r->server,\n+                  \"cache_select(): Decline to serve from provider %s.\",\n+                  cache->provider_name);\n             list = list->next;\n             continue;\n         }", "id": 89173, "time": "2006-05-16T21:08:55Z", "creator": "mhan@postini.com", "creation_time": "2006-05-16T21:08:55Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 39593, "attachment_id": null, "id": 89181, "creation_time": "2006-05-16T23:10:38Z", "time": "2006-05-16T23:10:38Z", "creator": "rpluem@apache.org", "text": "This bug is somewhat similar to #38017. I can confirm it. Could you please give\nthe attached patch a try? It is against trunk, but also works against httpd 2.2.2.", "is_private": false}, {"count": 2, "tags": [], "bug_id": 39593, "attachment_id": 18296, "id": 89182, "creation_time": "2006-05-16T23:11:15Z", "time": "2006-05-16T23:11:15Z", "creator": "rpluem@apache.org", "text": "Created attachment 18296\nPatch against trunk", "is_private": false}, {"count": 3, "tags": [], "bug_id": 39593, "text": "I saw that bug and even tried backing out the patch from the 2.2.2 code. But the\npatch you provided seems to work fine. Thanks!", "id": 89185, "time": "2006-05-16T23:23:24Z", "creator": "mhan@postini.com", "creation_time": "2006-05-16T23:23:24Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 39593, "attachment_id": null, "text": "Commited to trunk as r407357\n(http://svn.apache.org/viewcvs?rev=407268&view=rev). Thanks for testing.", "id": 89222, "time": "2006-05-17T19:17:49Z", "creator": "rpluem@apache.org", "creation_time": "2006-05-17T19:17:49Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 39593, "is_private": false, "id": 89493, "creation_time": "2006-05-25T18:43:27Z", "time": "2006-05-25T18:43:27Z", "creator": "rpluem@apache.org", "text": "Proposed for backport to 2.2.x as r409425\n(http://svn.apache.org/viewcvs?rev=409425&view=rev).", "attachment_id": null}, {"count": 6, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "text": "Backported to 2.2.x as r425035 (http://svn.apache.org/viewvc?rev=425035&view=rev).", "id": 91545, "time": "2006-07-24T14:01:28Z", "bug_id": 39593, "creation_time": "2006-07-24T14:01:28Z", "is_private": false}]