[{"count": 0, "tags": [], "creator": "marco.casavecchia@comune.ancona.it", "text": "I have an Apache web server that serves java applications with mod_proxy over ssl.\nIn this application there is a page that lets users to upload binary files.\nWhen the proxy works over http (without SSL) all the things works good, but when\nI switch the proxy from clear http to SSL the POST of binary data to the sever\nlacks of some MIME headers.\n\nIn other words:\n1) Client --(http)--> Apache(mod_proxy) ---------(http)->Tomcat Application [OK]\n2) Client --(https)--> Apache(mod_ssl+mod_proxy)-(http)->Tomcat Application [KO]\n\nI sniffed the connection between Apache and Tomcat with tcpdump and the dump of\nthe 2 connections follows:\n\n--------8<------8<----[Case 1 Start]-----8<-------8<-----------\nPOST\n/studiare/comunicazioni/uploadFile.do?operazione=inserisci&queryParam=Successful\nHTTP/1.1^M\nHost: comancona5.comune.ancona.it:8180^M\nUser-Agent: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.12) Gecko/20050920\nFirefox/1.0.7^M\nAccept:\ntext/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5^M\nAccept-Language: en-us,en;q=0.5^M\nAccept-Encoding: gzip,deflate^M\nAccept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7^M\nReferer:\nhttp://www.ankonascuola.it/studiare/comunicazioni/upload.do?subdirectory=WEB-INF/allegati/10^M\nCookie: JSESSIONID=91BE6C6E3F6792B2F45F539AA3BD7ECC^M\nContent-Type: multipart/form-data;\nboundary=---------------------------13517973694920679171504569917^M\nMax-Forwards: 10^M\nX-Forwarded-For: 81.117.60.241^M\nX-Forwarded-Host: www.ankonascuola.it^M\nX-Forwarded-Server: www.ankonascuola.it^M\nContent-Length: 94199^M\n^M\n-----------------------------13517973694920679171504569917^M\nContent-Disposition: form-data; name=\"theFile\"; filename=\"Manuale_COFAX.doc\"^M\nContent-Type: application/msword^M\n^M\n\u00d0\u00cf^Q\u00e0\u00a1\u00b1^Z\u00e1^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@;^@^C^@\u00fe\u00ff  \n^@^F^@^@^@^@^@^@^@^@^@^@^@^B^@^@^@\u00b4^@^@^@^@^@^@^@^@^P^@^@^B^@^@^@^A^@^@^@\u00fe\u00ff\u00ff\u00ff^@^@^@^@^@^@^@^@~@^@^@^@\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00fd\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00fe\u00ff\u00ff\u00ff^M^@^@^@^E^@^@^@^F^@^@^@^G^@^@^@^H^@^@^@\n^@^@^@@    \n[SNIP]\n--------8<------8<----[Case 1 End]-----8<-------8<-----------\n\n--------8<------8<----[Case 2 Start]-----8<-------8<-----------\nPOST\n/studiare/comunicazioni/uploadFile.do?operazione=inserisci&queryParam=Successful\nHTTP/1.1^M\nHost: comancona5.comune.ancona.it:8180^M\nUser-Agent: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.12) Gecko/20050920\nFirefox/1.0.7^M\nAccept:\ntext/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5^M\nAccept-Language: en-us,en;q=0.5^M\nAccept-Encoding: gzip,deflate^M\nAccept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7^M\nReferer:\nhttps://www.ankonascuola.it/studiare/comunicazioni/upload.do?subdirectory=WEB-INF/allegati/10^M\nCookie: JSESSIONID=FAAF6563D8ADE2DFA1C6EED5C8654983^M\nContent-Type: multipart/form-data;\nboundary=---------------------------14979831520386643701129566413^M\nMax-Forwards: 10^M\nX-Forwarded-For: 81.117.60.241^M\nX-Forwarded-Host: www.ankonascuola.it^M\nX-Forwarded-Server: www.ankonascuola.it^M\nContent-Length: 94199^M\n^M\n^D~E\u00e1^@~Vu/\u00b9^Y^P^Q[hGU\u00ea~X~GK*b\u00c3^L\u00b6\u00ecf\u00b4~[ar\u00e2~X\u00ab\u00c6~AS)\u00c7\u00cb^R~@p.~FEl~Y@mB^@\u00ed^S4~F~Ss^@1gu^TF\u00e4\n\u00bc\u00cfu^]~J\u00e2~X\u00cb^L~B\u00f7X>\u00fc\u00a2^D~K~I\u00b9hD\u00bb~M%\u00d0^A^?x~_\n\u00de;5\u00fa\u00c3I??2\u00f2\u00f8a \u00ba\u00f8\u00e6\u00c5| X\u00f0^_;\n[SNIP]\n--------8<------8<----[Case 2 End]-----8<-------8<-----------\n\nIt seems that in the second case, after the \"ContentLength\" header, the first\n\"boundary\" was trimmed out.. this cause that the java application never find the\nbinary data of the POST. (and send me a \"Null Pointer Exception..)\n\nHope this can help you to find what happened.\n\nPS: Note that the server is a \"NameVirtualHost and the part of httpd.conf and\nssl.conf follows:\n\n--------8<----------8<---[Start httpd.conf]-----8<-------------8<---------\n<VirtualHost 81.117.60.253>\n    ServerName www.ankonascuola.it\n    DocumentRoot \"/webhome/ankonascuola\"\n...\n     <Location /studiare>\n        Order deny,allow\n        Deny from all\n        Allow from all\n\n        ProxyPass http://comancona5.comune.ancona.it:8180/studiare\n        ProxyPassReverse http://comancona5.comune.ancona.it:8180/studiare\n    </Location>\n...\n</virtualhost>\n--------8<----------8<---[End httpd.conf]-----8<---------------8<---------\n\n--------8<----------8<---[Start ssl.conf]-----8<-------------8<---------\n<VirtualHost 81.117.60.253:443>\n\n#   General setup for the virtual host\nDocumentRoot \"/webhome/ankonascuola_ssl\"\nServerName www.ankonascuola.it:443\n....\nSetEnvIf User-Agent \".*MSIE.*\" \\\n         nokeepalive ssl-unclean-shutdown \\\n         downgrade-1.0 force-response-1.0\n    <Location /studiare>\n        Order deny,allow\n        Deny from all\n        Allow from all\n\n        ProxyPass http://comancona5.comune.ancona.it:8180/studiare\n        ProxyPassReverse http://comancona5.comune.ancona.it:8180/studiare\n    </Location>\n....\n</Virtualhost>\n--------8<----------8<---[End ssl.conf]-----8<---------------8<---------\n\nSorry for my poor english :O)", "id": 83085, "time": "2005-12-01T17:50:18Z", "bug_id": 37739, "creation_time": "2005-12-01T17:50:18Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "rpluem@apache.org", "text": "This looks like bug 37145 to me. Please try the patch attached to this bug and\nlet me know if it helps.", "id": 83100, "time": "2005-12-01T22:24:06Z", "bug_id": 37739, "creation_time": "2005-12-01T22:24:06Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "marco.casavecchia@comune.ancona.it", "text": "GREAT!\nThe patch works very well!\nThank you very much for your support and for your fast response.\n\nPS: Sorry for my late reply but I was in holiday. :O)\n\n*** This bug has been marked as a duplicate of 37145 ***", "id": 83367, "time": "2005-12-07T12:21:39Z", "bug_id": 37739, "creation_time": "2005-12-07T12:21:39Z", "is_private": false, "attachment_id": null}]