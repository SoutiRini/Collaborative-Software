[{"count": 0, "tags": [], "creator": "antony.bowesman@williamhill.com.au", "is_private": false, "text": "Seems like there's a flaw in the shutdown logic\n\nWhen a test is running, it goes through JMeterThread. executeSamplePackage() where it goes into the delay(pack.getTimers()) call.\n\nIf you shut down a test, it will interrupt the timers and you will see these messages in jmeter.log\n\njmeter.threads.JMeterThread: The delay timer was interrupted - probably did not wait as long as intended\n\nAs a result, all threads blocked waiting to sample() will get released at pretty much the same time and as the JMeter iteration logic does the delay _before_ the sample() rather than after, it means all threads will go into sample() at about the same time.\n\nWe've had cases where we've had to stop a production test as we're breaking it and the shutdown exacerbates the problem.\n\nAs the JMeterThread.stop() sets the running flag to false, it's probably a simple fix to wrap the code following the delay() call with if (running) {\n\n}", "id": 200185, "time": "2017-08-03T23:36:34Z", "bug_id": 61380, "creation_time": "2017-08-03T23:36:34Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 61380, "is_private": false, "id": 200188, "attachment_id": null, "creator": "sebb@apache.org", "creation_time": "2017-08-04T10:57:06Z", "time": "2017-08-04T10:57:06Z", "text": "(In reply to Antony Bowesman from comment #0)\n> Seems like there's a flaw in the shutdown logic\n> \n> When a test is running, it goes through JMeterThread. executeSamplePackage()\n> where it goes into the delay(pack.getTimers()) call.\n> \n> If you shut down a test, it will interrupt the timers and you will see these\n> messages in jmeter.log\n> \n> jmeter.threads.JMeterThread: The delay timer was interrupted - probably did\n> not wait as long as intended\n\nThose messages should be suppressed if 'running' is false.\n\n> As a result, all threads blocked waiting to sample() will get released at\n> pretty much the same time and as the JMeter iteration logic does the delay\n> _before_ the sample() rather than after, it means all threads will go into\n> sample() at about the same time.\n> \n> We've had cases where we've had to stop a production test as we're breaking\n> it and the shutdown exacerbates the problem.\n> \n> As the JMeterThread.stop() sets the running flag to false, it's probably a\n> simple fix to wrap the code following the delay() call with if (running) {\n> \n> }\n\nMay have to do a bit more than that in order to complete transaction samplers."}, {"count": 2, "tags": [], "creator": "antony.bowesman@williamhill.com.au", "text": "You're right with more needed, I just didn't understand the extra logic it was going through.\n\nI originally assumed that there would be a public boolean isRunning() method on the JMeterThread instance and was surprised to find there wasn't. Would this be a chance to expose state like that, as it would allow, particularly Java, samplers to also check state.", "id": 200212, "time": "2017-08-07T00:47:14Z", "bug_id": 61380, "creation_time": "2017-08-07T00:47:14Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 61380, "text": "Author: pmouawad\nDate: Mon Aug  7 20:49:23 2017\nNew Revision: 1804356\n\nURL: http://svn.apache.org/viewvc?rev=1804356&view=rev\nLog:\nBug 61380 - JMeter shutdown using timers releases thundering herd of interrupted samplers\nWithin this bug,  improve fix for bug 57958 which does not handle correctly the shutdown.\nBugzilla Id: 61380\n\nModified:\n    jmeter/trunk/src/core/org/apache/jmeter/threads/JMeterThread.java\n    jmeter/trunk/xdocs/changes.xml", "id": 200223, "attachment_id": null, "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-08-07T20:51:31Z", "time": "2017-08-07T20:51:31Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 61380, "text": "Hello,\nCan you try nightly build tomorrow and give your feedback ?\nhttp://jmeter.apache.org/nightly.html\nThanks", "id": 200224, "attachment_id": null, "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2017-08-07T20:52:13Z", "time": "2017-08-07T20:52:13Z", "is_private": false}, {"count": 5, "tags": [], "creator": "antony.bowesman@williamhill.com.au", "is_private": false, "text": "Tested the 3.1 build and the 3.2 nightly build, ref apache-jmeter-r1804400 and it fixed the problem.\n\nThanks!", "id": 200244, "time": "2017-08-09T00:25:51Z", "bug_id": 61380, "creation_time": "2017-08-09T00:25:51Z", "attachment_id": null}]