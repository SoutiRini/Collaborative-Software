[{"count": 0, "tags": [], "text": "The offending function is here:\n\nhttps://github.com/apache/poi/blob/d94ff1aa8e92b443e06008c35e49a6d1f5f891ea/src/ooxml/java/org/apache/poi/xssf/streaming/SheetDataWriter.java#L378\n\n    boolean dispose() throws IOException {\n        _out.close();\n        return _fd.delete();\n    }\n\nThe problem is when _out.close() throws an exception, the file handle is never deleted, and to my knowledge there is no way for an outside library user to EVER delete the file?\n\nI suggest the function be changed like so:\n\n    boolean dispose() throws IOException {\n        final boolean ret;\n        try {\n            _out.close();\n        } finally {\n            ret = _fd.delete();\n        }\n        return ret;\n    }\n\nThe way I stumbled upon this bug and what causes it to be a blocking issue is our /tmp is a tmpfs mount with a 2 gigabyte size limit, temporary compression was turned off and SXSSF created a temporary .xml file that filled up the 2 gigabyte limit on /tmp, an exception was thrown from .flush() that the drive was out of space, and when .dispose() was called in a finally block it did not delete the file, causing all subsequent runs of SXSSF to fail in the same way since the drive was still full.\n\nIf I can provide more info or help please let me know. Thanks!", "attachment_id": null, "id": 190191, "creator": "admin.apache@moparisthebest.com", "time": "2016-04-12T14:50:28Z", "bug_id": 59312, "creation_time": "2016-04-12T14:50:28Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 59312, "text": "Thanks for the patch! Applied in r1738848.\n\nDo you think you could also write a unit test to simulate running out of disk space (might need to create some OutputStream that has a fixed size that you can easily exceed)?", "id": 190196, "time": "2016-04-12T18:50:07Z", "creator": "onealj@apache.org", "creation_time": "2016-04-12T18:50:07Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 59312, "attachment_id": null, "id": 191145, "time": "2016-05-20T18:07:50Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2016-05-20T18:07:50Z", "is_private": false, "text": "I took a look and did not see an easy way to do unit-testing of this particular feature. Some other unit-tests cover the \"good\" case of deleting the file already, the rest needs to be tested manually for now... Still setting this to fixed as the code was adjusted accordingly."}]