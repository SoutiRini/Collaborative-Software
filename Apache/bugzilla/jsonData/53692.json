[{"count": 0, "tags": [], "bug_id": 53692, "attachment_id": null, "is_private": false, "id": 161246, "time": "2012-08-10T21:43:03Z", "creator": "bannis@wne.edu", "creation_time": "2012-08-10T21:43:03Z", "text": "Module mod_auth_form is losing POSTed data with default encoding before it can be made part of a login form. This does not happen with multipart/form encoding. The KEEP_BODY input filter is in place. Some simple debugging suggests that the issue is with the module's call to ap_parse_form_data. Whatever that function is doing with the data it reads as part of the subrequest, it's not making it back to the main input stream."}, {"count": 1, "tags": [], "bug_id": 53692, "text": "This is currently biting me. The whole point of \"Inline Login with Body Preservation\" is impossible unless the original POST data can be seen by the login page.", "id": 167000, "time": "2013-05-02T17:41:22Z", "creator": "bugzilla-asf@dm.cobite.com", "creation_time": "2013-05-02T17:41:22Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 53692, "attachment_id": null, "text": "In contrary to the findings in the original entry, I have found the POST data is lost irrespective of the form encoding.\n\nI have created a test case which I will attach.\n\n\nformauth.conf => place in /etc/httpd/conf.d or equiv\nstart.html => place in /var/www/form_auth_test as per conf\nlogin.shtml => ditto (to activate this change the ErrorDocument in conf)\nlogin.cgi => place in /var/www/form_auth_test_cgi as per conf \n\nHere are some comments regarding the test case:\n\nIn this example I will show that by the time the ErrorDocument for 401 is invoked (which is the way \"inline authentication with body preservation\" works), that the POST body has been discarded and the request has been converted from POST to GET (these are probably related).\n\nSo in this example there is a page /start.html which is NOT within the \"private\" area of the site.  It has a simple form which gets POSTed to /private/target.html (which doesn't need to exist because we fail before it's relevant).\n\nThe authentication hook intercepts the POST, and the mod_auth_form throws a 401, which is handled with the ErrorDocument 401 /cgi-bin/login.cgi (or /login.shtml)\n\nWhen login.cgi runs there is no POST data on STDIN and REQUEST_METHOD is always GET.\n\nBTW, I have also tried using ErrorDocument 401 /login.shtml (via mod_include) but the result is the same.", "id": 167261, "time": "2013-05-17T14:48:13Z", "creator": "bugzilla-asf@dm.cobite.com", "creation_time": "2013-05-17T14:48:13Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 53692, "attachment_id": 30295, "is_private": false, "id": 167267, "time": "2013-05-17T14:55:13Z", "creator": "bugzilla-asf@dm.cobite.com", "creation_time": "2013-05-17T14:55:13Z", "text": "Created attachment 30295\nhttpd conf file for test case, put in /etc/httpd/conf.d or equiv."}, {"count": 4, "tags": [], "creator": "bugzilla-asf@dm.cobite.com", "text": "Created attachment 30296\nstart page for test case. put in /var/www/form_auth_test", "id": 167268, "time": "2013-05-17T14:55:44Z", "bug_id": 53692, "creation_time": "2013-05-17T14:55:44Z", "is_private": false, "attachment_id": 30296}, {"count": 5, "tags": [], "bug_id": 53692, "attachment_id": 30297, "is_private": false, "id": 167269, "time": "2013-05-17T14:56:03Z", "creator": "bugzilla-asf@dm.cobite.com", "creation_time": "2013-05-17T14:56:03Z", "text": "Created attachment 30297\nlogin form generator - can't see POST data. put in /var/www/form_auth_test_cgi"}, {"count": 6, "tags": [], "bug_id": 53692, "attachment_id": 30298, "text": "Created attachment 30298\nalternative login handler using mod_include. put in /var/www/form_auth_test", "id": 167270, "time": "2013-05-17T14:56:26Z", "creator": "bugzilla-asf@dm.cobite.com", "creation_time": "2013-05-17T14:56:26Z", "is_private": false}, {"count": 7, "tags": [], "creator": "bannis@wne.edu", "text": "There may be more than one point of failure. A quick patch to mod_auth_form to pass the kept body from the body-parsing subrequest to the current request was enough to let a custom module find the body for drawing a login page, but a cgi still didn't see it. I don't know if it's related, but if you put a hard-coded body into the login page, mod_auth_form sees it, but it doesn't make it to the destination cgi", "id": 167275, "time": "2013-05-17T22:08:44Z", "bug_id": 53692, "creation_time": "2013-05-17T22:08:44Z", "is_private": false, "attachment_id": null}, {"count": 8, "attachment_id": null, "creator": "bugzilla-asf@dm.cobite.com", "text": "I have debugged this as well and found that the ErrorDocument 401 handler will ultimately end up calling \"internal_internal_redirect\" where a new request_rec is created for the 401 handler, and the kept_body is not passed to it. I.e it MAY need:\n\n  new->kept_body = r->kept_body;  // on-or-around line 488 of http_request.c\n\nHaving \"fixed\" this and gone back into the debugger, I found that the kept_body filter ignores r->kept_body unless ap_filter_t::ctx  variable is initialized properly, and the filters on the original request and on the request created in internal_internal_redirect are not the same \"instances\" so we have f->ctx is null in the subrequest.\n\nThis is where my ability to debug ended.", "id": 167309, "time": "2013-05-20T16:03:13Z", "bug_id": 53692, "creation_time": "2013-05-20T16:03:13Z", "tags": [], "is_private": false}, {"count": 9, "tags": [], "text": "Oh and of course, you are right (comment#7) that the mod_auth_form is ALSO missing:\n  \n  r->kept_body = rr->kept_body; // on-or-around line 1016 of mod_auth_form.c\n\nThat is a prerequisite to dropping the kept_body in internal_internal_redirect.", "attachment_id": null, "id": 167310, "creator": "bugzilla-asf@dm.cobite.com", "time": "2013-05-20T16:06:21Z", "bug_id": 53692, "creation_time": "2013-05-20T16:06:21Z", "is_private": false}, {"count": 10, "tags": [], "text": "Created attachment 30306\na hack which makes it work\n\nThe attached patch makes this work for me with a CGI ErrorDocument, but still doesn't work with mod_include ErrorDocument. \n\nI cannot vouch for the overall correctness of this.", "attachment_id": 30306, "id": 167328, "creator": "bugzilla-asf@dm.cobite.com", "time": "2013-05-21T17:58:38Z", "bug_id": 53692, "creation_time": "2013-05-21T17:58:38Z", "is_private": false}]