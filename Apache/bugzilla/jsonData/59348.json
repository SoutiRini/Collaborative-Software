[{"count": 0, "tags": [], "bug_id": 59348, "attachment_id": null, "id": 190341, "time": "2016-04-18T12:10:22Z", "creator": "alex@shopblocks.com", "creation_time": "2016-04-18T12:10:22Z", "is_private": false, "text": "When attempting a graceful reload in Apache 2.4.20, if there is a long-running (or currently active) connection on HTTP then the reload handles perfectly fine. The long running process continues without disruption.\n\nHowever, if the user is on HTTPS (we have H2 setup, but it may be a general SSL issue), then when the reload comes in, it terminates the HTTPS connection and throws a segmentation fault. \n\nIt seems that apache is closing all active SSL connections during a graceful reload, but HTTP connections reload.\n\n\n[Mon Apr 18 11:54:07.580084 2016] [mpm_prefork:notice] [pid 5483] AH00171: Graceful restart requested, doing restart\n[Mon Apr 18 11:54:09.174860 2016] [mpm_prefork:notice] [pid 5483] AH00163: Apache/2.4.20 (Ubuntu) OpenSSL/1.0.2g configured -- resuming normal operations\n[Mon Apr 18 11:54:09.180786 2016] [core:notice] [pid 5483] AH00094: Command line: '/usr/sbin/apache2'\n[Mon Apr 18 11:54:13.198995 2016] [core:notice] [pid 5483] AH00051: child pid 5487 exit signal Segmentation fault (11), possible coredump in /etc/apache2"}, {"count": 1, "tags": [], "creator": "stefan@eissing.org", "attachment_id": null, "is_private": false, "id": 190343, "time": "2016-04-18T12:13:38Z", "bug_id": 59348, "creation_time": "2016-04-18T12:13:38Z", "text": "Do you have or are you able to create a stack trace of the crash? That would help immensely."}, {"count": 2, "tags": [], "bug_id": 59348, "text": "Would you be able to assist in how to get the stack trace? Is strace enough?", "id": 190344, "time": "2016-04-18T12:27:05Z", "creator": "alex@shopblocks.com", "creation_time": "2016-04-18T12:27:05Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 59348, "text": "Of course, are you familiar with this guide? https://httpd.apache.org/dev/debugging.html\n\nThe section https://httpd.apache.org/dev/debugging.html#crashes about intermittent crashes seems to apply best.", "id": 190345, "time": "2016-04-18T12:31:37Z", "creator": "stefan@eissing.org", "creation_time": "2016-04-18T12:31:37Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "alex@shopblocks.com", "is_private": false, "text": "We have ran strace, and the pid's do not appear to match up.\n\nThe command we start the server with is:\n\nstrace -ff -o /var/log/strace_apache.log -r apache2ctl start\n\nand to reload the server we run:\n\nstrace -ff -o /var/log/strace_apache.log -r apache2ctl graceful\n\nWe get an a series of files like this:\n\n-rw-r--r--  1 root      root      5895 Apr 18 12:47 strace_apache.log.7791\n-rw-r--r--  1 root      root      6449 Apr 18 12:46 strace_apache.log.7792\n-rw-r--r--  1 root      root   3337877 Apr 18 12:46 strace_apache.log.7793\n-rw-r--r--  1 root      root   3338203 Apr 18 12:47 strace_apache.log.7794\n-rw-r--r--  1 root      root      5895 Apr 18 12:47 strace_apache.log.7841\n-rw-r--r--  1 root      root      6449 Apr 18 12:47 strace_apache.log.7842\n-rw-r--r--  1 root      root   3348810 Apr 18 12:47 strace_apache.log.7843\n-rw-r--r--  1 root      root   3346468 Apr 18 12:47 strace_apache.log.7844\n-rw-r--r--  1 root      root      5895 Apr 18 12:47 strace_apache.log.7863\n-rw-r--r--  1 root      root      6449 Apr 18 12:47 strace_apache.log.7864\n-rw-r--r--  1 root      root   3346488 Apr 18 12:47 strace_apache.log.7865\n-rw-r--r--  1 root      root   3346357 Apr 18 12:47 strace_apache.log.7866\n\nBut our pid for the segmentation fault:\n\n[Mon Apr 18 12:47:35.214485 2016] [mpm_prefork:notice] [pid 7601] AH00171: Graceful restart requested, doing restart\n[Mon Apr 18 12:47:37.483267 2016] [http2:warn] [pid 7820] [client 10.131.16.11:33950] AH03198: h2_mplx(5): release, waiting for 5 seconds now for 1 h2_workers to return, have still 1 requests outstanding\n[Mon Apr 18 12:47:37.483471 2016] [http2:warn] [pid 7820] [client 10.131.16.11:33950] ->03198: h2_stream(5-5): POST pokpokpok-admin.myshopblocks.com /test_long_post.php -> ? 0[orph=1/started=1/done=0/eos_in=1/eos_out=0]\n[Mon Apr 18 12:47:37.568779 2016] [mpm_prefork:notice] [pid 7601] AH00163: Apache/2.4.20 (Ubuntu) OpenSSL/1.0.2g configured -- resuming normal operations\n[Mon Apr 18 12:47:37.568923 2016] [core:notice] [pid 7601] AH00094: Command line: '/usr/sbin/apache2'\n[Mon Apr 18 12:47:42.483615 2016] [http2:warn] [pid 7820] [client 10.131.16.11:33950] AH03198: h2_mplx(5): release, waiting for 10 seconds now for 1 h2_workers to return, have still 1 requests outstanding\n[Mon Apr 18 12:47:44.592840 2016] [core:notice] [pid 7601] AH00051: child pid 7820 exit signal Segmentation fault (11), possible coredump in /etc/apache2\n\ndoesn't appear to line up at all.\n\nAny insight as to which strace file we hould be uploading?\n\nProviding all seems counter-productive.", "id": 190347, "time": "2016-04-18T12:54:24Z", "bug_id": 59348, "creation_time": "2016-04-18T12:54:24Z", "attachment_id": null}, {"count": 5, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "is_private": false, "id": 190348, "time": "2016-04-18T12:55:23Z", "bug_id": 59348, "creation_time": "2016-04-18T12:55:23Z", "text": "Please refer to the section about running gdb on your core file and obtaining backtraces of the process that crashed."}, {"count": 6, "tags": [], "bug_id": 59348, "text": "The issue has been confirmed to be with http2. Disabling the module for http2 and we can no longer reproduce this issue.\n\nWith regards to gdb, we do not have the ability to recompile apache with debug flags, is there another way to get gdb stack traces?", "id": 190349, "time": "2016-04-18T12:58:11Z", "creator": "alex@shopblocks.com", "creation_time": "2016-04-18T12:58:11Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 59348, "text": "Thanks for the information. I am able to reproduce this now. Analysing...", "id": 190350, "time": "2016-04-18T13:10:51Z", "creator": "stefan@eissing.org", "creation_time": "2016-04-18T13:10:51Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "alex@shopblocks.com", "attachment_id": null, "text": "Anything else we can do to assist this? Or do you have the information you require to debug it yourself?", "id": 190351, "time": "2016-04-18T13:39:51Z", "bug_id": 59348, "creation_time": "2016-04-18T13:39:51Z", "is_private": false}, {"text": "What I can reproduce here:\n\n- just calling 'apachectl -k graceful' works fine on my test setup (2.4.20)\n- same for 'apachectl -k restart'\n\n- I *do* get segmenation faults when I replace files in htdocs that are currently transferred.\n\nQuestion: do you remove/touch files while doing your graceful restart? Then we would be on the same page and I am on the correct track.\n\nTo verify, you could also *just* issue the apachectl -k graceful and see if that works for you or has the same effect.\n\nThanks!", "tags": [], "bug_id": 59348, "attachment_id": null, "count": 9, "id": 190354, "time": "2016-04-18T15:42:59Z", "creator": "stefan@eissing.org", "creation_time": "2016-04-18T15:42:59Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 59348, "text": "During our process, we are adding new virtual hosts with SSL certificates to the /etc/apache2/sites-available (and enabling them), then doing a reload (/etc/init.d/apache2 reload - Which translates into graceful).\n\nUsing `apache2ctl -k graceful` does not affect this. The issue still happens.\n\nWe are also modifying the files within the /var/www/sites folder (DocumentRoot).\n\nThis issue _only_ happens on http2, using apache 2.4.20 with http2 module disabled works as expected with no code changes.", "id": 190355, "time": "2016-04-18T15:50:44Z", "creator": "alex@shopblocks.com", "creation_time": "2016-04-18T15:50:44Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "bug_id": 59348, "text": "Note. It only fails under HTTPS, HTTP seems fine. (even with the http2 module enabled)", "id": 190356, "time": "2016-04-18T15:51:14Z", "creator": "alex@shopblocks.com", "creation_time": "2016-04-18T15:51:14Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "creator": "stefan@eissing.org", "attachment_id": 33777, "is_private": false, "id": 190374, "time": "2016-04-19T11:31:29Z", "bug_id": 59348, "creation_time": "2016-04-19T11:31:29Z", "text": "Created attachment 33777\nrestart segfault patch on mod_http2\n\nProposed patch to fix the segfault when updating files in document root."}, {"count": 13, "attachment_id": null, "creator": "stefan@eissing.org", "text": "Do you have a chance to test the supplied patch?", "id": 190376, "time": "2016-04-19T11:31:52Z", "bug_id": 59348, "creation_time": "2016-04-19T11:31:52Z", "tags": [], "is_private": false}, {"count": 14, "tags": [], "bug_id": 59348, "text": "1. How would we apply the patch?\n\n2. For us, the issue appeared to happen when the virtualhost file (config) itself changed. Not necessarily the DocumentRoot content.\n\nCan you confirm that you can replicate / this fixed the virtualhost itself changing?", "id": 190377, "time": "2016-04-19T11:33:56Z", "creator": "alex@shopblocks.com", "creation_time": "2016-04-19T11:33:56Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "bug_id": 59348, "attachment_id": null, "id": 190378, "time": "2016-04-19T11:39:07Z", "creator": "stefan@eissing.org", "creation_time": "2016-04-19T11:39:07Z", "is_private": false, "text": "1. The patch can only help if you can build your httpd from source. Where did you get your httpd from?\n\n2. I can repoduce the problem when a file being streamed out is replaced on disk. With the patch I can restart the server and no crashes occur. I can also reproduce your observations that on http: urls, the problem does not happen at all. In short: I am very confident that the patch addresses your issue.\n\n1b. If you are unable to rebuild the server, do you have the 2.4.20 apxs binary on your system? Then I could offer you a standalone github checkout that only builds mod_http2 using your apxs. Should be much simpler."}, {"count": 16, "tags": [], "creator": "alex@shopblocks.com", "attachment_id": null, "is_private": false, "id": 190379, "time": "2016-04-19T11:40:04Z", "bug_id": 59348, "creation_time": "2016-04-19T11:40:04Z", "text": "Sorry. Amendment to the previous statement.\n\nThe crash for us happened when somebody was connected via SSL (HTTP/2.0 only), and any graceful restart was attempted.\n\nWe managed to replicate it with a simple test script that effectively had a long running process in PHP (for loop with password_hash()), and in the terminal at the same time as it was running, gracefully restart apache.\n\nThere was no files changing anywhere on the DocumentRoot, and there was no file changing in the VirtualHost.\n\nThese were red-herrings for us, and where my previous statement came from, but our simple test proved that it was simply down to reloading apache whilst a live HTTPS connection was active / live."}, {"count": 17, "tags": [], "bug_id": 59348, "text": "Response to your message:\n\n> 1. The patch can only help if you can build your httpd from source. Where did you get your httpd from?\n\n1. We got our version from the apt repository with a PPA to get version 2.4.*\n\n> 2. I can repoduce the problem when a file being streamed out is replaced on disk. With the patch I can restart the server and no crashes occur. I can also reproduce your observations that on http: urls, the problem does not happen at all. In short: I am very confident that the patch addresses your issue.\n\nI think this is a separate issue that was found then, since we aren't replacing any files as explained in the previous message.\n\n> 1b. If you are unable to rebuild the server, do you have the 2.4.20 apxs binary on your system? Then I could offer you a standalone github checkout that only builds mod_http2 using your apxs. Should be much simpler.\n\nI have no idea what that means. At lunch i'll setup a new VM to test the patch, if you can guide how to modify the files. Is it simply checkout the full source, git apply that patch, and _then_ compile / make?", "id": 190380, "time": "2016-04-19T11:44:13Z", "creator": "alex@shopblocks.com", "creation_time": "2016-04-19T11:44:13Z", "is_private": false, "attachment_id": null}, {"text": "Probably the one from https://launchpad.net/~ondrej/+archive/ubuntu/apache2 or similar.\n\nThe problem for you is that these installations do not include all libraries and header files with which to build httpd and mod_http2. If you are unfamiliar with such things, it might take some time to get things right.\n\nI will publish a new release (1.4.7) on github https://github.com/icing/mod_h2 that has this patch - which definitely fixes *one* problem. You could contact the supplier of your PPA if he/she is willing to make a new release or to at least give you a mod_http2 shared module for testing.", "tags": [], "bug_id": 59348, "attachment_id": null, "count": 18, "id": 190381, "time": "2016-04-19T12:00:23Z", "creator": "stefan@eissing.org", "creation_time": "2016-04-19T12:00:23Z", "is_private": false}, {"count": 19, "tags": [], "creator": "stefan@eissing.org", "attachment_id": null, "is_private": false, "id": 190383, "time": "2016-04-19T12:10:04Z", "bug_id": 59348, "creation_time": "2016-04-19T12:10:04Z", "text": "Released at https://github.com/icing/mod_h2/releases/tag/v1.4.7"}, {"count": 20, "tags": [], "bug_id": 59348, "attachment_id": null, "id": 193386, "time": "2016-08-29T08:01:25Z", "creator": "stefan@eissing.org", "creation_time": "2016-08-29T08:01:25Z", "is_private": false, "text": "Graceful restart of a server had a bug in 2.4.23 mod_http2 that closed connection right away instead of serving ongoing requests until the end.\n\nThis has been fixed in trunk and 2.4.x and will be part of the next release."}, {"text": "Unfortunately, it still doesn't work.\nTested on Apache 2.4.25, as well as the recent svn (2.4.26 as of 26.Jan.2017)\nEven tried with recent mod_http2 1.8.10, and recent nghttp2 1.19.0\nTried with MPM prefork, worker, and event.\n\nThis bug is 100% reproducible.\nWhen downloading a large file on HTTPS and h/2, and graceful restart is issued, download is immediately terminated.\nHowever, everything works fine on http/1.1, both with or without HTTPS.\n\nDownload tested with Chrome browser.\nWhen downloading via curl --http2 -O <url> and graceful restart is issued during the transfer, it download the entire file, but when finished, displays \"curl: (16) Error in the HTTP2 framing layer\" error message.", "tags": [], "bug_id": 59348, "attachment_id": null, "count": 21, "id": 196456, "time": "2017-01-26T15:12:36Z", "creator": "slavko@gmail.com", "creation_time": "2017-01-26T15:12:36Z", "is_private": false}, {"count": 22, "tags": [], "creator": "stefan@eissing.org", "is_private": false, "text": "Slavko, have to look into this. From your description, I can see that clients behave differently. I assume that not all implementations agree how to follow the specifications. No surprise for a new protocol.\n\nI will check first with curl, since that also uses nghttp2. It at least waits until the end. Maybe the server sends something incorrect on closing the connection that curl does not like. We'll see.\n\nWhen that is working, I need to test Chrome. Have you already data on Firefox and Edge?\n\nThanks.", "id": 196458, "time": "2017-01-26T15:29:52Z", "bug_id": 59348, "creation_time": "2017-01-26T15:29:52Z", "attachment_id": null}, {"text": "Here are some of my new observations about how different clients behave, looks like it's different under various operating systems:\n\nChrome on Windows 7: Failed\nChrome on MacOS: OK\n\nFirefox on Windows 7: Failed\nFirefox on MacOS: OK\nFirefox on Win 10: OK\n\nEdge on Win10: OK\n\nSafari on MacOS: Failed", "tags": [], "bug_id": 59348, "attachment_id": null, "count": 23, "id": 196487, "time": "2017-01-27T11:05:42Z", "creator": "slavko@gmail.com", "creation_time": "2017-01-27T11:05:42Z", "is_private": false}, {"count": 24, "tags": [], "bug_id": 59348, "text": "Fixed again with r1780576 on trunk. Added test case.\nWill backport to 2.4.x and release separately on github.", "id": 196498, "time": "2017-01-27T17:14:21Z", "creator": "stefan@eissing.org", "creation_time": "2017-01-27T17:14:21Z", "is_private": false, "attachment_id": null}]