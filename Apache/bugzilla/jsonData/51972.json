[{"count": 0, "tags": [], "bug_id": 51972, "attachment_id": null, "id": 150224, "time": "2011-10-05T21:31:50Z", "creator": "heikki.vesalainen@ixonos.com", "creation_time": "2011-10-05T21:31:50Z", "is_private": false, "text": "The following URL is a protocol relative URL: \"//server.com:8080/foo/bar/kala.html\"\nwhere as this is server relative: \"/foo/bar/kala.html\"\n\norg/apache/catalina/connector/Response.java breaks on protocol relative URLs in that toAbsolute(String) expects everything that begins with a '/' to be server relative. toAbsolute adds the protocol, server and port to the URL, resulting in URLs like http://foo.com:80//server.com:8080/foo/bar/kala.html (instead of the correct http://server.com:8080/foo/bar/kala.html)"}, {"count": 1, "tags": [], "bug_id": 51972, "attachment_id": null, "text": "The JavaDoc for sendRedirect requires that anything that starts with '/' is treated as server relative. I'm not sure if that is what was intended but it is certainly what the spec currently requires. I don't see any reason not to allow protocol relative URLs. I'll see if I can get some clarification from the Servlet EG.", "id": 150233, "time": "2011-10-05T22:12:49Z", "creator": "markt@apache.org", "creation_time": "2011-10-05T22:12:49Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 51972, "text": "Discussion on this topic within the Servlet EG can be followed here:\nhttp://java.net/jira/browse/SERVLET_SPEC-27\n\nGiven that I am in favour of supporting protocol relative URLs, I will look at adding this support to Tomcat 7 ready for the next release.", "id": 150335, "attachment_id": null, "creator": "markt@apache.org", "creation_time": "2011-10-07T22:31:07Z", "time": "2011-10-07T22:31:07Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 51972, "attachment_id": null, "text": "I would also suggest using the java.net.URI to resolve things in place of any home-brewn code.\n\nprivate String toAbsolute(String href) {\n  URI base = URI.create(requestURI); // original request URI, including protocol\n  return base.resolve(URI.create(href)).toASCIIString();\n}\n\nAnd not just in this case, but all over tomcat where URIs are handled.", "id": 150350, "time": "2011-10-08T08:57:00Z", "creator": "heikki.vesalainen@ixonos.com", "creation_time": "2011-10-08T08:57:00Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 51972, "attachment_id": null, "text": "The home-brew code is used for a good reason - performance. It is currently ~2x faster than the alternative proposed.", "id": 150407, "time": "2011-10-10T11:56:08Z", "creator": "markt@apache.org", "creation_time": "2011-10-10T11:56:08Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 51972, "text": "100% difference sounds dramatic, but how many percent of the total response time is spent in this code? How bad would it make things if the slower (but more reliable) version was used? Is it like the home-brewn code is 0,1% of total time and the URI takes 0,2% of total time? That would sound trivial and not worth the optimization.", "id": 150408, "time": "2011-10-10T12:13:11Z", "creator": "heikki.vesalainen@ixonos.com", "creation_time": "2011-10-10T12:13:11Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 51972, "attachment_id": null, "id": 150409, "time": "2011-10-10T12:22:04Z", "creator": "markt@apache.org", "creation_time": "2011-10-10T12:22:04Z", "is_private": false, "text": "The amount of time spend in the sendRedirect code is likely to be only a small proportion of the overall request time but there are lots of places where URIs are manipulated in the Tomcat codebase. Switching all of them to URI is very likely to impact performance.\n\nIf you want to argue for this change then you'll need to present some hard numbers to the dev list (that cover both request processing time and GC) that show that there is no noticeable impact in making this change."}, {"count": 7, "tags": [], "bug_id": 51972, "attachment_id": null, "text": "This has been fixed in trunk and 7.0.x and will be included in 7.0.23 onwards.", "id": 150410, "time": "2011-10-10T12:22:43Z", "creator": "markt@apache.org", "creation_time": "2011-10-10T12:22:43Z", "is_private": false}]