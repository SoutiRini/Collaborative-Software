[{"count": 0, "tags": [], "text": "[NOTE: this is tomcat 7.0.11, not 7.0.10, but the version is not given as a choice, I therefore file it as 7.0.10, which I suspect has the same bug]\n\nScenario:\n\n* tomcat starts, as user u1, with only the manager application in place;\n* it is configured as to not deploy automatically;\n* user u1 copies a webapp tree into $CATALINA_HOME/webapps, which it\ncan since it has write/execute access to this directory;\n* the manager webapp is called to deploy that new web application;\n* [in between, credentials on the deployed webapp directory are\nchanged so that user u1 cannot remove the webapp at all]\n* the manager webapp is called to undeploy that application, BUG: it\nanswers OK, but it is not.\n\nThe manager webapp documentation explicitly states that undeploying an\napplication means that the webapp tree is removed - but of course, in\nthis case it isn't. Use case below, where $CATALINA_HOME/webapps is a symlink to /var/lib/o3/tomcat/installs:\n\n----\n# Only manager webapp running initially\n[o3@tomcat-r8 cockpit]$ wget -O - -q --http-user=tomcat\n--http-password=tomcat  http://localhost:8080/manager/text/list|sed 1d\n/manager:running:6:/usr/share/tomcat7/webapps/manager\n# webapp tree is created by other means. Now deploying the application:\n[o3@tomcat-r8 cockpit]$ wget -O - -q --http-user=tomcat --http-password=tomcat http://localhost:8080/manager/text/deploy'?path=/cockpit&war=file:/var/lib/o3/tomcat/installs/cockpit'\nOK - Deployed application at context path /cockpit\n[...]\n# In another terminal:\n[root@tomcat-r8 installs]# pwd\n/var/lib/o3/tomcat/installs\n# All files are created with umask 022. Just change the owner:\n[root@tomcat-r8 installs]# chown -R root.root cockpit/\n[...]\n# Back to the first terminal:\n[o3@tomcat-r8 cockpit]$ wget -O - -q --http-user=tomcat --http-password=tomcat\nhttp://localhost:8080/manager/text/undeploy?path=/cockpit\nOK - Undeployed application at context path /cockpit\n# Here is the bug: even though the command returns OK, the tree still exists.\n# The webapp is stopped, but it is not undeployed.\n[o3@tomcat-r8 cockpit]$ wget -O - -q --http-user=tomcat\n--http-password=tomcat  http://localhost:8080/manager/text/list|sed 1d\n/manager:running:9:/usr/share/tomcat7/webapps/manager  \n/cockpit:stopped:0:cockpit\n# Listing the contents of $CATALINA_HOME/webapps, we see that the tree is still \n# there:\n[o3@tomcat-r8 cockpit]$ ls /var/lib/o3/tomcat/installs\ncockpit\n----\n\nThe documentation states:\n\n----\nWARNING - This command will delete any web application artifacts that exist within appBase directory (typically \"webapps\") for this virtual host. This will\ndelete the the application .WAR, if present, the application directory resulting either from a deploy in unpacked form or from .WAR expansion as well as the XML Context definition from $CATALINA_BASE/conf/[enginename]/[hostname]/ directory.\n----\n\nThis turns out to be false in this case. While the application is stopped, the web application artifacts are NOT removed. The\nundeploy command should have failed with, say \"FAIL - context was stopped but some articats remain, check access rights\". What's more, the logs\ndon't mention that the webapp tree has failed to be removed at all.\n\nIf I chown back the webapp tree to its rightful owner, then the webapp\nis indeed undeployed as intended: all artifacts are destroyed.\n\nThe culprit code seems to be at org/apache/catalina/manager/ManagerServlet.java, methods undeploy() and undeployDir(). Both use the .delete() method of File objects, but fail to check their return code.", "is_private": false, "id": 145335, "creation_time": "2011-03-28T03:42:36Z", "time": "2011-03-28T03:42:36Z", "creator": "fgaliegue@gmail.com", "bug_id": 50984, "attachment_id": null}, {"count": 1, "attachment_id": null, "creator": "markt@apache.org", "is_private": false, "id": 145338, "time": "2011-03-28T04:16:20Z", "bug_id": 50984, "creation_time": "2011-03-28T04:16:20Z", "tags": [], "text": "Version added to database and issue updated."}, {"count": 2, "tags": [], "bug_id": 50984, "text": "Fixed in 7.0.x and will be included in 7.0.12 onwards.", "id": 145413, "time": "2011-03-30T13:40:09Z", "creator": "markt@apache.org", "creation_time": "2011-03-30T13:40:09Z", "is_private": false, "attachment_id": null}]