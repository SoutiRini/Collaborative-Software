[{"count": 0, "tags": [], "text": "example:\n\nwebapps\\examples\\WEB-INF\\classes\\async\\Async0.java\n\n\nlog file: logs\\localhost.2011-08-07.log\n=============================================\njava.lang.IllegalStateException: Calling [asyncComplete()] is not valid for a request with Async state [DISPATCHED]\n\tat org.apache.coyote.AsyncStateMachine.asyncComplete(AsyncStateMachine.java:221)\n\tat org.apache.coyote.http11.Http11Processor.actionInternal(Http11Processor.java:525)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.action(AbstractHttp11Processor.java:773)\n\tat org.apache.coyote.Request.action(Request.java:344)\n\tat org.apache.catalina.core.AsyncContextImpl.complete(AsyncContextImpl.java:89)\n\tat async.Async0.service(Async0.java:42)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:722)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:304)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)\n\tat org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:684)\n\tat org.apache.catalina.core.ApplicationDispatcher.doInclude(ApplicationDispatcher.java:593)\n\tat org.apache.catalina.core.ApplicationDispatcher.include(ApplicationDispatcher.java:530)\n\tat org.apache.catalina.core.AsyncContextImpl$1.run(AsyncContextImpl.java:173)\n\tat org.apache.catalina.core.AsyncContextImpl.doInternalDispatch(AsyncContextImpl.java:314)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:219)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:175)\n\tat org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:462)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:164)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:100)\n\tat org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:851)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)\n\tat org.apache.catalina.connector.CoyoteAdapter.asyncDispatch(CoyoteAdapter.java:296)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.asyncDispatch(AbstractHttp11Processor.java:1220)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:511)\n\tat org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:302)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\tat java.lang.Thread.run(Thread.java:619)", "is_private": false, "id": 148456, "creator": "zhh200910@gmail.com", "time": "2011-08-07T02:34:08Z", "bug_id": 51630, "creation_time": "2011-08-07T02:34:08Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 51630, "text": "I see no such exception running the latest 7.0.x code.", "id": 148457, "time": "2011-08-07T10:32:55Z", "creator": "markt@apache.org", "creation_time": "2011-08-07T10:32:55Z", "is_private": false, "attachment_id": null}, {"count": 2, "attachment_id": null, "creator": "zhh200910@gmail.com", "is_private": false, "id": 148468, "time": "2011-08-08T00:33:49Z", "bug_id": 51630, "creation_time": "2011-08-08T00:33:49Z", "tags": [], "text": "(In reply to comment #1)\n> I see no such exception running the latest 7.0.x code.\n\nI using the 7.0.19 code.\n\nThe IllegalStateException not showed in the browser, \nbut in the Tomcat/logs/localhost.2011-08-07.log"}, {"count": 3, "tags": [], "bug_id": 51630, "text": "Observing this as well with current trunk@r1178371 (7.0.22) using Nio connector.\nWinXP 32-bit, JDK 6u26.\n\nSteps to reproduce:\n1. Configure Tomcat with org.apache.coyote.http11.Http11NioProtocol\nI also have logging configured with OneLineFormatter, but that should not matter.\n\n2. Start it and open in web browser the following page:\nhttp://localhost:8080/examples/async/async0\n\n3. The following exception is in localhost.<date>.log: (not in catalina*.log !)\n\n03-\u043e\u043a\u0442-2011 14:35:15.218 SEVERE [http-nio-8080-exec-2] org.apache.catalina.core.StandardWrapperValve.invoke Servlet.service() for servlet [async0] in context with path [/examples] threw exception [java.lang.RuntimeException: java.lang.IllegalStateException: Calling [asyncComplete()] is not valid for a request with Async state [DISPATCHED]] with root cause\n java.lang.IllegalStateException: Calling [asyncComplete()] is not valid for a request with Async state [DISPATCHED]\n\tat org.apache.coyote.AsyncStateMachine.asyncComplete(AsyncStateMachine.java:221)\n\tat org.apache.coyote.http11.Http11NioProcessor.actionInternal(Http11NioProcessor.java:476)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.action(AbstractHttp11Processor.java:807)\n\tat org.apache.coyote.Request.action(Request.java:344)\n\tat org.apache.catalina.core.AsyncContextImpl.complete(AsyncContextImpl.java:89)\n\tat async.Async0.service(Async0.java:42)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:722)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:304)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)\n\tat org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:684)\n\tat org.apache.catalina.core.ApplicationDispatcher.doInclude(ApplicationDispatcher.java:593)\n\tat org.apache.catalina.core.ApplicationDispatcher.include(ApplicationDispatcher.java:530)\n\tat org.apache.catalina.core.AsyncContextImpl$1.run(AsyncContextImpl.java:173)\n\tat org.apache.catalina.core.AsyncContextImpl.doInternalDispatch(AsyncContextImpl.java:314)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:219)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:169)\n\tat org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:472)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:168)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:100)\n\tat org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:929)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)\n\tat org.apache.catalina.connector.CoyoteAdapter.asyncDispatch(CoyoteAdapter.java:296)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.asyncDispatch(AbstractHttp11Processor.java:1486)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:511)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1554)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\tat java.lang.Thread.run(Thread.java:662)\n\nIn catalina.<date>.log one can see debug messages from Async0 servlet:\n03-\u043e\u043a\u0442-2011 14:35:15.218 INFO [http-nio-8080-exec-2] async.Async0.service Received dispatch, completing on the worker thread.\n03-\u043e\u043a\u0442-2011 14:35:15.218 INFO [http-nio-8080-exec-2] async.Async0.service After complete called started:false\n\nWhat bothers me is that Async0 servlet is not annotated with @WebServlet(asyncSupported=true) as required by ch.2.3.3.3 of servlet-3_0-final-spec.pdf.  Page #12 (34/230) there: \"It is illegal to call startAsync if the request is within the scope of a servlet or filter that does not support asynchronous operations\"\n\nThe same chapter describes \"isAsyncStarted()\" saying that it should return false after a dispatch call. That is what we are observing here.\n\nFrom description of \"complete()\" in the same chapter, it is container's responsibility to call complete() after service() method exits: \"The complete method can be invoked by the container if\nthe request is dispatched to a servlet that does not support async processing, or\nthe target servlet called by AsyncContext.dispatch does not do a\nsubsequent call to startAsync. In this case, it is the container's responsibility\nto call complete() as soon as that servlet's service method is exited.\"\n\n\nSo I think the IllegalStateException is valid here, but the Async0 example should be fixed by removing the complete() call and annotating the servlet with @WebServlet(asyncSupported=true).", "id": 150073, "time": "2011-10-03T11:10:10Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2011-10-03T11:10:10Z", "is_private": false, "attachment_id": null}, {"count": 4, "attachment_id": null, "creator": "markt@apache.org", "text": "(In reply to comment #3)\n> What bothers me is that Async0 servlet is not annotated with\n> @WebServlet(asyncSupported=true) as required by ch.2.3.3.3 of\n> servlet-3_0-final-spec.pdf.  Page #12 (34/230) there: \"It is illegal to call\n> startAsync if the request is within the scope of a servlet or filter that does\n> not support asynchronous operations\"\n\nYou can also set async support in web.xml and this is what is done for the examples.", "id": 150085, "time": "2011-10-03T17:14:21Z", "bug_id": 51630, "creation_time": "2011-10-03T17:14:21Z", "tags": [], "is_private": false}, {"count": 5, "tags": [], "bug_id": 51630, "text": "Fixed in trunk and 7.0.x and will be included in 7.0.23 onwards.", "id": 150098, "time": "2011-10-03T19:55:14Z", "creator": "markt@apache.org", "creation_time": "2011-10-03T19:55:14Z", "is_private": false, "attachment_id": null}]