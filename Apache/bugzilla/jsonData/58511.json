[{"count": 0, "tags": [], "creator": "nihil.somani@gmail.com", "text": "We are on production with Apache/2.2.27 and Tomcat Version 7.0.55 on linux(2.6.32-431.37.1.el6.x86_64) with 6 core. what we're seeing is below error on webserver which has no pattern as to when it occurs.\n\n(104)Connection reset by peer: ajp_ilink_receive() can't receive header\najp_read_header: ajp_ilink_receive failed\n(120006)APR does not understand this error code: proxy: read response failed from <server ip>:<port> (<server ip>)\nit happens quite frequently when we do load test and on normal traffic it happens but rarely. As load ramps up we see cpu utilization going up(not hinting that this is reason) but we start seeing this error usually happens once we cross about 300 user load.\n\nwe also have firewall in play between webserver and appserver.\n\nAfter we see above error webserver jumps from one app server to another app server. probably thinks original server is marked down. This has become very comman with load going up hence I took thread dump to see what's happening and I did not find any blocked threads. I can post whole thread dump if required here is unique thread stack trace where most of threads are under load.\n\n1) \"ajp-bio-8009-exec-3396\" daemon prio=10 tid=0x00007fa165b99800 nid=0x538b runnable [0x00007fa069ad9000] \n   java.lang.Thread.State: RUNNABLE\n    at java.net.SocketInputStream.socketRead0(Native Method)\n    at java.net.SocketInputStream.read(SocketInputStream.java:152)\n    at java.net.SocketInputStream.read(SocketInputStream.java:122)\n    at org.apache.coyote.ajp.AjpProcessor.read(AjpProcessor.java:312)\n    at org.apache.coyote.ajp.AjpProcessor.readMessage(AjpProcessor.java:367)\n    at org.apache.coyote.ajp.AjpProcessor.process(AjpProcessor.java:118)\n    at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:611)\n    at org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:314)\n    - locked <0x00000007d2998118> (a org.apache.tomcat.util.net.SocketWrapper)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n\n\n2) \"pool-8-thread-1281\" prio=10 tid=0x00007fa0de140800 nid=0x5368 waiting on condition [0x00007fa0721d9000]\n   java.lang.Thread.State: TIMED_WAITING (parking)\n    at sun.misc.Unsafe.park(Native Method)\n    - parking to wait for  <0x000000050e5f11f8> (a java.util.concurrent.SynchronousQueue$TransferStack)\n    at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:226)\n    at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:460)\n    at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:359)\n    at java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:942)\n    at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:745)\n\n3) \"PooledThread[50]\" prio=10 tid=0x00007fa0c4125000 nid=0x734 in Object.wait() [0x00007fa0f064e000]\n   java.lang.Thread.State: WAITING (on object monitor)\n    at java.lang.Object.wait(Native Method)\n    - waiting on <0x00000006915ccf60> (a de.hybris.platform.util.threadpool.PoolableThread)\n    at java.lang.Object.wait(Object.java:503)\n    at de.hybris.platform.util.threadpool.PoolableThread.resetAndReturnToPool(PoolableThread.java:246)\n    - locked <0x00000006915ccf60> (a de.hybris.platform.util.threadpool.PoolableThread)\n    at de.hybris.platform.util.threadpool.PoolableThread.run(PoolableThread.java:219)\n\n4) \"PooledThread[49]\" prio=10 tid=0x00007fa0b801f800 nid=0x733 in Object.wait() [0x00007fa066cab000]\n   java.lang.Thread.State: WAITING (on object monitor)\n    at java.lang.Object.wait(Native Method)\n    - waiting on <0x0000000653594388> (a de.hybris.platform.util.threadpool.PoolableThread)\n    at java.lang.Object.wait(Object.java:503)\n    at de.hybris.platform.util.threadpool.PoolableThread.resetAndReturnToPool(PoolableThread.java:246)\n    - locked <0x0000000653594388> (a de.hybris.platform.util.threadpool.PoolableThread)\n    at de.hybris.platform.util.threadpool.PoolableThread.run(PoolableThread.java:219)\n\n 5) \"FD_SOCK client connection handler,hybris-broadcast,hybrisnode-2\" daemon prio=10 tid=0x00007fa0bc09d800 nid=0x67b7 runnable [0x00007fa06b9f8000]\n    java.lang.Thread.State: RUNNABLE\n    at java.net.SocketInputStream.socketRead0(Native Method)\n    at java.net.SocketInputStream.read(SocketInputStream.java:152)\n    at java.net.SocketInputStream.read(SocketInputStream.java:122)\n    at java.net.SocketInputStream.read(SocketInputStream.java:210)\n    at org.jgroups.protocols.FD_SOCK$ClientConnectionHandler.run(FD_SOCK.java:1120)\n    at java.lang.Thread.run(Thread.java:745)\nHere's our AJP connector config on tomcat\n\n<Connector  protocol=\"AJP/1.3\" \n  port=\"8009\" \n  redirectPort=\"443\" \n  useIPVHosts=\"true\" \n  URIEncoding=\"UTF-8\" \n  maxThreads=\"850\" \n  minSpareThreads=\"100\" \n  connectionTimeout=\"30000\" \n  backlog=\"1000\" \n  keepAliveTimeout=\"60000\" \n  maxConnections=\"700\" \n  acceptorThreadCount=\"4\"/>\nAnd below is apache conf\n\nprefork.c\nStartServers 20\nMaxSpareServers 40\nMinSpareServers 40\nServerLimit 700\nMaxClients 700\nIfModule\nand lb.conf\n\nBalancerMember ajp://<host_ip>:8009 route=app5 retry=60\nProxySet stickysession=JSESSIONID\nProxySet lbmethod=byrequests failonstatus=503,504", "id": 185818, "time": "2015-10-21T08:34:53Z", "bug_id": 58511, "creation_time": "2015-10-21T08:34:53Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 58511, "is_private": false, "text": "anyone has idea as to what's wrong here?", "id": 185827, "time": "2015-10-21T15:55:36Z", "creator": "nihil.somani@gmail.com", "creation_time": "2015-10-21T15:55:36Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "ylavic.dev@gmail.com", "attachment_id": null, "text": "This bugzilla is for reporting bugs in the Apache HTTP Server, not for support.\nThere is no evidence of any particular bug in httpd in your report, please ask for support on the users mailing-list (users@httpd.apache.org) or/and the Tomcat one (users@tomcat.apache.org).\nIf it proves to be a bug in httpd or tomcat, please reopen with the appropriate Product selected above.", "id": 185829, "time": "2015-10-21T16:54:06Z", "bug_id": 58511, "creation_time": "2015-10-21T16:54:06Z", "is_private": false}]