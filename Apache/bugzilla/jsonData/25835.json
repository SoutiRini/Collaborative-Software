[{"count": 0, "tags": [], "creator": "slavik.markovich@orange.co.il", "attachment_id": null, "is_private": false, "id": 49901, "time": "2003-12-31T14:24:13Z", "bug_id": 25835, "creation_time": "2003-12-31T14:24:13Z", "text": "Copied from the mailing list:\nI'm having some problems with using RemoteAddrValve to allow only certain\naddresses to access an Engine.\n\nI'm using tomcat 4.1.27 with jdk1.3.1 on Solaris.\n\nI've configured the following:\n<Valve className=\"org.apache.catalina.valves.RemoteAddrValve\" allow=\"a.b.c.d\"/>\nunder the engine. I know I should have escaped the '.' (regexp) but it should\nwork as is.\n\nI'm receiving once in every few thousands of requests the following error:\n2003-12-26 11:26:51 CoyoteAdapter An exception or error occurred in the\ncontainer during the request processing\njava.lang.StringIndexOutOfBoundsException: String index out of range: 11\n        at java.lang.String.charAt(String.java:511)\n        at\norg.apache.regexp.StringCharacterIterator.charAt(StringCharacterIterator.java:90)\n        at org.apache.regexp.RE.matchNodes(RE.java:1161)\n        at org.apache.regexp.RE.matchAt(RE.java:1448)\n        at org.apache.regexp.RE.match(RE.java:1540)\n        at org.apache.regexp.RE.match(RE.java:1468)\n        at org.apache.regexp.RE.match(RE.java:1561)\n        at\norg.apache.catalina.valves.RequestFilterValve.process(RequestFilterValve.java:335)\n        at\norg.apache.catalina.valves.RemoteAddrValve.invoke(RemoteAddrValve.java:131)\n        at\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:641)\n        at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:577)\n        at\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:641)\n        at\norg.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\n        at org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\n        at org.apache.coyote.tomcat4.CoyoteAdapter.service(CoyoteAdapter.java:223)\n        at\norg.apache.coyote.http11.Http11Processor.process(Http11Processor.java:601)\n        at\norg.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.processConnection(Http11Protocol.java:392)\n        at\norg.apache.tomcat.util.net.TcpWorkerThread.runIt(PoolTcpEndpoint.java:565)\n        at\norg.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:619)\n        at java.lang.Thread.run(Thread.java:479)\n\nAlso, once in every few thousands of requests I'm receiving a 403 access denied\nerror on a valid address (I can see that in the access log).\n\nAfter checking the RequestFilterValve class, I can see it saves the compiled\nregular expressions (RE) and reuses them to check every request. Looking at\nregexp documentations, it is explicitly stated that RE is not thread-safe. Am I\nmissing something? It looks like under load, this valve fails.\n\nAlso, I can see that the RequestFilterValve class didn't change in the 5.0.16\nversion either.\n\nPossible solution:\nSynchronizing the process method would be a bad idea (bottleneck for all\nrequests) so it looks like there won't be any choice but to recreate the RE as\nlocal variables.\nThere is also a possibility (ugly one) of serializing the array of RE to a byte\narray and de-serializing it in the process method."}, {"count": 1, "tags": [], "text": "This has been fixed in CVS for 4.1.x and will be included in 4.1.32+\n\nFor the record, this was fixed in 5.5.x as part of the migration to\njava.util.regexp.*", "attachment_id": null, "bug_id": 25835, "id": 76981, "time": "2005-07-04T22:42:30Z", "creator": "markt@apache.org", "creation_time": "2005-07-04T22:42:30Z", "is_private": false}]