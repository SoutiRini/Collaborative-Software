[{"count": 0, "tags": [], "bug_id": 37747, "text": "I am pretty shocked to have found this as we have been using 1.2.8 since it was\nreleased, but one of our testers can recreate this problem at will!! Here's the\nthread dump showing the deadlock:\n\njvm 1    | Found one Java-level deadlock:\njvm 1    | =============================\njvm 1    | \"Thread-189\":\njvm 1    |   waiting to lock monitor 0x286fa7b4 (object 0x06c2b8d8, a\norg.apache.log4j.net.SMTPAppender),\njvm 1    |   which is held by \"Thread-98\"\njvm 1    | \"Thread-98\":\njvm 1    |   waiting to lock monitor 0x00b3ebf4 (object 0x06c57bc0, a\norg.apache.log4j.spi.RootLogger),\njvm 1    |   which is held by \"Thread-189\"\njvm 1    | \njvm 1    | Java stack information for the threads listed above:\njvm 1    | ===================================================\njvm 1    | \"Thread-189\":\njvm 1    | \tat org.apache.log4j.AppenderSkeleton.doAppend(AppenderSkeleton.java:210)\njvm 1    | \t- waiting to lock <0x06c2b8d8> (a org.apache.log4j.net.SMTPAppender)\njvm 1    | \tat\norg.apache.log4j.helpers.AppenderAttachableImpl.appendLoopOnAppenders(AppenderAttachableImpl.java:65)\njvm 1    | \tat org.apache.log4j.Category.callAppenders(Category.java:203)\njvm 1    | \t- locked <0x06c57bc0> (a org.apache.log4j.spi.RootLogger)\njvm 1    | \tat org.apache.log4j.Category.forcedLog(Category.java:388)\njvm 1    | \tat org.apache.log4j.Category.info(Category.java:663)\njvm 1    | \tat\nuk.co.webessence.kernel.ApplicationLockManager.addLock(ApplicationLockManager.java:81)\njvm 1    | \tat\nuk.co.webessence.kernel.database.LockHolder.getLocks(LockHolder.java:152)\njvm 1    | \t- locked <0x08df4278> (a\nnet.staffplanner.kernel.taexceptions.processing.ProcessRawEvent)\njvm 1    | \tat\nuk.co.webessence.kernel.database.LockHolder._getAllRequiredLocks(LockHolder.java:86)\njvm 1    | \t- locked <0x08df4278> (a\nnet.staffplanner.kernel.taexceptions.processing.ProcessRawEvent)\njvm 1    | \tat\nuk.co.webessence.kernel.database.LockHolder.getAllRequiredLocks(LockHolder.java:75)\njvm 1    | \t- locked <0x08df4278> (a\nnet.staffplanner.kernel.taexceptions.processing.ProcessRawEvent)\njvm 1    | \tat\nuk.co.webessence.kernel.BackgroundProcess.getAllRequiredLocks(BackgroundProcess.java:173)\njvm 1    | \t- locked <0x08df4278> (a\nnet.staffplanner.kernel.taexceptions.processing.ProcessRawEvent)\njvm 1    | \tat\nuk.co.webessence.kernel.BackgroundProcess.tryGetAllRequiredLocks(BackgroundProcess.java:234)\njvm 1    | \tat\nuk.co.webessence.kernel.BackgroundProcess.waitForAllRequiredLocks(BackgroundProcess.java:212)\njvm 1    | \tat\nnet.staffplanner.kernel.taexceptions.processing.ProcessRawEvent.processSwipe(ProcessRawEvent.java:156)\njvm 1    | \tat\nnet.staffplanner.kernel.taexceptions.processing.ProcessRawEvent.doRun(ProcessRawEvent.java:74)\njvm 1    | \tat\nuk.co.webessence.kernel.BackgroundProcess.run(BackgroundProcess.java:96)\njvm 1    | \tat java.lang.Thread.run(Thread.java:595)\njvm 1    | \"Thread-98\":\njvm 1    | \tat org.apache.log4j.Category.callAppenders(Category.java:201)\njvm 1    | \t- waiting to lock <0x06c57bc0> (a org.apache.log4j.spi.RootLogger)\njvm 1    | \tat org.apache.log4j.Category.forcedLog(Category.java:388)\njvm 1    | \tat org.apache.log4j.Category.fatal(Category.java:362)\njvm 1    | \tat\nuk.co.webessence.utils.CriticalException.<init>(CriticalException.java:102)\njvm 1    | \t- locked <0x06c2b8d8> (a org.apache.log4j.net.SMTPAppender)\njvm 1    | \tat\nuk.co.webessence.utils.DatabaseException.<init>(DatabaseException.java:49)\njvm 1    | \tat\nuk.co.webessence.kernel.persistence.PersistenceHandler.handleSQLException(PersistenceHandler.java:696)\njvm 1    | \tat\nuk.co.webessence.kernel.persistence.PersistenceHandler.insert(PersistenceHandler.java:298)\njvm 1    | \tat\nuk.co.webessence.kernel.RecordServer.handlePersistentAdd(RecordServer.java:2012)\njvm 1    | \tat\nnet.staffplanner.kernel.taexceptions.TelfRecordServer.handlePersistentAdd(TelfRecordServer.java:86)\njvm 1    | \tat\nnet.staffplanner.kernel.taexceptions.TaExceptionLogServer.handlePersistentAdd(TaExceptionLogServer.java:82)\njvm 1    | \tat uk.co.webessence.kernel.RecordObject.flush(RecordObject.java:2393)\njvm 1    | \tat\nuk.co.webessence.kernel.database.UserTransactionCache.commit(UserTransactionCache.java:247)\njvm 1    | \tat\nuk.co.webessence.kernel.database.DatabaseTransaction.commit(DatabaseTransaction.java:137)\njvm 1    | \tat\nnet.staffplanner.kernel.taexceptions.processing.processSwipedEvent.matchRoundRecreateExceptionLogs(processSwipedEvent.java:203)\njvm 1    | \tat\nnet.staffplanner.kernel.taexceptions.processing.processSwipedEvent.doRun(processSwipedEvent.java:76)\njvm 1    | \tat\nuk.co.webessence.kernel.BackgroundProcess.start(BackgroundProcess.java:80)\njvm 1    | \tat\nuk.co.webessence.kernel.BackgroundProcess.start(BackgroundProcess.java:72)\njvm 1    | \tat\nnet.staffplanner.kernel.taexceptions.processing.ProcessRawEvent.doRun(ProcessRawEvent.java:76)\njvm 1    | \tat\nuk.co.webessence.kernel.BackgroundProcess.run(BackgroundProcess.java:96)\njvm 1    | \tat java.lang.Thread.run(Thread.java:595)\njvm 1    | \njvm 1    | Found 1 deadlock.\njvm 1    |", "id": 83106, "time": "2005-12-01T23:51:22Z", "creator": "dave@daveoxley.co.uk", "creation_time": "2005-12-01T23:51:22Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 37747, "text": "Oops, sorry. Found the bug in our code. We were synchronizing the SMTPAppender\nin order to update the email subject.", "id": 83125, "time": "2005-12-02T05:18:51Z", "creator": "dave@daveoxley.co.uk", "creation_time": "2005-12-02T05:18:51Z", "is_private": false, "attachment_id": null}]