[{"count": 0, "tags": [], "creator": "ddesborough@gmail.com", "is_private": false, "text": "When using the copy task to copy files from a CFIS mount, we are seeing the following behavior (directory contains a bunch of files with numbers as names:\n\nfileset: Setup scanner in dir /opt/storage with patternSet{ includes: [**] excludes: [] }\n     [copy] 100 added as 100 doesn't exist.\n     [copy] 16 added as 16 doesn't exist.\n     [copy] 18 added as 18 doesn't exist.\n     [copy] 28 added as 28 doesn't exist.\n<snip>\n     [copy] Copying 92 files to /opt/restore2\n     [copy] Copying /opt/storage/100 to /opt/restore2/100\n      [ant] Exiting /opt/backup-restore.xml.\n\nBUILD FAILED\n/opt/backup-restore-wrapper.xml:63: The following error occurred while executing this line:\n/opt/backup-restore.xml:506: Failed to copy /opt/storage/100 to /opt/restore2/100 due to Invalid argument\n        at org.apache.tools.ant.taskdefs.Copy.doFileOperations(Copy.java:914)\n        at org.apache.tools.ant.taskdefs.Copy.execute(Copy.java:567)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:291)\n        at sun.reflect.GeneratedMethodAccessor6.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:37)\n        at java.lang.reflect.Method.invoke(Method.java:611)\n        at org.apache.tools.ant.dispatch.DispatchUtils.execute(DispatchUtils.java:106)\n        at org.apache.tools.ant.Task.perform(Task.java:348)\n        at org.apache.tools.ant.Target.execute(Target.java:392)\n        at org.apache.tools.ant.Target.performTasks(Target.java:413)\n        at org.apache.tools.ant.Project.executeSortedTargets(Project.java:1399)\n        at org.apache.tools.ant.helper.SingleCheckExecutor.executeTargets(SingleCheckExecutor.java:38)\n        at org.apache.tools.ant.Project.executeTargets(Project.java:1251)\n        at org.apache.tools.ant.taskdefs.Ant.execute(Ant.java:442)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:291)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:60)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:37)\n        at java.lang.reflect.Method.invoke(Method.java:611)\n        at org.apache.tools.ant.dispatch.DispatchUtils.execute(DispatchUtils.java:106)\n        at org.apache.tools.ant.Task.perform(Task.java:348)\n        at org.apache.tools.ant.Target.execute(Target.java:392)\n        at org.apache.tools.ant.Target.performTasks(Target.java:413)\n        at org.apache.tools.ant.Project.executeSortedTargets(Project.java:1399)\n        at org.apache.tools.ant.Project.executeTarget(Project.java:1368)\n        at org.apache.tools.ant.helper.DefaultExecutor.executeTargets(DefaultExecutor.java:41)\n        at org.apache.tools.ant.Project.executeTargets(Project.java:1251)\n        at org.apache.tools.ant.Main.runBuild(Main.java:811)\n        at org.apache.tools.ant.Main.startAnt(Main.java:217)\n        at org.apache.tools.ant.launch.Launcher.run(Launcher.java:280)\n        at org.apache.tools.ant.launch.Launcher.main(Launcher.java:109)\nCaused by: java.io.IOException: Invalid argument\n        at sun.nio.ch.FileChannelImpl.map0(Native Method)\n        at sun.nio.ch.FileChannelImpl.map(FileChannelImpl.java:758)\n        at sun.nio.ch.FileChannelImpl.transferFromFileChannel(FileChannelImpl.java:542)\n        at sun.nio.ch.FileChannelImpl.transferFrom(FileChannelImpl.java:605)\n        at org.apache.tools.ant.util.ResourceUtils.copyResource(ResourceUtils.java:532)\n        at org.apache.tools.ant.util.FileUtils.copyFile(FileUtils.java:559)\n        at org.apache.tools.ant.taskdefs.Copy.doFileOperations(Copy.java:899)\n        ... 30 more\n\n\nThe task is simply:\n\n        <copy todir=\"${BACKUP_STORAGE_DIR}\" preservelastmodified=\"yes\">\n            <fileset dir=\"${STORAGE_LOCATION}\"\n               includes=\"**\">\n            </fileset>\n        </copy>\n\nThis works fine when run against local files or NFS mounts. \n\nSystem details:\n\nbash-4.2$ ant -version\nApache Ant(TM) version 1.8.4 compiled on May 22 2012\n\nbash-4.2$ java -version\njava version \"1.6.0\"\nJava(TM) SE Runtime Environment (build pap6460sr12-20121025_01(SR12))\nIBM J9 VM (build 2.4, JRE 1.6.0 IBM J9 2.4 AIX ppc64-64 jvmap6460sr12-20121024_126067 (JIT enabled, AOT enabled)\nJ9VM - 20121024_126067\nJIT  - r9_20120914_26057\nGC   - 20120928_AA)\nJCL  - 20121014_01\n\nbash-4.2$ oslevel -g\n6.1.0.0\n\nbash-4.2$ instfix -i | grep AIX_ML\n    All filesets for 6100-00_AIX_ML were found.\n    All filesets for 6100-01_AIX_ML were found.\n    All filesets for 6100-02_AIX_ML were found.\n    All filesets for 6100-03_AIX_ML were found.\n    All filesets for 6100-04_AIX_ML were found.\n\nmount created with the  mkcifsmnt command\n\nServer providing the share: \n\nWindows Server 2008 R2", "id": 164546, "time": "2013-01-10T03:02:24Z", "bug_id": 54397, "creation_time": "2013-01-10T03:02:24Z", "attachment_id": null}, {"count": 1, "text": "Applied AIX patches and updated to Java7 and I could still reproduce the issue.\n\nbash-4.2$ instfix -i | grep AIX_ML\n    All filesets for 6100-00_AIX_ML were found.\n    All filesets for 6100-01_AIX_ML were found.\n    All filesets for 6100-02_AIX_ML were found.\n    All filesets for 6100-03_AIX_ML were found.\n    All filesets for 6100-04_AIX_ML were found.\n    All filesets for 6100-05_AIX_ML were found.\n    All filesets for 6100-06_AIX_ML were found.\n    All filesets for 6100-07_AIX_ML were found.\n    All filesets for 6.1.0.0_AIX_ML were found.\n\nbash-4.2$ ./java -version\njava version \"1.7.0\"\nJava(TM) SE Runtime Environment (build pap6470sr3-20121025_01(SR3))\nIBM J9 VM (build 2.6, JRE 1.7.0 AIX ppc64-64 20121024_126071 (JIT enabled, AOT enabled)\nJ9VM - R26_Java726_SR3_20121024_1635_B126071\nJIT  - r11.b02_20120924_26343a\nGC   - R26_Java726_SR3_20121024_1635_B126071\nJ9CL - 20121024_126071)\nJCL - 20121019_01 based on Oracle 7u6-b17", "creator": "ddesborough@gmail.com", "is_private": false, "id": 164635, "time": "2013-01-15T15:02:36Z", "bug_id": 54397, "creation_time": "2013-01-15T15:02:36Z", "tags": [], "attachment_id": null}, {"count": 2, "tags": [], "creator": "jonteh1337@gmail.com", "is_private": false, "text": "I am encountering similar issues when using the commons.io.FileUtils to do copy operations via Groovy on an AIX box. plutarch is the name of my class. Perhaps Ant relies on these?\n\njava.io.IOException: A system call received a parameter that is not valid.\n\tat sun.nio.ch.FileChannelImpl.map0(Native Method)\n\tat sun.nio.ch.FileChannelImpl.map(FileChannelImpl.java:768)\n\tat sun.nio.ch.FileChannelImpl.transferFromFileChannel(FileChannelImpl.java:552)\n\tat sun.nio.ch.FileChannelImpl.transferFrom(FileChannelImpl.java:615)\n\tat org.apache.commons.io.FileUtils.doCopyFile(FileUtils.java:1147)\n\tat org.apache.commons.io.FileUtils.doCopyDirectory(FileUtils.java:1428)\n\tat org.apache.commons.io.FileUtils.copyDirectory(FileUtils.java:1389)\n\tat org.apache.commons.io.FileUtils.copyDirectory(FileUtils.java:1261)\n\tat org.apache.commons.io.FileUtils.copyDirectory(FileUtils.java:1230)\n\tat org.apache.commons.io.FileUtils$copyDirectory.call(Unknown Source)\n\tat org.codehaus.groovy.runtime.callsite.CallSiteArray.defaultCall(CallSiteArray.java:45)\n\tat org.codehaus.groovy.runtime.callsite.AbstractCallSite.call(AbstractCallSite.java:108)\n\tat org.codehaus.groovy.runtime.callsite.AbstractCallSite.call(AbstractCallSite.java:120)\n\tat plutarch.archiveOldFilesOnSabrina(plutarch.groovy:111)\n\tat plutarch$archiveOldFilesOnSabrina.callCurrent(Unknown Source)\n\tat org.codehaus.groovy.runtime.callsite.CallSiteArray.defaultCallCurrent(CallSiteArray.java:49)\n\tat org.codehaus.groovy.runtime.callsite.AbstractCallSite.callCurrent(AbstractCallSite.java:133)\n\tat org.codehaus.groovy.runtime.callsite.AbstractCallSite.callCurrent(AbstractCallSite.java:149)\n\tat plutarch.run(plutarch.groovy:47)\n\tat groovy.lang.GroovyShell.runScriptOrMainOrTestOrRunnable(GroovyShell.java:257)\n\tat groovy.lang.GroovyShell.run(GroovyShell.java:220)\n\tat groovy.lang.GroovyShell.run(GroovyShell.java:150)\n\tat groovy.ui.GroovyMain.processOnce(GroovyMain.java:588)\n\tat groovy.ui.GroovyMain.run(GroovyMain.java:375)\n\tat groovy.ui.GroovyMain.process(GroovyMain.java:361)\n\tat groovy.ui.GroovyMain.processArgs(GroovyMain.java:120)\n\tat groovy.ui.GroovyMain.main(GroovyMain.java:100)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:60)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:37)\n\tat java.lang.reflect.Method.invoke(Method.java:611)\n\tat org.codehaus.groovy.tools.GroovyStarter.rootLoader(GroovyStarter.java:106)\n\tat org.codehaus.groovy.tools.GroovyStarter.main(GroovyStarter.java:128)", "id": 165704, "time": "2013-03-06T22:41:31Z", "bug_id": 54397, "creation_time": "2013-03-06T22:41:31Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 54397, "is_private": false, "count": 3, "id": 172008, "time": "2014-01-01T22:23:47Z", "creator": "bodewig@apache.org", "creation_time": "2014-01-01T22:23:47Z", "text": "This is ugly.\n\nAnt uses FileChannel#transferFrom as this is supposed to be more efficient than the traditional shuffling of buffers between streams/channels.  It looks as if the implementation inside the Java classlib doesn't work for certain kinds of files.\n\nUnfortunately I don't see how Ant could detect the situation as we cannot query the FileChannel whether it would support transfers and the exception is an unspecific IOException.\n\nOne option may be to add a flag that disables transferFrom altogether - which will require changes in lots of places - I'm pondering a global system property to avoid adding a new parameter and adding it to lots of tasks.\n\nThere may be a workaround for you as Ant will not use transferFrom if a filterset or a filterchain exists.  You could add a filterChain that didn't modify anything but this would very likely break binary files when copying them (so is only an option if we are talking about text files)."}, {"count": 4, "tags": [], "creator": "bodewig@apache.org", "text": "with svn revision 1557433 Ant will log a warning and fall back to good old Streams in a situation like this.", "id": 172284, "time": "2014-01-11T18:11:19Z", "bug_id": 54397, "creation_time": "2014-01-11T18:11:19Z", "is_private": false, "attachment_id": null}]