[{"count": 0, "tags": [], "bug_id": 57877, "is_private": false, "text": "Created attachment 32705\nPatch to apr_file_open() & apr_os_file_put() to always associate a mutex\n\nThe default case is to open a file unbuffered, and such a file won't get a mutex as it is only required for protecting access to the buffer (aside from the APR_FOPEN_APPEND option). apr_file_buffer_set() can be used to assign a buffer afterwards, but no mutex will be allocated.\n\nMoreover the implementation for Windows in apr-1.5.1/file_io/win32/buffer.c tries to apr_thread_mutex_lock() with a NULL mutex in this case, causing logresolve.exe from httpd-2.4.x to always fail.\n\nThe implementation for UNIX of apr_file_buffer_set() (in apr-1.5.1/file_io/unix/buffer.c) differs by applying the file_lock() & -unlock macros from apr-1.5.1/include/arch/unix/apr_arch_file_io.h which in turn will only call apr_thread_mutex_lock() & -unlock if the mutex exists.\n\nMy first idea was to create the mutex on demand as shown in the following patch:\n============================================================================\n--- apr/file_io/win32/buffer-old.c\t2006-08-03 12:55:31.000000000 +0200\n+++ apr/file_io/win32/buffer.c\t2015-04-28 17:03:02.919790000 +0200\n@@ -23,6 +23,14 @@\n {\n     apr_status_t rv;\n \n+    if (!file->mutex) {\n+        rv = apr_thread_mutex_create(&file->mutex,\n+                                     APR_THREAD_MUTEX_DEFAULT, file->pool);\n+        if (rv) {\n+            return rv;\n+        }\n+    }\n+\n     apr_thread_mutex_lock(file->mutex);\n  \n     if(file->buffered) {\n============================================================================\nbut creating a new mutex for an opened file would have to be protected by a mutex on its own. The only save option is to create the mutex right on every open, even if it won't be used later on (at least #if APR_HAS_THREADS).\n\nAttached is a patch for apr-1.5.1/file_io/win32/open.c with small changes inside apr_file_open() & apr_os_file_put() commenting out the if statements.", "id": 182766, "time": "2015-04-30T14:20:05Z", "creator": "ernstthal@icloud.com", "creation_time": "2015-04-30T14:20:05Z", "attachment_id": 32705}, {"count": 1, "attachment_id": null, "creator": "ernstthal@icloud.com", "text": "Also see https://bz.apache.org/bugzilla/show_bug.cgi?id=57876", "id": 182767, "time": "2015-04-30T14:22:38Z", "bug_id": 57877, "creation_time": "2015-04-30T14:22:38Z", "tags": [], "is_private": false}]