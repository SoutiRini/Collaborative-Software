[{"count": 0, "tags": [], "bug_id": 61498, "text": "I have 2.4.6-45.el7.centos.4 on Centos 7.\nI have hundreds of virtual hosts with ErrorLog for all of them. \n\nWhen I count how many file descriptor my httpd process is using (/proc/xxxx/fd), if it's over 1024, Apache generates a Buffer Overflow :\n\n*** buffer overflow detected ***: /usr/sbin/httpd terminated\n======= Backtrace: =========\n/lib64/libc.so.6(__fortify_fail+0x37)[0x7fb23a6ee077]\n/lib64/libc.so.6(+0x10d230)[0x7fb23a6ec230]\n/lib64/libc.so.6(+0x10efe7)[0x7fb23a6edfe7]\n/usr/lib64/php/modules/memcache.so(mmc_pool_select+0x4b9)[0x7fb2228ab2f9]\n/usr/lib64/php/modules/memcache.so(mmc_pool_run+0x68)[0x7fb2228abb38]\n/usr/lib64/php/modules/memcache.so(zif_memcache_get+0x18f)[0x7fb2228a501f]\n/etc/httpd/modules/libphp5.so(+0x2f06c1)[0x7fb22da966c1]\n/etc/httpd/modules/libphp5.so(execute_ex+0x38)[0x7fb22da2a788]\n/etc/httpd/modules/libphp5.so(zend_execute_scripts+0x18b)[0x7fb22d9ef06b]\n/etc/httpd/modules/libphp5.so(php_execute_script+0x282)[0x7fb22d989d22]\n/etc/httpd/modules/libphp5.so(+0x2f20ad)[0x7fb22da980ad]\n/usr/sbin/httpd(ap_run_handler+0x40)[0x7fb23c123690]\n/usr/sbin/httpd(ap_invoke_handler+0x69)[0x7fb23c123bd9]\n/usr/sbin/httpd(ap_internal_redirect+0x5c)[0x7fb23c137acc]\n/etc/httpd/modules/mod_rewrite.so(+0x4e9c)[0x7fb2348d7e9c]\n/usr/sbin/httpd(ap_run_handler+0x40)[0x7fb23c123690]\n/usr/sbin/httpd(ap_invoke_handler+0x69)[0x7fb23c123bd9]\n/usr/sbin/httpd(ap_process_async_request+0x20a)[0x7fb23c13800a]\n/usr/sbin/httpd(ap_process_request+0x14)[0x7fb23c1382e4]\n/usr/sbin/httpd(+0x52c32)[0x7fb23c134c32]\n/usr/sbin/httpd(ap_run_process_connection+0x40)[0x7fb23c12cc90]\n/etc/httpd/modules/mod_mpm_prefork.so(+0x380f)[0x7fb231d2080f]\n/etc/httpd/modules/mod_mpm_prefork.so(+0x3a55)[0x7fb231d20a55]\n/etc/httpd/modules/mod_mpm_prefork.so(+0x46ee)[0x7fb231d216ee]\n/usr/sbin/httpd(ap_run_mpm+0x4e)[0x7fb23c107f6e]\n/usr/sbin/httpd(main+0xa86)[0x7fb23c100d76]\n/lib64/libc.so.6(__libc_start_main+0xf5)[0x7fb23a600b35]\n/usr/sbin/httpd(+0x1eeaf)[0x7fb23c100eaf]\n\nIf I disable a few virtual hosts to get below that threshold, it's starting up.\n\nI confirmed that my limits are ok :\ncat /proc/xxxxx/limits\nLimit                     Soft Limit           Hard Limit           Units\nMax cpu time              unlimited            unlimited            seconds\nMax file size             unlimited            unlimited            bytes\nMax data size             unlimited            unlimited            bytes\nMax stack size            8388608              unlimited            bytes\nMax core file size        0                    unlimited            bytes\nMax resident set          unlimited            unlimited            bytes\nMax processes             256005               256005               processes\nMax open files            30000                30000                files\nMax locked memory         65536                65536                bytes\nMax address space         unlimited            unlimited            bytes\nMax file locks            unlimited            unlimited            locks\nMax pending signals       256005               256005               signals\nMax msgqueue size         819200               819200               bytes\nMax nice priority         0                    0\nMax realtime priority     0                    0\nMax realtime timeout      unlimited            unlimited            us\n\nI had to add this, otherwise I was having a too many open file :\n/etc/systemd/system/httpd.service.d/limits.conf\n[Service]\nLimitNOFILE=30000", "id": 200710, "time": "2017-09-06T16:01:36Z", "creator": "bastien974@gmail.com", "creation_time": "2017-09-06T16:01:36Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 61498, "text": "This is deep within PHP, this bugzilla is only for httpd.", "id": 200711, "time": "2017-09-06T16:39:29Z", "creator": "covener@gmail.com", "creation_time": "2017-09-06T16:39:29Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "bastien974@gmail.com", "text": "I'm confused, why is it PHP ? I'm running the same version of PHP on other servers, but with httpd 2.2 and I have no issue.\n\nI can also load a simple php file with phpinfo(). But the full site with index.php triggers the overflow.", "id": 200712, "attachment_id": null, "bug_id": 61498, "creation_time": "2017-09-06T17:16:21Z", "time": "2017-09-06T17:16:21Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 61498, "text": "I'm (In reply to bastien974 from comment #2)\n> I'm confused, why is it PHP ? I'm running the same version of PHP on other\n> servers, but with httpd 2.2 and I have no issue.\n> \n> I can also load a simple php file with phpinfo(). But the full site with\n> index.php triggers the overflow.\n\nI'm simply referring to the backtrace.  httpd has passed control to mod_php and it crashed within an extension.  Maybe the extension doesn't run well in\na threaded MPM (you appear to be on event MPM) not for the usual reasons of\nthread safety but because it has some bug in the neighborhood of select() vs FD_SETSIZE when many fds are in use.", "id": 200713, "time": "2017-09-06T17:23:00Z", "creator": "covener@gmail.com", "creation_time": "2017-09-06T17:23:00Z", "is_private": false, "attachment_id": null}]