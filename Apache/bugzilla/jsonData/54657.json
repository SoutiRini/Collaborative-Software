[{"count": 0, "text": "the problem that i am reporting here is that when name resolution of a load balancer member fails, the affected member is not marked as disabled (or in error state), and taken out of the loop of actively load balanced members. the bad member continues to get requests and fail them.\n\ni believe what should occur is that the bad member should be marked as disabled (or in error state), a log entry made to the error log (this already occurs), and the request sent to a good member, if one is available. also, subsequent requests should not be sent to the bad member until/unless it becomes available. if a good member is not available to handle a request, then an error response is appropriate.\n\nthis is a minor issue because the member can be disabled at runtime through the balancer manager, or the name can be mapped to an address (even if it points to an address where nothing is listening on the right port -- because as long as the name resolves and the connection fails, then the member gets marked as being in error state and removed from the load balancing loop), etc...\n\nthis problem was noticed in an environment where the same httpd config is used in multiple testing environments. the testing environments have varying numbers of cluster members actually provisioned and available. the idea was that the loadbalancer would be able to determine when members were not available and skip over them.\n\ngiven this simplified config:\n<Proxy balancer://api-cluster>\n  BalancerMember http://box01:8182/api\n  BalancerMember http://box02:8182/api\n</Proxy>\nProxyPass /api/ balancer://api-cluster/\n\nwhen the box02 name is not resolvable, then every other client request coming into the load balancer generates a response similar to:\n\nHTTP/1.1 502 Proxy Error\nDate: Fri, 08 Mar 2013 15:12:03 GMT\nContent-Length: 400\nContent-Type: text/html; charset=iso-8859-1\n\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>502 Proxy Error</title>\n</head><body>\n<h1>Proxy Error</h1>\n<p>The proxy server received an invalid\nresponse from an upstream server.<br />\nThe proxy server could not handle the request <em><a href=\"/api/whatever\">GET&nbsp;/api/whatever</a></em>.<p>\nReason: <strong>DNS lookup failure for: box02</strong></p></p>\n</body></html>\n\nalso, this goes to the error_log at error level:\n[Fri Mar 08 10:12:03 2013] [error] [client 127.0.0.1] proxy: DNS lookup failure for: box02 returned by /api/whatever", "bug_id": 54657, "attachment_id": null, "id": 165726, "time": "2013-03-09T08:07:04Z", "creator": "domainspam@bellsouth.net", "creation_time": "2013-03-09T08:07:04Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "creator": "domainspam@bellsouth.net", "attachment_id": null, "id": 165897, "time": "2013-03-17T14:00:03Z", "bug_id": 54657, "creation_time": "2013-03-17T14:00:03Z", "is_private": false, "text": "just adding notes on how to reproduce this problem with the current latest version, 2.4.4:\n\nbuild process:\n- mkdir /tmp/apache/\n- cd /tmp/apache/\n- wget http://www.gtlib.gatech.edu/pub/apache/httpd/httpd-2.4.4.tar.gz\n- wget http://www.gtlib.gatech.edu/pub/apache/apr/apr-1.4.6.tar.gz\n- wget http://www.gtlib.gatech.edu/pub/apache/apr/apr-util-1.5.1.tar.gz\n- wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.32.tar.gz\n- tar xzf httpd-2.4.4.tar.gz\n- tar xzf apr-1.4.6.tar.gz\n- tar xzf apr-util-1.5.1.tar.gz\n- tar xzf pcre-8.32.tar.gz\n- mv apr-1.4.6 httpd-2.4.4/srclib/apr/\n- mv apr-util-1.5.1 httpd-2.4.4/srclib/apr-util/\n- cd /tmp/apache/pcre-8.32/\n- ./configure --prefix=/tmp/apache/mypcre\n- make && make install\n- cd /tmp/apache/httpd-2.4.4/\n- ./configure --prefix=/tmp/apache/myapache/ --enable-mods-shared=all --enable-mpms-shared=all --with-mpm=worker --disable-cgid --enable-proxy=shared --with-included-apr --with-pcre=/tmp/apache/mypcre/\n- make && make install\n\ntest config:\n/tmp/apache/myapache/conf> cat httpd.conf\nServerRoot /tmp/apache/myapache/\nListen 8080\nLoadModule authz_core_module modules/mod_authz_core.so\nLoadModule mpm_worker_module modules/mod_mpm_worker.so\nLoadModule unixd_module modules/mod_unixd.so\nLoadModule slotmem_shm_module modules/mod_slotmem_shm.so\nLoadModule proxy_module modules/mod_proxy.so\nLoadModule proxy_http_module modules/mod_proxy_http.so\nLoadModule proxy_balancer_module modules/mod_proxy_balancer.so\nLoadModule lbmethod_byrequests_module modules/mod_lbmethod_byrequests.so\n<Directory />\n    AllowOverride None\n    Require all denied\n</Directory>\nDocumentRoot /tmp/apache/myapache/htdocs\n<Directory /tmp/apache/myapache/htdocs>\n    AllowOverride None\n    Require all granted\n</Directory>\nErrorLog logs/error_log\nLogLevel warn\n<Proxy balancer://api-cluster>\n  BalancerMember http://box01:8182/api\n  BalancerMember http://box02:8182/api\n</Proxy>\nProxyPass /api/ balancer://api-cluster/\n\n\n- start the server\n- reproduce problem by repeatedly doing: curl http://localhost:8080/api/whatever"}, {"count": 2, "tags": [], "creator": "abiacco@formatdynamics.com", "attachment_id": null, "id": 171145, "time": "2013-11-08T16:11:06Z", "bug_id": 54657, "creation_time": "2013-11-08T16:11:06Z", "is_private": false, "text": "I can confirm this happens on my 2.2.24 also.\nThe app-03.local member listed below has no entry in my hosts file.\nMy member numbers also vary based on environment.\n\ncentos 6.4\nkernel 2.6.32-358.14.1.el6.x86_64\nhttpd 2.2.24\napr 1.4.6\napr-util 1.5.2\n\n\nSch\tHost\tStat\tRoute\tRedir\tF\tSet\tAcc\tWr\tRd\najp\tapp-03.local\tOk\tapp-03\t\t1\t0\t2\t 0\t 0\n\n[08/Nov/2013:08:59:14 -0700] GET /XXX 502 Sz 17 BR 246 BS 166 TMSec 12412 TSec 0 Bal balancer://loadbalancer SessWrk - RealWrk app-03 WrkName ajp://app-03.local:8009 PID 31861 TID 140004374312704 UID Un0KUgoKCtMAAHx1OF8AAAAM VHost XXX\n\n<IfModule mod_proxy_balancer.c>\n        ProxyPass /balancer-manager !\n        ProxyPass /XXX balancer://loadbalancer/XXX\n        ProxyPassReverse /XXX balancer://loadbalancer/XXX\n</IfModule>\n\n<IfModule mod_proxy.c>\n\n        ProxyRequests off\n        ProxyStatus On\n        # Enable/disable the handling of HTTP/1.1 \"Via:\" headers.\n        # (\"Full\" adds the server version; \"Block\" removes all outgoing Via: headers)\n        # Set to one of: Off | On | Full | Block\n        ProxyVia Off\n        ProxyPreserveHost On\n\n<IfModule mod_proxy_balancer.c>\n\n<Proxy balancer://loadbalancer>\n# Max is equal to the max threads a single tomcat can handle, devided by the number of tomcats being balanced\n# So if a single tomcat is configured for 300 max threads and there are 3 tomcats, you would set Max to 100 for each balancer member\nBalancerMember ajp://app-01.local:8009 route=app-01 loadfactor=1 max=200 acquire=2000 connectiontimeout=2 disablereuse=off keepalive=off ping=2 timeout=60 retry=60 ttl=120 flushpackets=on\nBalancerMember ajp://app-02.local:8009 route=app-02 loadfactor=1 max=200 acquire=2000 connectiontimeout=2 disablereuse=off keepalive=off ping=2 timeout=60 retry=60 ttl=120 flushpackets=on\nBalancerMember ajp://app-03.local:8009 route=app-03 loadfactor=1 max=200 acquire=2000 connectiontimeout=2 disablereuse=off keepalive=off ping=2 timeout=60 retry=60 ttl=120 flushpackets=on\n\nProxySet stickysession=JSESSIONID|jsessionid\nProxySet lbmethod=bybusyness\nProxySet scolonpathdelim=On\n# Balancer timeout in seconds. If set this will be the maximum time to wait for a free worker\n# Default is not to wait. (Acquire time * number of workers) / 1000?\nProxySet timeout=6\n# A single or comma-separated list of HTTP status codes. If set this will force the worker\n# into error state when the backend returns any status code in the list.\nProxySet failonstatus=500,503,502\n</Proxy>\n\n</IfModule>\n# end mod_proxy_balancer\n\n</IfModule>\n# end mod_proxy"}, {"count": 3, "tags": [], "creator": "cpjunk@yeroc.ca", "attachment_id": null, "is_private": false, "id": 187685, "time": "2016-01-14T16:17:37Z", "bug_id": 54657, "creation_time": "2016-01-14T16:17:37Z", "text": "I just got bitten by this same behaviour as well."}]