[{"count": 0, "tags": [], "bug_id": 51077, "attachment_id": null, "id": 145836, "time": "2011-04-18T14:35:08Z", "creator": "mark@catseye.org", "creation_time": "2011-04-18T14:35:08Z", "is_private": false, "text": "mod_rewrite does not pass the query string to the back-end server when the\n[P] flag is used with mod_proxy_fcgi or mod_proxy_scgi.\n\nTo reproduce the problem, add the following directives to the virtual host\ncontext and restart httpd:\n\nProxyPass /fcgi-test-proxypass/ fcgi://127.0.0.1:4000/\nProxyPass /scgi-test-proxypass/ scgi://127.0.0.1:4001/\nRewriteRule ^/(fcgi-test-rewrite/.*)$ fcgi://127.0.0.1:4000/$1 [P]\nRewriteRule ^/(scgi-test-rewrite/.*)$ scgi://127.0.0.1:4001/$1 [P]\n\n\nThen start each of the two perl scripts attached to this issue; each\none is a simple server (FastCGI and SCGI, respectively) that do nothing\nbut echo back the request environment variables to the client:\n\n# ./fcgi-test-server.pl &\n# ./scgi-test-server.pl &\n\n\nThe query string is handled properly when the ProxyPass directive is used:\n\n$ curl -s http://127.0.0.1/fcgi-test-proxypass/some/script.php?q=hello | \\\n  grep QUERY_STRING\nQUERY_STRING=\"q=hello\"\n$ curl -s http://127.0.0.1/scgi-test-proxypass/some/script.php?q=hello | \\\n  grep QUERY_STRING\nQUERY_STRING=\"q=hello\"\n$\n\n\nHowever, the query string is not passed to the back-end server when\nmod_rewrite is used.  (mod_proxy_fcgi sets the query string to an empty\nvalue, while mod_proxy_scgi does not set it at all.)\n\n$ curl -s http://127.0.0.1/fcgi-test-rewrite/some/script.php?q=hello | \\\n  grep QUERY_STRING\nQUERY_STRING=\"\"\n$ curl -s http://127.0.0.1/scgi-test-rewrite/some/script.php?q=hello | \\\n  grep QUERY_STRING\n$"}, {"count": 1, "tags": [], "text": "Created attachment 26894\nFastCGI test server for demonstrating the problem", "attachment_id": 26894, "bug_id": 51077, "id": 145837, "time": "2011-04-18T14:36:58Z", "creator": "mark@catseye.org", "creation_time": "2011-04-18T14:36:58Z", "is_private": false}, {"attachment_id": 26895, "tags": [], "bug_id": 51077, "is_private": false, "count": 2, "id": 145838, "time": "2011-04-18T14:37:27Z", "creator": "mark@catseye.org", "creation_time": "2011-04-18T14:37:27Z", "text": "Created attachment 26895\nSCGI test server for demonstrating the problem"}, {"count": 3, "tags": [], "bug_id": 51077, "attachment_id": 26896, "id": 145839, "time": "2011-04-18T14:38:46Z", "creator": "mark@catseye.org", "creation_time": "2011-04-18T14:38:46Z", "is_private": false, "text": "Created attachment 26896\nPatch to make mod_rewrite pass query strings to mod_proxy_fcgi and mod_proxy_scgi"}, {"attachment_id": null, "tags": [], "bug_id": 51077, "is_private": false, "count": 4, "id": 145840, "time": "2011-04-18T14:39:39Z", "creator": "mark@catseye.org", "creation_time": "2011-04-18T14:39:39Z", "text": "The attached patch fixes the problem:\n\n$ curl -s http://127.0.0.1/fcgi-test-rewrite/some/script.php?q=hello | \\\n  grep QUERY_STRING\nQUERY_STRING=\"q=hello\"\n$ curl -s http://127.0.0.1/scgi-test-rewrite/some/script.php?q=hello | \\\n  grep QUERY_STRING\nQUERY_STRING=\"q=hello\"\n$\n\nThe test for the http and https schemata is done first in order to\nprovide a small performance improvement by short-circuiting quickly in\nwhat should usually be the most common cases.\n\nThis should be a complete fix; none of the other schemata listed\nin mod_rewrite.c:is_absolute_uri() nor any of the other proxy modules\nappear to be candidates for accepting query strings."}, {"count": 5, "tags": [], "bug_id": 51077, "attachment_id": 26901, "id": 145845, "time": "2011-04-19T01:32:17Z", "creator": "mark@catseye.org", "creation_time": "2011-04-19T01:32:17Z", "is_private": false, "text": "Created attachment 26901\nVersion 2 - Patch to make mod_rewrite pass query strings to mod_proxy_fcgi and mod_proxy_scgi\n\n\nThe original patch resulted in different behavior in virtual host context versus directory context.\n\nIn virtual host context, mod_rewrite finishes with:\n\n2011-04-19 00:23:30.735588 Xs3Z3t0NPeY pid=14843 127.0.0.1:36448 127.0.0.1:80 rewrite:trace1 mod_rewrite.c(468): 127.0.0.1 - - [127.0.0.1/sid#7f17e5faf738][rid#7f17c80129f0/initial] go-ahead with proxy request proxy:fcgi://127.0.0.1:4000/fcgi-test-rewrite/some/script.php [OK]\n\nHowever, if the rewrite rule is placed in directory context, the final result has the query string appended to the URI, which in turn causes mod_proxy_fcgi to include the query string as a part of the SCRIPT_FILENAME environment variable, which is unexpected and causes problems for some (many?) back-end servers, including php-fpm.\n\n2011-04-19 00:25:20.246937 Tc9g5R0PPeY pid=14841 127.0.0.1:52797 127.0.0.1:80 rewrite:trace1 mod_rewrite.c(468): 127.0.0.1 - - [127.0.0.1/sid#7f17e5faf738][rid#7f17c8002970/initial] [perdir /www/html/] go-ahead with proxy request proxy:fcgi://127.0.0.1:4000/fcgi-test-rewrite2/some/script.php?q=hello [OK]\n\nThe virtual host context case and directory context case do not diverge from what is expected for each of them until the final trace message (above).\n\nInvestigation shows that mod_rewrite.c:hook_uri2file() (which is used for rewrite rules in server context) uses different tests for determining whether to append the query string to the filename than mod_rewrite.c:hook_fixup() (which is used for rewrite rules in directory context).\n\nVersion 2 of the patch (attached) fixes the original problem and also modifies hook_fixup() to use the same logic as hook_uri2file() in order to get consistent behavior between directory and virtual host contexts for rewrite rules that use the [P] flag."}, {"count": 6, "tags": [], "bug_id": 51077, "attachment_id": null, "id": 149712, "time": "2011-09-23T18:30:50Z", "creator": "jim@apache.org", "creation_time": "2011-09-23T18:30:50Z", "is_private": false, "text": "-            if (r->args != NULL) {\n+\t    if ((r->args != NULL)\n+                && ((r->proxyreq == PROXYREQ_PROXY)\n+                    || (rulestatus == ACTION_NOESCAPE))) {\n+                /* see proxy_http:proxy_http_canon() */\n\nbreaks framework tests... don't see the rationale for it"}, {"count": 7, "tags": [], "bug_id": 51077, "attachment_id": null, "id": 162220, "time": "2012-09-16T20:54:01Z", "creator": "mark@catseye.org", "creation_time": "2012-09-16T20:54:01Z", "is_private": false, "text": "This problem does not occur under httpd 2.4.3: RewriteRule with the [P] flag now passes the query string to the back-end server just like the ProxyPass directive does.\n\nClosing the issue."}]