[{"count": 0, "tags": [], "creator": "matsondawson@gmail.com", "attachment_id": null, "id": 161953, "time": "2012-09-05T04:05:54Z", "bug_id": 53829, "creation_time": "2012-09-05T04:05:54Z", "is_private": false, "text": "Timed out websocket hangs on send.\n\nComponent: Websockets\nJava: 1.6.25 and 1.6.30\nTomcat: 7.0.29\nOS: Windows Xp and SUSE Linux Enterprise Server 11 (x86_64) VERSION = 11 PATCHLEVEL = 1\nSeverity: \nFirewalls: none\nWeb server: Direct to Tomcat\nConfiguration: Default tomcat 7.0.29\n\nReproduce:\nIn a websocket chat application with firefox...\nPlace a breakpoint in your websocket servlet such that firefox times out on websocket connect (usually about 20 seconds).\nOnce firefox times out continue from your breakpoint, connection is stored in chat application.\nAttempt to write to socket (even though unknown to application it has reset), socket hangs.\n\nExpected:\nSocket should throw exception.\n\nWireshark Logs:\nGET /ui/websocket/hearing/hearing/1200104 HTTP/1.1\nHost: moj117894:8080\nUser-Agent: Mozilla/5.0 (Windows NT 5.1; rv:12.0) Gecko/20100101 Firefox/12.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\nAccept-Language: en-gb,en;q=0.5\nAccept-Encoding: gzip, deflate\nConnection: keep-alive, Upgrade\nSec-WebSocket-Version: 13\nOrigin: http://moj117894:8080\nSec-WebSocket-Key: yaf7QYaa4NGb1V5okQ76zA==\nCookie: JSESSIONID=1B535D70EAF05760390C784EF340B30C\nPragma: no-cache\nCache-Control: no-cache\nUpgrade: websocket\n\n\nHTTP/1.1 101 Switching Protocols\nServer: Apache-Coyote/1.1\nUpgrade: websocket\nConnection: upgrade\nSec-WebSocket-Accept: fuw+jh8p4BEW0MwPFbYRV2xOr3Q=\nTransfer-Encoding: chunked\nDate: Wed, 05 Sep 2012 03:29:17 GMT\n\n\n1\t0.000000\t10.134.2.149\t10.134.2.160\tTCP\t62\tquestnotify > http-alt [SYN] Seq=0 Win=65535 Len=0 MSS=1460 SACK_PERM=1\n2\t0.000022\t10.134.2.160\t10.134.2.149\tTCP\t62\thttp-alt > questnotify [SYN, ACK] Seq=0 Ack=1 Win=65535 Len=0 MSS=1460 SACK_PERM=1\n3\t0.000203\t10.134.2.149\t10.134.2.160\tTCP\t60\tquestnotify > http-alt [ACK] Seq=1 Ack=1 Win=65535 Len=0\n4\t0.000319\t10.134.2.149\t10.134.2.160\tHTTP\t599\tGET /ui/websocket/hearing/hearing/1200104 HTTP/1.1 \n5\t0.225306\t10.134.2.160\t10.134.2.149\tTCP\t54\thttp-alt > questnotify [ACK] Seq=1 Ack=546 Win=64990 Len=0\n6\t31.819501\t10.134.2.160\t10.134.2.149\tTCP\t275\t[TCP segment of a reassembled PDU]\n7\t32.017702\t10.134.2.149\t10.134.2.160\tTCP\t60\tquestnotify > http-alt [ACK] Seq=546 Ack=222 Win=65314 Len=0\n8\t37.890816\t10.134.2.160\t10.134.2.149\tTCP\t54\thttp-alt > questnotify [RST, ACK] Seq=222 Ack=546 Win=0 Len=0"}, {"count": 1, "tags": [], "bug_id": 53829, "attachment_id": null, "is_private": false, "id": 161954, "time": "2012-09-05T04:08:25Z", "creator": "matsondawson@gmail.com", "creation_time": "2012-09-05T04:08:25Z", "text": "Stack trace of hang:\n\njava.net.SocketOutputStream.socketWrite0(Native Method)\njava.net.SocketOutputStream.socketWrite(SocketOutputStream.java:92)\njava.net.SocketOutputStream.write(SocketOutputStream.java:115)\norg.apache.coyote.http11.upgrade.UpgradeBioProcessor.write(UpgradeBioProcessor.java:57)\norg.apache.coyote.http11.upgrade.UpgradeOutbound.write(UpgradeOutbound.java:41)\norg.apache.catalina.websocket.WsOutbound.doWriteBytes(WsOutbound.java:348)\norg.apache.catalina.websocket.WsOutbound.doWriteText(WsOutbound.java:398)\norg.apache.catalina.websocket.WsOutbound.writeTextMessage(WsOutbound.java:170)"}, {"count": 2, "tags": [], "creator": "markt@apache.org", "text": "Firefox doesn't close the connection, so since WebSocket uses an infinite timeout by default, Tomcat just sits and waits for Firefox so send some data. As soon as I close Firefox, the thread is released.\n\nPossible work-arounds are:\n- use a different browser (e.g. Chrome it didn't time out after a couple of minutes in my simple test)\n- specify a read timeout for the WebSocket app and then use ping/pongs to keep the connection alive\n\nYou may also want to report a bug against Firefox since the onClose() event is firing but the socket is remaining open.", "id": 161984, "time": "2012-09-05T23:01:27Z", "bug_id": 53829, "creation_time": "2012-09-05T23:01:27Z", "is_private": false, "attachment_id": null}]