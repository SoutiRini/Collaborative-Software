[{"attachment_id": null, "tags": [], "creator": "fred.bregier@free.fr", "is_private": false, "count": 0, "id": 91691, "time": "2006-07-28T10:52:00Z", "bug_id": 40134, "creation_time": "2006-07-28T10:52:00Z", "text": "We used httpd-2.2.0 as a reverse proxy in MPM mode.\nBehind the reverse proxy are :\n- first one Alteon (load balancer) which sets one cookie\n  (mode cookie-insert to keep the session on the same web server behind\n   for one particular user)\n- second (after the Alteon) several web servers (Apache+PHP)\n  which are setting too a cookie (PHP_SESSID).\nEverything works fine in apache 2.2.0.\n\nWhen we upgrade to apache 2.2.2 (due to one referenced bug of apache 2.2.0\nof segmentation fault every 2 to 3 hours in MPM mode), \nwe lost the first cookie (Alteon cookie) but still have the\nPHP cookie. Of course, our users had a big problem since\ndue to the lack of this Alteon cookie, they changed for every page\nof PHP server, so not getting the sticky session as supposed.\n\nWe got back to the apache 2.2.0 and everything is working well\n(exactly the same configuration, except the level of binary).\n\nI presume it is a regression capability of apache 2.2.2 compares\nto apache 2.2.0.\n\nFrederic"}, {"count": 1, "text": "Can you please do a network sniff between your reverse proxy and your\nloadbalancer with 2.2.2 (or better 2.2.3 if possible) running and a network\nsniff between your client and your reverse proxy? Furthermore your configuration\n(especially the proxy part) would be helpful.", "bug_id": 40134, "attachment_id": null, "id": 91696, "time": "2006-07-28T13:28:45Z", "creator": "rpluem@apache.org", "creation_time": "2006-07-28T13:28:45Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "creator": "fred.bregier@free.fr", "attachment_id": null, "id": 91712, "time": "2006-07-29T08:38:11Z", "bug_id": 40134, "creation_time": "2006-07-29T08:38:11Z", "is_private": false, "text": "I didn't have access right now to my config but here is what I can write:\nI used a tool (IBM Page Detailer) which traces the headers of the\nrequests. The construction is as follow :\n- first a reverse proxy 2.2.x with compression enable\n- passing to a reverse proxy cache 2.0.x\n- passing to a load balancer (Alteon) which sets a cookie\n- passing to one of the PHP web servers (1.3.x)\nThe reason of the first 2 proxies is that the first proxy is using\ncompression for all applications, and some of them do not accept\ncache (different proxy conf) and some does, so the chaining.\nAlso we wanted to be able to change one conf without stopping\neverything.\nWe used apache 2.2.x for compression since we need to use the mod_filter\nto check if we are allowed to compress the message proxified\n(for instance bug of IE when we compressed a PDF dynamic page).\nWe start 2 years ago with the mod_filter applied to apache 2.0.x,\nthen 2.1.x and now 2.2.x. Everything is ok there.\nThe conf of the reverse proxy is as follow and very standard (except the\ncompression part which makes it different than a standard reverse proxy) :\n(mode MPM_Worker)\n<VirtualHost default:80>\n# Reverse proxy definition\nProxyRequests Off\nProxyPreserveHost On\nProxyBadHeader Ignore\nProxyPass / http://foo.example.com/\nProxyPassReverse / http://foo.example.com/\n# Compression part (I don't have the code to read but the spirit is here)\nFilterDeclare gzip CONTENT_SET\nFilterProvider gzip resp=Content-Type $text/html\nFilterChain gzip \n</VirtualHost>\n\nThen the trace from IBM Page Detailer is as follow :\n- accessing directly to the load Balancer of PHP Web server:\n   \"set-cookie ALTEONPHP=xxx\" and \"set-cookie PHP_SESSID=xxx\"\n  OK\n- accessing to cache reverse proxy (apache 2.0.x) (-> alteon next)\n  \"set-cookie ALTEONPHP=xxx\" and \"set-cookie PHP_SESSID=xxx\"\n  OK\n- accessing to compression reverse proxy (apache 2.2.0) (-> cache RP next)\n  \"set-cookie ALTEONPHP=xxx\" and \"set-cookie PHP_SESSID=xxx\"\n  OK\n- accessing to compression reverse proxy (apache 2.2.2) (-> cache RP next)\n  \"set-cookie PHP_SESSID=xxx\" only\n  KO since the user will change every time of PHP web server \n  so the lack of affinity session.\nThe configuration for apache 2.2.0 and apache 2.2.2 are exactly the\nsame, same option for building, ...\n\nWe had 2 years ago a similar problem (not with apache)\nwith a open source software based on perl. Its function\nis to serve as a web portal with authentification wich makes\na reverse proxy with a single sign on feature.\nThis product was not able to accept more than 1 set-cookie\nat a time. An upgrade of version just correct this situation.\n\nAt the time writing, I don't have any clue except the\nchange of version from 2.2.0 to 2.2.2.\nGetting back to 2.2.0 just make the service back.\nI have also tested with 2.1.0 and it is ok too.\n\nFrederic"}, {"count": 3, "tags": [], "bug_id": 40134, "is_private": false, "text": "I test against 2.2.2, 2.2.3 and 2.2.4, the same error is\nstill there. The synoptic is as follow :\n1) First Alteon (load balancer) for proxy servers using a cookie\nfor affinity session (named PROXYCOOKIE).\n2) Proxy server\nHere is the configuration for all proxy server :\n<VirtualHost *:8080>\n     ServerName aristote\n     DocumentRoot /tmp/\n     ProxyRequests off\n     ProxyBadHeader StartBody\n     ProxyPreserveHost On\n     ProxyTimeout 300\n\n     ProxyPass / http://second-alteon:80/\n     ProxyPassReverse / http://second-alteon:80/\n</VirtualHost>\n3) The second alteon load balance between PHP Servers,\nsetting a new cookie named PHPCOOKIE\n4) The PHP server set a new cookie (PHPSESSID).\n\nI see the first cookie (PROXYCOOKIE), the last one (PHPSESSID),\nbut never the second one (PHPCOOKIE). The problem is therefore\nthe second alteon change the web server from time to time,\nbroken the session affinity and the applications behind.\n\nWhen I use apache 2.2.0, everything is OK (3 cookies from\nthe first time).\n\n", "id": 98453, "time": "2007-01-24T07:09:48Z", "creator": "fred.bregier@free.fr", "creation_time": "2007-01-24T07:09:48Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 40134, "is_private": false, "count": 4, "id": 98471, "time": "2007-01-24T14:04:32Z", "creator": "rpluem@apache.org", "creation_time": "2007-01-24T14:04:32Z", "text": "Please provide a network sniff when accessing your second alteon directly\n(http://second-alteon:80/). This is important for trying to reproduce the issue.\nFrom first glance the changes between 2.2.0 and 2.2.2 give me no idea why this\ncould happen."}, {"count": 5, "tags": [], "creator": "fred.bregier@free.fr", "attachment_id": 19464, "id": 98549, "time": "2007-01-26T01:18:18Z", "bug_id": 40134, "creation_time": "2007-01-26T01:18:18Z", "is_private": false, "text": "Created attachment 19464\nNetwork trace from Http sniffer (IBM Page detailer) to Alteon1 with httpd 2.2.0 : Status OK\n\nTrace when access to first PHP page using the following network path :\nalteon1 -> 1 of the RP httpd 2.2.0 -> alteon 2 -> 1 of the Apache+PHP.\n3 set-cookie are visible :\nSet-Cookie: PHPSESSID=1dc60dea0ed60e4f6951f69fb9fbf7c6; path=/\nSet-Cookie: PHPMONTREUIL=php2; path=/\nSet-Cookie: RPMONTREUIL=rp1; path=/\n\nThis is OK."}, {"count": 6, "tags": [], "creator": "fred.bregier@free.fr", "text": "Created attachment 19465\nNetwork trace from Http sniffer (IBM Page detailer) to Alteon2 with httpd 2.2.0 : Status OK\n\nTrace when access to first PHP page using the following network path :\nalteon 2 -> 1 of the Apache+PHP.\n2 set-cookie are visible :\nSet-Cookie: PHPSESSID=8aaec7f61126e08833f0dceecc6ced85; path=/\nSet-Cookie: PHPMONTREUIL=php1; path=/\n\nThis is OK.", "id": 98550, "time": "2007-01-26T01:19:57Z", "bug_id": 40134, "creation_time": "2007-01-26T01:19:57Z", "is_private": false, "attachment_id": 19465}, {"count": 7, "tags": [], "bug_id": 40134, "attachment_id": 19466, "text": "Created attachment 19466\nNetwork trace from Http sniffer (IBM Page detailer) to Alteon1 with httpd 2.2.4 : Status KO\n\nTrace when access to first PHP page using the following network path :\nalteon1 -> 1 of the RP httpd 2.2.4 -> alteon 2 -> 1 of the Apache+PHP.\n2 set-cookie are visible :\nSet-Cookie: PHPSESSID=1bd7f35c2b376125ca614390792b4d43; path=/\nSet-Cookie: RPMONTREUIL=rp1; path=/\n\nThis is KO.\nWhen I use a PHP application with a context, from time to time, \nthe second alteon change from one PHP server to another,\nthus cancelling the session affinity and cancelling the application session.", "id": 98551, "time": "2007-01-26T01:22:36Z", "creator": "fred.bregier@free.fr", "creation_time": "2007-01-26T01:22:36Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 40134, "is_private": false, "text": "Created attachment 19467\nNetwork trace from Http sniffer (IBM Page detailer) to Alteon2 without httpd 2.2.4 : Status OK\n\nTrace when access to first PHP page using the following network path :\nalteon 2 -> 1 of the Apache+PHP.\n2 set-cookie are visible :\nSet-Cookie: PHPSESSID=a7a1d5f639f81daa131a1942817b5f36; path=/\nSet-Cookie: PHPMONTREUIL=php2; path=/\n\nThis is OK.\nSo it confirms a bug in httpd 2.2.4 (also true for httpd 2.2.2 and 2.2.3).", "id": 98552, "time": "2007-01-26T01:24:56Z", "creator": "fred.bregier@free.fr", "creation_time": "2007-01-26T01:24:56Z", "attachment_id": 19467}, {"count": 9, "tags": [], "bug_id": 40134, "is_private": false, "text": "Created attachment 19546\nNetwork trace from Http sniffer (IBM Page detailer) to Alteon1 with httpd 2.3.0 : Status OK\n\nNetwork trace from Http sniffer (IBM Page detailer) to Alteon1 with httpd 2.3.0\n\n: Status OK\n\nTrace when access to first PHP page using the following network path :\nalteon1 -> 1 of the RP httpd 2.3.0 -> alteon 2 -> 1 of the Apache+PHP.\n3 set-cookie are visible :\nSet-Cookie: PHPSESSID=1dc60dea0ed60e4f6951f69fb9fbf7c6; path=/\nSet-Cookie: PHPMONTREUIL=php2; path=/\nSet-Cookie: RPMONTREUIL=rp1; path=/\n\nThis is OK. So the bug is not in devel version 2.3.0 but still in 2.2.4.\nThere must be a patch applied in 2.3 that corrects the problem ?", "id": 99102, "time": "2007-02-08T06:40:43Z", "creator": "fred.bregier@free.fr", "creation_time": "2007-02-08T06:40:43Z", "attachment_id": 19546}, {"attachment_id": null, "tags": [], "creator": "nick@webthing.com", "text": "I've gone through all proxy changes in SVN between 2.0 and 2.2, and fail to see\nany change that even touches the response headers.  This leads me wonder if\nthere's something else happening in your proxy.\n\nDoes 2.2.6 work for you?", "count": 10, "id": 107862, "time": "2007-09-08T08:48:06Z", "bug_id": 40134, "creation_time": "2007-09-08T08:48:06Z", "is_private": false}, {"count": 11, "tags": [], "creator": "nick@webthing.com", "attachment_id": null, "text": "No response for over a year; assuming fixed in last year's proxy protocol work.", "id": 123523, "time": "2008-12-26T10:33:06Z", "bug_id": 40134, "creation_time": "2008-12-26T10:33:06Z", "is_private": false}]