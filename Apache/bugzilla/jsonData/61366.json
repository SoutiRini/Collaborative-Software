[{"count": 0, "tags": [], "creator": "jhorowitz@aod-tech.com", "is_private": false, "id": 200124, "attachment_id": 35191, "bug_id": 61366, "creation_time": "2017-08-01T00:05:18Z", "time": "2017-08-01T00:05:18Z", "text": "Created attachment 35191\nProperly set the TCCL before performing JNDI datasource lookups\n\nWhen attempting to utilize a JNDI datasource defined at the Context level, JDBCStore uses the wrong TCCL and the lookup fails.\n\nThe fix for this (patch attached against current 8.5.x-trunk (revision 1803599) is similar to the changes introduced by revisions 1514281 and 1726925:  the JDBCStore session store implementation correctly sets the TCCL to that of the webapp context before attempting to load a session from the database.\n\nIt should do the same before attempting the JNDI datasource lookup."}, {"count": 1, "tags": [], "bug_id": 61366, "is_private": false, "text": "Created PR at https://github.com/apache/tomcat/pull/71\n\nUpdating patch to reflect the PR changes, backported to 8.5.x-trunk.", "id": 200125, "time": "2017-08-01T00:47:04Z", "creator": "jhorowitz@aod-tech.com", "creation_time": "2017-08-01T00:47:04Z", "attachment_id": null}, {"count": 2, "tags": [], "text": "Created attachment 35192\nProperly set the TCCL before performing JNDI datasource lookups", "is_private": false, "bug_id": 61366, "id": 200126, "time": "2017-08-01T00:47:46Z", "creator": "jhorowitz@aod-tech.com", "creation_time": "2017-08-01T00:47:46Z", "attachment_id": 35192}, {"count": 3, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 200134, "time": "2017-08-01T12:57:57Z", "bug_id": 61366, "creation_time": "2017-08-01T12:57:57Z", "is_private": false, "text": "The patch forces a switch from a global DataSource to a local one. That is going to break configurations for anyone currently using this Store.\n\nI think what is required is something similar to the DataSourceRealm's localDataSource attribute that allows either to be used."}, {"count": 4, "tags": [], "text": "Created attachment 35194\nSet TCCL to the webapp classloader if localDataSource == true", "is_private": false, "bug_id": 61366, "id": 200135, "time": "2017-08-01T17:39:55Z", "creator": "jhorowitz@aod-tech.com", "creation_time": "2017-08-01T17:39:55Z", "attachment_id": 35194}, {"count": 5, "tags": [], "bug_id": 61366, "is_private": false, "text": "Thanks Mark, the patch and PR have been modified to reflect your recommendation.", "id": 200136, "time": "2017-08-01T17:40:20Z", "creator": "jhorowitz@aod-tech.com", "creation_time": "2017-08-01T17:40:20Z", "attachment_id": null}, {"count": 6, "tags": [], "text": "Many thanks.\n\nI added some docs and a change log entry and applied it.\n\nFixed in:\n- trunk for 9.0.0.M26 onwards\n- 8.5.x for 8.5.20 onwards\n- 8.0.x for 8.0.46 onwards\n\nI didn't back-port to 7.0.x because the back-port was not clean and it seems unlikely that anyone already using 7.0.x is going to need this option.", "attachment_id": null, "id": 200151, "creation_time": "2017-08-02T15:39:05Z", "time": "2017-08-02T15:39:05Z", "creator": "markt@apache.org", "bug_id": 61366, "is_private": false}]