[{"attachment_id": null, "tags": [], "bug_id": 52950, "text": "To reproduce it, use the following setting in the httpd.conf\n\n<Location /private/>\n    AuthType None\n    Require valid-user\n</Location>\n\nstart the httpd server, and then use the browser to access the /private/. The browser will show \u201c500 Internal Server Error\u201d, while the server prints the following message in the error log\n\n[Mon Mar 19 21:14:30.936513 2012] [core:error] [pid 3431:tid 140737100195584] [client 132.239.17.127:42029] AH00027: Buggy authn provider failed to set user for /private/\n\nThe message here is really very misleading and inaccurate.\n\n---------\n\nuse gdb to trace the code, the problem is at server/request.c\n\n    access_status = ap_run_access_checker_ex(r);\n    if (access_status == OK) {\n    ap_log_rerror(APLOG_MARK, APLOG_TRACE3, 0, r,\n                  \"request authorized without authentication by \"\n                  \"access_checker_ex hook: %s\", r->uri);\n    }\n    else if (access_status != DECLINED) {\n        return decl_die(access_status, \"check access\", r);\n    }\n    else {\n        if ((access_status = ap_run_check_user_id(r)) != OK) {\n            return decl_die(access_status, \"check user\", r);\n        }\n        if (r->user == NULL) {\n            /* don't let buggy authn module crash us in authz */\n            ap_log_rerror(APLOG_MARK, APLOG_ERR, 0, r, APLOGNO(00028)\n                          \"Buggy authn provider failed to set user for %s\",\n                          r->uri);\n            access_status = HTTP_INTERNAL_SERVER_ERROR;\n            return decl_die(access_status, \"check user\", r);\n        }\n        ....,,\n    }\n\nsince AuthType is set to None, the ap_auth_type is always set to be NULL (see set_authtype() function in modules/aaa/mod_authn_core.c). \nIn the hooked functions like \n\nauthenticate_basic_user (r=0x8b17f0) at mod_auth_basic.c:197 \nauthenticate_form_authn (r=0x8b17f0) at mod_auth_form.c:849\nauthenticate_no_user (r=0x8b17f0) at mod_authn_core.c:351\n\nr->user cannot be set a value if ap_auth_type is NULL.\n\nSo the error occurs.", "count": 0, "id": 155090, "time": "2012-03-20T09:18:53Z", "creator": "tixu@cs.ucsd.edu", "creation_time": "2012-03-20T09:18:53Z", "is_private": false}]