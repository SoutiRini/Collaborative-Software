[{"count": 0, "tags": [], "bug_id": 58491, "text": "Hi,\n\nWe are currently facing an issue with Apache since our 2.4 upgrade. When the load increase too much (250 hits/s) the http instance generates core files.\n\nHere is the kind of core that we have :\n\nCore was generated by `/tech/apache/runtime/httpd-2.4.16/bin/httpd -D inst-switch -d /tech/apache -f /'.\nProgram terminated with signal 11, Segmentation fault.\n#0  apr_pool_cleanup_register (p=0x400000010, data=0x3181c78, plain_cleanup_fn=0x7f15bb4e7cc0 <thread_cond_cleanup>, child_cleanup_fn=0x427b10 <apr_pool_cleanup_null@plt>)\n    at memory/unix/apr_pools.c:2213\n2213\tmemory/unix/apr_pools.c: No such file or directory.\n\tin memory/unix/apr_pools.c\n\n(gdb) bt\n#0  apr_pool_cleanup_register (p=0x400000010, data=0x3181c78, plain_cleanup_fn=0x7f15bb4e7cc0 <thread_cond_cleanup>, child_cleanup_fn=0x427b10 <apr_pool_cleanup_null@plt>)\n    at memory/unix/apr_pools.c:2213\n#1  0x00007f15bb4e7de8 in apr_thread_cond_create (cond=0x3181c20, pool=0x3181168) at locks/unix/thread_cond.c:55\n#2  0x00007f15bb93f5ec in apr_reslist_create (reslist=0x1e46300, min=<value optimized out>, smax=<value optimized out>, hmax=25, ttl=<value optimized out>, con=<value optimized out>, \n    de=0x7f15b745a3e0 <connection_destructor>, params=0x291d9e8, pool=0x3181168) at misc/apr_reslist.c:299\n#3  0x00007f15b745af2d in ap_proxy_initialize_worker (worker=0x291d9e8, s=0x1eaaa38, p=0x1e46148) at proxy_util.c:1848\n#4  0x00007f15b7455cac in proxy_handler (r=0x7f1570002970) at mod_proxy.c:1087\n#5  0x000000000044b210 in ap_run_handler ()\n#6  0x000000000044f38e in ap_invoke_handler ()\n#7  0x000000000046201a in ap_process_async_request ()\n#8  0x000000000046217f in ap_process_request ()\n#9  0x000000000045e4ce in ap_process_http_connection ()\n#10 0x0000000000456020 in ap_run_process_connection ()\n#11 0x00007f15ba0c7f2a in process_socket (thd=0x2fce5f0, dummy=<value optimized out>) at worker.c:619\n#12 worker_thread (thd=0x2fce5f0, dummy=<value optimized out>) at worker.c:978\n#13 0x00007f15bac739d1 in start_thread () from /lib64/libpthread.so.0\n#14 0x00007f15ba9c08fd in clone () from /lib64/libc.so.6\n\nThis http instance is a reverse proxy with the following configuration at server level :\n\n\tProxyPreserveHost On\n\tBalancerPersist On\n\tRewriteRule /(.*)   balancer://tomcat7_80/$1  [proxy]\n\n\nWith the balancer defined at the server level :\n\n<Proxy balancer://tomcat7_80>\n        ProxySet lbmethod=bybusyness maxattempts=1\n\n        BalancerMember http://127.0.6.49:80           lbset=0 smax=0 ttl=3 connectiontimeout=2 retry=60\n\n        BalancerMember http://10.70.6.48:80           lbset=1 smax=0 ttl=3 connectiontimeout=2 retry=60\n\n</Proxy>\n\nWe have the same configuration on live environment with a much higher load without facing any issue with Apache 2.2.\n\nDetails about our platform :\n\n- OS : RHEL 6.4\n- Apache 2.4.16 compiled with apr-1.5.2 and apr-util-1.5.4\n- MPM_worker", "id": 185708, "time": "2015-10-09T09:21:29Z", "creator": "sygoulmy@gmail.com", "creation_time": "2015-10-09T09:21:29Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 58491, "text": "Do you insert/update load-balancer members via the balancer-manager during runtime?", "id": 185777, "time": "2015-10-16T21:38:39Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2015-10-16T21:38:39Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "sygoulmy@gmail.com", "text": "Sorry for this late answer.\n\nThe definitons of the balancer members are static, we don't add/remove any definitons during runtime.\n\nThe status can be modified during runtime by disabling/enabling a member with the balancer manager. However i have checked in the log files, the status of the balancer members have NOT been modified when the core dump appeared.\n\nBesides that we still have many core dumps on this http instance but many of them are different from the one i submited. They are still relative to the mod_proxy module but some of them appears during request processing and not process launching.\n\nWould you like that i add the new core dumps to the current ticket or should i open a ticket for each type of error ?", "id": 185970, "time": "2015-10-26T10:20:38Z", "bug_id": 58491, "creation_time": "2015-10-26T10:20:38Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "ylavic.dev@gmail.com", "attachment_id": null, "text": "(In reply to Sylvain Goulmy from comment #2)\n> Would you like that i add the new core dumps to the current ticket or should\n> i open a ticket for each type of error ?\n\nPlease use this same ticket since the error may be a corrupted memory which could be better diagnosed with other backtraces (the previous one made few sense so far).", "id": 185996, "time": "2015-10-26T23:23:22Z", "bug_id": 58491, "creation_time": "2015-10-26T23:23:22Z", "is_private": false}, {"count": 4, "text": "Please find two core that appeared on the same http instance with an interval of one minute :\n\nCore was generated by `/tech/apache/runtime/httpd-2.4.16/bin/httpd -D inst-switch -d /tech/apache -f /'.\nProgram terminated with signal 11, Segmentation fault.\n#0  run_cleanups (pool=0x7f15bbf7a018) at memory/unix/apr_pools.c:2351\n2351\tmemory/unix/apr_pools.c: No such file or directory.\n\tin memory/unix/apr_pools.c\nMissing separate debuginfos, use: debuginfo-install AF-httpd-2.4.16-0-el6.4.x86_64\n(gdb) bt full\n#0  run_cleanups (pool=0x7f15bbf7a018) at memory/unix/apr_pools.c:2351\n        c = 0x2e362e302e373231\n#1  apr_pool_destroy (pool=0x7f15bbf7a018) at memory/unix/apr_pools.c:804\n        active = <value optimized out>\n        allocator = <value optimized out>\n#2  0x00007f15b745a3fb in connection_destructor (resource=<value optimized out>, params=<value optimized out>, pool=<value optimized out>) at proxy_util.c:1499\n        conn = <value optimized out>\n#3  0x00007f15bb93f315 in destroy_resource (reslist=0x31d9600, resource=0x7f15a7df1ac8) at misc/apr_reslist.c:135\nNo locals.\n#4  apr_reslist_acquire (reslist=0x31d9600, resource=0x7f15a7df1ac8) at misc/apr_reslist.c:345\n        rv = <value optimized out>\n        res = 0x31d9638\n        now = 1445846735860297\n#5  0x00007f15b745a969 in ap_proxy_acquire_connection (proxy_function=0x7f15b724a1fe \"HTTP\", conn=0x7f15a7df1ac8, worker=0x31b77c8, s=0x2c8a4a8) at proxy_util.c:2125\n        rv = <value optimized out>\n#6  0x00007f15b7247879 in proxy_http_handler (r=0x7f155c006990, worker=0x31b77c8, conf=0x1edfd38, \n    url=0x7f155c003488 \"http://127.0.6.48/UpdateMyAccountCustomerWS/ws/passenger/marketing/000443v05\", proxyname=0x0, proxyport=0) at mod_proxy_http.c:1957\n        status = <value optimized out>\n        server_portstr = \"\\001\\000\\000\\000\\000\\000\\000\\000\\225\\312h\\270\\025\\177\\000\\000\\000\\000\\000\\000\\000\\000\\000\\000\\344\\217N\\273\\025\\177\\000\"\n        scheme = 0x7f155c003530 \"http\"\n        proxy_function = 0x7f15b724a1fe \"HTTP\"\n        u = <value optimized out>\n        backend = 0x0\n        is_ssl = 0\n        c = 0x7f159c01f968\n        retry = 0\n        p = 0x7f155c006918\n        uri = 0x7f155c0034d8\n\n\t\t\nCore was generated by `/tech/apache/runtime/httpd-2.4.16/bin/httpd -D inst-switch -d /tech/apache -f /'.\nProgram terminated with signal 11, Segmentation fault.\n#0  0x00007f15bb93efbd in get_container (reslist=0x31d9760) at misc/apr_reslist.c:97\n97\tmisc/apr_reslist.c: No such file or directory.\n\tin misc/apr_reslist.c\nMissing separate debuginfos, use: debuginfo-install AF-httpd-2.4.16-0-el6.4.x86_64\n(gdb) bt full\n#0  0x00007f15bb93efbd in get_container (reslist=0x31d9760) at misc/apr_reslist.c:97\n        res = 0x31d9780\n#1  0x00007f15bb93f02e in create_resource (reslist=0x31d9760, ret_res=0x7f15afffe868) at misc/apr_reslist.c:121\n        rv = 52270976\n        res = <value optimized out>\n#2  0x00007f15bb93f416 in apr_reslist_acquire (reslist=0x31d9760, resource=0x7f15afffeac8) at misc/apr_reslist.c:395\n        rv = <value optimized out>\n        res = 0x81\n        now = 1445846790718097\n#3  0x00007f15b745a969 in ap_proxy_acquire_connection (proxy_function=0x7f15b724a1fe \"HTTP\", conn=0x7f15afffeac8, worker=0x31b77c8, s=0x2c8a4a8) at proxy_util.c:2125\n        rv = <value optimized out>\n#4  0x00007f15b7247879 in proxy_http_handler (r=0x7f158c002970, worker=0x31b77c8, conf=0x1edfd38, \n    url=0x7f158c0074a8 \"http://127.0.6.48/UpdateMyAccountCustomerWS/ws/passenger/marketing/000443v05\", proxyname=0x0, proxyport=0) at mod_proxy_http.c:1957\n        status = <value optimized out>\n        server_portstr = \"p\\032\\276\\002\", '\\000' <repeats 12 times>, \"wh?\\025\\177\\000\\000\\063\\242N\\273\\025\\177\\000\"\n        scheme = 0x7f158c007550 \"http\"\n        proxy_function = 0x7f15b724a1fe \"HTTP\"\n        u = <value optimized out>\n        backend = 0x0\n        is_ssl = 0\n        c = 0x7f15b0007368\n        retry = 0\n        p = 0x7f158c0028f8\n        uri = 0x7f158c0074f8\n#5  0x00007f15b7450f12 in proxy_run_scheme_handler (r=0x7f158c002970, worker=0x31b77c8, conf=0x1edfd38, \n    url=0x7f158c0074a8 \"http://127.0.6.48/UpdateMyAccountCustomerWS/ws/passenger/marketing/000443v05\", proxyhost=0x0, proxyport=0) at mod_proxy.c:2789\n        pHook = <value optimized out>\n        n = <value optimized out>\n        rv = -1\n\n\t\t\nOnce again, i have checked that there was no configuration reload or any balancer updates at that time.\n\nI have kept the core files if necessary.\n\nHope it helps.", "bug_id": 58491, "is_private": false, "id": 186011, "time": "2015-10-27T13:08:06Z", "creator": "sygoulmy@gmail.com", "creation_time": "2015-10-27T13:08:06Z", "tags": [], "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 58491, "is_private": false, "text": "Hi,\n\nFor information, i have upgraded to Apache 2.4.17, since i have had two new cores :\n\nThe first one :\n\n#0  0x00007f8531da63a0 in pthread_mutex_lock () from /lib64/libpthread.so.0\nNo symbol table info available.\n#1  0x00007f8532a70076 in apr_reslist_maintain (reslist=0x17c9630) at misc/apr_reslist.c:184\n        now = <value optimized out>\n        rv = <value optimized out>\n        res = <value optimized out>\n        created_one = 0\n#2  0x00007f8532a705fe in apr_reslist_create (reslist=0xc3f230, min=<value optimized out>, smax=<value optimized out>, hmax=25, ttl=<value optimized out>, con=<value optimized out>, \n    de=0x7f852e58a440 <connection_destructor>, params=0x12b6698, pool=0x17c92d8) at misc/apr_reslist.c:305\n        rv = 0\n        rl = 0x17c9630\n#3  0x00007f852e58afdd in ap_proxy_initialize_worker (worker=0x12b6698, s=0xc34110, p=0xc3f0e8) at proxy_util.c:1854\n        rv = <value optimized out>\n        mpm_threads = 32645\n#4  0x00007f852e585c73 in proxy_handler (r=0x7f8508002970) at mod_proxy.c:1088\n        url = 0x7f8508007148 \"http://127.0.6.65/daemon/ws/COMET32_AMADEUS\"\n        uri = 0x7f8508007086 \"balancer://tomcat6_80/daemon/ws/COMET32_AMADEUS\"\n        scheme = 0x7f85080070e8 \"balancer\"\n        p = <value optimized out>\n        p2 = <value optimized out>\n        sconf = <value optimized out>\n        conf = 0xc3aef8\n        proxies = 0xc3b028\n        ents = 0xc361f8\n        i = <value optimized out>\n        access_status = 0\n        direct_connect = <value optimized out>\n        str = <value optimized out>\n        maxfwd = <value optimized out>\n        balancer = 0x12ad028\n        worker = 0x12b6698\n        attempts = 0\n        max_attempts = 0\n        list = <value optimized out>\n        saved_status = <value optimized out>\n#5  0x000000000044ce00 in ap_run_handler ()\nNo symbol table info available.\n#6  0x0000000000450f7e in ap_invoke_handler ()\nNo symbol table info available.\n#7  0x00000000004641ba in ap_process_async_request ()\nNo symbol table info available.\n#8  0x000000000046431f in ap_process_request ()\nNo symbol table info available.\n#9  0x000000000046065e in ap_process_http_connection ()\nNo symbol table info available.\n#10 0x0000000000457d30 in ap_run_process_connection ()\nNo symbol table info available.\n\nWith the following messages in the error log :\n\n[Fri Oct 30 06:18:20.094520 2015] [mpm_worker:emerg] [pid 1804:tid 140209616217856] (35)Resource deadlock avoided: AH00272: apr_proc_mutex_lock failed before this child process served any requests.\n[Fri Oct 30 11:27:34.378987 2015] [core:notice] [pid 20080:tid 140210063746880] AH00051: child pid 6479 exit signal Segmentation fault (11), possible coredump in /tech/apache/var/logs/switch\n\nAnd the second one :\n\n#0  ap_proxy_connect_backend (proxy_function=0x7f286014c1fe \"HTTP\", conn=0x298d300, worker=0x2281ef8, s=0x1e69448) at proxy_util.c:2706\n        rv = <value optimized out>\n        connected = 0\n        loglevel = <value optimized out>\n        backend_addr = 0x612e6474732e3034\n        local_addr = <value optimized out>\n        newsock = 0x2997540\n        sconf = <value optimized out>\n        conf = 0x1c07ef8\n#1  0x00007f28601499dc in proxy_http_handler (r=0x7f2834002970, worker=0x2281ef8, conf=0x1c07ef8, url=0x7f28340073e0 \"http://127.0.6.48/TravelDbServices/ws/ProvideTravelDbPassengerList-v1\", \n    proxyname=0x0, proxyport=0) at mod_proxy_http.c:1991\n        locurl = 0x7f28340074e8 \"/TravelDbServices/ws/ProvideTravelDbPassengerList-v1\"\n        status = 0\n        server_portstr = \"\\000\\342\\370\\002\", '\\000' <repeats 12 times>, \"w\\230\\267c(\\177\\000\\000\\063\\322>d(\\177\\000\"\n        scheme = <value optimized out>\n        proxy_function = 0x7f286014c1fe \"HTTP\"\n        u = <value optimized out>\n        backend = 0x298d300\n        is_ssl = 36183800\n        c = 0x7f2844002d28\n        retry = <value optimized out>\n        p = 0x7f28340028f8\n        uri = 0x7f2834007428\n#2  0x00007f2860352ef2 in proxy_run_scheme_handler (r=0x7f2834002970, worker=0x2281ef8, conf=0x1c07ef8, \n    url=0x7f28340073e0 \"http://127.0.6.48/TravelDbServices/ws/ProvideTravelDbPassengerList-v1\", proxyhost=0x0, proxyport=0) at mod_proxy.c:2806\n        pHook = <value optimized out>\n        n = <value optimized out>\n        rv = -1\n#3  0x00007f2860357f77 in proxy_handler (r=0x7f2834002970) at mod_proxy.c:1162\n        url = 0x7f28340073e0 \"http://127.0.6.48/TravelDbServices/ws/ProvideTravelDbPassengerList-v1\"\n        uri = 0x7f28340072ce \"balancer://tomcat7_80/TravelDbServices/ws/ProvideTravelDbPassengerList-v1\"\n        scheme = 0x7f2834007360 \"balancer\"\n        p = <value optimized out>\n        p2 = <value optimized out>\n        sconf = <value optimized out>\n        conf = 0x1c07ef8\n        proxies = 0x1c08028\n        ents = 0x1c031f8\n        i = <value optimized out>\n        access_status = 0\n        direct_connect = <value optimized out>\n        str = <value optimized out>\n        maxfwd = <value optimized out>\n        balancer = 0x227e128\n        worker = 0x2281ef8\n        attempts = 0\n        max_attempts = 1\n        list = <value optimized out>\n        saved_status = <value optimized out>\n\n\nWith the following messages in the error log :\n\t\t\n[Thu Oct 29 19:53:32.564666 2015] [proxy:error] [pid 31761:tid 139811349370624] (22)Invalid argument: AH00957: HTTP: attempt to connect to ?:21768 (127.0.6.48) failed\n[Thu Oct 29 19:53:32.564661 2015] [proxy:error] [pid 31761:tid 139811359860480] (22)Invalid argument: AH00957: HTTP: attempt to connect to ?:21768 (127.0.6.48) failed\n[Thu Oct 29 19:53:33.555683 2015] [core:notice] [pid 30780:tid 139811468363584] AH00051: child pid 31761 exit signal Bus error (7), possible coredump in /tech/apache/var/logs/switch", "id": 186115, "time": "2015-10-30T14:39:26Z", "creator": "sygoulmy@gmail.com", "creation_time": "2015-10-30T14:39:26Z", "attachment_id": null}, {"count": 6, "tags": [], "creator": "sygoulmy@gmail.com", "text": "Hi,\n\nToday i have had two more cores on my http instance in get_container method. These two cores were linked to the following error message in the error log :\n\n[Tue Nov 03 11:40:49.837710 2015] [proxy_http:error] [pid 18490:tid 139811338880768] [client 10.70.1.43:48219] AH01114: HTTP: failed to make connection to backend: 127.0.6.57\n[Tue Nov 03 12:29:28.355655 2015] [proxy:error] [pid 13344:tid 139811349370624] (70007)The timeout specified has expired: AH00941: HTTP: failed to acquire connection for (127.0.6.57)\n[Tue Nov 03 12:29:28.355723 2015] [proxy_http:error] [pid 13344:tid 139811359860480] [client 10.70.1.43:17359] AH01114: HTTP: failed to make connection to backend: 127.0.6.57\n[Tue Nov 03 12:29:29.346693 2015] [core:notice] [pid 30780:tid 139811468363584] AH00051: child pid 13344 exit signal Segmentation fault (11), possible coredump in /tech/apache/var/logs/switch\n\n\n[Tue Nov 03 12:59:42.492382 2015] [proxy:error] [pid 14803:tid 139811251812096] (70007)The timeout specified has expired: AH00941: HTTP: failed to acquire connection for (127.0.6.57)\n[Tue Nov 03 12:59:42.492369 2015] [proxy:error] [pid 14803:tid 139811241322240] (70007)The timeout specified has expired: AH00941: HTTP: failed to acquire connection for (127.0.6.57)\n[Tue Nov 03 12:59:42.492432 2015] [proxy_http:error] [pid 14371:tid 139811338880768] [client 10.70.1.43:6279] AH01114: HTTP: failed to make connection to backend: 127.0.6.57\n[Tue Nov 03 12:59:42.492524 2015] [proxy:error] [pid 14803:tid 139811338880768] (70007)The timeout specified has expired: AH00941: HTTP: failed to acquire connection for (127.0.6.57)\n[Tue Nov 03 12:59:48.489341 2015] [core:notice] [pid 30780:tid 139811468363584] AH00051: child pid 14803 exit signal Segmentation fault (11), possible coredump in /tech/apache/var/logs/switch", "id": 186225, "time": "2015-11-03T14:20:13Z", "bug_id": 58491, "creation_time": "2015-11-03T14:20:13Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "creator": "sygoulmy@gmail.com", "attachment_id": null, "text": "Hi,\n\nAfter removing the BalancerPersist directive the core dumps stop appearing for four days now whereas we used to have one or several core files by day.\n\nI'll give you a new update in a week to confirm that this directive is the root cause.\n\nRgds.", "id": 186373, "time": "2015-11-13T09:24:23Z", "bug_id": 58491, "creation_time": "2015-11-13T09:24:23Z", "is_private": false}]