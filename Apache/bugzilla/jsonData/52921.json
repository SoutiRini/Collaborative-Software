[{"count": 0, "attachment_id": 28475, "bug_id": 52921, "is_private": false, "id": 154948, "time": "2012-03-15T18:05:33Z", "creator": "thad.humphries@gmail.com", "creation_time": "2012-03-15T18:05:33Z", "tags": [], "text": "Created attachment 28475\nmod_jk.log showing full run from Apache start through failed HTML page\n\nSince October 2011, I have run the mod_jk/1.2.32 connector. I built the connector myself using Apache 2.2.15's apxs (I also built Apache myself).\n\nI downloaded, built, and installed the latest mod_jk.1.2.33 connector. This version causes my Apache server to crash when serving most any page I've tried--HTML, cgi-bin/test-cgi, GIF, etc. The only exceptions I've found are Apache's htdocs/index.html page, server-info, and Tomcat served pages.\n\nInitially I tried building the connector using --with-apxs set to the apxs in my copy of Apache 2.2.15. When that failed, I downloaded, built, and installed Apache 2.2.22, then built mod_jk 1.2.33 with the apxs from that version. Again, Apache (this time 2.2.22) crashes with mod_jk 1.2.33, but runs fine with the 1.2.32 connector.\n\nI am running openSUSE Linux 11.4. From the connector's config.log:\nuname -m = i686\nuname -r = 2.6.37.6-0.11-desktop\nuname -s = Linux\nuname -v = #1 SMP PREEMPT 2011-12-19 23:39:38 +0100\n\nTo document the problem, I added \"CoreDumpDirectory /tmp\" to httpd.conf, set \"JkLogLevel trace\" for mod_jk, made sure I was going to load mod_jk/1.2.33, and started Tomcat and Apache (I don't see Tomcat as necessary for this, but just be thorough). I accessed a simple HTML page. (I get similar results trying to access the local Apache manual, local javadocs, etc.)\n\nI'm attaching the mod_jk.log that resulted. Below is the entire contents of the Apache error_log:\n\n[Thu Mar 15 09:05:14 2012] [warn] Init: Session Cache is not configured [hint: SSLSessionCache]\n[Thu Mar 15 09:05:14 2012] [notice] Apache/2.2.22 (Unix) mod_ssl/2.2.22 OpenSSL/1.0.0c mod_jk/1.2.33 configured -- resuming normal operations\n[Thu Mar 15 09:05:22 2012] [notice] child pid 24552 exit signal Segmentation fault (11), possible coredump in /tmp\n\n\nHere is what I find in /tmp/core with gdb:\n\n$ gdb /srv/apache2/bin/httpd /tmp/core\nGNU gdb (GDB) SUSE (7.2-3.3)\nCopyright (C) 2010 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"i586-suse-linux\".\nFor bug reporting instructions, please see:\n<http://www.gnu.org/software/gdb/bugs/>...\nReading symbols from /srv/apache2.2.22/bin/httpd...done.\n[New Thread 24552]\n...\nLoaded symbols for /lib/ld-linux.so.2\nReading symbols from /srv/apache2/modules/mod_jk.so...done.\nLoaded symbols for /srv/apache2/modules/mod_jk.so\nCore was generated by `/srv/apache2.2.22/bin/httpd -k start'.\nProgram terminated with signal 11, Segmentation fault.\n#0  0xb720288c in jk_map_to_storage () from /srv/apache2/modules/mod_jk.so\n(gdb) backtrace\n#0  0xb720288c in jk_map_to_storage () from /srv/apache2/modules/mod_jk.so\n#1  0x08081478 in ap_run_map_to_storage ()\n#2  0x08081e55 in ap_process_request_internal ()\n#3  0x080da502 in ap_process_request ()\n#4  0x080d7531 in ap_process_http_connection ()\n#5  0x0808f05f in ap_run_process_connection ()\n#6  0x0808f474 in ap_process_connection ()\n#7  0x080f3deb in child_main ()\n#8  0x080f3fe0 in make_child ()\n#9  0x080f403a in startup_children ()\n#10 0x080f44d8 in ap_mpm_run ()\n#11 0x08070e89 in main ()\n(gdb) \n\nI can provide the full core dump if required."}, {"count": 1, "tags": [], "text": "Are you able to build mod_jk with symbols, e.g. adding \"-g\" to your gcc flags? That way gdb would show us the line number where the crash happens.\n\nFurthermore the request you used for reproduction is for \"/~thad/\". Does it also happen if you directly retrieve a mapped URL explicitely, like e.g. an index.jsp or similar, and on the other hand a non mapped object directly, like an index.txt?\n\nI will try to reproduce tomorrow.\n\nRegards,\n\nRainer", "is_private": false, "id": 154954, "creator": "rainer.jung@kippdata.de", "time": "2012-03-15T20:40:13Z", "bug_id": 52921, "creation_time": "2012-03-15T20:40:13Z", "attachment_id": null}, {"count": 2, "attachment_id": null, "bug_id": 52921, "is_private": false, "id": 154957, "time": "2012-03-15T21:24:04Z", "creator": "thad.humphries@gmail.com", "creation_time": "2012-03-15T21:24:04Z", "tags": [], "text": "This happens if I directly retrieve a mapped URL explicitly.\n\nMounts made with JkMount work fine. \"JkMount /*.jsp ajp13\" and \"JkMount /*/servlet/* ajp13\" allow me to run the Tomcat examples, as do my JkMount's apps.\n\nOddly, HTML and images placed directly under the server root (/srv/apache2.2.22/htdocs) display fine. Those same files placed in another directory will not display though the directory has been Alias'ed (the files display fine if mod_jk/1.2.32 is loaded vs 1.2.33).\n\nApache's manual, Alias'ed as manual, will not display with mod_jk/1.2.33 loaded but will with 1.2.33.\n\nI will rebuild mod_jk with the -g option on Monday and provide you the backtrace then.\n\nThanks."}, {"count": 3, "tags": [], "bug_id": 52921, "attachment_id": null, "text": "Confirmed on Debian Linux, Apache 2.2.16, mod_jk 1.2.33, using JkMounts and all other settings that have been in place for years in working configuration.\n\nSome specifics of my configuration:\n\nDocumentRoot /var/www/...\nAlias /context /path/to/my/context\nJkMount /context/*.jsp workerX\nJkMount /context/...\n\nAccessing files in DocumentRoot works.\nMaking a request to /context/a.jsp cores every time.\nMaking a request to /context/a.css (not JkMounted) cores every time.\nAccessing a file in DocumentRoot (again) works. At first, I thought this wasn't working because I was getting connection-resets for everything, but I was not able to reproduce it.\n\nI'll re-build with -g and get a stack trace.", "id": 154990, "time": "2012-03-16T20:33:05Z", "creator": "chris@christopherschultz.net", "creation_time": "2012-03-16T20:33:05Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 52921, "attachment_id": null, "is_private": false, "id": 154991, "time": "2012-03-16T20:54:18Z", "creator": "chris@christopherschultz.net", "creation_time": "2012-03-16T20:54:18Z", "text": "Debian isn't making my life easy. I did build with debugging symbols:\n\n$ grep CFLAGS Makefile\nAPXSCFLAGS = -DLINUX=2 -D_FORTIFY_SOURCE=2 -D_GNU_SOURCE -D_REENTRANT -I/usr/include/apr-1.0 -I/usr/include/openssl -I/usr/include/xmltok -pthread   -DHAVE_APR  -I/usr/include/apr-1.0 -I/usr/include/apr-1.0 -g -DHAVE_CONFIG_H\nCFLAGS = -g -DHAVE_CONFIG_H\n\nMy old 1.2.23:\n$ ls -l /usr/lib/apache2/modules/mod_jk-1.2.32.so \n-rwxr-xr-x 1 root root 483286 Dec  7 11:28 /usr/lib/apache2/modules/mod_jk-1.2.32.so\n$ file /usr/lib/apache2/modules/mod_jk-1.2.32.so \n/usr/lib/apache2/modules/mod_jk-1.2.32.so: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, not stripped\n\nMy new 1.2.33:\n$ file /usr/lib/apache2/modules/mod_jk-1.2.33.so \n/usr/lib/apache2/modules/mod_jk-1.2.33.so: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, not stripped\n$ ls -l /usr/lib/apache2/modules/mod_jk-1.2.33.so \n-rwxr-xr-x 1 root root 769392 Mar 16 16:35 /usr/lib/apache2/modules/mod_jk-1.2.33.so\n\nThe new version is nearly twice the size as the older one: I suspect that debugging symbols *have* been compiled-in.\n\nYet:\n\n gdb /usr/sbin/apache2 core\nGNU gdb (GDB) 7.0.1-debian\nCopyright (C) 2009 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"x86_64-linux-gnu\".\nFor bug reporting instructions, please see:\n<http://www.gnu.org/software/gdb/bugs/>...\n\nwarning: The current binary is a PIE (Position Independent Executable), which\nGDB does NOT currently support.  Most debugger features will fail if used\nin this session.\n\nReading symbols from /usr/sbin/apache2...(no debugging symbols found)...done.\n[New Thread 8888]\n[New Thread 8899]\n[New Thread 8900]\n[New Thread 8901]\n[New Thread 8903]\n[New Thread 8905]\n[New Thread 8892]\n[New Thread 8907]\n[New Thread 8894]\n[New Thread 8909]\n[New Thread 8896]\n[New Thread 8912]\n[New Thread 8914]\n[New Thread 8916]\n[New Thread 8918]\n[New Thread 8920]\n[New Thread 8934]\n[New Thread 8922]\n[New Thread 8895]\n[New Thread 8893]\n[New Thread 8924]\n[New Thread 8891]\n[New Thread 8926]\n[New Thread 8932]\n[New Thread 8928]\n[New Thread 8930]\nCore was generated by `/usr/sbin/apache2 -k start'.\nProgram terminated with signal 11, Segmentation fault.\n#0  0x00007f63638f56aa in ?? ()\n(gdb) where\n#0  0x00007f63638f56aa in ?? ()\n#1  0x0000000000000030 in ?? ()\n#2  0x00007f63657a6c61 in ?? ()\n#3  0x00007f636954cbc0 in ?? ()\n#4  0x00007f6369982a30 in ?? ()\n#5  0x0000000000000000 in ?? ()\n(gdb) \n\nI guess this means that since httpd doesn't have debugging symbols, we can't see anything. Also, it's using DSOs, so those probably don't get loaded by gdb anyway. I'll see what I can do.\n\nMore environment information:\n$ uname -a\nLinux dev.chadis.com 2.6.32-312-ec2 #24-Ubuntu SMP Fri Jan 7 18:30:50 UTC 2011 x86_64 GNU/Linux\n\n\n$ /usr/sbin/apache2 -V\nServer version: Apache/2.2.16 (Debian)\nServer built:   Feb  5 2012 21:35:44\nServer's Module Magic Number: 20051115:24\nServer loaded:  APR 1.4.2, APR-Util 1.3.9\nCompiled using: APR 1.4.2, APR-Util 1.3.9\nArchitecture:   64-bit\nServer MPM:     Worker\n  threaded:     yes (fixed thread count)\n    forked:     yes (variable process count)\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/worker\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"/etc/apache2\"\n -D SUEXEC_BIN=\"/usr/lib/apache2/suexec\"\n -D DEFAULT_PIDLOG=\"/var/run/apache2.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"mime.types\"\n -D SERVER_CONFIG_FILE=\"apache2.conf\""}, {"count": 5, "tags": [], "bug_id": 52921, "text": "Reviewing diff of current native/apache-2.0/mod_jk.c against r1142157 (aka 1.2.32 tag)\n\nThat is:\n[1] http://svn.apache.org/viewvc/tomcat/jk/trunk/native/apache-2.0/mod_jk.c?r1=1240904&r2=1142157&diff_format=h\n\n\nThe request-specific configuration structure was changed from (rule_extension_t *) to new structure (jk_request_conf_t *). That was done in r1187906\n\n\nLooking at the hook methods in mod_jk.c that access jk_request_conf_t:\n\n1. jk_translate \n\n  Does palloc of new instance unconditionally\n\n2. jk_map_to_storage\n\n  Checks for NULL and conditionally does palloc of new instance.\n\n3. request_log_transaction\n\n  Checks for NULL and returns DECLINED if it is null\n\n4. jk_handler\n  and init_ws_service (supplementary method called from jk_handler)\n\n  Access the structure without checking it for NULL.\n  Those are lines @r1293818:\n805, 807; 2575, 2577; 2603, 2605; 2625, 2627\n\nI think that jk_handler method should get the jk_request_conf_t instance once somewhere near the top of the method and check it for being NULL.\nThere are 3 possible ways to react if it is NULL:\n\n  a) return DECLINED,\n  b) palloc a new instance like jk_map_to_storage does.\n  c) skip the code that accesses the structure\n\n+    jk_request_conf_t *rconf = ap_get_module_config(r->request_config, &jk_module);\n+    if (rconf == NULL) {\n+        jk_request_conf_t *rconf = apr_palloc(r->pool, sizeof(jk_request_conf_t));\n+        rconf->jk_handled = JK_FALSE;\n+        rconf->rule_extensions = NULL;\n+        ap_set_module_config(r->request_config, &jk_module, rconf);\n+    }\n+", "id": 154996, "time": "2012-03-16T23:41:19Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2012-03-16T23:41:19Z", "is_private": false, "attachment_id": null}, {"count": 6, "attachment_id": null, "bug_id": 52921, "is_private": false, "id": 155000, "time": "2012-03-17T19:17:22Z", "creator": "mturk@apache.org", "creation_time": "2012-03-17T19:17:22Z", "tags": [], "text": "So I was able to reproduce it as well.\nSeems the crash is inside handling rule extensions\n\nProgram received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0xab1e7b40 (LWP 4822)]\n0xb7cbd3ae in jk_map_to_storage (r=0xaa0024c8) at mod_jk.c:3783\n3783\t                rconf->rule_extensions = e;\n\n(gdb) bt\n#0  0xb7cbd3ae in jk_map_to_storage (r=0xaa0024c8) at mod_jk.c:3783\n#1  0x08080598 in ap_run_map_to_storage ()\n#2  0x0808123e in ap_process_request_internal ()\n#3  0x080a2ca3 in ap_process_async_request ()\n#4  0x0809f762 in ap_process_http_async_connection ()\n#5  0x0809f932 in ap_process_http_connection ()\n#6  0x08095e03 in ap_run_process_connection ()"}, {"count": 7, "tags": [], "bug_id": 52921, "text": "Fixed in r1301987\nSuppose 1.2.34 is coming pretty soon :)", "id": 155001, "time": "2012-03-17T20:01:40Z", "creator": "mturk@apache.org", "creation_time": "2012-03-17T20:01:40Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 52921, "attachment_id": null, "text": "(In reply to comment #7)\n> Fixed in r1301987\n> Suppose 1.2.34 is coming pretty soon :)\n\nI build trunk and tried it -- no more SIGSEGV :)", "id": 155056, "time": "2012-03-19T16:18:16Z", "creator": "chris@christopherschultz.net", "creation_time": "2012-03-19T16:18:16Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 52921, "attachment_id": null, "text": "I've checked out 1301987, built, and tried it. All okay here with mod_jk/1.2.34-dev", "id": 155060, "time": "2012-03-19T17:38:49Z", "creator": "thad.humphries@gmail.com", "creation_time": "2012-03-19T17:38:49Z", "is_private": false}]