[{"count": 0, "tags": [], "creator": "vlsergey@gmail.com", "text": "There is extractor (converter?) from DOC to FO in hdf package, but it's not based on HWPF code. Neither support images or customization.\n\nin patch new extractor is proposed:\n - it is based on HWPF code\n - it is using DOM creation of FO document, not string building\n - with correct implementation of ImageHandler it can even convert MathType equations (i.e. extract WMF of those and let your ImageHandler do everything) \n\nSome things are not tested yet (for example, images, shapes or nested tables), but current code already creates nice PDF documents (with Apache FOP)", "id": 147008, "time": "2011-06-09T21:01:28Z", "bug_id": 51351, "creation_time": "2011-06-09T21:01:28Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 51351, "attachment_id": 27143, "id": 147009, "time": "2011-06-09T21:01:59Z", "creator": "vlsergey@gmail.com", "creation_time": "2011-06-09T21:01:59Z", "is_private": false, "text": "Created attachment 27143\npatch"}, {"count": 2, "tags": [], "creator": "yegor@dinom.ru", "text": "Thanks for the patch.\n\nCan you upload some samples so we can test your code? It would be nice to see a source .doc file, the produced XSL-FO and the resulting PDF. \n\nHow do you run FOP, via command line? Please post the exact command.\n\nRegards,\nYegor", "id": 147015, "time": "2011-06-10T07:19:27Z", "bug_id": 51351, "creation_time": "2011-06-10T07:19:27Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "text": "How much efforts are you going to invest in this utility? In its current form it is rather a proof of concept than a full-featured convertor. \n\nI was able to generate XSL-FO for some files from our collection of test Word documents. FOP 1.0 renders simple files, but stumbles on more complex ones:\n\nSeveral times I've seen this:\n\nCaused by: org.xml.sax.SAXParseException: Character reference \"&#12\" is an invalid XML character.\n        at org.apache.xerces.parsers.AbstractSAXParser.parse(Unknown Source)\n        at org.apache.xerces.jaxp.SAXParserImpl$JAXPSAXParser.parse(Unknown Source)\n\nand this:\n\njavax.xml.transform.TransformerException: org.apache.fop.fo.ValidationException: Border and padding for fo:region-body \"xsl-region-body\" sho\nld be '0' (See 6.4.14 in XSL 1.1); non-standard values are allowed if relaxed validation is enabled.  (See position 5:411)\n       at org.apache.fop.cli.InputHandler.transformTo(InputHandler.java:302)\n       at org.apache.fop.cli.InputHandler.renderTo(InputHandler.java:130)\n       at org.apache.fop.cli.Main.startFOP(Main.java:174)\n\nAlso, I see warnings in the console:\n\nJun 11, 2011 7:19:10 PM org.apache.fop.events.LoggingEventListener processEvent\nSEVERE: Invalid property value encountered in linefeed-treatment=\"false\": org.apache.fop.fo.expr.PropertyException: file:/C:/temp/DiffFirstP\nageHeadFoot.xml:9:38: No conversion defined false; property:'linefeed-treatment' (See position 10:520)\nJun 11, 2011 7:19:10 PM org.apache.fop.events.LoggingEventListener processEvent\nSEVERE: Invalid property value encountered in linefeed-treatment=\"false\": org.apache.fop.fo.expr.PropertyException: file:/C:/temp/DiffFirstP\nageHeadFoot.xml:9:38: No conversion defined false; property:'linefeed-treatment' (See position 16:520)\nJun 11, 2011 7:19:10 PM org.apache.fop.events.LoggingEventListener processEvent\nSEVERE: Invalid property value encountered in keep-together.within-page=\"true\": org.apache.fop.fo.expr.PropertyException: file:/C:/temp/Diff\nFirstPageHeadFoot.xml:9:38: No conversion defined true; property:'keep-together.within-page' (See position 20:578)\nJun 11, 2011 7:19:10 PM org.apache.fop.events.LoggingEventListener processEvent\nSEVERE: Invalid property value encountered in keep-with-next.within-page=\"true\": org.apache.fop.fo.expr.PropertyException: file:/C:/temp/Dif\nfFirstPageHeadFoot.xml:9:38: No conversion defined true; property:'keep-with-next.within-page' (See position 20:578)\nJun 11, 2011 7:19:10 PM org.apache.fop.events.LoggingEventListener processEvent \n\nWordToFOExtractor is a very promising feature, the question is where it should live: in poi-examples as a simple demo, or with the rest of HWPF code as a well-tested code.\n\nRegards,\nYegor", "attachment_id": null, "id": 147035, "creator": "yegor@dinom.ru", "time": "2011-06-11T15:58:55Z", "bug_id": 51351, "creation_time": "2011-06-11T15:58:55Z", "is_private": false}, {"count": 4, "tags": [], "creator": "vlsergey@gmail.com", "text": "Yegor,\n\nI will test and upload updated patch and examples using test doc files from POI collections of test files.\n\nCurrently FOP is called using additional bunch of code, including image handling. This is tightly linked to our internal system (for example, it's includes converting images from WMF to SVG format), so extracting an example is tricky.\n\nThis is currently proof-of-concept code, but i believe it will be part of production system in several month. Also I believe functionality of new extractor is better (at least not worse) then old org.apache.poi.hdf.extractor package.\n\nPersonally I intent to continue supporting this code until it will be ready for production usage and may be implement xls-to-fo extractor. My goal to create one-way converter with maximum readability, i.e. without lost text but may be without some formatting.\n\nShould I also notice that doc-to-html shall be easy to implement ? ;)\n\nRegards,\nSergey", "id": 147082, "time": "2011-06-13T21:42:36Z", "bug_id": 51351, "creation_time": "2011-06-13T21:42:36Z", "is_private": false, "attachment_id": null}, {"count": 5, "text": "Created attachment 27153\nUpdated patch\n\nFixed \"keep\" attributes;\nRemoved ImageHandler interface (handle images by extending extractor)", "bug_id": 51351, "is_private": false, "id": 147086, "time": "2011-06-13T23:09:58Z", "creator": "vlsergey@gmail.com", "creation_time": "2011-06-13T23:09:58Z", "tags": [], "attachment_id": 27153}, {"count": 6, "tags": [], "bug_id": 51351, "text": "POI doc sources, fo xml and PDF results\nhttp://www.sendspace.com/file/sf4o24\n2.5 Mb in size", "id": 147090, "time": "2011-06-13T23:18:00Z", "creator": "vlsergey@gmail.com", "creation_time": "2011-06-13T23:18:00Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "text": "Patch applied in r1135414. I added  Java main() to WordToFoExtractor, this is how I tested your code:\n\nUsage: WordToFoExtractor <inputFile.doc> <saveTo.fo>\n\nExcept for formatting and indentation, the output is identical to the XML in the uploaded archive. \n\n> \n> Personally I intent to continue supporting this code until it will be ready for\n> production usage and may be implement xls-to-fo extractor. My goal to create\n> one-way converter with maximum readability, i.e. without lost text but may be\n> without some formatting.\n> \n\nGreat! It will be a really valuable contribution.\n\nA xls-to-fo converter has been asked several times on the mailing lists. We already have ToCSV and ToHtml apps in poi-examples and  xls-to-fo can borrow/ share code from them.\n\n> Should I also notice that doc-to-html shall be easy to implement ? ;)\n> \n\nThat would be nice to have too. \n\nP.S. I'm leaving this ticket open for updates. Close it if you prefer to upload new patches in a new ticket.\n\nRegards,\nYegor", "attachment_id": null, "id": 147095, "creator": "yegor@dinom.ru", "time": "2011-06-14T09:14:02Z", "bug_id": 51351, "creation_time": "2011-06-14T09:14:02Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 51351, "text": "Created attachment 27155\nAdd most of images handling, except cropping\n\nAdded all possible image handling, except cropping - i can't find a way to obtain this information, neither pictures SPRM.\n\nSee testPictures.doc.pdf and testCroppedPictures.doc.pdf for examples.\n\nhttp://www.sendspace.com/file/adie2l", "id": 147116, "time": "2011-06-14T14:58:59Z", "creator": "vlsergey@gmail.com", "creation_time": "2011-06-14T14:58:59Z", "is_private": false, "attachment_id": 27155}, {"count": 9, "text": "Applied in r1136001\n\nIt looks like you attached not the most recent version of your code - createExternalGraphic is never called and the fo:external-graphic element is missing in the output. No prob - I expect it in next patches. \n\nRegards,\nYegor", "bug_id": 51351, "is_private": false, "id": 147132, "time": "2011-06-15T11:49:17Z", "creator": "yegor@dinom.ru", "creation_time": "2011-06-15T11:49:17Z", "tags": [], "attachment_id": null}, {"count": 10, "tags": [], "creator": "vlsergey@gmail.com", "attachment_id": null, "id": 147134, "time": "2011-06-15T12:05:49Z", "bug_id": 51351, "creation_time": "2011-06-15T12:05:49Z", "is_private": false, "text": "Yegor,\n\nGraphic handling won't be part of extractor code. It's a lot of additional code AND additional libraries like Apache Batik or even ImageMagic calls. Also file creation and cleaning up should be coded.\n\nSo there is an empty processImage() method that should be implemented in subclass if anyone want image to be included in XSL FO. createExternalGraphic() and setImageProperties() are helper methods for those people."}, {"count": 11, "tags": [], "creator": "yegor@dinom.ru", "attachment_id": null, "id": 147184, "time": "2011-06-16T08:03:03Z", "bug_id": 51351, "creation_time": "2011-06-16T08:03:03Z", "is_private": false, "text": "> \n> Graphic handling won't be part of extractor code. It's a lot of additional code\n> AND additional libraries like Apache Batik or even ImageMagic calls. Also file\n> creation and cleaning up should be coded.\n> \n> So there is an empty processImage() method that should be implemented in\n> subclass if anyone want image to be included in XSL FO. createExternalGraphic()\n> and setImageProperties() are helper methods for those people.\n\nI see, but we can provide default support for png/jpeg with minimum efforts! I added the following code and it worked for me:\n\n\n    protected void processImage(Element currentBlock, boolean inlined,\n            Picture picture) {\n\n        byte[] bytes = picture.getContent();\n        String ext = picture.getMimeType();\n        if(ext.equals(\"image/jpeg\") || ext.equals(\"image/png\")){\n            File file = new File(picture.suggestFullFileName()); \n\n            try {\n                // dump images in the work dir \n                FileOutputStream out = new FileOutputStream(file);\n                out.write(bytes);\n                out.close();\n\n                Element graphics = createExternalGraphic(file.toURI().toASCIIString());\n                WordToFoUtils.setPictureProperties(picture, graphics);\n                currentBlock.appendChild(graphics);\n\n            } catch (IOException e){\n                e.printStackTrace();\n            }\n        }\n\n    }\n\nI agree that handling other mimetypes is not trivial and may involve third-party libraries, but jpeg and png are most commons and should be supported by default.\n\nDoes it make sense for you?\n\nRegards,\nYegor"}, {"count": 12, "tags": [], "bug_id": 51351, "attachment_id": null, "text": "Yegor,\n\nYes, the provided code can correctly words for png and jpeg images. i shall assume, FOP can also handle BMP, TIFFs and GIFs, so they can be listed there as well. May be even WMF, according to http://xmlgraphics.apache.org/fop/0.95/graphics.html (but i wouldn't advise to assume it).\n\nBut the main question is about cleaning up the files after work. Where those image files shall be stored? Who and when should delete them? What happens in can of exception with those files? (and for your code - what happens in case of parallel processing?)\n\nEither this part is handled by external code, or it can be handled by Extractor code. In second case we will need some kind of close() or cleanup() method to delete those files after FOP processing.\n\nRegards,\nSergey.\n\nP.S.: I subscribed to poi-user/poi-dev mailists, so we can move discussion there.", "id": 147189, "time": "2011-06-16T09:39:26Z", "creator": "vlsergey@gmail.com", "creation_time": "2011-06-16T09:39:26Z", "is_private": false}, {"count": 13, "attachment_id": 27177, "creator": "vlsergey@gmail.com", "text": "Created attachment 27177\nnew patch\n\nAdd hyperlinks support;\nAdd common fields support;\nSplit WordToFoExtractor and AbstractToFoExtractor", "id": 147266, "time": "2011-06-20T09:05:50Z", "bug_id": 51351, "creation_time": "2011-06-20T09:05:50Z", "tags": [], "is_private": false}, {"count": 14, "text": "Created attachment 27178\nAdditional test docs", "bug_id": 51351, "attachment_id": 27178, "id": 147267, "time": "2011-06-20T09:07:28Z", "creator": "vlsergey@gmail.com", "creation_time": "2011-06-20T09:07:28Z", "tags": [], "is_private": false}, {"count": 15, "tags": [], "bug_id": 51351, "attachment_id": 27198, "text": "Created attachment 27198\nPatch to fix ListEntryNoListTable and MBD001D0B89 tests; additional tests", "id": 147391, "time": "2011-06-23T08:11:35Z", "creator": "vlsergey@gmail.com", "creation_time": "2011-06-23T08:11:35Z", "is_private": false}, {"count": 16, "tags": [], "text": "Applied in r1138836\n\nYegor\n\n(In reply to comment #15)\n> Created attachment 27198 [details]\n> Patch to fix ListEntryNoListTable and MBD001D0B89 tests; additional tests", "attachment_id": null, "bug_id": 51351, "id": 147395, "time": "2011-06-23T11:28:58Z", "creator": "yegor@dinom.ru", "creation_time": "2011-06-23T11:28:58Z", "is_private": false}, {"count": 17, "tags": [], "bug_id": 51351, "attachment_id": null, "text": "I made a small change in TestWordToFoExtractorSuite and added an option to exclude certain files from the suite.\n\nI resolved an old Bug 33519 which complained that HWPF failed on open a document and added the problematic file to our test collection. As result, TestWordToFoExtractorSuite started to fail on Bug33519.doc with a NPE:\n\njava.lang.NullPointerException\n\tat org.apache.poi.hwpf.extractor.WordToFoExtractor.processCharacters(WordToFoExtractor.java:255)\n\tat org.apache.poi.hwpf.extractor.WordToFoExtractor.processParagraph(WordToFoExtractor.java:492)\n\tat org.apache.poi.hwpf.extractor.WordToFoExtractor.processSectionParagraphes(WordToFoExtractor.java:571)\n\tat org.apache.poi.hwpf.extractor.WordToFoExtractor.processSection(WordToFoExtractor.java:519)\n\tat org.apache.poi.hwpf.extractor.WordToFoExtractor.processDocument(WordToFoExtractor.java:332)\n\tat org.apache.poi.hwpf.extractor.WordToFoExtractor.process(WordToFoExtractor.java:167)\n \nYegor", "id": 147439, "time": "2011-06-24T08:51:47Z", "creator": "yegor@dinom.ru", "creation_time": "2011-06-24T08:51:47Z", "is_private": false}, {"count": 18, "tags": [], "text": "Created attachment 27204\nWorkaround for NPE in Bug 33519\n\n(In reply to comment #17)\n> I resolved an old Bug 33519 which complained that HWPF failed on open a\n> document and added the problematic file to our test collection. As result,\n> TestWordToFoExtractorSuite started to fail on Bug33519.doc with a NPE:\n\nWordkaround in proposed patch.", "attachment_id": 27204, "bug_id": 51351, "id": 147446, "time": "2011-06-24T10:08:52Z", "creator": "vlsergey@gmail.com", "creation_time": "2011-06-24T10:08:52Z", "is_private": false}, {"count": 19, "tags": [], "text": "Created attachment 27205\nWorkaround for NPE in Bug 33519", "attachment_id": 27205, "id": 147501, "creator": "vlsergey@gmail.com", "time": "2011-06-25T14:02:23Z", "bug_id": 51351, "creation_time": "2011-06-25T14:02:23Z", "is_private": false}, {"count": 20, "tags": [], "bug_id": 51351, "attachment_id": null, "id": 147509, "time": "2011-06-26T10:27:08Z", "creator": "yegor@dinom.ru", "creation_time": "2011-06-26T10:27:08Z", "is_private": false, "text": "It still fails on Bug33519.doc, but with a different exception:\n\njava.lang.IllegalArgumentException: The end (1077) must not be before the start (1985)\n\tat org.apache.poi.hwpf.usermodel.Range.sanityCheckStartEnd(Range.java:243)\n\tat org.apache.poi.hwpf.usermodel.Range.<init>(Range.java:176)\n\tat org.apache.poi.hwpf.usermodel.CharacterRun.<init>(CharacterRun.java:97)\n\tat org.apache.poi.hwpf.usermodel.Range.getCharacterRun(Range.java:802)\n\tat org.apache.poi.hwpf.extractor.WordToFoExtractor.processCharacters(WordToFoExtractor.java:243)\n\tat org.apache.poi.hwpf.extractor.WordToFoExtractor.processParagraph(WordToFoExtractor.java:529)\n\tat org.apache.poi.hwpf.extractor.WordToFoExtractor.processSectionParagraphes(WordToFoExtractor.java:608)\n\tat org.apache.poi.hwpf.extractor.WordToFoExtractor.processSection(WordToFoExtractor.java:556)\n\tat org.apache.poi.hwpf.extractor.WordToFoExtractor.processDocument(WordToFoExtractor.java:341)\n\tat org.apache.poi.hwpf.extractor.WordToFoExtractor.process(WordToFoExtractor.java:167)\n\tat org.apache.poi.hwpf.extractor.WordToFoExtractor.main(WordToFoExtractor.java:142)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:597)\n\tat com.intellij.rt.execution.application.AppMain.main(AppMain.java:120)\n\n\nShall I commit this patch or wait for the next one?\n\nYegor\n\n(In reply to comment #19)\n> Created attachment 27205 [details]\n> Workaround for NPE in Bug 33519"}, {"count": 21, "text": "Created attachment 27207\nLatest patch\n\nOkey, here the latest patch. All tests passed.\n\nThe problem arised by Bug 33519 is not solved - there is just a workaround. It seems like CHPX are NOT SORTED, so it is not correct to assume it in Range class, so _charStart, _charEnd shall be removed and all code linked to those fields shall be rewritten.\n\nIt's a big task so i would like to have some kind of confirmation if my assumption about missing CHPX order is correct.\n\nIn addition (in fact, main part of) this patch includes doc-to-html extractor.", "bug_id": 51351, "is_private": false, "id": 147517, "time": "2011-06-27T09:15:22Z", "creator": "vlsergey@gmail.com", "creation_time": "2011-06-27T09:15:22Z", "tags": [], "attachment_id": 27207}, {"count": 22, "tags": [], "bug_id": 51351, "text": "Created attachment 27208\nLatest patch", "id": 147518, "time": "2011-06-27T09:37:54Z", "creator": "vlsergey@gmail.com", "creation_time": "2011-06-27T09:37:54Z", "is_private": false, "attachment_id": 27208}, {"count": 23, "text": "I'm closing this bug because all patches applied. Newly patches can be applied to SVN (have commiter access now). Patches from other users are still welcome (as new issues).", "bug_id": 51351, "is_private": false, "id": 147730, "time": "2011-07-04T19:52:49Z", "creator": "vlsergey@gmail.com", "creation_time": "2011-07-04T19:52:49Z", "tags": [], "attachment_id": null}]