[{"count": 0, "tags": [], "bug_id": 21000, "is_private": false, "id": 39251, "creation_time": "2003-06-22T15:36:43Z", "time": "2003-06-22T15:36:43Z", "creator": "web@bernd-feucht.de", "text": "Though I've set \"HostnameLookups On\" in my httpd.conf configuration file, DNS\nlookups seem not to be performed by the Apache-2.0 server.\nThe \"%h\" field in the access_log file contains the IP of the client, not the\ndesired host name. And the REMOTE_HOST environment variable ist not set for CGI\nscripts, only REMOTE_ADDR.\nAlso limiting access to a domain name (e.g. \"Allow from mydomain.de\") fails\n(this should even work independently of the HostnameLookups setting).\n\nTo reproduce:\n1) Build a default Apache/2.0.46 on a Unix/Linux system (./configure\n--prefix=/some/path ; make ; make install).\n2) In httpd.conf, change \"HostnameLookups Off\" to \"HostnameLookups On\".\n3) Start the httpd server.\n4) Get some document (e.g. /) from this server.\n\nIn access_log, only the client IP will be recorded in the \"%h\"-field of the\n\"common\" log format used by default. There should be the client hostname instead.\n\nIn addition, by setting \"chmod a+x cgi-bin/test-cgi\" and getting\n/cgi-bin/test-cgi from the server, the REMOTE_HOST variable is empty, only the\nREMOTE_ADDR variable contains the correct client IP. It should contain the\nclient hostname.\n\nAlso, by setting \"Order Deny,Allow\", \"Deny from all\", \"Allow from mydomain.de\"\nfor some directory (with mydomain.de replaced by my own client domain), this\ndirectory gets completely inaccessible. Here, Apache should make a reverse DNS\nlookup for the client hostname (independently of the HostnameLookups setting)\nand grant access if it matches mydomain.de.\n\nI made default builts of Apache/2.0.46 on Linux kernel 2.4.18-4GB (SuSE 8.0,\nusing gcc 2.95.3) and Linux kernel 2.4.19-4GB (SuSE 8.1, using gcc 3.2).\nI also tried the worker MPM instead of prefork (--with-mpm=worker).\n\nIn contrast, this problem does not exist for Apache/1.3.27: I've installed a\ndefault Apache/1.3.27 server on the same machine with \"HostnameLookups On\", and\nhere everything works properly.\n\nRegards,\nBernd Feucht", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 21000, "attachment_id": null, "id": 39256, "time": "2003-06-23T02:37:21Z", "creator": "trawick@apache.org", "creation_time": "2003-06-23T02:37:21Z", "is_private": false, "text": "works for me on RedHat 9, and nobody else has mentioned this issue as far as I\nrecall\n\none difference between Apache 1.3's support for this and Apache 2.0's is that\nApache 2.0 uses getnameinfo() for looking up client hostname instead of\ngethostbyaddr()\n\nstuff to try:\n\na) in case you have IPv6 active on your box, switch Apache to IPv4 with\nsomething like this:\n\nListen 0.0.0.0:80\n\ninstead of\n\nListen 80\n\nthis is to see if your getnameinfo() is fooled by v4-mapped address\n\nb) add some tracing around the call to getnameinfo()?\n\nit *sounds* like getnameinfo() on your system is not respecting the NI_NAMEREQD\nthat we pass in\n\nc) disable use of getnameinfo()\n\nneed to do 3 things, I suspect:\n\n0) make distclean\n1) add --disable-ipv6 to configure invocation\n2) after configure completes but before you run make, edit\nsrclib/apr/include/arch/unix/apr_private.h and comment out the line \"#define\nHAVE_GETNAMEINFO 1\" to see if it works when gethostbyaddr() is used\n"}, {"count": 2, "tags": [], "bug_id": 21000, "attachment_id": null, "text": "I tried the following suggestions from Jeff Trawick:\n\n1) I changed \"Listen 80\" to \"Listen 0.0.0.0:80\" in httpd.conf.\n   Then DNS lookups work fine.\n\n2) I built the Apache server with \"./configure --disable-ipv6\"\n   and commented out the \"#define HAVE_GETNAMEINFO 1\" line in\n   srclib/apr/include/arch/unix/apr_private.h before the make.\n   Here I left \"Listen 80\" in httpd.conf.\n   Then also DNS lookups work properly.\n\nSo it seems that something goes wrong with IPv6/v4 mapping in getnameinfo() in\nmy SuSE 8.0/8.1 linux distribution, as suggested by Jeff Trawick.\nThanks a lot for your help!\n\nWhat do you suggest how to proceed? How can I find out what exactly is going\nwrong so that I could give a hint to the SuSE developpers?\n", "id": 39270, "time": "2003-06-23T12:23:08Z", "creator": "web@bernd-feucht.de", "creation_time": "2003-06-23T12:23:08Z", "is_private": false}, {"count": 3, "tags": [], "creator": "trawick@apache.org", "attachment_id": null, "id": 39271, "time": "2003-06-23T12:57:29Z", "bug_id": 21000, "creation_time": "2003-06-23T12:57:29Z", "is_private": false, "text": "There is a test program at http://www.apache.org/~trawick/gni_mapped.c which\nshows this type of problem in a context much simpler than Apache.  (Mac OS X\nalso suffers from a failure with getnameinfo() on v4-mapped addresses,\nincidentally.)\n\nRun gni_mapped on your box and verify that it can look up via IPv4 but fails\nwith IPv6.  That should be a sufficient testcase to provide to the vendor.  On\nRH 9, I get this output:\n\nlook up via IPv4: 0/www.ibm.com\nlook up via IPv6: 0/www.ibm.com\n\nOther things to explore in order to aid the vendor are any special name lookup\nconfigurations you might have (e.g., NIS instead of DNS).\n\nPlease update the PR once you've had a chance to double-check that gni_mapped\nfails on your box.  This is just to get even further confirmation that it is not\na problem with Apache or apr.  Thanks!\n\n"}, {"count": 4, "tags": [], "creator": "web@bernd-feucht.de", "attachment_id": null, "id": 39278, "time": "2003-06-23T13:53:09Z", "bug_id": 21000, "creation_time": "2003-06-23T13:53:09Z", "is_private": false, "text": "I compiled http://www.apache.org/~trawick/gni_mapped.c on my machine and\nexecuted the binary. It yields:\n\nlook up via IPv4: 0/www.ibm.com\nlook up via IPv6: -2/not found\n\nSo actually, IPv6 seems to fail on my machine!\n\n"}, {"count": 5, "tags": [], "bug_id": 21000, "is_private": false, "id": 39279, "creation_time": "2003-06-23T14:02:42Z", "time": "2003-06-23T14:02:42Z", "creator": "trawick@apache.org", "text": "Thanks for the quick feedback.  Hopefully your OS vendor can figure out why the\ntest program doesn't work on your box.\n\nI'm marking this as invalid since there isn't anything to fix in Apache or apr.\nThe work-arounds include, at least, specifying IPv4 address on Listen statement\nor adding --disable-ipv6 to configure invocation.  (Since getnameinfo() works on\nIPv4 address, there is no need to edit apr_private.h and pretend that the system\ndoesn't have getnameinfo().)\n\nGood luck!\n", "attachment_id": null}, {"count": 6, "tags": [], "creator": "web@bernd-feucht.de", "attachment_id": null, "id": 39309, "time": "2003-06-24T00:57:15Z", "bug_id": 21000, "creation_time": "2003-06-24T00:57:15Z", "is_private": false, "text": "As reported above, the test program gni_mapped from Jeff Trawick fails to\nperform a DNS lookup for an IPv6 address with the SuSE 8.0 and 8.1 linux\ndistribution, using glibc 2.2.5 (patches 161 and 177).\n\nOn another machine, where SuSE 8.2 is installed, using glibc 2.3.2, gni_mapped\nsuccessfully reports the host domain via IPv4 and IPv6.\n\nSo the problem seems to be fixed in the latest SuSE release.\n\nSorry for the inconvenience caused by reporting an \"invalid\" Apache bug.\nBernd Feucht\n\n"}, {"count": 7, "tags": [], "creator": "trawick@apache.org", "attachment_id": null, "id": 39310, "time": "2003-06-24T01:09:58Z", "bug_id": 21000, "creation_time": "2003-06-24T01:09:58Z", "is_private": false, "text": ">Sorry for the inconvenience caused by reporting an \"invalid\" Apache bug.\n\nnot to worry; it is inevitable that many issues like this will first appear to\nbe an Apache problem\n"}]