[{"count": 0, "tags": [], "bug_id": 53147, "attachment_id": 28683, "is_private": false, "id": 158421, "time": "2012-04-25T13:45:56Z", "creator": "recyclebin5385@yahoo.co.jp", "creation_time": "2012-04-25T13:45:56Z", "text": "Created attachment 28683\ntest code and patch\n\nI changed the order of sheets in a workbook by invoking method setSheetOrder(String, int) of class org.apache.poi.hssf.usermodel.HSSFWorkbook and removed one sheet by invoking method removeSheetAt(int).\nThen I tried to save the workbook by invoking method write(OutputStream).\nBut a strange Exception was thrown and I could not save the workbook.\nBelow is the stack trace.\n\njava.lang.IllegalArgumentException: calculated end index (2231) is out of allowable range (2204..2228)\n\tat org.apache.poi.util.LittleEndianByteArrayOutputStream.<init>(LittleEndianByteArrayOutputStream.java:41)\n\tat org.apache.poi.hssf.record.StandardRecord.serialize(StandardRecord.java:45)\n\tat org.apache.poi.hssf.usermodel.HSSFWorkbook$SheetRecordCollector.serialize(HSSFWorkbook.java:1259)\n\tat org.apache.poi.hssf.usermodel.HSSFWorkbook.getBytes(HSSFWorkbook.java:1305)\n\tat org.apache.poi.hssf.usermodel.HSSFWorkbook.write(HSSFWorkbook.java:1205)\n\tat Test1.main(Test1.java:13)\n\n\nI looked into the source code and found that method org.apache.poi.hssf.model.InternalWorkbook#removeSheet(int) destroys the consistency of internal data.\n\nHere is part of the source code in that method.\n\n        if (boundsheets.size() > sheetIndex) {\n            records.remove(records.getBspos() - (boundsheets.size() - 1) + sheetIndex);\n            boundsheets.remove(sheetIndex);\n            fixTabIdRecord();\n        }\n\nThe code is intended to remove the same instance from both of fields \"boundsheets\" and \"records\".\nThis works only if the orders of elements are the same in both fields, but once method setSheetOrder(String, int) is called, only \"boundsheets\" is reordered and the precondition is not valid anymore.\n\nThis causes different result in calculating the size of the serialized data between method InternalWorkbook#serialize(int, byte[]) and InternalWorkbook#getSize() (returns wrong result).\nWhen getSize() returns a value less than the true serialized data size, POI fails to allocate enough size of buffer and the exception shown above occurs.\n\nI will attach a zip file including a test code and a patch to fix the bug."}, {"count": 1, "tags": [], "creator": "recyclebin5385@yahoo.co.jp", "attachment_id": null, "text": "\n\n*** This bug has been marked as a duplicate of bug 50083 ***", "id": 158447, "time": "2012-04-26T13:20:48Z", "bug_id": 53147, "creation_time": "2012-04-26T13:20:48Z", "is_private": false}]