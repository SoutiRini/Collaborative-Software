[{"count": 0, "tags": [], "bug_id": 51171, "attachment_id": 26970, "text": "Created attachment 26970\nPatch against SVN trunk\n\nOpening ~5M XLS-Files takes about half a second and high CPU load.\nBy a quick profiling I discovered a 55-million-times loop for getting the user style name for my XLS-files.\n\nThis patch against trunk fixes the number of loops significantly, by fixing the 'iterative search' causing the high loop count.\n\nI'll attach the profiling details in a moment.\nAs a summary, for my test cases I measured an average speedup =  old_time / new_time = ~ 1.3 .\n\nWould be great if the patch could be included in the next 3.8 release.\n\nCheers,\nMarcel", "id": 146190, "time": "2011-05-09T06:02:00Z", "creator": "marcel.may.de@gmail.com", "creation_time": "2011-05-09T06:02:00Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 51171, "attachment_id": 26971, "is_private": false, "id": 146191, "time": "2011-05-09T06:06:44Z", "creator": "marcel.may.de@gmail.com", "creation_time": "2011-05-09T06:06:44Z", "text": "Created attachment 26971\nCPU Hotspots, before to the patch. Notice the 55m inv count on WorkbookRecordList"}, {"count": 2, "tags": [], "bug_id": 51171, "attachment_id": 26972, "text": "Created attachment 26972\nIncluding the patch, fixing the previous top hotspots (these were all related, up to the SharedValueManger thing).", "id": 146192, "time": "2011-05-09T06:09:29Z", "creator": "marcel.may.de@gmail.com", "creation_time": "2011-05-09T06:09:29Z", "is_private": false}, {"count": 3, "tags": [], "creator": "marcel.may.de@gmail.com", "text": "The profiling screenshots attached show opening a single XLS file once:\n\nnew HSSFWorkbook(new FileInputStream(\"....\"));\n\nYou can see that the top hotspots (first 7 are related) got fixed when you compare before/after the patch. Looping 55 million times does not occur anymore.\n\nAnother micro bench mark including warmup phase followed by timed loops shows similiar results (speedup of ~1.3, or only ~75% of original time on average).", "id": 146193, "time": "2011-05-09T06:18:32Z", "bug_id": 51171, "creation_time": "2011-05-09T06:18:32Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 51171, "attachment_id": null, "is_private": false, "id": 146331, "time": "2011-05-15T18:54:35Z", "creator": "yegor@dinom.ru", "creation_time": "2011-05-15T18:54:35Z", "text": "Fixed in r1103502, but in a diffrent way.\n\nThe real problem was that HSSFCell.setCellStyle was called for every cell when constructing a workbook. This method is expensive and designed for assigning styles to individual cell and applying it to workbook scope causes performance issues. It appears that we don't need to call setCellStyle in the HSSFCell constructior at all, this line remained from all times (POI-3.5 or earlier) and does not make any sense in POI-3.8. So, I removed it.  \n\nThis fix should boost performance of opening .xls files even greater than ~1.3. \n\nYegor"}, {"count": 5, "tags": [], "creator": "marcel.may.de@gmail.com", "text": "(In reply to comment #4)\n> Fixed in r1103502, but in a diffrent way.\n> \n> The real problem was that HSSFCell.setCellStyle was called for every cell when\n> constructing a workbook. This method is expensive and designed for assigning\n> styles to individual cell and applying it to workbook scope causes performance\n> issues. It appears that we don't need to call setCellStyle in the HSSFCell\n> constructior at all, this line remained from all times (POI-3.5 or earlier) and\n> does not make any sense in POI-3.8. So, I removed it.  \n> \n> This fix should boost performance of opening .xls files even greater than ~1.3. \n> \n> Yegor\n\nThanks, Yegor - your fix was even better :-)\n\nI profiled again against latest version 1127506 and noticed another hotspot in the SharedValueManager class. Here's an 8 million times iteration doing 'findFormularGroup'.", "id": 146629, "time": "2011-05-25T14:22:29Z", "bug_id": 51171, "creation_time": "2011-05-25T14:22:29Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 51171, "attachment_id": 27064, "is_private": false, "id": 146630, "time": "2011-05-25T14:26:48Z", "creator": "marcel.may.de@gmail.com", "creation_time": "2011-05-25T14:26:48Z", "text": "Created attachment 27064\nProfiled hotspots (opening of XLS file using current trunk v1127506)"}, {"count": 7, "tags": [], "creator": "marcel.may.de@gmail.com", "attachment_id": 27065, "id": 146631, "time": "2011-05-25T14:28:48Z", "bug_id": 51171, "creation_time": "2011-05-25T14:28:48Z", "is_private": false, "text": "Created attachment 27065\nProfiled cpu calltree (opening of XLS file using current trunk v1127506)"}, {"count": 8, "tags": [], "bug_id": 51171, "is_private": false, "text": "Created attachment 27067\nImproves SharedValueManager.findFormulaGroup", "id": 146644, "time": "2011-05-26T06:42:34Z", "creator": "marcel.may.de@gmail.com", "creation_time": "2011-05-26T06:42:34Z", "attachment_id": 27067}, {"count": 9, "tags": [], "creator": "marcel.may.de@gmail.com", "text": "Created attachment 27068\nShows profiled hotspots after second patch for SharedValueManager.findFormulaGroup", "id": 146645, "time": "2011-05-26T06:47:56Z", "bug_id": 51171, "creation_time": "2011-05-26T06:47:56Z", "is_private": false, "attachment_id": 27068}, {"count": 10, "tags": [], "bug_id": 51171, "attachment_id": 27069, "text": "Created attachment 27069\nShows profiled calltree after second patch for SharedValueManager.findFormulaGroup", "id": 146646, "time": "2011-05-26T06:49:41Z", "creator": "marcel.may.de@gmail.com", "creation_time": "2011-05-26T06:49:41Z", "is_private": false}]