[{"count": 0, "tags": [], "creator": "peter.mezey@pss.boeing.com", "text": "Problem appears when a Verity search engine spider is launched against a \ndocument bundle consisting of approximately 5,000 jsp pages (each page has many \nlinks to the other pages in the bundle).  The use of actual jsp code is light.  \nEach page only has a <jsp:include ... tag in it to get a consistent look and \nfeel.  As the vspider program slams requests at Apache/Tomcat, you can watch the \nmemory usage slowly rise using \"top\".  Once it gets to about 170MB in SIZE, the \nsystem goes into a 100% iowait state and Tomcat no longer responds to any \nrequests.  I have slowed the vspider down to use three request threads and to \npause 2 seconds between each request.  At that rate, it can take from 30 - 60 \nminutes or longer before this happens (that works out to roughly 2,700 - 5,400 \nrequests to Tomcat).  Sometimes, I will see a stack trace, but not always:\n\njava.net.SocketException: Connection reset by peer: Connection reset by peer\n        at java.net.SocketInputStream.socketRead(Native Method)\n        at java.net.SocketInputStream.socketRead(Compiled Code)\n        at java.net.SocketInputStream.read(Compiled Code)\n        at \norg.apache.tomcat.service.connector.TcpConnector.receiveFully(Compiled Code)\n        at org.apache.tomcat.service.connector.TcpConnector.receive(Compiled \nCode)\n        at \norg.apache.tomcat.service.connector.Ajp13ConnectionHandler.processConnection(Com\npiled Code)\n        at org.apache.tomcat.service.TcpWorkerThread.runIt(Compiled Code)\n        at org.apache.tomcat.util.ThreadPool$ControlRunnable.run(Compiled Code)\n        at java.lang.Thread.run(Compiled Code)\n\nThe platform we have is the following:\n\nuname -a reports:\nSunOS urnge 5.6 Generic_105181-20 sun4u sparc SUNW,Ultra-2\n\nJDK version is 1.2.2_07 (I have the same problem with 1.3.0)\nApache version is 1.3.12\nTomcat version is 3.2.1\nI am using ajp13 (I have the same problem with ajp12)\nThe ajp13 setup in server.xml looks like this:\n\n<Connector className=\"org.apache.tomcat.service.PoolTcpConnector\">\n            <Parameter name=\"handler\"\n       value=\"org.apache.tomcat.service.connector.Ajp13ConnectionHandler\"/>\n            <Parameter name=\"port\" value=\"8009\"/>\n            <Parameter name=\"max_threads\" value=\"200\"/>\n            <Parameter name=\"max_spare_threads\" value=\"50\"/>\n            <Parameter name=\"min_spare_threads\" value=\"20\"/>\n        </Connector>\n\nIf there is any other information I can provide do not hesitate to ask.", "id": 872, "time": "2001-02-26T17:35:24Z", "bug_id": 725, "creation_time": "2001-02-26T17:35:24Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "text": "*** Bug 724 has been marked as a duplicate of this bug. ***", "attachment_id": null, "bug_id": 725, "id": 873, "time": "2001-02-26T17:38:07Z", "creator": "peter.mezey@pss.boeing.com", "creation_time": "2001-02-26T17:38:07Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 725, "attachment_id": null, "id": 1462, "time": "2001-03-20T12:49:01Z", "creator": "marc.saegesser@apropos.com", "creation_time": "2001-03-20T12:49:01Z", "is_private": false, "text": "This may be related to bug 1006."}, {"count": 3, "tags": [], "creator": "marc.saegesser@apropos.com", "attachment_id": null, "id": 1534, "time": "2001-03-21T13:00:37Z", "bug_id": 725, "creation_time": "2001-03-21T13:00:37Z", "is_private": false, "text": "This may be solved by the fix for bug 1006 which will appear in 3.2.2b2.  I'll \nleave this bug report open incase it isn't fixed so that it be investigated \nfurther in a later release."}, {"count": 4, "tags": [], "creator": "cmanolache@yahoo.com", "attachment_id": null, "id": 2031, "time": "2001-04-22T18:07:25Z", "bug_id": 725, "creation_time": "2001-04-22T18:07:25Z", "is_private": false, "text": "The most important question is if the JSP pages are using sessions ( the default\nis true ). That results in memory growing ( and there's nothing to do about\nit - except maybe limitting the number of allowed sessions ). \nIt would be very usefull to try the same thing using \"ab\" from apache \n( apache bench ) with only one of the JSPs. \n\n "}, {"count": 5, "tags": [], "bug_id": 725, "attachment_id": null, "id": 2246, "time": "2001-05-03T11:05:09Z", "creator": "peter.mezey@pss.boeing.com", "creation_time": "2001-05-03T11:05:09Z", "is_private": false, "text": "Thanks Costin for your tip on sessions.  I regenerated the whole document tree \nusing the <%@ page session=\"false\" %> directive for each and re-ran the verity \nspider program.  I am also using Tomcat 3.2.2b2 now.  It took much longer to get \nstuck, but it did get stuck once again.  At first I thought the 3.2.2b2 had \nsolved the problem because I was able to run through a whole document tree.  \nHowever, repeated efforts to duplicate the success show that 3.2.2b2 does seem \nto last longer, but still eventually winds up with a full 100% iowait state \ncondition - given a large enough document tree to index.\n\nOne other thing I've noticed is that the \"SIZE\" of tomcat as reported by top \napproached the maximum physical amount of memory on the box (256MB on the box, \napprox 227MB for tomcat).  I did not see any memory exceptions reported by \ntomcat, but is it possible that the GC is constantly going off trying to get \nmore memory, it's unsuccessful, and instead of throwing an exception, it just \nruns again?  I did not make note of the swap space left...I'll have to re-do \nthis and check that as well.  One other piece of information is that the \nmod_jk.log file is full of errors like the following:\n\n[jk_ajp13_worker.c (619)]: Error reading request\n[jk_ajp13_worker.c (619)]: Error reading request\n[jk_ajp13_worker.c (203)]: connection_tcp_get_message: Error - jk_tcp_socket_rec\nvfull failed\n[jk_ajp13_worker.c (619)]: Error reading request\n"}, {"count": 6, "tags": [], "text": "I'll close this bug. It should have been fixed in jk1.2 and jk2 - please verify\nand if it's still a problem reopen the bug.", "attachment_id": null, "id": 23769, "creator": "cmanolache@yahoo.com", "time": "2002-10-02T18:45:40Z", "bug_id": 725, "creation_time": "2002-10-02T18:45:40Z", "is_private": false}]