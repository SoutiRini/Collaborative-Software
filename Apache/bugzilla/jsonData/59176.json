[{"count": 0, "tags": [], "creator": "Russel.VanTuyl@gmail.com", "attachment_id": 33666, "is_private": false, "id": 189437, "time": "2016-03-13T14:04:53Z", "bug_id": 59176, "creation_time": "2016-03-13T14:04:53Z", "text": "Created attachment 33666\nApache Error Log\n\nI'm using nghttpx version x as proxy to connect to an Apache 2.4.18 instance built from source. The Apache 2.4.18 instance reports the below error when it receives connections over HTTP/2 from the nghttpx proxy.\n\n[Sun Mar 13 08:37:41.537125 2016] [http2:debug] [pid 24763:tid 139792823330560] h2_stream.c(206): [client 192.168.56.120:43987] h2_stream(0-1): reset, error=2\n[Sun Mar 13 08:37:41.537263 2016] [http2:debug] [pid 24763:tid 139792823330560] h2_stream.c(321): [client 192.168.56.120:43987] h2_stream(0-1): RST=2 (internal err) GET http://(null)/\n[Sun Mar 13 08:37:41.537415 2016] [http2:debug] [pid 24763:tid 139792823330560] h2_session.c(456): (70013)Missing parameter for the specified command line option: [client 192.168.56.120:43987] AH02923: h2_session: stream(0-1): error handling frame\n\n\nThe Apache 2.4.18 instance is able to handle HTTP/2 connections when accessed directly, without the use of nghttpx. I also built Apache 2.4.17 from source using the same static libraries and configure options. Apache 2.4.17 handles HTTP/2 proxy connections from nghttpx without error. Both instances of Apache 2.4.18 and 2.4.17 are configured the same. The complete debug output from error_log for the failed HTTP/2 connection is attached in 'error_log'. Below are the requests as logged by nghttpx\n\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_connection_handler.cc:332 [LISTEN:0x7ffd0f638190] Accepted connection. fd=9\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_client_handler.cc:338 [CLIENT_HANDLER:0x7f4382cea000] This is HTTP/1.1 connection, but may be upgraded to HTTP/2 later.\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_https_upstream.cc:69 [UPSTREAM:0x7f4382c720b0] HTTP request started\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_https_upstream.cc:248 [UPSTREAM:0x7f4382c720b0] HTTP request headers completed\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_https_upstream.cc:270 [UPSTREAM:0x7f4382c720b0] HTTP request headers\nGET / HTTP/1.1\nhost: 127.0.0.1:3000\npragma: no-cache\ncache-control: no-cache\naccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\nupgrade-insecure-requests: 1\nuser-agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/48.0.2564.109 Safari/537.36\naccept-encoding: gzip, deflate, sdch\naccept-language: en-US,en;q=0.8\nx-forwarded-for: 192.168.56.115\nx-forwarded-host: 192.168.56.120\nx-forwarded-server: www.example.com\nconnection: Keep-Alive\n\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_client_handler.cc:702 [CLIENT_HANDLER:0x7f4382cea000] Downstream address group_idx: 0\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_client_handler.cc:711 [CLIENT_HANDLER:0x7f4382cea000] Downstream connection pool is empty. Create new one\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_client_handler.cc:718 [CLIENT_HANDLER:0x7f4382cea000] http2_freelist is empty; create new Http2Session\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_http2_downstream_connection.cc:95 [DCONN:0x7f4382c633c0] Attaching to DOWNSTREAM:0x7f4382c0f800\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_http2_session.cc:1578 Start connecting to backend server\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_http2_session.cc:322 [DHTTP2:0x7f4382c2fc00] Using downstream address idx=0 out of 1\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_http2_session.cc:390 [DHTTP2:0x7f4382c2fc00] Connecting to downstream server\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_https_upstream.cc:395 [UPSTREAM:0x7f4382c720b0] HTTP request completed\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_http2_session.cc:1740 [DHTTP2:0x7f4382c2fc00] Connection established\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_connection.cc:418 tls: handshake is still in progress\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_connection.cc:418 tls: handshake is still in progress\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_connection.cc:418 tls: handshake is still in progress\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_connection.cc:469 SSL/TLS handshake completed\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_http2_session.cc:1841 [DHTTP2:0x7f4382c2fc00] SSL/TLS handshake completed\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_ssl.cc:1375 Update cache entry for SSL_SESSION=0x7f4382ca3480, addr=192.168.56.111:443, timestamp=1457675864.293091\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_http2_session.cc:1426 [DHTTP2:0x7f4382c2fc00] Negotiated next protocol: h2\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_http2_downstream_connection.cc:438 [DCONN:0x7f4382c633c0] HTTP request headers\n:method: GET\n:scheme: http\n:path: /\nhost: 192.168.56.111\npragma: no-cache\ncache-control: no-cache\naccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\nupgrade-insecure-requests: 1\nuser-agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/48.0.2564.109 Safari/537.36\naccept-encoding: gzip, deflate, sdch\naccept-language: en-US,en;q=0.8\nx-forwarded-host: 192.168.56.120\nx-forwarded-server: www.example.com\nx-forwarded-for: 192.168.56.115\nx-forwarded-proto: http\nvia: 1.1 nghttpx\n\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_http2_session.cc:734 [DHTTP2:0x7f4382c2fc00] Stream stream_id=1 is being closed with error code 2\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_client_handler.cc:453 [CLIENT_HANDLER:0x7f4382cea000] Deleting\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_client_handler.cc:476 [CLIENT_HANDLER:0x7f4382cea000] Deleted\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_downstream.cc:157 [DOWNSTREAM:0x7f4382c0f800] Deleting\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_http2_downstream_connection.cc:56 [DCONN:0x7f4382c633c0] Deleting\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_http2_session.cc:639 [DHTTP2:0x7f4382c2fc00] Remove downstream\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_http2_downstream_connection.cc:89 [DCONN:0x7f4382c633c0] Deleted\n10/Mar/2016:23:57:44 -0600 PID17624 [INFO] shrpx_downstream.cc:183 [DOWNSTREAM:0x7f4382c0f800] Deleted"}, {"count": 1, "tags": [], "creator": "Russel.VanTuyl@gmail.com", "attachment_id": null, "text": "Forgot to include nghttpx version: nghttpx nghttp2/1.9.0-DEV", "id": 189438, "time": "2016-03-13T14:10:14Z", "bug_id": 59176, "creation_time": "2016-03-13T14:10:14Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 59176, "attachment_id": null, "is_private": false, "id": 189458, "time": "2016-03-14T12:13:21Z", "creator": "stefan@eissing.org", "creation_time": "2016-03-14T12:13:21Z", "text": "Fixed in r1734910, backported to 2.4.x in r1734917."}]