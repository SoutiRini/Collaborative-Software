[{"count": 0, "tags": [], "bug_id": 47501, "attachment_id": 23948, "text": "Created attachment 23948\nSuggested fix to the problem.\n\napr_ldap_set_option() incorrectly handles setting LDAP_OPT_REFHOPLIMIT with OpenLDAP, see the patch attached. The reason is that OpenLDAP does define the LDAP_OPT_REFHOPLIMIT (under comment /* private and experimental options */\n/* OpenLDAP specific options */) but apparently does support setting it.\n(Tried with latest v2.4.16 of OpenLDAP).\n\nThis appears to be broken since revision 640388, as a result LDAP authentication in trunk HTTPD does not work with OpenLDAP, the following error is logged:\n[Thu Jul 09 11:05:18 2009] [debug] util_ldap.c(381): Setting referral hop limit to 5.\n[Thu Jul 09 11:05:18 2009] [debug] util_ldap.c(389): Unable to set LDAP_OPT_REFHOPLIMIT option to 5: -1.\n[Thu Jul 09 11:05:18 2009] [warn] [client 127.0.0.1] [8816] auth_ldap authenticate: user user1 authentication failed; URI /private [Unable to set LDAP_OPT_REFHOPLIMIT.][Can't contact LDAP server], referer: http://localhost:8000/", "id": 128662, "time": "2009-07-09T04:19:17Z", "creator": "alexey.v.varlamov@gmail.com", "creation_time": "2009-07-09T04:19:17Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 47501, "attachment_id": null, "is_private": false, "id": 130913, "time": "2009-10-06T10:52:27Z", "creator": "sf@sfritsch.de", "creation_time": "2009-10-06T10:52:27Z", "text": "I can confirm that this is broken with openldap 2.4.17 and that Alexey's patch fixes the problem."}, {"count": 2, "attachment_id": null, "bug_id": 47501, "is_private": false, "id": 130916, "time": "2009-10-06T12:06:42Z", "creator": "rpluem@apache.org", "creation_time": "2009-10-06T12:06:42Z", "tags": [], "text": "What about older OpenLDAP versions (e.g. 2.3.x)? Do they still run fine with the patch?"}, {"count": 3, "tags": [], "bug_id": 47501, "text": "(In reply to comment #2)\n> What about older OpenLDAP versions (e.g. 2.3.x)? Do they still run fine with\n> the patch?\n\nOk. So I guess I confused myself. I guess the correct statement from Alexey should be:\n\nThe reason is that OpenLDAP does define the\nLDAP_OPT_REFHOPLIMIT (under comment /* private and experimental options */\n/* OpenLDAP specific options */) but apparently does *NOT* support setting it.", "id": 130917, "time": "2009-10-06T12:09:36Z", "creator": "rpluem@apache.org", "creation_time": "2009-10-06T12:09:36Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 47501, "attachment_id": null, "is_private": false, "id": 130930, "time": "2009-10-07T02:41:55Z", "creator": "alexey.v.varlamov@gmail.com", "creation_time": "2009-10-07T02:41:55Z", "text": "Right, that's my typo - OpenLDAP does *NOT* support setting the option.\nAlso note, that ldap support is moving to main APR - so the initial patch may be not complete for the latest trunk, both APR and APR-utils should be fixed."}, {"count": 5, "tags": [], "creator": "rpluem@apache.org", "text": "Now the patch makes perfect sense :-).", "id": 130952, "time": "2009-10-07T12:02:47Z", "bug_id": 47501, "creation_time": "2009-10-07T12:02:47Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "creator": "covener@gmail.com", "text": "(In reply to comment #5)\n> Now the patch makes perfect sense :-).\n\nWhile it's already the behavior for Novell, I really don't like the behavior of this block of code.  The comment talks about reasonable defaults, but this method should only be called if you're looking to change them anyway and you've passed in an explicit number of hops.\n\nMeanwhile, LDAP_OPT_REHOPLIMIT isn't even ldap_get_option()'able in openldap.  I am fixing HTTPD to not make this APR call if the user hasn't explicitly asked for a change from the SDK defaults.  \n\nInterested in comments from others, but I do not think it's wise to no-op this call if we can't honor the specific value passed in.", "id": 131516, "time": "2009-10-31T07:08:51Z", "bug_id": 47501, "creation_time": "2009-10-31T07:08:51Z", "is_private": false, "attachment_id": null}, {"count": 7, "attachment_id": null, "bug_id": 47501, "text": "Well, the only (speculative) concern I have is that the suggested change in APR behavior can affect other programs (beside httpd) depending on APR. \nOTOH major release change may be enough warrant.", "id": 131807, "time": "2009-11-09T03:05:45Z", "creator": "alexey.v.varlamov@gmail.com", "creation_time": "2009-11-09T03:05:45Z", "tags": [], "is_private": false}]