[{"count": 0, "tags": [], "bug_id": 29867, "attachment_id": null, "id": 60059, "time": "2004-06-30T10:40:32Z", "creator": "dragzhb@yahoo.com.cn", "creation_time": "2004-06-30T10:40:32Z", "is_private": false, "text": "When I put jdbc connecting  in  DefaultContext, and When I put my WAR file in\nwebapps dir ,tomcat will auto deploy it, but tomcat can't release connecting\npool before it undeploy the old WAR. the connecting size will increase more and\nmore ,don't reduce. \nYou can test it, use netstat |wc -l to see how many connecting to database. then\nfor a long time , system file description will be used over, then system has no\nresource to use.\n\nHow can I release the connecting pool by manual in my program?\n\nattachment is the server.xml that I use.\n\n<Server port=\"8005\" shutdown=\"SHUTDOWN\">\n  <GlobalNamingResources>\n    <!-- Used by Manager webapp -->\n    <Resource name=\"UserDatabase\" auth=\"Container\"\n              type=\"org.apache.catalina.UserDatabase\"\n      description=\"User database that can be updated and saved\">\n    </Resource>\n    <ResourceParams name=\"UserDatabase\">\n      <parameter>\n        <name>factory</name>\n        <value>org.apache.catalina.users.MemoryUserDatabaseFactory</value>\n      </parameter>\n      <parameter>\n        <name>pathname</name>\n        <value>conf/tomcat-users.xml</value>\n      </parameter>\n    </ResourceParams>\n  </GlobalNamingResources>\n\n  <Service name=\"Catalina\">\n    <Connector port=\"80\" />\n\n    <!-- This is here for compatibility only, not required -->\n    <Connector port=\"8009\" protocol=\"AJP/1.3\" />\n\n    <Engine name=\"Catalina\" defaultHost=\"localhost\">\n      <Logger className=\"org.apache.catalina.logger.FileLogger\" />\n\n      <Realm className=\"org.apache.catalina.realm.UserDatabaseRealm\"\n             resourceName=\"UserDatabase\" />\n\n        <Realm  className=\"org.apache.catalina.realm.JDBCRealm\" debug=\"0\"\n             driverName=\"oracle.jdbc.driver.OracleDriver\"\n          connectionURL=\"jdbc:oracle:thin:@localhost:1521:nms\"\n         connectionName=\"test\" connectionPassword=\"test\"\n              userTable=\"view_users\" userNameCol=\"username\" userCredCol=\"password\"\n          userRoleTable=\"tb_user_roles\" roleNameCol=\"rolename\" />\n\n        <DefaultContext>\n\n        <Resource name=\"jdbc/AdminDB\" auth=\"Container\" type=\"javax.sql.DataSource\"/>\n\n        <ResourceParams name=\"jdbc/AdminDB\">\n<parameter>\n                <name>factory</name>\n                <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>\n            </parameter>\n            <parameter>\n            <name>driverClassName</name>\n                <value>oracle.jdbc.driver.OracleDriver</value>\n            </parameter>\n            <parameter>\n                <name>url</name>\n                <value>jdbc:oracle:thin:@localhost:1521:nms</value>\n            </parameter>\n            <parameter>\n                <name>username</name>\n                <value>test</value>\n            </parameter>\n            <parameter>\n                <name>password</name>\n                <value>test</value>\n            </parameter>\n            <parameter>\n                <name>maxActive</name>\n                <value>20</value>\n            </parameter>\n            <parameter>\n                <name>maxIdle</name>\n                <value>10</value>\n            </parameter>\n            <parameter>\n                <name>maxWait</name>\n                <value>-1</value>\n            </parameter>\n            <parameter>\n                    <name>removeAbandoned</name>\n                    <value>true</value>\n            </parameter>\n\n            <parameter>\n              <name>removeAbandonedTimeout</name>\n              <value>200</value>\n             </parameter>\n\n            <parameter>\n              <name>logAbandoned</name>\n              <value>true</value>\n            </parameter>\n\n        </ResourceParams>\n\n        </DefaultContext>\n\n      <Host name=\"localhost\" appBase=\"/home/smsc/proxy_nms/webapps\"\nunpackWARs=\"true\" >\n\n        <Context path=\"\" docBase=\"/opt/tomcat/webapps/ROOT\"\n            reloadable=\"true\" crossContext=\"true\"\n            debug=\"0\" privileged=\"false\" >\n\n            <Logger className=\"org.apache.catalina.logger.FileLogger\"\n                    prefix=\"localhost_root_log.\" suffix=\".txt\"\n                timestamp=\"true\"/>\n         </Context>\n\n        <Context path=\"/proxy_nms\" docBase=\"proxy_nms\"\n            reloadable=\"true\" crossContext=\"true\"\n            debug=\"0\" privileged=\"false\" >\n\n\n            <Logger className=\"org.apache.catalina.logger.FileLogger\"\n                    prefix=\"localhost_proxy_nms_log.\" suffix=\".txt\"\n                timestamp=\"true\"/>\n         </Context>\n\n      </Host>\n    </Engine>\n  </Service>\n</Server>"}, {"count": 1, "tags": [], "bug_id": 29867, "attachment_id": null, "is_private": false, "id": 61842, "time": "2004-08-11T16:45:41Z", "creator": "yoavs@computer.org", "creation_time": "2004-08-11T16:45:41Z", "text": "This is what we get for adding convenience features like DefaultContext.  I \nrecommend you stick to the Servlet Spec and declare the connection pool in your \ncontext element only, not in the DefaultContext.  The latter also has the \nundesirable side effect of creating one pool per context, so the total number \nof connections can be higher than you wanted."}, {"count": 2, "tags": [], "text": "This won't be fixed in Tomcat 5.0.x.  You should put the data source in the \n<Context> proper, not in <DefaultContext>.\n\nTo manually close the DataSource and/or its connections, do the normal JNDI \nlookup for it, e.g.\nInitialContext ictx = new InitialContext();\nDataSource ds = (DataSource) ictx.lookup(\"java:comp/env/jdbc/AdminDB\");\n\nThen cast to the DBCP-specific class, org.apache.commons.dbcp.BasicDataSource:\nBasicDataSource bds = (BasicDataSource) ds;\n\nAnd call bds.close().\n\nIf you have trouble with the above or in general, please use the tomcat-user \nmailing list to ask for help and discuss solutions.  Only post proven bugs with \ntest cases to Bugzilla please.  Thank you ;)", "attachment_id": null, "id": 62811, "creator": "yoavs@computer.org", "time": "2004-08-30T20:41:42Z", "bug_id": 29867, "creation_time": "2004-08-30T20:41:42Z", "is_private": false}]