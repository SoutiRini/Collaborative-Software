[{"count": 0, "tags": [], "bug_id": 30398, "attachment_id": null, "text": "Hi,\n\nI discovered a problem with the cooperation between mod_jk and Apache 2.0's\nmod_cache.\nI discovered the problem while I tried to cache Tomcat responses delivered by\nmod_jk with mod_cache. At the first look everything works fine and the content\nis served and cached, but after the content is cached the content type of the\ncache delivered content is always set to text/plain regardless of the content\ntype of the original Tomcat delivered content.\n\nMy environment:\n\nApache: 2.0.50\nmod_jk: 1.2.5\n\nOS: Linux\nTomcat: 5.0.18\n\nExcerpt from my Apache configuration:\n\n<VirtualHost 192.168.2.4:80>\nServerName www.something.de\nServerAdmin admin@www.something.de\nDocumentRoot \"/var/httpd/test/www.something.de/docs\"\nErrorLog \"|/opt/apache-2.0.50/bin/rotatelogs /var/httpd/test/www.something.de/lo\ngs/error_log 86400\"\nCustomLog \"|/opt/apache-2.0.50/bin/rotatelogs /var/httpd/test/www.something.de/l\nogs/access_log 86400\" combined\n\n\n<Directory /var/httpd/test/www.something.de/docs>\n   Options None\n   AllowOverride None\n</Directory>\n\nJkMount /* worker_ajp13\n\nCacheRoot /var/httpd/test/cache\nCacheSize 256\nCacheEnable disk /test\nCacheDirLevels 5\nCacheDirLength 3\n\nCacheMaxExpire 60\nCacheIgnoreNoLastMod On\nCacheIgnoreCacheControl On\nCacheDefaultExpire 60\n\n</VirtualHost>\n\nI believe that I found the reason for this, but I am not quite sure if it\nis a bug of mod_disk_cache or mod_jk. Maybe a separate discussion for the\ncore developers :-).\n\nmod_disk_cache stores the content type of a cached response together with the\nother headers of this response in a separate file (write_headers).\nFor storing the Content-Type it reads the information only from the headers_out\ntable and not from the content_type field in the request_rec structure.\n\nOn the other hand mod_jk's ws_start_response only sets the content type via\nap_set_content_type (thus only setting the content_type field) and does not\nadd the header Content-Type to the headers_out table.\n\nTo cut a long story short, the following patch to mod_jk.c (Apache 2.0 version)\nfixes this problem:\n\n--- jakarta-tomcat-connectors-jk-1.2.5-src/jk/native/apache-2.0/mod_jk.c.orig\n2003-09-06 17:37:20.000000000 +0200\n+++ jakarta-tomcat-connectors-jk-1.2.5-src/jk/native/apache-2.0/mod_jk.c\n2004-07-29 12:34:40.000000000 +0200\n@@ -254,6 +254,8 @@\n             /* and it make jk useable with deflate using */\n             /* AddOutputFilterByType DEFLATE text/html */\n             ap_set_content_type(r, tmp);\n+            apr_table_set(r->headers_out,\n+                          header_names[h], tmp);\n         } else if(!strcasecmp(header_names[h], \"Location\")) {\n #ifdef AS400\n             /* Fix escapes in Location Header URL*/\n\nThe diff is against 1.2.5 but it is also applicable against 1.2.6.\n\nAnother approach to solve this problem would be to adjust write_headers\nin mod_disk_cache.c of Apache 2.0 accordingly, but as said above the discussion\nof the correct approach is another story, where I cannot distribute anything.\n\nRegards\n\nR\u00fcdiger Pl\u00fcm", "id": 61343, "time": "2004-07-29T22:16:05Z", "creator": "ruediger.pluem@vodafone.com", "creation_time": "2004-07-29T22:16:05Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 30398, "attachment_id": 12267, "text": "Created attachment 12267\nmod_jk.c patch", "id": 61344, "time": "2004-07-29T22:17:23Z", "creator": "ruediger.pluem@vodafone.com", "creation_time": "2004-07-29T22:17:23Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 30398, "attachment_id": null, "id": 61557, "time": "2004-08-04T20:47:36Z", "creator": "ruediger.pluem@vodafone.com", "creation_time": "2004-08-04T20:47:36Z", "is_private": false, "text": "No, you cannot use my patch as I patched mod_jk to solve my problem. You\nneed a patch for mod_disk_cache. But as I mentioned in 30398, I was not quite\nsure if this problem is a bug in mod_jk or mod_cache / mod_disk_cache\n(BTW: mod_mem_cache does not have this problem). After I read this report here\nI am quite sure that it is a bug in mod_disk_cache and that it should be fixed\nthere.\nmod_disk_cache.c already contains the needed code in write_headers, but\nit is executed too late. So I just moved this piece of code and created an\nappropriate patch for this which I will attach.\n\nI removed my patch from my mod_jk and added my patch to mod_disk_cache and\nmy problem from 30398 remains silent. I hope that this patch will also solve\nyour problem. A short feedback on your experience with the patch would be much\nappreciated.\n\nBTW: If you have any problems with mod_cache storing Cookies unintentional, or\nwith other weird HTTP header caching behaviour you may find the following links\nuseful:\n\nhttp://nagoya.apache.org/bugzilla/show_bug.cgi?id=30399\nhttp://nagoya.apache.org/bugzilla/show_bug.cgi?id=30419\n"}, {"count": 3, "text": "Sorry wrong bug report :-(. Should have gone to 30278.", "bug_id": 30398, "attachment_id": null, "id": 61558, "time": "2004-08-04T20:48:22Z", "creator": "ruediger.pluem@vodafone.com", "creation_time": "2004-08-04T20:48:22Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "bug_id": 30398, "attachment_id": null, "text": "As I stumbled over Bug 30278\n(http://nagoya.apache.org/bugzilla/show_bug.cgi?id=30278)\nI am now sure that this problem is a bug of mod_disk_cache and that it should\nbe fixed there. Although my patch does not harm mod_jk, it is no longer needed\nto solve the problem provided the patch from 30278 is used and applied to\nmod_disk_cache.", "id": 61561, "time": "2004-08-04T20:51:03Z", "creator": "ruediger.pluem@vodafone.com", "creation_time": "2004-08-04T20:51:03Z", "is_private": false}, {"count": 5, "text": "Marking as INVALID based on the last comments.", "bug_id": 30398, "attachment_id": null, "id": 62943, "time": "2004-09-02T00:57:24Z", "creator": "funkman@joedog.org", "creation_time": "2004-09-02T00:57:24Z", "tags": [], "is_private": false}]