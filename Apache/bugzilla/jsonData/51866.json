[{"count": 0, "tags": [], "bug_id": 51866, "attachment_id": 27556, "text": "Created attachment 27556\nScenario for reproducing error\n\nMy scenario has such structure:\nTestPlan\n+Thread (Start next loop on error)\n++Loop (Loop Count = 7)\n+++Counter (increment = 1)\n+++Sampler1\n+++Sampler2\nIf any sampler inside loop was failed, value for counter incremented by \"Loop Count\" for loop\nWorkflow:\nSampler1 (counter = 1)\nSampler2 (counter = 1)\nSampler1 (counter = 2)\nSampler2 (counter = 2)\nSampler1(failed)\nSampler1 (counter = 9)\nSampler2 (counter = 9)\nIt looks like after error all iterations of loop passed but samplers just disabled, counters - not", "id": 149607, "time": "2011-09-22T06:46:14Z", "creator": "tedam@mail.ru", "creation_time": "2011-09-22T06:46:14Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 51866, "attachment_id": null, "id": 150030, "time": "2011-10-01T19:56:14Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-10-01T19:56:14Z", "is_private": false, "text": "Same explanation as 51868.\nIncrementation is due to this code in JMeterThread:\n\nsam = controller.next(); // need perfom a until loop for special case (tc as parent)\nwhile (sam != null && !sam.equals(firstSampler)) { // while the thread is NOT on the begining of the tree\n                                    sam = controller.next();\n}"}, {"count": 2, "tags": [], "bug_id": 51866, "attachment_id": 27670, "is_private": false, "id": 150045, "time": "2011-10-02T06:51:55Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-10-02T06:51:55Z", "text": "Created attachment 27670\nFix to issue\n\nHello,\nPatch uses same approach as 51868.\nRegards\nPhilippe"}, {"count": 3, "text": "Created attachment 27692\nSimplified test case\n\nIt's not just the counter that behaves strangely.\n\nThe attached test case behaves differently if the \"Outer\" Java sampler is disabled. In that case, the counter increments correctly.", "bug_id": 51866, "is_private": false, "id": 150157, "time": "2011-10-04T22:51:58Z", "creator": "sebb@apache.org", "creation_time": "2011-10-04T22:51:58Z", "tags": [], "attachment_id": 27692}, {"count": 4, "tags": [], "bug_id": 51866, "attachment_id": null, "id": 150158, "time": "2011-10-04T23:08:41Z", "creator": "sebb@apache.org", "creation_time": "2011-10-04T23:08:41Z", "is_private": false, "text": "(In reply to comment #2)\n> Created attachment 27670 [details]\n> Fix to issue\n> \n> Hello,\n> Patch uses same approach as 51868.\n> Regards\n> Philippe\n\nAlthough that might fix the Counter issue, it's not really scaleable - there are bound to be other elements that rely on the iterationStart() event: if not currently, then they may be added later.\n\nThe fix needs to ensure that the iterationStart() event is only triggered when the next loop actually starts.\n\nRather than looping through the samplers, maybe the code can trigger the loop-end condition in each of the parent controllers until the Thread Group is reached?\n\nUnfortunately this area of JMeter code is very complicated and not all that well documented."}, {"count": 5, "tags": [], "bug_id": 51866, "is_private": false, "text": "Created attachment 27697\nSame patch as 51868 taking into account you last comment\n\nRegards\nPhilippe M.", "id": 150178, "time": "2011-10-05T13:33:30Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-10-05T13:33:30Z", "attachment_id": 27697}, {"count": 6, "tags": [], "bug_id": 51866, "attachment_id": null, "id": 150194, "time": "2011-10-05T15:45:30Z", "creator": "sebb@apache.org", "creation_time": "2011-10-05T15:45:30Z", "is_private": false, "text": "Sorry, but I don't think that's OK either.\n\nThe method fireIterationStart() may be invoked by fireIterEvents() which resets first; it does not seem right to clear first when fireIterationStart() does nothing.\n\nThe code needs to behave as if each controller had reached the end of its loop, otherwise I think there are going to be edge cases that won't work, e.g. Once Only Controller."}, {"count": 7, "tags": [], "bug_id": 51866, "attachment_id": null, "is_private": false, "id": 150195, "time": "2011-10-05T15:52:30Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-10-05T15:52:30Z", "text": "If I put JMeterContextService.getContext().isWithinRestartNextLoop() test \nin fireIterEvents() instead, \ndo you see a case where it could fail ?\n\nRegards\nPhilippe"}, {"count": 8, "tags": [], "bug_id": 51866, "attachment_id": null, "id": 150196, "time": "2011-10-05T16:06:50Z", "creator": "sebb@apache.org", "creation_time": "2011-10-05T16:06:50Z", "is_private": false, "text": "(In reply to comment #7)\n> If I put JMeterContextService.getContext().isWithinRestartNextLoop() test \n> in fireIterEvents() instead, \n> do you see a case where it could fail ?\n\nYes, if fireIterationStart() is called directly.\nBut adding it to both won't necessarily help either, as that only fixes the issue with iteration listeners.\n\nBut as I pointed out in Comment 3, it's not just the counter that misbehaves; the counter problem is just one symptom.\n\nI think the whole \"Start next loop\" code needs rewriting.\n\nEffectively the option means \"go to end of loop\" for each controller up to the Thread Group. [At least I assume this is the intention, as the option only appears on the Thread Group controller.]\n\nSo we need to code the feature as if this has happened, and then everything else should happen naturally."}, {"count": 9, "text": "Date: Mon Oct 31 10:50:11 2011\nNew Revision: 1195404\n\nURL: http://svn.apache.org/viewvc?rev=1195404&view=rev\nLog:\nFix to Start Next Loop broken feature, fixes following issues:\n- Bug 51865 - Infinite loop inside thread group does not work properly if \"Start next loop after a Sample error\" option set\n- Bug 51868 - A lot of exceptions in jmeter.log while using option \"Start next loop\" for thread\n- Bug 51866 - Counter under loop doesn't work properly if \"Start next loop on error\" option set for thread group\n\n\nAdded:\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/threads/FindTestElementsUpToRootTraverser.java   (with props)\nModified:\n   jakarta/jmeter/trunk/src/components/org/apache/jmeter/control/ForeachController.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/control/Controller.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/control/GenericController.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/control/IfController.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/control/LoopController.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/control/RunTime.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/control/WhileController.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/threads/AbstractThreadGroup.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/threads/JMeterThread.java\n   jakarta/jmeter/trunk/xdocs/changes.xml", "bug_id": 51866, "attachment_id": null, "id": 151074, "time": "2011-10-31T10:52:21Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-10-31T10:52:21Z", "tags": [], "is_private": false}, {"count": 10, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "is_private": false, "id": 151098, "attachment_id": null, "bug_id": 51866, "creation_time": "2011-11-01T10:05:24Z", "time": "2011-11-01T10:05:24Z", "text": "Hello,\nA Fix has been provided, it would be Nice of you to test it and submit a comment confirming it is fixed for you.\n\nRegards"}, {"count": 11, "text": "looks like fixed, thanks\nverified on r1213077 (nightly build)", "bug_id": 51866, "is_private": false, "id": 152143, "time": "2011-12-13T13:41:06Z", "creator": "tedam@mail.ru", "creation_time": "2011-12-13T13:41:06Z", "tags": [], "attachment_id": null}, {"text": "*** Bug 52330 has been marked as a duplicate of this bug. ***", "tags": [], "bug_id": 51866, "attachment_id": null, "count": 12, "id": 152162, "time": "2011-12-14T12:09:35Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-12-14T12:09:35Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 51866, "attachment_id": null, "id": 152802, "time": "2012-01-15T13:46:43Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2012-01-15T13:46:43Z", "is_private": false, "text": "Thanks for verification.\nMarking issue as RESOLVED to avoid it appearing in Bug Report."}]