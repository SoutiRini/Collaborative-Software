[{"count": 0, "tags": [], "text": "I'm running Debian Lenny with Apache mpm prefork 2.2.9-10 on x86. I have it set up as a reverse proxy for a few thousand user directories as well as some virtual hosts. When I have reverse proxy enabled for all of these, a single request to my server causes apache to fill up the ram and start swapping until swap is full. This doesn't happen when I disable proxying to the user directories. It also doesn't happen upon loading apache. Only after the first request is processed. It doesn't cause apache to crash but it makes it go very slowly.\n\nHere is a small portion of the config:\nProxyPassMatch ^/~es44(/.*)?$ http://www.et.byu.edu/~es44$1\nProxyPassReverse /~es44 http://www.et.byu.edu/~es44\nProxyPassMatch ^/~bdefig(/.*)?$ http://www.et.byu.edu/~bdefig$1\nProxyPassReverse /~bdefig http://www.et.byu.edu/~bdefig\nProxyPassMatch ^/~rmariana(/.*)?$ http://www.et.byu.edu/~rmariana$1\nProxyPassReverse /~rmariana http://www.et.byu.edu/~rmariana\nProxyPassMatch ^/~scornwel(/.*)?$ http://www.et.byu.edu/~scornwel$1\nProxyPassReverse /~scornwel http://www.et.byu.edu/~scornwel\nProxyPassMatch ^/~gkh3(/.*)?$ http://www.et.byu.edu/~gkh3$1\nProxyPassReverse /~gkh3 http://www.et.byu.edu/~gkh3\nProxyPassMatch ^/~camoo(/.*)?$ http://www.et.byu.edu/~camoo$1\nProxyPassReverse /~camoo http://www.et.byu.edu/~camoo\nProxyPassMatch ^/~karhu(/.*)?$ http://www.et.byu.edu/~karhu$1\nProxyPassReverse /~karhu http://www.et.byu.edu/~karhu\nProxyPassMatch ^/~websterb(/.*)?$ http://www.et.byu.edu/~websterb$1\nProxyPassReverse /~websterb http://www.et.byu.edu/~websterb\n\nThere are few thousand of user directories configured in this manner.\nThere isn't anything special I do for this setup. I enabled proxy and proxy_http. I use the ssl proxy engine and I have ProxyRequests turned off and ProxyVia On\n\nThe problem goes away when I remove all the specific entries for user directories and replace them with:\nProxyPass /~ http://www.et.byu.edu/~\nProxyPassReverse /~ http://www.et.byu.edu/~", "attachment_id": null, "bug_id": 46282, "id": 122808, "time": "2008-11-24T16:44:26Z", "creator": "drew@thewithers.org", "creation_time": "2008-11-24T16:44:26Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 46282, "attachment_id": null, "is_private": false, "id": 123050, "time": "2008-12-03T09:11:31Z", "creator": "sf@sfritsch.de", "creation_time": "2008-12-03T09:11:31Z", "text": "(In reply to comment #0)\n> When I have reverse proxy enabled for all of these, a single\n> request to my server causes apache to fill up the ram and start swapping\n> until swap is full.\n\nWhat size do the apache processes have directly after a restart. To what size do they grow after the first request?\n\n"}, {"count": 2, "tags": [], "creator": "drew@thewithers.org", "attachment_id": null, "text": "> What size do the apache processes have directly after a restart. To what size\n> do they grow after the first request?\n> \nHere is what they look like when I have all of the proxies turned on:\n$ ps -eo rss,vsz,sz,command |grep /usr/sbin/apache2\n\nImmediately after restart:\n  RSS    VSZ    SZ COMMAND\n110536 150476 37619 /usr/sbin/apache2 -k start\n178636 286644 71661 /usr/sbin/apache2 -k start\n178636 286644 71661 /usr/sbin/apache2 -k start\n178640 286644 71661 /usr/sbin/apache2 -k start\n178636 286644 71661 /usr/sbin/apache2 -k start\n178636 286644 71661 /usr/sbin/apache2 -k start\n\n\n\nAfter loading one page:\n  RSS    VSZ    SZ COMMAND\n14824 150476 37619 /usr/sbin/apache2 -k start\n14756 286832 71708 /usr/sbin/apache2 -k start\n14668 286824 71706 /usr/sbin/apache2 -k start\n14332 286644 71661 /usr/sbin/apache2 -k start\n127120 286644 71661 /usr/sbin/apache2 -k start\n135356 286644 71661 /usr/sbin/apache2 -k start\n135312 286644 71661 /usr/sbin/apache2 -k start\n135288 286644 71661 /usr/sbin/apache2 -k start\n135816 286644 71661 /usr/sbin/apache2 -k start\n135380 286644 71661 /usr/sbin/apache2 -k start\n135416 286644 71661 /usr/sbin/apache2 -k start\n\n\n\n\nHere is what it looks like when I have it set up with the catchall that I mentioned before\n\nImmediately after restart:\n  RSS    VSZ    SZ COMMAND\n50056  67824 16956 /usr/sbin/apache2 -k start\n55876  82632 20658 /usr/sbin/apache2 -k start\n55880  82632 20658 /usr/sbin/apache2 -k start\n55876  82632 20658 /usr/sbin/apache2 -k start\n55876  82632 20658 /usr/sbin/apache2 -k start\n55876  82632 20658 /usr/sbin/apache2 -k start\n\n\nAfter loading one page:\n  RSS    VSZ    SZ COMMAND\n50056  67824 16956 /usr/sbin/apache2 -k start\n56688  82768 20692 /usr/sbin/apache2 -k start\n56960  82840 20710 /usr/sbin/apache2 -k start\n55880  82632 20658 /usr/sbin/apache2 -k start\n55876  82632 20658 /usr/sbin/apache2 -k start\n55876  82632 20658 /usr/sbin/apache2 -k start\n55876  82632 20658 /usr/sbin/apache2 -k start\n55876  82632 20658 /usr/sbin/apache2 -k start", "id": 123059, "time": "2008-12-03T13:26:07Z", "bug_id": 46282, "creation_time": "2008-12-03T13:26:07Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 46282, "attachment_id": null, "is_private": false, "id": 123283, "time": "2008-12-14T01:11:46Z", "creator": "sf@sfritsch.de", "creation_time": "2008-12-14T01:11:46Z", "text": "This looks like apache uses about 120MB of memory to store a few thousand config directives and the corresponding compiled regular expressions, i.e. on the order of 10K per directive (depending on how many 'a few' is). This doesn't look optimal but is probably acceptable.\n\nHowever, regardless of the used memory, your configuration will allways be dead slow because apache has to do thousands of regexp matches for every request. Use some more efficient configuration (e.g. with mod_rewrite and RewriteMaps) instead. If you have problems implementing this, ask on some support mailing list."}]