[{"count": 0, "tags": [], "bug_id": 24426, "attachment_id": null, "id": 46846, "time": "2003-11-05T09:31:59Z", "creator": "andreas.goetz.external@fujitsu-siemens.com", "creation_time": "2003-11-05T09:31:59Z", "is_private": false, "text": "I'm using a php script to deliver files (e.g. bmps, zip files etc). This is \nworking fine for all clients. No php compresssion or output buffering is used.\nWhen using mod_deflate (with the recommended configuration), IE(6) is no longer \nable to open the delivered zip files (corrupt, appearing empty). Below are the \nrequest responses with/out mod_deflate:\n\nmod_deflate off:\nHTTP/1.1 200 OK\nDate: Wed, 05 Nov 2003 09:17:54 GMT\nServer: Apache/2.0.47 (Win32) PHP/4.3.4\nX-Powered-By: PHP/4.3.4\nContent-Length: 228531\nContent-Disposition: filename=logs.zip\nContent-Description: Download Data\nContent-Type: application/x-zip-compressed\n\nPK...\n\nmod_deflate on:\nHTTP/1.1 200 OK\nDate: Wed, 05 Nov 2003 09:19:18 GMT\nServer: Apache/2.0.47 (Win32) PHP/4.3.4\nX-Powered-By: PHP/4.3.4\nContent-Length: 228531\nContent-Disposition: filename=logs.zip\nContent-Description: Download Data\nVary: Accept-Encoding,User-Agent\nCache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0\nPragma: no-cache\nContent-Type: application/x-zip-compressed\n\nPK...\n\nI understand this may be more an IE issue than Apache but would appreciate a \ncomment very much. Opera(7.21) is able to correctly open the zip file, too."}, {"count": 1, "tags": [], "bug_id": 24426, "attachment_id": null, "is_private": false, "id": 46922, "time": "2003-11-06T11:32:54Z", "creator": "andreas.goetz.external@fujitsu-siemens.com", "creation_time": "2003-11-06T11:32:54Z", "text": "I have also verified that the proxy does not seem to be the problem- I've set \nIE to direct connection, issue is still the same."}, {"count": 2, "tags": [], "bug_id": 24426, "attachment_id": null, "is_private": false, "id": 46977, "time": "2003-11-07T10:02:25Z", "creator": "andreas.goetz.external@fujitsu-siemens.com", "creation_time": "2003-11-07T10:02:25Z", "text": "You can use the following simple PHP script to reproduce the problem:\n\n<?php\nif ($_GET[dl]) {\n\t$filename = \"1.zip\";\n\theader(\"Content-type: application/zip\");\n\theader(\"Content-disposition: filename=$filename\");\n\treadfile($filename);\n} else { ?>\n\t<a href=\"<?=$_SERVER['PHP_SELF']?>?dl=1\">download</a> <?\n}\n?>\n"}, {"count": 3, "tags": [], "creator": "nd@perlig.de", "attachment_id": null, "text": "You might want to try out the force-no-vary environment variable. IE is known to\nhave problems with the Vary header somtimes.", "id": 46978, "time": "2003-11-07T10:21:29Z", "bug_id": 24426, "creation_time": "2003-11-07T10:21:29Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 24426, "attachment_id": null, "id": 46979, "time": "2003-11-07T10:38:50Z", "creator": "andreas.goetz.external@fujitsu-siemens.com", "creation_time": "2003-11-07T10:38:50Z", "is_private": false, "text": "I've added (although this is IE6, docs only refer to IE4):\nBrowserMatch MSIE force-no-vary\n\nbehaviour is still the same :(\n\nCheers,\nAndi\n"}, {"count": 5, "tags": [], "bug_id": 24426, "text": "I'm wondering where the cache headers come from. These headers could cause the\nproblem as well. mod_deflate doesn't emit them anyway. Do you have some proxy\nsoftware between the IE and the server? Or some other module involved?", "id": 47272, "time": "2003-11-12T21:48:48Z", "creator": "nd@perlig.de", "creation_time": "2003-11-12T21:48:48Z", "is_private": false, "attachment_id": null}, {"count": 6, "attachment_id": null, "bug_id": 24426, "text": "I'm not entirely sure. However, the behaviour is even reproducible with IE and \nApache running on the same (Windows) machine and direct connection to localhost-\n though in this scenario I'm unsure how to look at the headers?", "id": 47291, "time": "2003-11-13T08:35:55Z", "creator": "andreas.goetz.external@fujitsu-siemens.com", "creation_time": "2003-11-13T08:35:55Z", "tags": [], "is_private": false}, {"text": "Is there anything else I could do to help verifying?", "tags": [], "creator": "andreas.goetz.external@fujitsu-siemens.com", "is_private": false, "count": 7, "id": 48667, "time": "2003-12-08T11:42:42Z", "bug_id": 24426, "creation_time": "2003-12-08T11:42:42Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 24426, "attachment_id": null, "id": 49126, "time": "2003-12-15T11:44:32Z", "creator": "andreas.goetz.external@fujitsu-siemens.com", "creation_time": "2003-12-15T11:44:32Z", "is_private": false, "text": "I thought it might be related to these:\n\nhttp://support.microsoft.com/default.aspx?scid=kb;en-us;Q313712\nhttp://support.microsoft.com/default.aspx?scid=kb;en-us;Q312496\n\nBut the fix doesn't work. Document sizes differ by 5kb in one example if using \ncompression or not."}, {"count": 9, "attachment_id": null, "bug_id": 24426, "text": "I've also seen this:\nhttp://nagoya.apache.org/bugzilla/show_bug.cgi?id=22902\n\nIt seems to suggest a workaround for the current problem. If the DEFLATE filter \ncould be disabled for certain content types (e.g. zip files which get \ncorrupted) in addition to file extensions (e.g. .zip which is not applicable as \nthe zip file is served by a PHP script), this might help?\n\nThanks,\nAndi\n", "id": 49127, "time": "2003-12-15T11:57:12Z", "creator": "andreas.goetz.external@fujitsu-siemens.com", "creation_time": "2003-12-15T11:57:12Z", "tags": [], "is_private": false}, {"count": 10, "tags": [], "bug_id": 24426, "attachment_id": null, "is_private": false, "id": 60429, "time": "2004-07-11T08:15:49Z", "creator": "nick@webthing.com", "creation_time": "2004-07-11T08:15:49Z", "text": "Three points.\n\n* This doesn't really look like an apache bug - though it could be.\n* You can work around it in httpd.conf.\n* It will go away if my proposed filtering framework updates happen.\n\nShould this bug perhaps be resolved as LATER or WONTFIX?"}, {"count": 11, "attachment_id": null, "bug_id": 24426, "is_private": false, "id": 60552, "time": "2004-07-13T16:17:54Z", "creator": "andreas.goetz.external@fujitsu-siemens.com", "creation_time": "2004-07-13T16:17:54Z", "tags": [], "text": "Thank you for the comment- could you post the httpd.conf resolution? I'm not \nentirely sure how to- as I'd still like to use compression...\n\nThanks,\nAndi"}, {"count": 12, "attachment_id": null, "bug_id": 24426, "is_private": false, "id": 61364, "time": "2004-07-30T08:27:36Z", "creator": "nick@webthing.com", "creation_time": "2004-07-30T08:27:36Z", "tags": [], "text": "Looking more carefully at your \"mod_deflate on|off\" headers, the difference is in \nthe Vary header and the cache control directives.\n\nmod_deflate could set Vary: Accept-Encoding but NOT User-Agent.  And it won't even \ntouch the cacheing headers you cited.  So I have to conclude the difference, and \nyour problem, lie elsewhere.  Either something within PHP or in your config.\n\nThe problem I thought it might have been before was compressing an inappropriate \ncontent-type.  My proposal for dealing with this is now written up at\nhttp://www.apachetutor.org/dev/smart-filter\nWithout that, the httpd.conf fix would be simply not to compress."}]