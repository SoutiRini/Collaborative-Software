[{"count": 0, "tags": [], "bug_id": 51445, "attachment_id": null, "id": 147552, "time": "2011-06-28T10:33:26Z", "creator": "bhatu.mali@gmail.com", "creation_time": "2011-06-28T10:33:26Z", "is_private": false, "text": "I have noticed that in tomcat 7 if we implement SingleThreadModel and initialize some variables into init(ServletConfig config) method, in that case values initialized in init(ServletConfig config) not reflected into service block.\n\nFor Example : Following code will print \"0\".\n\nimport java.io.IOException;\nimport java.io.PrintWriter;\nimport javax.servlet.ServletConfig;\nimport javax.servlet.ServletException;\nimport javax.servlet.SingleThreadModel;\nimport javax.servlet.http.HttpServlet;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\n\npublic class test extends HttpServlet implements SingleThreadModel\n{\n\n    int i = 0;\n\n    @Override\n    public void init(ServletConfig config) throws ServletException\n    {\n        super.init(config);\n        i = 10;\n    }\n    protected void processRequest(HttpServletRequest request, HttpServletResponse response)\n            throws ServletException, IOException\n    {\n        response.setContentType(\"text/html;charset=UTF-8\");\n        PrintWriter out = response.getWriter();\n        try\n        {\n            out.println(i);\n        }\n        finally\n        {\n            out.close();\n        }\n    }\n    @Override\n    protected void doGet(HttpServletRequest request, HttpServletResponse response)\n            throws ServletException, IOException\n    {\n        processRequest(request, response);\n    }\n    @Override\n    protected void doPost(HttpServletRequest request, HttpServletResponse response)\n            throws ServletException, IOException\n    {\n        processRequest(request, response);\n    }\n    @Override\n    public String getServletInfo()\n    {\n        return \"Short description\";\n    }\n}"}, {"count": 1, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "Reducing severity. SingleThreadModel has been deprecated for as long as I can remember so this is not critical.", "id": 147565, "time": "2011-06-28T16:35:07Z", "bug_id": 51445, "creation_time": "2011-06-28T16:35:07Z", "is_private": false}, {"count": 2, "tags": [], "text": "This works for me with the latest 7.0.x code.\n\nI've added to test case that checks this just to be on the safe side.", "is_private": false, "id": 147575, "creator": "markt@apache.org", "time": "2011-06-28T18:01:25Z", "bug_id": 51445, "creation_time": "2011-06-28T18:01:25Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "bhatu.mali@gmail.com", "is_private": false, "id": 147588, "creation_time": "2011-06-29T05:18:03Z", "time": "2011-06-29T05:18:03Z", "bug_id": 51445, "text": "(In reply to comment #2)\n> This works for me with the latest 7.0.x code.\n> \n> I've added to test case that checks this just to be on the safe side.\n\n(In reply to comment #2)\n> This works for me with the latest 7.0.x code.\n> \n> I've added to test case that checks this just to be on the safe side.\n\n\nI think tomcat 7.0.16 has same problem. SingleThreadModel model is obviously deprecated but we have some old servlets in which it is used, and we can not change that code by some reasons.", "attachment_id": null}, {"count": 4, "tags": [], "text": "Please provide a test case that fails on a current version of Tomcat downloaded directly from the Apache site.\n\nMark's analysis is that the test case you provided works in his environment. It's up to you to prove that it doesn't work by reproducing the circumstances.", "is_private": false, "id": 147608, "creator": "chris@christopherschultz.net", "time": "2011-06-29T14:04:44Z", "bug_id": 51445, "creation_time": "2011-06-29T14:04:44Z", "attachment_id": null}, {"count": 5, "tags": [], "text": "\nWhat I hava to provide exactly in test case (as I am new here). All I can provide is I have tested same in apache-tomcat-7.0.12, apache-tomcat-7.0.16 with JDK jdk1.6.0_13, jdk1.6.0_26 in PC Linux OS.\n\nThe servlet I have provided should print 10 rather than 0.", "attachment_id": null, "id": 147628, "creator": "bhatu.mali@gmail.com", "time": "2011-06-30T05:50:57Z", "bug_id": 51445, "creation_time": "2011-06-30T05:50:57Z", "is_private": false}, {"count": 6, "tags": [], "text": "I think Mali is right and his test case is valid.\n\nIf you try the servlet in a freshly downloaded tomcat you will get \"0\" as result. If you spice up his testcase a little bit, you will see, that one instance of the servlet will get initialized and another one will be used for the request. That is what SingleThreadModel is for.\n\nI think the logic changed from 6.0 to 7.0 that there is only one (StandardWrapper-wide) instance variable which tells tomcat whether the servlet is initialized or not. This initialization has moved to allocate. That means, that one servlet gets initialized and every other newly created instance for the pool (instancePool) will not be initialized.\n\nIn tomcat6.0 I believe the newly created servlets were initialized in loadServlet.\n\nMarks testcase could be testing the wrong thing by providing an instance for a SingleThreadModel-servlet on its own.\n\nCould that be?", "is_private": false, "id": 147632, "creator": "felix.schumacher@internetallee.de", "time": "2011-06-30T08:14:57Z", "bug_id": 51445, "creation_time": "2011-06-30T08:14:57Z", "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 51445, "attachment_id": 27230, "id": 147634, "time": "2011-06-30T10:39:50Z", "creator": "felix.schumacher@internetallee.de", "creation_time": "2011-06-30T10:39:50Z", "is_private": false, "text": "Created attachment 27230\ninit every servlet if it is a SingleThreadMode servlet"}, {"count": 8, "tags": [], "bug_id": 51445, "attachment_id": null, "is_private": false, "id": 147637, "time": "2011-06-30T11:58:40Z", "creator": "markt@apache.org", "creation_time": "2011-06-30T11:58:40Z", "text": "Further investigation shows that o.a.catalina.startup.Tomcat (that is the basis for most of the unit tests) didn't handle SingleThreadModel servlets. I have fixed that and improved the unit tests in that area.\n\nSince the handling for SingleThreadModel servlets is slightly different, I need to put together a different unit test for this issue. Working on that now."}, {"count": 9, "tags": [], "text": "Unit test now reproduce this.\n\nThe bug has been fixed in 7.0.x and the fix will be included in 7.0.17 onwards.", "is_private": false, "id": 147638, "creator": "markt@apache.org", "time": "2011-06-30T12:17:16Z", "bug_id": 51445, "creation_time": "2011-06-30T12:17:16Z", "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 51445, "attachment_id": null, "is_private": false, "id": 147639, "time": "2011-06-30T12:17:35Z", "creator": "markt@apache.org", "creation_time": "2011-06-30T12:17:35Z", "text": "As an aside, I used a variation of Felix's patch."}, {"count": 11, "tags": [], "creator": "bhatu.mali@gmail.com", "is_private": false, "text": "May I know how to fix this bug in tomcat 7.0.16 or I have to wait for tomcat 7.0.17 ! May I know the tentative date for tomcat 7.0.17 release !", "id": 147640, "time": "2011-06-30T12:59:43Z", "bug_id": 51445, "creation_time": "2011-06-30T12:59:43Z", "attachment_id": null}, {"count": 12, "tags": [], "text": "(In reply to comment #11)\n> May I know how to fix this bug in tomcat 7.0.16 or I have to wait for tomcat\n> 7.0.17 ! May I know the tentative date for tomcat 7.0.17 release !\n\nIf you are comfortable using svn to get diffs for the files involved, patching them, and re-building Tomcat, you can look at Mark's patch here: http://svn.apache.org/viewvc?view=revision&revision=1141502\n\nIf you'd rather not patch but don't mind building and living on the edge, you can get svn trunk and use that.\n\nOtherwise, you'll have to wait for 7.0.17. Mark is the release manager for 7.0.x and has tried to keep to a roughly-monthly schedule for releasing patch levels for 7.0.x, so I would expect one in the next 20 days or so (if the release gets enough votes). If you have any further questions about releases, please ask on the users list.", "attachment_id": null, "id": 147661, "creator": "chris@christopherschultz.net", "time": "2011-06-30T20:07:09Z", "bug_id": 51445, "creation_time": "2011-06-30T20:07:09Z", "is_private": false}]