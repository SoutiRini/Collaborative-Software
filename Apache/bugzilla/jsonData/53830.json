[{"attachment_id": null, "tags": [], "creator": "knst.kolinko@gmail.com", "text": "See the following thread on the users list:\n\"Windows Path Not Found for urandom\", started on Aug 28, 2012\nhttp://markmail.org/thread/l3f3meujmac2jzqp\nhttp://marc.info/?t=134616742400004&r=1&w=2\n\nThis issue is specific to Tomcat 6 and earlier.\nIn Tomcat 7 the session id generation was reimplemented and this feature was removed.\n\nThe default value of o.a.c.session.ManagerBase.devRandomSource is \"/dev/urandom\".\n\n1) The value is unsuitable for Windows, where the file does not exist.\n\nI think it would be better to statically test the value once:\n- File.isAbsolute(), to avoid looking for \"C:\\dev\\urandom\"\n- File.exists()\n\n2) On each call to ManagerBase.getRandomBytes(..) it tries to reopen the file by calling setRandomFile(..).\n\nThere is try/catch(IOException) that clears the name and prevents subsequent attempts to open the file, but it does not happen in case of simple if(!f.exists()) return.\n\nStacktrace (from the mail thread, see details there):\n[[[\nAug 29, 2012 11:52:29 AM org.apache.catalina.session.ManagerBase setRandomFile\nWARNING: Error reading /dev/urandom\njava.io.EOFException\n        at java.io.DataInputStream.readFully(DataInputStream.java:180)\n        at java.io.DataInputStream.readLong(DataInputStream.java:399)\n        at org.apache.catalina.session.ManagerBase.setRandomFile(ManagerBase.java:548)\n        at org.apache.catalina.session.ManagerBase.getRandomBytes(ManagerBase.java:993)\n        at org.apache.catalina.session.ManagerBase.init(ManagerBase.java:767)\n        at org.apache.catalina.session.StandardManager.start(StandardManager.java:630)\n        at org.apache.catalina.core.ContainerBase.setManager(ContainerBase.java:446)\n        at org.apache.catalina.core.StandardContext.start(StandardContext.java:4631)\n        at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:799)\n        at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:779)\n        at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:601)\n        at org.apache.catalina.startup.HostConfig.deployDescriptor(HostConfig.java:675)\n        at org.apache.catalina.startup.HostConfig.deployDescriptors(HostConfig.java:601)\n        at org.apache.catalina.startup.HostConfig.deployApps(HostConfig.java:502)\n        at org.apache.catalina.startup.HostConfig.start(HostConfig.java:1317)\n        at org.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java:324)\n        at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:142)\n        at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1065)\n        at org.apache.catalina.core.StandardHost.start(StandardHost.java:840)\n        at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1057)\n        at org.apache.catalina.core.StandardEngine.start(StandardEngine.java:463)\n        at org.apache.catalina.core.StandardService.start(StandardService.java:525)\n        at org.apache.catalina.core.StandardServer.start(StandardServer.java:754)\n        at org.apache.catalina.startup.Catalina.start(Catalina.java:595)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.catalina.startup.Bootstrap.start(Bootstrap.java:289)\n        at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:414)\n]]]", "count": 0, "id": 161958, "time": "2012-09-05T08:07:20Z", "bug_id": 53830, "creation_time": "2012-09-05T08:07:20Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 53830, "text": "Created attachment 29329\n2012-09-05_tc6_53830.patch\n\nPatch for Tomcat 6", "id": 161959, "time": "2012-09-05T09:05:29Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2012-09-05T09:05:29Z", "is_private": false, "attachment_id": 29329}, {"count": 2, "tags": [], "text": "Created attachment 29330\n2012-09-05_tc6_53830_v2.patch\n\nCorrected patch.\n1) Properly close old randomIS stream when setRandomFile() is called at runtime to replace the random file.\n2) Documentation: The attribute is now documented both for StandardManager and for PersistentManager.", "is_private": false, "id": 161960, "creator": "knst.kolinko@gmail.com", "time": "2012-09-05T10:19:17Z", "bug_id": 53830, "creation_time": "2012-09-05T10:19:17Z", "attachment_id": 29330}, {"count": 3, "tags": [], "creator": "knst.kolinko@gmail.com", "text": "Created attachment 29331\n2012-09-05_tc55_53830_v2.patch\n\nPatch for Tomcat 5.5", "id": 161961, "time": "2012-09-05T10:26:26Z", "bug_id": 53830, "creation_time": "2012-09-05T10:26:26Z", "is_private": false, "attachment_id": 29331}, {"count": 4, "attachment_id": null, "creator": "chris@christopherschultz.net", "is_private": false, "id": 161971, "time": "2012-09-05T15:04:18Z", "bug_id": 53830, "creation_time": "2012-09-05T15:04:18Z", "tags": [], "text": "RE:documentation of the attribute name, Jeffrey reported that setting the \"randomFile\" attribute on the <Manager> had no effect: /dev/urandom was still used. I'm not sure why that was (it could have been a misconfiguration), but please check that setting \"randomFile\" actually has an effect."}, {"count": 5, "tags": [], "bug_id": 53830, "attachment_id": null, "text": "(In reply to comment #4)\n> RE:documentation of the attribute name, Jeffrey reported that setting the\n> \"randomFile\" attribute on the <Manager> had no effect: /dev/urandom was\n> still used. I'm not sure why that was (it could have been a\n> misconfiguration), but please check that setting \"randomFile\" actually has\n> an effect.\n\nRegarding 6.0.35:\nI do not know why it did not work for Jeffrey.\nhttp://markmail.org/message/4zfhs6fii6vb7pf4\n\na) A known issue is that if the value is a non-existent file, then in 6.0.35 setting the value would not have much effect. ManagerBase silently accepts the file name and then it will try to reopen it, like it does with the default value of /dev/urandom.\nAnyway, whether the value was set can be confirmed via JMX.\n\nb) Maybe a typo, or it was set in a wrong place?\n\n\nFor 6.0.35 and earlier running on Windows I would suggest to set randomFile attribute to point to an existing file, containing 8 bytes.\n\nThe initial 8 bytes are read during readLong() call in setRandomFile(). Having a non-empty file avoids logging an IOException there. An attempt to read more bytes in ManagerBase#getRandomBytes() will result in IOException, which will be caught and will set the devRandomSource field to null.\n\nUsing a longer file is not recommended, as it will affect the randomness of session ids.\n\n\nRegarding 6.0 + patch, I tested setting the value\na) Using JMX\nb) In conf/context.xml:\n <Manager randomFile=\"${catalina.base}/conf/server.xml\"/>\nIn conf/logging.properties:\n org.apache.catalina.session.ManagerBase.level=FINE\n\nIn logs/catalina.2012-09-05.log the following is logged:\n 05.09.2012 22:45:17 org.apache.catalina.session.ManagerBase doSetRandomFile\n FINE: Opening C:\\[redacted]/conf/server.xml", "id": 161981, "time": "2012-09-05T19:00:36Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2012-09-05T19:00:36Z", "is_private": false}, {"count": 6, "tags": [], "text": "Fixed in 5.5.x and will be included in 5.5.36 onwards.", "is_private": false, "id": 162488, "creator": "markt@apache.org", "time": "2012-10-01T09:51:13Z", "bug_id": 53830, "creation_time": "2012-10-01T09:51:13Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "markt@apache.org", "is_private": false, "count": 7, "id": 162583, "time": "2012-10-05T11:45:16Z", "bug_id": 53830, "creation_time": "2012-10-05T11:45:16Z", "text": "Fixed in 6.0.x and will be included in 6.0.36 onwards."}]