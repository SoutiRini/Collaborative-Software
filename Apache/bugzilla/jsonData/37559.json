[{"count": 0, "tags": [], "creator": "mguardiola@asp4all.nl", "text": "Hi, \n\nmod_deflate seems to overwrite Vary headers set by applications (or \nmod_headers) when serving proxied content. \n\nBelow my virtualhost configuration and the test data. \n\n_____________\n# cat /usr/local/apache/conf/deflate.conf\n<Virtualhost *>\n  ServerName            direct.test.nl\n  DocumentRoot          /var/www/html\n  AddOutputFilterByType DEFLATE text/html text/plain text/css\n</VirtualHost>\n\n<Virtualhost *>\n  ServerName            proxy.test.nl\n  ProxyPass             /       http://backend.test.nl/\n  ProxyPassReverse      /       http://backend.test.nl/\n  AddOutputFilterByType DEFLATE text/html text/plain text/css\n</VirtualHost>\n\n<Virtualhost *>\n  ServerName            backend.test.nl\n  DocumentRoot          /var/www/html\n</VirtualHost>\n_________________\n\n# cat test.cgi\n#!/bin/sh\n\necho \"Content-type: text/html\"\necho \"Vary: Accept\"\necho \"\"\necho \"\"\n\necho    \"\n<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\"><html>\n<head>\n<title>Test</title>\n</head>\n</body>\n</html>\n        \"\n______________\n\n# wget --header=\"Accept-Encoding: compress, gzip\" -SO backendhtml \nbackend.test.nl/cgi-bin/test.cgi 2>&1 | grep Vary\n 4 Vary: Accept\n\n# wget --header=\"Accept-Encoding: compress, gzip\" -SO directhtml  \ndirect.test.nl/cgi-bin/test.cgi 2>&1 | grep Vary\n 4 Vary: Accept,Accept-Encoding\n\n# wget --header=\"Accept-Encoding: compress, gzip\" -SO proxyhtml   \nproxy.test.nl/cgi-bin/test.cgi 2>&1 | grep Vary\n 4 Vary: Accept-Encoding\n\n______________\nThe last request should generate the same Vary header as the second one..\n\n\nKind regards, \n\nMarc Guardiola", "id": 82668, "time": "2005-11-18T17:58:24Z", "bug_id": 37559, "creation_time": "2005-11-18T17:58:24Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "mguardiola@asp4all.nl", "attachment_id": null, "id": 82669, "time": "2005-11-18T18:15:28Z", "bug_id": 37559, "creation_time": "2005-11-18T18:15:28Z", "is_private": false, "text": "Forgot to mention that mod_proxy is not the cause, without mod_deflate it works \nfine (The Vary header is not deleted by mod_proxy):\n\n# cat /usr/local/apache/conf/deflate.conf\n<Virtualhost *>\n  ServerName            backend.test.nl\n  DocumentRoot          /var/www/html\n</VirtualHost>\n\n<Virtualhost *>\n  ServerName            proxynodeflate.test.nl\n  ProxyPass             /       http://backend.test.nl/\n  ProxyPassReverse      /       http://backend.test.nl/\n</VirtualHost>\n\n__________________\n\n# wget --header=\"Accept-Encoding: compress, gzip\" -SO proxynodeflate      \nproxynodeflate.test.nl/cgi-bin/test.cgi 2>&1 | grep Vary\n 4 Vary: Accept\n\nRegards, \n\nMarc"}, {"count": 2, "tags": [], "creator": "rpluem@apache.org", "text": "Created attachment 16995\nPatch against 2.0.x (merge Vary instead of setting it)\n\nI think you hit the problem that has been fixed on the trunk in r161691\n(http://svn.apache.org/viewcvs.cgi?rev=161691&view=rev). Please try if the\nattached patch fixes your problem.", "id": 82677, "time": "2005-11-19T00:37:14Z", "bug_id": 37559, "creation_time": "2005-11-19T00:37:14Z", "is_private": false, "attachment_id": 16995}, {"count": 3, "tags": [], "text": "It works! Vary headers set by applications and/or by mod_headers are merged now.\n\nThanks!\n\nMarc", "attachment_id": null, "id": 82702, "creator": "mguardiola@asp4all.nl", "time": "2005-11-21T12:00:18Z", "bug_id": 37559, "creation_time": "2005-11-21T12:00:18Z", "is_private": false}, {"count": 4, "tags": [], "creator": "rpluem@apache.org", "text": "Proposed for backport to 2.0.x:\n(http://svn.apache.org/viewcvs.cgi?rev=347969&view=rev)", "id": 82708, "time": "2005-11-21T21:24:12Z", "bug_id": 37559, "creation_time": "2005-11-21T21:24:12Z", "is_private": false, "attachment_id": null}]