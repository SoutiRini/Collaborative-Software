[{"count": 0, "tags": [], "creator": "g.russell@napier.ac.uk", "attachment_id": null, "id": 159283, "time": "2012-05-24T09:00:48Z", "bug_id": 53286, "creation_time": "2012-05-24T09:00:48Z", "is_private": false, "text": "I moved from 2.2.21 to 2.2.22 on Fedora 15, and my mod_rewrite commands are no longer parsed when the request is the CONNECT method.\n\nIt used to be possible and reasonably documented to be able to do rewrites like:\n\nRewriteCond %{REQUEST_METHOD} ^connect$ [NC]\nRewriteCond %{THE_REQUEST} !^connect\\ tunnel-([^\\ ]+)\\.proxymachine\\.net:([0-9]+)\\ .*$ [NC]\nRewriteRule ^(.*)$  $1 [F,L]\n\nI use code like this to rewrite the uri to point to the tunnel endpoint from a RewriteMap file, and this has worked well for a few years. Even at logging level 9 nothing it produced in 2.2.22. Reverting the mod_rewrite module to 2.2.21 fixes the issue. \n\nAlthough not tested, I suspect httpd-2.2.22/modules/mappers/mod_rewrite.c at line 4268, which returns DECLINED if the uri[0] is not \"/\". However CONNECT is more likely to have the format \"CONNECT the.machine.com:6000\", and this contains no \"/\" characters. In fact attempting a CONNECT with a \"/\" gives an error very early on in the parse tree.\n\nI think the \" r->uri[0] != '/' \" test should have been guarded with a \" r->method_number == M_CONNECT \" test, but to be honest I have not tested this except in my head.\n\nCould we also add mod_rewrite parsing CONNECT as a regression test? It is so useful but perhaps there are only a few of us making use of it that it would take a while for someone to notice.\n\nThanks. I hope this report was useful. And by the way thanks for all your efforts!\n\nGordon."}, {"count": 1, "tags": [], "text": "The following patch fixes the problem for me. It also gives some logging for future users want to debug similar issues.\n-----\n\n\ndiff -Npru httpd-2.2.22.orig/modules/mappers/mod_rewrite.c httpd-2.2.22/modules/\nmappers/mod_rewrite.c\n--- httpd-2.2.22.orig/modules/mappers/mod_rewrite.c 2012-01-24 19:39:31.0000\n00000 +0000\n+++ httpd-2.2.22/modules/mappers/mod_rewrite.c 2012-05-24 14:47:49.949153810 +0\n100\n@@ -4267,10 +4267,14 @@ static int hook_uri2file(request_rec *r)\n     }\n\n     if ((r->unparsed_uri[0] == '*' && r->unparsed_uri[1] == '\\0')\n-        || !r->uri || r->uri[0] != '/') {\n+        || !r->uri ||\n+        (r->uri[0] != '/' && r->method_number != M_CONNECT)) {\n+        rewritelog((r, 2, NULL, \"uri %s is considered a security risk\",\n+                            r->uri));\n         return DECLINED;\n     }\n\n+\n     /*\n      *  add the SCRIPT_URL variable to the env. this is a bit complicated\n      *  due to the fact that apache uses subrequests and internal redirects", "is_private": false, "id": 159292, "creation_time": "2012-05-24T14:24:19Z", "time": "2012-05-24T14:24:19Z", "creator": "g.russell@napier.ac.uk", "bug_id": 53286, "attachment_id": null}, {"count": 2, "tags": [], "text": "Sorry to keep going on...\n\nLooking at my patch maybe the rewritelog line needs to be protected against r->uri being null? Probably someone with security knowledge should check this!\n\nSo maybe:\n\n\ndiff -Npru httpd-2.2.22.orig/modules/mappers/mod_rewrite.c httpd-2.2.22/modules/\nmappers/mod_rewrite.c\n--- httpd-2.2.22.orig/modules/mappers/mod_rewrite.c 2012-01-24 19:39:31.0000\n00000 +0000\n+++ httpd-2.2.22/modules/mappers/mod_rewrite.c 2012-05-24 14:47:49.949153810 +0\n100\n@@ -4267,10 +4267,14 @@ static int hook_uri2file(request_rec *r)\n     }\n\n     if ((r->unparsed_uri[0] == '*' && r->unparsed_uri[1] == '\\0')\n-        || !r->uri || r->uri[0] != '/') {\n+        || !r->uri ||\n+        (r->uri[0] != '/' && r->method_number != M_CONNECT)) {\n+        rewritelog((r, 2, NULL, \"uri %s is considered a security risk\",\n+                            r->uri ? r->uri : \"<null>\"));\n         return DECLINED;\n     }\n\n+\n     /*\n      *  add the SCRIPT_URL variable to the env. this is a bit complicated\n      *  due to the fact that apache uses subrequests and internal redirects", "attachment_id": null, "bug_id": 53286, "id": 159293, "time": "2012-05-24T14:58:24Z", "creator": "g.russell@napier.ac.uk", "creation_time": "2012-05-24T14:58:24Z", "is_private": false}, {"count": 3, "tags": [], "creator": "rainer.jung@kippdata.de", "attachment_id": null, "id": 159340, "time": "2012-05-26T13:00:41Z", "bug_id": 53286, "creation_time": "2012-05-26T13:00:41Z", "is_private": false, "text": "\n\n*** This bug has been marked as a duplicate of bug 52774 ***"}]