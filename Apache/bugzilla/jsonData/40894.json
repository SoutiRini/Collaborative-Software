[{"count": 0, "tags": [], "bug_id": 40894, "attachment_id": null, "text": "In mod_proxy_ftp, responses from the FTP server over the control channel are\ncopied from a bucket brigade to a buffer using apr_cpystrn() incorrectly. The\nlength parameter is taken directly from the bucket brigade, which represents the\nactual number of data bytes. However, apr_copystrn() always NULL-terminates\nstrings, meaning it uses the last byte inside the given length for a NULL, and\nnot for the last byte of data from the FTP server. Usually, this is not a\nproblem, since it only cuts off a period at the end of a sentence, or the LF of\na CRLF pair. However, it breaks some sites that return their responses as such:\nPacket one: \"250-\"\nPacket two: \"Welcome to our FTP site.\"\nPacket three: \"\\r\\n\"\nThis is passed back to the caller as \"250Welcome to our FTP site\\r\". Since the\ncaller checks that the fourth character is either '-' or ' ', the caller returns\nan error. Example URL given above in the appropriate field.\nSince the patch is so short, i'm inlining it here:\n\n--- proxy_util.c.orig   2006-11-04 08:15:20.000000000 +0100\n+++ proxy_util.c        2006-11-04 08:13:21.000000000 +0100\n@@ -967,6 +967,13 @@\n                 if (memchr(response, APR_ASCII_LF, len)) {\n                     found = 1;\n                 }\n+\n+                /* For the code below, apr_cpystrn() always NULL terminates\n+                 * the destination string, meaning we need to make len one\n+                 * byte longer to accommodate for that. Just to be paranoid,\n+                 * check for an integer overflow. */\n+                if (len+1 > len) len++;\n+\n                 /* concat strings until buff is full - then throw the data away */\n                 if (len > ((bufflen-1)-(pos-buff))) {\n                     len = (bufflen-1)-(pos-buff);", "id": 95416, "time": "2006-11-03T23:31:26Z", "creator": "arjones@simultan.dyndns.org", "creation_time": "2006-11-03T23:31:26Z", "is_private": false}, {"count": 1, "tags": [], "text": "Patched in trunk in r573903.", "attachment_id": null, "bug_id": 40894, "id": 107873, "time": "2007-09-08T13:29:49Z", "creator": "nick@webthing.com", "creation_time": "2007-09-08T13:29:49Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 40894, "attachment_id": null, "text": "Backported to 2.2 in r574941.", "id": 108068, "time": "2007-09-12T06:27:50Z", "creator": "nick@webthing.com", "creation_time": "2007-09-12T06:27:50Z", "is_private": false}]