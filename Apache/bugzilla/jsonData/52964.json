[{"count": 0, "text": "Created attachment 28492\npatch for mod_ratelimit\n\nTo replay, use the following setting in httpd.conf:\n\n<Location /downloads>\nSetOutputFilter RATE_LIMIT\nSetEnv rate-limit -400\n</Location>\n\nStart the httpd server; use your browser to access http://ipaddress/downloads/\nThen, the access will be stuck and the server will print out the following message in error log: \n\n[Wed Mar 21 10:58:33.664383 2012] [ratelimit:error] [pid 2951:tid 140736908777216] [client 132.239.17.127:46106] AH01456: rl: partition failed.\n\nThe message is really bad for users. Who knows what is the \"rl\" and what is the \"partition\"?\n\nTake a look at the code and find the root cause: \n\n------------------------\n\n//modules/filters/mod_ratelimit.c\n\nconst char *rl = NULL;\n\nrl = apr_table_get(f->r->subprocess_env, \"rate-limit\");\n\nif (rl == NULL) {\n    ap_remove_output_filter(f);\n    return ap_pass_brigade(f->next, bb);\n}\n\n/* first run, init stuff */\nctx = apr_palloc(f->r->pool, sizeof(rl_ctx_t));\nf->ctx = ctx;\nctx->speed = 0;\nctx->state = RATE_LIMIT;\n\n/* rl is in kilo bytes / second  */\nctx->speed = atoi(rl) * 1024;\n\nif (ctx->speed == 0) {\n    /* remove ourselves */\n    ap_remove_output_filter(f);\n    return ap_pass_brigade(f->next, bb);\n}\n\n/* calculate how many bytes / interval we want to send */\n/* speed is bytes / second, so, how many  (speed / 1000 % interval) */\nctx->chunk_size = (ctx->speed / (1000 / RATE_INTERVAL_MS));\n\n......\n\nrv = apr_brigade_partition(bb, ctx->chunk_size, &stop_point);\nif (rv != APR_SUCCESS && rv != APR_INCOMPLETE) {\n    ctx->state = RATE_ERROR;\n    ap_log_rerror(APLOG_MARK, APLOG_ERR, 0, f->r, APLOGNO(01456)\n                  \"rl: partition failed.\");\n    break;\n}\n\n------------------------\n\nHere is the thing: after get the ctx->speed, the code only checks whether it's 0 or not. If it's 0, then the cleaning job will be done. But a negative value will go much further and cause the error point.\n\nA simple fix will be change the checking from \"if (ctx->speed == 0) {\"  to \"if (ctx->speed <= 0) {\" as the attachment.\n\n\nThanks!", "bug_id": 52964, "attachment_id": 28492, "id": 155190, "time": "2012-03-21T19:32:41Z", "creator": "tixu@cs.ucsd.edu", "creation_time": "2012-03-21T19:32:41Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 52964, "is_private": false, "text": "Thanks for the report.\n\nFixed in trunk in r1439623\n\nI applied a slightly different version of the patch.", "id": 164912, "time": "2013-01-28T21:00:19Z", "creator": "christophe.jaillet@wanadoo.fr", "creation_time": "2013-01-28T21:00:19Z", "attachment_id": null}, {"count": 2, "text": "Backported to v2.4.5 in r1455219.", "bug_id": 52964, "attachment_id": null, "id": 166972, "time": "2013-04-30T15:57:15Z", "creator": "minfrin@sharp.fm", "creation_time": "2013-04-30T15:57:15Z", "tags": [], "is_private": false}]