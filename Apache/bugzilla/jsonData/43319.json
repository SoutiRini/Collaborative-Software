[{"count": 0, "tags": [], "bug_id": 43319, "attachment_id": null, "text": "I was trying to send %3d to backend server as a reverse proxy.\n--[Conf\nWith rewrite rule\nRewriteEngine on\nRewriteLogLevel 3\nRewriteRule ^(.*)test.txt$  http://agneyam.india.sun.com:2000/val\\%3dtest.txt \n[NE,P]\n\n]\n>[\nGET /http/me/test.txt HTTP/1.0\n\n]\n\ngets sent to back end as\n\n>[\nGET /val%253dtest.txt HTTP/1.1\nHost: agneyam.india.sun.com:2000\nMax-Forwards: 10\nX-Forwarded-For: 129.158.224.203\nX-Forwarded-Server: agneyam\nConnection: Keep-Alive\n\n]\n\nie, the % gets escaped again.\nIf I remove the [P] from the flags, the url generated is correct.\nWith out mod_proxy (N) in it,\n\nRewriteRule ^(.*)test.txt$  http://agneyam.india.sun.com:2000/val\\%3dtest.txt \n[NE]\n>[\nGET /http/me/test.txt HTTP/1.0\n]\n<[\nHTTP/1.1 302 Found\nDate: Thu, 06 Sep 2007 08:24:42 GMT\nServer: Apache/2.3.0-dev (Unix)\nLocation: http://agneyam.india.sun.com:2000/val%3dtest.txt\nContent-Length: 232\nLocation: http://agneyam.india.sun.com:2000/val%3dtest.txt\nContent-Length: 232\nConnection: close\nContent-Type: text/html; charset=iso-8859-1\n\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>302 Found</title>\n</head><body>\n<h1>Found</h1>\n<p>The document has moved <a href=\"http://agneyam.india.sun.com:2000/\nval%3dtest.txt\">here</a>.</p>\n</body></html>\n]\n(notice that the %3d is not munged.)\n\nJust for checking, I removed the NE flag too, which gave the expected result \n(which, with out the NE flag is to escape %)\n>[\nGET /http/me/test.txt HTTP/1.0\n]\n<[\nHTTP/1.1 302 Found\nDate: Thu, 06 Sep 2007 08:26:02 GMT\nServer: Apache/2.3.0-dev (Unix)\nLocation: http://agneyam.india.sun.com:2000/val%253dtest.txt\nContent-Length: 234\nLocation: http://agneyam.india.sun.com:2000/val%253dtest.txt\nContent-Length: 234\nConnection: close\nContent-Type: text/html; charset=iso-8859-1\n\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>302 Found</title>\n</head><body>\n<h1>Found</h1>\n<p>The document has moved <a href=\"http://agneyam.india.sun.com:2000/\nval%253dtest.txt\">here</a>.</p>\n</body></html>\n]\n\n\n\n====================================================\nJust to verify the behavior, I did further tests.\n====================================================\n\nIf I remove the '\\' from % in rewrite rule, (Just to see what happens.)\nRewriteRule ^(.*)test.txt$  http://agneyam.india.sun.com:2000/val%3dtest.txt \n[NE,P]\n\n>[\nGET /http/me/test.txt HTTP/1.0\n]\n\ngets sent to back end as\n\n>[\nGET /valdtest.txt HTTP/1.1\nHost: agneyam.india.sun.com:2000\nMax-Forwards: 10\nX-Forwarded-For: 129.158.224.203\nX-Forwarded-Server: agneyam\nConnection: Keep-Alive\n\n]\n\nUsing Rewriterule with out NE flag,\nRewriteRule ^(.*)test.txt$  http://agneyam.india.sun.com:2000/val\\%3dtest.txt \n[P]\n\n>[\nGET /http/me/test.txt HTTP/1.0\n]\n\ngets sent to back end as\n\n>[\nGET /val%253dtest.txt HTTP/1.1\nHost: agneyam.india.sun.com:2000\nMax-Forwards: 10\nX-Forwarded-For: 129.158.224.203\nX-Forwarded-Server: agneyam\nConnection: Keep-Alive\n\n]\n(ie: there is no change from using NE and not using it.)\n\nUsing mod_proxy directly using ProxyPass and not Rewrite does it the other way\n(changes Hex to chars)\nwith ProxyPass\nProxyRequests On\nProxyVia On\nProxyPass /http http://agneyam.india.sun.com:2000\n>[\nGET /http/me/val%3dtest.txt HTTP/1.0\n]\n\ngets sent to back end as:\n>[\nGET /me/val=test.txt HTTP/1.1\nHost: agneyam.india.sun.com:2000\nMax-Forwards: 10\nVia: 1.0 agneyam\nX-Forwarded-For: 129.158.224.203\nX-Forwarded-Server: agneyam\nConnection: Keep-Alive\n\n]\n\n=====================\nSummary\n=====================\nThe NE flag does not have an effect when mod_proxy (P) is involved.", "id": 107770, "time": "2007-09-06T04:25:24Z", "creator": "rahul.g.nair@gmail.com", "creation_time": "2007-09-06T04:25:24Z", "is_private": false}, {"attachment_id": 20843, "tags": [], "bug_id": 43319, "text": "Created attachment 20843\nA patch to let mod_rewrite flags P and NE co-exist.\n\nThe problem with mod_proxy (P) flag is that in \nmod_rewrite:hook_uri2file(request_rec *r)\nthe rulestatus != ACTION_NOESCAPE is checked only in the case when it is not a\nproxy. while there is nothing done when it is a proxy.\n\nOn the other hand, the mod_proxy escapes any and every URLs that it gets. \nso the URL that we passed in with NE gets munged by mod_proxy.\n\nThe fix is to check for ACTION_NOESCAPE in the if proxy section of \nmod_rewrite:hook_uri2file(request_rec *r), and set the r->notes\napr_table_setn(r->notes, \"mod_proxy:flags\",\"NE\");\n\nand in mod_proxy_http:proxy_http_canon which is responsible for escaping HTTP\nURLs, we check for the above flag's existence and if it is there, we let the\nURL path in with out escaping.\n\nThe reason notes is named mod_proxy:flags rather than mod_rewrite:flags is\nthat the same flags may be made use of by some other module that needs proxy\nfunctionality with out the escaping.", "count": 1, "id": 108325, "time": "2007-09-18T04:50:31Z", "creator": "rahul.g.nair@gmail.com", "creation_time": "2007-09-18T04:50:31Z", "is_private": false}, {"count": 2, "tags": [], "text": "Created attachment 20844\nfix a typo in previous patch.", "is_private": false, "id": 108327, "creator": "rahul.g.nair@gmail.com", "time": "2007-09-18T05:00:55Z", "bug_id": 43319, "creation_time": "2007-09-18T05:00:55Z", "attachment_id": 20844}, {"count": 3, "tags": [], "creator": "nick@webthing.com", "is_private": false, "text": "Fixed in trunk: r611134.  This is basically your patch, but tied in with my\nprevious fix to the same problem in mod_proxy without mod_rewrite.", "id": 112761, "time": "2008-01-11T02:55:54Z", "bug_id": 43319, "creation_time": "2008-01-11T02:55:54Z", "attachment_id": null}, {"count": 4, "tags": [], "text": "Fixed in r611414.", "is_private": false, "bug_id": 43319, "id": 112781, "time": "2008-01-12T05:54:42Z", "creator": "nick@webthing.com", "creation_time": "2008-01-12T05:54:42Z", "attachment_id": null}]