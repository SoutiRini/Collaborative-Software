[{"count": 0, "tags": [], "bug_id": 44543, "text": "Step0: cleanup browser A (e.g. alt-shift-del in firefox)\nStep1: browser A send http://B/ request through apache proxy to HTTP server B\nStep2: browser A send ftp://B/ request through apache proxy to FTP server B\nresult:\n\nProxy Error\n\nThe proxy server received an invalid response from an upstream server.\nThe proxy server could not handle the request GET ftp://192.168.3.129/.\n\nReason: Error reading from remote server\n\nB=192.168.3.129, A=127.0.0.1, apache proxy running at localhost\n\nerrorlog:\n\n[Wed Mar 05 15:35:43 2008] [debug] mod_proxy_http.c(1607): proxy: start body send\n[Wed Mar 05 15:35:43 2008] [debug] mod_proxy_http.c(1696): proxy: end body send\n[Wed Mar 05 15:35:43 2008] [debug] proxy_util.c(1873): proxy: HTTP: has released connection for (*)\n[Wed Mar 05 15:35:43 2008] [error] Optional hook test said: GET http://192.168.3.129/favicon.ico HTTP/1.1\n[Wed Mar 05 15:35:43 2008] [error] Optional function test said: GET http://192.168.3.129/favicon.ico HTTP/1.1\n[Wed Mar 05 15:35:43 2008] [debug] proxy_util.c(1670): proxy: grabbed scoreboard slot 0 in child 22992 for worker proxy:forward\n[Wed Mar 05 15:35:43 2008] [debug] proxy_util.c(1689): proxy: worker proxy:forward already initialized\n[Wed Mar 05 15:35:43 2008] [debug] proxy_util.c(1778): proxy: initialized single connection worker 0 in child 22992 for (*)\n[Wed Mar 05 15:35:43 2008] [debug] proxy_util.c(1670): proxy: grabbed scoreboard slot 1 in child 22992 for worker proxy:reverse\n[Wed Mar 05 15:35:43 2008] [debug] proxy_util.c(1689): proxy: worker proxy:reverse already initialized\n[Wed Mar 05 15:35:43 2008] [debug] proxy_util.c(1778): proxy: initialized single connection worker 1 in child 22992 for (*)\n[Wed Mar 05 15:35:43 2008] [debug] proxy_util.c(1670): proxy: grabbed scoreboard slot 0 in child 22993 for worker proxy:forward\n[Wed Mar 05 15:35:43 2008] [debug] proxy_util.c(1689): proxy: worker proxy:forward already initialized\n[Wed Mar 05 15:35:43 2008] [debug] proxy_util.c(1778): proxy: initialized single connection worker 0 in child 22993 for (*)\n[Wed Mar 05 15:35:43 2008] [debug] proxy_util.c(1670): proxy: grabbed scoreboard slot 1 in child 22993 for worker proxy:reverse\n[Wed Mar 05 15:35:43 2008] [debug] proxy_util.c(1689): proxy: worker proxy:reverse already initialized\n[Wed Mar 05 15:35:43 2008] [debug] proxy_util.c(1778): proxy: initialized single connection worker 1 in child 22993 for (*)\n[Wed Mar 05 15:35:45 2008] [debug] mod_proxy_ftp.c(149): proxy: FTP: canonicalising URL //192.168.3.129/\n[Wed Mar 05 15:35:45 2008] [debug] proxy_util.c(1424): [client 127.0.0.1] proxy: *: found forward proxy worker for ftp://192.168.3.129/\n[Wed Mar 05 15:35:45 2008] [debug] mod_proxy.c(849): Running scheme ftp handler (attempt 0)\n[Wed Mar 05 15:35:45 2008] [debug] mod_proxy_http.c(1812): proxy: HTTP: declining URL ftp://192.168.3.129/\n[Wed Mar 05 15:35:45 2008] [debug] mod_proxy_connect.c(100): proxy: CONNECT: declining URL ftp://192.168.3.129/\n[Wed Mar 05 15:35:45 2008] [debug] mod_proxy_ftp.c(811): proxy: FTP: serving URL ftp://192.168.3.129/\n[Wed Mar 05 15:35:45 2008] [debug] mod_proxy_ftp.c(903): proxy: FTP: connecting ftp://192.168.3.129/ to 192.168.3.129:21\n[Wed Mar 05 15:35:45 2008] [debug] proxy_util.c(1855): proxy: FTP: has acquired connection for (*)\n[Wed Mar 05 15:35:45 2008] [debug] proxy_util.c(2269): proxy: FTP: connection complete to 192.168.3.129:21 (192.168.3.129)\n[Wed Mar 05 15:35:45 2008] [debug] mod_proxy_ftp.c(993): proxy: FTP: control connection complete\n[Wed Mar 05 15:35:57 2008] [debug] mod_proxy_ftp.c(634): proxy:<FTP: 4294967295 <unable to read result>\n[Wed Mar 05 15:35:57 2008] [debug] proxy_util.c(1873): proxy: FTP: has released connection for (*)\n[Wed Mar 05 15:35:57 2008] [error] [client 127.0.0.1] proxy: Error reading from remote server returned by ftp://192.168.3.129/\n[Wed Mar 05 15:35:57 2008] [error] Optional hook test said: GET ftp://192.168.3.129/ HTTP/1.1\n[Wed Mar 05 15:35:57 2008] [error] Optional function test said: GET ftp://192.168.3.129/ HTTP/1.1\n\n\nAfter the following _hack_(cleaning up the worker's history), apache proxy works fine again.\n\ndiff -du modules/proxy/mod_proxy_ftp.c~ modules/proxy/mod_proxy_ftp.c\n--- modules/proxy/mod_proxy_ftp.c~      2008-01-02 11:25:08.000000000 -0800\n+++ modules/proxy/mod_proxy_ftp.c       2008-03-05 15:39:27.000000000 -0800\n@@ -902,6 +902,10 @@\n\n     ap_log_error(APLOG_MARK, APLOG_DEBUG, 0, r->server,\n        \"proxy: FTP: connecting %s to %s:%d\", url, connectname, connectport);\n+\n+    worker->is_address_reusable = 0;\n+    worker->cp->addr = NULL;\n+    worker->cp->conn = NULL;\n\n     if (worker->is_address_reusable) {\n         if (!worker->cp->addr) {", "id": 114310, "time": "2008-03-05T16:03:41Z", "creator": "jeffwu75@gmail.com", "creation_time": "2008-03-05T16:03:41Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 44543, "attachment_id": null, "id": 114312, "time": "2008-03-05T16:45:11Z", "creator": "jeffwu75@gmail.com", "creation_time": "2008-03-05T16:45:11Z", "is_private": false, "text": "looks like it's the same as d40416\n\nBTW, it's ctl-shift-del to cleanup firefox"}, {"count": 2, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "id": 114328, "time": "2008-03-06T03:23:48Z", "bug_id": 44543, "creation_time": "2008-03-06T03:23:48Z", "is_private": false, "text": "Can you please check if the following patch fixes your problem:\n\nhttp://people.apache.org/~jim/patches/proxy-ssl-44026-patch.txt\n\nDon't worry about the size of the patch. Its origin is to fix PR44026 and PR43238, but I think it will fix your problem as well and it is currently already discussed for backport to 2.2.x."}, {"text": "Yes, it works! Thanks a lot.", "tags": [], "bug_id": 44543, "is_private": false, "count": 3, "id": 114366, "time": "2008-03-06T10:39:43Z", "creator": "jeffwu75@gmail.com", "creation_time": "2008-03-06T10:39:43Z", "attachment_id": null}, {"count": 4, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "id": 116757, "time": "2008-05-17T12:54:59Z", "bug_id": 44543, "creation_time": "2008-05-17T12:54:59Z", "is_private": false, "text": "Backported to 2.2.x as r657440 (http://svn.apache.org/viewvc?rev=657440&view=rev)."}]