[{"count": 0, "tags": [], "creator": "rfrovarp@apache.org", "attachment_id": null, "is_private": false, "id": 103976, "time": "2007-06-01T13:12:30Z", "bug_id": 42567, "creation_time": "2007-06-01T13:12:30Z", "text": "How to replicate: Upload a png, jpg, or css file (gif and bmp might cause\nproblems too). Click on the site tab. Select a different node. Select the node\nyou just uploaded. An exception will happen.\n\nThe first time you go to the site tab, you are viewing nodename.html. Any\nfurther attempts put you at nodename.extension. This is where the problem comes\nin. The displayed exception is stating that the usecase coming back is\nundefined. Digging in log4j.log I see the real reason:\n\nCaused by: org.apache.lenya.ac.AccessControlException: Request\n[org.apache.cocoon.environment.http.HttpRequest@127d15e] does not contain roles: \n    URI: [/default/authoring/tutorial/JPG.jpg]\n    Parameter: [lenya.usecase] = [tab.overview]\n\n        at org.apache.lenya.cms.ac.PolicyUtil.getRoles(PolicyUtil.java:65)\n        at\norg.apache.lenya.cms.usecase.gui.impl.GUIManagerImpl.contextualize(GUIManagerImpl.java:262)\n        ... 96 more\n\n\nI don't know why there are no roles. In fact, trying to view the page without\nlogging in generates the same error.\n\nSomeone else is going to need to look at this one."}, {"count": 1, "tags": [], "bug_id": 42567, "text": "I've found what is causing the problem.\n\nsrc/modules-core/ac/java/src/org/apache/lenya/ac/impl/BypassableAccessController.java\n\nUnder authorize() there is a test for this.publicExtensions. This test matches\nany request with the following extensions: css,jpg,gif,png,rng,xsl. If this test\npasses, the call up to super doesn't happen. This prevents any role information\nfrom being setup. This in turn causes the exception to be thrown. Not sure the\nbest route to take to fix this problem.", "id": 104084, "time": "2007-06-05T07:27:23Z", "creator": "rfrovarp@apache.org", "creation_time": "2007-06-05T07:27:23Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 42567, "attachment_id": null, "id": 104096, "time": "2007-06-05T13:22:44Z", "creator": "rfrovarp@apache.org", "creation_time": "2007-06-05T13:22:44Z", "is_private": false, "text": "If the publicExtensions check is removed, it mostly works. The one thing I've\nfound to break is the svg module resize. It gets its image via HTTP, without any\nauthorization. This causes permission to be denied when the request is made from\nthe authoring side. Live side has no issue. Granting localhost visit rights does\nfix the problem, but is not desirable from a security standpoint. Is there a way\nto get the svg resize to use internal methods to get the image instead of HTTP?"}, {"count": 3, "tags": [], "creator": "andreas@apache.org", "attachment_id": null, "text": "I modified the sitetree2nav.xsl stylesheet so that the sitetree in the site area\nuses only .html URLs.", "id": 104114, "time": "2007-06-06T01:11:43Z", "bug_id": 42567, "creation_time": "2007-06-06T01:11:43Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 42567, "text": "That did it. Thanks.", "id": 104135, "time": "2007-06-06T06:38:43Z", "creator": "rfrovarp@apache.org", "creation_time": "2007-06-06T06:38:43Z", "is_private": false, "attachment_id": null}]