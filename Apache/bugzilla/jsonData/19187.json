[{"count": 0, "tags": [], "creator": "jdb@getsu.com", "attachment_id": null, "text": "The ReplaceRegExp task throws IndexOutOfBoundsException for files containing\nmulti-byte encodings.\n\njava.lang.IndexOutOfBoundsException\n        at java.io.BufferedReader.read(BufferedReader.java:256)\n        at\norg.apache.tools.ant.taskdefs.optional.ReplaceRegExp.doReplace(ReplaceRegExp.java:404)\n        at\norg.apache.tools.ant.taskdefs.optional.ReplaceRegExp.execute(ReplaceRegExp.java:491)\n        at org.apache.tools.ant.Task.perform(Task.java:319)\n        at org.apache.tools.ant.Target.execute(Target.java:309)\n        at org.apache.tools.ant.Target.performTasks(Target.java:336)\n        at org.apache.tools.ant.Project.executeTarget(Project.java:1306)\n        at org.apache.tools.ant.Project.executeTargets(Project.java:1250)\n        at org.apache.tools.ant.Main.runBuild(Main.java:610)\n        at org.apache.tools.ant.Main.start(Main.java:196)\n        at org.apache.tools.ant.Main.main(Main.java:235)\n\nThe task was:\n    <replaceregexp flags=\"g\" file=\"regtst\">\n        <regexp pattern=\"((Header:\\s+\\S+|Revision)\\s+\\S+\\s+\\S+\\s+\\S+)\\s+(\\w+)\"/>\n        <substitution expression=\"\\1\"/>\n      </replaceregexp>\n\nThe root cause seems to be the assumption that the length of the file is the\nsame as the number of characters in the file.  This assumption fails for\nmulti-byte encodings.  ReplaceRegExp.java lines 398 to 406 are: \n                int flen = (int) f.length();\n                char tmpBuf[] = new char[flen]; \n                int numread = 0;\n                int totread = 0; \n\n                while (numread != -1 && totread < flen) {\n                    numread = br.read(tmpBuf, totread, flen);\n                    totread += numread; \n                }\nThe flen is the number of bytes in the file, but it's being misused as the\nnumber of characters.\n\nRelated symptom: if you use a fileset, you don't get the full stacktrace, only a\nsummary:\n[replaceregexp] An error occurred processing file:\n'/home/jdb/projects/foo/regtst': java.lang.IndexOutOfBoundsException\n\nWork around:\nbyline=\"true\" uses a different block of code.  (But it's still apt to munge your\nencoding.)\n\nSuggested enhancement:\nadd a file encoding parameter to the task.\n\nSorry I don't have time to fix this right now.\n\n11011011", "id": 35688, "time": "2003-04-21T07:47:50Z", "bug_id": 19187, "creation_time": "2003-04-21T07:47:50Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 19187, "text": "There is an encoding attribute in 1.6, but the code has been changed significantly\nbetween 1.5.1 and 1.5.3 so chances are very good that it is going to work with\n1.5.3 already - at least as long as the multi-byte encoding is your native\nfile encoding.", "id": 35863, "time": "2003-04-23T09:44:47Z", "creator": "bodewig@apache.org", "creation_time": "2003-04-23T09:44:47Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "jdb@getsu.com", "text": "It must still be broken in 1.5.3, because there were no code changes in\nReplaceRegExp.java from 1.5.1.  \n\nBut I don't know about 1.6, and an encoding attribute sounds good!", "id": 35941, "attachment_id": null, "bug_id": 19187, "creation_time": "2003-04-24T05:59:47Z", "time": "2003-04-24T05:59:47Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 19187, "attachment_id": null, "id": 35944, "time": "2003-04-24T06:12:49Z", "creator": "bodewig@apache.org", "creation_time": "2003-04-24T06:12:49Z", "is_private": false, "text": "You are correct, the changes didn't get merged over.\n\nMoreover, I just rechecked CVS HEAD and realized that the branch where the\nbyline has been set to false still has this problem for multibyte encodings\nand - even worse - ignores the encoding attribute."}, {"count": 4, "tags": [], "bug_id": 19187, "attachment_id": null, "id": 35962, "time": "2003-04-24T09:13:13Z", "creator": "bodewig@apache.org", "creation_time": "2003-04-24T09:13:13Z", "is_private": false, "text": "OK, should be fixed in nightly build 2003-04-25"}]