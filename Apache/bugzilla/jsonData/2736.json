[{"count": 0, "tags": [], "creator": "peter.van_der_goten@alcatel.be", "attachment_id": null, "id": 3917, "time": "2001-07-23T04:15:24Z", "bug_id": 2736, "creation_time": "2001-07-23T04:15:24Z", "is_private": false, "text": "This bug was found in Ant1.3 and\nalso found in the latest nightly build of ant (2001-07-22)\nfile: jakarta-ant-1.4alpha-bin.zip\nI thid the tests on NT for the 1.4aplha release and found the\nbug on unix for the 1.3 release.\n\nIn our project we noticed some problems with depencies concerning interfaces\nused to specify constants.\nIt seemed that the constants are inlined in the .class files and these .class\nfiles which use the contsants where NOT recompiled when a constant was changed.\n\nTo test this I made a simple application which uses two other .java files\nin which only public final consts where defined in an interface.\n(in the manner we use in our project)\n\nThe bug could be reproduced with ant but NOT with javac or jikes used on \nthere own.\n\nThe build .xml file I used\n<project name=\"CompTest\" default=\"compile\">\n\n  <property name=\"build.compiler\" value=\"jikes\"/>\n  <property name=\"package\"        value=\"be/alcatel\"/>\n  <property name=\"src\"            value=\"${basedir}/Src\"/>\n  <property name=\"logfile\"        value=\"${basedir}/build.log\"/>\n  <property name=\"classes\"        value=\"${basedir}/Classes\"/>\n  <property name=\"show\"           value=\"true\"/>\n\n  <!-- ******* -->\n  <!-- Compile -->\n  <!-- ******* -->\n  <target name=\"compile\">\n    <javac srcdir=\"${src}\"\n     destdir=\"${classes}\"\n     classpath=\"${classpath}\"\n     includes=\"${package}/**/*.java\"\n     verbose=\"${show}\"\n     failonerror=\"false\"\n     depend=\"true\"\n     debug=\"off\" optimize=\"off\" deprecation=\"off\"/>\n  </target>\n\n</project>\nthe java files:\n//AnOtherTestConstsITF.java\npackage be.alcatel.another;\n\npublic interface AnOtherTestConstsITF{\n  public static final String const2 = \"2\";\n}\n//TestConstsITF\npackage be.alcatel.test;\n\npublic interface TestConstsITF{\n  public static final int const1 = 1;\n}\n//Test.java\npackage be.alcatel.test;\n\nimport be.alcatel.another.*;\n\npublic class Test implements TestConstsITF, AnOtherTestConstsITF{\n\n  public void printConsts(){\n    System.err.println(\"TestConstsITF.const1        = \"+TestConstsITF.const1);\n    System.err.println(\"const1                      = \"+const1);\n    System.err.println(\"AnOtherTestConstsITF.const2 = \n\"+AnOtherTestConstsITF.const2);\n    System.err.println(\"const2                      = \"+const2);\n  }\n\n  public static void main (String[] args){\n    Test t = new Test();\n    t.printConsts();\n  }\n}\n\nThe project direcotory structure:\nProjroot\n  Src\n    be\n      alcatel\n        test\n          Test.java\n          TestConstsITF.java\n        another\n          AnOtherTestConstsITF.java\n  Classes\n    be\n      alcatel\n        test\n          Test.class\n          TestConstsITF.class\n        another\n          AnOtherTestConstsITF.class\n  \nBuild.bat used to build this example\n\n@echo off\n@setlocal\nset PSD_VOB=D:\\Projects\\comptest\nset PF_TOOLS=F:\\PFTools\n\nset JAVA_HOME=%PF_TOOLS%\\j2sdk1.3.1-win\nset J2EE_HOME=%PF_TOOLS%\\bea\\wlserver6.0sp1\nset BUILDFILE=D:\\Projects\\comptest\\build.xml\n\nrem set ANT_HOME=%PF_TOOLS%\\jakarta-ant1.3\nset ANT_HOME=D:\\jakarta-ant-1.4alpha\n\nset CPATH=%JAVA_HOME%\\lib\\tools.jar\nset CPATH=%CPATH%;%J2EE_HOME%\\lib\\weblogic.jar\nset CPATH=%CPATH%;%ANT_HOME%\\lib\\ant.jar\nrem set CPATH=%CPATH%;%ANT_HOME%\\lib\\jakarta-ant-1.3-optional.jar\nset CPATH=%CPATH%;%ANT_HOME%\\lib\\jakarta-ant-1.4alpha-optional.jar\nset CPATH=%CPATH%;%ANT_HOME%\\lib\\parser.jar\nset CPATH=%CPATH%;%ANT_HOME%\\lib\\crimson.jar\nset CPATH=%CPATH%;%ANT_HOME%\\lib\\jaxp.jar\nset CPATH=%CPATH%;%PF_VOB%\\build\\ant\\lib\\PFant.jar\n\n%JAVA_HOME%\\bin\\java -classpath %CPATH% -Dant.home=\"%ANT_HOME%\" \norg.apache.tools.ant.Main -buildfile %BUILDFILE% -Dbasedir=%PSD_VOB% \n-Dlibdir=tmp -Dtools=%PF_TOOLS% -quiet %1 %2 %3 %4 %5 %6 %7 %8 %9\n\n@endlocal\n\nWhen the project is rebuild using an adapted version of \nAnOtherTestConstsITF.java\nThe only class file that is new will be AnOtherTestConstsITF.class\nBecause the constats of this class where inlinde by the compiler in Test.class\nthe Test.class file should have been recompiled.\nIn fact this is done by the standard javac tool or jikes (without using ant)\n\nIf make.bat is used all is well (doesn't use ant)\n@echo off\n\nrem make.bat for the test\n\nset PRJDIR=D:\\Projects\\comptest\nset JDK_HOME=c:\\jdk1.3.0_02\\bin\nset CLASSDIR=%PRJDIR%\\Classes\nset SRCDIR=%PRJDIR%\\Src\nset JARDIR=%PRJDIR%\\jar\n\n\n@echo compiling...\nstart /b /wait /d%PRJDIR% jikes -depend -sourcepath %SRCDIR% -classpath \n.;%CLASSDIR%;c:\\jdk1.3.0_02\\jre\\lib\\rt.jar -d %CLASSDIR% \n%SRCDIR%\\be\\alcatel\\test\\*.java\n\nnotice that i use -depend (but it will also work without it)\nthe depend flag was also used in the build.xml file (see above)\n\nBest regards,\nPeter Van der Goten"}, {"count": 1, "tags": [], "bug_id": 2736, "text": "See the description for tha javac task: \n\n\"The source and destination directory will be recursively scanned for Java \nsource files to compile. Only Java files that have no corresponding class file \nor where the class file is older than the java file will be compiled.\n\nNote: Ant uses only the names of the source and class files to find the classes \nthat need a rebuild. It will not scan the source and therefor will have no \nknowledge about nested classes, classes that are named different from the \nsource file and so on.\"\n\nIf you call jikes and pass only the names of the files that are out of date -\ndepend will not help you: \n\n\"C:\\temp\\bug2736>type src\\be\\alcatel\\test\\TestConstsITF.java\npackage be.alcatel.test;\n\npublic interface TestConstsITF{\n   public static final int const1 = 11;\n}\n\nC:\\temp\\bug2736>jikes -depend -sourcepath %SRCDIR% -classpath .;%CLASSDIR%;c:\\jd\nk131\\jre\\lib\\rt.jar -d %CLASSDIR% %SRCDIR%\\be\\alcatel\\test\\TestConstsITF.java\n\nC:\\temp\\bug2736>java -cp classes be.alcatel.test.Test\nTestConstsITF.const1        = 10\nconst1                      = 10\nAnOtherTestConstsITF.const2 = 10\nconst2                      = 10\"\n\nPossible Solutions include: \n\n- Modify Ant to always pass all java-files it finds to the compiler (results in \nrecompile everything)\n- Delete the target files before compiling (results in recompile everything)\n- Use the depend-task (find dependencies, delete files which should be \nrecompiled although they are up-to-date (from a file-time perspective) and use \njavac to compile only missing/old files) \n\nThis: \n\n<?xml version=\"1.0\"?>\n<project default=\"main\">\n  <target name=\"main\">\n    <depend srcdir=\"src\"\n            destdir=\"classes\"\n            closure=\"true\"/>    \n    <javac srcdir=\"src\"\n           destdir=\"classes\"/>\n  </target>\n</project>\n\nshould work for you. \n\nNothing we can fix here, we could just slowdown ant. You are invited to come to \nant-user if you have further questions regarding the proposed solution. ", "id": 3934, "time": "2001-07-23T13:31:29Z", "creator": "nico@apache.org", "creation_time": "2001-07-23T13:31:29Z", "is_private": false, "attachment_id": null}]