[{"count": 0, "tags": [], "text": "Hello,\n\nThere is a problem with the Days360 class in POI (org.apache.poi.ss.formula.functions.Days360.class).\n\nThe result of the evaluation is not the same as the Excel method when the start date is the last day of february and the end date is the last day of the month:\nStart date: 02/28/2018\nEnd date: 03/31/2018\nResult in Excel: 30\nResult in Apache POI: 31\n\nThe problem is in the method getEndingDate: you should not be using realStart but the result of getStartingDate.\n\nHere is a solution:\n\n    private static double evaluate(double d0, double d1, boolean method) {\n        Calendar realStart = getDate(d0);\n        Calendar realEnd = getDate(d1);\n        int startingDate[] = getStartingDate(realStart, method);\n        int endingDate[] = getEndingDate(realEnd, startingDate, method);\n        return\n            (endingDate[0]*360+endingDate[1]*30+endingDate[2])-\n            (startingDate[0]*360+startingDate[1]*30+startingDate[2]);\n    }\n\n    private static int[] getEndingDate(Calendar realEnd, int startingDate[], boolean method) {\n        Calendar d = realEnd;\n        int yyyy = d.get(Calendar.YEAR);\n        int mm = d.get(Calendar.MONTH);\n        int dd = Math.min(30, d.get(Calendar.DAY_OF_MONTH));\n\n        if (method == false && realEnd.get(Calendar.DAY_OF_MONTH) == 31) {\n            if (startingDate[2] < 30) {\n                d.set(Calendar.DAY_OF_MONTH, 1);\n                d.add(Calendar.MONTH, 1);\n                yyyy = d.get(Calendar.YEAR);\n                mm = d.get(Calendar.MONTH);\n                dd = 1;\n            } else {\n                dd = 30;\n            }\n        }\n        \n        return new int[]{yyyy,mm,dd};\n    }", "is_private": false, "id": 193253, "creator": "julienhoueix@gmail.com", "time": "2016-08-22T09:39:08Z", "bug_id": 60029, "creation_time": "2016-08-22T09:39:08Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 60029, "attachment_id": null, "id": 193255, "time": "2016-08-22T11:08:57Z", "creator": "jmarkmurphy@apache.org", "creation_time": "2016-08-22T11:08:57Z", "is_private": false, "text": "(In reply to Julien Houeix from comment #0)\n> Hello,\n> \n> There is a problem with the Days360 class in POI\n> (org.apache.poi.ss.formula.functions.Days360.class).\n> \n> The result of the evaluation is not the same as the Excel method when the\n> start date is the last day of february and the end date is the last day of\n> the month:\n> Start date: 02/28/2018\n> End date: 03/31/2018\n> Result in Excel: 30\n> Result in Apache POI: 31\n\nI just tried this in Excel 2016, and it gave me 31. Maybe your build of Excel has a bug? 31 is indeed the correct answer."}, {"count": 2, "tags": [], "bug_id": 60029, "attachment_id": 34168, "id": 193256, "time": "2016-08-22T11:55:43Z", "creator": "julienhoueix@gmail.com", "creation_time": "2016-08-22T11:55:43Z", "is_private": false, "text": "Created attachment 34168\nResult in Excel 2016"}, {"count": 3, "tags": [], "creator": "julienhoueix@gmail.com", "attachment_id": null, "text": "I get 30 with several versions of Excel, including Excel 2016. I attached a screenshot.", "id": 193257, "time": "2016-08-22T11:57:18Z", "bug_id": 60029, "creation_time": "2016-08-22T11:57:18Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 60029, "attachment_id": null, "id": 193264, "time": "2016-08-22T14:47:08Z", "creator": "jmarkmurphy@apache.org", "creation_time": "2016-08-22T14:47:08Z", "is_private": false, "text": "Ok, I see what you are looking at."}, {"count": 5, "tags": [], "bug_id": 60029, "attachment_id": 34169, "is_private": false, "id": 193268, "time": "2016-08-22T16:13:52Z", "creator": "onealj@apache.org", "creation_time": "2016-08-22T16:13:52Z", "text": "Created attachment 34169\nFailing unit test\n\nI can confirm the described behavior is a bug in the latest trunk build (r1757092, pre-3.16). See attached failing test case.\n\nFor reference, Microsoft's official documentation for this function is here:\nhttps://support.office.com/en-us/article/DAYS360-function-B9A509FD-49EF-407E-94DF-0CBDA5718C2A\n\nDays360.java: https://svn.apache.org/viewvc/poi/trunk/src/java/org/apache/poi/ss/formula/functions/Days360.java\nTestDays360: https://svn.apache.org/viewvc/poi/trunk/src/testcases/org/apache/poi/ss/formula/functions/TestDays360.java"}, {"count": 6, "tags": [], "bug_id": 60029, "attachment_id": null, "is_private": false, "id": 194445, "time": "2016-10-15T06:57:12Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2016-10-15T06:57:12Z", "text": "Fixed via r1765018 with some additional adjustments to reduce the size of the code and fix IDE warnings. Also some more tests added."}]