[{"count": 0, "tags": [], "text": "The thread pooling support (apr_thread_pool.[ch]) did not follow the convention \nof apr-utils services using APU_DECLARE vs APR_DECLARE.\n\nAdded the following enhancements to the thread pooling support:\n\n1) Time out of idle threads vs hard idle_max reap.  Helps reduce thrashing\n   of threads when requests are receive in bursts and allows idle to be set\n   to zero w/o being penalized for thread create/destroy.\n2) More statistics (#of tasks processed, high water mark of queued tasks,\n   high water mark of threads, #of idle threads that timed out waiting for\n   work).\n\nThese updates are contained w/in diff files that will be attached momentarily.", "attachment_id": null, "id": 105377, "creator": "Joe.Mudd@sas.com", "time": "2007-07-13T07:57:36Z", "bug_id": 42889, "creation_time": "2007-07-13T07:57:36Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 42889, "attachment_id": 20503, "text": "Created attachment 20503\nsource updates", "id": 105378, "time": "2007-07-13T07:59:02Z", "creator": "Joe.Mudd@sas.com", "creation_time": "2007-07-13T07:59:02Z", "is_private": false}, {"count": 2, "tags": [], "text": "Created attachment 20504\nAPU_DECLARE and new stat prototypes", "attachment_id": 20504, "id": 105379, "creator": "Joe.Mudd@sas.com", "time": "2007-07-13T07:59:29Z", "bug_id": 42889, "creation_time": "2007-07-13T07:59:29Z", "is_private": false}, {"count": 3, "tags": [], "text": "Quick review. Why did you removed the doxygen group tags? Could you separate\nthe patches in three (APU_DECLARE, timeout, statistics)? Thanks.", "attachment_id": null, "id": 105382, "creator": "davi@apache.org", "time": "2007-07-13T08:08:43Z", "bug_id": 42889, "creation_time": "2007-07-13T08:08:43Z", "is_private": false}, {"count": 4, "tags": [], "creator": "Joe.Mudd@sas.com", "text": "I must have missed the group update.  I will resync the files and submit the \npatches separately as requested.\n\nDo I need to submit three different bug reports for the separated patches?  Or, \nis one bug ok?", "id": 105383, "time": "2007-07-13T08:12:05Z", "bug_id": 42889, "creation_time": "2007-07-13T08:12:05Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "text": "(In reply to comment #4)\n> I must have missed the group update.  I will resync the files and submit the \n> patches separately as requested.\n\nThanks.\n\n> Do I need to submit three different bug reports for the separated patches?  Or, \n> is one bug ok?\n\nJust this one is ok.", "attachment_id": null, "id": 105384, "creator": "davi@apache.org", "time": "2007-07-13T08:19:48Z", "bug_id": 42889, "creation_time": "2007-07-13T08:19:48Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 42889, "attachment_id": null, "is_private": false, "id": 105393, "time": "2007-07-13T09:03:27Z", "creator": "davi@apache.org", "creation_time": "2007-07-13T09:03:27Z", "text": "CC'ing the original author."}, {"count": 7, "tags": [], "creator": "henryjen@ztune.net", "attachment_id": null, "id": 105400, "time": "2007-07-13T13:48:49Z", "bug_id": 42889, "creation_time": "2007-07-13T13:48:49Z", "is_private": false, "text": "Nice. :-)\n\nOne question: since the total number of tasks processed(tasks_run) is collected\nover time and could overflow, would it better to collect in interval? Anyway,\nthat may not be a big concern.\n\nThe code stopping the timeout idle threads is not quite correct:\n\n1. The thread should only be joined when the thread is stopped in idle mode by\ntrim_idle_thread, i.e, when elt->stop is 1. Otherwise, the thread should be\ndetached and exit as no one would be there join the thread.\n\n2. The thd_timed_out should be increased for the thread to quit after time out,\nie. when elt->stop == 0. The code seems to have an unintended else with the if\nstatement.\n\n"}, {"count": 8, "tags": [], "bug_id": 42889, "text": "Oh, shoot!  Thanks!\n\nI'll make these changes before submitting the updated diffs.\n\nI'm assuming the diffs should contain:\n\n1) existing source to source w/APU updates\n2) source w/APU updates to source w/time out updates\n3) source w/APU & time out updates to source w/additional statistics\n", "id": 105401, "time": "2007-07-13T13:58:11Z", "creator": "Joe.Mudd@sas.com", "creation_time": "2007-07-13T13:58:11Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "creator": "Joe.Mudd@sas.com", "is_private": false, "text": "Created attachment 20505\napr_thread_pool.c.diff.apu  APU updates\n\nReplacing big attachments w/incremental attachments", "id": 105402, "time": "2007-07-13T14:24:56Z", "bug_id": 42889, "creation_time": "2007-07-13T14:24:56Z", "attachment_id": 20505}, {"count": 10, "tags": [], "bug_id": 42889, "attachment_id": 20506, "is_private": false, "id": 105403, "time": "2007-07-13T14:25:44Z", "creator": "Joe.Mudd@sas.com", "creation_time": "2007-07-13T14:25:44Z", "text": "Created attachment 20506\napr_thread_pool.c.diff.timeout Time out updates"}, {"attachment_id": 20507, "tags": [], "bug_id": 42889, "text": "Created attachment 20507\napr_thread_pool.c.diff.stats Statistics updates", "count": 11, "id": 105404, "time": "2007-07-13T14:26:16Z", "creator": "Joe.Mudd@sas.com", "creation_time": "2007-07-13T14:26:16Z", "is_private": false}, {"attachment_id": 20508, "tags": [], "bug_id": 42889, "is_private": false, "count": 12, "id": 105405, "time": "2007-07-13T14:26:43Z", "creator": "Joe.Mudd@sas.com", "creation_time": "2007-07-13T14:26:43Z", "text": "Created attachment 20508\napr_thread_pool.h.diff.apu APU updates"}, {"attachment_id": 20509, "tags": [], "bug_id": 42889, "is_private": false, "count": 13, "id": 105406, "time": "2007-07-13T14:27:06Z", "creator": "Joe.Mudd@sas.com", "creation_time": "2007-07-13T14:27:06Z", "text": "Created attachment 20509\napr_thread_pool.h.diff.timeout Time out updates"}, {"count": 14, "tags": [], "creator": "Joe.Mudd@sas.com", "is_private": false, "text": "Created attachment 20510\napr_thread_pool.h.diff.stats Statistics updates", "id": 105407, "time": "2007-07-13T14:27:39Z", "bug_id": 42889, "creation_time": "2007-07-13T14:27:39Z", "attachment_id": 20510}, {"count": 15, "tags": [], "bug_id": 42889, "text": "APU updates patch committed to trunk in revision 558527:\n\nhttp://svn.apache.org/viewvc?view=rev&revision=558527", "id": 105832, "time": "2007-07-22T12:30:14Z", "creator": "davi@apache.org", "creation_time": "2007-07-22T12:30:14Z", "is_private": false, "attachment_id": null}, {"count": 16, "tags": [], "text": "Created attachment 20539\ntimeout (idle wait) update\n\nThe earlier patch may miss the scheduled task if the idle_wait is set and\nidle_max is larger than 0. This updated patch should address the scheduled\ntask.\n\nThe patch also refactoring a bit to use a state rather than a boolean to signal\na thread's exit. This eliminate the additional code to quit the thread.", "attachment_id": 20539, "id": 105869, "creator": "henryjen@ztune.net", "time": "2007-07-23T19:48:59Z", "bug_id": 42889, "creation_time": "2007-07-23T19:48:59Z", "is_private": false}, {"count": 17, "tags": [], "creator": "henryjen@ztune.net", "text": "Created attachment 20540\nstats patch update\n\nA minor update to reflect changes on timeout", "id": 105870, "time": "2007-07-23T20:36:19Z", "bug_id": 42889, "creation_time": "2007-07-23T20:36:19Z", "is_private": false, "attachment_id": 20540}, {"count": 18, "tags": [], "creator": "Joe.Mudd@sas.com", "text": "Created attachment 20542\ntimeout (idle wait) update (typo correction)\n\nFix typo in apr_thread_pool_idle_wait_set() @param timeout documentation. \n'timeout' is microseconds... not milliseconds.\n\nAnd thanks for putting this together so quickly.", "id": 105882, "time": "2007-07-24T05:12:01Z", "bug_id": 42889, "creation_time": "2007-07-24T05:12:01Z", "is_private": false, "attachment_id": 20542}, {"count": 19, "tags": [], "bug_id": 42889, "attachment_id": null, "text": "I applied the latest patches and observed that once a thread was put on \nprobation, it was reaped even if it was woken up to process a task (vs actually \ntiming out).\n\nShouldn't a thread on probation that was woken to process a task have its state \ntransition back to run?\n\nThanks for your consideration.", "id": 105938, "time": "2007-07-25T06:53:40Z", "creator": "Joe.Mudd@sas.com", "creation_time": "2007-07-25T06:53:40Z", "is_private": false}, {"count": 20, "tags": [], "bug_id": 42889, "text": "I considered that, and I have no preference to either way.\n\nThe reason I left it out is because the thread will only stop after becoming\nidle again, i.e., no other tasks in the queue. While this most likely mean all\nother threads will be idle as well and unless the max_idle was changed, the\nthread need to be stopped anyway.\n\nMake sense?", "id": 105952, "time": "2007-07-25T22:34:11Z", "creator": "henryjen@ztune.net", "creation_time": "2007-07-25T22:34:11Z", "is_private": false, "attachment_id": null}, {"count": 21, "tags": [], "bug_id": 42889, "attachment_id": null, "text": "Yes, the implementation makes sense and I can go either way as well.\n\nMy comment was more of from a thread in hand position.  I was thinking that if \nthe thread didn't really timeout, then there must be enough work to keep it \nbusy and it should be given another chance to waste away.\n\nAs an aside, I updated the thread pool code to change the state from probation \nto run after a task had been processed.  In my use of the thread pool (~50 \nsecond run on dual core Wintel), giving an idle thread that woke up and did \nwork another chance changed the number of reaped idle threads from 28 to 17 and \nshaved around 4 seconds off of the run.\n\nThanks again for the implementation and your very prompt attention.", "id": 105959, "time": "2007-07-26T05:01:31Z", "creator": "Joe.Mudd@sas.com", "creation_time": "2007-07-26T05:01:31Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 42889, "is_private": false, "count": 22, "id": 108295, "time": "2007-09-17T13:51:17Z", "creator": "Joe.Mudd@sas.com", "creation_time": "2007-09-17T13:51:17Z", "text": "I haven't seen any activity since my last response.  Is more information still \nrequired?  Thanks."}, {"attachment_id": null, "tags": [], "bug_id": 42889, "is_private": false, "count": 23, "id": 110277, "time": "2007-11-06T12:50:54Z", "creator": "Joe.Mudd@sas.com", "creation_time": "2007-11-06T12:50:54Z", "text": "I believe this is ready to roll so I am reassigning back to the folks that \nhandle APR updates."}, {"count": 24, "tags": [], "creator": "wrowe@apache.org", "is_private": false, "text": "It's my understanding from Henry that these patches are no longer required\nas the patch for 43876 is now committed.  Please correct my understanding\nif this is not true.", "id": 116357, "time": "2008-05-07T12:51:11Z", "bug_id": 42889, "creation_time": "2008-05-07T12:51:11Z", "attachment_id": null}, {"count": 25, "tags": [], "text": "Your understanding is correct.  43876 included these fixes.", "attachment_id": null, "id": 116361, "creator": "Joe.Mudd@sas.com", "time": "2008-05-07T13:25:10Z", "bug_id": 42889, "creation_time": "2008-05-07T13:25:10Z", "is_private": false}]