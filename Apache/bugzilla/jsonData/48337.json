[{"count": 0, "text": "When Batik requests an image via the <image> element, I am seeing an accept request header like this:\n\nimage/png,image/jpeg,image/jpg,image/tiff,image/tif,image/gif,[Ljava.lang.String;@f429d7;\n\nNote the Java \"string array\" stuck on the end. This gives my Jersey/JAX-RS-based web service fits because it automatically calls the header invalid and returns 400 bad request.", "bug_id": 48337, "attachment_id": null, "id": 132608, "time": "2009-12-03T13:57:12Z", "creator": "daveray@gmail.com", "creation_time": "2009-12-03T13:57:12Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "creator": "daveray@gmail.com", "attachment_id": null, "is_private": false, "id": 132614, "time": "2009-12-03T17:13:58Z", "bug_id": 48337, "creation_time": "2009-12-03T17:13:58Z", "text": "FWIW, the bug appears to be in SVGImageElementBridge.openStream() (line 409 on the trunk):\n\n   List mimeTypes = new ArrayList\n            (ImageTagRegistry.getRegistry().getRegisteredMimeTypes());\n   mimeTypes.add(MimeTypeConstants.MIME_TYPES_SVG);\n\nNote that MIME_TYPES_SVG is an *array* of strings which is added directly to the end of the list of mimeTypes. This explains the \"[Ljava.lang.String;@f429d7;\" that I'm seeing in the Accept header.\n\nI think the fix is simply to replace the add with:\n\n   mimeTypes.addAll(Arrays.asList(MimeTypeConstants.MIME_TYPES_SVG));\n\nDave"}, {"text": "First of all, thanks for taking the time to report and chase the issue! :-)\n\n\n(In reply to comment #1)\n> FWIW, the bug appears to be in SVGImageElementBridge.openStream() (line 409 on\n> the trunk):\n>    List mimeTypes = new ArrayList\n>             (ImageTagRegistry.getRegistry().getRegisteredMimeTypes());\n>    mimeTypes.add(MimeTypeConstants.MIME_TYPES_SVG);\n\nAs a matter of curiosity, I've made a quick crawl through that piece of code and it has been untouched for a while (i.e., it's probably a bug which has been sitting there for a long time, not a recent regression AFAIK). It's even somehow curious how this has slipped through until now... ;-)\n\n\n> Note that MIME_TYPES_SVG is an *array* of strings which is added directly to\n> the end of the list of mimeTypes. This explains the\n> \"[Ljava.lang.String;@f429d7;\" that I'm seeing in the Accept header.\n> \n> I think the fix is simply to replace the add with:\n> \n>    mimeTypes.addAll(Arrays.asList(MimeTypeConstants.MIME_TYPES_SVG));\n\nThe fix seems reasonable. Have you tested it? Are you able to submit the fix proposal in patch format instead? (Actually, I'm a lot more interested in the first question; if you need help with converting it to a patch, in order to ease review, I'll be more than willing to help you with that.)", "tags": [], "bug_id": 48337, "is_private": false, "count": 2, "id": 132624, "time": "2009-12-06T13:49:41Z", "creator": "helder.magalhaes@gmail.com", "creation_time": "2009-12-06T13:49:41Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 48337, "attachment_id": 24672, "id": 132628, "time": "2009-12-06T17:40:55Z", "creator": "daveray@gmail.com", "creation_time": "2009-12-06T17:40:55Z", "is_private": false, "text": "Created attachment 24672\nTested patch that includes the suggested fix."}, {"count": 4, "tags": [], "creator": "daveray@gmail.com", "attachment_id": null, "id": 132629, "time": "2009-12-06T17:46:45Z", "bug_id": 48337, "creation_time": "2009-12-06T17:46:45Z", "is_private": false, "text": "(In reply to comment #2)\n> First of all, thanks for taking the time to report and chase the issue! :-)\n\nNo problem. For a while there, I thought I was going mad. :)\n\n> (In reply to comment #1)\n> > FWIW, the bug appears to be in SVGImageElementBridge.openStream() (line 409 on\n> > the trunk):\n> >    List mimeTypes = new ArrayList\n> >             (ImageTagRegistry.getRegistry().getRegisteredMimeTypes());\n> >    mimeTypes.add(MimeTypeConstants.MIME_TYPES_SVG);\n> \n> As a matter of curiosity, I've made a quick crawl through that piece of code\n> and it has been untouched for a while (i.e., it's probably a bug which has been\n> sitting there for a long time, not a recent regression AFAIK). It's even\n> somehow curious how this has slipped through until now... ;-)\n\nIt seems that nothing else is as picky as Jersey is about this header so I guess it will only affect people that are serving non-static images through Jersey.... I guess I'm in an exclusive club.\n\n> > Note that MIME_TYPES_SVG is an *array* of strings which is added directly to\n> > the end of the list of mimeTypes. This explains the\n> > \"[Ljava.lang.String;@f429d7;\" that I'm seeing in the Accept header.\n> > \n> > I think the fix is simply to replace the add with:\n> > \n> >    mimeTypes.addAll(Arrays.asList(MimeTypeConstants.MIME_TYPES_SVG));\n> \n> The fix seems reasonable. Have you tested it? Are you able to submit the fix\n> proposal in patch format instead? (Actually, I'm a lot more interested in the\n> first question; if you need help with converting it to a patch, in order to\n> ease review, I'll be more than willing to help you with that.)\n\nI've tested the fix (it works) and submitted a patch.\n\nIn case anyone else has this problem before the next Batik release, my temporary workaround is a servlet filter that scrubs the accept header before it gets to the Jersey servlet."}, {"count": 5, "tags": [], "creator": "helder.magalhaes@gmail.com", "attachment_id": null, "is_private": false, "id": 132643, "time": "2009-12-07T03:13:45Z", "bug_id": 48337, "creation_time": "2009-12-07T03:13:45Z", "text": "(In reply to comment #4)\n> It seems that nothing else is as picky as Jersey is about this header so I\n> guess it will only affect people that are serving non-static images through\n> Jersey.... I guess I'm in an exclusive club.\n\n:-D\n\n\n> I've tested the fix (it works) and submitted a patch.\n\nGreat, thanks. :-)\n\nThomas, I've also reviewed the fix and it seems rather simple and reasonable. Could this be taken a look at?\n\nIn the meantime, I've added metadata to the bug in order to reflect the fact that a patch is available."}, {"count": 6, "tags": [], "creator": "deweese@apache.org", "attachment_id": null, "id": 132689, "time": "2009-12-09T03:52:38Z", "bug_id": 48337, "creation_time": "2009-12-09T03:52:38Z", "is_private": false, "text": "Fixed in rev 888773.\nThanks!"}]