[{"count": 0, "tags": [], "bug_id": 54651, "attachment_id": null, "text": "I have confirmed a bug in mod_remoteip.c's remoteip_modify_request function.\n\nThis bug was reported by yoshinori.ehara@gmail.com in 2012 in this thread:\n\nhttp://mail-archives.apache.org/mod_mbox/httpd-users/201210.mbox/%3CCAHa2qaJSW7Hvk68grWMbbiFSA=zAxQ1nr_-A-K-pDWbAB0Gd1Q@mail.gmail.com%3E\n\nThe bug appears to still be in httpd/trunk.\n\nThe bug here is that, even though temp_sa gets assigned to a new IP with every iteration of the while-loop, the apr_ipsubnet_test continues to check the list of proxy match_ip against the same connection IP (using c->client_addr) over and over again.  Thus, if c->client_addr matches, the code always walks to the very beginning of the X-Forwarded-For header.\n\n\n--- modules/metadata/mod_remoteip.c\t(revision 1407459)\n+++ modules/metadata/mod_remoteip.c\t(working copy)\n@@ -246,16 +246,16 @@\n     temp_sa = c->client_addr;\n\n     while (remote) {\n\n-        /* verify c->client_addr is trusted if there is a trusted proxy list\n+        /* verify temp_sa is trusted if there is a trusted proxy list\n          */\n         if (config->proxymatch_ip) {\n             int i;\n             remoteip_proxymatch_t *match;\n             match = (remoteip_proxymatch_t *)config->proxymatch_ip->elts;\n             for (i = 0; i < config->proxymatch_ip->nelts; ++i) {\n-                if (apr_ipsubnet_test(match[i].ip, c->client_addr)) {\n+                if (apr_ipsubnet_test(match[i].ip, temp_sa)) {\n                     internal = match[i].internal;\n                     break;\n                 }\n             }\n\nThe fix is to replace apr_ipsubnet_test(match[i].ip, c->client_addr) with apr_ipsubnet_test(match[i].ip, temp_sa) , and to correct the mention of c->client_addr comment.  Once fixed, the module works great.\n\n\nTo reproduce this bug, you have to setup mod_remoteip with these directives:\n\nRemoteIPHeader X-Forwarded-For\nRemoteIPInternalProxy 127.0.0.1\n\nThen, hit make two requests:\n\n1) curl --header 'X-Forwarded-For: 1.2.3.4' http://localhost:80/\n2) curl --header 'X-Forwarded-For: 1.2.3.4, 5.6.7.8' http://localhost:80/\n\nFor (1) the r->useragent_ip logged is expected to be 1.2.3.4 .  The code behaves correctly for this case.\n\nFor (2) the r->useragent_ip logged should be 5.6.7.8 .  The current code logs 1.2.3.4 still.  This is not the behavior as documented because 5.6.7.8 is not configured to be \"trusted\".\n\nEugeneL", "id": 165706, "time": "2013-03-07T01:25:50Z", "creator": "eugenel@amazon.com", "creation_time": "2013-03-07T01:25:50Z", "is_private": false}, {"count": 1, "tags": [], "creator": "mike.rumph@oracle.com", "is_private": false, "text": "Hello Eugene,\n\nThanks for pointing out this bug report on the Apache httpd dev mailing list.\nIt answers a mystery I had with regard to bug 55635.\nAs you can see in comment 1 (of 55635), I submitted results that were somewhat different from those of the bug reporter.\nIn comment 3, I gave an explanation of the bug reporter's results.\nBut that did not explain my own results.\n\nOnce I applied your patch from this bug, my results matched those of the bug reporter in 55635.\nIt appears that the bug reporter in 55635 had the patch for 54651 applied.\nSo I confirm that your patch is indeed valid and useful.\n\nSince I am a relatively new developer (1 year) for the Apache httpd project, I do not have committer access.\nPerhaps there is a committer who is interested in mod_remoteip that will consider committing the 54651 patch to trunk.\n\n\nThanks again,\n\nMike Rumph", "id": 171775, "time": "2013-12-16T19:12:12Z", "bug_id": 54651, "creation_time": "2013-12-16T19:12:12Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 54651, "attachment_id": 31174, "is_private": false, "id": 172115, "time": "2014-01-06T16:30:50Z", "creator": "mike.rumph@oracle.com", "creation_time": "2014-01-06T16:30:50Z", "text": "Created attachment 31174\nPatch to use correct IP address for trusted proxy comparison.\n\nWorked the patch in the bug description as an attachment.\nThis patch is an essential fix for mod_remoteip to function properly.\nThis fix should be receiving some attention.\n\nWithout this fix the remoteip_modify_request() function in mod_remoteip.c will not be using the correct IP address for comparison against the trusted proxy list when the RemoteIPHeader header value is a list.\nThe first pass of the while will work correctly,\nbut the subsequent passes will not."}, {"count": 3, "tags": [], "bug_id": 54651, "attachment_id": null, "id": 172880, "time": "2014-02-03T21:33:42Z", "creator": "mike.rumph@oracle.com", "creation_time": "2014-02-03T21:33:42Z", "is_private": false, "text": "Committed to trunk in https://svn.apache.org/viewvc?view=revision&revision=1564052 and proposed for httpd 2.4.x."}, {"count": 4, "tags": [], "creator": "mike.rumph@oracle.com", "attachment_id": null, "text": "Backported to httpd 2.4.8 by r1569006.", "id": 173306, "time": "2014-02-17T16:55:00Z", "bug_id": 54651, "creation_time": "2014-02-17T16:55:00Z", "is_private": false}]