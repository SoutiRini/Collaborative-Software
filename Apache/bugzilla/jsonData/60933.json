[{"attachment_id": null, "tags": [], "bug_id": 60933, "text": "When you create a new thread on the fly by the new API 'addNewThread', at the end of the run, JMeter don't wait them before stop.\n\nWich cause this error by example :\n\nTidying up ...    @ Wed Mar 29 13:36:29 UTC 2017 (1490794589776)\n... end of run\nsummary +     10 in 00:00:00 =   43.5/s Avg:   203 Min:   125 Max:   288 Err:     9 (90.00%) Active: 49 Started: 50 Finished: 1\nsummary =  76747 in 00:26:40 =   48.0/s Avg:   238 Min:     2 Max:  8034 Err: 33021 (43.03%)\nThe JVM should have exited but did not.\nThe following non-daemon threads are still running (DestroyJavaVM is OK):\nThread[milesSimulator 1-28,5,main], stackTrace:java.lang.Thread#sleep\njava.lang.Thread#sleep at line:340\njava.util.concurrent.TimeUnit#sleep at line:386\norg.apache.jmeter.threads.JMeterThread#delay at line:863\norg.apache.jmeter.threads.JMeterThread#executeSamplePackage at line:474\norg.apache.jmeter.threads.JMeterThread#processSampler at line:425\norg.apache.jmeter.threads.JMeterThread#run at line:254\njava.lang.Thread#run at line:745", "count": 0, "id": 198057, "time": "2017-03-29T14:38:48Z", "creator": "mchassagneux@apache.org", "creation_time": "2017-03-29T14:38:48Z", "is_private": false}, {"count": 1, "tags": [], "creator": "mchassagneux@apache.org", "is_private": false, "id": 198077, "attachment_id": null, "bug_id": 60933, "creation_time": "2017-03-30T08:57:49Z", "time": "2017-03-30T08:57:49Z", "text": "The problem is that JMeter wait for threads stop with looping on allThreads map ( see @ThreadGroup => waitThreadsStopped() method )\nThis map is initiate by the StandardJMeterEngine, and the loop is not updated on the fly when a new thread is added.\n\nA quick fix is to check if the map is not empty and iterate again like this : \n\n        while ( !allThreads.isEmpty() ) {\n            for (Thread t : allThreads.values()) {\n                waitThreadStopped(t);\n            }\n        }\n\nAny advice to fix it ?"}, {"count": 2, "tags": [], "bug_id": 60933, "text": "Fix in Revision 1795544\n\nhttp://svn.apache.org/viewvc?view=revision&revision=1795544", "id": 198816, "time": "2017-05-18T16:38:47Z", "creator": "mchassagneux@apache.org", "creation_time": "2017-05-18T16:38:47Z", "is_private": false, "attachment_id": null}]