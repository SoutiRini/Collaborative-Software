[{"count": 0, "tags": [], "bug_id": 54702, "attachment_id": null, "is_private": false, "id": 165853, "time": "2013-03-15T08:53:36Z", "creator": "jeanmarie.lamare@free.fr", "creation_time": "2013-03-15T08:53:36Z", "text": "Hello\n\nI think I've found a file descriptor leak in file /tomcat/trunk/java/org/apache/catalina/startup/ContextConfig.java (method getGlobalWebXmlSource).\n\nA stream is from file \"web.xml\" is not closed.\n\nprivate WebXml getDefaultWebXmlFragment() {\n... \n\n1284\t        InputSource globalWebXml = getGlobalWebXmlSource();\n...\n1337\t            // Parse global web.xml if present\n1338\t            if (globalWebXml == null) {\n1339\t                // This is unusual enough to log\n1340\t                log.info(sm.getString(\"contextConfig.defaultMissing\"));\n1341\t            } else {\n1342\t                parseWebXml(globalWebXml, webXmlDefaultFragment, false);\n1343\t            }\n\nHere is the full stack trace\n\n[java.io.FileInputStream.<init>(FileInputStream.java:109)] [org.apache.catalina.startup.ContextConfig.getWebXmlSource(ContextConfig.java:1837)] [org.apache.catalina.startup.ContextConfig.getGlobalWebXmlSource(ContextConfig.java:1744)] [org.apache.catalina.startup.ContextConfig.getDefaultWebXmlFragment(ContextConfig.java:1417)] [org.apache.catalina.startup.ContextConfig.webConfig(ContextConfig.java:1253)] [org.apache.catalina.startup.ContextConfig.configureStart(ContextConfig.java:878)] [org.apache.catalina.startup.ContextConfig.lifecycleEvent(ContextConfig.java:369)] [org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:119)] [org.apache.catalina.util.LifecycleBase.fireLifecycleEvent(LifecycleBase.java:90)] [org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:5173)] [org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:150)] [org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:901)] [org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:877)] [org.apache.catalina.core.StandardHost.addChild(StandardHost.java:633)] [org.apache.catalina.startup.HostConfig.deployWAR(HostConfig.java:977)] [org.apache.catalina.startup.HostConfig.deployApps(HostConfig.java:542)] [org.apache.catalina.startup.HostConfig.check(HostConfig.java:1462)] [sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)] [sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)] [sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)] [java.lang.reflect.Method.invoke(Method.java:597)] [org.apache.tomcat.util.modeler.BaseModelMBean.invoke(BaseModelMBean.java:301)] [com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.invoke(DefaultMBeanServerInterceptor.java:836)] [com.sun.jmx.mbeanserver.JmxMBeanServer.invoke(JmxMBeanServer.java:761)] [org.apache.catalina.manager.ManagerServlet.check(ManagerServlet.java:1445)] [org.apache.catalina.manager.HTMLManagerServlet.upload(HTMLManagerServlet.java:301)] [org.apache.catalina.manager.HTMLManagerServlet.doPost(HTMLManagerServlet.java:208)] [javax.servlet.http.HttpServlet.service(HttpServlet.java:647)] [javax.servlet.http.HttpServlet.service(HttpServlet.java:728)] [org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:305)] [org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)] [org.apache.catalina.filters.CsrfPreventionFilter.doFilter(CsrfPreventionFilter.java:213)] [org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:243)] [org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)] [org.apache.catalina.filters.SetCharacterEncodingFilter.doFilter(SetCharacterEncodingFilter.java:108)] [org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:243)] [org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)] [org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:222)] [org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:123)] [org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:581)] [org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)] [org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:99)] [org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:931)] [org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)] [org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:407)] [org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1004)] [org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:589)] [org.apache.tomcat.util.net.AprEndpoint$SocketProcessor.run(AprEndpoint.java:1822)] [java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)] [java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)] [java.lang.Thread.run(Thread.java:662)]"}, {"count": 1, "tags": [], "creator": "violetagg@apache.org", "attachment_id": null, "id": 165854, "time": "2013-03-15T09:27:49Z", "bug_id": 54702, "creation_time": "2013-03-15T09:27:49Z", "is_private": false, "text": "Hi,\n\nDid you observe that in some real situation?\n\nBasically the following is specified for org.xml.sax.InputSource [1]\n\n\"However, standard processing of both byte and character streams is to close them on as part of end-of-parse cleanup, so applications should not attempt to re-use such streams after they have been handed to a parser.\"\n\n\nRegards\nVioleta\n[1] http://docs.oracle.com/javase/6/docs/api/"}, {"count": 2, "tags": [], "bug_id": 54702, "text": "Hello\n\nThe following file are opened after a WAR deployment on my computer (I've used the command handle written by the sys internal team).\n\njava.exe pid: 3984 CASTCORP\\JML\n    C: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\bin\n   54: File  (R-D)   C:\\TEMP\\hsperfdata_jml\\3984\n   5C: Section       \\Sessions\\1\\BaseNamedObjects\\hsperfdata_JML_3984\n   E0: File  (RW-)   C:\\java\\jdk1.6.0_35_x64\\jre\\lib\\rt.jar\n  1E8: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\bin\\bootstrap.jar\n  1EC: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\bin\\commons-daemon.jar\n  1F0: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\bin\\tomcat-juli.jar\n  1F4: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\logs\\catalina.2013-03-15.log\n  1F8: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\logs\\localhost.2013-03-15.log\n  1FC: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\logs\\manager.2013-03-15.log\n  200: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\logs\\host-manager.2013-03-15.log\n  204: File  (RW-)   C:\\java\\jdk1.6.0_35_x64\\jre\\lib\\jsse.jar\n  208: File  (RW-)   C:\\java\\jdk1.6.0_35_x64\\jre\\lib\\ext\\dnsns.jar\n  20C: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\annotations-api.jar\n  210: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\catalina-ant.jar\n  214: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\catalina-ha.jar\n  218: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\catalina-tribes.jar\n  21C: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\catalina.jar\n  220: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\ecj-3.7.2.jar\n  224: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\el-api.jar\n  228: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\jasper-el.jar\n  22C: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\jasper.jar\n  230: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\jsp-api.jar\n  234: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\servlet-api.jar\n  238: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\tomcat-api.jar\n  23C: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\tomcat-coyote.jar\n  240: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\tomcat-dbcp.jar\n  244: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\tomcat-i18n-es.jar\n  248: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\tomcat-i18n-fr.jar\n  24C: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\tomcat-i18n-ja.jar\n  250: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\tomcat-jdbc.jar\n  254: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\lib\\tomcat-util.jar\n  27C: File  (RW-)   C:\\java\\jdk1.6.0_35_x64\\jre\\lib\\ext\\localedata.jar\n  288: File  (RW-)   C:\\java\\jdk1.6.0_35_x64\\jre\\lib\\resources.jar\n  304: File  (RW-)   C:\\java\\jdk1.6.0_35_x64\\jre\\lib\\jce.jar\n  308: File  (RW-)   C:\\java\\jdk1.6.0_35_x64\\jre\\lib\\ext\\sunjce_provider.jar\n  31C: File  (R-D)   C:\\Windows\\System32\\en-US\\KernelBase.dll.mui\n  338: File  (RW-)   C:\\java\\jdk1.6.0_35_x64\\jre\\lib\\charsets.jar\n  33C: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\logs\\localhost_access_log.2013-03-15.txt\n  354: File  (RW-)   C:\\java\\jdk1.6.0_35_x64\\jre\\lib\\charsets.jar\n  440: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\conf\\web.xml\n  454: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\conf\\web.xml\n  964: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\temp\\system4547162881526958771.jar\n  990: File  (RW-)   C:\\java\\apache-tomcat-7.0.33\\temp\\bootstrap5643731443438317122.jar\n  9A8: File  (RW-)   C:\\workspaces\\pmc_Contrex\\jvmagent\\jvmagent.jar\n\nSo the sys internal utility observes it in a real situation.\n\nI've discoverer this bug thanks a JVM agent which rewrites FileInputStream and FileOutputStream bytecodes. \nThis one ensures that FileInputStream.close is called after the constructor invocation.", "id": 165856, "time": "2013-03-15T10:33:34Z", "creator": "jeanmarie.lamare@free.fr", "creation_time": "2013-03-15T10:33:34Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "jeanmarie.lamare@free.fr", "attachment_id": null, "id": 165857, "time": "2013-03-15T11:47:15Z", "bug_id": 54702, "creation_time": "2013-03-15T11:47:15Z", "is_private": false, "text": "Is the bugs due to a missing close call there ?\n\n1312\t        if (entry != null && entry.getGlobalTimeStamp() == globalTimeStamp &&\n1313\t                entry.getHostTimeStamp() == hostTimeStamp) {\n1314\t            return entry.getWebXml();\n1315\t        }\n...\n1321\t            entry = hostWebXmlCache.get(host);\n1322\t            if (entry != null && entry.getGlobalTimeStamp() == globalTimeStamp &&\n1323\t                    entry.getHostTimeStamp() == hostTimeStamp) {\n1324\t                return entry.getWebXml();\n1325\t            }\n\nSometimes, the web.xml file is not parsed and the stream is not closed"}, {"count": 4, "tags": [], "bug_id": 54702, "attachment_id": null, "is_private": false, "id": 165863, "time": "2013-03-15T15:11:52Z", "creator": "violetagg@apache.org", "creation_time": "2013-03-15T15:11:52Z", "text": "Thanks for the report.\nFixed in trunk and 7.0.x and will be included in 7.0.39 onwards."}]