[{"count": 0, "tags": [], "bug_id": 61840, "attachment_id": null, "id": 202509, "creation_time": "2017-12-01T11:41:14Z", "time": "2017-12-01T11:41:14Z", "creator": "miaposta21_@hotmail.com", "text": "If you have a cell with a formula with some references (eg. \"=(B5-C5)/B5\") and you shift the row with Sheet.shiftRows(int,int,int) (eg. sheet.shiftRows(4,4,-1)) you lose the references and get \"=(#REF!-#REF!)/#REF!\").", "is_private": false}, {"count": 1, "tags": [], "text": "What version of Apache POI are you using? If it isn't the latest, what happens when you upgrade? (We've done quite a few fixes in this area lately)", "attachment_id": null, "bug_id": 61840, "id": 202512, "time": "2017-12-01T12:26:11Z", "creator": "apache@gagravarr.org", "creation_time": "2017-12-01T12:26:11Z", "is_private": false}, {"count": 2, "tags": [], "creator": "miaposta21_@hotmail.com", "attachment_id": null, "id": 202517, "time": "2017-12-01T14:23:40Z", "bug_id": 61840, "creation_time": "2017-12-01T14:23:40Z", "is_private": false, "text": "I'm using 3.17. It's the latest if I'm not mistaken. While I'm here I add the following issue: please make sure that references contained in the formula are updated when rows are shifted (same as when you copy paste formulas in Excel) and also when cells are copied. Because now, if you copy paste a formula from a cell into another cell with cell.setCellType(CellType.FORMULA); setCellFormula(anotherCell.getCellFormula()); formula is treated as a mere string and references are not updated."}, {"count": 3, "tags": [], "bug_id": 61840, "attachment_id": null, "id": 202520, "time": "2017-12-01T17:27:02Z", "creator": "onealj@apache.org", "creation_time": "2017-12-01T17:27:02Z", "is_private": false, "text": "This works for me in the latest version of POI (and probably also 3.17).\nYou will get #REF! errors if you shift references above the 1st row in the workbook, which is the same behavior as Excel.\n\nYou are getting #REF! errors likely from one of two scenarios:\n1) Formula: \"(B1-C1)/B1\", shiftRows(x, x, -1)\n2) Formula: \"(B5-C5)/B5\", shiftRows(x, x, -5)\n\nI wrote this unit test to test POI's functionality:\n@Test\npublic void test61840_shifting_rows_up_does_not_produce_REF_errors() throws Exception {\n    Workbook wb = _testDataProvider.createWorkbook();\n    Sheet sheet = wb.createSheet();\n    Cell cell = sheet.createRow(4).createCell(0);\n    cell.setCellFormula(\"(B5-C5)/B5\");\n    sheet.shiftRows(4, 4, -1);\n    Cell shiftedCell = sheet.getRow(3).getCell(0);\n    assertNotNull(shiftedCell);\n    assertEquals(\"(B4-C4)/B4\", shiftedCell.getCellFormula());\n}"}, {"count": 4, "tags": [], "bug_id": 61840, "attachment_id": null, "id": 202521, "creation_time": "2017-12-01T17:34:04Z", "time": "2017-12-01T17:34:04Z", "creator": "onealj@apache.org", "text": "(In reply to Luca from comment #2)\n> setCellFormula(anotherCell.getCellFormula()); formula is treated as a mere\n> string and references are not updated.\n\nsetCellFormula intentionally does not shift the formula that is pasted into it. It sets the cell formula as is.\nPerhaps what you're looking for is a function that copies a cell value from another cell, and if the source cell contains a formula, to shift that formula. Currently POI only contains methods to copy entire rows (Sheet.copyRows). Adding capability for copying just a cell is a good idea, and should be captured on a new bug.", "is_private": false}, {"count": 5, "tags": [], "creator": "onealj@apache.org", "attachment_id": null, "id": 202522, "time": "2017-12-01T17:48:16Z", "bug_id": 61840, "creation_time": "2017-12-01T17:48:16Z", "is_private": false, "text": "Added a unit test in r1816892."}]