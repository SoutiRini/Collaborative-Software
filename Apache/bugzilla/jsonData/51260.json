[{"count": 0, "tags": [], "bug_id": 51260, "attachment_id": null, "text": "Because of a logical condition ordering issue in ServerCookie.java, setting ALLOW_HTTP_SEPARATORS_IN_V0=true does not work 100% of the time.\n\nHere's a patch:\n\nIndex: java/org/apache/tomcat/util/http/ServerCookie.java\n===================================================================\n--- java/org/apache/tomcat/util/http/ServerCookie.java  (revision 1127279)\n+++ java/org/apache/tomcat/util/http/ServerCookie.java  (working copy)\n@@ -289,10 +289,8 @@\n             buf.append('\"');\n             buf.append(escapeDoubleQuotes(value,1,value.length()-1));\n             buf.append('\"');\n-        } else if (CookieSupport.isHttpToken(value) &&\n-                !CookieSupport.ALLOW_HTTP_SEPARATORS_IN_V0 ||\n-                CookieSupport.isV0Token(value) &&\n-                CookieSupport.ALLOW_HTTP_SEPARATORS_IN_V0) {\n+        } else if ((!CookieSupport.ALLOW_HTTP_SEPARATORS_IN_V0 && CookieSupport.isHttpToken(value)) ||\n+                   (CookieSupport.ALLOW_HTTP_SEPARATORS_IN_V0 && CookieSupport.isV0Token(value))) {\n             buf.append('\"');\n             buf.append(escapeDoubleQuotes(value,0,value.length()));\n             buf.append('\"');\n\n(added some parentheses in there as per tongue-in-cheek discussion on tomcat users list)", "id": 146606, "time": "2011-05-24T21:37:02Z", "creator": "dcheckoway@gmail.com", "creation_time": "2011-05-24T21:37:02Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 51260, "attachment_id": null, "id": 146607, "creation_time": "2011-05-24T21:39:55Z", "time": "2011-05-24T21:39:55Z", "creator": "dcheckoway@gmail.com", "text": "BTW, I forgot to mention a key piece of info...the code \"works\" as is, but the problem occurs when isHttpToken->isHttpSeparator throws an exception when it encounters a control character.\n\nIf ALLOW_HTTP_SEPARATORS_IN_V0 is set to true, that code should never get invoked in the first place (at least not imho).", "is_private": false}, {"count": 2, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 146612, "time": "2011-05-25T07:25:14Z", "bug_id": 51260, "creation_time": "2011-05-25T07:25:14Z", "is_private": false, "text": "Control characters are never valid in an HTTP header. The code is working as designed.\n\nA change to provide a better log message in this case (i.e. so suitable copy of the problematic header is included in the exception message) would be a reasonable enhancement request."}, {"count": 3, "tags": [], "bug_id": 51260, "attachment_id": null, "id": 146622, "creation_time": "2011-05-25T12:47:17Z", "time": "2011-05-25T12:47:17Z", "creator": "dcheckoway@gmail.com", "text": "Mark, from an efficiency standpoint alone, I still think those logical conditions should be reordered in the code (i.e. don't bother invoking isHttpToken if separators are allowed). \n\nIt just happens that a byproduct of that fix would be that it fixes my issue as well...  :-)\n\nBut I'd definitely appreciate a more informative message if that's possible.", "is_private": false}]