[{"count": 0, "tags": [], "bug_id": 54625, "is_private": false, "text": "When registering a new User defined function as described here:\n\nhttp://poi.apache.org/spreadsheet/user-defined-functions.html\n\nIn the case of the HSSF workbook\n\ndoing this:\n\nworkbook.addToolPack(udfToolpack);\n\nadds the udfToolpack to a static variable. \n\nAt the very least this could cause a bit of a memory leak, and in my case when dealing with multiple workbooks in a single process, that have different implementations for a particular UDF name, this statefulness means that the first one registered is the one that always gets used.\n\nI suggest changing this\n\nprivate UDFFinder _udfFinder = UDFFinder.DEFAULT;\n\nto this\n\nprivate IndexedUDFFinder _udfFinder = new IndexedUDFFinder(UDFFinder.DEFAULT);\n\nin org.apache.poi.hssf.usermodel.HSSFWorkbook\n\nIn the meantime, a suitable workaround for this issue is to create your own implementation of a workbook factory, and when you create a HSSFWorkbook, use reflection to set the appropriate value to the _udfFinder private variable.", "id": 165560, "time": "2013-03-01T03:18:12Z", "creator": "stuart.donald@ibboost.com", "creation_time": "2013-03-01T03:18:12Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 54625, "attachment_id": null, "text": "If anybody needs it, here is the workaround that I use\n\npublic class POIWorkbookFactory {\n\n\tpublic static Workbook create(InputStream inp) throws Exception {\n\t\tWorkbook workbook = WorkbookFactory.create(inp);\n\t\tif (workbook instanceof HSSFWorkbook) {\n\t\t\tField field = HSSFWorkbook.class.getDeclaredField(\"_udfFinder\");\n\t\t\tfield.setAccessible(true);\n\t\t\tfield.set(workbook, new IndexedUDFFinder(UDFFinder.DEFAULT));\n\t\t}\n\t\treturn workbook;\n\t}\n\n}", "id": 165561, "time": "2013-03-01T03:29:29Z", "creator": "stuart.donald@ibboost.com", "creation_time": "2013-03-01T03:29:29Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 54625, "attachment_id": null, "id": 165599, "time": "2013-03-03T16:16:36Z", "creator": "yegor@dinom.ru", "creation_time": "2013-03-03T16:16:36Z", "is_private": false, "text": "Fix applied in r1452060\n\nI had to move IndexedUDFFinder to the common package org.apache.poi.ss.formula.udf, otherwise HSSF did not compile. \n\nRegards,\nYegor"}]