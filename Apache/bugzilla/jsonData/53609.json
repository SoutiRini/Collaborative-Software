[{"count": 0, "text": "We have an apache module which handles all the http request from the client and update those data into our mysql database.\n\nAll the request data be on plain/text and some of in binary dump. We did a performance test on the module by creating more POST request to hit the apache module.\n\nThe current test hits with 100 concurrent request to the apache all the time through out the day with a 1 min gap between the request.\n\nOur MPM worker config is:\n\nThreadLimit 200\nStartServers 3\nMaxRequestWorkers 150\nMinSpareThreads 50\nMaxSpareThreads 200\nThreadsPerChild 150\nMaxRequestsPerChild 0\n\n\nIn between the test apache get hangs into the state with <defunt > . From there it is not able to process the any of the request.\n\nCore Dump Info:\n\nCore was generated by `/usr/local/apache2/bin/httpd -k start'.\nProgram terminated with signal 6, Aborted.\n[New process 8667]\n[New process 8919]\n[New process 8918]\n[New process 8917]\n[New process 8916]\n[New process 8915]\n[New process 8914]\n[New process 8913]\n[New process 8912]\n[New process 8911]\n[New process 8910]\n[New process 8909]\n[New process 8908]\n[New process 8907]\n[New process 8906]\n[New process 8905]\n[New process 8904]\n[New process 8903]\n[New process 8902]\n[New process 8901]\n[New process 8900]\n[New process 8899]\n[New process 8898]\n[New process 8897]\n[New process 8896]\n[New process 8895]\n[New process 8894]\n[New process 8893]\n[New process 8892]\n[New process 8891]\n[New process 8890]\n[New process 8889]\n[New process 8888]\n[New process 8887]\n[New process 8886]\n[New process 8885]\n[New process 8884]\n[New process 8883]\n[New process 8882]\n[New process 8881]\n[New process 8880]\n[New process 8879]\n[New process 8878]\n[New process 8877]\n[New process 8876]\n[New process 8875]\n[New process 8874]\n[New process 8873]\n[New process 8872]\n[New process 8871]\n[New process 8870]\n[New process 8869]\n[New process 8868]\n[New process 8867]\n[New process 8866]\n[New process 8865]\n[New process 8864]\n[New process 8863]\n[New process 8862]\n[New process 8861]\n[New process 8860]\n[New process 8859]\n[New process 8858]\n[New process 8857]\n[New process 8856]\n[New process 8855]\n[New process 8854]\n[New process 8853]\n[New process 8852]\n[New process 8851]\n[New process 8850]\n[New process 8849]\n[New process 8848]\n[New process 8847]\n[New process 8846]\n[New process 8845]\n[New process 8844]\n[New process 8843]\n[New process 8842]\n[New process 8841]\n[New process 8840]\n[New process 8839]\n[New process 8838]\n[New process 8837]\n[New process 8836]\n[New process 8835]\n[New process 8834]\n[New process 8833]\n[New process 8832]\n[New process 8831]\n[New process 8830]\n[New process 8829]\n[New process 8828]\n[New process 8827]\n[New process 8826]\n[New process 8825]\n[New process 8824]\n[New process 8823]\n[New process 8822]\n[New process 8821]\n[New process 8820]\n[New process 8819]\n[New process 8818]\n[New process 8817]\n[New process 8816]\n[New process 8815]\n[New process 8814]\n[New process 8813]\n[New process 8812]\n[New process 8811]\n[New process 8810]\n[New process 8809]\n[New process 8808]\n[New process 8807]\n[New process 8806]\n[New process 8805]\n[New process 8804]\n[New process 8803]\n[New process 8802]\n[New process 8801]\n[New process 8800]\n[New process 8799]\n[New process 8798]\n[New process 8797]\n[New process 8796]\n[New process 8795]\n[New process 8794]\n[New process 8793]\n[New process 8792]\n[New process 8791]\n[New process 8790]\n[New process 8789]\n[New process 8788]\n[New process 8787]\n[New process 8786]\n[New process 8785]\n[New process 8784]\n[New process 8783]\n[New process 8782]\n[New process 8781]\n[New process 8780]\n[New process 8779]\n[New process 8778]\n[New process 8777]\n[New process 8776]\n[New process 8775]\n[New process 8774]\n[New process 8773]\n[New process 8772]\n[New process 8771]\n[New process 8770]\n[New process 8769]\n[New process 8768]\n[New process 8767]\n[New process 8766]\n[New process 8765]\n[New process 8764]\n[New process 8763]\n[New process 8762]\n[New process 8761]\n[New process 8760]\n[New process 8759]\n[New process 8758]\n[New process 8757]\n[New process 8756]\n[New process 8755]\n[New process 8754]\n[New process 8753]\n[New process 8752]\n[New process 8751]\n[New process 8750]\n[New process 8749]\n[New process 8748]\n[New process 8747]\n[New process 8746]\n[New process 8745]\n[New process 8744]\n[New process 8743]\n[New process 8742]\n[New process 8741]\n[New process 8740]\n[New process 8739]\n[New process 8738]\n[New process 8737]\n[New process 8736]\n[New process 8735]\n[New process 8734]\n[New process 8733]\n[New process 8732]\n[New process 8731]\n[New process 8730]\n[New process 8729]\n[New process 8728]\n[New process 8727]\n[New process 8726]\n[New process 8725]\n[New process 8724]\n[New process 8723]\n[New process 8722]\n[New process 8721]\n[New process 8720]\n[New process 8719]\n[New process 8718]\n[New process 8717]\n[New process 8716]\n[New process 8715]\n[New process 8714]\n[New process 8713]\n[New process 8712]\n[New process 8711]\n[New process 8710]\n[New process 8709]\n[New process 8708]\n[New process 8707]\n[New process 8706]\n[New process 8705]\n[New process 8704]\n[New process 8703]\n[New process 8702]\n[New process 8701]\n[New process 8700]\n[New process 8699]\n[New process 8698]\n[New process 8697]\n[New process 8696]\n[New process 8695]\n[New process 8694]\n[New process 8693]\n[New process 8692]\n[New process 8691]\n[New process 8690]\n[New process 8689]\n[New process 8688]\n[New process 8687]\n[New process 8686]\n[New process 8685]\n[New process 8684]\n[New process 8683]\n[New process 8682]\n[New process 8681]\n[New process 8680]\n[New process 8679]\n[New process 8678]\n[New process 8677]\n[New process 8676]\n[New process 8675]\n[New process 8674]\n[New process 8673]\n[New process 8672]\n[New process 8671]\n[New process 8670]\n[New process 8669]\n#0  0x00000035b420d5cb in read () from /lib64/libpthread.so.0\n(gdb) bt full\n#0  0x00000035b420d5cb in read () from /lib64/libpthread.so.0\nNo symbol table info available.\n#1  0x00002aaab590cb91 in ap_worker_pod_check (pod=0x72da960) at pod.c:57\n        c = 7 '\\a'\n        fd = 7\n        rc = 0\n#2  0x00002aaab5908fa7 in child_main (child_num_arg=0) at worker.c:1332\n        threads = (apr_thread_t **) 0x7350e90\n        rv = 0\n        ts = (thread_starter *) 0x7351670\n        thread_attr = (apr_threadattr_t *) 0x73516a0\n        start_thread_id = (apr_thread_t *) 0x7351720\n#3  0x00002aaab5909149 in make_child (s=0x730f210, slot=0) at worker.c:1417\n        pid = 0\n#4  0x00002aaab590986a in perform_idle_server_maintenance () at worker.c:1618\n        i = 0\n        j = 250\n        idle_thread_count = 0\n        ws = (worker_score *) 0x2b5b7a806358\n        ps = (process_score *) 0x2b5b7a7f7020\n        free_length = 1\n        totally_free_length = 1\n        free_slots = {0, 0, 120648208, 0, 676492864, 32767, 4399419, 0, -1216176009, 10922, 65350085, -1732919508, -1283343424, 53, -1280786531, 53, 676492952, 32767, -1280520480, 53, 0, 0, \n  0, 0, 0, 0, 0, 0, 0, 0, 676492864, 32767}\n        last_non_dead = 0\n        total_non_dead = 1\n        active_thread_count = 0\n#5  0x00002aaab5909ba4 in server_main_loop (remaining_children_to_start=0) at worker.c:1739\n        old_gen = 119249696\n        child_slot = 0\n        exitwhy = 6\n        status = 6\n        processed_status = 0\n        pid = {pid = -1, in = 0x7fff28529a96, out = 0x730f210, err = 0x71edcb0}\n        i = 250\n#6  0x00002aaab5909f78 in worker_run (_pconf=0x71b9b50, plog=0x71edcb0, s=0x730f210) at worker.c:1810\n        remaining_children_to_start = 0\n        rv = 0\n---Type <return> to continue, or q <return> to quit---\n#7  0x0000000000430d36 in ap_run_mpm (pconf=0x71b9b50, plog=0x71edcb0, s=0x730f210) at mpm_common.c:96\n        pHook = (ap_LINK_mpm_t *) 0x7234930\n        n = 0\n        rv = -1\n#8  0x0000000000429761 in main (argc=3, argv=0x7fff28527ad8) at main.c:777\n        c = 0 '\\0'\n        showcompile = 0\n        showdirectives = 0\n        confname = 0x474073 \"conf/httpd.conf\"\n        def_server_root = 0x474083 \"/usr/local/apache2\"\n        temp_error_log = 0x0\n        error = 0x0\n        process = (process_rec *) 0x71b9b20\n        pconf = (apr_pool_t *) 0x71b9b50\n        plog = (apr_pool_t *) 0x71edcb0\n        ptemp = (apr_pool_t *) 0x72c4040\n        pcommands = (apr_pool_t *) 0x71d8680\n        opt = (apr_getopt_t *) 0x71edc40\n        rv = 0\n        mod = (module **) 0x68fa18\n        opt_arg = 0x2b5b796066a0 \"\u00d6\u00ecA\"\n        signal_server = (apr_OFN_ap_signal_server_t *) 0x4604af <ap_signal_server>", "bug_id": 53609, "attachment_id": null, "id": 160933, "time": "2012-07-27T10:26:28Z", "creator": "talk2.vino@gmail.com", "creation_time": "2012-07-27T10:26:28Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "id": 160934, "time": "2012-07-27T11:26:46Z", "bug_id": 53609, "creation_time": "2012-07-27T11:26:46Z", "is_private": false, "text": "What does your error log say?  What's the backtrace of the thread that crashed?\n\n\"thread apply all bt full\" and post the suspicious one."}, {"count": 2, "tags": [], "bug_id": 53609, "attachment_id": null, "id": 160943, "time": "2012-07-27T13:09:25Z", "creator": "talk2.vino@gmail.com", "creation_time": "2012-07-27T13:09:25Z", "is_private": false, "text": "Apologize previous core info was with other pid. Here is the right one.\n\nThe Error Log says:\n===================\n[Thu Jul 26 22:38:55.033453 2012] [core:notice] [pid 30703:tid 47671878384272] AH00051: child pid 26692 exit signal Aborted (6), possible coredump in /piroot/apache2-gdb-dump\napr_table_mergen: key not in ancestor pool of t\n[Thu Jul 26 22:43:42.038833 2012] [core:notice] [pid 30703:tid 47671878384272] AH00051: child pid 6351 exit signal Aborted (6), possible coredump in /piroot/apache2-gdb-dump\napr_table_mergen: key not in ancestor pool of t\n\n\nAttached the core dump of thread apply all bt full.\n\nIn the dump we removed the sql statements and the client Ipaddr."}, {"count": 3, "tags": [], "bug_id": 53609, "attachment_id": 29121, "id": 160944, "time": "2012-07-27T13:11:34Z", "creator": "talk2.vino@gmail.com", "creation_time": "2012-07-27T13:11:34Z", "is_private": false, "text": "Created attachment 29121\nIts a complete core dump"}, {"count": 4, "text": "#5  0x00002b5b793d9d2e in apr_table_mergen (t=0x2aab180d29b0, key=0x48169c \"Connection\", val=0x481704 \"Keep-Alive\") at tables/apr_tables.c:739\n\tnext_elt = <value optimized out>\n\tend_elt = <value optimized out>\n\tchecksum = <value optimized out>\n\thash = <value optimized out>\n#6  0x0000000000468898 in ap_set_keepalive (r=0x2aab181b9a60) at http_protocol.c:249", "bug_id": 53609, "attachment_id": null, "id": 160945, "time": "2012-07-27T13:17:16Z", "creator": "covener@gmail.com", "creation_time": "2012-07-27T13:17:16Z", "tags": [], "is_private": false}, {"count": 5, "tags": [], "creator": "rpluem@apache.org", "text": "I guess this is a bug in APR:\n\nCan you please test the following patch:\n\nIndex: tables/apr_tables.c\n===================================================================\n--- tables/apr_tables.c (revision 1366342)\n+++ tables/apr_tables.c (working copy)\n@@ -730,15 +730,18 @@\n     apr_table_entry_t *next_elt;\n     apr_table_entry_t *end_elt;\n     apr_uint32_t checksum;\n+    apr_pool_t *pool;\n     int hash;\n\n #if APR_POOL_DEBUG\n     {\n-       if (!apr_pool_is_ancestor(apr_pool_find(key), t->a.pool)) {\n+    pool = apr_pool_find(key);\n+       if ((pool != key) && (!apr_pool_is_ancestor(pool, t->a.pool))) {\n            fprintf(stderr, \"apr_table_mergen: key not in ancestor pool of t\\n\");\n            abort();\n        }\n-       if (!apr_pool_is_ancestor(apr_pool_find(val), t->a.pool)) {\n+    pool = apr_pool_find(val);\n+       if ((pool != val) && (!apr_pool_is_ancestor(pool, t->a.pool))) {\n            fprintf(stderr, \"apr_table_mergen: val not in ancestor pool of t\\n\");\n            abort();\n        }", "id": 160949, "time": "2012-07-27T14:31:20Z", "bug_id": 53609, "creation_time": "2012-07-27T14:31:20Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 53609, "text": "Thanks for the patch ruediger. I started the test with the patch against our module.\n\nI keep you posted if its gets solved our issue.", "count": 6, "id": 160954, "time": "2012-07-28T05:08:39Z", "creator": "talk2.vino@gmail.com", "creation_time": "2012-07-28T05:08:39Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 53609, "attachment_id": null, "id": 160955, "time": "2012-07-28T07:46:30Z", "creator": "talk2.vino@gmail.com", "creation_time": "2012-07-28T07:46:30Z", "is_private": false, "text": "we again hit with the same error in the patch too while testing. It is not happened immediately. It occurs during one to two hours of our test and makes the apache to hang at one stage.\n\nPlease let me know whats the real issue with APR table mergen/addn functions. Why its is behave in that manner when he hit with higher concurrency (100).\n\nAny help to overcome is greatly appreciated."}, {"count": 8, "tags": [], "bug_id": 53609, "attachment_id": 29123, "text": "Created attachment 29123\nError log of the patch apr_table.c\n\nApache2 error logs", "id": 160956, "time": "2012-07-28T07:48:39Z", "creator": "talk2.vino@gmail.com", "creation_time": "2012-07-28T07:48:39Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 53609, "text": "Found one interesting in the error log .apache2 gets restarted every time when the worker getting shutdown when it caught SIGTERM. While worker is getting shutting down we don't have any core dump associated with that.\n\nI set the maxreqworker is 150. The concurrency hit to the apache is always less than the maxreqworker config.\n\nIs this the expected behaviour?", "id": 160976, "attachment_id": null, "creator": "talk2.vino@gmail.com", "creation_time": "2012-07-29T04:37:43Z", "time": "2012-07-29T04:37:43Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 53609, "text": "(In reply to comment #7)\n> we again hit with the same error in the patch too while testing. It is not\n> happened immediately. It occurs during one to two hours of our test and\n> makes the apache to hang at one stage.\n\nI cannot see that you hit the same error again. You still have segfaults / aborts, but you don't have the \"key not in ancestor pool of \" any longer in the log. This means that the patch works and resolved one of your issues.", "count": 10, "id": 160996, "time": "2012-07-30T09:11:00Z", "creator": "rpluem@apache.org", "creation_time": "2012-07-30T09:11:00Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 53609, "text": "(In reply to comment #10)\n> (In reply to comment #7)\n> > we again hit with the same error in the patch too while testing. It is not\n> > happened immediately. It occurs during one to two hours of our test and\n> > makes the apache to hang at one stage.\n> \n> I cannot see that you hit the same error again. You still have segfaults /\n> aborts, but you don't have the \"key not in ancestor pool of \" any longer in\n> the log. This means that the patch works and resolved one of your issues.\n\nThe patch was committed as r1367050.", "count": 11, "id": 161000, "time": "2012-07-30T12:27:47Z", "creator": "rpluem@apache.org", "creation_time": "2012-07-30T12:27:47Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 53609, "text": "We see those error \"key not in ancestor pool of t\"  in the attached Error logs\n\n===============\n[Fri Jul 27 21:36:59.029498 2012] [core:notice] [pid 449:tid 47538503809680] AH00094: Command line: '/usr/local/apache2/bin/httpd'\napr_table_mergen: key not in ancestor pool of t\n[Fri Jul 27 22:29:38.067056 2012] [core:notice] [pid 449:tid 47538503809680] AH00051: child pid 1083 exit signal Aborted (6), possible coredump in /piroot/apache2-gdb-dump\napr_table_mergen: key not in ancestor pool of t\n[Fri Jul 27 22:50:13.089987 2012] [core:notice] [pid 449:tid 47538503809680] AH00051: child pid 23412 exit signal Aborted (6), possible coredump in /piroot/apache2-gdb-dump\napr_table_addn: val not in ancestor pool of t\n[Fri Jul 27 22:50:22.091015 2012] [core:notice] [pid 449:tid 47538503809680] AH00051: child pid 32280 exit signal Aborted (6), possible coredump in /piroot/apache2-gdb-dump\n*** glibc detected *** /usr/local/apache2/bin/httpd: double free or corruption (!prev): 0x00002aab90008b30 ***\n*** glibc detected *** /usr/local/apache2/bin/httpd: double free or corruption (!prev): 0x00002aab90008b30 ***\n*** glibc detected *** /usr/local/apache2/bin/httpd: double free or corruption (!prev): 0x00002aab90008b30 ***\n*** glibc detected *** /usr/local/apache2/bin/httpd: double free or corruption (!prev): 0x00002aab90008b30 ***\n*** glibc detected *** /usr/local/apache2/bin/httpd: double free or corruption (!prev): 0x00002aab90008b30 ***\n*** glibc detected *** /usr/local/apache2/bin/httpd: double free or corruption (!prev): 0x00002aab90008b30 ***\n[Fri Jul 27 22:50:33.091944 2012] [core:notice] [pid 449:tid 47538503809680] AH00051: child pid 32614 exit signal Segmentation fault (11), possible coredump in /piroot/apache2-gdb-dump\napr_table_addn: val not in ancestor pool of t\n[Fri Jul 27 22:50:54.093086 2012] [core:notice] [pid 449:tid 47538503809680] AH00051: child pid 525 exit signal Aborted (6), possible coredump in /piroot/apache2-gdb-dump\napr_table_mergen: key not in ancestor pool of t\n[Fri Jul 27 23:19:04.121667 2012] [core:notice] [pid 449:tid 47538503809680] AH00051: child pid 959 exit signal Aborted (6), possible coredump in /piroot/apache2-gdb-dump\napr_table_addn: val not in ancestor pool of t\n[Fri Jul 27 23:35:08.139140 2012] [core:notice] [pid 449:tid 47538503809680] AH00051: child pid 13036 exit signal Aborted (6), possible coredump in /piroot/apache2-gdb-dump\n\n===============\n\nToday we tried out the prefork mpm for the test instead of worker mpm. In that we dont see any aborts and seg faults in the test and also the error \"key not in ancestor pool of t\".\n\nIs there is anything associated with the issue in worker mpm.\n\nWhen we hit with the issue while in worker mpm the backtrace always say something that releated to worker.c file\n\nIs there any other information that you need from my side.", "id": 161010, "attachment_id": null, "creator": "talk2.vino@gmail.com", "creation_time": "2012-07-30T16:31:52Z", "time": "2012-07-30T16:31:52Z", "is_private": false}, {"count": 13, "attachment_id": null, "bug_id": 53609, "is_private": false, "id": 167017, "time": "2013-05-03T19:33:02Z", "creator": "sf@sfritsch.de", "creation_time": "2013-05-03T19:33:02Z", "tags": [], "text": "1.5 commit: r1368813\n1.4 commit: r1368817"}]