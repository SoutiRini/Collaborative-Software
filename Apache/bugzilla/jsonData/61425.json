[{"count": 0, "tags": [], "bug_id": 61425, "is_private": false, "id": 200324, "attachment_id": null, "creator": "wangzheng@cmss.chinamobile.com", "creation_time": "2017-08-16T12:47:16Z", "time": "2017-08-16T12:47:16Z", "text": "In my application, I use spring boot framework, and I choose \"Tomcat JDBC Pool\" as my connection pool, what I have configured is as follows.\n\nspring.datasource.type=org.apache.tomcat.jdbc.pool.DataSource\nspring.datasource.url=jdbc:postgresql://localhost:5432/test\nspring.datasource.tomcat.driverClassName=org.postgresql.Driver\nspring.datasource.tomcat.username=admin\nspring.datasource.tomcat.password=admin\nspring.datasource.tomcat.initialSize=15\nspring.datasource.tomcat.min-idle=15\nspring.datasource.tomcat.maxActive=30\nspring.datasource.tomcat.max-idle=30\nspring.datasource.tomcat.maxWait=300000\nspring.datasource.tomcat.timeBetweenEvictionRunsMillis=30000\nspring.datasource.tomcat.minEvictableIdleTimeMillis=60000\nspring.datasource.tomcat.removeAbandoned=true\nspring.datasource.tomcat.removeAbandonedTimeout=900\nspring.datasource.tomcat.logAbandoned=true\n\nspring.datasource.tomcat.testWhileIdle=true\nspring.datasource.tomcat.validationQuery=SELECT 1\nspring.datasource.tomcat.validationInterval=60000\nspring.datasource.tomcat.default-auto-commit=false\n\nThen I run my application, 60 seconds later, all the database connections become into \"<IDLE> in transaction\".\n\nWhy does this happen? I look into the \"PooledConnection.java\" source code, and I get the reason.\n\nIn the above configuration, I set the \"testWhileIdle\" to \"true\", so every connection in the pool will be tested to see if it is idle, using the specified SQL \"SELECT 1\".\nAfter executing the SQL, the connection does not call commit() or rollback(). We know that if the connection is auto committed, this is OK.\nBut because I set the \"defaultAutoCommit\" to \"false\", so the connection will not be committed automatically, and so the connection will always stay in the status of \"<IDLE> in transaction\", and I think this is incorrect."}, {"count": 1, "tags": [], "bug_id": 61425, "text": "Created attachment 35232\nAttaching a simple patch to commit/rollback the connection.", "id": 200325, "attachment_id": 35232, "creator": "wangzheng@cmss.chinamobile.com", "creation_time": "2017-08-16T12:49:19Z", "time": "2017-08-16T12:49:19Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 61425, "text": "Comment on attachment 35232\nAttaching a simple patch to commit/rollback the connection.\n\ndiff --git a/org/apache/tomcat/jdbc/pool/PooledConnection.java b/org/apache/tomcat/jdbc/pool/PooledConnection.java\nindex c833209..4615abf 100644\n--- a/org/apache/tomcat/jdbc/pool/PooledConnection.java\n+++ b/org/apache/tomcat/jdbc/pool/PooledConnection.java\n@@ -541,6 +541,22 @@ public class PooledConnection {\n             }\n             if (stmt!=null)\n                 try { stmt.close();} catch (Exception ignore2){/*NOOP*/}\n+\n+            try {\n+                if(!connection.getAutoCommit()) {\n+                    connection.rollback();\n+                }\n+            } catch (SQLException e) {\n+                // do nothing\n+            }\n+        } finally {\n+            try {\n+                if(!connection.getAutoCommit()) {\n+                    connection.commit();\n+                }\n+            } catch (SQLException e) {\n+                // do nothing\n+            }\n         }\n         return false;\n     } //validate", "id": 200326, "time": "2017-08-16T12:51:08Z", "creator": "wangzheng@cmss.chinamobile.com", "creation_time": "2017-08-16T12:51:08Z", "is_private": false, "attachment_id": 35232}, {"count": 3, "tags": [], "creator": "wangzheng@cmss.chinamobile.com", "is_private": false, "text": "Created attachment 35233\nuse this patch instead\n\nSorry, there are some mistakes in the previous patch, please use one instead.", "id": 200327, "time": "2017-08-16T13:00:14Z", "bug_id": 61425, "creation_time": "2017-08-16T13:00:14Z", "attachment_id": 35233}, {"count": 4, "tags": [], "bug_id": 61425, "is_private": false, "text": "admin=# select current_query from pg_stat_activity where usename='admin';\n     current_query     \n-----------------------\n <IDLE> in transaction\n <IDLE> in transaction\n <IDLE> in transaction\n <IDLE> in transaction\n <IDLE> in transaction\n <IDLE> in transaction\n <IDLE> in transaction\n <IDLE> in transaction\n <IDLE> in transaction\n <IDLE> in transaction\n <IDLE> in transaction\n <IDLE> in transaction\n <IDLE> in transaction\n <IDLE> in transaction\n <IDLE> in transaction\n(15 rows)\n\nThe above is queried the database.", "id": 200329, "time": "2017-08-16T13:11:07Z", "creator": "wangzheng@cmss.chinamobile.com", "creation_time": "2017-08-16T13:11:07Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 61425, "text": "Thanks for the patch.\nThe fix will be in :\n- 9.0.x for 9.0.0.M27 onwards\n- 8.5.x for 8.5.21 onwards\n- 8.0.x for 8.0.47 onwards\n- 7.0.x for 7.0.82 onwards", "id": 200423, "attachment_id": null, "creator": "kfujino@apache.org", "creation_time": "2017-08-23T08:16:17Z", "time": "2017-08-23T08:16:17Z", "is_private": false}]