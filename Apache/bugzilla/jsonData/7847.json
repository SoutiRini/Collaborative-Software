[{"count": 0, "tags": [], "bug_id": 7847, "attachment_id": null, "text": "Hello,\n\nTo start with Some Background follows\n\nWe are using Apache 1.3.24 as a reverse proxy server with caching enabled for\nsome internal web sites.  \n\nWe discovered that when we attempt to force a reload of the web page from the\norigin server using our web browser, we are simply getting back a blank page.\nThis problem is reproducable.\n\nThis works in IE 5.5 and Mozilla 0.9.9 and Netscape 4.79.\nTo issue the reload from the origin server from IE 5.5, type \"Ctrl-F5\".\nTo issue the reload from the origin server from Mozilla and Netscape, hold\n\"Ctrl\" and click the \"Reload\" button. By doing this, it sets \"Cache-Control\" in\nthe HTTP/1.1 request to \"No cache\".\n\nWe found that this only works when the origin server is MS IIS 4.0. When the\norigin server is an Apache server, the web page is refreshed from the cache of\nthe reverse proxy server.\n\nMore Detailed Information\n\nThe Internal origin server is an MS IIS 4.0 for www.dreo.dnd.ca.  This will work\nfor any page that is cached on the reverse proxy server.  The page we will use\nfor testing is http://www.dreo.dnd.ca/ which has already been previously cached\non the reverse proxy server.\n\nUsing a sniffer on the reverse proxy server we determined what the HTTP/1.1\nrequest was from the browser client:\n\nGET / HTTP/1.1\nAccept: */*\nAccept-Language: en-us\nAccept-Encoding:  gzip, deflate\nUser-Agent: Mozilla/4.0 (compatible; MSIE.5.5; Windows.NT 4.0)\nHost: www.dreo.dnd.ca.\nConnection: Keep-Alive\nCache-Control: no-cache\n\nWhen the reverse proxy receives this request it forwards it onto the internal\norigin server with a couple of additional fields (why does it send an HTTP/1.0\nrequest instead of the original HTTP/1.1 request?) :\n\nGET / HTTP/1.0\nHost: www.dreo.dnd.ca\nAccept: */*\nAccept-Encoding: gzip, deflate\nAccept-Language: en-us\nCache-Control: no-cache \nUser-Agent: Mozilla/4.0 (compatible; MSIE 5.5; Windows NT 4.0)\nIf-Modified-Since: Wed, 08 Nov 2000 18:10:04 GMT\nIf-None-Match: \"c077721eaf49c01:1364\"\nX-Forwarded-For: xxx.xxx.244.1\nConnection: close\n\nThe origin server then returns the following:\n\nHTTP/1.1\n304 Not Modified\nServer: Microsoft-IIS/4.0 \nDate: Thu, 04 Apr 2002 16:05:15 GMT\nContent-Location: http://www.dreo.dnd.ca/index.html \nETag: \"c077721eaf49c01:1364\"\nContent-Length: 0\n\nThis \"304 Not Modified\" is then cached on the reverse proxy server and the\nfollowing is served back to the client with no HTML content from the previously\ncached page (a blank page is displayed as a result):\n\nHTTP/1.1\n200 OK\nDate: Thu, 04 Apr 2002 16:05:34 GMT\nServer: Apache/1.3.24 (Unix)\nAccept-Ranges: bytes\nContent-Length: 0\nContent-Location: http://www.dreo.dnd.ca/index.html\nContent-Type: text/html\nETag:.\"c077721eaf49c01:1364\"\nLast-Modified: Wed, 08 Nov 2000 18:10:04 GMT\nX-Cache: HIT from www.dreo.dnd.ca (with.revalidation)\nKeep-Alive: timeout=15, max=100\nConnection: Keep-Alive\n\nWhen the Internal origin server is Apache, the difference in the \"304 Not\nModified\" returned to the reverse proxy server is there is no \"Content-Length:\n0\" header returned.\n\nThe error_log file (with debugging enabled) on the reverse proxy server shows\nthe following:\n\n[Fri Apr  5 15:51:37 2002] [debug] proxy_cache.c(1018): Request for\nhttp://www.dreo.dnd.ca/, pragma_req=(null), ims=0\n[Fri Apr  5 15:51:37 2002] [debug] proxy_util.c(1373): File\n/var/proxy/drdc/3G/mQ/sM/deHkd@zRyf3ADajA not found\n[Fri Apr  5 15:51:37 2002] [debug] proxy_cache.c(1271): Local copy not present\nor expired. Declining.\n[Fri Apr  5 15:51:38 2002] [debug] proxy_cache.c(1457): Expiry date is 0\n[Fri Apr  5 15:51:38 2002] [debug] proxy_cache.c(1468): Expiry date calculated\n1018126298\n[Fri Apr  5 15:51:38 2002] [debug] proxy_cache.c(1575): Create temporary file\n/var/proxy/drdc/tmpN80355\n[Fri Apr  5 15:51:38 2002] [debug] proxy_http.c(537): Content-Type: text/html\n\n\n[Fri Apr  5 15:51:51 2002] [debug] proxy_cache.c(1018): Request for\nhttp://www.dreo.dnd.ca/, pragma_req=(null), ims=0\n[Fri Apr  5 15:51:51 2002] [debug] proxy_cache.c(1271): Local copy not present\nor expired. Declining.\n[Fri Apr  5 15:51:51 2002] [debug] proxy_cache.c(1441): Reusing cached last modified\n[Fri Apr  5 15:51:51 2002] [debug] proxy_cache.c(1457): Expiry date is 0\n[Fri Apr  5 15:51:51 2002] [debug] proxy_cache.c(1468): Expiry date calculated\n1018126311\n\n\nThe access_log shows the following on the reverse proxy server:\n\nxxx.xxx.244.1 - - [05/Apr/2002:15:51:38 -0500] \"GET / HTTP/1.1\" 200 2557\nxxx.xxx.244.1 - - [05/Apr/2002:15:51:51 -0500] \"GET / HTTP/1.1\" 200 0\n\nIf you think that there is something else that you need from us to debug this\nlet me know.\n\nThanks\nRobert Tovell\nRobert.Tovell@nrns.ca", "id": 13052, "time": "2002-04-08T18:11:56Z", "creator": "Robert.Tovell@nrns.ca", "creation_time": "2002-04-08T18:11:56Z", "is_private": false}, {"count": 1, "tags": [], "text": "So far it looks like an IIS bug: The 304 response from IIS should not include\n\"content-length: 0\". Busy checking though.\n\n(If proxy is sending HTTP/1.0 requests to the backend, then you're probably not\nrunning apache 1.3.24)\n", "attachment_id": null, "id": 13517, "creation_time": "2002-04-14T19:47:13Z", "time": "2002-04-14T19:47:13Z", "creator": "minfrin@sharp.fm", "bug_id": 7847, "is_private": false}, {"count": 2, "tags": [], "bug_id": 7847, "is_private": false, "id": 13518, "creation_time": "2002-04-14T20:01:07Z", "time": "2002-04-14T20:01:07Z", "creator": "minfrin@sharp.fm", "text": "Apparently this is an IIS bug.\n\nWhen your browser specified \"no-cache\" to the proxy, what it meant was \"please\nrevalidate this data before returning it to me\". So, the proxy sent a\nconditional request to the IIS server with the \"If-None-Match\" header. The IIS\nserver responded correctly saying 304 Not Modified, which means \"in answer to\nyour question, no, the data was not modified, so your cached data is correct,\nsend it as is along with these changes in headers\". One of the headers that was\nchanged was the content-length header, which was set to zero. So Apache sent a\nresponse back with a zero content-length, thus your blank page.\n", "attachment_id": null}, {"count": 3, "tags": [], "text": "Quick question: Do you know whether this is a known bug in IIS?\n\nAside from the fact that this is an IIS problem, shouldn't the proxy server\nignore any additional entity-headers (ie. Content-Length) when a \"304 Not\nModified\" is encountered if the origin server mistakenly puts them in? \n\nThanks.", "attachment_id": null, "bug_id": 7847, "id": 13680, "time": "2002-04-15T19:56:13Z", "creator": "Robert.Tovell@nrns.ca", "creation_time": "2002-04-15T19:56:13Z", "is_private": false}]