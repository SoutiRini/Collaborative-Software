[{"count": 0, "tags": [], "bug_id": 52225, "is_private": false, "text": "There is an error in the fix for Bug 42707\n(\"add host alias using jmx doesn't take affect until restart\")\n\nIn Mapper#addHostAlias(String name, String alias)\nthe following line:\n   newHost.object = realHost;\n\nshould be replaced with the following one:\n   newHost.object = realHost.object;\n\nThat was r712467 (3 years ago). The issue affects current 5.5.x and 6.0.x as well.\n\nThe issue manifests itself only if addAlias() is called on an existing Host in embedded scenario or through JMX. The usual workflow of configuring aliases in server.xml is not affected.\n\n\n\nThe issue was reported on the dev@ list,\nhttp://tomcat.markmail.org/thread/sskxor4a3xtrjmk3\n\"Multiple Aliases Problem\"\n\nReproduction recipe #1, as reported on dev@:\n\n<quote>\n  I created a Host instance with the localhost1 domain name.\n\n  Host host = new StandardHost();\n  host.setAppBase(CATALINA_HOSTS_HOME);\n  host.setName(\"localhost1\");\n  host.setDeployOnStartup(false);\n  host.setBackgroundProcessorDelay(5);\n  host.setAutoDeploy(false);\n  host.setRealm(engine.getRealm());\n  engine.addChild(host);\n\n  Then I added the localhost2 as a alias.\n\n  host.addAlias(\"localhost2\");\n\n  If I entered localhost1 at a browser then it works fine but if I entered localhost2 at the browser then I got an error:\n\nNov 21, 2011 1:29:26 PM org.apache.coyote.http11.AbstractHttp11Processor process SEVERE: Error processing request java.lang.ClassCastException:\n  org.apache.tomcat.util.http.mapper.Mapper$Host\n  cannot be cast to org.apache.catalina.Host\nat org.apache.catalina.connector.Request.getHost(Request.java:631)\nat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:105) \n</quote>\n\nA workaround for the embedded scenario should be to reorder the calls as following:\n  host.addAlias(\"localhost2\");\n  engine.addChild(host);\n\nThat will call Mapper.addHost(String name, String[] aliases, Object host) which processes aliases correctly.\n\n\nReproduction recipe #2, using JMX:\n\n1. In standard server.xml replace\n <Engine defaultHost=\"localhost\" with <Engine defaultHost=\"foohost\"\n <Host name=\"localhost\" with <Host name=\"foohost\"\n2. Start Tomcat\n3. Open http://localhost:8080/  It opens correctly\n4. Start JConsole and connect to Tomcat\n5. In Catalina -> Host -> foohost -> Operations\ncall addAlias(localhost)\n6. Refresh http://localhost:8080/  Expected result: It opens correctly\nActual result:\n- Blank page\n- Exception in the logs,\n[[[\n22.11.2011 10:08:41 org.apache.coyote.http11.AbstractHttp11Processor process\nSEVERE: Error processing request\njava.lang.ClassCastException: org.apache.tomcat.util.http.mapper.Mapper$Host can\nnot be cast to org.apache.catalina.Host\n        at org.apache.catalina.connector.Request.getHost(Request.java:623)\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineVal\nve.java:77)\n]]]", "id": 151711, "time": "2011-11-22T07:14:09Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2011-11-22T07:14:09Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "knst.kolinko@gmail.com", "text": "Fixed in trunk and 7.0 with r1204856 and r1204860 and will be in 7.0.24.\nProposed for 6.0 and 5.5.", "id": 151712, "attachment_id": null, "bug_id": 52225, "creation_time": "2011-11-22T08:59:11Z", "time": "2011-11-22T08:59:11Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 52225, "attachment_id": null, "id": 151727, "time": "2011-11-22T19:25:49Z", "creator": "markt@apache.org", "creation_time": "2011-11-22T19:25:49Z", "is_private": false, "text": "Moving to 6.0.x"}, {"count": 3, "tags": [], "bug_id": 52225, "text": "Fixed in 5.5.x and will be in 5.5.35 onwards.", "id": 152328, "time": "2011-12-20T20:17:40Z", "creator": "markt@apache.org", "creation_time": "2011-12-20T20:17:40Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 52225, "attachment_id": null, "id": 152329, "creation_time": "2011-12-20T20:20:02Z", "time": "2011-12-20T20:20:02Z", "creator": "markt@apache.org", "text": "Fixed in 6.0.x and will be included in 6.0.36 onwards.", "is_private": false}]