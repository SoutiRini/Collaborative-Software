[{"attachment_id": 31514, "tags": [], "bug_id": 56391, "text": "Created attachment 31514\ntest log\n\nWhile this is the only error I see in whole Tomcat test suite it might be real issue. Please see attached report.\n\njava version \"1.7.0_51\"", "count": 0, "id": 174472, "time": "2014-04-11T13:11:18Z", "creator": "petr.sumbera@oracle.com", "creation_time": "2014-04-11T13:11:18Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 56391, "text": "JDK version = ?", "id": 174473, "time": "2014-04-11T13:14:51Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-04-11T13:14:51Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 56391, "text": "jdk1.7.0", "id": 174475, "time": "2014-04-11T13:22:41Z", "creator": "petr.sumbera@oracle.com", "creation_time": "2014-04-11T13:22:41Z", "is_private": false, "attachment_id": null}, {"text": "(In reply to Petr Sumbera from comment #2)\n> jdk1.7.0\n\nThe exact version please (e.g., 1.7.0_25).", "tags": [], "bug_id": 56391, "attachment_id": null, "count": 3, "id": 174477, "time": "2014-04-11T13:33:02Z", "creator": "chuck.caldarale@unisys.com", "creation_time": "2014-04-11T13:33:02Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 56391, "text": "$ /usr/jdk/instances/jdk1.7.0/bin/java -version\njava version \"1.7.0_51\"\nJava(TM) SE Runtime Environment (build 1.7.0_51-b34)\nJava HotSpot(TM) Server VM (build 24.51-b04, mixed mode)", "id": 174479, "time": "2014-04-11T13:38:56Z", "creator": "petr.sumbera@oracle.com", "creation_time": "2014-04-11T13:38:56Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 56391, "attachment_id": null, "text": "Is this repeatable? It is possible that the test behaves differently on Solaris and we simply don't handle it.", "id": 174769, "time": "2014-04-22T15:57:41Z", "creator": "markt@apache.org", "creation_time": "2014-04-22T15:57:41Z", "is_private": false}, {"count": 6, "tags": [], "text": "Not here. Just ran that test 10 times for Tomcat 8 trunk with NIO, BIO and APR each on Solaris 10 Sparc using Java 1.7.0_51. No failures.\n\nPetr: Can you reproduce?", "attachment_id": null, "bug_id": 56391, "id": 174771, "time": "2014-04-22T16:44:50Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2014-04-22T16:44:50Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 56391, "attachment_id": null, "id": 174772, "time": "2014-04-22T16:59:57Z", "creator": "remm@apache.org", "creation_time": "2014-04-22T16:59:57Z", "is_private": false, "text": "I could randomly reproduce it (on Linux), same stack trace. But it is odd, it does not happen with NIO2 for me, and I don't see why it wouldn't (the SSL code is the same use of SSL engine). I can't reproduce it if I run as a single test, but I can (one out of four times, I'd say) if running the full TestSsl series.\n\nMinor issue IMO since this doesn't happen much and this renegotiation test is just protocol abuse anyway."}, {"count": 8, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 174773, "time": "2014-04-22T19:16:27Z", "bug_id": 56391, "creation_time": "2014-04-22T19:16:27Z", "is_private": false, "text": "I can't reproduce this on Windows or OSX (tried 10+ runs) either."}, {"count": 9, "tags": [], "creator": "markt@apache.org", "text": "I've re-written the unit test. It still passes on Windows but now fails much more frequently on Windows. Getting to the bottom of why it fails is the next task.", "id": 174781, "time": "2014-04-22T22:28:27Z", "bug_id": 56391, "creation_time": "2014-04-22T22:28:27Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "id": 174782, "time": "2014-04-22T22:39:25Z", "bug_id": 56391, "creation_time": "2014-04-22T22:39:25Z", "is_private": false, "text": "With trunk at r1589300 the test now fails for me consistently in 10 of 10 runs on Windows 7 + JDK 7u55 32-bit.\n\nI am running with\n\nexecute.validate=false\nexecute.test.bio=false\nexecute.test.nio=true\nexecute.test.apr=false\nexecute.test.nio2=false\ntest.accesslog=false\ntest.entry=org.apache.tomcat.util.net.TestSsl\ntest.entry.methods=testSimpleSsl,testKeyPass,testRenegotiateWorks,testRenegotiateFail\n\nThe last property is to fix order of the methods.\n\nAll 10 failures are with the same \"72\" vs \"-1\" failure:\n[[[\nTestcase: testSimpleSsl took 4,581 sec\nTestcase: testKeyPass took 0,926 sec\nTestcase: testRenegotiateWorks took 3,418 sec\n        FAILED\nexpected:<72> but was:<-1>\njunit.framework.AssertionFailedError: expected:<72> but was:<-1>\n        at org.apache.tomcat.util.net.TestSsl.doRequest(TestSsl.java:158)\n        at org.apache.tomcat.util.net.TestSsl.testRenegotiateWorks(TestSsl.java:135)\n]]]\n\nApparently there is no more \"testRenegotiateFail\" test, so only 3 tests methods were run."}, {"count": 11, "tags": [], "text": "On Linux it fails 100% of the time too now (it used to be about 50%). NIO2 still does not fail for whatever reason. I can investigate tomorrow if needed.\n\nMy trace is on Linux is:\nTestcase: testRenegotiateWorks took 3.216 sec\n\tFAILED\nFailed on request number 1 after startHandshake()\njunit.framework.AssertionFailedError: Failed on request number 1 after startHandshake()\n\tat org.apache.tomcat.util.net.TestSsl.testRenegotiateWorks(TestSsl.java:138)\n\nYes, testRenegotiateFail is gone, it is not needed as trunk requires Java 7, according to the commit.\n\nBTW http://ci.apache.org/builders/tomcat-trunk is up again, but not running anything.", "is_private": false, "bug_id": 56391, "id": 174783, "time": "2014-04-22T22:50:08Z", "creator": "remm@apache.org", "creation_time": "2014-04-22T22:50:08Z", "attachment_id": null}, {"count": 12, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": 31550, "id": 174785, "time": "2014-04-22T23:07:38Z", "bug_id": 56391, "creation_time": "2014-04-22T23:07:38Z", "is_private": false, "text": "Created attachment 31550\ntest log (r1589303, Win7)\n\nTest log on Windows with trunk at r1589303.\n\nFailed on request number 2 after startHandshake(). expected:<72> but was:<-1>"}, {"attachment_id": null, "tags": [], "bug_id": 56391, "text": "I have been able to make a little progress debugging this. I still have not been able to reproduce this on Windows.\n\n1. The issue appears to be timing related. On OSX I see the error when running from the command line but not when running through Eclipse.\n\n2. It looks like the read() and write() methods in SecureNioChannel make assumptions about the return value of tasks() that are not correct if the client has triggered renegotiation.", "count": 13, "id": 174786, "time": "2014-04-22T23:13:14Z", "creator": "markt@apache.org", "creation_time": "2014-04-22T23:13:14Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 56391, "attachment_id": null, "text": "From my debugging, in the test it is never NEED_TASK, so tasks() is not called (and it doesn't feel wrong).\n\nHowever, (tracing the write, since that is what the test is doing) the handshake status goes into NEED_WRAP and NEED_UNWRAP, which means the write should read. Not a good concept IMO ...\n\nMore specifically about NIO2, this could be very difficult if not impossible to do it \"right\" (depending on what ends up being needed), since mixing read and write operations after the initial handshake would corrupt data or run into pending checks. This could be a candidate to end up as a known issue.", "id": 174793, "time": "2014-04-23T08:46:28Z", "creator": "remm@apache.org", "creation_time": "2014-04-23T08:46:28Z", "is_private": false}, {"count": 15, "tags": [], "bug_id": 56391, "attachment_id": null, "id": 174807, "creation_time": "2014-04-23T13:44:07Z", "time": "2014-04-23T13:44:07Z", "creator": "markt@apache.org", "text": "I have disabled this test for NIO (it was already disabled for APR) as the improved unit test has demonstrated that the current implementation is not reliable.\n\nI have created bug 56448 to track implementing improved renegotiation support.", "is_private": false}]