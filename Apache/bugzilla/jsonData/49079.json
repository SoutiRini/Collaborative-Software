[{"count": 0, "tags": [], "text": "Investigating a performance problem I believe that I have discovered an inefficient substitution issue with the <expandproperties> In this case we have a document that contains some tags that are processed and some that are not.  There are a largish number of properties defined.\n\nTaking stack dumps during the build process reveals that we were stuck in a tight loop.  Any help is greatly appreciated\n\nSample stack traces are all as follows:\n\n   java.lang.Thread.State: RUNNABLE\n        at java.lang.String.indexOf(String.java:1766)\n        at java.lang.String.indexOf(String.java:1733)\n        at org.apache.tools.ant.PropertyHelper$3.parsePropertyName(PropertyHelper.java:216)\n        at org.apache.tools.ant.property.ParseProperties.parsePropertyName(ParseProperties.java:187)\n        at org.apache.tools.ant.property.ParseProperties.parseNextProperty(ParseProperties.java:169)\n        at org.apache.tools.ant.property.ParseProperties.parseProperties(ParseProperties.java:110)\n        at org.apache.tools.ant.PropertyHelper.parseProperties(PropertyHelper.java:575)\n        at org.apache.tools.ant.PropertyHelper.replaceProperties(PropertyHelper.java:555)\n        at org.apache.tools.ant.PropertyHelper.replaceProperties(PropertyHelper.java:537)\n        at org.apache.tools.ant.Project.replaceProperties(Project.java:626)\n        at org.apache.tools.ant.filters.ExpandProperties.read(ExpandProperties.java:91)\n        at org.apache.tools.ant.filters.BaseFilterReader.read(BaseFilterReader.java:83)\n        at java.io.BufferedReader.read1(BufferedReader.java:185)\n        at java.io.BufferedReader.read(BufferedReader.java:261)\n        - locked <0x07b084b0> (a org.apache.tools.ant.filters.ExpandProperties)\n        at org.apache.tools.ant.util.ResourceUtils.copyResource(ResourceUtils.java:429)\n        at org.apache.tools.ant.util.FileUtils.copyFile(FileUtils.java:519)\n        at org.apache.tools.ant.util.FileUtils.copyFile(FileUtils.java:481)\n        at org.apache.tools.ant.util.FileUtils.copyFile(FileUtils.java:310)\n        at org.apache.tools.ant.taskdefs.Copy.doFileOperations(Copy.java:827)\n        at org.apache.tools.ant.taskdefs.Copy.execute(Copy.java:508)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:291)\n        at sun.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.tools.ant.dispatch.DispatchUtils.execute(DispatchUtils.java:106)\n        at org.apache.tools.ant.Task.perform(Task.java:348)\n        at org.apache.tools.ant.taskdefs.Sequential.execute(Sequential.java:68)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:291)\n        at sun.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.tools.ant.dispatch.DispatchUtils.execute(DispatchUtils.java:106)\n        at org.apache.tools.ant.Task.perform(Task.java:348)\n        at org.apache.tools.ant.taskdefs.MacroInstance.execute(MacroInstance.java:398)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:291)\n        at sun.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.tools.ant.dispatch.DispatchUtils.execute(DispatchUtils.java:106)\n        at org.apache.tools.ant.TaskAdapter.execute(TaskAdapter.java:154)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:291)\n        at sun.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.tools.ant.dispatch.DispatchUtils.execute(DispatchUtils.java:106)\n        at org.apache.tools.ant.Task.perform(Task.java:348)\n        at org.apache.tools.ant.taskdefs.Sequential.execute(Sequential.java:68)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:291)\n        at sun.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.tools.ant.dispatch.DispatchUtils.execute(DispatchUtils.java:106)\n        at org.apache.tools.ant.Task.perform(Task.java:348)\n        at org.apache.tools.ant.taskdefs.MacroInstance.execute(MacroInstance.java:398)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:291)\n        at sun.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.tools.ant.dispatch.DispatchUtils.execute(DispatchUtils.java:106)\n        at org.apache.tools.ant.Task.perform(Task.java:348)\n        at org.apache.tools.ant.Target.execute(Target.java:390)\n        at org.apache.tools.ant.Target.performTasks(Target.java:411)\n        at org.apache.tools.ant.Project.executeSortedTargets(Project.java:1397)\n        at org.apache.tools.ant.helper.SingleCheckExecutor.executeTargets(SingleCheckExecutor.java:38)\n        at org.apache.tools.ant.Project.executeTargets(Project.java:1249)\n        at org.apache.tools.ant.taskdefs.Ant.execute(Ant.java:442)\n        at org.apache.tools.ant.taskdefs.SubAnt.execute(SubAnt.java:302)\n        at org.apache.tools.ant.taskdefs.SubAnt.execute(SubAnt.java:221)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:291)\n        at sun.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.tools.ant.dispatch.DispatchUtils.execute(DispatchUtils.java:106)\n        at org.apache.tools.ant.Task.perform(Task.java:348)\n        at org.apache.tools.ant.taskdefs.Sequential.execute(Sequential.java:68)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:291)\n        at sun.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.tools.ant.dispatch.DispatchUtils.execute(DispatchUtils.java:106)\n        at org.apache.tools.ant.Task.perform(Task.java:348)\n        at org.apache.tools.ant.taskdefs.MacroInstance.execute(MacroInstance.java:398)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:291)\n        at sun.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.tools.ant.dispatch.DispatchUtils.execute(DispatchUtils.java:106)\n        at org.apache.tools.ant.Task.perform(Task.java:348)\n        at org.apache.tools.ant.Target.execute(Target.java:390)\n        at org.apache.tools.ant.Target.performTasks(Target.java:411)\n        at org.apache.tools.ant.Project.executeSortedTargets(Project.java:1397)\n        at org.apache.tools.ant.Project.executeTarget(Project.java:1366)\n        at org.apache.tools.ant.helper.DefaultExecutor.executeTargets(DefaultExecutor.java:41)\n        at org.apache.tools.ant.Project.executeTargets(Project.java:1249)\n        at org.apache.tools.ant.Main.runBuild(Main.java:801)\n        at org.apache.tools.ant.Main.startAnt(Main.java:218)\n        at org.apache.tools.ant.launch.Launcher.run(Launcher.java:280)\n        at org.apache.tools.ant.launch.Launcher.main(Launcher.java:109)", "attachment_id": null, "bug_id": 49079, "id": 135980, "time": "2010-04-09T05:05:29Z", "creator": "lindner@inuus.com", "creation_time": "2010-04-09T05:05:29Z", "is_private": false}, {"count": 1, "tags": [], "text": "the reason is likely the same one as in bug 48961\n\nI think the indexOf checks are costly and could be simplified.  Right now\nwe lack a good stand alone testcase to evaluate the relative performance of\ndifferent approaches.", "attachment_id": null, "bug_id": 49079, "id": 135990, "time": "2010-04-09T13:20:02Z", "creator": "bodewig@apache.org", "creation_time": "2010-04-09T13:20:02Z", "is_private": false}, {"count": 2, "tags": [], "text": "I have just committed a change to PropertyHelper to use a different approach than the costly indexOf check:\n\nCommitted revision 932456.", "attachment_id": null, "bug_id": 49079, "id": 135992, "time": "2010-04-09T15:16:12Z", "creator": "mbenson@apache.org", "creation_time": "2010-04-09T15:16:12Z", "is_private": false}, {"count": 3, "tags": [], "creator": "lindner@inuus.com", "text": "This fixed the issue I was seeing, builds are a whole lot faster. Thanks!\n\n(In reply to comment #2)\n> I have just committed a change to PropertyHelper to use a different approach\n> than the costly indexOf check:\n> \n> Committed revision 932456.", "id": 136020, "time": "2010-04-11T20:06:15Z", "bug_id": 49079, "creation_time": "2010-04-11T20:06:15Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 49079, "attachment_id": null, "text": "Thanks for testing", "id": 136041, "time": "2010-04-12T06:15:45Z", "creator": "bodewig@apache.org", "creation_time": "2010-04-12T06:15:45Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 49079, "is_private": false, "text": "(In reply to comment #4)\n> Thanks for testing\n\n+1", "id": 136055, "time": "2010-04-12T10:41:24Z", "creator": "mbenson@apache.org", "creation_time": "2010-04-12T10:41:24Z", "attachment_id": null}]