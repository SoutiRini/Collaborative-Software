[{"count": 0, "tags": [], "bug_id": 61825, "attachment_id": 35557, "id": 202432, "time": "2017-11-28T02:35:14Z", "creator": "ronxin999@163.com", "creation_time": "2017-11-28T02:35:14Z", "is_private": false, "text": "Created attachment 35557\nthe Http11ConnectionHandler concurrentHashmap contain too may request\n\nI am use tomcat8.0.30,use the async function,programe running a fews day,\nfound the full gc is runnig all the time,but memory is not clean up,i dump the memory analyse by eclipse mat found the follow result:\n\nRequest,Response,Nio2Channels and so an,the object is top big object.\n\n19,289 instances of \"org.apache.tomcat.util.net.Nio2Channel\", loaded by \"java.net.URLClassLoader @ 0x730cc4d58\" occupy 319,430,000 (11.05%) bytes. These instances are referenced from one instance of \"java.util.concurrent.ConcurrentHashMap$Segment[]\", loaded by \"<system class loader>\"\n\nKeywords\none \n19,488 instances of \"org.apache.catalina.connector.Response\", loaded by \"java.net.URLClassLoader @ 0x730cc4d58\" occupy 493,942,352 (17.09%) bytes. These instances are referenced from one instance of \"java.lang.Object[]\", loaded by \"<system class loader>\"\n\ntwo:\n19,488 instances of \"org.apache.catalina.connector.Request\", loaded by \"java.net.URLClassLoader @ 0x730cc4d58\" occupy 474,043,792 (16.40%) bytes. These instances are referenced from one instance of \"java.lang.Object[]\", loaded by \"<system class loader>\"\n\nthree:\n19,289 instances of \"org.apache.tomcat.util.net.Nio2Channel\", loaded by \"java.net.URLClassLoader @ 0x730cc4d58\" occupy 319,430,000 (11.05%) bytes. These instances are referenced from one instance of \"java.util.concurrent.ConcurrentHashMap$Segment[]\", loaded by \"<system class loader>\"\n\nall memory size is 2.1G,tomcat async request and response and Nio2Channel occupy 1.8G memory\uff0cmaybe the Nio2Channel,has a concurrentHashMap,the map reflence too may Http11Nio2Processor\n\nMy switch the request to other server,the tomcat async request and response is can't clean by gc,so i guess the tomcat is memory leak may be."}, {"count": 1, "tags": [], "bug_id": 61825, "attachment_id": 35558, "is_private": false, "id": 202433, "time": "2017-11-28T02:37:07Z", "creator": "ronxin999@163.com", "creation_time": "2017-11-28T02:37:07Z", "text": "Created attachment 35558\nrequest and response is not release maybe the concurrenthashmap reflence"}, {"count": 2, "tags": [], "bug_id": 61825, "attachment_id": null, "id": 202434, "time": "2017-11-28T03:07:48Z", "creator": "ronxin999@163.com", "creation_time": "2017-11-28T03:07:48Z", "is_private": false, "text": "the asyncState all is COMPLETING of the all async request asyncstateMachine,why is not end after timeout by tomcat container"}, {"count": 3, "tags": [], "bug_id": 61825, "attachment_id": 35559, "is_private": false, "id": 202436, "time": "2017-11-28T03:37:04Z", "creator": "ronxin999@163.com", "creation_time": "2017-11-28T03:37:04Z", "text": "Created attachment 35559\nthe async request asyncStateMachine state\n\nall the async request the statemachine is completing"}, {"count": 4, "tags": [], "bug_id": 61825, "attachment_id": null, "is_private": false, "id": 202450, "time": "2017-11-28T16:22:58Z", "creator": "chris@christopherschultz.net", "creation_time": "2017-11-28T16:22:58Z", "text": "If you are actually running Tomcat 8.0.30, please upgrade to latest Tomcat 8.0.47. There have been MANY improvements to async features, including a few that max fix memory leaks like the one you describe.\n\nPlease note that the Tomcat project does not issue patches for individual issues; instead, we produce new releases with new version numbers. Tomcat 8.0.47 should be drop-in compatible with Tomcat 8.0.30.\n\nYou should also consider upgrading to Tomcat 8.5.x for longer-term support."}, {"count": 5, "tags": [], "bug_id": 61825, "attachment_id": null, "is_private": false, "id": 202462, "time": "2017-11-29T04:57:55Z", "creator": "ronxin999@163.com", "creation_time": "2017-11-29T04:57:55Z", "text": "Thanks Christopher Schultz,I have a question,if i use 8.0.47,if the async is timeout,I need to invoke complete method ? i understand is not ,tomcat contain is end the async request if timeout is happend,thanks you"}, {"count": 6, "tags": [], "bug_id": 61825, "attachment_id": null, "is_private": false, "id": 202479, "time": "2017-11-29T17:15:39Z", "creator": "chris@christopherschultz.net", "creation_time": "2017-11-29T17:15:39Z", "text": "I'm sorry, I'm no expert on servlet-async so I'm not sure how to answer your question. If there are changes to the async state-machine in Tomcat, those changes will have been made in order to align Tomcat with the published standard, so your product should not have to be customized in any way to work with Tomcat (versus any other Java application server)."}, {"count": 7, "tags": [], "bug_id": 61825, "attachment_id": null, "is_private": false, "id": 203087, "time": "2018-01-04T20:38:48Z", "creator": "markt@apache.org", "creation_time": "2018-01-04T20:38:48Z", "text": "This does look like a Tomcat bug but likely one that was fixed in 8.0.38 (look in the changelog for deadlock).\n\nAbsent a test case that demonstrates this issue, I'm going to assume that this is fixed in the latest 8.0.x."}]