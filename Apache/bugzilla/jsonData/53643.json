[{"count": 0, "tags": [], "creator": "erno.kovacs@freemail.hu", "attachment_id": null, "text": "apache segfaults with mod_authn_dbd when dbd_min is zero:\n\n# tail -f error.log\n[Thu Aug 02 16:27:37 2012] [info] mod_ssl/2.2.22 compiled against Server: Apache/2.2.22, Library: OpenSSL/0.9.8o\n[Thu Aug 02 16:27:37 2012] [notice] Apache/2.2.22 (Unix) mod_ssl/2.2.22 OpenSSL/0.9.8o configured -- resuming normal operations\n[Thu Aug 02 16:27:37 2012] [info] Server built: Aug  2 2012 15:37:02\n[Thu Aug 02 16:27:37 2012] [debug] worker.c(1757): AcceptMutex: sysvsem (default: sysvsem)\n[Thu Aug 02 16:27:39 2012] [notice] child pid 13127 exit signal Segmentation fault (11)\n\nConfig line for compiling against the Squeeze packages is:\n\n./configure --prefix=/usr/local/apachetest --disable-echo --enable-cache --disable-include \\\n            --enable-ssl --enable-http --enable-cgi   --disable-imap --disable-userdir \\\n            --enable-dbd --enable-authn-dbd --with-apr=/usr --with-apr-util=/usr \\\n            --enable-so --enable-rewrite --disable-vhost-alias  --with-mpm=worker\n\n# dpkg -l|grep apr\nii  libapr1                             1.4.2-6+squeeze4             The Apache Portable Runtime Library\nii  libapr1-dev                         1.4.2-6+squeeze4             The Apache Portable Runtime Library - Development Headers\nii  libaprutil1                         1.3.9+dfsg-5                 The Apache Portable Runtime Utility Library\nii  libaprutil1-dbd-mysql               1.3.9+dfsg-5                 The Apache Portable Runtime Utility Library - MySQL Driver\nii  libaprutil1-dev                     1.3.9+dfsg-5                 The Apache Portable Runtime Utility Library - Development Headers\n\n\nhttpd.conf:\n############################################################### alapveto adatok begin\nServerRoot \"/usr/local/apachetest\"\nListen 50080\nUser nobody\nGroup nogroup\nServerAdmin tech@xxxxxxx.hu\nServerName xxxxxxx.hu:80\nDocumentRoot \"/usr/local/apachetest/htdocs\"\nDirectoryIndex index.html index.htm index.php\nExtendedStatus on\nServerTokens Prod\nServerSignature Off\nDefaultType text/plain\nTimeout 30\nKeepalive on\nMaxKeepAliveRequests 100\nKeepAliveTimeout 5\nUseCanonicalName Off\nAccessFilename .htaccess\nHostnameLookups off\nCoreDumpDirectory /tmp\n############################################################### alapveto adatok end\n\n############################################################### MPM begin\nThreadLimit 10\nThreadsPerChild 1\nServerLimit 10\nMaxClients 10\nStartServers 1\nMinSpareThreads 1\nMaxSpareThreads 1\nThreadStackSize 131072\nMaxRequestsPerChild  10000\n############################################################### MPM end\n\n#################################################################### mod_dbd begin\nDBDriver mysql\nDBDParams \"host=mysql.xxxxxxx.hu dbname=xxxxxxx user=xxxxxxx password=xxxxxxx\"\n\nDBDMin  0\nDBDKeep 5\nDBDMax  10\nDBDExptime 60\n#################################################################### mod_dbd end\n\n############################################################### access control begin\n<Directory />\n    Options FollowSymLinks\n    AllowOverride None\n    Order deny,allow\n    Deny from all\n\n</Directory>\n\n<Directory /usr/local/apachetest/htdocs>\n  Order allow,deny\n  Allow from all\n\n  AuthType Basic\n  AuthName \"My Server\"\n  AuthBasicProvider dbd\n\n  # core authorization configuration\n  Require valid-user\n\n  AuthDBDUserPWQuery \"SELECT pd_password FROM w3_protecteddirs WHERE pd_username = %s\"\n</Directory>\n\n<FilesMatch \"^\\.ht\">\n    Order allow,deny\n    Deny from all\n    Satisfy All\n</FilesMatch>\n############################################################### access control end\n\n################################################################### logging begin\nPidFile \"logs/httpd.pid\"\nErrorLog \"logs/error.log\"\nLogLevel debug\nLogFormat \"%h %V %u %t \\\"%r\\\" %s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\"\nTransferLog \"logs/access.log\"\n#################################################################### logging end\n\n\n\nIf I increase DBD_Min to 1, Apache does not crash.", "id": 161066, "time": "2012-08-02T14:35:51Z", "bug_id": 53643, "creation_time": "2012-08-02T14:35:51Z", "is_private": false}, {"count": 1, "tags": [], "creator": "erno.kovacs@freemail.hu", "attachment_id": null, "text": "However DBD_Min 0 is definetly a problem, and with a higher value authentication works fine, I can still reproduce the segfaults by pushing F5 (refresh) in the browser for a few minutes.\nI believe this is a stack issue, as I increase ThreadStackSize it works OK, no segfaults. I would recommend mentioning this in documentation. 256KByte seems to be enough.", "id": 161075, "time": "2012-08-02T17:38:39Z", "bug_id": 53643, "creation_time": "2012-08-02T17:38:39Z", "is_private": false}, {"count": 2, "tags": [], "creator": "erno.kovacs@freemail.hu", "attachment_id": null, "text": "Nevertheles, Apache even segfaults, when DBD is not configured at all in rsrc_conf and an attacker has the ability to upload .htaccess files with content of AuthBasicProvider dbd and AllowOverride AuthConfig is on.", "id": 161095, "time": "2012-08-04T21:50:08Z", "bug_id": 53643, "creation_time": "2012-08-04T21:50:08Z", "is_private": false}]