[{"count": 0, "tags": [], "creator": "bastian@diqube.org", "attachment_id": null, "id": 184471, "time": "2015-08-11T13:20:28Z", "bug_id": 58232, "creation_time": "2015-08-11T13:20:28Z", "is_private": false, "text": "Hello,\n\nI'm currently trying to register my own WebsocketEndpoint programatically, i.e. not using the annotations. JSR-356 says this is possible by using the ServerContainer which can be obtained from the ServletContext (see section 6.4). \nThe ServerContainer provides two methods that can be used to add a new endpoint. I do not want to use the one that takes a Class<?>, but I need to use the one that takes a ServerEndpointConfig. This is because I want to add some UserProperties to the ServerEndpointConfig before it is added - and I cannot do that when using the method that takes the Class<?>.\n\nWhen I'm doing this and try it, I get the following exception:\n\nAug 11, 2015 2:23:52 PM org.apache.coyote.AbstractProtocol$AbstractConnectionHandler process\nSEVERE: Error reading request, ignored\njava.lang.NullPointerException\n\tat org.apache.tomcat.websocket.pojo.PojoEndpointBase.doOnOpen(PojoEndpointBase.java:59)\n\tat org.apache.tomcat.websocket.pojo.PojoEndpointServer.onOpen(PojoEndpointServer.java:70)\n\tat org.apache.tomcat.websocket.server.WsHttpUpgradeHandler.init(WsHttpUpgradeHandler.java:138)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:696)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1521)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1478)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n\tat java.lang.Thread.run(Thread.java:745)\n\n\nWhen looking at the source of Tomcat, it seems that the method taking the Class<?> adds a userProperty to the ServerEndpointConfig, which contains an instance of PojoMethodMapping. This is not done when directly calling the method that takes the ServerEndpointConfig - and exactly that PojoMethodMapping seems to be missing in my case.\n\nAs PojoMethodMapping is not defined by the JSR, but is a Tomcat class, I  would like to not instantiate it myself, but I think the instantiation of PojoMethodMapping should be done in Tomcat in the method taking the ServerEndpointConfig, as the one with the Class<?> parameter calls that one anyway.\n\nI patched tomcat locally and it seems to work for me after that adjustment. I therefore propose that this adjustment be integrated into trunk.\nI will upload my changes to GitHub right away and add a comment with the link here.\n\n\nThanks,\nBasti"}, {"count": 1, "tags": [], "bug_id": 58232, "is_private": false, "id": 184472, "creation_time": "2015-08-11T13:22:53Z", "time": "2015-08-11T13:22:53Z", "creator": "bastian@diqube.org", "text": "https://github.com/bgloeckle/tomcat80/commit/ee8a0e6e11eaecdb6406cd9e1135eae25f0d11bf", "attachment_id": null}, {"count": 2, "tags": [], "creator": "violetagg@apache.org", "attachment_id": null, "text": "Hi,\n\nCan you please provide a simple test. I cannot reproduce the behavior that you are describing.\n\nBest Regards,\nVioleta", "id": 184506, "time": "2015-08-12T14:57:29Z", "bug_id": 58232, "creation_time": "2015-08-12T14:57:29Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 58232, "text": "Hi,\n\nThanks for replying that fast :)\n\nSure, I can:\n\n* New .war project\n* Provide a Context Listener in the web.xml\n* In context listener register a WebsocketEndpoint suing a ServerEndpointConfig\n* access Websocket from web\n* Exception.\n\nI'll attach my example files...", "count": 3, "id": 184511, "time": "2015-08-12T15:18:17Z", "creator": "bastian@diqube.org", "creation_time": "2015-08-12T15:18:17Z", "is_private": false}, {"count": 4, "attachment_id": 32993, "bug_id": 58232, "is_private": false, "id": 184512, "time": "2015-08-12T15:18:58Z", "creator": "bastian@diqube.org", "creation_time": "2015-08-12T15:18:58Z", "tags": [], "text": "Created attachment 32993\nweb.xml"}, {"attachment_id": 32994, "tags": [], "bug_id": 58232, "text": "Created attachment 32994\nExampleContextListener", "count": 5, "id": 184513, "time": "2015-08-12T15:19:23Z", "creator": "bastian@diqube.org", "creation_time": "2015-08-12T15:19:23Z", "is_private": false}, {"count": 6, "tags": [], "creator": "bastian@diqube.org", "attachment_id": 32995, "id": 184514, "creation_time": "2015-08-12T15:19:36Z", "time": "2015-08-12T15:19:36Z", "bug_id": 58232, "text": "Created attachment 32995\nWebSocketEndpoint", "is_private": false}, {"count": 7, "tags": [], "bug_id": 58232, "is_private": false, "id": 184515, "creation_time": "2015-08-12T15:19:47Z", "time": "2015-08-12T15:19:47Z", "creator": "bastian@diqube.org", "text": "Created attachment 32996\nindex.html", "attachment_id": 32996}, {"count": 8, "tags": [], "creator": "violetagg@apache.org", "text": "Hi,\n\nThanks for the report and the patch. I added a test case also.\nThe fix is available in trunk, 8.0.x (for 8.0.25 onwards) and 7.0.x (for 7.0.64 onwards)\n\nRegards,\nVioleta", "id": 184551, "time": "2015-08-13T15:10:35Z", "bug_id": 58232, "creation_time": "2015-08-13T15:10:35Z", "is_private": false, "attachment_id": null}]