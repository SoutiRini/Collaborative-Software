[{"count": 0, "tags": [], "text": "Upgrading Ant 1.5 to 1.5.3 causes the perforce optional tasks to hang the build \nprocess, this is not always the case, maybe 2% of the builds succeed. If \nattaching a debugger and stepping through the perforce tasks, the build \ncontinues. Therefore it seems to me that is has to do with some timing \nproblems. I've tried various versions of J2SE but the behavior stays the same.\n\nHowever making thread dumps shows that it is always the Execute task that is in \nthe wait state. It appears (by attaching truss to the perforce task) that the \np4change -i command is waiting for input and Ant waiting for p4change -i to \nreturn. The is caused by a p4change -o command that is executed before (to \nobtain the form to fill in) that can't obtain the p4change -o output. Only with \nthe debugger a form is obtained. Therefore it seems that the real problem is \nsomewhere in the code that has to read the output from the Unix process.\n\nI tried to run some old perforce optional tasks with Ant 1.5.3 that gave me the \nsame behavior, so maybe it is somewhere in the core.\n\nBTW the code in P4HandlerAdapter at line 135 seems strange to me, why \nsynchronize on the Reader itself, shouldn't it be the outer class?\n\n                while ((line = input.readLine()) != null) {\n                    synchronized (this){ \n                        process(line);\n                    }\n                }\n \nFull thread dump Java HotSpot(TM) Client VM (1.4.2-beta-b19 mixed mode):\n\n\"Thread-8\" prio=5 tid=0x002769e8 nid=0x14 runnable [f0b81000..f0b819a0]\n        at java.io.FileInputStream.readBytes(Native Method)\n        at java.io.FileInputStream.read(FileInputStream.java:194)\n        at java.lang.UNIXProcess$DeferredCloseInputStream.read(UNIXProcess.java:\n215)\n        at sun.nio.cs.StreamDecoder$CharsetSD.readBytes(StreamDecoder.java:408)\n        at sun.nio.cs.StreamDecoder$CharsetSD.implRead(StreamDecoder.java:450)\n        at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:182)\n        - locked <0xf14903a8> (a java.io.InputStreamReader)\n        at java.io.InputStreamReader.read(InputStreamReader.java:167)\n        at java.io.BufferedReader.fill(BufferedReader.java:136)\n        at java.io.BufferedReader.readLine(BufferedReader.java:299)\n        - locked <0xf14903a8> (a java.io.InputStreamReader)\n        at java.io.BufferedReader.readLine(BufferedReader.java:362)\n        at org.apache.tools.ant.taskdefs.optional.perforce.P4HandlerAdapter$Read\ner.run(P4HandlerAdapter.java:134)\n        at java.lang.Thread.run(Thread.java:534)\n\n\"Thread-7\" prio=5 tid=0x002767a0 nid=0x13 runnable [f1181000..f11819a0]\n        at java.io.FileInputStream.readBytes(Native Method)\n        at java.io.FileInputStream.read(FileInputStream.java:194)\n        at java.lang.UNIXProcess$DeferredCloseInputStream.read(UNIXProcess.java:\n215)\n        at java.io.BufferedInputStream.read1(BufferedInputStream.java:220)\n        at java.io.BufferedInputStream.read(BufferedInputStream.java:277)\n        - locked <0xf14819c0> (a java.io.BufferedInputStream)\n        at sun.nio.cs.StreamDecoder$CharsetSD.readBytes(StreamDecoder.java:408)\n        at sun.nio.cs.StreamDecoder$CharsetSD.implRead(StreamDecoder.java:450)\n        at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:182)\n        - locked <0xf14846f8> (a java.io.InputStreamReader)\n        at java.io.InputStreamReader.read(InputStreamReader.java:167)\n        at java.io.BufferedReader.fill(BufferedReader.java:136)\n        at java.io.BufferedReader.readLine(BufferedReader.java:299)\n        - locked <0xf14846f8> (a java.io.InputStreamReader)\n        at java.io.BufferedReader.readLine(BufferedReader.java:362)\n        at org.apache.tools.ant.taskdefs.optional.perforce.P4HandlerAdapter$Read\ner.run(P4HandlerAdapter.java:134)\n        at java.lang.Thread.run(Thread.java:534)\n\n\"process reaper\" daemon prio=5 tid=0x000a9c48 nid=0x12 runnable [f1381000..f1381\n9a0]\n        at java.lang.UNIXProcess.waitForProcessExit(Native Method)\n        at java.lang.UNIXProcess.access$1000(UNIXProcess.java:17)\n        at java.lang.UNIXProcess$3.run(UNIXProcess.java:80)\n\n\"Signal Dispatcher\" daemon prio=10 tid=0x000c3360 nid=0x8 waiting on condition [\n0..0]\n\n\"Finalizer\" daemon prio=8 tid=0x000beb60 nid=0x6 in Object.wait() [fc381000..fc3\n819a0]\n        at java.lang.Object.wait(Native Method)\n        - waiting on <0xf1b43520> (a java.lang.ref.ReferenceQueue$Lock)\n        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:111)\n        - locked <0xf1b43520> (a java.lang.ref.ReferenceQueue$Lock)\n        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:127)\n        at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:159)\n\n\"Reference Handler\" daemon prio=10 tid=0x000bd238 nid=0x5 in Object.wait() [fde8\n1000..fde819a0]\n        at java.lang.Object.wait(Native Method)\n        - waiting on <0xf1b43588> (a java.lang.ref.Reference$Lock)\n        at java.lang.Object.wait(Object.java:429)\n        at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:115)\n        - locked <0xf1b43588> (a java.lang.ref.Reference$Lock)\n\n\"main\" prio=5 tid=0x0002d0f0 nid=0x1 in Object.wait() [ffbee000..ffbeecac]\n        at java.lang.Object.wait(Native Method)\n        - waiting on <0xf14810a8> (a java.lang.UNIXProcess)\n        at java.lang.Object.wait(Object.java:429)\n        at java.lang.UNIXProcess.waitFor(UNIXProcess.java:109)\n        - locked <0xf14810a8> (a java.lang.UNIXProcess)\n        at org.apache.tools.ant.taskdefs.Execute.waitFor(Execute.java:466)\n        at org.apache.tools.ant.taskdefs.Execute.execute(Execute.java:448)\n        at org.apache.tools.ant.taskdefs.optional.perforce.P4Base.execP4Command(\nP4Base.java:226)\n        at org.apache.tools.ant.taskdefs.optional.perforce.P4Change.execute(P4Ch\nange.java:112)\n        at org.apache.tools.ant.Task.perform(Task.java:341)\n        at org.apache.tools.ant.Target.execute(Target.java:309)\n        at org.apache.tools.ant.Target.performTasks(Target.java:336)\n        at org.apache.tools.ant.Project.executeTarget(Project.java:1339)\n        at org.apache.tools.ant.Project.executeTargets(Project.java:1255)\n        at org.apache.tools.ant.Main.runBuild(Main.java:609)\n        at org.apache.tools.ant.Main.start(Main.java:196)\n        at org.apache.tools.ant.Main.main(Main.java:235)\n\n\"VM Thread\" prio=5 tid=0x000bc3d0 nid=0x4 runnable\n\n\"VM Periodic Task Thread\" prio=10 tid=0x000c4e30 nid=0xa waiting on condition\n\"Suspend Checker Thread\" prio=10 tid=0x000c0380 nid=0x7 runnable", "attachment_id": null, "id": 34989, "creator": "mark.brouwer@virgil.nl", "time": "2003-04-11T15:49:10Z", "bug_id": 18956, "creation_time": "2003-04-11T15:49:10Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 18956, "text": "see this bug report http://nagoya.apache.org/bugzilla/show_bug.cgi?id=18129 - is \nsee also this one http://nagoya.apache.org/bugzilla/show_bug.cgi?id=18154\nthe synchronized keyword in P4HandlerAdapter is there to prevent two different \nthreads (the one reading stdout and the one reading stderr) from calling process \nat the same time. I hope that this is fine, otherwise, feel free to propose a \nbetter way of doing it.\nAnother point : in principle the Perforce tasks are delegating through P4Base to \nthe Execute class (org.apache.tools.ant.taskdefs.Execute). Execute#execute()\nis then called. This line         waitFor(process); is I suspect the blocking \ncall.", "id": 35002, "time": "2003-04-11T17:17:17Z", "creator": "levylambert@tiscali-dsl.de", "creation_time": "2003-04-11T17:17:17Z", "is_private": false, "attachment_id": null}, {"attachment_id": 5822, "tags": [], "creator": "levylambert@tiscali-dsl.de", "text": "Created attachment 5822\nfixes the bug", "count": 2, "id": 35098, "time": "2003-04-14T11:29:23Z", "bug_id": 18956, "creation_time": "2003-04-14T11:29:23Z", "is_private": false}, {"count": 3, "attachment_id": null, "bug_id": 18956, "is_private": false, "id": 35099, "time": "2003-04-14T11:30:56Z", "creator": "levylambert@tiscali-dsl.de", "creation_time": "2003-04-14T11:30:56Z", "tags": [], "text": "Mark Brouwer wrote me on April 14th 2003, 10:04 am\nHi Antoine,\n\nI integrated the code and it seems to work now, I only tried it 3 times all with\nsuccess, for I don't want to flood our system with dozens of builds, but I will\ntrack it the next few days if everything is OK now.\n\nThanks,\n-- \nMark Brouwer"}, {"count": 4, "tags": [], "creator": "levylambert@tiscali-dsl.de", "text": "I am going to apply the patch contained in this page to the head CVS revision, \nwhich should fix the problem in the next nightly build.", "id": 35253, "time": "2003-04-15T19:12:08Z", "bug_id": 18956, "creation_time": "2003-04-15T19:12:08Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 18956, "attachment_id": null, "id": 35440, "time": "2003-04-17T16:18:35Z", "creator": "levylambert@tiscali-dsl.de", "creation_time": "2003-04-17T16:18:35Z", "is_private": false, "text": "Mark, it would be good if you could make a download of the ant nightly build to \nconfirm that this bug is really fixed."}, {"count": 6, "tags": [], "bug_id": 18956, "attachment_id": null, "id": 38452, "time": "2003-06-05T19:15:04Z", "creator": "aambrose@access-us-inc.com", "creation_time": "2003-06-05T19:15:04Z", "is_private": false, "text": "I am still getting this bug with last night's build.  I've checked the source,\nand the proposed patch is indeed in the code.  My platform is different, so\nplease tell me if you'd like me to enter a separate bug:\n\nLinux (2.4.20-13.7)\nJDK 1.4.1_02  (The JDK provided by BEA)\nAnt version: 1.6 alpha, built Jun 05 2003.\n\nThe build hangs on the p4change task, and looking at the process list, 'p4\nchange -i' is running."}, {"count": 7, "tags": [], "bug_id": 18956, "attachment_id": null, "id": 38455, "time": "2003-06-05T19:51:50Z", "creator": "levylambert@tiscali-dsl.de", "creation_time": "2003-06-05T19:51:50Z", "is_private": false, "text": "I will have a look at the problem. "}, {"count": 8, "tags": [], "bug_id": 18956, "text": "OK - I do not have access to a Linux machine.\nI have tried the nightly build on Solaris, there it is working.\nLet's try to revert experimentally to revision 1.7 of \nsrc/main/org/apache/tools/ant/taskdefs/optional/perforce/P4HandlerAdapter.java \n(before the threaded readers were introduced to read stdout and stderr) and see \nif it helps.\nI am going to attach the corresponding patch file to the bug report.", "id": 38465, "time": "2003-06-05T22:21:14Z", "creator": "levylambert@tiscali-dsl.de", "creation_time": "2003-06-05T22:21:14Z", "is_private": false, "attachment_id": null}, {"attachment_id": 6657, "tags": [], "creator": "levylambert@tiscali-dsl.de", "text": "Created attachment 6657\nbring P4HandlerAdapter.java back to revision 1.7", "count": 9, "id": 38467, "time": "2003-06-05T22:35:30Z", "bug_id": 18956, "creation_time": "2003-06-05T22:35:30Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 18956, "attachment_id": null, "id": 38535, "time": "2003-06-06T21:26:51Z", "creator": "levylambert@tiscali-dsl.de", "creation_time": "2003-06-06T21:26:51Z", "is_private": false, "text": "I have checked in new code in CVS, which will be in the next nightly build.\nThe P4HandlerAdapter now delegates to PumpStreamHandler, a class used for the \nExec task.\nIt has been tested by Adam Ambrose on linux.\nI mark the bug resolved again, hopefully for good this time."}, {"count": 11, "tags": [], "creator": "christopher@ezln23.com", "attachment_id": null, "id": 40535, "time": "2003-07-12T03:46:17Z", "bug_id": 18956, "creation_time": "2003-07-12T03:46:17Z", "is_private": false, "text": "*** Bug 21531 has been marked as a duplicate of this bug. ***"}, {"count": 12, "tags": [], "bug_id": 18956, "attachment_id": null, "id": 40538, "time": "2003-07-12T04:46:27Z", "creator": "christopher@ezln23.com", "creation_time": "2003-07-12T04:46:27Z", "is_private": false, "text": "I tested the latest nightly build (2003-07-11) and I have not been able to \nreplicate the bug."}, {"count": 13, "tags": [], "text": "Hi\n\nI had the same problem after upgrading from Ant 1.4.1 to 1.5.4.\nAfter studing CVS change log it appears that the bug was introduced in 1.5.2,\ndowngrading to 1.5.1 resolves the problem.\n\nI just tried the latest 1.6beta1 and I don't experience the problem.\n\nI see that there were several solutions proposed and I would like to confirm\nthat 1.6beta1 works for me.\n\nThank you.", "attachment_id": null, "bug_id": 18956, "id": 45550, "time": "2003-10-13T17:48:21Z", "creator": "yuri@nazarov.org", "creation_time": "2003-10-13T17:48:21Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 18956, "text": "*** Bug 29568 has been marked as a duplicate of this bug. ***", "id": 59221, "time": "2004-06-15T12:05:09Z", "creator": "antoine@apache.org", "creation_time": "2004-06-15T12:05:09Z", "is_private": false, "attachment_id": null}]