[{"count": 0, "tags": [], "text": "To be really clear, here is our architecture :\n\n         +---------+   +---------+   +---------+\n         |mod_proxy|   |mod_proxy|   |         |\nCLIENT---|  2.0.43 |---|mod_cache|---|   IIS   |\n         |         |   |  2.0.43 |   |         |\n         +---------+   +---------+   +---------+  \n              A             B             C\n\nWith mod_cache disabled on B\n---------------------------- \n1) When B requests a file on the IIS Server, IIS specifies in the response the \nAccept-Range: bytes directive and the Content-Length.\n2) When B sends the response to A, according to the RFC 2616, it removes the \nContent-Length from header and add a Transfer-Encoding: chunked directive.\n3) Then, A delivers the same response to the CLIENT.\n4) Everything seems OK in this case.\n\nWith mod_cache enabled on B\n---------------------------\n1) First request, the file is not on the cache. So B requests a file on the IIS \nServer, IIS specifies in the response the Accept-Range: bytes directive and the \nContent-Length.\n2) On B, mod_proxy removes the Content-Length header as said before, and pass \nthe response to mod_cache.\n3) On B, mod_cache doesn't see any Content-Length, so it considers the response \nas a stream (see bug 14364). It caches the response on the disk, and let \nmod_proxy deliver the response, as before.\n4) A delivers to the client as received from B.\n5) Second request, the file is on the cache. So on B, mod_cache delivers it to \nA with a Transfer-Encoding: chunked directive BUT also add the initial Content-\nLength. Why ?\n6) When A responds to the CLIENT, it puts the Content-Length value to zero, \nremoves the Transfer-Encoding: chunked directive and doesn't deliver the file.\n7) If, in the same HTTP/1.1 session, the client ask once more for the file, \nthen after a long time (15 seconds !) A delivers a \"2-chunks\" response, the \nsecond one containing the response (header+file) received from B.\n\nNetwork Traces to illustrate\n----------------------------\nRequest:\nGET /images/logogfa.gif HTTP/1.1\nHost: www.lea.generali.fr\n\n1) Received by B from IIS\nHTTP/1.1 200 OK\nServer: Microsoft-IIS/5.0\nDate: Fri, 08 Nov 2002 11:53:10 GMT\nContent-Type: image/gif\nAccept-Ranges: bytes\nLast-Modified: Thu, 04 Apr 2002 11:53:18 GMT\nETag: \"0cb674fcfdbc11:abf\"\nContent-Length: 2011\n...(data)\n\n2-3) Receive by A from B (delivered by mod_proxy because image is not in the \ncache)\nHTTP/1.1 200 OK\nDate: Fri, 08 Nov 2002 12:00:12 GMT\nServer: Microsoft-IIS/5.0\nContent-Type: image/gif\nAccept-Ranges: bytes\nLast-Modified: Thu, 04 Apr 2002 11:53:18 GMT\nETag: \"0cb674fcfdbc11:abf\"\nTransfer-Encoding: chunked\n...(data)\n  \n4) Same response as 2-3) delivered by A to the CLIENT\n\n5) Second request for this file. Received by A from B (delivered by mod_cache \nbecause it is in the cache)\nHTTP/1.1 200 OK\nDate: Fri, 08 Nov 2002 12:02:33 GMT\nServer: Apache\nAccept-Ranges: bytes\nETag: \"0cb674fcfdbc11:abf\"\nLast-Modified: Thu, 04 Apr 2002 11:53:18 GMT\nTransfer-Encoding: chunked\nContent-Type: image/gif\nAge: 147959900\nContent-Length: 2011\nX-Pad: avoid browser bug\n...(data)\n\n6) Received by the CLIENT from A (only header, no data)\nHTTP/1.1 200 OK\nDate: Fri, 08 Nov 2002 12:04:48 GMT\nServer: Apache\nAccept-Ranges: bytes\nETag: \"0cb674fcfdbc11:abf\"\nLast-Modified: Thu, 04 Apr 2002 11:53:18 GMT\nContent-Type: image/gif\nAge: 282918407\nX-Pad: avoid browser bug\nContent-Length: 0\n\n7) Received by the CLIENT from A, after a new request for the same file in the \nsame HTTP/1.1 session than 6). It takes 15 seconds for the response to be \ndelivered by A.\nHTTP/1.1 200 OK\nDate: Fri, 08 Nov 2002 12:08:24 GMT\nServer: Apache\nTransfer-Encoding: chunked\nContent-Type: image/gif\n\n734 (1st chunk size)\n...(1st chunk data)\n5b4 (2nd chunk size followed by 2nd chunk data)\nHTTP/1.1 200 OK\nDate: Fri, 08 Nov 2002 12:08:30 GMT\nServer: Apache\nAccept-Ranges: bytes\nETag: \"0cb674fcfdbc11:abf\"\nLast-Modified: Thu, 04 Apr 2002 11:53:18 GMT\nTransfer-Encoding: chunked\nContent-Type: image/gif\nAge: 498052908\nContent-Length: 2011\nX-Pad: avoid browser bug\n...(data)\n0 (last chunk)", "is_private": false, "id": 25912, "creation_time": "2002-11-08T12:14:07Z", "time": "2002-11-08T12:14:07Z", "creator": "tcastelle@generali.fr", "bug_id": 14385, "attachment_id": null}, {"count": 1, "attachment_id": null, "creator": "rederpj@remulak.net", "is_private": false, "id": 27441, "time": "2002-12-04T22:24:09Z", "bug_id": 14385, "creation_time": "2002-12-04T22:24:09Z", "tags": [], "text": "I was unable to replicate this problem with the current version of code. Please\ntest it again in your environment with the latest code (2.1.0-dev or\n2.0.44-dev). There have been several fixes applied in areas of the code that\nimpact the function you were using."}, {"count": 2, "tags": [], "creator": "tcastelle@generali.fr", "attachment_id": null, "id": 27454, "time": "2002-12-05T08:59:05Z", "bug_id": 14385, "creation_time": "2002-12-05T08:59:05Z", "is_private": false, "text": "Yes indeed, this bug is fixed in the current CVS snapshot (see bug 14364). Sorry\nnot having mentioned it before ! Shame on me... ;-)\n\n\n"}]