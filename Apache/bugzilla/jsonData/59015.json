[{"count": 0, "tags": [], "bug_id": 59015, "attachment_id": null, "is_private": false, "id": 188482, "time": "2016-02-16T18:49:42Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2016-02-16T18:49:42Z", "text": "While running the TC 8 test suite and endless loop int he APR poller occured during the test org.apache.catalina.core.TestStandardWrapper. The situation might be a race condition that is not related to the specific test.\n\nCode was TC 8 HEAD plus APR 1.2.4 based on OpenSSL 1.0.2f and APR 1.5.2. Platform Sun Solaris 10 Sparc. The machine was pretty busy, when the problem occured.\n\nError message occuring before the loop starts (only one such message):\n\n    [junit] 16-Feb-2016 17:30:31.285 SEVERE [http-apr-127.0.0.1-auto-6-Poller] org.apache.tomcat.util.net.AprEndpoint$Poller.run Poller failed with error [9] : [Bad file number]\n\nRelevant stacks:\n\nmain seems to hang in\n\n    [junit] \"main\" prio=3 tid=0x0002a400 nid=0x2 runnable [0xfdf7d000]\n    [junit]    java.lang.Thread.State: RUNNABLE\n    [junit]     at org.apache.tomcat.jni.Pool.destroy(Native Method)\n    [junit]     at org.apache.tomcat.util.net.AprEndpoint$Sendfile.destroy(AprEndpoint.java:2147)\n    [junit]     at org.apache.tomcat.util.net.AprEndpoint.stopInternal(AprEndpoint.java:781)\n    [junit]     at org.apache.tomcat.util.net.AbstractEndpoint.stop(AbstractEndpoint.java:814)\n    [junit]     at org.apache.coyote.AbstractProtocol.stop(AbstractProtocol.java:517)\n    [junit]     at org.apache.catalina.connector.Connector.stopInternal(Connector.java:1011)\n    [junit]     at org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:224)\n    [junit]     - locked <0xe6337060> (a org.apache.catalina.connector.Connector)\n    [junit]     at org.apache.catalina.core.StandardService.stopInternal(StandardService.java:517)\n    [junit]     - locked <0xe633eb28> (a java.lang.Object)\n    [junit]     at org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:224)\n    [junit]     - locked <0xe633ea58> (a org.apache.catalina.core.StandardService)\n    [junit]     at org.apache.catalina.core.StandardServer.stopInternal(StandardServer.java:790)\n    [junit]     at org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:224)\n    [junit]     - locked <0xe633e2c8> (a org.apache.catalina.core.StandardServer)\n    [junit]     at org.apache.catalina.startup.Tomcat.stop(Tomcat.java:355)\n    [junit]     at org.apache.catalina.startup.TomcatBaseTest.tearDown(TomcatBaseTest.java:218)\n\n\nPoller seems to loop, whenever I look it is in:\n\n    [junit] \"http-apr-127.0.0.1-auto-6-Poller\" daemon prio=3 tid=0x004fbc00 nid=0x4d runnable [0xb2aff000]\n    [junit]    java.lang.Thread.State: RUNNABLE\n    [junit]     at org.apache.tomcat.jni.Poll.create(Native Method)\n    [junit]     at org.apache.tomcat.util.net.AprEndpoint.allocatePoller(AprEndpoint.java:881)\n    [junit]     at org.apache.tomcat.util.net.AprEndpoint$Poller.run(AprEndpoint.java:1988)\n    [junit]     at java.lang.Thread.run(Thread.java:745)\n    [junit]\n\nRegards,\n\nRainer"}, {"count": 1, "tags": [], "creator": "rainer.jung@kippdata.de", "attachment_id": null, "is_private": false, "id": 188483, "time": "2016-02-16T19:02:12Z", "bug_id": 59015, "creation_time": "2016-02-16T19:02:12Z", "text": "Additional info:\n\n- truss does not show any system call activity.\n- unfortunately I forgot to use pstack to get info about the native frames"}, {"count": 2, "tags": [], "text": "It looks like the Poller thread enters the if (reset) { ... block during shutdown. That looks like it could create all sorts of chaos. Fixing that should be fairly easy.", "is_private": false, "bug_id": 59015, "id": 188733, "time": "2016-02-23T20:29:43Z", "creator": "markt@apache.org", "creation_time": "2016-02-23T20:29:43Z", "attachment_id": null}, {"count": 3, "tags": [], "text": "OK. Fixed in 9.0.x (for 9.0.0.M4 onwards), 8.0.x (for 8.0.33 onwards) and 7.0.x (for 7.0.69 onwards).", "attachment_id": null, "id": 188734, "creator": "markt@apache.org", "time": "2016-02-23T20:39:56Z", "bug_id": 59015, "creation_time": "2016-02-23T20:39:56Z", "is_private": false}]