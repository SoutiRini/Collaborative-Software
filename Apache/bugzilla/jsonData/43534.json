[{"count": 0, "tags": [], "bug_id": 43534, "attachment_id": null, "text": "The changes in APR 1.2.10+ and Apache 2.2.6 caused mod_perl 2.0.3 to fail on\nWindows.\n\nmod_perl attempts to save stdin and stdout on entry and restore them on exit.\n\nmod_perl uses POSIX-like int file descriptors - _fileno(stdin) and\n_fileno(stdout) - for this.\n\nThese file descriptors are not updated by setting STD_INPUT_HANDLE and\nSTD_OUTPUT_HANDLE via SetStdHandle(). For example,\nSetStdHandle(STD_INPUT_HANDLE, newhand) does not change the HANDLE associated\nwith _fileno(stdin). _fileno(stdin) still refers to the original Windows HANDLE\n - the pipe handle, regardless of whether it is open or has been closed.\n\nThis can be seen by comparing the return value from\nGetStdHandle(STD_INPUT_HANDLE) to the value from _get_osfhandle(_fileno(stdin))\nbefore and after mpm_winnt.c replaces the stdin handle.\n\nmpm_winnt currently creates a HANDLE to \"NUL\" as a replacement stdout when\nApache is run as a Windows Service.  Because a console-device HANDLE is not\nuseable (always returns \"invalid handle\") when it is inherited by a detached\nprocess, this is needed for command-line too.\n\nAttached is a patch to mpm_winnt (2.2.x branch) which:\n\n1. Creates the \"NUL\" stdout in the parent for both service and cmd-line\nexecution, rather than just for service. Only single-process mode (-X) retains\nthe original console-device stdout HANDLE.\n\n2. Uses _dup2() in the child to replace the stdin file descriptor with the\nstdout file descriptor (i.e. to set stdout to \"NUL\" except in single-process\nmode).  Note that this has the side-effect of closing the regular Windows HANDLE\nto the stdin pipe too, so it must be done after the child is done reading from\nthe parent.\n\n3. Sets the Windows HANDLEs (but not the file descriptors) for stdout and stderr\nto INVALID_HANDLE_VALUE at child_init for FastCGI modules. See APR bug 43329. \nThis would allow current Windows FastCGI modules to work with APR 1.2.10+\nwithout requiring APR_NO_FILE flag changes until a major Apache release, while\nother non-Apache APR programs could still take advantage of the APR process\ncreation changes.\n\nThis patch works with mod_fastcgi, mod_fcgid, and mod_perl on Win2k and Vista\nwhen built with either VC6 and VS8.", "id": 108885, "time": "2007-10-02T04:08:33Z", "creator": "Tom.Donovan@acm.org", "creation_time": "2007-10-02T04:08:33Z", "is_private": false}, {"count": 1, "tags": [], "text": "Created attachment 20905\nmod_perl and FastCGI patch\n\nAllows mod_perl and FastCGI programs to run with Apache 2.2.6 on Windows", "is_private": false, "id": 108886, "creator": "Tom.Donovan@acm.org", "time": "2007-10-02T04:10:25Z", "bug_id": 43534, "creation_time": "2007-10-02T04:10:25Z", "attachment_id": 20905}, {"count": 2, "tags": [], "creator": "Tom.Donovan@acm.org", "text": "Typo in 2. above - I meant:\n\n\"(i.e. to set stdin to \"NUL\" except in single-process\nmode)\"\n\nAlso observed that this patch does not interfere with the new APR behavior re:\nnot leaking unwanted handles.  rotatelogs.exe works as expected with APR 1.2.10+.\n", "id": 108890, "time": "2007-10-02T05:52:13Z", "bug_id": 43534, "creation_time": "2007-10-02T05:52:13Z", "is_private": false, "attachment_id": null}, {"count": 3, "attachment_id": 21264, "bug_id": 43534, "text": "Created attachment 21264\nnew patch for 2.2.x branch 12/12/2007\n\nUpdated patch for 2.2.x trunk (revision 603073 - Dec 12, 2007).  \n\nPer Bug 43329 - reverting the apr_proc_create behavior fixes the problem for\nnew processes created by mod_fastcgi or mod_fcgid.  STD_OUTPUT_HANDLE and\nSTD_ERROR_HANDLE are now INVALID_HANDLE_VALUE as required.\n\nThe Apache child process itself must be created with valid stdout and stdin\nfile descriptors (vs. HANDLEs) for modules which use fd's. It is OK for these\nto be file descriptors to \"NUL\".\n\nThis patch always creates the Apache child with \"NUL\" as stdout, which the\nchild later _dup2's to stdin after all the info has been collected from the\nparent via the stdin pipe.  This leaves the Apache child with acceptable fd's\nfor stdin and stdout to satisfy modules which use fd's instead of HANDLEs (like\nmod_perl).", "id": 111715, "time": "2007-12-12T10:57:55Z", "creator": "Tom.Donovan@acm.org", "creation_time": "2007-12-12T10:57:55Z", "tags": [], "is_private": false}, {"count": 4, "attachment_id": null, "bug_id": 43534, "is_private": false, "id": 112255, "time": "2007-12-28T13:00:26Z", "creator": "wrowe@apache.org", "creation_time": "2007-12-28T13:00:26Z", "tags": [], "text": "I'm reviewing the patch I had already authored (see URL above) which applied\nto both 2.2.x and 2.0.x branches.\n\nI'll then examine that it meets the requirements of the patch Tom has attached\nto this incident, because I think it covers all the bases but need to confirm.\n\nIf anyone else active in resolving this bug is interested, the current httpd\n2.2.x branch from svn, and the 1.2.12 apr[-util] release (or 1.2.x svn branch)\ncan be used to verify the current behavior before release."}, {"count": 5, "tags": [], "bug_id": 43534, "attachment_id": null, "text": "(In reply to comment #4)\n> I'm reviewing the patch I had already authored (see URL above) which applied\n> to both 2.2.x and 2.0.x branches.\n\nNot sure which \"URL above\" is meant here.\n\nThe current revision of the 2.2.x branch (rev 607543 30-Dec-2007), which\nincludes change 607311 to mpm_winnt.c, will run mod_perl only when Apache is\nstarted as a Windows service.  If Apache is started from the command line, the\nerror when mod_perl is invoked is:\n\n Failed to dup STDOUT: Bad file descriptor.\n [Sun Dec 30 08:18:22 2007] [notice] Parent: child process exited with status 9\n-- Restarting.\n\nIt is a welcome improvement that mod_perl errors (like \"Failed to dup\") now\nappear in the error log.", "id": 112299, "time": "2007-12-30T05:43:27Z", "creator": "Tom.Donovan@acm.org", "creation_time": "2007-12-30T05:43:27Z", "is_private": false}, {"count": 6, "tags": [], "text": "Created attachment 21351\nUpdated patch for 2.2.7\n\nUpdated patch to work with Apache 2.2.7 RC.  Only the command-line case needed\nto be fixed.  \n\nmpm_winnt already creates a stdout handle to \"NUL\", but only when started as a\nWindows Service.  This \"NUL\" handle is acceptable to mod_perl as both stdin and\nstdout.  Since console handles don't inherit - when Apache is started from the\ncommand-line mod_perl gets an invalid stdout. This patch changes mpm_winnt to\n*always* create a \"NUL\" stdout handle when creating a child process, for both\nWindows service and command-line startup.\n\nSingle-process mode (-X) has always worked with mod_perl.  There is no process\ncreation, therefore no handle inheritance is involved.\tBecause the original\n(real) console handles are valid, mod_perl runs correctly.", "is_private": false, "id": 112536, "creator": "Tom.Donovan@acm.org", "time": "2008-01-06T06:40:26Z", "bug_id": 43534, "creation_time": "2008-01-06T06:40:26Z", "attachment_id": 21351}, {"count": 7, "tags": [], "bug_id": 43534, "text": "Troubles with this patch; it doesn't mirror unix behavior (which is actually\nright in this case) and it introduces a service regression just as the earlier\npatch I committed introduced a console regression.\n\nThe unix behavior is that the stdout channel should be fixed at the moment that \nconfigure is finished.  This ensures any normal emits from perl, etc are seen\nin the parent by the user.  I'm working to track down where that happens, it\nmay be at daemonize() and actually embedded in apr, and I'm looking at a best\nsolution to mirror unix.\n\nThe regression is that stdio (and stderr and stdin) are third rails in a service\nthat we can't touch before they have been repaired.  The existing location of\nthe stdout substitution can't and won't be changed.\n\nThanks for the patch and the thorough explanation on dev@httpd, I'm proceeding\nwith the patch that will resolve this without modifying unix nor services.\n\n", "id": 112543, "time": "2008-01-06T09:09:46Z", "creator": "wrowe@apache.org", "creation_time": "2008-01-06T09:09:46Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "text": "Here we go;\n\non Unix, apr_proc_detach(1) causes all of the descriptors to be replaced with\nthe /dev/null handle, and this is precisely the behavior we want.\n\nToday on unix this occurs in pre_config (c.f. worker.c and prefork.c).  However\nthis behavior is a bit borked in the minds of some developers, who are frustrated\nwith the fact that perl emits that showed up in 1.3 no longer show up in 2.0.\nBut I can agree for now that we have to mirror unix, at least our register_hooks\nand earlier pre_config hooks will mirror unix.\n\nSee the revised patch which only modifies normal console-mode operation at;\n\n  http://svn.apache.org/viewvc?view=rev&revision=609354\n\nreview and let me know if this satisfies your test cases, and I'll backport\nASAP.\n\n", "is_private": false, "id": 112544, "creator": "wrowe@apache.org", "time": "2008-01-06T09:38:44Z", "bug_id": 43534, "creation_time": "2008-01-06T09:38:44Z", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 43534, "attachment_id": null, "is_private": false, "id": 112545, "time": "2008-01-06T10:37:14Z", "creator": "wrowe@apache.org", "creation_time": "2008-01-06T10:37:14Z", "text": "Corrected patch cited (now that I can take it to win32).  Sorry the initial\nbackport was actually from unix.\n\nhttp://svn.apache.org/viewvc/httpd/httpd/trunk/server/mpm/winnt/mpm_winnt.c?r1=607677&r2=609366\n "}, {"count": 10, "tags": [], "bug_id": 43534, "text": "(In reply to comment #9)\nr609366 applied to Apache 2.2.7 works as expected.\n\nWindows-service, command-line, and single-process (-X) all run mod_perl OK with\nthis change.\n\nCommand-line startup with no console also works OK - e.g. \"START /B httpd.exe\"\nor Apache started via CreateProcess(...DETACHED_PROCESS...).\n", "id": 112575, "time": "2008-01-07T06:14:03Z", "creator": "Tom.Donovan@acm.org", "creation_time": "2008-01-07T06:14:03Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "text": "Backported to both 2.0 and 2.2, I think we can at last tag this FIXED for the\nforthcoming 2.2.8 and 2.0.63 releases.  Thanks for all of your help Tom!", "is_private": false, "id": 112593, "creator": "wrowe@apache.org", "time": "2008-01-07T09:39:03Z", "bug_id": 43534, "creation_time": "2008-01-07T09:39:03Z", "attachment_id": null}, {"count": 12, "tags": [], "creator": "Tom.Donovan@acm.org", "text": "(In reply to comment #11)\n> Backported to both 2.0 and 2.2, I think we can at last tag this FIXED for the\n> forthcoming 2.2.8 and 2.0.63 releases.  Thanks for all of your help Tom!\n\nThanks for the kind words - but you may not want to thank me just yet.\n\nI failed to notice that with the current fix, closing the Apache window does not\nshut down Apache (presuming a window is displayed) .  Ditto for right-click\n[Close] on the task-bar icon.  This was not a problem with the previous patch,\nso somehow the windows console (vs. the child window itself) is not associated\nwith the parent process with this fix.\n\nI see this on Win2k and Steffen reports the same on XP. I regret we didn't catch\nthis quicker.", "id": 112597, "time": "2008-01-07T11:45:46Z", "bug_id": 43534, "creation_time": "2008-01-07T11:45:46Z", "is_private": false, "attachment_id": null}, {"count": 13, "tags": [], "bug_id": 43534, "text": "Fixed in 2.2.8.", "id": 113013, "time": "2008-01-19T11:49:57Z", "creator": "rpluem@apache.org", "creation_time": "2008-01-19T11:49:57Z", "is_private": false, "attachment_id": null}]