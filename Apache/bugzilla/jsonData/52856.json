[{"count": 0, "tags": [], "creator": "dmitry.kukushkin@external.telekom.de", "attachment_id": null, "id": 154695, "time": "2012-03-08T14:29:04Z", "bug_id": 52856, "creation_time": "2012-03-08T14:29:04Z", "is_private": false, "text": "How to reproduce:\nTomcat with the APR connector, using HTTPS scheme, when a client requests for some quite a big (~100K-200K) static file, and breaks the connection unexpectedly.\nShell script to reproduce:\n#!/bin/bash\n# A way to reproduce the bug in the APR connector.\n# Must be run from a different machine, the Tomcat is running on.\n# Author: Andreas Florath ( andreas.florath at external.telekom.de )\n\n\nfor port in 17890 17891 17892 17893 17894 17895 17896 17897 17898 17899; do\n     curl --local-port $port --insecure \"https://<host>:<port>/<some big file>\" &\n     sleep 0.1\n     iptables -A OUTPUT -p tcp --sport $port -j REJECT\ndone\n\n\nConnector enters a socket write loop, taking nearly 1 CPU core.\nA snippet from the strace log:\n...\n[pid 32221] write(91, \"\\347\\2\\22\\36\\334\\222\\2525g\\215\\342\\352A\\324\\246\\340\\7\\265(\\205n\\362\\215\\34az\\363>\\37Up\\213\"..., 1789 <unfinished ...>\n[pid 32222] <... futex resumed> )       = 0\n[pid 32221] <... write resumed> )       = -1 EAGAIN (Resource temporarily unavailable)\n[pid 32222] write(94, \"\\276\\275\\263zN\\n\\20^\\35\\200\\3.\\5\\n\\35\\300o\\364\\373\\305\\356\\35\\24{\\302\\200\\242\\346\\22\\241\\256\\326\"..., 2812 <unfinished ...>\n[pid 32221] write(91, \"\\347\\2\\22\\36\\334\\222\\2525g\\215\\342\\352A\\324\\246\\340\\7\\265(\\205n\\362\\215\\34az\\363>\\37Up\\213\"..., 1789 <unfinished ...>\n[pid 32222] <... write resumed> )       = -1 EAGAIN (Resource temporarily unavailable)\n[pid 32221] <... write resumed> )       = -1 EAGAIN (Resource temporarily unavailable)\n[pid 32222] write(94, \"\\276\\275\\263zN\\n\\20^\\35\\200\\3.\\5\\n\\35\\300o\\364\\373\\305\\356\\35\\24{\\302\\200\\242\\346\\22\\241\\256\\326\"..., 2812 <unfinished ...>\n[pid 32221] write(91, \"\\347\\2\\22\\36\\334\\222\\2525g\\215\\342\\352A\\324\\246\\340\\7\\265(\\205n\\362\\215\\34az\\363>\\37Up\\213\"..., 1789 <unfinished ...>\n[pid 32222] <... write resumed> )       = -1 EAGAIN (Resource temporarily unavailable)\n[pid 32221] <... write resumed> )       = -1 EAGAIN (Resource temporarily unavailable)\n...\n\nPossible patch:\nAdd polling for writing with the timeout before the next ssl socket write attempt in case of EAGAIN\n--- tomcat-native-1.1.22-src/jni/native/src/sslnetwork.c\n+++ tomcat-native-1.1.22-src/jni/native/src/sslnetwork.c\n@@ -471,7 +471,7 @@\n                 break;\n                 case SSL_ERROR_WANT_READ:\n                 case SSL_ERROR_WANT_WRITE:\n-                    if (nb && i == SSL_ERROR_WANT_WRITE) {\n+                    if (nb && i == SSL_ERROR_WANT_WRITE && !APR_STATUS_IS_EAGAIN(os) ) {\n                         *len = 0;\n                         return APR_SUCCESS;\n                     }"}, {"count": 1, "tags": [], "text": "*** Bug 54064 has been marked as a duplicate of this bug. ***", "attachment_id": null, "bug_id": 52856, "id": 163518, "time": "2012-11-19T05:35:30Z", "creator": "mturk@apache.org", "creation_time": "2012-11-19T05:35:30Z", "is_private": false}, {"count": 2, "tags": [], "creator": "mturk@apache.org", "is_private": false, "text": "Fixed in the SVN (1.1.x branch)\nWill be part of 1.1.25 release.\n\nNote that I didn't use your patch. The entire SSL send loop was a bit bogus, so I did some serious cleanup.\n\nHowever your test case helped a lot!\nWith 1.1.24 I see 98%CPU, with 1.1.25-dev it never goes beyond 62.5% on localhost for 80MB file.", "id": 163519, "time": "2012-11-19T05:39:23Z", "bug_id": 52856, "creation_time": "2012-11-19T05:39:23Z", "attachment_id": null}]