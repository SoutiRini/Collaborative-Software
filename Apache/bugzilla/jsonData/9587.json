[{"count": 0, "tags": [], "creator": "Timo.Weingaertner@web.de", "text": "If a directory contains a file listet in the DirectoryIndex directive, the \nfolder icon is replaced by the icon for the DirectoryIndex file, \ne.g. /icons/layout.gif if there is a file named index.html.", "id": 17102, "time": "2002-06-03T19:52:08Z", "bug_id": 9587, "creation_time": "2002-06-03T19:52:08Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 9587, "is_private": false, "text": "Created attachment 2021\nRemoves the filename mod_dir attaches to the request_rec before find_icon receives it.", "id": 17371, "time": "2002-06-07T00:32:44Z", "creator": "dpejesh@yahoo.com", "creation_time": "2002-06-07T00:32:44Z", "attachment_id": 2021}, {"count": 2, "attachment_id": null, "creator": "wrowe@apache.org", "text": "\n  An extra stat()?  (and in the wrong place, at that.)  ICK.\n\n  The essentials are that we already stat()ed this somewhere \n  in the way-back machine, and then ran it through to discover\n  that it is really something else [e.g. requesting /foo/ will\n  return an html document ... index.html in that directory.]\n  That means it is -more- than just another folder.\n\n  The correct fix is probably deeper in the code.  I expect we\n  will need to determine the stat() just a little bit earlier.\n  If I can prove the stat() always occurs, and that dir_walk\n  and file_walk will just borrow the pre-existing stat, then\n  noone should shoot us for requesting more detailed information\n  from apr_dir_read().\n\n  In any case, this should NOT BE OCCURING on Win32 unless some\n  patch to dir_walk, autoindex, or sub_req_lookup_dirent has it\n  borked.  Win32 apr_dir_read() already returns much more fileinfo\n  than most Unix platforms.\n\n  I will look at it, though I can't promise a fix in the 2.0.37\n  timeframe.  Certainly by 2.0.38.\n\n  \n\n  ", "id": 17386, "time": "2002-06-07T03:28:22Z", "bug_id": 9587, "creation_time": "2002-06-07T03:28:22Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "text": "The problem arises when mod_autoindex calls ap_sub_req_lookup_dirent on each of\nthe sub directories.  The returned request_rec.filename has the DirectoryIndex\nfile attached to it.  So, I figured it was best to strip that file off the end\nof the rr.filename before passing it to find_icon.\n\nThe ap_is_directory call is far from necessary... all that's needed is\n    rr->filename = ap_make_dirstr_parent (rr->pool, rr->filename);\n\n", "attachment_id": null, "bug_id": 9587, "id": 17388, "time": "2002-06-07T05:26:33Z", "creator": "dpejesh@yahoo.com", "creation_time": "2002-06-07T05:26:33Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 9587, "attachment_id": null, "is_private": false, "id": 17402, "time": "2002-06-07T14:49:57Z", "creator": "wrowe@apache.org", "creation_time": "2002-06-07T14:49:57Z", "text": "\n  \"The problem arises when mod_autoindex calls ap_sub_req_lookup_dirent \n  on each of the sub directories.\"\n\n  This is why the code once relied on dirent->type instead of rr->finfo->type.\n  However, some folks pointed out that Unix doesn't determine the filetype on\n  a dirread() call, and we would have to beg unix to do so.  However, if we\n  did that, we would want to prove we aren't wasting extra stats, and that\n  ap_sub_req_lookup_dirent will pass that info on to rr->finfo, which dir_walk\n  will actually consume.\n\n  If that code works correctly, it's just a matter of passing APR_FINFO_MIN\n  along with APR_FINFO_DIRENT switches to apr_dir_read.\n"}, {"count": 5, "attachment_id": null, "bug_id": 9587, "is_private": false, "id": 40689, "time": "2003-07-15T02:46:02Z", "creator": "noisefactor@netscape.net", "creation_time": "2003-07-15T02:46:02Z", "tags": [], "text": " i had to tweak the mod_autoindex.c in the\nlatest version of apache to get it\nto work right.  here are my work arounds:\n\n         //if (!(p->icon = find_icon(d, rr, 1))) {\n                // was getting wrong icons on folders\n                p->icon = find_default_icon(d, \"^^DIRECTORY^^\");\n            //}\n            if (!(p->alt = find_alt(d, rr, 1))) {\n                if (!(p->alt = find_default_alt(d, \"^^DIRECTORY^^\"))) {\n                    p->alt = \"DIR\";\n                }\n            }\n        }\n        else {\n            p->icon = find_icon(d, rr, 0);\n            p->alt = find_alt(d, rr, 0);\n            p->size = rr->finfo.size;\n        }\n\n\n        p->desc = find_desc(d, rr->filename);\n\n        if ((!p->desc) && (autoindex_opts & SCAN_HTML_TITLES)) {\n                //added this check -- was getting garbage description on folder\n           if (dirent->filetype != APR_DIR)  \n                p->desc = apr_pstrdup(r->pool, find_title(rr));\n        }"}, {"count": 6, "tags": [], "text": "Commenting out 'if (!(p->icon = find_icon(d, rr, 1)))' breaks the ability to\nspecify an icon for a directory with an AddIcon directive .  I've walked through\nthis code a ton of times and the simplest patch i've come up with is...\n\nIndex: modules/generators/mod_autoindex.c\n===================================================================\nRCS file: /home/cvspublic/httpd-2.0/modules/generators/mod_autoindex.c,v\nretrieving revision 1.119\ndiff -u -r1.119 mod_autoindex.c\n--- modules/generators/mod_autoindex.c  2 Mar 2003 18:06:16 -0000       1.119\n+++ modules/generators/mod_autoindex.c  15 Jul 2003 07:28:50 -0000\n@@ -1361,6 +1361,7 @@\n             if (autoindex_opts & FOLDERS_FIRST) {\n                 p->isdir = 1;\n             }\n+            rr->filename = ap_make_dirstr_parent (rr->pool, rr->filename);\n             if (!(p->icon = find_icon(d, rr, 1))) {\n                 p->icon = find_default_icon(d, \"^^DIRECTORY^^\");\n             }\n\nwhich removes the appended filename added by mod_dir, if any, from rr->filename\nwhich results in find_icon seeing the correct filename.\n", "attachment_id": null, "bug_id": 9587, "id": 40703, "time": "2003-07-15T07:51:36Z", "creator": "dpejesh@yahoo.com", "creation_time": "2003-07-15T07:51:36Z", "is_private": false}, {"count": 7, "attachment_id": null, "creator": "nd@perlig.de", "text": "this looks reasonable to me. Committed in 2.1 and proposed for backport.\n\nThanks for patch (and your patience :), Shane.", "id": 40714, "time": "2003-07-15T13:31:42Z", "bug_id": 9587, "creation_time": "2003-07-15T13:31:42Z", "tags": [], "is_private": false}, {"count": 8, "attachment_id": null, "bug_id": 9587, "is_private": false, "id": 43922, "time": "2003-09-10T07:08:20Z", "creator": "nd@perlig.de", "creation_time": "2003-09-10T07:08:20Z", "tags": [], "text": "*** Bug 23050 has been marked as a duplicate of this bug. ***"}]