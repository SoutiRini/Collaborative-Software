[{"count": 0, "tags": [], "bug_id": 56094, "attachment_id": null, "text": "quote from the httpd-devl-list:\n\n> It looks to me like it is not exposed in mod_rewrite.\n> I'd suggest opening a bug \"mod_rewrite doesn't expose client_addr\".\n> For consistency, I'd suggest CONN_REMOTE_ADDR as in the expression parser\n___________________________\n\nmod_rewrite can't distinguish between %a and %{c}a currently\n\nthe idea is that the proxy has 127.0.0.1 and does SSL-termination\nso it should use unecrypted connections to httpd, but in case\nthe connection comes from a different IP mod_rewrite is supposed\nto redirect the request as shown below to https\n\nwithout mod_remoteip the mod_rewrite snipped works as expected\nso only a replacement for %{REMOTE_ADDR} would be needed that\nuses the underlying peer IP address of the connection\n\n<IfModule mod_remoteip.c>\n RemoteIPHeader X-Forwarded-For\n RemoteIPInternalProxy 127.0.0.1\n</IfModule>\n<IfModule mod_rewrite.c>\n RewriteEngine on\n RewriteCond %{REMOTE_ADDR} !^127\\.0\\.0\\.1\n RewriteCond %{HTTPS} off\n RewriteRule (.*) https://www.example.com%{REQUEST_URI}\n</IfModule>\n\nhttp://httpd.apache.org/docs/2.4/mod/mod_rewrite.html\n\nhttp://httpd.apache.org/docs/2.4/mod/mod_log_config.html\n%a \tClient IP address of the request (see the mod_remoteip module).\n%{c}a \tUnderlying peer IP address of the connection (see the mod_remoteip module)", "id": 172821, "time": "2014-01-31T11:15:56Z", "creator": "h.reindl@thelounge.net", "creation_time": "2014-01-31T11:15:56Z", "is_private": false}, {"count": 1, "attachment_id": 31276, "bug_id": 56094, "text": "Created attachment 31276\nPatch for issue\n\nAdds support for CONN_REMOTE_ADDR to mod_rewrite", "id": 172833, "time": "2014-01-31T21:02:03Z", "creator": "Chaosed0@gmail.com", "creation_time": "2014-01-31T21:02:03Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "creator": "Chaosed0@gmail.com", "attachment_id": 31277, "id": 172835, "time": "2014-01-31T21:10:53Z", "bug_id": 56094, "creation_time": "2014-01-31T21:10:53Z", "is_private": false, "text": "Created attachment 31277\nWrong patch before - this adds CONN_REMOTE_ADDR to mod_rewrite"}, {"count": 3, "tags": [], "bug_id": 56094, "attachment_id": 31276, "text": "Comment on attachment 31276\nPatch for issue\n\nRemove patch marker now content has been removed by ASF infra", "id": 172837, "time": "2014-01-31T21:45:28Z", "creator": "markt@apache.org", "creation_time": "2014-01-31T21:45:28Z", "is_private": false}, {"count": 4, "tags": [], "creator": "h.reindl@thelounge.net", "text": "*wow* that was fast!\n\nsomehow rpmbuild does not like the patch format :-(\nmaybe i find out how to fix and give feedback\notherwise a \"unified diff\" would be cool\n\n+ echo 'Patch #8 (httpd-2.4-mod_rewrite_conn_remote_addr.patch):'\nPatch #8 (httpd-2.4-mod_rewrite_conn_remote_addr.patch):\n+ /usr/bin/cat /home/builduser/rpmbuild/SOURCES/httpd-2.4-mod_rewrite_conn_remote_addr.patch\n+ /usr/bin/patch -p1 --fuzz=0\ncan't find file to patch at input line 3\nPerhaps you used the wrong -p or --strip option?\nThe text leading up to this was:\n--------------------------\n|--- modules/mappers/mod_rewrite.c      (revision 1563220)\n|+++ modules/mappers/mod_rewrite.c      (working copy)\n--------------------------\nFile to patch:", "id": 172838, "time": "2014-01-31T22:51:15Z", "bug_id": 56094, "creation_time": "2014-01-31T22:51:15Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 56094, "attachment_id": null, "id": 172839, "time": "2014-01-31T23:23:17Z", "creator": "h.reindl@thelounge.net", "creation_time": "2014-01-31T23:23:17Z", "is_private": false, "text": "got it - the patch is fine, rpmbuild on likes a path-component before \"modules\", most likely because -p1, well i am not that good in patch-handling\n\nthe config below works exactly as expected - thank you!\n\n%prep\n%setup -q\n%patch1 -p1\n%patch2 -p1\n%patch3 -p1\n%patch4 -p1\n%patch5 -p1\n%patch6 -p1\n%patch7 -p1\n%patch8 -p1\n______________________________________\n\n<IfModule mod_rewrite.c>\n RewriteEngine on\n RewriteCond %{CONN_REMOTE_ADDR} !^127\\.0\\.0\\.1\n RewriteCond %{HTTPS} off\n RewriteRule (.*) https://www.example.com%{REQUEST_URI}\n</IfModule>"}, {"count": 6, "attachment_id": null, "bug_id": 56094, "text": "Thanks for the patch and test, commited to trunk in https://svn.apache.org/r1563418 and proposed for 2.4.x", "id": 172842, "time": "2014-02-01T14:04:48Z", "creator": "covener@gmail.com", "creation_time": "2014-02-01T14:04:48Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "bug_id": 56094, "attachment_id": null, "text": "i also made an RFE for RHEL7 on the Redhat-Bugzilla\nhttps://bugzilla.redhat.com/show_bug.cgi?id=1060536", "id": 172864, "time": "2014-02-02T17:04:51Z", "creator": "h.reindl@thelounge.net", "creation_time": "2014-02-02T17:04:51Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 56094, "attachment_id": null, "text": "Fixed in 2.4.8.", "id": 175776, "time": "2014-06-11T19:43:23Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-06-11T19:43:23Z", "is_private": false}]