[{"count": 0, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": 30152, "text": "Created attachment 30152\nhelloWorld.tagx\n\nSteps to reproduce:\n\n1. Go to  webapps\\examples\\WEB-INF\\tags\\\n2. Delete \"helloWorld.tag\" file and put there \"helloWorld.tagx\" file attached to this issue.\nThe file contains the following plus AL header:\n\n<?xml version=\"1.0\" encoding=\"utf-8\" ?>\n<jsp:root xmlns:jsp=\"http://java.sun.com/JSP/Page\" version=\"2.0\">\n<jsp:scriptlet><![CDATA[//\n  // ${foo}\n  out.println(\"Hello, world!!\");\n]]></jsp:scriptlet>\n</jsp:root>\n\n3. Start Tomcat and try to open the following page in a browser:\nhttp://localhost:8080/examples/jsp/jsp2/tagfiles/hello.jsp\n\nACTUAL result:\nin current TC8 trunk:\norg.xml.sax.SAXException: Body of scriptlet element must not contain any XML elements\n  org.apache.jasper.compiler.JspDocumentParser.checkScriptingBody(JspDocumentParser.java:1332)\n  org.apache.jasper.compiler.JspDocumentParser.endElement(JspDocumentParser.java:650)\n\t\n\nThis behaviour is caused by \"${foo}\" being present inside the scriptlet. If I remove that line, the page is displayed successfully.\n\nEXPECTED RESULT\nI think EL expressions should not be recognized inside of jsp:scriptlet, jsp:declaration or jsp:expression and should not trigger such an error.\n\nAs a confirmation, the following \"helloWorld.tag\" in JSP syntax compiles and executes successfully. Thus this issue is with XML syntax only,\n\n<%\n  // ${foo}\n%>\nHello, world!++\n\n\nAlternative solution could be to change the error message, but I think it is not the issue here,\ns/ any XML elements / any XML elements or EL expressions/", "id": 166397, "time": "2013-04-04T22:24:00Z", "bug_id": 54801, "creation_time": "2013-04-04T22:24:00Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 54801, "attachment_id": 30153, "id": 166398, "time": "2013-04-04T22:27:18Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-04-04T22:27:18Z", "is_private": false, "text": "Created attachment 30153\nStacktrace (current 7.0 = 7.0.39)"}, {"count": 2, "tags": [], "bug_id": 54801, "is_private": false, "text": "Created attachment 30167\n2013-04-10_tc8_54801_1.patch\n\n1. The JSP 2.2 specification chapter JSP.1.11 EL Elements says:\n\n\"EL expressions can appear in template data and in attribute values.\"\n\nI deduce that they cannot appear in scripting elements and thus trying to parse them there is a bug.\n\nScripting elements are represented in Jasper by abstract Node.ScriptingElement class. Its non-abstract derived classes are:  Declaration, Expression, Scriptlet.\n\n\n2. Parsing of EL here is performed in JspDocumentParser#processChars()\n\nI am attaching patch that fixes processing for scripting elements in processChars().\n\n\n3. It is strange that processChars() does EL parsing regardless of pageInfo.isELIgnored(). I suspect that it is a bug.\n\n\nThe code in the patch is the same as in \"if (tagDependentNesting > 0)\" block there, so the two could be merged, and be also used to fix the \"isELIgnored\" case.\n\nThere are no testcases in the patch yet.", "id": 166495, "time": "2013-04-09T22:19:03Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-04-09T22:19:03Z", "attachment_id": 30167}, {"count": 3, "tags": [], "bug_id": 54801, "attachment_id": 30168, "id": 166496, "time": "2013-04-09T22:34:45Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-04-09T22:34:45Z", "is_private": false, "text": "Created attachment 30168\npage1.jspx"}, {"count": 4, "tags": [], "bug_id": 54801, "attachment_id": 30169, "id": 166497, "time": "2013-04-09T22:35:14Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-04-09T22:35:14Z", "is_private": false, "text": "Created attachment 30169\npage2.jspx"}, {"count": 5, "tags": [], "bug_id": 54801, "is_private": false, "text": "> helloWorld.tagx\n\nThis issue is not specific to tag files and is reproducible with JSP documents as well. I attached \"page1.jspx\" and \"page2.jspx\" that reproduce this.\n\nI am changing TITLE of this issue accordingly.\n\nPresence of \"CDATA\" block is not important.\n\n\n(In reply to comment #2)\n>\n> 3. It is strange that processChars() does EL parsing regardless of\n> pageInfo.isELIgnored(). I suspect that it is a bug.\n> \n\nConfirmed as a bug. I filed it separately as bug 54821.", "id": 166501, "time": "2013-04-09T22:47:18Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-04-09T22:47:18Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 54801, "is_private": false, "text": "Fixed in trunk and will be included in 7.0.40 onwards.\nI turned the example JSP documents into unit tests.", "id": 166852, "time": "2013-04-25T13:21:14Z", "creator": "markt@apache.org", "creation_time": "2013-04-25T13:21:14Z", "attachment_id": null}]