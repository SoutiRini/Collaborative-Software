[{"count": 0, "tags": [], "bug_id": 59661, "attachment_id": null, "id": 191379, "time": "2016-06-03T08:51:40Z", "creator": "1983-01-06@gmx.net", "creation_time": "2016-06-03T08:51:40Z", "is_private": false, "text": "When the MailSessionFactory (https://github.com/apache/tomcat/blob/bbcad7fcc71e46952174b41eaef6ebcf45af9185/java/org/apache/naming/factory/MailSessionFactory.java) constructs the properties for the mail session, Properties does not receive System#getProperties().\n\nWe'd like to override mail.smtp.host (not localhost) and mail.smtp.localhost (OS issue) in setenv.sh passing to CATALINA_OPTS but unable to do so because it is not picked up.\n\nThis applies to all Tomcat versions.\n\nSMTPTransport uses PropUtil for a few properties by default from System#getProperties() but not for all (shortcoming?). Additionally, Transport does\n\n> Session s = (msg.session != null) ? msg.session :\n>\t\t     Session.getDefaultInstance(System.getProperties(), null);\n\nwhich is different to the config done in Tomcat. There must be a better way to support this.\n\nAlternatively, one must add those options to every context.xml, add to server.xml and work with resource links, or don't use the factory at all and let the code snippet from above make its work."}, {"count": 1, "tags": [], "bug_id": 59661, "text": "I guess it would be an enhancement, but I don't see the point, it's possible to define global resources, etc. So we won't add a system property on every field in Tomcat [this is basically the request here].", "id": 191380, "time": "2016-06-03T09:06:32Z", "creator": "remm@apache.org", "creation_time": "2016-06-03T09:06:32Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 59661, "text": "(In reply to Remy Maucherat from comment #1)\n> I guess it would be an enhancement, but I don't see the point, it's possible\n> to define global resources, etc. So we won't add a system property on every\n> field in Tomcat [this is basically the request here].\n\nWow, won't fixing with the speed of light? All you have to do is Properties p = new Properties(System.getProperties());\n\nThis is an enhancement which can easily be made. Since I have little control over the factory, this would be at least conforming with the code snippet shown.", "id": 191381, "time": "2016-06-03T09:11:31Z", "creator": "1983-01-06@gmx.net", "creation_time": "2016-06-03T09:11:31Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "chris@christopherschultz.net", "text": "Would you care to propose a small patch?", "id": 191398, "time": "2016-06-05T17:22:30Z", "bug_id": 59661, "creation_time": "2016-06-05T17:22:30Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 59661, "text": "(In reply to Christopher Schultz from comment #3)\n> Would you care to propose a small patch?\n\nYes, sure. Should the properties be added by default or with a config option?", "id": 191402, "time": "2016-06-05T21:27:48Z", "creator": "1983-01-06@gmx.net", "creation_time": "2016-06-05T21:27:48Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 59661, "attachment_id": 33915, "id": 191411, "time": "2016-06-06T12:44:10Z", "creator": "1983-01-06@gmx.net", "creation_time": "2016-06-06T12:44:10Z", "is_private": false, "text": "Created attachment 33915\nPatch for Tomcat 6.0"}, {"count": 6, "tags": [], "bug_id": 59661, "attachment_id": 33916, "text": "Created attachment 33916\nPatch for Tomcat 9.0", "id": 191412, "time": "2016-06-06T12:51:19Z", "creator": "1983-01-06@gmx.net", "creation_time": "2016-06-06T12:51:19Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 59661, "attachment_id": null, "text": "Added patches against 6.0 trunk and 9.0 trunk. Tests pass.\n\nI have removed the two default properties:\n* \"smtp\" is the default transport of none is set, see Session#getTransport()\n* Default mail localhost is derived from InetAdress.getLocalHost().getHostName(). This shall do in most cases.\n* Overriding system properties implicitly may cause problems", "id": 191414, "time": "2016-06-06T12:54:15Z", "creator": "1983-01-06@gmx.net", "creation_time": "2016-06-06T12:54:15Z", "is_private": false}, {"text": "I'm -1 on the patch as proposed. It allows the bypassing of the SecurityManager to access any system property. I've no objection to the system properties listed in Annex A of the JavaMail spec being explicitly copied across to be used as defaults where defined.", "tags": [], "bug_id": 59661, "attachment_id": null, "count": 8, "id": 191522, "time": "2016-06-10T09:52:03Z", "creator": "markt@apache.org", "creation_time": "2016-06-10T09:52:03Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 59661, "attachment_id": null, "text": "(In reply to Mark Thomas from comment #8)\n> I'm -1 on the patch as proposed. It allows the bypassing of the\n> SecurityManager to access any system property. I've no objection to the\n> system properties listed in Annex A of the JavaMail spec being explicitly\n> copied across to be used as defaults where defined.\n\nThe problem with copying is that you may missed custom attributes for custom providers. Though, being an edge cases, still valid.\nThe other point is that if your Mail does not have a Session associated, Transport with create a default one with the System Properties set. Deating your security concern by default. Have a look at the source code and you will see it.", "id": 191525, "time": "2016-06-10T11:54:17Z", "creator": "1983-01-06@gmx.net", "creation_time": "2016-06-10T11:54:17Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 59661, "attachment_id": null, "text": "(In reply to Michael Osipov from comment #9)\n> The problem with copying is that you may missed custom attributes for custom\n> providers. Though, being an edge cases, still valid.\n\nThose would have to be set explicitly on the factory.\n\n> The other point is that if your Mail does not have a Session associated,\n> Transport with create a default one with the System Properties set. Deating\n> your security concern by default. Have a look at the source code and you\n> will see it.\n\nI did look and that code is not inside a privileged block so it can't bypass the SecurityManager.\n\nMy position remains unchanged from that set out in comment #8.", "id": 191537, "time": "2016-06-10T18:52:14Z", "creator": "markt@apache.org", "creation_time": "2016-06-10T18:52:14Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 59661, "text": "(In reply to Mark Thomas from comment #10)\n> (In reply to Michael Osipov from comment #9)\n> > The problem with copying is that you may missed custom attributes for custom\n> > providers. Though, being an edge cases, still valid.\n> \n> Those would have to be set explicitly on the factory.\n\nI think that would default the simplicity of the factory. Especially that most properties apply per provider/protocol.\n\n> > The other point is that if your Mail does not have a Session associated,\n> > Transport with create a default one with the System Properties set. Deating\n> > your security concern by default. Have a look at the source code and you\n> > will see it.\n> \n> I did look and that code is not inside a privileged block so it can't bypass\n> the SecurityManager.\n> \n> My position remains unchanged from that set out in comment #8.\n\nYou are right. It is done in a lower level. Is ssing the SecurityManager in the session factory a way to go or still a leakage?", "id": 191538, "time": "2016-06-10T19:30:07Z", "creator": "1983-01-06@gmx.net", "creation_time": "2016-06-10T19:30:07Z", "is_private": false, "attachment_id": null}, {"text": "Not necessary anymore since there is no interest in this.", "tags": [], "bug_id": 59661, "attachment_id": null, "count": 12, "id": 196246, "time": "2017-01-20T13:34:15Z", "creator": "1983-01-06@gmx.net", "creation_time": "2017-01-20T13:34:15Z", "is_private": false}]