[{"count": 0, "tags": [], "text": "This initially looked similar to bug 60717, but it seems like that might be a coincidence.\n\nIf the configured ws:// backend for a proxy_wstunnel request immediately returns a final response code and closes the connection instead of upgrading, proxy_wstunnel will send an extra \"Bad Gateway\" response body after the response that has already been sent. Here's an example where the backend is responding to a client that hasn't sent a supported Sec-WebSocket-Version:\n\nHTTP/1.1 400 Bad Request\nDate: Wed, 12 Jul 2017 16:54:20 GMT\nServer: Apache/2.4.28-dev (Unix) OpenSSL/1.0.2g\nSec-WebSocket-Version: 13,8,7\nContent-Length: 226\nConnection: close\nContent-Type: text/html; charset=iso-8859-1\n\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>400 Bad Request</title>\n</head><body>\n<h1>Bad Request</h1>\n<p>Your browser sent a request that this server could not understand.<br />\n</p>\n</body></html>\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>502 Bad Gateway</title>\n</head><body>\n<h1>Bad Gateway</h1>\n<p>The proxy server received an invalid\nresponse from an upstream server.<br />\n</p>\n</body></html>", "is_private": false, "id": 199745, "creator": "jchampion@apache.org", "time": "2017-07-12T18:30:39Z", "bug_id": 61283, "creation_time": "2017-07-12T18:30:39Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 61283, "is_private": false, "id": 199747, "attachment_id": null, "creator": "jchampion@apache.org", "creation_time": "2017-07-12T19:16:01Z", "time": "2017-07-12T19:16:01Z", "text": "It looks like the code added in r1669299 might be backwards? It sets the `replied` flag if the client sends data, but it seems like we wanted it to be set if the server sends data."}, {"count": 2, "tags": [], "bug_id": 61283, "attachment_id": null, "id": 199748, "time": "2017-07-12T21:52:50Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2017-07-12T21:52:50Z", "is_private": false, "text": "Actually it was fixed in r1754164, but never proposed for backport (my bad)."}, {"count": 3, "tags": [], "bug_id": 61283, "attachment_id": null, "text": "Is there any wiggle room to consider backporting this?\n\nIt affects more than just 502 responses; in my experience, *any* time the backend server sends a valid WS payload and closes the connection right away triggers this bug. My application is a log tailer, and any time I fetch a log that\u2019s already completed I run into this bug.\n\nI observed it in 2.4.25. I didn\u2019t try 2.4.27.", "id": 199803, "time": "2017-07-14T22:05:56Z", "creator": "felipe@felipegasper.com", "creation_time": "2017-07-14T22:05:56Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 61283, "text": "Proposed for backport with r1801997.", "id": 199804, "time": "2017-07-14T22:33:32Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2017-07-14T22:33:32Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "creator": "jchampion@apache.org", "attachment_id": null, "id": 199805, "creation_time": "2017-07-14T23:11:31Z", "time": "2017-07-14T23:11:31Z", "bug_id": 61283, "text": "(In reply to felipe from comment #3)\n> It affects more than just 502 responses; in my experience, *any* time the\n> backend server sends a valid WS payload and closes the connection right away\n> triggers this bug.\nI've updated the bug title to help other people looking for this problem; thanks for pointing it out.", "is_private": false}, {"count": 6, "tags": [], "bug_id": 61283, "attachment_id": null, "id": 201271, "time": "2017-10-03T11:55:01Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2017-10-03T11:55:01Z", "is_private": false, "text": "Backported to 2.4.28 in r1802144."}]