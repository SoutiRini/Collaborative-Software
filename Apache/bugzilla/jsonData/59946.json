[{"attachment_id": 34103, "tags": [], "bug_id": 59946, "is_private": false, "count": 0, "id": 192898, "time": "2016-08-05T03:52:40Z", "creator": "Teemu.Vesala@qentinel.com", "creation_time": "2016-08-05T03:52:40Z", "text": "Created attachment 34103\nSample test file to show memory leak\n\nI noticed that there is major increase at memory usage when JSR223 components are used without caching the compiled script. The attached test script contains only JSR223 sampler with script \"def x = 1 + 1\" which should not leak memory. But if you execute it, you quickly notice that it increases the memory usage.\n\nThis does not affect to JMeter if the compiled script is cached. So I recommend it, but still this can be an issue.\n\nThe dump shows that the leaked elements are org.codehaus.groovy.reflection.ClassInfo. I've attached Eclipse MAT rerpot as ZIP package. \n\nI've experimented and investiaged multiple solutions. I've attached an example solution for JSR223Sampler.java, but I'm not sure if this solution is acceptable. Basically the problem is, that when we create new script engine ScriptEngineManager.getEngineByName(lang), the Groovy engine loses its cache reference, but still adds the information about the script to cache. For that reason it creates new script to cache each time when the script is executed. This at the end fills the memory with the Groovy's ClassInfo. \n\nBased to the answer abotu thread safety of Groovy (http://stackoverflow.com/questions/30140103/should-i-use-a-separate-scriptengine-and-compiledscript-instances-per-each-threa), only single ScriptEngine could be created for all threads. But does that cause problems with other script engines? \n\nThis same issue is with pre- and post-processor, and I suppose it is with all other JSR223 elements also."}, {"count": 1, "tags": [], "text": "Created attachment 34104\nMAT results for the leak", "attachment_id": 34104, "id": 192899, "creator": "Teemu.Vesala@qentinel.com", "time": "2016-08-05T03:53:45Z", "bug_id": 59946, "creation_time": "2016-08-05T03:53:45Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 59946, "is_private": false, "id": 192900, "attachment_id": 34105, "creator": "Teemu.Vesala@qentinel.com", "creation_time": "2016-08-05T03:54:48Z", "time": "2016-08-05T03:54:48Z", "text": "Created attachment 34105\nExample of non leaking JSR223Sampler - not the full solution"}, {"count": 3, "tags": [], "text": "Hello,\nFirst thanks a lot for the report, the investigation and your work.\n\nI read it and I wonder if you're not facing this:\n\n- http://www.groovy-lang.org/mailing-lists.html#nabble-td387931\n\nCould you clarify a bit more how this thread (http://stackoverflow.com/questions/30140103/should-i-use-a-separate-scriptengine-and-compiledscript-instances-per-each-thread) relates to this issue ? Is it because of null being returned by http://docs.oracle.com/javase/8/docs/api/javax/script/ScriptEngineFactory.html#getParameter-java.lang.String-\n\n\nI will have further look but I wonder if anything can be done about that if it's how groovy works.", "attachment_id": null, "bug_id": 59946, "id": 192928, "time": "2016-08-05T19:42:13Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2016-08-05T19:42:13Z", "is_private": false}, {"count": 4, "tags": [], "text": "Hi Again,\nI reproduced your issue and got a Heap Dump.\n\nIt seems we are facing Groovy bug :\n\n- https://issues.apache.org/jira/browse/GROOVY-7683 (which is in progress)\n- https://issues.apache.org/jira/browse/GROOVY-7591 (which is fixed)\n\nIt mentions a workaround which is to set \"-Dgroovy.use.classvalue=true\" \n\nThis flag is introduced as a (hopefully) temporary workaround for a JVM bug, that is to say that using\nClassValue prevents the classes and classloaders from being unloaded.\nee https://bugs.openjdk.java.net/browse/JDK-8136353\n\nGroovy team says for bug GROOVY-7591 that issue is due to JDK Bug:\n\n- https://bugs.openjdk.java.net/browse/JDK-8136353\n\nI tried the settings and it works.\n\nWhat do you think ?\n\nThanks for feedback", "attachment_id": null, "id": 192929, "creator": "p.mouawad@ubik-ingenierie.com", "time": "2016-08-05T20:11:40Z", "bug_id": 59946, "creation_time": "2016-08-05T20:11:40Z", "is_private": false}, {"count": 5, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "is_private": false, "text": "(In reply to Philippe Mouawad from comment #3)\n> Hello,\n> First thanks a lot for the report, the investigation and your work.\n> \n> I read it and I wonder if you're not facing this:\n> \n> - http://www.groovy-lang.org/mailing-lists.html#nabble-td387931\nIgnore this\n> \n> Could you clarify a bit more how this thread\n> (http://stackoverflow.com/questions/30140103/should-i-use-a-separate-\n> scriptengine-and-compiledscript-instances-per-each-thread) relates to this\n> issue ? Is it because of null being returned by\n> http://docs.oracle.com/javase/8/docs/api/javax/script/ScriptEngineFactory.\n> html#getParameter-java.lang.String-\n> \n> \n> I will have further look but I wonder if anything can be done about that if\n> it's how groovy works.", "id": 192932, "time": "2016-08-05T20:38:34Z", "bug_id": 59946, "creation_time": "2016-08-05T20:38:34Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 59946, "is_private": false, "count": 6, "id": 192975, "time": "2016-08-10T06:41:15Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2016-08-10T06:41:15Z", "text": "Author: pmouawad\nDate: Wed Aug 10 06:40:35 2016\nNew Revision: 1755674\n\nURL: http://svn.apache.org/viewvc?rev=1755674&view=rev\nLog:\nBug 59946 - Memory leak at JSR223 components with Groovy script due to Groovy Memory leak when not caching compiled script\nDocument workaround\nBugzilla Id: 59946\n\nModified:\n    jmeter/trunk/xdocs/usermanual/component_reference.xml"}, {"count": 7, "tags": [], "bug_id": 59946, "is_private": false, "id": 193062, "attachment_id": null, "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2016-08-12T07:17:40Z", "time": "2016-08-12T07:17:40Z", "text": "@Dev Team, should we set in system.properties:\n\n-Dgroovy.use.classvalue=true"}, {"attachment_id": null, "tags": [], "bug_id": 59946, "is_private": false, "count": 8, "id": 193379, "time": "2016-08-28T20:05:16Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2016-08-28T20:05:16Z", "text": "Nothing more can be done in JMeter for this.\nDocumentation updated to mention issue."}]