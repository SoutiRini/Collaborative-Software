[{"count": 0, "tags": [], "bug_id": 41504, "text": "I'm getting the above Error/Exception when Tomcat tries to redeploy my webapp.\nI've searched google/apache mailing list/ASF bugzilla, and haven't found a clear\nsolution to this problem.\nFrom what I've read, it appears that this bug crept in after version 5.5.12.\nCan you determine from your 5.5.12 code what has changed, which is causing this\nproblem on later verions?\nThis webapp has been running fine on Tomcat 4, but we have recently upgraded to\nJDK 1.5, and are considering upgrading the entire web app from servlet 2.3/jsp\n1.2 to servlet 2.4/jsp 2.0.\nThe webapp starts up and runs fine. It just fails to auto reload.\nTake a look at this post from the tomcat-user mailing list:\nhttp://marc.theaimsgroup.com/?l=tomcat-user&m=113932361804941&w=2\n\nHere's my stack trace:\n2007/01/31 10:09:41 org.apache.catalina.core.StandardContext reload\nINFO: Reloading this Context has started\npm.closed\npm.closed\njdbc.con.close\njdbc.con.close\n2007/01/31 10:09:43 org.apache.catalina.loader.WebappClassLoader loadClass\nINFO: Illegal access: this web application instance has been stopped already. \nCould not load org.apache.log4j.spi.VectorWriter.  The eventual following stack\ntrace is caused by an error thrown for debugging purposes as well as to attempt\nto terminate the thread which caused the illegal access, and has no functional\nimpact.\njava.lang.IllegalStateException\n\tat\norg.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1241)\n\tat\norg.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1201)\n\tat java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)\n\tat org.apache.log4j.spi.LoggingEvent.<init>(LoggingEvent.java:154)\n\tat org.apache.log4j.Category.forcedLog(Category.java:388)\n\tat org.apache.log4j.Category.log(Category.java:853)\n\tat org.apache.commons.logging.impl.Log4JLogger.error(Log4JLogger.java:198)\n\tat org.apache.catalina.session.StandardManager.doLoad(StandardManager.java:411)\n\tat org.apache.catalina.session.StandardManager.load(StandardManager.java:320)\n\tat org.apache.catalina.session.StandardManager.start(StandardManager.java:636)\n\tat org.apache.catalina.core.StandardContext.start(StandardContext.java:4161)\n\tat org.apache.catalina.core.StandardContext.reload(StandardContext.java:3024)\n\tat org.apache.catalina.loader.WebappLoader.backgroundProcess(WebappLoader.java:432)\n\tat\norg.apache.catalina.core.ContainerBase.backgroundProcess(ContainerBase.java:1277)\n\tat\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1569)\n\tat\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1578)\n\tat\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1578)\n\tat\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run(ContainerBase.java:1558)\n\tat java.lang.Thread.run(Thread.java:595)\n2007/01/31 10:09:43 org.apache.catalina.loader.WebappClassLoader loadClass\nINFO: Illegal access: this web application instance has been stopped already. \nCould not load org.apache.log4j.spi.VectorWriter.  The eventual following stack\ntrace is caused by an error thrown for debugging purposes as well as to attempt\nto terminate the thread which caused the illegal access, and has no functional\nimpact.\njava.lang.IllegalStateException\n\tat\norg.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1241)\n\tat\norg.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1201)\n\tat java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)\n\tat org.apache.log4j.spi.LoggingEvent.<init>(LoggingEvent.java:154)\n\tat org.apache.log4j.Category.forcedLog(Category.java:388)\n\tat org.apache.log4j.Category.log(Category.java:853)\n\tat org.apache.commons.logging.impl.Log4JLogger.error(Log4JLogger.java:198)\n\tat org.apache.catalina.session.StandardManager.start(StandardManager.java:638)\n\tat org.apache.catalina.core.StandardContext.start(StandardContext.java:4161)\n\tat org.apache.catalina.core.StandardContext.reload(StandardContext.java:3024)\n\tat org.apache.catalina.loader.WebappLoader.backgroundProcess(WebappLoader.java:432)\n\tat\norg.apache.catalina.core.ContainerBase.backgroundProcess(ContainerBase.java:1277)\n\tat\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1569)\n\tat\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1578)\n\tat\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1578)\n\tat\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run(ContainerBase.java:1558)\n\tat java.lang.Thread.run(Thread.java:595)\n2007/01/31 10:09:43 org.apache.commons.modeler.Registry registerComponent\nSEVERE: Null component\nCatalina:type=JspMonitor,name=jsp,WebModule=//localhost/capri,J2EEApplication=none,J2EEServer=none\n2007/01/31 10:09:43\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor processChildren\nSEVERE: Exception invoking periodic operation: \njava.lang.NoClassDefFoundError: org/apache/log4j/spi/VectorWriter\n\tat org.apache.log4j.spi.LoggingEvent.<init>(LoggingEvent.java:154)\n\tat org.apache.log4j.Category.forcedLog(Category.java:388)\n\tat org.apache.log4j.Category.log(Category.java:853)\n\tat org.apache.commons.logging.impl.Log4JLogger.error(Log4JLogger.java:198)\n\tat org.apache.catalina.session.StandardManager.start(StandardManager.java:638)\n\tat org.apache.catalina.core.StandardContext.start(StandardContext.java:4161)\n\tat org.apache.catalina.core.StandardContext.reload(StandardContext.java:3024)\n\tat org.apache.catalina.loader.WebappLoader.backgroundProcess(WebappLoader.java:432)\n\tat\norg.apache.catalina.core.ContainerBase.backgroundProcess(ContainerBase.java:1277)\n\tat\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1569)\n\tat\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1578)\n\tat\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1578)\n\tat\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run(ContainerBase.java:1558)\n\tat java.lang.Thread.run(Thread.java:595)", "id": 98821, "time": "2007-01-31T01:21:36Z", "creator": "EGoosen2@metropolitan.co.za", "creation_time": "2007-01-31T01:21:36Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 41504, "text": "*** Bug 41507 has been marked as a duplicate of this bug. ***", "count": 1, "id": 98858, "time": "2007-01-31T16:19:31Z", "creator": "markt@apache.org", "creation_time": "2007-01-31T16:19:31Z", "is_private": false}, {"count": 2, "attachment_id": null, "bug_id": 41504, "text": "*** Bug 41506 has been marked as a duplicate of this bug. ***", "id": 98860, "time": "2007-01-31T16:19:47Z", "creator": "markt@apache.org", "creation_time": "2007-01-31T16:19:47Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "text": "Please provide the simplest web application (ideally as a war) that exhibits\nthis issue.", "is_private": false, "id": 98861, "creator": "markt@apache.org", "time": "2007-01-31T16:36:53Z", "bug_id": 41504, "creation_time": "2007-01-31T16:36:53Z", "attachment_id": null}, {"count": 4, "tags": [], "text": "The MARC at AIMS message you mention had a different problem: blank docBase is\nnot acceptable.\n\nI'm closing this issue until a test WAR is provide that allows us to reproduce it.", "attachment_id": null, "bug_id": 41504, "id": 100896, "time": "2007-03-25T09:37:44Z", "creator": "yoavs@computer.org", "creation_time": "2007-03-25T09:37:44Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 41504, "attachment_id": null, "id": 116496, "time": "2008-05-12T06:22:03Z", "creator": "tapas.adhikary@gmail.com", "creation_time": "2008-05-12T06:22:03Z", "is_private": false, "text": "Hi ,\nI am able to reproduce the same problem and getting the following exception while loading the class from jDom.jar using tomcat 5.5.24.\n\n==============================================================================\nMay 12, 2008 6:43:05 PM org.apache.catalina.loader.WebappClassLoader loadClass\nINFO: Illegal access: this web application instance has been stopped already.  Could not load JDOMAbout$Author.  The eventual following stack trace is caused by an error thrown for debugging purposes as well as to attempt to terminate the thread which caused the illegal access, and has no functional impact.\njava.lang.IllegalStateException\n\tat org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1248)\n\tat org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1208)\n\tat com.company.nps.gadgetManager.LaunchService.loadJars(LaunchService.java:654)\n\tat com.company.nps.gadgetManager.LaunchService.onDelegateAction(LaunchService.java:85)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:585)\n\tat com.company.nps.gadgetManager.BaseGadgetInstance.handleAction(BaseGadgetInstance.java:2362)\n\tat com.company.nps.gadgetManager.GadgetManager.processInstanceRequest(GadgetManager.java:1606)\n\tat com.company.nps.gadgetManager.GadgetManager.processServiceRequest(GadgetManager.java:1062)\n\tat com.company.nps.PortalServlet.handleFrameService(PortalServlet.java:505)\n\tat com.company.nps.PortalServlet.processRequest(PortalServlet.java:373)\n\tat com.company.nps.PortalServlet.doPost(PortalServlet.java:279)\n\tat com.company.nps.PortalServlet.doGet(PortalServlet.java:262)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:690)\n\tat com.company.emframe.fw.servlet.AuthenticatorServlet.service(AuthenticatorServlet.java:323)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:803)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:269)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:188)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:213)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:174)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:117)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:108)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:151)\n\tat org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:874)\n\tat org.apache.coyote.http11.Http11BaseProtocol$Http11ConnectionHandler.processConnection(Http11BaseProtocol.java:665)\n\tat org.apache.tomcat.util.net.PoolTcpEndpoint.processSocket(PoolTcpEndpoint.java:528)\n\tat org.apache.tomcat.util.net.LeaderFollowerWorkerThread.runIt(LeaderFollowerWorkerThread.java:81)\n\tat org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:689)\n\tat java.lang.Thread.run(Thread.java:595)\n\n===============================================================================\nI have wrote a CustomClassLoader extending WebAppClassLoader and configured the server.xml file with \n\n<Context docBase=\"myProject\" path=\"/nps\" reloadable=\"true\" source=\"org.eclipse.jst.j2ee.server:myProject\"> \n <Loader Reloadable=\"false\" debug=\"10\" delegate=\"false\" loaderClass=\"com.novell.nps.utils.CCL\" />\n</Context>\n\nand made a jar of my custom class loader class CCL.java and keeping the jar in common/lib of my tomcat.\n\nPlease look into the issue.\n\nThanks,\n-Tapas"}, {"count": 6, "tags": [], "bug_id": 41504, "attachment_id": null, "id": 116518, "time": "2008-05-12T11:10:56Z", "creator": "markt@apache.org", "creation_time": "2008-05-12T11:10:56Z", "is_private": false, "text": "A couple of questions to help get to the bottom of this:\n1. Does this still happen without your classloader in the picture?\n2. Does it happen with the latest 5.5.x?\n3. Can you provide a simple test war (with source for any servlets etc) and/or the steps to reproduce on a clean install.\n \nNote for the test war you can leave out large libs in WEB-IBF/lib - just let us know exactly which versions to add."}, {"count": 7, "tags": [], "creator": "paul@mediamens.nl", "text": "To answer Mark's 2nd question: yes\nI'm using Tomcat 5.5.27 on an openSuSE 10.3 Linuxbox using JDK 1.5 and I'm running into the exact same exception after a reload via the manager servlet. In my case it's one of my own classes (ArrayUtils) that can no longer be loaded.\n\nI too, am using a custom classloader. In the stacktrace below the classes \"interacao.FreePage\" and \"interacao.PhotoPage\" were loaded by my custom classloader. However, the ArrayUtils class should get loaded by the normal classloader. I'll dig into my classloader, see if something goes wrong there. If I come up with anything interesting, I'll repost.\n\nHere's my stackdump:\n\n11-okt-2008 20:40:56 org.apache.catalina.loader.WebappClassLoader loadClass\nINFO: Illegal access: this web application instance has been stopped already.  Could not load nl.tohave.util.ArrayUtils.  The eventual following stack trace is caused by an error thrown for debugging purposes as well as to attempt to terminate the thread which caused the illegal access, and has no functional impact.\njava.lang.IllegalStateException\n        at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1272)\n        at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1232)\n        at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)\n        at interacao.FreePage.getFormElements(FreePage.java:84)\n        at interacao.PhotoPage.getFormElements(PhotoPage.java:49)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:585)\n        at nl.tohave.merlin2.core.MerlinObjectWrapper.getEmptyForm(MerlinObjectWrapper.java:2066)\n        at nl.tohave.merlin2.core.MerlinObjectWrapper.getForm(MerlinObjectWrapper.java:1995)\n        at nl.tohave.merlin2.core.MerlinObjectWrapper.getForm(MerlinObjectWrapper.java:1986)\n        at nl.tohave.merlin2.servlet.EditorServlet.run(EditorServlet.java:153)\n        at nl.tohave.merlin2.servlet.EditorServlet.service(EditorServlet.java:56)\n        at nl.tohave.merlin2.servlet.MerlinServlet.service(MerlinServlet.java:160)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:729)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:269)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:188)\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:204)\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:172)\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:117)\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:108)\n        at nl.tohave.merlin2.serverext.tomcat55.AccessLogValve.invoke(AccessLogValve.java:148)\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:174)\n        at org.apache.jk.server.JkCoyoteHandler.invoke(JkCoyoteHandler.java:200)\n        at org.apache.jk.common.HandlerRequest.invoke(HandlerRequest.java:283)\n        at org.apache.jk.common.ChannelSocket.invoke(ChannelSocket.java:773)\n        at org.apache.jk.common.ChannelSocket.processConnection(ChannelSocket.java:703)\n        at org.apache.jk.common.ChannelSocket$SocketConnection.runIt(ChannelSocket.java:895)\n        at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:689)\n        at java.lang.Thread.run(Thread.java:595)\n", "id": 121437, "time": "2008-10-11T12:17:05Z", "bug_id": 41504, "creation_time": "2008-10-11T12:17:05Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "paul@mediamens.nl", "attachment_id": null, "is_private": false, "id": 121450, "time": "2008-10-12T13:58:18Z", "bug_id": 41504, "creation_time": "2008-10-12T13:58:18Z", "text": "Mark, thanks for putting me on the right track!!\nTurns out the problem was indeed caused by my own custom classloader. It was not aware of the webapp getting reloaded and simply kept serving the \"old\" classes.\n\nI have now added a LifecycleListener to the StandardContext instance and whenever a \"start\" event is received my custom classloader is forced to reload all classes. Webapp-reloading now works like a charm!! Thanks a lot!\n\nPlease note: this does not explain why this issue does not appear to exist in Tomcat 5.5.12 as suggested by the original submitter of this bug.\n\nKinds regards,\nPaul Hamer"}, {"count": 9, "attachment_id": null, "bug_id": 41504, "text": "Closing this as an application issue. I haven't looked into what change around 5.5.12 may have caused this bug to start reporting errors.", "id": 124753, "time": "2009-02-09T11:45:57Z", "creator": "markt@apache.org", "creation_time": "2009-02-09T11:45:57Z", "tags": [], "is_private": false}]