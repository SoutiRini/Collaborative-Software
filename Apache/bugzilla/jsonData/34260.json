[{"count": 0, "tags": [], "bug_id": 34260, "is_private": false, "text": "A tomcat cluster, config as\n---------------------------------------------------------------------------\n<Cluster className=\"org.apache.catalina.cluster.tcp.SimpleTcpCluster\"\n                managerClassName=\"org.apache.catalina.cluster.session.DeltaManager\"\n                expireSessionsOnShutdown=\"false\"\n                useDirtyFlag=\"true\">\n-------------------------------------------------------------------------\nkill one node, then bring it back up again, it will not receive session data\nupdate from other node. Following is what I see after bring back the dead node\n\n----------------------------------------------------------------------------\nCreated MBeanServer with ID: 18020cc:102f5dc8465:-8000:donau:1\nMar 30, 2005 3:47:13 PM org.apache.coyote.http11.Http11Protocol init\nINFO: Initializing Coyote HTTP/1.1 on http-8080\nMar 30, 2005 3:47:13 PM org.apache.catalina.startup.Catalina load\nINFO: Initialization processed in 1273 ms\nMar 30, 2005 3:47:13 PM org.apache.catalina.core.StandardService start\nINFO: Starting service Catalina\nMar 30, 2005 3:47:13 PM org.apache.catalina.core.StandardEngine start\nINFO: Starting Servlet Engine: Apache Tomcat/5.0\nMar 30, 2005 3:47:13 PM org.apache.catalina.core.StandardHost start\nINFO: XML validation disabled\nMar 30, 2005 3:47:13 PM org.apache.catalina.cluster.tcp.SimpleTcpCluster start\nINFO: Cluster is about to start\nMar 30, 2005 3:47:13 PM org.apache.catalina.cluster.mcast.McastService start\nINFO: Sleeping for 2000 secs to establish cluster membership\nMar 30, 2005 3:47:14 PM org.apache.catalina.cluster.tcp.SimpleTcpCluster memberAdded\nINFO: Replication member\nadded:org.apache.catalina.cluster.mcast.McastMember[tcp://xxx.xx.20.218:4002,xxx.xx.20.218,4002,\nalive=10907852]\nMar 30, 2005 3:47:14 PM org.apache.catalina.cluster.tcp.SimpleTcpCluster memberAdded\nINFO: Replication member\nadded:org.apache.catalina.cluster.mcast.McastMember[tcp://127.0.0.1:4002,127.0.0.1,4002,\nalive=92927450]\nMar 30, 2005 3:47:16 PM org.apache.catalina.core.StandardHost getDeployer\nINFO: Create Host deployer for direct deployment ( non-jmx )\nMar 30, 2005 3:47:16 PM org.apache.catalina.core.StandardHostDeployer install\nINFO: Processing Context configuration file URL\nfile:/opt/dev/share/jakarta/tomcat/base/conf/Catalina/localhost/balancer.xml\nMar 30, 2005 3:47:16 PM org.apache.catalina.core.StandardHostDeployer install\nINFO: Processing Context configuration file URL\nfile:/opt/dev/share/jakarta/tomcat/base/conf/Catalina/localhost/manager.xml\nMar 30, 2005 3:47:17 PM org.apache.catalina.core.StandardHostDeployer install\nINFO: Processing Context configuration file URL\nfile:/opt/dev/share/jakarta/tomcat/base/conf/Catalina/localhost/admin.xml\nMar 30, 2005 3:47:17 PM org.apache.struts.util.PropertyMessageResources <init>\nINFO: Initializing, config='org.apache.struts.util.LocalStrings', returnNull=true\nMar 30, 2005 3:47:17 PM org.apache.struts.util.PropertyMessageResources <init>\nINFO: Initializing, config='org.apache.struts.action.ActionResources',\nreturnNull=true\nMar 30, 2005 3:47:17 PM org.apache.struts.util.PropertyMessageResources <init>\nINFO: Initializing, config='org.apache.webapp.admin.ApplicationResources',\nreturnNull=true\nMar 30, 2005 3:47:20 PM org.apache.catalina.core.StandardHostDeployer install\nINFO: Installing web application at context path /tomcat-docs from URL\nfile:/opt/dev/share/jakarta/tomcat/base/webapps/tomcat-docs\nMar 30, 2005 3:47:20 PM org.apache.catalina.core.StandardHostDeployer install\nINFO: Installing web application at context path /jsp-examples from URL\nfile:/opt/dev/share/jakarta/tomcat/base/webapps/jsp-examples\nMar 30, 2005 3:47:20 PM org.apache.catalina.core.StandardHostDeployer install\nINFO: Installing web application at context path  from URL\nfile:/opt/dev/share/jakarta/tomcat/base/webapps/ROOT\nMar 30, 2005 3:47:20 PM org.apache.catalina.core.StandardHostDeployer install\nINFO: Installing web application at context path /webdav from URL\nfile:/opt/dev/share/jakarta/tomcat/base/webapps/webdav\nMar 30, 2005 3:47:20 PM org.apache.catalina.core.StandardHostDeployer install\nINFO: Installing web application at context path /clusterapp from URL\nfile:/opt/dev/share/jakarta/tomcat/base/webapps/clusterapp\n\n\n\n\nCreating ClusterManager for context /clusterapp using class\norg.apache.catalina.cluster.session.DeltaManager\n\n\n\n\nMar 30, 2005 3:47:20 PM org.apache.catalina.cluster.session.DeltaManager start\nINFO: Starting clustering manager...:/clusterapp\nMar 30, 2005 3:47:20 PM org.apache.catalina.cluster.tcp.ReplicationTransmitter\nsendMessageData\nWARNING: Unable to send replicated message, is server down?\njava.net.ConnectException: Connection refused\n        at java.net.PlainSocketImpl.socketConnect(Native Method)\n        at java.net.PlainSocketImpl.doConnect(PlainSocketImpl.java:305)\n        at java.net.PlainSocketImpl.connectToAddress(PlainSocketImpl.java:171)\n        at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:158)\n        at java.net.Socket.connect(Socket.java:452)\n        at java.net.Socket.connect(Socket.java:402)\n        at java.net.Socket.<init>(Socket.java:309)\n        at java.net.Socket.<init>(Socket.java:153)\n        at\norg.apache.catalina.cluster.tcp.SocketSender.connect(SocketSender.java:66)\n        at\norg.apache.catalina.cluster.tcp.SocketSender.sendMessage(SocketSender.java:112)\n        at\norg.apache.catalina.cluster.tcp.PooledSocketSender.sendMessage(PooledSocketSender.java:119)\n        at\norg.apache.catalina.cluster.tcp.ReplicationTransmitter.sendMessageData(ReplicationTransmitter.java:117)\n        at\norg.apache.catalina.cluster.tcp.ReplicationTransmitter.sendMessage(ReplicationTransmitter.java:136)\n        at\norg.apache.catalina.cluster.tcp.SimpleTcpCluster.send(SimpleTcpCluster.java:457)\n        at\norg.apache.catalina.cluster.session.DeltaManager.start(DeltaManager.java:648)\n        at org.apache.catalina.core.ContainerBase.setManager(ContainerBase.java:499)\n        at\norg.apache.catalina.startup.ContextConfig.managerConfig(ContextConfig.java:308)\n        at org.apache.catalina.startup.ContextConfig.start(ContextConfig.java:635)\n        at\norg.apache.catalina.startup.ContextConfig.lifecycleEvent(ContextConfig.java:216)\n        at\norg.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:119)\n        at org.apache.catalina.core.StandardContext.start(StandardContext.java:4290)\n        at\norg.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:823)\n        at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:807)\n        at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:595)\n        at\norg.apache.catalina.core.StandardHostDeployer.install(StandardHostDeployer.java:277)\n        at org.apache.catalina.core.StandardHost.install(StandardHost.java:832)\n        at\norg.apache.catalina.startup.HostConfig.deployDirectories(HostConfig.java:701)\n        at org.apache.catalina.startup.HostConfig.deployApps(HostConfig.java:432)\n        at org.apache.catalina.startup.HostConfig.start(HostConfig.java:983)\n        at\norg.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java:349)\n        at\norg.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:119)\n        at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1091)\n        at org.apache.catalina.core.StandardHost.start(StandardHost.java:789)\n        at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1083)\n        at org.apache.catalina.core.StandardEngine.start(StandardEngine.java:478)\n        at org.apache.catalina.core.StandardService.start(StandardService.java:480)\n        at org.apache.catalina.core.StandardServer.start(StandardServer.java:2365)\n        at org.apache.catalina.startup.Catalina.start(Catalina.java:556)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at\nsun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n        at\nsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:324)\n        at org.apache.catalina.startup.Bootstrap.start(Bootstrap.java:287)\n        at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:425)\nMar 30, 2005 3:47:20 PM org.apache.catalina.cluster.session.DeltaManager start\nWARNING: Manager[/clusterapp], requesting session state from\norg.apache.catalina.cluster.mcast.McastMember[tcp://127.0.0.1:4002,127.0.0.1,4002,\nalive=92933570]. This operation will timeout if no session state has been\nreceived within 60 seconds\nMar 30, 2005 3:48:21 PM org.apache.catalina.cluster.session.DeltaManager start\nSEVERE: Manager[/clusterapp], No session state received, timing out.\nClusterApp context is created.\nMar 30, 2005 3:48:21 PM org.apache.catalina.core.StandardHostDeployer install\nINFO: Installing web application at context path /servlets-examples from URL\nfile:/opt/dev/share/jakarta/tomcat/base/webapps/servlets-examples\nMar 30, 2005 3:48:21 PM org.apache.coyote.http11.Http11Protocol start\nINFO: Starting Coyote HTTP/1.1 on http-8080\nMar 30, 2005 3:48:21 PM org.apache.jk.server.JkMain start\nINFO: APR not loaded, disabling jni components: java.io.IOException:\njava.lang.UnsatisfiedLinkError: no jkjni in java.library.path\nMar 30, 2005 3:48:21 PM org.apache.jk.common.ChannelSocket init\nINFO: JK2: ajp13 listening on /0.0.0.0:8009\nMar 30, 2005 3:48:21 PM org.apache.jk.server.JkMain start\nINFO: Jk running ID=0 time=3/94 \nconfig=/opt/dev/share/jakarta/tomcat/base/conf/jk2.properties\nMar 30, 2005 3:48:21 PM org.apache.catalina.startup.Catalina start\nINFO: Server startup in 68088 ms\n--------------------------------------------------------------------------------\n\nIt time out and create a new session context for my web application and when I\nswitch to this server, my old session data lost.\n\nI modified the DeltaManager.java a bit, it seems solved the problem. \n--------------------------------------------------------------------------\n\n[hzhao@donau session]$ diff DeltaManager.java\n/opt/jakarta-tomcat-5.0.28-src/jakarta-tomcat-catalina/modules/cluster/src/share/org/apache/catalina/cluster/session/DeltaManager.java\n632d631\n<           Member mbr=null;\n634,642c633\n<               for(int index=0; index<cluster.getMembers().length; index++) {\n<                       mbr = cluster.getMembers()[index];\n<                       if (mbr.getHost().equals(\"127.0.0.1\"))\n<                               mbr = null;\n<                       else\n<                               break;\n<               }\n<           }\n<           if (mbr != null) {\n---\n>                 Member mbr = cluster.getMembers()[0];\n[hzhao@donau session]$", "id": 73176, "time": "2005-04-01T03:04:05Z", "creator": "coltzhao@yahoo.com", "creation_time": "2005-04-01T03:04:05Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "coltzhao@yahoo.com", "attachment_id": null, "id": 73180, "time": "2005-04-01T04:52:46Z", "bug_id": 34260, "creation_time": "2005-04-01T04:52:46Z", "is_private": false, "text": "I reviewed  the log again, obviously I am wrong, my code above is wrong too. \nThe cause is that a node xxx.xx.20.218:4002 is a normal node, should be add in \nactive member of cluster,  but somehow it also appeared to be 127.0.0.1:4002 \n(The node on the localhost use port 4001, so this is not the local node) also \nadded to the active member of cluster. and cause time out. I wonder why it may \nhappen.\n\nSorry for if this cause any the confusion. "}, {"count": 2, "tags": [], "creator": "coltzhao@yahoo.com", "attachment_id": null, "id": 73196, "time": "2005-04-01T20:37:31Z", "bug_id": 34260, "creation_time": "2005-04-01T20:37:31Z", "is_private": false, "text": "I checked throughly today, and find out the problem to be one of our computer in\nintranet has a tomcat instance and sending out wrong information \"tcp listen\naddress 127.0.0.1:4002\". \nI changed the multicast port, and it is fine. \nThis is not a bug. sorry for the confusion."}]