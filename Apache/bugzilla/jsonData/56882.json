[{"count": 0, "tags": [], "bug_id": 56882, "text": "After a Context reload with Tomcat Manager all JSP calls with this.getServletContext().getRequestDispatcher(\"/jspname.jsp\").forward(request, response); create a \"HTTP Status 503 - Servlet jsp is currently unavailable\" response. With Tomcat 8.0.9 and Tomcat 7.0.55 it works.", "id": 177327, "time": "2014-08-22T21:14:41Z", "creator": "marco@lordzodiac.de", "creation_time": "2014-08-22T21:14:41Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 56882, "text": "Ack. Reproducible with 8.0.11 using the examples webapp.\n\nSteps:\n1. Configure a user with manager-gui role in conf/tomcat-users.xml\n2. Start Tomcat\n3. Access \"Include\" and \"Forward\" JSP examples,\nin two different tabs in Firefox\nhttp://localhost:8080/examples/jsp/include/include.jsp\nhttp://localhost:8080/examples/jsp/forward/forward.jsp\n\n4. Go to Tomcat Manager web application and click \"Reload\" button on the examples \nwebapp.\n\n5. Reload (F5 in Firefox) the above example pages.\nExpected: The same output as on step 3 though with diifferent time stamps.\nActual:\n\ninclude.jsp gives:\n[[[\nIn place evaluation of another JSP which gives you the current time: 1408802860131\nby including the output of another JSP: :-) \n]]]\nThe second sentence had to contain a timestamp value. It is missing.\n\nforward.jsp gives:\n[[[\nHTTP Status 503 - Servlet jsp is currently unavailable\n]]]\n\nThere are no error messages in the logs.\nAccess logs have\n127.0.0.1 - - [23/Aug/2014:18:07:37 +0400] \"GET /examples/jsp/forward/forward.jsp HTTP/1.1\" 503 1073\n127.0.0.1 - - [23/Aug/2014:18:07:40 +0400] \"GET /examples/jsp/include/include.jsp HTTP/1.1\" 200 299", "id": 177336, "time": "2014-08-23T14:15:46Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-08-23T14:15:46Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "text": "(In reply to Konstantin Kolinko from comment #1)\n> Ack. Reproducible with 8.0.11 using the examples webapp.\n> \n> Steps:\n> 1. Configure a user with manager-gui role in conf/tomcat-users.xml\n\nAn alternative way to reproduce:\nSkip step 1. and replace step 4. with:\n- Touch webapps\\examples\\WEB-INF\\web.xml \n- Wait several seconds, until a success message is logged on the console\nReloading Context with name [/examples] is completed\n\n> 2. Start Tomcat\n> 3. Access \"Include\" and \"Forward\" JSP examples,\n> in two different tabs in Firefox\n> http://localhost:8080/examples/jsp/include/include.jsp\n> http://localhost:8080/examples/jsp/forward/forward.jsp\n> \n> 4. Go to Tomcat Manager web application and click \"Reload\" button on the\n> examples \n> webapp.\n> \n> 5. Reload (F5 in Firefox) the above example pages.\n> Expected: The same output as on step 3 though with diifferent time stamps.\n> Actual:\n> \n> include.jsp gives:\n> [[[\n> In place evaluation of another JSP which gives you the current time:\n> 1408802860131\n> by including the output of another JSP: :-) \n> ]]]\n> The second sentence had to contain a timestamp value. It is missing.\n\nThe second sentence is missing more than just the timestamp.\nThe first part of it is missing as well. It had to be\n[[[\nTo get the current time in ms by including the output of another JSP: 1408803609298 :-) \n]]]\n\n\nThe source code of include.jsp page is essentially the following:\n[[[\n<%@ page buffer=\"5kb\" autoFlush=\"false\" %>\n<p>In place evaluation of another JSP which gives you the current time:\n<%@ include file=\"foo.jsp\" %>\n<p> <jsp:include page=\"foo.html\" flush=\"true\"/> by including the output of another JSP:\n<jsp:include page=\"foo.jsp\" flush=\"true\"/>\n:-)\n]]]\n\nThus both <jsp:include page=\"foo.html\"> and <jsp:include page=\"foo.jsp\"> are failing.\n\n\nI wonder why it silently skips the failed pages. I expected it to produce an exception after the first failed include and abort the response.\n\nThe generated Java code for include.jsp does\n[[[\n      out.write(\"<p> \");\n      org.apache.jasper.runtime.JspRuntimeLibrary.include(request, response, \"foo.html\", out, true);\n      out.write(\" by including the output of another JSP:\\r\\n\");\n]]]\nand the JspRuntimeLibrary.include() method just calls RequestDispatcher.include(). Neither of them does any try/catch wrapping.\n\nWhy isn't javax.servlet.UnavailableException being thrown by RequestDispatcher?", "id": 177337, "time": "2014-08-23T14:42:59Z", "bug_id": 56882, "creation_time": "2014-08-23T14:42:59Z", "is_private": false}, {"count": 3, "attachment_id": 31938, "creator": "knst.kolinko@gmail.com", "text": "Created attachment 31938\n2014-08-23_tc8_56882_v1.patch\n\nPatch that fixes the issue.\nJust a fix, no test case included.\n\nIt is regression from Mapper rework. The new ContextVersion object was not registered in contextObjectToContextVersionMap map.\n\n\nThe contextObjectToContextVersionMap map is specific to Tomcat 8 mapper implementation. In Tomcat 7 there are separate Mapper instances in Service and Context, and this map is a replacement for context-specific Mapper in Tomcat 8. It is used to implement mapping for context-scoped rd.include() and rd.forward() calls.\n\nThus this bug is absent in 7.0.x, but it'd be better to add a testcase there as well.", "id": 177338, "time": "2014-08-23T15:29:38Z", "bug_id": 56882, "creation_time": "2014-08-23T15:29:38Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "bug_id": 56882, "text": "(In reply to Konstantin Kolinko from comment #2)\n> > Actual:\n> > \n> > include.jsp gives:\n> > [[[\n> > In place evaluation of another JSP which gives you the current time:\n> > 1408802860131\n> > by including the output of another JSP: :-) \n> > ]]]\n> > The second sentence had to contain a timestamp value. It is missing.\n> \n> The second sentence is missing more than just the timestamp.\n> The first part of it is missing as well.\n>\n> (...)\n> \n> I wonder why it silently skips the failed pages. I expected it to produce an\n> exception after the first failed include and abort the response.\n> \n\nApparently there is some design feature for included pages.\nI do not plan to discuss it here. Just writing down the findings.\n\nCh.9.3 The Include Method (servlet-3_1-final.pdf), says\n\"The target servlet of the include method has access to all aspects of the request object, but its use of the response object is more limited.\" <...> \"It\ncannot set headers or call any method that affects the headers of the response, with the exception of the HttpServletRequest.getSession() and\nHttpServletRequest.getSession(boolean) methods.\"\n\nTechnically, processing of unavailable servlets here in done in o.a.c.core.ApplicationDispatcher.invoke() as\n1. Log a warning with wrapper.getLogger().warn(...)\n2. hresponse.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE, ...)\n\n\nThe warning is not logged, because logger.getHandlers() returns an empty list for all loggers in hierarchy chain. I do not know why that happens, but it might be expected for a stopped web application. (The request was mapped to a stopped ContextVersion due to this mapper bug).\n\nThe HttpServletResponse.sendError() call is ignored. (o.a.c.connector.Response#sendError(...)).", "id": 177350, "time": "2014-08-25T11:43:19Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-08-25T11:43:19Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 56882, "attachment_id": null, "id": 177351, "time": "2014-08-25T13:49:42Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-08-25T13:49:42Z", "is_private": false, "text": "Fixed in trunk with r1620326 and will be in 8.0.12.\n\nI will work on backporting the tests to Tomcat 7."}, {"count": 6, "text": "The test was backported to Tomcat 7 in r1620577 (to be in 7.0.56).\nIt passes successfully. There is no such bug in Tomcat 7.", "creator": "knst.kolinko@gmail.com", "attachment_id": null, "id": 177369, "time": "2014-08-26T11:53:33Z", "bug_id": 56882, "creation_time": "2014-08-26T11:53:33Z", "tags": [], "is_private": false}]