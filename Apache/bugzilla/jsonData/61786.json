[{"count": 0, "tags": [], "bug_id": 61786, "text": "we are using mpm_event \n\nwe see the behaviour that if the web server has been busy and the number of threads gets lower so it will need to clean up processes, there are PID's in a 'stopping' state for a very long time\n\nthis is causing the scoreboard to fill up after a while, halting the webserver, we are required to force a restart to free up the processes again", "id": 202263, "time": "2017-11-20T12:38:12Z", "creator": "s.schrier@nl.aswatson.com", "creation_time": "2017-11-20T12:38:12Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 61786, "text": "Addition:\n\nScoreboard of one of our servers. The processes seem stopping for ages.\n\n\nSlot\tPID\tStopping\tConnections\tThreads\tAsync connections\ntotal\taccepting\tbusy\tidle\twriting\tkeep-alive\tclosing\n0\t54957\tyes\t5\tno\t0\t0\t0\t0\t0\n1\t24721\tyes\t12\tno\t0\t0\t0\t0\t0\n2\t57230\tyes\t7\tno\t0\t0\t0\t0\t0\n3\t57892\tyes\t10\tno\t0\t0\t0\t0\t0\n4\t58393\tyes\t3\tno\t0\t0\t0\t0\t0\n5\t53025\tno\t35\tyes\t29\t35\t0\t6\t0\n6\t58529\tyes\t2\tno\t0\t0\t0\t0\t0\n7\t59050\tyes\t1\tno\t0\t0\t0\t0\t0\n9\t34843\tno\t8\tyes\t3\t61\t0\t4\t0\n10\t59762\tyes\t1\tno\t0\t0\t0\t0\t0\nSum\t10\t8\t84\t \t32\t96\t0\t10\t0\nG...........G.........................G.........G...G...........\n............G...................................................\n..G.............G...G.G....G...........G...G....................\n..................G...G......G.GG...........GG..G.G........G....\n.....................G......................G...G...............\n_W_WW_____W___W_WWW____WWW_W_____WWW__W_WWWWWW_WW____W___WWW_W__\n...........G..................G.................................\n................G...............................................\n................................................................\n__________________________W________________________W_____W______\n.......................G........................................\n................................................................\n................................................................\n................................................................", "id": 202355, "time": "2017-11-23T07:18:04Z", "creator": "s.schrier@nl.aswatson.com", "creation_time": "2017-11-23T07:18:04Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 61786, "attachment_id": null, "text": "Could you please attach a debugger to one of the processes in G state (for quite some time) and show us the state of the threads?\n\nFor example with gdb that would be:\n\n$ gdb /path/to/httpd <pid of process in G-state>\n$ thread apply all bt full\n\nand paste (or attach) the output here.\n\nThanks.", "id": 202356, "time": "2017-11-23T08:16:51Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2017-11-23T08:16:51Z", "is_private": false}, {"count": 3, "tags": [], "creator": "k.j.chernov@gmail.com", "attachment_id": 35560, "id": 202438, "time": "2017-11-28T05:56:03Z", "bug_id": 61786, "creation_time": "2017-11-28T05:56:03Z", "is_private": false, "text": "Created attachment 35560\npstack on all the processes after the server stopped responding"}, {"count": 4, "tags": [], "bug_id": 61786, "text": "Hi.\n\nWe encountered the same situation that author describes.\n\nIt started on 2.4.26 (after update from 2.4.23) and got much much worse on 2.4.29.\n\nWhile we were running 2.4.26, it used to happen once or twice in a week, on 2.4.29 it happens after 2-4 hours after server start. Also I noticed that it happens usually on a low-traffic servers (<1 rps), while the ones serving 80+ rps stays alive while having the same configuration options.\n\nWe are using Solaris 11 (SPARC), Apache is compiled using \"gcc -m64\", apr 1.6.3, apr-util 1.6.1.\n\nOn both 2.4.26 and 2.4.23 we were using apr 1.5.2 and apr-util 1.5.4.\n\nI attached pstacks of all the processes of stucked apache (approx. 30 minutes after it stopped responding).\n\nThere were no errors on 2.4.26, and on 2.4.29 it started saying about \"scoreboard is full\" before getting stuck.", "id": 202439, "time": "2017-11-28T06:03:42Z", "creator": "k.j.chernov@gmail.com", "creation_time": "2017-11-28T06:03:42Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 61786, "attachment_id": null, "text": "We have not yet been able to reproduce it but will post the data as soon as the issue re-occurs.", "id": 202465, "time": "2017-11-29T08:40:48Z", "creator": "s.schrier@nl.aswatson.com", "creation_time": "2017-11-29T08:40:48Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 61786, "text": "I've recompiled apache-2.4.29 with following lines in event.c commented:\n\n//        rv = apr_pollset_create_ex(&event_pollset, pollset_size, pchild, flags,\n//                                   good_methods[i]);\n//        if (rv == APR_SUCCESS) {\n//            listener_is_wakeable = 1;\n//            break;\n//        }\n\nRunning stable for now (24hrs passed).", "id": 202483, "time": "2017-11-30T02:10:00Z", "creator": "k.j.chernov@gmail.com", "creation_time": "2017-11-30T02:10:00Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 61786, "attachment_id": null, "id": 202498, "time": "2017-12-01T08:26:28Z", "creator": "s.schrier@nl.aswatson.com", "creation_time": "2017-12-01T08:26:28Z", "is_private": false, "text": "We hadd the issue today. Will add pdb dump."}, {"count": 8, "tags": [], "creator": "s.schrier@nl.aswatson.com", "attachment_id": 35572, "id": 202499, "time": "2017-12-01T08:27:27Z", "bug_id": 61786, "creation_time": "2017-12-01T08:27:27Z", "is_private": false, "text": "Created attachment 35572\ngdb output of process stuck in graceful"}, {"count": 9, "tags": [], "creator": "toscano.luca@gmail.com", "attachment_id": null, "id": 202543, "time": "2017-12-02T09:06:35Z", "bug_id": 61786, "creation_time": "2017-12-02T09:06:35Z", "is_private": false, "text": "I checked both Silvan's and Konstantin's debug traces (thanks to both!). As far as I got this issue happens when the volume of http requests to httpd lowers down and mpm_event cleans up some processes.\n\nSome interesting notes from the stack traces:\n\n1) in Silvan's gdb output, the listener seems to be waiting for threads to complete jk_tcp_socket_recvfull (mod_jk right?). So from my naive perspective it seems like the threads are still reading something from slow clients or something similar? Silvan, were you able to verify if slow clients were still sending data?\n\n2) in Konstantin's pstack output, it seems that the all the threads in a process are already done but the listener is waiting for polling data. Before 2.4.28 the listener thread was waiting in poll() for new data on the sockets for maximum 100ms, to then wake up and verify the status of the timeouts queues (keep alives, lingering closes, etc..). With 2.4.28 the 100ms timeout is not used anymore, and we rely on a feature of apr_pollset to be \"wakeable\" (so the listener thread can be woken up from polling by another thread). It is really interesting to see that the issue happens on Solaris, so it might be that the 'wakeable' feature in APR for Solaris is showing some issues.\nYann committed r1809273 very recently (only in trunk for the moment, not backported to 2.4.x), that might help Konstantin's use case.\n\nLuca"}, {"count": 10, "tags": [], "creator": "s.schrier@nl.aswatson.com", "attachment_id": null, "id": 202544, "time": "2017-12-02T14:00:48Z", "bug_id": 61786, "creation_time": "2017-12-02T14:00:48Z", "is_private": false, "text": "Hi Luca,\n\nYes you are correct we see this behaviour when we have had a busy period on our web servers and when it wants to settle down and mpm_event starts cleaning up close processes. \n\nAlso yes we confirm we are using mod_jk to connect to Tomcat. \n\nIt is very unlikely that the PIDs in stopping state with threads in 'G' state still are serving or receiving from slow clients. We don't really can see slow clients, request finish in a short time normally.\n\nSilvan"}, {"count": 11, "tags": [], "bug_id": 61786, "text": "Silvan,\n\nthere are cleary busy workers in attachment 35572, all of which are waiting in mod_jk for a response from the backend (Tomcat). The process won't stop until these connections end, that's the expected behaviour.\n\nDo you have different traces for processes in G state or are they all similar?\nIn the latter case, you probably need to find out why Tomcat isn't responding or closing the connection in a timely manner (and look around mod_jk timeouts which should trigger if the responses take really too long).", "id": 202545, "time": "2017-12-02T17:32:17Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2017-12-02T17:32:17Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "creator": "ylavic.dev@gmail.com", "attachment_id": null, "id": 203011, "time": "2018-01-02T14:25:07Z", "bug_id": 61786, "creation_time": "2018-01-02T14:25:07Z", "is_private": false, "text": "(In reply to Konstantin J. Chernov from comment #6)\n> I've recompiled apache-2.4.29 with following lines in event.c commented:\n[snip]\n> Running stable for now (24hrs passed).\n\nThanks Konstantin for the traces (and diagnostic).\n\nAfter searching without success for some race condition(s) in mpm_event, it looks like the issue comes from the implementation of the \"wakeup pipe\" for Solaris' poll() mechanism in APR (i.e. APR_POLLSET_PORT).\n\nCould you please test the following patch (against APR)?"}, {"count": 13, "tags": [], "creator": "toscano.luca@gmail.com", "text": "Yann did you attach the patch? For some reason I don't see it :(", "id": 203013, "time": "2018-01-02T14:29:04Z", "bug_id": 61786, "creation_time": "2018-01-02T14:29:04Z", "is_private": false, "attachment_id": null}, {"count": 14, "tags": [], "creator": "ylavic.dev@gmail.com", "attachment_id": 35636, "id": 203014, "time": "2018-01-02T14:32:01Z", "bug_id": 61786, "creation_time": "2018-01-02T14:32:01Z", "is_private": false, "text": "Created attachment 35636\nRearm polled Solaris Port wakeup pipe/events\n\nOn Solaris each poll()ed event should be re-associated with the port afterward for it to be re-armed, and it's not the case for the wakeup pipe.\n\nSorry but no Solaris at hand, so not even compile-tested...\nThe patch is based on APR-trunk, but it should apply to APR-1.6 (and probably 1.5) too."}, {"count": 15, "tags": [], "bug_id": 61786, "attachment_id": null, "text": "Fix committed to APR trunk, 1.7.x, and 1.6.x (respectively in r1819858, r1819937 and r1819938).", "id": 203037, "time": "2018-01-03T10:11:35Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2018-01-03T10:11:35Z", "is_private": false}]