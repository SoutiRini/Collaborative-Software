[{"count": 0, "tags": [], "creator": "seanrforeman@yahoo.com", "attachment_id": null, "text": "If someone writes a wrapper for a request and does not extend\nServletRequestWrapper, tomcat blows up in unwrapRequest()\n\nExample:\n\njava.lang.ClassCastException: com.mpaygateway.web.XSSEncodedHttpServletRequest\n\tat\norg.apache.catalina.core.ApplicationDispatcher.unwrapRequest(ApplicationDispatcher.java:814)\n\tat\norg.apache.catalina.core.ApplicationDispatcher.doForward(ApplicationDispatcher.java:401)\n\tat\norg.apache.catalina.core.ApplicationDispatcher.forward(ApplicationDispatcher.java:301)\n\nYe offending code snippet in method:\n\ncurrent = ((ServletRequestWrapper) current).getRequest();", "id": 88515, "time": "2006-04-26T18:43:00Z", "bug_id": 39417, "creation_time": "2006-04-26T18:43:00Z", "is_private": false}, {"count": 1, "tags": [], "creator": "william.barker@wilshire.com", "attachment_id": null, "text": "<spec-quote version=\"2.4\" section=\"8.2\">\nThe parameters to these methods can be either the request and response \narguments that were passed in via the service method of the javax.servlet \ninterface, or instances of subclasses of the request and response wrapper \nclasses that were introduced for version 2.3 of the\nspecification. In the latter case, the wrapper instances must wrap the request \nor response objects that the container passed into the service method.\n</spec-quote>", "id": 88517, "time": "2006-04-26T20:00:37Z", "bug_id": 39417, "creation_time": "2006-04-26T20:00:37Z", "is_private": false}, {"count": 2, "tags": [], "text": "Since the spec states that either the original request and response objects *or*\nwrapped versions of these can be passed in, shouldn't you handle both cases\nrather than throwing a ClassCastException in one case? Just checked with Jetty,\nseems to work fine there...\n", "is_private": false, "bug_id": 39417, "id": 109169, "time": "2007-10-09T09:02:43Z", "creator": "eric.jain@gmail.com", "creation_time": "2007-10-09T09:02:43Z", "attachment_id": null}, {"count": 3, "tags": [], "text": "*** Bug 43669 has been marked as a duplicate of this bug. ***", "is_private": false, "bug_id": 39417, "id": 109525, "time": "2007-10-21T13:46:47Z", "creator": "mailmur@yahoo.com", "creation_time": "2007-10-21T13:46:47Z", "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 39417, "is_private": false, "text": "I made a quick test, and this works fine. My \"requestDispatcher.forward(offReq,\noffRes)\" call went to the target webapp and reply written to the logfile. No\nmore ClassCastException.\n\n[ org.apache.catalina.core.ApplicationDispatcher.java ]\n  private void unwrapRequest(State state) {\n    ...\n      // FIX: avoid ClassCast exception if current one is ServletRequest\n      // but not ServletRequestWrapper.\n      if (!(current instanceof ServletRequestWrapper))\n        break;\n\n      // Advance to the next request in the chain\n      previous = current;\n      current = ((ServletRequestWrapper) current).getRequest();\n    }\n  }\n\n  private void unwrapResponse(State state) {\n    ...\n      // FIX: avoid ClassCast exception if current one is ServletResponse\n      // but not ServletResponseWrapper.\n      if (!(current instanceof ServletResponseWrapper))\n               break;\n\n      // Advance to the next response in the chain\n      previous = current;\n      current = ((ServletResponseWrapper) current).getResponse();\n    }\n  }\n", "id": 109527, "time": "2007-10-21T16:34:06Z", "creator": "mailmur@yahoo.com", "creation_time": "2007-10-21T16:34:06Z", "attachment_id": null}, {"count": 5, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "Looking at the OPs stack trace, the request/response objects being passed in are newly created objects rather than the originals or wrapped versions of the originals. This is not allowed by the spec.\n\nThe proposed patch would also breach the spec.", "id": 124747, "time": "2009-02-09T11:43:46Z", "bug_id": 39417, "creation_time": "2009-02-09T11:43:46Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "mailmur@yahoo.com", "text": "Jetty=works fine same issues\nTomcat5=works fine same issues\n\nProblem with the original tomcat source is that it creates a ClassCastException if you give it ServletRequest inteface. All it wants is ServletRequestWrapper and thats the problem.\n", "count": 6, "id": 124861, "time": "2009-02-15T10:21:15Z", "bug_id": 39417, "creation_time": "2009-02-15T10:21:15Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 39417, "attachment_id": null, "id": 124862, "time": "2009-02-15T10:22:05Z", "creator": "mailmur@yahoo.com", "creation_time": "2009-02-15T10:22:05Z", "is_private": false, "text": "(In reply to comment #6)\n> Jetty=works fine same issues\n> Tomcat5=works fine same issues\n> \n> Problem with the original tomcat source is that it creates a ClassCastException\n> if you give it ServletRequest inteface. All it wants is ServletRequestWrapper\n> and thats the problem.\n> \nOpps, I mean Tomcat4=worked fine\n\nTomcat5=no good anymore.\nTomcat6=don't know, I havent tried my apps on it.\n\n"}]