[{"count": 0, "tags": [], "bug_id": 33882, "attachment_id": null, "text": "When the apt task is invoked with forked=\"false\" and a factory attribute set,\nthe factory class is not found even though it is defined in the classpath. If\nfork is set to true it works fine. I am guessing that apt is looking at the ant\nclasspath not the target classpath.", "id": 71924, "time": "2005-03-07T21:08:43Z", "creator": "dave.smith@candata.com", "creation_time": "2005-03-07T21:08:43Z", "is_private": false}, {"count": 1, "tags": [], "creator": "mbenson@apache.org", "attachment_id": null, "id": 71926, "time": "2005-03-07T21:17:31Z", "bug_id": 33882, "creation_time": "2005-03-07T21:17:31Z", "is_private": false, "text": "Without knowing much about this particular task, this sounds like typical Ant\ncompilation-related-task behavior to me."}, {"attachment_id": null, "tags": [], "creator": "stevel@apache.org", "text": "Have you tried <factoryclasspath>", "count": 2, "id": 72094, "time": "2005-03-09T23:59:01Z", "bug_id": 33882, "creation_time": "2005-03-09T23:59:01Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 33882, "is_private": false, "count": 3, "id": 72105, "time": "2005-03-10T05:13:25Z", "creator": "dave.smith@candata.com", "creation_time": "2005-03-10T05:13:25Z", "text": "Fisrtly it is (In reply to comment #1)\n> Without knowing much about this particular task, this sounds like typical Ant\n> compilation-related-task behavior to me.\n\nIf this is not fixable then the fork option should not be available and it\nshould always fork."}, {"count": 4, "tags": [], "text": "(In reply to comment #2)\n> Have you tried <factoryclasspath>\n\nFirstly it is factoryPathRef so ..\n\n<path id=\"factory.path\">\n    <fileset dir=\"../ejb3/dest/\">\n      <include name=\"ejbFactory.jar\"/>\n    </fileset>\n  </path>\n <apt fork=\"no\" srcdir=\".\" destdir=\"build\"\nclasspath=\"/home/newdave/jboss/ejb3x/output/lib/jboss-ejb3x.jar:/home/newdave/jboss/j2ee/output/lib/jboss-j2ee.jar\"\nfactory=\"com.theappman.annotation.BusinessMethodFactory\"\nfactoryPathRef=\"factory.path\">\n      <include name=\"com/theappman/followup/**\"/>\n    </apt>\n\nOutput ..\n [apt] An exception has occurred in apt (1.5.0_01). Please file a bug at the\nJava Deve loper Connection (http://java.sun.com/webapps/bugreport)  after\nchecking the Bug Parade for  duplicates. Include your program and the following\ndiagnostic in your report.  Thank you.\n      [apt] java.lang.NoClassDefFoundError:\ncom/sun/mirror/apt/AnnotationProcessorFactory\n      [apt]     at java.lang.ClassLoader.defineClass1(Native Method)\n      [apt]     at java.lang.ClassLoader.defineClass(ClassLoader.java:620)\n      [apt]     at\njava.security.SecureClassLoader.defineClass(SecureClassLoader.java:124)\n      [apt]     at java.net.URLClassLoader.defineClass(URLClassLoader.java:260)\n      [apt]     at java.net.URLClassLoader.access$100(URLClassLoader.java:56)\n      [apt]     at java.net.URLClassLoader$1.run(URLClassLoader.java:195)\n      [apt]     at java.security.AccessController.doPrivileged(Native Method)\n      [apt]     at java.net.URLClassLoader.findClass(URLClassLoader.java:188)\n      [apt]     at java.lang.ClassLoader.loadClass(ClassLoader.java:306)\n      [apt]     at java.lang.ClassLoader.loadClass(ClassLoader.java:251)\n      [apt]     at com.sun.tools.apt.comp.Apt.main(Apt.java:287)\n      [apt]     at\ncom.sun.tools.apt.main.JavaCompiler.compile(JavaCompiler.java:458)\n      [apt]     at com.sun.tools.apt.main.Main.compile(Main.java:1075)\n      [apt]     at com.sun.tools.apt.main.Main.compile(Main.java:938)\n      [apt]     at com.sun.tools.apt.Main.processing(Main.java:95)\n      [apt]     at com.sun.tools.apt.Main.process(Main.java:43)\n      [apt]     at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n      [apt]     at\nsun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.jav a:39)\n      [apt]     at\nsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessor\nImpl.java:25)\n      [apt]     at java.lang.reflect.Method.invoke(Method.java:585)\n      [apt]     at\norg.apache.tools.ant.taskdefs.compilers.AptCompilerAdapter.execute(AptCo\nmpilerAdapter.java:114)\n      [apt]     at org.apache.tools.ant.taskdefs.Javac.compile(Javac.java:932)\n      [apt]     at org.apache.tools.ant.taskdefs.Javac.execute(Javac.java:758)\n      [apt]     at org.apache.tools.ant.taskdefs.Apt.execute(Apt.java:261)\n      [apt]     at\norg.apache.tools.ant.UnknownElement.execute(UnknownElement.java:275)\n      [apt]     at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n      [apt]     at\nsun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.jav a:39)\n      [apt]     at\nsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessor\nImpl.java:25)\n      [apt]     at java.lang.reflect.Method.invoke(Method.java:585)\n      [apt]     at\norg.apache.tools.ant.dispatch.DispatchUtils.execute(DispatchUtils.java:1 04)\n      [apt]     at org.apache.tools.ant.Task.perform(Task.java:365)\n      [apt]     at org.apache.tools.ant.Target.execute(Target.java:341)\n      [apt]     at org.apache.tools.ant.Target.performTasks(Target.java:369)\n      [apt]     at\norg.apache.tools.ant.Project.executeSortedTargets(Project.java:1207)\n      [apt]     at org.apache.tools.ant.Project.executeTarget(Project.java:1176)\n      [apt]     at\norg.apache.tools.ant.helper.DefaultExecutor.executeTargets(DefaultExecut or.java:37)\n      [apt]     at org.apache.tools.ant.Project.executeTargets(Project.java:1059)\n      [apt]     at org.apache.tools.ant.Main.runBuild(Main.java:668)\n      [apt]     at org.apache.tools.ant.Main.startAnt(Main.java:187)\n      [apt]     at org.apache.tools.ant.launch.Launcher.run(Launcher.java:245)\n      [apt]     at org.apache.tools.ant.launch.Launcher.main(Launcher.java:66)\n\n", "attachment_id": null, "bug_id": 33882, "id": 72106, "time": "2005-03-10T05:15:12Z", "creator": "dave.smith@candata.com", "creation_time": "2005-03-10T05:15:12Z", "is_private": false}, {"count": 5, "tags": [], "text": "OK. \n\n1. There is a <factorypath> element that is working in our tests; I havent added\na test for factorypath yet. \n\n2. We have done dynamic processor loading in our tests, so the basics work.\nEither it is something to do with extra jar files, or some other reason, but we\nare clearly not there yet.\n\n3. the classpath is an inherited attribute. It gets used when forking, but\nclearly not when not forking.\n\nTo be honest, it may be simpler if we just fork every time. The tool is\nsluggish, so the startup hit is minimal, and it does reduce a variable from\nevery single bugrep\n\n", "attachment_id": null, "bug_id": 33882, "id": 72115, "time": "2005-03-10T11:17:36Z", "creator": "stevel@apache.org", "creation_time": "2005-03-10T11:17:36Z", "is_private": false}, {"count": 6, "tags": [], "text": "I should add that this looks like a problem too\n\n      [apt] java.lang.NoClassDefFoundError:\ncom/sun/mirror/apt/AnnotationProcessorFactory\n\nas if tools.jar is not being found, from another class in the jar itself. ", "attachment_id": null, "bug_id": 33882, "id": 72116, "time": "2005-03-10T11:19:23Z", "creator": "stevel@apache.org", "creation_time": "2005-03-10T11:19:23Z", "is_private": false}, {"count": 7, "tags": [], "creator": "gattojavanet@uol.com.br", "attachment_id": 14576, "is_private": false, "id": 72914, "time": "2005-03-28T05:22:46Z", "bug_id": 33882, "creation_time": "2005-03-28T05:22:46Z", "text": "Created attachment 14576\nTest case for failure\n\nHi folks,\n\nApparently apt only works in non-forked mode if tools.jar is in the system\nclasspath.  I had to edit bin/ant in order to manually put it in the -classpath\nVM option.\n\nWhen I ran it without tools.jar in the system classpath, I got this:\n\njava.lang.NoClassDefFoundError: com/sun/mirror/apt/AnnotationProcessorFactory\n\nIf I added tools.jar to the classpath passed to the apt task from within the\nbuild file, I got this:\n\njava.lang.ClassCastException: apt.extractintf.ExtractInterfaceProcessorFactory\n\n(Which is about my test processor factory.)\n\nThings work when running in forked mode, but large filesets (1000 classes)\ncause Runtime.exec to fail.  So, if you decide to always fork, I guess you'll\nhave to generate a temp file with the sources to be processed and pass it\nthrough \"@files\" to apt.\n\nI'm attaching my test case to help in diagnostics.  I'm only sending 4 classes,\nif you want the other 996 (which I doubt) tell me :-)\n\nOn a side note, I ran this with ant 1.6 and the apt-related classes compiled\nfrom CVS HEAD.\tThe ant-apt.jar is in the attachment.  I tried 1.7alpha from\n20050324, but it didn't work due to a wrong method name (\"compile\" instead of\n\"process\").\n\nSince this bug (#33853) has been fixed since 2005-03-07, and the buildlog.txt\nfrom the nightlies area says that the build failed, I presume that what's being\nserved as 20050324 is in fact a very older build :-("}, {"count": 8, "tags": [], "creator": "gattojavanet@uol.com.br", "attachment_id": null, "is_private": false, "id": 72915, "time": "2005-03-28T05:37:44Z", "bug_id": 33882, "creation_time": "2005-03-28T05:37:44Z", "text": "I forgot to tell my environment: Windows 2000, jdk1.5.0_01, cygwin (running ant\nor ant.bat didn't make any difference, so I don't think this is cygwin-related)."}, {"attachment_id": null, "tags": [], "creator": "stevel@apache.org", "text": "Seems to me that eliminating the fork=false option before it gets used is the\nsimplest. The hit in start time is noise given how slow apt is, and the savings\nin stability worthwhile.\n\nthanks for the heads-up on command line size; going via a temp file and @files\nwould seem the best approach there too. Patches welcome :)", "count": 9, "id": 73078, "time": "2005-03-30T15:19:10Z", "bug_id": 33882, "creation_time": "2005-03-30T15:19:10Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 33882, "attachment_id": 14736, "text": "Created attachment 14736\nForcing fork on apt task\n\nPatches welcome, patch sent :-) Sorry for the delay.  This patch affects the\nfollowing files.\n\nsrc/main/org/apache/tools/ant/taskdefs/Apt.java\n- Ignores fork attribute, always use AptExternalCompilerAdapter\n\nsrc/main/org/apache/tools/ant/taskdefs/compilers/AptExternalCompilerAdapter.java\n\n- Fixes call to executeExternalCompile() to prevent command line size overflow\n\nPlease don't remove AptCompilerAdapter yet.  I filed a bug report in\njava.sun.com bug database, let's see what they say.  I think that apt is\ncreating a class loader to load annotation factories, but is not giving it a\nparent, that would explain why tools.jar must be on system classloader.  If\nthey fix it, we may restore non-forked execution.", "id": 73734, "time": "2005-04-17T02:22:18Z", "creator": "gattojavanet@uol.com.br", "creation_time": "2005-04-17T02:22:18Z", "is_private": false}, {"count": 11, "tags": [], "creator": "stevel@apache.org", "attachment_id": null, "is_private": false, "id": 73760, "time": "2005-04-18T11:43:20Z", "bug_id": 33882, "creation_time": "2005-04-18T11:43:20Z", "text": "Thanks for the patch; I'll commit this when I get a chance. Nice to see that\nyou've encountered (and fixed) a problem w/ command line length too.\n\nI think we'll have to flag this task in the docs as potentially unstable;\nprimarily because its a new thing from Sun that is still fairly raw, and they\nwill inevitably change things"}, {"count": 12, "tags": [], "creator": "peterreilly@apache.org", "attachment_id": null, "id": 110169, "time": "2007-11-02T06:56:49Z", "bug_id": 33882, "creation_time": "2007-11-02T06:56:49Z", "is_private": false, "text": "*** Bug 43782 has been marked as a duplicate of this bug. ***"}, {"count": 13, "tags": [], "text": "the patch turned into svn revision 348762 and svn revision 278229 both of which went into Ant 1.7.0", "attachment_id": null, "bug_id": 33882, "id": 129772, "time": "2009-08-18T07:06:16Z", "creator": "bodewig@apache.org", "creation_time": "2009-08-18T07:06:16Z", "is_private": false}]