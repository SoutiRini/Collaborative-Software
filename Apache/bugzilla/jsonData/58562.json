[{"count": 0, "tags": [], "bug_id": 58562, "attachment_id": null, "id": 186080, "time": "2015-10-29T11:37:51Z", "creator": "francesco.petruzzi@innovery.it", "creation_time": "2015-10-29T11:37:51Z", "is_private": false, "text": "I found there are some cases in which the protect, object protect, window protect BIFF records can contain no data, In most case this happen when protection is applied through vba routines with old Excel version.\nI think must be considered the option to set the protection flag if record is present but not contains data.\nFor example the org.apache.poi.hssf.record.ProtectRecord class can be patched in this way:\n\npublic ProtectRecord(RecordInputStream in) {\n\t this._options = 1;\n\t try {\n\t\t this._options = in.readShort();\n\t } catch (RecordFormatException e) {\n\t\t //System.out.println(\"Wrong Protect record found, set and skip check \");\n\t }\n}\n\nor check for availability of data in RecordInputStream in.\n\nBest Regards\n\nFrancesco Petruzzi\n\nInformation Security Manager\nInnovery SpA"}, {"count": 1, "attachment_id": null, "bug_id": 58562, "is_private": false, "id": 186081, "time": "2015-10-29T11:47:19Z", "creator": "dtn-asfbugs@corefiling.co.uk", "creation_time": "2015-10-29T11:47:19Z", "tags": [], "text": "Hi Francesco, please can you provide a minimal unit test demonstrating the problem this patch is trying to solve? Are you saying you get an NPE or other exception trying to read such a file?"}, {"count": 2, "tags": [], "text": "The file I use is confidential, I am waiting for a file free for distribution.\nIf I load and save the file with Excel2007 the output file is ok.\n\nThis is the stack trace when try to load ProtectRecord on original file:\n\norg.apache.poi.hssf.record.RecordFormatException: Not enough data (0) to read requested (2) bytes\n\tat org.apache.poi.hssf.record.RecordInputStream.checkRecordPosition(RecordInputStream.java:216)\n\tat org.apache.poi.hssf.record.RecordInputStream.readShort(RecordInputStream.java:233)\n\tat org.apache.poi.hssf.record.ProtectRecord.<init>(ProtectRecord.java:50)\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance(Unknown Source)\n\tat sun.reflect.DelegatingConstructorAccessorImpl.newInstance(Unknown Source)\n\tat java.lang.reflect.Constructor.newInstance(Unknown Source)\n\tat org.apache.poi.hssf.record.RecordFactory$ReflectionConstructorRecordCreator.create(RecordFactory.java:87)\n\tat org.apache.poi.hssf.record.RecordFactory.createSingleRecord(RecordFactory.java:338)\n\tat org.apache.poi.hssf.record.RecordFactoryInputStream.readNextRecord(RecordFactoryInputStream.java:310)\n\tat org.apache.poi.hssf.record.RecordFactoryInputStream.nextRecord(RecordFactoryInputStream.java:276)\n\tat org.apache.poi.hssf.record.RecordFactory.createRecords(RecordFactory.java:480)\n\tat org.apache.poi.hssf.usermodel.HSSFWorkbook.<init>(HSSFWorkbook.java:326)\n\tat org.apache.poi.ss.usermodel.WorkbookFactory.create(WorkbookFactory.java:115)\n\tat org.apache.poi.ss.usermodel.WorkbookFactory.create(WorkbookFactory.java:172)\n\tat org.apache.poi.ss.usermodel.WorkbookFactory.create(WorkbookFactory.java:143)\n\tat eu.inn.xlsx.JExcelExport.doExportCSV(JExcelExport.java:198)\n\tat eu.inn.xlsx.JExcelExport.doExportCSV(JExcelExport.java:180)\n\tat eu.inn.ExcelToCSV.main(ExcelToCSV.java:314)\neu.inn.xlsx.JExcelException: Error:161 Opening input Excel file: Not enough data (0) to read requested (2) bytes\n\tat eu.inn.xlsx.JExcelExport.doExportCSV(JExcelExport.java:231)\n\tat eu.inn.xlsx.JExcelExport.doExportCSV(JExcelExport.java:180)\n\tat eu.inn.ExcelToCSV.main(ExcelToCSV.java:314)", "attachment_id": null, "id": 186083, "creator": "francesco.petruzzi@innovery.it", "time": "2015-10-29T12:26:02Z", "bug_id": 58562, "creation_time": "2015-10-29T12:26:02Z", "is_private": false}]