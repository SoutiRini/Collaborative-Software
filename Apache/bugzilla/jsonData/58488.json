[{"count": 0, "tags": [], "bug_id": 58488, "attachment_id": null, "is_private": false, "id": 185699, "time": "2015-10-08T12:10:06Z", "creator": "carlos.nieto@seap.minhap.es", "creation_time": "2015-10-08T12:10:06Z", "text": "In a multi-pool PHP-FPM when one of the PHP-FPM pools is stopped, but apache continues processing requests towards the pool, the pools of others applications begins to fails.\n\nIn all the application's pools communication is realized over UDS.\n\nThere are registered segmentation faults in Apache logs.\n\n[Tue Oct 06 12:52:14.272956 2015] [core:notice] [pid 8563:tid 140096632240128] AH00052: child pid 13967 exit signal Segmentation fault (11)\n\nAlso the /var/log/messages show segfaults.\n\nOct  6 12:21:30 phcaeproma01 kernel: httpd[13647]: segfault at 55 ip 00007f6ac91aaab2 sp 00007f6ac17fa860 error 6 in mod_proxy_fcgi.so[7f6ac91a8000+4000]\n\nThis direction, corresponds to:\n\naddr2line -e /opt/apache-2.4/modules/mod_proxy.so -fCi 0x6AB2\nap_proxy_connection_create\n/home/software/php/httpd-2.4.9/modules/proxy/proxy_util.c:2790\n\nLine 2790 in proxy_util.c correspons to:\n\n    ap_log_error(APLOG_MARK, APLOG_DEBUG, 0, s, APLOGNO(00962)\n                 \"%s: connection complete to %pI (%s)\",\n                 proxy_function, backend_addr, conn->hostname);\n\nThis line, make be sanitized in similar form to bug https://bz.apache.org/bugzilla/show_bug.cgi?id=56858\n\nBut the source of error, i think, is the stablishment of the connection, when connections are UDS, it seems to me, that mod_proxy_fcgi does not detect that the PHP-FPM pool is closed and continues making connections instead of return a 503 or similar error condition. The UDS file is present, but nobody hear the request, and the connections are continuosly creating until some condition causes no more connections can be created, and the above ap_log_error receives a null connection."}, {"count": 1, "tags": [], "text": "Hi Carlos,\n\nreally sorry for the delay. This bug sounds really bad, would you mind to add some basic data about your httpd version and maybe some steps about how to repro it?", "attachment_id": null, "id": 192641, "creator": "toscano.luca@gmail.com", "time": "2016-07-26T08:14:27Z", "bug_id": 58488, "creation_time": "2016-07-26T08:14:27Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 58488, "is_private": false, "text": "Of course Luca, httpd version was 2.4.9, you can repro the bug in a configuration with at least two PHP-FPM pools backends and a apache frontend communicating over UDS. Configuration is something like this:\n\n<VirtualHost *:80>\n    ServerName poolA.test.com\n    DocumentRoot \"/opt/poolA/htdocs/\"\n\n    <Proxy \"unix:/dev/shm/poolA.sock|fcgi://php-fpm-poolA.local\">\n      ProxySet min=0\n      ProxySet acquire=20\n      ProxySet connectiontimeout=100ms\n      ProxySet retry=0\n      ProxySet timeout=300\n      Require all granted\n    </Proxy>\n\n    # Sintaxis 2.4.10\n    <FilesMatch \\.php$>\n      SetHandler \"proxy:fcgi://php-fpm-poolA.local\"\n      Require all granted\n    </FilesMatch>\n\n    RedirectMatch ^/$ /index.php\n</VirtualHost>\n\n<VirtualHost *:80>\n    ServerName poolB.test.com\n    DocumentRoot \"/opt/poolB/htdocs/\"\n\n    <Proxy \"unix:/dev/shm/poolB.sock|fcgi://php-fpm-poolB.local\">\n      ProxySet min=0\n      ProxySet acquire=20\n      ProxySet connectiontimeout=100ms\n      ProxySet retry=0\n      ProxySet timeout=300\n      Require all granted\n    </Proxy>\n\n    # Sintaxis 2.4.10\n    <FilesMatch \\.php$>\n      SetHandler \"proxy:fcgi://php-fpm-poolB.local\"\n      Require all granted\n    </FilesMatch>\n\n    RedirectMatch ^/$ /index.php\n</VirtualHost>\n\nSo, you can shutdown one of the PHP-FPM pools, by example poolB, killing their FPM processes, and inject requests to both pools, the active pool poolA responds, and the no active pool, poolB, returns 503 errors.\n\nBut if you persist the requests to both pool, then sometime crash happens and both pools fails.\n\nI have observed this behavior in a production system with high load in a pool with we have shutdowned for maintenance and then past a time, the other pools have begun these failures, so, instead of a simple shutdown, we had to set up a maintenance page.", "id": 192642, "time": "2016-07-26T09:02:45Z", "creator": "carlos.nieto@seap.minhap.es", "creation_time": "2016-07-26T09:02:45Z", "attachment_id": null}, {"count": 3, "tags": [], "text": "Extra question: since 2.4.9 is a bit old, have you tried to reproduce with a more recent version of httpd? \n\nI am asking this because I noticed this entry in the changelog (https://www.apache.org/dist/httpd/CHANGES_2.4) for 2.4.10:\n\n  *) mod_proxy_fcgi: Don't segfault when failing to connect to the backend.\n     (regression in 2.4.9 release) [Jeff Trawick]\n\nhttps://svn.apache.org/r1592998\n\nIf you still have patience and time it would be really great if you could test at least 2.4.10 and see if it solves the problem (or maybe only the patch mentioned above).\n\nAlso 2.4.9 -> 2.4.12 brought a lot of mod_proxy_fcgi fixes. The more recent version of httpd the better :)\n\nThanks!\n\nLuca", "attachment_id": null, "id": 193014, "creator": "toscano.luca@gmail.com", "time": "2016-08-11T12:08:05Z", "bug_id": 58488, "creation_time": "2016-08-11T12:08:05Z", "is_private": false}, {"count": 4, "tags": [], "text": "Hi Carlos,\n\nany news?\n\nLuca", "attachment_id": null, "id": 196721, "creator": "toscano.luca@gmail.com", "time": "2017-02-04T15:28:09Z", "bug_id": 58488, "creation_time": "2017-02-04T15:28:09Z", "is_private": false}]