[{"count": 0, "tags": [], "bug_id": 18757, "text": "When a HEAD request is issued to Apache 2.0.45 (or earlier) configured as a\nproxy, the reply is missing the Content-Length header. The problem is not really\nin the proxy but in the CONTENT_LENGTH filter, which sets the Content-Length to\nzero (because the HEAD reply has no body). Then later in the HEADER filter a\nContent-Length header is removed if the length is zero. I believe the\nCONTENT_LENGTH filter should not touch the existing Content-Length header if the\nrequest is a HEAD request.\n\nThis is a critical problem because it makes Windows boxes unable to install\nupdates and fixes from the Internet via Apache proxy.\n\nIndex: protocol.c\n===================================================================\nRCS file: /home/cvspublic/httpd-2.0/server/protocol.c,v\nretrieving revision 1.121.2.2\ndiff -u -r1.121.2.2 protocol.c\n--- protocol.c\t3 Feb 2003 17:32:00 -0000\t1.121.2.2\n+++ protocol.c\t24 Mar 2003 10:10:49 -0000\n@@ -1290,7 +1290,7 @@\n      * We can only set a C-L in the response header if we haven't already\n      * sent any buckets on to the next output filter for this request.\n      */\n-    if (ctx->data_sent == 0 && eos) {\n+    if (ctx->data_sent == 0 && eos && !r->header_only) {\n         ap_set_content_length(r, r->bytes_sent);\n     }", "id": 34617, "time": "2003-04-07T11:41:23Z", "creator": "sami.tikka@f-secure.com", "creation_time": "2003-04-07T11:41:23Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 18757, "text": "I'm going through the bug db to make sure patches are findable.  Please see \nhttp://httpd.apache.org/dev/patches.html\n", "id": 47814, "time": "2003-11-21T17:29:42Z", "creator": "trawick@apache.org", "creation_time": "2003-11-21T17:29:42Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "sami.tikka@f-secure.com", "attachment_id": 9298, "id": 48165, "time": "2003-11-26T13:52:11Z", "bug_id": 18757, "creation_time": "2003-11-26T13:52:11Z", "is_private": false, "text": "Created attachment 9298\nPatch file (unified diff) to fix #18757"}, {"count": 3, "tags": [], "bug_id": 18757, "attachment_id": null, "text": "*** Bug 8677 has been marked as a duplicate of this bug. ***", "id": 48168, "time": "2003-11-26T14:03:20Z", "creator": "sami.tikka@f-secure.com", "creation_time": "2003-11-26T14:03:20Z", "is_private": false}, {"count": 4, "tags": [], "creator": "slive@apache.org", "attachment_id": null, "id": 57852, "time": "2004-05-21T18:00:07Z", "bug_id": 18757, "creation_time": "2004-05-21T18:00:07Z", "is_private": false, "text": "*** Bug 21348 has been marked as a duplicate of this bug. ***"}, {"count": 5, "tags": [], "bug_id": 18757, "attachment_id": null, "text": "Hmmm, votes 13, by five people!\n\nThe patch is not necessarily correct: we should set the same content-length on a\nHEAD request as on the corresponding GET.  So it's only a bug when the HEAD is\nalready devoid of data at this point in the filter chain.\n\nI'm committing a slightly different fix in CVS.  I'll add it here too.", "id": 62897, "time": "2004-09-01T12:26:56Z", "creator": "nick@webthing.com", "creation_time": "2004-09-01T12:26:56Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 18757, "is_private": false, "text": "Created attachment 12893\nlog file excerpts and 'testcase'", "id": 64365, "time": "2004-09-29T14:34:16Z", "creator": "ralf.stubner@physik.uni-erlangen.de", "creation_time": "2004-09-29T14:34:16Z", "attachment_id": 12893}, {"count": 7, "tags": [], "bug_id": 18757, "text": "Ran into this very problem.  Patch code resolved half of the issue of getting\nWindows Update to work through Apache2 Proxy server.\n\nOther half of the problem was checking to be sure that Apache was listening on\nport 443 (SSL) and had the mod_proxy_connect loading.  Relevant sections of\nhttpd.conf:\n\nListen 80\nListen 443\n\nLoadModule proxy_module        modules/mod_proxy.so\nLoadModule proxy_http_module        modules/mod_proxy_http.so\nLoadModule proxy_connect_module        modules/mod_proxy_connect.so\n#LoadModule proxy_ftp_module        modules/mod_proxy_ftp.so\n\nOtherwise, would get various 0x800..... errors, after clicking on \"Check for\nUpdates\".\n\nAnthony Albert", "id": 66557, "time": "2004-11-05T21:44:05Z", "creator": "ajalbert@excite.com", "creation_time": "2004-11-05T21:44:05Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 18757, "attachment_id": null, "id": 68067, "time": "2004-12-07T20:08:58Z", "creator": "bnicholes@apache.org", "creation_time": "2004-12-07T20:08:58Z", "is_private": false, "text": "Reverted the patch that was committed for this bug.  It appears that it \ndoesn't actually fix this bug and it breaks at least the TLS upgrade \nfunctionality by removing the content-length header for all 0 length \nresponses.  Also, code for handling the \"Content-Length: 0\" header for HEAD \nrequests is already being done in ap_http_header_filter()."}, {"count": 9, "tags": [], "bug_id": 18757, "is_private": false, "text": "*** Bug 35105 has been marked as a duplicate of this bug. ***", "id": 75538, "time": "2005-05-27T21:13:56Z", "creator": "chip@force-elite.com", "creation_time": "2005-05-27T21:13:56Z", "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 18757, "text": "I tested the Windows Update problem with newer versions of Apache2\n(2.0.53+2.0.54). I can't find the \"Content-Length: 0\"-problem there. So it is\nprobably already fixed.\n\nBut Windows Update is still not working. I wrote about this in Bug #35105 which\nwas deleted, because it should be a duplicate of this bug.\n\nLet's search for other reasons, why Windows Update is not working with Apache2\nas a proxy.", "id": 75564, "time": "2005-05-28T16:04:37Z", "creator": "bjoernv@arcor.de", "creation_time": "2005-05-28T16:04:37Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "bug_id": 18757, "attachment_id": null, "text": "(In reply to comment #10)\n> I tested the Windows Update problem with newer versions of Apache2\n> (2.0.53+2.0.54). I can't find the \"Content-Length: 0\"-problem there.\n\nI have never seen \"Content-Length: 0\" comming from a apache proxy. However,\napache 2.0.53 as shipped with SuSE 9.3 still /removes/ the Content-Length\nheader completly. See #6 for a test case. Since this is the only difference\nbetween the direct response and the response via the proxy server, I think\nthis is the reason why windowsupdate is not working.", "id": 75749, "time": "2005-06-01T19:48:32Z", "creator": "ralf.stubner@physik.uni-erlangen.de", "creation_time": "2005-06-01T19:48:32Z", "is_private": false}, {"count": 12, "tags": [], "creator": "wrowe@apache.org", "attachment_id": null, "id": 78312, "time": "2005-08-09T22:41:12Z", "bug_id": 18757, "creation_time": "2005-08-09T22:41:12Z", "is_private": false, "text": "> I have never seen \"Content-Length: 0\" comming from a apache proxy. However,\n> apache 2.0.53 as shipped with SuSE 9.3 still /removes/ the Content-Length\n> header completly.\n\nThe proxy should, legitimately, yank the Content-Length header on the HEAD\nrequest -IF- it will respond with Transfer-Encoding: chunked and without\nthe Content-Length: when the GET is processed.  So we need to perform this\nsame transformation (replace Content-Length: n with Transfer-Encoding: chunked)\non bodyless HEAD requests; the CL and TE headers then match what the GET will\ndo.  \n\nBut the only way to proxy a HEAD request when the client does not accept TE\nresponses is to proxy it as a GET and run it through the C-L filter to determine \nthe size, if any content/body filters have been injected.\n"}, {"count": 13, "tags": [], "bug_id": 18757, "attachment_id": 16741, "text": "Created attachment 16741\npatch #3\n\nI've attached a new patch for this problem.  it is more narrowly scoped than\nthe previous patches to avoid problems.  it works fine for me.\t\n\nnote that you also have to enable the CONNECT method \n( LoadModule proxy_connect_module modules/mod_proxy_connect.so )\nto make Windows Update 100% happy.  thanks to Eric Covener for discovering\nthat.\n\nrather than just commit it, I will post the patch to dev at httpd since\nprevious patches encountered problems and explain how I think this one avoids\nthem.", "id": 81353, "time": "2005-10-19T00:00:46Z", "creator": "gregames@apache.org", "creation_time": "2005-10-19T00:00:46Z", "is_private": false}, {"count": 14, "attachment_id": null, "bug_id": 18757, "text": "Patch was committed as:\n\nhttp://svn.apache.org/viewcvs?rev=327008&view=rev\n\n(backports to 2.0.x/2.2.x not submitted)", "id": 81779, "time": "2005-10-26T17:51:27Z", "creator": "jorton@redhat.com", "creation_time": "2005-10-26T17:51:27Z", "tags": [], "is_private": false}, {"count": 15, "tags": [], "bug_id": 18757, "attachment_id": null, "id": 81908, "time": "2005-10-28T18:26:15Z", "creator": "jorton@redhat.com", "creation_time": "2005-10-28T18:26:15Z", "is_private": false, "text": "*** Bug 28571 has been marked as a duplicate of this bug. ***"}, {"count": 16, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "id": 149425, "time": "2011-09-17T19:53:23Z", "bug_id": 18757, "creation_time": "2011-09-17T19:53:23Z", "is_private": false, "text": "*** Bug 39837 has been marked as a duplicate of this bug. ***"}]