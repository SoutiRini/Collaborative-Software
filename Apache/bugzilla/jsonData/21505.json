[{"count": 0, "tags": [], "creator": "ts@appliedgenerics.com", "attachment_id": null, "is_private": false, "id": 40460, "time": "2003-07-11T12:57:04Z", "bug_id": 21505, "creation_time": "2003-07-11T12:57:04Z", "text": "The propertyfile task gets confused if multiple targets are specified to Ant.\n\nHere is an example:\n\n   <target name=\"bugDemo1\" depends=\"bugDemoInit\">\n      <echo>property is ${foo}</echo>\n   </target>\n\n   <target name=\"bugDemo2\" depends=\"bugDemoInit\">\n      <echo>property is ${foo}</echo>\n      <concat>\n        <fileset file=\"bugPropFile\"/>\n      </concat>\n   </target>\n\n   <target name=\"bugDemoInit\">\n      <echo>property is ${foo}</echo>\n      <propertyfile file=\"bugPropFile\">\n         <entry key=\"foo\" default=\"0\" value=\"1\" operation=\"+\" type=\"int\"/>\n      </propertyfile>\n      <property file=\"bugPropFile\"/>\n      <echo>property is ${foo}</echo>\n   </target>\n\nRunning Ant with arguments \"bugDemo1 bugDemo2\" causes the init target to be run\ntwice. The first time it increments the number in the file, but the second time\nit doubles it.\n\nIf the init target is run three times then the number is incremented the first\ntime then doubled twice."}, {"count": 1, "tags": [], "bug_id": 21505, "attachment_id": null, "id": 40468, "time": "2003-07-11T14:19:21Z", "creator": "antoine@apache.org", "creation_time": "2003-07-11T14:19:21Z", "is_private": false, "text": "I have tried this, and I do not see anything abnormal.\nThe documentation of the <propertyfile> task is maybe not clear about the fact \nthat if the property file already exists, before the incrementations are done, \nthe property file is loaded, doing the equivalent of <property file=\"xyz.\nproperties\"/> programmatically.\nEvery time you execute BugDemoInit, you are going to increment foo by 1.\nHere is a valid demo, where BugDemoInit runs 3 times. The value of foo in the \nend is 3, in the bugDemoInit target. \n<project name=\"propertyfile\" default=\"all\">\n   <target name=\"all\" depends=\"bugDemoInit\">\n      <concat>\n        <fileset file=\"bugPropFile\"/>\n      </concat>\n      <echo message=\"foo is ${foo}\"/>\n   </target>\n\n   <target name=\"bugDemoInit\">\n      <delete file=\"bugPropFile\" quiet=\"true\"/>\n      <echo>property is ${foo}</echo>\n      <propertyfile file=\"bugPropFile\">\n         <entry key=\"foo\" default=\"0\" value=\"1\" operation=\"+\" type=\"int\"/>\n      </propertyfile>\n      <propertyfile file=\"bugPropFile\">\n         <entry key=\"foo\" default=\"0\" value=\"1\" operation=\"+\" type=\"int\"/>\n      </propertyfile>\n      <propertyfile file=\"bugPropFile\">\n         <entry key=\"foo\" default=\"0\" value=\"1\" operation=\"+\" type=\"int\"/>\n      </propertyfile>\n      <property file=\"bugPropFile\"/>\n      <echo>property is ${foo}</echo>\n   </target>\n</project>\n"}, {"count": 2, "attachment_id": null, "bug_id": 21505, "text": "That is not the same thing at all.\n\nPerhaps I didn't explain clearly enough.\n\nDid you test my xml, typing something like\n    java org.apache.tools.ant.Main bugDemo1 bugDemo2\nat the command line?\n\nThe incorrect behaviour only happens if the target containing the propertyfile\ntask runs more than once.  There is no problem with running propertyfile\nmultiple times within a target.\n\nYour xml would show the problem if you removed the delete task and specified\ntargets \"all all\" on the command line (or \"all bugDemoInit\" or \"all all all\" etc.)\n\nAlso, you say that the property file is loaded automatically, but I find that it\nis undefined until an explicit <property file=.../> is run.\n\nHere is this output from a slightly changed build.xml (better debug output):\n\n[prompt]$ cat build.xml\n<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?>\n<project name=\"demoproj\" default=\"notUsed\">\n   <target name=\"notUsed\"/>\n\n   <target name=\"bugDemo1\" depends=\"bugDemoInit\"/>\n\n   <target name=\"bugDemo2\" depends=\"bugDemoInit\"/>\n\n   <target name=\"bugDemoInit\">\n      <concat><fileset file=\"bugPropFile\"/></concat>\n\n      <echo>property at start of init is ${foo}</echo>\n\n      <propertyfile file=\"bugPropFile\">\n         <entry key=\"foo\" default=\"0\" value=\"1\" operation=\"+\" type=\"int\"/>\n      </propertyfile>\n\n      <echo>property after writing, but before reading file is ${foo}</echo>\n      <property file=\"bugPropFile\"/>\n      <echo>property after reading file is ${foo}</echo>\n\n      <concat><fileset file=\"bugPropFile\"/></concat>\n   </target>\n</project>\n[prompt]$ rm -f bugPropFile\n[prompt]$ java $myJavaOptions org.apache.tools.ant.Main bugDemo1 bugDemo2\nBuildfile: build.xml\n\nbugDemoInit:\n   [concat] Warning: Could not find any of the files specified in concat task.\n     [echo] property at start of init is ${foo}\n[propertyfile] Creating new property file: /home/ts/proj/bugPropFile\n     [echo] property after writing, but before reading file is ${foo}\n     [echo] property after reading file is 1\n   [concat] #Fri Jul 11 16:01:35 BST 2003\n   [concat] foo=1\n\nbugDemo1:\n\nbugDemoInit:\n   [concat] #Fri Jul 11 16:01:35 BST 2003\n   [concat] foo=1\n     [echo] property at start of init is ${foo}\n[propertyfile] Updating property file: /home/ts/proj/bugPropFile\n     [echo] property after writing, but before reading file is ${foo}\n     [echo] property after reading file is 1\n   [concat] #Fri Jul 11 16:01:35 BST 2003\n   [concat] foo=2\n\nbugDemo2:\n\nBUILD SUCCESSFUL\nTotal time: 2 seconds\n[prompt]$ java $myJavaOptions org.apache.tools.ant.Main bugDemo1 bugDemo2\nBuildfile: build.xml\n\nbugDemoInit:\n   [concat] #Fri Jul 11 16:01:35 BST 2003\n   [concat] foo=2\n     [echo] property at start of init is ${foo}\n[propertyfile] Updating property file:\n/homes/ts/project/default/common-main/bugPropFile\n     [echo] property after writing, but before reading file is ${foo}\n     [echo] property after reading file is 3\n   [concat] #Fri Jul 11 16:02:06 BST 2003\n   [concat] foo=3\n\nbugDemo1:\n\nbugDemoInit:\n   [concat] #Fri Jul 11 16:02:06 BST 2003\n   [concat] foo=3\n     [echo] property at start of init is ${foo}\n[propertyfile] Updating property file:\n/homes/ts/project/default/common-main/bugPropFile\n     [echo] property after writing, but before reading file is ${foo}\n     [echo] property after reading file is 3\n   [concat] #Fri Jul 11 16:02:06 BST 2003\n   [concat] foo=6\n\nbugDemo2:\n\nBUILD SUCCESSFUL\nTotal time: 2 seconds\n[prompt]$", "id": 40478, "time": "2003-07-11T15:35:15Z", "creator": "ts@appliedgenerics.com", "creation_time": "2003-07-11T15:35:15Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "creator": "antoine@apache.org", "attachment_id": null, "text": "I can reproduce the problem, I am going to work on it.", "id": 40485, "time": "2003-07-11T16:01:26Z", "bug_id": 21505, "creation_time": "2003-07-11T16:01:26Z", "is_private": false}, {"count": 4, "tags": [], "creator": "ts@appliedgenerics.com", "is_private": false, "id": 40489, "attachment_id": null, "bug_id": 21505, "creation_time": "2003-07-11T16:20:11Z", "time": "2003-07-11T16:20:11Z", "text": "Thankyou!"}, {"count": 5, "tags": [], "bug_id": 21505, "attachment_id": null, "id": 40616, "time": "2003-07-14T07:42:39Z", "creator": "antoine@apache.org", "creation_time": "2003-07-14T07:42:39Z", "is_private": false, "text": "fixed with the nightly build of 2003-07-12."}]