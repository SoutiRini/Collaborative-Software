[{"count": 0, "tags": [], "bug_id": 39035, "attachment_id": null, "text": "Apache 2.3.0dev, compiled with APR 1.2.2 on MacOSX 10.4.5.\n\nChild httpd processes intermittently dump core with \n\n---------------------------------------------------\nhttpd(15950) malloc: ***  Deallocation of a pointer not malloced: 0x1929000;\nThis could be a double free(), or free() called with the middle of an allocated\nblock; Try setting environment variable MallocHelp to see tools to help debug\nhttpd(15950) malloc: ***  Deallocation of a pointer not malloced: 0x357b; This\ncould be a double free(), or free() called with the middle of an allocated block;\n Try setting environment variable MallocHelp to see tools to help debug\n[Mon Mar 20 05:11:09 2006] [notice] child pid 15950 exit signal Segmentation\nfault (11)\n---------------------------------------------------\n\nappearing in the httpd error_log.\n\nThe crash-reporter log reveals that the problem lies in libapr-1.0's\napr_allocator_destroy():\n\n---------------------------------------------------\n**********\n\nHost Name:      Jacques-Distlers-Computer\nDate/Time:      2006-03-20 05:11:08.122 -0600\nOS Version:     10.4.5 (Build 8H14)\nReport Version: 4\n\nCommand: httpd\nPath:    /usr/local/apache2/bin/httpd\nParent:  httpd [13312]\n\nVersion: ??? (???)\n\nPID:    15950\nThread: 0\n\nException:  EXC_BAD_ACCESS (0x0001)\nCodes:      KERN_INVALID_ADDRESS (0x0001) at 0x78809b00\n\nThread 0 Crashed:\n0   libapr-1.0.dylib    0x003c2260 apr_allocator_destroy + 44 (apr_pools.c:110)\n1   httpd               0x00027ee4 clean_child_exit + 64 (prefork.c:198)\n2   httpd               0x00028610 child_main + 1308 (prefork.c:661)\n3   httpd               0x00028764 make_child + 320 (prefork.c:739)\n4   httpd               0x00029070 ap_mpm_run + 2096 (prefork.c:861)\n5   httpd               0x000031e0 main + 3200 (main.c:712)\n6   httpd               0x00001a28 _start + 340 (crt.c:272)\n7   httpd               0x000018d0 start + 60\n\nThread 0 crashed with PPC Thread State 64:\n  srr0: 0x00000000003c2260 srr1: 0x100000000000f030                       \nvrsave: 0x0000000000000000\n    cr: 0x42004424          xer: 0x0000000020000000   lr: 0x00000000003c226c \nctr: 0x0000000090014500\n    r0: 0x00000000003c226c   r1: 0x00000000bffff460   r2: 0x0000000000000000  \nr3: 0x0000000078809b00\n    r4: 0x0000000000000000   r5: 0x0000000000000013   r6: 0xfffffffffffffffa  \nr7: 0x0000000000000003\n    r8: 0x0000000035376200   r9: 0x00000000bffff294  r10: 0x0000000000000000 \nr11: 0x00000000a00062d4\n   r12: 0x0000000090014500  r13: 0x00000000000480fc  r14: 0x00000000000380fc \nr15: 0x000000000191b018\n   r16: 0x00000000000380fc  r17: 0x000000000003f0b4  r18: 0x00000000000480fc \nr19: 0x00000000000480fc\n   r20: 0x00000000000480fc  r21: 0x00000000000380fc  r22: 0x000000000003f108 \nr23: 0x0000000000000001\n   r24: 0x00000000000480fc  r25: 0x00000000000480fc  r26: 0x000000000003f114 \nr27: 0x00000000005a4300\n   r28: 0x00000000005a4314  r29: 0x0000000000000004  r30: 0x00000000005a4318 \nr31: 0x0000000000027eac\n\nBinary Images Description:\n    0x1000 -    0x3dfff httpd   /usr/local/apache2/bin/httpd\n  0x122000 -   0x132fff libaprutil-1.0.dylib   \n/usr/local/apr/lib/libaprutil-1.0.dylib\n  0x172000 -   0x18bfff libexpat.0.dylib        /usr/local/apr/lib/libexpat.0.dylib\n  0x1b7000 -   0x1b8fff mod_access_compat.so   \n/usr/local/apache2/modules/mod_access_compat.so\n  0x1c0000 -   0x1c0fff mod_actions.so  /usr/local/apache2/modules/mod_actions.so\n  0x1c7000 -   0x1c8fff mod_alias.so    /usr/local/apache2/modules/mod_alias.so\n  0x1d1000 -   0x1d1fff mod_asis.so     /usr/local/apache2/modules/mod_asis.so\n  0x1d8000 -   0x1d8fff mod_auth_basic.so      \n/usr/local/apache2/modules/mod_auth_basic.so\n  0x1e0000 -   0x1e4fff mod_auth_digest.so     \n/usr/local/apache2/modules/mod_auth_digest.so\n  0x1f0000 -   0x1f0fff mod_authn_anon.so      \n/usr/local/apache2/modules/mod_authn_anon.so\n  0x1f7000 -   0x1f7fff mod_authn_core.so      \n/usr/local/apache2/modules/mod_authn_core.so\n  0x305000 -   0x39efff libdb-4.1.dylib        \n/usr/local/BerkeleyDB.4.1/lib/libdb-4.1.dylib\n  0x3b7000 -   0x3d1fff libapr-1.0.dylib        /usr/local/apr/lib/libapr-1.0.dylib\n  0x431000 -   0x431fff mod_authn_dbd.so       \n/usr/local/apache2/modules/mod_authn_dbd.so\n  0x439000 -   0x439fff mod_authn_dbm.so       \n/usr/local/apache2/modules/mod_authn_dbm.so\n  0x441000 -   0x441fff mod_authn_default.so   \n/usr/local/apache2/modules/mod_authn_default.so\n  0x448000 -   0x448fff mod_authn_file.so      \n/usr/local/apache2/modules/mod_authn_file.so\n  0x44f000 -   0x450fff mod_authz_core.so      \n/usr/local/apache2/modules/mod_authz_core.so\n  0x459000 -   0x45afff mod_authz_dbd.so       \n/usr/local/apache2/modules/mod_authz_dbd.so\n  0x462000 -   0x462fff mod_authz_dbm.so       \n/usr/local/apache2/modules/mod_authz_dbm.so\n  0x469000 -   0x469fff mod_authz_default.so   \n/usr/local/apache2/modules/mod_authz_default.so\n  0x470000 -   0x471fff mod_authz_groupfile.so \n/usr/local/apache2/modules/mod_authz_groupfile.so\n  0x479000 -   0x479fff mod_authz_host.so      \n/usr/local/apache2/modules/mod_authz_host.so\n  0x480000 -   0x480fff mod_authz_owner.so     \n/usr/local/apache2/modules/mod_authz_owner.so\n  0x487000 -   0x487fff mod_authz_user.so      \n/usr/local/apache2/modules/mod_authz_user.so\n  0x48e000 -   0x493fff mod_autoindex.so       \n/usr/local/apache2/modules/mod_autoindex.so\n  0x4a0000 -   0x4a0fff mod_cern_meta.so       \n/usr/local/apache2/modules/mod_cern_meta.so\n  0x4a8000 -   0x4abfff mod_cgi.so      /usr/local/apache2/modules/mod_cgi.so\n  0x4b8000 -   0x4bffff mod_dav_fs.so   /usr/local/apache2/modules/mod_dav_fs.so\n  0x4e1000 -   0x4e3fff mod_deflate.so  /usr/local/apache2/modules/mod_deflate.so\n  0x4ee000 -   0x4eefff mod_dir.so      /usr/local/apache2/modules/mod_dir.so\n  0x4f5000 -   0x4f5fff mod_dumpio.so   /usr/local/apache2/modules/mod_dumpio.so\n  0x605000 -   0x616fff mod_dav.so      /usr/local/apache2/modules/mod_dav.so\n  0x64f000 -   0x64ffff mod_env.so      /usr/local/apache2/modules/mod_env.so\n  0x656000 -   0x657fff mod_expires.so  /usr/local/apache2/modules/mod_expires.so\n  0x65f000 -   0x661fff mod_ext_filter.so      \n/usr/local/apache2/modules/mod_ext_filter.so\n  0x66c000 -   0x66dfff mod_filter.so   /usr/local/apache2/modules/mod_filter.so\n  0x677000 -   0x678fff mod_headers.so  /usr/local/apache2/modules/mod_headers.so\n  0x682000 -   0x683fff mod_ident.so    /usr/local/apache2/modules/mod_ident.so\n  0x68b000 -   0x68dfff mod_imagemap.so        \n/usr/local/apache2/modules/mod_imagemap.so\n  0x696000 -   0x69dfff mod_include.so  /usr/local/apache2/modules/mod_include.so\n  0x6af000 -   0x6b1fff mod_info.so     /usr/local/apache2/modules/mod_info.so\n  0x6ba000 -   0x6bdfff mod_log_config.so      \n/usr/local/apache2/modules/mod_log_config.so\n  0x6cb000 -   0x6ccfff mod_log_forensic.so    \n/usr/local/apache2/modules/mod_log_forensic.so\n  0x6d4000 -   0x6d4fff mod_logio.so    /usr/local/apache2/modules/mod_logio.so\n  0x6dc000 -   0x6defff mod_mime.so     /usr/local/apache2/modules/mod_mime.so\n  0x6e8000 -   0x6ebfff mod_mime_magic.so      \n/usr/local/apache2/modules/mod_mime_magic.so\n  0x6f8000 -   0x6fdfff mod_negotiation.so     \n/usr/local/apache2/modules/mod_negotiation.so\n  0x70c000 -   0x716fff mod_rewrite.so  /usr/local/apache2/modules/mod_rewrite.so\n  0x72a000 -   0x72bfff mod_setenvif.so        \n/usr/local/apache2/modules/mod_setenvif.so\n  0x734000 -   0x735fff mod_speling.so  /usr/local/apache2/modules/mod_speling.so\n  0x73d000 -   0x759fff mod_ssl.so      /usr/local/apache2/modules/mod_ssl.so\n  0x7f3000 -   0x7f6fff mod_status.so   /usr/local/apache2/modules/mod_status.so\n 0x1008000 -  0x1035fff libssl.0.9.7.dylib      /sw/lib/libssl.0.9.7.dylib\n 0x1047000 -  0x1117fff libcrypto.0.9.7.dylib   /sw/lib/libcrypto.0.9.7.dylib\n 0x1177000 -  0x1178fff mod_unique_id.so       \n/usr/local/apache2/modules/mod_unique_id.so\n 0x117f000 -  0x117ffff mod_userdir.so  /usr/local/apache2/modules/mod_userdir.so\n 0x1187000 -  0x1188fff mod_usertrack.so       \n/usr/local/apache2/modules/mod_usertrack.so\n 0x1190000 -  0x1190fff mod_version.so  /usr/local/apache2/modules/mod_version.so\n 0x1195000 -  0x1196fff mod_vhost_alias.so     \n/usr/local/apache2/modules/mod_vhost_alias.so\n 0x119e000 -  0x1274fff libiconv.2.dylib        /usr/local/lib/libiconv.2.dylib\n 0x12ac000 -  0x12e7fff libmysqlclient.14.dylib        \n/Library/MySQL/lib/mysql/libmysqlclient.14.dylib\n 0x13d5000 -  0x14cdfff libxml2.2.dylib         /usr/local/lib/libxml2.2.dylib\n 0x2008000 -  0x228cfff libphp5.so      /usr/local/apache2/modules/libphp5.so\n0x8fe00000 - 0x8fe54fff dyld 44.2       /usr/lib/dyld\n0x90000000 - 0x901b3fff libSystem.B.dylib       /usr/lib/libSystem.B.dylib\n0x9020b000 - 0x9020ffff libmathCommon.A.dylib  \n/usr/lib/system/libmathCommon.A.dylib\n0x9108e000 - 0x9109cfff libz.1.dylib    /usr/lib/libz.1.dylib\n0x913af000 - 0x913b7fff libgcc_s.1.dylib        /usr/lib/libgcc_s.1.dylib\n0x913bc000 - 0x913dcfff libmx.A.dylib   /usr/lib/libmx.A.dylib\n0x92d08000 - 0x92df6fff libiconv.2.dylib        /usr/lib/libiconv.2.dylib\n0x943d0000 - 0x9440dfff libsqlite3.0.dylib      /usr/lib/libsqlite3.0.dylib\n---------------------------------------------------", "id": 87029, "time": "2006-03-20T15:33:33Z", "creator": "distler@golem.ph.utexas.edu", "creation_time": "2006-03-20T15:33:33Z", "is_private": false}, {"count": 1, "tags": [], "text": "Please try changing your loglevel to warn instead of debug.\n\nI've noticed some very odd post-destruction behavior coming from the hooks\nin mod_ssl, and although I've fixed the crash-on-shutdown that occurs on Win32\ndue to an invalid criticial section lock that was already destroyed, this might\nbe a similar issue.\n\nNote that it's equally likely that corruption elsewhere was the problem, and\nthis is just the evidence of the corruption.  Can you please describe the\nreproduction details?  Frequency?  Are specific types of requests, proxy, ssl,\nor otherwise, required before a shutdown will cause this fault?\n\n", "is_private": false, "id": 87061, "creator": "wrowe@apache.org", "time": "2006-03-21T10:21:14Z", "bug_id": 39035, "creation_time": "2006-03-21T10:21:14Z", "attachment_id": null}, {"count": 2, "tags": [], "text": "(In reply to comment #1)\n\n> Note that it's equally likely that corruption elsewhere was the problem, and\n> this is just the evidence of the corruption.\n\nThat may be. The \"malloc\" message in the httpd error_log is specific to this\ncrash in apr_allocator_destroy(). But, looking at the crash logs, I see also\ncrashes in apr_bucket_free(), apr_palloc() and apr_brigade_writev().\n\nI can attach sample crash-reporter logs for those as well.\n\n> Can you please describe the\n> reproduction details?  Frequency?\n\nI don't know how to reproduce the crashes. They happen sporadically, maybe a\ndozen or two times a day:\n\n% grep 2006-03-13 /Library/Logs/CrashReporter/httpd.crash.log | wc -l\n      20\n% grep 2006-03-14 /Library/Logs/CrashReporter/httpd.crash.log | wc -l\n      16\n% grep 2006-03-15 /Library/Logs/CrashReporter/httpd.crash.log | wc -l\n      20\n% grep 2006-03-16 /Library/Logs/CrashReporter/httpd.crash.log | wc -l\n      19\n% grep 2006-03-17 /Library/Logs/CrashReporter/httpd.crash.log | wc -l\n      17\n% grep 2006-03-18 /Library/Logs/CrashReporter/httpd.crash.log | wc -l\n      10\n% grep 2006-03-19 /Library/Logs/CrashReporter/httpd.crash.log | wc -l\n      12\n% grep 2006-03-20 /Library/Logs/CrashReporter/httpd.crash.log |wc -l\n      46\n\n> Are specific types of requests, proxy, ssl,\n> or otherwise, required before a shutdown will cause this fault?\n\nLooking at the access logs, I don't see any sort of pattern in the requests\nimmediately preceding a crash.\n\nOf course, since there are several child processes servicing requests, I'm\nmostly staring at entries produced by children that *didn't* crash. Buried among\nthem is the child process that did.\n\nI can probably rule out SSL requests, as there are very few of those/day and\nprobably none coinciding with the crashes. Maybe mod_deflate or mod_include ... ?", "is_private": false, "id": 87066, "creator": "distler@golem.ph.utexas.edu", "time": "2006-03-21T16:03:20Z", "bug_id": 39035, "creation_time": "2006-03-21T16:03:20Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 39035, "is_private": false, "count": 3, "id": 87076, "time": "2006-03-21T19:02:50Z", "creator": "wrowe@apache.org", "creation_time": "2006-03-21T19:02:50Z", "text": "You may want to -try- setting maxrequestsperchild to a much smaller number, even\nsqueezing it down to 1, to help identify the type of requests which corrupt your\nserver's environment (it's clearly corruption from the info you provided.)\n\nYou should also look at mod_log_forensic which will catch a worker when the\nrequest comes in, log the request, and note a corresponding log entry when the\nrequest completes.  Any request which causes a segfault ends up with only one\nentry in the forensic log."}, {"count": 4, "tags": [], "bug_id": 39035, "text": "I'm invalidating this bug since it appears to be a flaw in httpd or one of the\nmany loaded modules, and there are enough hints here to start a bug in httpd\nonce a reproduction case is identified.", "id": 87084, "time": "2006-03-21T21:06:23Z", "creator": "wrowe@apache.org", "creation_time": "2006-03-21T21:06:23Z", "is_private": false, "attachment_id": null}]