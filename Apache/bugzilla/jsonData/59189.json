[{"count": 0, "tags": [], "bug_id": 59189, "text": "During websocket load tests we noticed that the resident memory usage of the tomcat process would grow and stay in use even after the sockets were closed when websocket compression was enabled. The java heap looked fine. It seems to be caused by PerMessageDeflate creating a Deflater and Inflater which in turn allocates native memory that isn't freed until the JVM decides to run their finalizers, which can take a long time before it happens.\n\nI propose calling .end() (which is what finalize() does) on the Deflater and Inflater when the websocket is closed. I have created a patch that does this and resident memory usage shrinks after the websockets are closed down with it. Would you be interested in this?", "id": 189528, "time": "2016-03-17T11:09:52Z", "creator": "henrik.olsson@mobenga.com", "creation_time": "2016-03-17T11:09:52Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 59189, "is_private": false, "text": "Sure. Attach the patch to this issue and someone will take a look.", "id": 189529, "time": "2016-03-17T11:15:58Z", "creator": "markt@apache.org", "creation_time": "2016-03-17T11:15:58Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "henrik.olsson@mobenga.com", "attachment_id": 33682, "id": 189531, "time": "2016-03-17T12:08:34Z", "bug_id": 59189, "creation_time": "2016-03-17T12:08:34Z", "is_private": false, "text": "Created attachment 33682\nMakes PerMessageDeflate call end on Inflater/Deflater by adding a close() method to the Transformation interface"}, {"count": 3, "tags": [], "creator": "henrik.olsson@mobenga.com", "is_private": false, "text": "(In reply to Mark Thomas from comment #1)\n> Sure. Attach the patch to this issue and someone will take a look.\n\nAttachment added. Not sure if it's the best way to do it but at least it's something :)", "id": 189532, "time": "2016-03-17T12:09:10Z", "bug_id": 59189, "creation_time": "2016-03-17T12:09:10Z", "attachment_id": null}, {"count": 4, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 189576, "time": "2016-03-18T11:34:11Z", "bug_id": 59189, "creation_time": "2016-03-18T11:34:11Z", "is_private": false, "text": "Thanks for the report and the proposed fix.\n\nI ended up applying a variation on your patch since I found a simpler path to call close().\n\nThe fix has been applied to:\n- 9.0.x for 9.0.0.M5 onwards\n- 8.5.x for 8.5.1 onwards\n- 8.0.x for 8.0.33 onwards\n- 7.0.x for 7.0.69 onwards"}, {"count": 5, "tags": [], "bug_id": 59189, "attachment_id": null, "id": 189577, "creation_time": "2016-03-18T11:41:31Z", "time": "2016-03-18T11:41:31Z", "creator": "henrik.olsson@mobenga.com", "text": "(In reply to Mark Thomas from comment #4)\n> Thanks for the report and the proposed fix.\n> \n> I ended up applying a variation on your patch since I found a simpler path\n> to call close().\n> \n> The fix has been applied to:\n> - 9.0.x for 9.0.0.M5 onwards\n> - 8.5.x for 8.5.1 onwards\n> - 8.0.x for 8.0.33 onwards\n> - 7.0.x for 7.0.69 onwards\n\nThanks for the quick response!", "is_private": false}]