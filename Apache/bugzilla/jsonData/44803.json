[{"count": 0, "tags": [], "bug_id": 44803, "text": "For the request:\n\nhttp://myhost/mywebapp/servlet/myservlet/pathcomp1/pathcomp2/foo%3Bbar?spaz=bot\n\nThe expected result of HttpServletRequest.getPathInfo() is\n\n/pathcomp1/pathcomp2/foo%3Bbar\n\nThe actual result in Tomcat 6.0.16 when using Apache 2.2.8 and mod_proxy_ajp, is:\n\n/pathcomp1/pathcomp2/foo\n\nAlso note that the %3B is already converted into a \";\" character in the results of\nHttpServletRequest.getRequestURI(), which is also quite incorrect.  Essentially the request URI is being decoded too early.\n\nmod_jk provided options like \"JkOptions +ForwardURIEscaped\" (and +ForwardURICompatUnparsed) to avoid this issue.  mod_proxy_ajp provides no such option.  This is a *very* serious omission in that it makes it impossible to get correct behavior for this use case in Tomcat and other servlet engines when fronted by mod_proxy_ajp.\n\nI'd very much appreciate a patch for this (and would test it, of course).", "id": 115527, "time": "2008-04-10T15:09:25Z", "creator": "jessh@ptc.com", "creation_time": "2008-04-10T15:09:25Z", "is_private": false, "attachment_id": null}, {"count": 1, "attachment_id": null, "bug_id": 44803, "is_private": false, "id": 115540, "time": "2008-04-10T23:24:26Z", "creator": "rpluem@apache.org", "creation_time": "2008-04-10T23:24:26Z", "tags": [], "text": "Please provide your proxy configuration."}, {"count": 2, "tags": [], "text": "Proxy configuration is:\n\n<Proxy balancer://ajpWorker>\n    BalancerMember ajp://localhost:8010 min=16 max=80 smax=40 ttl=900 keepalive=Off timeout=90000 retry=1 flushpackets=on  \n</Proxy>\n\nRewriteEngine on\nRewriteRule ^(/MyWebApp/(.*\\.jsp(.*)|servlet/.*|.*\\.jar))$ balancer://ajpWorker$1 [P]\n\nThis routes JSP, servlet, and .jar requests through Tomcat and lets Apache handle everything else.", "attachment_id": null, "bug_id": 44803, "id": 115544, "time": "2008-04-11T03:55:28Z", "creator": "jessh@ptc.com", "creation_time": "2008-04-11T03:55:28Z", "is_private": false}, {"count": 3, "tags": [], "creator": "jessh@ptc.com", "text": "By the way, we use\n\n  JkOptions +ForwardURIEscaped\n\nwhere we use mod_jk -- and that seems to work fine.", "id": 115545, "time": "2008-04-11T06:20:18Z", "bug_id": 44803, "creation_time": "2008-04-11T06:20:18Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 44803, "text": "If you use:\nRewriteRule ^(/myapp/(.*\\.jsp(.*)|servlet/.*|.*\\.jar))$ http://example.com/$1 [R=302,L]\n\nYou get: (404)\nThe requested URL /myapp/servlet/foo;bar was not found on this server.", "count": 4, "id": 115607, "time": "2008-04-15T05:20:04Z", "creator": "jfclere@gmail.com", "creation_time": "2008-04-15T05:20:04Z", "is_private": false}, {"count": 5, "tags": [], "creator": "jessh@ptc.com", "is_private": false, "text": "The rewrite rule most certainly gets us to Tomcat for URLs like that originally sited -- except that I unfortunately changed caps between my examples, i.e. the original URL should have been:\n\nhttp://myhost/MyWebApp/servlet/myservlet/pathcomp1/pathcomp2/foo%3Bbar?spaz=bot\n\nGiven that I used \"MyWebApp\", not \"mywebapp\" in the rewrite rule.", "id": 115608, "time": "2008-04-15T05:29:09Z", "bug_id": 44803, "creation_time": "2008-04-15T05:29:09Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 44803, "attachment_id": 21826, "is_private": false, "id": 115666, "time": "2008-04-17T05:42:31Z", "creator": "rpluem@apache.org", "creation_time": "2008-04-17T05:42:31Z", "text": "Created attachment 21826\nPatch against trunk\n\nWith this patch\n\nProxyPass(Match) /somewhere scheme://host/someplace nocanon\n\nshould work fine."}, {"count": 7, "tags": [], "creator": "rpluem@apache.org", "is_private": false, "text": "Created attachment 21833\nPatch against trunk\n\nIf it is not to late, please use this patch for testing if should contain our final thoughts on this issue. It is a diff of r649168 - r649840 of modules/proxy.", "id": 115720, "time": "2008-04-19T11:54:59Z", "bug_id": 44803, "creation_time": "2008-04-19T11:54:59Z", "attachment_id": 21833}, {"count": 8, "tags": [], "bug_id": 44803, "attachment_id": null, "id": 117046, "time": "2008-05-27T13:38:48Z", "creator": "dstusynski@ptc.com", "creation_time": "2008-05-27T13:38:48Z", "is_private": false, "text": "After applying the supplied patch (for mod_proxy_http.c and mod_proxy_ajp.c) against the 2.2.8 source I ran into an issue while testing the use of ProxyPassMatch. I did not test the mod_proxy_fcgi.c patch as we do not use, nor build fcgi.\n\nThe directive being used is: \n\n<IfModule mod_proxy_ajp.c>\n   ProxyPassMatch ^(/Windchill/(.*\\.jsp(.*)|servlet/.*|.*\\.jar))$ balancer://ajpWorker$1 nocanon\n</IfModule>\n\nThe balancer configuration is:\n<Proxy balancer://ajpWorker>\n\n    BalancerMember ajp://localhost:8010 min=16 max=80 smax=40 ttl=900 keepalive=Off timeout=90000 retry=1 flushpackets=on\n  \n</Proxy>\n\nThe issue is that the use of nocanon causes the URL to be rewritten incorrectly. A request to //ajpWorker/Windchill/netmarkets/jsp/product/list.jsp?tab=product&u8=1\nwas rewritten to ajp://localhost:8010/Windchill/netmarkets/jsp/product/list.jsp%3Ftab=product&u8=1?tab=product&u8=1\n\nThis resulted in a 404 from Tomcat. Removing the nocanon fixed the issue."}, {"count": 9, "attachment_id": 22020, "bug_id": 44803, "text": "Created attachment 22020\nPatch against trunk to mod_proxy_balancer\n\nCan you please check the attached patch in addition to the other patches?", "id": 117051, "time": "2008-05-27T14:29:19Z", "creator": "rpluem@apache.org", "creation_time": "2008-05-27T14:29:19Z", "tags": [], "is_private": false}, {"count": 10, "tags": [], "bug_id": 44803, "text": "The two patches combined, dated 2008-04-19 11:54 PST and 2008-05-27 14:29 PST respectively, seem to have done the trick.\n\nResults of a request to: http://host/dir/servlet/dir/dir/random%3Btest/okay?foo=bar \n\nThe HttpServletRequest.getPathInfo call returns :/dir/dir/random;test/okay: \nThe HttpServletRequest.getRequestURI call returns: :/dir/servlet/dir/dir/random%3Btest/okay: \n\nSo it appears to be in working order.\n\nAlso, the previously noted issue with nocanon improperly rewriting the URL was also corrected with the latter patch against mod_proxy_balancer.c.", "id": 117121, "time": "2008-05-29T07:49:31Z", "creator": "dstusynski@ptc.com", "creation_time": "2008-05-29T07:49:31Z", "is_private": false, "attachment_id": null}, {"count": 11, "attachment_id": null, "bug_id": 44803, "is_private": false, "id": 117150, "time": "2008-05-29T12:55:24Z", "creator": "rpluem@apache.org", "creation_time": "2008-05-29T12:55:24Z", "tags": [], "text": "Thanks for testing. Latest patch committed to trunk as r661452 (http://svn.apache.org/viewvc?view=rev&revision=661452)."}, {"attachment_id": null, "tags": [], "bug_id": 44803, "is_private": false, "count": 12, "id": 117152, "time": "2008-05-29T13:33:40Z", "creator": "rpluem@apache.org", "creation_time": "2008-05-29T13:33:40Z", "text": "Proposed for backport as r661465\n(http://svn.apache.org/viewvc?view=rev&revision=661465)."}, {"count": 13, "tags": [], "text": "Backported to 2.2.x as r663593\n(http://svn.apache.org/viewvc?view=rev&revision=663593).", "is_private": false, "id": 117371, "creator": "rpluem@apache.org", "time": "2008-06-05T05:50:36Z", "bug_id": 44803, "creation_time": "2008-06-05T05:50:36Z", "attachment_id": null}]