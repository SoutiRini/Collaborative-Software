[{"count": 0, "attachment_id": null, "bug_id": 53345, "text": "Seeing the below OutOfMemoryError error associated with Log4j ver log4j-1.2.15.jar.\n\nCaused by: java.lang.OutOfMemoryError\n\tat java.util.Arrays.copyOfRange(Arrays.java:4078)\n\tat java.util.Arrays.copyOf(Arrays.java:3810)\n\tat java.io.ByteArrayOutputStream.write(ByteArrayOutputStream.java:108)\n\tat java.io.PrintStream.write(PrintStream.java:443)\n\tat sun.nio.cs.StreamEncoder$CharsetSE.writeBytes(StreamEncoder.java:343)\n\tat sun.nio.cs.StreamEncoder$CharsetSE.implFlushBuffer(StreamEncoder.java:413)\n\tat sun.nio.cs.StreamEncoder$CharsetSE.implFlush(StreamEncoder.java:417)\n\tat sun.nio.cs.StreamEncoder.flush(StreamEncoder.java:161)\n\tat java.io.OutputStreamWriter.flush(OutputStreamWriter.java:263)\n\tat org.apache.log4j.helpers.QuietWriter.flush(QuietWriter.java:58)\n\tat org.apache.log4j.WriterAppender.subAppend(WriterAppender.java:316)\n\tat org.apache.log4j.WriterAppender.append(WriterAppender.java:160)\n\tat org.apache.log4j.AppenderSkeleton.doAppend(AppenderSkeleton.java:251)\n\tat org.apache.log4j.helpers.AppenderAttachableImpl.appendLoopOnAppenders(AppenderAttachableImpl.java:66)\n\tat org.apache.log4j.Category.callAppenders(Category.java:206)\n\tat org.apache.log4j.Category.forcedLog(Category.java:391)\n\tat org.apache.log4j.Category.debug(Category.java:260)\n\tat com.bcbsma.adapter.util.TPS837_D_Utils.getTransformed837DXmls(TPS837_D_Utils.java:119)\n\tat com.bcbsma.adapter.impl.TPS837AdapterImpl.processRequest(TPS837AdapterImpl.java:239)\n\tat sun.reflect.GeneratedMethodAccessor1768.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:600)\n\tat org.apache.tuscany.sca.implementation.java.invocation.JavaImplementationInvoker.invoke(JavaImplementationInvoker.java:158)\n\tat com.ibm.ws.soa.sca.observer.integration.ObserverInterceptor.invoke(ObserverInterceptor.java:199)\n\tat com.ibm.ws.soa.sca.binding.jms.provider.JMSInterceptor.invoke(JMSInterceptor.java:64)\n\tat com.ibm.ws.soa.sca.runtime.impl.RuntimeExtensionManager.invokeNextInterceptor(RuntimeExtensionManager.java:237)\n\tat com.ibm.ws.soa.sca.runtime.impl.RuntimeExtensionManager.processMessage(RuntimeExtensionManager.java:98)\n\tat com.ibm.ws.soa.sca.runtime.impl.RuntimeTuscanyInterceptor.invoke(RuntimeTuscanyInterceptor.java:209)\n\tat org.apache.tuscany.sca.core.databinding.wire.DataTransformationInterceptor.invoke(DataTransformationInterceptor.java:67)\n\tat org.apache.tuscany.sca.core.invocation.RuntimeWireInvoker.invoke(RuntimeWireInvoker.java:129)\n\t... 24 more", "id": 159600, "time": "2012-06-01T13:52:59Z", "creator": "mallikarjun.channappagoudar@bcbsma.com", "creation_time": "2012-06-01T13:52:59Z", "tags": [], "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 53345, "text": "Hello,\n\ncan you provide more information?\n\nCould you for example look how the log statement looks like:\nom.bcbsma.adapter.util.TPS837_D_Utils.getTransformed837DXmls(TPS837_D_Utils.java:119)\n\nIs it a String? How big is it?\n\nAlso can you probably show us your configuration?\n\nThanks!", "id": 159601, "time": "2012-06-01T14:02:06Z", "creator": "grobmeier@gmail.com", "creation_time": "2012-06-01T14:02:06Z", "tags": [], "is_private": false}, {"text": "(In reply to comment #1)\n> Hello,\n> \n> can you provide more information?\n> \n> Could you for example look how the log statement looks like:\n> om.bcbsma.adapter.util.TPS837_D_Utils.getTransformed837DXmls(TPS837_D_Utils.\n> java:119)\n> \n> Is it a String? How big is it?\n> \n> Also can you probably show us your configuration?\n> \n> Thanks!\n\nSurprisingly the line of code at TPS837_D_Utils.java:119 is not a debug statement, but for some reason the error stack has the following lines.\n\n\tat org.apache.log4j.Category.forcedLog(Category.java:391)\n\tat org.apache.log4j.Category.debug(Category.java:260)\n\tat com.bcbsma.adapter.util.TPS837_D_Utils.getTransformed837DXmls(TPS837_D_Utils.java:119)\n\nBut there are other instances where the line of code is actually a logger.debug statement and have caused OutOfMemory errors.\n\nThis has happened for small as well as large strings.\n\nThe configuration and env info is as follows.\n\nThe OS is Linux 2.6.18-164.el5 x86_64 GNU/Linux.\nThe application is deployed on WAS ND 7.0 with SCA Feature pack 1.0.1\n\nI tried to attach the native_stderr.log file to the bug but may be due to file size it was not getting attached.", "tags": [], "creator": "mallikarjun.channappagoudar@bcbsma.com", "is_private": false, "count": 2, "id": 159607, "time": "2012-06-01T14:52:33Z", "bug_id": 53345, "creation_time": "2012-06-01T14:52:33Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 53345, "attachment_id": null, "id": 159608, "time": "2012-06-01T14:58:42Z", "creator": "grobmeier@gmail.com", "creation_time": "2012-06-01T14:58:42Z", "is_private": false, "text": "Can you try to attach the configuration at least?\nWe should look into what appenders you are using.\n\nDo you also use MDC or FilewatchDog or something like that?"}, {"count": 4, "attachment_id": null, "bug_id": 53345, "is_private": false, "id": 159609, "time": "2012-06-01T15:10:31Z", "creator": "mallikarjun.channappagoudar@bcbsma.com", "creation_time": "2012-06-01T15:10:31Z", "tags": [], "text": "(In reply to comment #3)\n> Can you try to attach the configuration at least?\n> We should look into what appenders you are using.\n> \n> Do you also use MDC or FilewatchDog or something like that?\n\nWe use MDC. Find attached the config file."}, {"count": 5, "tags": [], "bug_id": 53345, "attachment_id": 28875, "text": "Created attachment 28875\nConfig file.", "id": 159610, "time": "2012-06-01T15:12:09Z", "creator": "mallikarjun.channappagoudar@bcbsma.com", "creation_time": "2012-06-01T15:12:09Z", "is_private": false}, {"text": "Probably you are running into MDC problems.\nDo you remove all the key appropriate after you have added them to MDC?\n\nThe config does not look as it would cause problems, so I suspect MDC.\n\nWith 1.2.17 a nasty MDC related fix has been applied. Please see the conversation around it here:\nhttps://issues.apache.org/bugzilla/show_bug.cgi?id=50486\n\nAt the bottom is some example code how to proper use MDC (and clean it up).\n\nPlease let me know if an upgrade to 1.2.17 and the recommendations from this issue helped you.", "tags": [], "creator": "grobmeier@gmail.com", "is_private": false, "count": 6, "id": 159611, "time": "2012-06-01T15:17:53Z", "bug_id": 53345, "creation_time": "2012-06-01T15:17:53Z", "attachment_id": null}, {"count": 7, "tags": [], "creator": "mallikarjun.channappagoudar@bcbsma.com", "attachment_id": null, "id": 159625, "time": "2012-06-01T20:05:20Z", "bug_id": 53345, "creation_time": "2012-06-01T20:05:20Z", "is_private": false, "text": "(In reply to comment #6)\n> Probably you are running into MDC problems.\n> Do you remove all the key appropriate after you have added them to MDC?\n> \n> The config does not look as it would cause problems, so I suspect MDC.\n> \n> With 1.2.17 a nasty MDC related fix has been applied. Please see the\n> conversation around it here:\n> https://issues.apache.org/bugzilla/show_bug.cgi?id=50486\n> \n> At the bottom is some example code how to proper use MDC (and clean it up).\n> \n> Please let me know if an upgrade to 1.2.17 and the recommendations from this\n> issue helped you.\n\nWe will try the version 1.2.17.\nWe use MDC in the following way, we do not remove the keys.\n\n\t\t// Add set MDC at the beginning of Adapter transaction\n\t\ttry {\n\t\t\tMDC.put(com.bcbsma.service.extendedmodel.Constants.MDC_CONTEXT, resp.getSubmitClaimRequest().getContext().getRequestId());\n\t\t} catch (Exception ex) {\n\t\t\tlogger.error(ex);\n\t\t\t// ignore the Error\n\t\t}"}, {"count": 8, "tags": [], "bug_id": 53345, "attachment_id": null, "text": "OK then this will cause the trouble.\n\nBasically MDC puts its values to ThreadLocalMap:\nhttp://svn.apache.org/repos/asf/logging/log4j/trunk/src/main/java/org/apache/log4j/MDC.java\n\nIt seems that your thread is putting so much values that at some point of time the memory is full. To prevent this, you need to clean up MDC like for example:\n\ntry {\n    MDC.put(myKey);\n    chain.doFilter(request, response);\n} finally {\n    MDC.remove(myKey);\n}        \n\nOr you can clear the whole MDC with: MDC.clear();\n\nit would be nice if you would try that out and let us know if your issue is solved then.\n\nThanks!", "id": 159627, "time": "2012-06-01T20:10:29Z", "creator": "grobmeier@gmail.com", "creation_time": "2012-06-01T20:10:29Z", "is_private": false}, {"text": "(In reply to comment #8)\n> OK then this will cause the trouble.\n> \n> Basically MDC puts its values to ThreadLocalMap:\n> http://svn.apache.org/repos/asf/logging/log4j/trunk/src/main/java/org/apache/\n> log4j/MDC.java\n> \n> It seems that your thread is putting so much values that at some point of\n> time the memory is full. To prevent this, you need to clean up MDC like for\n> example:\n> \n> try {\n>     MDC.put(myKey);\n>     chain.doFilter(request, response);\n> } finally {\n>     MDC.remove(myKey);\n> }        \n> \n> Or you can clear the whole MDC with: MDC.clear();\n> \n> it would be nice if you would try that out and let us know if your issue is\n> solved then.\n> \n> Thanks!\n\nThanks for your blazing fast responses.\nWe will incorporate the suggested changes and let you know of the outcome.", "tags": [], "bug_id": 53345, "is_private": false, "count": 9, "id": 159673, "time": "2012-06-04T14:41:55Z", "creator": "mallikarjun.channappagoudar@bcbsma.com", "creation_time": "2012-06-04T14:41:55Z", "attachment_id": null}]