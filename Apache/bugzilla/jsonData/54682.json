[{"attachment_id": null, "tags": [], "creator": "philip.persad@gmail.com", "text": "In the constructor for org.apache.poi.hwpf.model.UnhandledDataStructure, a byte array is allocated using a length value prior to the code which validates that the parameters passed to the constructor are sane.  The current check is:\n\nif (offset + length > buf.length)\n    {\n      throw new IndexOutOfBoundsException(\"buffer length is \" + buf.length +\n                                          \"but code is trying to read \" + length + \" from offset \" + offset);\n    }\n\nThis should be done prior to creating the buffer.  In one case a malformed word document was attempting to allocate ~1.8g of data when the total files size was 90k.\n\nAlso, the check should be:\n\nif (((long) offset) + length > buf.length)\n\nIn a corrupt file the parameters could potentially be large enough to overflow an integer.", "count": 0, "id": 165783, "time": "2013-03-13T00:44:43Z", "bug_id": 54682, "creation_time": "2013-03-13T00:44:43Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 54682, "attachment_id": null, "id": 165917, "time": "2013-03-18T00:23:59Z", "creator": "apache@gagravarr.org", "creation_time": "2013-03-18T00:23:59Z", "is_private": false, "text": "Do you have a sample file that shows off the problem you could share?"}, {"count": 2, "tags": [], "bug_id": 54682, "attachment_id": null, "id": 165969, "time": "2013-03-18T17:36:59Z", "creator": "philip.persad@gmail.com", "creation_time": "2013-03-18T17:36:59Z", "is_private": false, "text": "Unfortunately, I'm working under some rather strong confidentiality constraints and cannot provide you with the document which causes the error.\n\nHowever, the current structure of the code is:\n<allocate buffer>\n<sanity check length>\n<perform copy>\n\nThe structure:\n<sanity check length>\n<allocate buffer>\n<perform copy>\n\nIs clearly safer.  The fact that there is a sanity check in the existing code acknowledges that unsafe behaviour is possible, in that case it makes a lot of sense to perform buffer allocation afterwards.\n\nIt's also worth noting that an OutOfMemoryError is a catastrophic failure.  The worst case for most exceptions thrown by the poi library is a failure to parse a given document.  However, an OutOfMemoryError will generally take down the entire application."}, {"count": 3, "tags": [], "bug_id": 54682, "text": "Would you consider using the patch provided by RedHat regarding this issue?\nIt's available in their own bug report: https://bugzilla.redhat.com/show_bug.cgi?id=799078", "id": 167470, "time": "2013-05-29T07:46:58Z", "creator": "damiano.albani@gmail.com", "creation_time": "2013-05-29T07:46:58Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "apache@gagravarr.org", "attachment_id": null, "text": "Fixed in r1487555. (Slightly different patch to the redhat one, but the same idea)", "id": 167483, "time": "2013-05-29T17:26:54Z", "bug_id": 54682, "creation_time": "2013-05-29T17:26:54Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 54682, "attachment_id": null, "id": 167485, "time": "2013-05-29T19:23:56Z", "creator": "philip.persad@gmail.com", "creation_time": "2013-05-29T19:23:56Z", "is_private": false, "text": "The code:\n\nif (offset < 0 || length < 0)\n\nFails to account for the very real potential for integer overflow.  The check for offset + length < 0 is necessary.  I avoided that by casting to long, however I think the RedHat solution using binary inclusive OR is more elegant."}, {"count": 6, "tags": [], "creator": "apache@gagravarr.org", "attachment_id": null, "text": "I made some additional tweaks in r1487558, which I think should cover the int overflowing into negative case. If you think there's something still missing, please let me know, and if possible include a failing unit test :)", "id": 167490, "time": "2013-05-29T22:01:34Z", "bug_id": 54682, "creation_time": "2013-05-29T22:01:34Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "philip.persad@gmail.com", "text": "r1487558 looks good.", "count": 7, "id": 167492, "time": "2013-05-29T22:27:00Z", "bug_id": 54682, "creation_time": "2013-05-29T22:27:00Z", "is_private": false}]