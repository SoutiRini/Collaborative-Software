[{"count": 0, "tags": [], "bug_id": 55583, "attachment_id": null, "text": "I updated Tcl to 8.6.1 (from 8.6.0) on my personal machine tonight and Rivet started breaking when the code tries to do a \"headers\" command.\n\nmod_rivet-2.1.2     Embeds a Tcl interpreter in the Apache server\napache22-2.2.25     Version 2.2.x of Apache web server with prefork MPM.\ntcl86-8.6.1         Tool Command Language\n\nFor example, a rivet script which contains only:\n\n<?\n\nheaders redirect http://yahoo.com/\n\n?>\n\nTraces back thusly:\nRivet Error\ncommand returned bad code: 0\n    while executing\n\"namespace eval request {\nputs -nonewline \"\"\n\n\nheaders redirect http://yahoo.com/\n\n\nputs -nonewline \"\n\"\n\n}\"\n\nAs far as I know, the only thing I've changed is the Tcl 8.6.0 to 8.6.1.  Seems to be specific to \"redirect\" because \"headers add x-cow moo\" does not exhibit the behavior.\n\nAny clue?  I'm not familiar with the \"returned bad code\" Tcl response.", "id": 170219, "time": "2013-09-23T05:11:02Z", "creator": "jlawson-apache@bovine.net", "creation_time": "2013-09-23T05:11:02Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 55583, "text": "Massimo,\nI have tried your example with 2.1.2 and tcl8.6.1 and it worked for me, no error.\n\nSorry,\nHarald", "id": 170220, "time": "2013-09-23T07:03:42Z", "creator": "harald.oehlmann@elmicron.de", "creation_time": "2013-09-23T07:03:42Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 55583, "is_private": false, "count": 2, "id": 170223, "time": "2013-09-23T11:20:21Z", "creator": "mxmanghi@apache.org", "creation_time": "2013-09-23T11:20:21Z", "text": "Works for me too. Just run with Tcl 8.6.1 and Apache 2.2.22. I should test it with 2.2.25\n\nthe error message is weird: I didn't find any message starting with \"Rivet Error\" except when followed by more words \n\nrivet/trunk/src/apache-2/mod_rivet.c:            TclWeb_PrintError(\"<b>Rivet ErrorScript failed!</b>\",1,globals->req);\nrivet/trunk/src/apache-2/mod_rivet.c:        return \"Rivet Error: RivetServerConf requires two arguments\";\nrivet/trunk/src/apache-2/mod_rivet.c:        return \"Rivet Error: RivetDirConf requires two arguments\";\nrivet/trunk/src/apache-2/mod_rivet.c:        return \"Rivet Error: RivetUserConf requires two arguments\";\n\nis your message complete? was it changed or simplified by you?"}, {"count": 3, "attachment_id": 30873, "bug_id": 55583, "text": "Created attachment 30873\nbare-bones httpd.conf for Apache", "id": 170233, "time": "2013-09-23T19:11:47Z", "creator": "nugget@macnugget.org", "creation_time": "2013-09-23T19:11:47Z", "tags": [], "is_private": false}, {"attachment_id": 30874, "tags": [], "bug_id": 55583, "text": "Created attachment 30874\nMinimal rivet script to demonstrate problem", "count": 4, "id": 170234, "time": "2013-09-23T19:12:08Z", "creator": "nugget@macnugget.org", "creation_time": "2013-09-23T19:12:08Z", "is_private": false}, {"count": 5, "tags": [], "text": "I am able to reproduce the problem by also adding an ErrorScript config to Rivet in httpd.conf.  If I don't define an ErrorScript the problem does not seem to occur.\n\nI've attached working (very minimal) Apache httpd.conf which should allow others to reproduce the problem.\n\nRivetServerConf ChildInitScript \"proc error_handler {} { headers numeric 500 ; puts $::errorInfo }\"\nRivetServerConf ErrorScript error_handler\n\n<? headers redirect http://yahoo.com/ ?> produces the following traceback:\n\n\"command returned bad code: 0 while executing \"namespace eval request { puts -nonewline \"\" headers redirect http://flightaware.com/ puts -nonewline \" \" }\"\"\n\n<? headers add x-cow moo ?> performs as expected.\n\n<? bogus_command_that_doesnt_exist ?> calls error_handler as expected.\n\nRivet 2.1.2, Apache 2.2.25, Tcl 8.6.1 as installed by fresh FreeBSD ports on FreeBSD 9.1-RELEASE.", "attachment_id": null, "bug_id": 55583, "id": 170235, "time": "2013-09-23T19:21:50Z", "creator": "nugget@macnugget.org", "creation_time": "2013-09-23T19:21:50Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 55583, "is_private": false, "text": "Confirmed: I was able to reproduce the traceback with Tcl 8.6.1 *and* Apache 2.2.25 (Debian/linux unstable). Changing one of these to 8.6.0 or 2.2.22 doesn't produce the bug.\n\nI removed the numeric header command from the error handler and the bug doesn't show up again. Time to investigate what 'headers numeric' is actually doing, but I can't get on it immediately", "id": 170262, "time": "2013-09-24T22:17:08Z", "creator": "mxmanghi@apache.org", "creation_time": "2013-09-24T22:17:08Z", "attachment_id": null}, {"count": 7, "attachment_id": 30911, "bug_id": 55583, "text": "Created attachment 30911\nheaders redirect returned code changed from TCL_RETURN to TCL_OK\n\nI don't know if this has side effects (I still have to run the test suite) but apparently this trivial patch fixes the problem (Rivet 2.1.3, Apache 2.2.25, Tcl 8.6.1). The problem is with the Tcl code returned by command 'headers redirect ...' which is TCL_RETURN. I don't understand what happened under the hood of Tcl, but probably there is some interaction with the NRE that didn't occur in Tcl 8.6.0 (8.5 still has the recursive engine) \n\nIt seems to me that if TCL_RETURN could work out an equivalent TCL_OK in most cases, but Tcl 8.6.1 must have changed something. I wonder if this was a mistake or intentional of the person who originally coded this command.", "id": 170499, "time": "2013-10-08T23:47:57Z", "creator": "mxmanghi@apache.org", "creation_time": "2013-10-08T23:47:57Z", "tags": [], "is_private": false}, {"count": 8, "tags": [], "text": "I ran the tests on a module with this patch applied and everything was fine. I will therefore change this bug's status as 'resolved', allowing more time for new feedback before closing it", "is_private": false, "bug_id": 55583, "id": 170624, "time": "2013-10-15T22:35:28Z", "creator": "mxmanghi@apache.org", "creation_time": "2013-10-15T22:35:28Z", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 55583, "attachment_id": null, "text": "We have confirmed proper behavior with the proposed patch.", "id": 170655, "time": "2013-10-17T20:28:35Z", "creator": "jlawson-apache@bovine.net", "creation_time": "2013-10-17T20:28:35Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 55583, "is_private": false, "text": "Thanks, patch applied to code in trunk. I'm closing this bug", "id": 170658, "time": "2013-10-17T21:16:06Z", "creator": "mxmanghi@apache.org", "creation_time": "2013-10-17T21:16:06Z", "attachment_id": null}]