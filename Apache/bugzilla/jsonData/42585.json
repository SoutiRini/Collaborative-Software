[{"attachment_id": null, "tags": [], "bug_id": 42585, "text": "We had an issue when the SocketNode thread died with an OOM exception. The\nsocket is not closed in this case. The sending SocketAppender doesn't notice and\nblocks indefinitely in SocketOutputStream.write. Due to the locks held on the\nappender this causes the whole application to block.\n\nOne solution should be to close the the socket in a finally block. Of course we\nare also adding size checks to the problematic log statement plus increasing the\nheap size of the logserver.\n\n\"Dispatcher-Thread-3\" daemon prio=1 tid=0x5b6b6120 nid=0x6c8e runnable\n[0x5b16f000..0x5b16f770]\n\tat java.net.SocketOutputStream.socketWrite0(Native Method)\n\tat java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:92)\n\tat java.net.SocketOutputStream.write(SocketOutputStream.java:136)\n\tat\njava.io.ObjectOutputStream$BlockDataOutputStream.drain(ObjectOutputStream.java:1682)\n\tat\njava.io.ObjectOutputStream$BlockDataOutputStream.setBlockDataMode(ObjectOutputStream.java:1591)\n\tat java.io.ObjectOutputStream.writeNonProxyDesc(ObjectOutputStream.java:1173)\n\tat java.io.ObjectOutputStream.writeClassDesc(ObjectOutputStream.java:1127)\n\tat java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1284)\n\tat java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1079)\n\tat java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:302)\n\tat org.apache.log4j.net.SocketAppender.append(SocketAppender.java:224)\n\tat org.apache.log4j.AppenderSkeleton.doAppend(AppenderSkeleton.java:221)\n\t- locked <0x66a9c690> (a org.apache.log4j.net.SocketAppender)\n\tat\norg.apache.log4j.helpers.AppenderAttachableImpl.appendLoopOnAppenders(AppenderAttachableImpl.java:57)\n\tat org.apache.log4j.Dispatcher.run(AsyncAppender.java:310)\n\t- locked <0x66a9a060> (a org.apache.log4j.helpers.AppenderAttachableImpl)", "count": 0, "id": 104071, "time": "2007-06-05T05:08:09Z", "creator": "odi@odi.ch", "creation_time": "2007-06-05T05:08:09Z", "is_private": false}, {"attachment_id": 20312, "tags": [], "creator": "odi@odi.ch", "text": "Created attachment 20312\npatch", "count": 1, "id": 104078, "time": "2007-06-05T06:32:26Z", "bug_id": 42585, "creation_time": "2007-06-05T06:32:26Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 42585, "attachment_id": null, "text": "Fixed in rev 544675.  Should make it into log4j 1.2.15.  run method didn't check if ois or socket was null \nbefore doing actions on them so I added checks in addition to your suggested changes.", "id": 104103, "time": "2007-06-05T16:28:10Z", "creator": "carnold@apache.org", "creation_time": "2007-06-05T16:28:10Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 42585, "attachment_id": null, "text": "Fantastic, thanks a lot.", "id": 104111, "time": "2007-06-06T00:38:36Z", "creator": "odi@odi.ch", "creation_time": "2007-06-06T00:38:36Z", "is_private": false}, {"count": 4, "attachment_id": null, "bug_id": 42585, "text": "*** Bug 46324 has been marked as a duplicate of this bug. ***", "id": 123877, "time": "2009-01-08T09:34:51Z", "creator": "carnold@apache.org", "creation_time": "2009-01-08T09:34:51Z", "tags": [], "is_private": false}]