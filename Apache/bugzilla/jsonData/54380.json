[{"count": 0, "text": "In r1429745 I added a test to trunk that test what happens if the first attempt to start a Context fails, the cause of the failure is removed, and then the context is started for the second time.\n\nThe test is TestStandardContext.testBug46243().\n\nIt runs successfully, but the following message is logged:\n\nJan 07, 2013 3:02:07 PM org.apache.catalina.mapper.Mapper addWrapper\nSEVERE: No context found: \n\nThis happens when the context is started for the second time. If I put a breakpoint on the line that logs the message, the stack trace is (running Tomcat trunk):\n\n  Mapper.addWrapper(String, String, String, String, Wrapper, boolean, boolean) line: 319\t\n  MapperListener.registerWrapper(Wrapper) line: 417\t\n  MapperListener.lifecycleEvent(LifecycleEvent) line: 433\t\n  LifecycleSupport.fireLifecycleEvent(String, Object) line: 119\t\n  Tomcat$ExistingStandardWrapper(LifecycleBase).fireLifecycleEvent(String, Object) line: 90\t\n  Tomcat$ExistingStandardWrapper(LifecycleBase).setStateInternal(LifecycleState, Object, boolean) line: 402\t\n  Tomcat$ExistingStandardWrapper(LifecycleBase).start() line: 168\t\n  StandardContext.startInternal() line: 5009\t\n  StandardContext(LifecycleBase).start() line: 150\t\n  TestStandardContext.testBug46243() line: 109\t\n\n================================================\nMy understanding is the following:\n\n1. When Tomcat starts, registration into the mapper is performed by StandardService.startInternal().\nStack trace:\n  Mapper.addHost(String, String[], Host) line: 89\t\n  MapperListener.registerHost(Host) line: 287\t\n  MapperListener.startInternal() line: 107\t\n  MapperListener(LifecycleBase).start() line: 150\t\n  StandardService.startInternal() line: 450\t\n  StandardService(LifecycleBase).start() line: 150\t\n  StandardServer.startInternal() line: 745\t\n  StandardServer(LifecycleBase).start() line: 150\t\n  TomcatBaseTest$TomcatWithFastSessionIDs(Tomcat).start() line: 326\t\n  TomcatBaseTest$TomcatWithFastSessionIDs.start() line: 421\t\n  TestStandardContext.testBug46243() line: 89\t\n\n2. The Context that failed to start is skipped by MapperListener.registerHost(), thanks to getState().isAvailable() check there.\n\n3. The Mapper.addWrapper() call (the one that prints that \"No context found\" message) happens when AFTER_START_EVENT is processed for the Wrapper. At this moment the StandardContext.startInternal() has not completed yet and thus the context has not been registered by the mapper.\n\n4. Nothing serious happens, besides the message, because when StandardContext.startInternal() completes, the AFTER_START_EVENT for the Context is processed. This is when the Context and the Wrappers that it contains are registered.\n\nThus I think there should be a check either in MapperListener.lifecycleEvent() or in MapperListener.registerWrapper() that tests whether getContainer().getState().isAvailable() is true.", "bug_id": 54380, "attachment_id": null, "id": 164430, "time": "2013-01-07T12:37:27Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-01-07T12:37:27Z", "tags": [], "is_private": false}, {"count": 1, "text": "Fixed in trunk and 7.0 by r1430147 r1430173 . It will be in 7.0.35 onwards.", "bug_id": 54380, "is_private": false, "id": 164469, "time": "2013-01-08T08:54:09Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-01-08T08:54:09Z", "tags": [], "attachment_id": null}]