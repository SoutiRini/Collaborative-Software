[{"count": 0, "tags": [], "bug_id": 47114, "attachment_id": null, "id": 126602, "time": "2009-04-29T00:00:42Z", "creator": "vampirechina@hotmail.com", "creation_time": "2009-04-29T00:00:42Z", "is_private": false, "text": "Threads in Apache 2.0.63  hang and not release memory sometimes.\nI am using the prefork mpm on linux 2.6 Red Hat Enterprise Linux AS release 4 (Nahant Update 5).  \nKernel  is 2.6.9-55.ELsmp #1 SMP Fri Apr 20 17:03:35 EDT 2007 i686 i686 i386 GNU/Linux.\n\nHere is my server information.\n[root@web22 ~]# /usr/local/apache/bin/httpd -v\nServer version: Apache/2.0.63\nServer built:   Jun 23 2008 11:24:13\n[root@web22 ~]# /usr/local/apache/bin/httpd -l\nCompiled in modules:\n  core.c\n  mod_access.c\n  mod_auth.c\n  mod_include.c\n  mod_log_config.c\n  mod_env.c\n  mod_setenvif.c\n  prefork.c\n  http_core.c\n  mod_mime.c\n  mod_status.c\n  mod_autoindex.c\n  mod_asis.c\n  mod_cgi.c\n  mod_negotiation.c\n  mod_dir.c\n  mod_imap.c\n  mod_actions.c\n  mod_userdir.c\n  mod_alias.c\n  mod_so.c\n[root@web22 ~]# top -p 7439\ntop - 14:17:16 up 9 days, 55 min,  5 users,  load average: 1.23, 1.64, 1.75\nTasks:   1 total,   0 running,   1 sleeping,   0 stopped,   0 zombie\nCpu(s): 10.7% us,  2.0% sy,  0.0% ni, 87.2% id,  0.1% wa,  0.1% hi,  0.0% si\nMem:   8310220k total,  5859196k used,  2451024k free,   244240k buffers\nSwap:  6144852k total,    73540k used,  6071312k free,  1673068k cached\n  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                \n 7439 webid     16   0  185m 151m 7456 S    0  1.9   0:35.62 httpd \n\n[root@web22 ~]# ps -ef | grep httpd | grep 7439\nwebid     7439  4322  0 00:20 ?        00:00:35 /usr/local/apache/bin/httpd -k start\n\n\nAnd  here is my strace log\n[root@web22 ~]# strace -p 7439\nProcess 7439 attached - interrupt to quit\nfutex(0x23a840, FUTEX_WAIT, 2, NULL <unfinished ...>\nProcess 7439 detached\n\n\nHere is my gdb trace\n\n[root@web22 ~]# gdb --quiet\n(gdb) attach 7439\nAttaching to process 7439\nReading symbols from /usr/local/apache/bin/httpd...done.\nUsing host libthread_db library \"/lib/tls/libthread_db.so.1\".\nReading symbols from /lib/libcwait.so...done.\nLoaded symbols for /lib/libcwait.so\nReading symbols from /usr/local/apache/lib/libaprutil-0.so.0...done.\nLoaded symbols for /usr/local/apache/lib/libaprutil-0.so.0\nReading symbols from /usr/lib/libexpat.so.0...done.\nLoaded symbols for /usr/lib/libexpat.so.0\nReading symbols from /usr/local/apache/lib/libapr-0.so.0...done.\nLoaded symbols for /usr/local/apache/lib/libapr-0.so.0\nReading symbols from /lib/tls/librt.so.1...done.\nLoaded symbols for /lib/tls/librt.so.1\nReading symbols from /lib/tls/libm.so.6...done.\nLoaded symbols for /lib/tls/libm.so.6\nReading symbols from /lib/libcrypt.so.1...done.\nLoaded symbols for /lib/libcrypt.so.1\nReading symbols from /lib/libnsl.so.1...done.\nLoaded symbols for /lib/libnsl.so.1\nReading symbols from /lib/tls/libpthread.so.0...done.\n[Thread debugging using libthread_db enabled]\n[New Thread -1207974208 (LWP 7439)]\nLoaded symbols for /lib/tls/libpthread.so.0\nReading symbols from /lib/libdl.so.2...done.\nLoaded symbols for /lib/libdl.so.2\nReading symbols from /lib/tls/libc.so.6...done.\nLoaded symbols for /lib/tls/libc.so.6\nReading symbols from /lib/ld-linux.so.2...done.\nLoaded symbols for /lib/ld-linux.so.2\nReading symbols from /lib/libnss_files.so.2...done.\nLoaded symbols for /lib/libnss_files.so.2\nReading symbols from /usr/local/apache/modules/mod_rewrite.so...done.\nLoaded symbols for /usr/local/apache/modules/mod_rewrite.so\nReading symbols from /usr/local/apache/modules/mod_deflate.so...done.\nLoaded symbols for /usr/local/apache/modules/mod_deflate.so\nReading symbols from /usr/lib/libz.so.1...done.\nLoaded symbols for /usr/lib/libz.so.1\nReading symbols from /usr/local/apache/modules/mod_headers.so...done.\nLoaded symbols for /usr/local/apache/modules/mod_headers.so\nReading symbols from /usr/local/apache/modules/libphp4.so...done.\nLoaded symbols for /usr/local/apache/modules/libphp4.so\nReading symbols from /usr/local/gd/lib/libgd.so.2...done.\nLoaded symbols for /usr/local/gd/lib/libgd.so.2\nReading symbols from /usr/local/lib/libfreetype.so.6...done.\nLoaded symbols for /usr/local/lib/libfreetype.so.6\nReading symbols from /usr/local/lib/libpng12.so.0...done.\nLoaded symbols for /usr/local/lib/libpng12.so.0\nReading symbols from /usr/lib/libjpeg.so.62...done.\nLoaded symbols for /usr/lib/libjpeg.so.62\nReading symbols from /usr/lib/libcurl.so.3...done.\nLoaded symbols for /usr/lib/libcurl.so.3\nReading symbols from /lib/libresolv.so.2...done.\nLoaded symbols for /lib/libresolv.so.2\nReading symbols from /lib/libssl.so.4...done.\nLoaded symbols for /lib/libssl.so.4\nReading symbols from /lib/libcrypto.so.4...done.\nLoaded symbols for /lib/libcrypto.so.4\nReading symbols from /usr/lib/libgssapi_krb5.so.2...done.\nLoaded symbols for /usr/lib/libgssapi_krb5.so.2\nReading symbols from /usr/lib/libkrb5.so.3...done.\nLoaded symbols for /usr/lib/libkrb5.so.3\nReading symbols from /lib/libcom_err.so.2...done.\nLoaded symbols for /lib/libcom_err.so.2\nReading symbols from /usr/lib/libk5crypto.so.3...done.\nLoaded symbols for /usr/lib/libk5crypto.so.3\nReading symbols from /usr/lib/libidn.so.11...done.\nLoaded symbols for /usr/lib/libidn.so.11\nReading symbols from /opt/oracle/product/9.2.0/lib/libclntsh.so.9.0...done.\nLoaded symbols for /opt/oracle/product/9.2.0/lib/libclntsh.so.9.0\nReading symbols from /usr/X11R6/lib/libXpm.so.4...done.\nLoaded symbols for /usr/X11R6/lib/libXpm.so.4\nReading symbols from /usr/X11R6/lib/libX11.so.6...done.\nLoaded symbols for /usr/X11R6/lib/libX11.so.6\nReading symbols from /usr/lib/libfontconfig.so.1...done.\nLoaded symbols for /usr/lib/libfontconfig.so.1\nReading symbols from /opt/oracle/product/9.2.0/lib/libwtc9.so...done.\nLoaded symbols for /opt/oracle/product/9.2.0/lib/libwtc9.so\nReading symbols from /usr/X11R6/lib/libXext.so.6...done.\nLoaded symbols for /usr/X11R6/lib/libXext.so.6\nReading symbols from /usr/local/php/lib/php/extensions/no-debug-non-zts-20020429/eaccelerator.so...done.\nLoaded symbols for /usr/local/php/lib/php/extensions/no-debug-non-zts-20020429/eaccelerator.so\nReading symbols from /usr/local/php/lib/php/extensions/no-debug-non-zts-20020429/memcache.so...done.\nLoaded symbols for /usr/local/php/lib/php/extensions/no-debug-non-zts-20020429/memcache.so\nReading symbols from /usr/lib/gconv/GB18030.so...done.\nLoaded symbols for /usr/lib/gconv/GB18030.so\nReading symbols from /lib/libnss_dns.so.2...done.\nLoaded symbols for /lib/libnss_dns.so.2\n0x007d97a2 in _dl_sysinfo_int80 () from /lib/ld-linux.so.2\n(gdb) bt\n#0  0x007d97a2 in _dl_sysinfo_int80 () from /lib/ld-linux.so.2\n#1  0x001e6a9e in __lll_mutex_lock_wait () from /lib/tls/libc.so.6\n#2  0x0017800b in _L_mutex_lock_3769 () from /lib/tls/libc.so.6\n#3  0x085308ec in ?? ()\n#4  0xbfffed48 in ?? ()\n#5  0x0853be60 in ?? ()\n#6  0x085a4fdc in ?? ()\n#7  0x00993bb0 in eaccelerator_globals () from /usr/local/php/lib/php/extensions/no-debug-non-zts-20020429/eaccelerator.so\n#8  0xbfffed18 in ?? ()\n#9  0x0116c759 in _efree (ptr=0x853be60) at /home/dalamar/php-4.4.8/Zend/zend_alloc.c:280\n#10 0x0116c759 in _efree (ptr=0x853be6c) at /home/dalamar/php-4.4.8/Zend/zend_alloc.c:280\n#11 0x0117be0d in zend_hash_destroy (ht=0x853be60) at /home/dalamar/php-4.4.8/Zend/zend_hash.c:570\n#12 0x0097e94a in zm_deactivate_eaccelerator (type=1, module_number=25) at /home/dalamar/eaccelerator-0.9.5.3/eaccelerator.c:2170\n#13 0x0117a419 in module_registry_cleanup (module=0xfffffffc) at /home/dalamar/php-4.4.8/Zend/zend_API.c:1168\n#14 0x0117c0c0 in zend_hash_apply (ht=0x1329540, apply_func=0x117a3e8 <module_registry_cleanup>)\n    at /home/dalamar/php-4.4.8/Zend/zend_hash.c:708\n#15 0x01178152 in zend_deactivate_modules () at /home/dalamar/php-4.4.8/Zend/zend.c:678\n#16 0x01153a6a in php_request_shutdown (dummy=0x0) at /home/dalamar/php-4.4.8/main/main.c:990\n#17 0x01188e40 in php_handler (r=0x8479aa8) at /home/dalamar/php-4.4.8/sapi/apache2handler/sapi_apache2.c:598\n#18 0x0807d1f6 in ap_run_handler (r=0x8479aa8) at config.c:153\n#19 0x0807d6be in ap_invoke_handler (r=0x8479aa8) at config.c:364\n#20 0x0806cd63 in ap_process_request (r=0x8479aa8) at http_request.c:249\n#21 0x08068b95 in ap_process_http_connection (c=0x84718c8) at http_core.c:253\n#22 0x0808673e in ap_run_process_connection (c=0x84718c8) at connection.c:43\n#23 0x0807bd6f in child_main (child_num_arg=-4) at prefork.c:610\n#24 0x0807be8c in make_child (s=0x80c1868, slot=24) at prefork.c:704\n#25 0x0807c0d2 in perform_idle_server_maintenance (p=0x80b50a8) at prefork.c:839\n#26 0x0807c672 in ap_mpm_run (_pconf=0x3c, plog=0x80ed188, s=0x0) at prefork.c:1040\n#27 0x080818da in main (argc=3, argv=0xbffff924) at main.c:636\n(gdb) info thread\n  1 Thread -1207974208 (LWP 7439)  0x007d97a2 in _dl_sysinfo_int80 () from /lib/ld-linux.so.2\n(gdb) list\n636     main.c: No such file or directory.\n        in main.c\n(gdb) dir /home/dalamar/dalamar/httpd-2.0.63/server\nSource directories searched: /home/dalamar/dalamar/httpd-2.0.63/server:$cdir:$cwd\n(gdb) list\n636             if (ap_mpm_run(pconf, plog, server_conf))\n637                 break;\n638\n639             apr_pool_lock(pconf, 0);\n640         }\n641\n642         apr_pool_lock(pconf, 0);\n643         destroy_and_exit_process(process, 0);\n644\n645         return 0; /* Termination 'ok' */\n(gdb) q\nThe program is running.  Quit anyway (and detach it)? (y or n) y\nDetaching from program: /usr/local/apache/bin/httpd, process 7439"}, {"count": 1, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "text": "The backtrace shows that the process is hanging in PHP code. This is no httpd issue. Please open up the bug at http://bugs.php.net/.", "id": 126603, "time": "2009-04-29T00:17:15Z", "bug_id": 47114, "creation_time": "2009-04-29T00:17:15Z", "is_private": false}]