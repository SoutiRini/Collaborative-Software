[{"attachment_id": null, "tags": [], "bug_id": 40041, "is_private": false, "count": 0, "id": 91286, "time": "2006-07-13T19:33:24Z", "creator": "cognefou@hotmail.com", "creation_time": "2006-07-13T19:33:24Z", "text": "Hi,\n\nWe have many web servers and they are quite busy.  Just to get the idea, it's \nnot uncommon to see the size of access_log growing more over than 15 Gb per \nday.\n\nWe often change the configuration of virtual host and since we don't want to \nstop abruptly, we reload the httpd.conf by doing a graceful.\n\nSo, before going further about the issue we face every day, there is some \nlines \nof the configuration file (httpd.conf):\n\nLogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" %v\" \ncombined\nCustomLog \"|/path/apache/bin/rotatelogs /var/log/access_log.%Y%m%d-%H%M \n3600 -300\" combined\n\nWe want to rotate the logs every hour to avoid to have some files who exceeds \n1 GB in size.\n\nWhen we do a graceful, it seems that the 'rotatelogs' program is killed first.  \nThus, the httpd process can't write to the pipe and then stay stucked in the \nbackground indefinitely.  If we do 5-6 graceful in the same day, we can see \nmore than 1000 process who are stucked in the background.\n\nThere is the listing of httpd process provided by the command 'ps'.  take note \nthat today is 13 July 2006 and check the date on 12nd column and the state on \nthe 11nd column:\n\n[root@xxxxx home]# ps -efl |grep pipe_w |more\n5 S xxxxx    18511 18500  0  75   0    -  3477 pipe_w Jun05 ?        \n00:00:00 /xxxx/apache_1.3.34/bin/httpd\n5 S xxxxx    18563 18500  0  75   0    -  3477 pipe_w Jun05 ?        \n00:00:00 /xxxx/apache_1.3.34/bin/httpd\n5 S xxxxx    18597 18500  0  75   0    -  3477 pipe_w Jun05 ?        \n00:00:00 /xxxx/apache_1.3.34/bin/httpd\n5 S xxxxx    18843 18500  0  75   0    -  3477 pipe_w Jun05 ?        \n00:00:00 /xxxx/apache_1.3.34/bin/httpd\n5 S xxxxx    19657 18500  0  75   0    -  3477 pipe_w Jun05 ?        \n00:00:00 /xxxx/apache_1.3.34/bin/httpd\n5 S xxxxx    19664 18500  0  75   0    -  3477 pipe_w Jun05 ?        \n00:00:00 /xxxx/apache_1.3.34/bin/httpd\n5 S xxxxx    20426 18500  0  75   0    -  3477 pipe_w Jun05 ?        \n00:00:00 /xxxx/apache_1.3.34/bin/httpd\n5 S xxxxx    21355 18500  0  75   0    -  3477 pipe_w Jun05 ?        \n00:00:00 /xxxx/apache_1.3.34/bin/httpd\n5 S xxxxx    21377 18500  0  75   0    -  3477 pipe_w Jun05 ?        \n00:00:00 /xxxx/apache_1.3.34/bin/httpd\n[...]\n\nWe used 'strace' command on a stucked httpd process (pid: 21377 as showed \nabove):\n\n[root@xxxx home]# strace -f -v -s2000 -p 21377\nProcess 21377 attached - interrupt to quit\nwrite(8, \"xxx.xx.xx.xx - - [05/Jun/2006:15:45:19 -0400] \n\\\"POST /xxxxx/xxxxxx/xxxxx HTTP/1.1\\\" 200 0 \\\"http://xx.xx.xx.xx/xxxx/xxxx\\\" \n\\\"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)\\\" xxx.xxx.xxx\\n\", \n209 <unfinished ...>\nProcess 21377 detached\n[root@xxxx home]#\n\nWhen we used strace, it's stop there and does nothing.  It's clear that the \nhttpd process is waiting the other end of the pipe to accept his log.\n\nSee the difference of the pipe address bewteen the parent (pid: 18500) and \nthis child (pid: 21377):\n\nPARENT PROCESS:\n---------------\n[root@xxxxx home]# cd /proc/18500/fd\n[root@xxxxx fd]# ls -l |grep pipe\nlr-x------    1 root     root           64 Jul 13 15:23 7 -> pipe:[4210641028]\nl-wx------    1 root     root           64 Jul 13 15:23 8 -> pipe:[4210641028]\n\nCHILD PROCESS:\n--------------\n[root@xxxxx home]# cd /proc/21377/fd\n[root@xxxxx fd]# ls -l |grep pipe\nlr-x------    1 root     root           64 Jul 13 15:23 7 -> pipe:[3562989264]\nl-wx------    1 root     root           64 Jul 13 15:23 8 -> pipe:[3562989264]\n\nWe think that there is a bad timing between the mod_log and the pipe of the \nrotatelogs when we do a graceful.  It seems that the rotatelogs is killed \nfirst and the httpd (the child) seems doesn't handle this well.\n\nOur quick and dirty fix is to do a ps with a grep to kill those child process \nwho are hanging for a long time.\n\nThank you"}, {"count": 1, "tags": [], "creator": "cognefou@hotmail.com", "attachment_id": null, "text": "*** Bug 40040 has been marked as a duplicate of this bug. ***", "id": 91288, "time": "2006-07-13T19:35:46Z", "bug_id": 40041, "creation_time": "2006-07-13T19:35:46Z", "is_private": false}, {"count": 2, "tags": [], "creator": "jorton@redhat.com", "text": "This is fixed in 2.0.55 and later, see Jeff's comment for a 1.3.x patch.\n\n*** This bug has been marked as a duplicate of 26467 ***", "id": 91305, "time": "2006-07-14T08:35:13Z", "bug_id": 40041, "creation_time": "2006-07-14T08:35:13Z", "is_private": false, "attachment_id": null}]