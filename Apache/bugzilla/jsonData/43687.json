[{"count": 0, "tags": [], "text": "Steps to replicate problem:\n\n   1) clear firefox cache\n   2) load url \"http://localhost:8080/aaa/index.html\"\n   3) fill in auth form\n   4) on index.html page click logout link to logout.jsp (invalidate session and\nredirect to index.html)\n   5) fill in auth form\n   6) you will get form page again (!)\n   7) click \"reload\" button\n   8) you will get index.html\n\n\nConversation with server:\n\nfirefox:  GET /aaa/index.html HTTP/1.1\n tomcat:  HTTP/1.1 200 OK\n          ETag: W/\"478-1193216820000\"\n          Last-Modified: Wed, 24 Oct 2007 09:07:00 GMT\n\n          <page with login form>\n\nfirefox:  POST /aaa/j_security_check HTTP/1.1\n tomcat:  HTTP/1.1 302 Moved Temporarily\n          Location: http://localhost:8080/aaa/index.html\n\nfirefox:  GET /aaa/index.html HTTP/1.1\n          If-Modified-Since: Wed, 24 Oct 2007 09:07:00 GMT\n          If-None-Match: W/\"478-1193216820000\"\n tomcat:  HTTP/1.1 200 OK\n          ETag: W/\"316-1193222364000\"\n          Last-Modified: Wed, 24 Oct 2007 10:39:24 GMT\n          \n          <page with protected content -- index.html>\n\nfirefox:  GET /aaa/logout.jsp HTTP/1.1\n tomcat:  HTTP/1.1 302 Moved Temporarily\n          Location: http://localhost:8080/aaa/index.html\n\nfirefox:  GET /aaa/index.html HTTP/1.1\n          If-Modified-Since: Wed, 24 Oct 2007 10:39:24 GMT\n          If-None-Match: W/\"316-1193222364000\"\n tomcat:  HTTP/1.1 200 OK\n          ETag: W/\"478-1193216820000\"\n          Last-Modified: Wed, 24 Oct 2007 09:07:00 GMT\n          <page with login form>\n\nfirefox:  POST /aaa/j_security_check HTTP/1.1\n tomcat:  HTTP/1.1 302 Moved Temporarily\n          Location: http://localhost:8080/aaa/index.html\n\nfirefox:  GET /aaa/index.html HTTP/1.1\n          If-Modified-Since: Wed, 24 Oct 2007 09:07:00 GMT\n          If-None-Match: W/\"478-1193216820000\"\n tomcat:  HTTP/1.1 304 Not Modified\n          ETag: W/\"316-1193222364000\"\n\nfirefox:  GET /aaa/index.html HTTP/1.1\n          If-Modified-Since: Wed, 24 Oct 2007 09:07:00 GMT\n          If-None-Match: W/\"478-1193216820000\"\n          Cache-Control: max-age=0\n tomcat:  HTTP/1.1 200 OK\n          ETag: W/\"316-1193222364000\"\n          Last-Modified: Wed, 24 Oct 2007 10:39:24 GMT\n\n          <page with protected content -- index.html>", "is_private": false, "bug_id": 43687, "id": 109688, "time": "2007-10-24T03:58:50Z", "creator": "przemyslaw.madzik@assecobs.pl", "creation_time": "2007-10-24T03:58:50Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 43687, "attachment_id": 21032, "text": "Created attachment 21032\nweb app with form-based authentication\n\nwar to reproduce described behaviour", "id": 109689, "time": "2007-10-24T04:01:37Z", "creator": "przemyslaw.madzik@assecobs.pl", "creation_time": "2007-10-24T04:01:37Z", "is_private": false}, {"count": 2, "text": "Comment on attachment 21032\nweb app with form-based authentication\n\nwar to reproduce described behaviour.\n\nYou need also configured user with role \"aaa\". It is my\n$CATALINA_HOME/conf/tomcat-users.xml:\n<?xml version='1.0' encoding='utf-8'?>\t\t\t\t\t        \n<tomcat-users>\t\t\t\t\t\t\t\t        \n  <role rolename=\"aaa\"/>\t\t\t\t\t\t        \n  <user username=\"aaa\" password=\"aaa\" roles=\"aaa\"/>\t\t\t        \n</tomcat-users>", "bug_id": 43687, "attachment_id": 21032, "id": 109690, "time": "2007-10-24T04:09:02Z", "creator": "przemyslaw.madzik@assecobs.pl", "creation_time": "2007-10-24T04:09:02Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 43687, "attachment_id": null, "is_private": false, "id": 109726, "time": "2007-10-25T00:43:57Z", "creator": "przemyslaw.madzik@assecobs.pl", "creation_time": "2007-10-25T00:43:57Z", "text": "After looking a bit into source i found (FormAuthenticator.java) save/restore\nmechanism for requests done before/after authentication. I don't understand\nneeds for it, particularly for save/restore ALL request headers. IMHO restoring\nheaders like \"If-None-Match\" is incorrect.\n\nAfter commenting out lines  (403-412) which serve to restore request headers\nproblem not occurs."}, {"attachment_id": 21046, "tags": [], "bug_id": 43687, "text": "Created attachment 21046\nPatch so that complient browsers don't think the login page is the real page\n\nTomcat needs to replay the original request exactly to have any hope of\nworking.  This patch, against 6.0 trunk, should prevent any modern browser\nconfusing the login page with the actual resource that it requested.", "count": 4, "id": 109759, "time": "2007-10-25T19:20:51Z", "creator": "william.barker@wilshire.com", "creation_time": "2007-10-25T19:20:51Z", "is_private": false}, {"count": 5, "tags": [], "creator": "william.barker@wilshire.com", "text": "(In reply to comment #4)\n> Created an attachment (id=21046) [edit]\n> Patch so that complient browsers don't think the login page is the real page\n> Tomcat needs to replay the original request exactly to have any hope of\n> working.  This patch, against 6.0 trunk, should prevent any modern browser\n> confusing the login page with the actual resource that it requested.\n\nOk, so I'm having a brain-dead moment (seem to be pretty common around \nhere :).  This patch should do nothing at all, and it is a FireFox bug that \nyou are looking at (it shouldn't be sending 'if-modified-since' and 'if-none-\nmatch' headers, since it was already told that the page is uncachable).", "id": 109761, "time": "2007-10-25T19:31:21Z", "bug_id": 43687, "creation_time": "2007-10-25T19:31:21Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 43687, "attachment_id": null, "is_private": false, "id": 109851, "time": "2007-10-29T00:47:40Z", "creator": "przemyslaw.madzik@assecobs.pl", "creation_time": "2007-10-29T00:47:40Z", "text": "(In reply to comment #5)\n> Ok, so I'm having a brain-dead moment (seem to be pretty common around \n> here :).  This patch should do nothing at all, and it is a FireFox bug that \n> you are looking at (it shouldn't be sending 'if-modified-since' and 'if-none-\n> match' headers, since it was already told that the page is uncachable).\n\nIMHO it isn't firefox bug. RFC2616 (14.9.1 What is Cacheable) about\n\"Cache-control: no-cache\" says:\n\n    If the no-cache directive does not specify a field-name, then a\n    cache MUST NOT use the response to satisfy a subsequent request\n    without successful revalidation with the origin server. This\n    allows an origin server to prevent caching even by caches that\n    have been configured to return stale responses to client requests.\n\nSo because tomcat sends for static resources \"ETag\" and \"Last-Modified\"\nheaders it allow to make REVALIDATION by firefox.\n"}, {"count": 7, "tags": [], "bug_id": 43687, "attachment_id": 21057, "is_private": false, "id": 109932, "time": "2007-10-29T19:34:55Z", "creator": "william.barker@wilshire.com", "creation_time": "2007-10-29T19:34:55Z", "text": "Created attachment 21057\nAttempt to get around FireFox's aggressive caching\n\nFrom my reading of RFC 2616, this should work, since FF won't attempt to\nrevalidate a page that it doesn't have in it's cache.  If it doesn't work, than\nI consider it an FF bug (since the login page isn't in it's cache from 2616)."}, {"attachment_id": null, "tags": [], "creator": "przemyslaw.madzik@assecobs.pl", "text": "(In reply to comment #7)\n> From my reading of RFC 2616, this should work, since FF won't attempt to\n> revalidate a page that it doesn't have in it's cache.  If it doesn't work, than\n> I consider it an FF bug (since the login page isn't in it's cache from 2616).\n\nIMHO acording to RFC2616 (14.9.2) \"Cache-control: no-store\" header not clearly\nforbids caching response in VOLATILE storage such as memory.\n\nMy understanding RFC2616 is following: to make response uncachable one should\nsend \"Cache-control: no-cache\" and NOT send headers used for revalidation such\n\"Etag\" and \"Last-Modified\".\n\nBut the problem is IMHO in save/restore mechanism.\n", "count": 8, "id": 109942, "time": "2007-10-30T02:28:15Z", "bug_id": 43687, "creation_time": "2007-10-30T02:28:15Z", "is_private": false}, {"count": 9, "tags": [], "text": "Created attachment 21063\nPatch to disable conditionals headers on a replay for Form Auth\n\nOk, I'm convinced that it needs to be done in the replay.  \n\nIf you are able to actually try out this patch, and post here, it will probably\nspeed up getting it into the 6.0 tree.", "is_private": false, "bug_id": 43687, "id": 109995, "time": "2007-10-30T20:11:47Z", "creator": "william.barker@wilshire.com", "creation_time": "2007-10-30T20:11:47Z", "attachment_id": 21063}, {"attachment_id": null, "tags": [], "creator": "przemyslaw.madzik@assecobs.pl", "text": "(In reply to comment #9)\n> If you are able to actually try out this patch, and post here, it will probably\n> speed up getting it into the 6.0 tree.\n\nPatch is working for me. Thanks.", "count": 10, "id": 110074, "time": "2007-10-31T12:39:45Z", "bug_id": 43687, "creation_time": "2007-10-31T12:39:45Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 43687, "attachment_id": null, "text": "The patch has now been committed to SVN, and will appear in the next version \nof TC 6.x.", "id": 111230, "time": "2007-11-28T20:30:10Z", "creator": "william.barker@wilshire.com", "creation_time": "2007-11-28T20:30:10Z", "is_private": false}]