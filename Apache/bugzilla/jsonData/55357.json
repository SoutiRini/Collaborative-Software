[{"count": 0, "tags": [], "bug_id": 55357, "attachment_id": null, "text": "I'm using PersistentManager with JDBCStore to store sessions in my database. But in my webapplication, there is an object in my session which is an instance of org.apache.el.MethodExpressionImpl. This class implements the Externalizable interface but in this readExternal method it uses org.apache.el.util.ReflectionUtil.forName(String) which use Thread.currentThread().getContextClassLoader() as its ClassLoader.\n\nIt seems to be incorrect because this method return a StandardClassLoader which cannot find my classes in WEB-INF/lib directory of my webapp.\n\nIs it the problem of the MethodExpressionImpl class which use this method or the JDBCStore which does not set the thread contextClassLoader as the WebappClassLoader ?\n\nHere is the stacktrace :\n\nSEVERE: Error processing request\njava.lang.IllegalStateException: Erreur lors de la d\u00e9s\u00e9rialisation de la session 1634C328D27A31CB9FC4D52392FDB05F: {1}\n\tat org.apache.catalina.session.PersistentManagerBase.swapIn(PersistentManagerBase.java:713)\n\tat org.apache.catalina.session.PersistentManagerBase.findSession(PersistentManagerBase.java:503)\n\tat org.apache.catalina.connector.Request.isRequestedSessionIdValid(Request.java:2391)\n\tat org.apache.catalina.connector.CoyoteAdapter.parseSessionCookiesId(CoyoteAdapter.java:954)\n\tat org.apache.catalina.connector.CoyoteAdapter.postParseRequest(CoyoteAdapter.java:688)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:402)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1002)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:585)\n\tat org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:312)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:722)\nCaused by: java.lang.ClassNotFoundException: javax.faces.event.ActionEvent\n\tat java.net.URLClassLoader$1.run(URLClassLoader.java:366)\n\tat java.net.URLClassLoader$1.run(URLClassLoader.java:355)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat java.net.URLClassLoader.findClass(URLClassLoader.java:354)\n\tat java.lang.ClassLoader.loadClass(ClassLoader.java:423)\n\tat java.lang.ClassLoader.loadClass(ClassLoader.java:356)\n\tat java.lang.Class.forName0(Native Method)\n\tat java.lang.Class.forName(Class.java:266)\n\tat org.apache.el.util.ReflectionUtil.forName(ReflectionUtil.java:62)\n\tat org.apache.el.util.ReflectionUtil.toTypeArray(ReflectionUtil.java:88)\n\tat org.apache.el.MethodExpressionImpl.readExternal(MethodExpressionImpl.java:290)\n\tat java.io.ObjectInputStream.readExternalData(ObjectInputStream.java:1835)\n\tat java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1794)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1348)\n\tat java.io.ObjectInputStream.readObject(ObjectInputStream.java:370)\n\tat com.sun.facelets.el.TagMethodExpression.readExternal(TagMethodExpression.java:101)\n\tat java.io.ObjectInputStream.readExternalData(ObjectInputStream.java:1835)\n\tat java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1794)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1348)\n\tat java.io.ObjectInputStream.readArray(ObjectInputStream.java:1704)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1342)\n\tat java.io.ObjectInputStream.defaultReadFields(ObjectInputStream.java:1989)\n\tat java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:1913)\n\tat java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1796)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1348)\n\tat java.io.ObjectInputStream.readObject(ObjectInputStream.java:370)\n\tat java.util.ArrayList.readObject(ArrayList.java:733)\n\tat sun.reflect.GeneratedMethodAccessor90.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:601)\n\tat java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:1004)\n\tat java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:1891)\n\tat java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1796)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1348)\n\tat java.io.ObjectInputStream.readArray(ObjectInputStream.java:1704)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1342)\n\tat java.io.ObjectInputStream.readArray(ObjectInputStream.java:1704)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1342)\n\tat java.io.ObjectInputStream.readArray(ObjectInputStream.java:1704)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1342)\n\tat java.io.ObjectInputStream.readArray(ObjectInputStream.java:1704)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1342)\n\tat java.io.ObjectInputStream.readArray(ObjectInputStream.java:1704)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1342)\n\tat java.io.ObjectInputStream.readArray(ObjectInputStream.java:1704)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1342)\n\tat java.io.ObjectInputStream.readArray(ObjectInputStream.java:1704)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1342)\n\tat java.io.ObjectInputStream.readArray(ObjectInputStream.java:1704)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1342)\n\tat java.io.ObjectInputStream.readArray(ObjectInputStream.java:1704)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1342)\n\tat java.io.ObjectInputStream.readArray(ObjectInputStream.java:1704)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1342)\n\tat java.io.ObjectInputStream.readArray(ObjectInputStream.java:1704)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1342)\n\tat java.io.ObjectInputStream.readArray(ObjectInputStream.java:1704)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1342)\n\tat java.io.ObjectInputStream.readArray(ObjectInputStream.java:1704)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1342)\n\tat java.io.ObjectInputStream.defaultReadFields(ObjectInputStream.java:1989)\n\tat java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:1913)\n\tat java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1796)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1348)\n\tat java.io.ObjectInputStream.readObject(ObjectInputStream.java:370)\n\tat java.util.HashMap.readObject(HashMap.java:1155)\n\tat sun.reflect.GeneratedMethodAccessor89.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:601)\n\tat java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:1004)\n\tat java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:1891)\n\tat java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1796)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1348)\n\tat java.io.ObjectInputStream.readObject(ObjectInputStream.java:370)\n\tat java.util.HashMap.readObject(HashMap.java:1155)\n\tat sun.reflect.GeneratedMethodAccessor89.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:601)\n\tat java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:1004)\n\tat java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:1891)\n\tat java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1796)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1348)\n\tat java.io.ObjectInputStream.defaultReadFields(ObjectInputStream.java:1989)\n\tat java.io.ObjectInputStream.defaultReadObject(ObjectInputStream.java:499)\n\tat org.ajax4jsf.application.AjaxStateHolder.readObject(AjaxStateHolder.java:204)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:601)\n\tat java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:1004)\n\tat java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:1891)\n\tat java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1796)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1348)\n\tat java.io.ObjectInputStream.readObject(ObjectInputStream.java:370)\n\tat org.apache.catalina.session.StandardSession.readObject(StandardSession.java:1595)\n\tat org.apache.catalina.session.StandardSession.readObjectData(StandardSession.java:1060)\n\tat org.apache.catalina.session.JDBCStore.load(JDBCStore.java:657)\n\tat org.apache.catalina.session.PersistentManagerBase.swapIn(PersistentManagerBase.java:707)\n\t... 11 more", "id": 169134, "time": "2013-08-05T15:15:18Z", "creator": "maxime.falaize@gmail.com", "creation_time": "2013-08-05T15:15:18Z", "is_private": false}, {"count": 1, "tags": [], "creator": "maxime.falaize@gmail.com", "attachment_id": null, "id": 169229, "time": "2013-08-07T12:02:45Z", "bug_id": 55357, "creation_time": "2013-08-07T12:02:45Z", "is_private": false, "text": "My workaround to make it working is to add Thread.currentThread().setContextClassLoader(classLoader) in the JDBCStore (between line 644 and 645 in method load(String):Session) :\n\nif (classLoader != null)\n   Thread.currentThread().setContextClassLoader(classLoader);\n   ois = new CustomObjectInputStream(bis, classLoader);\n} else {\n   ois = new ObjectInputStream(bis);\n}\n\nMaybe add a try catch to catch the SecurityException thrown by the setContextClassLoader method."}, {"count": 2, "tags": [], "creator": "violetagg@apache.org", "text": "Thanks for the report.\nFixed in trunk and 7.0.x and will be included in 7.0.43 onwards.", "id": 169470, "time": "2013-08-15T19:47:30Z", "bug_id": 55357, "creation_time": "2013-08-15T19:47:30Z", "is_private": false, "attachment_id": null}]