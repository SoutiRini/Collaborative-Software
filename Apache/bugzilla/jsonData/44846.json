[{"count": 0, "tags": [], "bug_id": 44846, "attachment_id": null, "id": 115744, "time": "2008-04-21T08:27:54Z", "creator": "justinbeech@gmail.com", "creation_time": "2008-04-21T08:27:54Z", "is_private": false, "text": "While testing event MPM, using ab on another machine, if I pick\n-c NNN (concurrency) greater than MaxClients, then although the\nbenchmark finishes reasonably, dangling CLOSE_WAIT connections\nare left with Recv-Q data pointing to the httpd parent process.\n\nRepeating the same highly concurrent ab a few more times causes\nthe CLOSE_WAIT connections to accumulate further until eventually\nthere are so many that httpd is no longer reachable at all.\n\nWhen reaches this state, even after many minutes (or longer?)\nit remains unreachable.. it must be killed (which ages the\nCLOSE_WAITS very quickly) and restarted.\n\nWith lower concurrency the decay in performance to unreachability\nis much longer but still present, and CLOSE_WAITs still \naccumulate roughly in proportion to how slow the server gets.\n\n<IfModule event.c>\nListenBackLog      32\nStartServers        10\nThreadLimit        50\nThreadsPerChild    50\nMinSpareThreads    100\nMaxSpareThreads    1000\nThreadsPerChild    50\nMaxClients         500\nMaxRequestsPerChild  0\n</IfModule> \n\nKeepAlive is off.\n\nInitial ab:\n\n/ab -c 1000 -n 5000 http://192.168.1.1/server-status\nThis is ApacheBench, Version 2.0.41-dev <$Revision: 1.121.2.12 $> apache-2.0\nCopyright (c) 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/\nCopyright (c) 1998-2002 The Apache Software Foundation, http://www.apache.org/\n\nBenchmarking 192.168.1.1 (be patient)\nCompleted 500 requests\nCompleted 1000 requests\nCompleted 1500 requests\nCompleted 2000 requests\nCompleted 2500 requests\nCompleted 3000 requests\nCompleted 3500 requests\nCompleted 4000 requests\nCompleted 4500 requests\nFinished 5000 requests\n\n\nServer Software:        Apache\nServer Hostname:        192.168.1.1\nServer Port:            80\n\nDocument Path:          /server-status\nDocument Length:        215 bytes\n\nConcurrency Level:      1000\nTime taken for tests:   0.977488 seconds\nComplete requests:      5000\nFailed requests:        0\nWrite errors:           0\nNon-2xx responses:      5014\nTotal transferred:      1900306 bytes\nHTML transferred:       1078010 bytes\nRequests per second:    5115.15 [#/sec] (mean)\nTime per request:       195.498 [ms] (mean)\nTime per request:       0.195 [ms] (mean, across all concurrent requests)\nTransfer rate:          1897.72 [Kbytes/sec] received\n\nConnection Times (ms)\n              min  mean[+/-sd] median   max\nConnect:        0   15  10.7     13      41\nProcessing:     4   67 122.3     21     684\nWaiting:        2   64 122.5     18     682\nTotal:          6   83 127.4     34     723\n\nPercentage of the requests served within a certain time (ms)\n  50%     34\n  66%     45\n  75%     65\n  80%     83\n  90%    257\n  95%    279\n  98%    676\n  99%    680\n 100%    723 (longest request)\n\nSubsequent abs get lower and lower RPS ..\n\n./ab -c 1000 -n 10000 http://192.168.1.1/\nThis is ApacheBench, Version 2.0.41-dev <$Revision: 1.121.2.12 $> apache-2.0\nCopyright (c) 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/\nCopyright (c) 1998-2002 The Apache Software Foundation, http://www.apache.org/\n\nBenchmarking 192.168.1.1 (be patient)\nCompleted 1000 requests\nCompleted 2000 requests\nCompleted 3000 requests\nCompleted 4000 requests\nCompleted 5000 requests\nCompleted 6000 requests\nCompleted 7000 requests\nCompleted 8000 requests\nCompleted 9000 requests\nFinished 10000 requests\n\n\nServer Software:        Apache\nServer Hostname:        192.168.1.1\nServer Port:            80\n\nDocument Path:          /front/xxx\nDocument Length:        0 bytes\n\nConcurrency Level:      1000\nTime taken for tests:   17.232351 seconds\nComplete requests:      10000\nFailed requests:        0\nWrite errors:           0\nTotal transferred:      2370474 bytes\nHTML transferred:       0 bytes\nRequests per second:    580.30 [#/sec] (mean)\nTime per request:       1723.235 [ms] (mean)\nTime per request:       1.723 [ms] (mean, across all concurrent requests)\nTransfer rate:          134.28 [Kbytes/sec] received\n\nConnection Times (ms)\n              min  mean[+/-sd] median   max\nConnect:        0   84 745.6      1    9023\nProcessing:    13  162 830.0     24   14539\nWaiting:       11  160 830.0     22   14538\nTotal:         14  246 1150.7     25   16639\n\nPercentage of the requests served within a certain time (ms)\n  50%     25\n  66%     30\n  75%     41\n  80%     52\n  90%    140\n  95%    669\n  98%   3271\n  99%   6669\n 100%  16639 (longest request)\n\nUntil telnet ab or lynx just hang on the port.\n\nAnd from netstat:\n\nnetstat -nap|grep CLOSE_WAIT | grep 192.168.1.1:80| more\ntcp       96      0 192.168.1.1:80          192.168.1.30:49689      CLOSE_WAIT  -                   \ntcp       96      0 192.168.1.1:80          192.168.1.30:57625      CLOSE_WAIT  -                   \ntcp       96      0 192.168.1.1:80          192.168.1.30:37144      CLOSE_WAIT  31414/httpd         \ntcp       96      0 192.168.1.1:80          192.168.1.30:57111      CLOSE_WAIT  -                   \ntcp       96      0 192.168.1.1:80          192.168.1.30:37143      CLOSE_WAIT  31414/httpd         \ntcp       96      0 192.168.1.1:80          192.168.1.30:57110      CLOSE_WAIT  -                   \ntcp       96      0 192.168.1.1:80          192.168.1.30:37142      CLOSE_WAIT  31414/httpd         \ntcp       96      0 192.168.1.1:80          192.168.1.30:51989      CLOSE_WAIT  -                   \ntcp       96      0 192.168.1.1:80          192.168.1.30:37141      CLOSE_WAIT  31532/httpd         \ntcp       96      0 192.168.1.1:80          192.168.1.30:37141      CLOSE_WAIT  31532/httpd         \ntcp       96      0 192.168.1.1:80          192.168.1.30:51988      CLOSE_WAIT  -                   \ntcp       96      0 192.168.1.1:80          192.168.1.30:37140      CLOSE_WAIT  31532/httpd         \ntcp       96      0 192.168.1.1:80          192.168.1.30:37138      CLOSE_WAIT  31532/httpd         \ntcp       96      0 192.168.1.1:80          192.168.1.30:37137      CLOSE_WAIT  31532/httpd         \ntcp       96      0 192.168.1.1:80          192.168.1.30:37138      CLOSE_WAIT  31532/httpd         \ntcp       96      0 192.168.1.1:80          192.168.1.30:37137      CLOSE_WAIT  31532/httpd         \ntcp       96      0 192.168.1.1:80          192.168.1.30:37136      CLOSE_WAIT  31532/httpd         \ntcp       96      0 192.168.1.1:80          192.168.1.30:37135      CLOSE_WAIT  31532/httpd         \ntcp       96      0 192.168.1.1:80          192.168.1.30:37134      CLOSE_WAIT  31532/httpd         \ntcp       96      0 192.168.1.1:80          192.168.1.30:37133      CLOSE_WAIT  31532/httpd         \ntcp       96      0 192.168.1.1:80          192.168.1.30:37132      CLOSE_WAIT  31532/httpd         \ntcp       96      0 192.168.1.1:80          192.168.1.30:54283      CLOSE_WAIT  31469/httpd         \ntcp       96      0 192.168.1.1:80          192.168.1.30:37131      CLOSE_WAIT  31532/httpd         \ntcp       96      0 192.168.1.1:80          192.168.1.30:37130      CLOSE_WAIT  31532/httpd         \n\n(etc)\n\nNotice there are even some older entries from past runs where the server was killed and restarted..\n\nthe kernel is 2.6.11 for this test, using epoll"}, {"count": 1, "tags": [], "creator": "justinbeech@gmail.com", "is_private": false, "text": "Experimenting on another box with a slightly later kernel, and much more recent pthreads and gcc library, I *cannot* reproduce the problem.\n\nSo I'm guessing that this stability issue is with MPM-Event and older versions of NPTL threads (or older version of gcc).\n\na box with:\n\ngetconf GNU_LIBPTHREAD_VERSION\nNPTL 0.26\nand gcc 3.2.2\n\nshows the problem\nbut \n\ngetconf GNU_LIBPTHREAD_VERSION\nNPTL 2.4\nand gcc 4.1.1 \n\ndoes not", "id": 115759, "time": "2008-04-21T18:04:21Z", "bug_id": 44846, "creation_time": "2008-04-21T18:04:21Z", "attachment_id": null}]