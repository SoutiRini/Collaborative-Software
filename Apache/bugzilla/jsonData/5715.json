[{"count": 0, "tags": [], "bug_id": 5715, "attachment_id": null, "is_private": false, "id": 9398, "time": "2002-01-07T04:16:57Z", "creator": "serg_main@yahoo.com", "creation_time": "2002-01-07T04:16:57Z", "text": "response.setContentType() in Filter.doFilter() not changed content type"}, {"count": 1, "tags": [], "bug_id": 5715, "is_private": false, "text": "If you're using this before the response is committed, then it should work. It\nprobably won't do any good to set it after calling doFilter (but that depends on\nwhat your servlet is doing).", "id": 10614, "time": "2002-02-12T23:24:22Z", "creator": "remm@apache.org", "creation_time": "2002-02-12T23:24:22Z", "attachment_id": null}, {"text": "Currently, when a JSP is compiled to java code, it includes a line such as:\n\n  response.setContentType(\"text/html;charset=ISO-8859-1\");\n\nHowever, this seems to preclude setting the content type in a servlet filter, as\nanything that is set in the filter is over-ridden by the JSP.  Eg, with our\nproduct JIRA - we must cater for many different character sets, and so we can't\nhard-code the characterset in the header of the JSP, and must set it at runtime.\n\nTo do so, we use a filter that does this:\n\n  servletRequest.setCharacterEncoding(\"UTF-8\");\n  servletResponse.setContentType(\"text/html;charset=UTF-8\");\n\nWhich works fine on Orion and Resin.  But fails on Tomcat and Jetty (presumably\nbecause they share the same JSP compilation engine).\n\nYou can't set it after the JSP has been called, because by then the response has\nbeen committed, and you can't set headers after that time.\n\nAny ideas on how to fix it?  Could you make setContentType immutable? So only\nallow it to be set once?  Else change the JSP compiler so that it checks if\ncontentType has already been set before setting it?\n\nThis prevents JIRA running on Tomcat with configurable charactersets, and\npresumably other applications are in the same position.\n\nScott\n-- \nATLASSIAN - http://www.atlassian.com\nExpert J2EE Software, Services and Support\n-------------------------------------------------------\nNeed a simple, powerful way to track and manage issues?\nTry JIRA - http://www.atlassian.com/software/jira", "tags": [], "bug_id": 5715, "attachment_id": null, "count": 2, "id": 25511, "time": "2002-11-02T18:24:32Z", "creator": "scott@atlassian.com", "creation_time": "2002-11-02T18:24:32Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 5715, "attachment_id": null, "id": 25611, "time": "2002-11-04T14:15:27Z", "creator": "scott@atlassian.com", "creation_time": "2002-11-04T14:15:27Z", "is_private": false, "text": "A possible fix for this:\n\n1)  If you are using a filter, wrap your response in a response wrapper that\ndoes not allow the content-type to be set by the page.  The code for this is:\n\nThe following filter works:\n\n/**\n * @author <a href=\"mailto:scott@atlassian.com\">Scott Farquhar</a>\n */\npublic class EncodingFilter implements Filter\n{\n\n    public void destroy()\n    {\n    }\n\n    public void doFilter(ServletRequest servletRequest, ServletResponse\nservletResponse, FilterChain filterChain) throws IOException, ServletException\n    {\n        servletRequest.setCharacterEncoding(\"UTF-8\");\n        servletResponse.setContentType(\"text/html;charset=UTF-8\");\n\n        filterChain.doFilter(servletRequest,\n                new HttpServletResponseWrapper((HttpServletResponse)\nservletResponse)\n                {\n                    public void setContentType(String s)\n                    {\n                        System.out.println(\"EncodingFilter.setContentType \" + s);\n                        new Throwable().printStackTrace();\n                        if (s.length() > \"text/html\".length() && s.charAt(0) ==\n't' && s.startsWith(\"text/html\"))\n                        {\n                            //do nothing.  This call could be trying to set the\ncharset to another charset.\n                            //This is the case with Tomcat & Jetty, whose JSP\ncompiler sets the charset, whether it\n                            //is specified in the JSP page or not.\n\n                            //NB - this can also be accomplished by setting the\ncharset manually in the JSP page & the decorator,\n                            //but this approach allows for run-time flexibility\nof choosing the charsets.\n\n                            //And besides, this is the way that we do it in\nJIRA, and I want to test this against different\n                            //servers\n                        }\n                        else\n                        {\n                            super.setContentType(s);\n                        }\n                    }\n\n                });\n        System.out.println(\"servletResponse.getCharacterEncoding() = \" +\nservletResponse.getCharacterEncoding());\n    }\n\n    public void init(FilterConfig filterConfig) throws ServletException\n    {\n    }\n\n}"}, {"count": 4, "tags": [], "bug_id": 5715, "is_private": false, "id": 51863, "creation_time": "2004-02-07T14:28:36Z", "time": "2004-02-07T14:28:36Z", "creator": "funkman@joedog.org", "text": "The Filter is setting the content type, but then the JSP is next in the pipeline\nand then sets the content type overriding what was set by the filter.", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 5715, "attachment_id": null, "id": 51879, "creation_time": "2004-02-07T15:04:34Z", "time": "2004-02-07T15:04:34Z", "creator": "funkman@joedog.org", "text": "*** Bug 11197 has been marked as a duplicate of this bug. ***", "is_private": false}]