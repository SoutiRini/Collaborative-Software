[{"count": 0, "tags": [], "bug_id": 49632, "attachment_id": null, "id": 138613, "time": "2010-07-21T15:03:56Z", "creator": "tmclaugh@sdf.lonestar.org", "creation_time": "2010-07-21T15:03:56Z", "is_private": false, "text": "When mod_authnz_ldap is setup to search for a user at the root of an AD domain it will fail the user because of the referrals returned in the search.\n\n--- config ---\n<Location /private>\n#  SSLRequireSSL\n  AuthType              Kerberos\n  AuthName              \"EXAMPLE Domain Login\"\n  KrbMethodNegotiate    On\n  KrbMethodK5Passwd     On\n  KrbAuthRealms         EXAMPLE.COM\n  Krb5KeyTab            /etc/httpd/conf/keytab\n  require valid-user\n\n  # Strip the realm from the kerberos principle.\n  MapUsernameRule (.*)@(.*) \"$1\"\n\n  AuthLDAPURL           \"ldap://dc1.example.com dc2.example.com/dc=example,dc=com?sAMAccountName\"\n  AuthLDAPBindDN        cn=nss_ldap,ou=services,dc=example,dc=com\n  AuthLDAPBindPassword  ********\n  Require ldap-group    cn=Domain Admins,ou=Groups,dc=example,dc=com\n</Location>\n---\n\n--- error_log ---\n[Wed Jul 21 14:40:34 2010] [debug] src/mod_auth_kerb.c(1432): [client 172.30.235.107] kerb_authenticate_user entered with user (NULL) and auth_type Kerberos\n[Wed Jul 21 14:40:34 2010] [debug] src/mod_auth_kerb.c(915): [client 172.30.235.107] Using HTTP/corptech.meditech.com@MEDITECH.COM as server principal for password verification\n[Wed Jul 21 14:40:34 2010] [debug] src/mod_auth_kerb.c(655): [client 172.30.235.107] Trying to get TGT for user tmclaughlin@MEDITECH.COM\n[Wed Jul 21 14:40:34 2010] [debug] src/mod_auth_kerb.c(569): [client 172.30.235.107] Trying to verify authenticity of KDC using principal HTTP/corptech.meditech.com@MEDITECH.COM\n[Wed Jul 21 14:40:34 2010] [debug] src/mod_auth_kerb.c(994): [client 172.30.235.107] kerb_authenticate_user_krb5pwd ret=0 user=tmclaughlin@MEDITECH.COM authtype=Basic\n[Wed Jul 21 14:40:34 2010] [info] [client 172.30.235.107] Applying pattern '^(.*)@(.*)$' to user 'tmclaughlin@MEDITECH.COM', mech:'Any'\n[Wed Jul 21 14:40:34 2010] [info] [client 172.30.235.107] Pattern matched\n[Wed Jul 21 14:40:34 2010] [notice] [client 172.30.235.107] User name 'tmclaughlin@MEDITECH.COM' rewritten to 'tmclaughlin'\n[Wed Jul 21 14:40:34 2010] [debug] mod_authnz_ldap.c(683): [client 172.30.235.107] ldap authorize: Creating LDAP req structure\n[Wed Jul 21 14:40:37 2010] [debug] mod_authnz_ldap.c(695): [client 172.30.235.107] auth_ldap authorise: User DN not found, ldap_search_ext_s() for user failed\n---\n\nThe resulting request made by mod_authnz_ldap is for (&(objectclass=*)(sAMAccountName=tmclaughlin)).  The search result is the account entry in AD plus three referrals:\n\nldap://DomainDnsZones.example.com/DC=DomainDnsZones,DC=example,DC=com\nldap://ForestDnsZones.example.com/DC=ForestDnsZones,DC=example,DC=com\nldap://example.com/CN=Configuration,DC=example,DC=com\n\nThe attempts to search these three referrals all fail with the same LDAP error:\n\n00000000: LdapErr: DSID-0C090627, comment: In order to perform this operation a successful bind must be completed on the connection., data 0, vece\n\nI've found two workarounds for this issue.  One is to change the path in AuthLDAPURL to where all our users are stored.  This may not work for all organizations.  The second is to set in /etc/openldap/ldap.conf \"REFERRALS off\".  That unfortunately affects the behavior of everything using the openldap libs.  The best fix would probably be to implement what looks to have been done in mod_auth_ldap in bugzilla 26538 and add AuthLDAPFollowReferrals which would allow toggling referral chasing in mod_authnz_ldap."}, {"count": 1, "tags": [], "bug_id": 49632, "attachment_id": null, "is_private": false, "id": 138617, "time": "2010-07-21T15:57:15Z", "creator": "covener@gmail.com", "creation_time": "2010-07-21T15:57:15Z", "text": "other options: point at the global catalog port, or to the \"ADAM\" frontend."}, {"text": "Only problem I could see with searching a global catalog is often times the GC servers are a subset of your DCs.  You may have multiple DCs per site with only one GC in that site.  From my recollection of AD topology recommendations that is an advisable setup according to MS.  (It's to balance availability with replication load.)  For redundancy with mod_authnz_ldap you would end up pointing to the local site GC and a foreign site's GC instead of just utilizing the local site DCs.\n\nref:\nhttp://technet.microsoft.com/en-us/library/cc978012.aspx\nhttp://technet.microsoft.com/en-us/library/cc728188%28WS.10%29.aspx", "tags": [], "creator": "tmclaugh@sdf.lonestar.org", "is_private": false, "count": 2, "id": 138620, "time": "2010-07-21T17:42:03Z", "bug_id": 49632, "creation_time": "2010-07-21T17:42:03Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 49632, "attachment_id": null, "id": 172509, "time": "2014-01-19T20:29:43Z", "creator": "covener@gmail.com", "creation_time": "2014-01-19T20:29:43Z", "is_private": false, "text": "referral stuff in 2.4 helpful for this?\n\n(sorry this PR has been stagnant)"}]