[{"count": 0, "tags": [], "bug_id": 41280, "is_private": false, "id": 97544, "attachment_id": null, "creator": "david.ehrlich@tradecapture.com", "creation_time": "2007-01-02T12:45:52Z", "time": "2007-01-02T12:45:52Z", "text": "While processing a large number of files via an 'apt' ant task, apt is failing\nwith an out of memory exception.  Altering the task to include a\n'memoryMaximumSize' argument does not rectify the situation.  The following is\nemitted regardless of the 'fork=' setting in the ant script:\n\n      [apt] Compiling 1881 source files\n      [apt] Since fork is false, ignoring memoryMaximumSize setting.\n      [apt]\n      [apt]\n      [apt] The system is out of resources.\n      [apt] Consult the following stack trace for details.\n      [apt] java.lang.OutOfMemoryError: Java heap space\n\nI haven't found a way to work around the issue via the script.  However, I was\nable to get the Apt task to do what I need by altering the\norg.apache.tools.ant.taskdefs.Apt constructor as follows.\n\nOriginal constructor:\n    public Apt() {\n        super();\n        super.setCompiler(AptExternalCompilerAdapter.class.getName());\n        setFork(true);\n    }\nWork-around constructor:\n    public Apt() {\n        super();\n        super.setCompiler(AptExternalCompilerAdapter.class.getName());\n        super.setFork(true);\n    }\n\nHowever, the workaround causes the task to emit a different warning:\n      [apt] Since compiler setting isn't classic or modern,ignoring fork setting.\n      [apt] Compiling 1881 source files\n      [apt] Since compiler setting isn't classic or modern,ignoring fork setting.\n\nI suspect this implies other changes need to be made to get the apt task to\nrecognize the appropriate memory options."}, {"count": 1, "tags": [], "bug_id": 41280, "attachment_id": null, "id": 97557, "time": "2007-01-03T05:56:19Z", "creator": "stevel@apache.org", "creation_time": "2007-01-03T05:56:19Z", "is_private": false, "text": "good catch. we turned forking off because we want people to fork every time\n(classpath problems) but in fact hadn't fixed the problem because we'd stubbed\nout the setFork() operator. \n\nExpect a fix for Ant1.7.1"}, {"text": "fixed in SVN, you can check out and use the new version or stick with your\npatched edition until ant1.7.1 ships. Thank you for finding a bug that snuck\npast our testing!", "tags": [], "creator": "stevel@apache.org", "is_private": false, "count": 2, "id": 97581, "time": "2007-01-03T13:48:16Z", "bug_id": 41280, "creation_time": "2007-01-03T13:48:16Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 41280, "attachment_id": null, "text": "It happens again even with ant 1.7.1 with 64bit JDK 5u16 on Ubuntu Intrepid. I am not able to say if it is specific to ant package on Ubuntu.\n[local]> ant -version\nApache Ant version 1.7.1 compiled on October 3 2008\n\n  <target name=\"compile-jruby\" depends=\"compile-tasks, compile-annotation-binder, check-for-optional-packages\">\n    <!-- Generate binding logic ahead of time -->\n    <apt factory=\"org.jruby.anno.AnnotationBinder\" destdir=\"${jruby.classes.dir}\" debug=\"true\" source=\"${javac.version}\" target=\"${javac.version}\" deprecation=\"true\" encoding=\"UTF-8\">\n      <classpath refid=\"build.classpath\"/>\n      <classpath path=\"${jruby.classes.dir}\"/>\n      <src path=\"${src.dir}\"/>\n      <patternset refid=\"java.src.pattern\"/>\n      <compilerarg line=\"-XDignore.symbol.file=true\"/>\n    </apt>\n  </target>\n\n\ncompile-jruby:\n      [apt] Since compiler setting isn't classic or modern,ignoring fork setting.\n      [apt] Compiling 641 source files to /mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build/classes/jruby\n      [apt] Since compiler setting isn't classic or modern,ignoring fork setting.\n      [apt] warning: Annotation types without processors: [java.lang.Override, java.lang.SuppressWarnings, java.lang.Deprecated, org.jruby.anno.JRubyConstant, org.jruby.anno.JRubyModule, java.lang.annotation.Retention, java.lang.annotation.Target]\n      [apt] Problem encountered during annotation processing; \n      [apt] see stacktrace below for more information.\n      [apt] java.lang.OutOfMemoryError: Java heap space\n      [apt] \tat java.io.BufferedWriter.<init>(BufferedWriter.java:87)\n      [apt] \tat java.io.BufferedWriter.<init>(BufferedWriter.java:70)\n      [apt] \tat java.io.PrintStream.init(PrintStream.java:83)\n      [apt] \tat java.io.PrintStream.<init>(PrintStream.java:100)\n      [apt] \tat java.io.PrintStream.<init>(PrintStream.java:62)\n      [apt] \tat org.jruby.anno.AnnotationBinder$AnnotationBindingProcessor$RubyClassVisitor.visitClassDeclaration(AnnotationBinder.java:90)\n      [apt] \tat com.sun.tools.apt.mirror.declaration.ClassDeclarationImpl.accept(ClassDeclarationImpl.java:95)\n      [apt] \tat com.sun.mirror.util.DeclarationScanner.visitClassDeclaration(DeclarationScanner.java:110)\n      [apt] \tat com.sun.tools.apt.mirror.declaration.ClassDeclarationImpl.accept(ClassDeclarationImpl.java:95)\n      [apt] \tat com.sun.mirror.util.DeclarationScanner.visitClassDeclaration(DeclarationScanner.java:125)\n      [apt] \tat com.sun.tools.apt.mirror.declaration.ClassDeclarationImpl.accept(ClassDeclarationImpl.java:95)\n      [apt] \tat org.jruby.anno.AnnotationBinder$AnnotationBindingProcessor.process(AnnotationBinder.java:60)\n      [apt] \tat com.sun.mirror.apt.AnnotationProcessors$CompositeAnnotationProcessor.process(AnnotationProcessors.java:60)\n      [apt] \tat com.sun.tools.apt.comp.Apt.main(Apt.java:454)\n      [apt] \tat com.sun.tools.apt.main.JavaCompiler.compile(JavaCompiler.java:448)\n      [apt] \tat com.sun.tools.apt.main.Main.compile(Main.java:1075)\n      [apt] \tat com.sun.tools.apt.main.Main.compile(Main.java:938)\n      [apt] \tat com.sun.tools.apt.Main.processing(Main.java:95)\n      [apt] \tat com.sun.tools.apt.Main.process(Main.java:43)\n      [apt] \tat com.sun.tools.apt.Main.main(Main.java:34)\n      [apt] Note: Some input files use unchecked or unsafe operations.\n      [apt] Note: Recompile with -Xlint:unchecked for details.\n\n[o.jruby.distro]> java -version\njava version \"1.5.0_16-rev\"\nJava(TM) 2 Runtime Environment, Standard Edition (build 1.5.0_16-rev-b09)\nJava HotSpot(TM) 64-Bit Server VM (build 1.5.0_16-rev-b09, mixed mode)\n[o.jruby.distro]> javac -version\njavac 1.5.0_16-rev\n", "id": 122065, "time": "2008-10-31T03:18:49Z", "creator": "marek.slama@sun.com", "creation_time": "2008-10-31T03:18:49Z", "is_private": false}, {"text": "I forgot to say: The same target passes on 32bit JDK.", "tags": [], "bug_id": 41280, "is_private": false, "count": 4, "id": 122066, "time": "2008-10-31T03:20:54Z", "creator": "marek.slama@sun.com", "creation_time": "2008-10-31T03:20:54Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 41280, "attachment_id": null, "id": 122068, "time": "2008-10-31T04:21:29Z", "creator": "stevel@apache.org", "creation_time": "2008-10-31T04:21:29Z", "is_private": false, "text": "It probably only fails on a 64 bit VM because Sun 64-bit JVM heap requirements are 1.5X 32 bit due entirely to memory pointer length; it probably works on the JRockit JVM which uses short pointers when the heap is <4GB.\n\nWhat is the ant -verbose run?\n\nThe \"no forking\" message implies that Apt is running in Ant's own process, so if you set the heap size there then it should propagate down. That would make the problem go away, but not fix any defect. \n\n"}, {"count": 6, "tags": [], "bug_id": 41280, "is_private": false, "id": 122071, "attachment_id": null, "creator": "marek.slama@sun.com", "creation_time": "2008-10-31T04:48:57Z", "time": "2008-10-31T04:48:57Z", "text": "I set ANT_OPTS to \"-Xmx1024m -Dbuild.compiler.debug=true\" but it does not help anyway. It would say this should be enough so there might be another problem specific to 64bit JDK. Verbose output for this target (I build o.jruby.distro module from NetBeans sources.) is ~5MB. If you wish I can send zip file\n\nHopefully relevant part is (let me know if you want anything else):\n      [apt] Since compiler setting isn't classic or modern,ignoring fork setting.\n      [apt] Compiling 641 source files to /mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build/classes/jruby\n      [apt] Using external apt compiler\n      [apt] Since compiler setting isn't classic or modern,ignoring fork setting.\n      [apt] Compilation arguments:\n      [apt] '-deprecation'\n      [apt] '-d'\n      [apt] '/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build/classes/jruby'\n      [apt] '-classpath'\n      [apt] '/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build/classes/jruby:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/asm-3.0.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/asm-analysis-3.0.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/asm-commons-3.0.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/asm-tree-3.0.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/asm-util-3.0.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/backport-util-concurrent.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/bnd-0.0.249.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/bytelist-0.1.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/dynalang-0.3.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/emma.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/emma_ant.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/jarjar-1.0rc7.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/jline-0.9.93.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/jna-posix.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/jna.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/joda-time-1.5.1.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/joni.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/junit.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/jvyamlb-0.2.3.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/retroweaver-2.0.5.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/build_lib/retroweaver-rt-2.0.5.jar:/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/lib/bsf.jar:/usr/share/ant/lib/ant-launcher.jar:/usr/share/java/xmlParserAPIs.jar:/usr/share/java/xercesImpl.jar:/usr/share/ant/lib/ant-javamail.jar:/usr/share/ant/lib/ant-apache-oro.jar:/usr/share/ant/lib/ant-commons-logging.jar:/usr/share/ant/lib/ant-apache-bsf.jar:/usr/share/ant/lib/ant-apache-regexp.jar:/usr/share/ant/lib/ant-nodeps.jar:/usr/share/ant/lib/ant-jsch.jar:/usr/share/ant/lib/ant-jmf.jar:/usr/share/ant/lib/ant-apache-log4j.jar:/usr/share/ant/lib/ant.jar:/usr/share/ant/lib/ant-commons-net.jar:/usr/share/ant/lib/ant-apache-resolver.jar:/usr/share/ant/lib/ant-antlr.jar:/usr/share/ant/lib/ant-apache-bcel.jar:/usr/share/ant/lib/ant-trax.jar:/usr/share/ant/lib/ant-junit.jar:/usr/share/ant/lib/ant-jdepend.jar:/usr/share/ant/lib/ant-swing.jar:/usr/java/jdk1.5.0_16_64bit/lib/tools.jar'\n      [apt] '-sourcepath'\n      [apt] '/mnt/local/mslama/netbeans/hg-nbsrc/core-main/o.jruby.distro/unpatched_source/jruby-1.1.4/src'\n      [apt] '-target'\n      [apt] '1.5'\n      [apt] '-encoding'\n      [apt] 'UTF-8'\n      [apt] '-g'\n      [apt] '-XDignore.symbol.file=true'\n      [apt] '-source'\n      [apt] '1.5'\n      [apt] '-factory'\n      [apt] 'org.jruby.anno.AnnotationBinder'\n      [apt]\n      [apt] The ' characters around the executable and arguments are\n      [apt] not part of the command.\n      [apt] Files to be compiled:\n"}, {"count": 7, "tags": [], "creator": "stevel@apache.org", "attachment_id": null, "id": 122072, "time": "2008-10-31T05:15:14Z", "bug_id": 41280, "creation_time": "2008-10-31T05:15:14Z", "is_private": false, "text": "looking at the source, that warning about forking is invalid; its the superclass whining. The stack trace implies this is a new JVM (no ant classes in the trace) so we are forking. That leaves the question of whether the memory options are going down to the process or not.\n\nCan you now do an ant -debug run and paste in the [apt] bit of that log?"}, {"count": 8, "tags": [], "bug_id": 41280, "is_private": false, "id": 122074, "attachment_id": null, "creator": "marek.slama@sun.com", "creation_time": "2008-10-31T05:49:29Z", "time": "2008-10-31T05:49:29Z", "text": "I used memoryMaximumSize=\"256m\" for apt task and it works now. Yes warning about forking is confusing and should be eliminated. Parent process memory settings are not propagated to forked apt task so maximum memory size must be increased explicitly. But it is documented to it is correct. Thank you for help. I assume ant -debug output is not necessary anymore. If you still need it let me know."}, {"count": 9, "tags": [], "bug_id": 41280, "attachment_id": null, "id": 122075, "time": "2008-10-31T05:56:55Z", "creator": "marek.slama@sun.com", "creation_time": "2008-10-31T05:56:55Z", "is_private": false, "text": "Problem is that task does not fail when OutOfMemoryError happens in forked JVM. Is it correct? It makes diagnostic difficult in case of building big project."}]