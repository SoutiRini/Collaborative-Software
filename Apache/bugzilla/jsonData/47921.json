[{"count": 0, "tags": [], "bug_id": 47921, "text": "If a test plan stores data in JMeter variables, then the data is not released until the test plan terminates.\nThis data should be released when the thread group terminates.\n\nTo reproduce,\n * Create two thread groups with the same number of threads and a BSF sampler under each one.\n * Add some code to each BSF sampler to create some multi Mb string data and store it in vars.\n * Set the test plan option \"Run thread groups sequentially\".\n * Run the test.\n\nObserve that the memory used by JMeter goes up when running the first thread group, and up again by the same amount during the second thread group. Memory is not released until the end of the test plan.\n\nPlease see this mail for the reasoning leading up to this:\nhttp://mail-archives.apache.org/mod_mbox/jakarta-jmeter-user/200909.mbox/%3C4AC1AC85.2010805@groupbc.com%3E", "id": 130758, "time": "2009-09-30T08:19:14Z", "creator": "ronan.klyne@groupbc.com", "creation_time": "2009-09-30T08:19:14Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "text": "Created attachment 27497\nFixes the leaks\n\nHello,\nI tracked references and I saw 2 remaining issues:\n- JMeterThread holds a reference to JMeterVariables through threadVars, at end of thread this one holds data that were added by Samplers . So what I did was to take an image of threadVars at start in a variable called threadVars and then at end of thread, clean all keys that were not here at start , DO YOU SEE ANY CASE THAT WOULD INTRODUCE AN ISSUE ?\n- JMeterContext hold a reference to JMeterThread in thread variable which is not reset to null, as this is repositionned in initRun at each run, I can remove if safely I think\n\n\nRegards\nPhilippe", "attachment_id": 27497, "id": 149245, "creator": "p.mouawad@ubik-ingenierie.com", "time": "2011-09-14T21:34:38Z", "bug_id": 47921, "creation_time": "2011-09-14T21:34:38Z", "is_private": false}, {"count": 2, "text": "Created attachment 27498\nTest Plan as explained", "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": 27498, "id": 149246, "time": "2011-09-14T21:35:50Z", "bug_id": 47921, "creation_time": "2011-09-14T21:35:50Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "text": "Not sure I agree with the change to JMeterContext - the clear() method may be called other than at the end.\n\nI'm not sure why one needs to keep any JMeterVariables at the end of the JMeterThread run - the JMeterThread instance is not re-used - so I would have though it would be OK to clear all the variables. But really I would expect the JMeter Thread to be released at the end of its run, so probably no point even clearing the variables. However that does not seem to be the case.\n\nSeems to me the proper fix would be to ensure that the JMeterThread is released on exit, but I don't know what is retaining the reference.\n\nNote that the Debug Samplers copy the contents of the variables into their sample results, which are stored by the Tree View Listener.", "attachment_id": null, "id": 149248, "creator": "sebb@apache.org", "time": "2011-09-14T23:26:39Z", "bug_id": 47921, "creation_time": "2011-09-14T23:26:39Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 47921, "attachment_id": null, "id": 149251, "time": "2011-09-15T09:29:24Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-09-15T09:29:24Z", "is_private": false, "text": "Hello Sebb,\nI tracked and JMeterThread is finally retained by TestCompiler#pairing which is static and never cleaned once JMeterThread ends.\n\nIn details:\n1) pairing holds a reference to TestCompiler$ObjectPair\n2) TestCompiler$ObjectPair holds a reference through child to BSFSampler \n3) BSFSampler holds a reference through threadContext to JMeterThread\n\nReading code I don't fully understand the use of pairing.\nRegards\nPhilippe"}, {"count": 5, "tags": [], "bug_id": 47921, "text": "Again,\nAnd there is another reference held through IterationListener (instance class).\n\nTestCompiler$ObjectPair>ThreadGroup#propMap>TestElementProperty#savedValue and value>LoopController#iterationListeners.\n\n\nRegards\nPhilippe", "id": 149254, "time": "2011-09-15T10:01:26Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-09-15T10:01:26Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 47921, "attachment_id": 27499, "id": 149255, "time": "2011-09-15T10:07:53Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-09-15T10:07:53Z", "is_private": false, "text": "Created attachment 27499\nNew fix\n\nHello Sebb,\nHere is another solution that:\n- unregister listener\n- nullifies thread reference in clear0\n\nBy the way I don't see other calls to clear except JMeterThread#run.\n\n\nRegards\nPhilippe"}, {"count": 7, "tags": [], "text": "Hello Sebb,\nDid you have time to look at this one ?\nAre there still issues in it ?\nThank you\nRegards", "attachment_id": null, "id": 149360, "creator": "p.mouawad@ubik-ingenierie.com", "time": "2011-09-17T07:49:26Z", "bug_id": 47921, "creation_time": "2011-09-17T07:49:26Z", "is_private": false}, {"count": 8, "tags": [], "creator": "sebb@apache.org", "attachment_id": null, "id": 149364, "time": "2011-09-17T10:55:21Z", "bug_id": 47921, "creation_time": "2011-09-17T10:55:21Z", "is_private": false, "text": "Thanks for the new patch.\n\nThere was one raw type, and I localised the iterationListener variable to the run method.\n\nURL: http://svn.apache.org/viewvc?rev=1171944&view=rev\nLog:\nBug 47921 - Variables not released for GC after JMeterThread exits.\n\nModified:\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/control/Controller.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/control/GenericController.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/threads/AbstractThreadGroup.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/threads/JMeterContext.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/threads/JMeterThread.java\n   jakarta/jmeter/trunk/xdocs/changes.xml\n\nNot sure if this is yet enough to fix all the retained objects."}, {"count": 9, "tags": [], "bug_id": 47921, "text": "Hopefully this is now fixed.\n\nIf not, please re-open with details.", "id": 149440, "time": "2011-09-17T21:51:14Z", "creator": "sebb@apache.org", "creation_time": "2011-09-17T21:51:14Z", "is_private": false, "attachment_id": null}]