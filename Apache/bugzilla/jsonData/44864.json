[{"count": 0, "tags": [], "creator": "andre.cruz@co.sapo.pt", "attachment_id": null, "id": 115811, "time": "2008-04-23T09:36:55Z", "bug_id": 44864, "creation_time": "2008-04-23T09:36:55Z", "is_private": false, "text": "Even when SSLVerifyClient=\"optionalNoCA\" is specified in the connector, invalid client certificates still lead to invalid SSL handshakes.\n\nThis is because SSL_get_verify_result(con->ssl) in sslnetwork.c still returns != X509_V_OK even though SSL_callback_SSL_verify() returns ok in these cases. There is an extra check in openssl itself which is returning the error.\n\nThe way this is dealt on mod_ssl in apache (ssl_engine_io.c) is: \n\n    if ((verify_result != X509_V_OK) ||\n        sslconn->verify_error)\n    {\n        if (ssl_verify_error_is_optional(verify_result) &&\n            (sc->server->auth.verify_mode == SSL_CVERIFY_OPTIONAL_NO_CA))\n        {\n            /* leaving this log message as an error for the moment,\n             * according to the mod_ssl docs:\n             * \"level optional_no_ca is actually against the idea\n             *  of authentication (but can be used to establish\n             * SSL test pages, etc.)\"\n             * optional_no_ca doesn't appear to work as advertised\n             * in 1.x\n             */\n            ap_log_cerror(APLOG_MARK, APLOG_INFO, 0, c,\n                          \"SSL client authentication failed, \"\n                          \"accepting certificate based on \"\n                          \"\\\"SSLVerifyClient optional_no_ca\\\" \"\n                          \"configuration\");\n            ssl_log_ssl_error(APLOG_MARK, APLOG_INFO, c->base_server);\n        }\n        else {\n            const char *error = sslconn->verify_error ?\n                sslconn->verify_error :\n                X509_verify_cert_error_string(verify_result);\n\n            ap_log_cerror(APLOG_MARK, APLOG_INFO, 0, c,\n                         \"SSL client authentication failed: %s\",\n                         error ? error : \"unknown\");\n            ssl_log_ssl_error(APLOG_MARK, APLOG_INFO, c->base_server);\n\n            return ssl_filter_io_shutdown(filter_ctx, c, 1);\n        }\n    }\n\nEven though verify_result is not OK, if optional_no_ca is specified, the request should be valid.\n\nThe release notes specify that bugs in this code should be filed under \"Native:JNI\" component but I could find it in the pull-down."}, {"count": 1, "tags": [], "creator": "mturk@apache.org", "attachment_id": null, "id": 118924, "time": "2008-07-23T01:11:24Z", "bug_id": 44864, "creation_time": "2008-07-23T01:11:24Z", "is_private": false, "text": "This actually belongs to Connectors, not JK"}, {"count": 2, "tags": [], "text": "Should be fixed now. Can you verify by using the SVN trunk?", "attachment_id": null, "bug_id": 44864, "id": 118927, "time": "2008-07-23T02:04:15Z", "creator": "mturk@apache.org", "creation_time": "2008-07-23T02:04:15Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 44864, "attachment_id": null, "text": "Yes, it seems to work.\n\nThanks!", "id": 118932, "time": "2008-07-23T04:31:21Z", "creator": "andre.cruz@co.sapo.pt", "creation_time": "2008-07-23T04:31:21Z", "is_private": false}, {"count": 4, "tags": [], "creator": "trscavo@gmail.com", "attachment_id": null, "id": 118935, "time": "2008-07-23T07:31:02Z", "bug_id": 44864, "creation_time": "2008-07-23T07:31:02Z", "is_private": false, "text": "What version of tomcat will incorporate this patch, do you know?  Thanks."}]