[{"count": 0, "attachment_id": null, "bug_id": 60075, "is_private": false, "id": 193436, "time": "2016-08-31T15:05:09Z", "creator": "pgajdos@suse.cz", "creation_time": "2016-08-31T15:05:09Z", "tags": [], "text": "Hi,\n\nI get a segfault using following configuration:\n\n------ httpd.conf ------\nServerName test\nUser pgajdos\nGroup users\nListen 60080\nPidFile /tmp/apache-rex/mod_auth_digest-Authorization/pid\nErrorLog /tmp/apache-rex/mod_auth_digest-Authorization/error_log\nLoadModule auth_basic_module /usr/lib64/apache2-prefork/mod_auth_basic.so\nLoadModule dir_module /usr/lib64/apache2-prefork/mod_dir.so\nLoadModule authz_host_module /usr/lib64/apache2-prefork/mod_authz_host.so\nLoadModule auth_digest_module /usr/lib64/apache2-prefork/mod_auth_digest.so\nLoadModule authn_file_module /usr/lib64/apache2-prefork/mod_authn_file.so\nLoadModule authz_user_module /usr/lib64/apache2-prefork/mod_authz_user.so\nLoadModule version_module /usr/lib64/apache2-prefork/mod_version.so\nLoadModule authz_core_module /usr/lib64/apache2-prefork/mod_authz_core.so\nLoadModule authn_core_module /usr/lib64/apache2-prefork/mod_authn_core.so\nDocumentRoot /tmp/apache-rex/mod_auth_digest-Authorization/htdocs\nDirectoryIndex index.html\n\n### example configuration\n\n# make sure shm file is written into writeable dir \n# (without that, I got Permission denied: AH01179: \n# balancer slotmem_create failed for 2.4.6 @ 13.1)\n# \n# see for details:\n# http://mail-archives.apache.org/mod_mbox/httpd-dev/201203.mbox/%3Cddf3855a-8ab3-45e1-9ad4-049d90ac8879@zimbra1%3E\n#\n# directive available from 2.4.2\n<IfVersion >= 2.4.2>\n  DefaultRuntimeDir /tmp/apache-rex/mod_auth_digest-Authorization/run\n</IfVersion>\n\n<Directory \"/tmp/apache-rex/mod_auth_digest-Authorization/htdocs\">\n  AuthType Digest\n  AuthDigestProvider file\n  AuthName \"Restricted Area\"\n  AuthUserFile /tmp/apache-rex/mod_auth_digest-Authorization/htdigest\n  AuthDigestDomain \"/\"\n  Require valid-user\n</Directory>\n---------------------------\n\nand curl command:\n\n$ curl -s -i -H \"Authorization: Digest username=\\\"\\\", realm=\\\"\\\", nonce=\\\"\\\", uri=\\\"/index.html\\\", response=\\\"\\\", opaque=\\\"\\\"\" http://localhost:60080/index.html\n\nrun more than five times consecutively.\n\nIt seems that client_list->table gets overwritten in add_client() for some reason:\n\nProgram received signal SIGTRAP, Trace/breakpoint trap.\n0x00007ffff1033522 in memcpy (__len=112, __src=0x7fffffffdb40, __dest=0x7ffff7f22008) at /usr/include/bits/string3.h:53\n53\t/usr/include/bits/string3.h: No such file or directory.\n(gdb) bt\n#0  0x00007ffff1033522 in memcpy (__len=112, __src=0x7fffffffdb40, __dest=0x7ffff7f22008) at /usr/include/bits/string3.h:53\n#1  add_client (s=0x7ffff7f42bc8, info=0x7fffffffdb40, key=6) at mod_auth_digest.c:858\n#2  gen_client (r=r@entry=0x7ffff7f040a0) at mod_auth_digest.c:1117\n#3  0x00007ffff10357d8 in note_digest_auth_failure (r=r@entry=0x7ffff7f040a0, conf=conf@entry=0x7ffff7f3c188, resp=resp@entry=0x7ffff7f05810, stale=stale@entry=0)\n    at mod_auth_digest.c:1262\n#4  0x00007ffff10359e2 in authenticate_digest_user (r=0x7ffff7f040a0) at mod_auth_digest.c:1846\n[...]\n\n(gdb) frame 1\n#1  add_client (s=0x7ffff7f42bc8, info=0x7fffffffdb40, key=6) at mod_auth_digest.c:858\n858\t    memcpy(entry, info, sizeof(client_entry));\n(gdb) p client_list->table\n$1 = (client_entry **) 0x0\n(gdb) p client_list\n$8 = (struct hash_table *) 0x7ffff7f22038\n(gdb) p entry\n$9 = (client_entry *) 0x7ffff7f22008\n(gdb) p sizeof(client_entry)\n$10 = 112\n(gdb)\n\n\nUnfortunately I have not learned the aim of the opaque code in note_digest_auth_failure() to be able to think about a patch. When I run just:\n\n$ curl -i http://localhost:60080/index.html\n\nI got 401 correctly but gen_client()/add_client() is not called at all. During the first curl command (with the opaque= in the header) these two are called."}, {"count": 1, "tags": [], "creator": "pgajdos@suse.cz", "attachment_id": null, "text": "(In reply to Petr Gajdos from comment #0)\n> Unfortunately I have not learned the aim of the opaque code in\n> note_digest_auth_failure() to be able to think about a patch. When I run\n> just:\n> \n> $ curl -i http://localhost:60080/index.html\n> \n> I got 401 correctly but gen_client()/add_client() is not called at all.\n> During the first curl command (with the opaque= in the header) these two are\n> called.\n\nIn other words: if you look at example flow (run.sh) in:\n\nhttps://github.com/pgajdos/apache-rex/tree/master/mod_auth_digest-Authorization\n\nThere is 'opaque=' parameter nowhere in 'Authentication-Info' header in 200-response. So I am just not sure when opaque= (~ number of client here?) parameter is sent to client; note_digest_auth_failure()'s code seems to heavily depend on its value trough resp->opaque, which is set only while parsing Authorization: header, if I understand correctly.", "id": 193447, "time": "2016-09-01T10:10:33Z", "bug_id": 60075, "creation_time": "2016-09-01T10:10:33Z", "is_private": false}]