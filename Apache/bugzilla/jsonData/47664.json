[{"attachment_id": null, "tags": [], "bug_id": 47664, "is_private": false, "count": 0, "id": 129571, "time": "2009-08-07T13:29:19Z", "creator": "marco.walther@sun.com", "creation_time": "2009-08-07T13:29:19Z", "text": "I have a URL with an utf-8 encoded `\u00f3' in it. mod_proxy mangles that when `nocanon' is not set.\n\nThe problem is that one byte is translated back into the %HH form but the othe one is not:-(\n\nSome pieces of errorlog: (I added some log entries not in the normal source;-)\n---------------------------------------------------------------\nmod_proxy_balancer.c(46): proxy: BALANCER: canonicalising URL //cluster_foo/projects/mw-test/pages/\\xc3\\xb3/edit\nmod_proxy_balancer.c(71): proxy: BALANCER: mw canonicalised URL projects/mw-test/pages/\\xc3%B3/edit (len 32)\nmod_proxy_balancer.c(82): proxy: BALANCER: mw canonicalised filename proxy:balancer://cluster_foo/projects/mw-test/pages/\\xc3%B3/edit (len 63)\nmod_proxy_balancer.c(1152): proxy: Entering bybusyness for BALANCER (balancer://cluster_foo)\nmod_proxy_balancer.c(1211): proxy: bybusyness selected worker \"http://be:8280\" : busy 0 : lbstatus -1\nmod_proxy_balancer.c(581): proxy: BALANCER (balancer://cluster_foo) worker (http\n://be:8280) rewritten to http://be:8280/projects/mw-test/pages/\\xc3%B3/edit\nmod_proxy.c(993): Running scheme balancer handler (attempt 0)\nmod_proxy_http.c(1920): proxy: HTTP: serving URL http://be:8280/projects/mw-test/pages/\\xc3%B3/edit\nproxy_util.c(1991): proxy: HTTP: has acquired connection for (be)\nproxy_util.c(2047): proxy: connecting http://be:8280/projects/mw-test/pages/\\xc3%B3/edit to be:8280\nproxy_util.c(2145): proxy: connected /projects/mw-test/pages/\\xc3%B3/edit to be:8280\n-----------------------------------------------------\n\nThe problem seems to be in proxy_util.c - ap_proxy_canonenc, some (?) char's are not recoded.\n\nI changed the source a bit and now it seems to work better: The diff is for 2.2.11 but that area did not change in 2.2.12!!\n\n--- httpd-2.2.11-orig/modules/proxy/proxy_util.c     Tue Nov 11 12:04:34 2008\n+++ httpd-2.2.11-work/modules/proxy/proxy_util.c     Fri Aug  7 12:38:20 2009\n@@ -213,7 +213,7 @@\n             }\n         }\n /* recode it, if necessary */\n-        if (!apr_isalnum(ch) && !strchr(allowed, ch)) {\n+        if (!(apr_isascii(ch) && apr_isalnum(ch)) && !strchr(allowed, ch)) {\n             ap_proxy_c2hex(ch, &y[j]);\n             j += 2;\n         }"}]