[{"count": 0, "attachment_id": null, "bug_id": 14451, "is_private": false, "id": 26074, "time": "2002-11-11T16:06:20Z", "creator": "bruno@wolff.to", "creation_time": "2002-11-11T16:06:20Z", "tags": [], "text": "When I filter CGI output with the DEFLATE filter (with or without\nalso using INCLUDES) I get a content-length header with a byte count\noff by 20 bytes. The ones I have observed have been low in GET\nrequests and high in HEAD requests (for the latter a count of 20\nwas returned even though there was no body data returned).\nYou can see a sample of this using\nhttp://www.schroepl.net/cgi-bin/http_trace.pl\nto fetch the page http://wolff.to/area/G_776.html . I currently am\nnot compressing output for browsers that supply the string MSIE in\nthe user-agent header.\nI am using a CVS version of 2.0.44 from last week."}, {"count": 1, "tags": [], "creator": "bruno@wolff.to", "attachment_id": null, "is_private": false, "id": 26410, "time": "2002-11-15T22:43:07Z", "bug_id": 14451, "creation_time": "2002-11-15T22:43:07Z", "text": "I saw that some other fixes to mod_deflate were applied recently\nand retested on current CVS and the problem still exists."}, {"count": 2, "attachment_id": null, "bug_id": 14451, "text": "Is there some additional information that I can provide that would\nhelp you guys confirm this bug?\nI have tried looking through the bucket passing code in the past\nwhen reporting mod_deflate bugs and wasn't able to understand\nenough to be able to spot where the errors are.\nI see that you are possible going to change the status of mod_deflate\nto be a normal module instead of experimental. I have found that\npeople running IE 5.0 and IE 6.0 have been having a lot of problems\nviewing pages generate by cgi scripts and filtered by mod_deflate.\nI suspect that the problem is related to the content-length header\nissue, but I am not absolutely sure of this. If confirming this would\nhelp increase the priority on figuring this problem out, I could try\nusing mod_headers to strip the content-length headers and see if that\nsolves the problem for the IE users. However, I have to ask others\nto do the testing and it might take a few days before I get help after\nI have some modified pages for them to look at.", "id": 26801, "time": "2002-11-22T16:01:59Z", "creator": "bruno@wolff.to", "creation_time": "2002-11-22T16:01:59Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 14451, "attachment_id": null, "is_private": false, "id": 26816, "time": "2002-11-22T19:13:17Z", "creator": "trawick@apache.org", "creation_time": "2002-11-22T19:13:17Z", "text": "Supplying the simplest testcase you can come up with that shows the problem\nwould be very helpful.  I've tried to duplicate the problem with GET requests on\ncurrent code but I haven't been successful.  I haven't looked at the HEAD issue yet.\n"}, {"count": 4, "tags": [], "bug_id": 14451, "attachment_id": null, "is_private": false, "id": 26850, "time": "2002-11-23T03:12:12Z", "creator": "bruno@wolff.to", "creation_time": "2002-11-23T03:12:12Z", "text": "I think I have figured out enough so that you should be able to\nreproduce the problem. The missing part is that I do an internal\nredirect and that is needed to make the problem show up.\nhttp://wolff.to/area/htaccess (no period) with show the .htaccess\nfile. The first line (the filter list) and the last line (the\nrelevant redirect) should be all that matters.\nhttp://wolff.to/area/test.pl , http://wolff.to/area/test.cgi and\nhttp://wolff.to/area/test.html all point to the same file. The first\nwill give you the source, the second will work correctly and the\nthird has a content-length header off by 20. However, note that in\nthe second case the file is 20 bytes longer."}, {"count": 5, "attachment_id": null, "bug_id": 14451, "text": "I looked at the difference between the compressed output returned\nby test.cgi and test.html and it appears that test.html has an\nextra 20 bytes of what appears to be a gzip header tacked on to the\nend.\nI also updated to use the latest cvs yesterday so I am now running\na 2.1.0 version of httpd.", "id": 26873, "time": "2002-11-23T17:50:06Z", "creator": "bruno@wolff.to", "creation_time": "2002-11-23T17:50:06Z", "tags": [], "is_private": false}, {"count": 6, "tags": [], "bug_id": 14451, "text": "The HEAD and GET problems appear to be separate. The extra 20 bytes\nget added when there is an internal redirect (using mod_rewrite) and\nboth the new and old extension are subject to mod_deflate filtering.\nI added another rewrite rule to the htaccess file and a test.txt file\naccessible through a redirect as test1.txt to illustrate this case.\nI will see if I can do a better job of isolating the bad\ncontent-length header returns on HEAD requests.", "id": 27054, "time": "2002-11-27T13:49:40Z", "creator": "bruno@wolff.to", "creation_time": "2002-11-27T13:49:40Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 14451, "text": "I figured out what was happenning with the odd content-length header\nvalues on HEAD requests. The short story is that it isn't a bug.\nThe script I was using only returns a content-type header on HEAD\nrequests (this is probably broken behavior) to save doing database\nlookups that won't be used. Even though the body is 0 bytes, it still\ngets gzip encoded and this encoding takes up 20 bytes. That is why\nthere is a content-length of 20.\nSo the only issue is the extra 20 bytes being tacked on to the body\nof requests that have a filtered (by mod_deflate) on both the initial\nand final filename extensions.", "id": 27056, "time": "2002-11-27T14:38:42Z", "creator": "bruno@wolff.to", "creation_time": "2002-11-27T14:38:42Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "bruno@wolff.to", "attachment_id": null, "is_private": false, "id": 27061, "time": "2002-11-27T15:11:19Z", "bug_id": 14451, "creation_time": "2002-11-27T15:11:19Z", "text": "This is sort of a related note. Normally a content-lenght header\nisn't sent when an includes filter is used or when the output\ncomes from a cgi script. However if mod_deflate is used, then a\ncontent-length header is included for either or both of these cases."}, {"count": 9, "attachment_id": null, "bug_id": 14451, "text": "I tried using addoutputfilterbytype to see if that would work around\nthe problem, but it didn't help.", "id": 27216, "time": "2002-12-01T22:35:52Z", "creator": "bruno@wolff.to", "creation_time": "2002-12-01T22:35:52Z", "tags": [], "is_private": false}, {"count": 10, "attachment_id": null, "bug_id": 14451, "is_private": false, "id": 27528, "time": "2002-12-08T15:24:28Z", "creator": "bruno@wolff.to", "creation_time": "2002-12-08T15:24:28Z", "tags": [], "text": "Is there anything else I can do to help get this bug verified?\nI think I have included enough information for someone to check\non it, but haven't heard back either way since figuring out that\ncombining internal redirects and mod_deflate exhibits the problem."}, {"count": 11, "tags": [], "bug_id": 14451, "attachment_id": null, "is_private": false, "id": 27888, "time": "2002-12-16T18:35:48Z", "creator": "bruno@wolff.to", "creation_time": "2002-12-16T18:35:48Z", "text": "I was able to find a configuration that avoided the problem in my\nsetup. I have changed things to reflect this and have removed some\nof the test pages I had up.\nThe successful way to handle *.html URLs that were redirected to\n*.cgi URLs (with internal redirects) so that the output was passed\nboth though INCLUDES and DEFLATE without getting the extra 20 bytes\nof gzip header or messing *.html files that aren't redirected is:\nAddOutputFilter INCLUDES;DEFLATE .html\nAddOutputFilter DEFLATE .txt .pl .sql .cgi\nAddOutputFilterByType INCLUDES text/html\nThis is now all being done at the top level of my document root.\nPreviously there was an addoutputfilter for .cgi files that only\nspecified DEFLATE at the top level and this was overridden in a\nsubdirectory (area) where cgi output was to get passed through both\nINCLUDES and DEFLATE. This may be related to the problem I was having\nas reduplicating the issue with the output filter directives only\nat the top level doesn't seem to work.\nBy using the addoutputfilterbytype directive I can just do INCLUDES\nprocessing for cgi output that returns text/html (as opposed to\ntext/plain) and don't need to have diferent rules in different\ndirectories.\nSo, I am not completely sure what is needed to make the problem show\nup. I was able to get the problem to occur with just plain html\nfiles (no cgi script) subject to a redirect in the subdirectory.\nI am asking one of my users to see if this fixes the problem with\naccessing the pages with IE."}, {"count": 12, "tags": [], "bug_id": 14451, "attachment_id": null, "is_private": false, "id": 27965, "time": "2002-12-17T17:08:45Z", "creator": "bruno@wolff.to", "creation_time": "2002-12-17T17:08:45Z", "text": "It turns out my new configuration didn't fix things.\nhttp://www.schroepl.net/cgi-bin/http_trace.pl started reporting a\ndata returned size that matched the content length header, but\naccording to my access_log another 20 bytes were actually sent.\nI noticed this when I got a report back from an IE user that\nthey still couldn't get compressed responses to work. So what I think\nchanged was the testing service, not the content being served."}, {"count": 13, "tags": [], "bug_id": 14451, "attachment_id": null, "text": "I think I have something that will point out where I am seeing the\nproblem. In mod_deflate.c there is code to not due compression for\nsubrequests. I think this check should be extended to not do it\nfor internal redirects. (I am not sure why the check that the request\ndoesn't already have a gzip encoding doesn't catch this.) I checked\nr->next to see if there will be more processing after this request\nis completed. I am not sure this is correct, because the .h that\ndefines record_rec has a comment that this link refers to external\nrequests. I suspect that that is a typo. Anyway the patch seems to\nwork for my problem. I will let you know if this fixes the IE problem\nwhen I hear back from the person who has been having problems with\ncompressed responses.\nThe diff versus mod_deflate.c follows:\n*** mod_deflate.c.orig  Sun Dec 22 13:53:19 2002\n--- mod_deflate.c       Sun Dec 22 13:36:55 2002\n***************\n*** 260,266 ****\n          const char *encoding, *accepts;\n\n          /* only work on main request/no subrequests */\n!         if (r->main) {\n              ap_remove_output_filter(f);\n              return ap_pass_brigade(f->next, bb);\n          }\n--- 260,266 ----\n          const char *encoding, *accepts;\n\n          /* only work on main request/no subrequests */\n!         if (r->main || r->next) {\n              ap_remove_output_filter(f);\n              return ap_pass_brigade(f->next, bb);\n          }", "id": 28177, "time": "2002-12-22T19:53:44Z", "creator": "bruno@wolff.to", "creation_time": "2002-12-22T19:53:44Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 14451, "text": "I heard back from the IE user who was having problems and now that\nthere aren't an extra 20 bytes being tacked on to compressed\nresponses, things are working OK.", "id": 28210, "time": "2002-12-23T15:12:16Z", "creator": "bruno@wolff.to", "creation_time": "2002-12-23T15:12:16Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "bug_id": 14451, "attachment_id": null, "id": 31194, "time": "2003-02-13T02:03:29Z", "creator": "nd@perlig.de", "creation_time": "2003-02-13T02:03:29Z", "is_private": false, "text": "I'll try to have a closer look at the problem and the patch these days, but one\nword anyway:\n\nsending different headers for GET and HEAD is wrong. You should _not_ handle\nboth methods not differently. Just send the content regardless of the method.\nApache will do the right thing and discard the body if neccessary. But he's able\nto maintain the Content-length header (or TRansfer-Encoding)."}, {"count": 16, "tags": [], "bug_id": 14451, "text": "Thanks for looking at this!\nWhile working on this issue I did figure out that suppressing the\ncontent for the head method was wrong. I haven't gotten around to\nchanging the code yet, but I plan to. The original idea was to save\nresources by not doing database calls if the content was going to\nbe thrown away anyway, but it turned out that keeps the head method\nfrom being as useful as it should. I also got confused by this as\nI was expecting the content-length to be zero since there was no\nbody, not realizing that a gzip'd version of an empty content takes\nup 20 bytes.\nGet requests do seem to be broken though. And since mod_deflate checks\nto make sure it isn't run twice, I am pretty sure there is something\nwrong where I have patched the code. (Especially since it fixes things\nfor me.) I am just not sure that the fix is really correct for all\ncases.", "id": 31198, "time": "2003-02-13T02:28:11Z", "creator": "bruno@wolff.to", "creation_time": "2003-02-13T02:28:11Z", "is_private": false, "attachment_id": null}, {"text": "strange ...\n\nSeems to happen only when redirecting to the cgi-handler. Can someone confirm or\ndisprove this?\n\nThanks anyway for your patience with us :)", "tags": [], "creator": "nd@perlig.de", "attachment_id": null, "count": 17, "id": 31392, "time": "2003-02-17T02:51:06Z", "bug_id": 14451, "creation_time": "2003-02-17T02:51:06Z", "is_private": false}, {"count": 18, "attachment_id": null, "bug_id": 14451, "is_private": false, "id": 31485, "time": "2003-02-18T00:39:06Z", "creator": "nd@perlig.de", "creation_time": "2003-02-18T00:39:06Z", "tags": [], "text": "errr, forget my last comment. I did the wrong tests ;-)\n\nHowever, your patch worked around the actual problem, it did not solve it.\nThe problem was that after finalizing the (redirected) request, the original\nrequest sent an(other) EOS bucket down the filter chain, which caused\nmod_deflate to init zlib and exit zlib with the result of 20 extra bytes.\n\nThe following patch should solve the problem entirely:\n<http://cvs.apache.org/viewcvs.cgi/httpd-2.0/server/util_filter.c.diff?r1=1.94&r2=1.95>\n\nIt's proposed for backport and may be in the next 2.0 release.\n\nThanks again for your patience and your detailed reports!"}, {"count": 19, "tags": [], "bug_id": 14451, "text": "I removed my patched mod_deflate and resynced with current CVS\nand retested for the problem. It seems to be fixed now. Thanks!", "id": 31489, "time": "2003-02-18T01:42:29Z", "creator": "bruno@wolff.to", "creation_time": "2003-02-18T01:42:29Z", "is_private": false, "attachment_id": null}, {"count": 20, "attachment_id": null, "bug_id": 14451, "text": "FYI: The fix will be in 2.0.45.", "id": 31796, "time": "2003-02-22T20:30:50Z", "creator": "nd@perlig.de", "creation_time": "2003-02-22T20:30:50Z", "tags": [], "is_private": false}, {"count": 21, "attachment_id": null, "bug_id": 14451, "is_private": false, "id": 38846, "time": "2003-06-13T23:09:48Z", "creator": "koreth-apache@midwinter.com", "creation_time": "2003-06-13T23:09:48Z", "tags": [], "text": "*** Bug 17629 has been marked as a duplicate of this bug. ***"}, {"count": 22, "tags": [], "bug_id": 14451, "attachment_id": null, "text": "*** Bug 14678 has been marked as a duplicate of this bug. ***", "id": 41076, "time": "2003-07-21T14:09:41Z", "creator": "jorton@redhat.com", "creation_time": "2003-07-21T14:09:41Z", "is_private": false}, {"count": 23, "attachment_id": null, "bug_id": 14451, "text": "*** Bug 14678 has been marked as a duplicate of this bug. ***", "id": 112588, "time": "2008-01-07T08:36:31Z", "creator": "rpluem@apache.org", "creation_time": "2008-01-07T08:36:31Z", "tags": [], "is_private": false}]