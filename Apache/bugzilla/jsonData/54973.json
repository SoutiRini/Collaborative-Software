[{"attachment_id": null, "tags": [], "creator": "bruno.canet@b-source.ch", "is_private": false, "count": 0, "id": 167212, "time": "2013-05-15T06:47:07Z", "bug_id": 54973, "creation_time": "2013-05-15T06:47:07Z", "text": "mod_proxy_fcgi is configured to proxy request to php-fpm as follow:\nProxyPassMatch ^/(.*\\.php)$ fcgi://127.0.0.1:9000/opt/httpd/htdocs/app/$1\n\nIf a php script takes more than 30 seconds to execute, a HTTP RC 500 is returned to the client.\n\nphp max_execution_time is set to 300 seconds \n\nI used the following script to validate that the error was not due to php max_execution_time issue.\n\n<?php\n    error_log(\"executing script... \");\n    $time = time();\n    for ($t = 0; $t <= 15; $t++) {\n        error_log(\"Logging: $t (\".(time()-$time).\" seconds)\");\n        sleep(5);\n    }\n    error_log(\"execution done (\".(time()-$time).\" seconds)\");\n?>\nafter 30 seconds, the HTTP 500 is returned to the client, but in the php error_log the script continue its execution.\n\nAccording to the documentation, TimeOut is set to 60 seconds by default, so it should not be an issue, but in case, the following explicit definition were tested without improvement:\n\n1. ProxyPassMatch ^/(.*\\.php)$ fcgi://127.0.0.1:9000/opt/httpd/htdocs/app/$1 timeout=300\n\n2. in virtual host: ProxyTimeout 300\n\n3 in server config: TimeOut 300\n\nThe only workaround found was to hardcode the timeout in the mod_proxy_fcgi.c:\n--- ./modules/proxy/mod_proxy_fcgi.c.orig       2013-04-16 16:09:25.970332062 +0200\n+++ ./modules/proxy/mod_proxy_fcgi.c    2013-04-16 16:09:56.311088966 +0200\n@@ -575,7 +575,7 @@\n         /* We need SOME kind of timeout here, or virtually anything will\n          * cause timeout errors. */\n         if (! conn->worker->s->timeout_set) {\n-            timeout = apr_time_from_sec(30);\n+            timeout = apr_time_from_sec(300);\n         }\n\n         rv = apr_poll(&pfd, 1, &n, timeout);"}, {"count": 1, "attachment_id": null, "bug_id": 54973, "is_private": false, "id": 170028, "time": "2013-09-11T13:23:59Z", "creator": "apacheorg@rupostel.com", "creation_time": "2013-09-11T13:23:59Z", "tags": [], "text": "we confirm this behavior with: \nmod_proxy_fcgi\nmod_proxy\napache event mpm \non latest stable apache 2.4.6 \n\nwe are using: \n\n(we tried both inside and outside virtualhost: )\n<Proxy fcgi://socket=%2fdev%2fshm%2ffpm-php.sock>\n\t\tProxySet timeout=3600\n\t\tProxySet connectiontimeout=3600\n</Proxy>\n\nProxyPassMatch ^/(.*\\.php(/.*)?)$ fcgi://socket=%2fdev%2fshm%2ffpm-php.sock/mobilnet.sk/$1 timeout=3600 connectiontimeout=3600\n\nOR\nRewriteCond %{ENV:REDIRECT_STATUS} ^$\nRewriteRule ^/?(.*\\.php)$ fcgi://socket=\\%2fdev\\%2fshm\\%2ffpm-php.sock/path/$1 [P,L]\n\nbut none of them accepts the timeout: \n[proxy_fcgi:error] (70007)The timeout specified has expired: [...] AH01075: Error dispatching request to:"}, {"count": 2, "attachment_id": 30828, "bug_id": 54973, "is_private": false, "id": 170081, "time": "2013-09-13T07:50:55Z", "creator": "jkaluza@redhat.com", "creation_time": "2013-09-13T07:50:55Z", "tags": [], "text": "Created attachment 30828\nproposed patch\n\nThis patch removes hardcoded 30 second timeout from mod_proxy_fcgi and replaces it with ProxyTimeout/Timeout."}, {"count": 3, "tags": [], "bug_id": 54973, "attachment_id": 30829, "id": 170082, "time": "2013-09-13T08:04:33Z", "creator": "jkaluza@redhat.com", "creation_time": "2013-09-13T08:04:33Z", "is_private": false, "text": "Created attachment 30829\nproposed patch v2\n\nBetter patch respecting previous \"conn->worker->s->timeout\" timeout if set."}, {"count": 4, "tags": [], "text": "The fact that you were not able to set \"timeout=300\" is caused by PR 43513.", "is_private": false, "bug_id": 54973, "id": 170086, "time": "2013-09-13T12:07:25Z", "creator": "jkaluza@redhat.com", "creation_time": "2013-09-13T12:07:25Z", "attachment_id": null}, {"count": 5, "tags": [], "creator": "jkaluza@redhat.com", "attachment_id": 30833, "is_private": false, "id": 170088, "time": "2013-09-13T12:12:02Z", "bug_id": 54973, "creation_time": "2013-09-13T12:12:02Z", "text": "Created attachment 30833\nproposed patch v3\n\nEven better patch. Now uses apr_socket_timeout_get."}, {"count": 6, "tags": [], "text": "Fixed in 2.4.8:\n\n *) mod_proxy_fcgi: Use apr_socket_timeout_get instead of hard-coded\n     30 seconds timeout. [Jan Kaluza]", "is_private": false, "bug_id": 54973, "id": 175049, "time": "2014-05-05T23:51:54Z", "creator": "trawick@apache.org", "creation_time": "2014-05-05T23:51:54Z", "attachment_id": null}]