[{"count": 0, "tags": [], "bug_id": 60313, "text": "Steps to reproduce\n----------------------\ntelnet test.server.com 80\nTrying 54.xxx.xxx.18...\nConnected to test.server.com.\nEscape character is '^]'.\nPOST /errors/test HTTP/1.1\nHOST: test.server.com\nUser-Agent: deadbeef\nConnection: Keep-Alive\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 7\n\na=hi\n\nExpected behavior\n-----------------\nRequest is dropped and a 408 status code is returned.\n\nActual behavior\n---------------\nRequest is handled normally.\n\nPlatform\n--------\n$ httpd -V\nServer version: Apache/2.4.18 (centos)\nServer built:   Jul 14 2016 22:36:59\nServer's Module Magic Number: 20120211:52\nServer loaded:  APR 1.5.2, APR-UTIL 1.5.2\nCompiled using: APR 1.5.2, APR-UTIL 1.5.2\nArchitecture:   64-bit\nServer MPM:     prefork\n  threaded:     no\n    forked:     yes (variable process count)\nServer compiled with....\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=256\n -D HTTPD_ROOT=\"/etc/httpd\"\n -D SUEXEC_BIN=\"/usr/sbin/suexec\"\n -D DEFAULT_PIDLOG=\"/run/httpd/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"\n\n$ cat /etc/redhat-release\nCentOS Linux release 7.2.1511 (Core)", "id": 194689, "time": "2016-10-27T13:43:22Z", "creator": "axot@msn.com", "creation_time": "2016-10-27T13:43:22Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 60313, "attachment_id": null, "id": 194690, "time": "2016-10-27T13:51:41Z", "creator": "axot@msn.com", "creation_time": "2016-10-27T13:51:41Z", "is_private": false, "text": "Actual behavior\n---------------\n1477576164\t20161027\t224924\t-\t300\t20197465\t20\t200\t-\t127.0.0.1\ttest.server.com POST /errors/test HTTP/1.1\t-\t-\t-\t-\tnc\t-\t-\t-\t-errors\ttest\t-\n\nHTTP/1.1 200 OK\nDate: Thu, 27 Oct 2016 13:49:24 GMT\nServer: Apache\nCharset: x-user-defined\nContent-Length: 300\nConnection: close\nContent-Type: application/x-msgpack"}, {"count": 2, "text": "This has been fixed in trunk (r1739201), will propose a backport to 2.4 shortly.", "bug_id": 60313, "is_private": false, "id": 194692, "time": "2016-10-27T23:39:54Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2016-10-27T23:39:54Z", "tags": [], "attachment_id": null}, {"count": 3, "tags": [], "creator": "axot@msn.com", "text": "--- modules/http/http_filters.c 2016-10-28 14:44:05.977805795 +0900\n+++ modules/http/http_filters.c 2016-10-28 14:44:34.470100476 +0900\n@@ -1401,9 +1401,9 @@\n     case APR_ENOTIMPL: {\n         return HTTP_NOT_IMPLEMENTED;\n     }\n-    case APR_ETIMEDOUT: {\n+    case APR_TIMEUP:\n+    case APR_ETIMEDOUT:\n         return HTTP_REQUEST_TIME_OUT;\n-    }\n     default: {\n         return status;\n     }\n\nI made a patch like this, and recompiled apache 2.24.18.\nIt seems not fixed in this case.\nDid I missed something?", "id": 194694, "time": "2016-10-28T06:39:22Z", "bug_id": 60313, "creation_time": "2016-10-28T06:39:22Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "ylavic.dev@gmail.com", "attachment_id": null, "text": "How does your application read the body, through mod_php, mod_[proxy_f]cgi[d], or?\n\nThis patch makes the core http filter return a 408 (instead of 400 in 2.4.23) for the modules/application to known, but if it's ignored in the first place this won't change anything...", "id": 194695, "time": "2016-10-28T10:24:24Z", "bug_id": 60313, "creation_time": "2016-10-28T10:24:24Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 60313, "text": "What if the body length of apache was received less than Content-Length, should this case return 408 or process the request normally? The test was used mod_php.", "id": 194700, "time": "2016-10-28T14:05:33Z", "creator": "axot@msn.com", "creation_time": "2016-10-28T14:05:33Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 60313, "text": "If the connection has issues (timeout, closed, reset...) before the announced body is fully received (per Content-Length), httpd tells so to the module asking for it (mod_php or whatever).\n\nIf that module (as a request handler) wants httpd to respond with the relevant HTTP error, it simply returns the corresponding ap_map_http_request_error().\nBut if the caller ignores the error, there is nothing httpd can do.\n\nNo builtin httpd module should ignore errors, but mod_php is not maintained by the Apache HTTP server community, and I don't know enough about its internals to tell whether the error is ignored by it or the final application.", "id": 194717, "time": "2016-10-28T22:57:17Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2016-10-28T22:57:17Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 60313, "attachment_id": null, "id": 194728, "time": "2016-10-30T15:00:18Z", "creator": "axot@msn.com", "creation_time": "2016-10-30T15:00:18Z", "is_private": false, "text": "This a mod_php issue, and I found bug report here\nhttps://bugs.php.net/bug.php?id=61471\n\nThank you."}, {"count": 8, "tags": [], "bug_id": 60313, "attachment_id": null, "id": 194827, "time": "2016-11-04T22:39:05Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2016-11-04T22:39:05Z", "is_private": false, "text": "(In reply to Yann Ylavic from comment #2)\n> This has been fixed in trunk (r1739201), will propose a backport to 2.4\n> shortly.\n\nThe reported issue is not httpd's but for completeness, this fix related to timeouts handled by builtin modules was backported to upcoming 2.4.24 (r1768079), should one reach this PR with such issue."}, {"count": 9, "tags": [], "bug_id": 60313, "text": "Hi, I'm working on fixing this bug for mod_php. May I ask a question?\n\nIf we have some codes did not handle the result of `ap_get_brigade`.\n\nwe_do_not_want_modify_this_func() {\n  ...\n  while (ap_get_brigade(r->input_filters, brigade, AP_MODE_READBYTES, APR_BLOCK_READ, len) == APR_SUCCESS) {\n    apr_brigade_flatten(brigade, buf, &len);\n    apr_brigade_cleanup(brigade);\n    tlen += len;\n    if (tlen == count_bytes || !len) {\n      break;\n    }\n    buf += len;\n    len = count_bytes - tlen;\n  }\n  return tlen;\n}\n\nIs it possible to detect the error like this? Or is there a better way to do this?\n\ndetect_error() {\n  ...\n  error = OK;\n  bb = apr_brigade_create(r->pool, r->connection->bucket_alloc);\n  rv = ap_pass_brigade(r->output_filters, bb);\n\n  if (rv != APR_SUCCESS) {\n    if (APR_STATUS_IS_TIMEUP(rv)) {\n      error = ap_map_http_request_error(rv, HTTP_REQUEST_TIME_OUT);\n    } else {\n      error = ap_map_http_request_error(rv, HTTP_BAD_REQUEST);\n    }\n  }\n  return error;\n}\n\nThank you.", "id": 195441, "time": "2016-12-11T13:42:16Z", "creator": "axot@msn.com", "creation_time": "2016-12-11T13:42:16Z", "is_private": false, "attachment_id": null}]