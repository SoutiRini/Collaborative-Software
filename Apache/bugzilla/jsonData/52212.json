[{"count": 0, "tags": [], "bug_id": 52212, "attachment_id": null, "id": 151638, "time": "2011-11-18T23:12:04Z", "creator": "keith@burdis.org", "creation_time": "2011-11-18T23:12:04Z", "is_private": false, "text": "Sending a request via a mod_proxy reverse proxy to an https backend results in a segfault. This is a similar issue to bug 24030 in that the segfault also occurs in ssl_callback_proxy_cert calling the modssl_set_cert_info() macro:\n\n   #define modssl_set_cert_info(info, cert, pkey) \\\n       *cert = info->x509; \\\n       X509_reference_inc(*cert); \\\n       *pkey = info->x_pkey->dec_pkey; \\\n       EVP_PKEY_reference_inc(*pkey)\n\nexcept that instead of info->x_pkey being NULL, it is info->x_pkey->dec_pkey (the private key data) that is NULL.\n\n(gdb) p *info                                                                                 $1 = {x509 = 0xcb2140, crl = 0x0, x_pkey = 0xcaf490, enc_cipher = {cipher = 0x0,                  iv = \"?\\\"?\\000\\000\\000\\000\\000?\\t?\\000\\000\\000\\000\"}, enc_len = 0, enc_data = 0x0,          references = 1}                                                                             (gdb) set print pretty on\n(gdb) p info->x_pkey->dec_pkey\n$5 = (EVP_PKEY *) 0x0\n(gdb) c\nContinuing.\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x0000002a96f10e82 in CRYPTO_add_lock (pointer=0x8, amount=1, type=5,\n    file=0x2a96fbdd7f \"ssl_engine_kernel.c\", line=1698) at cryptlib.c:630\n^Z^Z/app/home/calrn13t/dl/openssl-1.0.0e/crypto/cryptlib.c:630:18583:beg:0x2a96f10e82\n(gdb) bt\n#0  0x0000002a96f10e82 in CRYPTO_add_lock (pointer=0x8, amount=1, type=5,\n    file=0x2a96fbdd7f \"ssl_engine_kernel.c\", line=1698) at cryptlib.c:630\n#1  0x0000002a96edd0a3 in ssl_callback_proxy_cert (ssl=0xcbc710, x509=0x7fbfffea28,\n    pkey=0x7fbfffea30) at ssl_engine_kernel.c:1698\n#2  0x0000002a96f09deb in ssl_do_client_cert_cb (s=0xcbc710, px509=0x7fbfffea28,\n    ppkey=0x7fbfffea30) at s3_clnt.c:3048\n#3  0x0000002a96f09e89 in ssl3_send_client_certificate (s=0xcbc710) at s3_clnt.c:2812\n#4  0x0000002a96f0a378 in ssl3_connect (s=0xcbc710) at s3_clnt.c:373\n...\n\nI initially avoided the segfault by modifying the fix for bug 24030 to check x_pkey->dec_pkey as well:\n\n--- a/httpd-2.2.21/modules/ssl/ssl_engine_init.c\n+++ b/httpd-2.2.21/modules/ssl/ssl_engine_init.c\n@@ -1006,7 +1006,7 @@ static void ssl_init_proxy_certs(server_rec *s,\n     for (n = 0; n < ncerts; n++) {\n         X509_INFO *inf = sk_X509_INFO_value(sk, n);\n\n-        if (!inf->x509 || !inf->x_pkey) {\n+        if (!inf->x509 || !inf->x_pkey || !inf->x_pkey->dec_pkey) {\n             sk_X509_INFO_free(sk);\n             ap_log_error(APLOG_MARK, APLOG_STARTUP, 0, s,\n                          \"incomplete client cert configured for SSL proxy \"\n\nwhich resulted in a:\n\n  incomplete client cert configured for SSL proxy (missing or encrypted private key?)\n\nerror on startup, which was an improvement.\n\nFurther investigation using gdb and testing showed that having the private key before the certificate in SSLProxyMachineCertificateFile was triggering the segfault.  Changing this file to have the certificate first resolved the issue.\n\nI'd suggest applying the above patch to avoid the segfault and at least updating the SSLProxyMachineCertificateFile documentation to say that the certificate should come before the private key.\n\nNote that this issue does not occur in Apache/2.2.11 with OpenSSL/0.9.8k but does also occur in Apache/2.2.17 with OpenSSL/1.0.0c."}, {"count": 1, "tags": [], "creator": "orion@cora.nwra.com", "text": "Seeing this on EL6 with mod_ssl-2.2.15-15.sl6.1.i686", "id": 161476, "time": "2012-08-16T22:28:52Z", "bug_id": 52212, "creation_time": "2012-08-16T22:28:52Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 52212, "attachment_id": null, "id": 161478, "creation_time": "2012-08-17T12:00:58Z", "time": "2012-08-17T12:00:58Z", "creator": "jorton@redhat.com", "text": "Thanks for the patch, Keith. \n\nI've committed this with an added check that the keypair actually matches.\n\nr1374214", "is_private": false}, {"count": 3, "tags": [], "bug_id": 52212, "attachment_id": null, "text": "(In reply to comment #0)\n> Further investigation using gdb and testing showed that having the private\n> key before the certificate in SSLProxyMachineCertificateFile was triggering\n> the segfault.  Changing this file to have the certificate first resolved the\n> issue.\n> \n> I'd suggest applying the above patch to avoid the segfault and at least\n> updating the SSLProxyMachineCertificateFile documentation to say that the\n> certificate should come before the private key.\n> \n> Note that this issue does not occur in Apache/2.2.11 with OpenSSL/0.9.8k but\n> does also occur in Apache/2.2.17 with OpenSSL/1.0.0c.\n\nThis observation is correct. It's actually caused by a regression in OpenSSL 1.0.0 and later, as reported here, in the meantime:\n\n  http://rt.openssl.org/Ticket/Display.html?user=guest&pass=guest&id=3028\n\nWith OpenSSL up to 0.9.8, the order doesn't matter. In this case, however, the check for encrypted private keys is insufficient, as found when dealing with bug 54698.\n\nAn additional fix has been committed to trunk in r1467593. Backport proposals for 2.2.x and 2.4.x submitted with r1467594.", "id": 166572, "time": "2013-04-13T11:39:20Z", "creator": "asfbugz@velox.ch", "creation_time": "2013-04-13T11:39:20Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 52212, "attachment_id": null, "text": "Backported to v2.4.", "id": 166899, "time": "2013-04-27T22:20:05Z", "creator": "minfrin@sharp.fm", "creation_time": "2013-04-27T22:20:05Z", "is_private": false}, {"count": 5, "tags": [], "creator": "asfbugz@velox.ch", "attachment_id": null, "id": 166985, "time": "2013-05-01T06:19:09Z", "bug_id": 52212, "creation_time": "2013-05-01T06:19:09Z", "is_private": false, "text": "Commit for 2.4.x: r1476685. To appear in 2.4.5."}, {"count": 6, "tags": [], "bug_id": 52212, "attachment_id": null, "text": "(In reply to Kaspar Brand from comment #3)\n> It's actually caused by a regression in OpenSSL\n> 1.0.0 and later, as reported here, in the meantime:\n> \n>   http://rt.openssl.org/Ticket/Display.html?user=guest&pass=guest&id=3028\n\nWill be fixed with the next OpenSSL releases, i.e. 1.0.0l, 1.0.1f and 1.0.2 (committed to the repository in early August).", "id": 171428, "time": "2013-11-24T09:43:33Z", "creator": "asfbugz@velox.ch", "creation_time": "2013-11-24T09:43:33Z", "is_private": false}]