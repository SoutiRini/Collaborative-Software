[{"count": 0, "tags": [], "creator": "palmercox@gmail.com", "attachment_id": null, "id": 182103, "time": "2015-03-26T00:25:41Z", "bug_id": 57761, "creation_time": "2015-03-26T00:25:41Z", "is_private": false, "text": "The following program won't work on Tomcat's WebSocket client jars, both 8.0.20 and Trunk:\n\npublic class App2 {\n    @ClientEndpoint\n    public static class Client {\n        @OnOpen\n        public void onOpen(Session s) throws Exception {\n            System.out.println(\"Sending PING\");\n            s.getBasicRemote().sendText(\"PING\");\n        }\n\n        @OnMessage\n        public void onMessage(Session s, String msg) throws Exception {\n            System.out.println(\"GOT: \" + msg);\n            Thread.sleep(1000);\n            s.getBasicRemote().sendText(\"PING\");\n            System.out.println(\"Sending PING\");\n        }\n    }\n\n    public static void main(final String[] args) throws Exception {\n        ContainerProvider.getWebSocketContainer().connectToServer(\n                Client.class,\n                URI.create(\"ws://echo.websocket.org\"));\n        Thread.sleep(Long.MAX_VALUE);\n    }\n}\n\nIt fails with:\n\nException in thread \"main\" javax.websocket.DeploymentException: The\nHTTP request to initiate the WebSocket connection failed\n    at org.apache.tomcat.websocket.WsWebSocketContainer.connectToServer(WsWebSocketContainer.java:357)\n    at org.apache.tomcat.websocket.WsWebSocketContainer.connectToServer(WsWebSocketContainer.java:164)\n    at org.apache.tomcat.websocket.WsWebSocketContainer.connectToServer(WsWebSocketContainer.java:181)\n    at io.davinci.test_sync_gateway_websocket.App2.main(App2.java:31)\nCaused by: java.io.EOFException\n    at org.apache.tomcat.websocket.WsWebSocketContainer.processResponse(WsWebSocketContainer.java:606)\n    at org.apache.tomcat.websocket.WsWebSocketContainer.connectToServer(WsWebSocketContainer.java:309)\n    ... 3 more\n\n\nIf you add a slash to the end of the URL, however, it connects."}, {"count": 1, "tags": [], "bug_id": 57761, "attachment_id": null, "text": "Without the slash, it would do a redirect and that's likely the cause of the problem. The ws client is not a real HTTP client, and I guess it cannot do many things, including auth, or apparently redirects. I am not convinced using a real HTTP client is mandatory, working only with a server that will do a straight upgrade could be good enough given what the ws API looks like (a non interactive direct connection).\n\nI recommend considering the slash is mandatory.", "id": 182112, "time": "2015-03-26T09:11:16Z", "creator": "remm@apache.org", "creation_time": "2015-03-26T09:11:16Z", "is_private": false}, {"count": 2, "tags": [], "creator": "markt@apache.org", "text": "It isn't the redirec.  The Tomcat client has a bug. It requests \"GET  HTTP/1.1\".", "id": 182117, "time": "2015-03-26T11:08:32Z", "bug_id": 57761, "creation_time": "2015-03-26T11:08:32Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 57761, "attachment_id": null, "id": 182118, "creation_time": "2015-03-26T11:20:05Z", "time": "2015-03-26T11:20:05Z", "creator": "remm@apache.org", "text": "Ah, that's another explanation and easier fix !\n\nMore generally, if it ran into a redirect (like requesting the root of a webapp maybe) or anything besides the upgrade response really, I don't think anything is supported. Did I miss something ? I don't think support is mandatory (should connect directly to a websocket URL, and it is not required to be a full client).", "is_private": false}, {"count": 4, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "id": 182127, "time": "2015-03-26T15:39:20Z", "bug_id": 57761, "creation_time": "2015-03-26T15:39:20Z", "is_private": false, "text": "The empty path in the request line is fixed in r1669353 in trunk, but I also verified that the websocket client cannot handle anything other than an upgrade response, so the same test adapted to a webapp root will fail to process the redirect response.\n\nI don't think it is required that the websocket client is a competent HTTP client, so maybe this bz can be transformed into a more generic enhancement.\n\nI don't think the fix is very useful \"standalone\" without client enhancements so no plan for porting it."}, {"count": 5, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 182129, "time": "2015-03-26T21:01:15Z", "bug_id": 57761, "creation_time": "2015-03-26T21:01:15Z", "is_private": false, "text": "I haven't seen any demand (yet) for handling a redirect. Lets cross that bridge if we come to it.\n\nI've backported your fix to 8.0.x (for 8.0.22 onwards) and 7.0.x (for 7.0.61 onwards)."}]