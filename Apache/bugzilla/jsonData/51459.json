[{"count": 0, "tags": [], "bug_id": 51459, "attachment_id": 27235, "text": "Created attachment 27235\nExcel file for reproducing the issue\n\nTrying to add an image to a worksheet does not actually work in the case of the attached Excel file (repro.xls). There is no error message - the image just won't end up on the worksheet. I could pin the problem down to the second worksheet (note, the image is to be added to first one). If I delete the second worksheet, it works. Originally, there were many more worksheets in the workbook and I tried deleting any of them in succession to detect where the issue is and it seems that exactly the remaining (worksheet 2 in repro.xls) is causing the grief.\n\nThe following is the code to reproduce the issue:\n\nFile f1 = new File(\"repro.xls\");\n        File f2 = new File(\"earthquake.jpg\");\n\n        HSSFWorkbook wb = new HSSFWorkbook(new FileInputStream(f1));\n        InputStream is = new FileInputStream(f2);\n        byte[] bytes = IOUtils.toByteArray(is);\n        int imageIndex = wb.addPicture(bytes, org.apache.poi.ss.usermodel.Workbook.PICTURE_TYPE_JPEG);\n        is.close();\n\n        Name cname = wb.getName(\"Test\");\n        Sheet sheet = wb.getSheet(cname.getSheetName());\n\n        AreaReference aref = new AreaReference(cname.getRefersToFormula());\n        CellReference topLeft = aref.getFirstCell();\n        CellReference bottomRight = aref.getLastCell();\n\n        Drawing drawing = null;\n        drawing = ((HSSFSheet)sheet).getDrawingPatriarch();\n        if(drawing == null) {\n            drawing = sheet.createDrawingPatriarch();\n        }\n\n        CreationHelper helper = wb.getCreationHelper();\n        ClientAnchor anchor = helper.createClientAnchor();\n        anchor.setRow1(topLeft.getRow());\n        anchor.setCol1(topLeft.getCol());\n        anchor.setRow2(bottomRight.getRow() + 1);\n        anchor.setCol2(bottomRight.getCol() + 1);\n        anchor.setAnchorType(ClientAnchor.DONT_MOVE_AND_RESIZE);\n\n        drawing.createPicture(anchor, imageIndex);\n\n        FileOutputStream fos = new FileOutputStream(f1, false);\n        wb.write(fos);\n        fos.close();\n\n\nI'm using POI 3.8-beta3 with a 64-bit JDK 1.6.0_20 on Windows 7 64-bit.", "id": 147667, "time": "2011-07-01T10:41:51Z", "creator": "martin.studer@mirai-solutions.com", "creation_time": "2011-07-01T10:41:51Z", "is_private": false}, {"count": 1, "tags": [], "creator": "martin.studer@mirai-solutions.com", "attachment_id": 27236, "id": 147668, "time": "2011-07-01T10:42:31Z", "bug_id": 51459, "creation_time": "2011-07-01T10:42:31Z", "is_private": false, "text": "Created attachment 27236\nImage file used for reproducing the issue"}, {"attachment_id": null, "tags": [], "bug_id": 51459, "text": "You seem to be trying to add to an existing drawing patriarch, which doesn't work for hssf (except in a very small number of cases)\n\nIf you want to add pictures, you need to start with a workbook with none in it, and then add them all in one go. See http://poi.apache.org/spreadsheet/quick-guide.html#Images\n\n(We'd love for HSSF to be able to edit existing pictures, but it's a massive amount of work and alas no-one has been willing so far to do it...)", "count": 2, "id": 147669, "time": "2011-07-01T10:47:56Z", "creator": "apache@gagravarr.org", "creation_time": "2011-07-01T10:47:56Z", "is_private": false}]