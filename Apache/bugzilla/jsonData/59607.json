[{"count": 0, "tags": [], "creator": "felix.draxler@sap.com", "attachment_id": 33856, "id": 191132, "time": "2016-05-20T08:12:25Z", "bug_id": 59607, "creation_time": "2016-05-20T08:12:25Z", "is_private": false, "text": "Created attachment 33856\nJMeter log file\n\nSummary:\nLoading a very large test case crashes JMeter.\n\nSteps to reproduce:\n1) Generate a very large test case (> Integer.MAX_VALUE bytes or > 2.15GB).\n2) Load it with JMeter (it's faster in non-GUI mode).\n\nExpected result:\nJMeter loads the test case after some time, then executes it.\n\nCurrent result:\nJMeter crashes, throwing a NegativeArraySizeException in BufferedInputStream. See the appended jmeter.log file."}, {"count": 1, "tags": [], "creator": "felix.draxler@sap.com", "attachment_id": null, "id": 191133, "time": "2016-05-20T08:13:05Z", "bug_id": 59607, "creation_time": "2016-05-20T08:13:05Z", "is_private": false, "text": "Error analysis:\nWhy does this occur?\n\n1) JMeter's SaveService#readTree wraps the InputStream it receives in a BufferedInputStream (BIS).\n\n2) It then tells the BIS to save all read data in memory up to a size of Integer.MAX_VALUE by calling reader.mark(Integer.MAX_VALUE).\n\n3) XStream successfully reads in bytes from the BIS. As requested in 2), the BIS saves all the bytes read into an array buffer.\n\n4) As the file is large, the BIS at some point calculates a buffer size exceeding the integer range. This integer is mapped to a negative value (integer overflow).\n\n5) BIS tries to allocate a byte buffer with this negative size, yielding the error."}, {"count": 2, "tags": [], "bug_id": 59607, "attachment_id": null, "text": "In my understanding of SaveService#readTree, the BIS wrapping was introduced to fall back to the old Avalon format: In case loading the .jmx failed, the BIS was reset to the beginning of the file and the OldSaveService tried loading the file. So the buffer was needed because a FileInputStream normally doesn't support marking.\n\nBug 59064 states that the OldSaveService is now removed from JMeter. Thus, there seems to be no need for the BufferedInputStream wrapping in SaveService#readTree anymore. Why?\n- XStream's XStream#fromXML(InputStream input) doesn't require an input stream that supports jumping in the file (called 'marking').\n- This appears just right: Thinking about the structure of the test plan file format, we never need to jump back in the file: It is simply a dump of a tree without cross-references.", "id": 191134, "time": "2016-05-20T08:21:28Z", "creator": "felix.draxler@sap.com", "creation_time": "2016-05-20T08:21:28Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 59607, "attachment_id": 33857, "is_private": false, "id": 191135, "time": "2016-05-20T09:04:20Z", "creator": "felix.draxler@sap.com", "creation_time": "2016-05-20T09:04:20Z", "text": "Created attachment 33857\nProposed patch\n\nRemove BufferedInputStream wrapper, JMeter can now load very large files."}, {"count": 4, "tags": [], "bug_id": 59607, "attachment_id": null, "text": "Or maybe just remove the mark", "id": 191137, "time": "2016-05-20T09:16:22Z", "creator": "sebb@apache.org", "creation_time": "2016-05-20T09:16:22Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 59607, "text": "Yes, that should also do it.", "count": 5, "id": 191138, "time": "2016-05-20T09:18:19Z", "creator": "felix.draxler@sap.com", "creation_time": "2016-05-20T09:18:19Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 59607, "attachment_id": null, "text": "Author: pmouawad\nDate: Mon May 30 19:42:27 2016\nNew Revision: 1746175\n\nURL: http://svn.apache.org/viewvc?rev=1746175&view=rev\nLog:\nBug 59607 - JMeter crashes when reading large test plan (greater than 2g)\nBugzilla Id: 59607\n\nModified:\n    jmeter/trunk/src/core/org/apache/jmeter/save/SaveService.java\n    jmeter/trunk/xdocs/changes.xml", "id": 191324, "time": "2016-05-30T19:42:45Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2016-05-30T19:42:45Z", "is_private": false}, {"count": 7, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": null, "id": 191325, "time": "2016-05-30T19:52:20Z", "bug_id": 59607, "creation_time": "2016-05-30T19:52:20Z", "is_private": false, "text": "Thanks for analysis.\nBug has been fixed in nightly build:\n- http://jmeter.apache.org/nightly.html\n\nIf you can test and give feedback it would be nice.\nThanks"}, {"count": 8, "tags": [], "bug_id": 59607, "attachment_id": null, "text": "Yes, works. Thanks for including the fix!", "id": 191517, "time": "2016-06-10T08:09:24Z", "creator": "felix.draxler@sap.com", "creation_time": "2016-06-10T08:09:24Z", "is_private": false}]