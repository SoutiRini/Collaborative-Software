[{"count": 0, "tags": [], "text": "The current SXSSF implementation uses temp files and this is problematic for companies who want all their data at rest to be encrypted.\nhttps://bz.apache.org/bugzilla/show_bug.cgi?id=59841 added support for developers to use their own implementations of ZipEntrySource when reading inro XSSF workbook. I have my own subclass of this that encrypts the temp file data.\nThe ZipEntrySource interface is read only but it would be feasible to have support for a writer to create ZipEntrySources too (eg something like org.apache.poi.poifs.crypt.TestSecureTempZip).\norg.apache.poi.xssf.streaming.SheetDataWriter exposes the temp file via its public API. If we were able to deprecate this and just provide Readers and Writers, then this could also be subclassed to have the data in the temp file encrypted. We could also allow a pattern where the readers and writers could be decorated with encryptors/decryptors.", "is_private": false, "bug_id": 60153, "id": 193839, "time": "2016-09-20T12:40:18Z", "creator": "fanningpj@yahoo.com", "creation_time": "2016-09-20T12:40:18Z", "attachment_id": null}, {"count": 1, "tags": [], "text": "I have a sample of what I'd like to change in https://github.com/pjfanning/poi/commit/72f0ada28f17b0079d296fa6dbc98d3b76b058a3\n\nI can add test cases to demonstrate the ability to plug in custom temp file implementations to override the use of simple temp files.\nBy subclassing this version of SXSSFWorkbook, developers can replace the temp file behaviour in write(OutputStream stream) with a custom ZipEntrySource (see org.apache.poi.poifs.crypt.TestSecureTempZip) before calling injectData.\ncreateSheetDataWriter() can be overriden to return a subclass of SheetDataWriter that overrides the decorateInputStream snd decorateOutputStream methods I've added.", "attachment_id": null, "id": 193861, "creator": "fanningpj@yahoo.com", "time": "2016-09-20T21:47:30Z", "bug_id": 60153, "creation_time": "2016-09-20T21:47:30Z", "is_private": false}, {"count": 2, "tags": [], "creator": "fanningpj@yahoo.com", "attachment_id": 34284, "id": 193863, "time": "2016-09-20T23:23:57Z", "bug_id": 60153, "creation_time": "2016-09-20T23:23:57Z", "is_private": false, "text": "Created attachment 34284\n[PATCH] open up SXSSF classes so that they can be subclassed"}, {"count": 3, "attachment_id": null, "bug_id": 60153, "is_private": false, "id": 193872, "time": "2016-09-21T03:42:44Z", "creator": "onealj@apache.org", "creation_time": "2016-09-21T03:42:44Z", "tags": [], "text": "The patch from comment 2 looks good to me, including the relevant unit tests :) I committed SXSSFWorkbook#flushSheets() to get the ball rolling in r1761668.\n\nCan someone else review this patch to make sure this implementation doesn't write unencrypted data to disk and is unlikely to be the source of a security vulnerability?"}, {"attachment_id": 34286, "tags": [], "bug_id": 60153, "is_private": false, "count": 4, "id": 193884, "time": "2016-09-21T09:30:26Z", "creator": "fanningpj@yahoo.com", "creation_time": "2016-09-21T09:30:26Z", "text": "Created attachment 34286\n[PATCH] open up SXSSF classes so that they can be subclassed\n\nupdated patch based on Javen's commit and tidied up some issues"}, {"attachment_id": null, "tags": [], "bug_id": 60153, "text": "I am assuming a lazy consensus that there are no security issues with this implementation. Most of the crypto code has been around in TestSecureTempZip for a while anyway. This patch just makes that code available to developers by moving it into the main library.\n\nI applied your patch from comment 4 with a one minor change in r1763943.\n1. provide protected or public accessor methods rather than elevating visibility of private variables. This gives us more freedom in the future to consolidate code between HSSF, XSSF, and SXSSF.\n\nRemaining questions:\n\n1. In AesZipFileZipEntrySource, should the close method do nothing if the object has already been closed (guard the code with an if (closed)?\n2. TestSecureTempZip demonstrates how to read an AES-encrypted XSSFWorkbook and TestSXSSFWorkbookWithCustomZipEntrySource demonstrates how to write an SXSSFWorkbook using encrypted temporary files, but we don't have an example for writing an SXSSFWorkbook where both temporary files and the saved workbook are AES-encrypted. Would you be willing to provide a code example or unit test for this?", "count": 5, "id": 194255, "time": "2016-10-09T04:51:35Z", "creator": "onealj@apache.org", "creation_time": "2016-10-09T04:51:35Z", "is_private": false}, {"count": 6, "tags": [], "text": "3. Can you write a unit test that demonstrates that temporary files created by SXSSFWorkbook are encrypted?", "is_private": false, "bug_id": 60153, "id": 194256, "time": "2016-10-09T04:54:19Z", "creator": "onealj@apache.org", "creation_time": "2016-10-09T04:54:19Z", "attachment_id": null}, {"count": 7, "tags": [], "creator": "fanningpj@yahoo.com", "attachment_id": null, "id": 194263, "time": "2016-10-09T08:27:02Z", "bug_id": 60153, "creation_time": "2016-10-09T08:27:02Z", "is_private": false, "text": "(In reply to Javen O'Neal from comment #6)\n> 3. Can you write a unit test that demonstrates that temporary files created\n> by SXSSFWorkbook are encrypted?\n\nThanks Javen. I can look at the 3 topics you highlighted and I can attach a new patch file over the coming days."}, {"attachment_id": 34346, "tags": [], "bug_id": 60153, "is_private": false, "count": 8, "id": 194268, "time": "2016-10-09T10:32:11Z", "creator": "fanningpj@yahoo.com", "creation_time": "2016-10-09T10:32:11Z", "text": "Created attachment 34346\nExtra test cases for encrypted temp data"}, {"count": 9, "tags": [], "text": "Thanks for the prompt patches! Applied in r1763969.\n\nIf you have any other unit tests you would like to add, please reopen this bug.", "is_private": false, "bug_id": 60153, "id": 194277, "time": "2016-10-09T13:00:30Z", "creator": "onealj@apache.org", "creation_time": "2016-10-09T13:00:30Z", "attachment_id": null}, {"count": 10, "tags": [], "text": "Would you be interested in writing a few sentences to add to the Encryption documentation https://poi.apache.org/encryption.html\n\nThe documentation source lives here: https://svn.apache.org/viewvc/poi/site/src/documentation/content/xdocs/encryption.xml?view=log", "is_private": false, "bug_id": 60153, "id": 194291, "time": "2016-10-09T23:58:10Z", "creator": "onealj@apache.org", "creation_time": "2016-10-09T23:58:10Z", "attachment_id": null}, {"count": 11, "tags": [], "bug_id": 60153, "text": "Hi Javen,\nI can look at putting together some doc and related sample code.\nCould take a few days.", "id": 194301, "time": "2016-10-10T12:58:00Z", "creator": "fanningpj@yahoo.com", "creation_time": "2016-10-10T12:58:00Z", "is_private": false, "attachment_id": null}]