[{"text": "Full description here http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=528062\n\nThis bug was also present in mod_ldap_userdir but its author solved it using similar patch.\n\n\nI have apache2 configured with mod_userdir + mod_suexec + mod_fcgid (for\nruning php5-cgi in my case).\n\n\nAccording to http://httpd.apache.org/docs/2.2/suexec.html#usage\nhandling of /~baryluk/ should automagically work (by working, I mean fcgid scripts\nare run under uid baryluk).\n\n\nCurrently this scripts are run under the www-data uid, because\nas I first written mod_userdir.c is not working correctly (not to be honest,\nnot well tested - this error is sitting there very very long).\n\n\nHere is my exact (i hope) configuration attached:\n\n# apt-get install apache2 apache2-suexec libapache2-mod-fcgid php5-cgi\n# a2enmod actions suexec userdir fcgid\n\nRelevant files in attachment\n\n/etc/apache2/sites-available/default\n/etc/apache2/conf.d/php-fcgid.conf\n\n/home/baryluk/public_html/test.php\n/home/baryluk/public_html/fcgi-bin/php-fcgi-wrapper\n/home/baryluk/public_html/.htaccess\n(edit the last one if other username needed)\n\n# chown -R baryluk:users /home/baryluk/public_html\n\n# /etc/init.d/apache2 restart\n\nThen point your web browser to http://servername/~baryluk/test.php\n\nYou will see, `whoami` output one the first line. It will say\n\"www-data\", but should say \"baryluk\".\n\nThis simply mean that suexec support in userdir is not working\ncorrectly.\n\n\nPatch in first post resolves this problem. There was identical problem\nin ldap-userdir, but is already solved there in the same way.\n\n\nAll patches against 2.2.11 at address http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=528062\n\nPlease at least comment this, as Debian maintainers doesn't seems to be interested.\n\nThis need to be fixed in code or in documentation.\n\nThanks you.", "tags": [], "bug_id": 49439, "is_private": false, "count": 0, "id": 137637, "time": "2010-06-14T17:20:48Z", "creator": "baryluk@smp.if.uj.edu.pl", "creation_time": "2010-06-14T17:20:48Z", "attachment_id": null}, {"text": "Here is a patch for better reference with comments:\n\n--- ./modules/mappers/mod_userdir.c\t2006-07-12 05:38:44.000000000 +0200\n+++ ../mod_userdir.c\t2009-05-10 17:38:36.048667150 +0200\n@@ -186,9 +186,11 @@\n     const userdir_config *s_cfg;\n     char *name = r->uri;\n     const char *userdirs;\n+    request_rec *notes_req;\n     const char *w, *dname;\n     char *redirect;\n     apr_finfo_t statbuf;\n+    \n \n     /*\n      * If the URI doesn't match our basic pattern, we've nothing to do with\n@@ -312,8 +314,17 @@\n             if (*userdirs && dname[0] == 0)\n                 r->finfo = statbuf;\n \n+            /* We could be servicing a sub-request; make sure we put notes\n+             * on the main request.\n+             */\n+            if (r->main) {\n+                notes_req = r->main;\n+            } else {\n+                notes_req = r;\n+            }\n+\n             /* For use in the get_suexec_identity phase */\n-            apr_table_setn(r->notes, \"mod_userdir_user\", w);\n+            apr_table_setn(notes_req->notes, \"mod_userdir_user\", w);\n \n             return OK;\n         }", "tags": [], "creator": "baryluk@smp.if.uj.edu.pl", "is_private": false, "count": 1, "id": 137638, "time": "2010-06-14T17:23:05Z", "bug_id": 49439, "creation_time": "2010-06-14T17:23:05Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 49439, "attachment_id": null, "text": "Just tested that patch applies cleanly to 2.2.15.", "id": 137680, "time": "2010-06-16T09:16:13Z", "creator": "baryluk@smp.if.uj.edu.pl", "creation_time": "2010-06-16T09:16:13Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 49439, "is_private": false, "text": "Should I reassign it to mod_suexec possibly?", "id": 137918, "time": "2010-06-25T20:30:22Z", "creator": "baryluk@smp.if.uj.edu.pl", "creation_time": "2010-06-25T20:30:22Z", "attachment_id": null}, {"text": "thanks for the patch. i installed it on centos v5.5, apache v2.2, php v5.2.13. after restarting apache i still get 500 error when using /~username and suexec enabled. i am running PHP as fcgi. however, running php as mod_php (DSO) or suPHP doesn't cause the 500 error.\n\nthanks,\njohn", "tags": [], "bug_id": 49439, "is_private": false, "count": 4, "id": 138129, "time": "2010-07-04T15:11:28Z", "creator": "johnharre@cronsystems.net", "creation_time": "2010-07-04T15:11:28Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 49439, "is_private": false, "text": "thanks for the patch. i installed it on centos v5.5, apache v2.2, and php v5.2.13. i restarted apache and still get 500 error. my PHP is using fast cgi.", "id": 138130, "time": "2010-07-04T15:24:50Z", "creator": "johnharre@cronsystems.net", "creation_time": "2010-07-04T15:24:50Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 49439, "attachment_id": null, "text": "(In reply to comment #5)\n> thanks for the patch. i installed it on centos v5.5, apache v2.2, and php\n> v5.2.13. i restarted apache and still get 500 error. my PHP is using fast cgi.\n\nThe configuration is quite complicated, this is how I make it working on my system:\n\nI have apache2 configured with mod_userdir + mod_suexec + mod_fcgid (for\nruning php5-cgi in my case).\n\nOn Debian I make:\n\nserver# apt-get install apache2 apache2-suexec libapache2-mod-fcgid php5-cgi\nserver# a2enmod actions suexec userdir fcgid\n\nBe sure to disable mod_php or even uninstall it from system.\nserver# a2dismod php\n\nThen I have edited  /etc/apache2/sites-available/default and ADDED this at the end:\n\n\tSuexecUserGroup www-data www-data\n\t<Directory /var/www>\n\t\tAction php-fcgi /fcgi-bin/php-fcgi-wrapper\n\t</Directory>\n\t<Directory /home/*/public_html/>\n\t\tAllowOverride FileInfo AuthConfig Limit\n\t\tOptions MultiViews Indexes SymLinksIfOwnerMatch IncludesNoExec\n\t\tOrder allow,deny\n\t\tAllow from all\n\t</Directory>\n\tScriptAliasMatch ^/~([^/]*)/fcgi-bin/(.*) /home/$1/public_html/fcgi-bin/$2\n\t<Directory /home/*/public_html/fcgi-bin>\n\t\tAllowOverride None\n\t\tOptions ExecCGI -MultiViews +SymLinksIfOwnerMatch\n\t\tSetHandler fcgid-script\n\t\tOrder allow,deny\n\t\tAllow from all\n\t</Directory>\n\nserver# cat /etc/apache2/conf.d/php-fcgid.conf\n  <IfModule !mod_php4.c>\n  <IfModule !mod_php4_filter.c>\n  <IfModule !mod_php5.c>\n  <IfModule !mod_php5_filter.c>\n  <IfModule !mod_php5_hooks.c>\n  <IfModule mod_actions.c>\n  <IfModule mod_alias.c>\n  <IfModule mod_mime.c>\n  <IfModule mod_fcgid.c>\n    # Path to php.ini \u2013 defaults to /etc/phpX/cgi\n    DefaultInitEnv PHPRC=/etc/php5/cgi\n\n    # Number of PHP childs that will be launched. Leave undefined to let PHP decide.\n    #DefaultInitEnv PHP_FCGI_CHILDREN 3\n\n    # Maximum requests before a process is stopped and a new one is launched\n    #DefaultInitEnv PHP_FCGI_MAX_REQUESTS 5000\n\n    # Define a new handler \"php-fcgi\" for \".php\" files, plus the action that must follow\n    AddHandler php-fcgi .php\n    Action php-fcgi /fcgi-bin/php-fcgi-wrapper\n\n    # Define the MIME-Type for \".php\" files\n    AddType application/x-httpd-php .php\n\n    # Define alias \"/fcgi-bin/\". The action above is using this value, which means that\n    # you could run another \"php5-cgi\" command by just changing this alias\n    #Alias /fcgi-bin/ /var/www/fcgi-bin.d/php5-default/\n\n    # Turn on the fcgid-script handler for all files within the alias \"/fcgi-bin/\"\n    <Location /fcgi-bin/>\n        SetHandler fcgid-script\n        Options +ExecCGI\n    </Location>\n  </IfModule>\n  </IfModule>\n  </IfModule>\n  </IfModule>\n  </IfModule>\n  </IfModule>\n  </IfModule>\n  </IfModule>\n  </IfModule>\n\nserver# cat /home/baryluk/public_html/test.php\n  <?php\n  system(\"whoami\");\n  echo \"<br/>\";\n  echo \"<br/>\";\n  system(\"id\");\n  echo \"<br/>\";\n  echo \"<br/>\";\n  phpinfo();\n  ?>\nserver# cat /home/baryluk/public_html/.htaccess\n  Action php-fcgi /~baryluk/fcgi-bin/php-fcgi-wrapper\nserver# cat /home/baryluk/public_html/fcgi-bin/php-fcgi-wrapper\n  #!/bin/sh\n  exec /usr/bin/php5-cgi\nserver# chmod +x /home/baryluk/public_html/fcgi-bin/php-fcgi-wrapper\nserver# chown -R baryluk:users /home/baryluk/public_html\nserver# /etc/init.d/apache2 restart\n\n\n\nIn http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=528062#20 you can find attachmens which can simplify setup.\n\n\nThis setup on stock Apache server, when visiting http://localhost/~baryluk/test.php, works, but shows \"www-data\". After using patch, it shows baryluk, as expected.\n\nI'm using apache2-mpm-worker 2.2.15-5 package and libapache2-mod-fcgid 1:2.3.5-2, php5-cgi 5.3.2-1.\n\n\nApache will run with one process at the \"root\" user, and few workers with \"www-data\". It will also spawn fcgi using suexec when accessing user fcgi scripts, including php in userdirs, if configured as above. Static files in userdir will still be served using \"www-data\" user, so be sure that public_html directory and its content is readable, also when php scripts will create some files, I have ACL for this:\n\nserver# getfacl home/baryluk\n# file: home/baryluk\n# owner: baryluk\n# group: users\nuser::rwx\ngroup::---\ngroup:www-data:--x\nmask::--x\nother::---\n\nserver# getfacl home/baryluk/public_html\n# file: home/baryluk/public_html\n# owner: baryluk\n# group: users\nuser::rwx\ngroup::---\ngroup:www-data:r-x\nmask::rwx\nother::---\ndefault:user::rwx\ndefault:group::---\ndefault:group:www-data:r-x\ndefault:mask::r-x\ndefault:other::---", "id": 138448, "time": "2010-07-15T22:11:07Z", "creator": "baryluk@smp.if.uj.edu.pl", "creation_time": "2010-07-15T22:11:07Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 49439, "attachment_id": null, "text": "Can you give a repro case with the simplest possible configuration for this?\n\nIt's not obvious to me why unconditionally propagating the userdir identity from a subrequest to the main request (which may be of a URI outside userdir-enabled space) is a good idea.", "id": 143617, "time": "2011-01-25T09:08:48Z", "creator": "jorton@redhat.com", "creation_time": "2011-01-25T09:08:48Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 49439, "attachment_id": null, "text": "(In reply to comment #7)\n> Can you give a repro case with the simplest possible configuration for this?\n\nI already given reproduction case. It is very simple case. I cannot minimize it in any way. It really is just few files to be put in clean installation (preferably Debian), with php5-cgi as example and eventually edit them to make username be proper. I can try using pure cgi without fcgi, and trying to run some simple bash cgi, without php if you wish.\n\n> \n> It's not obvious to me why unconditionally propagating the userdir identity\n> from a subrequest to the main request (which may be of a URI outside\n> userdir-enabled space) is a good idea.\n\nThis is exactly a  comment I was waiting for! I was sure that there are some cases it is bad.\n\nAs I understand subrequest will be made on redirect/rewrite or server includes right?\n\nEven then I do not think it is much unsafe, as when using suexec whole server is already running as root, or www-data, which have quite big permission to all files. So changing uid cannot make it worse, in my opinion. It will not give access to more that it already have. (Becuase most often www-data already have read permiossion to most user files). But of course if it would be possible to switch by one user to other's user UID then indeeded, things like deleting others file would be a problem. \n\nWhen this \"switch\" happens?\nOn server includes? (i do not exactly understand what is \"subrequest\" unfortunetly).\nCan subrequests be done recursivly? (subrequest of subrequest?).", "id": 143631, "time": "2011-01-25T14:39:26Z", "creator": "baryluk@smp.if.uj.edu.pl", "creation_time": "2011-01-25T14:39:26Z", "is_private": false}, {"text": ">    ScriptAliasMatch ^/~([^/]*)/fcgi-bin/(.*) /home/$1/public_html/fcgi-bin/$2\n>    Action php-fcgi /fcgi-bin/php-fcgi-wrapper\n\nThis is causing an internal redirect, to hit the fcgi interpreter with an argument of your script, which is not tagged with the userdir identity.\n\nUnclear whether this particular case should find a way to remember, and if that would live in the fastcgi module, userdir, or elsewhere, but I'm sure in general there are cases where the userdir identity should not tag along.", "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "count": 9, "id": 143660, "time": "2011-01-26T09:41:06Z", "bug_id": 49439, "creation_time": "2011-01-26T09:41:06Z", "is_private": false}, {"count": 10, "tags": [], "creator": "centurianii@yahoo.co.uk", "attachment_id": null, "id": 162224, "time": "2012-09-16T21:59:15Z", "bug_id": 49439, "creation_time": "2012-09-16T21:59:15Z", "is_private": false, "text": "Sorry to all but,\n\nI need help to get my server running with mod_userdir: so my question is how do I apply the patch for Apache 2 ???\n\nHere is my post for this issue after overcoming all errors related with suexec and virtual hosts one per domain: http://www.howtoforge.com/forums/showthread.php?p=285160#post285160\nIs it possible to adapt the solution with my proposal at the post of this forum?\n\nI can see plus and minus symbols at the patch. What are they?\nFrom my post you can see that I followed with success Falco's post (http://www.howtoforge.com/how-to-set-up-apache2-with-mod_fcgid-and-php5-on-ubuntu-11.10) which I think is much more elegant than \"Witold Baryluk\" approach.\n\nThank you for any help!\n\nPS: there are other grey areas in Witold Baryluk's post like: \n\".....also when php scripts will create some files, I have ACL for this:\n\nserver# getfacl home/baryluk\n# file: home/baryluk\n.....\"\nACL what???"}, {"count": 11, "tags": [], "creator": "kpietru@poczta.fm", "text": "(In reply to Witold Baryluk from comment #8)\n> (In reply to comment #7)\n> > Can you give a repro case with the simplest possible configuration for this?\n> \n> I already given reproduction case. It is very simple case. I cannot minimize\n> it in any way. It really is just few files to be put in clean installation\n> (preferably Debian), with php5-cgi as example and eventually edit them to\n> make username be proper. I can try using pure cgi without fcgi, and trying\n> to run some simple bash cgi, without php if you wish.\n> \n> > \n> > It's not obvious to me why unconditionally propagating the userdir identity\n> > from a subrequest to the main request (which may be of a URI outside\n> > userdir-enabled space) is a good idea.\n> \n> This is exactly a  comment I was waiting for! I was sure that there are some\n> cases it is bad.\n> \n> As I understand subrequest will be made on redirect/rewrite or server\n> includes right?\n> \n> Even then I do not think it is much unsafe, as when using suexec whole\n> server is already running as root, or www-data, which have quite big\n> permission to all files. So changing uid cannot make it worse, in my\n> opinion. It will not give access to more that it already have. (Becuase most\n> often www-data already have read permiossion to most user files). But of\n> course if it would be possible to switch by one user to other's user UID\n> then indeeded, things like deleting others file would be a problem. \n> \n> When this \"switch\" happens?\n> On server includes? (i do not exactly understand what is \"subrequest\"\n> unfortunetly).\n> Can subrequests be done recursivly? (subrequest of subrequest?).", "id": 183834, "time": "2015-07-01T12:46:34Z", "bug_id": 49439, "creation_time": "2015-07-01T12:46:34Z", "is_private": false, "attachment_id": null}]