[{"count": 0, "attachment_id": null, "bug_id": 26686, "is_private": false, "id": 51767, "time": "2004-02-05T15:54:00Z", "creator": "eblotml@free.fr", "creation_time": "2004-02-05T15:54:00Z", "tags": [], "text": "Using Debian-i386 apache2-mpm-prefork engine;\nUsing mod_ldap (authentication + cache) w/ OpenLDAP 2.1 server;\nUsing mod_ssl (however, the trouble occurs without sollicitating https://);\nUsing PHP 4.3.x or PHP5.0.0b3 (same behaviour);\n\nAfter a couple of hours (< 24 hours), the httpd daemon starts to consume all \nthe available CPU time and deadlock. This is 100% reproducible, even with few \nHTTP requests.\n\nI don't know how to investigate further.\nIf there is a means to help tracking down the issue, please let me know."}, {"count": 1, "tags": [], "bug_id": 26686, "text": "Same trouble occurs with the mpm-worker engine.\n\nAddtionnal information\n\nA ps (or a top) command shows the thread that seems looping around:\n\n19869 ?        S      0:00 /usr/sbin/apache2 -k restart\n19933 ?        S      0:00  \\_ /usr/sbin/apache2 -k restart\n19935 ?        S      0:00      \\_ /usr/sbin/apache2 -k restart\n19939 ?        S      0:01          \\_ /usr/sbin/apache2 -k restart\n19946 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19949 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19950 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19952 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19955 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19956 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19958 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19961 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19962 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19964 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19967 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19968 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19970 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19973 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19974 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19976 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19979 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19980 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19982 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19985 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19986 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19988 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19944 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19943 ?        S      0:00          \\_ /usr/sbin/apache2 -k restart\n19940 ?        R    120:55          \\_ /usr/sbin/apache2 -k restart\n\nGDB shows that this thread is stalled at this point:\n\n(gdb) info stack\n#0  0x40159438 in apr_date_parse_rfc () from /usr/lib/libaprutil-0.so.0\n#1  0x40159608 in apr_date_parse_rfc () from /usr/lib/libaprutil-0.so.0\n#2  0x40159b7c in apr_rmm_calloc () from /usr/lib/libaprutil-0.so.0\n#3  0x40298d2b in util_ald_alloc () from /usr/lib/apache2/modules/mod_ldap.so\n#4  0x402987ea in util_ldap_search_node_copy () from\n/usr/lib/apache2/modules/mod_ldap.so\n#5  0x402992ba in util_ald_cache_insert () from /usr/lib/apache2/modules/mod_ldap.so\n#6  0x40297da2 in util_ldap_cache_checkuserid () from\n/usr/lib/apache2/modules/mod_ldap.so\n#7  0x405449c2 in mod_auth_ldap_check_user_id () from\n/usr/lib/apache2/modules/mod_auth_ldap.so\n#8  0x0808784a in ap_run_check_user_id ()\n#9  0x08088098 in ap_process_request_internal ()\n#10 0x08067755 in ap_process_request ()\n#11 0x080639d5 in _start ()\n#12 0x0807e06a in ap_run_process_connection ()\n#13 0x08072512 in ap_graceful_stop_signalled ()\n#14 0x08072b6f in ap_graceful_stop_signalled ()\n#15 0x4028c85c in apr_threadattr_detach_get () from /usr/lib/libapr-0.so.0\n#16 0x4044ee31 in pthread_start_thread () from /lib/libpthread.so.0\n\nAny idea ?\n\nRegards.", "id": 51871, "time": "2004-02-07T14:52:13Z", "creator": "eblotml@free.fr", "creation_time": "2004-02-07T14:52:13Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 26686, "attachment_id": null, "text": "It seems that the trouble comes from the LDAP module.\n\nApache is able to serve HTTP requests that do not require LDAP authentication,\nwhereas it stalls on any request that involves any LDAP request.\n", "id": 51873, "time": "2004-02-07T14:55:22Z", "creator": "eblotml@free.fr", "creation_time": "2004-02-07T14:55:22Z", "is_private": false}, {"count": 3, "tags": [], "text": "Problem is probably ldap related... stack is trashed and we came through ldap\ncache code and ldap in stable branch has serious issues with the cache.  What\nhappens if you disable the cache?\n\n(Note that ldap in apache 2.1-dev has some cache fixes that have not yet been\nmerged into stable.  Not sure if they resolve all known problems, but they\nhave helped some folks.  It would be great if you could try that.  Grab latest\nldap files from http://cvs.apache.org/viewcvs.cgi/httpd-2.0/modules/experimental/)\n\n", "is_private": false, "id": 51888, "creator": "trawick@apache.org", "time": "2004-02-07T15:15:43Z", "bug_id": 26686, "creation_time": "2004-02-07T15:15:43Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 26686, "text": "With LDAP cache disabled, the problem does not seem to occur.\nI need some time to confirm this workaround. \nThe server is up for about 1 day and 2 hours, and with LDAP cache enabled, the \nserver used to go mad after only 12 hours.\n\nSo you're probably right Jeff: the trouble comes from the LDAP cache.\n\nI will wait for a couple of day to validate this, and try the experimental \nmodule.\n\nThanks for your help !\n", "count": 4, "id": 51979, "time": "2004-02-09T09:18:45Z", "creator": "eblotml@free.fr", "creation_time": "2004-02-09T09:18:45Z", "is_private": false}, {"count": 5, "attachment_id": null, "bug_id": 26686, "is_private": false, "id": 52178, "time": "2004-02-12T11:53:28Z", "creator": "eblotml@free.fr", "creation_time": "2004-02-12T11:53:28Z", "tags": [], "text": "I think I can say the problem definitely comes from the LDAP cache\n\nServer uptime: 4 days 4 hours 58 minutes 30 seconds\nCPU Usage: u87.69 s5.9 cu.94 cs.74 - .0262% CPU load\n\nno trouble.\n\nI shall try the latest LDAP files in a couple of days.\n\n(It might be useful to update this bug summary for further bug tracking, I don't\nknow the policy about this)"}, {"count": 6, "tags": [], "bug_id": 26686, "attachment_id": null, "text": "updating summary/component for latest findings...  need to look through existing\nmod_auth_ldap reports and see if this has already been reported\n", "id": 52183, "time": "2004-02-12T13:24:50Z", "creator": "trawick@apache.org", "creation_time": "2004-02-12T13:24:50Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 26686, "text": "There are many new fixes in v2.1.0-dev - can you give this version a try and\nconfirm whether this problem still exists?\n", "id": 57808, "time": "2004-05-21T14:51:50Z", "creator": "minfrin@sharp.fm", "creation_time": "2004-05-21T14:51:50Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "minfrin@sharp.fm", "is_private": false, "text": "apr_rmm_calloc() should either return a memory block, or return NULL, it should\nnot hang for any reason.\n\nThis is an apr-util bug.", "id": 58068, "time": "2004-05-25T17:33:47Z", "bug_id": 26686, "creation_time": "2004-05-25T17:33:47Z", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 26686, "text": "Do you have details of a specific apr_rmm bug being seen here, or is that just a\nrandom reassignment in the vague hope that it's not really a mod_auth_ldap problem?", "id": 58084, "time": "2004-05-25T19:27:20Z", "creator": "jorton@redhat.com", "creation_time": "2004-05-25T19:27:20Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "text": "Given continued discussion of fundamental LDAP shared caching issues,\nreassigning back.", "is_private": false, "id": 59204, "creator": "jorton@redhat.com", "time": "2004-06-14T22:08:21Z", "bug_id": 26686, "creation_time": "2004-06-14T22:08:21Z", "attachment_id": null}, {"count": 11, "tags": [], "creator": "minfrin@apache.org", "is_private": false, "text": "Can anybody confirm whether this problem is still present?\n", "id": 64523, "time": "2004-10-03T16:09:16Z", "bug_id": 26686, "creation_time": "2004-10-03T16:09:16Z", "attachment_id": null}, {"count": 12, "attachment_id": null, "bug_id": 26686, "is_private": false, "id": 65245, "time": "2004-10-17T18:23:41Z", "creator": "minfrin@apache.org", "creation_time": "2004-10-17T18:23:41Z", "tags": [], "text": "Closing - please reopen if this problem still exists.\n"}, {"count": 13, "tags": [], "bug_id": 26686, "attachment_id": null, "text": "I'm using Apache 2.0.54 as a reverse proxy, and the hangs (as mentioned in the\nfirst mail) keep ocurring. \nI have been debugging with gdb and the process enters an infinite loop in lines\n75,77,80,81 of httpd-2.0.54/srclib/apr-util/misc/apr_rmm.c, with values:\nnext = 14112\n\nsize = 32\n\nblk->size = 0\n\nblk->prev = 7720\n\nblk->next = 14112\nHere is the backtrace:\n#0  0x40024023 in find_block_of_size (rmm=0x404d1008, size=32) at apr_rmm.c:75\n#1  0x4002471f in apr_rmm_calloc (rmm=0x81df660, reqsize=32) at apr_rmm.c:305\n#2  0x08080700 in util_ald_alloc (cache=0x404d1668, size=1078792200) at\nutil_ldap_cache_mgr.c:103\n#3  0x08080cdb in util_ald_cache_insert (cache=0x404d1668, payload=0xbfffb680)\nat util_ldap_cache_mgr.c:401\n#4  0x0807ed89 in util_ldap_cache_checkuserid (r=0x827cd28, ldc=0x8228b50,\nurl=0xbfffb680 \" \u00b7\u00ff\u00bf\u00d0\u00e1'\\b\u00a2\u00e1'\\b\\202(V#\u00d4\",\n    basedn=xxxxxxxx \"dc=xx\", scope=2, attrs=0x8221028, filter=0xbfffb720\n\"(&(objectClass=*)(uid=xxxxx))\",\n    bindpw=0x827e1a2 \"xxxxxx\", binddn=xxxxxxx, retvals=0xbfffb718) at\nutil_ldap.c:950\n#5  0x08081956 in mod_auth_ldap_check_user_id (r=0x827cd28) at mod_auth_ldap.c:360\n#6  0x080d2376 in ap_run_check_user_id (r=0x827cd28) at request.c:70\n#7  0x080d2c76 in ap_process_request_internal (r=0x827cd28) at request.c:217\n#8  0x080ab179 in ap_process_request (r=0x827cd28) at http_request.c:247\n#9  0x080a6cc9 in ap_process_http_connection (c=0x8272488) at http_core.c:251\n#10 0x080c7206 in ap_run_process_connection (c=0x8272488) at connection.c:43\n#11 0x080bb504 in child_main (child_num_arg=3) at prefork.c:610\n#12 0x080bb630 in make_child (s=0x81a7f30, slot=1) at prefork.c:704\n#13 0x080bb8b7 in perform_idle_server_maintenance (p=0x81a2798) at prefork.c:839\n#14 0x080bbebe in ap_mpm_run (_pconf=0x0, plog=0x81e0890, s=0x0) at prefork.c:1040\n#15 0x080c1688 in main (argc=3, argv=0xbfffda54) at main.c:618\n#16 0x402b14a2 in __libc_start_main () from /lib/libc.so.6\n\nI'm using the default values for the cache. As someone mentioned this seems an\napr bug, where do I report it?\nI'm going to see what happens after disabling the cache but, for obvious\nperformance, reasons I would like help in fixing the bug to reenable chacheing.\n\n\nRegards,\n\nlmeiners >><at><< cybsec.com", "id": 80009, "time": "2005-09-15T22:53:27Z", "creator": "lmeiners@cybsec.com", "creation_time": "2005-09-15T22:53:27Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 26686, "text": "There have been a number of ldap cache corruption fixes since 2.0.54; can you\ntry this patch:\n\n  http://people.apache.org/~jorton/httpd-2.0.54-ldap.patch\n\nIf you still see crashes with this applied can you obtain a new backtrace and\npost that along with the exact ldap config you're using.", "id": 80014, "time": "2005-09-15T23:55:11Z", "creator": "jorton@redhat.com", "creation_time": "2005-09-15T23:55:11Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "bug_id": 26686, "text": "And you should also remember to add yourself to the CC list when posting to bugs! :)", "id": 80015, "time": "2005-09-15T23:57:42Z", "creator": "jorton@redhat.com", "creation_time": "2005-09-15T23:57:42Z", "is_private": false, "attachment_id": null}, {"count": 16, "tags": [], "bug_id": 26686, "text": "No activity in years, and 2.2 has at least one fix that could cause apr_rmm to spin.", "id": 142363, "time": "2010-12-04T07:15:16Z", "creator": "covener@gmail.com", "creation_time": "2010-12-04T07:15:16Z", "is_private": false, "attachment_id": null}]