[{"count": 0, "tags": [], "creator": "nicolas@kessler.cx", "attachment_id": null, "text": "When preferred languages contain a country code, then mod_negotiation ignores \nthe preference if the corresponding AddLanguage entry in httpd.conf comes \n*before* an AddLanguage entry without country-code extension.\n\nExample:\n\nIn httpd.conf we have\n\nAddLanguage de-ch .de\nAddLanguage de .de\n\nand the browser requests: \n\nAccept-Language: de-ch,fr;q=0.7,de;q=0.3\n\nthen French is served. If the order is\n\nAddLanguage de .de\nAddLanguage de-ch .de\n\nthen German is served. \n\nThis is not the expected behavior and unwelcome, because the order of the \nAddLanguage statement changes the Content-Language header (which obviously \nmust be determined by the site and not made dependent on language negotiation).", "id": 75269, "time": "2005-05-24T11:57:59Z", "bug_id": 35039, "creation_time": "2005-05-24T11:57:59Z", "is_private": false}, {"count": 1, "tags": [], "creator": "slive@apache.org", "attachment_id": null, "text": "I haven't looked into this problem in detail, but I believe you are\nmisdiagnosing it.\n\nThe problem, I believe, is that you can't assign more than one language to a\nfile with AddLanguage.  The second AddLanguage *replaces* the first one, it\ndoesn't add to it.\n\nI don't personally know of any way to assign more than one language to a file\nfor negotiation purposes.  You could try\nAddLanguage \"de,de-ch\" .de\nwhich will probably create a valid Content-Language header, but I don't know\nwhat mod_negotiation will do with it.  I'd have to check the code.\n", "id": 75281, "time": "2005-05-24T19:12:49Z", "bug_id": 35039, "creation_time": "2005-05-24T19:12:49Z", "is_private": false}, {"count": 2, "tags": [], "creator": "nd@perlig.de", "attachment_id": null, "text": "Nope, but the comma variant works in a type map (Content-Language:). Further you\ncould use more than one extension:\n\nAddLanguage de .de\nAddLanguage de-ch .de-ch\n\nAnd then have foo.de.de-ch, which would be of language de and de-ch.\n\n-> marking invalid.", "id": 75283, "time": "2005-05-24T19:22:22Z", "bug_id": 35039, "creation_time": "2005-05-24T19:22:22Z", "is_private": false}, {"count": 3, "tags": [], "creator": "nicolas@kessler.cx", "attachment_id": null, "text": "I see - so the documented behavior (http://httpd.apache.org/docs-\n2.0/mod/mod_mime.html#addlanguage, paragraph \"If multiple language assignments \nare made for the same extension...\"), while technically correct, is somewhat \nmisleading, because multiple entries like\n\nAddLanguage en .en\nAddLanguage en-gb .en\nAddLanguage en-us .en \n\nwould be completely useless. My (apparently incorrect) interpretation was that \nthe last entry decides on the Content-Language header and that the entries are \ncomplementary.\n\nSo there is no way, using MultiViews, to treat \"de\" and \"de-CH\" as equivalent \nlanguages without changing filenames? I will end up with index.html.de.de-ch-\nde-at.de-li.de-lu :-)", "id": 75286, "time": "2005-05-24T20:51:37Z", "bug_id": 35039, "creation_time": "2005-05-24T20:51:37Z", "is_private": false}, {"count": 4, "tags": [], "creator": "slive@apache.org", "attachment_id": null, "text": "In my opinion, an enhancement request for\nAddLanguage \"de,de-ch,de-at,de-li,de-lu\" .de\nto be properly handled by mod_negotiation would be interesting.  But I don't\nknow of anyone prepared to contribute the appropriate code.\n\nBut it also seems a little silly to be marking a document in that way.  It seems\nthat your document must really be in one language, and you want to mark all\nthese languages simply to get around client preferences that you don't like. \nThat doesn't seem like the right thing to do.  The clients have expressed\nlanguage preferences for a reason.\n\n", "id": 75288, "time": "2005-05-24T21:58:05Z", "bug_id": 35039, "creation_time": "2005-05-24T21:58:05Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 35039, "attachment_id": null, "id": 75290, "time": "2005-05-24T22:12:11Z", "creator": "nicolas@kessler.cx", "creation_time": "2005-05-24T22:12:11Z", "is_private": false, "text": "Sorry to keep this flowing, but whatever the AddLanguage story is, \nmod_negotiation has an issue with the country code suffixes. Let's try \nwith \"http://httpd.apache.org/docs-2.0/\":\n\nCalling this URL with \"Accept-Language: de-ch\" gives me German, which is fine, \nalthough I can't see what server configuration achieves this behavior.\n\n\"Accept-Language: fr-ch\" gives me French, which is consistent.\n\n\"Accept-Language: de-ch,fr-ch;q=0.5\" gives me German, which is still \nconsistent.\n\n\"Accept-Language: fr-ch,de-ch;q=0.5\" gives me German, which is not consistent.\n\n\"Accept-Language: de-ch,fr-ch;q=0.7,fr;q=0.3\" gives me French, which is again \nnot consistent, although in a different way: it fits with what you guys tell \nme about the AddLanguage behavior (assuming that the last \".fr\" entry \nin \"httpd.apache.org\"'s httpd.conf is AddLanguage fr .fr).\n\nTo me all this looks like some \"country code suffix hack\" somewhere in \nmod_negotiation, probably not at all related to AddLanguage."}, {"count": 6, "tags": [], "creator": "nicolas@kessler.cx", "attachment_id": null, "text": "Joshua - I completed my remarks just before I saw your comment; I agree with \nyou: the real issue is getting around a situation with some users' language \npreference and I was misled trying to achieve this through AddLanguage.\n\nThe problem is, here in Switzerland, most browsers are preconfigured \nwith \"Accept-Language: de-ch\", but people expect/accept \"de\". (Isn't this also \nthe case in the US with \"en-us\"?).\n\nRe my previous post: mod_negotiation seems to look after this problem, but in \nan inconsistent way.\n", "id": 75292, "time": "2005-05-24T22:25:28Z", "bug_id": 35039, "creation_time": "2005-05-24T22:25:28Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 35039, "text": "This is exactly the behaviour as described in the relevant RFCs. Let me explain,\nhow mod_negotiation sees it:\n\nFirst, you should know that the httpd is configured to not deliver 300 or 406,\nbut instead look for a deliverable variant (ForceLanguagePriority). Furthermore\nLanguagePriority is ordered alphabetically.\n\n> \"Accept-Language: fr-ch\" gives me French\n\nWell, we don't provide fr-ch (no match), so mod_negotiation delivers what it\nthink, it's best. That's implementation defined (matching fr-ch vs fr gives q =\n0.001 (assigned by apache), which is better than q = 0)\n\n> \"Accept-Language: de-ch,fr-ch;q=0.5\" gives me German\n\nWe neither provide de-ch, so you get de and fr both with q = 0.001.\nLanguagePriority catches up and de wins.\n\n> \"Accept-Language: fr-ch,de-ch;q=0.5\" gives me German\n\nsame game.\n\n> \"Accept-Language: de-ch,fr-ch;q=0.7,fr;q=0.3\" gives me French\n\nBecause fr is the one and only thing in your accept-language we really provide.\nIt wins easily. q = 0.3 > 0.001\n\nThat accepting de-CH or en-US doesn't match provided de or en is a known\nproblem, but the RFCs define it that way. See, for example, Alan Flavell's\narticle about it: http://ppewww.ph.gla.ac.uk/~flavell/www/lang-neg.html (section\nLanguage subset selection).\n\nWith regard to the addlanguage comma thing -- that should not be that\ncomplicated to build in. I'm not sure though, if this is really necessary.", "id": 75294, "time": "2005-05-24T23:08:30Z", "creator": "nd@perlig.de", "creation_time": "2005-05-24T23:08:30Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "nicolas@kessler.cx", "attachment_id": null, "text": "Thank you, Andr\u00e9, for this detailed answer. I was not aware about the \"q = \n0.001\" thing. But I am glad you guys care reading the specs!\n\nRegards,\nNicolas\n", "id": 75296, "time": "2005-05-24T23:27:15Z", "bug_id": 35039, "creation_time": "2005-05-24T23:27:15Z", "is_private": false}]