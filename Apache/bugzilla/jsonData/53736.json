[{"count": 0, "tags": [], "bug_id": 53736, "attachment_id": 29249, "id": 161504, "time": "2012-08-17T22:34:43Z", "creator": "bpkroth@gmail.com", "creation_time": "2012-08-17T22:34:43Z", "is_private": false, "text": "Created attachment 29249\nrelevant vhost confs\n\nI'm using mod_proxy_balancer to balance requests across different backends for some vhosts in a hosting environment.  Currently there's actually only one vhost that uses the balancer.  All others use a simple ProxyPass directive to a single backend host in their VirtualHost configs.\n\nI would like to be able to use the /balancer-manager on the balancer vhost (really the proxy for it) to disable individual backends for maintenance.  However, when I submit the form, no changes are saved.  Everything remains as it did originally.  I've not found any explaination for this in the debug logs.  The request goes through and appears to be processed, but no change is registered.\n\nBased on some long ago reported problems, I've tried this with and without the :port appended in the BalancerMember declaration, but to no avail.\n\nAdditionally, I've noticed that if I visit https://mybalancedvhost.mydomain/balancer-manager I get a second \"empty\" section.\n\nSome examples are attached.\n\nLet me know if you need any more details.\n\nThanks,\nBrian"}, {"count": 1, "tags": [], "bug_id": 53736, "attachment_id": 29250, "text": "Created attachment 29250\nexample /balancer-manager output", "id": 161505, "time": "2012-08-17T22:35:06Z", "creator": "bpkroth@gmail.com", "creation_time": "2012-08-17T22:35:06Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 53736, "attachment_id": null, "id": 163117, "time": "2012-11-01T14:45:39Z", "creator": "jim@apache.org", "creation_time": "2012-11-01T14:45:39Z", "is_private": false, "text": "The balancer-manager is designed to be per server and not server-wide. That is because it stores various parameters in shared memory which is associated with the particular server that the balancer is defined in."}, {"count": 3, "attachment_id": null, "bug_id": 53736, "is_private": false, "id": 163207, "time": "2012-11-05T20:56:39Z", "creator": "bpkroth@gmail.com", "creation_time": "2012-11-05T20:56:39Z", "tags": [], "text": "Adding this via the webform since I just realized my previous email replies didn't make it into the system ...\n\nbugzilla@apache.org <bugzilla@apache.org> 2012-11-01 14:45:\n> https://issues.apache.org/bugzilla/show_bug.cgi?id=53736\n>\n> --- Comment #2 from Jim Jagielski <jim@apache.org> ---\n> The balancer-manager is designed to be per server and not server-wide. That is\n> because it stores various parameters in shared memory which is associated with\n> the particular server that the balancer is defined in.\n\nBy \"per server\" do you mean \"per vhost\"?\n\nAs in, the confs should look like this instead?\n\n<Proxy balancer://...>\n\t# Same balancer stuff as before ...\n</Proxy>\n\n<VirtualHost ...>\n\t# Same vhost stuff as before ...\n\n\t# Put this here, rather than at the top level.\n\t<Location /balancer-manager>\n\t\tSetHandler balancer-manager\n\t\t...\n\t</Location>\n</VirtualHost>\n# Rinse, repeat for each individual vhost ...\n\nI think I had originally left it at the top because \n1) That's how the distro (Debian) packages that config file, and \n2) This page states the following:\nhttp://httpd.apache.org/docs/2.4/mod/mod_proxy_balancer.html#balancer_manager\nPlease note that only Balancers defined outside of <Location ...> containers can be dynamically controlled by the Manager.\n\nHowever, that note doesn't show up in the 2.2 docs, which I'm currently running.\n\nThanks,\nBrian"}, {"count": 4, "tags": [], "bug_id": 53736, "attachment_id": null, "id": 163208, "time": "2012-11-05T20:57:20Z", "creator": "bpkroth@gmail.com", "creation_time": "2012-11-05T20:57:20Z", "is_private": false, "text": "Brian Paul Kroth <bpkroth@gmail.com> 2012-11-01 10:29:\n> bugzilla@apache.org <bugzilla@apache.org> 2012-11-01 14:45:\n>> https://issues.apache.org/bugzilla/show_bug.cgi?id=53736\n>>\n>> --- Comment #2 from Jim Jagielski <jim@apache.org> ---\n>> The balancer-manager is designed to be per server and not server-wide. That is\n>> because it stores various parameters in shared memory which is associated with\n>> the particular server that the balancer is defined in.\n>\n> By \"per server\" do you mean \"per vhost\"?\n>\n> As in, the confs should look like this instead?\n>\n> <Proxy balancer://...>\n> \t# Same balancer stuff as before ...\n> </Proxy>\n>\n> <VirtualHost ...>\n> \t# Same vhost stuff as before ...\n>\n> \t# Put this here, rather than at the top level.\n> \t<Location /balancer-manager>\n> \t\tSetHandler balancer-manager\n> \t\t...\n> \t</Location>\n> </VirtualHost>\n> # Rinse, repeat for each individual vhost ...\n\nI tried this, but I got the same results.  Any other ideas?\n\nThanks,\nBrian"}, {"count": 5, "tags": [], "text": "So, I think I've figured out what the problem is here.  Basically, we have IPv6 backends that include [] characters (eg: http://[fded:ff:cb23:608:b774:712c]).  On the form submital, the w field is being ap_escape_uri()ed twice, so that [ becomes first %5b, and then %255b, but only ap_unescape_url()ed once.\n\nI've attached a patch that just does the existing ap_unescape_url() call twice (just wrapped in a for loop).  There may be a better way to do that.\n\n\nHere's the steps I used to track this down.\n\n1) Throw in a bunch of ap_log_error() calls around the while (args ...) processing, wsel instantiation, and other params checking blocks to dump debug information out to the log and rebuild mod_proxy_balancer.so\n\n2) Load the /balancer-manager page.\n\n3) Click on one of the backends to pull up the form.  That results in output like the following:\n\n[Thu Feb 07 17:55:33 2013] [debug] mod_proxy_balancer.c(719): proxy: balancer-manager handler got escaped w=http://%5bfded:ff::cb23:608:b774:712c%5d\n[Thu Feb 07 17:55:33 2013] [debug] mod_proxy_balancer.c(729): proxy: balancer-manager handler got w=http://[fded:ff:cb23:608:b774:712c]\n[Thu Feb 07 17:55:33 2013] [debug] mod_proxy_balancer.c(733): proxy: balancer-manager handler stored w=http://[fded:ff::cb23:608:b774:712c]\n[Thu Feb 07 17:55:33 2013] [debug] mod_proxy_balancer.c(767): proxy: balancer-manager handler for balancer balancer://bpk-test_http_cluster requested worker http://[fded:ff::cb23:608:b774:712c], found ws http://[fded:ff::cb23:608:b774:712c], checking wsel http://[fded:ff::cb23:608:b774:712c]\n[Thu Feb 07 17:55:33 2013] [debug] mod_proxy_balancer.c(787): proxy: balancer-manager handler for balancer balancer://bpk-test_http_cluster requested worker http://[fded:ff::cb23:608:b774:712c]\n\nNotice that \na) It's properly unescaping the w= GET parameter at that point.\nb) From that it finds and sets wsel correctly.\n\n4) View the source for that page.  You'll note that it generates the following html for an escaped w field:\n\n<input type=hidden name=\"w\" value=\"http://%5bfded:ff::cb23:608:b774:712c%5d\">\n\n\n5) Submit the form.  That results in output like the following:\n\n[Thu Feb 07 17:55:39 2013] [debug] mod_proxy_balancer.c(719): proxy: balancer-manager handler got escaped w=http%3A%2F%2F%255bfded%3A%3Aff%3A%3Acb23%3A608%3Ab774%3A712c%255d\n[Thu Feb 07 17:55:39 2013] [debug] mod_proxy_balancer.c(729): proxy: balancer-manager handler got w=http://%5bfded:ff::cb23:608:b774:712c%5d\n[Thu Feb 07 17:55:39 2013] [debug] mod_proxy_balancer.c(733): proxy: balancer-manager handler stored w=http://%5bfded:ff::cb23:608:b774:712c%5d\n\nNotice that\na) w is not entirely unescaped at this point, so that\nb) wsel doesn't get set, so that \nc) the if (wsel) processing bit to change the worker's parameters never gets processed.\n\nThe attached patch fixes that.\n\nLet me know if you have any questions.\n\nThanks,\nBrian", "is_private": false, "id": 165135, "creator": "bpkroth@gmail.com", "time": "2013-02-09T00:01:54Z", "bug_id": 53736, "creation_time": "2013-02-09T00:01:54Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 53736, "attachment_id": 29933, "id": 165136, "time": "2013-02-09T00:02:46Z", "creator": "bpkroth@gmail.com", "creation_time": "2013-02-09T00:02:46Z", "is_private": false, "text": "Created attachment 29933\nmod_proxy_balancer-manager_ipv6_backends.patch"}, {"count": 7, "tags": [], "text": "Comment on attachment 29933\nmod_proxy_balancer-manager_ipv6_backends.patch\n\nunescape twice the doubly escaped ipv6 backend uri", "is_private": false, "id": 165137, "creator": "bpkroth@gmail.com", "time": "2013-02-09T00:03:49Z", "bug_id": 53736, "creation_time": "2013-02-09T00:03:49Z", "attachment_id": 29933}]