[{"count": 0, "tags": [], "creator": "jlrenard@generali.fr", "attachment_id": null, "is_private": false, "id": 25882, "time": "2002-11-07T18:31:57Z", "bug_id": 14364, "creation_time": "2002-11-07T18:31:57Z", "text": "We are using an Apache 2.0.43 in reverse proxy mode on a linux redhat 7.2 \nserver with mod_cache and mod_disk_cache enabled.\n\nA problem appears when we are requesting files on a server where an Accept-\nRange: bytes parameter is present in the response because mod_proxy replace the \nContent-Lenght directive by a Transfer-Encoding: chunked directive and \nmod_cache doesn't handle it properly.\n\nHere is a trace of our requests :\n\n=> Sent from client\nGET /images/ima10.gif HTTP/1.1\nHost: www.bk.generali.fr\n\n=> Response from the IIS Server\nHTTP/1.1 200 OK\nServer: Microsoft-IIS/4.0\nDate: Thu, 07 Nov 2002 17:27:36 GMT\nContent-Type: image/gif\nAccept-Ranges: bytes\nLast-Modified: Tue, 29 Jan 2002 18:43:37 GMT\nETag: \"aac7b4dcf4a8c11:e15\"\nContent-Length: 1388\n\n=>Response sent by mod_proxy with mod_cache disabled \n=>(Content-Length diretive have been replaced with transfer-Encoding: chuncked \ndirective)\nHTTP/1.1 200 OK\nDate: Thu, 07 Nov 2002 17:24:21 GMT\nServer: Microsoft-IIS/4.0\nContent-Type: image/gif\nAccept-Ranges: bytes\nLast-Modified: Tue, 29 Jan 2002 18:43:37 GMT\nETag: \"aac7b4dcf4a8c11:e15\"\nTransfer-Encoding: chunked\n\n=>Response sent by mod_proxy with mod_cache enable\nHTTP/1.1 200 OK\nDate: Thu, 07 Nov 2002 17:38:53 GMT\nServer: Microsoft-IIS/4.0\nContent-Type: image/gif\nAccept-Ranges: bytes\nLast-Modified: Tue, 29 Jan 2002 18:43:37 GMT\nETag: \"aac7b4dcf4a8c11:e15\"\nTransfer-Encoding: chunked\n\n=>extract for errorlog file for this request : \n=> mod_cache consider this file as a stream, because content-length directive\n=> has been removed by mod_proxy\n=> mod_cache DOES NOT HANDLE PROPERLY Transfer-Encoding: chunked DIRECTIVE. \n[Thu Nov 07 18:39:27 2002] [debug] mod_cache.c(118): cache: \nURL /images/ima10.gif is being handled by disk\n[Thu Nov 07 18:39:27 2002] [debug] mod_cache.c(202): cache: no cache - add \ncache_in filter and DECLINE\n[Thu Nov 07 18:39:27 2002] [debug] proxy_http.c(109): proxy: HTTP: \ncanonicalising URL //www.bk.generali.fr/images/ima10.gif\n[Thu Nov 07 18:39:27 2002] [debug] mod_proxy.c(442): Trying to run \nscheme_handler against proxy\n[Thu Nov 07 18:39:27 2002] [debug] proxy_http.c(1061): proxy: HTTP: serving URL \nhttp://www.bk.generali.fr/images/ima10.gif\n[Thu Nov 07 18:39:27 2002] [debug] proxy_http.c(221): proxy: HTTP connecting \nhttp://www.bk.generali.fr/images/ima10.gif to www.bk.generali.fr:80\n[Thu Nov 07 18:39:27 2002] [debug] proxy_util.c(1167): proxy: HTTP: fam 2 \nsocket created to connect to 10.6.11.14\n[Thu Nov 07 18:39:27 2002] [debug] proxy_http.c(370): proxy: socket is connected\n[Thu Nov 07 18:39:27 2002] [debug] proxy_http.c(404): proxy: connection \ncomplete to 10.6.11.14:8880 (10.6.11.14)\n[Thu Nov 07 18:39:27 2002] [debug] proxy_http.c(902): proxy: start body send\n[Thu Nov 07 18:39:27 2002] [debug] mod_cache.c(436): cache: running CACHE_IN \nfilter\n[Thu Nov 07 18:39:27 2002] [debug] mod_cache.c(650): cache: not caching \nstreamed response for /images/ima10.gif because length > CacheMaxStreamingBuffer\n[Thu Nov 07 18:39:27 2002] [debug] proxy_http.c(961): proxy: end body send\n\n=>Response sent by mod_proxy with mod_cache enable and CacheMaxStreamingBuffer \n=>directive set to 65536 in httpd.conf\n=>File is now put in the cache, but no cache is possible for file greater\n=>than 64Kbytes\nHTTP/1.1 200 OK\nDate: Thu, 07 Nov 2002 17:59:55 GMT\nServer: Microsoft-IIS/4.0\nContent-Type: image/gif\nAccept-Ranges: bytes\nLast-Modified: Tue, 29 Jan 2002 18:43:37 GMT\nETag: \"aac7b4dcf4a8c11:e15\"\nTransfer-Encoding: chunked\n\n=>extract for errorlog file for this request : \n=>This file is now put in cache.\n[Thu Nov 07 18:59:55 2002] [debug] mod_cache.c(118): cache: \nURL /images/ima10.gif is being handled by disk\n[Thu Nov 07 18:59:55 2002] [debug] mod_cache.c(202): cache: no cache - add \ncache_in filter and DECLINE\n[Thu Nov 07 18:59:55 2002] [debug] proxy_http.c(109): proxy: HTTP: \ncanonicalising URL //www.bk.generali.fr/images/ima10.gif\n[Thu Nov 07 18:59:55 2002] [debug] mod_proxy.c(442): Trying to run \nscheme_handler against proxy\n[Thu Nov 07 18:59:55 2002] [debug] proxy_http.c(1061): proxy: HTTP: serving URL \nhttp://www.bk.generali.fr/images/ima10.gif\n[Thu Nov 07 18:59:55 2002] [debug] proxy_http.c(221): proxy: HTTP connecting \nhttp://www.bk.generali.fr/images/ima10.gif to www.bk.generali.fr:80\n[Thu Nov 07 18:59:55 2002] [debug] proxy_util.c(1167): proxy: HTTP: fam 2 \nsocket created to connect to 10.6.11.14\n[Thu Nov 07 18:59:55 2002] [debug] proxy_http.c(370): proxy: socket is connected\n[Thu Nov 07 18:59:55 2002] [debug] proxy_http.c(404): proxy: connection \ncomplete to 10.6.11.14:8880 (10.6.11.14)\n[Thu Nov 07 18:59:55 2002] [debug] proxy_http.c(902): proxy: start body send\n[Thu Nov 07 18:59:55 2002] [debug] mod_cache.c(436): cache: running CACHE_IN \nfilter\n[Thu Nov 07 18:59:55 2002] [debug] mod_cache.c(715): cache: Response length \nstill unknown, setting aside content for url: /images/ima10.gif\n[Thu Nov 07 18:59:55 2002] [debug] mod_cache.c(436): cache: running CACHE_IN \nfilter\n[Thu Nov 07 18:59:55 2002] [info] disk_cache: Caching URL \nfront.www.bk.generali.fr/images/ima10.gif?\n[Thu Nov 07 18:59:55 2002] [debug] mod_cache.c(786): cache: Caching \nurl: /images/ima10.gif\n[Thu Nov 07 18:59:55 2002] [debug] mod_cache.c(819): cache: Added date header\n[Thu Nov 07 18:59:55 2002] [info] disk_cache: Caching headers for URL \nfront.www.bk.generali.fr/images/ima10.gif?\n[Thu Nov 07 18:59:55 2002] [info] disk_cache: Cached body for URL \nfront.www.bk.generali.fr/images/ima10.gif?\n[Thu Nov 07 18:59:55 2002] [debug] proxy_http.c(961): proxy: end body send"}, {"count": 1, "text": "There are two parts to answering this PR. The first is that Estrade Matthieu and\nBrian Pane recently committed a fix to remove headers that shouldn't be cached.\nTransfer-encoding is one of those headers, so that fix is available in the HEAD\nof the CVS library and will be available in a future release of Apache.\n\nThe second part of the answer is that there are a variety of reasons why\ncontent-length may get removed. Your configuration needs to be set up to handle\nthat. One way to handle it would be to set CacheMaxStreamingBuffer to a value\nvery near CacheMaxFileSize. Another way would be to try and limit the number of\nthings that cause content-length to be removed from cachable files. You can do\nthings like make sure those files aren't unnecessarily run through mod_include.\n\nThose two things should fix the problem you have encountered so I am marking\nthis as fixed.", "bug_id": 14364, "is_private": false, "id": 26513, "time": "2002-11-18T22:05:02Z", "creator": "rederpj@remulak.net", "creation_time": "2002-11-18T22:05:02Z", "tags": [], "attachment_id": null}]