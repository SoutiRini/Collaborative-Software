[{"count": 0, "tags": [], "creator": "PhiLho@GMX.net", "attachment_id": 32165, "id": 178832, "time": "2014-10-29T17:17:27Z", "bug_id": 57165, "creation_time": "2014-10-29T17:17:27Z", "is_private": false, "text": "Created attachment 32165\nThe Excel file\n\nI created an Excel 2010 file (XLS first, then saved to XLSX format).\nLater, I re-ordered the tabs.\n\nI have code that copies this file, opens it, removes all sheets except the selected one, then clone this sheet n times before filling them.\nIe. the document is a template with several models.\n\nI found out that in some cases, the clone operation fails.\n\nNote: I have to use a convoluted method to delete the sheets, because of the bug #57163.\n\nMy method to isolate a sheet:\n\n  void removeAllSheetsBut(int sheetIndex, Workbook wb)\n  {\n    int sheetNb = wb.getNumberOfSheets();\n    // Move this sheet at the first position\n    wb.setSheetOrder(wb.getSheetName(sheetIndex), 0);\n    // Must make this sheet active (otherwise, for XLSX, Excel might protest that active sheet no longer exists)\n    // I think POI should automatically handle this case when deleting sheets...\n    wb.setActiveSheet(0);\n    for (int sn = sheetNb - 1; sn > 0; sn--)\n    {\n      wb.removeSheetAt(sn);\n    }\n  }\n\n(I will open a new bug about the comment, once I will be able to reproduce it.)\n\nThen I just do:\n\nWorkbook wb = readWorkbook(fileName);\nremoveAllSheetsBut(3, wb);\nwb.cloneSheet(0);\nwb.setSheetName(1, \"New Sheet\");\nsaveWorkbook(wb, fileName + \" Updated\");\n\nOn the cloneSheet line, I get an exception:\n\nException in thread \"main\" org.apache.poi.openxml4j.exceptions.PartAlreadyExistsException: A part with the name '/xl/worksheets/sheet4.xml' already exists : Packages shall not contain equivalent part names and package implementers shall neither create nor recognize packages with equivalent part names. [M1.12]\n\tat org.apache.poi.openxml4j.opc.OPCPackage.createPart(OPCPackage.java:785)\n\tat org.apache.poi.openxml4j.opc.OPCPackage.createPart(OPCPackage.java:749)\n\tat org.apache.poi.POIXMLDocumentPart.createRelationship(POIXMLDocumentPart.java:374)\n\tat org.apache.poi.POIXMLDocumentPart.createRelationship(POIXMLDocumentPart.java:358)\n\tat org.apache.poi.xssf.usermodel.XSSFWorkbook.createSheet(XSSFWorkbook.java:728)\n\tat org.apache.poi.xssf.usermodel.XSSFWorkbook.cloneSheet(XSSFWorkbook.java:503)\n\tat org.apache.poi.xssf.usermodel.XSSFWorkbook.cloneSheet(XSSFWorkbook.java:102)\n\nFrom my investigation, I would say the culprit is the line:\n\nfor(XSSFSheet sh : sheets) sheetNumber = (int)Math.max(sh.sheet.getSheetId() + 1, sheetNumber);\n\nin XSSFSheet createSheet(String sheetname) (in XSSFWorkbook).\n\nThis sheetNumber is used to name the sheet<n>.xml file, but apparently, after moving around the tabs (I suppose) in Excel, they are no longer in synch, hence the conflict."}, {"count": 1, "attachment_id": null, "bug_id": 57165, "text": "Can you create a small junit unit test which triggers the problem? We can then use that to test a fix, and to ensure it stays fixed going forward?", "id": 178833, "time": "2014-10-29T17:29:06Z", "creator": "apache@gagravarr.org", "creation_time": "2014-10-29T17:29:06Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 57165, "attachment_id": 32174, "text": "Created attachment 32174\nShow bugs", "id": 178862, "time": "2014-10-31T11:30:21Z", "creator": "PhiLho@GMX.net", "creation_time": "2014-10-31T11:30:21Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 57165, "attachment_id": null, "text": "Not really a JUnit test, but it is a standalone class that loads the sample Excel file and reproduce the bugs (three bugs are shown, I numbered them with the Bugzilla id).\nYou might need to adjust the path to the sample.", "id": 178864, "time": "2014-10-31T11:32:46Z", "creator": "PhiLho@GMX.net", "creation_time": "2014-10-31T11:32:46Z", "is_private": false}, {"count": 4, "attachment_id": null, "bug_id": 57165, "text": "FYI, there is now a test in class org.apache.poi.xssf.usermodel.TestUnfixedBugs which reproduces this, a fix is still pending, though...", "id": 179933, "time": "2014-12-22T09:16:19Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2014-12-22T09:16:19Z", "tags": [], "is_private": false}, {"count": 5, "tags": [], "creator": "dominik.stadler@gmx.at", "attachment_id": null, "id": 181418, "time": "2015-03-01T20:02:15Z", "bug_id": 57165, "creation_time": "2015-03-01T20:02:15Z", "is_private": false, "text": "This exception is now avoided when cloning/creating sheets via r1663153 as we now look at the existing parts and increase the internal sheet index accordingly if necessary."}]