[{"count": 0, "tags": [], "bug_id": 61583, "text": "After upgrading from 8.5.16 to 8.5.20, PKCS11 support was broken due to #61451. Upon receiving release announcement for 8.5.23 and testing (somehow missed 8.5.21), PKCS11 support still appears broken because it does not honor the key alias set on the connector. I have verified that 8.5.21 also displays the same behavior.\n\nThe testing configuration uses a single PKCS11 keystore (backed by NSS) with three keys inside: admin, server and client. The testing suite configures Tomcat with two connectors, one for administrative access and a second for \"business\" access. Upon running the test suite, Tomcat consistently uses the client certificate for both the server and administrative connectors. When examining the keystore with a java program, the client certificate is the first key in the store.\n\nExample connector:\n    <Connector name=\"https\"\n               enableLookups=\"false\"\n               xpoweredBy=\"false\"\n               address=\"192.168.40.216\"\n               scheme=\"https\"\n               server=\"server\"\n               port=\"25004\"\n               secure=\"true\"\n               maxHttpHeaderSize=\"8192\"\n               SSLEnabled=\"true\"\n               clientAuth=\"false\"\n               sslProtocol=\"TLS\"\n               sslEnabledProtocols=\"SSLv2Hello,TLSv1.1,TLSv1.2\"\n               ciphers=\"TLS_RSA_WITH_AES_256_CBC_SHA256,TLS_RSA_WITH_AES_256_CBC_SHA,TLS_RSA_WITH_AES_128_CBC_SHA256,TLS_RSA_WITH_AES_128_CBC_SHA\"\n               keyAlias=\"tomcatserver\"\n               keystoreFile=\"/tmp/pkcs11.0.cfg\"\n               keystorePass=\"nss\"\n               keystoreType=\"PKCS11\"\n               truststoreFile=\"/tmp/trust.jks\"\n               truststoreType=\"JKS\"\n               />\n\n\nStore contents of NSS database:\n$ certutil -d /tmp/pkcs11 -K\ncertutil: Checking token \"NSS FIPS 140-2 Certificate DB\" in slot \"NSS FIPS 140-2 User Private Key Services\"\nEnter Password or Pin for \"NSS FIPS 140-2 Certificate DB\":\n< 0> rsa      40261c884934d113672666784953129ea53a6492   NSS FIPS 140-2 Certificate DB:tomcatadmin\n< 1> rsa      dba317a2b93e771032c0b5fafb019649229dcc7c   NSS FIPS 140-2 Certificate DB:tomcatserver\n< 2> rsa      6ed07ff1e609c5daa965bf152004e1212177a87f   NSS FIPS 140-2 Certificate DB:tomcatclient\n\nViewed as a KeyStore object and iterating over the keys:\nx509 test application\nKeystore loaded\nCertificate: tomcatclient (key entry)\nCertificate: tomcatserver (key entry)\nCertificate: tomcatadmin (key entry)\n\nIf there is any debug logging information I can provide, please let me know.", "id": 201278, "time": "2017-10-03T14:30:02Z", "creator": "DRuggeri@primary.net", "creation_time": "2017-10-03T14:30:02Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "DRuggeri@primary.net", "attachment_id": null, "is_private": false, "id": 201279, "time": "2017-10-03T14:31:07Z", "bug_id": 61583, "creation_time": "2017-10-03T14:31:07Z", "text": "Also, as a side comment, I would be happy to help produce tests to catch these during release. I'm not sure where to start, but am motivated to assist."}, {"attachment_id": null, "tags": [], "bug_id": 61583, "is_private": false, "count": 2, "id": 201280, "time": "2017-10-03T15:00:02Z", "creator": "remm@apache.org", "creation_time": "2017-10-03T15:00:02Z", "text": "It is true the alias setting will now only work if the key type is PKCS8."}, {"count": 3, "tags": [], "bug_id": 61583, "is_private": false, "text": "After investigating, it would seem r1800874 has to be partially reverted since we cannot put the non PKCS8 key in the in memory keystore and may have to use the JSSEKeyManager wrapper instead. Unless it is always possible to do the memory keystore creation with other types [and go with putting the key there], in which case the condition \"PKCS#8\".equalsIgnoreCase(k.getFormat()) can simply be removed.\n\nUnfortunately, no test case here to make sure I don't do anything wrong.", "id": 201281, "time": "2017-10-03T15:18:10Z", "creator": "remm@apache.org", "creation_time": "2017-10-03T15:18:10Z", "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 61583, "text": "Sure, understood. If you can provide a jar, I can do testing to verify the change before committing.\n\nThinking about the ability to test this ongoing, I *think* that the Oracle PKCS11 provider works in software on Solaris, Linux and Windows. I can try putting together some test code if you think it would be worth doing.", "id": 201282, "time": "2017-10-03T15:53:42Z", "creator": "DRuggeri@primary.net", "creation_time": "2017-10-03T15:53:42Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 61583, "is_private": false, "text": "I agree with R\u00e9my's analysis.\n\nSince I messed this up, I'm happy to take a look at getting it fixed. First step will be setting up a software PKCS11 keystore for testing. Any pointers appreciated.", "id": 201284, "time": "2017-10-03T18:31:26Z", "creator": "markt@apache.org", "creation_time": "2017-10-03T18:31:26Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 61583, "text": "I think I have fixed this. Snapshot build available here:\nhttp://people.apache.org/~markt/dev/v8.5.24-dev/\n\nIf you could test and provide feedback that will be great.\n\nNote: This is a snapshot, not an official release. It is intended for testing this issue only. If your server catches fire when you install it you are on your own, etc.", "id": 201290, "time": "2017-10-03T20:38:12Z", "creator": "markt@apache.org", "creation_time": "2017-10-03T20:38:12Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "creator": "DRuggeri@primary.net", "text": "Hi, Mark;\n   I can confirm that the preview build you shared corrects the problem... and I even detected no smoke!\n\n   For testing, I was mistaken. The SunPKCS11 Provider does, indeed, ship on all Solaris, Windows and Linux builds but does not include a backing PKCS11 implementation - that's still separate. Can you help me understand what flexibility exists in the testing infrastructure for Tomcat? The way I test this in our environment is with NSS which is free, provides a PCKS11 implementation and is available on RedHat and Debian derivatives. If you have a Windows or Linux VM to do said testing, I can provide scripts that will generate the stores. I could also throw together a Dockerfile if docker is a thing for you.", "id": 201292, "time": "2017-10-03T21:52:40Z", "bug_id": 61583, "creation_time": "2017-10-03T21:52:40Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "All of our testing is based around JUnit. Some variation of the unit tests in o.a.tomcat.util.net is probably required. Making them optional depending on the presence of NSS is probably the way to go. You should be able to re-use the keys/certs in that location.", "id": 201297, "time": "2017-10-04T18:16:44Z", "bug_id": 61583, "creation_time": "2017-10-04T18:16:44Z", "is_private": false}]