[{"count": 0, "tags": [], "creator": "zin@jaist.ac.jp", "attachment_id": null, "is_private": false, "id": 177744, "time": "2014-09-11T12:01:16Z", "bug_id": 56960, "creation_time": "2014-09-11T12:01:16Z", "text": "In case of worker process graceful shutdown, listener thread cannot get worker for processing connections under asynchronous state because get_worker() will not set *have_idle_worker_p. This raise the dead-lock problem, that is the listener thread cannot get idle workers to process asynchronous (e.g. CONN_STATE_WRITE_COMPLETION) because the get_worker don't pass have_idle_worker, but workers are already waiting in ap_queue_pop_something().\n\nThis is because the ap_queue_info_wait_for_idler() will return APR_EOF with allocating idle worker (s.t. decreasing worker_queue_info->idlers) after ap_queue_info_term() but the get_worker() will not set *have_idle_worker_p in APR_EOF case. So the listener_thread() multiply call get_worker() for processing waiting connections and worker_queue_info->idlers goes to pt_zero.\n\n---\ndiff -r -u httpd-2.4.10.orig//server/mpm/event/event.c httpd-2.4.10//server/mpm/event/event.c\n--- httpd-2.4.10.orig//server/mpm/event/event.c Thu Jun 26 07:01:31 2014\n+++ httpd-2.4.10//server/mpm/event/event.c      Thu Sep 11 19:04:52 2014\n@@ -1271,13 +1271,13 @@\n     else\n         rc = ap_queue_info_try_get_idler(worker_queue_info);\n \n-    if (rc == APR_SUCCESS) {\n+    if (rc == APR_SUCCESS || APR_STATUS_IS_EOF(rc)) {\n         *have_idle_worker_p = 1;\n     }\n     else if (!blocking && rc == APR_EAGAIN) {\n         *all_busy = 1;\n     }\n-    else if (!APR_STATUS_IS_EOF(rc)) {\n+    else {\n         ap_log_error(APLOG_MARK, APLOG_ERR, rc, ap_server_conf, APLOGNO(00472)\n                      \"ap_queue_info_wait_for_idler failed.  \"\n                      \"Attempting to shutdown process gracefully\");"}, {"count": 1, "tags": [], "creator": "zin@jaist.ac.jp", "is_private": false, "id": 178189, "attachment_id": 32071, "bug_id": 56960, "creation_time": "2014-09-30T04:56:36Z", "time": "2014-09-30T04:56:36Z", "text": "Created attachment 32071\npatch for Bug 56960"}, {"count": 2, "tags": [], "bug_id": 56960, "text": "How to reproduce...\n1) enable mod_status with extended status (to check status)\n2) set small value for MaxConnectionsPerChild eg. 1000 (to easy reproduce)\n3) make dummy large file (>100M) under DocumentRoot.\n4) make a heavy load with the large file, with many (>1000) concurrent connection\n\nAfter several tens minutes, you can find some dead-locked httpd process. Thease process has following status\n- Connections total is not 0, listen 'no'.\n- Busy and idle thread is 0.\n- have some Async connections.\n\nThis issue is CRITICAL because this not only happen in case of administrative graceful shutdown but also happen restart each worker process (e.g. exceed MaxConnectionsPerChild)", "id": 178190, "time": "2014-09-30T04:58:30Z", "creator": "zin@jaist.ac.jp", "creation_time": "2014-09-30T04:58:30Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "zin@jaist.ac.jp", "text": "add keyword 'PatchAvailable' ...", "id": 178191, "attachment_id": null, "bug_id": 56960, "creation_time": "2014-09-30T04:59:53Z", "time": "2014-09-30T04:59:53Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 56960, "text": "This patch seems to work properly with httpd-2.4.x and fixes the mentioned bug for me, but for some reason it fails to fix it in httpd-trunk. Although it improves the situation there, I still see some workers dead-locks (but not so many as without the patch).\n\nBefore committing this patch, I will try to find out what's different between trunk and 2.4.x in the event MPM causing this.", "id": 178194, "time": "2014-09-30T08:46:48Z", "creator": "jkaluza@redhat.com", "creation_time": "2014-09-30T08:46:48Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "creator": "ylavic.dev@gmail.com", "is_private": false, "id": 178198, "attachment_id": null, "bug_id": 56960, "creation_time": "2014-09-30T11:46:28Z", "time": "2014-09-30T11:46:28Z", "text": "Possible duplicate of Bug 49504 (active children during graceful restart may trigger it)?"}, {"count": 6, "attachment_id": null, "bug_id": 56960, "text": "So the remaining issue I see with event MPM is caused by http://svn.apache.org/r1605328 (according to svn-bisect)", "id": 178265, "time": "2014-10-03T12:10:22Z", "creator": "jkaluza@redhat.com", "creation_time": "2014-10-03T12:10:22Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "creator": "ylavic.dev@gmail.com", "is_private": false, "id": 178268, "attachment_id": null, "bug_id": 56960, "creation_time": "2014-10-03T13:47:31Z", "time": "2014-10-03T13:47:31Z", "text": "Probably workers_were_busy and have_idle_worker should be declared back as before.\nThey have a both a meaningful value during the whole life of the listener thread..."}, {"count": 8, "attachment_id": null, "bug_id": 56960, "is_private": false, "id": 178270, "time": "2014-10-03T14:17:02Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-10-03T14:17:02Z", "tags": [], "text": "(In reply to Yann Ylavic from comment #7)\n> Probably workers_were_busy and have_idle_worker should be declared back as\n> before.\n> They have a both a meaningful value during the whole life of the listener\n> thread...\n\nIn fact only have_idle_worker is concerned, workers_were_busy must be reset to 0 for each main loop."}, {"count": 9, "tags": [], "creator": "jkaluza@redhat.com", "attachment_id": null, "text": "Yes, just wanted to write here that have_idle_worker must be preserved during iterations. I'm going to commit that and patch from this bug into trunk.", "id": 178273, "time": "2014-10-03T14:49:33Z", "bug_id": 56960, "creation_time": "2014-10-03T14:49:33Z", "is_private": false}, {"count": 10, "tags": [], "creator": "jkaluza@redhat.com", "text": "Attached patch for the original issue committed in r1629577, patch for the issue I found while fixing this bug committed in r1629576.\n\nProposed for 2.4.x.", "id": 178300, "attachment_id": null, "bug_id": 56960, "creation_time": "2014-10-06T06:13:29Z", "time": "2014-10-06T06:13:29Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 56960, "attachment_id": null, "id": 180503, "time": "2015-01-23T08:46:35Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2015-01-23T08:46:35Z", "is_private": false, "text": "Backported to 2.4.11 in r1634526."}]