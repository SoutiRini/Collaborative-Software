[{"count": 0, "tags": [], "text": "I don't know whether this is on the mod_proxy_ajp side or the tomcat side, \nso ...\n\nhost: \tlinux (CentOS, aka RHEL, 4 with all current updates)\nbrowser:\tfirefox 1.0.7\nhttpd:\t2.1.7, built from source\ntomcat:\t5.0.28, binary distribution\n\nappend to /etc/hosts:\n\t127.0.0.1\tlocalhost tomcat\n\nappend to httpd.conf:\n\n <VirtualHost *>\n ServerName tomcat\n #ProxyPass        / ajp://localhost:8009/\n ProxyPass        / http://localhost:8080/\n #ProxyPassReverse / ajp://localhost:8009/\n ProxyPassReverse / http://localhost:8080/\n </VirtualHost>\n\nNo other changes from a default installation of the two servers.\n\nThe first problem is that if you simply browse to http://tomcat and click on \nadmin, it works with HTTP, but not with AJP.  To illustrate, let's compare the \ndifferences with wget:\n\nAJP:\n $ wget http://tomcat/admin\n --01:06:56--  http://tomcat/admin\n            => `admin'\n Resolving tomcat... 127.0.0.1\n Connecting to tomcat|127.0.0.1|:80... connected.\n HTTP request sent, awaiting response... 302 Moved Temporarily\n Location: https://tomcat/admin/ [following]\n --01:06:56--  https://tomcat/admin/\n            => `index.html'\n Connecting to tomcat|127.0.0.1|:443... failed: Connection refused.\n Resolving tomcat... 127.0.0.1\n Connecting to tomcat|127.0.0.1|:443... failed: Connection refused.\n\nHTTP:\n $ wget http://tomcat/admin\n --01:09:20--  http://tomcat/admin\n            => `admin'\n Resolving tomcat... 127.0.0.1\n Connecting to tomcat|127.0.0.1|:80... connected.\n HTTP request sent, awaiting response... 302 Moved Temporarily\n Location: http://tomcat/admin/ [following]\n --01:09:20--  http://tomcat/admin/\n            => `index.html'\n Connecting to tomcat|127.0.0.1|:80... connected.\n HTTP request sent, awaiting response... 200 OK\n Length: 2,622 (2.6K) [text/html]\n \n 100%[====================================>] 2,622         --.--K/s\n \n 01:09:20 (53.20 MB/s) - `index.html' saved [2622/2622]\n\nNote that the 302 redirects from HTTP to HTTPS in the AJP case, but not in the \nHTTP case.\n\nOK, so let's bypass the 302 and go directly to http://tomcat/admin/.  The \ninitial GET works with either protocol, e.g., with AJP:\n\n # wget http://tomcat/admin/\n --01:10:06--  http://tomcat/admin/\n            => `index.html.1'\n Resolving tomcat... 127.0.0.1\n Connecting to tomcat|127.0.0.1|:80... connected.\n HTTP request sent, awaiting response... 200 OK\n Length: 2,615 (2.6K) [text/html\n \n 100%[====================================>] 2,615         --.--K/s\n \n 01:10:06 (95.92 MB/s) - `index.html.1' saved [2615/2615]\n\nHowever, the resources referenced on the page are only fetched when using \nHTTP, not AJP.  The difference is readily apparent.  The images, stylesheets, \netc., are served up with HTTP, but not with AJP.", "is_private": false, "id": 80658, "creator": "noel@devtech.com", "time": "2005-10-01T07:52:21Z", "bug_id": 36883, "creation_time": "2005-10-01T07:52:21Z", "attachment_id": null}, {"count": 1, "tags": [], "text": "If you bring up the same stock configurations described above, you can also \nreproduce the redirect to HTTPS problem by accessing http://tomcat/tomcat-docs.", "is_private": false, "id": 80688, "creator": "noel@devtech.com", "time": "2005-10-03T04:06:57Z", "bug_id": 36883, "creation_time": "2005-10-03T04:06:57Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 36883, "attachment_id": null, "id": 80860, "time": "2005-10-06T20:05:41Z", "creator": "noel@devtech.com", "creation_time": "2005-10-06T20:05:41Z", "is_private": false, "text": "I can reproduce the problem with 5.5.12 (and httpd 2.0.8) as well, so since \nfrom the lack of response no one in tomcat-dev appears to care about problems \nwith 5.0.x, I'm modifying the record to show that it effects the current \ndevelopment branch, too."}, {"count": 3, "tags": [], "creator": "noel@devtech.com", "attachment_id": null, "is_private": false, "id": 80862, "time": "2005-10-06T20:09:54Z", "bug_id": 36883, "creation_time": "2005-10-06T20:09:54Z", "text": "(In reply to comment #2)\n> ... httpd 2.0.8 ...\n\nEr, make that 2.1.8, i.e., the latest available code."}, {"count": 4, "tags": [], "text": "(In reply to comment #2)\n> I can reproduce the problem with 5.5.12 (and httpd 2.0.8) as well, so since \n> from the lack of response no one in tomcat-dev appears to care about \nproblems \n> with 5.0.x, I'm modifying the record to show that it effects the current \n> development branch, too.\n\nIt seems that the problem is that mod_proxy_ajp isn't playing nice with \nmod_ssl (so that this is really a Httpd bug).  Even when the connection isn't \nHTTPS, mod_proxy_ajp is sending (empty) SSL attributes like cipher, client-\ncert, session-id.  This causes Tomcat to believe that the request was recieved \non HTTPS, so it redirects accordingly.  Below is a dump of the Request message \nthat Tomcat recieves from Httpd:\n\nFINE: 12 34 00 6b 02 02 00 08 48 54 54 50 2f 31 2e 31  | .4.k....HTTP/1.1\nFINE: 00 00 0c 2f 74 6f 6d 63 61 74 2d 64 6f 63 73 00  | .../tomcat-docs.\nFINE: 00 09 31 32 37 2e 30 2e 30 2e 31 00 ff ff 00 07  | ..127.0.0.1.??..\nFINE: 68 6f 75 73 74 6f 6e 00 22 b8 00 00 02 a0 0b 00  | houston.\"?...?..\nFINE: 0c 68 6f 75 73 74 6f 6e 3a 38 38 38 38 00 00 0c  | .houston:8888...\nFINE: 4d 61 78 2d 46 6f 72 77 61 72 64 73 00 00 02 31  | Max-Forwards...1\nFINE: 30 00 07 00 00 00 08 00 00 00 09 00 00 00 ff     | 0.............?\n", "is_private": false, "id": 80874, "creator": "william.barker@wilshire.com", "time": "2005-10-06T22:22:27Z", "bug_id": 36883, "creation_time": "2005-10-06T22:22:27Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 36883, "attachment_id": null, "id": 80882, "time": "2005-10-07T01:26:44Z", "creator": "noel@devtech.com", "creation_time": "2005-10-07T01:26:44Z", "is_private": false, "text": "Now that William Barker has assessed the defect locale, try reassigning to \nApache httpd-2.0 product."}, {"count": 6, "tags": [], "bug_id": 36883, "attachment_id": 16617, "text": "Created attachment 16617\nPatch against trunk\n\nThanks to all for the analysis data. The attached patch against trunk should\nfix this. Can you please give it a try and give feedback.", "id": 80892, "time": "2005-10-07T15:22:23Z", "creator": "rpluem@apache.org", "creation_time": "2005-10-07T15:22:23Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 36883, "attachment_id": 16619, "text": "Created attachment 16619\nPatch against Tomcat 5.5.9\n\nAfter doing some further tests and further analysis I must revert my earlier\nassumption that this is a httpd bug. It rather seems that\norg.apache.ajp.RequestHandler does not honour the isSSL bit inside an ajp\nmessage correctly. Attached is a patch against Tomcat 5.5.9 that should fix\nthis.", "id": 80896, "time": "2005-10-07T16:05:19Z", "creator": "rpluem@apache.org", "creation_time": "2005-10-07T16:05:19Z", "is_private": false}, {"count": 8, "tags": [], "creator": "mturk@apache.org", "attachment_id": null, "is_private": false, "id": 80898, "time": "2005-10-07T16:21:32Z", "bug_id": 36883, "creation_time": "2005-10-07T16:21:32Z", "text": "Hi,\n\nI must dissagree with you.\nThe bug has nothing to do with Tomcat.\nTomcat works pretty well with mod_jk w or w/o SSL.\n\nThe error is obviously in mod_proxy_ajp."}, {"count": 9, "tags": [], "text": "Mladen is insisting that the problem is with mod_proxy_ajp, so he'll veto the\npatch. Unfortunately, he's quite busy right now, so more comments later.\n\nIt also seems to me that it is a mod_proxy_ajp bug if it sends bogus HTTPS\nrelated headers if this isn't actually using HTTPS.", "is_private": false, "id": 80899, "creator": "remm@apache.org", "time": "2005-10-07T16:23:29Z", "bug_id": 36883, "creation_time": "2005-10-07T16:23:29Z", "attachment_id": null}, {"count": 10, "tags": [], "text": "(In reply to comment #7)\n> Created an attachment (id=16619) [edit]\n> Patch against Tomcat 5.5.9\n> After doing some further tests and further analysis I must revert my earlier\n> assumption that this is a httpd bug. It rather seems that\n> org.apache.ajp.RequestHandler does not honour the isSSL bit inside an ajp\n> message correctly. Attached is a patch against Tomcat 5.5.9 that should fix\n> this.\n\nThe first patch of mod_proxy_ajp is sub-optimal, but will work.  It would be \nbetter if mod_proxy_ajp honored the is_ssl flag and didn't bother to check the \nSSL attributes unless it was set.\n\nYour patch of Tomcat isn't even worth vetoing, since the patched class doesn't \nexist in 5.5.x, and is deprecated in 4.1.x.\n", "attachment_id": null, "bug_id": 36883, "id": 80901, "time": "2005-10-07T16:40:18Z", "creator": "william.barker@wilshire.com", "creation_time": "2005-10-07T16:40:18Z", "is_private": false}, {"count": 11, "tags": [], "text": "Play watch the bouncing bug ;-).", "is_private": false, "id": 80903, "creator": "william.barker@wilshire.com", "time": "2005-10-07T16:58:34Z", "bug_id": 36883, "creation_time": "2005-10-07T16:58:34Z", "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 36883, "attachment_id": 16620, "id": 80904, "time": "2005-10-07T17:02:45Z", "creator": "william.barker@wilshire.com", "creation_time": "2005-10-07T17:02:45Z", "is_private": false, "text": "Created attachment 16620\nFix for mod_proxy_ajp's SSL attributes\n\nThis fixes mod_proxy_ajp handling of SSL attributes.  Not only does it stop it\nfrom sending garbage to Tomcat, but it doesn't even bother with the lookup\nunless the request came in on SSL.  And, as a bonus feature, it even gets the\nkey-size working again.\n\nSomeday, mod_proxy_ajp may be almost as good as mod_jk ;-)."}, {"count": 13, "tags": [], "bug_id": 36883, "attachment_id": null, "is_private": false, "id": 80914, "time": "2005-10-07T20:38:20Z", "creator": "rpluem@apache.org", "creation_time": "2005-10-07T20:38:20Z", "text": "Apart from a few minor style issues the patch looks good to me. Thanks. It\nremoves the problem I saw with my first version of the patch which did not fix\nit correctly. What still worries me a little bit is the comment above the\nkey_size block, which says \"added support only in ajp14 mode\". Maybe I am just\nmisreading this comment, but could someone of the AJP gurus confirm that this\nattribute is also valid in AJP13?"}, {"count": 14, "tags": [], "text": "(In reply to comment #13)\n> misreading this comment, but could someone of the AJP gurus confirm that this\n> attribute is also valid in AJP13?\n\nAll current release versions of Tomcat support it, and any older ones will \nignore an attribute that they don't recognize.\n\n\n\n", "attachment_id": null, "bug_id": 36883, "id": 80916, "time": "2005-10-07T21:27:39Z", "creator": "william.barker@wilshire.com", "creation_time": "2005-10-07T21:27:39Z", "is_private": false}, {"count": 15, "tags": [], "bug_id": 36883, "attachment_id": null, "id": 80918, "time": "2005-10-07T23:13:20Z", "creator": "rpluem@apache.org", "creation_time": "2005-10-07T23:13:20Z", "is_private": false, "text": "Committed a style adjusted variant to trunk (r307195)\nhttp://svn.apache.org/viewcvs.cgi/httpd/httpd/trunk/modules/proxy/ajp_header.c?rev=307195&r1=232247&r2=307195\n\nand to 2.2.x branch (r307196)\nhttp://svn.apache.org/viewcvs.cgi/httpd/httpd/branches/2.2.x/modules/proxy/ajp_header.c?rev=307196&r1=234103&r2=307196\n"}, {"count": 16, "tags": [], "bug_id": 36883, "attachment_id": null, "id": 80919, "time": "2005-10-07T23:17:43Z", "creator": "rpluem@apache.org", "creation_time": "2005-10-07T23:17:43Z", "is_private": false, "text": "(In reply to comment #8)\n> Hi,\n> \n> I must dissagree with you.\n> The bug has nothing to do with Tomcat.\n> Tomcat works pretty well with mod_jk w or w/o SSL.\n> \n> The error is obviously in mod_proxy_ajp.\n\nAgreed, but I am not sure if the AJP connector on Tomcat side should set isSSL\nto true once it finds some of the SSL variables in the AJP message. From my\npoint of view it should also ignore all SSL variables in the message if isSSL is\nset to false in the message."}]