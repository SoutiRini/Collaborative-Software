[{"count": 0, "tags": [], "bug_id": 59911, "attachment_id": null, "id": 192711, "creation_time": "2016-07-29T10:23:35Z", "time": "2016-07-29T10:23:35Z", "creator": "jan0michael@yahoo.com", "text": "Im trying to use tomcat 9.0.0.M9 with certificates from PEM files.\nI do not want to use openssl and APR based Apache Tomcat Native library to be not affected by security holes in native code.\nSo I installed a virtual server with no tomcat native library and no openssl.\n\n\nRelevant part from server.xml:\n\n  <Service name=\"Catalina\">\n\n    <!-- Connector port=\"8080\" protocol=\"HTTP/1.1\"... -->\n    <Connector port=\"8080\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\"\n               connectionTimeout=\"20000\" redirectPort=\"8443\" />\n    \n    <Connector port=\"8443\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\"\n               maxThreads=\"150\" SSLEnabled=\"true\" scheme=\"https\" secure=\"true\"\n               defaultSSLHostConfigName=\"abcde.xyz-informatik.de\">\n        <SSLHostConfig hostName=\"abcde.xyz-informatik.de\">\n            <!-- Certificate certificateKeystoreFile=\"conf/localhost-rsa.jks\"\n                         type=\"RSA\" /-->\n            <Certificate certificateFile=\"conf/ssl/abcde.xyz-informatik.de/domain.crt\"\n                         certificateChainFile=\"conf/ssl/abcde.xyz-informatik.de/chain.crt\"\n                         certificateKeyFile=\"conf/ssl/abcde.xyz-informatik.de/domain.key\"\n                         certificateKeyPassword=\"\"\n                         type=\"RSA\" />\n        </SSLHostConfig>\n    </Connector>\n\n\n\n\nGives exception at startup (if .keystore exists):\n\n29-Jul-2016 12:14:36.217 INFO [main] org.apache.coyote.AbstractProtocol.init Initializing ProtocolHandler [\"https-jsse-nio-8443\"]\n29-Jul-2016 12:14:36.620 SEVERE [main] org.apache.coyote.AbstractProtocol.init Failed to initialize end point associated with ProtocolHandler [\"https-jsse-nio-8443\"]\n java.lang.IllegalArgumentException: java.io.IOException: Alias name tomcat does not identify a key entry\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.createSSLContext(AbstractJsseEndpoint.java:102)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.initialiseSsl(AbstractJsseEndpoint.java:80)\n\tat org.apache.tomcat.util.net.NioEndpoint.bind(NioEndpoint.java:245)\n\tat org.apache.tomcat.util.net.AbstractEndpoint.init(AbstractEndpoint.java:866)\n\tat org.apache.coyote.AbstractProtocol.init(AbstractProtocol.java:558)\n\tat org.apache.coyote.http11.AbstractHttp11Protocol.init(AbstractHttp11Protocol.java:65)\n\tat org.apache.catalina.connector.Connector.initInternal(Connector.java:1010)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.core.StandardService.initInternal(StandardService.java:549)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.core.StandardServer.initInternal(StandardServer.java:873)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.startup.Catalina.load(Catalina.java:606)\n\tat org.apache.catalina.startup.Catalina.load(Catalina.java:629)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.apache.catalina.startup.Bootstrap.load(Bootstrap.java:311)\n\tat org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:494)\nCaused by: java.io.IOException: Alias name tomcat does not identify a key entry\n\tat org.apache.tomcat.util.net.jsse.JSSEUtil.getKeyManagers(JSSEUtil.java:213)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.createSSLContext(AbstractJsseEndpoint.java:100)\n\t... 19 more\n\n29-Jul-2016 12:14:36.623 SEVERE [main] org.apache.catalina.core.StandardService.initInternal Failed to initialize connector [Connector[HTTP/1.1-8443]]\n org.apache.catalina.LifecycleException: Failed to initialize component [Connector[HTTP/1.1-8443]]\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:112)\n\tat org.apache.catalina.core.StandardService.initInternal(StandardService.java:549)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.core.StandardServer.initInternal(StandardServer.java:873)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.startup.Catalina.load(Catalina.java:606)\n\tat org.apache.catalina.startup.Catalina.load(Catalina.java:629)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.apache.catalina.startup.Bootstrap.load(Bootstrap.java:311)\n\tat org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:494)\nCaused by: org.apache.catalina.LifecycleException: Protocol handler initialization failed\n\tat org.apache.catalina.connector.Connector.initInternal(Connector.java:1013)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\t... 12 more\nCaused by: java.lang.IllegalArgumentException: java.io.IOException: Alias name tomcat does not identify a key entry\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.createSSLContext(AbstractJsseEndpoint.java:102)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.initialiseSsl(AbstractJsseEndpoint.java:80)\n\tat org.apache.tomcat.util.net.NioEndpoint.bind(NioEndpoint.java:245)\n\tat org.apache.tomcat.util.net.AbstractEndpoint.init(AbstractEndpoint.java:866)\n\tat org.apache.coyote.AbstractProtocol.init(AbstractProtocol.java:558)\n\tat org.apache.coyote.http11.AbstractHttp11Protocol.init(AbstractHttp11Protocol.java:65)\n\tat org.apache.catalina.connector.Connector.initInternal(Connector.java:1010)\n\t... 13 more\nCaused by: java.io.IOException: Alias name tomcat does not identify a key entry\n\tat org.apache.tomcat.util.net.jsse.JSSEUtil.getKeyManagers(JSSEUtil.java:213)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.createSSLContext(AbstractJsseEndpoint.java:100)\n\t... 19 more\n\n\n\n\n\nGives exception at startup (if .keystore does not exist):\n\n\n\n29-Jul-2016 12:18:19.366 INFO [main] org.apache.coyote.AbstractProtocol.init Initializing ProtocolHandler [\"https-jsse-nio-8443\"]\n29-Jul-2016 12:18:19.821 SEVERE [main] org.apache.tomcat.util.net.SSLUtilBase.getStore Failed to load keystore type [JKS] with path [/opt/tomcat9//.keystore] due to [/opt/tomcat9/.keystore (No such file or directory)]\n java.io.FileNotFoundException: /opt/tomcat9/.keystore (No such file or directory)\n\tat java.io.FileInputStream.open0(Native Method)\n\tat java.io.FileInputStream.open(FileInputStream.java:195)\n\tat java.io.FileInputStream.<init>(FileInputStream.java:138)\n\tat java.io.FileInputStream.<init>(FileInputStream.java:93)\n\tat sun.net.www.protocol.file.FileURLConnection.connect(FileURLConnection.java:90)\n\tat sun.net.www.protocol.file.FileURLConnection.getInputStream(FileURLConnection.java:188)\n\tat org.apache.tomcat.util.file.ConfigFileLoader.getInputStream(ConfigFileLoader.java:96)\n\tat org.apache.tomcat.util.net.SSLUtilBase.getStore(SSLUtilBase.java:129)\n\tat org.apache.tomcat.util.net.SSLHostConfigCertificate.getCertificateKeystore(SSLHostConfigCertificate.java:187)\n\tat org.apache.tomcat.util.net.jsse.JSSEUtil.getKeyManagers(JSSEUtil.java:189)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.createSSLContext(AbstractJsseEndpoint.java:100)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.initialiseSsl(AbstractJsseEndpoint.java:80)\n\tat org.apache.tomcat.util.net.NioEndpoint.bind(NioEndpoint.java:245)\n\tat org.apache.tomcat.util.net.AbstractEndpoint.init(AbstractEndpoint.java:866)\n\tat org.apache.coyote.AbstractProtocol.init(AbstractProtocol.java:558)\n\tat org.apache.coyote.http11.AbstractHttp11Protocol.init(AbstractHttp11Protocol.java:65)\n\tat org.apache.catalina.connector.Connector.initInternal(Connector.java:1010)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.core.StandardService.initInternal(StandardService.java:549)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.core.StandardServer.initInternal(StandardServer.java:873)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.startup.Catalina.load(Catalina.java:606)\n\tat org.apache.catalina.startup.Catalina.load(Catalina.java:629)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.apache.catalina.startup.Bootstrap.load(Bootstrap.java:311)\n\tat org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:494)\n\n29-Jul-2016 12:18:19.824 SEVERE [main] org.apache.coyote.AbstractProtocol.init Failed to initialize end point associated with ProtocolHandler [\"https-jsse-nio-8443\"]\n java.lang.IllegalArgumentException: java.io.FileNotFoundException: /opt/tomcat9/.keystore (No such file or directory)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.createSSLContext(AbstractJsseEndpoint.java:102)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.initialiseSsl(AbstractJsseEndpoint.java:80)\n\tat org.apache.tomcat.util.net.NioEndpoint.bind(NioEndpoint.java:245)\n\tat org.apache.tomcat.util.net.AbstractEndpoint.init(AbstractEndpoint.java:866)\n\tat org.apache.coyote.AbstractProtocol.init(AbstractProtocol.java:558)\n\tat org.apache.coyote.http11.AbstractHttp11Protocol.init(AbstractHttp11Protocol.java:65)\n\tat org.apache.catalina.connector.Connector.initInternal(Connector.java:1010)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.core.StandardService.initInternal(StandardService.java:549)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.core.StandardServer.initInternal(StandardServer.java:873)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.startup.Catalina.load(Catalina.java:606)\n\tat org.apache.catalina.startup.Catalina.load(Catalina.java:629)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.apache.catalina.startup.Bootstrap.load(Bootstrap.java:311)\n\tat org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:494)\nCaused by: java.io.FileNotFoundException: /opt/tomcat9/.keystore (No such file or directory)\n\tat java.io.FileInputStream.open0(Native Method)\n\tat java.io.FileInputStream.open(FileInputStream.java:195)\n\tat java.io.FileInputStream.<init>(FileInputStream.java:138)\n\tat java.io.FileInputStream.<init>(FileInputStream.java:93)\n\tat sun.net.www.protocol.file.FileURLConnection.connect(FileURLConnection.java:90)\n\tat sun.net.www.protocol.file.FileURLConnection.getInputStream(FileURLConnection.java:188)\n\tat org.apache.tomcat.util.file.ConfigFileLoader.getInputStream(ConfigFileLoader.java:96)\n\tat org.apache.tomcat.util.net.SSLUtilBase.getStore(SSLUtilBase.java:129)\n\tat org.apache.tomcat.util.net.SSLHostConfigCertificate.getCertificateKeystore(SSLHostConfigCertificate.java:187)\n\tat org.apache.tomcat.util.net.jsse.JSSEUtil.getKeyManagers(JSSEUtil.java:189)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.createSSLContext(AbstractJsseEndpoint.java:100)\n\t... 19 more\n\n29-Jul-2016 12:18:19.827 SEVERE [main] org.apache.catalina.core.StandardService.initInternal Failed to initialize connector [Connector[HTTP/1.1-8443]]\n org.apache.catalina.LifecycleException: Failed to initialize component [Connector[HTTP/1.1-8443]]\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:112)\n\tat org.apache.catalina.core.StandardService.initInternal(StandardService.java:549)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.core.StandardServer.initInternal(StandardServer.java:873)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\tat org.apache.catalina.startup.Catalina.load(Catalina.java:606)\n\tat org.apache.catalina.startup.Catalina.load(Catalina.java:629)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.apache.catalina.startup.Bootstrap.load(Bootstrap.java:311)\n\tat org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:494)\nCaused by: org.apache.catalina.LifecycleException: Protocol handler initialization failed\n\tat org.apache.catalina.connector.Connector.initInternal(Connector.java:1013)\n\tat org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n\t... 12 more\nCaused by: java.lang.IllegalArgumentException: java.io.FileNotFoundException: /opt/tomcat9/.keystore (No such file or directory)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.createSSLContext(AbstractJsseEndpoint.java:102)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.initialiseSsl(AbstractJsseEndpoint.java:80)\n\tat org.apache.tomcat.util.net.NioEndpoint.bind(NioEndpoint.java:245)\n\tat org.apache.tomcat.util.net.AbstractEndpoint.init(AbstractEndpoint.java:866)\n\tat org.apache.coyote.AbstractProtocol.init(AbstractProtocol.java:558)\n\tat org.apache.coyote.http11.AbstractHttp11Protocol.init(AbstractHttp11Protocol.java:65)\n\tat org.apache.catalina.connector.Connector.initInternal(Connector.java:1010)\n\t... 13 more\nCaused by: java.io.FileNotFoundException: /opt/tomcat9/.keystore (No such file or directory)\n\tat java.io.FileInputStream.open0(Native Method)\n\tat java.io.FileInputStream.open(FileInputStream.java:195)\n\tat java.io.FileInputStream.<init>(FileInputStream.java:138)\n\tat java.io.FileInputStream.<init>(FileInputStream.java:93)\n\tat sun.net.www.protocol.file.FileURLConnection.connect(FileURLConnection.java:90)\n\tat sun.net.www.protocol.file.FileURLConnection.getInputStream(FileURLConnection.java:188)\n\tat org.apache.tomcat.util.file.ConfigFileLoader.getInputStream(ConfigFileLoader.java:96)\n\tat org.apache.tomcat.util.net.SSLUtilBase.getStore(SSLUtilBase.java:129)\n\tat org.apache.tomcat.util.net.SSLHostConfigCertificate.getCertificateKeystore(SSLHostConfigCertificate.java:187)\n\tat org.apache.tomcat.util.net.jsse.JSSEUtil.getKeyManagers(JSSEUtil.java:189)\n\tat org.apache.tomcat.util.net.AbstractJsseEndpoint.createSSLContext(AbstractJsseEndpoint.java:100)\n\t... 19 more\n\n\n\nI found this: #59910", "is_private": false}, {"count": 1, "tags": [], "bug_id": 59911, "attachment_id": null, "id": 192814, "time": "2016-08-02T14:44:51Z", "creator": "remm@apache.org", "creation_time": "2016-08-02T14:44:51Z", "is_private": false, "text": "Please don't file duplicates on purpose.\n\n*** This bug has been marked as a duplicate of bug 59904 ***"}, {"count": 2, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "id": 192817, "time": "2016-08-02T14:46:39Z", "bug_id": 59911, "creation_time": "2016-08-02T14:46:39Z", "is_private": false, "text": "Wrong BZ."}, {"count": 3, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "id": 192821, "time": "2016-08-02T15:05:43Z", "bug_id": 59911, "creation_time": "2016-08-02T15:05:43Z", "is_private": false, "text": "Although the exception is confusing, this is supposed to work (see BZ 59344) and I've verified it works for me. There's probably some issue with your PEM key which isn't valid and thus it says there's no \"tomcat\" key in the (virtual) keystore [that's the default key alias for now, see BZ 59910]. Please investigate on the user list."}, {"count": 4, "tags": [], "creator": "jan0michael@yahoo.com", "attachment_id": null, "is_private": false, "id": 192869, "time": "2016-08-03T19:37:13Z", "bug_id": 59911, "creation_time": "2016-08-03T19:37:13Z", "text": "> There's probably some issue with your PEM key\n\nIf there was a problem with the PEM key, I would expect Tomcat to throw an exception and stop. It would be a security problem, if Tomcat would use another key than the configured one.\n\nBy the way: I can display key, certificate and certificate chain with openssl without problem.\n\n\n> Please don't file duplicates on purpose\n\n#59910 is not a duplicate of what I have described. I just thought, that maybe #59910 could be a hint, that the certificate selection code in 9.0.0.M9 may have some shortcomings.\n\nThank you for your help and confirmation, that it works for you.\nI'll do some more tests, as soon as I find some time for it.\nI don't have openssl and I don't have the tomcat native library installed, so that will be the first thing I am going to test."}, {"count": 5, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "id": 192870, "time": "2016-08-03T19:51:18Z", "bug_id": 59911, "creation_time": "2016-08-03T19:51:18Z", "is_private": false, "text": "> > Please don't file duplicates on purpose\n> \n> #59910 is not a duplicate of what I have described.\n\nThe duplicate thing was a mistake, please ignore it.\n\n> I just thought, that\n> maybe #59910 could be a hint, that the certificate selection code in\n> 9.0.0.M9 may have some shortcomings.\n\nThere's no certificate selection code, Tomcat uses a virtual keystore with a single key created from your pems. The key alias is \"tomcat\", hence the error message.\nBZ 59344 is where to look.\n\n> Thank you for your help and confirmation, that it works for you.\n> I'll do some more tests, as soon as I find some time for it.\n> I don't have openssl and I don't have the tomcat native library installed,\n> so that will be the first thing I am going to test.\n\nPlease investigate in the user list."}]