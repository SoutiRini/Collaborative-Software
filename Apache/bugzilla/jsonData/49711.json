[{"count": 0, "tags": [], "text": "In order to have the ability to process multipart/form-data transparently with help of the new Servlet 3.0 HttpServletRequest#getParts(), a Filter is the most suitable place for this. \n\nThis works fine in Glassfish v3. However, in Tomcat the getParts() returns null and it works only inside a servlet with @MultipartConfig annotation.\n\nThis is too strict. This makes it hard if not impossible to process multipart/form-data requests transparently with help of a Filter (i.e. creating a new parametermap and replacing the original one in HttpServletRequest).\n\nIt is true that the Servlet 3.0 spec tells nothing about the use of this method inside a Filter, but this is in my opinion an oversight. There is no other way to obtain the parts than parsing the stream yourself with good 'ol Apache Commons FileUpload.\n\nSince it works fine in Glassfish v3, I'd suggest to make Tomcat 7 that lenient as well.", "is_private": false, "bug_id": 49711, "id": 138927, "time": "2010-08-05T16:39:53Z", "creator": "balusc@gmail.com", "creation_time": "2010-08-05T16:39:53Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 49711, "attachment_id": null, "id": 138930, "time": "2010-08-05T16:51:57Z", "creator": "markt@apache.org", "creation_time": "2010-08-05T16:51:57Z", "is_private": false, "text": "I've just read the spec and my reading of the spec is that this is expected to work. A quick look at the code suggests it should work. If you want to dig into this yourself, start at line 2499 of o.a.catalina.connector.Request"}, {"count": 2, "tags": [], "creator": "balusc@gmail.com", "is_private": false, "text": "Correction: it didn't return null, it returned an empty collection.\n\nI will dig in the source.", "id": 138931, "time": "2010-08-05T17:11:24Z", "bug_id": 49711, "creation_time": "2010-08-05T17:11:24Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 49711, "attachment_id": null, "id": 138933, "time": "2010-08-05T17:57:50Z", "creator": "balusc@gmail.com", "creation_time": "2010-08-05T17:57:50Z", "is_private": false, "text": "Well, the getWrapper().getMultipartConfigElement() at line 2493 always returns null and thus an empty collection will be returned. Only when I call getParts() inside a Servlet with @MultipartConfig, it works. But the intent is to call getParts() inside a Filter. The getWrapper() always returns the target JSP/Servlet associated with the request which in my case does not necessarily have the @MultipartConfig annotation (or cannot have one because it's a 3rd party one out of your control, e.g. FacesServlet)."}, {"count": 4, "tags": [], "creator": "markt@apache.org", "is_private": false, "id": 139351, "attachment_id": null, "bug_id": 49711, "creation_time": "2010-08-22T19:03:13Z", "time": "2010-08-22T19:03:13Z", "text": "If the Servlet doesn't have the @MultipartConfig annotation then getParts() should not work. Tomcat is therefore specification compliant in this regard.\n\nI'm not adverse to adding a (probably per context) configuration attribute to relax this requirement. Therefore, I am changing this to an enhancement request."}, {"count": 5, "tags": [], "text": "Thank you. This is imo an oversight in the Servlet 3.0 specification. I will report it sooner or later.", "attachment_id": null, "bug_id": 49711, "id": 139352, "time": "2010-08-22T19:10:21Z", "creator": "balusc@gmail.com", "creation_time": "2010-08-22T19:10:21Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 49711, "attachment_id": null, "id": 141547, "time": "2010-11-08T10:15:52Z", "creator": "chris@christopherschultz.net", "creation_time": "2010-11-08T10:15:52Z", "is_private": false, "text": "If @MultipartConfig in a servlet is the sole way to trigger multipart handling during a request, then a Filter must be able to check the target servlet to determine if Request.getParts will work (which I don't believe is possible). I agree with balusc's assertion that this is an oversight in the specification.\n\nMy only question is what the overall behavior should be. If a Filter calls Request.getParts and the content-type of the request is multipart/form-data, should Tomcat simply parse it as a multipart request regardless of the presence (or absence) of an @MultipartConfig annotation on the servlet?\n\nI would argue that Tomcat /should/ go ahead and do this. I would also argue that this ought to be the /default configuration/ as well.\n\nThere are some web applications where a Filter is expected to be the content generator. All Apache Struts 2 applications are like this: the front controller is implemented as a Filter instead of as a Servlet (don't ask me why this is the case). Ignoring the fact that S2 provides multipart parsing itself, S2 applications would not be able to use the 3.0 specification for loading multipart data because the request will never reach a servlet (or, at best, the request would have to be mapped to both a Filter which does the real work, and to a dummy servlet that simply has the @MultipartConfig annotation just to achieve the goal)."}, {"count": 7, "tags": [], "bug_id": 49711, "attachment_id": null, "id": 141737, "time": "2010-11-15T19:40:59Z", "creator": "balusc@gmail.com", "creation_time": "2010-11-15T19:40:59Z", "is_private": false, "text": "FYI: this issue is currently reported on servlet-spec-public: https://servlet-spec-public.dev.java.net/issues/show_bug.cgi?id=14"}, {"count": 8, "tags": [], "bug_id": 49711, "attachment_id": null, "id": 143524, "time": "2011-01-20T16:20:54Z", "creator": "chris@christopherschultz.net", "creation_time": "2011-01-20T16:20:54Z", "is_private": false, "text": "Working on a patch."}, {"count": 9, "tags": [], "bug_id": 49711, "attachment_id": null, "id": 143566, "time": "2011-01-21T12:48:10Z", "creator": "chris@christopherschultz.net", "creation_time": "2011-01-21T12:48:10Z", "is_private": false, "text": "Fixed. Will be available in 7.0.7 onwards.\n\nSee documentation for <Connector> for how to enable this."}, {"count": 10, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "is_private": false, "id": 143569, "time": "2011-01-21T13:29:26Z", "bug_id": 49711, "creation_time": "2011-01-21T13:29:26Z", "text": "Patch needs tweaking. Configuration belongs in the Context, not in the Connector."}, {"count": 11, "tags": [], "bug_id": 49711, "attachment_id": null, "id": 143570, "time": "2011-01-21T13:40:26Z", "creator": "chris@christopherschultz.net", "creation_time": "2011-01-21T13:40:26Z", "is_private": false, "text": "Fixed (again). Will be in 7.0.7 onwards."}, {"count": 12, "tags": [], "bug_id": 49711, "is_private": false, "id": 147522, "attachment_id": null, "creator": "nsnospam3@gmail.com", "creation_time": "2011-06-27T13:06:00Z", "time": "2011-06-27T13:06:00Z", "text": "Fixed in 7.0.7, but back in 7.0.16?? \nPlease tell me if I'm wrong, but the code from BalusC works with Glassfish v3.1 it dosn't with Tomcat 7.0.16. HttpServletRequest#getParts() in the filter returns an empty collection.\nDo anybody know more about it?"}, {"count": 13, "tags": [], "text": "See allowCasualMultipartParsing on the Context and ask on the users list if you have any further questions.", "is_private": false, "bug_id": 49711, "id": 147523, "time": "2011-06-27T13:09:34Z", "creator": "markt@apache.org", "creation_time": "2011-06-27T13:09:34Z", "attachment_id": null}, {"count": 14, "tags": [], "text": "This problem also exists in Tomcat 7.0.47.", "is_private": false, "bug_id": 49711, "id": 172507, "time": "2014-01-19T20:10:20Z", "creator": "noel@familie-kuntze.de", "creation_time": "2014-01-19T20:10:20Z", "attachment_id": null}, {"count": 15, "tags": [], "bug_id": 49711, "is_private": false, "id": 172513, "attachment_id": null, "creator": "knst.kolinko@gmail.com", "creation_time": "2014-01-19T22:25:32Z", "time": "2014-01-19T22:25:32Z", "text": "(In reply to noel from comment #14)\n> This problem also exists in Tomcat 7.0.47.\n\nThe burden of proof is yours. You provided no proof.\n\nPlease discuss this on the users mailing list so that others confirm\nthat there is an issue, before reopening or submitting other issue.\n\nNote that\n\n1. The testsuite contains testcases for this feature,\n\norg.apache.catalina.core.TestStandardContext#testBug49711()\norg.apache.catalina.connector.TestRequest#testBug54984()\n\nSo it does work, if configured properly.\n\n2. You must read documentation on \"allowCasualMultipartParsing\" option, as mentioned above. It is off by default.\n\nhttp://tomcat.apache.org/tomcat-7.0-doc/config/context.html\n\nRe-closing as FIXED."}]