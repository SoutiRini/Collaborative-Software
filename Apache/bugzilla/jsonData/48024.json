[{"count": 0, "tags": [], "text": "This has been reported to me by Bram <mod_sed@mail.wizbit.be>\n\nWhen Apache is used as a reverse proxy and mod_sed is used to filter\nto content and the output contains lines which are really long e.g\n1M-4M chracters in single line, mod_sed consumes too much memory.\n\nHere is the snips of the mail from Bram :\n- 1 mb file with only a newline at the end\n$ perl -we '$\\=\"\\x0D\\x0A\"; print \"a\" x (1 * 2 ** 20);' > /var/www/a.1.bin\n\nWhen the file is downloaded apache uses 70 mb of memory\n\n\n- 2 mb file with only a newline at the end:\n$ perl -we '$\\=\"\\x0D\\x0A\"; print \"a\" x (2 * 2 ** 20);' > /var/www/a.2.bin\n\nWhen the file is downloaded apache uses 277 mb of memory\n\n\n- 3 mb file with only a newline at the end:\n$ perl -we '$\\=\"\\x0D\\x0A\"; print \"a\" x (3 * 2 ** 20);' > /var/www/a.3.bin\n\nWhen the file is downloaded apache uses 608 mb of memory\n\n\n- 4 mb file with only a newline at the end:\n$ perl -we '$\\=\"\\x0D\\x0A\"; print \"a\" x (4 * 2 ** 20);' > /var/www/a.2.bin\n\nWhen the file is downloaded apache uses 1070 mb of memory\n\n------------------------------------------------\n\nI am able to reproduce the issue with following configuration :\n\nLoadModule sed_module modules/mod_sed.so\nLoadModule headers_module  modules/mod_headers.so\nLoadModule substitute_module  modules/mod_substitute.so\nLoadModule proxy_module          modules/mod_proxy.so\nLoadModule proxy_http_module     modules/mod_proxy_http.so\n\nProxyPass / http://hostname:8080/\n<Location />\n        Header unset Content-Length\n        SetOutputFilter Sed\n        OutputSed s/\\(https:\\/\\/192.168.173.114\\)\\//\\1:444\\//g\n</Location>\n\n------------------------------------------------\n\nThe above doesn't have any impact if line sizes are small which is the typical\ncase with html or ascii text.\n\n* Using core category because mod_sed component is not available.", "attachment_id": null, "id": 131228, "creation_time": "2009-10-19T11:49:58Z", "time": "2009-10-19T11:49:58Z", "creator": "basant.kukreja@sun.com", "bug_id": 48024, "is_private": false}, {"count": 1, "attachment_id": 24397, "creator": "basant.kukreja@sun.com", "text": "Created attachment 24397\nPatch\n\nsed needs to buffer the line until it finds the end of the line. \nAt present it increments the line buffer by 4KB size or based on new sizes.\nWhen mod_sed is used inside apache with regular files, number of time\nreallocation happens are less because single brigade contains the entire\nfile.\n\nBut when mod_sed is used as a reverse proxy then the number of times\nsed_response is called is called can be huge which means buffer will be\nreallocated many many times compared to filtering text directly.  I noticed\nthat for 2M characters in single line then mod_sed reallocated stuff in 275\ntimes.\n\nFix for this is that grow_buffer should grow the sizes at least each time it\nis invoked. This reduced the the reallocation to just 9 times for 2M line\nsize.\n\nFix is attached.\n\nBram confirmed that fix worked for him. Here is the comments from Bram.\n----------------------------------\nFor a 2 MB, 3 MB and 4 MB file it seems to be below 26/27 MB of memory.\nFor a 20 MB file it is around 98 MB of memory\n----------------------------------", "id": 131229, "time": "2009-10-19T11:54:06Z", "bug_id": 48024, "creation_time": "2009-10-19T11:54:06Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 48024, "text": "I need to correct the grammer :\n==============================================\nFix for this is that grow_buffer should grow the sizes at least twice each time \nit is invoked. This reduced the the reallocation to just 9 times for 2M line\nsize.\n==============================================", "id": 131230, "time": "2009-10-19T12:06:15Z", "creator": "basant.kukreja@sun.com", "creation_time": "2009-10-19T12:06:15Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 48024, "attachment_id": 24398, "id": 131231, "creation_time": "2009-10-19T12:18:46Z", "time": "2009-10-19T12:18:46Z", "creator": "basant.kukreja@sun.com", "text": "Created attachment 24398\nPatch against trunk\n\nPatched against trunk (Previous patch was generated by mistake by some other repository.", "is_private": false}, {"count": 4, "tags": [], "bug_id": 48024, "is_private": false, "text": "Thanks for the patch. Fixed in trunk as r826772. Also I added mod_sed as\ncomponent. Thanks for noting.", "id": 131232, "time": "2009-10-19T12:25:24Z", "creator": "rpluem@apache.org", "creation_time": "2009-10-19T12:25:24Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 48024, "text": "Closing since mod_sed is only in trunk", "id": 147486, "time": "2011-06-25T12:29:17Z", "creator": "sf@sfritsch.de", "creation_time": "2011-06-25T12:29:17Z", "is_private": false, "attachment_id": null}]