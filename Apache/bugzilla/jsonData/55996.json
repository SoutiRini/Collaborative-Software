[{"count": 0, "tags": [], "bug_id": 55996, "attachment_id": 31200, "id": 172321, "time": "2014-01-13T06:12:37Z", "creator": "hardeepsangha@gmail.com", "creation_time": "2014-01-13T06:12:37Z", "is_private": false, "text": "Created attachment 31200\nServlet with Async processing and Java Based client\n\nI created a ProblemServlet which receives request via a Java based client. The Servlet starts an Async processing for each request.\nWithin the Async processing run() method there is a while loop which cyclically sends String messages to the client. The implementation of run method is shown.\n\npublic void run()\n        {\n            try\n            {\n                String msg = \"\";\n                ServletOutputStream outputStream = publisherAsyncCtx.getResponse().getOutputStream();\n                boolean continu = true;\n                \n                while (continu)\n                {\n                    msg = \"\";\n\n                    msg = \"|\" + \" \" + new Date();\n                    System.out.println(\"publishing message... \" + msg);\n                    \n                    outputStream.println(msg);\n                    publisherAsyncCtx.getResponse().flushBuffer();\n                    \n                    try\n                    {\n                        Thread.sleep(1000);\n                    }\n                    catch (InterruptedException e)\n                    {\n                        System.out.println(\"sleep InterruptedException: \" + e.getMessage());\n                        e.printStackTrace();\n                    }\n                }\n            }\n\nWhen a Java based console application client hits this servlet and reads its output stream, for around 10 sec the messages arrive. But after 10 seconds the connection is closed by the server.\n\nLogs on the Server side:\nStarting the Async Context.\npublishing message... | Mon Jan 13 11:28:30 IST 2014\npublishing message... | Mon Jan 13 11:28:31 IST 2014\npublishing message... | Mon Jan 13 11:28:32 IST 2014\npublishing message... | Mon Jan 13 11:28:33 IST 2014\npublishing message... | Mon Jan 13 11:28:34 IST 2014\npublishing message... | Mon Jan 13 11:28:35 IST 2014\npublishing message... | Mon Jan 13 11:28:36 IST 2014\npublishing message... | Mon Jan 13 11:28:37 IST 2014\npublishing message... | Mon Jan 13 11:28:38 IST 2014\npublishing message... | Mon Jan 13 11:28:39 IST 2014\npublishing message... | Mon Jan 13 11:28:40 IST 2014\npublishing message... | Mon Jan 13 11:28:41 IST 2014\nException in thread \"http-bio-8080-exec-6\" java.lang.IllegalStateException: The request associated with the AsyncContext has already completed processing.\n\tat org.apache.catalina.core.AsyncContextImpl.check(AsyncContextImpl.java:521)\n\tat org.apache.catalina.core.AsyncContextImpl.getResponse(AsyncContextImpl.java:245)\n\tat com.pg.orion.artcloopcheck.ProblemServlet$AsynRunnable.run(ProblemServlet.java:67)\n\tat org.apache.catalina.core.AsyncContextImpl$RunnableWrapper.run(AsyncContextImpl.java:557)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:722)\n\n\nIssue is seen with \"apache-tomcat-7.0.50\", \"apache-tomcat-7.0.47\". Not tested with other release 7 variants.\nThe same codebase when run on \"apache-tomcat-8.0.0-RC10\" there are no issues."}, {"count": 1, "tags": [], "bug_id": 55996, "attachment_id": null, "id": 172343, "time": "2014-01-13T18:25:46Z", "creator": "markt@apache.org", "creation_time": "2014-01-13T18:25:46Z", "is_private": false, "text": "Tomcat 7 is behaving correctly. It is 8.0.x that has the bug. The Async context should timeout unless there is a call to dispatch() or complete() within the timeout. 8.0.x appears to be resetting the timeout counter on every write which is not correct."}, {"count": 2, "tags": [], "bug_id": 55996, "attachment_id": null, "id": 172379, "time": "2014-01-14T19:18:58Z", "creator": "markt@apache.org", "creation_time": "2014-01-14T19:18:58Z", "is_private": false, "text": "This has been fixed in 8.0.x for 8.0.0 and in 7.0.x for 7.0.51."}]