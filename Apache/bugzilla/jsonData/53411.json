[{"count": 0, "attachment_id": null, "creator": "jakub@pakamera.com.pl", "is_private": false, "id": 159971, "time": "2012-06-13T16:22:07Z", "bug_id": 53411, "creation_time": "2012-06-13T16:22:07Z", "tags": [], "text": "I can see in my log file a regular exception throwed by AbstractHttp11Processor, with this stack trace:\n\norg.apache.coyote.http11.AbstractHttp11Processor process\nError processing request\njava.lang.NullPointerException\n        at org.apache.tomcat.util.buf.CharChunk.append(CharChunk.java:355)\n        at org.apache.tomcat.util.http.mapper.Mapper.map(Mapper.java:667)\n        at org.apache.catalina.connector.CoyoteAdapter.postParseRequest(CoyoteAdapter.java:646)\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:402)\n        at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:999)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:565)\n        at org.apache.tomcat.util.net.AprEndpoint$SocketWithOptionsProcessor.run(AprEndpoint.java:1770)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)\n        at java.lang.Thread.run(Thread.java:722)\n\n\nI cannot find the request which makes this exception, it's rather rare, but still, I think it's worth to look at."}, {"text": "The NPE is triggered by the default host name being null. Such a configuration is invalid. Please follow up on the users list for assistance.", "tags": [], "bug_id": 53411, "attachment_id": null, "count": 1, "id": 159975, "time": "2012-06-13T17:43:56Z", "creator": "markt@apache.org", "creation_time": "2012-06-13T17:43:56Z", "is_private": false}, {"count": 2, "tags": [], "creator": "jakub@pakamera.com.pl", "attachment_id": null, "text": "Well, I think you've changed the status too early.\n\nMy Apache Tomcat 7 server is running, all web apps are working and defaultHost parameter in server.xml is set to \"localhost\":  <Engine name=\"Catalina\" defaultHost=\"localhost\">\n\nSo, this exception doesn't stop tomcat or any context, I don't even noticed if this exception is visible for any user. From the user point of view everything works fine.\nI've just noticed this strange stack trace in the log file and this is the only one exception which I can find there - that's why it caught my attention. \n\n\nEven if the problem is in the configuration - Tomcat should not start or should give a clear message during the startup, in my opinion.", "id": 159976, "time": "2012-06-13T17:58:58Z", "bug_id": 53411, "creation_time": "2012-06-13T17:58:58Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 53411, "attachment_id": null, "text": "There is insufficient information provided to reproduce the issue. The only information provided - the stack trace - points to a configuration problem. \n\nPlease do not re-open this issue without providing either:\n- sufficient information for it to be produced\n- analysis that identifies a code path that code trigger this issue\n\nThe users list is the place to seek help with obtaining either of the above.\n\nA warning is already logged if the default host cannot be identified.", "id": 159980, "time": "2012-06-13T19:37:13Z", "creator": "markt@apache.org", "creation_time": "2012-06-13T19:37:13Z", "is_private": false}, {"count": 4, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "is_private": false, "id": 159982, "time": "2012-06-13T20:49:32Z", "bug_id": 53411, "creation_time": "2012-06-13T20:49:32Z", "text": "Just for reference, confirming what Mark already wrote,\nin tc7.0.x/tags/TOMCAT_7_0_27\n\nCharChunk.java line 355\n[[[\n354 \tpublic void append(String s) throws IOException {\n355 \tappend(s, 0, s.length());\n356 \t}\n]]]\n\nSo \"s\" is null.\n\nMapper.java line 667\n[[[\n666 \tif (host.isNull()) {\n667 \thost.getCharChunk().append(defaultHostName);\n668 \t}\n]]]\n\nSo \"defaultHostName\" is null.\n\nThe \"if(host.isNull())\" branch is executed when it is an HTTP/1.0 request that does not have a \"Host\" header. Such requests are rare nowadays.\n\n\n(In reply to comment #2)\n> <Engine name=\"Catalina\" defaultHost=\"localhost\">\n\nThere must exist <Host name=\"localhost\" > for that. If it does not, the defaultHost value will be ignored.\n\nMapperListener.java\n[[[\n        if(found) {\n            mapper.setDefaultHostName(defaultHost);\n        } else {\n            log.warn(sm.getString(\"mapperListener.unknownDefaultHost\",\n                    defaultHost, connector));\n        }\n]]]"}, {"count": 5, "attachment_id": null, "creator": "knst.kolinko@gmail.com", "is_private": false, "id": 159985, "time": "2012-06-13T21:55:10Z", "bug_id": 53411, "creation_time": "2012-06-13T21:55:10Z", "tags": [], "text": "Reopening this as enhancement.\n\nLooking at AbstractHttp11Processor#process() this error is correctly written to access log, etc, so I do not see much concern.\n\nStill I think there is a room for improvement, and I noted several minor issues from my code review.\n\n\n1) in MapperListener#findDefaultHost()\n\nFirst, maybe \ns/log.warn(sm.getString(\"mapperListener.unknownDefaultHost\",/log.error/ \n\nSecond, maybe mention something like \" Tomcat will not be able to process HTTP/1.0 requests that do not specify a Host header\" in the message.\n\nThird, I am a bit wondering why not to call mapper.setDefaultHost() unconditionally. What is wrong with passing a name there?\n\nHosts can be added and removed through JMX calls on StandardEngine#addChild()/removeChild() and it seems that MapperListener fails to update defaultHost setting on the Mapper when it happens.\n\nSo why not to pass the defaultHost name to the Mapper as is and let it handle missing matches (like it already does)?\n\n\n2) in Mapper#map(MB,MB,S,MD)\n\nFourth,\nMaybe just return without mapping here, as if the Host is not found. We already do if(defaultHostName==null){ return; } in its #internalMap(CC,CC,S,MD) method.\n\nIt will need some update to its caller though, which is\nCoyoteAdapter#postParseRequest()\n\n\n3) In CoyoteAdapter#postParseRequest()\n\nThis request could be rejected with error 404, instead of 400 that exception handling in AbstractHttp11Processor#process() does. The postParseRequest() already has code for handling it as 404, but\n\nFifth,\naccess logging needs to be changed a bit. The current code:\n\n[[[\n                // Make sure there is a host (might not be during shutdown)\n                if (host != null) {\n                    host.logAccess(request, response, 0, true);\n                }\n]]]\n\nI think that it should fallback to CoyoteAdapter#log(..) when host is null."}, {"count": 6, "tags": [], "creator": "jakub@pakamera.com.pl", "attachment_id": null, "is_private": false, "id": 160006, "time": "2012-06-14T13:24:25Z", "bug_id": 53411, "creation_time": "2012-06-14T13:24:25Z", "text": "(In reply to comment #5)\n> Reopening this as enhancement.\n> \n> Looking at AbstractHttp11Processor#process() this error is correctly written\n> to access log, etc, so I do not see much concern.\n> \n> Still I think there is a room for improvement, and I noted several minor\n> issues from my code review.\n> \n> \n> 1) in MapperListener#findDefaultHost()\n> \n> First, maybe \n> s/log.warn(sm.getString(\"mapperListener.unknownDefaultHost\",/log.error/ \n> \n> Second, maybe mention something like \" Tomcat will not be able to process\n> HTTP/1.0 requests that do not specify a Host header\" in the message.\n> \n> Third, I am a bit wondering why not to call mapper.setDefaultHost()\n> unconditionally. What is wrong with passing a name there?\n> \n> Hosts can be added and removed through JMX calls on\n> StandardEngine#addChild()/removeChild() and it seems that MapperListener\n> fails to update defaultHost setting on the Mapper when it happens.\n> \n> So why not to pass the defaultHost name to the Mapper as is and let it\n> handle missing matches (like it already does)?\n> \n> \n> 2) in Mapper#map(MB,MB,S,MD)\n> \n> Fourth,\n> Maybe just return without mapping here, as if the Host is not found. We\n> already do if(defaultHostName==null){ return; } in its\n> #internalMap(CC,CC,S,MD) method.\n> \n> It will need some update to its caller though, which is\n> CoyoteAdapter#postParseRequest()\n> \n> \n> 3) In CoyoteAdapter#postParseRequest()\n> \n> This request could be rejected with error 404, instead of 400 that exception\n> handling in AbstractHttp11Processor#process() does. The postParseRequest()\n> already has code for handling it as 404, but\n> \n> Fifth,\n> access logging needs to be changed a bit. The current code:\n> \n> [[[\n>                 // Make sure there is a host (might not be during shutdown)\n>                 if (host != null) {\n>                     host.logAccess(request, response, 0, true);\n>                 }\n> ]]]\n> \n> I think that it should fallback to CoyoteAdapter#log(..) when host is null.\n\n\n\nIn my opinion if Tomcat cannot process some requests because of wrong configuration - Tomcat should not start and give an error with clear message at start up. Current message doesn't say anything about after-effects, is easy to ignore."}, {"count": 7, "tags": [], "bug_id": 53411, "text": "Created attachment 32138\nPatch for the enhancements mentioned above\n\nI have incorporated the changes mentioned above, with this patch.\n\nP.S. This is my first patch submission. Let me know if I could do anything to help better.", "id": 178679, "time": "2014-10-22T14:58:52Z", "creator": "cloakcavalier@gmail.com", "creation_time": "2014-10-22T14:58:52Z", "is_private": false, "attachment_id": 32138}, {"text": "Thanks for the patch. Don't be concerned about how much of the patch I am suggesting you change (most of it). The first patch I proposed was torn apart beyond recognition before it got anywhere near the Tomcat code base.\n\nThe view expressed by Kubak that Tomcat should not start if the default host is not valid is not the consensus opinion of the Tomcat developers. It is safe to assume that Konstatin's comments (as a committer) does represent the consensus opinion unless another committer comments otherwise (in which case expect a discussion on the dev list to reach a consensus).\n\nI suggest you go through Konstantin's comments in comment #5 one by one and address each of them in your patch.", "tags": [], "bug_id": 53411, "attachment_id": null, "count": 8, "id": 178684, "time": "2014-10-22T19:46:51Z", "creator": "markt@apache.org", "creation_time": "2014-10-22T19:46:51Z", "is_private": false}]