[{"count": 0, "tags": [], "creator": "bojan@rexursive.com", "attachment_id": 24449, "id": 131520, "time": "2009-11-01T00:42:20Z", "bug_id": 48094, "creation_time": "2009-11-01T00:42:20Z", "is_private": false, "text": "Created attachment 24449\n(Hopefully) safe close_worker_sockets()\n\nCurrent code closes worker sockets in close_worker_sockets() from the listener\nthread without suspending the workers. At the same time, worker threads may be\nin the process of doing the same (they may even set worker_sockets[i] to NULL,\ncausing a segfault in the listener), potentially causing problems.\n\nThe attached patch suspends worker threads first and then shuts down sockets,\nusing shutdown(). This way, worker threads can still proceed later with regular\nclose, without any side effects."}, {"text": "Created attachment 24450\nSame for 2.2.x", "tags": [], "creator": "bojan@rexursive.com", "attachment_id": 24450, "count": 1, "id": 131521, "time": "2009-11-01T00:42:43Z", "bug_id": 48094, "creation_time": "2009-11-01T00:42:43Z", "is_private": false}, {"count": 2, "tags": [], "text": "Please note, I actually tested the 2.2.x patch. The patch against trunk has been edited to apply.", "is_private": false, "id": 131522, "creation_time": "2009-11-01T00:44:29Z", "time": "2009-11-01T00:44:29Z", "creator": "bojan@rexursive.com", "bug_id": 48094, "attachment_id": null}, {"count": 3, "tags": [], "text": "Created attachment 24453\n(Hopefully) safe close_worker_sockets()\n\nSomewhat simpler and more Unixy patch, using sigsuspend() and atomic counters.", "attachment_id": 24453, "id": 131534, "creator": "bojan@rexursive.com", "time": "2009-11-01T14:47:34Z", "bug_id": 48094, "creation_time": "2009-11-01T14:47:34Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 48094, "attachment_id": 24454, "id": 131535, "time": "2009-11-01T14:48:00Z", "creator": "bojan@rexursive.com", "creation_time": "2009-11-01T14:48:00Z", "is_private": false, "text": "Created attachment 24454\nSame for 2.2.x"}, {"count": 5, "tags": [], "bug_id": 48094, "attachment_id": 24510, "id": 131838, "time": "2009-11-10T02:11:46Z", "creator": "bojan@rexursive.com", "creation_time": "2009-11-10T02:11:46Z", "is_private": false, "text": "Created attachment 24510\n(Hopefully) safe close_worker_sockets()\n\nSimpler and safer patch. Instead of suspending workers (which may hang the server in some corner cases), we simply send signals to worker threads. Once the signal handler is executed for a worker thread, we are guaranteed that the other worker code isn't going to be executing, so we avoid the race."}, {"count": 6, "tags": [], "text": "Created attachment 24511\nSame for 2.2.x", "is_private": false, "id": 131839, "creation_time": "2009-11-10T02:12:13Z", "time": "2009-11-10T02:12:13Z", "creator": "bojan@rexursive.com", "bug_id": 48094, "attachment_id": 24511}]