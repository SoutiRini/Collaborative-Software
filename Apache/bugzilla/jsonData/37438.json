[{"count": 0, "tags": [], "creator": "dee.ess@gmail.com", "attachment_id": null, "is_private": false, "id": 82335, "time": "2005-11-10T07:02:41Z", "bug_id": 37438, "creation_time": "2005-11-10T07:02:41Z", "text": "Hi,\n\nI am filing this bug report after discussion into the users list and a \nsuggestion to file bug report (see: http://www.gossamer-\nthreads.com/lists/apache/users/299510).\n\nI have a setup of Front / Back Apache Reverse Proxy. Front Apache is running on \nport 80 and Back Apache is running on 8080. SSI OPTIONS is enabled on both the \nApache.\n \nI have a requirement that all files are to be served from the front Apache \nexcept the /mycomps folder. The mycomps folder ScriptAlias. Requests \nto /mycomps should go to Back Apache.\n \nUptill this point everything is working as expected.\n \nThat is:\nIf I try to access http://ds.india.noida/mycomps/testsuccess.html it gets \nserved from Back Apache as desired (confirmed from the logs) -- Good ! \n\nNow, I have another page \"dstest.html\" into the DocumentRoot folder which, has \na virtual include tag as:\n\n<!--#include virtual=\"/mycomps/testsuccess.html\" -->\n\nBut, the problem is that when I try to access http://ds.india.noida/dstest.html \nthe SSI /mycomps/testsuccess.html also gets parsed from the Front Apache. \n\nI wish that dstest.html should get served from Front Apache \nbut \"/mycomps/testsuccess.html\" should get parsed from Back Apache.\n\nHere is my config:\n\nFront Apache Virtual Host on port 80:\n<VirtualHost 10.216.204.59>\n   ServerAlias ds.india.noida www.ds.india.noida ds.india\n   ServerName www.ds.india.noida\n   ServerAdmin dee.ess@gmail.com\n   DocumentRoot /home/www/html/jobs\n   ServerPath /jobs\n   ScriptAlias /mycomps/ \"/home/www/html/mycomps/\" \n   <Directory /home/www/html>\n      Options FollowSymLinks Includes \n      AddHandler server-parsed .html\n      AddOutputFilter INCLUDES .html\n   </Directory>\n   RewriteEngine On\n   RewriteRule \\.(gif|jpg|png|txt|css|js|ico|swf)$ [OR]\n   RewriteRule !^/mycomps/.*$ - [last]\n   RewriteRule ^/(.*)$ http://ds.india.noida:8080/$1 [proxy]\n   ProxyPassReverse / http://ds.india.noida:8080/ \n   CustomLog /home/logs/ds_access_log combinedref env=!DONOTLOGIMAGE\n</VirtualHost>\n\nBack Apache Virtual Host on Port 8080:\n<VirtualHost 10.216.204.59>\n   ServerAlias ds.india.noida www.ds.india.noida ds.india.noida \n   ServerName ds.india.noida\n   ServerAdmin dee.ess@gmail.com\n   DocumentRoot /home/www/html/jobs \n   ServerPath /jobs\n   ScriptAlias /mycomps/ \"/home/www/html/mycomps/\" \n   <Directory /home/www/html>\n      Options FollowSymLinks Includes \n      AddHandler server-parsed .html\n      AddOutputFilter INCLUDES .html\n   </Directory>\n</VirtualHost> \n\nThe entries for ds.india.noida www.ds.india.noida ds.india are into \nmy /etc/hosts file.\n\nI enabled RewriteLogLevel to 9 and did further tests.\n\nProblem Diagnosis -->\n\nIf I access http://ds.india.noida/mycomps/testsuccess.html directly it works \nokay, i.e., gets served from Back Apache:\n\n10.216.204.64 - - [09/Nov/2005:12:12:52 +051800] [ds.india.noida/sid#8e829b8]\n[rid#8f0bf78/initial] (2) init rewrite engine with requested \nuri /mycomps/testsuccess.html\n10.216.204.64 - - [09/Nov/2005:12:12:52 +051800] [ds.india.noida/sid#8e829b8]\n[rid#8f0bf78/initial] (3) applying pattern '^/mycomps/.*$' to \nuri '/mycomps/testsuccess.html'\n10.216.204.64 - - [09/Nov/2005:12:12:52 +051800] [ds.india.noida/sid#8e829b8]\n[rid#8f0bf78/initial] (3) applying pattern '^/(.*)$' to \nuri '/mycomps/testsuccess.html'\n10.216.204.64 - - [09/Nov/2005:12:12:52 +051800] [ds.india.noida/sid#8e829b8]\n[rid#8f0bf78/initial] (2) rewrite /mycomps/testsuccess.html -> \nhttp://ds.india.noida:8080/mycomps/testsuccess.html\n10.216.204.64 - - [09/Nov/2005:12:12:52 +051800] [ds.india.noida/sid#8e829b8]\n[rid#8f0bf78/initial] (2) forcing proxy-throughput with \nhttp://ds.india.noida:8080/mycomps/testsuccess.html \n10.216.204.64 - - [09/Nov/2005:12:12:52 +051800] [ds.india.noida/sid#8e829b8]\n[rid#8f0bf78/initial] (1) go-ahead with proxy request proxy: \nhttp://ds.india.noida:8080/mycomps/testsuccess.html [OK]\n\nIf I access http://ds.india.noida/dstest.html which has <!--#include \nvirtual=\"/mycomps/testsuccess.html\" --> (dstest.html has to be served from \nFront and /mycomps/testsuccess.html should be served from Back Apache, but both \nare passed through): \n\n10.216.204.64 - - [09/Nov/2005:12:13:27 +051800] [ds.india.noida/sid#8e829b8]\n[rid#8f16740/initial] (2) init rewrite engine with requested uri /dstest.html\n10.216.204.64 - - [09/Nov/2005:12:13:27 +051800] [ds.india.noida/sid#8e829b8]\n[rid#8f16740/initial] (3) applying pattern '^/mycomps/.*$' to uri '/dstest.html'\n10.216.204.64 - - [09/Nov/2005:12:13:27 +051800] [ds.india.noida/sid#8e829b8]\n[rid#8f16740/initial] (1) pass through /dstest.html\n10.216.204.64 - - [09/Nov/2005:12:13:27 +051800] [ds.india.noida /sid#8e829b8]\n[rid#8f2e908/subreq] (2) init rewrite engine with requested \nuri /mycomps/testsuccess.html\n10.216.204.64 - - [09/Nov/2005:12:13:27 +051800] [ds.india.noida/sid#8e829b8]\n[rid#8f2e908/subreq] (3) applying pattern '^/mycomps/.*$' to \nuri '/mycomps/testsuccess.html' \n10.216.204.64 - - [09/Nov/2005:12:13:27 +051800] [ds.india.noida/sid#8e829b8]\n[rid#8f2e908/subreq] (1) pass through /mycomps/testsuccess.html\n\nSo, the Problem is that in case of \"subreq\" via SSI call, the mod_rewrite.c is \nsimply refusing to deal with a proxied subrequest (and thus SSI).\n\nI checked the modules/mappers/mod_rewrite.c and found the following around line \n1828 (httpd-2.0.55):\n\n        /*\n         *  Ignore this rule on subrequests if we are explicitly\n         *  asked to do so or this is a proxy-throughput or a\n         *  forced redirect rule.\n         */\n        if (r->main != NULL && \n            (p->flags & RULEFLAG_IGNOREONSUBREQ ||\n             p->flags & RULEFLAG_PROXY          ||\n             p->flags & RULEFLAG_FORCEREDIRECT    )) {\n            continue;\n        } \n\nIn my opinion (of limited knowledge of Apache internals) the line \nwith \"RULEFLAG_PROXY\" may be the culprit. I commented the line:\n\n             /* p->flags & RULEFLAG_PROXY          || */\n\nand recompiled the Front Apache. Voila, now its giving the desired effect of \nrewriterule on subrequest via SSI.\n\nSo, now on accessing http://ds.india.noida/dstest.html, the result is:\n10.216.204.64 - - [09/Nov/2005:12:35:53 +051800] [ds.india.noida /sid#99a29b8]\n[rid#9a2bf68/initial] (2) init rewrite engine with requested uri /dstest.html\n10.216.204.64 - - [09/Nov/2005:12:35:53 +051800] [ds.india.noida/sid#99a29b8]\n[rid#9a2bf68/initial] (3) applying pattern '^/mycomps/.*$' to \nuri '/dstest.html' \n10.216.204.64 - - [09/Nov/2005:12:35:53 +051800] [ds.india.noida/sid#99a29b8]\n[rid#9a2bf68/initial] (1) pass through /dstest.html\n10.216.204.64 - - [09/Nov/2005:12:35:53 +051800] [ ds.india.noida/sid#99a29b8]\n[rid#9a3a150/subreq] (2) init rewrite engine with requested \nuri /mycomps/testsuccess.html\n10.216.204.64 - - [09/Nov/2005:12:35:53 +051800] [ds.india.noida/sid#99a29b8]\n[rid#9a3a150/subreq] (3) applying pattern '^/mycomps/.*$' to \nuri '/mycomps/testsuccess.html' \n10.216.204.64 - - [09/Nov/2005:12:35:53 +051800] [ds.india.noida/sid#99a29b8]\n[rid#9a3a150/subreq] (3) applying pattern '^/(.*)$' to \nuri '/mycomps/testsuccess.html'\n10.216.204.64 - - [09/Nov/2005:12:35:53 +051800] [ds.india.noida/sid#99a29b8]\n[rid#9a3a150/subreq] (2) rewrite /mycomps/testsuccess.html -> \nhttp://ds.india.noida:8080/mycomps/testsuccess.html \n10.216.204.64 - - [09/Nov/2005:12:35:53 +051800] [ds.india.noida/sid#99a29b8]\n[rid#9a3a150/subreq] (2) forcing proxy-throughput with \nhttp://ds.india.noida:8080/mycomps/testsuccess.html\n10.216.204.64 - - [09/Nov/2005:12:35:53 +051800] [ds.india.noida/sid#99a29b8]\n[rid#9a3a150/subreq] (1) go-ahead with proxy request proxy: \nhttp://ds.india.noida:8080/mycomps/testsuccess.html [OK]\n\nI would like to seek opinion of the expert list members / developers, whether \nthis modification is okay and would it have any bad impact somewhere else?\n\nIf this is okay, it may please be modified into the Apache 2.0.x series please.\n\nThanks,\n\nDevendra Singh"}, {"count": 1, "tags": [], "bug_id": 37438, "is_private": false, "text": "This is fixed in 2.2 and later.", "id": 142357, "time": "2010-12-03T21:49:44Z", "creator": "covener@gmail.com", "creation_time": "2010-12-03T21:49:44Z", "attachment_id": null}]