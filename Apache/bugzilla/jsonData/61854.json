[{"count": 0, "tags": [], "bug_id": 61854, "text": "Created attachment 35582\nJSP example for trhe bug\n\nThe EL specification 3.0 defines the use of maps and sets like this:\n\nsets: {1, 2, 3}\nmaps: {\"one\":1, \"two\":2, \"three\":3}\n\nSee chapter 2.2 Construction of Collection Objects in the specification http://download.oracle.com/otndocs/jcp/el-3_0-fr-eval-spec/index.html\n\nSo in EL 3.0 a expression like this is is valid:\n\n${ map = {'1':'2', 'a':'b'}; fn:length(map['a']) }\n\nIt should return 1. In all tomcat versions this throws:\n\norg.apache.jasper.JasperException: org.apache.jasper.JasperException: javax.el.ELException: Function [fn:length] not found\n\nThe main reason seems to be that the ELParser that register the functions does not take into account that a closing bracket is now possible before closing the real EL expression. So it is closing the expression before and the function is not registered (and it's not found later on). The following change makes it work:\n\n--- java/org/apache/jasper/compiler/ELParser.java\t(revision 1817073)\n+++ java/org/apache/jasper/compiler/ELParser.java\t(working copy)\n@@ -106,11 +106,17 @@\n         ELexpr = new ELNode.Nodes();\n         curToken = null;\n         prevToken = null;\n+        int openBracket = 0;\n         while (hasNext()) {\n             curToken = nextToken();\n             if (curToken instanceof Char) {\n                 if (curToken.toChar() == '}') {\n-                    break;\n+                    openBracket--;\n+                    if (openBracket < 0) {\n+                        break;\n+                    }\n+                } else if (curToken.toChar() == '{') {\n+                    openBracket++;\n                 }\n                 buf.append(curToken.toString());\n             } else {\n\nThe modification just counts the opening brackets and the EL expression is only considered as complete when the brackets are all closed.", "id": 202562, "time": "2017-12-04T09:33:25Z", "creator": "rickyepoderi@yahoo.es", "creation_time": "2017-12-04T09:33:25Z", "is_private": false, "attachment_id": 35582}, {"count": 1, "tags": [], "bug_id": 61854, "is_private": false, "text": "Thanks for the report and the test webapp. I converted it to a Tomcat test and added it to the test suite.\n\nFixed in:\n- trunk for 9.0.3 onwards\n- 8.5.x for 8.5.25 onwards\n- 8.0.x for 8.0.49 onwards", "id": 202605, "time": "2017-12-06T14:53:27Z", "creator": "markt@apache.org", "creation_time": "2017-12-06T14:53:27Z", "attachment_id": null}]