[{"count": 0, "tags": [], "bug_id": 53138, "is_private": false, "id": 158370, "creation_time": "2012-04-24T11:53:11Z", "time": "2012-04-24T11:53:11Z", "creator": "cprakas@gmail.com", "text": "We have an application that uses a java script file of size around 700Kb that will be downloaded as part of the client. The connector used was NIO . All these days we did not see any issue till Tomcat 7.0.26.\n \nWhen we upgraded it to the latest Tomcat version 7.0.27 we started getting this problem. The file is never getting downloaded the connection will be broken in middle. \n\nAnd we used fiddler to see what is happening and it gives us a message as below\n\n\u201cContent-Length mismatch: Response Header indicated 757,692 bytes, but server sent 262,142 bytes.\u201d\n\nIf I use the default connector there is no issues. it works fine. \n\nTo reproduce this we have created a sample application. Please follow the steps below.\n\nClean up all the browser cash: \n1.\tDeploy  TestNIOConnector app in tomcat.\n2.\tIn server.xml change to connect to NIO as shown below.\n<Connector port=\"9880\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\" maxThreads=\"150\" connectionTimeout=\"70000\"\n  acceptCount=\"100\" compression=\"on\" acceptorThreadCount=\"2\" redirectPort=\"8443\" />\n3.\tStart the service and try to access this file using the following URL in IE.\nhttp://localhost:9880/TestNIOConnector/apidocs.js", "attachment_id": null}, {"count": 1, "tags": [], "creator": "cprakas@gmail.com", "attachment_id": 28666, "is_private": false, "id": 158371, "time": "2012-04-24T12:01:29Z", "bug_id": 53138, "creation_time": "2012-04-24T12:01:29Z", "text": "Created attachment 28666\nSample app to reproduce this issue\n\nThis app is to reproduce the issue."}, {"count": 2, "tags": [], "creator": "robert_kish@yahoo.com", "attachment_id": null, "id": 158744, "time": "2012-05-02T15:52:02Z", "bug_id": 53138, "creation_time": "2012-05-02T15:52:02Z", "is_private": false, "text": "I am having the same problem with my application. We have noticed only some files are not downloading, not all of them - there's no apparent pattern to the file size. We had one file that's 115397 download, but another that's 111158 fail.\n\nWhat made it interesting was that the file did not download in IE 8, but the file did download in FF 12. This leads me to believe it's something browser specific about downloading the file. My searches led me to an item for 7.0.27, https://issues.apache.org/bugzilla/show_bug.cgi?id=52858\nthat looked interesting. Perhaps the issue relates to that change."}, {"count": 3, "tags": [], "creator": "fhanik@apache.org", "attachment_id": null, "id": 158749, "time": "2012-05-02T16:46:42Z", "bug_id": 53138, "creation_time": "2012-05-02T16:46:42Z", "is_private": false, "text": "Just ran the sample app on a 7.0.27 download\n\nHTTP/1.1 200 OK\nServer: Apache-Coyote/1.1\nAccept-Ranges: bytes\nETag: W/\"757692-1335976856000\"\nLast-Modified: Wed, 02 May 2012 16:40:56 GMT\nContent-Type: application/javascript\nContent-Length: 757692\nDate: Wed, 02 May 2012 16:43:11 GMT\n\nand then I get all the bytes. \n\n<Connector port=\"9880\" \n           protocol=\"org.apache.coyote.http11.Http11NioProtocol\" \n           maxThreads=\"150\" \n           connectionTimeout=\"70000\"\n           acceptCount=\"100\" \n           compression=\"on\" \n           acceptorThreadCount=\"2\" \n           redirectPort=\"8443\"/> \n\nI was unable to reproduce it. The last bytes I get downloaded are:\n\nY.on('hashchange', function (e) {\n    pjax.updateTabState('hashchange');\n}, win);\n\n});\n\nand that corresponds with the file contents"}, {"count": 4, "attachment_id": null, "bug_id": 53138, "is_private": false, "id": 158750, "time": "2012-05-02T16:49:07Z", "creator": "fhanik@apache.org", "creation_time": "2012-05-02T16:49:07Z", "tags": [], "text": "Tested in \nFirefox 11 and Internet Explorer 9"}, {"count": 5, "tags": [], "text": "(In reply to comment #4)\n> Tested in \n> Firefox 11 and Internet Explorer 9\n\n\nTomcat installation:\n\n<Connector port=\"8081\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\" SSLEnabled=\"true\"\n               maxThreads=\"150\" scheme=\"https\" secure=\"true\"\n               clientAuth=\"false\" sslProtocol=\"TLS\" keystoreFile=\"xxx/.keystore\" keystorePass=\"xxx\" keyPass=\"xxx\"/>\n\n\nRunning on HPUX 11.11:\n\n64 bit JVM\n\njava version \"1.6.0.14\"\nJava(TM) SE Runtime Environment (build 1.6.0.14-jinteg_07_mar_2012_00_45-b00)\nJava HotSpot(TM) 64-Bit Server VM (build 20.6-b01-jre1.6.0.14-rc1b2 PA2.0W (aCC_AP), mixed mode)\n\n-------\n\nOn Windows XP,\n\nUsing IE 8, I get 114,688 bytes of the file. It takes a long time to download the file after the first chunk of data. I'm guessing it just gives up and stops.\n\nUsing FF 12, I get about the same size of data initially - the file's progress is paused - I get the \"Connecting\" status - but after a while, the document completes and I get the whole size.", "attachment_id": null, "bug_id": 53138, "id": 158755, "time": "2012-05-02T20:02:56Z", "creator": "robert_kish@yahoo.com", "creation_time": "2012-05-02T20:02:56Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 53138, "is_private": false, "text": "Thanks Robert, are you able to reproduce this on a non HPUX system with a more recent runtime? ie, can you reproduce the attached test case on your local laptop or workstation?", "id": 158759, "time": "2012-05-02T20:27:32Z", "creator": "fhanik@apache.org", "creation_time": "2012-05-02T20:27:32Z", "attachment_id": null}, {"count": 7, "tags": [], "text": "(In reply to comment #6)\n> Thanks Robert, are you able to reproduce this on a non HPUX system with a\n> more recent runtime? ie, can you reproduce the attached test case on your\n> local laptop or workstation?\n\nYes. I just finished testing this on my PC:\nWindows XP SP 3\n\n32 bit JVM\n\njava version \"1.7.0_03\"\nJava(TM) SE Runtime Environment (build 1.7.0_03-b05)\nJava HotSpot(TM) Client VM (build 22.1-b02, mixed mode, sharing)\n\nIt worked on Tomcat 7.0.26. I installed 7.0.27, and it didn't work. I went back to 7.0.26, and it works again.", "attachment_id": null, "bug_id": 53138, "id": 158760, "time": "2012-05-02T20:30:30Z", "creator": "robert_kish@yahoo.com", "creation_time": "2012-05-02T20:30:30Z", "is_private": false}, {"count": 8, "tags": [], "creator": "fhanik@apache.org", "attachment_id": null, "is_private": false, "id": 158761, "time": "2012-05-02T21:06:47Z", "bug_id": 53138, "creation_time": "2012-05-02T21:06:47Z", "text": "Thanks Robert, I can reproduce it with IE 9 if I hit the \"Save\" option when I hit refresh in the browser. I will check on this and see how it works out"}, {"count": 9, "tags": [], "creator": "fhanik@apache.org", "attachment_id": null, "is_private": false, "id": 158762, "time": "2012-05-02T21:46:42Z", "bug_id": 53138, "creation_time": "2012-05-02T21:46:42Z", "text": "In the meantime a workaround for this is to set useSendfile=\"false\"\n\n<Connector port=\"8081\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\" SSLEnabled=\"true\"\n               maxThreads=\"150\" scheme=\"https\" secure=\"true\"\n               clientAuth=\"false\" sslProtocol=\"TLS\" keystoreFile=\"xxx/.keystore\" keystorePass=\"xxx\" keyPass=\"xxx\" useSendfile=\"false\"/>"}, {"count": 10, "tags": [], "bug_id": 53138, "is_private": false, "id": 158763, "creation_time": "2012-05-02T21:49:29Z", "time": "2012-05-02T21:49:29Z", "creator": "fhanik@apache.org", "text": "Current suspect is:\nhttp://svn.apache.org/viewvc/tomcat/tc7.0.x/trunk/java/org/apache/tomcat/util/net/NioEndpoint.java?r1=1300872&r2=1300950&diff_format=h", "attachment_id": null}, {"count": 11, "tags": [], "creator": "fhanik@apache.org", "attachment_id": null, "is_private": false, "id": 158905, "time": "2012-05-08T14:28:54Z", "bug_id": 53138, "creation_time": "2012-05-08T14:28:54Z", "text": "(In reply to comment #10)\n> Current suspect is:\n> http://svn.apache.org/viewvc/tomcat/tc7.0.x/trunk/java/org/apache/tomcat/\n> util/net/NioEndpoint.java?r1=1300872&r2=1300950&diff_format=h\n\nConfirmed that the above check in broke sendFile for NIO. Current workaround is useSendfile=\"false\" on the NIO connector"}, {"count": 12, "tags": [], "bug_id": 53138, "is_private": false, "id": 159174, "creation_time": "2012-05-18T19:30:33Z", "time": "2012-05-18T19:30:33Z", "creator": "fhanik@apache.org", "text": "Fixed in trunk in r1340215\nFixed in 7.0.x in r1340218\nWill be available in 7.0.28", "attachment_id": null}, {"count": 13, "tags": [], "bug_id": 53138, "is_private": false, "id": 159537, "creation_time": "2012-05-30T17:43:11Z", "time": "2012-05-30T17:43:11Z", "creator": "fhanik@apache.org", "text": "*** Bug 53331 has been marked as a duplicate of this bug. ***", "attachment_id": null}, {"count": 14, "tags": [], "creator": "gschiavo@ets.org", "attachment_id": null, "id": 198242, "time": "2017-04-11T19:16:41Z", "bug_id": 53138, "creation_time": "2017-04-11T19:16:41Z", "is_private": false, "text": "This same issue is still happening on Tomcat 8. Setting the flag useSendData to false is a workaround my team has applied for now, but the bug is till there in Tomcat 8 and we would like to avoid using useSendData=false because increased CPU consumption.  \nThis issue is happening using with apache-tomcat-8.0.18 in Windows 7 environment"}, {"count": 15, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 198245, "time": "2017-04-11T21:29:18Z", "bug_id": 53138, "creation_time": "2017-04-11T21:29:18Z", "is_private": false, "text": "This specific issue was fixed for 8.0.x almost 5 years ago.\n\nIf you are seeing an issue with similar symptoms, please test with the latest 8.0.x release (8.0.43 as I type this) and if you still see the issue please create a new bug report. You'll need to provide the simplest set of steps to reproduce the issue on a clean install of the latest 8.0.x release."}, {"count": 16, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "id": 198273, "time": "2017-04-12T21:37:10Z", "bug_id": 53138, "creation_time": "2017-04-12T21:37:10Z", "is_private": false, "text": "Revert bug description. It's still insanely long, but there is no need to thrash web indexers on this old issue."}, {"count": 17, "tags": [], "creator": "gschiavo@ets.org", "attachment_id": null, "id": 198326, "time": "2017-04-17T18:21:32Z", "bug_id": 53138, "creation_time": "2017-04-17T18:21:32Z", "is_private": false, "text": "It is an old issue but it still happening it seems. We get this error in Chrome Electron 51, but not with other browsers. My guess is that the error is being ignored by other browsers. We haven't validated yet with 8.0.43, but we see it with 8.0.18. I will open a new bug after I validate with 8.0.43 in case it still happens with this version."}]