[{"count": 0, "tags": [], "bug_id": 51604, "attachment_id": null, "is_private": false, "id": 148346, "time": "2011-08-03T02:43:00Z", "creator": "sanmoy@gmail.com", "creation_time": "2011-08-03T02:43:00Z", "text": "I had written this simple piece of code   \n\nFileInputStream fileInputStream = new FileInputStream(new File(\"C:\\\\in.doc\")); \nFileOutputStream fileOutputStream = new FileOutputStream(new File(\"C:\\\\out.doc\")); \nHWPFDocument hwpfDocument = new HWPFDocument(fileInputStream); \nRange range = hwpfDocument.getRange(); \nint numParagraph = range.numParagraphs(); \nfor (int i = 0; i < numParagraph; i++) \n{ \nParagraph paragraph = range.getParagraph(i); \nint numCharRuns = paragraph.numCharacterRuns(); \nfor (int j = 0; j < numCharRuns; j++) \n{ \nCharacterRun charRun = paragraph.getCharacterRun(j); \nString text = charRun.text(); \ncharRun.replaceText(text, \"added\"); \n} \n} \nhwpfDocument.write(fileOutputStream); \n\nAfter the execution, the output file becomes corrupted ( tried to open with office 2007) , input file was properly opening. input file is a very basic file, with 4-5 simple lines\n\nNo exception thrown. \n\nhad written similar code using XWPFDocument, and it works fine"}, {"attachment_id": null, "tags": [], "creator": "sanmoy@gmail.com", "text": "One addition, \n\nfileOutputStream.close() is present in the original code, by mistake, which i didn't copy while raising the defect. \n\nPlease remember, the following code is working perfectly \n\nXWPFDocument xwpfDocument = new XWPFDocument(inputStream);\n \nList<XWPFParagraph> paragraphs = xwpfDocument.getParagraphs();\nfor(XWPFParagraph xParagraph:paragraphs)\n{\nfor(XWPFRun xwpfRun : xParagraph.getRuns())\n{\nxwpfRun.setText(\"replace\", 0);\n}\n}\nxwpfDocument.write(outputStream);\noutputStream.close();", "count": 1, "id": 148347, "time": "2011-08-03T02:54:44Z", "bug_id": 51604, "creation_time": "2011-08-03T02:54:44Z", "is_private": false}, {"count": 2, "tags": [], "text": "Which version of POI? Please try with the latest build from trunk, there have been quite a lot of updates recently.\n\nIf the problem is still there, please attach the problematic file. Without the input .doc file we can't do much to help you.\n\nYegor", "is_private": false, "bug_id": 51604, "id": 148348, "time": "2011-08-03T06:58:05Z", "creator": "yegor@dinom.ru", "creation_time": "2011-08-03T06:58:05Z", "attachment_id": null}, {"count": 3, "tags": [], "text": "Created attachment 27346\ntest input file for hwpf\n\nI have tested with 6-Jul-2011 nightly build. poi-bin-3.8-beta3-20110606.tar", "is_private": false, "bug_id": 51604, "id": 148368, "time": "2011-08-04T00:30:42Z", "creator": "sanmoy@gmail.com", "creation_time": "2011-08-04T00:30:42Z", "attachment_id": 27346}, {"count": 4, "tags": [], "bug_id": 51604, "attachment_id": null, "text": "Now I have tested with yesterday's nightly build poi-3.8-beta4-20110803 from http://encore.torchbox.com/poi-svn-build/", "id": 148369, "time": "2011-08-04T00:40:19Z", "creator": "sanmoy@gmail.com", "creation_time": "2011-08-04T00:40:19Z", "is_private": false}, {"count": 5, "tags": [], "text": "Very interested in this bug.  Having the same issue. Can't use XWPF since contract requires us to maintain original version.", "is_private": false, "bug_id": 51604, "id": 148416, "time": "2011-08-05T16:15:49Z", "creator": "jacob@streamlinerweb.com", "creation_time": "2011-08-05T16:15:49Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 51604, "is_private": false, "text": "Fixed in r1155211 (3.8-beta4-20110810 or later). Please, test.", "id": 148499, "time": "2011-08-09T05:26:05Z", "creator": "vlsergey@gmail.com", "creation_time": "2011-08-09T05:26:05Z", "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 51604, "is_private": false, "text": "Created attachment 27369\ntest output file for hwpf\n\nI have tested with 3.8-beta4-20110810, but the defect still exists.\n\nNow, I have added a check, when the line contains the string \"Header\" ( please see the input doc ) then it will replace the text. \n if(text.contains(\"Header\"))\ncharRun.replaceText(text, \"added\");\n\nAnd I have compared the output file with \"beyond compare\" ( a file comparison tool ), it shows the text has been replaced properly, but the document format is corrupted. I don't know much about the doc format so cannot comment. I have attached the output file, hope it will help.", "id": 148537, "time": "2011-08-11T05:26:24Z", "creator": "sanmoy@gmail.com", "creation_time": "2011-08-11T05:26:24Z", "attachment_id": 27369}, {"count": 8, "tags": [], "bug_id": 51604, "text": "Created attachment 27370\ncomparison result\n\ncomparison result", "id": 148538, "time": "2011-08-11T05:27:38Z", "creator": "sanmoy@gmail.com", "creation_time": "2011-08-11T05:27:38Z", "is_private": false, "attachment_id": 27370}, {"count": 9, "tags": [], "bug_id": 51604, "attachment_id": null, "id": 148540, "time": "2011-08-11T08:23:29Z", "creator": "vlsergey@gmail.com", "creation_time": "2011-08-11T08:23:29Z", "is_private": false, "text": "Sanmoy,\n\nI don't see the difference between in.doc and out.doc, except \"Header\" -> \"added\" change. What exaclty is broken?\n\nSergey"}, {"attachment_id": 27371, "tags": [], "bug_id": 51604, "text": "Created attachment 27371\nerror-snap-shot\n\nplease try to open the output file with MS office 2003 or 2007, it will display file corrupted", "count": 10, "id": 148548, "time": "2011-08-11T09:25:46Z", "creator": "sanmoy@gmail.com", "creation_time": "2011-08-11T09:25:46Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "vlsergey@gmail.com", "text": "Sanmoy,\n\nI did fix a couple of issues (FIB and stylesheets processing) that may be reason of why file is not opening by Microsoft Office. Please try with next night build or trunk version.\n\nResult file is still not passed binary file validation tool thought :(\n\nSergey", "count": 11, "id": 148573, "time": "2011-08-11T18:43:51Z", "bug_id": 51604, "creation_time": "2011-08-11T18:43:51Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 51604, "attachment_id": null, "id": 148633, "time": "2011-08-16T10:20:13Z", "creator": "vlsergey@gmail.com", "creation_time": "2011-08-16T10:20:13Z", "is_private": false, "text": "Sanmoy,\n\nPlease, check the latest trunk version or 3.8-beta4 or later."}, {"count": 13, "tags": [], "bug_id": 51604, "attachment_id": null, "id": 148726, "time": "2011-08-20T10:50:33Z", "creator": "sanmoy@gmail.com", "creation_time": "2011-08-20T10:50:33Z", "is_private": false, "text": "the defect has been fixed .. thanks"}, {"count": 14, "tags": [], "bug_id": 51604, "attachment_id": null, "text": "/**\n* Replace (all instances of) a piece of text with another...\n*\n* @param pPlaceHolder\n*            The text to be replaced (e.g., \"${organization}\")\n* @param pValue\n*            The replacement text (e.g., \"Apache Software Foundation\")\n*/\npublic void replaceText(String pPlaceHolder, String pValue) \n\nThe replaceText API will not work if the String pValue contains the String pPlaceHolder\n\nFor example if pPlaceHolder=\"abcd\" and pValue=\"abcd\" or \"abcdef\" or \"12abcdef\" this code will go to a infinite loop\n\nModify the original testcode charRun.replaceText(text, text); that is, try to replace the original value with itself, it will not work, it will fall into a infinite loop. For your convenience, I am copying the original code again. Please test it with the attached files\n\nFileInputStream fileInputStream = new FileInputStream(new File(\"C:\\\\in.doc\")); \nFileOutputStream fileOutputStream = new FileOutputStream(new\nFile(\"C:\\\\out.doc\")); \nHWPFDocument hwpfDocument = new HWPFDocument(fileInputStream); \nRange range = hwpfDocument.getRange(); \nint numParagraph = range.numParagraphs(); \nfor (int i = 0; i < numParagraph; i++) \n{ \nParagraph paragraph = range.getParagraph(i); \nint numCharRuns = paragraph.numCharacterRuns(); \nfor (int j = 0; j < numCharRuns; j++) \n{ \nCharacterRun charRun = paragraph.getCharacterRun(j); \nString text = charRun.text(); \ncharRun.replaceText(text, text); \n} \n} \nhwpfDocument.write(fileOutputStream); \nfileOutputStream.close();\n\nI have tested with the latest nightly buid 3.8-beta5-20110904\n\nI have debugged the poi code and found the problem in this following logic \nString text = text();\nint offset = text.indexOf(pPlaceHolder);\ntext is returning the replaced value and if the replaced value contains the original String, offset will always be >=0 and it will keep on increasing\n\npublic void replaceText(String pPlaceHolder, String pValue)  {\n\tboolean keepLooking = true;\n\twhile (keepLooking){\n\n\tString text = text();\n\tint offset = text.indexOf(pPlaceHolder);\n\tif (offset >= 0)\n\t\treplaceText(pPlaceHolder, pValue, offset);\n\telse\n\t\tkeepLooking = false;\n\t\t}\n\t}", "id": 149017, "time": "2011-09-04T16:49:18Z", "creator": "sanmoy@gmail.com", "creation_time": "2011-09-04T16:49:18Z", "is_private": false}, {"count": 15, "tags": [], "bug_id": 51604, "attachment_id": null, "text": "Hi, I have tested poi-bin-3.8-beta5-20111217.tar.gz with a MS office 2003 (input file) using \"charRun.replaceText(\"XYZ\", \"ABC\");\"\nand the output file is corrupted. \nwithout replacement the output is ok, so I guess that problem come from replacement logic.\n\nAlso it worked out with poi-bin-3.8-beta4 if length of  pValue was equal to the length of PlaceHolder.. otherwise the output file was also corrupted ! \nAny idea !\nThanks", "id": 153783, "time": "2012-02-14T17:13:38Z", "creator": "patrick_applanc@yahoo.fr", "creation_time": "2012-02-14T17:13:38Z", "is_private": false}]