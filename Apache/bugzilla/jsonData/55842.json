[{"count": 0, "tags": [], "creator": "martin.maier-moessner@oenb.at", "attachment_id": null, "text": "I found a problem with setting the buffer size for the ServletResponse. \nIf I call 'response.setBufferSize(1,000,000);' and send about 20,000 characters, the response will be chunked even though it should not.\nThe response is sent in several chunks and contains the 'Transfer-Encoding: chunked' response header.\nIn my understanding in this case the response should be fully buffered on the server and then sent as a whole containing the Content-Length-header.\n\nThis causes a problem in my application because I want to use a larger buffer to be able to redirect to an error page if an error occurs during rendering the response. \n\nI was able to reproduce this on Tomcat 7.0.39, 7.0.40, 7.0.42, 7.0.47. Tomcat 7.0.37 works fine and as expected.\n\nThis is easily reproducable by using a JSP as follows:\n<%\nresponse.setBufferSize(1000*1000);\nfor (int i = 0; i < 100; i++) {\n\tfor (int j = 0; j < 100; j++) {\n\t\tresponse.getWriter().write(\"X\");\n\t}\n    response.getWriter().write(\"<br />\");\n}\n%>", "id": 171560, "time": "2013-12-04T15:56:09Z", "bug_id": 55842, "creation_time": "2013-12-04T15:56:09Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 55842, "attachment_id": null, "id": 171570, "time": "2013-12-04T21:02:55Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-12-04T21:02:55Z", "is_private": false, "text": "1. Usually the buffer size of a JSP page is configured via @page directive.\n\nI suspect that response.setBufferSize() is a wrong API here and configures something else.\n\n\n2. What is the size of the first chunk of that chunked response?"}, {"count": 2, "tags": [], "bug_id": 55842, "attachment_id": null, "id": 171589, "time": "2013-12-05T15:05:54Z", "creator": "martin.maier-moessner@oenb.at", "creation_time": "2013-12-05T15:05:54Z", "is_private": false, "text": "1. It is reproducable with a simple Servlet as well. In fact, I found this bug using a JSF application where the response was chunked, even though I set the context-param 'javax.faces.FACELETS_BUFFER_SIZE' to a high value (over 1MB). Myfaces calls response.setBufferSize with the correct value.\n\n2. All chunks are 2,000 bytes (looks like this is some kind of default)\n\nI have created and attached a simple project that you can use to see the problem. Just deploy the Servlet to Tomcat and run the test case. The test case shows the chunks in System.err."}, {"count": 3, "tags": [], "creator": "martin.maier-moessner@oenb.at", "text": "Created attachment 31095\nEclipse/Maven project to reproduce this bug\n\n- Deploy the project on a Tomcat\n- Run ChunkTest.testChunk() as Junit Test\n- Look at System.err output", "id": 171590, "time": "2013-12-05T15:16:34Z", "bug_id": 55842, "creation_time": "2013-12-05T15:16:34Z", "is_private": false, "attachment_id": 31095}, {"count": 4, "tags": [], "text": "Thanks for the report and test case. This has been fixed in 8.0.x and 7.0.x and will be included in 7.0.48 and 8.0.0-RC6 onwards.", "is_private": false, "bug_id": 55842, "id": 171608, "time": "2013-12-06T12:26:52Z", "creator": "markt@apache.org", "creation_time": "2013-12-06T12:26:52Z", "attachment_id": null}, {"count": 5, "text": "Thanks for the fast fix!", "bug_id": 55842, "is_private": false, "id": 171609, "time": "2013-12-06T12:30:23Z", "creator": "martin.maier-moessner@oenb.at", "creation_time": "2013-12-06T12:30:23Z", "tags": [], "attachment_id": null}, {"count": 6, "tags": [], "text": "*** Bug 57138 has been marked as a duplicate of this bug. ***", "is_private": false, "bug_id": 55842, "id": 178733, "time": "2014-10-24T20:15:05Z", "creator": "markt@apache.org", "creation_time": "2014-10-24T20:15:05Z", "attachment_id": null}]