[{"count": 0, "tags": [], "creator": "Stefan.Birkner@immobilienscout24.de", "text": "Sometimes a JSP's Java code, which have been generated by Jasper, has duplicate variable names. Therefore the JSP cannot be compiled and tomcat delivers an HTTP status code 500. You get an error message like this\n\norg.apache.jasper.JasperException: Unable to compile class for JSP: \nAn error occurred at line: 10 in the jsp file: /test1.jsp\nDuplicate local variable _jspx_temp0\n7: \t\t<c:set var=\"a\">\n8: \t\t\t<jsp:attribute name=\"value\"><%= new java.util.Date().toString() %></jsp:attribute>\n9: \t\t</c:set>\n10: \t\t<c:set var=\"b\">\n11: \t\t\t<jsp:attribute name=\"value\"><%= new java.util.Date().toString() %></jsp:attribute>\n12: \t\t</c:set>\n13: \t\t<h1>Test 1</h1>\n\nThe reason of this error is the generation of variable names like _jspx_temp0, which are created for <jsp:attribute> tags. At the beginning of parsing a JSP file a counter is reset to 0. Every time an <jsp:attribute> tag occurs, the counter is used to build a variable name _jspx_temp<counter>. Thereafter the counter will be incremented. Unfortunately the counter is a static member of the JspUtil class. Suppose there's a thread 1, which created _jspx_temp4. The counter is 5. Now a second thread (thread 2) starts and resets the counter. Afterwards thread 2 creates _jspx_temp0 to _jspx_temp3. The counter is 4 by now. Then thread 2 stops and thread 1 continues. The next variable's name in thread 1 will be _jspx_temp4, which already exists. Therefore the generated java class cannot be compiled.", "id": 120103, "time": "2008-08-26T07:23:33Z", "bug_id": 45691, "creation_time": "2008-08-26T07:23:33Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 45691, "attachment_id": 22482, "text": "Created attachment 22482\nWAR of a test application to reproduce the bug\n\nHere is a WAR, which can be used to replay the bug. After installing the war, you have to start your tomcat and a debugger. Then do the following steps:\n* set a breakpoint on JspUtil.nextTemporaryVariableName()\n* open /duplicateVariableName/test1.jsp in your browser\n* your debugger stops at JspUtil.nextTemporaryVariableName()\n* resume the debugger\n* again your debugger stops at JspUtil.nextTemporaryVariableName()\n* open /duplicateVariableName/test2.jsp in your browser\n* your debugger stops at JspUtil.nextTemporaryVariableName()\n* switch to the thread of /duplicateVariableName/test1.jsp\n* resume the debugger\n* the browser window of /duplicateVariableName/test1.jsp shows the error", "id": 120104, "time": "2008-08-26T07:31:41Z", "creator": "Stefan.Birkner@immobilienscout24.de", "creation_time": "2008-08-26T07:31:41Z", "is_private": false}, {"count": 2, "attachment_id": 22483, "bug_id": 45691, "is_private": false, "id": 120105, "time": "2008-08-26T07:49:41Z", "creator": "Stefan.Birkner@immobilienscout24.de", "creation_time": "2008-08-26T07:49:41Z", "tags": [], "text": "Created attachment 22483\nPatch to be applied to the package org.apache.jasper.compiler\n\nThis patch changes two classes: org.apache.jasper.compiler.Generator and org.apache.jasper.compiler.Node.\n\nInstead of creating the variable names of NamedAtttributes when parsing the JSP code, the names are created when the Generator generates the java code.\n\nThe Generator class has two additional members: an HashMap<NamedAttribute, String> variableNamesOfNamedAttributes, which stores the mapping between NamedAttributes and there variable names, and a variableNameCounter, which is used to create the variables' names. The new method getVariableName(NamedAttribute) returns the variable names.\n\nThe member temporaryVariableName and its getter getTemporaryVariableName() are removed from the node class."}, {"count": 3, "attachment_id": null, "bug_id": 45691, "is_private": false, "id": 120236, "time": "2008-08-31T07:05:46Z", "creator": "markt@apache.org", "creation_time": "2008-08-31T07:05:46Z", "tags": [], "text": "I have fixed this in trunk with a more general fix that should address all possible issues if this nature.\n\nThe fix has been proposed for 6.0.x"}, {"count": 4, "tags": [], "creator": "markt@apache.org", "text": "This has been applied to 6.0.x and will be included in 6.0.19 onwards.", "id": 121863, "time": "2008-10-24T14:03:33Z", "bug_id": 45691, "creation_time": "2008-10-24T14:03:33Z", "is_private": false, "attachment_id": null}]