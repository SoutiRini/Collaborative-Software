[{"count": 0, "attachment_id": null, "bug_id": 51704, "is_private": false, "id": 148751, "time": "2011-08-22T13:17:27Z", "creator": "sebb@apache.org", "creation_time": "2011-08-22T13:17:27Z", "tags": [], "text": "File#mkdirs() only returns true if the method created the directory itself.\n\nIf mkdirs() returns false, it is still possible for the directory to exist.\n\nThus the code in FileHandler at [1], i.e.\n\n\n364     // Create the directory if necessary\n365 \tFile dir = new File(directory);\n366 \tif (!dir.exists() && !dir.mkdirs()) {\n367 \t    reportError(\"Unable to create [\" + dir + \"]\", null,\n368 \t    ErrorManager.OPEN_FAILURE);\n369 \t    writer = null;\n370 \t    return;\n371 \t}\n\ncan generate an error even though the directory now exists.\n\nIt would be safer to code the check as follows:\n\n366 \tif (!dir.mkdirs() && !dir.exists()) {\n\nThere is no need to call dir.exists() before mkdirs() as mkdirs() does that anyway.\n\nThere is similar code at [2] and possibly elsewhere in Tomcat, I did not check.\n\n[1] http://svn.apache.org/viewvc/tomcat/trunk/java/org/apache/juli/FileHandler.java?view=markup#l364\n\n[1] http://svn.apache.org/viewvc/tomcat/trunk/java/org/apache/juli/FileHandler.java?view=markup#l379"}, {"count": 1, "tags": [], "bug_id": 51704, "attachment_id": null, "is_private": false, "id": 148846, "time": "2011-08-26T17:12:51Z", "creator": "markt@apache.org", "creation_time": "2011-08-26T17:12:51Z", "text": "There were ~25 uses of mkdirs() throughout the codebase. All have been reviewed and fixed as appropriate.\n\nIf we are being this pedantic then\n\nif (!dir.mkdirs() && !dir.isDirectory()) {\n\nis a better test since it ensures the file that exists is a directory rather than a regular file.\n\nThis has been fixed in trunk and 7.0.x and will be included in 7.0.21 onwards."}]