[{"count": 0, "tags": [], "creator": "gruber.chri@gmx.at", "attachment_id": 32581, "id": 181835, "time": "2015-03-17T11:14:39Z", "bug_id": 57721, "creation_time": "2015-03-17T11:14:39Z", "is_private": false, "text": "Created attachment 32581\ntest excel file\n\nIf you evaluate all formula cells in an XLSX file (for instance using  XSSFFormulaEvaluator.evaluateAllFormulaCells((XSSFWorkbook) workbook) ) and are using formulas in \"named tables\" in Excel 2007+, an exception is thrown.\n\nI don't know how you call these named tables exactly, but they are created in Excel 2007+ by selecting a range (of data) and pressing the \"Table\" button in the \"Insert\" ribbon (including headers). Excel then offers special \"table tools\" in the title bar, when selecting a cell in the table.\n\nIf you create this kind of table and are using formulas referencing cells in the named table, excel doesn't reference these rows/cells via A1, B2, etc., but with their column and table names:\n\n\nCreate this simple table (attached as formular_test.xlsx):\n\nA | B\n-----\n1 | 3\n2 | 4\n\nThen select the whole table and select Insert > Table, the table gets styled with alternating row colors etc.\nIf you then create a sum for all the table data, excel displays the formula as:\n=SUM(Table1[#All]) or =SUM(Table1[[#All];[A]:[B]]) or =SUM(Table1)\n\nWhen reading such a file with Apache POI, calling evaluateAllFormulaCells (source attached as UpdateFormulaTest.java) this exception is thrown:\nException in thread \"main\" org.apache.poi.ss.formula.FormulaParseException: Specified named range 'Table1' does not exist in the current workbook (thrown when using \"SUM(Table1[[A]:[B]])\" as formula).\n\nIt looks like it fails, as soon as formulas are referencing these named tables."}, {"count": 1, "tags": [], "text": "Created attachment 32582\njava test pgm", "attachment_id": 32582, "id": 181836, "creator": "gruber.chri@gmx.at", "time": "2015-03-17T11:15:24Z", "bug_id": 57721, "creation_time": "2015-03-17T11:15:24Z", "is_private": false}, {"count": 2, "tags": [], "creator": "stephenjmatta@gmail.com", "attachment_id": null, "id": 189834, "time": "2016-03-30T12:16:25Z", "bug_id": 57721, "creation_time": "2016-03-30T12:16:25Z", "is_private": false, "text": "This is preventing me from shifting rows that use the formula. My workaround is to use the \"Table Tools/Design\" tab and \"Convert to Range\" the table in Excel. This is not ideal but it's allowing me to move forward for now."}, {"count": 3, "tags": [], "creator": "greg.woolsey@gmail.com", "attachment_id": null, "id": 191427, "time": "2016-06-06T17:27:30Z", "bug_id": 57721, "creation_time": "2016-06-06T17:27:30Z", "is_private": false, "text": "Tables are used widely in formulas, but POI formula evaluation doesn't handle them.  This is a significant problem for us, as Excel table references make writing complex formulas much simpler and less error-prone."}, {"count": 4, "tags": [], "text": "Patches are always welcome!\nSubmitting patches: https://poi.apache.org/guidelines.html#SubmittingPatches\nUnderstanding formula evaluation:\nhttps://poi.apache.org/spreadsheet/eval.html\nhttps://poi.apache.org/spreadsheet/eval-devguide.html", "attachment_id": null, "id": 191429, "creator": "onealj@apache.org", "time": "2016-06-06T18:36:08Z", "bug_id": 57721, "creation_time": "2016-06-06T18:36:08Z", "is_private": false}, {"count": 5, "tags": [], "creator": "greg.woolsey@gmail.com", "attachment_id": null, "text": "This isn't a problem with formula function coverage, it is a core problem with XSSF formula SYNTAX evaluation.  POI just doesn't understand Excel Table \"Structured References\" in formulas.  These are XSSF format objects only, and have no equivalent in HSSF.\n\nhttps://support.office.com/en-us/article/Using-structured-references-with-Excel-tables-f5ed2452-2337-4f71-bed3-c8ae6d2b276e\n\nThis means POI formula support is limited to pre-2007 syntax only, which is an increasing problem.\n\nThe fix should not be too hard, but would be deep into XSSFEvaluationWorkbook.  There is no function to register.  It would need to extend getName(String, int) to also check all sheets for tables matching the given name (tables have globally scoped names but are tied to specific sheets), and return something similar to EvaluationName.  \n\nSince table references are just convenience syntax, this could just map directly to a range specification and parse the formula using the range expression from that point on, I think.\n\nI plan to dig a bit, but any fix will involve some extensive refactoring, so I'm not sure anyone outside the core committers can write a patch acceptable to the repository owners.", "id": 191434, "time": "2016-06-06T19:41:39Z", "bug_id": 57721, "creation_time": "2016-06-06T19:41:39Z", "is_private": false}, {"count": 6, "tags": [], "text": "I found this issue, with a potential patch, that has received no attention in over a year:\n\nhttps://bz.apache.org/bugzilla/show_bug.cgi?id=57840\n\nFrom the description, this looks like exactly what is needed.", "attachment_id": null, "id": 191435, "creator": "greg.woolsey@gmail.com", "time": "2016-06-06T20:19:57Z", "bug_id": 57721, "creation_time": "2016-06-06T20:19:57Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 57721, "attachment_id": null, "id": 191529, "time": "2016-06-10T16:37:20Z", "creator": "onealj@apache.org", "creation_time": "2016-06-10T16:37:20Z", "is_private": false, "text": "With the added support of structured references from bug 57840, using the XSSFFormulaEvaluator to evaluate all formulas in a workbook containing structured references works. Applied unit test in r1747740 to make sure this continues to work into the future."}, {"count": 8, "tags": [], "creator": "onealj@apache.org", "attachment_id": null, "is_private": false, "id": 193909, "time": "2016-09-22T07:16:37Z", "bug_id": 57721, "creation_time": "2016-09-22T07:16:37Z", "text": "Is anything else needed to close this bug?"}, {"count": 9, "tags": [], "text": "I think the other patches accepted for Structured Reference syntax cover this.  I've been on other tasks for a bit, will be digging back into the project that needed this shortly.  If I find anything else, it would be new bugs filed separately (hopefully with patches :D )", "is_private": false, "id": 193939, "creator": "greg.woolsey@gmail.com", "time": "2016-09-22T20:05:18Z", "bug_id": 57721, "creation_time": "2016-09-22T20:05:18Z", "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 57721, "attachment_id": null, "text": "Closing. This was added to the changelog under Version 3.15-beta2 (2016-07-02) https://poi.apache.org/changes.html", "id": 193944, "time": "2016-09-22T21:45:25Z", "creator": "onealj@apache.org", "creation_time": "2016-09-22T21:45:25Z", "is_private": false}]