[{"count": 0, "attachment_id": null, "creator": "knst.kolinko@gmail.com", "is_private": false, "id": 175938, "time": "2014-06-21T02:19:53Z", "bug_id": 56653, "creation_time": "2014-06-21T02:19:53Z", "tags": [], "text": "I noticed this issue while reviewing the code of Mapper.removeContextVersion() of the current trunk (@1604217). The same code exists in Tomcat 7 and 6.\n\nIn Mapper.removeContextVersion() (Mapper.removeContext() in Tomcat 6) it does the following:\n[[[\nhost.contextList.contexts = newContexts;             \n// Recalculate nesting                               \nhost.contextList.nesting = 0;                        \nfor (int i = 0; i < newContexts.length; i++) {       \n    int slashCount = slashCount(newContexts[i].name);\n    if (slashCount > host.contextList.nesting) {     \n        host.contextList.nesting = slashCount;       \n    }                                                \n}                                                    \n]]]\n\nThe problem is there is a delay between when the list of contexts is updated (contextList.contexts) and the contextList.nesting field is updated. The \"nesting\" field is used when mapping contexts.\n\nFor example,\n1. If there are the following contexts:\nROOT\nfoo\nfoo#bar\n\n2. Context foo#bar is being stopped.\n\n3. A request for \"foo\" comes in, e.g. http://localhost/foo/index.html\nExpected behaviour: Map the context to foo application.\nActual behaviour:\nIt may be that the request will be erroneously mapped to the ROOT webapp instead of \"foo\".\n\nI have a test case."}, {"count": 1, "tags": [], "creator": "knst.kolinko@gmail.com", "is_private": false, "text": "I added the test case in r1604309.\nIt may pass, but I also observed the following failures:\n\norg.junit.ComparisonFailure: expected:<[/foo/bar/bla]> but was:<[]>\n\tat org.apache.catalina.mapper.TestMapper.testContextListConcurrencyBug56653(TestMapper.java:263)", "id": 175939, "time": "2014-06-21T02:26:35Z", "bug_id": 56653, "creation_time": "2014-06-21T02:26:35Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 56653, "attachment_id": 31736, "id": 175940, "time": "2014-06-21T03:10:03Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-06-21T03:10:03Z", "is_private": false, "text": "Created attachment 31736\n2014-06-21_tc8_56653_v1.patch\n\nThis patch fixes the issue, BUT breaks aliases support.\nThanks to TestMapper tests for catching that.\n\nThe idea to turn ContextList into an immutable object with final fields does not work, because all aliases share the same ContextList object."}, {"count": 3, "tags": [], "bug_id": 56653, "attachment_id": null, "is_private": false, "id": 175950, "time": "2014-06-21T06:31:07Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-06-21T06:31:07Z", "text": "Fixed in Tomcat 8 by r1604319 and will be in 8.0.10 onwards."}, {"count": 4, "tags": [], "text": "(In reply to Konstantin Kolinko from comment #3)\n> Fixed in Tomcat 8 by r1604319 and will be in 8.0.10 onwards.\n\nA part of that solution was reverted in r1604934 and re-implemented in a different way in r1604940.\n\nInstead of introducing an additional level of indirection, I run a loop to update all the aliases.", "attachment_id": null, "id": 175993, "creator": "knst.kolinko@gmail.com", "time": "2014-06-23T21:19:11Z", "bug_id": 56653, "creation_time": "2014-06-23T21:19:11Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 56653, "attachment_id": null, "id": 176303, "time": "2014-07-09T02:38:16Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-07-09T02:38:16Z", "is_private": false, "text": "Fixed in Tomcat 7 with r1608983 and r1608993 and  will be in 7.0.55 onwards."}, {"count": 6, "tags": [], "text": "Marking as fixed since this was fixed in 7.0.x.\n\nNote it was not back-ported to 6.0.x since 6.0.x reached end of life before anyone expressed an interest in back-porting the fix.", "is_private": false, "id": 195777, "creator": "markt@apache.org", "time": "2017-01-01T11:15:50Z", "bug_id": 56653, "creation_time": "2017-01-01T11:15:50Z", "attachment_id": null}]