[{"count": 0, "attachment_id": 34418, "bug_id": 60337, "is_private": false, "id": 194797, "time": "2016-11-03T15:26:07Z", "creator": "gaeremyncks@gmail.com", "creation_time": "2016-11-03T15:26:07Z", "tags": [], "text": "Created attachment 34418\nA simple Word 2007 document that contains a table with a repeating header row\n\nThis bug report relates to the repeating header logic in XWPFTableRow.\n\nWhen doing a .isRepeatHeader call on the provided Word document an NPE is thrown on line 229 (repeat = rpt.getVal().equals(STOnOff.ON);). It looks like .getVal() can be null, even though the repeating header is enabled in the document. I Generated this document in Microsoft Word for Mac v15.25 (160817).\n\nRelated to this, setRepeatHeader seems to append values rather than replace them. When you check whether the header is a repeating table header after a setRepeatHeader call you will always get the initial value as (CTOnOff rpt = trpr.getTblHeaderArray(0);) is used. I'm not sure whether that's according to the spec or not but I thought I'd mention it in the report nonetheless.\n\nBelow is a diff [1] that includes test cases for both bugs.\n\nLet me know if you need any extra information.\n\nThanks!\nSimon\n\n\ndiff --git a/src/ooxml/testcases/org/apache/poi/xwpf/usermodel/TestXWPFTableRow.java b/src/ooxml/testcases/org/apache/poi/xwpf/usermodel/TestXWPFTableRow.java\nindex b22f1a0..2f1242f 100644\n--- a/src/ooxml/testcases/org/apache/poi/xwpf/usermodel/TestXWPFTableRow.java\n+++ b/src/ooxml/testcases/org/apache/poi/xwpf/usermodel/TestXWPFTableRow.java\n@@ -18,6 +18,8 @@\n package org.apache.poi.xwpf.usermodel;\n \n import junit.framework.TestCase;\n+\n+import org.apache.poi.xwpf.XWPFTestDataSamples;\n import org.openxmlformats.schemas.wordprocessingml.x2006.main.CTRow;\n import org.openxmlformats.schemas.wordprocessingml.x2006.main.CTTbl;\n \n@@ -60,8 +62,29 @@ public class TestXWPFTableRow extends TestCase {\n         XWPFTableRow tr = table.getRow(0);\n         assertNotNull(tr);\n \n+        // Assert the repeat header is false by default\n+        boolean isRpt = tr.isRepeatHeader();\n+        assertFalse(isRpt);\n+\n+        // Repeat the header\n         tr.setRepeatHeader(true);\n+        isRpt = tr.isRepeatHeader();\n+        assertTrue(isRpt);\n+\n+        // Make the header no longer repeating\n+        tr.setRepeatHeader(false);\n+        isRpt = tr.isRepeatHeader();\n+        assertFalse(isRpt);\n+    }\n+\n+    // Test that validates the table header value can be parsed from a document generated in Word\n+    public void testIsRepeatHeader() throws Exception {\n+        XWPFDocument doc = XWPFTestDataSamples.openSampleDocument(\"Word2007TableWithHeader.docx\");\n+        XWPFTable table = doc.getTables().get(0);\n+        assertNotNull(table);\n+        XWPFTableRow tr = table.getRow(0);\n+        assertNotNull(tr);\n         boolean isRpt = tr.isRepeatHeader();\n-        assert (isRpt);\n+        assertTrue(isRpt);\n     }\n }"}, {"count": 1, "tags": [], "bug_id": 60337, "text": "I admit I'm fairly new to this but I think the specification [1] allows for just having a <w:tblHeader /> element (so no val=\"true\" attribute).\n\nThe logic should probably be something like:\nif (trpr.sizeOfTblHeaderArray() > 0) {\n    // Use last index here?\n    CTOnOff rpt = trpr.getTblHeaderArray(0);\n    STOnOff.Enum val = rpt.getVal();\n    repeat = (val == null || val.equals(STOnOff.ON));\n}\n\n[1] http://officeopenxml.com/WPtableRowProperties.php", "id": 194798, "time": "2016-11-03T15:38:43Z", "creator": "gaeremyncks@gmail.com", "creation_time": "2016-11-03T15:38:43Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "text": "Are you able to construct a file in word where trpr.sizeOfTblHeaderArray() is 2 or 3? That would let us verify the right behaviour in the fix, as well as allowing an even better unit test!", "is_private": false, "bug_id": 60337, "id": 194801, "time": "2016-11-03T17:38:15Z", "creator": "apache@gagravarr.org", "creation_time": "2016-11-03T17:38:15Z", "attachment_id": null}, {"count": 3, "tags": [], "text": "I don't think that is a possibility for Word, and it doesn't make any sense. I don't know why the Schema is that way, there are several properties that can be arrays in this context, but in a document, it makes no sense.\n\nCan't split row is another property that wiull have the same problems as repeating rows. I think I have this.", "is_private": false, "id": 194826, "creation_time": "2016-11-04T22:29:26Z", "time": "2016-11-04T22:29:26Z", "creator": "jmarkmurphy@apache.org", "bug_id": 60337, "attachment_id": null}, {"count": 4, "tags": [], "text": "r1768153", "is_private": false, "id": 194832, "creation_time": "2016-11-05T06:14:08Z", "time": "2016-11-05T06:14:08Z", "creator": "jmarkmurphy@apache.org", "bug_id": 60337, "attachment_id": null}, {"count": 5, "tags": [], "creator": "jmarkmurphy@apache.org", "text": "Created attachment 34421\nmylyn/context/zip", "id": 194833, "time": "2016-11-05T06:14:11Z", "bug_id": 60337, "creation_time": "2016-11-05T06:14:11Z", "is_private": false, "attachment_id": 34421}]