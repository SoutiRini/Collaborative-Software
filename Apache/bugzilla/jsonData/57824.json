[{"count": 0, "tags": [], "creator": "michal.sevcenko@etnetera.cz", "attachment_id": null, "text": "When upgrading tomcat to 7.0.59 we started experience strange errors in WELD integration layer. It seems that when an error occurres (e.g. 403 reported by HttpServletResponse.sendError(HttpServletResponse.SC_FORBIDDEN)), which does not have error page handler declared in web.xml, the org.apache.catalina.Context.fireRequestDestroyEvent does not get called.\n\nThe problem may be related to the following change:\n\nhttps://github.com/markt-asf/tomcat/commit/5e195b2f06dba1be3f90b0a9d1f67604af905e47\n\nwhich was a fix of BUG#57252.\n\nThe problem may be in StandardHostValve\n\nlines 319:324\n        ErrorPage errorPage = context.findErrorPage(statusCode);\n        if (errorPage == null) {\n            // Look for a default error page\n            errorPage = context.findErrorPage(0);\n        }\n        if (errorPage != null && response.setErrorReported()) {\n\ni.e. if error page is not found the reposnse is not marked as \"setErrorReported\"\n\nand then lines 214-216\n\n            if (!request.isAsync() && !response.isErrorReportRequired()) {\n                context.fireRequestDestroyEvent(request);\n            }\n\ni.e. if request is synchronous and the error report is not required (caused by missing error page) the important lifecycle method is not called.\n\nThe workaround is to declare universal error handler page\n\n\t<error-page>\n\t\t<location>...</location>\n\t</error-page>\n\nwhich ensures that some error page is always found.\n\nThe problem may also be related to BUG#57314 as it has the same symptoms reported in\n\nhttp://weld.cdi-spec.org/documentation/ see What do WELD-xxx warnings mean?\n\nie WELD-000225, WELD-000335, WELD-000715 errors that report leaked resources caused by missing lifecycle method call.\n\nAccording to this bug report we thought that the problem is caused by async requests (which we do not use explicitly), but declaring the error page correctly seems to fix the problem.", "id": 182434, "time": "2015-04-16T17:14:42Z", "bug_id": 57824, "creation_time": "2015-04-16T17:14:42Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 57824, "text": "Hi,\n\nFix is provided in Tomcat 7 trunk and will be available for 7.0.62 onwards.\n\nRegards,\nVioleta", "id": 182435, "time": "2015-04-16T18:59:52Z", "creator": "violetagg@apache.org", "creation_time": "2015-04-16T18:59:52Z", "is_private": false, "attachment_id": null}]