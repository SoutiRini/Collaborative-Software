[{"count": 0, "tags": [], "bug_id": 54064, "attachment_id": null, "id": 163021, "time": "2012-10-29T13:17:20Z", "creator": "dragos.cernahoschi@gmail.com", "creation_time": "2012-10-29T13:17:20Z", "is_private": false, "text": "As suggested by mladen turk I'm filling a bug regarding this tomcat native issue:\nhttps://community.jboss.org/thread/212044\n\nIt seems that Jboss AS 7.1.2 uses 1.1.22 version of tomcat native.\n\nIf you need more information please contact me.\n\nThank you."}, {"count": 1, "tags": [], "creator": "mturk@apache.org", "attachment_id": null, "id": 163022, "time": "2012-10-29T13:23:20Z", "bug_id": 54064, "creation_time": "2012-10-29T13:23:20Z", "is_private": false, "text": "Yes, we had similar issue on users list but was not entered into BZ cause reporter could not figure out the reason. I think I know what might be the issue, so it would be great if you can verify the fix (after I apply it to the subversion)"}, {"count": 2, "tags": [], "bug_id": 54064, "attachment_id": null, "text": "Yes, I'll verify it the next day(s) after you apply the fix.", "id": 163031, "time": "2012-10-29T16:21:07Z", "creator": "dragos.cernahoschi@gmail.com", "creation_time": "2012-10-29T16:21:07Z", "is_private": false}, {"count": 3, "tags": [], "creator": "mturk@apache.org", "attachment_id": null, "id": 163050, "time": "2012-10-30T07:31:41Z", "bug_id": 54064, "creation_time": "2012-10-30T07:31:41Z", "is_private": false, "text": "OK.\nI have applied possible fix.\nCheckout the 1.1.x branch\n\nsvn co https://svn.apache.org/repos/asf/tomcat/native/branches/1.1.x\n\nor apply a fix to tomcat-native-1.1.24 (might be easier to do since you won't\nneed apr sources, just apr-devel package for Ubuntu)\n\nhttp://svn.apache.org/viewvc/tomcat/native/branches/1.1.x/native/src/network.c?r1=1403635&r2=1403634&pathrev=1403635&view=patch"}, {"count": 4, "tags": [], "creator": "dragos.cernahoschi@gmail.com", "attachment_id": null, "id": 163183, "time": "2012-11-05T11:59:37Z", "bug_id": 54064, "creation_time": "2012-11-05T11:59:37Z", "is_private": false, "text": "Ok, sorry for the delay.\n\nCan you help me with the native libraries building? I need the library built for a linux-x86-64 environment. Unfortunately I have only one machine like this: the live machine and I cannot build there."}, {"count": 5, "tags": [], "creator": "mturk@apache.org", "text": "What's the OS (and version) you are running that on?", "id": 163191, "time": "2012-11-05T12:40:33Z", "bug_id": 54064, "creation_time": "2012-11-05T12:40:33Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "creator": "dragos.cernahoschi@gmail.com", "text": "Ubuntu server 10.04.", "id": 163192, "time": "2012-11-05T12:54:50Z", "bug_id": 54064, "creation_time": "2012-11-05T12:54:50Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 54064, "is_private": false, "id": 163194, "attachment_id": 29548, "creator": "mturk@apache.org", "creation_time": "2012-11-05T13:12:11Z", "time": "2012-11-05T13:12:11Z", "text": "Created attachment 29548\ntomcat-native dev\n\nTry with this one. It's build on Debian 6 (closest I have to Ubuntu 10)"}, {"count": 8, "tags": [], "creator": "dragos.cernahoschi@gmail.com", "attachment_id": null, "id": 163216, "time": "2012-11-05T22:09:31Z", "bug_id": 54064, "creation_time": "2012-11-05T22:09:31Z", "is_private": false, "text": "It's not working :( I get no errors on jboss startup, but jboss web is refusing to serve any http requests with this new library. There are no errors, the request is just hanging until timeout.\n\nI've just replaced the old native library with new one. Maybe should I have rebuilt the whole jboss and jboss web? Seems complicated as jboss uses tomcat native by a jboss native dependency."}, {"count": 9, "tags": [], "bug_id": 54064, "attachment_id": null, "id": 163224, "time": "2012-11-06T04:13:02Z", "creator": "mturk@apache.org", "creation_time": "2012-11-06T04:13:02Z", "is_private": false, "text": "OK. It seems its either wrong binary or the patch is faulty.\nNevertheless let me setup Ubuntu 10.04-4 and I'll check that.\nFrom where did you get the AS 7.1.2. That's not official community release, so it's either build from source or its from EAP-6.0. In later case which natives you are using?"}, {"count": 10, "tags": [], "creator": "dragos.cernahoschi@gmail.com", "text": "Yes. My Jboss is built from github sources: https://github.com/jbossas/jboss-as/tree/7.1.2.Final.", "id": 163226, "time": "2012-11-06T07:49:31Z", "bug_id": 54064, "creation_time": "2012-11-06T07:49:31Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "bug_id": 54064, "is_private": false, "text": "OK, so it seems we are still missing some info.\n\n1. Did you build tomcat-native as well? \n   If not from where it comes.\n2. Where do you load tomcat-native from\n   modules/org/jboss/as/web/main/lib/linux-x86_64\n   or you depend on system LD_LIBRARY_PATH\n3. IIUC you are using https (openssl version 0.9.8k) when those delays occur.\n   Does it happen for non-ssl layer as well?", "id": 163231, "time": "2012-11-06T14:12:43Z", "creator": "mturk@apache.org", "creation_time": "2012-11-06T14:12:43Z", "attachment_id": null}, {"count": 12, "tags": [], "text": "Created attachment 29560\ntomcat native for ubuntu 10.04\n\nThis is build on ubuntu server 10.04 linking to system's apr (1.3.8)", "attachment_id": 29560, "bug_id": 54064, "id": 163233, "time": "2012-11-06T16:31:56Z", "creator": "mturk@apache.org", "creation_time": "2012-11-06T16:31:56Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 54064, "text": "Answers:\n\n1. No. It seems that the build system for jboss produces the native libraries auto magically. It declares a dependency with jboss native 2.0.10 and I think it downloads the libraries from somewhere, they couldn't be built locally. If you build the Jboss 7.1.2 from github you will have the exact libraries I'm using.\n\n2. Jboss v. > 7.1.1 has a \"native\" configuration parameter for jboss web <subsystem xmlns=\"urn:jboss:domain:web:1.1\" ... native=\"true\"> that enables or disables the native support. They are definitely loaded from modules/org/jboss/as/web/main/lib/linux-x86_64. Here I replace the jboss library with the library you sent to me.\n\n3. Yes. The application runs only on https. And the slow connections with high CPU usage happen only when using ssl with the native connector \"native=\"true\". When using the ssl with the java connector (native=\"false\") there are some slow requests, but they deterministic: clients connecting with strange devices, slow connections and more importantly the CPU usage remains normal.\n\nThe bad news is that the last library you attached works better, but is not usable. It serves https requests, but the pages are only partially loaded. Sorry.", "id": 163252, "attachment_id": null, "creator": "dragos.cernahoschi@gmail.com", "creation_time": "2012-11-06T22:26:43Z", "time": "2012-11-06T22:26:43Z", "is_private": false}, {"text": "OK, thanks for a detailed feedback.\nIt seems patch I made is faulty so let me try something different.\n\nBecause of high CPU usage you observe its probable we have some endless loop and detecting such scenarios can be a real PITA, especially since its caused by some sort of client-server communication irregularity.\n\nI'd appreciated if you could test few more versions with some debug logging added so we get some clue what is going on with those margin requests.\n\nBTW, what kind of client you are using, and is there some consistency on client usage (e.g more errors with particular client or similar)?", "tags": [], "bug_id": 54064, "attachment_id": null, "count": 14, "id": 163257, "time": "2012-11-07T04:28:02Z", "creator": "mturk@apache.org", "creation_time": "2012-11-07T04:28:02Z", "is_private": false}, {"count": 15, "tags": [], "bug_id": 54064, "attachment_id": null, "text": "I think I found a pattern for the slow connections. I've used in the last week only the java https connector, not the native connector. And the very slow connections(300s, 600s) still happen with the same rate: 0.01 - 0.02% off all requests.\n\nI checked the logs from the previous weeks when I was using the native connector and found they happen when a client with a dynamic IP have its IP changed mid time a request: it starts the request with an IP and waits the response on another one. It might happen on slow connections when receiving a larger response.\n\nSo the only difference between the java connector and native connector is that the last one uses CPU intensively to solve this use case. After the request is served the CPU usage goes down.\n\nWhy are the connectors slow in this case? What can it be done?\n\nIf you have a patch for the native connector that solves at least the high CPU problem I'll try it.", "id": 163306, "time": "2012-11-09T10:50:48Z", "creator": "dragos.cernahoschi@gmail.com", "creation_time": "2012-11-09T10:50:48Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 54064, "text": "Hmm,\n\nThis looks like an endless loop where socket is trying to write to something that's not there any more. The problem with that is how to simulate such situation. Since it happens with SSL only I presume its hidden somewhere in our SSL send loop. Since it seems the only way is by trial and error let me check few options. I'll prepare real tcnative binary for Linux, so hope you'll be able to check few runs.", "id": 163366, "attachment_id": null, "creator": "mturk@apache.org", "creation_time": "2012-11-12T05:40:55Z", "time": "2012-11-12T05:40:55Z", "is_private": false}, {"count": 17, "text": "\n\n*** This bug has been marked as a duplicate of bug 52856 ***", "bug_id": 54064, "attachment_id": null, "id": 163517, "time": "2012-11-19T05:35:30Z", "creator": "mturk@apache.org", "creation_time": "2012-11-19T05:35:30Z", "tags": [], "is_private": false}]