[{"count": 0, "tags": [], "bug_id": 48097, "attachment_id": 24452, "id": 131530, "time": "2009-11-01T11:06:06Z", "creator": "amichai2@amichais.net", "creation_time": "2009-11-01T11:06:06Z", "is_private": false, "text": "Created attachment 24452\nsimple webapp with one jsp and one class in one jar, reproducing the error\n\nI've had a strange situation getting NoClassDefFoundErrors on a particular jsp\npage (which happened to be the index.jsp page). The class it claimed to not\nfind is a simple session bean class within a jar in the WEB-INF/lib folder. The\nstrange thing is that it gave this error only when this page was the first one\naccessed after a tomcat restart. If any page was accessed before it, it would\nwork properly. But if this page was accessed first, then no matter what pages\nwere later accessed, the error remained in place. So the error/success state\nwas determined by whichever page was accessed first ater the tomcat restart,\nand remained in the same error/success state for as long as tomcat was up,\nregardless of anything happening later on (until the next restart)\n\nThis seems to be some sort of class-loading oder-of-initialization bug, but is\nentirely consistent when the pages are accessed in this order after a tomcat\nrestart. It drove me nuts for a while, since the main application page was\nshowing an error after every restart, but I eventually stumbled on a strange\nworkaround: changing the order or a couple of lines in the jsp, involving the\nuseBean directive and access to java's URI class. with the order changed, the\nerror never happens. with the order returned, the error is reproduced as\ndescribed above.\n\nI've managed to distill a simple scenario which reproduces this error - a short\njsp and a trivial bean session class - attached. I reproduced this on a fresh\ninstallation of Kubuntu 9.10 in a virtual machine, with sun jre 6 and tomcat6\ninstalled. I didn't change any configuration, just replaced the ROOT sample\nwebapp with this one, restarted tomcat, and browsed to\nhttp://localhost:8080/index.jsp. Remember u have to restart tomcat after every\nchange to the jsp if u want to recreate the bug, because simply changing it and\nrefreshing the browser will always succeed."}, {"count": 1, "text": "What is your configuration of JspServlet in conf/web.xml file?\nIts \"development\" option is set to true or false?\n\nIs your Tomcat version 6.0.20?\n\nAre you running with SecurityManager enabled?\n\nCan you provide any stack traces? From the error page and from the log files.", "creator": "knst.kolinko@gmail.com", "is_private": false, "id": 131531, "time": "2009-11-01T12:44:49Z", "bug_id": 48097, "creation_time": "2009-11-01T12:44:49Z", "tags": [], "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 48097, "attachment_id": null, "id": 131532, "time": "2009-11-01T13:51:27Z", "creator": "amichai2@amichais.net", "creation_time": "2009-11-01T13:51:27Z", "is_private": false, "text": "Yes, it's version 6.0.20. As mentioned, I changed nothing at all in the default configuration from the distro's installation - simply overwrote the webapps/ROOT folder.\n\nThe JspServlet configuration in web.xml:\n\n<servlet>\n        <servlet-name>jsp</servlet-name>\n        <servlet-class>org.apache.jasper.servlet.JspServlet</servlet-class>\n        <init-param>\n            <param-name>fork</param-name>\n            <param-value>false</param-value>\n        </init-param>\n        <init-param>\n            <param-name>xpoweredBy</param-name>\n            <param-value>false</param-value>\n        </init-param>\n        <load-on-startup>3</load-on-startup>\n    </servlet>\n\nI don't see 'development' set anywhere in web.xml, so I guess it uses the default.\n\nI didn't explicitly set a SecurityManager, where can I check what the default is, or if it is set?\n\nThere are two types of errors in the logs, from the first access after a restart, and a refresh after that:\n\nov 1, 2009 8:50:11 PM org.apache.catalina.core.StandardWrapperValve invoke\nSEVERE: Servlet.service() for servlet jsp threw exception\njava.lang.NoClassDefFoundError: net/freeutils/web/SessionBean\n        at org.apache.jsp.index_jsp._jspService(index_jsp.java:64)\n        at org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:70)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)\n        at org.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:374)\n        at org.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:342)\n        at org.apache.jasper.servlet.JspServlet.service(JspServlet.java:267)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:616)\n        at org.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:269)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at javax.security.auth.Subject.doAsPrivileged(Subject.java:537)\n        at org.apache.catalina.security.SecurityUtil.execute(SecurityUtil.java:301)\n        at org.apache.catalina.security.SecurityUtil.doAsPrivilege(SecurityUtil.java:162)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:283)\n        at org.apache.catalina.core.ApplicationFilterChain.access$000(ApplicationFilterChain.java:56)\n        at org.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:189)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:185)\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:128)\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:293)\n        at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:849)\n        at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:583)\n        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:454)\n        at java.lang.Thread.run(Thread.java:636)\nNov 1, 2009 8:50:30 PM org.apache.catalina.core.StandardWrapperValve invoke\nSEVERE: Servlet.service() for servlet jsp threw exception\njava.lang.ClassNotFoundException: net.freeutils.web.SessionBean\n        at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1387)\n        at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1233)\n        at org.apache.jasper.servlet.JasperLoader.loadClass(JasperLoader.java:128)\n        at org.apache.jasper.servlet.JasperLoader.loadClass(JasperLoader.java:66)\n        at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:336)\n        at org.apache.jsp.index_jsp._jspService(index_jsp.java:64)\n        at org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:70)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)\n        at org.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:374)\n        at org.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:342)\n        at org.apache.jasper.servlet.JspServlet.service(JspServlet.java:267)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:616)\n        at org.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:269)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at javax.security.auth.Subject.doAsPrivileged(Subject.java:537)\n        at org.apache.catalina.security.SecurityUtil.execute(SecurityUtil.java:301)\n        at org.apache.catalina.security.SecurityUtil.doAsPrivilege(SecurityUtil.java:162)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:283)\n        at org.apache.catalina.core.ApplicationFilterChain.access$000(ApplicationFilterChain.java:56)\n        at org.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:189)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:185)\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:128)\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:293)\n        at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:849)\n        at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:583)\n        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:454)\n        at java.lang.Thread.run(Thread.java:636)\n\n\nThe error page exception:\n\ndescription The server encountered an internal error () that prevented it from fulfilling this request.\n\nexception\n\norg.apache.jasper.JasperException: javax.servlet.ServletException: java.lang.NoClassDefFoundError: net/freeutils/web/SessionBean\n\torg.apache.jasper.servlet.JspServletWrapper.handleJspException(JspServletWrapper.java:522)\n\torg.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:398)\n\torg.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:342)\n\torg.apache.jasper.servlet.JspServlet.service(JspServlet.java:267)\n\tjavax.servlet.http.HttpServlet.service(HttpServlet.java:717)\n\tsun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tsun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n\tsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tjava.lang.reflect.Method.invoke(Method.java:616)\n\torg.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:269)\n\tjava.security.AccessController.doPrivileged(Native Method)\n\tjavax.security.auth.Subject.doAsPrivileged(Subject.java:537)\n\torg.apache.catalina.security.SecurityUtil.execute(SecurityUtil.java:301)\n\torg.apache.catalina.security.SecurityUtil.doAsPrivilege(SecurityUtil.java:162)\n\nroot cause\n\njavax.servlet.ServletException: java.lang.NoClassDefFoundError: net/freeutils/web/SessionBean\n\torg.apache.jasper.runtime.PageContextImpl.doHandlePageException(PageContextImpl.java:862)\n\torg.apache.jasper.runtime.PageContextImpl.access$1100(PageContextImpl.java:71)\n\torg.apache.jasper.runtime.PageContextImpl$12.run(PageContextImpl.java:778)\n\tjava.security.AccessController.doPrivileged(Native Method)\n\torg.apache.jasper.runtime.PageContextImpl.handlePageException(PageContextImpl.java:776)\n\torg.apache.jsp.index_jsp._jspService(index_jsp.java:85)\n\torg.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:70)\n\tjavax.servlet.http.HttpServlet.service(HttpServlet.java:717)\n\torg.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:374)\n\torg.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:342)\n\torg.apache.jasper.servlet.JspServlet.service(JspServlet.java:267)\n\tjavax.servlet.http.HttpServlet.service(HttpServlet.java:717)\n\tsun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tsun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n\tsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tjava.lang.reflect.Method.invoke(Method.java:616)\n\torg.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:269)\n\tjava.security.AccessController.doPrivileged(Native Method)\n\tjavax.security.auth.Subject.doAsPrivileged(Subject.java:537)\n\torg.apache.catalina.security.SecurityUtil.execute(SecurityUtil.java:301)\n\torg.apache.catalina.security.SecurityUtil.doAsPrivilege(SecurityUtil.java:162)\n\nroot cause\n\njava.lang.NoClassDefFoundError: net/freeutils/web/SessionBean\n\torg.apache.jsp.index_jsp._jspService(index_jsp.java:64)\n\torg.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:70)\n\tjavax.servlet.http.HttpServlet.service(HttpServlet.java:717)\n\torg.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:374)\n\torg.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:342)\n\torg.apache.jasper.servlet.JspServlet.service(JspServlet.java:267)\n\tjavax.servlet.http.HttpServlet.service(HttpServlet.java:717)\n\tsun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tsun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n\tsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tjava.lang.reflect.Method.invoke(Method.java:616)\n\torg.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:269)\n\tjava.security.AccessController.doPrivileged(Native Method)\n\tjavax.security.auth.Subject.doAsPrivileged(Subject.java:537)\n\torg.apache.catalina.security.SecurityUtil.execute(SecurityUtil.java:301)\n\torg.apache.catalina.security.SecurityUtil.doAsPrivilege(SecurityUtil.java:162)\n\n\nAny other information that I can supply to help resolve this?"}, {"count": 3, "text": "Thank you for the information.\n\nI can see from the stacktraces that you run with SecurityManager enabled.\n(That is default in some re-distributions of Tomcat).\n\nThe \"development\" flag of JspServlet defaults to \"true\".\n\n\nUnfortunately, as of now I cannot reproduce your error neither on 6.0.20 nor on the latest tc6.0.x.   While trying your app I saw an error once in latest tc6.0.x, but it was different from what you are observing, and it also is no more reproducible. As it is so hard to reproduce, I suppose it is a race condition.\n\n\nThe error that you observed occurs in _jspService() method of compiled JSP page class. So the class was successfully compiled, loaded into memory, its instance created, _jspService method called, and then the error occurs.\n> org.apache.jsp.index_jsp._jspService(index_jsp.java:64)\n\nLine 64 in my copy of the file, compiled by Tomcat 6.0.20, is\n> bean = new net.freeutils.web.SessionBean();\n\nIt was WebappClassLoader's responsibility to load the class. Line 1387 there is the normal exit, when no classfile is found.\n> org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1387)\n\nI do not see any clues to what could have caused this.\n\n\nNote, that requesting '/index.jsp' and requesting '/' might be different, because the latter involves more resource existence checks.\n\n\nOur usual question regarding re-distributions of Tomcat is whether an error is reproducible with our official distribution from tomcat.apache.org.\n\nNote, that to start with SecurityManager you run 'catalina.sh start -security', and that the default conf/catalina.policy file of TC 6.0.20 does not work with recent version of Sun JRE (starting with 6u14). You have to get the updated version of it from\nhttp://svn.apache.org/repos/asf/tomcat/tc6.0.x/trunk/conf/", "bug_id": 48097, "is_private": false, "id": 131538, "time": "2009-11-01T16:18:11Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2009-11-01T16:18:11Z", "tags": [], "attachment_id": null}, {"count": 4, "attachment_id": null, "creator": "amichai2@amichais.net", "is_private": false, "id": 131540, "time": "2009-11-01T17:20:57Z", "bug_id": 48097, "creation_time": "2009-11-01T17:20:57Z", "tags": [], "text": "The bug occurs both with access to '/' and to '/index.jsp', so that can be ruled out as a cause.\n\nI hope I understood you correctly - to make sure, here are the exact steps I just did:\n0. stopped the distro's tomcat instance, and verified there's nothing at localhost:8080.\n1. downloaded the tomcat 6.0.20 binary tar.gz distribution from http://tomcat.apache.org/download-60.cgi, and extracted it to a temp folder.\n2. renamed the webapps/ROOT app to webapps/ROOT.original, and copied the ROOT app (the attachment to this bug) in its place.\n3. ran './catalina.sh start -security' from the bin directory.\n4. opened localhost:8080/index.jsp in the browser. the page loaded successfully.\n5. I realized the classloading was behaving differently than before since there are other webapps (the samples in the distribution, etc.). I backed up the entire webapps folder to webapps.original, and then deleted all folders under webapps, leaving only the ROOT folder (which is my sample app).\n6. ran './catalina.sh stop', refreshed the browser to make sure the server is down, followed by './catalina.sh start'.\n7. refreshed the browser again - and the error was reproduced.\n8. downloaded the catalina.policy file from http://svn.apache.org/repos/asf/tomcat/tc6.0.x/trunk/conf/ and replaced the conf/catalina.policy file with it.\n9. did steps 6 and 7 again, and the error was reproduced again.\n10. repeated steps 6 and 7 again a few more times, accessing either '/' or '/index.jsp', changing the order of the jsp lines (as described in the original report), etc. everything was reproduced exactly as in the original report.\n\nSo, in a nutshell, take the official tomcat binary unmodified, delete everything in the webapps folder (which cause a different classloading sequence to occur), put the attached ROOT sample app in there, and fire it up - this was enough to fully reproduce the bug."}, {"count": 5, "tags": [], "bug_id": 48097, "attachment_id": 24456, "is_private": false, "id": 131543, "time": "2009-11-01T21:17:48Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2009-11-01T21:17:48Z", "text": "Created attachment 24456\nPatch for WebappClassLoader to do not swallow AccessControlException\n\nThe patch is for the current tc6.0.x"}, {"count": 6, "tags": [], "bug_id": 48097, "attachment_id": null, "is_private": false, "id": 131545, "time": "2009-11-01T22:15:14Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2009-11-01T22:15:14Z", "text": "Thank you for the recipe, I was able to reproduce the issue.\n\nThe issue is observable both in 6.0.20 and in current 6.0.x sources, and I was able to do some debugging.\n\n~ What is essential: ~\n\n1). I updated my JDK to 6u16. I was using 6u15 previously.\nI have not verified yet that it indeed works OK with 6u15, but it might be it.\n\n2). It is essential to run with SecurityManager enabled.\n\nThe permissions are essential. If you add\ngrant {\n        permission java.security.AllPermission;\n}\nall starts working again.\n\n3). I removed all applications from the webapps folder, except the ROOT application that was replaced with the one from attachment 24452.\n\n4). You need to precompile the JSP page. That is, start Tomcat, access the page, shutdown Tomcat, and start it for the second time.\n\n5). Access http://localhost:8080/\n\n6). The stacktrace as in Comment #2 is observed.\n\n\n~ Debugging showed the following: ~\n\nThe following line in WebappClassLoader#findResourceInternal(String) resulted in AccessControlException:\n2070:   entry = new ResourceEntry();\n\nThe exception was caught by the caller (WebappClassLoader#findClass(String)) and wrapped into ClassNotFoundException.\n\nThe ClassNotFoundException was caught by the caller (WebappClassLoader#loadClass(String,boolean)) and ignored. That is why we do not see it in the logs.\n\nThe patch in attachment 24456 makes WebappClassLoader#findClass(String) to log the AccessControlException when it is encountered.\n\nThe exception text and stacktrace are the following:\n\n02.11.2009 7:53:51 org.apache.catalina.loader.WebappClassLoader findClass\nSEVERE: findClassInternal(net.freeutils.web.SessionBean) failed\njava.security.AccessControlException: access denied (java.lang.RuntimePermission accessClassInPackage.org.apache.catalina.loader)\n\tat java.security.AccessControlContext.checkPermission(Unknown Source)\n\tat java.security.AccessController.checkPermission(Unknown Source)\n\tat java.lang.SecurityManager.checkPermission(Unknown Source)\n\tat java.lang.SecurityManager.checkPackageAccess(Unknown Source)\n\tat sun.misc.Launcher$AppClassLoader.loadClass(Unknown Source)\n\tat java.lang.ClassLoader.loadClass(Unknown Source)\n\tat java.lang.ClassLoader.loadClass(Unknown Source)\n\tat java.lang.ClassLoader.loadClassInternal(Unknown Source)\n\tat org.apache.catalina.loader.WebappClassLoader.findResourceInternal(WebappClassLoader.java:2070)\n\tat org.apache.catalina.loader.WebappClassLoader.findClassInternal(WebappClassLoader.java:1851)\n\tat org.apache.catalina.loader.WebappClassLoader.findClass(WebappClassLoader.java:887)\n\tat org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1352)\n\tat org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1231)\n\tat org.apache.jasper.servlet.JasperLoader.loadClass(JasperLoader.java:128)\n\tat org.apache.jasper.servlet.JasperLoader.loadClass(JasperLoader.java:66)\n\tat java.lang.ClassLoader.loadClassInternal(Unknown Source)\n\tat org.apache.jsp.index_jsp._jspService(index_jsp.java:64)\n\tat org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:70)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:717)\n\tat org.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:374)\n\tat org.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:334)\n\tat org.apache.jasper.servlet.JspServlet.service(JspServlet.java:259)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:717)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)\n\tat java.lang.reflect.Method.invoke(Unknown Source)\n\tat org.apache.catalina.security.SecurityUtil$1.run(SecurityUtil.java:269)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAsPrivileged(Unknown Source)\n\tat org.apache.catalina.security.SecurityUtil.execute(SecurityUtil.java:301)\n\tat org.apache.catalina.security.SecurityUtil.doAsPrivilege(SecurityUtil.java:162)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:283)\n\tat org.apache.catalina.core.ApplicationFilterChain.access$000(ApplicationFilterChain.java:56)\n\tat org.apache.catalina.core.ApplicationFilterChain$1.run(ApplicationFilterChain.java:189)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:185)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:294)\n\tat org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:852)\n\tat org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:583)\n\tat org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:478)\n\tat java.lang.Thread.run(Unknown Source)\n\n\n~ Notes: ~\n\n1. The \njava.security.AccessControlException that I cited above is printed into catalina.<date>.log\n\n2. At the same time,\n02.11.2009 8:51:54 org.apache.catalina.core.StandardWrapperValve invoke\nSEVERE: Servlet.service() for servlet jsp threw exception\njava.lang.ClassNotFoundException: net.freeutils.web.SessionBean\n\tat org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1385)\n\tat org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1231)\n\tat org.apache.jasper.servlet.JasperLoader.loadClass(JasperLoader.java:128)\n\tat org.apache.jasper.servlet.JasperLoader.loadClass(JasperLoader.java:66)\n\tat java.lang.ClassLoader.loadClassInternal(Unknown Source)\n\tat org.apache.jsp.index_jsp._jspService(index_jsp.java:64)\n\nis printed into different log file, localhost.<date>.log\n\n\n3. java.lang.NoClassDefFoundError: net/freeutils/web/SessionBean\n\torg.apache.jsp.index_jsp._jspService(index_jsp.java:64)\nthat is displayed on the error 500 page is not printed into the logs.\n\nThough the ClassNotFoundException is also printed on the error 500 page as the root cause of that NoClassDefFoundError.\n\n4. While debugging I also observed different behaviour: The request to http://localhost:8080/  resulted in blank page (response with content length of 0) being returned by the server.\n\nNote, that the classes layout and the policy file were different while I was debugging.\n\nThe following additional steps allowed me to reproduce this error in that setup:\n1) I deployed an additional empty web application, where I copied index.html from our examples app.\n2) The first access to http://localhost:8080/  resulted in empty page, but if after that I accessed the second webapp, and, after some delay (about 5-10 seconds), used Ctrl+F5 to refresh http://localhost:8080/  in my Firefox,  the error showed itself.\n\n\n5. The blank response suggests that there is some other place in the code, where AccessControlException is ignored. Nothing is written into the logs when the blank response is shown.  I do not know where it occurs.\n\n6. The fix to this issue would be to either add some permissions to the policy, or to preload some classes, as we do. I do not know what is the root cause of it yet, though."}, {"count": 7, "tags": [], "bug_id": 48097, "is_private": false, "text": "I debugged the case of the blank response.\n\nThe sequence of events is the following:\n\n1) The index_jsp.class is successfully loaded, instantiated, and its _jspInit() method was successfully called.\n2) The error occurs in its _jspService(request, response) method.\n\nThe code there is the following:\n    try {\n      response.setContentType(\"text/html; charset=UTF-8\");\n      pageContext = _jspxFactory.getPageContext(this, request, response,\n      \t\t\tnull, true, 8192, true);\n      _jspx_page_context = pageContext;\n\n(...)\n    } catch (Throwable t) {\n      if (!(t instanceof SkipPageException)){\n        out = _jspx_out;\n        if (out != null && out.getBufferSize() != 0)\n          try { out.clearBuffer(); } catch (java.io.IOException e) {}\n        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);\n      }\n    } finally {\n      _jspxFactory.releasePageContext(_jspx_page_context);\n    }\n\nThe exception occurs when calling response.setContentType(). The exception is:\njava.security.AccessControlException: access denied (java.lang.RuntimePermission accessClassInPackage.org.apache.catalina.connector)\n\nBecause it occurs earlier than the _jspx_page_context variable is initialized, the _jspx_page_context.handlePageException(t); line is not called and empty response is returned to the client.\n\n\nThe failure in setContentType() method occurs in ResponseFacade#setContentType(). It is caused by the attempt to load the following class: ResponseFacade$SetContentTypePrivilegedAction\n\nThat class is listed in o.a.catalina.security.SecurityClassLoad#loadCoyotePackage() but, because I used org.apache.catalina.startup.Catalina class to start Tomcat in the IDE, that method was not called at all. It is called from Bootstrap#init() only.\n\nJasper's SecurityClassLoad on the contrary is called, because that occurs in another place.\n\nThe blank page issue disappeared when I used o.a.c.startup.Bootstrap class instead of Catalina.\n\nI do not know, whether we should fix this bootstrap issue. (Is anyone concerned?)", "id": 131547, "time": "2009-11-01T23:44:06Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2009-11-01T23:44:06Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 48097, "attachment_id": 24457, "id": 131548, "time": "2009-11-01T23:56:14Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2009-11-01T23:56:14Z", "is_private": false, "text": "Created attachment 24457\nPatch for SecurityClassLoad to preload o.a.c.loader.ResourceEntry class\n\nThis patch fixes the NoClassDefFoundError: net/freeutils/web/SessionBean issue.\nIt is for the current tc6.0.x."}, {"count": 9, "tags": [], "bug_id": 48097, "attachment_id": 24458, "is_private": false, "id": 131549, "time": "2009-11-02T00:03:32Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2009-11-02T00:03:32Z", "text": "Created attachment 24458\nPatch for WebappClassLoader to do not swallow AccessControlException (updated)\n\nUpdated the WebappClassLoader patch.\n- Changed the log message\n- Reduced severity from error to warning\n- There exist one more case where AccessControlException was swallowed, in the same method.\nThe patch is for the current tc6.0.x."}, {"count": 10, "text": "Thanks for the detailed investigation and review!\n\nI've actually been hit by the blank page issue too a year ago, with a production system's home page returning a blank page and not being noticed for a while (monitoring tools all saw it's a 200 OK and didn't report an error). I didn't know how to recreate it at the time... funny that you hit it with this bug's investigation... (well, maybe funny isn't the right word).\n\nSo, are both issues fixed by these patches? the blank screen replaced with an error, and the error replaced with a successful page load? Is there anything more you need my help with?", "creator": "amichai2@amichais.net", "is_private": false, "id": 131550, "time": "2009-11-02T00:58:32Z", "bug_id": 48097, "creation_time": "2009-11-02T00:58:32Z", "tags": [], "attachment_id": null}, {"count": 11, "tags": [], "text": "Regarding the blank page issue:\nI did not fix it. It was a configuration issue on my side.\nRunning Tomcat with o.a.c.startup.Catalina using a SecurityManager would still be broken. As of now, I do not know, whether and how to fix that.\n\nSuggestions from other Tomcat committers are welcome.\n\nI committed both the patches that fix NoClassDefFoundError issue into trunk, and will propose them for tc6.0.x\n\nAs of now, the trunk does not run with SecurityManager, apparently because of servlet 3.0 classes. This app would be a good example to test it.\n\n> Is there anything more you need my help with?\n\nI think we are done with it.\nYou may want to test TC 6.0.21 when it becomes available.", "attachment_id": null, "id": 131551, "creator": "knst.kolinko@gmail.com", "time": "2009-11-02T01:34:00Z", "bug_id": 48097, "creation_time": "2009-11-02T01:34:00Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 48097, "attachment_id": null, "id": 131864, "time": "2009-11-11T01:18:21Z", "creator": "markt@apache.org", "creation_time": "2009-11-11T01:18:21Z", "is_private": false, "text": "The patches have been applied to 6.0.x and will be in 6.0.21 onwards.\n\nYou should also now be able to run trunk with a security manager."}, {"count": 13, "tags": [], "bug_id": 48097, "attachment_id": null, "is_private": false, "id": 131909, "time": "2009-11-12T11:13:01Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2009-11-12T11:13:01Z", "text": "Reopening.\n\nThe WebappClassLoader$PrivilegedFindResourceByName class (added in rev.834814) has to be preloaded in o.a.c.security.SecurityClassLoad#loadLoaderPackage().\n\nThat can be demonstrated by the following:\n1. Deploy the sample ROOT application, as described in comment #6\n2. Copy default conf/web.xml to webapps/ROOT/WEB-INF/\n3. Remove all content from the default conf/web.xml and leave just the root XML tag and its attributes.\n4. Start  catalina.bat start -security\n5. Access http://localhost:8080/\n6. Observe the exception\n\nUsually the first calls to WebappClassLoader#findResourceInternal() are to load JspServlet and DefaultServlet. In this configuration those are avoided.\n\n\nThis is already fixed in trunk. I will propose a backport soon."}, {"count": 14, "tags": [], "text": "The back port was proposed and has been applied to 6.0.x. It will be included in 6.0.21 onwards.", "attachment_id": null, "id": 132870, "creator": "markt@apache.org", "time": "2009-12-16T08:56:55Z", "bug_id": 48097, "creation_time": "2009-12-16T08:56:55Z", "is_private": false}, {"text": "Fixed in 5.5 in r900755, will be in 5.5.29.\n\nNote, though, that there can be other errors observable at the same circumstances, that are not yet fixed. See bug 48581, bug 48580.", "tags": [], "bug_id": 48097, "is_private": false, "count": 15, "id": 133822, "time": "2010-01-22T00:11:10Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2010-01-22T00:11:10Z", "attachment_id": null}]