[{"count": 0, "tags": [], "bug_id": 23528, "text": "Support, \n The browser hangs for 300sec.waiting for httpd to respond and ends up timing \nout.\nWhen I decrease the amount of content I dont see this problem. I originally had \nthis\nwith 2.0.40. Download and build the latest and get the same hang.  Heres the \nerror_log:\n\n-------------------- Start Error Log ---------------- \n\nThu Sep 25 15:28:31 2003] [notice] Apache/2.0.47 (Unix) configured -- resuming \nnormal operations\n\nThu Sep 25 15:28:31 2003] [info] Server built: Sep 25 2003 14:17:17\n[Thu Sep 25 15:28:31 2003] \n[debug] prefork.c(1037): AcceptMutex: sysvsem (default: sysvsem)\n\n[Thu Sep 25 15:37:41 2003] [error] [client 192.168.8.158] (70007)The timeout \nspecified has expired: ap_content_length_filter: apr_bucket_read() failed, \nreferer: http://192.168.8.158/cgi-bin/editBuildTags-branch3.cgi\n\n-------------------- End -----------------------------", "id": 44899, "time": "2003-09-30T18:12:58Z", "creator": "alirette@sandial.com", "creation_time": "2003-09-30T18:12:58Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 23528, "attachment_id": null, "id": 44900, "time": "2003-09-30T18:21:01Z", "creator": "trawick@apache.org", "creation_time": "2003-09-30T18:21:01Z", "is_private": false, "text": "let me guess... your cgi script is writing a bunch of stuff to stderr?  change\nthat and see if it still occurs"}, {"count": 2, "tags": [], "bug_id": 23528, "attachment_id": null, "text": "Im not writing anything to stderr, only to stdout with print statements and\nwriting/reading files. ", "id": 44908, "time": "2003-09-30T21:32:46Z", "creator": "alirette@sandial.com", "creation_time": "2003-09-30T21:32:46Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 23528, "attachment_id": null, "id": 45026, "time": "2003-10-02T18:29:50Z", "creator": "alirette@sandial.com", "creation_time": "2003-10-02T18:29:50Z", "is_private": false, "text": "Jeff, Any other ideas?  Thanks."}, {"count": 4, "tags": [], "creator": "trawick@apache.org", "attachment_id": null, "text": "If it wasn't a CGI request, I dunno :(  Can you reproduce it with a certain type\nof request?  Have you looked at the access log to see what type of request it is?\n", "id": 45120, "time": "2003-10-06T09:01:16Z", "bug_id": 23528, "creation_time": "2003-10-06T09:01:16Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 23528, "attachment_id": null, "text": "Heres the access.log entry...\n\nlocalhost.localdomain - - [03/Oct/2003:15:16:12 -0400] \"GET /cgi-\nbin/editBuildTags-branch4.cgi HTTP/1.1\" 200 6265 \"-\" \"Mozilla/5.0 (X11; U; \nLinux i686; en-US; rv:1.0.1) Gecko/20021003\"\nlocalhost.localdomain - - [03/Oct/2003:15:16:42 -0400] \"POST /cgi-\nbin/editBuildTags-branch4.cgi HTTP/1.1\" 200 \n\nI can execute the Perl script outside of httpd without any errors, if thats \nwhat your asking me.", "id": 45145, "time": "2003-10-06T11:53:48Z", "creator": "alirette@sandial.com", "creation_time": "2003-10-06T11:53:48Z", "is_private": false}, {"count": 6, "tags": [], "creator": "trawick@apache.org", "is_private": false, "id": 45342, "attachment_id": null, "bug_id": 23528, "creation_time": "2003-10-10T12:35:38Z", "time": "2003-10-10T12:35:38Z", "text": "Reproduce the problem, and during the 300 second hang, attach to the CGI process\nwith strace and see what syscall it is in.\n\nIf you have a simple testcase I can use to reproduce it on my system, please\npost it.\n"}, {"count": 7, "tags": [], "creator": "alirette@sandial.com", "is_private": false, "id": 45655, "attachment_id": null, "bug_id": 23528, "creation_time": "2003-10-14T17:37:19Z", "time": "2003-10-14T17:37:19Z", "text": "Unfortunately I cant get a simple testcase cuase everything I try works. The \napplication itself will work 10-15% of the time.  Is there a debugger I need to \nattatch to the process when it hangs? Im not familar how to do this?"}, {"count": 8, "tags": [], "bug_id": 23528, "text": "This bug is probably the same as bug #20866.\n", "id": 48992, "time": "2003-12-12T17:31:09Z", "creator": "coad@measurement-factory.com", "creation_time": "2003-12-12T17:31:09Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "creator": "alirette@sandial.com", "attachment_id": null, "text": "Has this  ever been resolved?", "id": 50104, "time": "2004-01-05T21:11:30Z", "bug_id": 23528, "creation_time": "2004-01-05T21:11:30Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 23528, "attachment_id": null, "id": 50107, "time": "2004-01-05T21:37:48Z", "creator": "trawick@apache.org", "creation_time": "2004-01-05T21:37:48Z", "is_private": false, "text": "need more information to resolve it...  we don't know what code is hanging... \ninfo requested on 10/10 is expected to help...\n"}, {"count": 11, "tags": [], "creator": "fbujanic@fikus.com", "attachment_id": null, "text": "I have several apache 2.0.48 servers exhibiting the\n\"ap_content_length_filter:  apr_bucket_read() failed\" problem with little\nbit of poking around I found that this happens avery time apache is\nwaiting for a large amount of data to be returned to it from the cgi\nscript (eg. large and time consuming database read/write or extensive\nwriting to stderr). This happens on both 32 and 64 bit (Linux and Solaris)\nplatform but only in the preforked mpm model, the worker (threaded) mpm\nseems to handle this problem better.\n\nI did couple of straces to my cgi script and it always gets stuck in the\nwrite system call and at the same time the corresponding http server is\nstuck in poll system call. this lasts for (5 min) 'Timeout 300' and the\nerror is displayed inside the error_log file\n\n(70007)The timeout specified has expired: ap_content_length_filter:\napr_bucket_read() failed\n\nand the cgi script either dies or becomes a zombie process.\n\nIf I am correct error is coming from httpd-2.0.48/server/protocol.c file,\n(snippet included below) and has to do with BLOCK_READ vs. NONBLOCK_READ.\nI might be totally wrong about this guess but....\n\nHope you have a fix for this bug or maybe an idea how I could work around\nit.\n\nthanks\nfil\n\n    /* Loop through this set of buckets to compute their length\n     */\n    e = APR_BRIGADE_FIRST(b);\n    while (e != APR_BRIGADE_SENTINEL(b)) {\n        if (APR_BUCKET_IS_EOS(e)) {\n            eos = 1;\n            break;\n        }\n        if (e->length == (apr_size_t)-1) {\n            apr_size_t len;\n            const char *ignored;\n            apr_status_t rv;\n\n            /* This is probably a pipe bucket.  Send everything\n             * prior to this, and then read the data for this bucket.\n             */\n            rv = apr_bucket_read(e, &ignored, &len, eblock);\n            if (rv == APR_SUCCESS) {\n                /* Attempt a nonblocking read next time through */\n                eblock = APR_NONBLOCK_READ;\n                r->bytes_sent += len;\n            }\n            else if (APR_STATUS_IS_EAGAIN(rv)) {\n                /* Output everything prior to this bucket, and then\n                 * do a blocking read on the next batch.\n                 */\n                if (e != APR_BRIGADE_FIRST(b)) {\n                    apr_bucket_brigade *split = apr_brigade_split(b, e);\n                    apr_bucket *flush =\napr_bucket_flush_create(r->connection->bucket_alloc);\n\n                    APR_BRIGADE_INSERT_TAIL(b, flush);\n                    rv = ap_pass_brigade(f->next, b);\n                    if (rv != APR_SUCCESS || f->c->aborted) {\n                        apr_brigade_destroy(split);\n                        return rv;\n                    }\n                    b = split;\n                    e = APR_BRIGADE_FIRST(b);\n\n                    ctx->data_sent = 1;\n                }\n                eblock = APR_BLOCK_READ;\n                continue;\n            }\n            else {\n                ap_log_rerror(APLOG_MARK, APLOG_ERR, rv, r,\n                              \"ap_content_length_filter: \"\n                              \"apr_bucket_read() failed\");\n                return rv;\n            }\n        }\n        else {\n            r->bytes_sent += e->length;\n        }\n        e = APR_BUCKET_NEXT(e);\n    }\n\n", "id": 51736, "time": "2004-02-04T20:35:20Z", "bug_id": 23528, "creation_time": "2004-02-04T20:35:20Z", "is_private": false}, {"count": 12, "tags": [], "creator": "sorin.mocanu@intersol.ro", "attachment_id": null, "text": "\nRegarding the 2003-10-10 question from Jeff Trawick, I attached to the process\nusing strace and it shows \n\nwrite(2, \"Use of uninitialized value in co\"..., 126\n\nThat would be a warning printed by a Perl script that has a lot of undefined\nvariables embeded in strings and runs with -w. (Use of uninitialized value in\nconcatenation (.) or string at xxx.pl line YYY) Development server, duh :)\n\nAfter the 300 seconds I got from strace this:\n\n--- SIGPIPE (Broken pipe) @ 0 (0) ---\nwrite(2, \"Use of uninitialized value in co\"..., 126) = -1 EPIPE (Broken pipe)\n--- SIGPIPE (Broken pipe) @ 0 (0) ---\n--- SIGTERM (Terminated) @ 0 (0) ---\n\nRegards\nSorin Mocanu", "id": 54964, "time": "2004-03-31T14:39:57Z", "bug_id": 23528, "creation_time": "2004-03-31T14:39:57Z", "is_private": false}, {"count": 13, "tags": [], "creator": "trawick@apache.org", "is_private": false, "id": 54966, "attachment_id": null, "bug_id": 23528, "creation_time": "2004-03-31T14:57:04Z", "time": "2004-03-31T14:57:04Z", "text": "Sorin,\n\n>Regarding the 2003-10-10 question from Jeff Trawick, I attached \n>to the process using strace and it shows \n>\n>write(2, \"Use of uninitialized value in co\"..., 126\n\nThe script is hung writing to stderr.  You're suffering from PR 22030."}, {"count": 14, "tags": [], "text": "Looks like a possibly related bug #20866 may have been fixed in version 2.0.50.\nFolks should retry with that version.\n", "is_private": false, "id": 60565, "creator": "coad@measurement-factory.com", "time": "2004-07-13T19:40:01Z", "bug_id": 23528, "creation_time": "2004-07-13T19:40:01Z", "attachment_id": null}, {"count": 15, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "text": "To confirm whether this is related to stderr handling in mod_cgi please try to\nreproduce the problem using 2.0.50.", "id": 60569, "time": "2004-07-13T19:45:20Z", "bug_id": 23528, "creation_time": "2004-07-13T19:45:20Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 23528, "attachment_id": null, "text": "Let's presume this is bug 22030 and hence fixed in 2.0.50. lacking evidence to\nthe contrary.\n\n*** This bug has been marked as a duplicate of 22030 ***", "id": 62434, "time": "2004-08-24T20:41:20Z", "creator": "jorton@redhat.com", "creation_time": "2004-08-24T20:41:20Z", "is_private": false}, {"count": 17, "tags": [], "bug_id": 23528, "text": "I'm running a script on our intranet (apache_2.0.52-win32-x86-no_ssl,\nActivePerl-5.8.6.811-MSWin32-x86-122208) querying our MSSQL 2000 server, all\nrunning on a Win2K server, and I'm getting the same error:\n\n[Tue Aug 09 12:56:32 2005] [error] [client 10.0.0.110] (70007)The timeout\nspecified has expired: ap_content_length_filter: apr_bucket_read() failed,\nreferer: http://intranet/reports/order_me.pl\n\nIt normally takes about 5 seconds to run, if the results are small (less than 50\nrows as far as I've experienced.)  In that case, there is no error, and the page\nloads and completes just fine.  However, when I modify the script such that 1000\nrows are returned, it always hangs in the browser for five minutes (as the\noriginal poster described) after outputting about 41 kb of HTML.  It must be\nsome kind of buffer problem because it'll stop in mid-print-statement, like\nafter the '&nb' of an '&nbsp;' in an empty cell.  Worse than the original poster\ndescribed, however, is the fact that the results get cut short at that point and\nthe rest are never displayed.\n\nThanks,\nKev", "id": 78306, "time": "2005-08-09T19:54:16Z", "creator": "kev@brantaero.com", "creation_time": "2005-08-09T19:54:16Z", "is_private": false, "attachment_id": null}, {"count": 18, "tags": [], "text": "We're now on the latest, ActivePerl-5.8.7.813-MSWin32 and apache_2.0.54-win32,\nand still the exact same thing happens.\n\nI ran a test using a simple query that's fast and returns a lot of data.  It ran\nfine, returning 365 kb of data.\n\nHowever, I tested the other query (the one that's causing problems) using a\nquery analyzer, and it took 9 seconds (expected, it's complex) but not any 300\nseconds.\n\nI would guess it's timing out waiting for the query results and something\nstrange is happening that prevents it from getting the rest, because it starts\nreturning results after only 2 seconds, gives one burst of data, and that's it.\n\nIs nobody else still having things happen like this?  I see David Trusty\nreopened one of the ones this was supposedly a duplicate of as well.\n\nIf you need any more info from me just let me know.\n\nThanks,\nKev", "is_private": false, "id": 78839, "creator": "kev@brantaero.com", "time": "2005-08-22T22:00:09Z", "bug_id": 23528, "creation_time": "2005-08-22T22:00:09Z", "attachment_id": null}, {"count": 19, "tags": [], "bug_id": 23528, "text": "For now, anyway, Eric Pearce's suggestion works very well for me:\n\n'I changed the begining of the script from \"perl -w\" to \"perl -X\" and all\nproblems ceased...'\n\nThanks,\nKev", "id": 78842, "time": "2005-08-22T22:07:58Z", "creator": "kev@brantaero.com", "creation_time": "2005-08-22T22:07:58Z", "is_private": false, "attachment_id": null}, {"count": 20, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "text": "The only remaining bug here is that Win32 can't poll() across non-socket fds so\nmod_cgi's CGI bucket stuff can't be used on that platform.  This needs to be\nfixed at APR or somewhere below mod_cgi, marking WONTFIX until it is.  (perhaps\n\"CANTFIX\" is more appropriate)", "id": 81898, "time": "2005-10-28T17:35:31Z", "bug_id": 23528, "creation_time": "2005-10-28T17:35:31Z", "is_private": false}]