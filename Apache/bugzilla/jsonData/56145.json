[{"count": 0, "tags": [], "creator": "joffroy.christen@solvaxis.com", "attachment_id": null, "id": 173069, "time": "2014-02-17T11:07:46Z", "bug_id": 56145, "creation_time": "2014-02-17T11:07:46Z", "is_private": false, "text": "Child process (mod_proxy_ws_tunnel worker) go in infinite loop / 100% CPU core usage when browser websocket connection is baldly closed.\n\nmod_proxy_ws_tunnel is configured to proxy websockets:\n\nbrowser <----conn_client----> apache/mod_proxy_ws_tunnel <----conn_server----> app\n\nIf browser or app close properly the connection, there is no problem (worker stop).\n\nIf app is killed or conn_server is lost, mod_proxy_ws_tunnel worker stop as expected.\n\nIf browser is killed or conn_client is lost, mod_proxy_ws_tunnel worker enter in infinite loop, 100% CPU core usage, and gigabytes log generation ([proxy_wstunnel:debug] AH02445: woke from poll(), i=1).\n\n\nmod_proxy_wstunnel.c\nMethod proxy_wstunnel_pump (ap_proxy_wstunnel_request for 2.4.x)\n\n\n    while(1) { \n        if ((rv = apr_pollset_poll(pollset, timeout, &pollcnt, &signalled))\n                != APR_SUCCESS) {\n            if (APR_STATUS_IS_EINTR(rv)) {\n                continue;\n            }\n            else if (APR_STATUS_IS_TIMEUP(rv)) { \n                ap_log_rerror(APLOG_MARK, APLOG_DEBUG, 0, r, APLOGNO(02542) \"Attempting to go asynch\");\n                return SUSPENDED;\n            }\n            else { \n                ap_log_rerror(APLOG_MARK, APLOG_ERR, rv, r, APLOGNO(02444) \"error apr_poll()\");\n                return HTTP_INTERNAL_SERVER_ERROR;\n            }\n        }\n\n        ap_log_rerror(APLOG_MARK, APLOG_DEBUG, 0, r, APLOGNO(02445)\n                \"woke from poll(), i=%d\", pollcnt);\n\n        for (pi = 0; pi < pollcnt; pi++) {\n            const apr_pollfd_t *cur = &signalled[pi];\n\n            if (cur->desc.s == sock) {\n                pollevent = cur->rtnevents;\n                if (pollevent & APR_POLLIN) {\n                    ap_log_rerror(APLOG_MARK, APLOG_DEBUG, 0, r, APLOGNO(02446)\n                            \"sock was readable\");\n                    rv = proxy_wstunnel_transfer(r, backconn, c, bb, \"sock\");\n                }\n                else if ((pollevent & APR_POLLERR)\n                        || (pollevent & APR_POLLHUP)) {\n                    rv = APR_EPIPE;\n                    ap_log_rerror(APLOG_MARK, APLOG_NOTICE, 0, r, APLOGNO(02447)\n                            \"err/hup on backconn\");\n                }\n                if (rv != APR_SUCCESS)\n                    client_error = 1;\n            }\n            else if (cur->desc.s == client_socket) {\n                pollevent = cur->rtnevents;\n                if (pollevent & APR_POLLIN) {\n                    ap_log_rerror(APLOG_MARK, APLOG_DEBUG, 0, r, APLOGNO(02448)\n                            \"client was readable\");\n                    rv = proxy_wstunnel_transfer(r, c, backconn, bb, \"client\");\n                }\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\nThere is no \"else if ((pollevent & APR_POLLERR) || (pollevent & APR_POLLHUP))\"\nShouldn't be there one?\nCopied-pasted above \"else if\", compiled, tested and worked fine.\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n            }\n            else {\n                rv = APR_EBADF;\n                ap_log_rerror(APLOG_MARK, APLOG_INFO, 0, r, APLOGNO(02449)\n                        \"unknown socket in pollset\");\n            }\n\n        }\n        if (rv != APR_SUCCESS) {\n            break;\n        }\n\n    }"}, {"count": 1, "tags": [], "bug_id": 56145, "attachment_id": null, "text": "I've detected the issue in 2.4.7, then tested and noticed the same issue in 2.4.x (2.4.8) and 2.x (2.5).", "id": 173305, "time": "2014-02-17T16:38:04Z", "creator": "joffroy.christen@solvaxis.com", "creation_time": "2014-02-17T16:38:04Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 56145, "attachment_id": null, "id": 173330, "time": "2014-02-18T14:10:40Z", "creator": "covener@gmail.com", "creation_time": "2014-02-18T14:10:40Z", "is_private": false, "text": "(In reply to Jo from comment #1)\n> I've detected the issue in 2.4.7, then tested and noticed the same issue in\n> 2.4.x (2.4.8) and 2.x (2.5).\n\nThanks for the report/analysis/patch.  In my system I could not easily trigger the symptom, even when I killed the client it became readable and was handled by the normal read.\n\nCan you re-test this patch since your env hits it more easily?\n\nhttp://people.apache.org/~covener/patches/trunk-ws-disconnect.diff"}, {"count": 3, "attachment_id": null, "creator": "joffroy.christen@solvaxis.com", "is_private": false, "id": 173338, "time": "2014-02-18T16:50:20Z", "bug_id": 56145, "creation_time": "2014-02-18T16:50:20Z", "tags": [], "text": "(In reply to Eric Covener from comment #2)\n> \n> Thanks for the report/analysis/patch.  In my system I could not easily\n> trigger the symptom, even when I killed the client it became readable and\n> was handled by the normal read.\n> \n> Can you re-test this patch since your env hits it more easily?\n> \n> http://people.apache.org/~covener/patches/trunk-ws-disconnect.diff\n\nI'd to replace APLOGNO() by APLOGNO(02453) to compile it.\n\nI've successfully tested it on 2.4.8-dev and 2.5-dev. Thanks.\n\nOn app killed, it logs \"AH02447: err/hup on backconn\" as before.\nOn browser killed, it logs \"AH02447: err/hup on client conn\" as expected now.\n\nI never had \"unknown event on backconn\" nor \"unknown event on client conn\", but I just made a few tests."}, {"count": 4, "attachment_id": null, "bug_id": 56145, "is_private": false, "id": 173988, "time": "2014-03-21T08:07:12Z", "creator": "martin.studer@mirai-solutions.com", "creation_time": "2014-03-21T08:07:12Z", "tags": [], "text": "We're currently using Apache 2.4.9 on Win64 which seems to solve the \"infinite loop on websocket connection loss\" problem for us. However, what we are seeing now is entries like\n\n[Fri Mar 21 08:00:10.405224 2014] [proxy_wstunnel:notice] [pid 19932:tid 836] [client 172.29.184.113:53972] AH02447: err/hup on backconn\n[Fri Mar 21 08:00:42.229688 2014] [proxy_wstunnel:notice] [pid 19932:tid 788] [client 172.29.184.113:53982] AH02447: err/hup on backconn\n[Fri Mar 21 08:05:08.604172 2014] [proxy_wstunnel:notice] [pid 19932:tid 840] [client 172.29.184.113:54199] AH02447: err/hup on backconn\n[Fri Mar 21 08:05:16.780267 2014] [proxy_wstunnel:notice] [pid 19932:tid 772] [client 172.29.184.113:54210] AH02447: err/hup on backconn\n[Fri Mar 21 08:05:21.724793 2014] [proxy_wstunnel:notice] [pid 19932:tid 768] [client 172.29.184.113:54216] AH02447: err/hup on backconn\n[Fri Mar 21 08:18:26.592849 2014] [proxy_wstunnel:notice] [pid 19932:tid 788] [client 172.29.184.113:54414] AH02447: err/hup on backconn\n[Fri Mar 21 08:18:26.595779 2014] [proxy_wstunnel:notice] [pid 19932:tid 764] [client 172.29.184.113:54413] AH02447: err/hup on backconn\n[Fri Mar 21 08:26:53.173822 2014] [proxy_wstunnel:notice] [pid 19932:tid 764] [client 172.29.184.113:54463] AH02447: err/hup on backconn\n[Fri Mar 21 08:40:58.011922 2014] [proxy_wstunnel:notice] [pid 19932:tid 840] [client 172.29.184.113:60997] AH02447: err/hup on backconn\n[Fri Mar 21 08:40:58.011922 2014] [proxy_wstunnel:notice] [pid 19932:tid 772] [client 172.29.184.113:60998] AH02447: err/hup on backconn\n\nWe can't find any indication so far that there would be a problem with the websocket server (Play/Netty). So it looks like this might be an issue with mod_proxy_ws_tunnel?"}, {"count": 5, "tags": [], "bug_id": 56145, "attachment_id": null, "id": 173989, "time": "2014-03-21T09:19:37Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-03-21T09:19:37Z", "is_private": false, "text": "(In reply to Martin Studer from comment #4)\n> We're currently using Apache 2.4.9 on Win64 which seems to solve the\n> \"infinite loop on websocket connection loss\" problem for us. However, what\n> we are seeing now is entries like\n\nPlease open a new bug report so that it can be referenced independently."}]