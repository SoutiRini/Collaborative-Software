[{"count": 0, "tags": [], "text": "Problem:          \n           \nAdding error-page directive to web.xml have no affect to tomcat error          \nreporting.          \n            \nTestCase:             \n            \n1. getting working copy of jakarta-tomcat-5.0.2 \n3. go to webapps/ROOT/WEB-INF            \n4. add following to web.xml            \n            \n     <error-page>            \n      <error-code>404</error-code>            \n      <location>/404.html</location>            \n     </error-page>            \n           \n5. create a file webapps/ROOT/404.html with some content           \n6. start tomcat           \n7. access http://localhost:8080/NotExistingFile.html           \n8. getting error report from ErrorReportValve, and not /404.html    \n                \nBreakdown:         \n         \n1. Getting tomcat to print debug stuff ( especially DefaultServlet/Jasper )         \n2. Seeing in source code, that ErrorDispatcherValve calls  \nRequestDispatcher.forward         \nwith location of error-page         \n4. But see, that jasper/defaultservlet trying to getting origin location,not  \nthe location of error-page        \n5. Looking in ApplicationDispatcher, see that uri is changed without affect         \nfor error-pages, because processRequest using unaltered request for errors       \n        \n   \nPossibly broken, but working small ( WORKSFORME!) fix:     \n      \nIndex: ApplicationDispatcher.java            \n===================================================================            \nRCS file:            \n/home/cvspublic/jakarta-tomcat-catalina/catalina/src/share/org/apache/catalina/core/ApplicationDispatcher.java,v            \nretrieving revision 1.16            \ndiff -u -r1.16 ApplicationDispatcher.java            \n--- ApplicationDispatcher.java  17 Apr 2003 15:31:45 -0000      1.16            \n+++ ApplicationDispatcher.java  18 May 2003 12:04:59 -0000            \n@@ -449,7 +449,7 @@            \n                 wrequest.setQueryParams(queryString);            \n             }            \n            \n-            processRequest(request,response);            \n+            processRequest(wrequest,response);            \n             unwrapRequest();            \n            \n         }", "attachment_id": null, "id": 37399, "creator": "tfohrer@t-online.de", "time": "2003-05-18T12:29:41Z", "bug_id": 20018, "creation_time": "2003-05-18T12:29:41Z", "is_private": false}, {"attachment_id": 6406, "tags": [], "creator": "tfohrer@t-online.de", "text": "Created attachment 6406\nROOT context with error-page for http status 404", "count": 1, "id": 37400, "time": "2003-05-18T12:32:35Z", "bug_id": 20018, "creation_time": "2003-05-18T12:32:35Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "remm@apache.org", "text": "Ok, I can reproduce that. However:\n- your patch looks suspicious (and doesn't fix the problem for me)\n- the line numbers are bad (they don't match Tomcat 5.0.2 code)", "count": 2, "id": 37402, "time": "2003-05-18T14:59:51Z", "bug_id": 20018, "creation_time": "2003-05-18T14:59:51Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "remm@apache.org", "text": "BTW, I forgot to mention it, but the cause of this is likely the same causing\nthe proposed change to FORM (using forward instead of a redirect). So it seems\nthe \"bug\" is that you can't forward from outside the filter pipeline (which in\nsome ways makes sense; I think we've abused that in TC 4). Likely the issue is\nthat the filter pipeline will get constructed bad.\n\nI'm wondering if it's valid to directly invoke the servlet wrapper (faster +\ncleaner + easier), or if we have to do it like a real forward, and invoke the\nfilters mapped with forward. Spec people, any opinions ?\n\nIf you want an easy workaround, replace the forward with a sendRedirect.", "count": 3, "id": 37403, "time": "2003-05-18T15:06:29Z", "bug_id": 20018, "creation_time": "2003-05-18T15:06:29Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 20018, "text": "diff is against cvs version, sorry ", "id": 37405, "time": "2003-05-18T15:20:12Z", "creator": "tfohrer@t-online.de", "creation_time": "2003-05-18T15:20:12Z", "is_private": false, "attachment_id": null}, {"attachment_id": 6407, "tags": [], "creator": "tfohrer@t-online.de", "text": "Created attachment 6407\nPatched Version of ApplicationDispatcher", "count": 5, "id": 37407, "time": "2003-05-18T15:25:14Z", "bug_id": 20018, "creation_time": "2003-05-18T15:25:14Z", "is_private": false}, {"count": 6, "tags": [], "text": "I know which line you wanted to patch (it was sort of obvious ...), however:\n- It does not do what it's supposed to do (and it also breaks forwarding in general)\n- the ApplicationDispatcher in 5.0.2 is identical to the revision in HEAD\n(version 1.16)\n\nSo this bug is valid, but the patch is bad.", "attachment_id": null, "id": 37410, "creator": "remm@apache.org", "time": "2003-05-18T15:34:25Z", "bug_id": 20018, "creation_time": "2003-05-18T15:34:25Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 20018, "text": "Ok, i need error-pages for a project, which part of forwarding my patch break? \n \nand how can i resolve it? \n \n ", "id": 37411, "time": "2003-05-18T15:40:13Z", "creator": "tfohrer@t-online.de", "creation_time": "2003-05-18T15:40:13Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 20018, "text": "I dissagree with the patch. That will break agains the filter dispatcher\nmechanims whend <DISPATCHER> ERROR </DISPATCHER> is used (this part of the code\nreally needs to be reworked). A workaround for is to use the following patch,\nwhich I don't like but make the mechanism working:\n\n===================================================================\nRCS file:\n/home/cvs/jakarta-tomcat-catalina/catalina/src/share/org/apache/catalina/valves/ErrorDispatcherValve.java,v\nretrieving revision 1.6\ndiff -u -r1.6 ErrorDispatcherValve.java\n--- ErrorDispatcherValve.java   22 Feb 2003 14:56:35 -0000      1.6\n+++ ErrorDispatcherValve.java   19 May 2003 16:06:03 -0000\n@@ -327,6 +327,10 @@\n                                        errorPage.getLocation());\n             sreq.setAttribute(ApplicationFilterFactory.DISPATCHER_TYPE_ATTR,\n                                                  new\nInteger(ApplicationFilterFactory.ERROR));\n+\n+           ((HttpRequest) request).setPathInfo(errorPage.getLocation());\n+\n+\n             Wrapper wrapper = request.getWrapper();\n             if (wrapper != null)\n                 sreq.setAttribute(Globals.SERVLET_NAME_ATTR,\n\n-- Jeanfrancois\n", "id": 37439, "time": "2003-05-19T16:10:02Z", "creator": "jfarcand@apache.org", "creation_time": "2003-05-19T16:10:02Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 20018, "attachment_id": null, "id": 37479, "time": "2003-05-20T14:29:35Z", "creator": "jfarcand@apache.org", "creation_time": "2003-05-20T14:29:35Z", "is_private": false, "text": "Fixed. "}, {"attachment_id": null, "tags": [], "creator": "phuang@capitolix.com", "text": "When I try to redirect to a custom error page (allerrors.jsp) I get the\nfollowing in the logs:\n\n2003-10-09 13:50:53 org.apache.catalina.core.StandardHostValve@1ff5c98:\nException Processing ErrorPage[errorCode=404, location=/allerrors.jsp]\njava.lang.IllegalStateException: getOutputStream() has already been called for\nthis response", "count": 10, "id": 45318, "time": "2003-10-09T21:06:37Z", "bug_id": 20018, "creation_time": "2003-10-09T21:06:37Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 20018, "attachment_id": null, "id": 45319, "time": "2003-10-09T21:09:40Z", "creator": "remm@apache.org", "creation_time": "2003-10-09T21:09:40Z", "is_private": false, "text": "Please post that kind of question on tomcat-user.\nIf you used the output stream in a servlet, you cannot use the writer later\n(that means you can't use a JSP error page)."}]