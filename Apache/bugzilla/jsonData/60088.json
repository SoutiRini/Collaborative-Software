[{"count": 0, "tags": [], "bug_id": 60088, "attachment_id": null, "text": "httpd.conf:\n\nExtFilterDefine MyInFilter mode=input cmd=\"/path/to/filters/request_filter.php\"\n<Location \"/mywebapplication-url\">\n    setInputFilter MyInFilter\n    ExtFilterOptions LogStderr\n    LimitRequestBody 0\n</Location>\n\n\nMy filter code:\n\n#!/usr/bin/php\n<?php\n\n     function processFilter() {\n\n         $stdin = file_get_contents('php://stdin');\n         if (empty($stdin)) {\n            error_log(\"empty request\");\n            return $stdin;\n         }\n\n         // do filter work here, do nothing for test\n\n         return $stdin;\n    }\n\n    error_log(\"Filter starts\");\n\n    $before = microtime(true);\n    print(processFilter());\n    $after = microtime(true);\n\n    error_log(\"Filter needs: \" . ($after-$before) .\" s\");\n?>\n\nIf I post a request with data larger than 8192 bytes, my filter won't be called and the request dies with an error:\n\n[Tue Sep 06 09:58:09.470309 2016] [ext_filter:trace1] [pid 15343] mod_ext_filter.c(629): [client 192.168.50.26:46497] filtering `/an-URL' of type `(unspecified)' through `/path/to/filters/request_filter.php', cfg ExtFilterOptions LogStderr !PreserveContentLength ExtFilterInType application/x-www-form-urlencoded ExtFilterOuttype (unchanged), referer: https://another-URL\n\n[Tue Sep 06 09:58:09.470399 2016] [ext_filter:trace6] [pid 15343] mod_ext_filter.c(807): (11)Resource temporarily unavailable: [client 192.168.50.26:46497] AH01466: apr_file_read(child output), len 18446744073709551615, referer: https://another-URL\n\n[Tue Sep 06 09:58:09.470441 2016] [:error] [pid 15343] Sending error response: The request contained fewer content data than specified by the content-length header\n\nI have recompiled the mod_ext_filter.c with a lot of log output and I found a discrepancy in ef_unified_filter(), where the apr_bucket_read() gets only 8192 bytes, but the ef_input_filter() reads just before i.e. 9827 bytes from the current brigade. \nThere is only one bucket within the brigade and the for-loop in ef_unified_filter() runs therefore only once. The result is the different content length from the error message, but at the moment I cannot find a solution for that.\n\nIt is not a PHP-specific problem, I have tested it with a Bash-script filter too. Also I have tested w/o LimitRequestBody.", "id": 193516, "time": "2016-09-06T13:49:11Z", "creator": "andre.rothe@phosco.info", "creation_time": "2016-09-06T13:49:11Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 60088, "attachment_id": null, "text": "I have checked the problem on 2.4.20 and it is still present. In the /var/log/audit/audit.log I can see:\n\ntype=ANOM_ABEND msg=audit(1473319986.976:46188): auid=4294967295 uid=48 gid=48 ses=4294967295 subj=system_u:system_r:httpd_t:s0 pid=15702 comm=\"httpd\" reason=\"memory violation\" sig=11\n\njust after processing the request.", "id": 193564, "time": "2016-09-08T08:06:12Z", "creator": "andre.rothe@phosco.info", "creation_time": "2016-09-08T08:06:12Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 60088, "attachment_id": null, "text": "Can you retest with 2.4.25?  I can't reproduce the error here from that config/filter combination.", "id": 197079, "time": "2017-02-16T17:46:44Z", "creator": "jorton@redhat.com", "creation_time": "2017-02-16T17:46:44Z", "is_private": false}]