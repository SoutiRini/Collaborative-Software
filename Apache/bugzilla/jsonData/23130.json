[{"count": 0, "attachment_id": null, "creator": "bjorn@exoweb.net", "is_private": false, "id": 44098, "time": "2003-09-12T09:41:50Z", "bug_id": 23130, "creation_time": "2003-09-12T09:41:50Z", "tags": [], "text": "[ Also reported for Apache 1.3.28 as BUG# 23129 ]\n\nThis bug was first reported by James Cooper in 1999 \n(http://archive.apache.org/gnats/4089), but was somehow never included.\n\nSearching the web it is obvious that many people have found this bug through \nthe years, but none (except James) have reported it.  Instead, it's \nbecome \"common knowledge\" that for mod_proxy in Apache to cache content, it has \nto have a Last-Modified header.  Just having an Expires header is not enough; \nit will always result in a X-Cache: MISS\n\nLast-Modified headers do not really make sense for dynamic content, so many \nHTTP Accelerator plugins for dynamic websites only generate Expires headers, \nassuming that it'll work fine, when it doesn't.\n\nThis patch should fix this deficiency for 2.0.47 (not heavily tested):\n\n*** mod_cache.c-org\tFri Sep 12 15:44:36 2003\n--- mod_cache.c\tFri Sep 12 15:44:41 2003\n***************\n*** 540,553 ****\n          reason = \"HTTP Status 304 Not Modified\";\n      }\n      else if (r->status == HTTP_OK && lastmods == NULL && etag == NULL \n               && (conf->no_last_mod_ignore ==0)) {\n!         /* 200 OK response from HTTP/1.0 and up without a Last-Modified\n!          * header/Etag \n           */\n          /* XXX mod-include clears last_modified/expires/etags - this\n           * is why we have an optional function for a key-gen ;-) \n           */\n!         reason = \"No Last-Modified or Etag header\";\n      }\n      else if (r->header_only) {\n          /* HEAD requests */\n--- 540,554 ----\n          reason = \"HTTP Status 304 Not Modified\";\n      }\n      else if (r->status == HTTP_OK && lastmods == NULL && etag == NULL \n+              && (exps == NULL || exp == APR_DATE_BAD)\n               && (conf->no_last_mod_ignore ==0)) {\n!         /* 200 OK response from HTTP/1.0 and up without a Last-Modified,\n!          * Expires, or Etag  header\n           */\n          /* XXX mod-include clears last_modified/expires/etags - this\n           * is why we have an optional function for a key-gen ;-) \n           */\n!         reason = \"No Last-Modified, Expires, or Etag header\";\n      }\n      else if (r->header_only) {\n          /* HEAD requests */"}, {"count": 1, "tags": [], "text": "I just committed a fix based on your patch to the 2.1-dev branch. I have\nsubmitted it for backporting to the 2.0-stable tree. Thank you for your\nsubmission and for using Apache. One request, could you use unified diff format\nin the future for any patches (diff -u). It is the standard format that we all\nuse. Thanks.", "attachment_id": null, "bug_id": 23130, "id": 44130, "time": "2003-09-12T19:57:51Z", "creator": "rederpj@remulak.net", "creation_time": "2003-09-12T19:57:51Z", "is_private": false}]