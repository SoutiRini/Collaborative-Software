[{"count": 0, "tags": [], "bug_id": 52557, "text": "Hi,\n\nwe have some weird issues since we tried to switch from tomcat 6.0.32 to 6.0.35.\nWe're using authentication with DIGEST and we saw a big rewrite in 6.0.33 and the\nrewrite was necessary (like said in the changelog) because of the DIGEST didn't\nreally worked.\n\nWhen we're trying to enable 6.0.35 there are some clients haven't any problem and\nsome clients have periodical issues (20 to 80% fails, depending on client or\nlocation, so locally accessed or via the network). \"curl\" is one of them and so maybe most\nof the clients using libcurl or whatever.\n\nBecause of the fact that as quicker the requests will be send (while loop) the more errors\noccur so maybe a time issue (timestamp in the nonce maybe?).\n\n\nSystem in use:\n\n  production systems:\n    Server side:\n     - JAVA:\n        java -version\n        java version \"1.6.0_24\"\n        Java(TM) SE Runtime Environment (build 1.6.0_24-b07)\n        Java HotSpot(TM) Server VM (build 19.1-b02, mixed mode)\n     - Kernel:\n        2.6.35 (self compiled)\n\n    Client side (for curl tests):\n     - same like on server (test worked also on server side with using localhost)\n\n  local system for testing with vanilla stuff:\n     - JAVA:\n        java -version\n        java version \"1.6.0_26\"\n        Java(TM) SE Runtime Environment (build 1.6.0_26-b03)\n        Java HotSpot(TM) 64-Bit Server VM (build 20.1-b02, mixed mode)\n     - Kernel:\n        3.1.0-1-amd64 (Debian Testing)\n\n\n\nWhat we see:\n\n  curl to an DIGEST authentication secured page gives normal 401 response with\n  WWW-Authenticate in it and the second request gives a 200 OK. But the directly\n  next request fails with a 401 also on the second response.\n\nHow to reproduce:\n\n  Download the tomcat 6.0.35 package from\n  http://archive.apache.org/dist/tomcat/tomcat-6/v6.0.35/src/apache-tomcat-6.0.35-src.tar.gz\n  and extract it to somewhere.\n  Use the patches below to enable DIGEST for the http://localhost:8080/manager/html site\n  and execute multiple times (in a while loop maybe with a sleep of 0.2):\n\n  curl localhost:8080/manager/html -v --digest -u test:test 2>&1 > /dev/null\n\n  When i test it with:\n\n  while :; do echo \"ccccc\"; curl localhost:8080/manager/html -v --digest -u test:test 2>&1 > /dev/null  |egrep \"(HTTP|Auth)\"| grep 200; sleep 1; done\n\n  there are no errors but with\n\n  while :; do echo \"ccccc\"; curl localhost:8080/manager/html -v --digest -u test:test 2>&1 > /dev/null  |egrep \"(HTTP|Auth)\"| grep 200; sleep 0.5; done\n\n  there are sometimes errors and with a sleep of 0.1 there are many many errors.\n\n################################ PATCHES ##################################\n\n=============================================\nseffenberg@siteop-25:~/tomcat/apache-tomcat-6.0.35-src$ diff -u conf/server.xml output/build/conf/server.xml\n--- conf/server.xml     2011-11-28 11:22:44.000000000 +0100\n+++ output/build/conf/server.xml        2012-01-26 14:05:25.000000000 +0100\n@@ -120,7 +120,8 @@\n            that are performed against this UserDatabase are immediately\n            available for use by the Realm.  -->\n       <Realm className=\"org.apache.catalina.realm.UserDatabaseRealm\"\n-             resourceName=\"UserDatabase\"/>\n+             resourceName=\"UserDatabase\"\n+             digest=\"MD5\" />\n \n       <!-- Define the default virtual host\n            Note: XML Schema validation will not work with Xerces 2.2.\n=============================================\nseffenberg@siteop-25:~/tomcat/apache-tomcat-6.0.35-src$ diff -u conf/tomcat-users.xml output/build/conf/tomcat-users.xml\n--- conf/tomcat-users.xml       2011-11-28 11:22:44.000000000 +0100\n+++ output/build/conf/tomcat-users.xml  2012-01-26 14:06:12.000000000 +0100\n@@ -26,6 +26,8 @@\n   and thus are ignored when reading this file. Do not forget to remove\n   <!.. ..> that surrounds them.\n -->\n+  <role rolename=\"manager\"/>\n+  <user username=\"test\" password=\"8d6db5856fdcd4d166914bfda9ffda86\" roles=\"manager\"/>\n <!--\n   <role rolename=\"tomcat\"/>\n   <role rolename=\"role1\"/>\n=============================================\nseffenberg@siteop-25:~/tomcat/apache-tomcat-6.0.35-src$ diff -u webapps/manager/WEB-INF/web.xml output/build/webapps/manager/WEB-INF/web.xml\n--- webapps/manager/WEB-INF/web.xml     2011-11-28 11:22:46.000000000 +0100\n+++ output/build/webapps/manager/WEB-INF/web.xml        2012-01-26 14:06:01.000000000 +0100\n@@ -248,8 +248,8 @@\n \n   <!-- Define the Login Configuration for this Application -->\n   <login-config>\n-    <auth-method>BASIC</auth-method>\n-    <realm-name>Tomcat Manager Application</realm-name>\n+    <auth-method>DIGEST</auth-method>\n+    <realm-name>Tomcat Manager Application TEST</realm-name>\n   </login-config>\n \n   <!-- Security roles referenced by this web application -->\n@@ -284,6 +284,7 @@\n     <role-name>manager</role-name>\n   </security-role>\n \n+<!--\n   <error-page>\n     <error-code>401</error-code>\n     <location>/401.jsp</location>\n@@ -292,5 +293,5 @@\n     <error-code>403</error-code>\n     <location>/403.jsp</location>\n   </error-page>\n-\n+-->\n </web-app>\n=============================================\n\n################################ HOW THE PASSWORD STUFF WAS GENERATED ##################################\n\n$ ./bin/digest.sh -a MD5 \"test:Tomcat Manager Application TEST:test\"\ntest:Tomcat Manager Application TEST:test:8d6db5856fdcd4d166914bfda9ffda86\n\n\n################################ EXAMPLE OUTPUT ##################################\n\n############# First run ###########\nseffenberg@siteop-25:~/tomcat/apache-tomcat-6.0.35-src$ curl localhost:8080/manager/html -v --digest -u test:test 2>&1 > /dev/null\n* About to connect() to localhost port 8080 (#0)\n*   Trying ::1...   % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0connected\n* Server auth using Digest with user 'test'\n> GET /manager/html HTTP/1.1\n> User-Agent: curl/7.23.1 (x86_64-pc-linux-gnu) libcurl/7.23.1 OpenSSL/1.0.0g zlib/1.2.3.4 libidn/1.23 libssh2/1.2.8 librtmp/2.3\n> Host: localhost:8080\n> Accept: */*\n>\n* additional stuff not fine transfer.c:1036: 0 0\n* HTTP 1.1 or later with persistent connection, pipelining supported\n< HTTP/1.1 401 Unauthorized\n< Server: Apache-Coyote/1.1\n< Pragma: No-cache\n< Cache-Control: no-cache\n< Expires: Thu, 01 Jan 1970 01:00:00 CET\n< WWW-Authenticate: Digest realm=\"Tomcat Manager Application TEST\", qop=\"auth\", nonce=\"1327583459726:bbe144d54df7614e8c6bcf0a42bc1a5c\", opaque=\"1E5BE98D669D910CFC2C975F9B1EDB30\"\n< Content-Type: text/html;charset=utf-8\n< Content-Length: 954\n< Date: Thu, 26 Jan 2012 13:10:59 GMT\n<\n* Ignoring the response-body\n{ [data not shown]\n100   954  100   954    0     0   310k      0 --:--:-- --:--:-- --:--:--  465k\n* Connection #0 to host localhost left intact\n* Issue another request to this URL: 'HTTP://localhost:8080/manager/html'\n* Re-using existing connection! (#0) with host localhost\n* Connected to localhost (::1) port 8080 (#0)\n* Server auth using Digest with user 'test'\n> GET /manager/html HTTP/1.1\n> Authorization: Digest username=\"test\", realm=\"Tomcat Manager Application TEST\", nonce=\"1327583459726:bbe144d54df7614e8c6bcf0a42bc1a5c\", uri=\"/manager/html\", cnonce=\"Mjc3NDU2\", nc=00000001, qop=\"auth\", response=\"eb67cc859946b8c5ad37222be0cd8ab4\", opaque=\"1E5BE98D669D910CFC2C975F9B1EDB30\"\n> User-Agent: curl/7.23.1 (x86_64-pc-linux-gnu) libcurl/7.23.1 OpenSSL/1.0.0g zlib/1.2.3.4 libidn/1.23 libssh2/1.2.8 librtmp/2.3\n> Host: localhost:8080\n> Accept: */*\n>\n* additional stuff not fine transfer.c:1036: 0 0\n* HTTP 1.1 or later with persistent connection, pipelining supported\n< HTTP/1.1 200 OK\n< Server: Apache-Coyote/1.1\n< Pragma: No-cache\n< Cache-Control: no-cache\n< Expires: Thu, 01 Jan 1970 01:00:00 CET\n< Set-Cookie: JSESSIONID=F04781AE79D6D5F4B8F4C989E1B53F74; Path=/manager; HttpOnly\n< Content-Type: text/html;charset=utf-8\n< Transfer-Encoding: chunked\n< Date: Thu, 26 Jan 2012 13:10:59 GMT\n<\n{ [data not shown]\n1661   954  1661 15851    0     0  1802k      0 --:--:-- --:--:-- --:--:-- 1802k\n* Connection #0 to host localhost left intact\n* Closing connection #0\n\n\n\n\n\n############# Second run directly after the first one ##########\nseffenberg@siteop-25:~/tomcat/apache-tomcat-6.0.35-src$ curl localhost:8080/manager/html -v --digest -u test:test 2>&1 > /dev/null\n* About to connect() to localhost port 8080 (#0)\n*   Trying ::1...   % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0connected\n* Server auth using Digest with user 'test'\n> GET /manager/html HTTP/1.1\n> User-Agent: curl/7.23.1 (x86_64-pc-linux-gnu) libcurl/7.23.1 OpenSSL/1.0.0g zlib/1.2.3.4 libidn/1.23 libssh2/1.2.8 librtmp/2.3\n> Host: localhost:8080\n> Accept: */*\n>\n* HTTP 1.1 or later with persistent connection, pipelining supported\n< HTTP/1.1 401 Unauthorized\n< Server: Apache-Coyote/1.1\n< Pragma: No-cache\n< Cache-Control: no-cache\n< Expires: Thu, 01 Jan 1970 01:00:00 CET\n< WWW-Authenticate: Digest realm=\"Tomcat Manager Application TEST\", qop=\"auth\", nonce=\"1327583498775:abca97e062fa1078996f30ecd5702b4b\", opaque=\"1E5BE98D669D910CFC2C975F9B1EDB30\"\n< Content-Type: text/html;charset=utf-8\n< Content-Length: 954\n< Date: Thu, 26 Jan 2012 13:11:38 GMT\n<\n* Ignoring the response-body\n{ [data not shown]\n100   954  100   954    0     0   416k      0 --:--:-- --:--:-- --:--:--  931k\n* Connection #0 to host localhost left intact\n* Issue another request to this URL: 'HTTP://localhost:8080/manager/html'\n* Re-using existing connection! (#0) with host localhost\n* Connected to localhost (::1) port 8080 (#0)\n* Server auth using Digest with user 'test'\n> GET /manager/html HTTP/1.1\n> Authorization: Digest username=\"test\", realm=\"Tomcat Manager Application TEST\", nonce=\"1327583498775:abca97e062fa1078996f30ecd5702b4b\", uri=\"/manager/html\", cnonce=\"Mjc3NDk1\", nc=00000001, qop=\"auth\", response=\"62e4ddfadda157b2f4460431ebaa4e20\", opaque=\"1E5BE98D669D910CFC2C975F9B1EDB30\"\n> User-Agent: curl/7.23.1 (x86_64-pc-linux-gnu) libcurl/7.23.1 OpenSSL/1.0.0g zlib/1.2.3.4 libidn/1.23 libssh2/1.2.8 librtmp/2.3\n> Host: localhost:8080\n> Accept: */*\n>\n* HTTP 1.1 or later with persistent connection, pipelining supported\n< HTTP/1.1 401 Unauthorized\n< Server: Apache-Coyote/1.1\n< Pragma: No-cache\n< Cache-Control: no-cache\n< Expires: Thu, 01 Jan 1970 01:00:00 CET\n* Authentication problem. Ignoring this.\n< WWW-Authenticate: Digest realm=\"Tomcat Manager Application TEST\", qop=\"auth\", nonce=\"1327583498776:6eccf77a482bee58433632f82e8ba695\", opaque=\"1E5BE98D669D910CFC2C975F9B1EDB30\"\n< Content-Type: text/html;charset=utf-8\n< Content-Length: 954\n< Date: Thu, 26 Jan 2012 13:11:38 GMT\n<\n{ [data not shown]\n100   954  100   954    0     0   267k      0 --:--:-- --:--:-- --:--:--  267k\n* Connection #0 to host localhost left intact\n* Closing connection #0", "id": 153276, "time": "2012-01-30T09:50:01Z", "creator": "savar@schuldeigen.de", "creation_time": "2012-01-30T09:50:01Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "text": "Created attachment 28224\npatch for tomcat-users\n\nto test the issue this is one of three patches", "attachment_id": 28224, "id": 153278, "creator": "savar@schuldeigen.de", "time": "2012-01-30T09:55:24Z", "bug_id": 52557, "creation_time": "2012-01-30T09:55:24Z", "is_private": false}, {"count": 2, "tags": [], "creator": "savar@schuldeigen.de", "attachment_id": 28225, "text": "Created attachment 28225\npatch for server.xml\n\nto test the issue this is one of three patches", "id": 153279, "time": "2012-01-30T09:55:46Z", "bug_id": 52557, "creation_time": "2012-01-30T09:55:46Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 52557, "text": "Created attachment 28226\npatch for web.xml\n\nto test the issue this is one of three patches", "id": 153280, "time": "2012-01-30T09:56:12Z", "creator": "savar@schuldeigen.de", "creation_time": "2012-01-30T09:56:12Z", "is_private": false, "attachment_id": 28226}, {"count": 4, "tags": [], "bug_id": 52557, "text": "Added the patches for testing as attachments to prevent line wrapping..", "id": 153281, "time": "2012-01-30T09:56:48Z", "creator": "savar@schuldeigen.de", "creation_time": "2012-01-30T09:56:48Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 52557, "text": "curl is re-using cnonce values without incrementing the nonce-count as required by RFC2617. You can see this with the following access log configuration:\n\n<Valve className=\"org.apache.catalina.valves.AccessLogValve\"\n       directory=\"logs\"\n       prefix=\"localhost_access_log.\" suffix=\".txt\"\n       pattern=\"%h %l %u %t &quot;%r&quot; %s %b %{authorization}i\" />\n\nSince this appears to be a replay attack, Tomcat correctly rejects the requests.\n\nIt looks like curl changes the cnonce every second but never changes the nonce count which is why you only see failures when the delay is less than one second and also why the percentage of failures increases as the loop gets tighter.\n\nThere is a bug here but it is in curl, not Tomcat.", "id": 153282, "time": "2012-01-30T10:29:17Z", "creator": "markt@apache.org", "creation_time": "2012-01-30T10:29:17Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "text": "Many thanks for the explanation. Ok it is not a curl bug also because in a while loop the curl never knows anything about the previous request but when i do something like this:\n\n\ncurl -v --digest -u test:test localhost:8080/manager/html localhost:8080/manager/html localhost:8080/manager/html localhost:8080/manager/html localhost:8080/manager/html localhost:8080/manager/html localhost:8080/manager/html localhost:8080/manager/html localhost:8080/manager/html localhost:8080/manager/html localhost:8080/manager/html localhost:8080/manager/html localhost:8080/manager/html localhost:8080/manager/html localhost:8080/manager/html localhost:8080/manager/html 2>&1 > /dev/null\n\nthen it works with an growing nc= value.. so i know where to search next!", "attachment_id": null, "id": 153305, "creator": "savar@schuldeigen.de", "time": "2012-01-30T16:09:46Z", "bug_id": 52557, "creation_time": "2012-01-30T16:09:46Z", "is_private": false}]