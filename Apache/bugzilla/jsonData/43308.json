[{"count": 0, "tags": [], "bug_id": 43308, "text": "In Apache 2.2.x a worker, and the associated backend connection pool, is created\nfor each ProxyPass directive. In that case the backend connections will by\ndefault be persistent (reusable).\n\nAnother mechanism exists for proxying requests to a backend: RewriteRule with\nthe [P] flag. Unless the URL resulting from the rewriting process matches an\nexisting worker (created because of the presence of a RewriteRule), the\nrewritten request will not be able to benefit from a persistent connection to\nthe backend. In that case the default worker (*) will be used. The connections\nin the pool of the default worker are not persistent.\n\nI therefore suggest to modify ap_proxy_pre_request() in order to create new\nworkers as needed in the event of requests that do not match an existing worker.", "id": 107732, "time": "2007-09-04T23:27:45Z", "creator": "asmorgrav@yahoo.no", "creation_time": "2007-09-04T23:27:45Z", "is_private": false, "attachment_id": null}, {"attachment_id": 20771, "tags": [], "creator": "asmorgrav@yahoo.no", "text": "Created attachment 20771\nPatch against httpd 2.2.4\n\nThe attached patch adds new workers on the fly as new backends for which no\nworker exists are identified. This can happen if a RewriteRule proxies a\nrequest (with the [P] flag), and the backend URL does not match any of the\nProxyPass' second argument (URL).\n\n1. New workers are created for scheme://address/. The URL path is ignored. One\nmight want to add a new configuration directive for specifying the number of\npath elements to include in the worker name.\n\n2. The request for which the worker is created is served using the default\nworker. The connection pool for the new worker is then only populated on the\nfirst request matching the new worker (the 2nd request), and an existing\nconnection may only be reused from the following request on.\n\n3. There is no way to tune the connection pooling of the workers created\non-the-fly.\n\n4. One might want to add a new configuration directive for (de-)activating this\nmechanism\n\n\nRegarding the implementation details, being a novice to Apache development, I\nlook forward to your comments. However\n\ni) PROXY_COPY_CONF_PARAMS should probably be moved to mod_proxy.h to avoid\nduplication of code\n\nii) I allocate a copy of the URL on the stack rather than out of the pool since\nas far as I could see, it is duplicated in ap_proxy_add_worker() anyway\n\niii) Someone skilled in the art of Apache httpd development could probably come\nup with a way that the newly created worker could be used immediately instead\nof having to wait for the next request.", "count": 1, "id": 107733, "time": "2007-09-04T23:34:28Z", "bug_id": 43308, "creation_time": "2007-09-04T23:34:28Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 43308, "text": "Created attachment 20772\nConfiguration and debug log illustrating the creation of new workers\n\nThe attached file contains the debug log tracing a few requests made against a\npatched server.", "id": 107735, "time": "2007-09-05T01:20:44Z", "creator": "asmorgrav@yahoo.no", "creation_time": "2007-09-05T01:20:44Z", "is_private": false, "attachment_id": 20772}, {"count": 3, "text": "Can you provide the patch in 'diff -u' format?", "creator": "chip@force-elite.com", "attachment_id": null, "id": 107999, "time": "2007-09-10T18:52:30Z", "bug_id": 43308, "creation_time": "2007-09-10T18:52:30Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "creator": "asmorgrav@yahoo.no", "attachment_id": 20808, "id": 108110, "time": "2007-09-13T01:54:01Z", "bug_id": 43308, "creation_time": "2007-09-13T01:54:01Z", "is_private": false, "text": "Created attachment 20808\nPatch in Unified format\n\nHere's the same patch again, this time in diff -u format"}, {"count": 5, "tags": [], "creator": "asmorgrav@yahoo.no", "attachment_id": null, "id": 108253, "time": "2007-09-16T23:52:21Z", "bug_id": 43308, "creation_time": "2007-09-16T23:52:21Z", "is_private": false, "text": "In order to address certain concerns about possible DoS attacks or potential\nresource consumption, rather than a configuration directive for de-activating\nthis mechanism, I suggest adding a new configuration directive ProxyMaxAddtlWorkers.\n\nIt will take a single numeric argument which is the maximum number of workers\nthat can be implicitly created. The default value would be 0 - zero -\neffectively disabling the creation of additional workers.\n\nApart from limiting the number of workers created by the above described\nmechanism, an equivalent number of additional scoreboard entries should also be\nallocated during the configuration phase in order to avoid starving client\nconnections."}, {"count": 6, "tags": [], "creator": "asmorgrav@yahoo.no", "attachment_id": 20830, "id": 108255, "time": "2007-09-17T02:09:13Z", "bug_id": 43308, "creation_time": "2007-09-17T02:09:13Z", "is_private": false, "text": "Created attachment 20830\nPatch against httpd 2.2.4\n\nIn addition to creating workers implicitly, this new patch implements a new\nconfiguration directive ProxyMaxAddtlWorkers which defaults to 0. This\ndirective limits the number of workers that can be implicitly created during\nrequest processing and an equivalent number of additional scoreboard entries\nare allocated at startup.\n\nAnother advantage over the previous patch is that the newly created worker is\nused immediately - no need to wait for the next request.\n\nThe macro PROXY_COPY_CONF_PARAMS has been moved from mod_proxy.c to mod_proxy.h\nbecause it is also used in proxy_util.c."}, {"count": 7, "tags": [], "creator": "asmorgrav@yahoo.no", "attachment_id": 20831, "id": 108256, "time": "2007-09-17T02:29:10Z", "bug_id": 43308, "creation_time": "2007-09-17T02:29:10Z", "is_private": false, "text": "Created attachment 20831\nPatch against \n\nThe scoreboard entries are not really allocated, but proxy_lb_workers is\nincremented by the value of ProxyMaxAddtlWorkers."}, {"count": 8, "tags": [], "creator": "takashi.asfbugzilla@tks.st", "attachment_id": null, "id": 108786, "time": "2007-09-28T23:45:03Z", "bug_id": 43308, "creation_time": "2007-09-28T23:45:03Z", "is_private": false, "text": "I've read mod_proxy.c and proxy_util.c and found a hackful workaround.\nUsing ProxyPass to create dummy workers.\nRewriting applied, then uses the dummy ProxyPass's worker.\n\n-----example-----\n\nmy server conf:\nRewriteEngine On\nRewriteRule ^/([^.]+)\\.php$ http://localhost:20000/test/$1.php [P]\nProxyPassReverse / http://localhost:20000/test/\n\nadded:\nProxyPass /keepalive-dummy/ http://localhost:20000/\n"}, {"count": 9, "tags": [], "bug_id": 43308, "attachment_id": null, "text": "(In reply to comment #8)\n> I've read mod_proxy.c and proxy_util.c and found a hackful workaround.\n> Using ProxyPass to create dummy workers.\n> Rewriting applied, then uses the dummy ProxyPass's worker.\n\nYes indeed, but it supposes that you code the exhaustive list of workers into\nthe configuration. If your backend server list is in a RewriteMap where you can\nadd and delete workers without restarting Apache, or if you use any other means\nto maintain the list of backend servers, this approach does not work.", "id": 108859, "time": "2007-10-01T10:26:16Z", "creator": "asmorgrav@yahoo.no", "creation_time": "2007-10-01T10:26:16Z", "is_private": false}, {"count": 10, "tags": [], "creator": "asmorgrav@yahoo.no", "attachment_id": 21731, "text": "Created attachment 21731\nPatch against 2.2.8", "id": 115067, "time": "2008-03-28T02:51:33Z", "bug_id": 43308, "creation_time": "2008-03-28T02:51:33Z", "is_private": false}, {"count": 11, "tags": [], "creator": "asmorgrav@yahoo.no", "attachment_id": null, "id": 136472, "time": "2010-04-28T03:13:22Z", "bug_id": 43308, "creation_time": "2010-04-28T03:13:22Z", "is_private": false, "text": "We have had this patch in production with several versions of Apache 2.2 including 2.2.14 without having encountered any problems."}]