[{"count": 0, "tags": [], "bug_id": 60372, "attachment_id": 34445, "id": 194998, "time": "2016-11-15T03:53:09Z", "creator": "katzyn@gmail.com", "creation_time": "2016-11-15T03:53:09Z", "is_private": false, "text": "Created attachment 34445\nA sample of journalctl output\n\nWith HTTP/2 enabled many similar exceptions frequently appear in journal.\n\nSEVERE: Servlet.service() for servlet [default] in context with path [] threw exception\njava.nio.BufferOverflowException\n        at java.nio.HeapByteBuffer.put(HeapByteBuffer.java:189)\nSEVERE: Error processing request\njava.nio.BufferOverflowException\n        at java.nio.HeapByteBuffer.put(HeapByteBuffer.java:189)\nSEVERE: Error finishing response\njava.nio.BufferOverflowException\n        at java.nio.HeapByteBuffer.put(HeapByteBuffer.java:189)\n\nSee attachment for full stack traces.\n\nThere are a few of HTTP and HTTPS connectors with IPv4 and IPv6 addresses.\n\nHTTPS connectors configured like this:\n\n<Connector address=\"...\" port=\"443\" protocol=\"HTTP/1.1\" SSLEnabled=\"true\"\n      maxThreads=\"150\" scheme=\"https\" secure=\"true\"\n      connectionTimeout=\"20000\"\n      compression=\"on\"\n      compressableMimeType=\"text/html,application/xml,text/css,application/javascript,text/plain,application/json\">\n        <UpgradeProtocol className=\"org.apache.coyote.http2.Http2Protocol\" />\n        <SSLHostConfig>\n            <Certificate\n              certificateFile=\"...\"\n              certificateKeyFile=\"...\"\n              certificateChainFile=\"...\"\n        </SSLHostConfig>\n</Connector>\n\nWithout <UpgradeProtocol> exceptions do not appear.\n\nServer is running Tomcat 8.5.8 + tcnative 1.2.10 + openSSL 1.0.2h.\n\nI cannot reproduce this on testing server with the same configuration by my own requests."}, {"count": 1, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "id": 195021, "time": "2016-11-16T09:38:12Z", "bug_id": 60372, "creation_time": "2016-11-16T09:38:12Z", "is_private": false, "text": "This is a bad beug report. The stacktrace indicates the issue occurs with HTTP/1.1, HTTP/2 is not affected. The headers sent back seem to be too large, but I don't really see why. It could be a state issue with the new ByteBuffer based code, maybe related to upgrade.\nDoes this also occurs on 8.5.6 ?"}, {"count": 2, "tags": [], "bug_id": 60372, "attachment_id": null, "id": 195024, "time": "2016-11-16T10:36:45Z", "creator": "katzyn@gmail.com", "creation_time": "2016-11-16T10:36:45Z", "is_private": false, "text": "You're right, now I see similar exceptions without HTTP/2 enabled. But it took many hours after server's restart to see them. Triples of exceptions appear with rate about 3000 per hour with random intervals between them. They disappears again after restart with the same settings.\n\nUnfortunately, old journal data is already erased and I cannot definitely say is this bug present in previous versions, but I remember that I saw strange exceptions some time ago with different versions from 8.5 line after relatively long uptimes of Tomcat Server.\n\nBut I've just downgraded Tomcat to version 8.5.6 to check it. It takes some time, maybe some days. It seems that long uptime and heavy load required to reveal this bug."}, {"count": 3, "tags": [], "bug_id": 60372, "attachment_id": null, "text": "It seems that check in Http11OutputBuffer.checkLengthBeforeWrite() is not correct.\n\nIt compares with ByteBuffer.capacity(), but ByteBuffer.limit() should be used actually.", "id": 195025, "time": "2016-11-16T11:28:11Z", "creator": "katzyn@gmail.com", "creation_time": "2016-11-16T11:28:11Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 60372, "attachment_id": null, "text": "Hi,\n\n(In reply to Evgenij Ryazanov from comment #3)\n> It seems that check in Http11OutputBuffer.checkLengthBeforeWrite() is not\n> correct.\n> \n> It compares with ByteBuffer.capacity(), but ByteBuffer.limit() should be\n> used actually.\n\nThe check is correct. If you take a look to the code again you will see that the ByteBuffer is kept in \"writing\" mode i.e. the limit is the capacity.\n\nI'll do a code review in order to try to find the reason for this exception.\n\nRegards,\nVioleta", "id": 195026, "time": "2016-11-16T12:20:40Z", "creator": "violetagg@apache.org", "creation_time": "2016-11-16T12:20:40Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 60372, "attachment_id": null, "text": "Oh, I see. But exception in the middle of commit() method can prevent proper reinitialization.\n\n@@ -347,6 +347,8 @@\n         if (headerBuffer.position() > 0) {\n             // Sending the response header buffer\n             headerBuffer.flip();\n+            // Random I/O exception\n+            if (Math.random() < 0.1)\n+                throw new IOException();\n             socketWrapper.write(isBlocking(), headerBuffer);\n             headerBuffer.position(0).limit(headerBuffer.capacity());\n         }\n@@ -493,6 +495,8 @@\n      * requested number of bytes.\n      */\n     private void checkLengthBeforeWrite(int length) {\n+        if (headerBuffer.capacity() != headerBuffer.limit())\n+            System.err.printf(\"%d != %d%n\", headerBuffer.capacity(), headerBuffer.limit());\n         // \"+ 4\": BZ 57509. Reserve space for CR/LF/COLON/SP characters that\n         // are put directly into the buffer following this write operation.\n         if (headerBuffer.position() + length + 4 > headerBuffer.capacity()) {", "id": 195028, "time": "2016-11-16T13:25:34Z", "creator": "katzyn@gmail.com", "creation_time": "2016-11-16T13:25:34Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 60372, "attachment_id": null, "text": "nextRequest() sets position back to 0, but leaves limit as is.", "id": 195029, "time": "2016-11-16T13:37:49Z", "creator": "katzyn@gmail.com", "creation_time": "2016-11-16T13:37:49Z", "is_private": false}, {"count": 7, "attachment_id": null, "bug_id": 60372, "text": "(In reply to Evgenij Ryazanov from comment #5)\n> Oh, I see. But exception in the middle of commit() method can prevent proper\n> reinitialization.\n> \n> @@ -347,6 +347,8 @@\n>          if (headerBuffer.position() > 0) {\n>              // Sending the response header buffer\n>              headerBuffer.flip();\n> +            // Random I/O exception\n> +            if (Math.random() < 0.1)\n> +                throw new IOException();\n>              socketWrapper.write(isBlocking(), headerBuffer);\n\nYes that's the problem that I also saw while inspecting the code.\nIOException can be thrown while writing the response headers to the socket.\n\nHere [1] is the fix.\nDo you think you can test it?\n\nThanks,\nVioleta\n\n[1] http://svn.apache.org/viewvc?view=revision&revision=1769976", "id": 195030, "time": "2016-11-16T13:42:21Z", "creator": "violetagg@apache.org", "creation_time": "2016-11-16T13:42:21Z", "tags": [], "is_private": false}, {"count": 8, "tags": [], "bug_id": 60372, "attachment_id": null, "text": "Yes, but it will take a couple of days I guess.", "id": 195031, "time": "2016-11-16T13:49:42Z", "creator": "katzyn@gmail.com", "creation_time": "2016-11-16T13:49:42Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 60372, "attachment_id": null, "text": "Ok, IMO a new 8.5 is definitely needed.", "id": 195032, "time": "2016-11-16T13:54:34Z", "creator": "remm@apache.org", "creation_time": "2016-11-16T13:54:34Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 60372, "text": "(In reply to Evgenij Ryazanov from comment #8)\n> Yes, but it will take a couple of days I guess.\n\nHere [1] I published a snapshot that contains the fix if you need it.\nIt will be great if you can test it.\n\nThanks,\nVioleta\n\n[1] https://repository.apache.org/content/repositories/snapshots/org/apache/tomcat/tomcat/8.5-SNAPSHOT/", "id": 195034, "time": "2016-11-16T15:05:08Z", "creator": "violetagg@apache.org", "creation_time": "2016-11-16T15:05:08Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "creator": "katzyn@gmail.com", "attachment_id": null, "id": 195055, "time": "2016-11-17T00:52:10Z", "bug_id": 60372, "creation_time": "2016-11-17T00:52:10Z", "is_private": false, "text": "Server is now running tomcat-8.5-20161116.160434-5.tar.gz. I will check it for exceptons later."}, {"count": 12, "tags": [], "bug_id": 60372, "attachment_id": null, "text": "Seems to be fixed. No new exceptions in journal and no random ERR_EMPTY_RESPONSE errors in clients any more after reasonable long uptime under heavy load.", "id": 195070, "time": "2016-11-18T00:22:32Z", "creator": "katzyn@gmail.com", "creation_time": "2016-11-18T00:22:32Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 60372, "attachment_id": null, "text": "Hi,\n\nThanks for testing the fix.\nIt will be available in 9.0.0.M14 and 8.5.9 onwards\n\nRegards,\nVioleta", "id": 195078, "time": "2016-11-18T13:43:57Z", "creator": "violetagg@apache.org", "creation_time": "2016-11-18T13:43:57Z", "is_private": false}, {"count": 14, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "text": "I was thinking maybe the state could be reinitialized when \"creating\" the output buffer, but the try/finally should be cheap and better.", "id": 195079, "time": "2016-11-18T14:04:36Z", "bug_id": 60372, "creation_time": "2016-11-18T14:04:36Z", "is_private": false}, {"count": 15, "tags": [], "bug_id": 60372, "attachment_id": null, "text": "*** Bug 60433 has been marked as a duplicate of this bug. ***", "id": 195305, "time": "2016-11-30T12:36:07Z", "creator": "violetagg@apache.org", "creation_time": "2016-11-30T12:36:07Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 60372, "attachment_id": null, "text": "*** Bug 60455 has been marked as a duplicate of this bug. ***", "id": 195406, "time": "2016-12-08T15:30:59Z", "creator": "violetagg@apache.org", "creation_time": "2016-12-08T15:30:59Z", "is_private": false}, {"count": 17, "tags": [], "bug_id": 60372, "text": "dear support\n\nwhen can I expect the patch to be included in tomcat 8.5 or tomcat 9 release?\n\nI have not found it in changelog of latest tomcat 8.5 \n\nThank you, Jan", "id": 195407, "time": "2016-12-08T15:39:24Z", "creator": "jan.kostelansky@aerosoftsys.com", "creation_time": "2016-12-08T15:39:24Z", "is_private": false, "attachment_id": null}, {"count": 18, "tags": [], "creator": "mgrigorov@apache.org", "attachment_id": null, "text": "8.5.9 is being voted at the moment.\nIf everything is OK it will be available in the next few days.", "id": 195408, "time": "2016-12-08T15:40:55Z", "bug_id": 60372, "creation_time": "2016-12-08T15:40:55Z", "is_private": false}]