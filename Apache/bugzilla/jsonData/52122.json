[{"count": 0, "tags": [], "text": "When creating a formula based conditional formatting referencing another cell, the formatting is not (re-)calculated properly.\n\nThe only change I've made to patch the problem is in constructor method\n\"CFRecordsAggregate(CFHeaderRecord pHeader, CFRuleRecord[] pRules)\" in class \"CFRecordsAggregate\" where I added the row:\n\n//----------------------------------\nheader.setNeedRecalculation(true);        \n//----------------------------------", "attachment_id": null, "id": 151128, "creator": "ivano.diana@ext.bhuman.it", "time": "2011-11-02T11:33:27Z", "bug_id": 52122, "creation_time": "2011-11-02T11:33:27Z", "is_private": false}, {"count": 1, "tags": [], "creator": "ivano.diana@ext.bhuman.it", "attachment_id": 27888, "text": "Created attachment 27888\npatch.tar.gz  attachement created by command ---> ant -f patch.xml\n\npatch.tar.gz  contain class file:\n\nsrc\\java\\org\\apache\\poi\\hssf\\record\\aggregates\\CFRecordsAggregate.java \n\nmodified in constructor method.", "id": 151129, "time": "2011-11-02T12:33:54Z", "bug_id": 52122, "creation_time": "2011-11-02T12:33:54Z", "is_private": false}, {"count": 2, "tags": [], "text": "Hi,\n\nCan you please attach a simple unit test to show the problem you fixed in your patch?\n\nRegards, Evgeniy\n\n(In reply to comment #1)\n> Created attachment 27888 [details]\n> patch.tar.gz  attachement created by command ---> ant -f patch.xml\n> \n> patch.tar.gz  contain class file:\n> \n> src\\java\\org\\apache\\poi\\hssf\\record\\aggregates\\CFRecordsAggregate.java \n> \n> modified in constructor method.", "attachment_id": null, "id": 161982, "creator": "superrubiroyd@gmail.com", "time": "2012-09-05T20:21:37Z", "bug_id": 52122, "creation_time": "2012-09-05T20:21:37Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 52122, "text": "Created attachment 32359\nTest class to reproduce the problem\n\nI've compiled and run the attached class; as a result see the next attached file where I try to explain the problem.\nP.S.: I've executed the tests using POI versions 3.8 beta4, 3.9, 3.11 and the results is the same; when I've executed the test with POI library patched as described by Mr. Diana, the behavior is as expected (see next attached file).", "id": 180239, "time": "2015-01-09T11:34:58Z", "creator": "carlo.dellacqua@ext.piksel.it", "creation_time": "2015-01-09T11:34:58Z", "is_private": false, "attachment_id": 32359}, {"count": 4, "tags": [], "bug_id": 52122, "text": "Created attachment 32360\nDescription of the executed tests\n\nIn test_description.docx there is the description of the esecuted test;\nin conditional-sheet_poi-3.8.xls and conditional-sheet_poi-3.8_mod.xls there are the execel files which I've opened with Excel 2013", "id": 180240, "time": "2015-01-09T11:59:52Z", "creator": "carlo.dellacqua@ext.piksel.it", "creation_time": "2015-01-09T11:59:52Z", "is_private": false, "attachment_id": 32360}, {"count": 5, "tags": [], "creator": "dominik.stadler@gmx.at", "attachment_id": null, "text": "*** Bug 49688 has been marked as a duplicate of this bug. ***", "id": 181895, "time": "2015-03-18T20:58:03Z", "bug_id": 52122, "creation_time": "2015-03-18T20:58:03Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 52122, "attachment_id": null, "id": 188069, "time": "2016-01-30T16:21:41Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2016-01-30T16:21:41Z", "is_private": false, "text": "I tried the sample application with the latest version of POI and it did already work there, so it seems some work that we did on conditional formatting also fixed this case. \n\nPlease retry with a recent nightly or POI 3.14-beta1 and reopen with additional information if it still does not work for you."}, {"count": 7, "tags": [], "text": "Created attachment 33641\njava test class\n\nJava test class used to create the xls file to reproduce the problem.", "attachment_id": 33641, "id": 189194, "creator": "carlo.dellacqua@ext.piksel.it", "time": "2016-03-07T09:39:33Z", "bug_id": 52122, "creation_time": "2016-03-07T09:39:33Z", "is_private": false}, {"count": 8, "tags": [], "text": "I've downloaded the last version of POI (poi-bin-3.14, poi-src-3.14) and the problem is still present; \nto solve the problem I've changed the source file\nCFRecordsAggregate.java\nadding after line 74\n    header = pHeader;\nthe call to\n    header.setNeedRecalculation(true);\n\nThe following is the test class I use to create the xls file\n\npackage test;\n\nimport java.io.FileOutputStream;\nimport java.io.IOException;\n\nimport org.apache.poi.hssf.usermodel.HSSFWorkbook;\nimport org.apache.poi.ss.usermodel.Cell;\nimport org.apache.poi.ss.usermodel.ConditionalFormattingRule;\nimport org.apache.poi.ss.usermodel.IndexedColors;\nimport org.apache.poi.ss.usermodel.PatternFormatting;\nimport org.apache.poi.ss.usermodel.Row;\nimport org.apache.poi.ss.usermodel.Sheet;\nimport org.apache.poi.ss.usermodel.SheetConditionalFormatting;\nimport org.apache.poi.ss.usermodel.Workbook;\nimport org.apache.poi.ss.util.CellRangeAddress;\n\npublic class TestExcelConditionalFormattingByFormula_2 {\n\tpublic static void main(String[] args) throws IOException {\n\t\t  FileOutputStream fos = null;\n\t\t  try {\n\t\t\t  Workbook workbook = new HSSFWorkbook();\n\t\t\t  Sheet sheet = workbook.createSheet(\"Conditional Formatting Test\");\n\t\t\t  sheet.setColumnWidth(0, 256 * 10);\n\t\t\t  sheet.setColumnWidth(1, 256 * 10);\n\t\t\t  sheet.setColumnWidth(2, 256 * 10);\n\n\t\t\t  // Create some content.\n\t\t\t  // row 0\n\t\t\t  Row row = sheet.createRow(0);\n\n\t\t\t  Cell cell0 = row.createCell(0);\n\t\t\t  cell0.setCellType(org.apache.poi.ss.usermodel.Cell.CELL_TYPE_NUMERIC);\n\t\t\t  cell0.setCellValue(100);\n\n\t\t\t  Cell cell1 = row.createCell(1);\n\t\t\t  cell1.setCellType(org.apache.poi.ss.usermodel.Cell.CELL_TYPE_NUMERIC);\n\t\t\t  cell1.setCellValue(120);\n\n\t\t\t  Cell cell2 = row.createCell(2);\n\t\t\t  cell2.setCellType(org.apache.poi.ss.usermodel.Cell.CELL_TYPE_NUMERIC);\n\t\t\t  cell2.setCellValue(130);\n\n\t\t\t  // row 1\n\t\t\t  row = sheet.createRow(1);\n\n\t\t\t  cell0 = row.createCell(0);\n\t\t\t  cell0.setCellType(org.apache.poi.ss.usermodel.Cell.CELL_TYPE_NUMERIC);\n\t\t\t  cell0.setCellValue(200);\n\n\t\t\t  cell1 = row.createCell(1);\n\t\t\t  cell1.setCellType(org.apache.poi.ss.usermodel.Cell.CELL_TYPE_NUMERIC);\n\t\t\t  cell1.setCellValue(220);\n\n\t\t\t  cell2 = row.createCell(2);\n\t\t\t  cell2.setCellType(org.apache.poi.ss.usermodel.Cell.CELL_TYPE_NUMERIC);\n\t\t\t  cell2.setCellValue(230);\n\n\t\t\t  // row 2\n\t\t\t  row = sheet.createRow(2);\n\n\t\t\t  cell0 = row.createCell(0);\n\t\t\t  cell0.setCellType(org.apache.poi.ss.usermodel.Cell.CELL_TYPE_NUMERIC);\n\t\t\t  cell0.setCellValue(300);\n\n\t\t\t  cell1 = row.createCell(1);\n\t\t\t  cell1.setCellType(org.apache.poi.ss.usermodel.Cell.CELL_TYPE_NUMERIC);\n\t\t\t  cell1.setCellValue(320);\n\n\t\t\t  cell2 = row.createCell(2);\n\t\t\t  cell2.setCellType(org.apache.poi.ss.usermodel.Cell.CELL_TYPE_NUMERIC);\n\t\t\t  cell2.setCellValue(330);\n\t\t\t  \n\t\t\t  // Create conditional formatting, CELL1 should be yellow if CELL0 is not blank.\n\t\t\t  SheetConditionalFormatting formatting = sheet.getSheetConditionalFormatting();\n\n\t\t\t  ConditionalFormattingRule rule = formatting.createConditionalFormattingRule(\"$A$1>75\");\n\n\t\t\t  PatternFormatting pattern = rule.createPatternFormatting();\n\t\t\t  pattern.setFillBackgroundColor(IndexedColors.BLUE.index);\n\t\t\t  pattern.setFillPattern(PatternFormatting.SOLID_FOREGROUND);\n\n\t\t\t  CellRangeAddress[] range = {CellRangeAddress.valueOf(\"B2:C2\")};\n\t\t\t  CellRangeAddress[] range2 = {CellRangeAddress.valueOf(\"B1:C1\")};\n\n\t\t\t  formatting.addConditionalFormatting(range, rule);\n\t\t\t  formatting.addConditionalFormatting(range2, rule);\n\n\t\t\t  // Write file.\n\t\t\t  fos = new FileOutputStream(\"conditional-sheet.xls\");\n\t\t\t  workbook.write(fos);\n\t\t  } finally {\n\t\t\t  if (fos != null) {\n\t\t\t\t  try {\n\t\t\t\t\t  fos.close();\n\t\t\t\t  } catch (IOException x) {\n\t\t\t\t  }\n\t\t\t  }\n\t\t  }\n\t\t  System.out.println(\"ready.\");\n\t  }\n}", "attachment_id": null, "bug_id": 52122, "id": 189195, "time": "2016-03-07T09:45:07Z", "creator": "carlo.dellacqua@ext.piksel.it", "creation_time": "2016-03-07T09:45:07Z", "is_private": false}, {"count": 9, "tags": [], "text": "The problem occours only using HSSF (xls file extension)", "attachment_id": null, "id": 189204, "creator": "carlo.dellacqua@ext.piksel.it", "time": "2016-03-07T14:50:57Z", "bug_id": 52122, "creation_time": "2016-03-07T14:50:57Z", "is_private": false}, {"count": 10, "tags": [], "creator": "dominik.stadler@gmx.at", "attachment_id": 33827, "text": "Created attachment 33827\nPatch which creates a sample document", "id": 190743, "time": "2016-05-05T09:42:48Z", "bug_id": 52122, "creation_time": "2016-05-05T09:42:48Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 52122, "attachment_id": null, "id": 192466, "time": "2016-07-17T21:48:24Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2016-07-17T21:48:24Z", "is_private": false, "text": "I just re-tested on the latest version of POI and it seems to work: If you use my attached patch and open the file in LibreOffice (only had a Linux box here, need to try on Windows as well), then the behavior is as expected, i.e. if I change \"100\" to below 75, all the blue cells become white. If I change them back I get all blue again. \n\nSo we need to confirm on Windows if it actually does not work in Excel itself."}, {"count": 12, "tags": [], "creator": "dominik.stadler@gmx.at", "attachment_id": null, "text": "Still fails in Excel, so that is where the different results come from here.", "id": 192478, "time": "2016-07-18T08:28:27Z", "bug_id": 52122, "creation_time": "2016-07-18T08:28:27Z", "is_private": false}, {"count": 13, "tags": [], "creator": "dominik.stadler@gmx.at", "attachment_id": null, "text": "Finally applied this for Excel via v1753199, it seems LibreOffice does handle such Excel files correctly out of the box, but Excel itself does not handle the conditional formatting correctly unless the recalculate is forced, which we do now in CFRecordsAggregate.", "id": 192485, "time": "2016-07-18T10:39:49Z", "bug_id": 52122, "creation_time": "2016-07-18T10:39:49Z", "is_private": false}]