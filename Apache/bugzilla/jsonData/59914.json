[{"attachment_id": 34082, "tags": [], "bug_id": 59914, "text": "Created attachment 34082\npatch to modify apr1 poll() emulation to match behavior expected by serf\n\nserf depends on the poll emulation in apr returning a POLLERR event if a non-blocking connect() attempt fails in order to trigger an IPv6 -> IPv4 fallback, or a fallback to another address for a multi-homed host.  On FreeBSD, the poll emulation is done using kqueue, and the result returned by the poll() emulation is POLLIN + POLLHUP.\n\nconnect(4,{ AF_INET6 [xxxx:xxxx:xxxx:xxxx::xxxx]:80 },28) ERR#36 'Operation now in progress'\ngettimeofday({ 1469515046.979614 },0x0)\t\t = 0 (0x0)\nkevent(3,{ 4,EVFILT_READ,EV_ADD,0x0,0x0,0x805491300 },1,0x0,0,0x0) = 0 (0x0)\nkevent(3,{ 4,EVFILT_WRITE,EV_ADD,0x0,0x0,0x805491300 },1,0x0,0,0x0) = 0 (0x0)\nkevent(3,0x0,0,{ 4,EVFILT_READ,EV_EOF,NOTE_LOWAT|0x3c,0x0,0x805491300 4,EVFILT_WRITE,EV_EOF,NOTE_LOWAT|0x3c,0x8000,0x805491300 },32,{ 0.500000000 }) = 2 (0x2)\n\nWhen serf sees this, it calls read(), which then fails with ECONNREFUSED (or whatever), which is not even a documented read() errno value.\n\nread(4,0x80549c064,8000)\t\t\t ERR#61 'Connection refused'\n\nWhat that occurs, serf closes the socket an any other addresses are not tried.\n\nThe attached patch modifies apr to return what serf expects in the case of a non-blocking connect() failure.  Unfortunately, I did not see an easy way of handling ETIMEDOUT since that error can either be caused by connect failing or after the connection is established.  The poll emulation might need to differentiate between those two cases.\n\nThis problem affects users of svn who don't have working IPv6 connectivity to the FreeBSD svn servers.\n\n\nThe original request is in from FreeBSD bugzilla PR 211430 https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=211430", "count": 0, "id": 192731, "time": "2016-07-31T10:27:53Z", "creator": "ohauer@gmx.de", "creation_time": "2016-07-31T10:27:53Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 59914, "attachment_id": null, "is_private": false, "id": 192736, "time": "2016-07-31T10:32:50Z", "creator": "ohauer@gmx.de", "creation_time": "2016-07-31T10:32:50Z", "text": "*** Bug 59917 has been marked as a duplicate of this bug. ***"}, {"count": 2, "text": "*** Bug 59916 has been marked as a duplicate of this bug. ***", "bug_id": 59914, "attachment_id": null, "id": 192738, "time": "2016-07-31T10:36:42Z", "creator": "ohauer@gmx.de", "creation_time": "2016-07-31T10:36:42Z", "tags": [], "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 59914, "is_private": false, "count": 3, "id": 192740, "time": "2016-07-31T10:38:01Z", "creator": "ohauer@gmx.de", "creation_time": "2016-07-31T10:38:01Z", "text": "*** Bug 59915 has been marked as a duplicate of this bug. ***"}]