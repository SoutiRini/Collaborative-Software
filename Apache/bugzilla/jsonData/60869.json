[{"count": 0, "tags": [], "creator": "bug@bszx.eu", "is_private": false, "text": "Created attachment 34829\nserver status\n\nTested on prefork mpm and event mpm.\n\nHow to reproduce:\n- enable mod_http2\n- start apache\n$ ./apachectl start\n- reload apache\n$ ./apachectl graceful\n\nAfter this all existing workers are locked up in finishing state like in attached server status:\n\nSrv\tPID\tAcc\tM\tCPU \tSS\tReq\tConn\tChild\tSlot\tClient\tProtocol\tVHost\tRequest\n0-0\t9684\t0/0/0\tG \t0.00\t52\t0\t0.0\t0.00\t0.00\n1-0\t9685\t0/0/0\tG \t0.00\t52\t0\t0.0\t0.00\t0.00\n2-0\t9686\t0/3/3\tG \t0.00\t26\t0\t0.0\t0.00\t0.00 \t127.0.0.1\thttp/1.1\t127.0.0.1:8081\tGET /favicon.ico HTTP/1.1\n3-0\t9687\t0/0/0\tG \t0.00\t52\t0\t0.0\t0.00\t0.00\n4-0\t9688\t0/0/0\tG \t0.00\t52\t0\t0.0\t0.00\t0.00\n5-0\t9695\t0/0/0\tG \t0.00\t31\t0\t0.0\t0.00\t0.00\n6-1\t9701\t0/0/0\tW \t0.00\t0\t0\t0.0\t0.00\t0.00 \t127.0.0.1\thttp/1.1\t127.0.0.1:8081\tGET /server-status HTTP/1.1\n\n\n$ strace -f -p 9684\nstrace: Process 9684 attached with 2 threads\n[pid  9690] futex(0x1208718, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid  9684] futex(0x1208714, FUTEX_WAIT_PRIVATE, 12, NULL\n\n$ gdb -p 9684\n(gdb) thread apply all bt\n\nThread 2 (Thread 0x7f05a9c93700 (LWP 9690)):\n#0  0x00007f05ae69f9f6 in futex_wait_cancelable (private=<optimized out>, expected=0, futex_word=0x1208718)\n    at ../sysdeps/unix/sysv/linux/futex-internal.h:88\n#1  __pthread_cond_wait_common (abstime=0x0, mutex=0x12086a0, cond=0x12086f0) at pthread_cond_wait.c:502\n#2  __pthread_cond_wait (cond=0x12086f0, mutex=0x12086a0) at pthread_cond_wait.c:655\n#3  0x00007f05ab155ba1 in get_mplx_next (worker=0x1208790, ctx=0x12085a0, ptask=0x7f05a9c92ea8, psticky=0x7f05a9c92eb4) at h2_workers.c:160\n#4  0x00007f05ab155049 in execute (thread=0x12087d0, wctx=0x1208790) at h2_worker.c:43\n#5  0x00007f05ae699550 in start_thread (arg=0x7f05a9c93700) at pthread_create.c:456\n#6  0x00007f05ae1d49af in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:94\n#7  0x0000000000000000 in ?? ()\n\nThread 1 (Thread 0x7f05af7af540 (LWP 9684)):\n#0  0x00007f05ae69f539 in futex_wait (private=<optimized out>, expected=12, futex_word=0x1208714)\n    at ../sysdeps/unix/sysv/linux/futex-internal.h:61\n#1  futex_wait_simple (private=<optimized out>, expected=12, futex_word=0x1208714) at ../sysdeps/nptl/futex-internal.h:135\n#2  __pthread_cond_destroy (cond=0x12086f0) at pthread_cond_destroy.c:54\n#3  0x00007f05aead226e in run_cleanups (cref=<optimized out>) at memory/unix/apr_pools.c:2352\n#4  apr_pool_destroy (pool=0x1208528) at memory/unix/apr_pools.c:814\n#5  0x00007f05aead2245 in apr_pool_destroy (pool=0x1204508) at memory/unix/apr_pools.c:811\n#6  0x00007f05aace3c89 in clean_child_exit (code=0) at prefork.c:227\n#7  0x00007f05aace5052 in child_main (child_num_arg=0, child_bucket=0) at prefork.c:744\n#8  0x00007f05aace524e in make_child (s=0x118e3d0, slot=0, bucket=0) at prefork.c:824\n#9  0x00007f05aace52ed in startup_children (number_to_start=5) at prefork.c:843\n#10 0x00007f05aace58bf in prefork_run (_pconf=0x1167138, plog=0x1194358, s=0x118e3d0) at prefork.c:1010\n#11 0x0000000000434033 in ap_run_mpm (pconf=0x1167138, plog=0x1194358, s=0x118e3d0) at mpm_common.c:94\n#12 0x000000000042b1b3 in main (argc=3, argv=0x7ffc5e108828) at main.c:783", "id": 197677, "time": "2017-03-15T12:07:37Z", "bug_id": 60869, "creation_time": "2017-03-15T12:07:37Z", "attachment_id": 34829}, {"count": 1, "tags": [], "creator": "stefan@eissing.org", "is_private": false, "id": 197680, "creation_time": "2017-03-15T13:27:00Z", "time": "2017-03-15T13:27:00Z", "bug_id": 60869, "text": "Bartek, thanks for you bug report. There have been fixes done in the meantime regarding mod_http2 and graceful restart. Are you able to test your setup with a copy of the Apache 2.4.x subversion branch or are you able to build and test the module from https://github.com/icing/mod_h2\n\nThat would be helpful.\n\nUnrelated to this: have you tried using another mpm module than prefork? mpm_event is highly recommended when you want to use HTTP/2 since prefork cannot really benefit from it.\n\n-Stefan", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 60869, "attachment_id": 34830, "is_private": false, "id": 197683, "time": "2017-03-15T14:31:05Z", "creator": "bug@bszx.eu", "creation_time": "2017-03-15T14:31:05Z", "text": "Created attachment 34830\nserver status with prefork mpm"}, {"count": 3, "tags": [], "bug_id": 60869, "text": "Created attachment 34831\nserver status with event mpm", "id": 197684, "time": "2017-03-15T14:31:39Z", "creator": "bug@bszx.eu", "creation_time": "2017-03-15T14:31:39Z", "is_private": false, "attachment_id": 34831}, {"count": 4, "tags": [], "text": "Created attachment 34832\nbacktrace with event mpm", "attachment_id": 34832, "id": 197685, "creator": "bug@bszx.eu", "time": "2017-03-15T14:32:57Z", "bug_id": 60869, "creation_time": "2017-03-15T14:32:57Z", "is_private": false}, {"count": 5, "tags": [], "creator": "bug@bszx.eu", "attachment_id": null, "text": "I've copied the Apache 2.4.x subversion branch rev 1787046 (and srclib/apr branch 1.5.x rev 1787048; srclib/apr-util branch 1.5.x rev 1787048) tested the result and the issue is still there.\n\nTest results with prefork_mpm (server status is attached):\n\n$ strace -f -p 23435\nstrace: Process 23435 attached with 2 threads\n[pid 23437] futex(0x77f718, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23435] futex(0x77f714, FUTEX_WAIT_PRIVATE, 12, NULL\n\n$ gdb -p 23435\n(gdb) thread apply all bt\n\nThread 2 (Thread 0x7fc000a5c700 (LWP 23437)):\n#0  0x00007fc0054689f6 in futex_wait_cancelable (private=<optimized out>, expected=0, futex_word=0x77f718)\n    at ../sysdeps/unix/sysv/linux/futex-internal.h:88\n#1  __pthread_cond_wait_common (abstime=0x0, mutex=0x77f6a0, cond=0x77f6f0) at pthread_cond_wait.c:502\n#2  __pthread_cond_wait (cond=0x77f6f0, mutex=0x77f6a0) at pthread_cond_wait.c:655\n#3  0x00007fc001f1eba1 in get_mplx_next (worker=0x77f790, ctx=0x77f5a0, ptask=0x7fc000a5bea8, psticky=0x7fc000a5beb4) at h2_workers.c:160\n#4  0x00007fc001f1e049 in execute (thread=0x77f7d0, wctx=0x77f790) at h2_worker.c:43\n#5  0x00007fc005462550 in start_thread (arg=0x7fc000a5c700) at pthread_create.c:456\n#6  0x00007fc004f9d9af in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:94\n#7  0x0000000000000000 in ?? ()\n\nThread 1 (Thread 0x7fc006578540 (LWP 23435)):\n#0  0x00007fc005468539 in futex_wait (private=<optimized out>, expected=12, futex_word=0x77f714)\n    at ../sysdeps/unix/sysv/linux/futex-internal.h:61\n#1  futex_wait_simple (private=<optimized out>, expected=12, futex_word=0x77f714) at ../sysdeps/nptl/futex-internal.h:135\n#2  __pthread_cond_destroy (cond=0x77f6f0) at pthread_cond_destroy.c:54\n#3  0x00007fc00589b26e in run_cleanups (cref=<optimized out>) at memory/unix/apr_pools.c:2352\n#4  apr_pool_destroy (pool=0x77f528) at memory/unix/apr_pools.c:814\n#5  0x00007fc00589b245 in apr_pool_destroy (pool=0x77b508) at memory/unix/apr_pools.c:811\n#6  0x00007fc001aacc89 in clean_child_exit (code=0) at prefork.c:227\n#7  0x00007fc001aae052 in child_main (child_num_arg=0, child_bucket=0) at prefork.c:744\n#8  0x00007fc001aae24e in make_child (s=0x7053d0, slot=0, bucket=0) at prefork.c:824\n#9  0x00007fc001aae2ed in startup_children (number_to_start=5) at prefork.c:843\n#10 0x00007fc001aae8bf in prefork_run (_pconf=0x6de138, plog=0x70b358, s=0x7053d0) at prefork.c:1010\n#11 0x0000000000434033 in ap_run_mpm ()\n#12 0x000000000042b1b3 in main ()\n\nTest results with event_mpm (server status and backtrace is attached):\n$ strace -f -p 23507\nstrace: Process 23507 attached with 26 threads\n[pid 23551] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23555] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23548] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23545] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23544] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23541] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23538] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23535] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23533] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23530] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23527] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23525] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23524] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23522] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23521] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23519] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23518] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23517] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23516] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23515] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23514] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23513] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23512] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23510] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23509] futex(0x1c29ee8, FUTEX_WAIT_PRIVATE, 0, NULL <unfinished ...>\n[pid 23507] futex(0x1c29ee4, FUTEX_WAIT_PRIVATE, 204, NULL", "id": 197686, "time": "2017-03-15T14:33:35Z", "bug_id": 60869, "creation_time": "2017-03-15T14:33:35Z", "is_private": false}, {"attachment_id": 34833, "tags": [], "bug_id": 60869, "is_private": false, "count": 6, "id": 197687, "time": "2017-03-15T15:46:51Z", "creator": "stefan@eissing.org", "creation_time": "2017-03-15T15:46:51Z", "text": "Created attachment 34833\ntest patch for worker exit\n\nCan you check if the attached patch helps in your scenario?\n\ngraceful restarts are part of the normal h2 test suite, so on my systems the current implementation works fine. Something is different on your machine. You are not in any way affected by something like: https://groups.google.com/forum/#!topic/mechanical-sympathy/QbmpZxp6C64 maybe?"}, {"count": 7, "attachment_id": null, "bug_id": 60869, "text": "I've made a mistake during the second test (old mod_http2 was loaded).\nRev 1787046 works properly with and without attached patch.\n\nSorry for the noise.", "id": 197693, "time": "2017-03-15T21:08:50Z", "creator": "bug@bszx.eu", "creation_time": "2017-03-15T21:08:50Z", "tags": [], "is_private": false}, {"count": 8, "tags": [], "text": "Another mistake :-(\nI've retested it once again carefully (I've ensured that mod_http2 was enabled) and noticed that:\n\nRev 1787046 with attached patch works properly.\nRev 1787046 without attached patch locks up.", "is_private": false, "id": 197704, "creator": "bug@bszx.eu", "time": "2017-03-16T08:32:42Z", "bug_id": 60869, "creation_time": "2017-03-16T08:32:42Z", "attachment_id": null}, {"count": 9, "tags": [], "creator": "stefan@eissing.org", "attachment_id": null, "text": "Well, no harm done and thanks for re-verifying. I will the commit the attached patch, so it will be part of the next Apache, as well as the next mod_http2 github release.\n\nSeems that on most system, conditionals wake up threads on destruction, but not on yours. But I am not sure if it is guarantueed that way. The patch makes the behaviour defined which is for the better.", "id": 197705, "time": "2017-03-16T08:35:51Z", "bug_id": 60869, "creation_time": "2017-03-16T08:35:51Z", "is_private": false}, {"count": 10, "tags": [], "creator": "stefan@eissing.org", "attachment_id": null, "text": "Fixed in r1787141.", "id": 197706, "time": "2017-03-16T08:41:13Z", "bug_id": 60869, "creation_time": "2017-03-16T08:41:13Z", "is_private": false}]