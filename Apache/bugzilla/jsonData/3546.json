[{"count": 0, "tags": [], "bug_id": 3546, "attachment_id": null, "id": 5350, "time": "2001-09-11T03:42:18Z", "creator": "mak-apache-bugzilla@greenhills.co.uk", "creation_time": "2001-09-11T03:42:18Z", "is_private": false, "text": "req.getDateHeader can fail under load because it uses SimpleDateFormat\nwhich is not thread-safe.\n\nBased on http://www.servlets.com/soapbox/bugs.html\nSee also: http://developer.java.sun.com/developer/bugParade/bugs/4228335.html\n\nYou can reproduce this with a simple servlet:\n\n  import java.io.*;\n  import javax.servlet.*;\n  import javax.servlet.http.*;\n\n  public class DateServlet extends HttpServlet {\n\n    public void service(HttpServletRequest request,\n                        HttpServletResponse response)\n        throws ServletException, IOException {\n\n        PrintWriter out = response.getWriter();\n        out.println(request.getDateHeader(\"Date\"));\n    }   \n  }\n\nand hammer it with this perl script (season URL to taste):\n\n  use LWP::UserAgent;\n  my $ua = new LWP::UserAgent;\n  while(1) {\n    my $req = new HTTP::Request GET => 'http://localhost:7779/example/now';\n    $req->header('Date' => 'Tue, 11 Sep 2001 10:00:59 GMT');\n    my $res = $ua->request($req);\n    if ($res->is_success) {\n        $v = $res->content();\n        if (!defined $val) {\n            $val = $v;\n            next;\n        }\n        elsif ($val ne $v) {\n            print \"WRONG: $val\\n\";\n        }\n    } else {\n        print \"FAILED: \", $res->code();\n    }\n  }\n\nUnder java 1.3 on a 1-CPU Ultra5, 7 instances of the above, \nagainst Tomcat 4.0 rc1, start showing \"WRONG\" responses \nafter a little while (YMMV).\n\nWorkaround is to use your own synchronisation.\nThe ideal fix is for Java to include thread-safe SimpleDateFormat.\nUntil that happens perhaps Tomcat should address this. \n\nI've marked this as minor severity since servers cannot rely on\nthere being a Date header in the request (See RFC2068 Section 14.19)\nanyway, so I don't expect many servlets will look for one."}, {"count": 1, "tags": [], "text": "Should be fixed. The field was made non static, so that each request object has \nits own SimpleDateFormat objects.", "attachment_id": null, "bug_id": 3546, "id": 5393, "time": "2001-09-11T20:12:13Z", "creator": "remm@apache.org", "creation_time": "2001-09-11T20:12:13Z", "is_private": false}, {"count": 2, "tags": [], "text": "Thanks! I have verified that this fixes the failure.\n", "attachment_id": null, "bug_id": 3546, "id": 5416, "time": "2001-09-12T06:16:26Z", "creator": "mak-apache-bugzilla@greenhills.co.uk", "creation_time": "2001-09-12T06:16:26Z", "is_private": false}, {"count": 3, "tags": [], "creator": "jhunter@apache.org", "is_private": false, "text": "FWIW, it may be faster to use a thread-safe speed-optimized implementation as \ndiscussed at:\n\nhttp://www.servlets.com/archive/servlet/ReadMsg?msgId=142104&listName=tea-intere\nst\n\n-jh-\n", "id": 5742, "time": "2001-09-18T18:31:22Z", "bug_id": 3546, "creation_time": "2001-09-18T18:31:22Z", "attachment_id": null}]