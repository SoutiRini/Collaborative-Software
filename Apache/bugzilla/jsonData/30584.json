[{"count": 0, "attachment_id": null, "bug_id": 30584, "is_private": false, "id": 61804, "time": "2004-08-11T11:08:03Z", "creator": "yg64588@yahoo.com", "creation_time": "2004-08-11T11:08:03Z", "tags": [], "text": "UpdateTracker is _not_ intended to be\nthread safe, but UpdateTracker.changeStarted() is\ncalled outside the UpdateManager thread when resizing\nthe SVGCanvas. sometimes this could finnish with a\nConcurrentModificationException in UpdateManager... no more refreshing...\n\nTested on linux mandrake 10.0,\nJDK: IBM JDK 1.4.1   and   sun JDK 1.4.2_04\nbatik 1.5.1\n\n\n\n\nHere is a test case:\njust save map.svg, compile TestSVG, run and resize several times the window.\nThe program terminates as soon as RunnableQueue is broken (it takes only few\nseconds when resizing the window continuously).\n\n\n\nTestSVG.java:\n\n\nimport java.util.Random;\n\nimport javax.swing.JFrame;\n\nimport org.apache.batik.swing.JSVGCanvas;\nimport org.apache.batik.util.RunnableQueue;\nimport org.w3c.dom.Element;\nimport org.w3c.dom.NodeList;\n\n/**\n * @author yann\n */\npublic class TestSVG extends JFrame {\n\tJSVGCanvas c;\n\n\tString nomsvg = \"map.svg\";\n\n\tpublic TestSVG() {\n\t\tsuper();\n\t\tc = new JSVGCanvas();\n\n\t\tc.setDocumentState(JSVGCanvas.ALWAYS_DYNAMIC);\n\t\tc.setEnableImageZoomInteractor(false);\n\t\tc.setEnablePanInteractor(false);\n\t\tc.setEnableResetTransformInteractor(false);\n\t\tc.setEnableRotateInteractor(false);\n\t\tc.setEnableZoomInteractor(false);\n\t\tc.setURI(\"file://\" + nomsvg);\n\n\t\tgetContentPane().add(c);\n\t\tsetSize(400, 400);\n\t\tsetDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);\n\t\tshow();\n                \n                //wait until we can play...\n\t\twhile (c.getUpdateManager() == null) {\n\t\t\ttry {\n\t\t\t\tThread.sleep(1000);\n\t\t\t} catch (InterruptedException ie) {\n\t\t\t}\n\t\t}\n\t\twhile (c.getUpdateManager().getUpdateRunnableQueue() == null) {\n\t\t\ttry {\n\t\t\t\tThread.sleep(1000);\n\t\t\t} catch (InterruptedException ie) {\n\t\t\t}\n\t\t}\n\t\tRunnableQueue q = c.getUpdateManager().getUpdateRunnableQueue();\n\n                // everything ok. \n\t\tint cpt = 0;\n\t\twhile (true) { // modify continuously the svg document\n                               // the svgcanvas is often repainted\n                               // which make the problem appear soon\n\t\t\tcpt++;\n\t\t\ttry {\n\t\t\t\tq.invokeLater(new Runnable() {\n\t\t\t\t\tpublic void run() {\n\t\t\t\t\t\tNodeList nl = c.getSVGDocument().getElementsByTagName(\n\t\t\t\t\t\t\t\t\"path\");\n\t\t\t\t\t\tfor (int i = 0; i < nl.getLength(); i++) {\n\t\t\t\t\t\t\tElement e = (Element) nl.item(i);\n\t\t\t\t\t\t\te.setAttribute(\"style\", \"fill:rgb(\"\n\t\t\t\t\t\t\t\t\t+ r.nextInt(255) + \",\" + r.nextInt(255)\n\t\t\t\t\t\t\t\t\t+ \",\" + r.nextInt(255) + \")\");\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tif (cpt % 100 == 0)\n\t\t\t\t\tThread.sleep(200);\n\t\t\t} catch (Exception e) {\n                                // RunnableQueue may be broken...\nIllegalStateException\n\t\t\t\te.printStackTrace();\n\t\t\t\tSystem.exit(0);\n\t\t\t}\n\t\t}\n\n\t}\n\n\tpublic static Random r = new Random();\n\n\tpublic static void main(String[] args) {\n\t\tnew TestSVG();\n\t}\n\n}\n\n\n\nmap.svg:\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n\n<svg nom=\"france\" xmlns:xlink=\"http://www.w3.org/1999/xlink\"\npreserveAspectRatio=\"xMidYMid\" viewBox=\"-110 70 700 600\">\n\n\n<path id=\"AI\"   d=\"M  473 349    456 353    432 344    418 377    440 387    462\n368    466 365    \"/>\n<path id=\"AS\"   d=\"M  336 155    372 142    376 168    361 183    358 199    339\n167    337 161    \"/>\n<path id=\"AL\"   d=\"M  380 365    353 341    341 334    330 348    331 375    358\n377    369 379    \"/>\n<path id=\"AP\"   d=\"M  473 507    514 481    518 450    500 460    483 462    463\n483    468 502    \"/>\n<path id=\"AH\"   d=\"M  487 422    507 457    490 464    473 472    469 451    488\n434    487 422    \"/>\n<path id=\"AM\"   d=\"M  549 496    548 472    519 464    511 471    517 506    524\n514    543 497    \"/>\n<path id=\"AD\"   d=\"M  425 458    425 447    405 436    393 447    387 454    407\n479    423 479    \"/>\n<path id=\"AR\"   d=\"M  412 182    414 173    404 147    387 142    380 157    389\n181    398 181    \"/>\n<path id=\"AG\"   d=\"M  291 586    266 571    283 552    300 546    304 552    313\n565    322 577    \"/>\n<path id=\"AB\"   d=\"M  406 258    402 262    366 251    362 226    376 223    408\n234    406 252    \"/>\n<path id=\"AU\"   d=\"M  330 571    348 569    361 567    343 544    321 535    315\n567    319 575    \"/>\n<path id=\"AV\"   d=\"M  317 465    306 479    358 509    366 487    355 464    335\n452    333 457    \"/>\n<path id=\"BR\"   d=\"M  418 515    459 510    470 516    444 532    448 528    442\n528    429 533    423 527   \"/>\n<path id=\"CA\"   d=\"M  189 223    226 212    233 195    213 192    178 187    179\n215    179 223    \"/>\n<path id=\"CL\"   d=\"M  367 441    349 458    346 450    315 452    323 421    328\n418    349 423    355 420  \"/>\n<path id=\"CH\"   d=\"M  243 380    258 378    251 403    214 429    211 413    220\n392    233 380    \"/>\n<path id=\"CM\"   d=\"M  181 365    193 373    220 392    222 432    176 396    179\n383    177 368    \"/>\n<path id=\"CE\"   d=\"M  320 353    331 339    330 293    326 290    309 301    299\n313    307 333    \"/>\n<path id=\"CZ\"   d=\"M  328 418    324 417    299 447    277 416    293 409    308\n400    327 397    \"/>\n<path id=\"CS\"   d=\"M  552 609    551 617    545 634    532 627    516 600    519\n579    517 576    552 609   \"/>\n<path id=\"HC\"   d=\"M  537 593    533 583    524 564    536 557    548 554    556\n550    555 561    552 602   \"/>\n<path id=\"CR\"   d=\"M  390 285    395 269    403 261    427 278    439 310    427\n317    387 311    \"/>\n<path id=\"CT\"   d=\"M  145 248    131 232    124 231    101 219    78 230     104\n258    123 261    \"/>\n<path id=\"CU\"   d=\"M  329 373    314 358    288 359    281 368    290 389    305\n397    319 402    328 390   \"/>\n<path id=\"DO\"   d=\"M  225 435    236 420    279 422    287 443    279 461    242\n465    222 439    \"/>\n<path id=\"DU\"   d=\"M  472 341    470 330    455 312    477 281    488 276    494\n303    477 329    \"/>\n<path id=\"DR\"   d=\"M  434 415    441 422    455 445    455 465    467 479    456\n482    425 458    430 438  \"/>\n<path id=\"EU\"   d=\"M  236 209    232 194    233 188    260 192    288 184    281\n202    259 223    244 213   \"/>\n<path id=\"EL\"   d=\"M  256 260    258 234    281 212    292 236    300 255    276\n268    263 258    260 261   \"/>\n<path id=\"FI\"   d=\"M  74 282     60  272    43  250    54 243     51 227     79\n244     75 261     \"/>\n<path id=\"GD\"   d=\"M  396 486    393 473    406 481    425 502    412 524    378\n506    373 500    \"/>\n<path id=\"GH\"   d=\"M  247 582    250 558    263 540    293 509    299 521    286\n549    275 555    \"/>\n<path id=\"GE\"   d=\"M  255 545    275 532    266 510    227 510    218 522    224\n531    246 544    255 545  \"/>\n<path id=\"GI\"   d=\"M  187 421    199 439    226 454    232 465    226 483    201\n484    176 469    \"/>\n<path id=\"HE\"   d=\"M  397 524    390 500    378 506    353 518    346 522    349\n541    353 537    368 545  \"/>\n<path id=\"IV\"   d=\"M  141 252    137 231    148 231    181 248    182 270    139\n290    131 272    132 261  \"/>\n<path id=\"IN\"   d=\"M  312 345    298 314    279 317    266 325    273 363    291\n360    295 357    312 358  \"/>\n<path id=\"IL\"   d=\"M  276 323    265 337    247 326    236 330    228 308    258\n285    265 296    268 309   \"/>\n<path id=\"IS\"   d=\"M  427 387    443 381    483 420    477 441    432 414    423\n412    428 393    \"/>\n<path id=\"JU\"   d=\"M  453 311    473 327    440 346    439 330    438 320    435\n316    442 306    444 297  \"/>\n<path id=\"LD\"   d=\"M  166 526    181 475    188 480    205 485    218 510    191\n531    178 535    175 533   \"/>\n<path id=\"LC\"   d=\"M  299 313    312 294    292 283    266 262    254 267    267\n299    278 314    \"/>\n<path id=\"LO\"   d=\"M  379 384    384 366    404 369    418 401    423 412    393\n416    387 416    378 394 \"/>\n<path id=\"LH\"   d=\"M  393 416    409 421    405 437    393 447    382 447    367\n441    361 415    378 417  \"/>\n<path id=\"LA\"   d=\"M  123 304    128 312    135 314    144 327    173 321    171\n310    176 289    \"/>\n<path id=\"LE\"   d=\"M  335 279    345 264    327 256    300 255    297 284    329\n293    336 292    \"/>\n<path id=\"LT\"   d=\"M  274 479    281 486    297 486    317 467    310 444    285\n452    280 458    272 469   \"/>\n<path id=\"LG\"   d=\"M  231 463    228 482    231 500    256 502    271 481    263\n470    262 465    245 466   \"/>\n<path id=\"LZ\"   d=\"M  351 461    379 446    390 463    392 478    396 485    359\n483    359 473    \"/>\n<path id=\"ML\"   d=\"M  231 292    213 285    178 291    175 314    178 325    218\n322    231 296    \"/>\n<path id=\"MA\"   d=\"M  160 223    160 208    152 169    172 173    176 219    191\n227    168 241    \"/>\n<path id=\"MR\"   d=\"M  362 226    376 223    392 224    408 218    382 175    362\n193    356 214    360 225\"/>\n<path id=\"MH\"   d=\"M  456 257    444 249    435 229    408 234    406 252    420\n274    431 278    437 278\"/>\n<path id=\"MY\"   d=\"M  181 269    179 253    191 241    214 236    215 248    212\n258    209 266    204 281    \"/>\n<path id=\"MM\"   d=\"M  493 212    466 203    457 195    452 174    448 190    447\n225    465 229    485 226   \"/>\n<path id=\"MS\"   d=\"M  444 199    442 184    431 166    414 177    414 202    416\n215    437 230    \"/>\n<path id=\"MO\"   d=\"M  137 286    132 273    120 267    102 256    76 267     95\n288     105 290    109 290      \"/>\n<path id=\"ME\"   d=\"M  457 195    452 174    478 178    511 179    493 191    504\n199    506 202    \"/>\n<path id=\"NI\"   d=\"M  353 341    366 341    384 333    383 301    378 297    363\n290    337 292    347 332  \"/>\n<path id=\"NO\"   d=\"M  354 142    361 138    380 136    341 104    315 85     315\n108    335 125    339 141  \"/>\n<path id=\"OI\"   d=\"M  286 173    285 164    320 167    339 167    338 180    339\n199    317 198    301 192   \"/>\n<path id=\"OR\"   d=\"M  188 239    226 212    252 223    250 255    244 252    219\n241    209 238    188 239\"/>\n<path id=\"PC\"   d=\"M  279 113    302 98     326 112    329 114    333 136    324\n139    312 131    280 125\"/>\n<path id=\"PD\"   d=\"M  328 404    337 418    374 416    378 394    371 379    330\n386    326 392    \"/>\n<path id=\"PA\"   d=\"M  206 576    196 567    154 541    166 536    211 531    227\n539    221 557    \"/>\n<path id=\"PH\"   d=\"M  216 569    227 545    227 539    233 538    240 580    236\n580    222 577    \"/>\n<path id=\"PO\"   d=\"M  306 591    314 594    325 596    361 590    357 566    351\n565    326 580    306 587  \"/>\n<path id=\"RB\"   d=\"M  501 227    505 205    504 199    494 201    493 191    514\n190    530 182    526 208   \"/>\n<path id=\"RH\"   d=\"M  507 272    502 268    502 234    525 269    511 279    507\n277    \"/>\n<path id=\"RO\"   d=\"M  403 363    409 359    426 386    421 406    407 392    404\n385    398 375    404 365  \"/>\n<path id=\"SH\"   d=\"M  437 285    457 295    486 278    491 264    489 258    479\n256    459 257    455 260     \"/>\n<path id=\"SL\"   d=\"M  435 316    412 323    392 310    385 351    403 363    420\n366    442 331     \"/>\n<path id=\"ST\"   d=\"M  256 260    247 251    236 238    232 239    212 262    204\n281    215 285    231 292    \"/>\n<path id=\"SV\"   d=\"M  501 420    522 405    495 378    477 385    460 393    476\n403    481 420    492 425  \"/>\n<path id=\"SA\"   d=\"M  466 365    464 366    471 385    480 385    491 375    495\n378    502 358    479 354   469 363 \"/>\n<path id=\"SM\"   d=\"M  234 181    246 155    274 145    286 161    285 168    286\n181    279 179    249 182   \"/>\n<path id=\"SE\"   d=\"M  321 205    322 198    339 199    356 214    360 225    336\n253    330 253    322 252   321 225   \"/>\n<path id=\"YV\"   d=\"M  298 240    303 226    306 219    301 205    291 204    286\n225    298 240\"/>\n<path id=\"SD\"   d=\"M  218 324    224 341    225 350    229 375    210 383    198\n360    199 352    191 328   \"/>\n<path id=\"SO\"   d=\"M  324 139    310 136    299 134    298 129    272 143    286\n159    336 162    338 149   \"/>\n<path id=\"TA\"   d=\"M  353 518    325 494    309 492    301 519    302 525    309\n530    325 534    339 525   350 519  \"/>\n<path id=\"TG\"   d=\"M  264 497    274 483    292 489    297 486    306 482    284\n512    280 516    260 508   \"/>\n<path id=\"VA\"   d=\"M  476 506    484 508    516 502    523 519    488 544    473\n537    472 520    474 509   \"/>\n<path id=\"VU\"   d=\"M  468 502    462 493    455 482    451 480    439 475    427\n489    431 490    455 508   \"/>\n<path id=\"VE\"   d=\"M  186 368    173 369    168 369    150 358    160 333    164\n329    173 324    181 326   198 360   \"/>\n<path id=\"VI\"   d=\"M  218 324    224 341    225 350    229 368    233 377    265\n369    267 354    246 327   218 322 \"/>\n<path id=\"VH\"   d=\"M  293 394    290 389    281 368    258 378    258 411    272\n412    273 416    284 412   305 403   \"/>\n<path id=\"VO\"   d=\"M  495 260    504 230    499 219    472 227    450 224    447\n241    453 253    475 254   482 252   \"/>\n<path id=\"YO\"   d=\"M  388 262    378 264    360 240    343 256    363 290    387\n299    395 273    392 264   \"/>\n<path id=\"TB\"   d=\"M  493 260    499 262    507 272    504 277    495 275    493\n260    \"/>\n<path id=\"ES\"   d=\"M  321 225    310 245    298 240    301 233    312 219    315\n220    317 220    320 221   321 222  \"/>\n<path id=\"VS\"   d=\"M  291 196    308 196    321 201    315 206    308 208    297\n206    291 204    288 202   \"/>\n<path id=\"IC\"   d=\"M  309 220    306 214    313 206    321 223    320 222    319\n220    315 220    313 220   312 219 \"/> \n\n</svg>\n\n\n\n\n\n\nHere are stack traces  for AWTEventDispatchThread (the code called when the\ncanvas is resized)  and\nthe ConcurrentModificationException in UpdateManager (crash of the RunnableQueue):\n\n\njava.lang.Exception: Stack trace\n\tat java.lang.Thread.dumpStack(Thread.java:1103)\n\tat org.apache.batik.gvt.UpdateTracker.changeStarted(Unknown Source)\n\tat\norg.apache.batik.gvt.AbstractGraphicsNode.fireGraphicsNodeChangeStarted(Unknown\nSource)\n\tat\norg.apache.batik.gvt.AbstractGraphicsNode.fireGraphicsNodeChangeStarted(Unknown\nSource)\n\tat org.apache.batik.gvt.CanvasGraphicsNode.setViewingTransform(Unknown Source)\n\tat org.apache.batik.swing.svg.JSVGComponent.updateRenderingTransform(Unknown\nSource)\n\tat org.apache.batik.swing.gvt.JGVTComponent$1.componentResized(Unknown Source)\n\tat java.awt.AWTEventMulticaster.componentResized(AWTEventMulticaster.java:125)\n\tat java.awt.Component.processComponentEvent(Component.java:5120)\n\tat java.awt.Component.processEvent(Component.java:5074)\n\tat java.awt.Container.processEvent(Container.java:1607)\n\tat java.awt.Component.dispatchEventImpl(Component.java:3754)\n\tat java.awt.Container.dispatchEventImpl(Container.java:1664)\n\tat java.awt.Component.dispatchEvent(Component.java:3582)\n\tat java.awt.EventQueue.dispatchEvent(EventQueue.java:531)\n\tat\njava.awt.EventDispatchThread.pumpOneEventForHierarchy(EventDispatchThread.java:238)\n\tat\njava.awt.EventDispatchThread.pumpEventsForHierarchy(EventDispatchThread.java:182)\n\tat java.awt.EventDispatchThread.pumpEvents(EventDispatchThread.java:176)\n\tat java.awt.EventDispatchThread.pumpEvents(EventDispatchThread.java:168)\n\tat java.awt.EventDispatchThread.run(EventDispatchThread.java:131)\n\n\n\n\njava.util.ConcurrentModificationException\n\tat java.util.HashMap$HashIterator.nextEntry(HashMap.java(Compiled Code))\n\tat java.util.HashMap$KeyIterator.next(HashMap.java(Compiled Code))\n\tat org.apache.batik.gvt.UpdateTracker.getDirtyAreas(Unknown Source)\n\tat org.apache.batik.bridge.UpdateManager.repaint(Unknown Source)\n\tat\norg.apache.batik.bridge.UpdateManager$UpdateManagerRunHander.runnableInvoked(Unknown\nSource)\n\tat org.apache.batik.util.RunnableQueue.runnableInvoked(Unknown Source)\n\tat org.apache.batik.util.RunnableQueue.run(Unknown Source)\n\tat java.lang.Thread.run(Thread.java:568)"}, {"count": 1, "tags": [], "bug_id": 30584, "attachment_id": null, "id": 62252, "time": "2004-08-20T19:31:36Z", "creator": "deweese@apache.org", "creation_time": "2004-08-20T19:31:36Z", "is_private": false, "text": "This bug should be fixed in CVS now."}]