[{"count": 0, "tags": [], "text": "Internet Explorer opens up to four http connections to the web server \n(configured as reverse proxy). These are in ESTABLISHED state for the duration \nof the keep-alive timeout period. Then they enter CLOSE_WAIT state, where they \nstay for a few seconds. If the user tries to go to a new page AND \"friendly \nhttp error messages\" is enabled in Internet Explorer, the infamous \"The page \ncannot be displayed\" appears.\n\nThis has been reproduced with httpd 2.0.52 and 2.0.53 with OpenSSL 0.9.7b, \n0.9.7d and 0.9.7g. We were not able to reproduce the bug in 2.0.40 or 2.0.47 \n(all config files were equal), which makes us believe some sort of bug or \nincampability with Explorer is introduced some time after 2.0.47. One will have \nto go via a proxy in order to reproduce it.\n\nFor performance reasons, it is not an option to disable keep-alive.\n\nDisabling SSLv3 \"fixes\" the problem.", "is_private": false, "id": 73642, "creator": "eirik.gjesteland@accenture.com", "time": "2005-04-14T16:02:13Z", "bug_id": 34452, "creation_time": "2005-04-14T16:02:13Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "jorton@redhat.com", "is_private": false, "text": "There have been a couple of reports like this recently.  Do you have a precise\nreproduction case with a specific version of MSIE, which only triggers in those\nparticular httpd versions?  What's logged to the error log for the SSL vhost?\n\nAnyway, the default SSL vhost configuration will disable keepalives for MSIE for\nthe SSL vhost, using the SetEnvIf below; I take it you have disabled this?\n\nSetEnvIf User-Agent \".*MSIE.*\" \\\n         nokeepalive ssl-unclean-shutdown \\\n         downgrade-1.0 force-response-1.0\n", "id": 73643, "time": "2005-04-14T16:47:57Z", "bug_id": 34452, "creation_time": "2005-04-14T16:47:57Z", "attachment_id": null}, {"text": "Please also include the full SSL configuration you're using,", "tags": [], "creator": "jorton@redhat.com", "is_private": false, "count": 2, "id": 73644, "time": "2005-04-14T16:48:52Z", "bug_id": 34452, "creation_time": "2005-04-14T16:48:52Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "eirik.gjesteland@accenture.com", "text": "Created attachment 14715\nSSL configuration", "id": 73647, "time": "2005-04-14T17:33:27Z", "bug_id": 34452, "creation_time": "2005-04-14T17:33:27Z", "is_private": false, "attachment_id": 14715}, {"count": 4, "tags": [], "creator": "eirik.gjesteland@accenture.com", "text": "For performance reasons (throughput was halfed without keep-alive) the default \nSetEnvIf has been disabled. As 95% of our users use IE, it is not an option to \nuse this setting.\n\nWe tried to include just SetEnvIf User-Agent \".*MSIE.*\" ssl-unclean-shutdown, \nbut it did not fix the problem.\n\nWe have also tried to run without mod_deflate, but that didn't help either.\n\nMy full IE version is 6.0.2800.1106.xpsp2_gdr.040517-1325CO with updates \nQ323308, Q832894, Q837009 and Q867801. We have received error reports from \nusers with different versions, though.\n\nThe full SSL config file is now attached (virtual section included).", "id": 73648, "time": "2005-04-14T17:37:01Z", "bug_id": 34452, "creation_time": "2005-04-14T17:37:01Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "creator": "eirik.gjesteland@accenture.com", "text": "Nothing is logged in the ssl logs on the server. In fact I don't think the \nrequest reaches the server at all, as Explorer seems to try to use a connection \nthat is in CLOSE_WAIT state. One could argue that this seems like an Explorer \nbug, but as we easily reproduce this problem in 2.0.52/53 and not in 40/47, \nsome unfortunate change seems to have been introduced after 47.", "id": 73651, "time": "2005-04-14T17:46:03Z", "bug_id": 34452, "creation_time": "2005-04-14T17:46:03Z", "is_private": false, "attachment_id": null}, {"text": "OK, more things it would be useful to try:\n\n1. MSIE can be sensitive to session caching; try switching to the\nSSLSessionCache shmcb:... line\n\n2. it would be useful to narrow down where the regression occurs; particularly,\nif it works with 2.0.48 and fails with 2.0.49, that's useful; there was a\nsignificant change to the SSL connection closure handling there, but it\nshouldn't take effect if you have ssl-unclean-shutdown configured for *MSIE*.\n\n3. get some useful logs; add to the SSL vhost config:\n\nLogLevel debug\nErrorLog logs/ssl_debug_log\n\nand attach the resultant ssl_debug_log showing the reproduction of the failure\n(or better yet; a before-and-after with a version which works and one which doesn't)", "tags": [], "creator": "jorton@redhat.com", "is_private": false, "count": 6, "id": 73652, "time": "2005-04-14T18:31:06Z", "bug_id": 34452, "creation_time": "2005-04-14T18:31:06Z", "attachment_id": null}, {"count": 7, "attachment_id": 14724, "bug_id": 34452, "text": "Created attachment 14724\nSSL debug log from 2.0.40 (no error)\n\nPerformed the following steps:\n1. Navigated to https://10.110.64.26/ega/connectiontest/index.html (this page\ncontains a lot of large images so that explorer sets up many connections\n2. Waited until all connetions were in CLOSE_WAIT state (~30 secs)\n3. Navigated to https://10.110.64.26/ega/\n\n10.110.5.11 is the proxy server\n10.110.64.26 is the reverse proxy server\n10.110.64.6 is the web server", "id": 73675, "time": "2005-04-15T10:00:53Z", "creator": "eirik.gjesteland@accenture.com", "creation_time": "2005-04-15T10:00:53Z", "tags": [], "is_private": false}, {"count": 8, "tags": [], "creator": "eirik.gjesteland@accenture.com", "text": "Created attachment 14725\nSSL debug log from 2.0.52 (page cannot be displayed)\n\nPerformed the following steps:\n1. Navigated to https://10.110.64.26/ega/connectiontest/index.html (this page\ncontains a lot of large images so that explorer sets up many connections\n2. Waited until all connetions were in CLOSE_WAIT state (~30 secs)\n3. Navigated to https://10.110.64.26/ega/\n\n10.110.5.11 is the proxy server\n10.110.64.26 is the reverse proxy server\n10.110.64.6 is the web server", "id": 73676, "time": "2005-04-15T10:01:51Z", "bug_id": 34452, "creation_time": "2005-04-15T10:01:51Z", "is_private": false, "attachment_id": 14725}, {"count": 9, "tags": [], "bug_id": 34452, "attachment_id": 14726, "is_private": false, "id": 73677, "time": "2005-04-15T10:02:57Z", "creator": "eirik.gjesteland@accenture.com", "creation_time": "2005-04-15T10:02:57Z", "text": "Created attachment 14726\nSSL debug log from 2.0.52 ssl2 (no error)\n\nPerformed the following steps:\n1. Navigated to https://10.110.64.26/ega/connectiontest/index.html (this page\ncontains a lot of large images so that explorer sets up many connections\n2. Waited until all connetions were in CLOSE_WAIT state (~30 secs)\n3. Navigated to https://10.110.64.26/ega/\n\n10.110.5.11 is the proxy server\n10.110.64.26 is the reverse proxy server\n10.110.64.6 is the web server"}, {"count": 10, "attachment_id": null, "bug_id": 34452, "is_private": false, "id": 73678, "time": "2005-04-15T10:09:10Z", "creator": "eirik.gjesteland@accenture.com", "creation_time": "2005-04-15T10:09:10Z", "tags": [], "text": "schmcb caching did not help.\n\nI have uploaded some log files from 2.0.52 and 2.0.40.\n\nIf you still need more info I can try to narrow down where the problem occurs \nin a few days."}, {"count": 11, "tags": [], "creator": "eirik.gjesteland@accenture.com", "text": "I have now verified that the error is reproducable in 2.0.49 but not in 2.0.48.\n\n", "id": 73691, "time": "2005-04-15T11:31:39Z", "bug_id": 34452, "creation_time": "2005-04-15T11:31:39Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 34452, "attachment_id": null, "is_private": false, "id": 73765, "time": "2005-04-18T14:03:07Z", "creator": "eirik.gjesteland@accenture.com", "creation_time": "2005-04-18T14:03:07Z", "text": "I looked at the code and it seems the problem is that ssl-unclean-shutdown is \nignored.\n\nIf you change the default: behaviour in the switch in ssl_filter_io_shutdown() \nin ssl_engine_io.c to unclean the problem disappears.\n\nI guess sslconn->shutdown_type should be set by ssl_configure_env in \nssl_engine_kernel.c, but it seems like this function is not run at all. I don't \nknow the httpd architecture well enough to find why not.\n\nThe reason it worked in 2.0.48 is that the block\n\nelse if (AP_BUCKET_IS_EOC(bucket)) {\n            /* The special \"EOC\" bucket means a shutdown is needed;\n             * - turn off buffering in bio_filter_out_write\n             * - issue the SSL_shutdown\n             */\n            filter_ctx->nobuffer = 1;\n            status = ssl_filter_io_shutdown(filter_ctx, f->c, 0);\n            if (status != APR_SUCCESS) {\n                ap_log_error(APLOG_MARK, APLOG_INFO, status, NULL,\n                             \"SSL filter error shutting down I/O\");\n            }\n            if ((status = ap_pass_brigade(f->next, bb)) != APR_SUCCESS) {\n                return status;\n            }\n            break;\n        }\n\nwas inserted in ssl_io_filter_output in ssl_engine_io.c.\n\nDoes this make sense?"}, {"count": 13, "tags": [], "creator": "jorton@redhat.com", "text": "That does make perfect sense, I was wondering whether that might be the issue. \nBut we now need to work out why the shutdown_type is not getting set; I'll try\nsome tests here.  Thanks a lot!", "id": 73768, "time": "2005-04-18T14:23:10Z", "bug_id": 34452, "creation_time": "2005-04-18T14:23:10Z", "is_private": false, "attachment_id": null}, {"count": 14, "tags": [], "bug_id": 34452, "attachment_id": null, "text": "Ugh, yes.  ssl_configure_env is called from mod_ssl's ssl_hook_Translate, but\nthat won't run if, e.g. mod_proxy's translate_name hook is run first and returns\nOK, as happens in the reverse-proxy case.\n\nI have no idea why that section of mod_ssl code needs to be in a translate_name\nhook, it's probably historical.  If it can be moved somewhere more sensible this\nwill work.", "id": 73769, "time": "2005-04-18T14:45:26Z", "creator": "jorton@redhat.com", "creation_time": "2005-04-18T14:45:26Z", "is_private": false}, {"count": 15, "tags": [], "creator": "jorton@redhat.com", "text": "Created attachment 14750\nproposed mod_ssl fix\n\nHere's a patch which should fix this; it moves the ssl_configure_env call to\nthe post_read_request hook, and runs said hook slightly later to ensure that it\nruns later than the mod_setenvif post_read_request hook (a quick hack for\ntesting purposes, I'll do better when committing this).\n\nPatch should apply against 2.0.5[34]-ish.", "id": 73770, "time": "2005-04-18T15:01:58Z", "bug_id": 34452, "creation_time": "2005-04-18T15:01:58Z", "is_private": false, "attachment_id": 14750}, {"count": 16, "tags": [], "text": "Created attachment 14804\nequivalent patch for 2.0.x backport proposal\n\nThis patch is to be proposed for backport to 2.0.x and is essentially\nequivalent to the previous patch.", "is_private": false, "id": 74019, "creator": "jorton@redhat.com", "time": "2005-04-23T00:47:51Z", "bug_id": 34452, "creation_time": "2005-04-23T00:47:51Z", "attachment_id": 14804}, {"count": 17, "tags": [], "creator": "jorton@redhat.com", "text": "Fixed on the trunk: http://svn.apache.org/viewcvs?view=rev&rev=161958\nand proposed for backport to 2.0.x.  Thanks again for your help debugging this\nissue!", "id": 74075, "time": "2005-04-25T08:47:14Z", "bug_id": 34452, "creation_time": "2005-04-25T08:47:14Z", "is_private": false, "attachment_id": null}, {"count": 18, "tags": [], "text": "Does anybody know whether or not this fix was incorporated in the 2.2 tree?   \n\nWe recently upgraded from 2.0.48 to 2.2.0 and are now seeing a similiar issue \nto what's reported here.   Let me know if you require additional information.  ", "is_private": false, "id": 88513, "creator": "rfreilich@rim.net", "time": "2006-04-26T17:43:32Z", "bug_id": 34452, "creation_time": "2006-04-26T17:43:32Z", "attachment_id": null}, {"count": 19, "attachment_id": null, "bug_id": 34452, "text": "This patch is also contained in 2.2.0.", "id": 88516, "time": "2006-04-26T19:14:36Z", "creator": "rpluem@apache.org", "creation_time": "2006-04-26T19:14:36Z", "tags": [], "is_private": false}, {"text": "*** Bug 20641 has been marked as a duplicate of this bug. ***", "tags": [], "creator": "davi@apache.org", "is_private": false, "count": 20, "id": 104266, "time": "2007-06-09T07:39:58Z", "bug_id": 34452, "creation_time": "2007-06-09T07:39:58Z", "attachment_id": null}]