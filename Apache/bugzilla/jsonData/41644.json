[{"count": 0, "tags": [], "creator": "stuart@terminus.co.uk", "attachment_id": null, "is_private": false, "id": 99492, "time": "2007-02-16T09:28:27Z", "bug_id": 41644, "creation_time": "2007-02-16T09:28:27Z", "text": "Spotted this during reproduction/testing of bug #39245\n\nSet up Apache as a reverse proxy to some backend HTTP server:\n\n    ProxyPass /rproxy http://localhost:12345\n    ProxyPassReverse /rproxy http://localhost:12345\n\nNow make a GET request via this to something that does not exist on the backend\nserver (so a 404 will be returned):\n\n$ time curl --get http://localhost:2200/rproxy/n\nI am an error from the backend.\n\nreal    0m0.009s\nuser    0m0.004s\nsys     0m0.003s\n\nAnd now a HEAD request:\n\ngnl05024 ~ $ time curl --head http://localhost:2200/rproxy/\nHTTP/1.1 404 Not Found\nDate: Fri, 16 Feb 2007 16:47:15 GMT\nServer: Apache/2.2.4 (Unix)\nLast-Modified: Fri, 16 Feb 2007 13:33:42 GMT\nETag: \"452dd8-20-6299980\"\nAccept-Ranges: bytes\nContent-Length: 32\nContent-Type: text/plain\n\n\nreal    0m0.010s\nuser    0m0.004s\nsys     0m0.003s\n\nAll fine. Now add the following config to the frontend and repeat:\n\n    ProxyErrorOverride On\n    ErrorDocument 404 /error.txt\n\n$ time curl --get http://localhost:2200/rproxy/notfound\nI am an error from the frontend.\n\nreal    0m0.010s\nuser    0m0.004s\nsys     0m0.005s\n\n$ time curl --head http://localhost:2200/rproxy/notfound\nHTTP/1.1 404 Not Found\nDate: Fri, 16 Feb 2007 16:50:21 GMT\nServer: Apache/2.2.4 (Unix)\nLast-Modified: Fri, 16 Feb 2007 13:33:42 GMT\nETag: \"452dd8-20-6299980\"\nAccept-Ranges: bytes\nContent-Length: 32\nContent-Type: text/plain\n\n\nreal    0m5.009s\nuser    0m0.005s\nsys     0m0.002s\n\nWhoops, we're getting blocked for 5s somewhere. Attaching a debugger during the\n\"pause\" and obtaining a backtrace:\n\n#0  0x001f2402 in __kernel_vsyscall ()\n#1  0x00c7969b in poll () from /lib/libc.so.6\n#2  0x0068e974 in apr_wait_for_io_or_timeout (f=0x0, s=0x9575a60, for_read=1)\n    at support/unix/waitio.c:51\n#3  0x0068a130 in apr_socket_recv (sock=0x9575a60, \n    buf=0x95c0350 \"HTTP/1.1 404 Not Found\\r\\nDate: Fri, 16 Feb 2007 16:55:01\nGMT\\r\\nServer: Apache/2.2.4 (Unix)\\r\\nLast-Modified: Fri, 16 Feb 2007 13:33:42\nGMT\\r\\nETag: \\\"452dd8-20-6299980\\\"\\r\\nAccept-Ranges: bytes\\r\\nContent-Length:\"..., \n    len=0xbf9d1f5c) at network_io/unix/sendrecv.c:87\n#4  0x00ea17e7 in apr_bucket_socket_create () from /usr/lib/libaprutil-1.so.0\n#5  0x080782c3 in ap_core_input_filter (f=0x95b4ee0, b=0x95b6220, \n    mode=AP_MODE_READBYTES, block=APR_BLOCK_READ, readbytes=8192)\n    at core_filters.c:245\n#6  0x080865d4 in ap_get_brigade (next=0x95b4ee0, bb=0x95b6220, \n    mode=AP_MODE_READBYTES, block=APR_BLOCK_READ, readbytes=8192)\n    at util_filter.c:489\n#7  0x0809a649 in ap_http_filter (f=0x95b6200, b=0x95b6220, \n    mode=AP_MODE_READBYTES, block=APR_BLOCK_READ, readbytes=8192)\n    at http_filters.c:349\n#8  0x080865d4 in ap_get_brigade (next=0x95b6200, bb=0x95b6220, \n    mode=AP_MODE_READBYTES, block=APR_BLOCK_READ, readbytes=8192)\n    at util_filter.c:489\n#9  0x0809bdf8 in ap_discard_request_body (r=0x95b5170) at http_filters.c:1123\n#10 0x00a771ad in ap_proxy_http_process_response (p=0x95b4310, r=0x95bc368, \n    backend=0x95a7a60, origin=0x95b4a88, conf=0x954f688, \n    server_portstr=0xbf9d430c \":2200\") at mod_proxy_http.c:1576\n#11 0x00a77679 in proxy_http_handler (r=0x95bc368, worker=0x954b5e0, \n    conf=0x954f688, url=0x95b4a78 \"/notfound\", proxyname=0x0, proxyport=0)\n    at mod_proxy_http.c:1711\n#12 0x00117d56 in proxy_run_scheme_handler (r=0x95bc368, worker=0x954b5e0, \n    conf=0x954f688, url=0x95bd44e \"http://localhost:12345/notfound\", \n    proxyhost=0x0, proxyport=0) at mod_proxy.c:1978\n#13 0x00114dde in proxy_handler (r=0x95bc368) at mod_proxy.c:780\n#14 0x08079edd in ap_run_handler (r=0x95bc368) at config.c:157\n#15 0x0807a627 in ap_invoke_handler (r=0x95bc368) at config.c:372\n#16 0x08098b64 in ap_process_request (r=0x95bc368) at http_request.c:258\n#17 0x080956e4 in ap_process_http_connection (c=0x95b44e0) at http_core.c:184\n#18 0x0808244f in ap_run_process_connection (c=0x95b44e0) at connection.c:43\n#19 0x08082863 in ap_process_connection (c=0x95b44e0, csd=0x95b4348)\n    at connection.c:178\n#20 0x080b14b3 in child_main (child_num_arg=0) at prefork.c:640\n#21 0x080b159d in make_child (s=0x9505c80, slot=0) at prefork.c:680\n#22 0x080b1b44 in ap_mpm_run (_pconf=0x95010a8, plog=0x953f1a0, s=0x9505c80)\n    at prefork.c:956\n#23 0x08063476 in main (argc=2, argv=0xbf9d4824) at main.c:717\n\nWe can see it's within ap_discard_request_body() called towards the end of\nap_proxy_http_process_response() in mod_proxy_http. Looking at that code:\n\n   if (conf->error_override) {\n        /* the code above this checks for 'OK' which is what the hook expects */\n        if (ap_is_HTTP_SUCCESS(r->status))\n            return OK;\n        else {\n            /* clear r->status for override error, otherwise ErrorDocument\n             * thinks that this is a recursive error, and doesn't find the\n             * custom error page\n             */\n            int status = r->status;\n            r->status = HTTP_OK;\n            /* Discard body, if one is expected */\n            if ((status != HTTP_NO_CONTENT) && /* not 204 */\n                (status != HTTP_NOT_MODIFIED)) { /* not 304 */\n               ap_discard_request_body(rp);\n           }\n\nSo the first two ifs determine whether ProxyErrorOverride is On and the response\nis an error. In this case we'll be ignoring the response data from the backend\nserver and planting our own ErrorDocument - so we need to read and discard it\nhere. However, we may not always have a body! 204 and 304 are already countered\nfor there as you can see. HEAD requests are not. In fact, earlier in\nap_proxy_http_process_response() we see a similar check:\n\n        /* send body - but only if a body is expected */\n        if ((!r->header_only) &&                   /* not HEAD request */\n            !interim_response &&                   /* not any 1xx response */\n            (r->status != HTTP_NO_CONTENT) &&      /* not 204 */\n            (r->status != HTTP_NOT_MODIFIED)) {    /* not 304 */\n\nSo the appropriate fix would be to add a similar check of r->header_only to the\nconditional on calling ap_discard_request_body().\n\nNB: \"ap_discard_request_body\" is confusing in this context - it's the body (or\nlack of) of the *response* coming back from the backend server that's being\ndealt with here. Right?\n\nThis same logic appears in trunk, 2.2.x and 2.0.x (actually tested and\nobservered with current 2.2.x HEAD, 2.2.4 and 2.0.58). Interestingly, 2.0.x also\nchecks for HTTP_RESET_CONTENT - which is not something I've dealt with so can't\nreally comment on whether that should be there or not. RFC says \"The response\nMUST NOT include an entity.\" - not sure if that means message-body?"}, {"count": 1, "tags": [], "creator": "stuart@terminus.co.uk", "attachment_id": 19608, "is_private": false, "id": 99493, "time": "2007-02-16T09:37:13Z", "bug_id": 41644, "creation_time": "2007-02-16T09:37:13Z", "text": "Created attachment 19608\npatch against current 2.2.x HEAD to fix bug\n\nWith this patch applied to 2.2.x:\n\n$ time curl --get http://localhost:2200/rproxy/notfound\nI am an error from the frontend.\n\nreal\t0m0.010s\nuser\t0m0.004s\nsys\t0m0.003s\n\n$ time curl --head http://localhost:2200/rproxy/notfound\nHTTP/1.1 404 Not Found\nDate: Fri, 16 Feb 2007 17:31:28 GMT\nServer: Apache/2.2.4 (Unix)\nLast-Modified: Fri, 16 Feb 2007 13:33:42 GMT\nETag: \"452dd8-20-6299980\"\nAccept-Ranges: bytes\nContent-Length: 32\nContent-Type: text/plain\n\n\nreal\t0m0.012s\nuser\t0m0.004s\nsys\t0m0.004s\n\nThe \"pause\" has gone."}, {"count": 2, "tags": [], "text": "Created attachment 19609\npatch against current trunk to fix bug", "is_private": false, "id": 99495, "creation_time": "2007-02-16T09:39:44Z", "time": "2007-02-16T09:39:44Z", "creator": "stuart@terminus.co.uk", "bug_id": 41644, "attachment_id": 19609}, {"count": 3, "tags": [], "text": "fixed in trunk and forthcoming 2.2", "is_private": false, "id": 107587, "creation_time": "2007-09-01T10:07:09Z", "time": "2007-09-01T10:07:09Z", "creator": "nick@webthing.com", "bug_id": 41644, "attachment_id": null}]