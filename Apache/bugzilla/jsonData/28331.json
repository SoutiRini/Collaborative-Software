[{"count": 0, "tags": [], "text": "Hello,\n\nI use only UTF-8, as well as for reading from the Request as for writing into \nthe Response. At unpredictable times though, Tomcat seems to switch it's \nencoding in the Response to another encoding (the platform's default \nencoding?). Here's an extract out of the log file of me sending 4 consecutive \nrequests (These log() calls happen in a javax.servlet.Filter):\n\n2004-04-10 16:37:11 StandardContext[]KOEN, encoding in RESPONSE for /edit.jsp: \nUTF-8\n\n2004-04-10 16:37:13 StandardContext[]KOEN, encoding in RESPONSE for /edit.jsp: \nUTF-8\n\n2004-04-10 16:37:14 StandardContext[]KOEN, encoding in RESPONSE for /edit.jsp: \nUTF-8\n\n2004-04-10 16:37:15 StandardContext[]KOEN, encoding in RESPONSE for /edit.jsp: \nISO-8859-1\n\nI have tried many things, like explicitly setting the Content-Type header in \nthe Response in the beginning of my page, like explicitly setting that same \nheader in the Filter. Nothing works. This always happens again.\n\nI think I didn't make a mistake, you can verify my source code:\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<jsp:root xmlns:jsp=\"http://java.sun.com/JSP/Page\" \nxmlns=\"http://www.w3.org/1999/xhtml\" version=\"2.0\">\n<jsp:directive.page contentType=\"text/html\"/>\n\nExtract of the generated source code:\n\nresponse.setContentType(\"text/html;charset=UTF-8\");", "is_private": false, "id": 55618, "creator": "koen@sapo.pt", "time": "2004-04-10T15:45:36Z", "bug_id": 28331, "creation_time": "2004-04-10T15:45:36Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 28331, "attachment_id": null, "id": 55619, "time": "2004-04-10T16:04:49Z", "creator": "remm@apache.org", "creation_time": "2004-04-10T16:04:49Z", "is_private": false, "text": "- Try a newer release\n- If you are certain there's a bug, submit a ready to run test webapp (with a\nsimple JSP) demonstrating the problem"}, {"count": 2, "tags": [], "bug_id": 28331, "attachment_id": 13092, "id": 65150, "time": "2004-10-14T18:32:36Z", "creator": "bastian_knight@wp.pl", "creation_time": "2004-10-14T18:32:36Z", "is_private": false, "text": "Created attachment 13092\nTest WAR which can trigger this error"}, {"count": 3, "tags": [], "text": "Created attachment 13093\nScreenshot of good execution of testweb application", "is_private": false, "id": 65151, "creator": "bastian_knight@wp.pl", "time": "2004-10-14T18:33:58Z", "bug_id": 28331, "creation_time": "2004-10-14T18:33:58Z", "attachment_id": 13093}, {"attachment_id": 13094, "tags": [], "bug_id": 28331, "is_private": false, "count": 4, "id": 65152, "time": "2004-10-14T18:35:17Z", "creator": "bastian_knight@wp.pl", "creation_time": "2004-10-14T18:35:17Z", "text": "Created attachment 13094\nScreenshot of bad execution of testweb application"}, {"count": 5, "tags": [], "bug_id": 28331, "is_private": false, "id": 65153, "attachment_id": null, "creator": "bastian_knight@wp.pl", "creation_time": "2004-10-14T18:42:47Z", "time": "2004-10-14T18:42:47Z", "text": "I have attached three files which could help track this problem. There is simple\nweb application which one JSP page and servlet which generates simple picture.\nOther two files are screenshots which demonstrate the problem.\n\nTo trigger this bug you have to run this app and refresh a couple of times JSP\npage in Mozilla (or other browser). From time to time national letters will be\nwrongly encoded (ISO-8859-1 instead of UTF-8). It is hard to tell how many times\nyou have to refresh the page for this error to occur, but eventually it will.\n\nThis error I encountered on Linux system (Fedora Core 1 and 2), with JDK 1.4.2\nand JDK 5.0 and on any version of Tomcat 5 I have tested (even the new ones).\n"}, {"attachment_id": null, "tags": [], "bug_id": 28331, "is_private": false, "count": 6, "id": 65154, "time": "2004-10-14T19:00:54Z", "creator": "remm@apache.org", "creation_time": "2004-10-14T19:00:54Z", "text": "Right. And, unsurprisingly, this is a so specific case it is ridiculous. I\nwonder what is causing this at this time, but all I know is that the evaluation\nis going to cost me to spend a lot of time, and in the end isn't going to be\npretty for your issue."}, {"count": 7, "tags": [], "bug_id": 28331, "is_private": false, "id": 65155, "creation_time": "2004-10-14T19:17:42Z", "time": "2004-10-14T19:17:42Z", "creator": "remm@apache.org", "text": "Actually, I'm stupid, it's trivial, because I've already seen the bug. The\nproblem is that your Java2D stuff you're using has some threading weirdness. So\nit accesses slightly asynchronously the response object, causing it to become\ncommitted during the start of the processing of the next request. The issue\noccurs when there are problems with the connection (IOE during rapid requests\nfrom client disconnects). So you have a bad servlet, and your bug is INVALID.\n\nTwo solutions:\na) Write to a buffer first (ie, if something bad happens, no harm done, since\nJava2D won't have any Tomcat object to mess with).\nb) Run the security manager (so that the facade objects get discarded to protect\nthe integrity and isolation of requests). This will cause NPEs to be thrown\nduring each invalid access.\n\nSee, I told you it wouldn't be pretty for your issue ;)", "attachment_id": null}]