[{"count": 0, "tags": [], "bug_id": 39216, "attachment_id": null, "text": "mod_disk_cache cannot update cache for expired content (win32)\n\nThere is a problem with using mod_disk_cache in conjonction of mod_proxy.\n\nWhen a file is expired in the cache, mod_disk_cache doesn't handle the backend\nupdate correctly.\n\nThis leads to 2 differents problems:\n\n1) The cache won't never been updated and you're loosing benefits of caching.\n2) It leaves a tempfile in CacheRoot dir, making the CacheRoot dir bigger than\nexpected.\n\nMessages that are displayed in error.log:\n==========================================\n[Wed Mar 29 10:41:40 2006] [error] (OS 5)Acc\u00e8s refus\u00e9.  : disk_cache: rename\ntempfile to hdrsfile failed: C:/apache_cache/aptmpcBQArf ->\nC:/apache_cache/M/2fl@WQwwEqpEKxjyw7VFA.header\n\nSteps to reproduce:\n==========================================\n\nhttpd.conf:\n\n#LogLevel warn\nListen 80\n\nLoadModule authz_host_module modules/mod_authz_host.so\nLoadModule cache_module modules/mod_cache.so\nLoadModule disk_cache_module modules/mod_disk_cache.so\nLoadModule log_config_module modules/mod_log_config.so\nLoadModule proxy_module modules/mod_proxy.so\nLoadModule proxy_http_module modules/mod_proxy_http.so\nLoadModule ssl_module modules/mod_ssl.so\nLoadModule rewrite_module modules/mod_rewrite.so\nLoadModule include_module modules/mod_include.so\nLoadModule headers_module modules/mod_headers.so\nLoadModule setenvif_module modules/mod_setenvif.so\nLoadModule unique_id_module modules/mod_unique_id.so\n\nTimeout 300\nKeepAlive On\nMaxKeepAliveRequests 10000\nKeepAliveTimeout 15\n\n<IfModule mpm_winnt.c>\n\tThreadsPerChild 250\n\tMaxRequestsPerChild  0\n</IfModule>\n\nProxyVia on\nSSLProxyEngine on\nSSLSessionCache shm:C:/Apache/2.2.0/logs/ssl_gcache_data(1048576)\n\nServerRoot \"C:/Apache/2.2.0\"\nDocumentRoot \"C:/Apache/2.2.0\"\nServerName localhost:80\n\n# On ne doit pas avoir d'\u00e9l\u00e9ments variables dans le cache.\nHeader unset Vary\nHeader unset Expires\nCacheIgnoreHeaders Set-Cookie\nCacheIgnoreHeaders RequestID\nCacheIgnoreHeaders TimeReq\nCacheIgnoreHeaders User-Agent\nCacheIgnoreHeaders Accept-Encoding\nCacheIgnoreHeaders Warning\nCacheIgnoreHeaders Via\n\n# Forcer IE \u00e0 cacher les \u00e9l\u00e9ments statiques.\nSetEnvIf Request_URI \"\\.css$\"  force-no-vary\nSetEnvIf Request_URI \"\\.gif$\"  force-no-vary\nSetEnvIf Request_URI \"\\.hta$\"  force-no-vary\nSetEnvIf Request_URI \"\\.htm$\"  force-no-vary\nSetEnvIf Request_URI \"\\.html$\" force-no-vary\nSetEnvIf Request_URI \"\\.jpg$\"  force-no-vary\nSetEnvIf Request_URI \"\\.js$\"   force-no-vary\nSetEnvIf Request_URI \"\\.vbs$\"  force-no-vary\n\n<Directory />\n    Options FollowSymLinks\n    AllowOverride None\n    Order deny,allow\n    Deny from all\n</Directory>\n\n<Directory \"C:/Apache/2.2.0/htdocs\">\n    Options Indexes FollowSymLinks\n    AllowOverride None\n    Order allow,deny\n    Allow from all\n</Directory>\n\n<IfModule dir_module>\n    DirectoryIndex index.html\n</IfModule>\n\n<FilesMatch \"^\\.ht\">\n    Order allow,deny\n    Deny from all\n</FilesMatch>\n\nErrorLog logs/error.log\n\n<IfModule log_config_module>\n    LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\"\ncombined\n    LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b\" common\n\n    <IfModule logio_module>\n      # You need to enable mod_logio.c to use %I and %O\n      LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" %I\n%O\" combinedio\n    </IfModule>\n\n    CustomLog logs/access.log common\n\n</IfModule>\n\n<IfModule alias_module>\n    ScriptAlias /cgi-bin/ \"C:/Apache/2.2.0/cgi-bin/\"\n</IfModule>\n\n<Directory \"C:/Apache/2.2.0/cgi-bin\">\n    AllowOverride None\n    Options None\n    Order allow,deny\n    Allow from all\n</Directory>\n\nDefaultType text/plain\n\n<IfModule mime_module>\n    TypesConfig conf/mime.types\n\n    AddType application/x-compress .Z\n    AddType application/x-gzip .gz .tgz\n\n</IfModule>\n\nEnableMMAP off\nEnableSendfile off\nWin32DisableAcceptEx\n\n<IfModule ssl_module>\n\tSSLRandomSeed startup builtin\n\tSSLRandomSeed connect builtin\n</IfModule>\n\nListen 81\n<VirtualHost *:81>\n\n\tRequestHeader set TimeReq \"%t\"\n\tRequestHeader set RequestID \"%{UNIQUE_ID}e\"\n\n\tCacheEnable disk /\n\tCacheMaxExpire 10\n\tCacheDefaultExpire 10\n\tCacheLastModifiedFactor 10000000.0 \n\tCacheRoot \"C:/apache_cache\"\n\tCacheDirLength 1\n\tCacheDirLevels 1\n\n\tRewriteEngine On\n\tRewriteRule ^/(.*)$ http://some.site.com/$1 [P,L]\n\tProxyPassReverse / http://some.site.com/\n\t\n\tCustomLog \"| 'C:/Apache/2.2.0/bin/rotatelogs.exe' -l 'logs/vhost81_%Y%m%d.log'\n86400\" common\n\t\n</VirtualHost>\n\nThen issue this command:\n\nbin\\ab.exe -n 10000 -c 1024 -k -d http://some.site.com/some/file.txt\n\nAs soon as the file will be expired, you will see the problem.", "id": 87608, "time": "2006-04-05T14:46:27Z", "creator": "fleger@siderlog.fr", "creation_time": "2006-04-05T14:46:27Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 39216, "attachment_id": null, "is_private": false, "id": 90424, "time": "2006-06-21T09:08:24Z", "creator": "chip@force-elite.com", "creation_time": "2006-06-21T09:08:24Z", "text": "mod_disk_cache makes several assumptions on how unix file systems operate, and\nhow it is safe to move files, even if they are open.  Win32 doesn't really\nsupport all of these concepts.  I am not sure if we ever plan to support\nmod_disk_cache on win32, at least in the current incarnation. (Patches welcome\nof course)"}, {"count": 2, "tags": [], "bug_id": 39216, "attachment_id": 21858, "is_private": false, "id": 115909, "time": "2008-04-26T05:12:55Z", "creator": "philippe.duveau@eurocis.fr", "creation_time": "2008-04-26T05:12:55Z", "text": "Created attachment 21858\nPatch which close opened files (unlock) before renaming\n\nTh problem is that the function cache_select (cache_storage.c) makes some return on error after the call to open_entity (provider) without taking care of opened files by this last function.\n\nSo to fix this behaviour, the patch add a new function to sub provider which is intended to close potential opened handles. And this function is call before each returns on error.\n\nSo, this patch need to act on 3 modules mod_cache, mod_disk_cache and mod_mem_cache. About mod_mem_cache, it needs to add the new function even if it does nothing."}, {"count": 3, "tags": [], "bug_id": 39216, "attachment_id": null, "is_private": false, "id": 124786, "time": "2009-02-11T14:41:46Z", "creator": "dbuss@novell.com", "creation_time": "2009-02-11T14:41:46Z", "text": "I applied the patch bug found that I still had files being left open.  In addition to the patch in mod_disk_cache.c I made the following changes :\n   - set the header and body file handle to null after it's closed in multiple places\n   - initialized the two handles to null in open_entity\n   - in remove_entity close any open handles.\n"}]