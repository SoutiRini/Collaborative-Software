[{"count": 0, "tags": [], "bug_id": 60945, "text": "We integrate apache into our work project, and we ran into an issue where the process management service (that tracks the apache process via the FreeBSD process table), said that the process had died, but because httpd hadn't removed the process on our version, it claimed that the PID file was open, so (in theory) the process itself was running (even though the process with the PID in the pidfile didn't correspond to the apache instance).\n\nGetting to the point, PidFile management with apache is done improperly -- in particular, this logic doesn't keep the pidfile open (over the course of the worker process lifetime), and doesn't lock the pidfile with fcntl(2), or something similar via open(2):\n\n1555     if ((rv = apr_file_open(&pid_file, fname,\n1556                             APR_WRITE | APR_CREATE | APR_TRUNCATE,\n1557                             APR_UREAD | APR_UWRITE | APR_GREAD | APR_WREAD, p))\n1558         != APR_SUCCESS) {\n1559         ap_log_error(APLOG_MARK, APLOG_ERR, rv, NULL, APLOGNO(00099)\n1560                      \"could not create %s\", fname);\n1561         ap_log_error(APLOG_MARK, APLOG_ERR, 0, NULL, APLOGNO(00100)\n1562                      \"%s: could not log pid to file %s\",\n1563                      ap_server_argv0, fname);\n1564         exit(1);\n1565     }\n1566     apr_file_printf(pid_file, \"%\" APR_PID_T_FMT APR_EOL_STR, mypid);\n1567     apr_file_close(pid_file);\n1568     saved_pid = mypid;\n\nFreeBSD has a set of shims for this that could be used (pidfile_open(3)), but unfortunately they're not portable as-is (just to the various BSD versions, with some minor adjustments).\n\nApache needs to learn how to do pid files properly so it can be managed properly. Otherwise, there's no point to having PidFile's per VirtualHost that cannot be managed.", "id": 198092, "time": "2017-03-30T20:12:47Z", "creator": "yaneurabeya@gmail.com", "creation_time": "2017-03-30T20:12:47Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 60945, "attachment_id": null, "text": "> Apache needs to learn how to do pid files properly so it can be managed\n> properly. Otherwise, there's no point to having PidFile's per VirtualHost\n> that cannot be managed.\n\n\"PidFile\" isn't syntactically valid inside of VirtualHost.  What's the relationship of this to the rest of the report?", "id": 198093, "time": "2017-03-30T20:33:47Z", "creator": "covener@gmail.com", "creation_time": "2017-03-30T20:33:47Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 60945, "is_private": false, "id": 198094, "creation_time": "2017-03-30T22:32:31Z", "time": "2017-03-30T22:32:31Z", "creator": "yaneurabeya@gmail.com", "text": "(In reply to Eric Covener from comment #1)\n> > Apache needs to learn how to do pid files properly so it can be managed\n> > properly. Otherwise, there's no point to having PidFile's per VirtualHost\n> > that cannot be managed.\n> \n> \"PidFile\" isn't syntactically valid inside of VirtualHost.  What's the\n> relationship of this to the rest of the report?\n\nI'm sorry -- I misread the docs yesterday ( http://httpd.apache.org/docs/current/mod/mpm_common.html#pidfile ). It has nothing to do with VirtualHost directives (I misspoke in comment # 0).\n\nThanks!", "attachment_id": null}]