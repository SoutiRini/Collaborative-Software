[{"count": 0, "text": "I have a formula in an Excel 97-2003 spreadsheet as follows\n=AVERAGE(J6:OFFSET(I6,0,DAY(TODAY())-1))\nwhich basically does an average on a number of cells dependant on todays date.\n\nWhen I run the sample code at the bottom of  http://poi.apache.org/spreadsheet/eval.html to recalculate all formulas in a workbook (which I had to modify as follows to get it to compile properly)\n\nFileInputStream fis = new FileInputStream(\"c:\\\\test.xls\");\nFileOutputStream fos = new FileOutputStream(\"c:\\\\test2.xls\");\nWorkbook wb = new HSSFWorkbook(fis); //or new XSSFWorkbook(\"/somepath/test.xls\")\nFormulaEvaluator evaluator = wb.getCreationHelper().createFormulaEvaluator();\nfor(int sheetNum = 0; sheetNum < wb.getNumberOfSheets(); sheetNum++) {\n    Sheet sheet = wb.getSheetAt(sheetNum);\n    for(Row r : sheet) {\n        for(Cell c : r) {\n            if(c.getCellType() == Cell.CELL_TYPE_FORMULA) {\n                System.out.println(c.getCellFormula().toString());\n                evaluator.evaluateFormulaCell(c);\n            }\n        }\n    }\n}\nwb.write(fos);\nfos.close();\nfis.close();\n\nI am getting an error at the above formula\n\nException in thread \"main\" java.lang.IllegalArgumentException: Unexpected ref arg class (org.apache.poi.ss.formula.LazyAreaEval)\n        at org.apache.poi.hssf.record.formula.eval.RangeEval.evaluateRef(RangeEval.java:62)\n        at org.apache.poi.hssf.record.formula.eval.RangeEval.evaluate(RangeEval.java:40)\n        at org.apache.poi.ss.formula.WorkbookEvaluator.invokeOperation(WorkbookEvaluator.java:394)\n        at org.apache.poi.ss.formula.WorkbookEvaluator.evaluateFormula(WorkbookEvaluator.java:329)\n        at org.apache.poi.ss.formula.WorkbookEvaluator.evaluateAny(WorkbookEvaluator.java:216)\n        at org.apache.poi.ss.formula.WorkbookEvaluator.evaluate(WorkbookEvaluator.java:180)\n        at org.apache.poi.hssf.usermodel.HSSFFormulaEvaluator.evaluateFormulaCellValue(HSSFFormulaEvaluator.java:297)\n        at org.apache.poi.hssf.usermodel.HSSFFormulaEvaluator.evaluate(HSSFFormulaEvaluator.java:159)\n        at poitest.Main.main(Main.java:41)\nJava Result: 1\n\nIs this a bug, or something I'm doing wrong?", "bug_id": 46948, "attachment_id": null, "id": 125923, "time": "2009-03-31T17:22:20Z", "creator": "kevinrmckee@hotmail.com", "creation_time": "2009-03-31T17:22:20Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 46948, "is_private": false, "id": 125935, "creation_time": "2009-04-01T12:50:43Z", "time": "2009-04-01T12:50:43Z", "creator": "josh@apache.org", "text": "Fixed in svn r761023 \n\njunit added\n\nPOI can now *evaluate* formulas which apply the range operator to area refs. (e.g. \"SUM((C1:D2):(D2:E3))\").  So the example code should run OK now.\n\n\nHowever, POI still cannot *parse* these formulas. For example, these calls will fail:\ncell.setCellFormula(\"AVERAGE(J6:OFFSET(I6,0,DAY(TODAY())-1))\");\ncell.setCellFormula(\"SUM((C1:D2):(D2:E3))\");\n\nBug 46951 has been opened to track this as a separate bug.", "attachment_id": null}]