[{"count": 0, "tags": [], "creator": "andreas@apache.org", "attachment_id": null, "text": "Load test:\n\n* 30 threads\n* 30s ramp up time\n* creation of 20 documents per thread\n\n7% of all first requests after creating the document returned 404 responses.\n\nI guess it is somehow related to the save/load cycle of the sitetree.", "id": 106697, "time": "2007-08-13T07:08:38Z", "bug_id": 43110, "creation_time": "2007-08-13T07:08:38Z", "is_private": false}, {"count": 1, "tags": [], "text": "Actually it turns out that, even if the loading time is after the saving time,\nthe new document is still not contained. Maybe File.renameTo() (which is used by\nFileSourceOutputStream.close) is asynchronous in the JVM?", "is_private": false, "id": 106698, "creator": "andreas@apache.org", "time": "2007-08-13T07:11:04Z", "bug_id": 43110, "creation_time": "2007-08-13T07:11:04Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 43110, "attachment_id": null, "id": 106734, "time": "2007-08-14T01:47:55Z", "creator": "andreas@apache.org", "creation_time": "2007-08-14T01:47:55Z", "is_private": false, "text": "There are stale sitetree repository nodes (logged when loading the sitetree):\n\nSocketListener0-4 ERROR lenya.site - xml rev:   27\nSocketListener0-4 ERROR lenya.site - save rev:  28\nSocketListener0-4 ERROR lenya.site - load rev:  27\nSocketListener0-4 ERROR lenya.site - save time: 1187080809460\nSocketListener0-4 ERROR lenya.site - load time: 1187080808874\n"}, {"count": 3, "tags": [], "bug_id": 43110, "attachment_id": null, "id": 106735, "time": "2007-08-14T01:52:53Z", "creator": "andreas@apache.org", "creation_time": "2007-08-14T01:52:53Z", "is_private": false, "text": "Maybe the stale nodes are holded in the pipeline cache. This is the stack trace\nwhere the stale node was loaded:\n\nSocketListener0-4 ERROR nodefactory.source - Load stack trace: \njava.lang.Exception\n        at\norg.apache.lenya.cms.repository.SourceWrapper.loadData(SourceWrapper.java:237)\n        at\norg.apache.lenya.cms.repository.SourceWrapper.exists(SourceWrapper.java:192)\n        at org.apache.lenya.cms.repository.SourceNode.exists(SourceNode.java:398)\n        at\norg.apache.lenya.cms.repository.SourceNode.getLastModified(SourceNode.java:415)\n        at\norg.apache.lenya.cms.cocoon.source.RepositorySource.getLastModified(RepositorySource.java:306)\n        at\norg.apache.lenya.cms.cocoon.source.RepositorySourceValidity.<init>(RepositorySourceValidity.java:37)\n        at\norg.apache.lenya.cms.cocoon.source.RepositorySource.getValidity(RepositorySource.java:400)\n        at\norg.apache.cocoon.generation.FileGenerator.getValidity(FileGenerator.java:102)\n        at\norg.apache.cocoon.components.pipeline.impl.AbstractCachingProcessingPipeline.getValidityForInternalPipeline(AbstractCachingProcessingPipeline.java:1061)"}, {"count": 4, "tags": [], "text": "The question is - why does the sitetree use this old session? Where does the\nsession survive from one request to the next?", "is_private": false, "id": 106738, "creator": "andreas@apache.org", "time": "2007-08-14T01:56:13Z", "bug_id": 43110, "creation_time": "2007-08-14T01:56:13Z", "attachment_id": null}, {"count": 5, "tags": [], "text": "When the session is not attached to the request (RepositoryUtil.getSession()),\nthe problem is gone. But this would be a bad option from a performance point of\nview.", "is_private": false, "id": 106740, "creator": "andreas@apache.org", "time": "2007-08-14T02:24:38Z", "bug_id": 43110, "creation_time": "2007-08-14T02:24:38Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 43110, "attachment_id": null, "id": 106741, "time": "2007-08-14T03:28:14Z", "creator": "andreas@apache.org", "creation_time": "2007-08-14T03:28:14Z", "is_private": false, "text": "The freshly created session for the request causes the 404:\n\nSession dae6cc30-4a50-11dc-8f29-82fadfa065ef created for request\n/default/authoring/index/Noticia5644.html\nSession dae6cc30-4a50-11dc-8f29-82fadfa065ef caused 404 for request\n/default/authoring/index/Noticia5644.html"}, {"count": 7, "tags": [], "bug_id": 43110, "attachment_id": null, "id": 106742, "time": "2007-08-14T03:30:48Z", "creator": "andreas@apache.org", "creation_time": "2007-08-14T03:30:48Z", "is_private": false, "text": "Maybe the sitetree was loaded into the SharedItemStore before the new request\nwas issued, so the new session uses a stale sitetree? That would mean that\neither the SharedItemStore was not properly cleaned after the previous session\nwas committed, or the nodes were not yet saved when the SharedItemStore was cleaned."}, {"count": 8, "tags": [], "bug_id": 43110, "attachment_id": null, "is_private": false, "id": 106745, "time": "2007-08-14T04:04:31Z", "creator": "andreas@apache.org", "creation_time": "2007-08-14T04:04:31Z", "text": "The sitetree repo node is from a different session, certainly via the\nSharedItemStore:\n\nSession e89867d0-4a55-11dc-ab05-d3038c2a02a9 created for request\n/default/authoring/index/Noticia4524.html\nSession e89867d0-4a55-11dc-ab05-d3038c2a02a9 caused 404 for request\n/default/authoring/index/Noticia4524.html\nSession db1a1ef0-4a55-11dc-ab05-d3038c2a02a9 is the site node session."}, {"count": 9, "tags": [], "bug_id": 43110, "attachment_id": null, "is_private": false, "id": 106746, "time": "2007-08-14T05:36:09Z", "creator": "andreas@apache.org", "creation_time": "2007-08-14T05:36:09Z", "text": "The SharedItemStore contains publications which have a SessionImpl instead of\nthe SharedItemStore ..."}, {"count": 10, "tags": [], "bug_id": 43110, "attachment_id": null, "id": 106752, "time": "2007-08-14T06:51:00Z", "creator": "andreas@apache.org", "creation_time": "2007-08-14T06:51:00Z", "is_private": false, "text": "(In reply to comment #9)\n> The SharedItemStore contains publications which have a SessionImpl instead of\n> the SharedItemStore ...\n\nThe apparent reason for this was that the PublicationFactory stored the session\nin a field."}, {"count": 11, "tags": [], "text": "Seems to be fixed.", "is_private": false, "id": 106753, "creator": "andreas@apache.org", "time": "2007-08-14T07:11:31Z", "bug_id": 43110, "creation_time": "2007-08-14T07:11:31Z", "attachment_id": null}]