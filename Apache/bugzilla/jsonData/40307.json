[{"count": 0, "tags": [], "bug_id": 40307, "attachment_id": null, "text": "I have a JSP page that contains a custom JSP tag nested within a custom JSP \nbody tag, which occurs after a jsp:include tag with flush=\"true\".  When an \nexception is thrown from the nested custom JSP tag, I don't see the error page \nassociated with the JSP page.  This problem is only reproducible in certain \ncircumstances, which I will explain below.\n\nI have reproduced it in Tomcat 5.5.17.\n\nHere is the code for the JSP page (nestedTagError.jsp):\n\n******************************************************************************\n<%@ taglib uri=\"/WEB-INF/tlds/testtagerrors.tld\" prefix=\"testtagerrors\"%>\n<%@ page errorPage=\"errors.jsp\"%>\n<html>\n<head>\n<title>\nNested Tag Page\n</title>\n</head>\n<body bgcolor=\"#ffffff\">\n\n<jsp:include page='included.jsp' flush=\"true\"/>\n\n<testtagerrors:simpleBufferedBodyTag>\n  <testtagerrors:noBodyTagWithError/>\n</testtagerrors:simpleBufferedBodyTag>\n<h1>\nNested Tag Page\n</h1>\n</body>\n</html>\n******************************************************************************\n\nThe noBodyTagWithError tag is the one that throws the error.  Here is the code \nfor the tag class:\n\n******************************************************************************\npackage testtagerrors;\n\nimport java.io.IOException;\n\nimport javax.servlet.jsp.tagext.TagSupport;\nimport javax.servlet.jsp.JspException;\n\npublic class NoBodyTagWithError extends TagSupport {\n    public int doStartTag() throws JspException {\n\n        if (true)\n            throw new RuntimeException(\"RuntimeException thrown from \nNoBodyTagWithError.doStartTag\");\n        \n        return SKIP_BODY;\n    }\n}\n******************************************************************************\n\nsimpleBufferedBodyTag is a body tag that buffers its contents and then writes \nthem out in the doAfterBody method:\n\n******************************************************************************\npackage testtagerrors;\n\nimport javax.servlet.jsp.tagext.*;\nimport javax.servlet.jsp.JspException;\nimport javax.servlet.jsp.JspWriter;\nimport java.io.IOException;\n\npublic class SimpleBufferedBodyTag extends BodyTagSupport {\n    public int doStartTag() throws JspException {\n        return EVAL_BODY_BUFFERED;\n    }\n\n    public int doAfterBody() throws JspException {\n        try {\n            JspWriter out = getPreviousOut();\n            BodyContent bodyContent = getBodyContent();\n            bodyContent.writeOut(out);\n            bodyContent.clearBody();\n        } catch (IOException ioe) {\n            throw new JspException (ioe);\n        }\n        return SKIP_BODY;\n    }\n}\n******************************************************************************\n\nincluded.jsp just contains some simple HTML content:\n\n******************************************************************************\n<br>\nSome included content.\n<br>\n******************************************************************************\n\nFinally, errors.jsp is a simple error page:\n\n******************************************************************************\n<%@ page isErrorPage=\"true\"%>\n<html>\n<head>\n<title>\nError Page\n</title>\n</head>\n<body bgcolor=\"#ffffff\">\n<h1>\nERROR\n</h1>\n<%= exception.getMessage() %>\n</body>\n</html>\n******************************************************************************\n\nWhen I request nestedTagError.jsp, I get the following output:\n\n******************************************************************************\n<html>\n<head>\n<title>\nNested Tag Page\n</title>\n</head>\n<body bgcolor=\"#ffffff\">\n******************************************************************************\n\nThis is rendered as a blank page in the browser.  I would expect to get:\n\n******************************************************************************\n<html>\n<head>\n<title>\nNested Tag Page\n</title>\n</head>\n<body bgcolor=\"#ffffff\">\n\n\n\n<html>\n<head>\n<title>\nError Page\n</title>\n</head>\n<body bgcolor=\"#ffffff\">\n<h1>\nERROR\n</h1>\nRuntimeException thrown from NoBodyTagWithError.doStartTag\n</body>\n</html>\n\n******************************************************************************\n\nThis is indeed what I get if I replace the simpleBufferedBodyTag in \nnestedTagError.jsp with anothyer custom JSP tag, simpleBodyTag, which has the \nfollowing code:\n\n******************************************************************************\npackage testtagerrors;\n\nimport javax.servlet.jsp.tagext.*;\nimport javax.servlet.jsp.JspException;\n\npublic class SimpleBodyTag extends BodyTagSupport {\n    public int doStartTag() throws JspException {\n        return EVAL_BODY_INCLUDE;\n    }\n}\n******************************************************************************\n\nAfter doing some testing, there are 4 conditions required to reproduce this \nbehavior:\n\n1) The tag that throws the error (noBodyTagWithError) must be nested\n2) inside a body tag that buffers its output\n3) and occurs after a jsp:include tag\n4) with flush=\"true\"\n\nIn other words, the error page will be shown if *any one* of these changes is \nmade:\n1) The noBodyTagWithError tag is moved outside the simpleBufferedBodyTag tag\n2) A non-buffering body tag (simpleBodyTag) is used in the place of \nsimpleBufferedBodyTag \n3) The jsp:include tag is omitted\n4) The jsp:include tag uses flush=\"false\"\n\nI can upload a complete .war file and all of the source code if necessary.  \nAlso, here are the .tld and web.xml files:\n\n******************************************************************************\n\n<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n\n<!DOCTYPE taglib\n        PUBLIC \"-//Sun Microsystems, Inc.//DTD JSP Tag Library 1.1//EN\"\n        \"http://java.sun.com/j2ee/dtds/web-jsptaglibrary_1_1.dtd\">\n\n<taglib>\n    <tlibversion>1.0</tlibversion>\n    <jspversion>1.1</jspversion>\n    <shortname>testTagErrorsTL</shortname>\n    <info>TestTagErrors Tag Library</info>\n    <tag>\n        <name>noBodyTagWithError</name>\n        <tagclass>testtagerrors.NoBodyTagWithError</tagclass>\n        <bodycontent>empty</bodycontent>\n    </tag>\n    <tag>\n        <name>simpleBodyTag</name>\n        <tagclass>testtagerrors.SimpleBodyTag</tagclass>\n        <bodycontent>JSP</bodycontent>\n    </tag>\n    <tag>\n        <name>simpleBufferedBodyTag</name>\n        <tagclass>testtagerrors.SimpleBufferedBodyTag</tagclass>\n        <bodycontent>JSP</bodycontent>\n    </tag>\n</taglib>\n\n******************************************************************************\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE web-app PUBLIC \"-//Sun Microsystems, Inc.//DTD Web Application \n2.3//EN\" \"http://java.sun.com/dtd/web-app_2_3.dtd\">\n<web-app>\n  <display-name>TestTagErrors</display-name>\n  <servlet>\n    <servlet-name>debugjsp</servlet-name>\n    <description>Added by JBuilder to compile JSPs with debug info</description>\n    <servlet-class>org.apache.jasper.servlet.JspServlet</servlet-class>\n    <init-param>\n      <param-name>classdebuginfo</param-name>\n      <param-value>true</param-value>\n    </init-param>\n    <load-on-startup>3</load-on-startup>\n  </servlet>\n  <servlet-mapping>\n    <servlet-name>debugjsp</servlet-name>\n    <url-pattern>*.jsp</url-pattern>\n  </servlet-mapping>\n</web-app>\n\n******************************************************************************", "id": 92480, "time": "2006-08-23T21:52:06Z", "creator": "zhangrusi@yahoo.com", "creation_time": "2006-08-23T21:52:06Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 40307, "attachment_id": 18748, "id": 92481, "time": "2006-08-23T22:05:31Z", "creator": "zhangrusi@yahoo.com", "creation_time": "2006-08-23T22:05:31Z", "is_private": false, "text": "Created attachment 18748\nA test case that should reproduce the issue on Tomcat 5.5.17."}, {"count": 2, "tags": [], "creator": "zhangzel@gmail.com", "attachment_id": 19263, "text": "Created attachment 19263\nthis is resolve file", "id": 96939, "time": "2006-12-15T06:03:26Z", "bug_id": 40307, "creation_time": "2006-12-15T06:03:26Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "funkman@joedog.org", "text": "Since flush=\"true\" on a include -  the respsone is committed. Error pages won't \nbe invoked correctly since the the requestDispather.forward() cannot work \ncorrectly once a response is committed.", "count": 3, "id": 96940, "time": "2006-12-15T06:35:31Z", "bug_id": 40307, "creation_time": "2006-12-15T06:35:31Z", "is_private": false}]