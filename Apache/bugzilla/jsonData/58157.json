[{"count": 0, "tags": [], "bug_id": 58157, "attachment_id": 32916, "text": "Created attachment 32916\nServlet which starts asynchronous processing and intentionally waits for a timeout before dispatching to a static HTML file.\n\nOverview:\nWhen repeatedly polling an asynchronous servlet which (intentionally) times out, I occasionally see the following exception in the console:\n\nJul 20, 2015 8:58:45 AM org.apache.catalina.connector.CoyoteAdapter checkRecycled\nINFO: Encountered a non-recycled request and recycled it forcedly.\norg.apache.catalina.connector.CoyoteAdapter$RecycleRequiredException\n\tat org.apache.catalina.connector.CoyoteAdapter.checkRecycled(CoyoteAdapter.java:590)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.recycle(AbstractHttp11Processor.java:1809)\n\tat org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.release(Http11NioProtocol.java:199)\n\tat org.apache.tomcat.util.net.NioEndpoint$Poller.cancelledKey(NioEndpoint.java:1100)\n\tat org.apache.tomcat.util.net.NioEndpoint$Poller.timeout(NioEndpoint.java:1466)\n\tat org.apache.tomcat.util.net.NioEndpoint$Poller.run(NioEndpoint.java:1234)\n\tat java.lang.Thread.run(Thread.java:745)\n\nThis coincides with a request not receiving any response.\n\nThe majority of times the servlet is called, the correct response is returned as expected once the request times out, however on occasion (sometimes within 1 min, sometimes not until 30 mins of successful requests have passed) I see this exception and AsyncListener.onTimeout() is never called to produce the response.\n\nSteps to reproduce:\n0) Configure Tomcat to use the NIO connector\n1) Deploy the attached TimeoutServlet (note: add a static HTML page 'timeout.html' to the root of the web application to serve as the timeout response).\n2) Using a tool of your choice (I used JMeter), repeatedly send a request to the servlet and wait for the timeout response before sending the next request.\n\nActual Results:\nEventually, one of the requests will receive no response and the above exception will be written to the console.\n\nExpected Results:\nEvery request should receive the timeout response (timeout.html) after 1 second and no exception should appear in the console.\n\nAdditional Information:\nAppears to be very similar to https://bz.apache.org/bugzilla/show_bug.cgi?id=57011.", "id": 184085, "time": "2015-07-20T13:32:13Z", "creator": "cg.throwaway@mailinator.com", "creation_time": "2015-07-20T13:32:13Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 58157, "attachment_id": null, "text": "Just to add: have also seen this issue in 7.0.63.", "id": 184086, "time": "2015-07-20T14:00:32Z", "creator": "cg.throwaway@mailinator.com", "creation_time": "2015-07-20T14:00:32Z", "is_private": false}, {"count": 2, "tags": [], "text": "Something that may take 30 minutes to reproduce is going to be pretty much impossible to debug. It looks like a rare timing problem. We can try and find it by code inspection but anything you can do to provide an easier to reproduce test case would be appreciated.", "attachment_id": null, "id": 184289, "creator": "markt@apache.org", "time": "2015-08-03T20:39:39Z", "bug_id": 58157, "creation_time": "2015-08-03T20:39:39Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 58157, "attachment_id": null, "text": "I think what you are seeing is a symptom of bug 57943 where the same socket ends up in the Poller twice. That would explain the stack trace you see.\n\nAre you able to build Tomcat 7.0.x from svn and test it? If not, you'll need to wait for the next 7.0.x release.\n\nI'm leaving this as NEEDINFO for now as we need to know if this issue is still reproducible with the current 7.0.x trunk.", "id": 184299, "time": "2015-08-04T13:05:29Z", "creator": "markt@apache.org", "creation_time": "2015-08-04T13:05:29Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 58157, "text": "Tried the test servlet on the latest Tomcat 7.0.x trunk build and still seeing the checkRecycled exceptions in the Tomcat console.", "id": 184405, "time": "2015-08-07T11:23:24Z", "creator": "cg.throwaway@mailinator.com", "creation_time": "2015-08-07T11:23:24Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 58157, "attachment_id": 32978, "text": "Created attachment 32978\nJMeter script that continuously does a GET on the test servlet and verifies the response is 200.", "id": 184407, "time": "2015-08-07T13:02:44Z", "creator": "cg.throwaway@mailinator.com", "creation_time": "2015-08-07T13:02:44Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 58157, "text": "For info - the checkRecycled exception was, on average, being generated within 1 minute of the JMeter script being run.", "count": 6, "id": 184408, "time": "2015-08-07T13:04:08Z", "creator": "cg.throwaway@mailinator.com", "creation_time": "2015-08-07T13:04:08Z", "is_private": false}, {"count": 7, "tags": [], "text": "Hi. Could you give 7.0.x trunk another try please. I've fixed an issue that might be the cause of this bug. I don't think it is but it is worth checking and I haven't been able to reproduce this yet.", "attachment_id": null, "id": 184478, "creator": "markt@apache.org", "time": "2015-08-11T20:40:16Z", "bug_id": 58157, "creation_time": "2015-08-11T20:40:16Z", "is_private": false}, {"count": 8, "attachment_id": null, "bug_id": 58157, "text": "Hi, built the latest 7.0.x trunk and tried it today. Still seeing the checkRecycled exception - first one 4 minutes after starting the JMeter script.\nI will upload the Tomcat logs if they help at all - I ran the JMeter script against the test servlet for an hour.", "id": 184494, "time": "2015-08-12T12:26:37Z", "creator": "cg.throwaway@mailinator.com", "creation_time": "2015-08-12T12:26:37Z", "tags": [], "is_private": false}, {"count": 9, "tags": [], "bug_id": 58157, "attachment_id": 32988, "text": "Created attachment 32988\nZip containing Tomcat 7.0.x logs after running JMeter script for an hour.", "id": 184495, "time": "2015-08-12T12:28:36Z", "creator": "cg.throwaway@mailinator.com", "creation_time": "2015-08-12T12:28:36Z", "is_private": false}, {"count": 10, "attachment_id": 32989, "bug_id": 58157, "text": "Created attachment 32989\nWAR file for servlet used to recreate this bug.\n\nAttaching the WAR file I have been running the JMeter script against.", "id": 184498, "time": "2015-08-12T12:38:04Z", "creator": "cg.throwaway@mailinator.com", "creation_time": "2015-08-12T12:38:04Z", "tags": [], "is_private": false}, {"count": 11, "tags": [], "bug_id": 58157, "text": "Another thing to note is that it takes much longer to reproduce this exception using a JavaScript client versus using JMeter (where it can be seen within a few minutes).\nThanks!", "id": 184500, "time": "2015-08-12T12:43:40Z", "creator": "cg.throwaway@mailinator.com", "creation_time": "2015-08-12T12:43:40Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 184525, "time": "2015-08-12T18:05:27Z", "bug_id": 58157, "creation_time": "2015-08-12T18:05:27Z", "is_private": false, "text": "Thanks for testing. I'll be taking another look at this over the next few days."}, {"count": 13, "tags": [], "bug_id": 58157, "attachment_id": null, "id": 184554, "time": "2015-08-13T19:58:44Z", "creator": "markt@apache.org", "creation_time": "2015-08-13T19:58:44Z", "is_private": false, "text": "Good news. I think I have managed to track down the root cause of this. It is a race condition between the Poller timing out the socket and new data arriving. I haven't - yet - figured out how to fix it.\n\nThe test case only triggered one failure in a hour for me but this is going to be *very* sensitive to timing so that isn't a surprise. I think I can trigger the correct execution sequence in a debugger so - assuming that is the case - I'll be able to confirm any fix fairly easily."}, {"count": 14, "tags": [], "bug_id": 58157, "attachment_id": null, "id": 184563, "creation_time": "2015-08-14T06:54:24Z", "time": "2015-08-14T06:54:24Z", "creator": "markt@apache.org", "text": "I've found and fixed a couple of concurrency issues that could have contributed to this but I'm still seeing the occassional failure.\n\nI haven't yet managed to reproduce the same exception with a debugger.\n\nInvestigations continue.", "is_private": false}, {"count": 15, "tags": [], "bug_id": 58157, "text": "Hi Mark, just thought I'd try out your latest update - still seeing the exception (as you have stated above). Thanks.", "id": 184566, "time": "2015-08-14T09:19:24Z", "creator": "cg.throwaway@mailinator.com", "creation_time": "2015-08-14T09:19:24Z", "is_private": false, "attachment_id": null}, {"count": 16, "attachment_id": null, "bug_id": 58157, "text": "A quick update before the weekend.\n\nI have better grip on what is going wrong. The issue is that async dispatches are being processed multiple times. Depending on the timing, this can go wrong.\n\nThe fix (for 7.0.x at least) is non-trivial. I've tried various small patches but all introduce a different problem. At this point, I think a reafctoring of the async dispatch handling will be required.\n\nI haven't looked at 9.0.x or 8.0.x as yet. The refactoring that has already taken place in those versions may have already addressed this. Or not.\n\nI'll continue to look at this next week.", "id": 184569, "time": "2015-08-14T21:38:49Z", "creator": "markt@apache.org", "creation_time": "2015-08-14T21:38:49Z", "tags": [], "is_private": false}, {"count": 17, "tags": [], "bug_id": 58157, "attachment_id": null, "id": 184589, "creation_time": "2015-08-17T07:37:49Z", "time": "2015-08-17T07:37:49Z", "creator": "markt@apache.org", "text": "I've spent some more time looking at this and - having found the 'right' place to fix this - the patch was actually fairly small.\n\nI have fixed the issue in 9.0.x, 8.0.x (for 8.0.25 onwards) and 7.0.x (for 7.0.64 onwards).", "is_private": false}, {"count": 18, "tags": [], "bug_id": 58157, "attachment_id": null, "text": "We have built the trunk and we can confirm that we haven't seen the bug appearing during our tests with the minimal servlet, and also with our full application.\n\nWe'll continue testing for more time but it's looking really good.\n\nThanks a lot for your help Thomas! Really appreciated!", "id": 184603, "time": "2015-08-17T13:47:16Z", "creator": "cg.throwaway@mailinator.com", "creation_time": "2015-08-17T13:47:16Z", "is_private": false}, {"count": 19, "tags": [], "bug_id": 58157, "text": "Sorry!. I meant to say Mark... or Mr.Thomas.... as you prefer :)", "id": 184604, "time": "2015-08-17T13:54:09Z", "creator": "cg.throwaway@mailinator.com", "creation_time": "2015-08-17T13:54:09Z", "is_private": false, "attachment_id": null}, {"count": 20, "tags": [], "bug_id": 58157, "attachment_id": null, "text": "I answer to most names - as long as they are polite ;)\n\nI did some local testing before committing this patch with the simple test case and didn't see any issues for over 15 hours so I'm reasonably confident that this issue is fixed. If your testing shows otherwise just re-open this issue.", "id": 184605, "time": "2015-08-17T14:05:11Z", "creator": "markt@apache.org", "creation_time": "2015-08-17T14:05:11Z", "is_private": false}]