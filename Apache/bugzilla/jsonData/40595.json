[{"count": 0, "tags": [], "bug_id": 40595, "text": "I get an error message when trying to run a junitreport task with todays \ncheckout of ant.\nIt worked until yesterdays checkout.\n\nError:\n[junitreport] Failed to process C:\\Documents and Settings\\Jan \nCumps\\sandbox_sf\\junitpdfreport\\build\\example_run\\themes\\brief\\generated\\TESTS-\nTestSuites.xml\nErrors while applying transformations: java.lang.IllegalStateException: zip \nfile closed\n\n\nIt's still too early to say, but it seems to happen when the junitreport task \nis called twice in during the same build.", "id": 94050, "time": "2006-09-24T18:38:18Z", "creator": "j_cumps@yahoo.com", "creation_time": "2006-09-24T18:38:18Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 40595, "attachment_id": 18904, "is_private": false, "id": 94052, "time": "2006-09-24T19:03:44Z", "creator": "j_cumps@yahoo.com", "creation_time": "2006-09-24T19:03:44Z", "text": "Created attachment 18904\nexample build file to show the issue"}, {"count": 2, "tags": [], "text": "It happens at the third call of junitreport.\nI've attached a build file that shows that it works for 2 calls, but fails for \n3 calls.\n\nThe target 2 calls junitreport 2 times, and succeeds.\n\n> ant 2\nBUILD SUCCESSFUL\n\nThe target 3 calls junitreport 3 times, and fails.\n\n> ant 3\nBUILD FAILED\nC:\\Documents and Settings\\Jan Cumps\\x\\build.xml:26: Errors while applying \ntransf\normations: java.lang.IllegalStateException: zip file closed\n\nTotal time: 1 second\n\n", "attachment_id": null, "bug_id": 40595, "id": 94053, "time": "2006-09-24T19:04:24Z", "creator": "j_cumps@yahoo.com", "creation_time": "2006-09-24T19:04:24Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 40595, "attachment_id": 18905, "is_private": false, "id": 94054, "time": "2006-09-24T19:06:35Z", "creator": "j_cumps@yahoo.com", "creation_time": "2006-09-24T19:06:35Z", "text": "Created attachment 18905\njunit result file used when replicating the bug\n\nPlace the build.xml and TESTS-TestSuites.xml in a directory.\n\nRun ant 2 (this will succeed)\nRun ant 3 (this will fail)."}, {"count": 4, "tags": [], "bug_id": 40595, "attachment_id": 18906, "is_private": false, "id": 94055, "time": "2006-09-24T19:17:33Z", "creator": "j_cumps@yahoo.com", "creation_time": "2006-09-24T19:17:33Z", "text": "Created attachment 18906\njunit result file used when replicating the bug\n\nAttached the original TEST-TestSuites.xml.\n\nIt seems that the junitreport task removes content from this file while\nrunning(see what happened to my previous, obsolete, attachment)."}, {"count": 5, "tags": [], "text": "I am not too sure if this is the problem\nbut your build file uses the same dir\nfor junitreport todir and the xml test reports.\n      <junitreport todir=\".\">           << -- here\n        <fileset dir=\".\">               << -- here\n          <include name=\"TEST-*.xml\"/>\n        </fileset>\n        <report format=\"noframes\" todir=\".\"/>\n      </junitreport>\n\nFrom my reading of junitreport, it makes a file\ncalled TESTS-TestSuites.xml from a number of  TESTS-*.xml\nfiles (Aggregates) and then transfroms this xml-file into\na html file.\n\nThis means that your use of the junitreport will open\nthe TEST-TestSuites.xml for input and for output - causing\ngrief.\n\n\nyou need to do something like:\n    <junitreport todir=\"${build.junit.reports}\">\n      <fileset dir=\"${build.junit.xml}\">\n        <include name=\"TEST-*.xml\"/>\n      </fileset>\n      <report format=\"frames\" todir=\"${build.junit.reports}\"/>\n    </junitreport>\n\ni.e have the outputs of <junit> task placed in ${build.junit.xml}\nand have the outputs of <junitreport> task placed in ${build.junit.reports}", "attachment_id": null, "id": 94057, "creator": "peterreilly@apache.org", "time": "2006-09-24T21:15:07Z", "bug_id": 40595, "creation_time": "2006-09-24T21:15:07Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 40595, "attachment_id": null, "is_private": false, "id": 94060, "time": "2006-09-25T04:51:05Z", "creator": "j_cumps@yahoo.com", "creation_time": "2006-09-25T04:51:05Z", "text": "My explanation was not very clear.\n\nI followed your instructions, placed the test\u00a7 files (TEST-\nnet.cars.engine.DelcoTest.xml, ...) into separate directory testresults,\nand let each junitreport task write both the aggregate file and the html file \nto a separate folder.\n\nThe error persists. I'm uploading a verbose log file, and the revised \nbuild.xml.\n"}, {"count": 7, "tags": [], "bug_id": 40595, "attachment_id": 18907, "is_private": false, "id": 94061, "time": "2006-09-25T04:54:50Z", "creator": "j_cumps@yahoo.com", "creation_time": "2006-09-25T04:54:50Z", "text": "Created attachment 18907\nRevised build file, taking in account  Peter's remarks\n\nI created a dir testresult to hold the original xml output from junit task (not\naggregated).\n\nI created dir testreporta to hold the results of the first junitreport call.\nI created dir testreportb to hold the results of the second junitreport call.\nI created dir testreportc to hold the results of the third junitreport call."}, {"attachment_id": 18908, "tags": [], "bug_id": 40595, "text": "Created attachment 18908\nVerbose Output from the run.\n\nVerbose Output from the run.", "count": 8, "id": 94062, "time": "2006-09-25T04:57:05Z", "creator": "j_cumps@yahoo.com", "creation_time": "2006-09-25T04:57:05Z", "is_private": false}, {"count": 9, "tags": [], "text": "Created attachment 18909\nVerbose error from the run.\n\nVerbose error from the run.", "attachment_id": 18909, "bug_id": 40595, "id": 94063, "time": "2006-09-25T04:57:42Z", "creator": "j_cumps@yahoo.com", "creation_time": "2006-09-25T04:57:42Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 40595, "attachment_id": null, "is_private": false, "id": 94073, "time": "2006-09-25T10:34:17Z", "creator": "antoine@apache.org", "creation_time": "2006-09-25T10:34:17Z", "text": "I am sure this bug report is due to changes I did recently in URLResource in an\nattempt to make sure that jar files opened with a jar:file: URL get closed\nproperly. The bit of code which I introduced in URLResource for this purpose\ncomes from Velocity. In Velocity, they have a special class called JarHolder\nthat Velocity uses to maintain an in memory map of all the jar files opened with\njar:file: URLs and close them all at the end of the run."}, {"count": 11, "tags": [], "creator": "j_cumps@yahoo.com", "text": "Antoine, you are right.\n\nWhen I revert the two last commits on URLResource (commit 448049 and 448452), \nand build ant using URLResource version of commit 439418, the error is gone.\n\n\nIt seems that the issue is introduced by commit 448049.", "id": 94088, "time": "2006-09-25T18:28:26Z", "bug_id": 40595, "creation_time": "2006-09-25T18:28:26Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 40595, "attachment_id": 18927, "is_private": false, "id": 94206, "time": "2006-09-28T07:44:18Z", "creator": "j_cumps@yahoo.com", "creation_time": "2006-09-28T07:44:18Z", "text": "Created attachment 18927\npatch for /ant/core/trunk/src/main/org/apache/tools/ant/types/resources/URLResource.java\n\nThe issue is caused by the closing of the resource in the finalyze() of\nURLResource.java.\n\nThere is also a call to close() in getSize(), but that does not cause this\nissue.\n\nAttached is  diff to the trunk (svn diff URLResource.java > 40595.diff).\nThis resolves the issue reported in this bug."}, {"count": 13, "tags": [], "creator": "j_cumps@yahoo.com", "text": "Comment on attachment 18927\npatch for /ant/core/trunk/src/main/org/apache/tools/ant/types/resources/URLResource.java\n\nThe conn = null line should stay.", "id": 94207, "time": "2006-09-28T07:51:28Z", "bug_id": 40595, "creation_time": "2006-09-28T07:51:28Z", "is_private": false, "attachment_id": 18927}, {"count": 14, "tags": [], "bug_id": 40595, "text": "Created attachment 18928\npatch for /ant/core/trunk/src/main/org/apache/tools/ant/types/resources/URLResource.java\n\nRevised patch.", "id": 94208, "time": "2006-09-28T07:52:42Z", "creator": "j_cumps@yahoo.com", "creation_time": "2006-09-28T07:52:42Z", "is_private": false, "attachment_id": 18928}, {"count": 15, "tags": [], "text": "Thanks Jan for providing a solution. I hope this works really. Regards. Antoine", "attachment_id": null, "id": 94235, "creator": "antoine@apache.org", "time": "2006-09-28T14:20:35Z", "bug_id": 40595, "creation_time": "2006-09-28T14:20:35Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 40595, "attachment_id": null, "is_private": false, "id": 94248, "time": "2006-09-28T18:57:27Z", "creator": "j_cumps@yahoo.com", "creation_time": "2006-09-28T18:57:27Z", "text": "Validated, and it works:\n\nchecked out trunk from svn.\nRan the test:\n\n>ant 3\nBuildfile: build.xml\n\ntesta:\n[junitreport] Processing C:\\Documents and Settings\\Jan \nCumps\\x\\testreporta\\TESTS\n-TestSuites.xml to C:\\Documents and Settings\\Jan Cumps\\x\\testreporta\\junit-\nnofra\nmes.html\n[junitreport] Loading stylesheet jar:file:/C:/sandbox_ant/ant/ant-\ntrunk/dist/lib\n/ant-junit.jar!/org/apache/tools/ant/taskdefs/optional/junit/xsl/junit-\nnoframes.\nxsl\n[junitreport] Transform time: 1156ms\n\ntestb:\n[junitreport] Processing C:\\Documents and Settings\\Jan \nCumps\\x\\testreportb\\TESTS\n-TestSuites.xml to C:\\Documents and Settings\\Jan Cumps\\x\\testreportb\\junit-\nnofra\nmes.html\n[junitreport] Loading stylesheet jar:file:/C:/sandbox_ant/ant/ant-\ntrunk/dist/lib\n/ant-junit.jar!/org/apache/tools/ant/taskdefs/optional/junit/xsl/junit-\nnoframes.\nxsl\n[junitreport] Transform time: 500ms\n\ntestc:\n[junitreport] Processing C:\\Documents and Settings\\Jan \nCumps\\x\\testreportc\\TESTS\n-TestSuites.xml to C:\\Documents and Settings\\Jan Cumps\\x\\testreportc\\junit-\nnofra\nmes.html\n[junitreport] Loading stylesheet jar:file:/C:/sandbox_ant/ant/ant-\ntrunk/dist/lib\n/ant-junit.jar!/org/apache/tools/ant/taskdefs/optional/junit/xsl/junit-\nnoframes.\nxsl\n[junitreport] Transform time: 406ms\n\n3:\n\nBUILD SUCCESSFUL\nTotal time: 3 seconds"}]