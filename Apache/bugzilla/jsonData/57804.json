[{"count": 0, "tags": [], "bug_id": 57804, "attachment_id": null, "id": 182312, "creation_time": "2015-04-10T20:15:50Z", "time": "2015-04-10T20:15:50Z", "creator": "vividhsv@gmail.com", "text": "Hi,\n\nWith the latest release of Jmeter 2.13, I see SSL handshake is being done for each sample HTTPS request, which suggests that the cached ssl context is not being used.\nFollowing properties is also set in the jmeter properties file.\nhttps.use.cached.ssl.context=true\n\nAs can be seen from the below log file, in 2.13 close is being called twice for 2 HTTPS samplers\n\n2.13 - dubug info of ssl connection\n1_11_PerfomanceTestSuite_SingleUser 1-1, called close()\n1_11_PerfomanceTestSuite_SingleUser 1-1, called closeInternal(true)\n1_11_PerfomanceTestSuite_SingleUser 1-1, SEND TLSv1.2 ALERT:  warning, description = close_notify\n1_11_PerfomanceTestSuite_SingleUser 1-1, called closeSocket(selfInitiated)\n1_11_PerfomanceTestSuite_SingleUser 1-1, called close()\n1_11_PerfomanceTestSuite_SingleUser 1-1, called closeInternal(true)\n1_11_PerfomanceTestSuite_SingleUser 1-1, SEND TLSv1.2 ALERT:  warning, description = close_notify\n1_11_PerfomanceTestSuite_SingleUser 1-1, called closeSocket(selfInitiated)\n\nAs can be seen from the below log file, in 2.11 close is being called once for HTTPS samplers\n2.11 - dubug info of ssl connection\n1_11_PerfomanceTestSuite_SingleUser 1-1, setSoTimeout(10000) called\n1_11_PerfomanceTestSuite_SingleUser 1-1, called close()\n1_11_PerfomanceTestSuite_SingleUser 1-1, called closeInternal(true)\n1_11_PerfomanceTestSuite_SingleUser 1-1, SEND TLSv1.2 ALERT:  warning, description = close_notify\n1_11_PerfomanceTestSuite_SingleUser 1-1, called closeSocket(selfInitiated)", "is_private": false}, {"count": 1, "tags": [], "bug_id": 57804, "attachment_id": null, "text": "Hi,\nCan you confirm you don'tget same behaviour with 2.12 ?\nCan you put jmeter in debug and send log file ?\n\nCan you attach your test plan ?\n\n\nThanks", "id": 182414, "time": "2015-04-15T21:43:01Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2015-04-15T21:43:01Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 57804, "is_private": false, "count": 2, "id": 182469, "time": "2015-04-18T12:29:08Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2015-04-18T12:29:08Z", "text": "Hi,\nI tested with 2.13 and it works for me.\nFor a Test Plan that runs 10  samples to same HTTPS URL and 1 user:\n- If I set https.use.cached.ssl.context=true, I get 1 handshake \n*** ServerHelloDone\n\n- If I set https.use.cached.ssl.context=false, I get 10 handshakes\n*** ServerHelloDone\n\nNote that you must use HTTPClient 4 or 3.1\n\nClosing as it works for me, feel free  to open with more details."}, {"count": 3, "tags": [], "bug_id": 57804, "attachment_id": null, "is_private": false, "id": 182948, "time": "2015-05-11T22:47:12Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2015-05-11T22:47:12Z", "text": "I just ran into the same problem and did a little analysis:\n\nIt happens with the HC4 sampler (don't know about the others) when used with client certs. HC4 uses a pool that compares two things to find an adequate connection: the HttpRoute (target host, proxies etc.) and a \"state\" Object.\n\nIf the state Object is null, then HC4 will only return a connection who's state is also null. If it is not null, the state of the connection must have the same state value. Now state is not something like closed or opened or so. Instead by default if no state is present, HC4 determines a state at the end of the request using a UserTokenHandler. The default UserTokenHandler will set the state of a connection at the end of the request to the value of the client cert used in the SSL session. But JMeter always requests a connection with null state value, so a previously used connection will never match,\n\nI don't have a fix ready, but since currently the requested state - null - and the state a connection is set to after use - the client cert - never matches, we either need to make sure, that we request a connection for the correct state, or that the state of a connection is not set or set to a stete we use when requesting the connection.\n\nExample:\n\nSet the state to something sensible before running the request: the state can be injected using\n\nlocalContext.setAttribute(ClientContext.USER_TOKEN, \"dummy\");\n\nin JMeter HTTPHC4Impl between creating localContext and calling executeRequest().\nHC4 will then take the state from the context and not try to determine it using the SSL Session. For the first request, a new connection has to be created and when it is released is will be branded using the provided state. Next time we need a connection, if we ask for the same state, we will get the same connection back. So if we have a good concept of the correct state Object, we could fix it that way.\n\nSo far for now."}, {"count": 4, "tags": [], "bug_id": 57804, "attachment_id": null, "is_private": false, "id": 182958, "time": "2015-05-12T13:49:12Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2015-05-12T13:49:12Z", "text": "@Vividh: are you also using client certificates?"}, {"count": 5, "tags": [], "bug_id": 57804, "attachment_id": null, "text": "Something like the key alias would be a good state object. Don't know whether that's easy to get and use in HTTPHC4Impl.", "id": 182959, "time": "2015-05-12T13:50:47Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2015-05-12T13:50:47Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 57804, "attachment_id": null, "id": 182960, "time": "2015-05-12T14:16:28Z", "creator": "vividhsv@gmail.com", "creation_time": "2015-05-12T14:16:28Z", "is_private": false, "text": "Yes, I am using client certs (self signed)."}, {"count": 7, "text": "Renaming to make the bug clearer.\nAlso removing the \"regression\" qualification as it does not appear to be a regression.", "bug_id": 57804, "is_private": false, "id": 187129, "time": "2015-12-26T22:51:52Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2015-12-26T22:51:52Z", "tags": [], "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 57804, "text": "Author: pmouawad\nDate: Sat Dec 26 23:06:17 2015\nNew Revision: 1721771\n\nURL: http://svn.apache.org/viewvc?rev=1721771&view=rev\nLog:\nBug 57804 - HTTP Request doesn't reuse cached SSL context when using Client Certificates in HTTPS\nBugzilla Id: 57804\n\nModified:\n    jmeter/trunk/src/protocol/http/org/apache/jmeter/protocol/http/sampler/HTTPHC4Impl.java\n    jmeter/trunk/xdocs/changes.xml", "count": 8, "id": 187130, "time": "2015-12-26T23:06:49Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2015-12-26T23:06:49Z", "is_private": false}, {"attachment_id": 33374, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "text": "Created attachment 33374\nTest plan used", "count": 9, "id": 187131, "time": "2015-12-26T23:12:41Z", "bug_id": 57804, "creation_time": "2015-12-26T23:12:41Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 57804, "text": "Created attachment 33375\nLogs of 3 test\n\nUsing the Test Plan , see the logs for:\n- 2.13\n- 2.14 pre fix\n- 2.14 post fix\n\nLog files are named using:\n- client-cert suffix relates to ClientCert being enabled / NoClientCert being disabled\n- no-client-cert suffix relates to ClientCert being disabled / NoClientCert being enabled", "id": 187132, "time": "2015-12-26T23:18:46Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2015-12-26T23:18:46Z", "is_private": false, "attachment_id": 33375}, {"count": 11, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": null, "id": 187260, "time": "2015-12-30T15:31:52Z", "bug_id": 57804, "creation_time": "2015-12-30T15:31:52Z", "is_private": false, "text": "Author: pmouawad\nDate: Wed Dec 30 15:26:19 2015\nNew Revision: 1722352\n\nURL: http://svn.apache.org/viewvc?rev=1722352&view=rev\nLog:\nFix NPE during recording\nBugzilla Id: 57804\n\nModified:\n    jmeter/trunk/src/protocol/http/org/apache/jmeter/protocol/http/sampler/HTTPHC4Impl.java"}]