[{"count": 0, "tags": [], "bug_id": 37355, "attachment_id": null, "text": "The apache reverse proxy tries to establish a https connecteion to the http\nproxy. This causes an error:\n  [info] SSL Proxy connect failed\n  [info] SSL Library Error: 336031996 error:140770FC:SSL\nroutines:SSL23_GET_SERVER_HELLO:unknown protocol\n\nConfiguration:\n  LoadModule proxy_module modules/mod_proxy.so\n  LoadModule proxy_connect_module modules/mod_proxy_connect.so\n  LoadModule proxy_http_module modules/mod_proxy_http.so\n  LoadModule ssl_module modules/mod_ssl.so\n\n  SSLProxyEngine On\n  ProxyRequests Off\n  ProxyRemote https://foo.org http://proxy.bar.org:8080\n  <Location /foo\n    ProxyPass https://foo.org\n    ProxyPassReverse https://foo.org\n  </Location>", "id": 82124, "time": "2005-11-04T11:52:08Z", "creator": "hendrik.harms@gmail.com", "creation_time": "2005-11-04T11:52:08Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 37355, "text": "The problem is the missing CONNECT Handshake. If a Proxy is defined\n(ProxyRemote) and the scheme to backend is HTTPS then a CONNECT has to be send\nto the proxy to open the proxy tunnel.", "id": 82512, "time": "2005-11-15T15:22:52Z", "creator": "hendrik.harms@gmail.com", "creation_time": "2005-11-15T15:22:52Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "text": "If I may take the patch from bug 19188, I am still missing a way to add a\nProxy-Authorization Header.\n\nnice to have:\n   ProxyRemote https://foo.org http://[<login>:<password>@]proxy.bar.org:8080\n\nThe \"<login>:<password>@\" should be an optional feature of the ProxyRemote\nconfig command.", "attachment_id": null, "id": 82860, "creator": "hendrik.harms@gmail.com", "time": "2005-11-25T10:37:43Z", "bug_id": 37355, "creation_time": "2005-11-25T10:37:43Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 37355, "attachment_id": 17448, "id": 84766, "time": "2006-01-19T08:15:09Z", "creator": "hendrik.harms@gmail.com", "creation_time": "2006-01-19T08:15:09Z", "is_private": false, "text": "Created attachment 17448\nProxyRemote extension\n\nThis patch based on apache-httpd version 2.0.55. It adds a new feature for the\nProxyRemote config item. It is now possible to set an optional \n<proxy-user:proxy-passwd@> prefix. This works with http and https backends.\n  ProxyRemote <protocol://backend-server[:port]>\n<protocol://[<proxy-user>:<proxy-passwd>@]<proxy-server[:port]>\nExample:\n  ProxyRemote https://foo.org http://user:passwd@bar.com:8080\n\nI could only test this patch with a BlueCoat and a Squid Proxy."}, {"count": 4, "tags": [], "text": "Created attachment 27977\nPatched ported to 2.2.x\n\nThis is the same thing, 5 years later.\nThis patch based on apache-httpd version 2.2.21. It adds a new feature for the\nProxyRemote config item. It is now possible to set an optional \n<proxy-user:proxy-passwd@> prefix. This works with http and https backends.\n  ProxyRemote <protocol://backend-server[:port]>\n<protocol://[<proxy-user>:<proxy-passwd>@]<proxy-server[:port]>\nExample:\n  ProxyRemote https://foo.org http://user:passwd@bar.com:8080\n\nI could only test this patch with a Squid Proxy.", "is_private": false, "id": 151730, "creator": "131.php@cloudyks.org", "time": "2011-11-22T22:40:33Z", "bug_id": 37355, "creation_time": "2011-11-22T22:40:33Z", "attachment_id": 27977}, {"count": 5, "tags": [], "bug_id": 37355, "text": "\nHello Fran\u00e7ois,\n\nI have rebuilt apache 2.2 with your patch, it works well for http request so useful, thank you. But my remote proxy sends me a 407 error (like if authentication was not provided) for the https requests. Here is my config for https vhost :\n\nNameVirtualHost *:443\n<VirtualHost *:443>\nServerName my.server.name\nSSLEngine on\nSSLProxyEngine on\nSSLVerifyClient none\nSSLCertificateFile \"/my/cert/file.crt\"\nSSLCertificateKeyFile \"/my/key/file.key\"\nProxyRemote https https://user:pass@proxyhost:80\nProxyPass / https://foreign.https.server/\nProxyPassReverse / https://foreign.https.server/\n</VirtualHost>\n\nI can see in apache logs :\n[error] send_http_connect: the forward proxy returned code is '407'\n\nand apache sends to the end browser a 503 error code.\n\nIs there something wrong in my config or do you have an idea regarding the patch ?\n\nThank you very much,\nJulien\n\n(In reply to comment #4)\n> Created attachment 27977 [details]\n> Patched ported to 2.2.x\n> \n> This is the same thing, 5 years later.\n> This patch based on apache-httpd version 2.2.21. It adds a new feature for the\n> ProxyRemote config item. It is now possible to set an optional \n> <proxy-user:proxy-passwd@> prefix. This works with http and https backends.\n>   ProxyRemote <protocol://backend-server[:port]>\n> <protocol://[<proxy-user>:<proxy-passwd>@]<proxy-server[:port]>\n> Example:\n>   ProxyRemote https://foo.org http://user:passwd@bar.com:8080\n> \n> I could only test this patch with a Squid Proxy.", "id": 158103, "time": "2012-04-16T08:47:59Z", "creator": "yoshee@meta-lan.net", "creation_time": "2012-04-16T08:47:59Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "creator": "intersat2@gmail.com", "attachment_id": 28815, "text": "Created attachment 28815\nA first (dirty but stable) stab at a port to 2.4.x.", "id": 159214, "time": "2012-05-22T12:28:03Z", "bug_id": 37355, "creation_time": "2012-05-22T12:28:03Z", "is_private": false}, {"count": 7, "tags": [], "creator": "hendrik.harms@gmail.com", "is_private": false, "text": "Created attachment 31121\npatch for modules/proxy of httpd-2.4.6\n\nYes it's me - 8 years later and still the same problem ;-)\nI took the last patch (thanks to intersat2, YosheE and Francois Leurent) and added some stuff to pass a HTTP Forward Proxy with HTTPS. By doing so I ran on an other problem (Bug 55892) also fixed by this patch.\n\nI only could test this patch on Linux passing through a Squid and a BlueCoat forward proxy", "id": 171780, "time": "2013-12-16T21:40:39Z", "bug_id": 37355, "creation_time": "2013-12-16T21:40:39Z", "attachment_id": 31121}, {"count": 8, "tags": [], "bug_id": 37355, "text": "Created attachment 32361\npatch for modules/proxy of httpd-2.4.10\n\nPatch adapted to httpd-2.4.10\nThis patch includes also the patch for Bug 55892 and the patch for Bug 57138", "id": 180251, "time": "2015-01-10T16:47:17Z", "creator": "hendrik.harms@gmail.com", "creation_time": "2015-01-10T16:47:17Z", "is_private": false, "attachment_id": 32361}, {"count": 9, "tags": [], "creator": "hendrik.harms@gmail.com", "is_private": false, "text": "there is a typo in my last comment: wrong: Bug 57138 -\ncorrect: the patch of Bug 57139 was included into my last patch 32361.", "id": 180252, "time": "2015-01-10T16:52:19Z", "bug_id": 37355, "creation_time": "2015-01-10T16:52:19Z", "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 37355, "attachment_id": null, "text": "Hello:\n\nI have the same problem in a server in which we are using a squid, the version of the apache is 2.2.14. My Operating System is SLES 11 SP3, can i apply the patch uploaded by Francois Leurent, or there is another?\n\nMany Thanks!\nVictor", "id": 181916, "time": "2015-03-19T23:55:25Z", "creator": "victor_amrich@hotmail.com", "creation_time": "2015-03-19T23:55:25Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 37355, "attachment_id": 32670, "is_private": false, "id": 182522, "time": "2015-04-21T08:56:33Z", "creator": "somebody.here@gmx.de", "creation_time": "2015-04-21T08:56:33Z", "text": "Created attachment 32670\nmod_proxy 2.4.12 error_log\n\nHi Hendrik,\n\nI applied your patch for 2.4.10. and still observe a strange behavior in our scenario:\n\nclient -> mod_proxy 2.4.12 -> squid -> IIS 8.5\n\nHere's my config:\n\nLogLevel debug\n<VirtualHost *:80>\nServerName my.server.name\nSSLProxyEngine on\nSSLProxyCheckPeerCN off\nSSLProxyCheckPeerName off\nProxyRemote https http://proxyhost:8080\nProxyPass / https://foreign.https.server/\nProxyPassReverse / https://foreign.https.server/\n</VirtualHost>\n\nEvery request after 120 sec idle returns a HTTP 502. Subsequent connections work as expected, if there is no delay of >120 sec.\n\nerror_log content attachment.\n\nSuggestions very appreciated.\n\nMany Thanks,\nMichael"}, {"count": 12, "tags": [], "bug_id": 37355, "attachment_id": null, "is_private": false, "id": 182549, "time": "2015-04-22T08:55:08Z", "creator": "hendrik.harms@gmail.com", "creation_time": "2015-04-22T08:55:08Z", "text": "(In reply to Michael G\u00f6hler from comment #11)\n> \n> client -> mod_proxy 2.4.12 -> squid -> IIS 8.5\n> \n> ProxyRemote https http://proxyhost:8080\n>\n\nYou don't need this patch for your setup - no user/password is configured in ProxyRemote. Only the patches of Bug 57139 and may be of Bug 55892 are needed for your setup.\n\n> \n> Every request after 120 sec idle returns a HTTP 502. Subsequent connections\n> work as expected, if there is no delay of >120 sec.\n> \n\nThe 502 usually indicates a problem during establishing the TCP connection. What does the squid do with idle connections? Do you have a firewall in your setup or other routing devices dropping their routing informations without TCP-close after an idle timeout?"}, {"count": 13, "tags": [], "text": "(In reply to Hendrik Harms from comment #12)\n\nThanks for your reply!\n\n> You don't need this patch for your setup - no user/password is configured in\n> ProxyRemote. Only the patches of Bug 57139 and may be of Bug 55892 are\n> needed for your setup.\n\nI know. It was just the easiest way to combine both.\n\n> The 502 usually indicates a problem during establishing the TCP connection.\n> What does the squid do with idle connections? Do you have a firewall in your\n> setup or other routing devices dropping their routing informations without\n> TCP-close after an idle timeout?\n\nI have a 120 sec. timeout on squid which matches what we see.\n\nThe Apache correctly identifies the connection as stale and reestablishes it.\nAH00951: HTTPS: backend socket is disconnected.\nAH00949: send_http_connect: response from the forward proxy: HTTP/1.0 200 Connection established\n\nIt seams to be an SSL handshake issue, as\n\nthe second request logs:\n[ssl:info] AH01964: Connection to child 0 established (server my.server.name:80)\n[ssl:debug] ssl_engine_kernel.c(1378): AH02275: Certificate Verification ...\n\nwhile the first logs:\n[ssl:info] AH01964: Connection to child 0 established (server my.server.name:80)\n[ssl:info] AH02003: SSL Proxy connect failed\n\nI'll go for some LogLevel=trace3 logs, as the error seams to happen in SSL_connect().\n\nJust a side-note:\nAre you aware of the discussion in Bug 55892? They decided to go without the force-proxy-request-1.0 condition, which is still part of your patch.", "attachment_id": null, "id": 182616, "creator": "somebody.here@gmx.de", "time": "2015-04-24T15:03:01Z", "bug_id": 37355, "creation_time": "2015-04-24T15:03:01Z", "is_private": false}, {"count": 14, "attachment_id": null, "bug_id": 37355, "text": "(In reply to Michael G\u00f6hler from comment #13)\n\nSolved my issue using\nSetEnv proxy-nokeepalive 1\nSetEnv proxy-initial-not-pooled 1", "id": 182688, "time": "2015-04-28T11:33:44Z", "creator": "somebody.here@gmx.de", "creation_time": "2015-04-28T11:33:44Z", "tags": [], "is_private": false}, {"count": 15, "tags": [], "bug_id": 37355, "attachment_id": null, "id": 184213, "time": "2015-07-28T21:46:28Z", "creator": "wrowe@apache.org", "creation_time": "2015-07-28T21:46:28Z", "is_private": false, "text": "Hello again Hendrik.\n\nGlad we were able to get PR 55892 addressed now in 2.4 (and 2.2).\n\nAIUI the patch above (2015-01-10) addressed both https: CONNECT remoteing as well as auth.  I would expect some redundancy/collision there?\n\nLooking at the changes, I'm uncertain of whether the group would entertain any API changes to mod_proxy.h for feature enhancements such as changing the args list for auth. Third party module authors need binary stability between subversion releases, and that would include those writing any mod_proxy framework participants.\n\nIf there was a way to store/pass this info without altering the API, it's much more likely to be applied to 2.4.  I was prepared to refactor your patch for trunk/2.4.16 changes to eliminate duplication of PR 55892 concerns, and commit to trunk, but I'm looking for your thoughts before proceeding.  Thank you for the submissions and for fighting the good fight of getting these changes into httpd!"}, {"count": 16, "attachment_id": null, "bug_id": 37355, "text": "(In reply to William A. Rowe Jr. from comment #15)\n\n> Glad we were able to get PR 55892 addressed now in 2.4 (and 2.2).\nThank you for this - I have already found it in 2.4.16 :-)\n \n> AIUI the patch above (2015-01-10) addressed both https: CONNECT remoteing as\n> well as auth.  I would expect some redundancy/collision there?\nI don't see a redundancy or collision between CONNECT remote an proxy authentication.\nI've build this patch because I need a setup discribed in Bug 55892:\nThe backend of my apache reverse proxy is place behind a http forward proxy. This forward proxy requires a proxy authentication (HTTP-407) and the backend requires https. The clients sending requests to my reverse proxy should not know anything about this setup especially the needed proxy authentication. This should be covered by the reverse proxy.\nAs described somethere in the RFCs it should be possible to configure the proxy authentication as a hop-to-hop header. So the ReverseProxy should be able to authenticate itself to the forward proxy.\nA forward proxy could be defined by the ProxyRemote config directive. So I thought it was a good idea to enhance this config directive by an optional authentication prefix [<user>:<password>@]\n\n> Looking at the changes, I'm uncertain of whether the group would entertain\n> any API changes to mod_proxy.h for feature enhancements such as changing the\n> args list for auth. Third party module authors need binary stability between\n> subversion releases, and that would include those writing any mod_proxy\n> framework participants.\nYes, unfortunately my patch will kill the compatibility of some third party modules :-(\nBut I think best place to store and transfer this authentication info should be very close to the other attributes defining the forward proxy (hostname, port, ... + auth), because they belong together. \n \n> If there was a way to store/pass this info without altering the API, it's\n> much more likely to be applied to 2.4. \nIf the API change is not possible in 2.4 we should flag it for 2.6 and think about a workaround in 2.4\n\n> I was prepared to refactor your\n> patch for trunk/2.4.16 changes to eliminate duplication of PR 55892\n> concerns, and commit to trunk, but I'm looking for your thoughts before\n> proceeding.  Thank you for the submissions and for fighting the good fight\n> of getting these changes into httpd!\nHTH - never give up ;-)", "id": 184250, "time": "2015-07-31T10:02:43Z", "creator": "hendrik.harms@gmail.com", "creation_time": "2015-07-31T10:02:43Z", "tags": [], "is_private": false}, {"count": 17, "tags": [], "creator": "hendrik.harms@gmail.com", "attachment_id": 32948, "text": "Created attachment 32948\npatch for modules/proxy of httpd-2.4.16\n\nPatches for Bug 55892 and Bug Bug 57139 are applied to 2.4.16 - so they are not part of this patch anymore.", "id": 184251, "time": "2015-07-31T10:42:57Z", "bug_id": 37355, "creation_time": "2015-07-31T10:42:57Z", "is_private": false}, {"count": 18, "tags": [], "bug_id": 37355, "attachment_id": null, "text": "Thank you for the revised patch.  It is easier for the core developers to read a small dedicated patch that addresses just a single issue at a time, even if that means there is a set of several patches to get to the desired outcome.\n\nHere's one proposal that wouldn't require API changes.\n\nIf we added a 407 handler extension of some sort, we would be able to handle specific backend challenges for auth credentials in a unified way.  If we stored the credentials in an auth challenge table, we could eventually support other auth methods, including digest or even cookie based auth.\n\nThe syntax of the ProxyRemote directive still changes, but the scheme://host would be split from the auth user:pass and stored in two different mechanisms.\n\nThe only downside is whether users in practice would want to identify a particular proxy use by use case.  While we can keep different stores of auth tupples by virtual host, further differentiation might prove troublesome.\n\nThoughts?", "id": 184395, "time": "2015-08-06T20:31:28Z", "creator": "wrowe@apache.org", "creation_time": "2015-08-06T20:31:28Z", "is_private": false}, {"count": 19, "tags": [], "bug_id": 37355, "text": "Apologies for the ignorance here, after googling I came across this patch and it is exactly what I need....but how do I get this change into my mod_proxy.so file??", "id": 185308, "time": "2015-09-17T09:37:54Z", "creator": "owensy83@gmail.com", "creation_time": "2015-09-17T09:37:54Z", "is_private": false, "attachment_id": null}, {"count": 20, "tags": [], "bug_id": 37355, "attachment_id": 34271, "id": 193797, "time": "2016-09-19T07:10:05Z", "creator": "hendrik.harms@gmail.com", "creation_time": "2016-09-19T07:10:05Z", "is_private": false, "text": "Created attachment 34271\npatch for modules/proxy of httpd-2.4.23"}, {"count": 21, "tags": [], "bug_id": 37355, "attachment_id": null, "id": 193798, "time": "2016-09-19T07:12:48Z", "creator": "hendrik.harms@gmail.com", "creation_time": "2016-09-19T07:12:48Z", "is_private": false, "text": "Pardon - it's still the same kind of patch like those before"}, {"count": 22, "tags": [], "creator": "info-bz-apache@ch2o.info", "is_private": false, "text": "adding proxy credential in proxyremote make possible to chaine proxy with differente authentication from front to back in chaining proxy and make possible to use authenticated proxy on backend proxy...\n\nwhen they are integrated in last http 2.4 version?", "id": 195687, "time": "2016-12-28T18:26:23Z", "bug_id": 37355, "creation_time": "2016-12-28T18:26:23Z", "attachment_id": null}]