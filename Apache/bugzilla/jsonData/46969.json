[{"count": 0, "tags": [], "bug_id": 46969, "attachment_id": null, "id": 126007, "time": "2009-04-05T06:44:05Z", "creator": "evanc@nortel.com", "creation_time": "2009-04-05T06:44:05Z", "is_private": false, "text": "CustomLog format %m is always GET in an error condition when the error message is provided by a local ErrorDocument.  %m is correct for a successful connection.  %m is also correct with ErrorDocument disabled.\n\nThe local ErrorDocument is a .shtml with server-side includes enabled.  REQUEST_METHOD as reported by printenv in the .shtml is also GET.  The original method is stored in REDIRECT_REQUEST_METHOD.  I tried to log\n\"%<m\" instead to get the original request's method, but that also logged\nGET instead of the original method.\n\nRunning Apache 2.2.11 as forward proxy server, with mod_proxy, mod_proxy_http and mod_proxy_connect.  Problem can be duplicated with HEAD and CONNECT requests to unavailable/invalid URLs."}, {"count": 1, "tags": [], "creator": "nick@webthing.com", "attachment_id": null, "text": "I am able to reproduce part of this: namely GET is always shown as REQUEST_METHOD in a .shtml errordocument.  However, my access log always shows the original method, as expected.  That's with a 404.shtml errordocument.\n\nCan you post a configuration extract and request that'll demonstrate this?", "id": 129855, "time": "2009-08-22T18:47:57Z", "bug_id": 46969, "creation_time": "2009-08-22T18:47:57Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 46969, "attachment_id": null, "id": 130174, "time": "2009-09-06T21:32:09Z", "creator": "evanc@nortel.com", "creation_time": "2009-09-06T21:32:09Z", "is_private": false, "text": "(In reply to comment #1)\n> I am able to reproduce part of this: namely GET is always shown as\n> REQUEST_METHOD in a .shtml errordocument.  However, my access log always shows\n> the original method, as expected.  That's with a 404.shtml errordocument.\n> \n> Can you post a configuration extract and request that'll demonstrate this?\n\nSorry for the delay.  Here is a short configuration that demonstrates this:\n\nUser nobody\nGroup nobody\nLogFormat \"%t %m %U%q %>s\" access_log\nCustomLog \"logs/access_log\" access_log\nErrorLog \"logs/error_log\"\nLogLevel crit\n\nDefaultType text/plain\nAddType text/html .shtml\nAddOutputFilter INCLUDES .shtml\nErrorDocument 400 /error/template.shtml\nErrorDocument 403 /error/template.shtml\nErrorDocument 404 /error/template.shtml\nErrorDocument 502 /error/template.shtml\nErrorDocument 503 /error/template.shtml\n\n<Directory />\n        AllowOverride None\n        Deny from all\n</Directory>\n\nDocumentRoot \"/usr/local/apache/htdocs\"\n<Directory \"/usr/local/apache/htdocs/error\">\n        Options IncludesNoExec\n        Allow from all\n</Directory>\n\nProxyRequests On\nListen 8080\n<Proxy *>\n        Deny from all\n</Proxy>\n\nServer version: 2.2.13\n\nRequest via proxy: https://doesnotexist.mycompany.com/ (CONNECT doesnotexist.mycompany.com:443)\nAccess log result:\n[07/Sep/2009:04:00:01 +0000] GET doesnotexist.mycompany.com:443 403\n\nRequest via proxy: HEAD http://doesntoexist.mycompany.com/\nAccess log result:\n[07/Sep/2009:04:13:03 +0000] GET http://doesnotexist.ca.nortel.com/ 403\n\nIn either case, GET is logged instead of CONNECT.\n\nThanks very much for your help.\n\nEvan"}, {"count": 3, "tags": [], "bug_id": 46969, "is_private": false, "id": 198857, "creation_time": "2017-05-23T14:35:22Z", "time": "2017-05-23T14:35:22Z", "creator": "petar@smokva.net", "text": "ErrorDocuments are delivered through internal redirects so we end up\nwith two requests, the original (POST) and the new request (GET).\n\nWhen resolving REQUEST_METHOD, you should try to resolve the original\nREQUEST_METHOD (which would be %<{REQUEST_METHOD}e in mod_log_config\nlingo).  Otherwise it will always resolve to \"GET\" in case of internal\nredirects to some ErrorDocument.\n\nIt's different with %m, %m will always be \"GET\" by design:\n\nhttpd-2.4.25/modules/http/http_request.c:\n188     else if (custom_response[0] == '/') {\n189         const char *error_notes;\n190         r->no_local_copy = 1;       /* Do NOT send HTTP_NOT_MODIFIED for\n191                                      * error documents! */\n192         /*\n193          * This redirect needs to be a GET no matter what the original\n194          * method was.\n195          */\n196         apr_table_setn(r->subprocess_env, \"REQUEST_METHOD\", r->method);\n197 \n198         /*\n199          * Provide a special method for modules to communicate\n200          * more informative (than the plain canned) messages to us.\n201          * Propagate them to ErrorDocuments via the ERROR_NOTES variable:\n202          */\n203         if ((error_notes = apr_table_get(r->notes,\n204                                          \"error-notes\")) != NULL) {\n205             apr_table_setn(r->subprocess_env, \"ERROR_NOTES\", error_notes);\n206         }\n207         r->method = \"GET\";\n208         r->method_number = M_GET;\n209         ap_internal_redirect(custom_response, r);\n210         return;\n211     }\n\nHere, apr_die_r saves the original method into REQUEST_METHOD before\nresetting method/method_number to \"GET\"/M_GET and the comment before\napr_table_setn indicates that this is done on purpose.\n\nSo if you need the original method, use %<{REQUEST_METHOD}e instead of %m.", "attachment_id": null}]