[{"count": 0, "tags": [], "creator": "calestyo@scientia.net", "attachment_id": null, "is_private": false, "id": 153628, "time": "2012-02-09T15:29:04Z", "bug_id": 52631, "creation_time": "2012-02-09T15:29:04Z", "text": "Hi.\n\nI've noticed the following problem, which happens at least with Firefox and Chromium as clients.\n\nI'm using SSL with SNI.\n\nThere is a default name based virtual host, with it's own hostname and corresponding certificate as well as non-default name based vhosts with own hostname and certs.\n\nSSL client authentication is disabled.\n\nWhen I have a freshly started apache2 and access the non-default vhost via SSL/SNI the first time this fails and apache actually takes the default vhost and also delivers the server cert of that to the client (which is the reason why it fails - well at least from a SSL point of view).\n\nWhen I click reload in the browser it works from then on (I'm not sure if it works really infinitely from then on,.. there might have been cases where it happened again after some time... so perhaps there is some caching issue?!).\n\n\nThis is reproducible, when restarting apache again,.. it happens again (the first time).\n\n\nCheers,\nChris."}, {"count": 1, "tags": [], "text": "Can't reproduce, and this looks like a fairly standard SNI use case.\n\nPlease read https://issues.apache.org/bugwritinghelp.html, and if you really think it's not an issue with your particular setup, then provide specific information about how to reproduce, and be more specific about what \"SSL / SNI accesses don't work\" means in your case (error messages in the httpd log, browser etc.).", "attachment_id": null, "bug_id": 52631, "id": 153679, "time": "2012-02-11T06:49:10Z", "creator": "asfbugz@velox.ch", "creation_time": "2012-02-11T06:49:10Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 52631, "attachment_id": null, "id": 153900, "time": "2012-02-18T00:39:04Z", "creator": "calestyo@scientia.net", "creation_time": "2012-02-18T00:39:04Z", "is_private": false, "text": "First, please don't blindly close my bugs, just YOU cannot reproduce them immediately.\nIf I'd abandon a bug report and wouldn't answer on it for a  longer time (> weeks) than it's ok to do this without being impolite.\n\n\nThe description seems rather clear to me:\nRestart Apache,... SNI doesn't work on the first access.\nAccessing again,... and it works from then on.\n\nSeems not to difficult to be understood, right?\n\n\nAll what I can do IMHO, is giving you my whole configuration suite,.. if that helps...\nIf you cannot reproduce it with it, then it may be some problem in the packages of my distro (which sounds rather unlikely to me) or some bad interaction between some library versions or so.\n\n\nIt could actually be also a problem in the browser, but then it would have to be a bug in both, Firefox and Chromium."}, {"count": 3, "tags": [], "creator": "calestyo@scientia.net", "attachment_id": null, "text": "Is there an easy way to catch what the browsers send as SNI hostname?", "id": 153901, "time": "2012-02-18T00:40:20Z", "bug_id": 52631, "creation_time": "2012-02-18T00:40:20Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 52631, "attachment_id": null, "id": 153906, "time": "2012-02-18T02:58:56Z", "creator": "calestyo@scientia.net", "creation_time": "2012-02-18T02:58:56Z", "is_private": false, "text": "Some more on this...\n\nThe following is from the server wide error log (not from the vhost's)...\n\nWhen playing the game (i.e. opening the site in the browser, restarting apache, reloading it - which gives the wrong certificate then, namely that of the default vhost)...\n\n...with Chromium:\nSat Feb 18 03:52:27 2012] [info] [client 91.8.39.109] (70014)End of file found: SSL handshake interrupted by system [Hint: Stop button pressed in browser?!]\n[Sat Feb 18 03:52:27 2012] [info] [client 91.8.39.109] Connection closed to child 132 with abortive shutdown (server b.http.srv.scientia.net:443)\n[Sat Feb 18 03:52:27 2012] [info] [client 91.8.39.109] (70014)End of file found: SSL handshake interrupted by system [Hint: Stop button pressed in browser?!]\n[Sat Feb 18 03:52:27 2012] [info] [client 91.8.39.109] Connection closed to child 64 with abortive shutdown (server b.http.srv.scientia.net:443)\n[Sat Feb 18 03:52:27 2012] [info] [client 91.8.39.109] (70014)End of file found: SSL handshake interrupted by system [Hint: Stop button pressed in browser?!]\n[Sat Feb 18 03:52:27 2012] [info] [client 91.8.39.109] Connection closed to child 21 with abortive shutdown (server b.http.srv.scientia.net:443)\n[Sat Feb 18 03:52:27 2012] [info] [client 91.8.39.109] (70014)End of file found: SSL handshake interrupted by system [Hint: Stop button pressed in browser?!]\n[Sat Feb 18 03:52:27 2012] [info] [client 91.8.39.109] Connection closed to child 133 with abortive shutdown (server b.http.srv.scientia.net:443)\n[Sat Feb 18 03:52:27 2012] [info] [client 91.8.39.109] (70014)End of file found: SSL handshake interrupted by system [Hint: Stop button pressed in browser?!]\n[Sat Feb 18 03:52:27 2012] [info] [client 91.8.39.109] Connection closed to child 65 with abortive shutdown (server b.http.srv.scientia.net:443)\n[Sat Feb 18 03:52:27 2012] [info] [client 91.8.39.109] (70014)End of file found: SSL handshake interrupted by system [Hint: Stop button pressed in browser?!]\n[Sat Feb 18 03:52:27 2012] [info] [client 91.8.39.109] Connection closed to child 12 with abortive shutdown (server b.http.srv.scientia.net:443)\n\n(of course I did not press a stop button)\n\n\n\nWith Firefox:\n[Sat Feb 18 03:53:59 2012] [info] [client 91.8.39.109] Connection to child 132 established (server b.http.srv.scientia.net:443)\n[Sat Feb 18 03:53:59 2012] [info] Seeding PRNG with 1312 bytes of entropy\n[Sat Feb 18 03:53:59 2012] [info] [client 91.8.39.109] SSL library error 1 in handshake (server b.http.srv.scientia.net:443)\n[Sat Feb 18 03:53:59 2012] [info] SSL Library Error: 336151570 error:14094412:SSL routines:SSL3_READ_BYTES:sslv3 alert bad certificate Subject CN in certificate not server name or identical to CA!?\n[Sat Feb 18 03:53:59 2012] [info] [client 91.8.39.109] Connection closed to child 132 with abortive shutdown (server b.http.srv.scientia.net:443)\n\n\nThe vhost's error log shows basically just those messages:\n[Sat Feb 18 03:53:37 2012] [info] Configuring server for SSL protocol\n[Sat Feb 18 03:53:37 2012] [info] RSA server certificate enables Server Gated Cryptography (SGC)\n[Sat Feb 18 03:53:42 2012] [info] Initial (No.1) HTTPS request received for child 132 (server alpa-hydraulik-verladetechnik.de:443)\n[Sat Feb 18 03:53:42 2012] [info] Subsequent (No.2) HTTPS request received for child 132 (server alpa-hydraulik-verladetechnik.de:443)\n[Sat Feb 18 03:53:42 2012] [info] Initial (No.1) HTTPS request received for child 64 (server alpa-hydraulik-verladetechnik.de:443)\n[Sat Feb 18 03:53:42 2012] [info] Initial (No.1) HTTPS request received for child 21 (server alpa-hydraulik-verladetechnik.de:443)\n[Sat Feb 18 03:53:42 2012] [info] Initial (No.1) HTTPS request received for child 133 (server alpa-hydraulik-verladetechnik.de:443)\n[Sat Feb 18 03:53:42 2012] [info] Initial (No.1) HTTPS request received for child 65 (server alpa-hydraulik-verladetechnik.de:443)\n[Sat Feb 18 03:53:42 2012] [info] Subsequent (No.2) HTTPS request received for child 65 (server alpa-hydraulik-verladetechnik.de:443)\n[Sat Feb 18 03:53:42 2012] [info] Subsequent (No.3) HTTPS request received for child 132 (server alpa-hydraulik-verladetechnik.de:443)\n[Sat Feb 18 03:53:42 2012] [info] Subsequent (No.2) HTTPS request received for child 133 (server alpa-hydraulik-verladetechnik.de:443)\n[Sat Feb 18 03:53:42 2012] [info] Subsequent (No.2) HTTPS request received for child 64 (server alpa-hydraulik-verladetechnik.de:443)\n[Sat Feb 18 03:53:55 2012] [info] Loading certificate & private key of SSL-aware server\n[Sat Feb 18 03:53:55 2012] [info] Configuring server for SSL protocol\n[Sat Feb 18 03:53:55 2012] [info] RSA server certificate enables Server Gated Cryptography (SGC)\n[Sat Feb 18 03:53:55 2012] [info] Loading certificate & private key of SSL-aware server\n[Sat Feb 18 03:53:55 2012] [info] Configuring server for SSL protocol\n[Sat Feb 18 03:53:55 2012] [info] RSA server certificate enables Server Gated Cryptography (SGC)"}, {"count": 5, "tags": [], "creator": "calestyo@scientia.net", "attachment_id": null, "is_private": false, "id": 153908, "time": "2012-02-18T03:16:16Z", "bug_id": 52631, "creation_time": "2012-02-18T03:16:16Z", "text": "I've just reported a similar (but I guess not the same) issue: #52703"}, {"count": 6, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "text": "Post a configuration and a binary, unformatted packet capture and highlight the misbehavior from apache.  You may need to use a throwaway private key and also provide it to decrypt the traces.", "id": 153915, "time": "2012-02-18T12:09:02Z", "bug_id": 52631, "creation_time": "2012-02-18T12:09:02Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 52631, "text": "I'll be on holidays starting with tomorrow.\nAs the information you need requires some effort, please wait till I'm back which is at the 1st of March.\nPlease be patient :)\n\n\nIn the meantime however I did some more checks and found out the following:\nThis seems to be some session issue....\n\nWhen I have the website in Firefox and/or Chromium opened (correctly) and I restart Apache, then the next reload of _both_ (!!!) browsers won't work but will lead me to the default name based vhost.\nSubsequent reloads work again and bring me to the non-default name based vhost.\n\n\nBUT.... when I have the browsers closed and do the restart,... and then open the browsers (either of them or both) it works for them.\n\nSo it seems as if this wouldn't be just some internal Apache issue, but really how the Apache+Browser plays with each other.", "id": 153928, "time": "2012-02-19T18:44:50Z", "creator": "calestyo@scientia.net", "creation_time": "2012-02-19T18:44:50Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "calestyo@scientia.net", "attachment_id": null, "is_private": false, "id": 153929, "time": "2012-02-19T18:47:49Z", "bug_id": 52631, "creation_time": "2012-02-19T18:47:49Z", "text": "As it's not sure that this is really a problem in Apache alone I've reported it against...\n\nFirefox:\nhttps://bugzilla.mozilla.org/show_bug.cgi?id=728713\n\nand\n\nChromium:\nhttps://code.google.com/p/chromium/issues/detail?id=114943\n\n\nPerhaps those guys can help, too."}, {"count": 9, "tags": [], "bug_id": 52631, "text": "I just found out that this issue, as well as #52703, is seemingly solved by setting\nSSLSessionCache (https://httpd.apache.org/docs/current/mod/mod_ssl.html#sslsessioncache) to it's default:\nnone\nfrom my own setting (Debian's default):\nSSLSessionCache shmcb:${APACHE_RUN_DIR}/ssl_scache(512000)\n\n\nI came to this idea via http://vincent.bernat.im/en/blog/2011-ssl-session-reuse-rfc5077.html ...\n\nSo SSLSessionCache is responsible for SSL Session resumption, right?!\n\nAgain, it happens with Firefox/Chromium (both using NSS) so this might be either a NSS bug or an Apache bug or some bad playing between both.", "id": 154460, "time": "2012-03-03T00:43:11Z", "creator": "calestyo@scientia.net", "creation_time": "2012-03-03T00:43:11Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 52631, "text": "Is the stuff asked for in comment #6 still usefull?", "id": 154462, "time": "2012-03-03T00:52:53Z", "creator": "calestyo@scientia.net", "creation_time": "2012-03-03T00:52:53Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "text": "(In reply to comment #10)\n> Is the stuff asked for in comment #6 still usefull?\n\nBeat's guessing if a session was/wasn't resumed and if it came with a servername indicator.", "attachment_id": null, "bug_id": 52631, "id": 154464, "time": "2012-03-03T01:14:05Z", "creator": "covener@gmail.com", "creation_time": "2012-03-03T01:14:05Z", "is_private": false}, {"count": 12, "tags": [], "text": "This bug seems to have the same reasons as bug #52703 ... so I suggest to discuss anything further there (when it is Apache related) or at:\nhttps://bugzilla.mozilla.org/show_bug.cgi?id=728715\n(when it is NSS related).\n\n\nRegarding comment #6 and comment #11:\nI guess we have currently enough information in the other bug reports, right?\nAs setting up a fake CA/etc. is quite some effort (especially as I have to test on a production system, where we would have to make a downtime then)... I'll skip this for now, until someone requests it again because it's needed.", "is_private": false, "bug_id": 52631, "id": 154490, "time": "2012-03-04T16:11:02Z", "creator": "calestyo@scientia.net", "creation_time": "2012-03-04T16:11:02Z", "attachment_id": null}, {"count": 13, "tags": [], "bug_id": 52631, "text": "simplification and marking this as a dup of the one getting effectively the same updates.\n\n*** This bug has been marked as a duplicate of bug 52703 ***", "id": 154492, "time": "2012-03-04T16:20:01Z", "creator": "covener@gmail.com", "creation_time": "2012-03-04T16:20:01Z", "is_private": false, "attachment_id": null}]