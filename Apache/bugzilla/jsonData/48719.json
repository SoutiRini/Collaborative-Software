[{"count": 0, "tags": [], "bug_id": 48719, "is_private": false, "text": "Created attachment 24959\ntest jsp page\n\n1 error in apache-mod_proxy_ajp\n1.1 In apache-mod_proxy_ajp-tomcat connection,\nwhen jsp page on tomcat trys to create a very big cookie(about 8000B) to user explorer, (or just try to read a very big cookie from user explorer),\nerror occurs.\n\nWith the size of cookie changed\uff0c\nthe following error log generated\uff08in apache/logs/error_log\uff09\uff1a\n\n--\n[Tue Feb 09 14:02:40 2010] [error] ajp_msg_get_string(): \nBufferOverflowException 8188 8192\n[Tue Feb 09 14:02:40 2010] [error] ajp_unmarshal_response: Null header name\n[Tue Feb 09 14:02:40 2010] [error] (120001)APR does not understand this \nerror code: proxy: send body failed to 172.28.14.243:8009 (172.28.14.243)\n\n--\n[Tue Feb 09 12:37:22 2010] [error] ajp_check_msg_header() incoming message \nis too big 8196, max is 8192\n[Tue Feb 09 12:37:22 2010] [error] ajp_ilink_receive() received bad header\n[Tue Feb 09 12:37:22 2010] [error] ajp_read_header: ajp_ilink_receive failed\n[Tue Feb 09 12:37:22 2010] [error] (120007)APR does not understand this \nerror code: proxy: send body failed to 172.28.14.243:8009 (172.28.14.243)\n\n--\n[Tue Feb 09 13:42:22 2010] [error] (70014)End of file found: \najp_ilink_receive() can't receive header\n[Tue Feb 09 13:42:22 2010] [error] ajp_read_header: ajp_ilink_receive failed\n[Tue Feb 09 13:42:22 2010] [error] (120006)APR does not understand this \nerror code: proxy: read response failed from 172.28.14.243:8009 \n(172.28.14.243)\n\nAnd with the size of cookie changed\uff0cdifferent error message \nreturn to user explorer. \nBut not describe the truly reason (cookie or url or just ajp_header are out of limit).\n\n1.2 source check\n\n1.2.1 base source\n  + Apache\u30002.2.4 mod_proxy_ajp\n  + Tomcat\u30005.5.23 connectors/ajp\n\n1.2.2 source extraction\n--SEND (apache_tomcat_ajp)--\n//apache-tomcat-5.5.23-src/connectors/ajp/ajplib/src/ajp_msg.c\n//apache-tomcat-5.5.23-src/connectors/ajp/ajplib/src/ajp_link.c\n//apache-tomcat-5.5.23-src/connectors/ajp/ajplib/src/ajp_header.c\n//apache-tomcat-5.5.23-src/connectors/ajp/ajplib/include/ajp_header.h\n//apache-tomcat-5.5.23-src/connectors/ajp/proxy/proxy_ajp.c\n//apache-tomcat-5.5.23-src/connectors/ajp/proxy/mod_proxy.c\nap_proxy_ajp_request(){\n    ... ...\n    ajp_send_header();\n    ... ...\n}\n\najp_send_header(){\n    ... ...\n    ajp_msg_create();\n    ajp_malshal_to_msgb();\n    ajp_ilink_send();\n    ... ...\n}\n\najp_msg_create(){\n    ... ...\n    msg->len=0;\n    msg->header_len=4;\n    ... ...\n}\n\najp_malshal_to_msgb(){\n    ... ...\n    ajp_msg_append_*();    // msg->len += 1/2/4/...\n}\n\najp_ilink_send(){\n    ... ...\n    ajp_msg_end();\n    ... ...\n}\n\najp_msg_append_uint8(){\n    if((msg->len + 1) >= 8KB)    // <== ERROR: msg->len + 4 \n(msg->header_len) + 1 >= 8KB\n        // <== fine process for too big error\n}\n\najp_msg_end(){\n    ... ...\n    // write prefix 2 bytes to buf[0-1]\n    ... ...\n    // write len (msg->len - 4) 2 bytes to buf[2-3]\n    len = msg->len - 4;        // <== ERROR: msg->len used as save buf used \nlength\n    ... ...\n}\n\n--RECEIVE(apache_mod_proxy_ajp)--\n//httpd-2.2.4/modules/proxy/apj_msg.c\n\najp_msg_chech_heaher(){\n    ... ...\n    // get msglen from buf\n    if(msglen > 8KB){    // <== ERROR: msglen used as save buf used length\n        // output: [Wed Dec 30 14:17:43 2009] [error] ajp_check_msg_header() \nincoming message is too big 8196, max is 8192\n        // this message should nerver appear\n    }\n    ... ...\n}\n\n1.3 wrong use of len(in struct ajp_msg)/header_len/msglen(in ajp_header buf).\nIt seems that these three value has different meaning in describe the ajp_header. But in two places, it was used in different meaning.\nSo that when the ajp_header size reached about AJP_MSG_BUFFER_SZ,\nerror occurs in many places.\n\n2 For many applications' necessory,\nwe suggest the value of AJP_MSG_BUFFER_SZ up to 16KB.\nThis value should be a good balance between performance and availability.\n\n3 wrong function name in log output.\napache/modules/proxy/ajp_msg.c:\nline: 102 function name error.\nline: 113 function name error.\n\n4 test jsp page (in attachment)", "id": 134384, "time": "2010-02-09T22:56:37Z", "creator": "qu-chunguang@necsoft.com.cn", "creation_time": "2010-02-09T22:56:37Z", "attachment_id": 24959}]