[{"count": 0, "tags": [], "bug_id": 14760, "is_private": false, "id": 26766, "attachment_id": null, "creator": "tcbug@hippoit.co.uk", "creation_time": "2002-11-22T08:56:51Z", "time": "2002-11-22T08:56:51Z", "text": "Overview:\nVariable 'buf' in org.apache.coyote.http11.InternalOutputBuffer can overflow in\nthe write method.\n\nSteps to Reproduce:\nUnsure, appears eventually under medium load on our web-app. Continually hitting\ntomcat with requests which produce a lot of output data will eventually trigger it.\n\nNotes:\nI added some extra logging into InternalOutputBuffer to see what the contents of\nthe 'buf' array were and at the point it overflows it appears to have multiple\nsets of response headers as below:\n--- snip ---\nHTTP/1.1 200 OK\nContent-Type: text/html;charset=ISO-8859-1\nCache-Control: no-cache, post-check=0, pre-check=0\nPragma: no-cache\nExpires: Thu, 01 Dec 1994 16:00:00 GMT\nTransfer-Encoding: chunked\nDate: Thu, 21 Nov 2002 12:02:39 GMT\nServer: Apache Coyote/1.0\n\nHTTP/1.1 200 OK\nContent-Type: text/html;charset=ISO-8859-1\nCache-Control: no-cache, post-check=0, pre-check=0\nPragma: no-cache\nExpires: Thu, 01 Dec 1994 16:00:00 GMT\nTransfer-Encoding: chunked\nDate: Thu, 21 Nov 2002 12:02:39 GMT\nServer: Apache Coyote/1.0\nTransfer-Encoding: chunked\nDate: Thu, 21 Nov 2002 12:02:39 GMT\nServer: Apache Coyote/1.0\n\nHTTP/1.1 200 OK\nContent-Type: text/html;charset=ISO-8859-1\nCache-Control: no-cache, post-check=0, pre-check=0\nPragma: no-cache\nExpires: Thu, 01 Dec 1994 16:00:00 GMT\nTransfer-Encoding: chunked\nDate: Thu, 21 Nov 2002 12:02:39 GMT\nServer: Apache Coyote/1.0\nTransfer-Encoding: chunked\nDate: Thu, 21 Nov 2002 12:02:39 GMT\n--- snip ---\n\nThe buffer contains 32k worth of this stuff repeated at the point at which it\noverflows.\nThe exception occurs due to the array index 'pos' being incremented without a\nrange check to ensure that it's not going past the end of 'buf' but I'm assuming\nthat the root problem is the fact that it's filling up at all rather than the\nlack of range checking.\n\nStack Trace:\njava.lang.ArrayIndexOutOfBoundsException\nat\norg.apache.coyote.http11.InternalOutputBuffer.write(InternalOutputBuffer.java:615)\nat\norg.apache.coyote.http11.InternalOutputBuffer.sendStatus(InternalOutputBuffer.java:407)\nat\norg.apache.coyote.http11.Http11Processor.prepareResponse(Http11Processor.java:901)\nat org.apache.coyote.http11.Http11Processor.action(Http11Processor.java:471)\nat org.apache.coyote.Response.action(Response.java:214)\nat\norg.apache.coyote.http11.InternalOutputBuffer.doWrite(InternalOutputBuffer.java:516)\nat org.apache.coyote.Response.doWrite(Response.java:513)\nat org.apache.coyote.tomcat4.OutputBuffer.realWriteBytes(OutputBuffer.java:380)\nat org.apache.tomcat.util.buf.ByteChunk.flushBuffer(ByteChunk.java:360)\nat org.apache.tomcat.util.buf.ByteChunk.append(ByteChunk.java:338)\nat org.apache.tomcat.util.buf.IntermediateOutputStream.write(C2BConverter.java:273)\nat sun.nio.cs.StreamEncoder$CharsetSE.writeBytes(StreamEncoder.java:334)\nat sun.nio.cs.StreamEncoder$CharsetSE.implFlushBuffer(StreamEncoder.java:403)\nat sun.nio.cs.StreamEncoder$CharsetSE.implFlush(StreamEncoder.java:407)\nat sun.nio.cs.StreamEncoder.flush(StreamEncoder.java:150)\nat java.io.OutputStreamWriter.flush(OutputStreamWriter.java:213)\nat org.apache.tomcat.util.buf.WriteConvertor.flush(C2BConverter.java:222)\nat org.apache.tomcat.util.buf.C2BConverter.flushBuffer(C2BConverter.java:165)\nat org.apache.coyote.tomcat4.OutputBuffer.realWriteChars(OutputBuffer.java:576)\nat org.apache.tomcat.util.buf.CharChunk.flushBuffer(CharChunk.java:388)\nat org.apache.coyote.tomcat4.OutputBuffer.flush(OutputBuffer.java:340)\nat java.io.PrintWriter.flush(PrintWriter.java:120)\nat org.apache.coyote.tomcat4.CoyoteWriter.flush(CoyoteWriter.java:97)\nat org.apache.catalina.valves.ErrorReportValve.report(ErrorReportValve.java:366)\nat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:205)\nat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:641)\nat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\nat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\nat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:174)\nat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\nat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\nat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\nat org.apache.coyote.tomcat4.CoyoteAdapter.service(CoyoteAdapter.java:223)\nat org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:405)\nat\norg.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.processConnection(Http11Protocol.java:380)\nat org.apache.tomcat.util.net.TcpWorkerThread.runIt(PoolTcpEndpoint.java:508)\nat\norg.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:533)\nat java.lang.Thread.run(Thread.java:536)"}, {"count": 1, "attachment_id": null, "bug_id": 14760, "is_private": false, "id": 26767, "time": "2002-11-22T09:06:39Z", "creator": "remm@apache.org", "creation_time": "2002-11-22T09:06:39Z", "tags": [], "text": "I'd like yuou to try to reproduce this problem with 4.1.15\n(http://jakarta.apache.org/builds/jakarta-tomcat-4.0/release/v4.1.15-alpha/).\nOtherwise, I'll consider it has been fixed or is an invalid report.\n\nThe position on the buffer is reset to 0 after each request, so I don't see how\nyou describe can actually happen."}, {"count": 2, "tags": [], "creator": "tcbug@hippoit.co.uk", "attachment_id": null, "id": 26769, "time": "2002-11-22T09:45:26Z", "bug_id": 14760, "creation_time": "2002-11-22T09:45:26Z", "is_private": false, "text": "Still happens in Tomcat 4.1.15\n\nI will add additional logging in the 4.1.12 source (as I've already started with\nthat and there is very little difference in the code for InternalOutputBuffer\nbetween 4.1.12 and 4.1.15 and see if I can get any more info. I'll check the pos\nvalue at various times and see if it's not getting reset sometimes?\n\nHere's the stacktrace:\njava.lang.ArrayIndexOutOfBoundsException\nat\norg.apache.coyote.http11.InternalOutputBuffer.write(InternalOutputBuffer.java:631)\nat\norg.apache.coyote.http11.InternalOutputBuffer.sendStatus(InternalOutputBuffer.java:407)\nat\norg.apache.coyote.http11.Http11Processor.prepareResponse(Http11Processor.java:934)\nat org.apache.coyote.http11.Http11Processor.action(Http11Processor.java:479)\nat org.apache.coyote.Response.action(Response.java:214)\nat\norg.apache.coyote.http11.InternalOutputBuffer.doWrite(InternalOutputBuffer.java:516)\nat org.apache.coyote.Response.doWrite(Response.java:518)\nat org.apache.coyote.tomcat4.OutputBuffer.realWriteBytes(OutputBuffer.java:384)\nat org.apache.tomcat.util.buf.ByteChunk.flushBuffer(ByteChunk.java:360)\nat org.apache.tomcat.util.buf.ByteChunk.append(ByteChunk.java:338)\nat org.apache.tomcat.util.buf.IntermediateOutputStream.write(C2BConverter.java:273)\nat sun.nio.cs.StreamEncoder$CharsetSE.writeBytes(StreamEncoder.java:334)\nat sun.nio.cs.StreamEncoder$CharsetSE.implFlushBuffer(StreamEncoder.java:403)\nat sun.nio.cs.StreamEncoder$CharsetSE.implFlush(StreamEncoder.java:407)\nat sun.nio.cs.StreamEncoder.flush(StreamEncoder.java:150)\nat java.io.OutputStreamWriter.flush(OutputStreamWriter.java:213)\nat org.apache.tomcat.util.buf.WriteConvertor.flush(C2BConverter.java:222)\nat org.apache.tomcat.util.buf.C2BConverter.flushBuffer(C2BConverter.java:165)\nat org.apache.coyote.tomcat4.OutputBuffer.realWriteChars(OutputBuffer.java:580)\nat org.apache.tomcat.util.buf.CharChunk.flushBuffer(CharChunk.java:388)\nat org.apache.coyote.tomcat4.OutputBuffer.flush(OutputBuffer.java:344)\nat java.io.PrintWriter.flush(PrintWriter.java:120)\nat org.apache.coyote.tomcat4.CoyoteWriter.flush(CoyoteWriter.java:97)\nat org.apache.catalina.valves.ErrorReportValve.report(ErrorReportValve.java:363)\nat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:205)\nat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:641)\nat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\nat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\nat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:174)\nat\norg.apache.catalina.core.StandardPipeline$StandardPipelineValveContext.invokeNext(StandardPipeline.java:643)\nat org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:480)\nat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:995)\nat org.apache.coyote.tomcat4.CoyoteAdapter.service(CoyoteAdapter.java:223)\nat org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:413)\nat\norg.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.processConnection(Http11Protocol.java:380)\nat org.apache.tomcat.util.net.TcpWorkerThread.runIt(PoolTcpEndpoint.java:537)\nat\norg.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:533)\nat java.lang.Thread.run(Thread.java:536)\n"}, {"count": 3, "tags": [], "bug_id": 14760, "attachment_id": 3919, "id": 26787, "creation_time": "2002-11-22T13:52:40Z", "time": "2002-11-22T13:52:40Z", "creator": "tcbug@hippoit.co.uk", "text": "Created attachment 3919\nTest case web app and source code", "is_private": false}, {"count": 4, "tags": [], "bug_id": 14760, "attachment_id": null, "id": 26788, "time": "2002-11-22T13:56:52Z", "creator": "tcbug@hippoit.co.uk", "creation_time": "2002-11-22T13:56:52Z", "is_private": false, "text": "After further investigation I can now reproduce this at will with a small test\nwebapp (see attachment).\nIt appears to happen when a request is interrupted (for example by the user\nclicking on another app url after selecting an initial url which is taking some\ntime to come back). The final request is served correctly but the\nInternalOutputBuffer associated with the interrupted request fills up with many\ncalls to the write() method. If the originally requested page is big enough (as\ndemonstrated in the web app attached to this report) the output buffer will\noverflow.\n\nTo see this:\nDeploy the war file.\nLoad the index.jsp file.\nClick on two of the links in quick succession.\nCheck the log file - at some point you will see the out of bounds exception.\n\nI have also modified the InternalOutputBuffer code (source on request) to\nprovide logging on the 'pos' variable and I can see that it is increasing with\nmany calls to write(String) or write(MessageBytes) before the overflow occurs."}, {"count": 5, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "id": 26803, "time": "2002-11-22T16:07:43Z", "bug_id": 14760, "creation_time": "2002-11-22T16:07:43Z", "is_private": false, "text": "I cannot really reproduce it using the test case (pos never got higher than 533,\nbut is not constant, and that's higher than it should be). With the fix (will be\nin 4.1.16 and 5.0.1), the value stays low and constant.\nThe bug has little impact except the trace ending up in the logs, and a small\nperformance degradation."}]