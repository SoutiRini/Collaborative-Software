[{"count": 0, "tags": [], "bug_id": 43491, "is_private": false, "text": "Pb was reproduced with 2.2.6 on AIX and Solaris.\n\nOnce piped log are configured (ex with rotatelogs), if you start Apache, you \nwill find two copies of the errorlog piped program: \n- one has been started a few seconds prior to the second one \n- the first one has parent pid=1 (not httpd) and is attached to your tty\n\nExample below:\n UID     PID    PPID   C    STIME    TTY  TIME CMD\nroot 1761522       1   0 18:28:05      -  0:00 httpd -k start \nxxxx 1892358 1761522   0 18:28:05      -  0:00 httpd -k start \nroot 1077456       1   0 18:28:02 pts/12  0:00 rotatelogs errors.%Y%m%d 86400\nroot 2170970 1761522   0 18:28:05      -  0:00 rotatelogs errors.%Y%m%d 86400 \n\nSince the first one is attached to your tty, you can no longer exit your ssh \nconnection easily nor automate things with remote shell commands\n\nLocated the pb in server/log.c: latest revision commited in 2.2.x branch \nintroduced the regression\nhttp://svn.apache.org/viewvc/httpd/httpd/branches/2.2.x/server/log.c?\nr1=569542&r2=570451&diff_format=h\n\nNote: if first piped program is killed, no prob since the second one is the \none doing the job", "id": 108645, "time": "2007-09-26T09:42:35Z", "creator": "christian_boitel@yahoo.fr", "creation_time": "2007-09-26T09:42:35Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "wrowe@apache.org", "is_private": false, "id": 108655, "attachment_id": null, "bug_id": 43491, "creation_time": "2007-09-26T10:54:30Z", "time": "2007-09-26T10:54:30Z", "text": "I'm wondering if there's a way to determine if AIX picked up on the availability\nof RELIABLE_PIPED_LOGS... can you take a look at your configured include/apr.h\nfile and look for a line such as;\n\n#define APR_HAS_OTHER_CHILD       1\n\nand report back?\n\nThanks for the report!"}, {"count": 2, "tags": [], "creator": "wrowe@apache.org", "is_private": false, "id": 108658, "attachment_id": null, "bug_id": 43491, "creation_time": "2007-09-26T11:59:04Z", "time": "2007-09-26T11:59:04Z", "text": "Another thought.  Are you using worker mpm plus mod_cgid?  If we've spawned off\na long lived cgid or similar process during the startup, that extra fork()'ed\nprocess may be holding the stderr handle open to the very first piped logger."}, {"count": 3, "tags": [], "creator": "rpluem@apache.org", "attachment_id": 20888, "id": 108663, "time": "2007-09-26T13:05:21Z", "bug_id": 43491, "creation_time": "2007-09-26T13:05:21Z", "is_private": false, "text": "Created attachment 20888\nPatch against trunk\n\nCan you please check if the attached patch fixes your problem?"}, {"count": 4, "tags": [], "text": "(In reply to comment #1)\n> I'm wondering if there's a way to determine if AIX picked up on the \n\nThe same happens on Linux. See also my attached patch. IMHO the problem is that\nwe keep a copy of the pipe in s_main->error_log after we dup2ed it into\nstderr_log. This one gets inherited by the second piped rotater for the main\nserver. Thus the first piped rotater, which is started while the server is still\nattached to the terminal does not shut down.", "attachment_id": null, "id": 108664, "creation_time": "2007-09-26T13:08:27Z", "time": "2007-09-26T13:08:27Z", "creator": "rpluem@apache.org", "bug_id": 43491, "is_private": false}, {"count": 5, "tags": [], "text": "Please confirm the attached patch resolves the flaw; it will be tagged for prompt\nattention and target release 2.2.7, if so.", "attachment_id": null, "bug_id": 43491, "id": 108665, "time": "2007-09-26T13:23:16Z", "creator": "wrowe@apache.org", "creation_time": "2007-09-26T13:23:16Z", "is_private": false}, {"count": 6, "tags": [], "text": "I can reproduce the problem for Solaris.\n\nThe patch posted by Bill on httpd-dev fixes the problem on Solaris (apart from a\nmissing semicolon) as well as the one you attached.\n\nI can provide full truss output, if someone needs it. Below find an excerpt with\nthe relevant diff. This rotatelogs process gets forked from the httpd process,\nthat does the first configuration validation.\n\nEven without the patch: during the first (graceful) restart the additional\nrotatelogs process terminates.\n\nCaution: I use a slightly non standard build, using the shell /usr/xpg4/bin/sh\nnsted of /bin/sh in /srclib/apr/include/arch/unix/apr_arch_threadproc.h:\n#define SHELL_PATH \"/usr/xpg4/bin/sh\"\n\nOn Solaris one otherwise gets double processes for rotatelogs, since /bin/sh\ncreates a second process when calles with \"-c\". This is a separate observation\nnot only restricted for the error logger of the main server.\n\ntruss with bug (28235 startup httpd process, 28237 rotatelogs forked by that):\n28235:  bind(3, 0x0007C608, 32, 3)                      = 0\n28235:          AF_INET6  name = ::  port = 8001\n28235:  listen(3, 511, 1)                               = 0\n########## THIS part goes away with the patch ##########\n28235:  pipe()                                          = 7 [8]\n28235:  fcntl(7, F_GETFL, 0x00000000)                   = 2\n28235:  fstat64(7, 0xFFBEF6D0)                          = 0\n28235:      d=0x04140000 i=9338918 m=0010000 l=0  u=1200  g=1200  sz=0\n28235:          at = Sep 26 20:44:54 CEST 2007  [ 1190832294 ]\n28235:          mt = Sep 26 20:44:54 CEST 2007  [ 1190832294 ]\n28235:          ct = Sep 26 20:44:54 CEST 2007  [ 1190832294 ]\n28235:      bsz=5120  blks=0     fs=fifofs\n28235:  fstat64(7, 0xFFBEF6D0)                          = 0\n28235:      d=0x04140000 i=9338918 m=0010000 l=0  u=1200  g=1200  sz=0\n28235:          at = Sep 26 20:44:54 CEST 2007  [ 1190832294 ]\n28235:          mt = Sep 26 20:44:54 CEST 2007  [ 1190832294 ]\n28235:          ct = Sep 26 20:44:54 CEST 2007  [ 1190832294 ]\n28235:      bsz=5120  blks=0     fs=fifofs\n28235:  fcntl(7, F_SETFL, 0x00000082)                   = 0\n########## END PART ##########\n28235:  brk(0x0014A800)                                 = 0\n28235:  brk(0x0014C800)                                 = 0\n28235:  pipe()                                          = 9 [10]\n28235:  pipe()                                          = 11 [12]\n28235:  fcntl(1, F_DUP2FD, 0x0000000B)                  = 11\n28235:  access(\"/opt/build/test/apache22-prefork-2.2.6_0.9.8e-1/bin/rotatelogs\",\n5) = 0\n28235:  fork1()                                         = 28237\n28237:  fork1()         (returning as child ...)        = 28235\n28237:  getpid()                                        = 28237 [28235]\n\ntruss with patch (5966 httpd startup process, 5968 forked rotatelogs):\n5966:   bind(3, 0x0007E628, 32, 3)                      = 0\n5966:           AF_INET6  name = ::  port = 8001\n5966:   listen(3, 511, 1)                               = 0\n5966:   pipe()                                          = 7 [8]\n5966:   brk(0x0014C820)                                 = 0\n5966:   brk(0x0014E820)                                 = 0\n5966:   pipe()                                          = 9 [10]\n5966:   pipe()                                          = 11 [12]\n5966:   fcntl(1, F_DUP2FD, 0x0000000B)                  = 11\n5966:   access(\"/opt/build/test/apache22-prefork-2.2.6_0.9.8e-1/bin/rotatelogs\",\n5) = 0\n5966:   fork1()                                         = 5968\n5968:   fork1()         (returning as child ...)        = 5966\n5968:   getpid()                                        = 5968 [5966]\n", "attachment_id": null, "bug_id": 43491, "id": 108666, "time": "2007-09-26T13:24:48Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2007-09-26T13:24:48Z", "is_private": false}, {"count": 7, "tags": [], "creator": "rainer.jung@kippdata.de", "is_private": false, "id": 108670, "attachment_id": null, "bug_id": 43491, "creation_time": "2007-09-26T14:33:35Z", "time": "2007-09-26T14:33:35Z", "text": "I could reproduce the same problem for 2.0.61 under Solaris.\nWill test patch there also, because log.c is very similar to 2.2.6."}, {"count": 8, "tags": [], "text": "The patch also fixes BZ 40651 for me. I could still reproduce 40651 with 2.2.6.\n", "attachment_id": null, "id": 108675, "creation_time": "2007-09-26T16:13:20Z", "time": "2007-09-26T16:13:20Z", "creator": "rainer.jung@kippdata.de", "bug_id": 43491, "is_private": false}, {"count": 9, "tags": [], "text": "Same patch fixes problem for 2.0.61 prefork/Solaris.", "attachment_id": null, "bug_id": 43491, "id": 108681, "time": "2007-09-26T17:49:21Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2007-09-26T17:49:21Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 43491, "is_private": false, "text": "Believe we have a line on this, with luck it will be addressed very soon as\nrelease 2.2.7.", "id": 108693, "time": "2007-09-26T22:00:16Z", "creator": "wrowe@apache.org", "creation_time": "2007-09-26T22:00:16Z", "attachment_id": null}, {"count": 11, "tags": [], "text": "(In reply to comment #5)\n> Please confirm the attached patch resolves the flaw; it will be tagged for \nprompt\n> attention and target release 2.2.7, if so.\n\nPatch solves pb on both my AIX and Solaris platforms.", "attachment_id": null, "bug_id": 43491, "id": 108706, "time": "2007-09-27T01:41:15Z", "creator": "christian_boitel@yahoo.fr", "creation_time": "2007-09-27T01:41:15Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 43491, "is_private": false, "text": "Committed to trunk as r580431 (http://svn.apache.org/viewvc?rev=580431&view=rev)\nand proposed for backport to 2.2.x as r580434\n(http://svn.apache.org/viewvc?rev=580434&view=rev).", "id": 108782, "time": "2007-09-28T15:04:14Z", "creator": "rpluem@apache.org", "creation_time": "2007-09-28T15:04:14Z", "attachment_id": null}, {"count": 13, "tags": [], "creator": "nick@webthing.com", "is_private": false, "id": 129860, "attachment_id": null, "bug_id": 43491, "creation_time": "2009-08-23T13:41:30Z", "time": "2009-08-23T13:41:30Z", "text": "Patch was backported ... PR wasn't closed at the time."}]