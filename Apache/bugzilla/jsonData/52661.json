[{"count": 0, "tags": [], "creator": "lianggt08@sei.pku.edu.cn", "is_private": false, "id": 153769, "attachment_id": null, "bug_id": 52661, "creation_time": "2012-02-14T08:50:50Z", "time": "2012-02-14T08:50:50Z", "text": "The fix revision 720997 was aimed to remove an NPE bug on the \"this._moniker\" in the method \"toString\" of the file \"/poi/trunk/src/java/org/apache/poi/hssf/record/HyperlinkRecord.java\" , but it is incomplete. \nSince the \"this._moniker\" is a class field and also could be null during the run-time execution, it should also be null-checked before being dereferenced in other methods. \n\nThe buggy code locations the same fix needs to be applied at are as bellows: \nLine 559 of the method \"serialize\". \n\n\n\tpublic void serialize(LittleEndianOutput out) {\n\t        _range.serialize(out);\n\t\n\t        _guid.serialize(out);\n\t        out.writeInt(0x00000002); // TODO const\n\t        out.writeInt(_linkOpts);\n\t\n\t        if ((_linkOpts & HLINK_LABEL) != 0){\n\t            out.writeInt(_label.length());\n\t            StringUtil.putUnicodeLE(_label, out);\n\t        }\n\t        if ((_linkOpts & HLINK_TARGET_FRAME) != 0){\n\t            out.writeInt(_targetFrame.length());\n\t            StringUtil.putUnicodeLE(_targetFrame, out);\n\t        }\n\t\n\t        if ((_linkOpts & HLINK_UNC_PATH) != 0) {\n\t            out.writeInt(_address.length());\n\t            StringUtil.putUnicodeLE(_address, out);\n\t        } else if ((_linkOpts & HLINK_URL) != 0){\n[Line 559]\t            _moniker.serialize(out);\n\t            if(URL_MONIKER.equals(_moniker)){\n\t                if ((_linkOpts & HLINK_TARGET_FRAME) != 0) {\n\t                    out.writeInt(_address.length()*2);\n\t                    StringUtil.putUnicodeLE(_address, out);\n\t                } else {\n\t                    out.writeInt(_address.length()*2 + TAIL_SIZE);\n\t                    StringUtil.putUnicodeLE(_address, out);\n\t                    writeTail(_uninterpretedTail, out);\n\t                }\n\t            } else if (FILE_MONIKER.equals(_moniker)){\n\t                out.writeShort(_fileOpts);\n\t                out.writeInt(_shortFilename.length());\n\t                StringUtil.putCompressedUnicode(_shortFilename, out);\n\t                writeTail(_uninterpretedTail, out);\n\t                if (_address == null) {\n\t                    out.writeInt(0);\n\t                } else {\n\t                    int addrLen = _address.length() * 2;\n\t                    out.writeInt(addrLen + 6);\n\t                    out.writeInt(addrLen);\n\t                    out.writeShort(0x0003); // TODO const\n\t                    StringUtil.putUnicodeLE(_address, out);\n\t                }\n\t            }\n\t        }\n\t        if((_linkOpts & HLINK_PLACE) != 0){\n\t               out.writeInt(_textMark.length());\n\t            StringUtil.putUnicodeLE(_textMark, out);\n\t        }\n\t    }"}, {"count": 1, "tags": [], "bug_id": 52661, "attachment_id": null, "id": 153778, "time": "2012-02-14T12:52:42Z", "creator": "apache@gagravarr.org", "creation_time": "2012-02-14T12:52:42Z", "is_private": false, "text": "I believe that a monkier is required for both of the two kinds of links that are being serialized there. If the monkier is null at this point, then the problem lies earlier. We can't just skip writing it, as the record wouldn't be valid\n\nHow are you ending up without one?"}, {"count": 2, "tags": [], "creator": "lianggt08@sei.pku.edu.cn", "is_private": false, "id": 153797, "attachment_id": null, "bug_id": 52661, "creation_time": "2012-02-15T06:12:10Z", "time": "2012-02-15T06:12:10Z", "text": "The text diff of the revision 720997 is as bellows: \n--- poi/trunk/src/java/org/apache/poi/hssf/record/HyperlinkRecord.java\t2008/11/26 22:00:07\t720996\n+++ poi/trunk/src/java/org/apache/poi/hssf/record/HyperlinkRecord.java\t2008/11/26 22:00:29\t720997\n@@ -628,7 +628,7 @@\n         if ((_linkOpts & HLINK_TARGET_FRAME) != 0) {\n             buffer.append(\"    .targetFrame= \").append(getTargetFrame()).append(\"\\n\");\n         }\n-        if((_linkOpts & HLINK_URL) != 0) {\n+        if((_linkOpts & HLINK_URL) != 0 && _moniker != null) {\n             buffer.append(\"    .moniker   = \").append(_moniker.formatAsString()).append(\"\\n\");\n         }\n         if ((_linkOpts & HLINK_PLACE) != 0) {\n\nwe can see that only checking \"(_linkOpts & HLINK_URL) != 0\" can not guarantee\nthat \" _moniker != null\". \n\nIf the revision 720997 is a right fix, then I think the Line 559 of the method \"serialize\" should also be fixed this way. \n\nI think it will be more reasonable to treat them in a same way."}, {"count": 3, "tags": [], "bug_id": 52661, "is_private": false, "text": "I would say that toString() must correspond to serialize(), not the other way around.\n\nThe code in HyperlinkRecord.serialize is correct. If a link is URL and not a UNC path then the moniker field MUST be set. If it is null then you are constructing wrong data.\n\nHyperlinkRecord.toString() uses slightly different logic and prints the moniker if it is not null and hyperlink type is URL (UNC path option is not tested here). This is not quite correct but acceptable because toString() is used mainly for debugging purposes. \n\nIn any case, I'm not going to change it without a unit test that demonstrates the NPE issue. If you are able to construct one, please upload and re-open this ticket.\n\nYegor \n\n(In reply to comment #2)\n> The text diff of the revision 720997 is as bellows: \n> --- poi/trunk/src/java/org/apache/poi/hssf/record/HyperlinkRecord.java   \n> 2008/11/26 22:00:07    720996\n> +++ poi/trunk/src/java/org/apache/poi/hssf/record/HyperlinkRecord.java   \n> 2008/11/26 22:00:29    720997\n> @@ -628,7 +628,7 @@\n>          if ((_linkOpts & HLINK_TARGET_FRAME) != 0) {\n>              buffer.append(\"    .targetFrame=\n> \").append(getTargetFrame()).append(\"\\n\");\n>          }\n> -        if((_linkOpts & HLINK_URL) != 0) {\n> +        if((_linkOpts & HLINK_URL) != 0 && _moniker != null) {\n>              buffer.append(\"    .moniker   =\n> \").append(_moniker.formatAsString()).append(\"\\n\");\n>          }\n>          if ((_linkOpts & HLINK_PLACE) != 0) {\n> \n> we can see that only checking \"(_linkOpts & HLINK_URL) != 0\" can not guarantee\n> that \" _moniker != null\". \n> \n> If the revision 720997 is a right fix, then I think the Line 559 of the method\n> \"serialize\" should also be fixed this way. \n> \n> I think it will be more reasonable to treat them in a same way.", "id": 153802, "time": "2012-02-15T08:39:30Z", "creator": "yegor@dinom.ru", "creation_time": "2012-02-15T08:39:30Z", "attachment_id": null}, {"count": 4, "tags": [], "creator": "dominik.stadler@gmx.at", "attachment_id": null, "text": "Closing based on previous comment and non-update for a long time.", "id": 183227, "time": "2015-05-31T22:18:49Z", "bug_id": 52661, "creation_time": "2015-05-31T22:18:49Z", "is_private": false}]