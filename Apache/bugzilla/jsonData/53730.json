[{"count": 0, "tags": [], "creator": "rainer.jung@kippdata.de", "attachment_id": null, "is_private": false, "id": 161466, "time": "2012-08-16T15:35:05Z", "bug_id": 53730, "creation_time": "2012-08-16T15:35:05Z", "text": "When requesting a non-existing file via mod_proxy_ajp with an error page of at least 969 bytes in size I get a crash. I used Tomcat with standard Tomcat error page as a back end (Tomcat trunk and TC 7 head). If the URI is short, the error page is a bit shorter than 969 bytes and is shown. It the URI gets longer, the error page size gets beyond 969 bytes and the crash happens.\n\nFor the short page, where there's no crash, the packet dump code in ajp_msg_dump() returns early with APR_ENOMEM, because the buffer is to short. There seems to be a miscalculation in this code.\n\nWhen the page gets longer, the packet dump code goes through and the packet is being logged and shortly after during the same request the crash happens. It seems there is some memory corruption taking place around ajp_msg_dump().\n\nWhen the log level is below trace7, the code in ajp_msg_dump() is ont being executed. Need to investigate ajp_msg_dump() in detail.\n\nThis happens with prefork and event (worker not tested).\n\nBacktrace:\n\n#0  0xff0568c4 in _malloc_unlocked () from /lib/libc.so.1\nNo symbol table info available.\n#1  0xff056684 in malloc () from /lib/libc.so.1\nNo symbol table info available.\n#2  0xff2d453c in allocator_alloc (in_size=<optimized out>, allocator=0x147210) at memory/unix/apr_pools.c:349\n        node = <optimized out>\n        ref = <optimized out>\n        max_index = <optimized out>\n        i = <optimized out>\n        size = 8192\n        index = 1\n#3  apr_allocator_alloc (allocator=0x147210, size=<optimized out>) at memory/unix/apr_pools.c:438\nNo locals.\n#4  0xff347630 in apr_bucket_alloc (size=8016, list=0x1a7a30) at buckets/apr_buckets_alloc.c:148\n        memnode = <optimized out>\n        node = <optimized out>\n        active = 0x1a7a18\n        endp = <optimized out>\n#5  0xff346fe8 in apr_brigade_writev (b=0x1b81e0, flush=0, ctx=<optimized out>, vec=0xffbfedd8, nvec=4) at buckets/apr_brigade.c:576\n        e = 0x1b81e4\n        total_len = 24\n        i = 0\n        buf = <optimized out>\n#6  0x0005c7ec in basic_http_header (r=0x1a9a78, bb=0x1b81e0, protocol=0x700d8 \"HTTP/1.1\") at /shared/build/dev/httpd/svn/httpd/branches/2.4.x/modules/http/http_filters.c:924\n        date = <optimized out>\n        proxy_date = <optimized out>\n        server = <optimized out>\n        us = 0x124700 \"Apache/2.4.3-dev (Unix)\"\n        h = {pool = 0x20, bb = 0x1}\n        vec = {{iov_base = 0x700d8, iov_len = 8}, {iov_base = 0x70098, iov_len = 1}, {iov_base = 0x1b7b60, iov_len = 13}, {iov_base = 0x700f0, iov_len = 2}}\n#7  0x0005ce90 in ap_http_header_filter (f=0x1aa610, b=0x1b7b28) at /shared/build/dev/httpd/svn/httpd/branches/2.4.x/modules/http/http_filters.c:1283\n        r = 0x1a9a78\n        c = 0x1a5d00\n        protocol = 0x700d8 \"HTTP/1.1\"\n        e = <optimized out>\n        b2 = 0x1b81e0\n        h = {pool = 0x0, bb = 0x0}\n        ctx = 0x0\n        ctype = <optimized out>\n        eb = <optimized out>\n#8  0x000349e0 in ap_pass_brigade (next=0x1aa610, bb=0x1b7b28) at /shared/build/dev/httpd/svn/httpd/branches/2.4.x/server/util_filter.c:533\n        e = <optimized out>\n#9  0x00038960 in ap_content_length_filter (f=0x1aa5f8, b=0x1b7b28) at /shared/build/dev/httpd/svn/httpd/branches/2.4.x/server/protocol.c:1424\n        r = 0x1a9a78\n        ctx = 0x1b8170\n        e = <optimized out>\n        eblock = APR_NONBLOCK_READ\n#10 0x000349e0 in ap_pass_brigade (next=0x1aa5f8, bb=bb@entry=0x1b7b28) at /shared/build/dev/httpd/svn/httpd/branches/2.4.x/server/util_filter.c:533\n        e = <optimized out>\n#11 0x0005ea4c in ap_byterange_filter (f=0x1aa5e0, bb=0x1b7b28) at /shared/build/dev/httpd/svn/httpd/branches/2.4.x/modules/http/byterange_filter.c:496\n        r = 0x1a9a78\n        c = 0x1a5d00\n        e = <optimized out>\n        bsend = <optimized out>\n        tmpbb = <optimized out>\n        range_start = <optimized out>\n        range_end = <optimized out>\n        clength = <optimized out>\n        found = 0\n        num_ranges = 0\n        bound_head = 0x0\n        indexes = <optimized out>\n        idx = <optimized out>\n        i = <optimized out>\n        original_status = <optimized out>\n        max_ranges = 200\n        max_overlaps = 20\n        max_reversals = 20\n        overlaps = 0\n        reversals = 0\n        core_conf = <optimized out>\n#12 0x000349e0 in ap_pass_brigade (next=0x1aa5e0, bb=0x1b7b28) at /shared/build/dev/httpd/svn/httpd/branches/2.4.x/server/util_filter.c:533\n        e = <optimized out>\n#13 0xfee4368c in proxy_ajp_handler (r=0x1a9a78, worker=<optimized out>, conf=0xf30a0, url=<optimized out>, proxyname=0x0, proxyport=<optimized out>)\n    at /shared/build/dev/httpd/svn/httpd/branches/2.4.x/modules/proxy/mod_proxy_ajp.c:510\n        locurl = 0x1ab098 \"/23\"\n        status = <optimized out>\n        server_portstr = \":9080\\000R\u00c8\\000\\032]\\000\\000\\032\\232x\\000\\032\\232x\\000\\000\\000\\000\u00fe\u00e7\\006p\\000\\000\\004,\"\n        backend = 0x163410\n        retry = <optimized out>\n        dconf = 0xf3890\n        p = <optimized out>\n        uri = <optimized out>\n#14 0xfee64800 in proxy_run_scheme_handler (r=0x1a9a78, worker=0xf34a0, conf=0xf30a0, url=0x1aaff6 \"ajp://localhost:8009/23\", proxyhost=0x0, proxyport=<optimized out>)\n    at /shared/build/dev/httpd/svn/httpd/branches/2.4.x/modules/proxy/mod_proxy.c:2546\n        n = 0\n        rv = <optimized out>\n#15 0xfee69260 in proxy_handler (r=0x1a9a78) at /shared/build/dev/httpd/svn/httpd/branches/2.4.x/modules/proxy/mod_proxy.c:1072\n        url = 0x1aaff6 \"ajp://localhost:8009/23\"\n        uri = 0x1aaff6 \"ajp://localhost:8009/23\"\n        scheme = 0x1ab010 \"ajp\"\n        p = 0x1aaff9 \"://localhost:8009/23\"\n        p2 = 0xf33c0 \"\"\n        conf = 0xf30a0\n        proxies = 0xf3158\n        i = 1748985\n        access_status = 0\n        maxfwd = <optimized out>\n        balancer = 0x0\n        worker = 0xf34a0\n        attempts = 0\n        max_attempts = 0"}, {"count": 1, "attachment_id": null, "bug_id": 53730, "is_private": false, "id": 161467, "time": "2012-08-16T16:19:20Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2012-08-16T16:19:20Z", "tags": [], "text": "Fixed in trunk in r1373898 and proposed for backport to 2.4.x. 2.2 is not affected."}]