[{"count": 0, "tags": [], "bug_id": 46989, "text": "Created attachment 23453\nhssf-array-ptg.xls\n\nThe following test case is in our set of \"things which POI cannot do\":\n\n    public void testArrayPtg() throws Exception\n    {\n        File file = new File(\"hssf-array-ptg.xls\");\n\n        HSSFWorkbook workbook = new HSSFWorkbook(new POIFSFileSystem(new FileInputStream(file)));\n        HSSFSheet sheet = workbook.getSheetAt(0);\n        HSSFCell cell;\n\n        // All in one row\n        cell = sheet.getRow(0).getCell((short) 0);\n        assertEquals(\"Wrong formula string for numeric 4x1 array\", \"{1,2,3,4}\",\n                     cell.getCellFormula());\n        assertEquals(\"Wrong numeric value for numeric 4x1 array\", 1.0,\n                     cell.getNumericCellValue(), 0.0);\n\n        // All in one column\n        cell = sheet.getRow(0).getCell((short) 1);\n        assertEquals(\"Wrong formula string for numeric 1x4 array\", \"{1;2;3;4}\",\n                     cell.getCellFormula());\n        assertEquals(\"Wrong numeric value for numeric 1x4 array\", 1.0,\n                     cell.getNumericCellValue(), 0.0);\n\n        // 2 x 2\n        cell = sheet.getRow(0).getCell((short) 2);\n        assertEquals(\"Wrong formula string for numeric 2x2 array\", \"{1,2;3,4}\",\n                     cell.getCellFormula());\n        assertEquals(\"Wrong numeric value for numeric 2x2 array\", 1.0,\n                     cell.getNumericCellValue(), 0.0);\n\n        // Strings\n        cell = sheet.getRow(1).getCell((short) 0);\n        assertEquals(\"Wrong formula string for string array\", \"{\\\"a\\\",\\\"b\\\",\\\"c\\\"}\",\n                     cell.getCellFormula());\n        assertEquals(\"Wrong string value for string array\", \"a\",\n                     cell.getRichStringCellValue().toString());\n\n        // Booleans\n        cell = sheet.getRow(2).getCell((short) 0);\n        assertEquals(\"Wrong formula string for boolean array\", \"{TRUE,FALSE}\",\n                     cell.getCellFormula());\n        assertTrue(\"Wrong boolean value for boolean array\",\n                   cell.getBooleanCellValue());\n    }\n\nIn POI 3.1 it failed with RecordFormatException.  In POI trunk it appears to fail with IllegalStateException instead.\n\nThis was a test case constructed myself using Excel 2003 to reproduce something we saw in real user data.", "id": 126060, "time": "2009-04-07T17:37:09Z", "creator": "trejkaz@trypticon.org", "creation_time": "2009-04-07T17:37:09Z", "is_private": false, "attachment_id": 23453}, {"count": 1, "attachment_id": null, "creator": "trejkaz@trypticon.org", "is_private": false, "id": 126061, "time": "2009-04-07T18:14:42Z", "bug_id": 46989, "creation_time": "2009-04-07T18:14:42Z", "tags": [], "text": "Another of our \"wait to see if it gets fixed\" test cases which probably belongs under the same umbrella:\n\n    @Test\n    public void testArrayPlusMemAreaPtg() throws Exception\n    {\n        File file = new File(\"hssf-array-plus-memarea-ptg.xls\");\n        HSSFWorkbook workbook = new HSSFWorkbook(new POIFSFileSystem(new FileInputStream(file)));\n        HSSFCell cell = workbook.getSheetAt(0).getRow(3).getCell((short) 0);\n        assertEquals(\"Wrong cell value\", 5.0, cell.getNumericCellValue(), 0.0);\n        assertEquals(\"Wrong cell formula\", \"{1}+A1:A2 A2:A3+{2}\", cell.getCellFormula());\n    }"}, {"count": 2, "tags": [], "bug_id": 46989, "attachment_id": 23454, "id": 126062, "creation_time": "2009-04-07T18:15:39Z", "time": "2009-04-07T18:15:39Z", "creator": "trejkaz@trypticon.org", "text": "Created attachment 23454\nhssf-array-plus-memarea-ptg.xls", "is_private": false}, {"count": 3, "tags": [], "creator": "cdugas@calasys.fr", "text": "Hi,\n\nI have a problem with POI due probably to array formula. It's why I'm posting the probleme in this bug.\n\nI have attach 2 xls files. One contain array formula (in cell B37..), the other not. \nI get an error \"java.lang.RuntimeException: Failed to find a matching shared formula record\" when I save the file containing array formula using POI (method: workbook.write) If I save the file using Excel 2010, and then pass it to POI, it's ok. But if it is saved from Excel 2003, there is a problem.\n\nIs there a fix for this? Is it link to the bug describe here?\n\nThanks.\nChristophe.", "id": 152069, "time": "2011-12-08T15:17:45Z", "bug_id": 46989, "creation_time": "2011-12-08T15:17:45Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 46989, "attachment_id": null, "text": "Similar to bug 48292, there was no update on this for a long time, likely some things already work nowadays, so I think it best to report fresh bugs for anything that is still missing.\n\nThe provided test-case does not fail with any exception, but rather \"java.lang.IllegalStateException: Cannot get a formula value from a numeric formula cell\", which sounds like a test-case problem.", "id": 181948, "time": "2015-03-22T14:39:21Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2015-03-22T14:39:21Z", "is_private": false}, {"count": 5, "tags": [], "text": "Well then, can you suggest a test case which passes and shows that the feature works? Because it's still failing here.", "is_private": false, "id": 181984, "creator": "trejkaz@trypticon.org", "time": "2015-03-23T02:33:32Z", "bug_id": 46989, "creation_time": "2015-03-23T02:33:32Z", "attachment_id": null}, {"count": 6, "attachment_id": null, "creator": "dominik.stadler@gmx.at", "is_private": false, "id": 182007, "time": "2015-03-23T19:51:43Z", "bug_id": 46989, "creation_time": "2015-03-23T19:51:43Z", "tags": [], "text": "Can you then please update and combine the failing tests so we have an up-to-date set? At least the first unit test seems to fail in a strange unrelated way, maybe the attached document is incorrect as it only has a formula in cell 0,3, but the test expects formulas in more cells."}, {"count": 7, "tags": [], "bug_id": 46989, "text": "What I'm finding:\n\n- the first example now works (but somehow the attached .xls was the wrong file, which is probably a source of confusion.)\n\n- the second example still fails and I didn't have to update the code. Stack trace:\n\njava.lang.RuntimeException: Unknown grbit value (64)\n\tat org.apache.poi.ss.formula.constant.ConstantValueParser.readAConstantValue(ConstantValueParser.java:76)\n\tat org.apache.poi.ss.formula.constant.ConstantValueParser.parse(ConstantValueParser.java:52)\n\tat org.apache.poi.ss.formula.ptg.ArrayPtg$Initial.finishReading(ArrayPtg.java:261)\n\tat org.apache.poi.ss.formula.ptg.Ptg.readTokens(Ptg.java:70)\n\tat org.apache.poi.ss.formula.Formula.getTokens(Formula.java:82)\n\tat org.apache.poi.hssf.record.FormulaRecord.getParsedExpression(FormulaRecord.java:311)\n\tat org.apache.poi.hssf.record.aggregates.FormulaRecordAggregate.getFormulaTokens(FormulaRecordAggregate.java:197)\n\tat org.apache.poi.hssf.usermodel.HSSFCell.getCellFormula(HSSFCell.java:626)\n\tat TestHssf.testArrayPlusMemAreaPtg(TestHssf.java:189)", "id": 182078, "time": "2015-03-25T00:19:56Z", "creator": "trejkaz@trypticon.org", "creation_time": "2015-03-25T00:19:56Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 46989, "attachment_id": 32609, "text": "Created attachment 32609\ncorrect hssf-array-ptg.xls\n\nCorrected version of hssf-array-ptg.xls in case anyone is curious.", "id": 182079, "time": "2015-03-25T00:23:30Z", "creator": "trejkaz@trypticon.org", "creation_time": "2015-03-25T00:23:30Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 46989, "attachment_id": null, "text": "Updating version to reflect that it still occurs on the 3.12 beta. It also occurs on 3.10 (which is what we were using before I updated to check it out) and on 3.5 (which is what we were on when we first discovered it.)", "id": 182080, "time": "2015-03-25T00:28:33Z", "creator": "trejkaz@trypticon.org", "creation_time": "2015-03-25T00:28:33Z", "is_private": false}, {"count": 10, "tags": [], "creator": "tc@extravision.com", "attachment_id": null, "id": 186540, "time": "2015-11-25T10:11:57Z", "bug_id": 46989, "creation_time": "2015-11-25T10:11:57Z", "is_private": false, "text": "As of 3.13, certainly syntax like \"IF({1,0}... throws \"Unexpected ptg class (org.apache.poi.ss.formula.ptg.ArrayPtg)\" errors.\n\nThere was some discussion on the mailing list :\nhttp://mail-archives.apache.org/mod_mbox/poi-user/201511.mbox/%3CCAAwi-j_kWOZ-x+s-e5AQvZ9DCGj6iYktwLEOnL3vOL+pWk_9UQ@mail.gmail.com%3E"}]