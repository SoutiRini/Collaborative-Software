[{"count": 0, "tags": [], "creator": "makub@ics.muni.cz", "text": "Calling ServletRequest.setLocale(locale) sets \"charset\" attribute\neven if it was already specified. Following code shows it:\n\npublic void doGet (...) {\n PrintWriter out;\n response.setContentType(\"text/plain; charset=utf-8\");\n out = response.getWriter();\n out.println( \"getCharacterEncoding() = \" + response.getCharacterEncoding() );\n response.setLocale(request.getLocale());\n out.println( \"getCharacterEncoding() = \" + response.getCharacterEncoding() );\n}\n\nIt will produce output\n\ngetCharacterEncoding() = utf-8\ngetCharacterEncoding() = ISO-8859-2\n\nfor my browser with \"cs\" locale. This bug was probably introduced\nby patch mentioned in bug 6569. To be precise, the Servlet 2.3 javadoc says\nfor ServletResponse.setLocale():\n\nhttp://java.sun.com/webservices/docs/1.0/api/javax/servlet/ServletResponse.html#setLocale(java.util.Locale)\n\n Sets the locale of the response, setting the headers (including the\n Content-Type's charset) as appropriate.\n\nbut the javadoc for Servlet 2.4 is more precise:\n\nhttp://java.sun.com/webservices/docs/1.2/api/javax/servlet/ServletResponse.html#setLocale(java.util.Locale)\n\n Sets the locale of the response, setting the Content-Language header,\n if the response has not been committed yet. It also sets the response's\n character encoding appropriately for the locale, if the character\n encoding has not been explicitly set using\n setContentType(java.lang.String) or\n setCharacterEncoding(java.lang.String), getWriter hasn't been called\n yet, and the response hasn't been committed yet.\n\nSo Servlet 2.3 was vague in this, but Servlet 2.4 says it clearly, that\nsetLocale() should not change charset, if it is already set.\nThe last draft of Servlet 2.4 specification say in part 5.4 on page 52,\nthat \"explicit specifications take precedence over implicit specifications\".\n\nThis is a major problem when using JSTL fmt: tags for displaying internationalized\nmessages, because each fmt: tag calls the setLocale() to set Content-Language\nheader, and accidentaly changes also the charset. This makes impossible\nto display internationalized pages with multilingual content using utf-8,\nas the utf-8 charset is always replaced by setLocale() call of the last fmt:\ntag.", "id": 44095, "time": "2003-09-12T09:22:29Z", "bug_id": 23128, "creation_time": "2003-09-12T09:22:29Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 23128, "attachment_id": null, "text": "I think that the second implementation mentioned in bug 6569 was the correct\none according to the spec, so you can just return back to it:\n\n    public void setLocale(Locale locale) {\n        [...]\n        this.locale = locale;\n        if ((this.encoding == null) && (this.context != null)) {\n            CharsetMapper mapper = context.getCharsetMapper();\n            this.encoding = mapper.getCharset(locale);\n            if ((contentType != null) && (contentType.indexOf(';') < 0)) {\n                contentType = contentType + \";charset=\" + encoding;\n            }\n        }\n    }\n\n", "id": 44096, "time": "2003-09-12T09:31:03Z", "creator": "makub@ics.muni.cz", "creation_time": "2003-09-12T09:31:03Z", "is_private": false}, {"count": 2, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 57930, "time": "2004-05-23T18:55:21Z", "bug_id": 23128, "creation_time": "2004-05-23T18:55:21Z", "is_private": false, "text": "I am afraid that this bug is invalid.\n\nThe TC4 implementation of setLocale() is consistent with the 2.3 spec.\nThe TC5 implementation of setLocale() is consistent with the 2.4 spec.\n\nThe issue you identify is a valid one but the problem is with the spec, not \nwith Tomcat's implementation of it - this is why it was clarified in 2.4. To \nmaintain consistency between servlet containers tomcat has to implement the \nspec as written. If servlet container imlementations start diverging from the \nspec to fix issues such as this the whole concept of portability goes out of \nthe window."}, {"attachment_id": null, "tags": [], "bug_id": 23128, "text": "*** Bug 23195 has been marked as a duplicate of this bug. ***", "count": 3, "id": 57935, "time": "2004-05-23T20:02:03Z", "creator": "markt@apache.org", "creation_time": "2004-05-23T20:02:03Z", "is_private": false}]