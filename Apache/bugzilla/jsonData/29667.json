[{"count": 0, "tags": [], "bug_id": 29667, "text": "The proxy_detect functions does not detect local URIs when apache listens on\nmore than the default ports, even when the virtual hosts are setup correctly.\n\nPort 80\nListen 8102\nServerName proxy.local\n<virtualhost _default_:80>\n    ServerAlias proxy\n    ServerAlias 192.168.1.19\n</virtualhost>\n<virtualhost _default_:8102>\n    ServerAlias proxy\n    ServerAlias 192.168.1.19\n</virtualhost>\n\n\nWhen having ProxyRequests Off\n\nWhen requesting /index.php proxy settings to 192.168.1.19:80:\n REMOTE_ADDR = 192.168.1.32\n SERVER_PORT = 80\n\nWhen requesting /index.php proxy settings to 192.168.1.19:8102:\n REMOTE_ADDR = 192.168.1.32\n SERVER_PORT = 8102\n\n\nWhen having ProxyRequests On\n\nWhen requesting /index.php proxy settings to 192.168.1.19:80:\n REMOTE_ADDR = 192.168.1.32\n SERVER_PORT = 80\n\nWhen requesting /index.php proxy settings to 192.168.1.19:8102:\n REMOTE_ADDR = 192.168.1.19\n SERVER_PORT = 80\n\nAnd the accesslog shows an extra line indicating the initial request has been\nproxied even for local URI.\n\nApplying the following patch resolves this behaviour:\n\n--- mod_proxy-old.c\tFri Jun 18 12:04:56 2004\n+++ mod_proxy.c\tFri Jun 18 11:21:14 2004\n@@ -154,7 +154,7 @@\n         if (!(r->parsed_uri.hostname\n               && !strcasecmp(r->parsed_uri.scheme, ap_http_method(r))\n               && ap_matches_request_vhost(r, r->parsed_uri.hostname,\n-        r->parsed_uri.port_str ? r->parsed_uri.port : ap_default_port(r)))) {\n+        r->parsed_uri.port_str ? r->parsed_uri.port :\nhtons(r->connection->local_addr.sin_port) ))) {\n             r->proxyreq = STD_PROXY;\n             r->uri = r->unparsed_uri;\n             r->filename = ap_pstrcat(r->pool, \"proxy:\", r->uri, NULL);", "id": 59472, "time": "2004-06-18T11:11:56Z", "creator": "tnimble@xs4all.nl", "creation_time": "2004-06-18T11:11:56Z", "is_private": false, "attachment_id": null}]