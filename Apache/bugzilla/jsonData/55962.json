[{"count": 0, "tags": [], "creator": "mike.rumph@oracle.com", "attachment_id": null, "is_private": false, "id": 172119, "time": "2014-01-06T18:08:13Z", "bug_id": 55962, "creation_time": "2014-01-06T18:08:13Z", "text": "Presenting the following discussion from the Apache httpd dev mailing list as a bug report:\n- http://mail-archives.apache.org/mod_mbox/httpd-dev/201312.mbox/%3C52B3426B.4060203%40oracle.com%3E\n\nThe remoteip_modify_request() function in mod_remoteip.c processes the value in the RemoteIPHeader header in a while loop from right to left.\nIn the first pass the c->client_ip is taken as the user agent IP.\nThen the user agent is compared against the trusted proxy list.\nThe elements in the trusted proxy list are of two types (internal or external) from the RemoteIPInternalProxy and RemoteIPTrusted directives.\nIf the user agent matches an element in the proxy list,\nthen it is trusted to present the previous IP address in the RemoteIPHeader header value.\nThe current code allows internal proxies to present external proxies and external proxies to present internal proxies.\nBut an internal proxy presented by an external proxy should be considered external."}, {"count": 1, "tags": [], "text": "Created attachment 31175\nPatch to prevent an external proxy from presenting an internal proxy.\n\nI have attached a patch against mod_remoteip.c in httpd trunk.\nThis patch will prevent an external proxy from presenting an internal proxy.\nThe presented internal proxy will be considered external.\nThis patch documents the case where no RemoteIPInternalProxy or RemoteIPTrustedProxy directive is configured.\nThe patch also includes the essential patch from bug 54651.\n\nThe patch can be verified with the following setup which are variations from bug 55635:\n\nThis tests some internal-external-internal proxy combinations.\n\nLogFormat \"%h %a %{c}a xf=\\\"%{X-Forwarded-For}i\\\" %l %u %t \\\"%r\\\" %>s %b\" forward\nCustomLog \"logs/access_log\" forward\n\n<Location /test>\n        Order Deny,Allow\n        Deny from all\n        Allow from localhost 127.0.0.1 1.1.1.1\n</Location>\n\nRemoteIPHeader X-Forwarded-For\nRemoteIPInternalProxy 10.1.2.3\nRemoteIPInternalProxy 87.245.198.54\nRemoteIPTrustedProxy 87.250.250.203\n- $ curl -v -H \"X-Forwarded-For: 1.1.1.2, 1.1.1.1, 87.245.198.54, 87.250.250.203\" http://10.1.2.3:8080/test/ \n- $ curl -v -H \"X-Forwarded-For: 1.1.1.2, 10.1.1.1, 87.245.198.54, 87.250.250.203\" http://10.1.2.3:8080/test/", "attachment_id": 31175, "bug_id": 55962, "id": 172120, "time": "2014-01-06T18:31:03Z", "creator": "mike.rumph@oracle.com", "creation_time": "2014-01-06T18:31:03Z", "is_private": false}, {"count": 2, "tags": [], "creator": "mike.rumph@oracle.com", "attachment_id": null, "text": "Committed to trunk in r1588330.", "id": 174687, "time": "2014-04-17T18:22:09Z", "bug_id": 55962, "creation_time": "2014-04-17T18:22:09Z", "is_private": false}, {"text": "Proposed for backport", "tags": [], "bug_id": 55962, "attachment_id": null, "count": 3, "id": 188372, "time": "2016-02-11T17:39:06Z", "creator": "wrowe@apache.org", "creation_time": "2016-02-11T17:39:06Z", "is_private": false}, {"text": "Backported to 2.4.19 in r1730684.", "tags": [], "bug_id": 55962, "is_private": false, "count": 4, "id": 188488, "time": "2016-02-17T00:08:46Z", "creator": "mike.rumph@oracle.com", "creation_time": "2016-02-17T00:08:46Z", "attachment_id": null}, {"text": "(FYI Mike, if you commit the backport, mark as resolved :)  Thanks!", "tags": [], "bug_id": 55962, "is_private": false, "count": 5, "id": 188615, "time": "2016-02-19T18:00:02Z", "creator": "wrowe@apache.org", "creation_time": "2016-02-19T18:00:02Z", "attachment_id": null}]