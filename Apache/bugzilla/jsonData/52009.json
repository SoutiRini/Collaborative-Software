[{"count": 0, "text": "1. I copied activemq-all-5.4.2.jar, commons-logging-1.1.jar to tomcat lib folder\n2. Edit tomcat-user.xml, context.xml, server.xml as below:\n\nChanges  in server.xml:\n\n<Resource  name=\"jms/broker\" auth=\"Container\" \n        type=\"org.apache.activemq.ActiveMQConnectionFactory\" description=\"JMS Connection Factory\"\n        factory=\"org.apache.activemq.jndi.JNDIReferenceFactory\" brokerURL=\"tcp://localhost:61616\" brokerName=\"ActiveMQBroker\" useEmbeddedBroker=\"false\" />\n        \n    <Resource name=\"jms/topic/MyTopic\" auth=\"Container\" type=\"org.apache.activemq.command.ActiveMQTopic\" factory=\"org.apache.activemq.jndi.JNDIReferenceFactory\" physicalName=\"APP.JMS.TOPIC\" />\n\n<Resource name=\"jms/queue/MyQueue\" auth=\"Container\" type=\"org.apache.activemq.command.ActiveMQQueue\" factory=\"org.apache.activemq.jndi.JNDIReferenceFactory\" physicalName=\"APP.JMS.QUEUE\" />\n\n\n<Connector acceptorThreadPriority=\"1\" allowTrace=\"true\" asyncTimeout=\"10000\" connectionLinger=\"25\" connectionTimeout=\"60000\" name=\"NIOConnector\" pollerThreadPriority=\"1\" port=\"8888\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\" redirectPort=\"8443\" tcpNoDelay=\"false\"/>\n\nChanges in context.xml\n\n<ResourceLink global=\"jms/broker\" name=\"jms/broker\" type=\"javax.jms.ConnectionFactory\"/>\n<ResourceLink global=\"jms/topic/MyTopic\" name=\"jms/topic/MyTopic\" type=\"javax.jms.Topic\"/>\n<ResourceLink global=\"jms/queue/MyQueue\" name=\"jms/queue/MyQueue\" type=\"javax.jms.Queue\"/>\n\nYou can also get these file from attached zip\n\nThen access\nhttp://localhost:8080/manager/text/resources, got three JMS resource i defined \n\nOK - Listed global resources of all types\njms/topic/MyTopic:org.apache.activemq.command.ActiveMQTopic\njms/queue/MyQueue:org.apache.activemq.command.ActiveMQQueue\njms/broker:org.apache.activemq.ActiveMQConnectionFactory\nUserDatabase:org.apache.catalina.users.MemoryUserDatabase\n\n3. Start apache-activemq-5.4.2, create topic APP.JMS.TOPIC, and queque: APP.JMS.QUEUE\n\n4. Put sample files QuoteStreamerApp.war as attached in webapp folder, then it will report errors, but if don't define NIO connector, this error doesn't exist\n\n2011-10-11 15:53:01 org.apache.catalina.startup.HostConfig checkResources\nINFO: Undeploying context [/QuoteStreamerApp]\n2011-10-11 15:53:11 org.apache.catalina.startup.HostConfig deployWAR\nINFO: Deploying web application archive QuoteStreamerApp.war\n2011-10-11 15:53:52 com.ibm.websphere.webmsg.quotestreamer.AppInit init\nINFO: DataSimulator successfully created and set and started.\n2011-10-11 15:54:01 com.ibm.webmsg.example.StockServlet setProperties\nINFO: Configured properties for quote streamer requests.\n2011-10-11 15:54:02 com.ibm.webmsg.example.StockServlet registerURL\nINFO: Registered the URL for comet requests.\n2011-10-11 15:54:02 org.apache.coyote.http11.AbstractHttp11Processor process\nSEVERE: Error processing request\njava.lang.NullPointerException\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:436)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:970)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:515)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1550)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\tat java.lang.Thread.run(Thread.java:662)\n2011-10-11 15:54:02 org.apache.coyote.http11.AbstractHttp11Processor process\nSEVERE: Error processing request\njava.lang.NullPointerException\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:436)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:970)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:515)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1550)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\tat java.lang.Thread.run(Thread.java:662)\n2011-10-11 15:54:04 org.apache.coyote.http11.AbstractHttp11Processor process\nSEVERE: Error processing request\njava.lang.NullPointerException\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:436)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:970)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:515)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1550)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\tat java.lang.Thread.run(Thread.java:662)\n2011-10-11 15:54:04 org.apache.coyote.http11.AbstractHttp11Processor process\nSEVERE: Error processing request\njava.lang.NullPointerException\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:436)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:970)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:515)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1550)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\tat java.lang.Thread.run(Thread.java:662)", "bug_id": 52009, "is_private": false, "id": 150454, "time": "2011-10-11T08:06:49Z", "creator": "viola.lu@gmail.com", "creation_time": "2011-10-11T08:06:49Z", "tags": [], "attachment_id": null}, {"count": 1, "text": "(In reply to comment #0)\n> You can also get these file from attached zip\n> 4. Put sample files QuoteStreamerApp.war as attached in webapp folder\n\n1) You forgot to attach the files.\n\n> \n> 2011-10-11 15:53:01 org.apache.catalina.startup.HostConfig checkResources\n> INFO: Undeploying context [/QuoteStreamerApp]\n\n2) What happened before the above line?  Undeploying/redeploying the webapp is not mentioned in your reproduction scenario.\n\nIt would better to see the full logs. You may attach them to the issue - no need to paste them into the text field.\n\n3) What pages should I access in web browser to reproduce the issue? It is not mentioned. (The logs say that CoyoteAdapter processes a request. What a request that is?)", "bug_id": 52009, "is_private": false, "id": 150483, "time": "2011-10-12T02:57:34Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2011-10-12T02:57:34Z", "tags": [], "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 52009, "attachment_id": 27764, "is_private": false, "id": 150484, "time": "2011-10-12T03:07:05Z", "creator": "viola.lu@gmail.com", "creation_time": "2011-10-12T03:07:05Z", "text": "Created attachment 27764\ntomcat configuration\n\ntomcat configuration"}, {"count": 3, "tags": [], "bug_id": 52009, "attachment_id": null, "is_private": false, "id": 150485, "time": "2011-10-12T03:18:05Z", "creator": "viola.lu@gmail.com", "creation_time": "2011-10-12T03:18:05Z", "text": "Hi, Konstantin:\n\n Errors were generated when tomcat start. I just directly put it before tomcat start, so it failed when start tomcat. You can start tomcat, and then put it in webapp folder to recreate it. \n\nI already sent you the application in gmail, which is so large to attache here.\n\nI tried to debug it, but failed to get request.\n\nMay i can add a println to get request in this tomcat code.\n\nFull log, but i can't get any hints from this log, is there log level option i can change, so ii can get more details?\n2011-10-11 15:52:19 org.apache.catalina.startup.HostConfig deployWAR\nINFO: Deploying web application archive QuoteStreamerApp.war\n2011-10-11 15:52:20 org.apache.catalina.startup.HostConfig deployDirectory\nINFO: Deploying web application directory docs\n2011-10-11 15:52:20 org.apache.catalina.startup.HostConfig deployDirectory\nINFO: Deploying web application directory examples\n2011-10-11 15:52:20 org.apache.catalina.startup.HostConfig deployDirectory\nINFO: Deploying web application directory host-manager\n2011-10-11 15:52:20 org.apache.catalina.startup.HostConfig deployDirectory\nINFO: Deploying web application directory manager\n2011-10-11 15:52:20 org.apache.catalina.startup.HostConfig deployDirectory\nINFO: Deploying web application directory ROOT\n2011-10-11 15:52:20 org.apache.coyote.AbstractProtocol start\nINFO: Starting ProtocolHandler [\"http-bio-8080\"]\n2011-10-11 15:52:20 org.apache.coyote.AbstractProtocol start\nINFO: Starting ProtocolHandler [\"ajp-bio-8009\"]\n2011-10-11 15:52:20 org.apache.coyote.AbstractProtocol start\nINFO: Starting ProtocolHandler [\"http-nio-8888\"]\n2011-10-11 15:52:20 org.apache.catalina.startup.Catalina start\nINFO: Server startup in 3328 ms\n2011-10-11 15:53:01 org.apache.catalina.startup.HostConfig checkResources\nINFO: Undeploying context [/QuoteStreamerApp]\n2011-10-11 15:53:11 org.apache.catalina.startup.HostConfig deployWAR\nINFO: Deploying web application archive QuoteStreamerApp.war\n2011-10-11 15:53:52 com.ibm.websphere.webmsg.quotestreamer.AppInit init\nINFO: DataSimulator successfully created and set and started.\n2011-10-11 15:54:01 com.ibm.webmsg.example.StockServlet setProperties\nINFO: Configured properties for quote streamer requests.\n2011-10-11 15:54:02 com.ibm.webmsg.example.StockServlet registerURL\nINFO: Registered the URL for comet requests.\n2011-10-11 15:54:02 org.apache.coyote.http11.AbstractHttp11Processor process\nSEVERE: Error processing request\njava.lang.NullPointerException\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:436)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:970)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:515)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1550)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\tat java.lang.Thread.run(Thread.java:662)\n2011-10-11 15:54:02 org.apache.coyote.http11.AbstractHttp11Processor process\nSEVERE: Error processing request\njava.lang.NullPointerException\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:436)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:970)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:515)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1550)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\tat java.lang.Thread.run(Thread.java:662)\n2011-10-11 15:54:04 org.apache.coyote.http11.AbstractHttp11Processor process\nSEVERE: Error processing request\njava.lang.NullPointerException\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:436)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:970)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:515)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1550)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\tat java.lang.Thread.run(Thread.java:662)\n2011-10-11 15:54:04 org.apache.coyote.http11.AbstractHttp11Processor process\nSEVERE: Error processing request\njava.lang.NullPointerException\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:436)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:970)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:515)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1550)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\tat java.lang.Thread.run(Thread.java:662)\n2011-10-11 15:54:07 org.apache.coyote.AbstractProtocol pause\nINFO: Pausing ProtocolHandler [\"http-bio-8080\"]\n2011-10-11 15:54:08 org.apache.coyote.AbstractProtocol pause\nINFO: Pausing ProtocolHandler [\"ajp-bio-8009\"]\n2011-10-11 15:54:08 org.apache.coyote.http11.AbstractHttp11Processor process\nSEVERE: Error processing request\njava.lang.NullPointerException\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:436)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:970)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:515)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1550)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\tat java.lang.Thread.run(Thread.java:662)\n2011-10-11 15:54:09 org.apache.coyote.AbstractProtocol pause\nINFO: Pausing ProtocolHandler [\"http-nio-8888\"]\n2011-10-11 15:54:10 org.apache.catalina.core.StandardService stopInternal\nINFO: Stopping service Catalina\n2011-10-11 15:54:10 org.apache.catalina.loader.WebappClassLoader clearReferencesThreads\nSEVERE: The web application [/QuoteStreamerApp] appears to have started a thread named [ActiveMQConnection[ID:IBM-R86F1CF-2194-1318319631890-0:1] Scheduler] but has failed to stop it. This is very likely to create a memory leak.\n2011-10-11 15:54:10 org.apache.catalina.loader.WebappClassLoader clearReferencesThreads\nSEVERE: The web application [/QuoteStreamerApp] appears to have started a thread named [ActiveMQ Transport: tcp://localhost/127.0.0.1:61616] but has failed to stop it. This is very likely to create a memory leak.\n2011-10-11 15:54:10 org.apache.catalina.loader.WebappClassLoader clearReferencesThreads\nSEVERE: The web application [/QuoteStreamerApp] appears to have started a thread named [InactivityMonitor ReadCheck] but has failed to stop it. This is very likely to create a memory leak.\n2011-10-11 15:54:10 org.apache.catalina.loader.WebappClassLoader clearReferencesThreads\nSEVERE: The web application [/QuoteStreamerApp] appears to have started a thread named [InactivityMonitor WriteCheck] but has failed to stop it. This is very likely to create a memory leak.\n2011-10-11 15:54:10 org.apache.catalina.loader.WebappClassLoader clearReferencesThreads\nSEVERE: The web application [/QuoteStreamerApp] appears to have started a thread named [Timer-0] but has failed to stop it. This is very likely to create a memory leak.\n2011-10-11 15:54:10 org.apache.catalina.loader.WebappClassLoader clearReferencesThreads\nSEVERE: The web application [/QuoteStreamerApp] appears to have started a thread named [ActiveMQConnection[ID:IBM-R86F1CF-2194-1318319631890-0:2] Scheduler] but has failed to stop it. This is very likely to create a memory leak.\n2011-10-11 15:54:10 org.apache.catalina.loader.WebappClassLoader clearReferencesThreads\nSEVERE: The web application [/QuoteStreamerApp] appears to have started a thread named [ActiveMQ Transport: tcp://localhost/127.0.0.1:61616] but has failed to stop it. This is very likely to create a memory leak.\n2011-10-11 15:54:10 org.apache.catalina.loader.WebappClassLoader clearReferencesThreads\nSEVERE: The web application [/QuoteStreamerApp] appears to have started a thread named [Thread-18] but has failed to stop it. This is very likely to create a memory leak.\n2011-10-11 15:54:10 org.apache.catalina.loader.WebappClassLoader clearReferencesThreads\nSEVERE: The web application [/QuoteStreamerApp] appears to have started a thread named [ActiveMQ Session Task] but has failed to stop it. This is very likely to create a memory leak.\n2011-10-11 15:54:10 org.apache.catalina.loader.WebappClassLoader clearReferencesThreads\nSEVERE: The web application [/QuoteStreamerApp] appears to have started a thread named [ActiveMQ Session Task] but has failed to stop it. This is very likely to create a memory leak.\n2011-10-11 15:54:10 org.apache.coyote.AbstractProtocol stop\nINFO: Stopping ProtocolHandler [\"http-bio-8080\"]\n2011-10-11 15:54:10 org.apache.coyote.AbstractProtocol stop\nINFO: Stopping ProtocolHandler [\"ajp-bio-8009\"]\n2011-10-11 15:54:10 org.apache.coyote.AbstractProtocol stop\nINFO: Stopping ProtocolHandler [\"http-nio-8888\"]\n2011-10-11 15:54:10 org.apache.coyote.AbstractProtocol destroy\nINFO: Destroying ProtocolHandler [\"http-bio-8080\"]\n2011-10-11 15:54:10 org.apache.coyote.AbstractProtocol destroy\nINFO: Destroying ProtocolHandler [\"ajp-bio-8009\"]\n2011-10-11 15:54:10 org.apache.coyote.AbstractProtocol destroy\nINFO: Destroying ProtocolHandler [\"http-nio-8888\"]"}, {"count": 4, "tags": [], "bug_id": 52009, "attachment_id": null, "is_private": false, "id": 150486, "time": "2011-10-12T04:31:05Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2011-10-12T04:31:05Z", "text": "> I already sent you the application in gmail, which is so large to attache here.\n\n1) I bet that you do not need all 25 Mb of dojox components of dojotoolkit.\n\nThe NPE issue is still reproducible if I delete the dojox folder from the webapp and that shrinks its size significantly.\n\n2) Source code for StockServlet is there - thank you, but sources of its parent class BayeuxServlet is not available.\n\n3) To reproduce the issue, open http://localhost:8888/QuoteStreamerApp/\n\nJust open the page in browser and leave it open.\n\nThe page sends a flow of POST requests to\n/QuoteStreamerApp/stockServlet HTTP/1.1\n\n4) I am running with the following line added to catalina.properties file:\norg.apache.coyote.http11.InternalNioInputBuffer.level = FINE\n\nand it shows that there are problems in BayeuxServlet that it calls setHeader() on a response that has already been recycled.\nIt is an application error. This is unacceptable and can lead to updating a response that is being delivered to a different client.\n\nStacktrace in localhost.2011-10-12.log:\n\n12-\u043e\u043a\u0442-2011 08:04:02.078 SEVERE [http-nio-8888-exec-8] org.apache.catalina.core.StandardWrapperValve.event Servlet.service() for servlet [StockServlet] in context with path [/QuoteStreamerApp] threw exception\n java.lang.IllegalStateException: The response object has been recycled and is no longer associated with this facade\n\tat org.apache.catalina.connector.ResponseFacade.isCommitted(ResponseFacade.java:325)\n\tat org.apache.catalina.connector.ResponseFacade.setHeader(ResponseFacade.java:518)\n\tat com.ibm.ws.webmsg.servlet.adapter.ServletResponse.setHeader(ServletResponse.java:147)\n\tat com.ibm.ws.webmsg.client.bayeux.protocol.vone.JSONTransport.endResponse(JSONTransport.java:191)\n\tat com.ibm.ws.webmsg.client.bayeux.protocol.vone.processor.EventDeliveryProcessor.close(EventDeliveryProcessor.java:139)\n\tat com.ibm.ws.webmsg.client.bayeux.protocol.vone.WASCEClientImpl.shutdown(WASCEClientImpl.java:117)\n\tat com.ibm.ws.webmsg.client.bayeux.protocol.vone.processor.DisconnectProcessor.processMessage(DisconnectProcessor.java:63)\n\tat com.ibm.ws.webmsg.client.bayeux.protocol.vone.ClientImpl.processRequest(ClientImpl.java:332)\n\tat com.ibm.webmsg.servlet.BayeuxServlet.handleRead(BayeuxServlet.java:233)\n\tat com.ibm.webmsg.servlet.BayeuxServlet.event(BayeuxServlet.java:210)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilterEvent(ApplicationFilterChain.java:482)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilterEvent(ApplicationFilterChain.java:376)\n\tat org.apache.catalina.core.StandardWrapperValve.event(StandardWrapperValve.java:414)\n\tat org.apache.catalina.core.StandardContextValve.event(StandardContextValve.java:192)\n\tat org.apache.catalina.valves.ValveBase.event(ValveBase.java:226)\n\tat org.apache.catalina.core.StandardHostValve.event(StandardHostValve.java:245)\n\tat org.apache.catalina.valves.ValveBase.event(ValveBase.java:226)\n\tat org.apache.catalina.valves.ValveBase.event(ValveBase.java:226)\n\tat org.apache.catalina.core.StandardEngineValve.event(StandardEngineValve.java:138)\n\tat org.apache.catalina.connector.CoyoteAdapter.event(CoyoteAdapter.java:211)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:411)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:970)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:515)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1550)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\tat java.lang.Thread.run(Thread.java:662)\n\n\n5) There are a lot of exceptions like\njavax.jms.JMSException: Could not connect to broker URL: tcp://localhost:61616. Reason: java.net.ConnectException: Connection refused: connect\n\nbut the NullPointerException at CoyoteAdapter.java:436 is reproducible.\n\n6) The NPE is reproducible both in 7.0.22 and in trunk.\n\n\nThe requests to of them fail with error 500, but response sizes in different requests are different.\n\nI noted the following while debugging trunk:\n\n1. In access log all requests are POST to /QuoteStreamerApp/stockServlet.\nThey all fail with error 500, but response sizes are different.\n\n2. After the call to getPipeline().getFirst().invoke(request, response) the value of request.isComet() is true.\n\n3. The cause for NPE at CoyoteAdapter.java:436 is that at that point the request is already recycled and request.getMappingData().context  is null.\n\n4. The recycling happens in the finally block in CoyoteAdapter#event(..),\nlines 252-254:\n            if (error || response.isClosed() || !request.isComet()) {\n                request.recycle();\n                request.setFilterChain(null);\n                response.recycle();\n            }\n\nI do not know much about request that is being recycled. It is not the first request that was received.\n\n5. If I put breakpoint on the request.recycle() call above, the call stack is:\n\nCoyoteAdapter.event(Request, Response, SocketStatus) line: 252\t\nCoyoteAdapter.service(Request, Response) line: 411\t\nHttp11NioProcessor(AbstractHttp11Processor<S>).process(SocketWrapper<S>) line: 970\t\nHttp11NioProtocol$Http11ConnectionHandler(AbstractProtocol$AbstractConnectionHandler<S,P>).process(SocketWrapper<S>, SocketStatus) line: 515\t\nNioEndpoint$SocketProcessor.run() line: 1550\t\n\nAfter returning from event() call on CoyoteAdapter:411 (the call returns false) the lines 431..440 are executed:\n            } else if (!comet) {\n                request.finishRequest();\n                response.finishResponse();\n                if (postParseSuccess) {\n                    // Log only if processing was invoked.\n                    // If postParseRequest() failed, it has already logged it.\n                    ((Context) request.getMappingData().context).logAccess(\n                            request, response,\n                            System.currentTimeMillis() - req.getStartTime(),\n                            false);\n                }\n\nThe comet variable is false and postParseSuccess is true.\nThe request is already recycled and request.getMappingData().context is null, leading to an NPE."}, {"count": 5, "tags": [], "bug_id": 52009, "is_private": false, "id": 150494, "creation_time": "2011-10-12T13:01:40Z", "time": "2011-10-12T13:01:40Z", "creator": "viola.lu@gmail.com", "text": "You should start an activemq server, then javax.jms.JMSException will be gone.\n\nI already sent you source of project, pls check your gmail.\n\nThanks in advance!", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 52009, "attachment_id": null, "is_private": false, "id": 150509, "time": "2011-10-13T07:11:46Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2011-10-13T07:11:46Z", "text": "(In reply to comment #4)\n> 4) I am running with the following line added to catalina.properties file:\n> org.apache.coyote.http11.InternalNioInputBuffer.level = FINE\n\nOps. I meant the following line:\norg.apache.catalina.connector.RECYCLE_FACADES=true\n\n> \n> and it shows that there are problems in BayeuxServlet that it calls setHeader()\n> on a response that has already been recycled. (...)"}, {"count": 7, "tags": [], "bug_id": 52009, "attachment_id": null, "is_private": false, "id": 150557, "time": "2011-10-14T11:11:54Z", "creator": "markt@apache.org", "creation_time": "2011-10-14T11:11:54Z", "text": "Adding users to the cc list without their explicit permission is extremely rude. You MUST NOT do this. Repeated abuse of Bugzilla in this or any other way will result in your access to Bugzilla being blocked.\n\nAll changes to any Bugzilla issues is automatically routed to the appropriate dev list where all the Apache committers for a project will see it."}, {"count": 8, "tags": [], "bug_id": 52009, "text": "(In reply to comment #4)\n> 4) I am running with the following line added to catalina.properties file:\n> org.apache.catalina.connector.RECYCLE_FACADES=true\n> \n> and it shows that there are problems in BayeuxServlet that it calls setHeader()\n> on a response that has already been recycled.\n> It is an application error. This is unacceptable and can lead to updating a\n> response that is being delivered to a different client.\n\nYep. That makes this an application / Bayeux library error rather than a Tomcat bug.", "id": 150564, "time": "2011-10-14T12:58:03Z", "creator": "markt@apache.org", "creation_time": "2011-10-14T12:58:03Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 52009, "attachment_id": null, "text": "(In reply to comment #8)\n> (In reply to comment #4)\n> > 4) I am running with the following line added to catalina.properties file:\n> > org.apache.catalina.connector.RECYCLE_FACADES=true\n> Yep. That makes this an application / Bayeux library error rather than a Tomcat\n> bug.\n\nSee in comment #4:\n> 6) The NPE is reproducible both in 7.0.22 and in trunk.\n> (..) \n> \n> 3. The cause for NPE at CoyoteAdapter.java:436 is that at that point the\n> request is already recycled and request.getMappingData().context  is null.\n> \n> 4. The recycling happens in the finally block in CoyoteAdapter#event(..),\n> lines 252-254:\n>             if (error || response.isClosed() || !request.isComet()) {\n>                 request.recycle();\n>                 request.setFilterChain(null);\n>                 response.recycle();\n>             }\n> \n> I do not know much about request that is being recycled. It is not the first\n> request that was received.\n> \n> 5. If I put breakpoint on the request.recycle() call above, the call stack is:\n> \n> CoyoteAdapter.event(Request, Response, SocketStatus) line: 252    \n> CoyoteAdapter.service(Request, Response) line: 411    \n> Http11NioProcessor(AbstractHttp11Processor<S>).process(SocketWrapper<S>) line:\n> 970    \n> Http11NioProtocol$Http11ConnectionHandler(AbstractProtocol$AbstractConnectionHandler<S,P>).process(SocketWrapper<S>,\n> SocketStatus) line: 515    \n> NioEndpoint$SocketProcessor.run() line: 1550    \n> \n> After returning from event() call on CoyoteAdapter:411 (the call returns false)\n> the lines 431..440 are executed:\n>             } else if (!comet) {\n>                 request.finishRequest();\n>                 response.finishResponse();\n>                 if (postParseSuccess) {\n>                     // Log only if processing was invoked.\n>                     // If postParseRequest() failed, it has already logged it.\n>                     ((Context) request.getMappingData().context).logAccess(\n>                             request, response,\n>                             System.currentTimeMillis() - req.getStartTime(),\n>                             false);\n>                 }\n> \n> The comet variable is false and postParseSuccess is true.\n> The request is already recycled and request.getMappingData().context is null,\n> leading to an NPE.\n\nThe above is a legitimate bug. Recycling in event() -> returning to service() -> NPE when trying to log it.", "id": 150565, "time": "2011-10-14T13:05:10Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2011-10-14T13:05:10Z", "is_private": false}, {"count": 10, "tags": [], "creator": "viola.lu@gmail.com", "attachment_id": null, "text": "Hi, Mark:\n\n Sorry to add you to the cc list without notification in advance. I tried to send email to markt@apache.org, but rejected, and you are the NIO connector code owner, so i did it. Thanks for your understanding.\n\n This application can work on tomcat 6.0.19, but failed in trunk and 7.0.9/22, so i think it's tomcat nio connector problem. If i don't add NIO connector to server.xml, there is no exception.", "id": 150568, "time": "2011-10-14T13:25:24Z", "bug_id": 52009, "creation_time": "2011-10-14T13:25:24Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 52009, "text": "(In reply to comment #9)\n> > 5. If I put breakpoint on the request.recycle() call above, the call stack is:\n> > \n> > CoyoteAdapter.event(Request, Response, SocketStatus) line: 252    \n> > CoyoteAdapter.service(Request, Response) line: 411    \n> > Http11NioProcessor(AbstractHttp11Processor<S>).process(SocketWrapper<S>) line:\n> > 970    \n> > Http11NioProtocol$Http11ConnectionHandler(AbstractProtocol$AbstractConnectionHandler<S,P>).process(SocketWrapper<S>,\n> > SocketStatus) line: 515    \n> > NioEndpoint$SocketProcessor.run() line: 1550    \n> > \n> > After returning from event() call on CoyoteAdapter:411 (the call returns false)\n> > the lines 431..440 are executed:\n> >             } else if (!comet) {\n> >                 request.finishRequest();\n> >                 response.finishResponse();\n> >                 if (postParseSuccess) {\n> >                     // Log only if processing was invoked.\n> >                     // If postParseRequest() failed, it has already logged it.\n> >                     ((Context) request.getMappingData().context).logAccess(\n> >                             request, response,\n> >                             System.currentTimeMillis() - req.getStartTime(),\n> >                             false);\n> >                 }\n> > \n> > The comet variable is false and postParseSuccess is true.\n> > The request is already recycled and request.getMappingData().context is null,\n> > leading to an NPE.\n> \n> The above is a legitimate bug. Recycling in event() -> returning to service()\n> -> NPE when trying to log it.\n\nSorry. Missed that. I'll take a look.\n\n(In reply to comment #10)\n> Hi, Mark:\n> \n> Sorry to add you to the cc list without notification in advance. I tried to\n> send email to markt@apache.org, but rejected, and you are the NIO connector\n> code owner, so i did it. Thanks for your understanding.\n\n1. I am not the maintainer of the NIO code. All of the committers work on all of the code base. There are no project or component leads at the ASF.\n\n2. Sending private mails to individual committers is also frowned upon and most committers (me included) reject or ignore them. The only place to discuss change to the Tomcat code base is the dev@tomcat.a.o mailing list.\n\n>  This application can work on tomcat 6.0.19, but failed in trunk and 7.0.9/22,\n> so i think it's tomcat nio connector problem. If i don't add NIO connector to\n> server.xml, there is no exception.\n\nSee above.", "id": 150574, "time": "2011-10-14T15:03:08Z", "creator": "markt@apache.org", "creation_time": "2011-10-14T15:03:08Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 52009, "text": "The NPE has been fixed in trunk and 7.0.x and will be included in 7.0.23 onwards.", "id": 150590, "time": "2011-10-14T20:59:48Z", "creator": "markt@apache.org", "creation_time": "2011-10-14T20:59:48Z", "is_private": false, "attachment_id": null}, {"count": 13, "tags": [], "bug_id": 52009, "text": "Thanks for your quick response. I run the test app against, no exception now. Thanks again.\nIf i offended you , pls forgive. THanks.", "id": 150653, "time": "2011-10-17T03:35:53Z", "creator": "viola.lu@gmail.com", "creation_time": "2011-10-17T03:35:53Z", "is_private": false, "attachment_id": null}, {"count": 14, "tags": [], "creator": "dkwakkel@gmail.com", "attachment_id": null, "text": "I think this issue is reintroduced in tomcat 7.0.68.\nI see in http://svn.apache.org/repos/asf/tomcat/tc7.0.x/tags/TOMCAT_7_0_67/java/org/apache/catalina/connector/CoyoteAdapter.java:\n{code}\nif (postParseSuccess &&\n                        request.getMappingData().context != null) {\n                    // Log only if processing was invoked.\n                    // If postParseRequest() failed, it has already logged it.\n                    // If context is null this was the start of a comet request\n                    // that failed and has already been logged.\n                    ((Context) request.getMappingData().context).logAccess(\n{code}\nWhile in http://svn.apache.org/repos/asf/tomcat/tc7.0.x/tags/TOMCAT_7_0_68/java/org/apache/catalina/connector/CoyoteAdapter.java:\n{code}\n   if (postParseSuccess) {\n                        // Log only if processing was invoked.\n                        // If postParseRequest() failed, it has already logged it.\n                        // If context is null this was the start of a comet request\n                        // that failed and has already been logged.\n                        ((Context) request.getMappingData().context).logAccess(\n{code}\nI can not find out where this has been changed from svn logs :-(\nDo you want me to log a new ticket for this?", "id": 200119, "time": "2017-07-31T14:07:42Z", "bug_id": 52009, "creation_time": "2017-07-31T14:07:42Z", "is_private": false}, {"text": "http://svn.apache.org/viewvc?view=revision&revision=1720757", "tags": [], "bug_id": 52009, "is_private": false, "count": 15, "id": 200120, "time": "2017-07-31T14:20:38Z", "creator": "bodewig@apache.org", "creation_time": "2017-07-31T14:20:38Z", "attachment_id": null}, {"count": 16, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 200123, "time": "2017-07-31T19:59:47Z", "bug_id": 52009, "creation_time": "2017-07-31T19:59:47Z", "text": "This bug is fixed. If you are experiencing a similar bug then please open a new issue and provide the steps to reproduce it from a clean Tomcat install."}]