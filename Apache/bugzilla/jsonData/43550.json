[{"count": 0, "text": "Query strings are not being passed along when mod_negotiation\ncombines  multiviews with typemap processing. This is a regression\ncompared to the behavior we had on Apache 1.3.x. It is complementary\nto PR 33112, which fixed a similar problem, but in a different part\nof the same module.\n\nThe guilty party is the call to\n\n   ap_internal_fast_redirect(sub_req, r)\n\nin mod_negotiation.c:handle_multi() which discards the\npreviously parsed args and path_info. That info is\nnot regenerated again. I'm including a very naive patch\nagainst 2.2.6 and trunk that fixes this.  I'm sure there is a\nbetter way to fix it, but need more guidance\nto achieve it in an optimal way.\n\nI'm also submitting a new test for the perl-framework test procedure\nthat tests this behavior, to avoid having this regression in next \nversions.\n\n== Reproducing the bug ==\n\nYou can use either use the new test I'm submitting or use the following \nscenario. Please adjust accordingly\nto your server setup. I assume the use of php\nfor printing out the query parameters; you could use\nperl (like my test procedure contribution does) or a shell script too):\n\n1. In a directory, put the three files that I've attached:\n   test.html, test.php, test.var\n\n2. query the server for test.php?q=3\n\n           http://localhost/test.php?q=3\n\n    ==> you'll see that the query parameters are correctly\n        passed to the script.\n\n3. query the server for test?q=3\n\n           http://localhost/test?q=3\n\n    ==> in this case, the query parameters have been discarded\n        by mod_negotiation's call to\n        ap_internal_fast_redirect inside handle_multi().\n\nYou'll see that my naive solution is to make a backup copy of\nargs and path_info, if they existed, before the call to\nap_internal_fast_redirect(), and then restoring them. This\neffectively solves the bug. I don't know if there's a better\nway to do this.", "bug_id": 43550, "attachment_id": null, "id": 108976, "time": "2007-10-04T06:52:59Z", "creator": "jose@w3.org", "creation_time": "2007-10-04T06:52:59Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "creator": "jose@w3.org", "attachment_id": 20915, "text": "Created attachment 20915\nPatch against 2.2.6\n\nTypemap handling didn't pass the query string and path_info parameters", "id": 108978, "time": "2007-10-04T06:56:05Z", "bug_id": 43550, "creation_time": "2007-10-04T06:56:05Z", "is_private": false}, {"count": 2, "text": "Created attachment 20916\nPatch against trunk\n\nTypemap handling didn't pass the query string and path_info parameters.", "bug_id": 43550, "attachment_id": 20916, "id": 108979, "time": "2007-10-04T06:56:45Z", "creator": "jose@w3.org", "creation_time": "2007-10-04T06:56:45Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "creator": "jose@w3.org", "text": "Created attachment 20917\nNew test procedure for perl-framework for testing typemaps and query string parameters \n\nDESCRIPTION\n\nThe following tests checks that query string parameters are being\ncorrectly passed-on whenever a resource is selected by means\nof a type-map.\n\nCONTENT\n\nThis test has been prepared using the svn trunk version of httpd-test\nand is comprised of:\n\n1. Test htdocs directory:\n\n  httpd-test/perl-framework/t/htdocs/modules/negotiation/ \\\n    typemap_query_string\n      |\n      - test.html\n      |\n      - test.pl\n      |\n      - test.var\n\n2. Patches to both t/conf/extra.conf.in and t/modules/negotiation.t\n   to include the new test\n\n    typemaptest.diff\n\nINSTALLATION\n\n1. Check out the httpd-test directory\n    svn checkout http://svn.apache.org/repos/asf/httpd/test/trunk/ \\\n     httpd-test\n\n2. Install the\n    htdocs/modules/negotiation/typemap_query_string/ directory\n    and files.\n\n     tar -xzf typemapqstest.tgz\n\n3. Patch extra.conf.in and negotiation.t to include the new test\n\n   patch -p0 <typemaptest.diff\n\nDESCRIPTION OF THE TEST\n\nThe test consists in requesting the following resource:\n\n    http://server/..../typemap_query_string/test?foo\n\nIf the query string parameter is being passed correctly, test.pl will\nbe called and will return the string\n    QUERY_STRING --> foo\n\nRUNNING THE TEST\n\n    t/TEST modules/negotiation\n\nThe new test has number #99.\n\nNote that this test will fail unless you apply the patch to\nmod_negotiation which is included in my report.", "id": 108980, "time": "2007-10-04T07:02:25Z", "bug_id": 43550, "creation_time": "2007-10-04T07:02:25Z", "is_private": false, "attachment_id": 20917}, {"attachment_id": 20962, "tags": [], "bug_id": 43550, "text": "Created attachment 20962\nQuery string  were not being handled to resources handled by typemaps (2.2.6 patch)\n\nWhen preparing my patch for submission, I a typo which caused a sigsev. Here's\nthe correct patch.", "count": 4, "id": 109278, "time": "2007-10-11T14:19:27Z", "creator": "jose@w3.org", "creation_time": "2007-10-11T14:19:27Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 43550, "attachment_id": 20963, "text": "Created attachment 20963\nQuery string  were not being handled to resources handled by typemaps (trunk patch)\n\nWhen preparing my patch for submission, I a typo which caused a sigsev.\nHere's the correct patch.", "id": 109279, "time": "2007-10-11T14:21:58Z", "creator": "jose@w3.org", "creation_time": "2007-10-11T14:21:58Z", "is_private": false}, {"count": 6, "tags": [], "creator": "jorton@redhat.com", "text": "Test case added in http://svn.apache.org/viewvc?view=rev&revision=589666 - thanks!", "id": 109883, "time": "2007-10-29T08:06:57Z", "bug_id": 43550, "creation_time": "2007-10-29T08:06:57Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "creator": "rpluem@apache.org", "text": "This seems now fixed by fixing PR33112\n\n*** This bug has been marked as a duplicate of bug 33112 ***", "id": 134826, "time": "2010-02-23T20:07:24Z", "bug_id": 43550, "creation_time": "2010-02-23T20:07:24Z", "is_private": false, "attachment_id": null}]