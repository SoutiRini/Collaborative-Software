[{"count": 0, "tags": [], "creator": "a7cdcq002@sneakemail.com", "attachment_id": null, "id": 75166, "time": "2005-05-21T12:19:11Z", "bug_id": 35000, "creation_time": "2005-05-21T12:19:11Z", "is_private": false, "text": "I've created a ZIP archive to reproduce Sun bug 4615343 (ZipFile.entries()\nthrows java.lang.InternalError). InfoZip's unzip 5.50 also agrees that the\narchive is broken:\n\n---------\n$ unzip -l broken-index.zip \nArchive:  broken-index.zip\nerror [broken-index.zip]:  NULL central directory offset\n  (attempting to process anyway)\n  Length     Date   Time    Name\n --------    ----   ----    ----\n     4096  01-01-80 00:00   1.txt\n     4096  01-01-80 00:00   2.txt\n --------                   -------\n     8192                   2 files\n---------\n\nHowever, if I try to unzip it using the following build.xml, ant neither detects\nan error nor does it extract anything:\n\n---------\n<?xml version=\"1.0\"?>\n<project name=\"unzip-broken-index\" default=\"build\" basedir=\".\">\n    <target name=\"build\">\n        <unzip src=\"broken-index.zip\" dest=\".\"/>\n    </target>\n</project>\n---------\n\nHere's the console output:\n\n---------\n$ ant build\nBuildfile: build.xml\n\nbuild:\n    [unzip] Expanding: .../broken-index.zip into ...\n\nBUILD SUCCESSFUL\nTotal time: 0 seconds\n---------\n\nMy expectation would have been that <unzip> fails with an error message like\n\"ZIP file directory index must be fixed\" or something similar.\n\nI didn't see any way to attach the test archive to this bug. It is really small,\nso I'll just insert a uuencoded copy of it:\n\nbegin 644 broken-index.zip\nM4$L#!!0`\"``(````(0`````````````````%````,2YT>'3MP4$.0!$,0$%K\nMI^C5I/RDBZKP+=S>/>3-U.U^I+:ET\\9OT24^*:+AICD!`````(`77%!+!PB'\nMK#S<,@`````0``!02P,$%``(``@````A``````````````````4````R+G1X\nM=.W!00Y`$0Q`06NGZ-6D_*2+JO`MW-X]Y,W4[7ZDMJ73QF_1)3XIHN&F.0$`\nM````@!=<4$L'\"(>L/-PR`````!```%!+`0(4`!0`\"``(````(0\"'K#S<,@``\nM```0```%```````````````````````Q+G1X=%!+`0(4`!0`\"``(````(0\"'\nMK#S<,@`````0```%`````````````````&4````R+G1X=%!+!08``````@`\"\n+`&8`````````````\n`\nend"}, {"count": 1, "tags": [], "creator": "a7cdcq002@sneakemail.com", "attachment_id": 15104, "id": 75167, "time": "2005-05-21T12:26:46Z", "bug_id": 35000, "creation_time": "2005-05-21T12:26:46Z", "is_private": false, "text": "Created attachment 15104\nZIP archive with broken directory index"}, {"count": 2, "tags": [], "bug_id": 35000, "attachment_id": null, "text": "The problem seems to be that ZipFile.populateFromCentralDirectory() ignores the\ncase that the directory is empty. Here's a suggested fix for the current CVS\nrevision 1.19:\n\n    private void populateFromCentralDirectory()\n        throws IOException {\n        positionAtCentralDirectory();\n\n        byte[] cfh = new byte[CFH_LEN];\n\n        byte[] signatureBytes = new byte[4];\n        archive.readFully(signatureBytes);\n        long sig = ZipLong.getValue(signatureBytes);\n        final long cfhSig = ZipLong.getValue(ZipOutputStream.CFH_SIG);\n>       if (sig != cfhSig) {\n>           throw new ZipException(\"cannot find ZIP directory index\");\n>       }\n        while (sig == cfhSig) {\n            ...", "id": 75168, "time": "2005-05-21T13:01:18Z", "creator": "a7cdcq002@sneakemail.com", "creation_time": "2005-05-21T13:01:18Z", "is_private": false}, {"count": 3, "tags": [], "creator": "bodewig@apache.org", "attachment_id": null, "id": 118753, "time": "2008-07-17T06:14:50Z", "bug_id": 35000, "creation_time": "2008-07-17T06:14:50Z", "is_private": false, "text": "will fail starting with svn revision 677575"}, {"text": "hmm, the same change would prevent Ant from dealing with empty archives.\n\nFor now I've added a failOnEmptyArchive attribute to unzip an friends.\n\nsvn revision 677592", "tags": [], "bug_id": 35000, "attachment_id": null, "count": 4, "id": 118758, "time": "2008-07-17T07:24:02Z", "creator": "bodewig@apache.org", "creation_time": "2008-07-17T07:24:02Z", "is_private": false}, {"count": 5, "tags": [], "creator": "bodewig@apache.org", "text": "separated this sort of broken archive from the general \"central directory is empty because the archive is empty\" case completely.\n\nunzipping the attachment will fail, unzipping of empty archives will not, unless the task is explicitly asked to do that.\n\nsvn revision 677870", "id": 118801, "time": "2008-07-18T03:14:28Z", "bug_id": 35000, "creation_time": "2008-07-18T03:14:28Z", "is_private": false, "attachment_id": null}]