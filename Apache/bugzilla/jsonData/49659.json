[{"count": 0, "tags": [], "bug_id": 49659, "attachment_id": null, "id": 138708, "time": "2010-07-28T11:17:23Z", "creator": "michael_rennie@ca.ibm.com", "creation_time": "2010-07-28T11:17:23Z", "is_private": false, "text": "Working on updating Eclipse to use Ant 1.8.1 I found that we have numerous test suite failures around popup /completion proposals. I tracked the problem back to where we try to look up a path element by its id.\n\nThe following is the test build file that fails:\n\n<project default=\"1\">\n\t<path id=\"project.class.path\">\n\t\t<pathelement location=\"lib/\" />\n\t\t<pathelement path=\"${java.class.path}/\" />\n\t\t<pathelement path=\"${additional.path}\" />\n\t</path>\n\t\n\t<target name=\"1\">\n\t\t<path id=\"project.class.path2\">\n\t\t\t<path refid=\"project.class.path\" />\n\t\t</path>\n\t</target>\n\t<target name=\"compile\">\n\t\t<javac srcdir=\"src\"\n\t       destdir=\"dst\"\n\t       classpathref=\"\"\n\t       sourcepathref=\"\"\n\t       bootclasspathref=\"\"\n\t       debug=\"on\" />\n\t</target>\n\t<target name= \"depends\" depends=\" compile  , 1 \">\n\t</target>\n\t<property name=\"name with spaces\" value=\"value with spaces\"/>\n\t<fileset dir=\"dir\" id=\"filesetTest\">\n\t    <include name=\"include\"/>\n\t    <exclude name=\"exclude\"/>\n\t</fileset>\n\t<patternset id=\"patternSetTest\">\n\t\t\t<include name=\"*.xml\"/>\n\t\t\t<exclude name=\"**/*Test*\"/>\n\t</patternset>\n\t<patternset id=\"patternSetTestBad\">\n\t\t<includesfile name=\"nothere\"/>\n\t</patternset>\n\t<echo>${name with spaces}</echo>\n\t<fileset refid=\"filesetTest\">\n\t\t<patternset refid=\"patternSetTest\"></patternset>\n\t\t<patternset refid=\"patternSetTestBad\"></patternset>\n\t</fileset>\n</project>\n\nDuring our tests we try to look up the element \"project.class.path\". In versions < 1.8.* this worked fine, however in Ant 1.8.1 the lookup will always result in null being returned.\n\nI tracked the cause to Project.getReference(key), where you used to lookup the element in the idReferences map to try and resolve it if it did not appear in the references mapping. \n\nPerhaps AntRefTable.get(..) needs to also consult the idReferences cache in the event of a miss?"}, {"count": 1, "tags": [], "creator": "bodewig@apache.org", "attachment_id": null, "id": 139002, "time": "2010-08-09T16:02:46Z", "bug_id": 49659, "creation_time": "2010-08-09T16:02:46Z", "is_private": false, "text": "I'm not sure how you are getting your project instance.  What has been done by Ant before you try to look up \"project.class.path\"?"}, {"count": 2, "tags": [], "bug_id": 49659, "text": "(In reply to comment #1)\n> I'm not sure how you are getting your project instance.  What has been done by\n> Ant before you try to look up \"project.class.path\"?\n\nWe have a subclass of Project - AntModelProject - that allows us to hook into getting user properties and knowing when a build is done. When we create our project instance we simply call Project.init() on it, set a few system properties and set some custom tasks and types using ComponentHelper.\n\nAnt handles the parsing of the buildfile, although we do have some logic to try optionally configuring Task nodes after parse, but this also no longer works for the same reason mentioned above. We do have our own copy of ProjectHelper, but 99% of the code in it is a direct copy from Ant with a few additional hooks for us.", "id": 139033, "time": "2010-08-10T10:26:12Z", "creator": "michael_rennie@ca.ibm.com", "creation_time": "2010-08-10T10:26:12Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "michael_rennie@ca.ibm.com", "text": "Would have been nice to have this fixed in Ant 1.8.2.\n\nI spent some time doing some more debugging of the org.apache.ant source and found that during the parse of a build file in \n\nProjectHelpr2$ElementHandler#onStartElement(...)\n\na call is made to AntXMLContext.configureId(...) which maps the UnknownElement to its id in Project#idReferences. Prior to Ant 1.8.0 you could then look up these UnknownElements by passing their id into Project#getReference. This no longer works as mentioned in comment #0.", "id": 142701, "time": "2010-12-14T15:53:33Z", "bug_id": 49659, "creation_time": "2010-12-14T15:53:33Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "antoine@apache.org", "text": "Hello Michael,\n\nsorry I have not been active in reading bug reports recently :(\n\nIn Ant 1.8.0 I think that the possibility of using references which were detected at parse time has been removed. The ant targets only see the references which have been defined in targets previously executed.\n\nProbably when this was changed the needs of API clients such as the Eclipse integration had not been taken into account.\n\nLet's see what the other committers think about this.", "id": 142704, "time": "2010-12-14T16:24:15Z", "bug_id": 49659, "creation_time": "2010-12-14T16:24:15Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 49659, "attachment_id": null, "text": "(In reply to comment #4)\n> Hello Michael,\n> \n> sorry I have not been active in reading bug reports recently :(\n> \n> In Ant 1.8.0 I think that the possibility of using references which were\n> detected at parse time has been removed. The ant targets only see the\n> references which have been defined in targets previously executed.\n> \n> Probably when this was changed the needs of API clients such as the Eclipse\n> integration had not been taken into account.\n> \n> Let's see what the other committers think about this.\n\nSounds good.", "id": 142739, "time": "2010-12-15T09:56:37Z", "creator": "michael_rennie@ca.ibm.com", "creation_time": "2010-12-15T09:56:37Z", "is_private": false}]