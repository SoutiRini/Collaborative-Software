[{"count": 0, "tags": [], "text": "Short description:\n\n(mem) cache size becomes negative in some circumstances\n(caching dynamic objects, small cache size, at least two threads),\nlater causing wrong behaviour and segfault in the cache_insert functions.\n\nDetailed description:\n\nIf our understanding of the code is correct, dinamically generated\nobjects are first inserted in the cache as temporary objects with a\ndefault size.\nIn the function write_body (in mod_mem_cache.c) to resize a temporary\nobject after it has been completed, it is first removed from cache,\nand then it is re-inserted with its correct size. This operation is\nperformed withouth checking if the removed object is still present \nin the cache. Suppose another thread has removed the temporary object from the\ncache because of a capacity miss in cache_insert functions (cache_cache.c). \nThen you can remove an object of different \nsize and adjust the cache size in a wrong manner eventually producing a \nnegative cache size. \nA negative cache size quickly produces a segfault in cache_insert().", "attachment_id": null, "bug_id": 21285, "id": 39875, "time": "2003-07-02T17:48:43Z", "creator": "m.torquati@huginsoft.it", "creation_time": "2003-07-02T17:48:43Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 21285, "attachment_id": null, "id": 39877, "time": "2003-07-02T18:17:32Z", "creator": "m.torquati@huginsoft.it", "creation_time": "2003-07-02T18:17:32Z", "is_private": false, "text": "The problem shows up on only with dynamic object generation. We have\ntested it using PHP and a small number of simple http clients.\n\nHow to reproduce the problem:\n\nSend object requests from some (2-3) clients (I wrote a simple client that at\nmax rate possible connect to server, post a GET request, read reply and close\nthe connection) to a simple php script (code follows) with the cache object\ncount very very small (Es. : MCacheMaxObjectCount 50).\n \nThe script produces different small objects (a few bytes in size)\nbased on an input variable (pippo.php?variabile=1234).\nIf you look at the cache size after some\ntime you see it decrease to zero and become negative. Eventually, some\nof the threads die because of a segfault.\n\n-------- Apache (2.0.46) configure command -------------\n\n./configure --with-mpm=worker --prefix=/apache-test/ --enable-mods-shared=all\n--enable-so --enable-cache=shared --enable-mem_cache=shared\n\n\n----- Cache configuration ------------- \n#\n# Sample Cache Configuration\n#\n<IfModule mod_cache.c>\n<IfModule mod_mem_cache.c>\nCacheEnable mem /\nCacheDefaultExpire 1000\nCacheMaxExpire 3000\nCacheIgnoreCacheControl Off\nCacheIgnoreNoLastMod    On\nMCacheSize 2000\nMCacheMaxObjectCount 50\nMCacheMinObjectSize 1\nMCacheMaxObjectSize 1048576\n</IfModule>\n</IfModule>\n\n---- php script code (pippo.php) ----\n<?php \nheader(\"Expires: Mon, 26 Jul 2005 05:00:00 GMT\");\necho \"<head>  </head>\";\necho \"<html> <br> html part <br> </html>\";\nif (isset($_GET[\"variabile\"])) { \necho \"mi hai passato \".$_GET[\"variabile\"];\n}\nelse {\necho \"non mi hai passato niente\";\n}\n?>"}, {"count": 2, "tags": [], "bug_id": 21285, "attachment_id": 7067, "id": 39878, "time": "2003-07-02T18:21:16Z", "creator": "m.torquati@huginsoft.it", "creation_time": "2003-07-02T18:21:16Z", "is_private": false, "text": "Created attachment 7067\nproposed patch for bug 21285 and bug 21287"}, {"count": 3, "tags": [], "bug_id": 21285, "attachment_id": null, "text": "The patch corrects the bugs 21285 and the bug 21287. \n\nI think there are cleaner ways to remove bug 21285; perhaps the simplest\none is to mark temporary objects in the cache as not removable. This\nclearly has consequences on the removing algorithm as well, though.\n\nIn the meanwhile, the patch I propose works well to eliminate the\nproblem, and has been extensively tested in the same settings with\nversion 2.0.44 and 2.0.46 . We have not tested if there are\ninteractions with other cache modules (e.g. mod_disk_cache).", "id": 39879, "time": "2003-07-02T18:24:46Z", "creator": "m.torquati@huginsoft.it", "creation_time": "2003-07-02T18:24:46Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 21285, "attachment_id": null, "id": 47889, "time": "2003-11-21T22:23:31Z", "creator": "trawick@apache.org", "creation_time": "2003-11-21T22:23:31Z", "is_private": false, "text": "enabling the PatchAvailable keyword\nupdated doc on submitting patches is at http://httpd.apache.org/dev/patches.html\n"}, {"count": 5, "text": "Created attachment 9525\nfix the defect w/o touching the pq functions", "bug_id": 21285, "attachment_id": 9525, "id": 48945, "time": "2003-12-11T23:58:43Z", "creator": "jjclar@novell.com", "creation_time": "2003-12-11T23:58:43Z", "tags": [], "is_private": false}, {"count": 6, "tags": [], "creator": "stoddard@apache.org", "text": "Fixed with this patch to Apache 2.1. Will port to an upcoming release of 2.0\n(2.0.49?)\nhttp://cvs.apache.org/viewcvs.cgi/httpd-2.0/modules/experimental/mod_mem_cache.c?r1=1.99&r2=1.100", "id": 49377, "time": "2003-12-18T21:27:57Z", "bug_id": 21285, "creation_time": "2003-12-18T21:27:57Z", "is_private": false, "attachment_id": null}]