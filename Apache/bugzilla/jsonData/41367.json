[{"count": 0, "tags": [], "creator": "dave64@andrew.cmu.edu", "is_private": false, "id": 98066, "attachment_id": null, "bug_id": 41367, "creation_time": "2007-01-15T04:44:17Z", "time": "2007-01-15T04:44:17Z", "text": "When apache logs via a pipe to a child process (cronolog, for example) a\ngraceful restart will kill the cronolog process leaving any httpd processes\nwriting to that log pipe in a blocking write() call.  Apache leaves the read end\nof the pipe open in the parent on creation, so the httpd will never receive\nEPIPE on this write since there will always be a reader (itself).  This results\nin many httpds stuck in 'L' state after a graceful restart."}, {"count": 1, "tags": [], "bug_id": 41367, "text": "Created attachment 19406\nPatch to resolve this problem.\n\nThis patch is applied at our site and being tested.", "id": 98067, "time": "2007-01-15T04:50:18Z", "creator": "dave64@andrew.cmu.edu", "creation_time": "2007-01-15T04:50:18Z", "is_private": false, "attachment_id": 19406}, {"count": 2, "tags": [], "bug_id": 41367, "attachment_id": null, "text": "Regarding this comment:\n\n+    /* Close the read end in the parent.  This will allow us to receive\n+     * EPIPE on write() calls to this pipe when the child process goes away\n+     * for any reason.\n+     */\n\nIt is my understanding that both ends of the pipe have to be held open in the\nparent so that when the piped logger crashes or otherwise exits, the parent is\nable to restart a new logger process using the same handles, which is what\nallows child processes serving requests to start using the new piped logger process.\n\nA fix for the hang over graceful restart was put in later releases some time ago:\n\nhttp://svn.apache.org/viewvc/httpd/httpd/branches/2.0.x/server/log.c?r1=202154&r2=202161\n", "id": 98078, "time": "2007-01-15T08:55:23Z", "creator": "trawick@apache.org", "creation_time": "2007-01-15T08:55:23Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 41367, "attachment_id": null, "text": "Thanks for looking at this so quickly, Jeff.  For various reasons, we can't move\nto apache 2.x yet, and the fix you pointed out doesn't appear to exist for the\n1.3.x branch.  I understand what you mean, in theory, that if the child logger\n(cronolog, for example) should crash, you can fork/exec a new child and log\nusing the same file descriptors since they'll be duplicated again from the\nparent to the child on fork/exec.  The problem we're seeing, however, is that\nthe httpd processes never know that the child logging process went away.  They\nget stuck in a blocking write() call on the pipe file descriptor forever.  Since\nhttpd holds open the write and read end of the pipe, there will always be a\nreader and the write() calls neither complete nor fail.  Instead, they block\nforever.", "id": 98081, "time": "2007-01-15T09:14:04Z", "creator": "dave64@andrew.cmu.edu", "creation_time": "2007-01-15T09:14:04Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 41367, "text": "If you'd like to see how this manifests itself in practice, here's some output.\n\nTruss output showing that pid 27009 is blocking on a write to fd 11 (and that it\nwas not interrupted by SIGPIPE):\n\nbash-2.03# truss -f -d -l -p 27009\nBase time stamp:  1168438376.6331  [ Wed Jan 10 09:12:56 EST 2007 ]\n27009/1:        write(11, \" 2 2 1 . 2 0 3 . 5 5 . 1\".., 68) (sleeping...)\n27009/2:        signotifywait()                 (sleeping...)\n27009/3:        lwp_sema_wait(0xFE30DE60)       (sleeping...)\n\n\n\nlsof output showing that fd 11 is a pipe with inode number 43592:\n\nbash-2.03# lsof -p 27009\nlsof: WARNING: can't access AFS name list file: /usr/vice/etc/modload/libafs\nCOMMAND     PID   USER   FD   TYPE        DEVICE   SIZE/OFF       NODE NAME\nlibhttpd. 27009 nobody  cwd   VDIR          32,0        512    4728578\n/usr/www/htdocs\nlibhttpd. 27009 nobody  txt   VREG          32,0      63424    4698542\n/usr/www/libexec/libhttpd.ep\nlibhttpd. 27009 nobody  txt   VREG          32,0      44836     403254 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0     700020    4698548 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG        0,4660    1720344  602079816 /afs (AFS)\nlibhttpd. 27009 nobody  txt   VREG          32,0     124212    4698549 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG        0,4660     325392  602079818 /afs (AFS)\nlibhttpd. 27009 nobody  txt   VREG          32,0    2841428    4698535 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0      57560    4698506 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0      63128    4698501\n/usr/www/libexec/mod_usertrack.so\nlibhttpd. 27009 nobody  txt   VREG          32,0      59044    4698524 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0      55852    4698528 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0      53816    4698534 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0      59208    4698530 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0      57404    4698537 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0     153492    4698508 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0      60644    4698532 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0      54424    4698502 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0      59648    4698505 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0      64880    4698526 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0      53144    4698523 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0      96484    4698529 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0     105828    4698516 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0      76280    4698504 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0     100992    4698509\n/usr/www/libexec/mod_negotiation.so\nlibhttpd. 27009 nobody  txt   VREG          32,0      66980    4698511\n/usr/www/libexec/mod_mime.so\nlibhttpd. 27009 nobody  txt   VREG          32,0      75536    4698512 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0    1158072     403702\n/usr/lib/libc.so.1\nlibhttpd. 27009 nobody  txt   VREG          32,0     183496     403244 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0      24968     403219\n/usr/lib/libmp.so.2\nlibhttpd. 27009 nobody  txt   VREG        0,4660     310140  386007042 /afs (AFS)\nlibhttpd. 27009 nobody  txt   VREG          32,0     911408     403524\n/usr/lib/libnsl.so.1\nlibhttpd. 27009 nobody  txt   VREG          32,0       5008     403701\n/usr/lib/libdl.so.1\nlibhttpd. 27009 nobody  txt   VREG          32,0      38904     403515 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG          32,0      70864     403506\n/usr/lib/libsocket.so.1\nlibhttpd. 27009 nobody  txt   VREG          32,0    2023308    4698541 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody  txt   VREG        0,4660       4852 1138820532 /afs (AFS)\nlibhttpd. 27009 nobody  txt   VREG          32,0     267824     403587\n/usr/lib/ld.so.1\nlibhttpd. 27009 nobody    0r  VCHR          13,2        0t0     974615\n/devices/pseudo/mm@0:null\nlibhttpd. 27009 nobody    1w  VCHR          13,2        0t0     974615\n/devices/pseudo/mm@0:null\nlibhttpd. 27009 nobody    2u  FIFO 0x3000807f108       0t78      43591 (fifofs)\nPIPE->0x3000807f020\nlibhttpd. 27009 nobody    3r  VREG          32,0       2048    2845618 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody    4u  VCHR          24,4 0t11864267     974698\n/devices/pseudo/pts@0:4->ttcompat->ldterm->ptem->pts\nlibhttpd. 27009 nobody    5u  VCHR          24,4 0t11864267     974698\n/devices/pseudo/pts@0:4->ttcompat->ldterm->ptem->pts\nlibhttpd. 27009 nobody    6u  VCHR          24,4 0t11864267     974698\n/devices/pseudo/pts@0:4->ttcompat->ldterm->ptem->pts\nlibhttpd. 27009 nobody    7r  DOOR         307,0        0t0       5108\n/etc/.name_service_door (door to nscd[404])\nlibhttpd. 27009 nobody    8u  FIFO 0x3000807f108       0t78      43591 (fifofs)\nPIPE->0x3000807f020\nlibhttpd. 27009 nobody    9r  VREG          32,0       2048    2845618 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27009 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27009 nobody   12u  FIFO 0x3000807ee20        0t0      43593 (fifofs)\nPIPE->0x3000807ef08\nlibhttpd. 27009 nobody   13u  FIFO 0x3000807ef08      0t236      43593 (fifofs)\nPIPE->0x3000807ee20\nlibhttpd. 27009 nobody   14u  IPv4 0x3000a154650        0t0        TCP\nWWW-ANDREW-1.andrew.cmu.edu:*->221.203.55.166:* (IDLE)\nlibhttpd. 27009 nobody   15w  VREG          32,0    7424659    6142352 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody   16u  IPv4 0x3000788d248        0t0        TCP *:443\n(LISTEN)\nlibhttpd. 27009 nobody   17u  IPv4 0x30007af13d0        0t0        TCP *:www\n(LISTEN)\nlibhttpd. 27009 nobody   18w  VREG          32,0          0    4620295 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody   19w  VREG          32,0          0    4620301 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody   20w  VREG          32,0          0    4620307 /\n(/dev/dsk/c0t0d0s0)\nlibhttpd. 27009 nobody   21w  VREG          32,0          0    4620301 /\n(/dev/dsk/c0t0d0s0)\n\n\nNow I ran lsof and grepped for 43592 in an attempt to find out what cronolog\nprocess should be at the other end of the pipe, only to discover that there\nisn't one:\n\nbash-2.03# lsof | grep 43592\nlsof: WARNING: can't access AFS name list file: /usr/vice/etc/modload/libafs\nlibhttpd. 25624 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 25624 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 25635 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 25635 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 25685 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 25685 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 25734 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 25734 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 25804 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 25804 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 25903 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 25903 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 25904 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 25904 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 25906 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 25906 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 26287 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 26287 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 26920 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 26920 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 26944 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 26944 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 26947 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 26947 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 26964 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 26964 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 26965 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 26965 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27005 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27005 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27007 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27007 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27009 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27009 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27119 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27119 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27120 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27120 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27162 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27162 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27164 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27164 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27165 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27165 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27170 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27170 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27173 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27173 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27211 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27211 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27212 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27212 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27213 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27213 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27222 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27222 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27227 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27227 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27246 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27246 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27247 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27247 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27268 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27268 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27397 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27397 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27400 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27400 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27402 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27402 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27605 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27605 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 27718 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 27718 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 28707 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 28707 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 28713 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 28713 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\nlibhttpd. 28717 nobody   10u  FIFO 0x30002c35620        0t0      43592 (fifofs)\nPIPE->0x30002c35708\nlibhttpd. 28717 nobody   11u  FIFO 0x30002c35708      0t419      43592 (fifofs)\nPIPE->0x30002c35620\n", "id": 98082, "time": "2007-01-15T09:31:22Z", "creator": "dave64@andrew.cmu.edu", "creation_time": "2007-01-15T09:31:22Z", "is_private": false, "attachment_id": null}]