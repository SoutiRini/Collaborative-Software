[{"count": 0, "tags": [], "creator": "pb@bieringer.de", "attachment_id": null, "id": 43745, "time": "2003-09-05T14:36:45Z", "bug_id": 22946, "creation_time": "2003-09-05T14:36:45Z", "is_private": false, "text": "First: the construct:\n\nA footer CGI (Perl or C) will be called via:\n\nAddOutputFilter INCLUDES .html .shtml .pl .cgi\nAction add-footer /cgi-bin/footer.pl (Perl)\nAction add-footer /cgi-bin/footer.cgi (C)\nAddHandler add-footer .html\n\nThis footer program only reads content of file given in env(PATH_TRANSLATED),\nprint all lines to stdout while checking for \"</body\".  If reached, footer\nprogram will open a footer.txt file, print the lines of this file and finally\nprint \"</body></html>\".\n\nfooter.txt contain some SSI code, which would be parsed by OutputFilter INCLUDES.\n\nFor several pages on my site I got a lot of errors like:\n\n[Wed Jun 11 11:25:14 2003] [notice] child pid 4443 exit signal Segmentation\nfault (11)\n\nAnd the HTML content of footer.txt is only printed until the first SSI code\n(here: <!--#if).\n\nThis happen on 2.0.46 and on 2.0.47 again.\n\nBecause it does not happen on each page, I've played around with the SSI code in\nfooter.txt and found a very interesting issue:\n\nNo problems are occour if SSI code in footer starts after a new line.\nProblem occurs, if SSI code is indented by some TABs and SPACEs - but not always.\n\nGood:\n<!--#if expr=\"$REMOTE_ADDR = /^::ffff:/\" -->\n\nBad:\n                                <!--#if expr=\"$REMOTE_ADDR = /^::ffff:/\" -->\n\nWhile shifting the code to beginning of the line, I suddenly got inbetween shift\n& test following log line:\n\n[Fri Sep 05 16:11:58 2003] [error] [client *****] unknown directive \"f\" in\nparsed doc /path/to/cgi-bin/footer.cgi, referer: http://****/\n\nOoops, looks like there is a line buffer problem somewhere imho because there is\nno directive \"f\"...\n\nCurrently I moved all SSI code to beginning of the line, Segfaults are now gone\nfor the moment.\n\nIf you need filter program, webpage and footer.txt for local testing, I can\nprovide them."}, {"count": 1, "tags": [], "bug_id": 22946, "text": "Error occours again,\n\nLog:\n\n[Mon Sep 08 10:08:41 2003] [error] [client 2002:d9e5:96f::1] unknown directive\n\"cho\" in parsed doc /path/to/cgi-bin/footer.cgi\n\nRelated SSI code:\n\n<font face=\"Helvetica, Arial, sans-serif\" size=\"-2\">\nYour address: <!--#echo var=\"REMOTE_ADDR\" -->\n</font>\n\nCurrent temp solution: break lines and add a newline:\n\n<font face=\"Helvetica, Arial, sans-serif\" size=\"-2\">\n\nYour address:\n<!--#echo var=\"REMOTE_ADDR\" -->\n</font>\n\n\nVery strange at all.\n", "id": 43827, "time": "2003-09-08T08:25:41Z", "creator": "pb@bieringer.de", "creation_time": "2003-09-08T08:25:41Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "text": "The same on version 2.0.48\n\nThis happen also using another CGI program, with open a template HTML file\ncontaining SSI code, replace some special tags and serve this page to the\nbrowser via output filter INCLUDES like\n  AddOutputFilter INCLUDES .html .shtml .pl .cgi\n\nReproducable on each reload and also after restarting Apache (worker). If I\nmodify the HTML file a little bit, it works.\n\nBuffer problem somewhere?", "attachment_id": null, "id": 46910, "creator": "pb@bieringer.de", "time": "2003-11-06T09:12:32Z", "bug_id": 22946, "creation_time": "2003-11-06T09:12:32Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 22946, "attachment_id": null, "id": 46959, "time": "2003-11-06T23:14:36Z", "creator": "nd@perlig.de", "creation_time": "2003-11-06T23:14:36Z", "is_private": false, "text": "Yes, that happens  because of the disability of mod_include to handle some edge\ncases. You're seeing the problems, because the particular directives span\nbuckets or brigades.\nThere was a rewrite of the whole module in 2.1 which was backported to 2.0 (with\nsome changes to keep the api consistent).\nYou might want to test out this patch:\n<http://cvs.apache.org/~nd/ssi-redesign20.patch> (about 70k)\n\nBut be warned, it's not finally reviewed yet, so use it at your own risk.\n(But if you do, some feedback is really welcome).\n\nThanks!"}, {"count": 4, "tags": [], "text": "> You might want to test out this patch:\n> <http://cvs.apache.org/~nd/ssi-redesign20.patch> (about 70k)\nApplied, backed new RPM, updated...server works again, will now wait if now\nchilds are dying again.\n\n> But be warned, it's not finally reviewed yet, so use it at your own risk.\nNever heard that use of open source is ever without \"use it at your own risk\" :-)\n\n> (But if you do, some feedback is really welcome).\nWill do so. But I'm now 1 week offline, will send report afterwards.", "attachment_id": null, "id": 46975, "creator": "pb@bieringer.de", "time": "2003-11-07T09:46:18Z", "bug_id": 22946, "creation_time": "2003-11-07T09:46:18Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 22946, "attachment_id": null, "id": 47399, "time": "2003-11-15T11:43:41Z", "creator": "pb@bieringer.de", "creation_time": "2003-11-15T11:43:41Z", "is_private": false, "text": "I would note that no child crashed until starting the patch-applied version.\n\nLoad:\n\nServer Version: Apache/2\nServer Built: Nov 7 2003 10:13:47 \nCurrent Time: Saturday, 15-Nov-2003 12:38:41 CET\nRestart Time: Friday, 07-Nov-2003 10:33:58 CET\nParent Server Generation: 0\nServer uptime: 8 days 2 hours 4 minutes 42 seconds\nTotal accesses: 247231 - Total Traffic: 847.6 MB\nCPU Usage: u39.25 s11.98 cu137.34 cs23.79 - .0304% CPU load\n.354 requests/sec - 1272 B/second - 3595 B/request\n1 requests currently being processed, 19 idle workers\n\nLog:\n[Fri Nov 07 10:33:31 2003] [notice] caught SIGTERM, shutting down\n[Fri Nov 07 10:33:53 2003] [notice] suEXEC mechanism enabled (wrapper:\n/usr/sbin/suexec)\n[Fri Nov 07 10:33:56 2003] [notice] Digest: generating secret for digest\nauthentication ...\n[Fri Nov 07 10:33:56 2003] [notice] Digest: done\n[Fri Nov 07 10:33:58 2003] [notice] Apache/2 configured -- resuming normal\noperations\n(nothing more)\n\nLooks like this patch really fixes this issue - thanks a lot."}, {"count": 6, "tags": [], "creator": "nd@perlig.de", "text": "Thanks for the feedback!", "id": 47508, "time": "2003-11-17T20:28:15Z", "bug_id": 22946, "creation_time": "2003-11-17T20:28:15Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "pb@bieringer.de", "text": "Using this new SSI code causes after a SSI typo on a HTML page excessive error\nlog entries (turns mad) and finally kills httpd.\n\nStarted on \n[Thu Nov 20 20:15:02 2003] [error] [client 217.233.49.91] unknown parameter\n\"de\"ar\" to tag if in /path/to/page.html\n\nLast one:\n[Thu Nov 20 20:25:08 2003] [error] [client 217.233.49.91] unknown parameter\n\"de\"ar\" to tag if in /path/to/page.html\n\nNov 20 20:24:24 server Out of Memory: Killed process 23703 (httpd).\n\n# zcat error_log.gz | grep \"unknown parameter\" |wc -l\n4195938\n\n(a little bit too much...)\n\nProbably caused by a misplaced \" in following SSI code:\n\n\t<!-- start of content -->\n         <!--#if expr=\"$lang != de\" -->\n         <!--#include virtual=\"content.en.html\" -->\n\t<!--#endif -->\n         <!--#if expr=\"$lang = de\" -->\n         <!--#include virtual=\"content.de.html\" -->\n\t<!--#endif -->\n         <!-- end of content -->\n\nProbably something like:\n <!--#if expr=\"$lang = \"de\" -->\n\n(I report only the issue, orig code was changed and fixed without saving the\nproblem causing one by another guy).\n\nCan't currently verify this because the new SSI code is only running on\nproduction server and I'm far away from our lab.", "count": 7, "id": 47726, "time": "2003-11-20T21:03:43Z", "bug_id": 22946, "creation_time": "2003-11-20T21:03:43Z", "is_private": false}, {"count": 8, "tags": [], "text": "ok, reproduced with exactly your suggestion. I've added a test to the testsuite\nand will dig into the issue... Thanks!", "attachment_id": null, "id": 47735, "creator": "nd@perlig.de", "time": "2003-11-20T22:08:14Z", "bug_id": 22946, "creation_time": "2003-11-20T22:08:14Z", "is_private": false}, {"count": 9, "tags": [], "text": "Ok, I've uploaded a fixed version to\n<http://cvs.apache.org/~nd/ssi-redesign20-r1.patch>. The problem should be gone\nnow. It was an infinite loop (suprise, surprise ;-), caused by one of the api\ncompat hacks. The tag position pointer wasn't counted up, when no tag value was\nfound...", "is_private": false, "id": 47739, "creator": "nd@perlig.de", "time": "2003-11-20T23:21:42Z", "bug_id": 22946, "creation_time": "2003-11-20T23:21:42Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "pb@bieringer.de", "text": "Can't apply the patch against http-2.0.48 (which I'm prefer for using at the\nmoment):\n\n1 out of 20 hunks FAILED -- saving rejects to file modules/filters/mod_include.c.rej\n\n\n$ more ../BUILD/httpd-2.0.48/modules/filters/mod_include.c.rej\n***************\n*** 3340,3346 ****\n       * We don't know if we are going to be including a file or executing\n       * a program - in either case a strong ETag header will likely be invalid.\n       */\n-      apr_table_setn(f->r->notes, \"no-etag\", \"\");\n\n      return OK;\n  }\n--- 3544,3550 ----\n       * We don't know if we are going to be including a file or executing\n       * a program - in either case a strong ETag header will likely be invalid.\n       */\n+     apr_table_setn(f->r->notes, \"no-etag\", \"\");\n\n      return OK;\n  }\n\n\nUnfortunately, I do not really know, how to modify the patch...do not really\nfind similar in orig version, only something like:\n\n    /* Always unset the ETag/Last-Modified fields - see RFC2616 - 13.3.4.\n     * We don't know if we are going to be including a file or executing\n     * a program which may change the Last-Modified header or make the\n     * content completely dynamic.  Therefore, we can't support these\n     * headers.\n     * Exception: XBitHack full means we *should* set the Last-Modified field.\n     */\n    apr_table_unset(f->r->headers_out, \"ETag\");\n\n\nCould you please create a patch against version 2.0.48? Thank you very much!\n", "count": 10, "id": 47998, "time": "2003-11-24T11:35:36Z", "bug_id": 22946, "creation_time": "2003-11-24T11:35:36Z", "is_private": false}, {"count": 11, "attachment_id": null, "creator": "nd@perlig.de", "is_private": false, "id": 48047, "time": "2003-11-24T22:04:54Z", "bug_id": 22946, "creation_time": "2003-11-24T22:04:54Z", "tags": [], "text": "Oh well, sorry, I've diffed against the cvs version. The etag stuff moved from\nthe filter to filter init. However, I've created a patch against 2.0.48 here:\n<http://cvs.apache.org/~nd/ssi-redesign-r1-2.0.48.patch>.\n\nThanks for testing :-)"}, {"count": 12, "tags": [], "bug_id": 22946, "attachment_id": null, "id": 48075, "time": "2003-11-25T09:35:52Z", "creator": "pb@bieringer.de", "creation_time": "2003-11-25T09:35:52Z", "is_private": false, "text": "Ok, \"turn-mad\" problem is gone - thanks a lot.\n\nTested :\n <!--#if expr=\"$lang != \"de\" -->\n\nGot one error line:\n\nunknown parameter \"de\"r\" to tag if in /path/to/page.html\n\nBTW: I don't know whether this error message really proper describe the\nproblem...what does mean:  \"de\"r\"?  Where is the source for this strange \"r\"???"}, {"count": 13, "tags": [], "creator": "nd@perlig.de", "attachment_id": null, "id": 48077, "time": "2003-11-25T09:53:15Z", "bug_id": 22946, "creation_time": "2003-11-25T09:53:15Z", "is_private": false, "text": "Good question. First guess, a missing \\0 byte somewhere. I'll take a closer look\nthis evening..."}, {"count": 14, "tags": [], "bug_id": 22946, "is_private": false, "id": 48122, "creation_time": "2003-11-25T22:07:27Z", "time": "2003-11-25T22:07:27Z", "creator": "nd@perlig.de", "text": "Well, it was actually a missing \\0 byte in the wrapper code for backwards\ncompatibility. A new revision of the patch against 2.0.48 can be found here:\n<http://cvs.apache.org/~nd/ssi-redesign-r2-2.0.48.patch>.", "attachment_id": null}, {"count": 15, "tags": [], "bug_id": 22946, "attachment_id": null, "id": 49252, "time": "2003-12-17T15:22:33Z", "creator": "pb@bieringer.de", "creation_time": "2003-12-17T15:22:33Z", "is_private": false, "text": "Sorry for delay, tested r2 now, working:\n\n[Wed Dec 17 16:19:36 2003] [error] [client 2002:****] unknown parameter \"de\"\" to\ntag if in /path/to/page.html\n\nPlease push it to 2.0.49\n"}, {"count": 16, "tags": [], "creator": "nd@perlig.de", "text": "FYI: It's now in the 2.0 tree and will appear in 2.0.49.", "id": 50425, "time": "2004-01-12T19:39:56Z", "bug_id": 22946, "creation_time": "2004-01-12T19:39:56Z", "is_private": false, "attachment_id": null}]