[{"count": 0, "tags": [], "creator": "athieme@zapdata.com", "attachment_id": null, "id": 46702, "time": "2003-11-03T22:36:08Z", "bug_id": 24368, "creation_time": "2003-11-03T22:36:08Z", "is_private": false, "text": "I have seen mention of a similar bug in StandardManager code that was fixed, \nbut the cooresponding fix was not made to PersistentManagerBase. In the \nfollowing code, if an Exception occurs while expiring sessions, that Exception \nwill kill the PersistentManager thread.\n\nAs for a fix, of course, a try/catch around this code will do the trick. \nHowever, I wonder why this code is not shared between StandardManager and \nPersistentManager?\n\nFrom PersistentManagerBase.java:\n    protected void processExpires() {\n\n        if (!started)\n            return;\n\n        long timeNow = System.currentTimeMillis();\n        Session sessions[] = findSessions();\n\n        for (int i = 0; i < sessions.length; i++) {\n            StandardSession session = (StandardSession) sessions[i];\n            if (!session.isValid())\n                continue;\n            if (isSessionStale(session, timeNow))\n                session.expire();\n        }\n\n    }\n\nFrom StandardManager.java: (includes try/catch)\n\n    private void processExpires() {\n\n        long timeNow = System.currentTimeMillis();\n        Session sessions[] = findSessions();\n\n        for (int i = 0; i < sessions.length; i++) {\n            StandardSession session = (StandardSession) sessions[i];\n            if (!session.isValid())\n                continue;\n            int maxInactiveInterval = session.getMaxInactiveInterval();\n            if (maxInactiveInterval < 0)\n                continue;\n            int timeIdle = // Truncate, do not round up\n                (int) ((timeNow - session.getLastAccessedTime()) / 1000L);\n            if (timeIdle >= maxInactiveInterval) {\n                try {\n                    expiredSessions++;\n                    session.expire();\n                } catch (Throwable t) {\n                    log(sm.getString(\"standardManager.expireException\"), t);\n                }\n            }\n        }\n\n    }"}, {"count": 1, "tags": [], "bug_id": 24368, "attachment_id": null, "text": "Present in TC4 and TC5. I have submitted patches to tomcat-dev. BTW, the code \nis not shared as the logic between the classes is slightly different.", "id": 47065, "time": "2003-11-09T20:21:34Z", "creator": "medthomas@ntlworld.com", "creation_time": "2003-11-09T20:21:34Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 24368, "attachment_id": 9032, "is_private": false, "id": 47130, "time": "2003-11-10T19:46:14Z", "creator": "medthomas@ntlworld.com", "creation_time": "2003-11-10T19:46:14Z", "text": "Created attachment 9032\nPatch for TC4 to fix this bug"}, {"count": 3, "tags": [], "bug_id": 24368, "attachment_id": 9033, "text": "Created attachment 9033\nPatch for TC5 to fix this bug", "id": 47132, "time": "2003-11-10T19:46:43Z", "creator": "medthomas@ntlworld.com", "creation_time": "2003-11-10T19:46:43Z", "is_private": false}, {"count": 4, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "id": 47133, "time": "2003-11-10T19:51:02Z", "bug_id": 24368, "creation_time": "2003-11-10T19:51:02Z", "is_private": false, "text": "With TC 5, there's no possible way the background thread can die like this. All\nit will do is log the exception."}, {"count": 5, "tags": [], "bug_id": 24368, "is_private": false, "text": "Regarding the proposed fixes, I would argue that it would be helpful to include \na log statement rather than simply catch/ignore.", "id": 47139, "time": "2003-11-10T21:05:41Z", "creator": "athieme@zapdata.com", "creation_time": "2003-11-10T21:05:41Z", "attachment_id": null}, {"count": 6, "tags": [], "creator": "medthomas@ntlworld.com", "is_private": false, "text": "Remy has applied the patch. Thanks ;)", "id": 47370, "time": "2003-11-14T19:33:14Z", "bug_id": 24368, "creation_time": "2003-11-14T19:33:14Z", "attachment_id": null}, {"count": 7, "tags": [], "text": "From your recent comments, and in viewing the updated source, I take it you do \nnot agree that a log statement is necessary inside your try catch? If that's \nthe case, might I implore you to reconsider? While the cause of the exception \nmay not be Tomcat related, it is frequently extremely helpful to have explicit \nlog statements as an alert to a problem that may exist elsewhere, but might not \notherwise be noticed. As further testimony, in StandardManager, which serves a \nsimilar purpose, a simple log statement IS provided in the catch.\n\nThanks!", "attachment_id": null, "id": 47375, "creator": "athieme@zapdata.com", "time": "2003-11-14T20:42:17Z", "bug_id": 24368, "creation_time": "2003-11-14T20:42:17Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 24368, "attachment_id": null, "is_private": false, "id": 47429, "time": "2003-11-16T14:19:37Z", "creator": "medthomas@ntlworld.com", "creation_time": "2003-11-16T14:19:37Z", "text": "Point taken, but a severity of 'major' is no longer appropriate."}, {"count": 9, "tags": [], "bug_id": 24368, "attachment_id": null, "text": "The log message has been added.", "id": 48929, "time": "2003-12-11T20:59:18Z", "creator": "medthomas@ntlworld.com", "creation_time": "2003-12-11T20:59:18Z", "is_private": false}, {"count": 10, "tags": [], "text": "In going back to your fix of StandardManagerBase, I see where you now have the \ntry/catch (and the log statement) in the stop() method, but have not added \nanything to the processExpires() method, that which I had pointed to in this \nbug. Was this an oversight, or am I just missing something obvious.\n\nGoing on the assumption that this was an oversight, I have marked the bug \nseverity as \"major\".", "attachment_id": null, "id": 48943, "creator": "athieme@zapdata.com", "time": "2003-12-11T23:37:33Z", "bug_id": 24368, "creation_time": "2003-12-11T23:37:33Z", "is_private": false}, {"count": 11, "tags": [], "creator": "medthomas@ntlworld.com", "text": "Sorry. My original patch got applied in stop() rather than processExpires(). \nNot sure if this was deliberate or an accident. To be in the safe side I have \nadded the same code to processExpires().", "id": 48944, "time": "2003-12-11T23:53:41Z", "bug_id": 24368, "creation_time": "2003-12-11T23:53:41Z", "is_private": false, "attachment_id": null}]