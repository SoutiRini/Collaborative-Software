[{"count": 0, "tags": [], "creator": "brooke@usinternet.com", "attachment_id": 34027, "text": "Created attachment 34027\nMACRO VIRUS INFECTED WORD DOC, DO NOT OPEN IN WORD!\r\nIt causes readMacros() to throw an IOException\n\nWARNING: ATTACHED DOCUMENT IS INFECTED WITH A MALICIOUS MACRO. DO NOT OPEN IT USING MICROSOFT WORD.\n\nI have been using POI to help take apart Office documents and look for suspicious/malicious content. I had developed my own way to extract the VBA script in the embedded macros, but have found the new VBAMacroReader to be much more useful.\n\nHowever, I have noticed that VBAMacroReader fails on certain Office documents. I have attached one such example.\n\n\nCode used to reproduce the error:\n\nFile file = new File(\"macro_virus.doc\");\nVBAMacroReader reader = new VBAMacroReader(file);\nMap<String, String> macros = reader.readMacros();\n\n\nStack trace:\njava.io.IOException: Skipped only -1 while trying to skip 67116544 bytes.  This should never happen.\n\tat org.apache.poi.poifs.macros.VBAMacroReader.trySkip(VBAMacroReader.java:182)\n\tat org.apache.poi.poifs.macros.VBAMacroReader.readMacros(VBAMacroReader.java:240)\n\tat org.apache.poi.poifs.macros.VBAMacroReader.findMacros(VBAMacroReader.java:148)\n\tat org.apache.poi.poifs.macros.VBAMacroReader.findMacros(VBAMacroReader.java:153)\n\tat org.apache.poi.poifs.macros.VBAMacroReader.findMacros(VBAMacroReader.java:153)\n\tat org.apache.poi.poifs.macros.VBAMacroReader.readMacros(VBAMacroReader.java:115)\n\tat poitester.POITester.main(POITester.java:27)\n\n\nI've successfully opened the file in a sandbox and it appears to be a valid Word document.\n\nAlso, just FYI, I am using poi-3.15-beta2 and I get the same results on OSX 10.10.5 and openSUSE 11.4. \n\nThanks!", "id": 192248, "time": "2016-07-08T16:34:15Z", "bug_id": 59830, "creation_time": "2016-07-08T16:34:15Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 59830, "text": "I added context as to why -1 is being returned (could not read bytes from input stream) in r1751982.\n\nError occurred while reading section id 2\njava.io.IOException: Error occurred while reading section id 2\n        at org.apache.poi.poifs.macros.VBAMacroReader.readMacros(VBAMacroReader.java:244)\n        at org.apache.poi.poifs.macros.VBAMacroReader.findMacros(VBAMacroReader.java:148)\n        at org.apache.poi.poifs.macros.VBAMacroReader.findMacros(VBAMacroReader.java:153)\n        at org.apache.poi.poifs.macros.VBAMacroReader.findMacros(VBAMacroReader.java:153)\n        at org.apache.poi.poifs.macros.VBAMacroReader.readMacros(VBAMacroReader.java:115)\n        at org.apache.poi.poifs.macros.TestVBAMacroReader.bug59830(TestVBAMacroReader.java:249)\nCaused by: java.io.IOException: Skipped only -1 while trying to skip 67116544 bytes.  This should never happen.\n        at org.apache.poi.poifs.macros.VBAMacroReader.trySkip(VBAMacroReader.java:182)\n        at org.apache.poi.poifs.macros.VBAMacroReader.readMacros(VBAMacroReader.java:242)\n\nFrom the MS-OVBA spec [1], a value of 0x0002 corresponds to a PROJECTLCID Record (section 2.3.4.2.1.2). The size of this record must be 0x00000004 according to the spec. See an example [2].\nLCID is an abbreviation for language code identifier, \"a 32-bit number that identifies the user interface human language dialect or variation that is supported by an application or a client computer\" [3].\nIs the 67116544 bytes number referring to the length of the PROJCTLCID record?\n\n[1] https://msdn.microsoft.com/en-us/library/office/cc313094(v=office.12).aspx\n[2] https://msdn.microsoft.com/en-us/library/dd952163(v=office.12).aspx\n[3] https://msdn.microsoft.com/en-us/library/dd908523(v=office.12).aspx#gt_c7f99c66-592f-4053-b62a-878c189653b6\n\nI did not commit the doc file though. Would you be able to extract the vbaProject.bin out of this malicious document? I'd feel more comfortable committing a file that can't execute itself. Probably the easiest way to get this file is to use Word to save-as to docm, then rename the docm with a .zip extension, and then pull out the file named vbaProject.bin.\n\nFYI, I think the infected file can only harm Windows computers, as the document contains 3 macros that call powershell.exe on document open. Nonetheless, please exercise caution.\n\nIt may also be helpful to see what POI can read from the document using org.apache.poi.poifs.dev.POIFSDump.main. Keep in mind that the extracted files will contain ascii and non-ascii characters, as the extracted files are likely run-length encoded.", "id": 192259, "time": "2016-07-09T06:21:39Z", "creator": "onealj@apache.org", "creation_time": "2016-07-09T06:21:39Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 59830, "text": "I believe I was able to successfully extract the vbaProject.bin, using the suggested procedure.\n\nI also ran POIFSDump.main on the problem doc file. I zipped the directory that it generated and attached it to this bug report.\n\nLet me know if there is anything else I can do to help track this down.\n\nThanks!", "id": 192297, "time": "2016-07-11T18:49:33Z", "creator": "brooke@usinternet.com", "creation_time": "2016-07-11T18:49:33Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 59830, "text": "Created attachment 34030\nThe vbaProject.bin file found after saving as a .docm using Word", "id": 192298, "time": "2016-07-11T18:51:00Z", "creator": "brooke@usinternet.com", "creation_time": "2016-07-11T18:51:00Z", "is_private": false, "attachment_id": 34030}, {"count": 4, "tags": [], "creator": "brooke@usinternet.com", "attachment_id": 34031, "text": "Created attachment 34031\nThe results of running org.apache.poi.poifs.dev.POIFSDump.main on the problem document.", "id": 192299, "time": "2016-07-11T18:51:52Z", "bug_id": 59830, "creation_time": "2016-07-11T18:51:52Z", "is_private": false}, {"count": 5, "tags": [], "creator": "tallison@mitre.org", "attachment_id": null, "text": "r1765468\n\nThank you for extracting the malicious payload!\n\nI found a non-malicious file in govdocs1 that triggered the same exception.\n\nPlease re-open if this doesn't fix your problem.", "id": 194499, "time": "2016-10-18T15:49:38Z", "bug_id": 59830, "creation_time": "2016-10-18T15:49:38Z", "is_private": false}]