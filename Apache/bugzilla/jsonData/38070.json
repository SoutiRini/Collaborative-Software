[{"text": "Version httpd-2.2.0\nUse mod_cgi\n\nThis symptom has been reported against older apaches before.\napache 1.3 http://archive.apache.org/gnats/5640\napache 2.0 http://issues.apache.org/bugzilla/show_bug.cgi?id=37166\nBut the solution is not included in current 1.3 and 2.0 sources.\nAnd this time,Ireport it against apache 2.2.0.\n\nSymptom:\nBrowser access cgi program multiple times.\n1st time, httpd returns status code 200 packet and logged status 200\nin accesslog. Correct screen is display.\n2nd time, httpd returns status code 200 without BODY and logged \nstatus 304 in accesslog.  Blank screen is display.\n\nSample script:\nhttp://issues.apache.org/bugzilla/attachment.cgi?id=16757\n\nFix patchlet:\nhttp://archive.apache.org/gnats/5640\n\nI hope apache developer will include the patch into all 3\nversion of httpd souce trees.\n\nRegards,\nMasanari Iida", "tags": [], "bug_id": 38070, "attachment_id": null, "count": 0, "id": 84055, "time": "2005-12-29T08:42:18Z", "creator": "standby24x7@gmail.com", "creation_time": "2005-12-29T08:42:18Z", "is_private": false}, {"count": 1, "tags": [], "creator": "standby24x7@gmail.com", "text": "I have posted this symptom to apache users mailing list.\nNick Kew reply to the question.\n\nFrom: Nick Kew <>\tMailed-By: httpd.apache.org\nReply-To: users httpd apache org\nTo: users@httpd apache org\nDate: Jan 15, 2006 4:26 AM\nSubject: Re: [users@httpd] Bug or feature?\n\nOn Saturday 14 January 2006 18:04, Masanari Iida wrote:\n> Hi,\n>\n> I would like to ask the list members if following are\n> bug or feature of apache.\n>\n> Use following sample script,\n> Apache version: ANY  (1.3, 2.0 and 2.2)\n>\n> #!/bin/sh\n> cat <<EOT\n> Status: 200 OK\n> Last-Modified: Tue, 15 Feb 2005 15:00:00 GMT\n> Content-Type: text/html\n>\n> Hello world\n> EOT\n\nInteresting.  I can confirm that your CGI script with an If-Modified-Since\nheader later than the Last-Modified date supplied by the script does\nindeed return 200 with no body.  That's broken, but is it Apache or\nthe script that's at fault[1]?\n\nRFC2616 says of If-Modified-Since:\n\n     c) If the variant has not been modified since a valid If-^M\n        Modified-Since date, the server SHOULD return a 304 (Not^M\n        Modified) response.^M\n\nThat makes sense: the script is stupid but technically within its rights\nto send the 200 unconditionally.  So Apache should presumably\naccommodate it by ignoring the If-Modified-Since header and\nreturning 200 with the full body.\n\nIf that's not already in bugzilla, you might consider entering it there.\n\n[1] It's both, of course.\n\n--\nNick Kew", "id": 84635, "time": "2006-01-15T07:14:07Z", "bug_id": 38070, "creation_time": "2006-01-15T07:14:07Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 38070, "text": "Fixed in trunk:  r370692 ", "id": 84793, "time": "2006-01-20T02:38:02Z", "creator": "nick@webthing.com", "creation_time": "2006-01-20T02:38:02Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 38070, "attachment_id": null, "text": "Are you sure you don't want to convert a CGI-generated 200 to a 304 when the\nHTTP conditions fail?  ap_scan_script_header_err is also called by mod_asis .  I\nuse mod_asis extensively, with files which include Last-Modified: and ETag:\nheaders, and it would be disastrous to return 200 when 304 would be appropriate.\n\nAdmittedly, I've had to patch both mod_asis.c and util_script.c to get the right\nresults, but my server seems to return the responses I expect.", "id": 85369, "time": "2006-02-02T21:06:08Z", "creator": "Dave.Sparks@dandasparks.org.uk", "creation_time": "2006-02-02T21:06:08Z", "is_private": false}, {"text": "(In reply to comment #3) \n> Are you sure you don't want to convert a CGI-generated 200 to a 304 when the \n> HTTP conditions fail? \n \nThere are two cases.  If the CGI *explicitly* generates a Status: header, we \nshould honour it.  If not, then we just need to generate whatever is \nappropriate - usually 200, or 302 if the CGI emitted a Location header. \n \n>   ap_scan_script_header_err is also called by mod_asis .  I \n \nThe crucial difference thare is that mod_asis isn't documented as having a \nStatus header (though I guess it might, if it goes through the same parsing as \nCGI). \n \n> use mod_asis extensively, with files which include Last-Modified: and ETag: \n> headers, and it would be disastrous to return 200 when 304 would be \nappropriate. \n \nYour asis doesn't say \"Status: foo\"?  Then the patch won't affect it. \n>  \n> Admittedly, I've had to patch both mod_asis.c and util_script.c to get the \nright \n> results, but my server seems to return the responses I expect. \n \nIf you're saying we've got something wrong in the patch, please explain. ", "tags": [], "bug_id": 38070, "attachment_id": null, "count": 4, "id": 85377, "time": "2006-02-03T01:39:45Z", "creator": "nick@webthing.com", "creation_time": "2006-02-03T01:39:45Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 38070, "attachment_id": null, "text": "Fixed in:  \n trunk: http://svn.apache.org/viewcvs?rev=370692&view=rev  \n 2.0:   http://svn.apache.org/viewcvs?rev=374894&view=rev \n 2.2:   http://svn.apache.org/viewcvs?rev=374895&view=rev ", "id": 85417, "time": "2006-02-04T18:50:09Z", "creator": "nick@webthing.com", "creation_time": "2006-02-04T18:50:09Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 38070, "text": "I have opened Red Hat's bugzilla case and ask RH to back\nport your patch into RH's.  \nhttps://bugzilla.redhat.com/bugzilla/show_bug.cgi?id=176663\n\nThen RH's engineer wrote in comment #5.\n\n>Comment #5 From Joe Orton (jorton@redhat.com)  \t on 2006-02-20 10:49 EST  \n[reply]  \t   \t \n>\n>The fix committed upstream prevents handling of conditional requests with a CGI\n>script which outputs an explicit (albeit redundant) \"Status: 200\" header.  This\n>would count as a regression so we would not include that patch as-is in a RHEL\n>update.\n>\n>I've prepared a (simpler) alternative patch, which fixes the real issue and will\n>make packages available for testing.\n>\n\n--- httpd-2.0.52/server/util_script.c.cgistatus\n+++ httpd-2.0.52/server/util_script.c\n@@ -462,6 +462,13 @@\n\n            if ((cgi_status == HTTP_OK) && (r->method_number == M_GET)) {\n                cond_status = ap_meets_conditions(r);\n+\n+                /* In case an explicit Status: header had set\n+                 * r->status_line, then unset it here, so that the\n+                 * actual handler return value will be honoured. */\n+                if (cond_status != OK) {\n+                    r->status_line = NULL;\n+                }\n            }\n            apr_table_overlap(r->err_headers_out, merge,\n                APR_OVERLAP_TABLES_MERGE);\n\nWith Red Hat's fix, apache with sample cgi return 200,304,304,304.\nWith Nick's fix, apache with sample cgi return 200,200,200,200.\nBoth cases, no more white (empty) display.\nBut,which one is better solution?\n", "count": 6, "id": 86002, "time": "2006-02-21T10:49:43Z", "creator": "standby24x7@gmail.com", "creation_time": "2006-02-21T10:49:43Z", "is_private": false}, {"count": 7, "tags": [], "text": "The CGI spec. is quite explicit on this: \n \n7.2.1.3. Status   \n The \"Status\" header field is used to indicate to the server what status code  \nthe server MUST use in the response message. \n \nso a patch that causes it to change that breaks CGI. \n \nHaving said that, for the particular example reported in this bug, Joe's fix \nis better in practical terms.  That's because the CGI script itself misused \n\"status\".  See todays thread on dev@httpd. ", "attachment_id": null, "id": 86017, "creator": "nick@webthing.com", "time": "2006-02-21T16:56:08Z", "bug_id": 38070, "creation_time": "2006-02-21T16:56:08Z", "is_private": false}, {"count": 8, "tags": [], "creator": "Dave.Sparks@dandasparks.org.uk", "text": "Notwithstanding a semantically flawed sentence in a draft which expired over six\nyears ago, a CGI script which includes cache validation headers in its response\ncannot rely on a status code of 200 being returned to the client.  An HTTP/1.1\nproxy may return a 304 response without troubling the server; or if it has to\ntransmit the request via an HTTP/1.0 proxy it may convert a conditional GET to a\nHEAD whose 200 response may be converted to a 304 if the conditions are\nsatisfied.  Insisting that a 200 response with cache validation headers be\ntransmitted unchanged is futile.\n\nThe draft supposedly encodes current CGI practice, but I suspect that in the\narea of cache validation headers in CGI-generated responses there is no current\npractice to encode.\n\nThe documentation for mod_asis says \"A Status: header is also required\", where\n'required' implies that it can never be omitted.  Since the header handling is\ncommon with mod_cgi the documentation is plainly wrong.  I have removed the\nStatus line from my 802 .asis files with no ill effects.\n\nWhatever the outcome of the argument about \"Status: 200\" with a \"Last-Modified:\"\nwhich satisfies a conditional request, I'm going to have to continue to patch\nap_scan_script_header_err to include my \"ETag:\" headers in the check.", "id": 86033, "time": "2006-02-21T20:39:24Z", "bug_id": 38070, "creation_time": "2006-02-21T20:39:24Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "creator": "nick@webthing.com", "text": "(In response to Dave Sparks) \n \n1. What a proxy can do with a response is totally independent of CGI rules.  \nThey operate at different levels, and affect different agents. \n \n2. Thanks for the headsup re: mod_asis documentation.  I've just fixed \nthe .xml source, so that should propagate through to the live docs in due \ncourse. \n \n3. You keep telling us you had to patch a problem, but I still can't see a \nproblem description.  If we had one, maybe we could fix it, as we have done \nthe bug that was clearly and accurately described in this bug report. ", "id": 86044, "time": "2006-02-21T22:29:37Z", "bug_id": 38070, "creation_time": "2006-02-21T22:29:37Z", "is_private": false, "attachment_id": null}]