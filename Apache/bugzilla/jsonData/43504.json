[{"count": 0, "tags": [], "creator": "marcus.albrecht@sycor.de", "attachment_id": null, "text": "Dear Ladies and Gentlemen,\n\nafter upgrading vom Apache 2.2.4 to 2.2.6 my configuration with mod_proxy and \nAJP stopped working.\nDowngrading to 2.2.4 it worked again. (Platform is Red Hat Linux Enterprise 4)\n\nThe Apache error log showed:\n[Fri Sep 28 14:38:53 2007] [error] ajp_msg_append_uint8(): \nBufferOverflowException 4 4\n[Fri Sep 28 14:38:53 2007] [error] ajp_msg_append_uint8(): \nBufferOverflowException 4 4\n\nWhen accessing the webpage i got:\n\n\"Service Temporarily Unavailable\nThe server is temporarily unable to service your request due to maintenance \ndowntime or capacity problems. Please try again later.\"\n\nThere are two servers which are spoken to via mod_proxy / balancer and AJP.\nOne is primary and the other standby. Normally the first gets served. After \nupgrading to 2.2.6 the state of the primary changes to error and the standby \ndoes not jump in.\nThe Backends are Tomcat 5.5.20.\n\n\nBalancer Page:\nLoad Balancer Manager for www.xxx.com\nServer Version: Apache/2.2.6 (Unix) mod_ssl/2.2.6 PHP/5.2.3 \nServer Built: Sep 28 2007 13:05:04 \n--------------------------------------------------------------------------------\nLoadBalancer Status for balancer://testname_lb\nStickySession Timeout FailoverAttempts Method \n 0 1 byrequests \n\nWorker URL Route RouteRedir Factor Set Status Elected To From \najp://192.168.40.146:8009   1 0 Stby Ok 0 0  0  \najp://192.168.40.145:8009   1 0 Err  4 0  0  \n\nApache 2.2.4 and 2.2.6 are both compiled with the following parameters:\n\n./configure  --prefix=/usr/local/apache2 --enable-proxy --enable-proxy-ajp --\nenable-proxy-balancer  --enable-proxy-connect --enable-proxy-http --enable-\nrewrite  --enable-ssl --with-mpm=worker --with-included-apr\n\nBes regards,\n\nMarcus Albrecht\n\n-------------\n\nApache Config:\n\nServerRoot \"/usr/local/apache2\"\nListen 80\nHostnameLookups off\n\nLoadModule php5_module        modules/libphp5.so\nAddType application/x-httpd-php .php .phtml\n\n<IfModule !mpm_netware_module>\nUser nobody\nGroup nobody\n</IfModule>\n\n\nServerAdmin info@xxx.de\nServerName xxx.xxx.de\nDocumentRoot \"/usr/local/apache2/htdocs\"\n\n<Directory />\n    Options FollowSymLinks\n    AllowOverride None\n    Order deny,allow\n    Deny from all\n</Directory>\n\n<Directory \"/usr/local/apache2/htdocs\">\n    Options Indexes FollowSymLinks\n    AllowOverride None\n    Order allow,deny\n    Allow from all\n</Directory>\n\n<IfModule dir_module>\n    DirectoryIndex index.html\n</IfModule>\n\n\n<FilesMatch \"^\\.ht\">\n    Order allow,deny\n    Deny from all\n    Satisfy All\n</FilesMatch>\n\nErrorLog logs/error_log\nLogLevel warn\n\n<IfModule log_config_module>\n    LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\" \ncombined\n    LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b\" common\n    <IfModule logio_module>\n      # You need to enable mod_logio.c to use %I and %O\n      LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" %\nI %O\" combinedio\n    </IfModule>\n    CustomLog logs/access_log common\n</IfModule>\n\n<IfModule alias_module>\n    ScriptAlias /cgi-bin/ \"/usr/local/apache2/cgi-bin/\"\n</IfModule>\n\n<IfModule cgid_module>\n    #Scriptsock logs/cgisock\n</IfModule>\n\n<Directory \"/usr/local/apache2/cgi-bin\">\n    AllowOverride None\n    Options None\n    Order allow,deny\n    Allow from all\n</Directory>\n\nDefaultType text/plain\n\n<IfModule mime_module>\n    TypesConfig conf/mime.types\n    AddType application/x-compress .Z\n    AddType application/x-gzip .gz .tgz\n</IfModule>\n# Server-pool management (MPM specific)\nInclude conf/extra/httpd-mpm.conf\n# Multi-language error messages\n#Include conf/extra/httpd-multilang-errordoc.conf\n# Fancy directory listings\n#Include conf/extra/httpd-autoindex.conf\n# Language settings\n#Include conf/extra/httpd-languages.conf\n# User home directories\n#Include conf/extra/httpd-userdir.conf\n# Real-time info on requests and configuration\n#Include conf/extra/httpd-info.conf\n# Virtual hosts\n\nNameVirtualHost xxx.xxx.xxx.xxx:80\n\n# Local access to the Apache HTTP Server Manual\n#Include conf/extra/httpd-manual.conf\n# Distributed authoring and versioning (WebDAV)\n#Include conf/extra/httpd-dav.conf\n# Various default settings\n#Include conf/extra/httpd-default.conf\n# Secure (SSL/TLS) connections\n#Include conf/extra/httpd-ssl.conf\n\n<IfModule ssl_module>\nSSLRandomSeed startup builtin\nSSLRandomSeed connect builtin\n</IfModule>\n\n\n<VirtualHost xxx.xxx.xxx.xxx:80>\n    ServerName www.xxx.com\n    ServerAdmin info@xxx.com\n#    DocumentRoot /data/domain/xxx/html/\n    ErrorLog /data/xxx-error.log\n    CustomLog /data/xxx-access.log combined\n\nKeepAlive On\nKeepAliveTimeout 2\nProxyRequests Off\nRewriteEngine On\n\n# If /cps* the get Data from internal\nRewriteCond %{REQUEST_URI} /cps[\\/]?\n#RewriteRule ^/(.*) ajp://192.168.40.145:8009/$1 [L,P]\nRewriteRule ^/(.*) balancer://testname_lb/$1 [L,P]\n\n# If anythin else then above the redicet to first page (Proxy Pass with rewrite)\nRewriteCond %{REQUEST_URI} /.*\nRewriteRule ^/$ balancer://testname_lb/cps/rde/xchg/project/hs.xsl/index.html \n[P]\nRewriteRule ^/index.html$ \nbalancer://testname_lb/cps/rde/xchg/project/index.html [P]\n\n\n<Proxy balancer://testname_lb>\nBalancerMember ajp://192.168.40.146:8009 keepalive=on ping=15 timeout=30 \nstatus=+H\nBalancerMember ajp://192.168.40.145:8009 keepalive=on ping=15 timeout=30\nProxySet lbmethod=byrequests\n</Proxy>\n\n<Location /balancer-manager/>\nSetHandler balancer-manager\nOrder Deny,Allow\nDeny from all\nAllow from 192.168\n</Location>\n\n</VirtualHost>", "id": 108751, "time": "2007-09-28T07:08:02Z", "bug_id": 43504, "creation_time": "2007-09-28T07:08:02Z", "is_private": false}, {"count": 1, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "is_private": false, "id": 113060, "time": "2008-01-22T12:31:58Z", "bug_id": 43504, "creation_time": "2008-01-22T12:31:58Z", "text": "Can you please try to apply the following patch, which is a backport of the\nfollowing trunk revisions:\n\nhttp://svn.apache.org/viewvc?view=rev&revision=467259\nhttp://svn.apache.org/viewvc?view=rev&revision=467274\n\n\nIndex: modules/proxy/ajp.h\n===================================================================\n--- modules/proxy/ajp.h (Revision 614304)\n+++ modules/proxy/ajp.h (Arbeitskopie)\n@@ -147,6 +147,7 @@\n #define AJP_MSG_BUFFER_SZ           8192\n #define AJP_MAX_BUFFER_SZ           65536\n #define AJP13_MAX_SEND_BODY_SZ      (AJP_MAX_BUFFER_SZ - AJP_HEADER_SZ)\n+#define AJP_PING_PONG_SZ            128\n\n /** Send a request from web server to container*/\n #define CMD_AJP13_FORWARD_REQUEST   (unsigned char)2\nIndex: modules/proxy/ajp_utils.c\n===================================================================\n--- modules/proxy/ajp_utils.c   (Revision 614304)\n+++ modules/proxy/ajp_utils.c   (Arbeitskopie)\n@@ -31,7 +31,7 @@\n     ap_log_error(APLOG_MARK, APLOG_DEBUG, 0, r->server,\n                          \"Into ajp_handle_cping_cpong\");\n\n-    rc = ajp_msg_create(r->pool, AJP_HEADER_SZ_LEN+1, &msg);\n+    rc = ajp_msg_create(r->pool, AJP_PING_PONG_SZ, &msg);\n     if (rc != APR_SUCCESS) {\n         ap_log_error(APLOG_MARK, APLOG_ERR, 0, r->server,\n                \"ajp_handle_cping_cpong: ajp_msg_create failed\");\n"}, {"count": 2, "tags": [], "creator": "jefft@apache.org", "attachment_id": null, "text": "With 2.2.8 and this configuration:\n\n<VirtualHost *:80>\n  ..\n  RewriteEngine on\n  RewriteRule ^/jira_testing(.*) ajp://localhost:20009/jira_testing$1 [P]\n  ..\n</VirtualHost>\n\n<Proxy ajp://localhost:20009/jira_testing>\n   ProxySet ping=1\n</Proxy>\n\nI got the same error:\n\n[Fri Mar 14 06:16:25 2008] [error] ajp_msg_append_uint8(): BufferOverflowException 4 4\n[Fri Mar 14 06:16:25 2008] [error] ajp_handle_cping_cpong: ajp_marshal_into_msgb failed\n[Fri Mar 14 06:16:25 2008] [error] (120001)APR does not understand this error code: proxy: AJP: cping/cpong failed to (null) (localhost)\n\n\nR\u00fcdiger's patch fixes it for me.", "id": 114623, "time": "2008-03-14T06:25:13Z", "bug_id": 43504, "creation_time": "2008-03-14T06:25:13Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 43504, "text": "Backported to 2.2.x as r615931 (http://svn.apache.org/viewvc?view=rev&revision=615931).", "id": 114631, "time": "2008-03-14T09:19:30Z", "creator": "rpluem@apache.org", "creation_time": "2008-03-14T09:19:30Z", "is_private": false, "attachment_id": null}]