[{"count": 0, "tags": [], "creator": "minfrin@apache.org", "attachment_id": null, "is_private": false, "id": 60964, "time": "2004-07-22T13:50:20Z", "bug_id": 30260, "creation_time": "2004-07-22T13:50:20Z", "text": "When proxy is reverse proxying a site under load tests, the following error is\nencountered:\n\n[error] (OS 10048)Only one usage of each socket address (protocol/network\naddress/port) is normally permitted.  : proxy: HTTP: attempt to connect to\n127.0.0.1:8080 (localhost) failed\n\nMladen Turk <mturk@apache.org> proposes the following fix to line 1037 of\nproxy_util.c:\n\n        /* make the connection out of the socket */\n        do {\n            rv = apr_socket_connect(*newsock, backend_addr);\n        } while (APR_STATUS_IS_EINTR(rv)); \n\nThe only query is whether the above code would be an infinite loop in any\ncircumstances."}, {"count": 1, "tags": [], "bug_id": 30260, "attachment_id": null, "text": "Further info:\n\nOS error 10048 means:\n\nTypically, only one usage of each socket address (protocol/IP address/port) is\npermitted. This error occurs if an application attempts to bind a socket to an\nIP address/port that has already been used for an existing socket, or a socket\nthat was not closed properly, or one that is still in the process of closing.\nFor server applications that need to bind multiple sockets to the same port\nnumber, consider using setsockopt (SO_REUSEADDR).\n", "id": 60965, "time": "2004-07-22T13:53:21Z", "creator": "minfrin@apache.org", "creation_time": "2004-07-22T13:53:21Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 30260, "attachment_id": null, "text": ">(OS 10048)Only one usage of each socket address (protocol/network\naddress/port) is normally permitted. \n\nMy guess is that this is the Win32 way to say that connect() failed due to\ntemporary shortage of ephemeral ports, and the user should reconfigure the OS to\nallow more such ports.  (Google for ->Win32 ephemeral port<- or similar.)\n\n>do {\n>            rv = apr_socket_connect(*newsock, backend_addr);\n>       } while (APR_STATUS_IS_EINTR(rv)); \n\napr_socket_connect() *should* handle EINTR internally for platforms where that\ncan happen; APR_STATUS_IS_EINTR() doesn't return true for 10048 anyway, does it?\n looks like Win32 version of the macro checks for WSAEINTR and APR_EINTR\n", "id": 60969, "time": "2004-07-22T14:26:15Z", "creator": "trawick@apache.org", "creation_time": "2004-07-22T14:26:15Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 30260, "attachment_id": null, "text": "Would it be possible to improve the error message so that it better explains\nwhat needs to be done?\n\nThis issue was highlighted in a thread on tomcat-dev, where people were showing\nthat benchmarks of proxy with tomcat on the backend were returning errors.\n\nIf these errors are potentially Win32 related (or caused), then the error should\nprobably say what needs to be changed to prevent the error from occuring.\n\nIs there anything httpd can do to stop this error?\n", "id": 60971, "time": "2004-07-22T14:47:39Z", "creator": "minfrin@apache.org", "creation_time": "2004-07-22T14:47:39Z", "is_private": false}, {"count": 4, "tags": [], "text": "(Adding comments from mturk@apache.org)\n\nGraham Leggett wrote:\n\n\n>> Can you look at the comments at\n>> http://issues.apache.org/bugzilla/show_bug.cgi?id=30260 - \n>> apparently this may be a Windows specific problem.\n>>\n\n\nCould be, or not.\n\nIf for example after connect I write:\n\nif (rv == 730048) { \n  apr_socket_close(*newsock);\n  *newsock = NULL;\n  continue;\n}\n\n\nIt goes in an infinite loop, but it should not.\n \n \n\n>> I'm a unix type, so the windows issues are not something I am \n>> familiar with.\n>>\n\n\nThink that has nothing to do with windows (I even lowered the thread count\nto 50), but not sure.\nIf someone wishes to check that on some worker mpm with high thread count.\n\nIt serves 1995 conections, either ab -n 2000 or 2 x ab -n 1000 (the first\none has no errors, the second has 5 errors).\nAfter that any attempt to connect to mod_proxy returns 503.\n\nI've spend couple of hours trying to find the bug, or at least the reason,\nbut I'm slightly loosing the interest.\n\nRegards,\nMT.\n", "attachment_id": null, "bug_id": 30260, "id": 60974, "time": "2004-07-22T16:26:16Z", "creator": "minfrin@apache.org", "creation_time": "2004-07-22T16:26:16Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 30260, "attachment_id": null, "text": ">Would it be possible to improve the error message so that it better explains\n>what needs to be done?\n\nunclear; one concern is that there is no unique errno (or OS equivalent) which\nsays that the operation failed due to no available ephemeral port, and it would\nbe hard to say definitively that some OS foo returns some error code bar from\nthis particular call to connect() IFF it is out of ephemeral ports\n\nproxy could add something a bit vague like \"(out of ephemeral ports?)\" to its\nlog message based on looking at the apr_status_t (definitely can't add that for\nthe normal ECONNREFUSED errors or perhaps several others\n\n>If these errors are potentially Win32 related (or caused), then the error should\n>probably say what needs to be changed to prevent the error from occuring.\n\nRunning out of ephemeral ports in load test scenarios can happen on any platform\nI have access to if I haven't tweaked the OS to allow a full range of ephemeral\nports.\n\n--/--\n\nBack to the big picture: Somebody getting that message during load testing needs\nto increase the range of ephemeral ports to the full possible range and verify\nthat their problem is resolved.  I can only say this:\n\n* running out of ephemeral ports is something that can happen with such a test\n* different OSs report different error codes on connect when you run out of\nephemeral ports\n* that very well could be the Win32 way of reporting it but I can't say for certain", "id": 60975, "time": "2004-07-22T16:49:18Z", "creator": "trawick@apache.org", "creation_time": "2004-07-22T16:49:18Z", "is_private": false}, {"count": 6, "tags": [], "creator": "minfrin@apache.org", "attachment_id": null, "id": 60977, "time": "2004-07-22T17:44:05Z", "bug_id": 30260, "creation_time": "2004-07-22T17:44:05Z", "is_private": false, "text": "So basically something has to be done to Windows to fix this problem.\n\nIs there any Apache httpd docs that describe using httpd under load? Maybe a\nnote should be made there on how to fix this problem, assuming such docs exist.\n"}, {"count": 7, "tags": [], "creator": "briangalle@earthlink.net", "attachment_id": null, "is_private": false, "id": 89972, "time": "2006-06-08T22:44:20Z", "bug_id": 30260, "creation_time": "2006-06-08T22:44:20Z", "text": "  I am using Apache HTTP Server 2.0.53 and it doesn't have a proxy_util.c: file\nin it's proxy directory."}, {"count": 8, "tags": [], "text": "This is not an Apache issue.", "attachment_id": null, "bug_id": 30260, "id": 102714, "time": "2007-05-01T04:46:16Z", "creator": "fielding@apache.org", "creation_time": "2007-05-01T04:46:16Z", "is_private": false}]