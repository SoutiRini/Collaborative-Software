[{"count": 0, "tags": [], "bug_id": 54507, "text": "The Tomcat backgroundprocess for expiring sessions does not wait for the servlet context (application loaded by a filter) to be fully initialized. The following stacktrace happens while Filter.init is still being executed (hence the application is only partly initialized and shouldn't receive any work):\n\n        at org.apache.wicket.protocol.http.WebApplication.sessionUnbound(WebApplication.java:552)\n        at org.apache.wicket.session.HttpSessionStore$SessionBindingListener.valueUnbound(HttpSessionStore.java:465)\n        at org.apache.catalina.session.StandardSession.removeAttributeInternal(StandardSession.java:1800)\n        at org.apache.catalina.session.StandardSession.expire(StandardSession.java:865)\n        at org.apache.catalina.session.StandardSession.isValid(StandardSession.java:658)\n        at org.apache.catalina.session.ManagerBase.processExpires(ManagerBase.java:534)\n        at org.apache.catalina.session.ManagerBase.backgroundProcess(ManagerBase.java:519)\n        at org.apache.catalina.core.ContainerBase.backgroundProcess(ContainerBase.java:1352)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1530)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1540)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1540)\n        at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run(ContainerBase.java:1519)\n        at java.lang.Thread.run(Thread.java:722)", "id": 164952, "time": "2013-01-31T07:59:11Z", "creator": "sverre.boschman@topicus.nl", "creation_time": "2013-01-31T07:59:11Z", "is_private": false, "attachment_id": null}, {"count": 1, "attachment_id": null, "bug_id": 54507, "text": "Configuring an application in a Filter.init() method is a poor design choice. Application initialization should happen in a ServletContextListener.\n\nThere is a little ambiguity in section 6.2.1 of the Servlet specification but your interpretation (that Filter#init() must be called for all filters before requests are served) is consistent with how the Tomcat developers have implemented filter initialization.\n\nThat said, I do not see how the behavior you describe can occur. The background processing method exits immediately if the component is not available - which it isn't when the Filters are being started.\n\nI have moved the starting/stopping of the thread since the thread can't do anything until the start method completes so there is no point starting it earlier. However, that shouldn't change the current behavior.\n\nI also found and fixed a problem in Tomcat trunk where the test for component availability was being skipped. However, Tomcat 7 does not exhibit that problem.\n\nMarking this as fixed due to the Tomcat 8 fix.", "id": 164974, "time": "2013-02-01T12:23:27Z", "creator": "markt@apache.org", "creation_time": "2013-02-01T12:23:27Z", "tags": [], "is_private": false}]