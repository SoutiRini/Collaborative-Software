[{"count": 0, "attachment_id": null, "creator": "andersk@mit.edu", "text": "PowerTOP shows httpd waking up 20 times per second on a completely idle server.  This is wasteful of CPU time and power, especially on a laptop or a virtual machine.  The biggest culprit appears to be the following code in server/mpm/event/event.c:\n\n        apr_thread_mutex_lock(g_timer_skiplist_mtx);\n        te = apr_skiplist_peek(timer_skiplist);\n        if (te) {\n            if (te->when > now) {\n                timeout_interval = te->when - now;\n            }\n            else {\n                timeout_interval = 1;\n            }\n        }\n        else {\n            timeout_interval = apr_time_from_msec(100);\n        }\n        apr_thread_mutex_unlock(g_timer_skiplist_mtx);\n\n        rc = apr_pollset_poll(event_pollset, timeout_interval, &num, &out_pfd);\n\nwhich says if there\u2019s no reason to wake up, wake up every 100 ms anyway.  apr_time_from_msec(100) should be replaced with -1.", "id": 180044, "time": "2014-12-28T22:41:41Z", "bug_id": 57399, "creation_time": "2014-12-28T22:41:41Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 57399, "is_private": false, "text": "> which says if there\u2019s no reason to wake up, wake up every 100 ms anyway. \n> apr_time_from_msec(100) should be replaced with -1.\n\nWouldn't the server then miss timer events registered and fired while there is no poll activity in the server?  Maybe we could document the limited features that use timers and expose the 100ms number as configuration.", "id": 180052, "time": "2014-12-29T13:17:18Z", "creator": "covener@gmail.com", "creation_time": "2014-12-29T13:17:18Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 57399, "text": "Looking at that code, if replacing 100 ms with -1 would cause the server to miss timers registered when no timers are in progress, then it must already be the case that the server will miss timers registered when a longer timer is in progress.  I assumed that, for correctness, anything that registers an earlier timer must also arrange for the listener thread to break out of its current apr_pollset_poll (either via an FD event or via a signal) so that it can be restarted with a lower timeout.  If that isn\u2019t already the case, it should be fixed either way.", "id": 180064, "time": "2014-12-29T20:46:17Z", "creator": "andersk@mit.edu", "creation_time": "2014-12-29T20:46:17Z", "is_private": false, "attachment_id": null}, {"attachment_id": 34142, "tags": [], "creator": "toscano.luca@gmail.com", "text": "Created attachment 34142\nIntroduce APR_POLLSET_WAKEABLE in mpm-event\n\nAdding a patch that should solve the problem, but we'd need to:\n\n1) verify that APR_POLLSET_WAKEABLE is reliable and suitable for mpm-event;\n2) test test test\n3) verify that if the pollset does not support APR_POLLSET_WAKEABLE the behavior will still be correct.\n\nThanks a lot for bringing up the issue!", "count": 3, "id": 193059, "time": "2016-08-12T06:53:04Z", "bug_id": 57399, "creation_time": "2016-08-12T06:53:04Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 57399, "text": "Something that may be an issue: the calls to process_timeout_queue to manage Keep Alives, Lingering close and Write completion sockets.\n\nThe function seems to be called after each wake up, so sleeping indefinitely while idle could lead to miss some events.", "id": 193073, "time": "2016-08-12T13:44:43Z", "creator": "toscano.luca@gmail.com", "creation_time": "2016-08-12T13:44:43Z", "is_private": false, "attachment_id": null}, {"count": 5, "attachment_id": 34167, "creator": "ylavic.dev@gmail.com", "is_private": false, "id": 193251, "time": "2016-08-22T08:48:17Z", "bug_id": 57399, "creation_time": "2016-08-22T08:48:17Z", "tags": [], "text": "Created attachment 34167\nmpm_event's listener wakeup\n\nThis patch makes full use of wakeups to avoid active polling and locking in the listener's (fast) path.\n\nWould you please test it Anders?"}, {"count": 6, "attachment_id": null, "creator": "andersk@mit.edu", "text": "(In reply to Yann Ylavic from comment #5)\n> Would you please test it Anders?\n\nThanks, that\u2019s a massive improvement.  Wakeups are reduced from ~30 per second to 1 per second.  That remaining one is the apr_sleep(apr_time_from_sec(1)) in ap_wait_or_timeout, called from server_main_loop.  Should I file another issue for that?", "id": 193254, "time": "2016-08-22T09:39:10Z", "bug_id": 57399, "creation_time": "2016-08-22T09:39:10Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "bug_id": 57399, "is_private": false, "id": 193258, "creation_time": "2016-08-22T12:02:14Z", "time": "2016-08-22T12:02:14Z", "creator": "ylavic.dev@gmail.com", "text": "Thanks for testing.\n\nRegarding ap_wait_or_timeout(), waking up waitpid() is another beast, possibly with a signal (but signals and threads...).\n\nThis PR looks fine (generic enough) to handle/discuss the case, I think we can keep it open for now.", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 57399, "is_private": false, "text": "Created attachment 34263\nmpm_event's listener wakeup (with fudge factor)\n\nPatch updated to handle a timeout fudge factor preventing multiple near wakeups within the same 0.1 second (queues), or 0.01 second (timers).\nThe former could possibly/later be increased to 0.5s sinces queues have a granularity of 1s anyway.", "id": 193787, "time": "2016-09-18T20:51:25Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2016-09-18T20:51:25Z", "attachment_id": 34263}, {"attachment_id": 34264, "tags": [], "creator": "ylavic.dev@gmail.com", "text": "Created attachment 34264\nmpm_event's listener wakeup (with fudge factor) for 2.4.x", "count": 9, "id": 193788, "time": "2016-09-18T20:54:34Z", "bug_id": 57399, "creation_time": "2016-09-18T20:54:34Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 57399, "is_private": false, "text": "Created attachment 34300\nmpm_event's listener wakeup v5 (trunk)\n\nFix !listener_is_wakeable case on graceful restart/shutdown (poll() timeout may be infinite while all workers are idle).", "id": 193973, "time": "2016-09-24T13:49:19Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2016-09-24T13:49:19Z", "attachment_id": 34300}, {"count": 11, "tags": [], "bug_id": 57399, "is_private": false, "text": "Created attachment 34301\nmpm_event's listener wakeup v5 (2.4.x)\n\nSame fix + r1732228 from trunk (otherwise good_methods[1:2] are not recognized as wakeable on 64bit systems, i.e. Solaris' port and Linux' epoll).", "id": 193974, "time": "2016-09-24T13:54:21Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2016-09-24T13:54:21Z", "attachment_id": 34301}, {"count": 12, "tags": [], "bug_id": 57399, "is_private": false, "text": "Committed to trunk in r1762718.", "id": 194073, "time": "2016-09-28T22:13:49Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2016-09-28T22:13:49Z", "attachment_id": null}, {"count": 13, "tags": [], "bug_id": 57399, "is_private": false, "text": "Anybody that wants to test this patch and provide feedback is more than welcome. Eventually it will become a 2.4.x backport proposal but more testing is probably needed (especially on multiple os/platforms).", "id": 195226, "time": "2016-11-26T08:52:20Z", "creator": "toscano.luca@gmail.com", "creation_time": "2016-11-26T08:52:20Z", "attachment_id": null}, {"count": 14, "attachment_id": null, "creator": "stefan@priebe.ws", "is_private": false, "id": 195657, "time": "2016-12-26T20:19:49Z", "bug_id": 57399, "creation_time": "2016-12-26T20:19:49Z", "tags": [], "text": "This one no longer applies to httpd 2.4.25."}, {"count": 15, "tags": [], "creator": "ylavic.dev@gmail.com", "attachment_id": 34557, "text": "Created attachment 34557\nmpm_event's listener wakeup v6 (2.4.x)\n\nMerges the following commits from trunk:\n- r1762580,\n- r1762701,\n- r1762702,\n- r1762718,\n- r1762742,\n- r1762743,\n- r1774538.\n\nThanks Stefan for testing!", "id": 195661, "time": "2016-12-26T23:15:25Z", "bug_id": 57399, "creation_time": "2016-12-26T23:15:25Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "stefan@priebe.ws", "is_private": false, "count": 16, "id": 196123, "time": "2017-01-17T20:53:37Z", "bug_id": 57399, "creation_time": "2017-01-17T20:53:37Z", "text": "Hi Yann,\n\nwhile testing V6 i'm experiencing segfaults.\n\nexit signal Segmentation\n\nserver-error.log:\nAH00052: child pid 14110 exit signal Segmentation fault (11)\n\ncurrently i'm trying to grab a core dump."}, {"attachment_id": 34641, "tags": [], "creator": "ylavic.dev@gmail.com", "text": "Created attachment 34641\nmpm_event's listener wakeup v7 (2.4.x)\n\nv6 + r1779354 (fixes queues/pollset race, hopefully).", "count": 17, "id": 196156, "time": "2017-01-18T16:47:47Z", "bug_id": 57399, "creation_time": "2017-01-18T16:47:47Z", "is_private": false}, {"count": 18, "tags": [], "bug_id": 57399, "text": "Backported to 2.4.28 in r1802146.", "id": 201272, "time": "2017-10-03T11:58:05Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2017-10-03T11:58:05Z", "is_private": false, "attachment_id": null}]