[{"count": 0, "tags": [], "text": "Assuem the following proxy settings:\n\n<proxy area=\"live\" ssl=\"true\" url=\"https://www.example.org\"/>\n<proxy area=\"live\" ssl=\"false\" url=\"http://www.example.org\"/>\n\nA request for http://www.example.org/secure.html (where secure ist ssl\nprotected\" is redirect to https://www.example.org/secure.html. This request\nagain is redirect to https://www.example.org/secure.html by the\nSslRedirectAction and so on ......\n\nI checked in a fix: \nIndex: SslRedirectAction.java\n===================================================================\n--- SslRedirectAction.java      (revision 584054)\n+++ SslRedirectAction.java      (working copy)\n@@ -74,7 +74,7 @@\n                 PolicyManager policyManager = accessController.getPolicyManager();\n                 Policy policy =\npolicyManager.getPolicy(accessController.getAccreditableManager(),\n                         url);\n-                if (policy.isSSLProtected()) {\n+                if (policy.isSSLProtected() &&\n!request.getScheme().equals(\"https\")) {\n                     Session session = RepositoryUtil.getSession(this.manager,\nrequest);\n                     LinkRewriter rewriter = new\nOutgoingLinkRewriter(this.manager, session, url,\n                             false, true, false);\n\nassuming that if the scheme is already https there is no need to redirect again.\n Maybe someone has a better solution for that problem. \n\nBTW I am not sure what happend if we use mod_proxy on a frontend apache server\nwhich does not redirect to tomcat using https??", "attachment_id": null, "bug_id": 43613, "id": 109304, "time": "2007-10-12T08:50:24Z", "creator": "jann.forrer@id.unizh.ch", "creation_time": "2007-10-12T08:50:24Z", "is_private": false}, {"count": 1, "tags": [], "text": "(In reply to comment #0)\n\n> +                if (policy.isSSLProtected() &&\n> !request.getScheme().equals(\"https\")) {\n\nMaybe we could use request.isSecure()?\n\n> BTW I am not sure what happend if we use mod_proxy on a frontend apache server\n> which does not redirect to tomcat using https??\n\nI guess then the redirect will fail. It should work with mod_proxy_ajp though.\nI'll give it a try.", "is_private": false, "bug_id": 43613, "id": 109785, "time": "2007-10-26T06:07:57Z", "creator": "andreas@apache.org", "creation_time": "2007-10-26T06:07:57Z", "attachment_id": null}, {"count": 2, "tags": [], "text": "(In reply to comment #1)\n> (In reply to comment #0)\n\n> > BTW I am not sure what happend if we use mod_proxy on a frontend apache server\n> > which does not redirect to tomcat using https??\n> \n> I guess then the redirect will fail.\n\nThat was bad wording, what I meant was that Lenya won't be informed that the\nhttps protocol is used, and the redirect won't be issued. A workaround might be\nto use a \"isSecure\" session attribute or something like that.\n\n", "attachment_id": null, "bug_id": 43613, "id": 109786, "time": "2007-10-26T06:09:54Z", "creator": "andreas@apache.org", "creation_time": "2007-10-26T06:09:54Z", "is_private": false}, {"count": 3, "tags": [], "text": "(In reply to comment #1)\n> (In reply to comment #0)\n> \n> > +                if (policy.isSSLProtected() &&\n> > !request.getScheme().equals(\"https\")) {\n> \n> Maybe we could use request.isSecure()?\n\nDone, it works with mod_proxy_ajp.\n\nCan we close this issue?", "attachment_id": null, "bug_id": 43613, "id": 109788, "time": "2007-10-26T06:40:37Z", "creator": "andreas@apache.org", "creation_time": "2007-10-26T06:40:37Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 43613, "attachment_id": null, "id": 109796, "time": "2007-10-26T07:17:43Z", "creator": "jann.forrer@id.unizh.ch", "creation_time": "2007-10-26T07:17:43Z", "is_private": false, "text": "if you want to use mod_proxy instead than you have to proxy via https like: \n\n ProxyRequests Off\n RewriteEngine On\n SSLProxyEngine On\n .....\n .....\n RewriteRule  ^/(.*) https://localhost:8443/lenya/unitemplate/live/$1  [P]\n ProxyPassReverse  / https://localhost:8443/\n\nBTW a session attribute is not enought. That works only the first time a user\ntries to access a ssl-page. If he tries to access another ssl-page via http the\nsession attribute is set and he could access the site via http :-( \n\nShall we leve the bug open until we have the documentation ready?"}, {"count": 5, "tags": [], "bug_id": 43613, "attachment_id": null, "text": "(In reply to comment #4)\n> if you want to use mod_proxy instead than you have to proxy via https like: \n> \n>  ProxyRequests Off\n>  RewriteEngine On\n>  SSLProxyEngine On\n>  .....\n>  .....\n>  RewriteRule  ^/(.*) https://localhost:8443/lenya/unitemplate/live/$1  [P]\n>  ProxyPassReverse  / https://localhost:8443/\n> \n> BTW a session attribute is not enought. That works only the first time a user\n> tries to access a ssl-page. If he tries to access another ssl-page via http the\n> session attribute is set and he could access the site via http :-(\n\nYou're right, this wouldn't help. Is there any way to achieve this behaviour\nwith plain mod_proxy?\n\n> Shall we leve the bug open until we have the documentation ready?\n\nSure. Would you mind taking a look at the docs and update them if necessary?\nhttp://lenya.zones.apache.org/docu/docs/2_0_x/tutorials/proxy/proxy.html\nMaybe can do this together in Freiburg.", "id": 109800, "time": "2007-10-26T07:36:12Z", "creator": "andreas@apache.org", "creation_time": "2007-10-26T07:36:12Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 43613, "attachment_id": null, "is_private": false, "id": 109802, "time": "2007-10-26T07:46:16Z", "creator": "jann.forrer@id.unizh.ch", "creation_time": "2007-10-26T07:46:16Z", "text": "As far as i know you have to proxy to https as described in my last Comment and\nset: SSLProxyEngine On\n\nI did not found another solutions. \n\nWe can update the docu in Freiburg or i will do after the meeting and then close\nthe bug."}, {"count": 7, "tags": [], "text": "Jann, are there any news about this issue?", "attachment_id": null, "id": 113220, "creator": "andreas@apache.org", "time": "2008-01-28T09:21:52Z", "bug_id": 43613, "creation_time": "2008-01-28T09:21:52Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 43613, "attachment_id": null, "id": 113258, "time": "2008-01-29T02:25:50Z", "creator": "jann.forrer@id.unizh.ch", "creation_time": "2008-01-29T02:25:50Z", "is_private": false, "text": "Forgot that bug :-( \nI will update the docu after thursday. As i said, the only solution i see at the\nmoment ist to proxy to https for secure connections. You have to be aware of\nthis if you setup your system (which is not that nice). "}, {"count": 9, "tags": [], "text": "\nif (policy.isSSLProtected() && !request.isSecure()) {\n     Session session = request.getSession(true);\n     ....\n\nworks at least for 1.2. That means no redirect loops if using mod_proxy but you have to proxy to https! \n\nI still need to update the docu. \n\nJann", "is_private": false, "bug_id": 43613, "id": 114102, "time": "2008-02-28T08:12:03Z", "creator": "jann.forrer@id.unizh.ch", "creation_time": "2008-02-28T08:12:03Z", "attachment_id": null}]