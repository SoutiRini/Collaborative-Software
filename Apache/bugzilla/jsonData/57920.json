[{"count": 0, "tags": [], "bug_id": 57920, "attachment_id": null, "id": 182949, "time": "2015-05-12T07:13:00Z", "creator": "776041669@qq.com", "creation_time": "2015-05-12T07:13:00Z", "is_private": false, "text": "i can not access the https port 443, there are so many CLOSE_WAIT in the server. i dumped the threads using the jvisualvm. there is a deadlock.\n\n\n\"http-nio-443-exec-41\" daemon prio=10 tid=0x00007ff618e3a000 nid=0x5384 waiting for monitor entry [0x00007ff61cda7000]\n   java.lang.Thread.State: BLOCKED (on object monitor)\n\tat org.apache.tomcat.websocket.WsSession.onClose(WsSession.java:463)\n\t- waiting to lock <0x00000006e18acd38> (a java.lang.Object)\n\tat org.apache.tomcat.websocket.WsFrameBase.processDataControl(WsFrameBase.java:342)\n\tat org.apache.tomcat.websocket.WsFrameBase.processData(WsFrameBase.java:284)\n\tat org.apache.tomcat.websocket.WsFrameBase.processInputBuffer(WsFrameBase.java:130)\n\tat org.apache.tomcat.websocket.server.WsFrameServer.onDataAvailable(WsFrameServer.java:56)\n\t- locked <0x00000006e18b3c98> (a java.lang.Object)\n\tat org.apache.tomcat.websocket.server.WsHttpUpgradeHandler$WsReadListener.onDataAvailable(WsHttpUpgradeHandler.java:203)\n\tat org.apache.coyote.http11.upgrade.AbstractServletInputStream.onDataAvailable(AbstractServletInputStream.java:203)\n\tat org.apache.coyote.http11.upgrade.AbstractProcessor.upgradeDispatch(AbstractProcessor.java:92)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:609)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1736)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1695)\n\t- locked <0x00000006e18aa7a0> (a org.apache.tomcat.util.net.SecureNioChannel)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\n\tat org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n\tat java.lang.Thread.run(Unknown Source)\n\n   Locked ownable synchronizers:\n\t- <0x000000068d8bcc58> (a java.util.concurrent.ThreadPoolExecutor$Worker)"}, {"count": 1, "tags": [], "bug_id": 57920, "attachment_id": null, "is_private": false, "id": 182950, "time": "2015-05-12T09:05:18Z", "creator": "markt@apache.org", "creation_time": "2015-05-12T09:05:18Z", "text": "No evidence of a deadlock provided in this report."}, {"count": 2, "text": "Yes, this thread looks fine.\n\nHowever, I still don't understand why read events lock (WsFrameServer.onDataAvailable) and write events don't. It should be fine to remove the WsFrameServer.onDataAvailable lock on connectionReadLock (it is only called by the read event from the upgrade handler, so no possible concurrency).\n\nNote: I have no idea if it would change anything to this deadlock.", "creator": "remm@apache.org", "attachment_id": null, "id": 182951, "time": "2015-05-12T09:22:27Z", "bug_id": 57920, "creation_time": "2015-05-12T09:22:27Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "creator": "776041669@qq.com", "attachment_id": null, "text": "(In reply to Remy Maucherat from comment #2)\n> Yes, this thread looks fine.\n> \n> However, I still don't understand why read events lock\n> (WsFrameServer.onDataAvailable) and write events don't. It should be fine to\n> remove the WsFrameServer.onDataAvailable lock on connectionReadLock (it is\n> only called by the read event from the upgrade handler, so no possible\n> concurrency).\n> \n> Note: I have no idea if it would change anything to this deadlock.\n\nSorry, actually it is my code bug. I invoke the method WsSession.getBasicRemote().sendText and override the onClose which results in the dead lock", "id": 182968, "time": "2015-05-13T03:33:04Z", "bug_id": 57920, "creation_time": "2015-05-13T03:33:04Z", "is_private": false}, {"count": 4, "tags": [], "text": "I'm fang the exact same issue, and can't find the culprit for this deadlock. How did you find it?", "is_private": false, "id": 185257, "creator": "izanmail@gmail.com", "time": "2015-09-15T14:56:44Z", "bug_id": 57920, "creation_time": "2015-09-15T14:56:44Z", "attachment_id": null}]