[{"attachment_id": null, "tags": [], "creator": "manabu.shibata@gmail.com", "is_private": false, "count": 0, "id": 161891, "time": "2012-09-02T12:38:16Z", "bug_id": 53814, "creation_time": "2012-09-02T12:38:16Z", "text": "When I deploy PDF file on ROOT Application.\nAnd I try to download the PDF file by access to direct URL(e.g.:http://localhost:8080/example.pdf).\nThen browser open Adobe Acrobat Reader but the Reader shows error message and could not display the PDF file.\n\nTomcat doesn't record any error log.\nAccess log shows Acrobat Reader does partial request.\n\n---\n192.168.58.97 - - [02/Sep/2012:21:05:47 +0900] \"GET /vsphere-esxi-vcenter-server-50-basics-guide.pdf HTTP/1.1\" 206 4096\n---\n\nWhen I deploy same pdf file to Tomcat 7.0.26 running on same machine.\nThen Acrobat Reader can display the file collectly.\n\nTomcat 7.0.28 and 7.0.29 has same problem.\n\n----- Environment -----\nServer: RHEL5.8\nJDK:1.6.0u33\nTomcat:7.0.27/7.0.28/7.0.29\n\nClient\nOS: Windows7\nBrownser: IE9\nPDF Viewer:Adobe Acrobat Reader 9.5.0"}, {"count": 1, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "text": "There have been several threads on users@ regarding this,\n\n[1] \"PDF Download problem tomcat >= 7.0.27\" started Jul 30, 2012\nhttp://markmail.org/thread/lkr6touhymrxn4rg\nhttp://marc.info/?t=134364331600004&r=1&w=2\n\n[2] \"Tomcat 7.x and Internet Explorer Adobe Reader plugin\" started Aug 21, 2012\nhttp://markmail.org/thread/loubsqje3ssqg7x7\nhttp://marc.info/?t=134555927900004&r=1&w=2\n\nSeveral notes:\n--------------\n1. Thus far nobody has shown any real data on what is wrong in Tomcat behaviour.\n\nWithout this, no real fix can be made.\nI am changing the state of this issue to NEEDINFO.\n\n2. According to [2] the problem appears only in IE, but not in Firefox or Chrome.\n3. According to [1] the problem does not appear in Adobe Reader 10.\n\nAccording to Abode site, Acrobat 9/Reader 9 are still supported, but their EOL is June 26, 2013. Maybe someone has to contact their support?\n\nhttp://blogs.adobe.com/adobereader/2012/06/one-year-from-now-adobe-reader-and-acrobat-9-eol.html\n\n4. A message that cites real request data (Jul 31)\nhttp://markmail.org/message/3ylg5wdzmv4yd6fi\n[[[\n206KO:\nGET /test.pdf HTTP/1.1\nAccept: */*\nRange: bytes=3446021-3447865, 475136-1792507\nAccept-Encoding: gzip, deflate\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727)\nHost: xxxx:8080\nConnection: Keep-Alive\nPragma: no-cache\n\nHTTP/1.1 206 Partial Content\nServer: Apache-Coyote/1.1\nAccept-Ranges: bytes\nETag: W/\"3447866-1343391729000\"\nLast-Modified: Fri, 27 Jul 2012 12:22:09 GMT\nContent-Type: multipart/byteranges;boundary=CATALINA_MIME_BOUNDARY\nDate: Tue, 31 Jul 2012 12:32:20 GMT\nContent-Length: 1319458 \n]]]\n\n5. If the problem is in how range requests are served,\nI can say the following:\n\n- The components that serves the response here is org.apache.catalina.servlets.DefaultServlet.\nMaybe someone could find a clue there.\n\n- It is possible to disable support for range requests by setting its init parameter \"useAcceptRanges\" to the value of \"false\". See\nhttp://tomcat.apache.org/tomcat-7.0-doc/default-servlet.html", "id": 161893, "time": "2012-09-02T14:50:45Z", "bug_id": 53814, "creation_time": "2012-09-02T14:50:45Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 53814, "text": "Hi,\n\nI can reproduce this on a Windows 7 (SP1) x64 machine with Java 1.7.0_07 (64-Bit), Tomcat 7.0.30, using HTTP-APR (TC Native 1.1.24, 64-Bit), and with IE9 + Adobe Reader 9.5.0 (on the same machine). I used the PDF file from the OP in http://markmail.org/thread/lkr6touhymrxn4rg.\n\nTo record the data which is sent on TCP connections to Tomcat, I created a small Java program that redirects TCP connections and writes the exact data which is transmitted to 2 Filestreams (one for sending and one for receiving) per opened TCP connection.\n\nI have uploaded a zip file which contains the original PDF file, and two folders which contains TCP stream data for Tomcat 7.0.30 and Tomcat 7.0.26. For each TCP connection, there are two file pairs, one with \"In\" and one with \"Out\".\nIt is available here: http://preisser.dynalias.org/dere1/Tomcat-PDF-Test.zip\n\nWhat I can see is:\n- With Tomcat 7.0.26, no problem occurs: IE does a request to the PDF file, and after some KB are transferred, the TCP connection is canceled. Then a new TCP connection is created, probably by Adobe Reader, which sends multiple requests with byte ranges (for the \"Fast Web View\").\n\n- With Tomcat 7.0.30, the behavior is the same, except that the Adobe Reader sometimes seems to cancel one of the TCP connections and then displays a \"Network Error\" (because of that, the file \"TCP-Data TC 7.0.30/Sock-1-In.txt\" has only 8.00 KiB).\n\nHowever, I don't know why Adobe Reader seems to think that there is an error, as I could not find anything wrong with Tomcat's response - the byte range response seems correct to me.\n\nMaybe someone which has more detailed knowledge with the HTTP protocol can examine the files to see if there is anything going wrong...", "id": 161952, "time": "2012-09-04T22:43:40Z", "creator": "kpreisser@apache.org", "creation_time": "2012-09-04T22:43:40Z", "is_private": false, "attachment_id": null}, {"count": 3, "text": "One small difference is\n7.0.26:\nContent-Type: multipart/byteranges; boundary=CATALINA_MIME_BOUNDARY\n\n7.0.30:\nContent-Type: multipart/byteranges;boundary=CATALINA_MIME_BOUNDARY\n\nThere is no whitespace in \";boundary\". (See bug 52811 for a cause of this change).\n\n----------\nWell, the grammar is (RFC 2616)\n\n       media-type     = type \"/\" subtype *( \";\" parameter )\n       parameter               = attribute \"=\" value\n\nor (RFC 2045)\n\n  content := \"Content-Type\" \":\" type \"/\" subtype\n             *(\";\" parameter)\n             ; Matching of media type and subtype\n             ; is ALWAYS case-insensitive.\n  parameter := attribute \"=\" value\n\nso officially there is no need for a whitespace there.\nIf Adobe Reader indeed expects a '; ', then they are not following the specification.\n\nI note, though, that many (if not all) examples in the specification have a whitespace before parameter. It seems that it would be more fool-proof to always include a whitespace there.\n\nSee o.a.tomcat.util.http.parser.AstMediaType#toString(), #toStringNoCharset()\ns/sb.append(';');/sb.append(\"; \");/", "bug_id": 53814, "is_private": false, "id": 161955, "time": "2012-09-05T04:19:41Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2012-09-05T04:19:41Z", "tags": [], "attachment_id": null}, {"count": 4, "tags": [], "text": "Hi Konstantin,\n\n(In reply to comment #3)\n> See o.a.tomcat.util.http.parser.AstMediaType#toString(), #toStringNoCharset()\n> s/sb.append(';');/sb.append(\"; \");/\n\nThank you.\nYou are right: When I apply this change to the Tomcat 7.0.30 sources, then Adobe Reader loads the PDF in IE without any error.\n\nSo it seems that indeed the client (I guess IE if Adobe Reader uses its API to do HTTP requests, since IE's User-Agent is submitted and the problem does not occur on Firefox or Chrome) is expecting a whitespace after the \";\".\n\nAlthough it is not really a Tomcat bug since the absent whitespace is spec-compliant as you said, I also think a whitespace should be added to not exclude non-spec-compliant clients.", "attachment_id": null, "bug_id": 53814, "id": 161974, "time": "2012-09-05T16:59:42Z", "creator": "kpreisser@apache.org", "creation_time": "2012-09-05T16:59:42Z", "is_private": false}, {"count": 5, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "This is a client bug, not a Tomcat one.\n\nGenerally, the Tomcat team does not make changes to work-around buggy clients.\n\nGiven which client is broken (Adobe Reader on IE) then the wide user base is potentially a reason to provide an optional work-around. That is probably best handled as a separate enhancement request with a better description rather than re-opening and editing this issue. Personally, I'd like to see some evidence that the bug had been reported to Adobe and they have refused to fix it before we even consider adding the work-around to Tomcat. Of course, there is always the \"user a different browser\" work-around.", "id": 161976, "time": "2012-09-05T17:11:35Z", "bug_id": 53814, "creation_time": "2012-09-05T17:11:35Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "markt@apache.org", "text": "I ended up revisiting the HTTP header parser as a result of another bug. The parser for Content-Type has been replaced and the new version contains a work-around for this bug. The work-around will remain in place as long as the following are true:\n- Adobe Acrobat Reader 9 is supported by Adobe\n- Adobe has not fixed the bug in Acrobat Reader 9\n\nSince the work-around is HTTP compliant and should not affect any other user agents, the work-around is hard-coded to enabled.", "count": 6, "id": 163156, "time": "2012-11-03T20:58:41Z", "bug_id": 53814, "creation_time": "2012-11-03T20:58:41Z", "is_private": false}]