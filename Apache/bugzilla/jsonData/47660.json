[{"count": 0, "tags": [], "bug_id": 47660, "attachment_id": null, "id": 129561, "time": "2009-08-07T01:56:27Z", "creator": "numberzero1029@gmail.com", "creation_time": "2009-08-07T01:56:27Z", "is_private": false, "text": "I'm using JMeter-2.3.4 to test a HTTP Server nowadays, and find out that\nJMeter can not send HTTP PUT or POST request with large files using HTTP\nSampler.\n\nAfter reading the the code of HTTP sampler and making experiments with\nHttpURLConnection class which is used in HTTP Sampler, I find out that it is\nJMeter's misusing HttpURLConnection class that trigerd suck bug.\n\nHttpURLConnection can add 'Content-Length' header automatically, so it will\nbuffer all the output stream before sending it in order to count the length\nof the stream.  So when we want to send a large file, HttpURLConnection will\nbuffer it until stack overflow.\n\nTo fix the problem of PUT(which also exists in POST method) large file, I modified the code of setHeaders\nmethod of org.apache.jmeter.protocol.http.sampler.PutWriter class.\nHere is a fragment of the modified code in setHeaders:\n\nif(hasPutBody) {\n   ///////////////modified place:////////////////\n   // Set the content length\n   // the following code makes no sense\n   // since the HttpURLConnection can add Content-Length header\n   // automatically\n   // connection.setRequestProperty(HTTPConstants.HEADER_CONTENT_LENGTH,\n   // Long.toString(contentLength));\n\n   // set the HttpURLConnection to send fixed length stream\n   // this code prevent HttpURLConnection to buffer output stream\n   if(connection instanceof HttpURLConnection){\n    ((HttpURLConnection)connection).setFixedLengthStreamingMode(contentLength);\n   }\n   ////////////////////end of modified place/////////////////////////\n\n\n   // Make the connection ready for sending post data\n   connection.setDoOutput(true);\n}\n\nAs is shown in the code, I comment out the code\n\"connection.setRequestProperty(HTTPConstants.HEADER_CONTENT_LENGTH,\nLong.toString(contentLength));\" (since HttpURLConnection will add it\nautomatically later), and add \"((HttpURLConnection)\nconnection).setFixedLengthStreamingMode(contentLength);\", this tells\nHttpURLConnection the fixed length of the request body and enables streaming\nof a HTTP request body without internal buffering.\n\nAfter making this modification, JMeter can send PUT HTTP request with large\nfiles to my HTTP Server.\n\nRegards\nHao Lin"}, {"count": 1, "tags": [], "creator": "sebb@apache.org", "attachment_id": null, "is_private": false, "id": 129608, "time": "2009-08-11T06:53:51Z", "bug_id": 47660, "creation_time": "2009-08-11T06:53:51Z", "text": "The method setFixedLengthStreamingMode() is only available with Java 1.5+\n\nThe current version of JMeter is targetted at Java 1.4+.\n\nHowever, Java 1.5 will become the minimum version at which point the proposed fix can be applied.\n\nIn the mean-time, you could try using the HttpClient sampler instead."}, {"count": 2, "tags": [], "bug_id": 47660, "is_private": false, "text": "There are some problems with the suggested patch:\n\n1) contentLength is currently held as a long, but setFixedLengthStreamingMode() requires an int. This would be easy enough to work round.\n\n2) When output streaming is enabled, authentication and redirection cannot be handled automatically. This is not so easy to fix.", "id": 129770, "time": "2009-08-18T06:27:20Z", "creator": "sebb@apache.org", "creation_time": "2009-08-18T06:27:20Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": null, "id": 151464, "time": "2011-11-14T12:12:41Z", "bug_id": 47660, "creation_time": "2011-11-14T12:12:41Z", "is_private": false, "text": "Still in 2.5.1"}, {"count": 4, "tags": [], "text": "\n\n*** This bug has been marked as a duplicate of bug 58852 ***", "is_private": false, "id": 188863, "creator": "p.mouawad@ubik-ingenierie.com", "time": "2016-02-26T21:28:50Z", "bug_id": 47660, "creation_time": "2016-02-26T21:28:50Z", "attachment_id": null}]