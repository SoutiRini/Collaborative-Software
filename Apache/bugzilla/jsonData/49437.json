[{"count": 0, "tags": [], "bug_id": 49437, "attachment_id": null, "text": "# /usr/local/apache/bin/httpd -v\nServer version: Apache/2.2.15 (Unix)\nServer built:   Apr  6 2010 11:11:49\n\n# /usr/local/apache/bin/httpd -l\nCompiled in modules:\n  core.c\n  mod_authn_file.c\n  mod_authn_default.c\n  mod_authz_host.c\n  mod_authz_groupfile.c\n  mod_authz_user.c\n  mod_authz_default.c\n  mod_auth_basic.c\n  mod_cache.c\n  mod_filter.c\n  mod_log_config.c\n  mod_env.c\n  mod_setenvif.c\n  mod_version.c\n  mod_ssl.c\n  worker.c\n  http_core.c\n  mod_mime.c\n  mod_status.c\n  mod_autoindex.c\n  mod_asis.c\n  mod_cgid.c\n  mod_cgi.c\n  mod_negotiation.c\n  mod_dir.c\n  mod_actions.c\n  mod_alias.c\n  mod_rewrite.c\n  mod_so.c\n\n\n# cat /usr/local/apache/conf/httpd-test.conf\n############################################################### alapveto adatok begin\nServerRoot \"/usr/local/apache\"\nListen ip_to_listen_on\nUser nobody\nGroup nogroup\nServerAdmin tech@monstermedia.hu\nServerName monstermedia.hu:80\nDocumentRoot \"/docroot\"\nDirectoryIndex index.html index.htm index.php\nExtendedStatus on\nServerTokens Prod\nServerSignature Off\nDefaultType text/plain\nTimeout 30\nKeepalive on\nMaxKeepAliveRequests 100\nKeepAliveTimeout 5\nUseCanonicalName Off\nAccessFilename .htaccess\nHostnameLookups off\nCoreDumpDirectory /tmp\n############################################################### alapveto adatok end\n\n############################################################### MPM begin\n<IfModule mpm_worker_module>\n  MaxClients 400\n  ServerLimit 16\n  StartServers 2\n  MinSpareThreads 25\n  MaxSpareThreads 75\n  ThreadsPerChild 25\n  ThreadStackSize 131072\n  MaxRequestsPerChild  10000\n</IfModule>\n############################################################### MPM end\n\n############################################################### access control begin\n<Directory />\n    Options FollowSymLinks\n    AllowOverride None\n    Order deny,allow\n    Deny from all\n</Directory>\n\n<Directory \"/docroot\">\n    Options -Indexes FollowSymLinks\n    AllowOverride All\n    Order allow,deny\n    Allow from all\n</Directory>\n\n<FilesMatch \"^\\.ht\">\n    Order allow,deny\n    Deny from all\n    Satisfy All\n</FilesMatch>\n############################################################### access control end\n\n################################################################### logging begin\nPidFile \"logs/httpd-test.pid\"\nErrorLog \"logs/error_log-test\"\nLogLevel error\nLogFormat \"%h %V %u %t \\\"%r\\\" %s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\" myvcommon\nCustomLog \"/usr/local/apache/logs/access_log\" myvcommon\n#################################################################### logging end\n\n#################################################################### alias begin\nAlias /icons/ \"/usr/local/apache/icons/\"\n<Directory \"/usr/local/apache/icons\">\n    Options Indexes MultiViews\n    AllowOverride None\n    Order allow,deny\n    Allow from all\n</Directory>\n#################################################################### alias end\n\n\n# ulimit -c unlimited\n# /usr/local/apache/bin/httpd -f /usr/local/apache/conf/httpd-test.conf\n\n# cat /docroot/.htaccess\nAuthType Basic\nAuthName \"Password Required\"\nAuthUserFile /docroot/.htpasswd\nRequire valid-user\n\n# cat /web/web/host/netlogic.hu/pages/stats/.htpasswd\nadminuser:sensitivepasswordhash\n\nthen sending a request with a browser causes httpd process to crash.\n\n\n# cat /usr/local/apache/logs/error_log-test\n[Mon Jun 14 20:11:47 2010] [notice] Apache/2.2.15 (Unix) mod_ssl/2.2.15 OpenSSL/0.9.8g configured -- resuming normal operations\n[Mon Jun 14 20:11:59 2010] [notice] child pid 669 exit signal Segmentation fault (11), possible coredump in /tmp\n\naccess_log-test is empty.\n\n\n\nbacktrace:\n\n# cd /tmp\n# gdb /usr/local/apache/bin/httpd 669\nGNU gdb 6.8-debian\nCopyright (C) 2008 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"x86_64-linux-gnu\"...\nAttaching to program: /usr/local/apache/bin/httpd, process 669\nptrace: No such process.\n\nwarning: Can't read pathname for load map: Input/output error.\nReading symbols from /usr/lib/libssl.so.0.9.8...done.\nLoaded symbols for /usr/lib/libssl.so.0.9.8\nReading symbols from /usr/lib/libcrypto.so.0.9.8...done.\nLoaded symbols for /usr/lib/libcrypto.so.0.9.8\nReading symbols from /lib/libm.so.6...done.\nLoaded symbols for /lib/libm.so.6\nReading symbols from /usr/local/apache/lib/libaprutil-1.so.0...done.\nLoaded symbols for /usr/local/apache/lib/libaprutil-1.so.0\nReading symbols from /usr/lib/libexpat.so.1...done.\nLoaded symbols for /usr/lib/libexpat.so.1\nReading symbols from /usr/local/apache/lib/libapr-1.so.0...done.\nLoaded symbols for /usr/local/apache/lib/libapr-1.so.0\nReading symbols from /lib/librt.so.1...done.\nLoaded symbols for /lib/librt.so.1\nReading symbols from /lib/libcrypt.so.1...done.\nLoaded symbols for /lib/libcrypt.so.1\nReading symbols from /lib/libpthread.so.0...done.\nLoaded symbols for /lib/libpthread.so.0\nReading symbols from /lib/libdl.so.2...done.\nLoaded symbols for /lib/libdl.so.2\nReading symbols from /lib/libc.so.6...done.\nLoaded symbols for /lib/libc.so.6\nReading symbols from /usr/lib/libz.so.1...done.\nLoaded symbols for /usr/lib/libz.so.1\nReading symbols from /lib/ld-linux-x86-64.so.2...done.\nLoaded symbols for /lib64/ld-linux-x86-64.so.2\nReading symbols from /lib/libnss_compat.so.2...done.\nLoaded symbols for /lib/libnss_compat.so.2\nReading symbols from /lib/libnsl.so.1...done.\nLoaded symbols for /lib/libnsl.so.1\nReading symbols from /lib/libnss_nis.so.2...done.\nLoaded symbols for /lib/libnss_nis.so.2\nReading symbols from /lib/libnss_files.so.2...done.\nLoaded symbols for /lib/libnss_files.so.2\nReading symbols from /lib/libgcc_s.so.1...done.\nLoaded symbols for /lib/libgcc_s.so.1\nFailed to read a valid object file image from memory.\nCore was generated by `./httpd -f /usr/local/apache/conf/httpd-test.conf'.\nProgram terminated with signal 11, Segmentation fault.\n[New process 671]\n[New process 698]\n[New process 697]\n[New process 696]\n[New process 695]\n[New process 693]\n[New process 692]\n[New process 691]\n[New process 690]\n[New process 689]\n[New process 688]\n[New process 687]\n[New process 686]\n[New process 685]\n[New process 684]\n[New process 683]\n[New process 682]\n[New process 681]\n[New process 680]\n[New process 679]\n[New process 678]\n[New process 677]\n[New process 676]\n[New process 675]\n[New process 674]\n[New process 673]\n[New process 669]\n#0  0x00007f729ff3ddd6 in apr_password_validate (passwd=0x1506722 \"sensitivepass\", hash=0x1507bc8 \"sensitivepasswordhash\")\n    at crypto/apr_md5.c:705\n705     crypto/apr_md5.c: No such file or directory.\n        in crypto/apr_md5.c\n(gdb) bt full\n#0  0x00007f729ff3ddd6 in apr_password_validate (passwd=0x1506722 \"sensitivepass\", hash=0x1507bc8 \"sensitivepasswordhash\")\n    at crypto/apr_md5.c:705\n        sample = \"\\000\\000\\000\\000\\000\\000\\000\\000\u00da\u00e1\\234\u00a0r\\177\\000\\000\\005\", '\\0' <repeats 15 times>, \"\\001\\000\\000\\000\\000\\000\\000\\000P\\177=A\\000\\000\\000\\000\u00a0>\u00f3\\237r\\177\\000\\000\u010c{P\\001\\000\\000\\000\\000P\\237=A\\000\\000\\000\\000\\\"@\\235\u00a0r\\177\\000\\000\\003\", '\\0' <repeats 15 times>, \"\\002\\000\\000\\000\\000\\000\\000\\000\u010c{P\\001\\000\\000\\000\\000\\\"gP\\001\\000\\000\\000\"\n        crypt_pw = <value optimized out>\n#1  0x000000000044ef08 in check_password (r=0x14fdb90, user=0x1506730 \"adminuser\", password=0x1506722 \"sensitivepass\")\n    at mod_authn_file.c:103\n        conf = <value optimized out>\n        f = (ap_configfile_t *) 0x1507b58\n        l = \"adminuser:sensitivepasswordhash\", '\\0' <repeats 6569 times>, \"\\220\\232=A\", '\\0' <repeats 16 times>, \"\\002\", '\\0' <repeats 227 times>, \"\\030\u0170O\\001\\000\\000\\000\\000p_P\\001\\000\\000\\000\\000p_P\\001\\000\\000\\000\\000h_P\\001\", '\\0' <repeats 12 times>, \"8\u0164G\\001\\000\\000\\000\\000H\\r\u017b\\237r\\177\\000\\000\\000\\000\\000\\000\\000\\000\\000\\000\\002\\000\\000\\000\\000\\000\\000\\000\u0159_P\\001\\000\\000\\000\\000 \\000\\000\\000\\000\\000\\000\\000\\020\\000\\000\\000\\000\\000\\000\\000\\030\u0170O\\001\\000\\000\\000\\000\u0159\\\\P\\001\\000\\000\\000\\000\\v\", '\\0' <repeats 15 times>, \"\u0158\\\\P\\001\\000\\000\\000\\000\u00b0\\234=A\\000\\000\\000\\000\u0110fP\\001\\000\"...\n        status = <value optimized out>\n        file_password = 0x1507bc8 \"sensitivepasswordhash\"\n#2  0x0000000000450356 in authenticate_basic_user (r=0x14fdb90) at mod_auth_basic.c:230\n        provider = (const authn_provider *) 0x49f7a0\n        current_auth = <value optimized out>\n        res = <value optimized out>\n        auth_result = <value optimized out>\n        current_provider = (authn_provider_list *) 0x0\n#3  0x000000000043ed43 in ap_run_check_user_id (r=0x14fdb90) at request.c:71\n        n = 1\n        rv = 2\n#4  0x00000000004410f4 in ap_process_request_internal (r=0x14fdb90) at request.c:214\n        file_req = 0\n        access_status = 0\n#5  0x000000000046f748 in ap_process_request (r=0x14fdb90) at http_request.c:280\n        access_status = 3\n#6  0x000000000046c778 in ap_process_http_connection (c=0x14f77b8) at http_core.c:190\n        r = (request_rec *) 0x14fdb90\n        csd = (apr_socket_t *) 0x0\n#7  0x000000000044b3f3 in ap_run_process_connection (c=0x14f77b8) at connection.c:43\n        n = 0\n        rv = 2\n#8  0x000000000048dd41 in worker_thread (thd=0x14a7410, dummy=<value optimized out>) at worker.c:544\n        process_slot = 0\n        thread_slot = 0\n        csd = (apr_socket_t *) 0x14f75a0\n        bucket_alloc = (apr_bucket_alloc_t *) 0x14fbb08\n        last_ptrans = <value optimized out>\n        ptrans = (apr_pool_t *) 0x14f7528\n        rv = <value optimized out>\n        is_idle = <value optimized out>\n---Type <return> to continue, or q <return> to quit---\n#9  0x00007f729f483fc7 in start_thread () from /lib/libpthread.so.0\nNo symbol table info available.\n#10 0x00007f729eff559d in clone () from /lib/libc.so.6\nNo symbol table info available.\n#11 0x0000000000000000 in ?? ()\nNo symbol table info available.", "id": 137632, "time": "2010-06-14T14:19:34Z", "creator": "erno.kovacs@freemail.hu", "creation_time": "2010-06-14T14:19:34Z", "is_private": false}, {"count": 1, "tags": [], "creator": "nick@webthing.com", "text": "Confused.  The crash comes from a strncmp, and seems to imply that your hash is a dangling pointer and segfaults when dereferenced.  Any chance of de-obfuscating the stack dump (create a non-sensitive dummy user so you can post it literally without revealing anything that matters).\n\nAlso your configuration doesn't look as if it should work in 2.2.  But that's a different issue, and a dicky config shouldn't cause segfault!", "id": 138144, "time": "2010-07-04T22:35:54Z", "bug_id": 49437, "creation_time": "2010-07-04T22:35:54Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 49437, "text": "(In reply to comment #1)\n> Confused.  The crash comes from a strncmp, and seems to imply that your hash is\n> a dangling pointer and segfaults when dereferenced.  Any chance of\n> de-obfuscating the stack dump (create a non-sensitive dummy user so you can\n> post it literally without revealing anything that matters).\n> \n> Also your configuration doesn't look as if it should work in 2.2.  But that's a\n> different issue, and a dicky config shouldn't cause segfault!\n\nit must be some mpm-worker/threading issue, since i moved to mpm-prefork, the problem doesnt exist anymore.", "id": 138158, "time": "2010-07-05T05:02:14Z", "creator": "erno.kovacs@freemail.hu", "creation_time": "2010-07-05T05:02:14Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 49437, "attachment_id": null, "text": "Confirming this issue with Apache 2.2.15. mpm_worker / mod_auth_basic crashes on <successful> authentication (on failing auth, everything goes smooth, mpm_prefork is okay, too).", "id": 138306, "time": "2010-07-09T12:19:20Z", "creator": "alex@net13.info", "creation_time": "2010-07-09T12:19:20Z", "is_private": false}, {"count": 4, "tags": [], "creator": "alex@net13.info", "text": "I found the reason and the (probable) solution.\n\nIt's related to the ThreadStackSize. I am using reduced TSS (131072 bytes, to be precise) to reduce memory footprint of the frontend. The crypt_data structure is just too large to fit on stack (it is more than 131072 bytes in size).\n\nWhile increasing TSS is a viable option, I still do think keeping several tens of kilobytes of temporary data on stack sounds nonsense. So, I made a patch to malloc the structure insted (feel free to correct me there if something more effective can be used instead of malloc).\n\nAttaching a patch.", "id": 138307, "time": "2010-07-09T14:35:30Z", "bug_id": 49437, "creation_time": "2010-07-09T14:35:30Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 49437, "attachment_id": 25737, "text": "Created attachment 25737\nProposed patch", "id": 138308, "time": "2010-07-09T14:37:11Z", "creator": "alex@net13.info", "creation_time": "2010-07-09T14:37:11Z", "is_private": false}, {"count": 6, "attachment_id": null, "bug_id": 49437, "is_private": false, "id": 138309, "time": "2010-07-09T14:50:08Z", "creator": "alex@net13.info", "creation_time": "2010-07-09T14:50:08Z", "tags": [], "text": "Oh, and the malloc is not always thread safe. While it works for me, the patch surely requires cleanup."}, {"count": 7, "tags": [], "bug_id": 49437, "attachment_id": null, "text": "The fact that 128k stack size will crash on Linux is now documented in trunk and 2.2.x: r1005529 and r1005531", "id": 140565, "time": "2010-10-07T13:22:13Z", "creator": "sf@sfritsch.de", "creation_time": "2010-10-07T13:22:13Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 49437, "attachment_id": null, "text": "This function has been copied from apr_md5.c to apr_passwd.c in r1357772.\nThis has been fixed later on in r1460243.\n\nThis is available in apr-util 1.5.2", "id": 167576, "time": "2013-06-02T05:16:30Z", "creator": "christophe.jaillet@wanadoo.fr", "creation_time": "2013-06-02T05:16:30Z", "is_private": false}]