[{"count": 0, "tags": [], "bug_id": 53911, "attachment_id": null, "id": 162313, "time": "2012-09-21T08:12:22Z", "creator": "testers3n3@gmail.com", "creation_time": "2012-09-21T08:12:22Z", "is_private": false, "text": "When the keyStore contains trustedCertEntry entries alongside the PrivateKeyEntry and the PrivateKeyEntry is not the 1st entry in the keyStore, Jmeter 2.7's JmeterKeystore.load cannot find the key. It throws an exception which accompanying message reads \"No key(s) found\".\n\nThe reason lies in the implementation of the load method. Its skeleton when scanning the aliases is:\n\n         if (null != is){ // is is the InputStream\n            PrivateKey _key = null;\n            int index = 0;\n            Enumeration<String> aliases = store.aliases();\n            while (aliases.hasMoreElements()) {\n                String alias = aliases.nextElement();\n                if (store.isKeyEntry(alias)) {\n                    if ((index >= startIndex && index <= endIndex)) {\n                        _key = (PrivateKey) store.getKey(alias,...);\n                        if (null == _key) {\n                            throw new Exception(...);\n                        }\n                        ...\n                        v_names.add(alias);\n                        ...\n                    }\n                }\n                index++;\n            }\n\n            if (null == _key) { // Defect: source of problem\n               throw new Exception(\"No key(s) found\");\n            }\n        }\n        int v_size = v_names.size();\n        ...\n\nSo:\n- The location test of _key itself would be a problem because _key would always be the last entry read in the keyStore, which might not be the private key.\n- But the fact that startIndex and endIndex are 0 (default initialisation values of implicitly initialised arguments, see SSLManager.java) implies that the private key would be found only if it was the 1st entry in the keystore. I didn't find any hint that this is a JSSE requirement.\n\nAssuming that only 1 key can be loaded (another source file states that no provision has been made to allow the user to specify one key amongst many) I think that:\n- the \"if ((index >= startIndex && index <= endIndex))\" condition gets in the way;\n- the validation that a key does exist in the keystore would be better done by asserting that \"v_size != 0\".\n\nNote that JMeter 2.4 was loading the keystore along the lines I'm suggesting, which is no surprise since I located the problem by investigating how JMeter 2.4 was getting it right when 2.7 was failing (on the same keystore)."}, {"count": 1, "tags": [], "bug_id": 53911, "attachment_id": null, "id": 162315, "creation_time": "2012-09-21T08:50:55Z", "time": "2012-09-21T08:50:55Z", "creator": "testers3n3@gmail.com", "text": "There is a mistake in my explanation of the problem. The core of it in the current implementation (official release of 2.7) is the condition around the index variable.\n\nWere that condition removed, _key would be set if one private key had been found, even if it is not the 1st entry in the keystore.\n\nSorry to the hasty confusing initial description.", "is_private": false}, {"count": 2, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": null, "id": 162387, "time": "2012-09-25T11:51:20Z", "bug_id": 53911, "creation_time": "2012-09-25T11:51:20Z", "is_private": false, "text": "Can you attach a keystore file showing the issue ?\nAnd also can you explain what issue you are facing.\n\nI agree there is a problem, but I want to know the impacts for you and what exactly is your test case.\nThank you"}, {"count": 3, "text": "Date: Thu Sep 27 20:14:28 2012\nNew Revision: 1391197\n\nURL: http://svn.apache.org/viewvc?rev=1391197&view=rev\nLog:\nBug 53911 - JmeterKeystore does not allow for key down the list of certificate\n\nModified:\n    jmeter/trunk/src/core/org/apache/jmeter/util/keystore/JmeterKeyStore.java\n    jmeter/trunk/xdocs/changes.xml", "bug_id": 53911, "is_private": false, "id": 162441, "time": "2012-09-27T20:15:43Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2012-09-27T20:15:43Z", "tags": [], "attachment_id": null}, {"count": 4, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": null, "id": 162446, "time": "2012-09-27T21:01:35Z", "bug_id": 53911, "creation_time": "2012-09-27T21:01:35Z", "is_private": false, "text": "Issue has been fixed but it would be very kind of you to make a test on nightly build to ensure it is for you and give us some feedback.\n\nSee:\nhttp://jmeter.apache.org/nightly.html"}]