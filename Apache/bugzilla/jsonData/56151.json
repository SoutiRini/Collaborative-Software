[{"attachment_id": null, "tags": [], "creator": "bob.sauvage@gmx.fr", "text": "Hi there, \n\nWe are running a high volume web application that uses Apache 2.2.15 mod_proxy \nto reverse proxy content from apache to JBoss 6. \n\nWe found 503 errors which happen sporadically throughout the day on random requests (perhaps 1/2% of daily requests).\n\nProxy config:\n\n    <IfModule mod_ssl.c>\n       <IfModule mod_proxy_http.c>\n          ProxyTimeout     600\n          SetEnv force-proxy-request-1.0 1\n          SetEnv proxy-nokeepalive 1\n          ProxyPass        /unproxied/ !\n          ProxyPass        /error/ !\n          ProxyPass        /   http://127.0.0.1:8080/ retry=0 ttl=600\n          ProxyPassReverse /   http://127.0.0.1:8080/\n       </IfModule>\n    </IfModule>\n\nJBoss config: \n\n        <Connector\n            address              = \"${jboss.bind.address}\"\n            port                 = \"8080\"\n            maxThreads           = \"200\"\n            acceptCount          = \"100\"\n            scheme               = \"https\"\n            secure               = \"true\"\n            proxyName            = \"xxx\"\n            proxyPort            = \"443\"\n            xpoweredBy           = \"true\"\n            connectionTimeout    = \"1200000\"\n            enableLookups        = \"false\"\n            maxKeepAliveRequests = \"-1\"\n            maxHttpHeaderSize    = \"50000\"\n            compression          = \"force\"\n            compressionMinSize   = \"512\"\n            compressableMimeType = \"text/html,text/xml,text/css,text/javascript,application/x-javascript,application/javascript,image/svg+xml,application/json,text/json\"\n            />\n\nWhat we can see in the error log:\n\n[Tue Feb 18 10:11:05 2014] [error] (110)Connection timed out: proxy: HTTP: attempt to connect to 127.0.0.1:9355 (127.0.0.1) failed\n[Tue Feb 18 10:11:05 2014] [error] ap_proxy_connect_backend disabling worker for (127.0.0.1)\n\nWhat se can see in the access log: \n\n[18/Feb/2014:10:11:07 +0100] \"HEAD /xxx HTTP/1.1\" 503 - \"https://xxx\" \"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"\n\nNothing appears in the JBoss log. \n\nIn the kernel log, we see that every error coincide with an invalid tcp packet: \n\nkernel: invalid:IN=lo OUT= MAC=00:00:00:00:00:00:00:00:00:00:00:00:08:00 SRC=127.0.0.1 DST=127.0.0.1 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=33082 DF PROTO=TCP SPT=48340 DPT=8080 WINDOW=32792 RES=0x00 SYN URGP=0\n\nAfter some investigations, this SYN packet is not acknowledged by JBoss in order to perform the TCP 3-Way Handshake.\n\nI don't know if this is related.", "count": 0, "id": 173316, "time": "2014-02-18T12:11:02Z", "bug_id": 56151, "creation_time": "2014-02-18T12:11:02Z", "is_private": false}, {"count": 1, "tags": [], "creator": "bob.sauvage@gmx.fr", "is_private": false, "text": "The error in the error log is not \"(110)Connection timed out: proxy:\" but \"(111)Connection refused: proxy\"\n\nSorry.", "id": 173317, "time": "2014-02-18T12:36:53Z", "bug_id": 56151, "creation_time": "2014-02-18T12:36:53Z", "attachment_id": null}, {"count": 2, "tags": [], "text": "Would seem to be an OS, HW, or network problem if the connection fails in this way. Can you fill the OS field appropriately and try on a different platform?", "is_private": false, "id": 173318, "creation_time": "2014-02-18T12:39:59Z", "time": "2014-02-18T12:39:59Z", "creator": "covener@gmail.com", "bug_id": 56151, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 56151, "text": "or the back-end is just temporarily overloaded...  maybe increasing the listen queue depth on the back-end would be enough to get over the occasional issue...", "id": 173319, "time": "2014-02-18T12:46:25Z", "creator": "trawick@apache.org", "creation_time": "2014-02-18T12:46:25Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 56151, "attachment_id": null, "is_private": false, "id": 173329, "time": "2014-02-18T13:51:56Z", "creator": "bob.sauvage@gmx.fr", "creation_time": "2014-02-18T13:51:56Z", "text": "The OS is RedHat 6.5\n\nSome additional info: \n\nInvalid packets were rejected by iptables. So the error in the error log was : \"(111)Connection refused: proxy\".\n\nThe tcpdump indicated that JBoss didn't reply to this TCP SYN. Quite normal, it was not received by JBoss due to iptables.\n\nI've added a rule in order to authorize invalid packet coming from Apache to JBoss. The error is now \"(110)Connection timed out: proxy\".\n\nIn the tcpdump, I can see the SYN packet sent by Apache, the SYN ACK sent by JBoss but the handshake is stopped by Apache which sends a RST packet. \n\nWhy Apache sends an invalid packet ? Why Apache sents a RST packet ?"}, {"count": 5, "tags": [], "text": "This issue was related to iptables. Some problems with rules on SYN packets.\n\nI decided to add a rule in order to ACCEPT all packets from 127.0.0.1 to or from port 8080.\n\nSince this update, I don't see this kind of errors anymore.\n\nThanks.", "is_private": false, "id": 173351, "creator": "bob.sauvage@gmx.fr", "time": "2014-02-19T09:34:13Z", "bug_id": 56151, "creation_time": "2014-02-19T09:34:13Z", "attachment_id": null}]