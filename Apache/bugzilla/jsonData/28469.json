[{"count": 0, "tags": [], "text": "I'm using mod_jk2 2.0.4. jk_logger_file.c uses apr_file_open_stderr to create a\nstderr handle. jk2_logger_file_init is called twice - once from setProperty, and\nonce from jk2_workerEnv_init. on the second call, the previously created stderr\nhandle is closed, and another apr_file_t handle is created - on the already\nclosed file handle 2. nothing is logged from now on, EBADF.\n\n(there is no separate bugzilla product for tomcat-connectors, so I put this\nreport into Tomcat 5/Native:JK, no idea if this is correct)", "is_private": false, "bug_id": 28469, "id": 56023, "time": "2004-04-19T14:21:10Z", "creator": "max@linuxtag.org", "creation_time": "2004-04-19T14:21:10Z", "attachment_id": null}, {"count": 1, "tags": [], "text": "This is an OK place to put the bug.  So we should modify the jk2_workerEnv_init \nmethod so that if it already has a handle on stderr, it won't close and reopen? \nWhy doesn't it work actually, after all the second stderr handle should still \nbe valid, no?\n\nIf you have an actual patch to jk_logger_file.c it'd be welcome.\n", "is_private": false, "id": 58322, "creator": "yoavs@computer.org", "time": "2004-05-28T14:42:44Z", "bug_id": 28469, "creation_time": "2004-05-28T14:42:44Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 28469, "attachment_id": null, "id": 58442, "time": "2004-06-01T09:02:45Z", "creator": "max@linuxtag.org", "creation_time": "2004-06-01T09:02:45Z", "is_private": false, "text": "Explanation: apr_file_open_stderr does not dup() the system stderr filehandle\n(fd 2), it just creates a new APR wrapper for fd 2. If you close the APR handle,\nthe original system stderr is closed, and all APR wrappers for fd 2 become\ninvalid. This might be considered an APR bug, because the abstraction offered by\nAPR is not consistent here.\n\nI'll attach my solution later today when I'm at my office."}, {"count": 3, "tags": [], "text": "Created attachment 11708\nworkaround patch (untested)", "is_private": false, "bug_id": 28469, "id": 58450, "time": "2004-06-01T12:24:21Z", "creator": "max@linuxtag.org", "creation_time": "2004-06-01T12:24:21Z", "attachment_id": 11708}, {"count": 4, "tags": [], "text": "I have now attached a patch which works around the problem - it tests whether\nthe previous name was \"stderr\" and simply doesn't close stderr handles. I just\nwrote down that patch without testing... just an idea to start with.\n\nPreviously, I have commented out the apr_file_close line in\njk2_logger_file_init. Object destruction and freeing memory doesn't really work\nin jk2 anyways (ever tried to run a small JK2 test program with dmalloc or\nsimilar heap debuggers? For some classes, there aren't even destructors\navailable.. - email me if you want my help with the code cleanup required here)", "is_private": false, "id": 58452, "creator": "max@linuxtag.org", "time": "2004-06-01T12:30:18Z", "bug_id": 28469, "creation_time": "2004-06-01T12:30:18Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 28469, "is_private": false, "text": "OK, patch applied to file.", "id": 59299, "time": "2004-06-16T14:34:59Z", "creator": "yoavs@computer.org", "creation_time": "2004-06-16T14:34:59Z", "attachment_id": null}]