[{"count": 0, "tags": [], "creator": "dan@danshome.net", "attachment_id": null, "id": 144274, "time": "2011-02-14T16:19:09Z", "bug_id": 50775, "creation_time": "2011-02-14T16:19:09Z", "is_private": false, "text": "+++ This bug was initially created as a clone of Bug #33774 +++\nJNDIRealm fails with ServiceUnavailableException and NotContextException\n\nWe are experiencing an issue very similar to the one reported in https://issues.apache.org/bugzilla/show_bug.cgi?id=33774\n\nAfter Tomcat is running for some period of time, any attempts to use the JNDI Realm fail with a ServiceUnavailableException and NotContextException (see full exception below).  A restart of Tomcat is required to fix the problem.  We only see this issue on Linux (Linux details below). We are running the exact same Tomcat binaries (not the native libraries of course) and configuration on Windows 2003 R2 and AIX 5.3 and we don't see this issue. I added alternateURL in hopes it might help, but the problem still exists.  \n\nMy JNDI Realm Definition:\n\n      <Realm className=\"org.apache.catalina.realm.JNDIRealm\"\n        connectionURL=\"ldap://ldap01:389\"\n\talternateURL=\"ldap://ldap02:389\"\n        connectionName=\"uid=ldapbind,cn=Applications,cn=MYSCOPE\"\n        connectionPassword=\"********\"\n        userBase=\"cn=MYSCOPE\"\n        userSearch=\"(uid={0})\"\n        userSubtree=\"true\"\n        roleBase=\"cn=MYSCOPE\"\n        roleSearch=\"(uniqueMember={0})\"\n        roleSubtree=\"true\"\n        roleName=\"cn\"\n      />\n\nTomcat Version Information:\n\nFeb 14, 2011 5:12:15 AM org.apache.catalina.core.AprLifecycleListener init\nINFO: Loaded APR based Apache Tomcat Native library 1.1.20.\n...\nFeb 14, 2011 5:12:19 AM org.apache.catalina.core.AprLifecycleListener init\nINFO: APR capabilities: IPv6 [true], sendfile [true], accept filters [false], random [true].\n...\nFeb 14, 2011 5:12:31 AM org.apache.catalina.core.StandardEngine start\nINFO: Starting Servlet Engine: Apache Tomcat/6.0.29\n\nJava Version Information:\n[root@AS01 bin]# ./java -version\njava version \"1.6.0_22\"\nJava(TM) SE Runtime Environment (build 1.6.0_22-b04)\nJava HotSpot(TM) Server VM (build 17.1-b03, mixed mode)\n\nLinux Version Information:\n[root@AS01 ~]# cat /etc/redhat-release \nCentOS release 5.3 (Final)\n[root@AS01 ~]# uname -a\nLinux AS01.dev.local 2.6.18-128.1.6.el5 #1 SMP Wed Apr 1 09:19:18 EDT 2009 i686 i686 i386 GNU/Linux\n\n\nFeb 14, 2011 2:17:12 PM org.apache.catalina.realm.JNDIRealm authenticate\nWARNING: Exception performing authentication\njavax.naming.ServiceUnavailableException: ldap01:389; socket closed; remaining name 'cn=MYSCOPE'\n\tat com.sun.jndi.ldap.Connection.readReply(Connection.java:419)\n\tat com.sun.jndi.ldap.LdapClient.getSearchReply(LdapClient.java:611)\n\tat com.sun.jndi.ldap.LdapClient.search(LdapClient.java:534)\n\tat com.sun.jndi.ldap.LdapCtx.doSearch(LdapCtx.java:1962)\n\tat com.sun.jndi.ldap.LdapCtx.searchAux(LdapCtx.java:1824)\n\tat com.sun.jndi.ldap.LdapCtx.c_search(LdapCtx.java:1749)\n\tat com.sun.jndi.toolkit.ctx.ComponentDirContext.p_search(ComponentDirContext.java:368)\n\tat com.sun.jndi.toolkit.ctx.PartialCompositeDirContext.search(PartialCompositeDirContext.java:338)\n\tat com.sun.jndi.toolkit.ctx.PartialCompositeDirContext.search(PartialCompositeDirContext.java:321)\n\tat javax.naming.directory.InitialDirContext.search(InitialDirContext.java:248)\n\tat org.apache.catalina.realm.JNDIRealm.getUserBySearch(JNDIRealm.java:1340)\n\tat org.apache.catalina.realm.JNDIRealm.getUser(JNDIRealm.java:1188)\n\tat org.apache.catalina.realm.JNDIRealm.getUser(JNDIRealm.java:1147)\n\tat org.apache.catalina.realm.JNDIRealm.authenticate(JNDIRealm.java:1089)\n\tat org.apache.catalina.realm.JNDIRealm.authenticate(JNDIRealm.java:947)\n\tat org.apache.catalina.authenticator.BasicAuthenticator.authenticate(BasicAuthenticator.java:181)\n\tat org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:528)\n\tat org.apache.catalina.valves.RequestFilterValve.process(RequestFilterValve.java:269)\n\tat org.apache.catalina.valves.RemoteAddrValve.invoke(RemoteAddrValve.java:81)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)\n\tat org.apache.catalina.ha.session.JvmRouteBinderValve.invoke(JvmRouteBinderValve.java:227)\n\tat org.apache.catalina.ha.tcp.ReplicationValve.invoke(ReplicationValve.java:347)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:298)\n\tat org.apache.coyote.http11.Http11AprProcessor.process(Http11AprProcessor.java:861)\n\tat org.apache.coyote.http11.Http11AprProtocol$Http11ConnectionHandler.process(Http11AprProtocol.java:579)\n\tat org.apache.tomcat.util.net.AprEndpoint$Worker.run(AprEndpoint.java:1584)\n\tat java.lang.Thread.run(Thread.java:662)\nFeb 14, 2011 2:17:12 PM org.apache.catalina.realm.JNDIRealm authenticate\nSEVERE: Exception performing authentication\njavax.naming.NotContextException: Not an instance of DirContext\n\tat javax.naming.directory.InitialDirContext.getURLOrDefaultInitDirCtx(InitialDirContext.java:92)\n\tat javax.naming.directory.InitialDirContext.search(InitialDirContext.java:248)\n\tat org.apache.catalina.realm.JNDIRealm.getUserBySearch(JNDIRealm.java:1340)\n\tat org.apache.catalina.realm.JNDIRealm.getUser(JNDIRealm.java:1188)\n\tat org.apache.catalina.realm.JNDIRealm.getUser(JNDIRealm.java:1147)\n\tat org.apache.catalina.realm.JNDIRealm.authenticate(JNDIRealm.java:1089)\n\tat org.apache.catalina.realm.JNDIRealm.authenticate(JNDIRealm.java:994)\n\tat org.apache.catalina.authenticator.BasicAuthenticator.authenticate(BasicAuthenticator.java:181)\n\tat org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:528)\n\tat org.apache.catalina.valves.RequestFilterValve.process(RequestFilterValve.java:269)\n\tat org.apache.catalina.valves.RemoteAddrValve.invoke(RemoteAddrValve.java:81)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)\n\tat org.apache.catalina.ha.session.JvmRouteBinderValve.invoke(JvmRouteBinderValve.java:227)\n\tat org.apache.catalina.ha.tcp.ReplicationValve.invoke(ReplicationValve.java:347)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:298)\n\tat org.apache.coyote.http11.Http11AprProcessor.process(Http11AprProcessor.java:861)\n\tat org.apache.coyote.http11.Http11AprProtocol$Http11ConnectionHandler.process(Http11AprProtocol.java:579)\n\tat org.apache.tomcat.util.net.AprEndpoint$Worker.run(AprEndpoint.java:1584)\n\tat java.lang.Thread.run(Thread.java:662)"}, {"count": 1, "attachment_id": null, "bug_id": 50775, "text": "It looks like the connection is timing out but the attempt to reconnect is failing. The NotContextException is really odd. That it works on Windows and AIX but not Linux points to a JVM bug, rather than a Tomcat issue.\n\nIt might be possible to figure out a work around with more information although the Tomcat developers generally don't like putting workarounds for JVM bugs, OS bugs etc into the Tomcat codebase.\n\nIdeally, a reproducible test case is required. In these circumstances that looks unlikely.\n\nThe best way forward would be to use the users list to help you debug. Personally, I'd run a Tomcat instance configured to allow remote debugging (suitably secured) and when the error starts happening debug my way through the Tomcat and JVM code to see if I could figure out what the problem was. I'd also have a working instance to hand so I could compare the two.", "id": 144394, "time": "2011-02-17T18:57:30Z", "creator": "markt@apache.org", "creation_time": "2011-02-17T18:57:30Z", "tags": [], "is_private": false}]