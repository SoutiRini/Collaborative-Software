[{"count": 0, "tags": [], "text": "Created attachment 33647\nPowerpoint containing bar chart to update\n\nI have a powerpoint (.pptx) file containing a bar chart template that I want to update programatically. Apache POI throws run time exception while trying to get the outputStream object of the embedded excel sheet file in bar chart.\n\nException stacktrace:\nException in thread \"main\" org.apache.poi.openxml4j.exceptions.OpenXML4JRuntimeException: Rule M2.4 exception : this error should NEVER happen! Please raise a bug at https://bz.apache.org/bugzilla/enter_bug.cgi?product=POI and attach a file that triggers it, thanks!\n\tat org.apache.poi.openxml4j.opc.internal.ContentTypeManager.getContentType(ContentTypeManager.java:343)\n\tat org.apache.poi.openxml4j.opc.internal.ContentTypeManager.removeContentType(ContentTypeManager.java:256)\n\tat org.apache.poi.openxml4j.opc.OPCPackage.removePart(OPCPackage.java:943)\n\tat org.apache.poi.openxml4j.opc.PackagePart.getOutputStream(PackagePart.java:522)\n\tat com.company.Main.updateBarChartTemplate(Main.java:114)\n\tat com.company.Main.main(Main.java:37)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:483)\n\tat com.intellij.rt.execution.application.AppMain.main(AppMain.java:140)\n\n\n\n\n\nCouldn't attach the .java file as there is only one file attachment option, hence pasting the code below just in case you need it.\n\n\n\n\n\npackage com.company;\n\nimport org.apache.poi.POIXMLDocumentPart;\nimport org.apache.poi.ss.util.CellRangeAddress;\nimport org.apache.poi.ss.util.CellReference;\nimport org.apache.poi.xslf.usermodel.XMLSlideShow;\nimport org.apache.poi.xslf.usermodel.XSLFChart;\nimport org.apache.poi.xslf.usermodel.XSLFSlide;\nimport org.apache.poi.xssf.usermodel.XSSFRow;\nimport org.apache.poi.xssf.usermodel.XSSFSheet;\nimport org.apache.poi.xssf.usermodel.XSSFWorkbook;\nimport org.openxmlformats.schemas.drawingml.x2006.chart.*;\nimport org.openxmlformats.schemas.drawingml.x2006.main.CTTextBody;\nimport org.openxmlformats.schemas.drawingml.x2006.main.CTTextParagraph;\n\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.IOException;\nimport java.io.OutputStream;\nimport java.util.HashMap;\nimport java.util.Map;\n\npublic class Main {\n\n    public static void main(String[] args) {\n\t    String inputPath = \"excel_writing_bug.pptx\";\n\t    String outputPath = \"excel_writing_bug_output.pptx\";\n\t    int slideNumber = 1;\n\t    String templateChartTitle = \"Title\";\n\t    String newChartTitle = \"Title updated\";\n\t    Map<String, Double> chartValues = new HashMap<>();\n\t    chartValues.put(\"Windows\", 5d);\n\t    chartValues.put(\"Solaris\", 2d);\n\t    chartValues.put(\"Unix\", 8d);\n\t    chartValues.put(\"Linux\", 5d);\n\t    try {\n\t\t    updateBarChartTemplate(inputPath, outputPath, slideNumber, templateChartTitle, newChartTitle, chartValues);\n\t    } catch (IOException e) {\n\t\t    e.printStackTrace();\n\t    }\n    }\n\n\tpublic static void updateBarChartTemplate(String inputPath, String outputPath, int slideNumber, String templateChartTitle, String newChartTitle, Map<String, Double> chartValues)\n\t\tthrows IllegalStateException, IOException{\n\n\t\tXMLSlideShow pptx = null;\n\t\ttry {\n\t\t\tpptx = new XMLSlideShow(new FileInputStream(inputPath));\n\t\t\tXSLFChart chart = getChartFromTitle(inputPath, slideNumber, templateChartTitle);\n\t\t\tif (chart == null) throw new IllegalStateException(\"chart not found in the template\");\n\t\t\t// embedded Excel workbook that holds the chart data\n\t\t\tPOIXMLDocumentPart xlsPart = chart.getRelations().get(0);\n\t\t\tXSSFWorkbook wb = new XSSFWorkbook();\n\t\t\tOutputStream xlsOut = null;\n\t\t\ttry {\n\t\t\t\tXSSFSheet sheet = wb.createSheet();\n\n\t\t\t\tCTChart ctChart = chart.getCTChart();\n\n\n\t\t\t\tCTPlotArea plotArea = ctChart.getPlotArea();\n\n\t\t\t\tCTBarChart barChart = plotArea.getBarChartArray(0);\n\t\t\t\t//Bar Chart Series\n\t\t\t\tCTBarSer ser = barChart.getSerArray(0);\n\n\t\t\t\t// Series Text\n\t\t\t\tCTSerTx tx = ser.getTx();\n\t\t\t\ttx.getStrRef().getStrCache().getPtArray(0).setV(newChartTitle);\n\t\t\t\tsheet.createRow(0).createCell(1).setCellValue(newChartTitle);\n\t\t\t\tString titleRef = new CellReference(sheet.getSheetName(), 0, 1, true, true).formatAsString();\n\t\t\t\ttx.getStrRef().setF(titleRef);\n\n\t\t\t\t// Category Axis Data\n\t\t\t\tCTAxDataSource cat = ser.getCat();\n\t\t\t\tCTStrData strData = cat.getStrRef().getStrCache();\n\n\t\t\t\t// Values\n\t\t\t\tCTNumDataSource val = ser.getVal();\n\t\t\t\tCTNumData numData = val.getNumRef().getNumCache();\n\n\t\t\t\tstrData.setPtArray(null);  // unset old axis text\n\t\t\t\tnumData.setPtArray(null);  // unset old values\n\n\t\t\t\t// set model\n\t\t\t\tint idx = 0;\n\t\t\t\tint rownum = 1;\n\n\t\t\t\tfor (Map.Entry<String, Double> entry : chartValues.entrySet()) {\n\t\t\t\t\tString key = entry.getKey();\n\t\t\t\t\tString value = String.valueOf(entry.getValue());\n\t\t\t\t\tCTNumVal numVal = numData.addNewPt();\n\t\t\t\t\tnumVal.setIdx(idx);\n\t\t\t\t\tnumVal.setV(value);\n\n\t\t\t\t\tCTStrVal sVal = strData.addNewPt();\n\t\t\t\t\tsVal.setIdx(idx);\n\t\t\t\t\tsVal.setV(key);\n\n\t\t\t\t\tidx++;\n\t\t\t\t\tXSSFRow row = sheet.createRow(rownum++);\n\t\t\t\t\trow.createCell(0).setCellValue(key);\n\t\t\t\t\trow.createCell(1).setCellValue(Double.valueOf(value));\n\t\t\t\t}\n\t\t\t\tnumData.getPtCount().setVal(idx);\n\t\t\t\tstrData.getPtCount().setVal(idx);\n\n\t\t\t\tString numDataRange = new CellRangeAddress(1, rownum - 1, 1, 1).formatAsString(sheet.getSheetName(), true);\n\t\t\t\tval.getNumRef().setF(numDataRange);\n\t\t\t\tString axisDataRange = new CellRangeAddress(1, rownum - 1, 0, 0).formatAsString(sheet.getSheetName(), true);\n\t\t\t\tcat.getStrRef().setF(axisDataRange);\n\n\t\t\t\t// updated the embedded workbook with the data\n\t\t\t\txlsOut = xlsPart.getPackagePart().getOutputStream();\n\t\t\t\ttry {\n\t\t\t\t\twb.write(xlsOut);\n\t\t\t\t} finally {\n\t\t\t\t\txlsOut.close();\n\t\t\t\t}\n\t\t\t\tFileOutputStream fos = new FileOutputStream(outputPath);\n\t\t\t\ttry {\n\t\t\t\t\tpptx.write(fos);\n\t\t\t\t} finally {\n\t\t\t\t\tfos.close();\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\twb.close();\n\t\t\t}\n\t\t} finally {\n\t\t\tif (pptx != null) pptx.close();\n\t\t}\n\t}\n\n\tpublic static XSLFChart getChartFromTitle(String inputPath, int slideNumber, String templateChartTitle) throws IOException {\n\t\tXMLSlideShow pptx = null;\n\t\ttry {\n\t\t\tpptx = new XMLSlideShow(new FileInputStream(inputPath));\n\n\t\t\tXSLFSlide slide = pptx.getSlides().get(slideNumber - 1);\n\t\t\t// find chart in the slide\n\t\t\tXSLFChart chart = null;\n\t\t\tfor (POIXMLDocumentPart part : slide.getRelations()) {\n\t\t\t\tif (part instanceof XSLFChart) {\n\t\t\t\t\tchart = (XSLFChart) part;\n\t\t\t\t\tCTChart ctChart = chart.getCTChart();\n\n\t\t\t\t\tCTTitle ctTitle = ctChart.getTitle();\n\t\t\t\t\tCTTx titleTx = ctTitle.getTx();\n\t\t\t\t\tCTTextBody body = titleTx.getRich();\n\t\t\t\t\tCTTextParagraph paragraph = body.getPArray(0);\n\t\t\t\t\tString chartTitle = paragraph.getRArray(0).getT();\n\n\t\t\t\t\tif (chartTitle.equalsIgnoreCase(templateChartTitle)) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tchart = null;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn chart;\n\t\t} finally {\n\t\t\tif (pptx != null) pptx.close();\n\t\t}\n\t}\n}", "is_private": false, "bug_id": 59141, "id": 189249, "time": "2016-03-08T07:16:58Z", "creator": "arif.shaikh786@gmail.com", "creation_time": "2016-03-08T07:16:58Z", "attachment_id": 33647}, {"count": 1, "attachment_id": 33648, "bug_id": 59141, "text": "Created attachment 33648\nTestcase for bug\n\nTest case for the bug", "id": 189251, "time": "2016-03-08T09:05:54Z", "creator": "arif.shaikh786@gmail.com", "creation_time": "2016-03-08T09:05:54Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 59141, "attachment_id": null, "text": "In your code, you open twice the same file but you try to change the chart after its slideshow has been closed.  This is the cause of the Rule M2.4 exception.\n\n\nWould you mind trying to adapt your code in order to avoid this?\n\nYou might also be interested in trying the code available in the pull request #68 which could make it easier to define new values for your chart.\n\nhttps://github.com/apache/poi/pull/68\n\nIn that branch you would find a BarChartDemo under the examples, which shows how to access the charts without closing the presentation.", "id": 200850, "time": "2017-09-13T17:43:56Z", "creator": "Alain.Bearez@cua.li", "creation_time": "2017-09-13T17:43:56Z", "is_private": false}]