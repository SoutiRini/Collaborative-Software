[{"count": 0, "tags": [], "creator": "contact@ruslan.org", "attachment_id": 26008, "id": 139784, "time": "2010-09-09T07:22:00Z", "bug_id": 49905, "creation_time": "2010-09-09T07:22:00Z", "is_private": false, "text": "Created attachment 26008\nPatch to remove context classloader from threads in ThreadPoolExecutor in tribes\n\nTested on apache-tomcat-6.0.29 running under jdk 1.6.0_18.\n\nWhen DeltaManager is instantiated and assigned in StandardContext.start(),\nis it done AFTER StandardContext.bindThreads().\n\nDeltaManager, in turn, during initalization, asks for sessions in other nodes,\nand this may result in creating threads in ThreadPoolExecutor in tribes.\n\nThese threads created with contextClassLoader set to current\nwebapplication WebAppClassLoader.\n\nThis results in memory leak and error message during redeployment in tomcat log:\n\n09/09/2010 14:46:19 S - - WebappClassLoader.clearReferencesThreads:\nThe web application [/creditdev] appears to have started a thread\nnamed [pool-1-thread-1] but has failed to stop it. This is very likely\nto create a memory leak.\n\nStacktrace:\n       at java.util.concurrent.ThreadPoolExecutor.addThread(Unknown Source)\n       at java.util.concurrent.ThreadPoolExecutor.addIfUnderCorePoolSize(Unknown\nSource)\n       at java.util.concurrent.ThreadPoolExecutor.execute(Unknown Source)\n       at org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor.addToQueue(MessageDispatch15Interceptor.java:67)\n       at org.apache.catalina.tribes.group.interceptors.MessageDispatchInterceptor.sendMessage(MessageDispatchInterceptor.java:68)\n       at org.apache.catalina.tribes.group.ChannelInterceptorBase.sendMessage(ChannelInterceptorBase.java:75)\n       at org.apache.catalina.tribes.group.interceptors.TcpFailureDetector.sendMessage(TcpFailureDetector.java:87)\n       at org.apache.catalina.tribes.group.ChannelInterceptorBase.sendMessage(ChannelInterceptorBase.java:75)\n       at org.apache.catalina.tribes.group.GroupChannel.send(GroupChannel.java:216)\n       at org.apache.catalina.tribes.group.GroupChannel.send(GroupChannel.java:175)\n       at org.apache.catalina.ha.tcp.SimpleTcpCluster.send(SimpleTcpCluster.java:813)\n       at org.apache.catalina.ha.session.DeltaManager.getAllClusterSessions(DeltaManager.java:959)\n       at org.apache.catalina.ha.session.DeltaManager.start(DeltaManager.java:930)\n       at org.apache.catalina.core.ContainerBase.setManager(ContainerBase.java:438)\n       at org.apache.catalina.core.StandardContext.start(StandardContext.java:4559)\n       at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:791)\n       at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:771)\n       at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:546)\n       at org.apache.catalina.startup.HostConfig.deployDescriptor(HostConfig.java:637)\n       at org.apache.catalina.startup.HostConfig.deployDescriptors(HostConfig.java:563)\n       at org.apache.catalina.startup.HostConfig.deployApps(HostConfig.java:498)\n       at org.apache.catalina.startup.HostConfig.start(HostConfig.java:1277)\n       at org.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java:321)\n       at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:119)\n       at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1053)\n       at org.apache.catalina.core.StandardHost.start(StandardHost.java:785)\n       at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1045)\n       at org.apache.catalina.core.StandardEngine.start(StandardEngine.java:445)\n       at org.apache.catalina.core.StandardService.start(StandardService.java:519)\n       at org.apache.catalina.core.StandardServer.start(StandardServer.java:710)\n       at org.apache.catalina.startup.Catalina.start(Catalina.java:581)\n       at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n       at sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)\n       at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)\n       at java.lang.reflect.Method.invoke(Unknown Source)\n       at org.apache.catalina.startup.Bootstrap.start(Bootstrap.java:289)\n       at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:414)\n       at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n       at sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)\n       at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)\n       at java.lang.reflect.Method.invoke(Unknown Source)\n       at org.tanukisoftware.wrapper.WrapperStartStopApp.run(WrapperStartStopApp.java:243)\n       at java.lang.Thread.run(Unknown Source)\n\nProposed solution - implement java.util.concurrent.ThreadFactory in\nMessageDispatch15Interceptor\nand pass instance on ThreadPoolExecutor executor creation.\nThis instance must call setContextClassLoader(null) in newThread()\noverriden method."}, {"count": 1, "tags": [], "bug_id": 49905, "attachment_id": null, "text": "This has been fixed in trunk and will be included 7.0.3 onwards.\n\nI have proposed the same fix for 6.0.x.", "id": 140376, "time": "2010-10-01T12:35:02Z", "creator": "markt@apache.org", "creation_time": "2010-10-01T12:35:02Z", "is_private": false}, {"count": 2, "attachment_id": null, "bug_id": 49905, "text": "This has been fixed in 6.0.x and will be included in 6.0.30 onwards.", "id": 140549, "time": "2010-10-07T07:06:56Z", "creator": "markt@apache.org", "creation_time": "2010-10-07T07:06:56Z", "tags": [], "is_private": false}]