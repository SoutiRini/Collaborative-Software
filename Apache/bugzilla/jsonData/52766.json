[{"count": 0, "tags": [], "creator": "mstreeter1@gmail.com", "attachment_id": null, "id": 154133, "time": "2012-02-25T04:08:28Z", "bug_id": 52766, "creation_time": "2012-02-25T04:08:28Z", "is_private": false, "text": "Hello,\n\nWhen a target web site being connected to through a proxy server has a rewrite with no content in the body, the proxy server closes the connection before sending any headers.  In my case, I can't control the target site and have to rely on the proxy server to gracefully handle a redirect like this.\n\nAn example can be seen with this bit of php code on the target site that the proxy server proxies to.  Put this into the document root as index.php so that a GET request for / will execute it:\n\n<?php\nheader ('Location: http://mytargethost.com/test.html');\n?>\n\nConnecting directly to mytargethost.com will return headers with no body content, which is the expected behavior when connecting through the proxy server:\n\ntelnet mytargethost.com 80\nTrying 192.168.1.2...\nConnected to mytargethost.com (192.168.1.2).\nEscape character is '^]'.\nGET / HTTP/1.0\nUser-Agent: Wget/1.11.4 Red Hat modified\nAccept: */*\nHost: mytargethost.com\n\nHTTP/1.1 302 Moved Temporarily\nDate: Sat, 25 Feb 2012 03:47:08 GMT\nServer: Apache/2.2.21 (Unix) mod_ssl/2.2.21 OpenSSL/0.9.8q DAV/2 mod_auth_passthrough/2.1 mod_bwlimited/1.4 FrontPage/5.0.2.2635\nLocation: http://mytargethost.com/test.html\nContent-Length: 0\nConnection: close\nContent-Type: text/html\n\n\nBut the proxy server drops the connection before sending any headers:\n\n$ telnet myproxyhost.com 80\nTrying 192.168.1.1...\nConnected to myproxyhost.com (192.168.1.1).\nEscape character is '^]'.\nGET /mytargethost.com/ HTTP/1.0\nUser-Agent: Wget/1.11.4 Red Hat modified\nAccept: */*\nHost: myproxyhost.com\n\nConnection closed by foreign host.\n\n\n\nHere is the relevant Apache configuration on the proxy server:\n\nProxyHTMLEnable On\nProxyHTMLLinks  a               href\nProxyPass /mytargethost.com http://mytargethost.com\n<Location /mytargethost.com/>\n     ProxyHTMLURLMap / /mytargethost.com/\n</Location>\n\n\nThis patch fixed the problem for me on httpd 2.4.1:\n\n--- mod_proxy_html.c    2012-02-24 17:45:53.000000000 -0600\n+++ mod_proxy_html-patched.c    2012-02-24 17:51:53.000000000 -0600\n@@ -947,6 +947,10 @@\n         }\n     }\n     /*ap_fflush(ctxt->f->next, ctxt->bb);        // uncomment for debug */\n+\n+    if ( ctxt->parser == NULL )             /*If no processing was done, simply pass the brigade.*/\n+      return ap_pass_brigade(f->next, bb) ;\n+\n     apr_brigade_cleanup(bb);\n     return APR_SUCCESS;\n }\n\nBest regards,\nMike Streeter"}, {"count": 1, "text": "Thanks for the detailed bug report. But actually, I think this is a bug in mod_xml2enc. Can you verify that this patch fixes the problem for you?\n\nhttp://svn.apache.org/viewvc/httpd/httpd/trunk/modules/filters/mod_xml2enc.c?r1=1293717&r2=1293716&pathrev=1293717", "bug_id": 52766, "attachment_id": null, "id": 154154, "time": "2012-02-25T22:55:09Z", "creator": "sf@sfritsch.de", "creation_time": "2012-02-25T22:55:09Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 52766, "attachment_id": null, "text": "I tested your patch, and it fixes the problem for me.  Thanks!", "id": 154302, "time": "2012-02-28T01:18:13Z", "creator": "mstreeter1@gmail.com", "creation_time": "2012-02-28T01:18:13Z", "is_private": false}]