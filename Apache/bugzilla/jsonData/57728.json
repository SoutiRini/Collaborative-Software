[{"count": 0, "tags": [], "text": "We are experiencing issues with Tomcat 6.0.43 that do not occur on Tomcat 7.0.59 with the exact same versions of tomcat-native (1.1.32) and apr (1.5.1) and same Tomcat configuration.\n\nWhen starting Tomcat, it throws the following exception (more complete logs, stacktrace, and configuration below):\n\njava.lang.Exception: Invalid Server SSL Protocol (error:140A90A1:lib(20):func(169):reason(161))\n\nThis error means:\n$ openssl errstr 140A90A1\nerror:140A90A1:SSL routines:SSL_CTX_new:library has no ciphers\n\nI tried specifying explicit SSLProtocol and SSLCipherSuite to no avail. To be sure that this was not caused by bugs in distribution patches (such as https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=780447 which bit us on Tomcat 7.0.59), I compiled tomcat-native and libapr from latest Apache sources, obtained directly from Apache mirrors.\n\nMore complete log and stacktrace:\n\nMar 19, 2015 6:56:12 PM org.apache.catalina.core.AprLifecycleListener init\nINFO: Loaded APR based Apache Tomcat Native library 1.1.32 using APR version 1.5.1.\nMar 19, 2015 6:56:12 PM org.apache.catalina.core.AprLifecycleListener init\nINFO: APR capabilities: IPv6 [true], sendfile [true], accept filters [false], random [true].\nMar 19, 2015 6:56:13 PM org.apache.coyote.http11.Http11AprProtocol init\nSEVERE: Error initializing endpoint\njava.lang.Exception: Invalid Server SSL Protocol (error:140A90A1:lib(20):func(169):reason(161))\n        at org.apache.tomcat.jni.SSLContext.make(Native Method)\n        at org.apache.tomcat.util.net.AprEndpoint.init(AprEndpoint.java:779)\n        at org.apache.coyote.http11.Http11AprProtocol.init(Http11AprProtocol.java:109)\n        at org.apache.catalina.connector.Connector.initialize(Connector.java:1123)\n        at org.apache.catalina.core.StandardService.initialize(StandardService.java:703)\n        at org.apache.catalina.core.StandardServer.initialize(StandardServer.java:838)\n        at org.apache.catalina.startup.Catalina.load(Catalina.java:538)\n        at org.apache.catalina.startup.Catalina.load(Catalina.java:562)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:606)\n        at org.apache.catalina.startup.Bootstrap.load(Bootstrap.java:261)\n        at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:413)\n\nMar 19, 2015 6:56:13 PM org.apache.catalina.core.StandardService initialize\nSEVERE: Failed to initialize connector [Connector[HTTP/1.1-7102]]\nLifecycleException:  Protocol handler initialization failed: java.lang.Exception: Invalid Server SSL Protocol (error:140A90A1:lib(20):func(169):reason(161))\n        at org.apache.catalina.connector.Connector.initialize(Connector.java:1125)\n        at org.apache.catalina.core.StandardService.initialize(StandardService.java:703)\n        at org.apache.catalina.core.StandardServer.initialize(StandardServer.java:838)\n        at org.apache.catalina.startup.Catalina.load(Catalina.java:538)\n        at org.apache.catalina.startup.Catalina.load(Catalina.java:562)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:606)\n        at org.apache.catalina.startup.Bootstrap.load(Bootstrap.java:261)\n        at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:413)\n\nRelevant Tomcat configuration:\n\n      <Listener className=\"org.apache.catalina.core.AprLifecycleListener\" SSLEngine=\"on\" />\n\n      <Connector port=\"7102\"\n                 maxThreads=\"200\"\n                 protocol=\"org.apache.coyote.http11.Http11AprProtocol\"\n                 scheme=\"https\"\n                 secure=\"true\"\n                 SSLEnabled=\"true\"\n                 SSLCertificateFile=\"${catalina.base}/sslcerts/test-cert.pem\"\n                 SSLCertificateKeyFile=\"${catalina.base}/sslcerts/test-key.pem\"\n                 SSLVerifyClient=\"optional\"/>\n\nHost is Ubuntu Trusty 14.04 with libssl 1.0.1f-1ubuntu2.8, Java is build 1.7.0_55-b13.\n\nAgain, this same exact configuration, on the same system, with the same libraries, starts just fine with Tomcat 7.0.59, and worked fine on Tomcat 6.0.37 with tomcat-native 1.1.29 and libapr 1.5.0. Note we have some applications which still require Tomcat 6 or we would simply do the obvious and migrate to Tomcat 7 or 8.\n\nLet me know if there's any additional information I can provide.", "is_private": false, "bug_id": 57728, "id": 181912, "time": "2015-03-19T19:23:37Z", "creator": "lscotte@gmail.com", "creation_time": "2015-03-19T19:23:37Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "markt@apache.org", "text": "This works for me on mutliple platforms. The users list is the place to figure out what is going on here.\n\nLine 779 of AprEndpoint is a comment so whatever it is you are using, it isn't an official Tomcat distribution. My first suggestion would be to start again with Tomcat 6.0.43, tomcat-native 1.1.32 and APR 1.5.1 downloaded from the ASF. I might even go as far as building OpenSSL from source too.", "id": 181913, "time": "2015-03-19T20:01:05Z", "bug_id": 57728, "creation_time": "2015-03-19T20:01:05Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "lscotte@gmail.com", "attachment_id": null, "id": 181914, "time": "2015-03-19T20:22:24Z", "bug_id": 57728, "creation_time": "2015-03-19T20:22:24Z", "is_private": false, "text": "Thanks for the reply, the reason for the line mismatch is that I pasted in the wrong stacktrace, from another test. Aside from that, exception is otherwise the same.\n\nMy apologies, here's the correct stack:\n\nINFO: Loaded APR based Apache Tomcat Native library 1.1.32 using APR version 1.5.1.\nMar 19, 2015 8:16:43 PM org.apache.catalina.core.AprLifecycleListener init\nINFO: APR capabilities: IPv6 [true], sendfile [true], accept filters [false], random [true].\nMar 19, 2015 8:16:43 PM org.apache.coyote.http11.Http11AprProtocol init\nSEVERE: Error initializing endpoint\njava.lang.Exception: Unable to create SSLContext. Check that SSLEngine is enabled in the AprLifecycleListener, the AprLifecycleListener has initialised correctly and that a valid SSLProtocol has been specified\njava.lang.Exception: Unable to create SSLContext. Check that SSLEngine is enabled in the AprLifecycleListener, the AprLifecycleListener\n has initialised correctly and that a valid SSLProtocol has been specified\n        at org.apache.tomcat.util.net.AprEndpoint.init(AprEndpoint.java:795)\n        at org.apache.coyote.http11.Http11AprProtocol.init(Http11AprProtocol.java:109)\n        at org.apache.catalina.connector.Connector.initialize(Connector.java:1123)\n        at org.apache.catalina.core.StandardService.initialize(StandardService.java:703)\n        at org.apache.catalina.core.StandardServer.initialize(StandardServer.java:843)\n        at org.apache.catalina.startup.Catalina.load(Catalina.java:538)\n        at org.apache.catalina.startup.Catalina.load(Catalina.java:562)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:606)\n        at org.apache.catalina.startup.Bootstrap.load(Bootstrap.java:261)\n        at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:413)\nCaused by: java.lang.Exception: Invalid Server SSL Protocol (error:140A90A1:lib(20):func(169):reason(161))\n        at org.apache.tomcat.jni.SSLContext.make(Native Method)\n        at org.apache.tomcat.util.net.AprEndpoint.init(AprEndpoint.java:790)\n        ... 12 more\n\nMar 19, 2015 8:16:44 PM org.apache.catalina.core.StandardService initialize\nSEVERE: Failed to initialize connector [Connector[HTTP/1.1-7102]]\nLifecycleException:  Protocol handler initialization failed: java.lang.Exception: Unable to create SSLContext. Check that SSLEngine is enabled in the AprLifecycleListener, the AprLifecycleListener has initialised correctly and that a valid SSLProtocol has been specified\n        at org.apache.catalina.connector.Connector.initialize(Connector.java:1125)\n        at org.apache.catalina.core.StandardService.initialize(StandardService.java:703)\n        at org.apache.catalina.core.StandardServer.initialize(StandardServer.java:843)\n        at org.apache.catalina.startup.Catalina.load(Catalina.java:538)\n        at org.apache.catalina.startup.Catalina.load(Catalina.java:562)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:606)\n        at org.apache.catalina.startup.Bootstrap.load(Bootstrap.java:261)\n        at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:413)"}, {"count": 3, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 181915, "time": "2015-03-19T20:41:27Z", "bug_id": 57728, "creation_time": "2015-03-19T20:41:27Z", "is_private": false, "text": "This still works for me and my comment regarding the users list still stands."}]