[{"count": 0, "tags": [], "text": "System\n  two Tomcat Server(AP1,AP2)\n  Tomcat's version is 6.0.18.\n  Replication method is Delta Manager\n \n I stopped Tomcat of AP1.\n Then, I restarted Tomcat of AP1.\n Then, for AP1, Tomcat's log is as follows.\n \n  Jul 2, 2009 4:51:04 PM\n  org.apache.catalina.ha.session.DeltaManager getAllClusterSessions\n  WARNING: Manager [/tpcw]: Drop message SESSION-DELTA\n  inside GET_ALL_SESSIONS sync phase start date 7/2/09 4:51 PM message date 1/1/70 9:00 AM\n  \n  Jul 2, 2009 4:51:04 PM\n  org.apache.catalina.ha.session.DeltaManager getAllClusterSessions\n  WARNING: Manager [/tpcw]: Drop message SESSION-ACCESSED\n  inside GET_ALL_SESSIONS sync phase start date 7/2/09 4:51 PM message date 1/1/70 9:00 AM\n  \n TimeStamp is incorrect when SESSION-DELTA or SESSION-ACCESSED because \"1/1/70 9:00 AM\" isn't created time of session.\n In this case, AP1's Tomcat may drop all session data.\n As a result, AP1's Tomcat can't replicate session.\n If TimeStamp is updated when update last replicated time, it goes well.\n \n I made patch.\n \n DeltaManager's patch.\n \nIndex: java/org/apache/catalina/ha/session/DeltaManager.java\n===================================================================\n--- java/org/apache/catalina/ha/session/DeltaManager.java\t(revision 792004)\n+++ java/org/apache/catalina/ha/session/DeltaManager.java\t(working copy)\n@@ -1162,7 +1162,10 @@\n             }\n \n             //update last replicated time\n-            if (msg != null) session.setLastTimeReplicated(System.currentTimeMillis());\n+            if (msg != null){\n+            \tsession.setLastTimeReplicated(System.currentTimeMillis());\n+            \tmsg.setTimestamp(session.getLastTimeReplicated());\n+            }\n             return msg;\n         } catch (IOException x) {\n             log.error(sm.getString(\"deltaManager.createMessage.unableCreateDeltaRequest\",sessionId), x);", "is_private": false, "id": 128775, "creator": "yoshihara.ryuiti@oss.ntt.co.jp", "time": "2009-07-12T23:08:36Z", "bug_id": 47515, "creation_time": "2009-07-12T23:08:36Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 47515, "attachment_id": null, "is_private": false, "id": 128806, "time": "2009-07-13T12:41:22Z", "creator": "fhanik@apache.org", "creation_time": "2009-07-13T12:41:22Z", "text": "Many thanks, can you please attach the patch as an attachment as line breaks get inserted into your copy paste"}, {"count": 2, "tags": [], "text": "Created attachment 23972\nDeltaManager's patch\n\n Sorry.\n\n This is the patch for DeltaManager.\n\n Best regards.", "is_private": false, "id": 128814, "creator": "yoshihara.ryuiti@oss.ntt.co.jp", "time": "2009-07-13T17:23:30Z", "bug_id": 47515, "creation_time": "2009-07-13T17:23:30Z", "attachment_id": 23972}, {"count": 3, "tags": [], "creator": "yoshihara.ryuiti@oss.ntt.co.jp", "is_private": false, "text": "Created attachment 23973\nDeltaManager's patch\n\nSorry, I miss the patch.\n\nThis is the patch for DeltaManager.\n\nBest regards.", "id": 128815, "time": "2009-07-13T18:02:10Z", "bug_id": 47515, "creation_time": "2009-07-13T18:02:10Z", "attachment_id": 23973}, {"count": 4, "tags": [], "creator": "fhanik@apache.org", "attachment_id": null, "id": 128911, "creation_time": "2009-07-16T07:12:50Z", "time": "2009-07-16T07:12:50Z", "bug_id": 47515, "text": "Fixed in trunk\nRevision 794684\nProposed for backport to 6.0", "is_private": false}]