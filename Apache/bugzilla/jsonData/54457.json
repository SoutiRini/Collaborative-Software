[{"count": 0, "tags": [], "creator": "jschutt@amazon.com", "text": "In the AbstractHttp11Processor class, errors that occur during the parsing of headers don't result in the correct HTTP status code. The status codes are always being overwritten with a status of 500.  \n\nFor example when errors occurs during the processing of HTTP headers, it is caught in the following block of code.  This code sets the HTTP status to 400 and sets the 'error' boolean to true.\n\n963 \t} catch (Throwable t) {\n964 \tExceptionUtils.handleThrowable(t);\n965 \tif (getLog().isDebugEnabled()) {\n966 \tgetLog().debug(\n967 \tsm.getString(\"http11processor.header.parse\"), t);\n968 \t}\n969 \t// 400 - Bad Request\n970 \tresponse.setStatus(400);\n971 \tadapter.log(request, response, 0);\n972 \terror = true;\n973 \t}\n\nLater on in the same method, if error is true it sets the HTTP status to 500 which clobbers the HTTP status of 400 from above. \n\n1053 \t// If there was an error, make sure the request is counted as\n1054 \t// and error, and update the statistics counter\n1055 \tif (error) {\n1056 \tresponse.setStatus(500);\n1057 \t}\n\nThe same problem occurs for HTTP status codes set on the following lines:\n937 \tresponse.setStatus(503);\n970 \tresponse.setStatus(400);\n987 \tresponse.setStatus(400);\n\nThe following patch seems to fix the problem.  Basically if an error has occurred but the HTTP status code is still 'OK', then set the status to 500.\n\n--- java/org/apache/coyote/http11/AbstractHttp11Processor.java      2012-07-30 00:00:00.000000000 0000\n+++ java/org/apache/coyote/http11/AbstractHttp11Processor.java      2012-07-30 00:00:00.000000000 0000\n@@ -1050,7 +1058,9 @@\n \n             // If there was an error, make sure the request is counted as\n             // and error, and update the statistics counter\n-            if (error) {\n+            // Don't update change the response status for an error \n+            // if one has already been set \n+            if (error && response.getStatus() == 200) {\n                 response.setStatus(500);\n             }\n             request.updateCounters();", "id": 164769, "time": "2013-01-21T19:31:38Z", "bug_id": 54457, "creation_time": "2013-01-21T19:31:38Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 54457, "attachment_id": null, "text": "The response is committed before the line of code claimed to be problematic.", "id": 164831, "time": "2013-01-23T15:51:08Z", "creator": "markt@apache.org", "creation_time": "2013-01-23T15:51:08Z", "is_private": false}]