[{"count": 0, "tags": [], "bug_id": 51783, "is_private": false, "id": 149093, "creation_time": "2011-09-07T23:49:30Z", "time": "2011-09-07T23:49:30Z", "creator": "nistor1@illinois.edu", "text": "Created attachment 27471\ntest\n\nHi,\n\nI am encountering a NullPointerException in WriterAppender. I am using\nLog4j version 1.2.16. \n\nThe NullPointerException manifests when calling close() and append()\nconcurrently. I have attached a test that exposes this problem. For \nthis test, the expected output is:\n\nExpected output:\n0\n1\n2\n3\n4\n.....\n499998\n499999\nDONE\n\nBut when the bug manifests (almost always for this test), the output \nis:\n\nBug output:\n0\n1\n2\n3\n4\n...\n16\nException in thread \"main\" java.lang.NullPointerException\n    at org.apache.log4j.WriterAppender.subAppend(WriterAppender.java:317)\n    at org.apache.log4j.WriterAppender.append(WriterAppender.java:162)\n    at org.apache.log4j.Test.test(Test.java:37)\n    at org.apache.log4j.Test.main(Test.java:16)\n\nor\n\n0\n1\n2\n3\n4\nException in thread \"main\" java.lang.NullPointerException\n    at org.apache.log4j.WriterAppender.subAppend(WriterAppender.java:318)\n    at org.apache.log4j.WriterAppender.append(WriterAppender.java:162)\n    at org.apache.log4j.Test.test(Test.java:37)\n    at org.apache.log4j.Test.main(Test.java:16)\n\nThe test iteration where the NullPointerException is thrown varies\nfrom run to run, depending on how the threads interleave.\n\nThe reason for NullPointerException is that append() is not \nsynchronized. \n\nHere is the thread scenario that triggers the bug:\n(1) append() starts to execute. It checks checkEntryConditions(). This\n    check succeeds because close was not yet executed(). append() \n    continue to subAppend(event); but does not yet enter subAppend()\n    (e.g., if there is a delay due to high load)\n(2) the other thread executes close(). close() calls reset() which\n    sets this.qw = null;\n(3) append() continue to execute subAppend(); subAppend() calls \n    several methods on this.qw, which by now is null. These methods\n    are:\n        this.qw.write(this.layout.format(event));\n        this.qw.write(s[i]);\n        this.qw.write(Layout.LINE_SEP);\n    Calling these methods throws NullPointerException.\n\nThe solution is to synchronize append(). close() is already \nsynchronized.\n\nIs this a bug? Does synchronizing append() fully solve the problem?\nAre there other scenarios that I am missing and are not solved by\nsynchronizing append()?\n\nThanks!\n\nAdrian", "attachment_id": 27471}]