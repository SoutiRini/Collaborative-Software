[{"count": 0, "tags": [], "bug_id": 23805, "attachment_id": null, "id": 45589, "time": "2003-10-14T11:19:23Z", "creator": "rjimenez@tissat.es", "creation_time": "2003-10-14T11:19:23Z", "is_private": false, "text": "Hi,\nI have implemented a servlet response wrapper that has its own \nServletOutputStream implementation. This ServletOutputStream implementation \nstores all data received by its methods (print(*),write(*),println()...) in a \nCharArrayWriter. When a JSP writes content over 8kb, the servlet implementation \ncalls the method write(byte[] b, int off, int len) in the ServletOutputStream \nwith off=8192 and b.length=8192, thus it fails.\nI have changed the JSP buffer size to 16kb and occurs the same error with the \nsame index (8192).\nI think that it is an error of the response wrapper implementation.\n\nThanks and regards."}, {"count": 1, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "id": 45686, "time": "2003-10-14T21:45:29Z", "bug_id": 23805, "creation_time": "2003-10-14T21:45:29Z", "is_private": false, "text": "So Jasper calls your output stream with bad parameters ? Can you give a\nstacktrace of the incoming call ? (this is confusing)"}, {"count": 2, "tags": [], "bug_id": 23805, "attachment_id": 8582, "id": 45717, "time": "2003-10-15T09:26:43Z", "creator": "rjimenez@tissat.es", "creation_time": "2003-10-15T09:26:43Z", "is_private": false, "text": "Created attachment 8582\nOutputStream of the ResponseWrapper"}, {"count": 3, "attachment_id": null, "bug_id": 23805, "is_private": false, "id": 45718, "time": "2003-10-15T09:27:05Z", "creator": "rjimenez@tissat.es", "creation_time": "2003-10-15T09:27:05Z", "tags": [], "text": "Yes, Jasper calls my output stream with bad parameters, it calls the\nwrite(byte[] b, int offset, int len) method with an array width 8192 bytes and\nan offset=8192.\n\nA stacktrace:\njava.lang.StringIndexOutOfBoundsException: String index out of range: 8192\n\tat java.lang.String.getChars(String.java:484)\n\tat java.io.CharArrayWriter.write(CharArrayWriter.java:107)\n\tat com.tissat.isum.presentation.ISUMServletOutputStream.write(Unknown Source)\n\tat sun.nio.cs.StreamEncoder$CharsetSE.writeBytes(StreamEncoder.java:336)\n\tat sun.nio.cs.StreamEncoder$CharsetSE.implWrite(StreamEncoder.java:395)\n\tat sun.nio.cs.StreamEncoder.write(StreamEncoder.java:136)\n\tat java.io.OutputStreamWriter.write(OutputStreamWriter.java:191)\n\tat java.io.BufferedWriter.write(BufferedWriter.java:170)\n\tat java.io.PrintWriter.write(PrintWriter.java:200)\n\tat org.apache.jasper.runtime.JspWriterImpl.write(JspWriterImpl.java:306)\n\tat java.io.PrintWriter.write(PrintWriter.java:200)\n\tat org.apache.jasper.runtime.JspWriterImpl.flushBuffer(JspWriterImpl.java:159)\n\tat org.apache.jasper.runtime.JspWriterImpl.write(JspWriterImpl.java:355)\n\tat org.apache.jasper.runtime.JspWriterImpl.write(JspWriterImpl.java:366)\n\tat org.apache.jasper.runtime.JspWriterImpl.print(JspWriterImpl.java:491)\n\tat com.tissat.isum.presentation.taglib.ChildrenServicesTag.m1(Unknown Source)\n\tat com.tissat.isum.presentation.taglib.ChildrenServicesTag.doAfterBody(Unknown\nSource)\n\tat org.apache.jsp.interfaces.inttissat.LeftG_jsp._jspService(LeftG_jsp.java:302)\n\tat org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:133)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:856)\n...\n...\n...\n"}, {"count": 4, "tags": [], "text": "Thanks. This is indeed the same issue that was reported a few days ago by Kin-Man.\nAbout the JSP which causes this: what does it look like ? Is it caused by a\nstatic content block > 8KB ? Can you submit a test JSP to reproduce the issue ?\nIf you can't, the stack trace should be enough by itself to fix it, though.", "is_private": false, "bug_id": 23805, "id": 45721, "time": "2003-10-15T09:40:23Z", "creator": "remm@apache.org", "creation_time": "2003-10-15T09:40:23Z", "attachment_id": null}, {"count": 5, "tags": [], "text": "Sorry, I can't send you the JSP, I haven't permission :(\nThe JSP that causes the problem generates its content dinamically and it fails\nwhen generates over 8kb.\nThanks a lot and sorry, my english is not good :)\n", "attachment_id": null, "id": 45722, "creator": "rjimenez@tissat.es", "time": "2003-10-15T09:55:23Z", "bug_id": 23805, "creation_time": "2003-10-15T09:55:23Z", "is_private": false}, {"count": 6, "tags": [], "creator": "ernst.matthias@gmail.com", "attachment_id": null, "id": 45723, "creation_time": "2003-10-15T10:11:25Z", "time": "2003-10-15T10:11:25Z", "bug_id": 23805, "text": "Well, judging from the stack trace, you\n(com.tissat.isum.presentation.ISUMServletOutputStream) are calling the\nCharArrayWriter with the wrong parameters. I suspect the bug is there, not in\nJasper.\n\nPlease submit both\n* what ISUMServletOutputStream gets called with (offset=8192 AND length)\n* what ISUMServletOutputStream passes to the CharArrayWriter (String, offset and\nlength)", "is_private": false}, {"count": 7, "tags": [], "text": "ISUMServletOutputStream is submited. Enter to bugzilla to access it.", "attachment_id": null, "bug_id": 23805, "id": 45735, "time": "2003-10-15T13:22:55Z", "creator": "rjimenez@tissat.es", "creation_time": "2003-10-15T13:22:55Z", "is_private": false}, {"count": 8, "tags": [], "creator": "ernst.matthias@gmail.com", "attachment_id": null, "id": 45736, "creation_time": "2003-10-15T13:56:24Z", "time": "2003-10-15T13:56:24Z", "bug_id": 23805, "text": "The exception says: \"String index out of range: 8192\"\nAccording to String.java, this is because the end index is larger than the\nstring length. So the String you make from the bytes is shorter than 8192 chars.\n\nYour messing up bytes and chars here. Your outputstream converts the bytes to\nchars (e.g. does new String(bytes)) and assumes that the indices are still correct.\n\nI suspect that you\n* use UTF-8 encoding, where you typically have more bytes than chars\n* new String(bytes).length < 8192\n* you call writer.write(string, 8192, 0) and bang.\n\nIn ISO-encoding, calling your stream with write(new byte[8192], 8192, 0) works\nperfectly fine.\n", "is_private": false}, {"count": 9, "tags": [], "text": "Wait a minute. I believe there's likely a real bug there. If the byte array is\n8K long, and the offset is 8K, then there's a problem. I agree that converting\nto a String like that is bad, but this doesn't change the fact that the args\nseem bogus. As I said, this also looks very similar to Kin-Man's problem, so I\nthink this bug should stay open a bit longer (I didn't really look into the\nissue yet).", "attachment_id": null, "bug_id": 23805, "id": 45738, "time": "2003-10-15T14:30:33Z", "creator": "remm@apache.org", "creation_time": "2003-10-15T14:30:33Z", "is_private": false}, {"count": 10, "tags": [], "creator": "ernst.matthias@gmail.com", "attachment_id": null, "is_private": false, "id": 45740, "time": "2003-10-15T14:48:06Z", "bug_id": 23805, "creation_time": "2003-10-15T14:48:06Z", "text": "As long as 'len==0' this would be ok. And the exception seems to indicate\nexactly that. String.java#getChars, line 484, barfs about the end index (8192)\nbeing larger than the string size.\n\nI would propose the following change to rijmenez's class:\n\nwrite(byte[] b, int off, int len) {\n- writer.write(new String(b), off, len);\n+ writer.write(new String(b, off, len));\n}\n\nIf that doesn't solve the issue, I'm wrong.\n"}, {"count": 11, "tags": [], "text": "Well. I believe that Matthias has reason, my code has this bug. The other\nproblem commented by Remy, I believe that this problem does not causes an\nexception, simply that we can not change the JSP buffer (by default 8kb).\nThanks for all", "is_private": false, "id": 45741, "creator": "rjimenez@tissat.es", "time": "2003-10-15T15:01:26Z", "bug_id": 23805, "creation_time": "2003-10-15T15:01:26Z", "attachment_id": null}, {"count": 12, "tags": [], "text": "I now agree with Kin-Man's evaluation. Weird Jasper behavior, though.", "is_private": false, "id": 45961, "creator": "remm@apache.org", "time": "2003-10-21T06:07:36Z", "bug_id": 23805, "creation_time": "2003-10-21T06:07:36Z", "attachment_id": null}]