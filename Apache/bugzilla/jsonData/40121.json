[{"count": 0, "tags": [], "creator": "sam@mitre.org", "is_private": false, "text": "I have a build of httpd 2.2.2 from source with mod_headers and mod_rewrite\nstatically included. Here's httpd -l:\n\n  core.c\n  mod_authn_file.c\n  mod_authn_dbd.c\n  mod_authn_default.c\n  mod_authz_host.c\n  mod_authz_groupfile.c\n  mod_authz_user.c\n  mod_authz_default.c\n  mod_auth_basic.c\n  mod_dbd.c\n  mod_include.c\n  mod_filter.c\n  mod_log_config.c\n  mod_log_forensic.c\n  mod_logio.c\n  mod_env.c\n  mod_mime_magic.c\n  mod_headers.c\n  mod_ident.c\n  mod_usertrack.c\n  mod_unique_id.c\n  mod_setenvif.c\n  mod_version.c\n  mod_proxy.c\n  mod_proxy_connect.c\n  mod_proxy_ftp.c\n  mod_proxy_http.c\n  mod_proxy_ajp.c\n  mod_proxy_balancer.c\n  mod_ssl.c\n  prefork.c\n  http_core.c\n  mod_mime.c\n  mod_status.c\n  mod_autoindex.c\n  mod_asis.c\n  mod_cgi.c\n  mod_cgid.c\n  mod_negotiation.c\n  mod_dir.c\n  mod_imagemap.c\n  mod_actions.c\n  mod_speling.c\n  mod_alias.c\n  mod_rewrite.c\n  mod_so.c\n\nI try to set up forwarding the REMOTE_USER to a reverse proxy as follows:\n\nRewriteEngine on\nRewriteRule .* - [E=RU:%{LA-U:REMOTE_USER}]\nRequestHeader add X-TMP \"%{RU}e\"\nRewriteRule .* - [E=TU:%{LA-U:REMOTE_USER}]\nRequestHeader set UserId \"%{TU}e\"\n\n<Location /newsstand>\n  AuthType Basic\n  AuthName \"MiTAP Newsstand Search\"\n  AuthUserFile /sys/newsstand/db/newsusers\n  Require valid-user\n  ProxyPass http://tapestry.mitre.org:8082/newsstand\n  ProxyPassReverse http://tapestry.mitre.org:8082/newsstand\n</Location>\n\nA CGI test script inserted into the proxied server shows that there's still no\nvalue for REMOTE_USER in this case, but there's a value for HTTP_X_TMP, and it's\nwrong; it's not the name of the user I authenticated as, and in fact it's not\nthe name of any user in the AuthUserFile. If I reverse the order of the\nsubstitutions, as follows:\n\nRewriteEngine on\nRewriteRule .* - [E=TU:%{LA-U:REMOTE_USER}]\nRequestHeader set UserId \"%{TU}e\"\nRewriteRule .* - [E=RU:%{LA-U:REMOTE_USER}]\nRequestHeader add X-TMP \"%{RU}e\"\n\nI still get nothing for REMOTE_USER, but I get a different value for HTTP_X_TMP,\nstill wrong (in the case I just tried, it was the name of the script).\n\nIf I have only one rewrite rule, as follows:\n\nRewriteEngine on\nRewriteRule .* - [E=TU:%{LA-U:REMOTE_USER}]\nRequestHeader set UserId \"%{TU}e\"\nRequestHeader add X-TMP \"%{TU}e\"\n\nI get yet a different value for X-TMP, still wrong, and still no value for\nREMOTE_USER. Etc. Adding more rewrite rules changes the behavior for the X-TMP\nvariable; if I turn on logging, the value for X-TMP disappears.\n\nThis has all the earmarks of a memory error. \n\nP.S. In case it's not immediately clear what I'm trying to do, I'm following the\ndescription of how to forward REMOTE_USER to proxy servers found at\n\nhttp://www.forbiddenweb.org/viewtopic.php?id=92524\n\nI've found no documentation for \"set UserID\" as the way to pass the remote user;\nhowever, I've tried using \"set REMOTE-USER\" and \"set REMOTE_USER\" and neither of\nthem work either.", "id": 91625, "time": "2006-07-26T19:35:16Z", "bug_id": 40121, "creation_time": "2006-07-26T19:35:16Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 40121, "text": "After some further investigation, I've discovered that I wasn't seeing the\nuserid or REMOTE_USER because I was looking at a restricted context (my proxied\nserver is Tomcat, and I was running a CGI script under Tomcat). If I inspect the\nheaders directly from my server (e.g., from a Tomcat JSP page), I see that these\nheaders ARE being forwarded, but the value is, indeed, wrong.", "id": 91627, "time": "2006-07-26T20:34:27Z", "creator": "sam@mitre.org", "creation_time": "2006-07-26T20:34:27Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 40121, "text": "OK, I've poked around some more, and there's definitely something strange going\non, but I can't figure out what it is, and Tomcat's involved, so let's just punt\non this. I've succeeded in relaying the variable I'm interested in as follows:\n\n<Location /newsstand>\n  AuthType Basic\n  AuthName \"MiTAP Newsstand Search\"\n  AuthUserFile /sys/newsstand/db/newsusers\n  Require valid-user\n\n  RewriteEngine on\n  # RewriteRule .* - [E=RU:%{LA-U:REMOTE_USER}]\n  RewriteRule .* - [E=UVAR:%{REMOTE_USER}]\n  RequestHeader add REMOTE-USER  \"%{UVAR}e\"\n\n  ProxyPass http://tapestry.mitre.org:8082/newsstand\n  ProxyPassReverse http://tapestry.mitre.org:8082/newsstand\n</Location>", "id": 91631, "time": "2006-07-26T23:01:54Z", "creator": "sam@mitre.org", "creation_time": "2006-07-26T23:01:54Z", "is_private": false, "attachment_id": null}]