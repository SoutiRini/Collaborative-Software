[{"count": 0, "tags": [], "creator": "psnively@vmware.com", "attachment_id": null, "id": 146226, "time": "2011-05-09T18:47:49Z", "bug_id": 51180, "creation_time": "2011-05-09T18:47:49Z", "is_private": false, "text": "On a connector configured with org.apache.coyote.http11.Http11NioProtocol, the first request to a 3.0 servlet results in an NPE. Successive requests behave correctly. Below is a catalina.out log excerpt covering two identical consecutive requests, created with \"org.apache.catalina.core.AsyncContextImpl.level = FINE\" added to the end of conf/logging.properties:\n\n\nMay 9, 2011 11:33:55 AM org.apache.catalina.core.AsyncContextImpl logDebug\nFINE: Req:     null  CReq:     null  RP:     null  Stage: -  Thread: ttp-nio-8080\"-exec-1  State:                  N/A  Method: Constructor  URI: N/A\n05/09 11:33:55 DEBUG[akka:event-driven:dispatcher:global-2] a.d.MonitorableThread - Created thread akka:event-driven:dispatcher:global-2\n05/09 11:33:56 DEBUG[akka:event-driven:dispatcher:global-2] c.s.RootService - Received HttpRequest(GET,http://localhost:8080/hello/CliveBarker,List(host: localhost:8080, user-agent: Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.6; en-US; rv:1.9.2.17) Gecko/20110420 Firefox/3.6.17, Accept: MediaType(text/html), MediaType(application/xhtml+xml), MediaType(application/xml), MediaRange(*/*), Accept-Encoding: gzip, deflate, Accept-Charset: Charset(ISO-8859-1), Charset(UTF-8), CharsetRange(*), keep-alive: 115, connection: keep-alive, cookie: __utma=111872281.1546197940.1294377584.1295211055.1295212368.20; __utmz=111872281.1294377584.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none)),None,Some(0:0:0:0:0:0:0:1%0),Some(HTTP/1.1)) with one attached service, dispatching...\n05/09 11:33:56 DEBUG[akka:event-driven:dispatcher:global-3] a.d.MonitorableThread - Created thread akka:event-driven:dispatcher:global-3\n05/09 11:33:56 DEBUG[akka:event-driven:dispatcher:global-3] c.v.v.v.e.HelloServiceBuilder - *** HTTP GET METHOD RECEIVED ON PATH WITH KEY CliveBarker, CALLING PERSISTENCE SERVICE ***\n05/09 11:33:56 DEBUG[akka:event-driven:dispatcher:global-4] a.d.MonitorableThread - Created thread akka:event-driven:dispatcher:global-4\n05/09 11:33:56 DEBUG[akka:event-driven:dispatcher:global-4] c.r.RedisClient - C: *2\\r\\n$3\\r\\nGET\\r\\n$28\\r\\npersistentHellos:CliveBarker\\r\\n\nMay 9, 2011 11:33:56 AM org.apache.catalina.core.AsyncContextImpl logDebug\nFINE: Req: 3ac58af4  CReq: 7f25b750  RP:  5262667  Stage: 3  Thread: ttp-nio-8080\"-exec-2  State:                  N/A  Method: complete     URI: /hello/CliveBarker\nMay 9, 2011 11:33:56 AM org.apache.catalina.core.AsyncContextImpl logDebug\nFINE: Req: 3ac58af4  CReq: 7f25b750  RP:  5262667  Stage: 3  Thread: ttp-nio-8080\"-exec-3  State:                  N/A  Method: recycle      URI: /hello/CliveBarker\n05/09 11:33:56 DEBUG[akka:event-driven:dispatcher:global-4] c.v.v.v.e.HelloServiceBuilder$PersistenceService - *** 'GET DIDN'T FIND KEY CliveBarker, RETURNING NONE ***\n05/09 11:33:56 DEBUG[akka:event-driven:dispatcher:global-3] c.v.v.v.e.HelloServiceBuilder - *** PERSISTENCE SERVICE DIDN'T RETURN OBJECT FOR KEY CliveBarker, RETURNING 403 TO CLIENT ***\n05/09 11:33:56 ERROR[akka:event-driven:dispatcher:global-3] a.h.Servlet30ContextMethodFactory$$anon$2 - Failed to write data to connection on resume - the client probably disconnected\njava.lang.NullPointerException: null\n\tat cc.spray.ServletConverter$$anonfun$fromSprayResponse$1.apply(ServletConverter.scala:88) ~[spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.ServletConverter$$anonfun$fromSprayResponse$1.apply(ServletConverter.scala:87) ~[spray_2.8.1-0.5.0.jar:na]\n\tat akka.http.RequestMethod$class.rawComplete(Mist.scala:394) ~[akka-http-1.0.jar:na]\n\tat akka.http.Get.rawComplete(Mist.scala:458) [akka-http-1.0.jar:na]\n\tat cc.spray.RootService.cc$spray$RootService$$completeRequest(RootService.scala:80) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.RootService$$anonfun$cc$spray$RootService$$handleOneService$1.apply(RootService.scala:57) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.RootService$$anonfun$cc$spray$RootService$$handleOneService$1.apply(RootService.scala:57) [spray_2.8.1-0.5.0.jar:na]\n\tat akka.dispatch.DefaultCompletableFuture.akka$dispatch$DefaultCompletableFuture$$notifyListener(Future.scala:324) [akka-actor-1.0.jar:na]\n\tat akka.dispatch.DefaultCompletableFuture$$anonfun$notifyListeners$1.apply(Future.scala:320) [akka-actor-1.0.jar:na]\n\tat akka.dispatch.DefaultCompletableFuture$$anonfun$notifyListeners$1.apply(Future.scala:319) [akka-actor-1.0.jar:na]\n\tat scala.collection.LinearSeqOptimized$class.foreach(LinearSeqOptimized.scala:61) [scala-library.jar:na]\n\tat scala.collection.immutable.List.foreach(List.scala:45) [scala-library.jar:na]\n\tat akka.dispatch.DefaultCompletableFuture.notifyListeners(Future.scala:319) [akka-actor-1.0.jar:na]\n\tat akka.dispatch.DefaultCompletableFuture.completeWithResult(Future.scala:279) [akka-actor-1.0.jar:na]\n\tat akka.actor.ScalaActorRef$$anon$1.$bang(ActorRef.scala:1398) [akka-actor-1.0.jar:na]\n\tat cc.spray.HttpServiceActor$$anon$1.apply(HttpServiceActor.scala:39) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.HttpServiceActor$$anon$1.apply(HttpServiceActor.scala:37) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.RequestContext.reject(RequestContext.scala:67) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.MiscBuilders$$anon$1$$anonfun$$tilde$1$$anonfun$apply$1$$anonfun$apply$2.apply(MiscBuilders.scala:80) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.MiscBuilders$$anon$1$$anonfun$$tilde$1$$anonfun$apply$1$$anonfun$apply$2.apply(MiscBuilders.scala:78) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.RequestContext.reject(RequestContext.scala:67) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.FilterRoute$$anonfun$fromRouting$1.apply(FilterBuilders.scala:59) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.FilterRoute$$anonfun$fromRouting$1.apply(FilterBuilders.scala:56) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.MiscBuilders$$anon$1$$anonfun$$tilde$1$$anonfun$apply$1.apply(MiscBuilders.scala:76) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.MiscBuilders$$anon$1$$anonfun$$tilde$1$$anonfun$apply$1.apply(MiscBuilders.scala:74) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.RequestContext.reject(RequestContext.scala:67) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.MiscBuilders$$anon$1$$anonfun$$tilde$1$$anonfun$apply$1$$anonfun$apply$2.apply(MiscBuilders.scala:80) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.MiscBuilders$$anon$1$$anonfun$$tilde$1$$anonfun$apply$1$$anonfun$apply$2.apply(MiscBuilders.scala:78) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.RequestContext.reject(RequestContext.scala:67) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.FilterRoute$$anonfun$fromRouting$1.apply(FilterBuilders.scala:59) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.FilterRoute$$anonfun$fromRouting$1.apply(FilterBuilders.scala:56) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.MiscBuilders$$anon$1$$anonfun$$tilde$1$$anonfun$apply$1.apply(MiscBuilders.scala:76) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.MiscBuilders$$anon$1$$anonfun$$tilde$1$$anonfun$apply$1.apply(MiscBuilders.scala:74) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.RequestContext.reject(RequestContext.scala:67) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.RequestContext.reject(RequestContext.scala:62) [spray_2.8.1-0.5.0.jar:na]\n\tat com.vmware.vcloud.vmole.example.HelloServiceBuilder$$anonfun$helloService$1$$anonfun$apply$3.apply(HelloServiceBuilder.scala:107) [HelloServiceBuilder$$anonfun$helloService$1$$anonfun$apply$3.class:na]\n\tat com.vmware.vcloud.vmole.example.HelloServiceBuilder$$anonfun$helloService$1$$anonfun$apply$3.apply(HelloServiceBuilder.scala:98) [HelloServiceBuilder$$anonfun$helloService$1$$anonfun$apply$3.class:na]\n\tat cc.spray.builders.FilterRoute$$anonfun$fromRouting$1.apply(FilterBuilders.scala:58) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.FilterRoute$$anonfun$fromRouting$1.apply(FilterBuilders.scala:56) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.MiscBuilders$$anon$1$$anonfun$$tilde$1.apply(MiscBuilders.scala:72) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.MiscBuilders$$anon$1$$anonfun$$tilde$1.apply(MiscBuilders.scala:71) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.FilterRoute$$anonfun$fromRouting$1.apply(FilterBuilders.scala:58) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.FilterRoute$$anonfun$fromRouting$1.apply(FilterBuilders.scala:56) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.FilterRoute$$anonfun$fromRouting$1.apply(FilterBuilders.scala:58) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.FilterRoute$$anonfun$fromRouting$1.apply(FilterBuilders.scala:56) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.MiscBuilders$$anon$1$$anonfun$$tilde$1.apply(MiscBuilders.scala:72) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.builders.MiscBuilders$$anon$1$$anonfun$$tilde$1.apply(MiscBuilders.scala:71) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.HttpServiceLogic$class.handle(HttpServiceLogic.scala:33) [spray_2.8.1-0.5.0.jar:na]\n\tat com.vmware.vcloud.vmole.example.CustomHttpService.handle(HelloServiceBuilder.scala:50) [CustomHttpService.class:na]\n\tat cc.spray.HttpServiceActor$$anonfun$receive$1.apply(HttpServiceActor.scala:34) [spray_2.8.1-0.5.0.jar:na]\n\tat cc.spray.HttpServiceActor$$anonfun$receive$1.apply(HttpServiceActor.scala:33) [spray_2.8.1-0.5.0.jar:na]\n\tat akka.actor.Actor$$anonfun$4.apply(Actor.scala:481) [akka-actor-1.0.jar:na]\n\tat akka.actor.Actor$$anonfun$4.apply(Actor.scala:464) [akka-actor-1.0.jar:na]\n\tat akka.actor.Actor$class.apply(Actor.scala:435) [akka-actor-1.0.jar:na]\n\tat com.vmware.vcloud.vmole.example.CustomHttpService.apply(HelloServiceBuilder.scala:50) [CustomHttpService.class:na]\n\tat akka.actor.LocalActorRef.akka$actor$LocalActorRef$$dispatch(ActorRef.scala:1012) [akka-actor-1.0.jar:na]\n\tat akka.actor.LocalActorRef$$anonfun$invoke$1.apply$mcV$sp(ActorRef.scala:832) [akka-actor-1.0.jar:na]\n\tat akka.actor.LocalActorRef$$anonfun$invoke$1.apply(ActorRef.scala:828) [akka-actor-1.0.jar:na]\n\tat akka.actor.LocalActorRef$$anonfun$invoke$1.apply(ActorRef.scala:828) [akka-actor-1.0.jar:na]\n\tat akka.util.ReentrantGuard.withGuard(LockUtil.scala:19) [akka-actor-1.0.jar:na]\n\tat akka.actor.LocalActorRef.invoke(ActorRef.scala:827) [akka-actor-1.0.jar:na]\n\tat akka.dispatch.MessageInvocation.invoke(MessageHandling.scala:23) [akka-actor-1.0.jar:na]\n\tat akka.dispatch.ExecutableMailbox$class.processMailbox(ExecutorBasedEventDrivenDispatcher.scala:190) [akka-actor-1.0.jar:na]\n\tat akka.dispatch.ExecutorBasedEventDrivenDispatcher$$anon$1.processMailbox(ExecutorBasedEventDrivenDispatcher.scala:109) [akka-actor-1.0.jar:na]\n\tat akka.dispatch.ExecutableMailbox$class.run(ExecutorBasedEventDrivenDispatcher.scala:166) [akka-actor-1.0.jar:na]\n\tat akka.dispatch.ExecutorBasedEventDrivenDispatcher$$anon$1.run(ExecutorBasedEventDrivenDispatcher.scala:109) [akka-actor-1.0.jar:na]\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886) [na:1.6.0_24]\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908) [na:1.6.0_24]\n\tat java.lang.Thread.run(Thread.java:680) [na:1.6.0_24]\n\tat akka.dispatch.MonitorableThread.run(ThreadPoolBuilder.scala:185) [akka-actor-1.0.jar:na]\n05/09 11:33:56 DEBUG[akka:event-driven:dispatcher:global-3] c.v.v.v.e.HelloServiceBuilder - *** PERSISTENCE SERVICE TIMED OUT FOR KEY CliveBarker, RETURNING 403 TO CLIENT ***\nMay 9, 2011 11:33:59 AM org.apache.catalina.core.AsyncContextImpl logDebug\nFINE: Req:     null  CReq:     null  RP:     null  Stage: -  Thread: ttp-nio-8080\"-exec-4  State:                  N/A  Method: Constructor  URI: N/A\n05/09 11:33:59 DEBUG[akka:event-driven:dispatcher:global-5] a.d.MonitorableThread - Created thread akka:event-driven:dispatcher:global-5\n05/09 11:33:59 DEBUG[akka:event-driven:dispatcher:global-5] c.s.RootService - Received HttpRequest(GET,http://localhost:8080/hello/CliveBarker,List(host: localhost:8080, user-agent: Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.6; en-US; rv:1.9.2.17) Gecko/20110420 Firefox/3.6.17, Accept: MediaType(text/html), MediaType(application/xhtml+xml), MediaType(application/xml), MediaRange(*/*), Accept-Encoding: gzip, deflate, Accept-Charset: Charset(ISO-8859-1), Charset(UTF-8), CharsetRange(*), keep-alive: 115, connection: keep-alive, cookie: __utma=111872281.1546197940.1294377584.1295211055.1295212368.20; __utmz=111872281.1294377584.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none)),None,Some(0:0:0:0:0:0:0:1%0),Some(HTTP/1.1)) with one attached service, dispatching...\n05/09 11:33:59 DEBUG[akka:event-driven:dispatcher:global-6] a.d.MonitorableThread - Created thread akka:event-driven:dispatcher:global-6\n05/09 11:33:59 DEBUG[akka:event-driven:dispatcher:global-6] c.v.v.v.e.HelloServiceBuilder - *** HTTP GET METHOD RECEIVED ON PATH WITH KEY CliveBarker, CALLING PERSISTENCE SERVICE ***\n05/09 11:33:59 DEBUG[akka:event-driven:dispatcher:global-7] a.d.MonitorableThread - Created thread akka:event-driven:dispatcher:global-7\n05/09 11:33:59 DEBUG[akka:event-driven:dispatcher:global-7] c.r.RedisClient - C: *2\\r\\n$3\\r\\nGET\\r\\n$28\\r\\npersistentHellos:CliveBarker\\r\\n\n05/09 11:33:59 DEBUG[akka:event-driven:dispatcher:global-7] c.v.v.v.e.HelloServiceBuilder$PersistenceService - *** 'GET DIDN'T FIND KEY CliveBarker, RETURNING NONE ***\n05/09 11:33:59 DEBUG[akka:event-driven:dispatcher:global-6] c.v.v.v.e.HelloServiceBuilder - *** PERSISTENCE SERVICE DIDN'T RETURN OBJECT FOR KEY CliveBarker, RETURNING 403 TO CLIENT ***\nMay 9, 2011 11:33:59 AM org.apache.catalina.core.AsyncContextImpl logDebug\nFINE: Req: 3ac58af4  CReq: 7f25b750  RP:  5262667  Stage: 7  Thread: :dispatcher:global-6  State:                  N/A  Method: complete     URI: /hello/CliveBarker\n05/09 11:33:59 DEBUG[akka:event-driven:dispatcher:global-6] c.v.v.v.e.HelloServiceBuilder - *** PERSISTENCE SERVICE TIMED OUT FOR KEY CliveBarker, RETURNING 403 TO CLIENT ***\nMay 9, 2011 11:33:59 AM org.apache.catalina.core.AsyncContextImpl logDebug\nFINE: Req: 3ac58af4  CReq: 7f25b750  RP:  5262667  Stage: 3  Thread: ttp-nio-8080\"-exec-6  State:                  N/A  Method: recycle      URI: /hello/CliveBarker\n\nAs you can see, on the first request, the AsyncContextImpl has complete()ed and recycle()d the connection immediately upon the main thread returning control. On the second request, however, the AsyncContextImpl does not complete() and recycle() the connection until after the forked thread has complete()ed the context."}, {"count": 1, "tags": [], "text": "There are unit tests that test this exact scenario in org.apache.catalina.core.TestAsyncContextImpl and they pass with the current 7.0.x code with all three HTTP connector implementations and have also passed with the 7.0.12 tag.\n\nIf you re-open this issue, you'll need to provide the simplest possible test case (source for a single Servlet should be enough based on your description) that demonstrates this issue along with the exact steps to reproduce it on a clean install of the latest 7.0.x release.", "is_private": false, "bug_id": 51180, "id": 146227, "time": "2011-05-09T19:13:50Z", "creator": "markt@apache.org", "creation_time": "2011-05-09T19:13:50Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "id": 146228, "time": "2011-05-09T19:38:00Z", "bug_id": 51180, "creation_time": "2011-05-09T19:38:00Z", "is_private": false, "text": "> c.v.v.v.e.HelloServiceBuilder$PersistenceService - *** 'GET DIDN'T FIND KEY\n> CliveBarker, RETURNING NONE ***\n\nThe above is not in Tomcat code. As well as NPE in\ncc.spray.ServletConverter$$anonfun$fromSprayResponse$1.apply(ServletConverter.scala:88)\n\nand \n> at akka.dispatch.MonitorableThread.run(ThreadPoolBuilder.scala:185)\nis not a thread run by Tomcat.\n\nNote, that when a lot of different threads print to System.out (aka catalina.out file) simultaneously the order between their messages may be arbitrary."}]