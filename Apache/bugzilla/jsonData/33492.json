[{"count": 0, "attachment_id": null, "creator": "aleksander.adamowski.apache@altkom.pl", "is_private": false, "id": 70762, "time": "2005-02-10T16:22:41Z", "bug_id": 33492, "creation_time": "2005-02-10T16:22:41Z", "tags": [], "text": "I have the following Engine configuration in server.xml:\n\n<Engine name=\"Catalina\" defaultHost=\"localhost\">\n  <Logger className=\"org.apache.catalina.logger.FileLogger\" />\n\n  <Realm className=\"org.apache.catalina.realm.JNDIRealm\" debug=\"99\"\n         connectionURL=\"ldap://localhost:388\"\n         authentication=\"simple\"\n         userBase=\"dc=altkom,dc=pl,o=Altkom\" userSubtree=\"true\"\n         userSearch=\"uid={0}\"\n         userRoleName=\"ou\"\n         resourceName=\"LdapDatabase\" />\n\n  <Host name=\"localhost\" appBase=\"webapps\" />\n</Engine>\n\nThe port 388 is used by a local stunnel proxy that forwards SSL-encapsulated\nLDAP requests to a central LDAP authentication server (Tomcat stubbornly uses\nplaintext communication even with ldaps:// URI's, but that's another story...).\n\nThe Tomcat server starts up OK, and I can see it opening a connection to the\nLDAP server. It's visible in OpenLDAP's logs:\n\nFeb 10 16:08:30 ldap slapd[10446]: conn=36 fd=17 ACCEPT from\nIP=xxx.xxx.xxx.xxx:49747 (IP=0.0.0.0:636) \nFeb 10 16:08:30 ldap slapd[10446]: conn=36 op=0 BIND dn=\"\" method=128 \nFeb 10 16:08:30 ldap slapd[10446]: conn=36 op=0 RESULT tag=97 err=0 text= \n\nTomcat reports success in its logs too:\n\nFeb 10, 2005 4:08:30 PM org.apache.catalina.core.StandardEngine start\nINFO: Starting Servlet Engine: Apache Tomcat/5.0\nFeb 10, 2005 4:08:31 PM org.apache.catalina.core.StandardHost start\nINFO: XML validation disabled\nFeb 10, 2005 4:08:31 PM org.apache.catalina.core.StandardHost getDeployer\nINFO: Create Host deployer for direct deployment ( non-jmx )\nFeb 10, 2005 4:08:31 PM org.apache.catalina.core.StandardHostDeployer install\nINFO: Processing Context configuration file URL\nfile:/etc/tomcat5/Catalina/localhost/balancer.xml\n...\n\nHowever, if I try to authenticate a user by trying to log in to the standard\nadmin webapp, Tomcat floods the LDAP server with redundant search requests:\n\nFeb 10 16:11:03 ldap slapd[10446]: conn=36 op=1 SRCH\nbase=\"dc=altkom,dc=pl,o=Altkom\" scope=2 filter=\"(uid=someuser)\"\nFeb 10 16:11:03 ldap slapd[10446]: conn=36 op=1 SRCH attr=ou\nFeb 10 16:11:03 ldap slapd[10446]: conn=37 fd=19 ACCEPT from IP=127.0.0.1:40390\n(IP=0.0.0.0:389)\nFeb 10 16:11:03 ldap slapd[10446]: conn=37 op=0 BIND dn=\"\" method=128\nFeb 10 16:11:03 ldap slapd[10446]: conn=37 op=0 RESULT tag=97 err=0 text=\nFeb 10 16:11:03 ldap slapd[10446]: conn=37 op=1 SRCH\nbase=\"dc=altkom,dc=pl,o=Altkom\" scope=2 filter=\"(uid=someuser)\"\nFeb 10 16:11:03 ldap slapd[10446]: conn=37 op=1 SRCH attr=ou\nFeb 10 16:11:03 ldap slapd[10446]: conn=38 fd=21 ACCEPT from IP=127.0.0.1:40391\n(IP=0.0.0.0:389)\nFeb 10 16:11:03 ldap slapd[10446]: conn=38 op=0 BIND dn=\"\" method=128\nFeb 10 16:11:03 ldap slapd[10446]: conn=38 op=0 RESULT tag=97 err=0 text=\nFeb 10 16:11:03 ldap slapd[10446]: conn=38 op=1 SRCH\nbase=\"dc=altkom,dc=pl,o=Altkom\" scope=2 filter=\"(uid=someuser)\"\nFeb 10 16:11:03 ldap slapd[10446]: conn=38 op=1 SRCH attr=ou\nFeb 10 16:11:03 ldap slapd[10446]: conn=39 fd=23 ACCEPT from IP=127.0.0.1:40392\n(IP=0.0.0.0:389)\nFeb 10 16:11:03 ldap slapd[10446]: conn=39 op=0 BIND dn=\"\" method=128\nFeb 10 16:11:03 ldap slapd[10446]: conn=39 op=0 RESULT tag=97 err=0 text=\n\nTomcat opens many parallel connections until it clogs the LDAP server.\n\nLooks like it tries to do an asynchronous search (why not a synchronous one?),\nand instead of checking back for results later, opens new connections and does\nnew searches in an infinite loop.\n\nExpected behaviour: Tomcat should receive search results, and if an entry is\nfound, it should try to bind using that entry's DN.\nIf bind operation succeeds, it should assume that the user/password is correct\nand the user has the roles corresponding to values of the \"ou\" attribute (if\npresent).\n\nIn my case the search for ou would return the following results:\ndn: uid=someuser,dc=warszawa,dc=altkom,dc=pl,o=altkom\nou: tk\nou: edu\nou: tomcat\n\nSo after authentication successfully, someuser should have the roles \"tk\", \"edu\"\nand \"tomcat\" in the webapp."}, {"count": 1, "tags": [], "creator": "aleksander.adamowski.apache@altkom.pl", "text": "BTW, I'm using Sun JDK-1.5.0.01 from jPackage nosource RPM\n(java-1.5.0-sun-1.5.0.01-3jpp).", "id": 70838, "time": "2005-02-11T15:33:12Z", "bug_id": 33492, "creation_time": "2005-02-11T15:33:12Z", "is_private": false, "attachment_id": null}, {"count": 2, "attachment_id": null, "creator": "Andrew_Polozov@yahoo.com", "is_private": false, "id": 72824, "time": "2005-03-25T04:05:20Z", "bug_id": 33492, "creation_time": "2005-03-25T04:05:20Z", "tags": [], "text": "JNDIRealm by itself performs search only once per authorization.\nI guess what you see is a result of authorizing multiple element referred by\nHTML page (pictures, css, jafascript, etc.)\nI've seen that too. It happens for first requests. Than the information\n(User/Roles) is getting cached (I'm not sure where).\nI'm not sure how Catalina handles Realm instances, I guess it has some kind of\npool, so each request is performed in it's own Thread via separate Realm instance..."}, {"count": 3, "tags": [], "bug_id": 33492, "text": "There's one Realm instance per declaration in server.xml typically.  The\nexception is if you define it in <DefaultContext>, in which case there's one\nrealm instance per actual context.\n\nPlease comment on Andrey's remark.  Please also test on Tomcat 5.5.7 if\npossible.  And since it seems you know LDAP fairly well, a patch to JNDIRealm\nwould be appreciated ;)", "id": 72826, "time": "2005-03-25T04:12:11Z", "creator": "yoavs@computer.org", "creation_time": "2005-03-25T04:12:11Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 33492, "text": "Nothing is done asynchronously in the JNDI realm, and it should limit itself to\none connection to the backend. If you have a problem, you need to look into the\nJNDI realm sourcecode, as your asumptions on the realm do not correspond to how\nit works (or at least, how it is supposed to work).\n\nAnyway, since this was not reported against Tomcat 5.5, I will not close the report.", "id": 72999, "time": "2005-03-29T17:32:29Z", "creator": "remm@apache.org", "creation_time": "2005-03-29T17:32:29Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 33492, "attachment_id": null, "text": "No further comments or data from OP, closing.", "id": 74370, "time": "2005-05-03T16:09:13Z", "creator": "yoavs@computer.org", "creation_time": "2005-05-03T16:09:13Z", "is_private": false}]