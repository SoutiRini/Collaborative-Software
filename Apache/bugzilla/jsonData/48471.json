[{"count": 0, "tags": [], "bug_id": 48471, "attachment_id": null, "text": "From time to time, Apache keeps restarting (sometimes rarely, sometimes quite often).\n\ngrep -R \"Doing graceful restart\" /etc/httpd/logs/error_log | awk 'BEGIN {FS=\"]\"};{print $1}'| cut -d \"[\" -f 2\n\nTue Dec 29 16:11:06 2009\nTue Dec 29 16:24:40 2009\nTue Dec 29 16:25:11 2009\nTue Dec 29 16:25:12 2009\nTue Dec 29 16:28:44 2009\nTue Dec 29 16:37:29 2009\nTue Dec 29 16:46:17 2009\nTue Dec 29 16:55:13 2009\n\nI turned on the LogLevel from warn to debug and Apache and uncovered the following message in the logs:\n\n[Tue Dec 29 04:35:05 2009] [notice] SIGUSR1 received. Doing graceful restart [Tue Dec 29 04:35:05 2009] [debug] worker.c(791): (22)Invalid argument:\napr_proc_mutex_unlock failed. Attempting to shutdown process gracefully.\n\nSwitching to prework solved the issue. Recompiled many times, still same issue.\n\nCentOS 5.4 x64", "id": 133261, "time": "2010-01-02T02:56:32Z", "creator": "theking@getpaidforum.net", "creation_time": "2010-01-02T02:56:32Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 48471, "attachment_id": null, "is_private": false, "id": 133262, "time": "2010-01-02T03:01:01Z", "creator": "theking@getpaidforum.net", "creation_time": "2010-01-02T03:01:01Z", "text": "PHP 5.2.12"}, {"count": 2, "tags": [], "text": "It's well-known and well-documented, you don't use worker (or other threaded MPM) with non-thread-safe software.\n\nThat's why all the distros give you prefork if you want mod_php.\n\nIf you want worker+php, run the php out-of-process, e.g. with CGI or fastcgi.", "is_private": false, "id": 133263, "creator": "nick@webthing.com", "time": "2010-01-02T03:58:06Z", "bug_id": 48471, "creation_time": "2010-01-02T03:58:06Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "theking@getpaidforum.net", "text": "I am running suPHP + fCGI", "id": 133264, "time": "2010-01-02T04:08:52Z", "bug_id": 48471, "creation_time": "2010-01-02T04:08:52Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 48471, "attachment_id": null, "text": "I am not using mod_php, I am running on suPHP + fCGI", "id": 133265, "time": "2010-01-02T05:46:26Z", "creator": "theking@getpaidforum.net", "creation_time": "2010-01-02T05:46:26Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "trawick@apache.org", "text": "> [notice] SIGUSR1 received. Doing graceful restart\n\nSome process is sending the SIGUSR1 signal to the httpd parent process; this should be a separate httpd process, when invoked via \"apachectl graceful\" or \"httpd -k graceful\".\n\nIf it isn't a script or user explicitly triggering graceful restart, I don't know a straightforward way to capture the sender.\n\nPerhaps a script that watches the log file for that message could capture the list of active processes?  (Hopefully someone has a better idea.)\n\n>debug] worker.c(791): (22)Invalid argument: apr_proc_mutex_unlock failed. Attempting to shutdown process gracefully.\n\nThis is an uninteresting error which occurs during graceful restart processing and can be ignored.", "count": 5, "id": 133267, "time": "2010-01-02T05:52:03Z", "bug_id": 48471, "creation_time": "2010-01-02T05:52:03Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "theking@getpaidforum.net", "is_private": false, "count": 6, "id": 133369, "time": "2010-01-06T00:28:37Z", "bug_id": 48471, "creation_time": "2010-01-06T00:28:37Z", "text": "Well whatever process is making these graceful restarts, is not using /etc/init.d/httpd. I see restarts at 1900, but nothing has touched that init script since I have last. I also checked and a /scripts/restartsrv_httpd doesn't issue a graceful restart either , just a regular restart."}, {"count": 7, "tags": [], "text": "From the logs, I believe I might have finally found something interesting from the script:\n\n[root@host] ~ >> grep -R safeaprestart /root/restartWatch-*\n\n/root/restartWatch-01:16::01-06-2010:root 24474 0.0 0.1 28456 4040 ? SN 01:16\n0:00 safeaprestart - doing restart /root/restartWatch-09:30::01-06-2010:root\n10721 2.5 0.1 28456 4044 ? RN 09:30 0:00 safeaprestart - doing restart /root/restartWatch-09:47::01-06-2010:root 25993 1.0 0.1 28452 4040 ? SN 09:47\n0:00 safeaprestart - doing restart /root/restartWatch-10:05::01-06-2010:root\n21235 0.0 0.1 28452 4040 ? SN 10:05 0:00 safeaprestart - doing restart /root/restartWatch-12:05::01-06-2010:root 1042 0.0 0.1 28456 4036 ? SN 12:05\n0:00 safeaprestart - doing restart\n\nAs you can see, when these restarts happen, there is a mysterious \"safeaprestart\" process running. A little research seems to indicate that is a component of tailwatchd. Also a little research reveals that everytime you add a account, Apache is restarted with that process as well:\n\n$output .= Whostmgr::UI::setstatus(\"Restarting apache\"); Cpanel::HttpUtils::safeaprestart();\n$output .= Whostmgr::UI::setstatusdone();\n\nFor now I have disabled monitoring of Apache from tailwatchd. Now if the issue was purely tailwatchd restarting Apache even though it didn't need to be, this won't cause any downtime. On the other hand if Apache is really failing due to some other issue (and it doesn't appear to be) it will continue to fail, but won't be automatically restarted by tailwatchd.\n\nAs of now, tailwatchd monitoring of Apache is disabled. So if the restarts cease to happen now, we will know tailwatchd was the culprit.", "is_private": false, "id": 133388, "creator": "theking@getpaidforum.net", "time": "2010-01-06T09:35:12Z", "bug_id": 48471, "creation_time": "2010-01-06T09:35:12Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 48471, "text": "3rd party issue, non httpd related.", "id": 133389, "time": "2010-01-06T09:44:41Z", "creator": "rpluem@apache.org", "creation_time": "2010-01-06T09:44:41Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 48471, "text": "Huh niq?\n\nNothing in PHP [itself] is a problem - in fact it works very well in any\nnumber of distributions.  Combining PHP with extensions that access non-threadsafe\nlibraries is - obviously - a problem.\n\nBut please leave this fud on PHP's documentation commentary sections, where the\nmisinformed, blanket commentary belongs.\n\nAs noted by rplume, this is not the place for such problem reports.", "id": 133528, "time": "2010-01-11T20:47:25Z", "creator": "wrowe@apache.org", "creation_time": "2010-01-11T20:47:25Z", "is_private": false, "attachment_id": null}]