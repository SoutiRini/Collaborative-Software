[{"attachment_id": null, "tags": [], "creator": "shaun@legalfiles.com", "is_private": false, "count": 0, "id": 192874, "time": "2016-08-03T21:01:34Z", "bug_id": 59940, "creation_time": "2016-08-03T21:01:34Z", "text": "Connector attribute \"certificateVerification\" in the new SSLHostConfig section is not requiring a client certificate in Tomcat 8.5.4.\n\nIn Tomcat 8.0.33 I was using the clientAuth=\"true\" connector attribute.  I moved it over to the new certificateVerification=\"required\" in the SSLHostConfig section.\n\nI have removed all client certificates and I am not getting rejected.  I connect to a Tomcat 8.0.33 with not certificate and get rejected.  If I add the client certificate back and connect to the 8.0.33 I am good.  \n\nI have set Tomcat logs to debug and have not found any error messages, issues starting the connector or issues with bad attributes.  I have used both IE and Chrome browsers.  It seems as if the certificateVerification isn't being set.  I searched for any issues for the certificateVerification attribute and could not find anything.\n\nI apologize up front if I missed the fix when searching for one.\n\nHere is my server.xml portion for SSL:\n    <!-- Define a SSL/TLS HTTP/1.1 Connector on port 8443\n         This connector uses the NIO implementation with the JSSE engine. When\n         using the JSSE engine, the JSSE configuration attributes must be used.\n    -->\n\n    <Connector port=\"8443\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\"\n\t       SSLEnabled=\"true\"\n               maxThreads=\"150\" \n\t       scheme=\"https\" \n\t       secure=\"true\"\n\t       maxKeepAliveRequests=\"15\"\n\t       connectionTimeout=\"60000\"\n\t       acceptCount=\"100\"\n\t       connectionUploadTimeout=\"300000\"\n\t       compression=\"force\"\n\t       enableLookups=\"true\"\n\t       disableUploadTimeout=\"false\" >\n        <SSLHostConfig>\n\t       truststoreFile=\"?:\\?\\?.jks\"\n\t       truststorePass=\"*********\"\n\t       certificateVerification=\"required\"\n\t       protocols=\"TLSv1,TLSv1.1,TLSv1.2\" >\n            <Certificate certificateKeystoreFile=\"?:\\?\\?.jks\"\n\t\t\t certificateKeystorePassword=\"***********\"\n\t \t\t certificateKeyAlias=\"1\"\n                         type=\"RSA\" />\n        </SSLHostConfig>\n    </Connector>"}, {"count": 1, "tags": [], "creator": "shaun@legalfiles.com", "text": "I would expect to see this error message in the tomcat8-stdout.????-??-??.log with SSL debug is enabled and the client does not present a certificate.  I see nothing in the log when running 8.5.4:\n\n%% Invalidated:  [Session-2, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA]\nhttp-nio-8443-exec-2, SEND TLSv1.2 ALERT:  fatal, description = bad_certificate\nhttp-nio-8443-exec-2, WRITE: TLSv1.2 Alert, length = 2\nhttp-nio-8443-exec-2, called closeSocket()\nhttp-nio-8443-exec-2, handling exception: javax.net.ssl.SSLHandshakeException: null cert chain\nhttp-nio-8443-exec-2, IOException in getSession():  javax.net.ssl.SSLHandshakeException: null cert chain\nhttp-nio-8443-exec-2, called close()\nhttp-nio-8443-exec-2, called closeInternal(true)\n\nand what Chrome would present:\nThis site can\u2019t provide a secure connection\n\nservername didn\u2019t accept your login certificate, or your login certificate may have expired.\nTry contacting the system admin.\nERR_BAD_SSL_CLIENT_AUTH_CERT", "id": 192883, "time": "2016-08-04T16:23:56Z", "bug_id": 59940, "creation_time": "2016-08-04T16:23:56Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 59940, "text": "I was able to resolve the problem.  Need to use the attribute \"truststorePassword\" instead of the attribute \"truststorePass\" listed on the following help page:\nhttps://tomcat.apache.org/tomcat-8.5-doc/config/http.html#SSL_Support_-_SSLHostConfig\n\n\n\n\nWorking Server.xml file:\n\n    <Connector port=\"8443\" protocol=\"org.apache.coyote.http11.Http11NioProtocol\"\n\t       SSLEnabled=\"true\"\n               maxThreads=\"150\" \n\t       scheme=\"https\" \n\t       secure=\"true\"\n\t       maxKeepAliveRequests=\"15\"\n\t       connectionTimeout=\"60000\"\n\t       acceptCount=\"100\"\n\t       connectionUploadTimeout=\"300000\"\n\t       compression=\"force\"\n\t       enableLookups=\"true\"\n\t       disableUploadTimeout=\"false\" >\n        <SSLHostConfig\n\t       truststoreFile=\"?:\\?\\?.jks\"\n\t       truststorePassword=\"*******\"\n\t       certificateVerification=\"required\"\n\t       protocols=\"+TLSv1,+TLSv1.1,+TLSv1.2\" >\n            <Certificate certificateKeystoreFile=\"?:\\?\\?.jks\"\n\t\t\t certificateKeystorePassword=\"*******\"\n\t \t\t certificateKeyAlias=\"1\"\n                         type=\"RSA\" />\n        </SSLHostConfig>\n    </Connector>", "count": 2, "id": 192893, "time": "2016-08-04T19:25:32Z", "creator": "shaun@legalfiles.com", "creation_time": "2016-08-04T19:25:32Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 59940, "text": "Thanks for the update. I've fixed the docs for 9.0.x and 8.5.x for the next release of each (9.0.0.M10 and 8.5.5).", "id": 192894, "time": "2016-08-04T19:55:21Z", "creator": "markt@apache.org", "creation_time": "2016-08-04T19:55:21Z", "is_private": false, "attachment_id": null}]