[{"count": 0, "text": "We see sockets in CLOSE_WAIT when NioReceiver.stop() is called. \n\nApparently, according to;\n\nhttp://forum.java.sun.com/thread.jspa?threadID=478802&messageID=2231353\n\none must remain registered with the selector, close, then select again (with a timeout), and then the channel is properly drained and a tcp reset occurs.\n\nI'm working on a patch.", "bug_id": 45282, "attachment_id": null, "id": 117991, "time": "2008-06-25T14:20:20Z", "creator": "robert.newson@gmail.com", "creation_time": "2008-06-25T14:20:20Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "creator": "robert.newson@gmail.com", "text": "\nAh, forgive me, linger is enabled with a 3 second timeout. In my tests I see them hanging around but if I wait they do close.\n\nThe pattern for draining the queue completely is still a useful enhancement and would allow correct behavior without linger.\n", "id": 117992, "time": "2008-06-25T14:36:16Z", "bug_id": 45282, "creation_time": "2008-06-25T14:36:16Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 45282, "attachment_id": null, "text": "Any progress on your patch?", "id": 121122, "time": "2008-10-01T08:36:27Z", "creator": "markt@apache.org", "creation_time": "2008-10-01T08:36:27Z", "is_private": false}, {"count": 3, "text": "I believe a patch could look something like\n\nIndex: org/apache/catalina/tribes/transport/nio/NioReceiver.java\n===================================================================\n--- org/apache/catalina/tribes/transport/nio/NioReceiver.java   (revision 695909)\n+++ org/apache/catalina/tribes/transport/nio/NioReceiver.java   (working copy)\n@@ -377,6 +377,7 @@\n                 log.warn(\"Unable to cleanup on selector close.\",ignore);\n             }\n         }catch ( ClosedSelectorException ignore){}\n+        try {selector.selectNow();}catch (Throwable ignore){}\n         selector.close();\n     }\n\n\n\nand all we do, is issue a selectNow statement after we have cancelled the keys\n\nbest\nFilip\n\n", "bug_id": 45282, "is_private": false, "id": 121128, "time": "2008-10-01T09:24:59Z", "creator": "fhanik@apache.org", "creation_time": "2008-10-01T09:24:59Z", "tags": [], "attachment_id": null}, {"count": 4, "text": "Filips patch has been applied to 8.0.x for 8.0.15 onwards.\n\nI do not propose to back-port this.", "bug_id": 45282, "attachment_id": null, "id": 178314, "time": "2014-10-06T22:14:36Z", "creator": "markt@apache.org", "creation_time": "2014-10-06T22:14:36Z", "tags": [], "is_private": false}]