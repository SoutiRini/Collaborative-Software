[{"count": 0, "tags": [], "bug_id": 15370, "text": "(i think this is a bug, but no-one seems to be able to confirm this)\n\nI'll try and be a succinct as possible. \n\nI have configured two apache 2.0.43 servers, one acting as an ssl enabled \nserver which requests a client cert via http://server:81, the other is acting \nas a client proxy which users connect to via their browser, via \nhttps://proxy:7800/server\n\nThe proxy is configured to Proxy the client request using the client cert (in \npem format) to the server (via the ProxyPass mechanism). I have confirmed my \nconfigs as I can s_client connect to both proxy and server to docroot.\n\nI can also connect to the endpoint server by installing my client cert in p12 \nformat from my browser and it works ok. (and via commandline on the proxy using \ncurl)\n\nI have noticed the following errors.\n\na. the proxy cannot complete the ssl handshake to the server as it cannot find \nthe end point servers client cert.\n\nfrom default_error_logs\n------------------------\n[Fri Dec 13 14:43:30 2002] [warn] Proxy client certificate callback: \n(217.199.xx.xx:443) downstream server wanted client certificate but none are \nconfigured\n[Fri Dec 13 14:43:30 2002] [error] SSL Proxy connect failed\n[Fri Dec 13 14:43:30 2002] [error] SSL Library Error: 336151568 \nerror:14094410:lib(20):func(148):reason(1040)\n[Fri Dec 13 14:43:30 2002] [error] (20014)Error string not specified yet: \nproxy: request failed to 62.49.xx.xx:81 (server.somewhere.com)\n\nI have also run httpd on the proxy via strace and get the following errors at \nthe same time.. ( pay particular attention to the client.pem open system call) \nas this is where the client pem cert is located as apache starts up.\n\n30218 14:19:30 semget(IPC_PRIVATE, 1, IPC_CREAT|0x180|0600) = 2981895\n30218 14:19:30 semctl(2981895, 0, 0x110 /* SEM_??? */, 0xbffff418) = 0\n30218 14:19:30 geteuid32()              = 0\n30218 14:19:30 semctl(2981895, 0, 0x101 /* SEM_??? */, 0xbffff428) = 0\n30218 14:19:30 gettimeofday({1039789170, 486809}, NULL) = 0\n30218 14:19:30 write(9, \"[Fri Dec 13 14:19:30 2002] [warn\"..., 121) = 121\n30218 14:19:30 open(\"/usr/local/apache2/conf/client.pem\", O_RDONLY) = 10\n30218 14:19:30 fstat64(10, {st_mode=S_IFREG|0644, st_size=3489, ...}) = 0\n30218 14:19:30 mmap2(NULL, 4096, PROT_READ|PROT_WRITE, \nMAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x4002c000\n30218 14:19:30 read(10, \"Certificate:\\n    Data:\\n        V\"..., 4096) = 3489\n30218 14:19:30 read(10, \"\", 4096)       = 0\n30218 14:19:30 close(10)                = 0\n30218 14:19:30 munmap(0x4002c000, 4096) = 0\n30218 14:19:30 open(\"/usr/local/apache2/conf/client.pem\", O_RDONLY) = 10\n30218 14:19:30 fstat64(10, {st_mode=S_IFREG|0644, st_size=3489, ...}) = 0\n30218 14:19:30 mmap2(NULL, 4096, PROT_READ|PROT_WRITE, \nMAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x4002c000\n30218 14:19:30 read(10, \"Certificate:\\n    Data:\\n        V\"..., 4096) = 3489\n30218 14:19:30 read(10, \"\", 4096)       = 0\n30218 14:19:30 close(10)                = 0\n\nI have tried using the other SSLProxyCARevocationFile directive, and I get the \nsame results.\n\nWhen i connect to the proxy via the browser I get this error.\n\n<from html browser error page>\n\nServer error!\nThe server encountered an internal error and was unable to complete your \nrequest. Either the server is overloaded or there was an error in a CGI script. \nIf you think this is a server error, please contact the webmaster. \nError 20014\nproxy.somwhere.com\nFri Dec 13 17:18:12 2002 \nApache/2.0.43 (Unix) mod_ssl/2.0.43 OpenSSL\n\n\nextract from httpd.conf for proxy pass\n\n        ProxyPass /server https://server.somewhere.com:81\n        ProxyPassReverse /server https://server.somewhere.com:81\n\nThis has been bugging me for nearly a week and I'm sure it's a bug, if it's \nnot, please correct my errors...\n\nRegards\n\nDan Cave", "id": 27823, "time": "2002-12-13T18:19:53Z", "creator": "mogul@totalise.co.uk", "creation_time": "2002-12-13T18:19:53Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 15370, "attachment_id": null, "id": 45720, "time": "2003-10-15T09:32:25Z", "creator": "kris.verbeeck@advalvas.be", "creation_time": "2003-10-15T09:32:25Z", "is_private": false, "text": "I think you should use the SSLProxyMachineCertificateFile directive instead of\nthe SSLProxyCACertificateFile directive if you want to configure client\ncertificate authentication towards a back-end web server."}, {"count": 2, "tags": [], "bug_id": 15370, "attachment_id": null, "id": 45725, "time": "2003-10-15T10:21:52Z", "creator": "mads@apache.org", "creation_time": "2003-10-15T10:21:52Z", "is_private": false, "text": "Without seeing the exact config for the SSLProxy* directives, \nit is hard to guess what happens - but my first guess is that\nthere is no SSLProxyEngine on\nhttp://httpd.apache.org/docs-2.0/mod/mod_ssl.html#sslproxyengine"}]