[{"count": 0, "tags": [], "bug_id": 50541, "attachment_id": null, "text": "Today, when enabling an application's LDAP authentication through Active Directory, I've discovered that with apparently a completely correct LDAP Realm configuration on the Tomcat side, AD returns the following error all the time:\n\nLDAP: error code 1 - 000004DC: LdapErr: DSID-0C0906DD, comment: In order to perform this operation a successful bind must be completed on the connection., data 0, v1771\n\nAfter some hours of Googling and experimenting with referrals, subtree search modes et cetera, I've found out (through network packet analysis) that the problem is caused by LDAP sizeLimit being set to zero in the searches sent by Tomcat.\n\nAfter closer inspection of Tomcat source code, I've dug out this class:\n\nhttp://svn.apache.org/repos/asf/tomcat/trunk/java/org/apache/catalina/realm/JNDIRealm.java\n\nAnd this code fragment in the method getUserBySearch(DirContext context, String username, String[] attrIds):\n\n\n\n        // Set up the search controls\n        SearchControls constraints = new SearchControls();\n\n        if (userSubtree) {\n            constraints.setSearchScope(SearchControls.SUBTREE_SCOPE);\n        }\n        else {\n            constraints.setSearchScope(SearchControls.ONELEVEL_SCOPE);\n        }\n\n        // Specify the attributes to be retrieved\n        if (attrIds == null)\n            attrIds = new String[0];\n        constraints.setReturningAttributes(attrIds);\n\n        NamingEnumeration<SearchResult> results =\n            context.search(userBase, filter, constraints);\n\nAs you can see (http://tomcat.apache.org/tomcat-7.0-doc/realm-howto.html#JNDIRealm), currently there's no way to customize other search controls than search scope and returning attributes by means of XML configuration.\n\nIn javax.naming.directory.SearchControls, the LDAP sizeLimit is determined by the countLimit property:\nhttp://download.oracle.com/javase/6/docs/api/javax/naming/directory/SearchControls.html#setCountLimit(long)\n\nI propose to create a new configuration attribute for the Realm XML element that would enable setting this limit, and naming it \"sizeLimit\" (not \"countLimit\" like the Java property, because in LDAP world people are used to the former term). While we're at it, adding \"timeLimit\" (measured in milliseconds) attribute would be also nice.\n\nSo for example one would be able to set 1000 entries sizeLimit and 5 seconds timeLimit this way:\n\n<Realm className=\"org.apache.catalina.realm.JNDIRealm\" debug=\"99\"\n     connectionURL=\"ldap://localhost:389\"\n       userPattern=\"uid={0},ou=people,dc=mycompany,dc=com\"\n       sizeLimit=\"1000\"\n       timeLimit=\"5000\"\n/>", "id": 143060, "time": "2011-01-04T11:35:07Z", "creator": "apache@olo.org.pl", "creation_time": "2011-01-04T11:35:07Z", "is_private": false}, {"count": 1, "tags": [], "creator": "markt@apache.org", "text": "Fixed in 7.0.x and will be included in 7.0.6 onwards.", "id": 143068, "time": "2011-01-04T12:35:16Z", "bug_id": 50541, "creation_time": "2011-01-04T12:35:16Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 50541, "attachment_id": null, "text": "(In reply to comment #1)\n> Fixed in 7.0.x and will be included in 7.0.6 onwards.\n\nAreyou planning on applying this fix also to the 6.0.x version?", "id": 143082, "time": "2011-01-05T06:33:18Z", "creator": "marwasilewski@pzu.pl", "creation_time": "2011-01-05T06:33:18Z", "is_private": false}, {"count": 3, "tags": [], "creator": "markt@apache.org", "text": "There are no such plans at present.", "id": 143083, "time": "2011-01-05T06:36:35Z", "bug_id": 50541, "creation_time": "2011-01-05T06:36:35Z", "is_private": false, "attachment_id": null}]