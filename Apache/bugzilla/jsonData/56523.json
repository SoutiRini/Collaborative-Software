[{"count": 0, "tags": [], "bug_id": 56523, "text": "Created attachment 31620\nGNU Unified diff format of proposed fix\n\nIn the event of a privilegedactionexception in SpnegoAuthenticator, the error is always logged. Hence the stack trace of the error always appears in catalina.out. \nThis leads to spurious logs even when debugging is not enabled\n\nIn the event of GSSException, its logged only when debugging is enabled.\n\nIt is imperative to note that The privilegedactions are AcceptAction and action both of which only have the capacity to throw GSSException.\n\nHence I am suggesting a fix which logs privileged action exception only when debugging is enabled in tomcat. This is added as an attachment and is a unified diff of the SpnegoAuthenticator before and after the change.\n\nPlease let me know if you have any doubts about the fix or if you need a sample catalina.out highlighting the problem.", "id": 175201, "time": "2014-05-14T09:54:30Z", "creator": "arunav.sanyal91@gmail.com", "creation_time": "2014-05-14T09:54:30Z", "is_private": false, "attachment_id": 31620}, {"count": 1, "tags": [], "bug_id": 56523, "text": "A stack trace to see what exactly is going on here would be helpful.\n\nI suspect, to be safe, we'll only want to log at debug if the cause of the PrivilegedActionException is an instance of GSSException.", "id": 175206, "time": "2014-05-14T14:06:23Z", "creator": "markt@apache.org", "creation_time": "2014-05-14T14:06:23Z", "is_private": false, "attachment_id": null}, {"count": 2, "attachment_id": null, "bug_id": 56523, "text": "Thanks Mark\n\nHere is an example stack trace from our installation of tomcat along with a few of our webapps defined.\n\nNode is starting in kerberos mode.\n2014-Jan-30 13:26:24.074 Starting Tomcat on HTTP port [64960].\n[2014-Jan-30 13:26:24.241] Domain service init method is called.\n[2014-Jan-30 13:26:44.916] Enabling master Core services.\n[2014-Jan-30 13:26:44.925] Domain Configuration service init method is called.\n[2014-Jan-30 13:26:47.015] Log service init method is called.\n[2014-Jan-30 13:26:47.081] User Management service init method is called.\n[2014-Jan-30 13:26:48.500] Edr service init method is called.\n[2014-Jan-30 13:26:49.760] Called the alert domain function init method.\n[2014-Jan-30 13:26:49.888] Licensing service init method is called.\n[2014-Jan-30 13:26:50.014] Monitoring service init method is called.\n[2014-Jan-30 13:26:50.105] Plugin Registry service init method is called.\n[2014-Jan-30 13:26:50.121] Master Core services enabled.\n[2014-Jan-30 13:26:50.728] LogServiceAgent init method is called.\nJan 31, 2014 4:16:59 PM org.apache.catalina.authenticator.SpnegoAuthenticator authenticate\nSEVERE: Unable to login as the service principal\njavax.security.auth.login.LoginException: Clock skew too great (37)\n\tat com.sun.security.auth.module.Krb5LoginModule.attemptAuthentication(Krb5LoginModule.java:763)\n\tat com.sun.security.auth.module.Krb5LoginModule.login(Krb5LoginModule.java:584)\n\tat sun.reflect.GeneratedMethodAccessor224.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:606)\n\tat javax.security.auth.login.LoginContext.invoke(LoginContext.java:784)\n\tat javax.security.auth.login.LoginContext.access$000(LoginContext.java:203)\n\tat javax.security.auth.login.LoginContext$4.run(LoginContext.java:698)\n\tat javax.security.auth.login.LoginContext$4.run(LoginContext.java:696)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.login.LoginContext.invokePriv(LoginContext.java:695)\n\tat javax.security.auth.login.LoginContext.login(LoginContext.java:594)\n\tat org.apache.catalina.authenticator.SpnegoAuthenticator.authenticate(SpnegoAuthenticator.java:214)\n\tat org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:574)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:100)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1041)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:603)\n\tat org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:310)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:744)\nCaused by: KrbException: Clock skew too great (37)\n\tat sun.security.krb5.KrbKdcRep.check(KrbKdcRep.java:95)\n\tat sun.security.krb5.KrbAsRep.decrypt(KrbAsRep.java:159)\n\tat sun.security.krb5.KrbAsRep.decryptUsingKeyTab(KrbAsRep.java:121)\n\tat sun.security.krb5.KrbAsReqBuilder.resolve(KrbAsReqBuilder.java:288)\n\tat sun.security.krb5.KrbAsReqBuilder.action(KrbAsReqBuilder.java:364)\n\tat com.sun.security.auth.module.Krb5LoginModule.attemptAuthentication(Krb5LoginModule.java:735)\n\t... 23 more\n\nJan 31, 2014 4:16:59 PM org.apache.catalina.authenticator.SpnegoAuthenticator authenticate\nSEVERE: Unable to login as the service principal\njavax.security.auth.login.LoginException: Clock skew too great (37)\n\tat com.sun.security.auth.module.Krb5LoginModule.attemptAuthentication(Krb5LoginModule.java:763)\n\tat com.sun.security.auth.module.Krb5LoginModule.login(Krb5LoginModule.java:584)\n\tat sun.reflect.GeneratedMethodAccessor224.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:606)\n\tat javax.security.auth.login.LoginContext.invoke(LoginContext.java:784)\n\tat javax.security.auth.login.LoginContext.access$000(LoginContext.java:203)\n\tat javax.security.auth.login.LoginContext$4.run(LoginContext.java:698)\n\tat javax.security.auth.login.LoginContext$4.run(LoginContext.java:696)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.login.LoginContext.invokePriv(LoginContext.java:695)\n\tat javax.security.auth.login.LoginContext.login(LoginContext.java:594)\n\tat org.apache.catalina.authenticator.SpnegoAuthenticator.authenticate(SpnegoAuthenticator.java:214)\n\tat org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:574)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:100)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1041)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:603)\n\tat org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:310)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:744)\nCaused by: KrbException: Clock skew too great (37)\n\tat sun.security.krb5.KrbKdcRep.check(KrbKdcRep.java:95)\n\tat sun.security.krb5.KrbAsRep.decrypt(KrbAsRep.java:159)\n\tat sun.security.krb5.KrbAsRep.decryptUsingKeyTab(KrbAsRep.java:121)\n\tat sun.security.krb5.KrbAsReqBuilder.resolve(KrbAsReqBuilder.java:288)\n\tat sun.security.krb5.KrbAsReqBuilder.action(KrbAsReqBuilder.java:364)\n\tat com.sun.security.auth.module.Krb5LoginModule.attemptAuthentication(Krb5LoginModule.java:735)\n\t... 23 more\n\nYes you are right. It should be logged at debug only when its an instance of GSSException. However in practice I have seen any other underlying reason for PrivilegedActionException because the Actions can only throw GSSExceptions.\n\nShould I still go ahead and ascertain the cause and log only when underlying cause is GSSException.", "id": 175207, "time": "2014-05-14T14:26:28Z", "creator": "arunav.sanyal91@gmail.com", "creation_time": "2014-05-14T14:26:28Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 56523, "is_private": false, "text": "The previous comment indicated when loginexception is caught. I think that needs to be addressed as well. However for this particular issue an example would be:- \n\nMay 06, 2014 3:22:56 PM org.apache.catalina.authenticator.SpnegoAuthenticator authenticate\nSEVERE: Unable to login as the service principal\njava.security.PrivilegedActionException: GSSException: Defective token detected (Mechanism level: GSSHeader did not find the right tag)\n at java.security.AccessController.doPrivileged(Native Method)\n at javax.security.auth.Subject.doAs(Subject.java:415)\n at org.apache.catalina.authenticator.SpnegoAuthenticator.authenticate(SpnegoAuthenticator.java:242)\n at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:573)\n at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:170)\n at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:98)\n at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:116)\n at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)\n at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1040)\n at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:607)\n at org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:315)\n at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n at java.lang.Thread.run(Thread.java:744)\nCaused by: GSSException: Defective token detected (Mechanism level: GSSHeader did not find the right tag)\n at sun.security.jgss.GSSHeader.<init>(GSSHeader.java:97)\n at sun.security.jgss.GSSContextImpl.acceptSecContext(GSSContextImpl.java:306)\n at sun.security.jgss.GSSContextImpl.acceptSecContext(GSSContextImpl.java:285)\n at sun.security.jgss.spnego.SpNegoContext.GSS_acceptSecContext(SpNegoContext.java:871)\n at sun.security.jgss.spnego.SpNegoContext.acceptSecContext(SpNegoContext.java:544)\n at sun.security.jgss.GSSContextImpl.acceptSecContext(GSSContextImpl.java:342)\n at sun.security.jgss.GSSContextImpl.acceptSecContext(GSSContextImpl.java:285)\n at org.apache.catalina.authenticator.SpnegoAuthenticator$AcceptAction.run(SpnegoAuthenticator.java:327)\n at org.apache.catalina.authenticator.SpnegoAuthenticator$AcceptAction.run(SpnegoAuthenticator.java:314)\n ... 14 more", "id": 175209, "time": "2014-05-14T14:33:15Z", "creator": "arunav.sanyal91@gmail.com", "creation_time": "2014-05-14T14:33:15Z", "attachment_id": null}, {"count": 4, "attachment_id": null, "bug_id": 56523, "is_private": false, "id": 175233, "time": "2014-05-14T21:36:15Z", "creator": "markt@apache.org", "creation_time": "2014-05-14T21:36:15Z", "tags": [], "text": "I think the LoginExceptions need to stay at error level. They indicate a general problem with SPNEGO auth and it is likely that any attempts to authenticate users will fail.\n\nThe exceptions triggered by user login failures should be reduced to debug. I have applied a patch that should do this to 8.0.x for 8.0.7 onwards and to 7.0.x for 7.0.54 onwards."}]