[{"count": 0, "tags": [], "bug_id": 55454, "attachment_id": null, "id": 169595, "creation_time": "2013-08-20T09:30:09Z", "time": "2013-08-20T09:30:09Z", "creator": "cdanzmann@gmail.com", "text": "possible related to 53353\n\nWhen having an invalid contenttype like:\n<jsp:directive.page language=\"java\" contentType=\"text/html;\"/>\n(note the trailing \";\") Tomcat throws a NullPointerException like this:\n\njava.lang.NullPointerException\n\torg.apache.tomcat.util.http.parser.HttpParser.parseMediaType(HttpParser.java:217)\n\torg.apache.tomcat.util.http.parser.MediaTypeCache.parse(MediaTypeCache.java:54)\n\torg.apache.catalina.connector.Response.setContentType(Response.java:805)\n\torg.apache.catalina.connector.ResponseFacade.setContentType(ResponseFacade.java:245)\n\tjavax.servlet.ServletResponseWrapper.setContentType(ServletResponseWrapper.java:123)\n\nAfter removing the extra \";\" or entering a charset like this:\n<jsp:directive.page language=\"java\" contentType=\"text/html; charset=UTF-8\"/>\nit works as expected.\n\nMy desired behaviour would be:\nDon't crash with a NPE.\nOther Tomcat versions seem to handly this different.", "is_private": false}, {"count": 1, "tags": [], "bug_id": 55454, "text": "I'm unable to reproduce this with a unit test on Tomcat 7.0.x or 8.0.x nor with a JSP with 7.0.x. I have tried with the example provided and with various combinations of whitespace around the ';'.\n\nIf you are sure this issue affects that latest stable Tomcat 7 release please re-open this issue and attach the simplest possible JSP that demonstrates the issue on a clean Tomcat 7 install of the latest stable release.", "id": 169596, "time": "2013-08-20T11:22:28Z", "creator": "markt@apache.org", "creation_time": "2013-08-20T11:22:28Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 55454, "attachment_id": null, "id": 169597, "creation_time": "2013-08-20T13:26:26Z", "time": "2013-08-20T13:26:26Z", "creator": "violetagg@apache.org", "text": "(In reply to Mark Thomas from comment #1)\n> I'm unable to reproduce this with a unit test on Tomcat 7.0.x or 8.0.x nor\n> with a JSP with 7.0.x. I have tried with the example provided and with\n> various combinations of whitespace around the ';'.\n> \n> If you are sure this issue affects that latest stable Tomcat 7 release\n> please re-open this issue and attach the simplest possible JSP that\n> demonstrates the issue on a clean Tomcat 7 install of the latest stable\n> release.\n\nMark\nI took the <tomcat7.0.x-trunk>/webapps/examples/jsp/jsp2/jspx/basic.jspx and change it like this <jsp:directive.page contentType=\"text/html;\" />\n\nThen I can reproduce the NPE.\n\norg.apache.tomcat.util.http.parser.HttpParser.parseMediaType(StringReader) \n\nrow -> 211 String attribute = readToken(input);\n\nthe attribute is null and the input is \"text/html;;charset=UTF-8\"", "is_private": false}, {"count": 3, "tags": [], "bug_id": 55454, "text": "What about if we do a change like this?\n\n--- org/apache/tomcat/util/http/parser/HttpParser.java\t(revision 1515761)\n+++ org/apache/tomcat/util/http/parser/HttpParser.java\t(working copy)\n@@ -210,11 +210,13 @@\n         while (lookForSemiColon == SkipConstantResult.FOUND) {\n             String attribute = readToken(input);\n \n+            String value = \"\";\n             if (skipConstant(input, \"=\") == SkipConstantResult.FOUND) {\n-                String value = readTokenOrQuotedString(input, true);\n+                value = readTokenOrQuotedString(input, true);\n+            }\n+\n+            if (attribute != null) {\n                 parameters.put(attribute.toLowerCase(Locale.ENGLISH), value);\n-            } else {\n-                parameters.put(attribute.toLowerCase(Locale.ENGLISH), \"\");\n             }\n \n             lookForSemiColon = skipConstant(input, \";\");", "id": 169598, "time": "2013-08-20T13:54:11Z", "creator": "violetagg@apache.org", "creation_time": "2013-08-20T13:54:11Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "markt@apache.org", "text": "Works for me.", "count": 4, "id": 169599, "time": "2013-08-20T14:00:41Z", "bug_id": 55454, "creation_time": "2013-08-20T14:00:41Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 55454, "attachment_id": null, "id": 169606, "creation_time": "2013-08-20T16:40:58Z", "time": "2013-08-20T16:40:58Z", "creator": "violetagg@apache.org", "text": "(In reply to Mark Thomas from comment #4)\n> Works for me.\nthanks\n\n\nFixed in trunk and 7.0.x and will be included in 7.0.43 onwards.", "is_private": false}]