[{"count": 0, "tags": [], "text": "Created attachment 24850\napr-1.3.9-assume-cloexec.patch\n\napr_file_open currently uses O_CLOEXEC when opening file's to avoid race conditions with the classic behavior of then using fcntl() to set the FD_CLOEXEC flag.  this is all find and dandy except that on newer operating systems, the two fcntl() calls are still made even if the open() function supports O_CLOEXEC.  when doing something like `svn commit` on a large tree, these translates to a huge number of useless syscalls.\n\nthis should be easy to avoid -- if we called open() with O_CLOEXEC, and the fcntl() get step shows that FD_CLOEXEC is already set, we cache the result in a local variable.  then in all future steps, we check the cached value before doing any fcntl() syscalls.\n\ngetting back to subversion, before my fix, a simple `svn st` looks something like this:\n......\nopen(\".svn/entries\", O_RDONLY|O_CLOEXEC) = 3\nfcntl(3, F_GETFD)                       = 0x1 (flags FD_CLOEXEC)\nfcntl(3, F_SETFD, FD_CLOEXEC)           = 0\nread(3, \"10\\n\\ndir\\n9382\\nsvn://nwd2cvs1.corp\"..., 80) = 80\nclose(3)                                = 0\nopen(\".svn/entries\", O_RDONLY|O_CLOEXEC) = 3\nfcntl(3, F_GETFD)                       = 0x1 (flags FD_CLOEXEC)\nfcntl(3, F_SETFD, FD_CLOEXEC)           = 0\nread(3, \"10\\n\\ndir\\n9382\\nsvn://nwd2cvs1.corp\"..., 4096) = 1187\nread(3, \"\", 4096)                       = 0\nread(3, \"\", 4096)                       = 0\nclose(3)                                = 0\nopen(\"vendors/.svn/entries\", O_RDONLY|O_CLOEXEC) = 3\nfcntl(3, F_GETFD)                       = 0x1 (flags FD_CLOEXEC)\nfcntl(3, F_SETFD, FD_CLOEXEC)           = 0\nread(3, \"10\\n\\ndir\\n9382\\nsvn://nwd2cvs1.corp\"..., 80) = 80\nclose(3)                                = 0\n......\n\nand after, we see:\n......\nopen(\".svn/entries\", O_RDONLY|O_CLOEXEC) = 3\nfcntl(3, F_GETFD)                       = 0x1 (flags FD_CLOEXEC)\nfcntl(3, F_SETFD, FD_CLOEXEC)           = 0\nread(3, \"10\\n\\ndir\\n9382\\nsvn://nwd2cvs1.corp\"..., 80) = 80\nclose(3)                                = 0\nopen(\".svn/entries\", O_RDONLY|O_CLOEXEC) = 3\nread(3, \"10\\n\\ndir\\n9382\\nsvn://nwd2cvs1.corp\"..., 4096) = 1187\nread(3, \"\", 4096)                       = 0\nread(3, \"\", 4096)                       = 0\nclose(3)                                = 0\nopen(\"vendors/.svn/entries\", O_RDONLY|O_CLOEXEC) = 3\nread(3, \"10\\n\\ndir\\n9382\\nsvn://nwd2cvs1.corp\"..., 80) = 80\nclose(3)                                = 0\n......\n\nwhen working on a repo with thousands of dirs/files, you can see how this easily makes a significant difference.", "attachment_id": 24850, "id": 133638, "creator": "vapier@gentoo.org", "time": "2010-01-15T14:14:52Z", "bug_id": 48557, "creation_time": "2010-01-15T14:14:52Z", "is_private": false}, {"count": 1, "tags": [], "text": "This wouldn't fail safe in the case where O_CLOEXEC was ignored (an earlier kernel).  I've change the code to avoid the second fcntl call in r905040.  Thanks for the report!", "attachment_id": null, "id": 134067, "creator": "jorton@redhat.com", "time": "2010-01-31T05:47:12Z", "bug_id": 48557, "creation_time": "2010-01-31T05:47:12Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 48557, "attachment_id": null, "is_private": false, "id": 134161, "time": "2010-02-02T20:37:51Z", "creator": "vapier@gentoo.org", "creation_time": "2010-02-02T20:37:51Z", "text": "sorry, i dont understand ... the has_o_cloexec variable is only set to 1 if the fcntl() get operation after the open(O_CLOEXEC) shows that O_CLOEXEC has been applied.  a running program wont be moved between systems on the fly."}, {"count": 3, "tags": [], "bug_id": 48557, "attachment_id": null, "id": 140766, "time": "2010-10-16T03:46:16Z", "creator": "vapier@gentoo.org", "creation_time": "2010-10-16T03:46:16Z", "is_private": false, "text": "please review my latest comments.  apr is not as optimal as it could be here."}, {"count": 4, "tags": [], "bug_id": 48557, "attachment_id": null, "id": 150629, "time": "2011-10-15T21:35:14Z", "creator": "sf@sfritsch.de", "creation_time": "2011-10-15T21:35:14Z", "is_private": false, "text": "r1183698, r1183730, r1183732, will be in 1.4.6"}, {"count": 5, "tags": [], "bug_id": 48557, "text": "Fixed in 1.4.6 and later releases", "id": 172596, "time": "2014-01-21T13:02:18Z", "creator": "trawick@apache.org", "creation_time": "2014-01-21T13:02:18Z", "is_private": false, "attachment_id": null}]