[{"count": 0, "tags": [], "bug_id": 20233, "attachment_id": null, "is_private": false, "id": 37793, "time": "2003-05-26T07:21:02Z", "creator": "p.maseres@wanadoo.fr", "creation_time": "2003-05-26T07:21:02Z", "text": "I tried to set up my web-app descriptor to use a form based authentication with \na confidential \"transport guarantee\", to make Tomcat switch the logon redirect \nfrom HTTP to HTTPS. In fact, i'd like to use SSL only for the protected part of \nthe application URLs.\nThe descriptor is accepted as is, but at runtime a \"Malformed URL\" exception is \nthrown, as if the code that processes the redirect was not SSL aware.\nThe SSL connector works right when request are addressed directly using HTTPS.\nThanks for any help...\nPS : i'd try to search for previous bugs about this feature, but i did'nt find \nany one."}, {"count": 1, "tags": [], "creator": "jonas.anden@aptilo.com", "attachment_id": null, "id": 37796, "time": "2003-05-26T07:38:21Z", "bug_id": 20233, "creation_time": "2003-05-26T07:38:21Z", "is_private": false, "text": "Set up your JRE with HTTPS support. Run java with\n-Djava.protocol.handler.pkgs=<protocol-handler>, or add the protocol handler to\nthe <jre>/lib/security/java.security file.\n\nIf you're using JSSE for SSL, the protocol handler is\n\"com.sun.net.ssl.internal.www.protocol\".\n\nSee JSSE docs for more info. Not a bug in tomcat."}, {"count": 2, "tags": [], "bug_id": 20233, "attachment_id": null, "is_private": false, "id": 37797, "time": "2003-05-26T07:58:01Z", "creator": "p.maseres@wanadoo.fr", "creation_time": "2003-05-26T07:58:01Z", "text": "My Tomcat is set up with SSL support, using the SUN JSSE (the SSL provider \nadded to the java.security file), and it works well when HTTPS requests are \naddressed directly by clients.\nThe problem only appears when the security is checked by the container and the \nCONFIDENTIAL transport is required by the descriptor, implying a protocol \nchange for the logon redirect. In fact, if the original request, i mean the \nrequest that leads the container to the logon redirect, is addressed in HTTPS, \nall work fine.\nI hope this will be more clear than my first explanation.\nThanks again."}, {"count": 3, "tags": [], "bug_id": 20233, "attachment_id": null, "text": "I think there are duplicates of this report, actually. I recommend testing with\n4.1.24.\nThere have been issues reported with the redirection when the default ports of\nthe protocols are not used, although the location header sent back to the client\nis correct (so that would look like a client issue).\n\nIf it still does not work, you'll have to post a test webapp with connector\nconfiguration (and the stack trace you get, also).", "id": 37813, "time": "2003-05-26T15:21:59Z", "creator": "remm@apache.org", "creation_time": "2003-05-26T15:21:59Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 20233, "attachment_id": 6507, "text": "Created attachment 6507\nBug in https for form authentication", "id": 37829, "time": "2003-05-27T09:19:50Z", "creator": "p.maseres@wanadoo.fr", "creation_time": "2003-05-27T09:19:50Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 20233, "attachment_id": null, "text": "As it has been suggested, i've tried a simple web-app with a similar \nconfiguration with 4.1.24.\nI'm afraid the bug is still in the version.\nI attached an archive to the case :\n- a trivial application files\n- the context xml file of this web-app\n- server.xml\n- the application detailed log file with the error trace\nI hope this will help you to help me !\nThanks again.", "id": 37830, "time": "2003-05-27T09:20:54Z", "creator": "p.maseres@wanadoo.fr", "creation_time": "2003-05-27T09:20:54Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 20233, "attachment_id": null, "text": "You carefully avoided mentioning which JDK release you were using, but the logs\nhelp.\nIf you're not using 1.4, you have to check that JSSE is correctly set as an\nextension of the JRE.\n\nThe mistake in the authenticator is that it's pretty much the only place in the\ncode which uses URL to build SSL URLs (and that requires JSSE). There's no good\nreason to do that IMO, and it should be removed.", "id": 37832, "time": "2003-05-27T09:43:46Z", "creator": "remm@apache.org", "creation_time": "2003-05-27T09:43:46Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 20233, "attachment_id": null, "text": "In fact, i use jdk 1.3.1, but i'm sure the jsse is installed correctly. As i \nsaid in a previous message, when all the application is accessed by https\n(because https works perfectly in all other cases !), no exception occurs in \nthe authentication redirection.\nHere the lines extracted from my java.security file :\n---\nsecurity.provider.1=sun.security.provider.Sun\nsecurity.provider.2=com.sun.rsajca.Provider\n\n# Ajout Philippe pour JSSE le 23/08/2001 11:20\nsecurity.provider.3=com.sun.net.ssl.internal.ssl.Provider\n---\nSo... if i can give anything else to help...\nThanks again.", "id": 37834, "time": "2003-05-27T10:11:20Z", "creator": "p.maseres@wanadoo.fr", "creation_time": "2003-05-27T10:11:20Z", "is_private": false}, {"count": 8, "attachment_id": null, "creator": "remm@apache.org", "is_private": false, "id": 37835, "time": "2003-05-27T10:15:23Z", "bug_id": 20233, "creation_time": "2003-05-27T10:15:23Z", "tags": [], "text": "I think it's not exactly the same. No part in Tomcat builds URL like that except\nthat code (and it's a mistake; I will fix it in TC 5). I haven't used JDK 1.3 in\na long time, so I don't know for sure, but I think there may be stuff which you\nneed to do to have https being recognized as a valid protocol with older JDKs."}, {"count": 9, "tags": [], "text": "Try running the following code in your JRE:\n\n<code>\n    java.security.Provider providers[] = java.security.Security.getProviders();\n    if( providers.length == 0 )\n    {\n      System.out.println( \"No security providers found\" );\n    }\n    else\n    {\n      for( int i = 0; i < providers.length; i++ )\n      {\n        String name = providers[i].getName();\n        System.out.println( \"Security provider found: \" + name );\n\tif( name.equals( \"SunJSSE\" ) )\n        {\n          System.out.println( \"I've got Sun JSSE\" );\n        }\n      }\n    }\n</code>\n\nThat should verify that the JSSE is working as it should, and you should then be\nable to build HTTPS URLS using the URL object.\n", "attachment_id": null, "bug_id": 20233, "id": 37836, "time": "2003-05-27T11:01:13Z", "creator": "jonas.anden@aptilo.com", "creation_time": "2003-05-27T11:01:13Z", "is_private": false}, {"count": 10, "tags": [], "creator": "p.maseres@wanadoo.fr", "attachment_id": null, "is_private": false, "id": 37837, "time": "2003-05-27T12:13:25Z", "bug_id": 20233, "creation_time": "2003-05-27T12:13:25Z", "text": "I add a jsp page with the following code to test the security providers as \nsuggested by the previous message. As expected, the 3 providers i declared in \nmy security file are in the list, and among them the famous SunJSSE. I don't \nforward the result page, so please trust my \"parole\" !\nAs my test, a jsp page, runs in the web-apps classloading context, perhaps it \nmeans the problem comes from the separation of the private classes of Catalina \nfrom the global context. I repeat it once more : all the HTTPS features seem to \nwork fine except the authentication redirect when a secured URL is requested.\nFor more data, just ask me...\nThanks again.\n\nPS : don't care about the poor jsp style !\n\n------- JSP -------\n<%@ page session=\"false\"%>\n<%@ page import=\"java.security.*\"%>\n<%@ page import=\"java.util.*\"%>\n<html>\n\t<head>\n\t\t<title>SECURITY PROVIDERS</title>\n\t</head>\n\t<body>\n\t\t<b><p>Security Prividers</p></b>\n\t\t<table width=\"100%\" border=\"1\">\n<%\n\tjava.security.Provider providers[] = java.security.Security.getProviders\n();\n\tfor(int x = 0; x < providers.length; x++) {\n\t\tProvider p = providers[x];\n%>\n\t\t\t<tr>\n\t\t\t\t<td valign=\"top\"><%=p.getName()%></td>\n\t\t\t\t<td valign=\"top\"><%=p.getInfo()%></td>\n\t\t\t\t<td valign=\"top\"><%=p.getVersion()%></td>\n\t\t\t\t<td valign=\"top\">\n\t\t\t\t\t<ul>\n<%\n\t\tfor (Iterator i = p.entrySet().iterator(); i.hasNext(); ) {\n\t\t\tMap.Entry e = (Map.Entry) i.next();\n%>\n\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t<%=e.getKey()%> = <%\n=e.getValue()%>\n\t\t\t\t\t\t</li>\n<%\n\t\t}\n%>\n\t\t\t\t\t</ul>\n\t\t\t\t</td>\n\t\t\t</tr>\n<%\n\t}\n%>\n\t\t</table>\n\t</body>\n</html>\n------- end -------"}, {"count": 11, "tags": [], "bug_id": 20233, "attachment_id": null, "is_private": false, "id": 37838, "time": "2003-05-27T13:16:22Z", "creator": "remm@apache.org", "creation_time": "2003-05-27T13:16:22Z", "text": "I think the real test is to try building a https URL (since that's what is\nfailing in the Tomcat code; use new URL(\"https\", ...)). If JSSE is correctly\nsetup, this will succeed, otherwise, it will not. If you cannot get it to work,\nyou should plan upgrading to JDK 1.4.0+.\n\nI'll commit a patch to Tomcat 5 to remove the use of new URL, which is clearly a\nmistake.\n\nThis issue is not a Tomcat bug, so I'm closing the report.\n"}, {"count": 12, "tags": [], "bug_id": 20233, "attachment_id": null, "text": "After my last test about installed security providers, i had doubts about the \nJSSE set up, and i quickly read again the install notes file. It clearly says \nhow install the package as a JRE extension, what i did, and how to declare the \nsecurity provider by a durable way adding it in the java.security file, what i \ndid too. But, as Jonas Anden suggested in a first answer, none of these \noperations implies an automatic set up of the protocol handlers. As all my \nserver https activity seem ok, i forgot it. I added the required -D option to \nthe Tomcat java command, and my HTTPS URL are now \"handled\" without error !\nSo, sorry for my mistake.\nNow, i have another problem with port numbers during the multiple redirections \nthat occurs in the authentication phase, with stange mixing of http/8443 and \nhttps/8080. As i need to analyse the log details before, i think that, except \nif somebody has some well-known issue about that, the present case should be \nclosed, and i should post a new one latter.\nThanks again and again...\n", "id": 37839, "time": "2003-05-27T13:25:36Z", "creator": "p.maseres@wanadoo.fr", "creation_time": "2003-05-27T13:25:36Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 20233, "attachment_id": null, "is_private": false, "id": 37841, "time": "2003-05-27T13:49:01Z", "creator": "remm@apache.org", "creation_time": "2003-05-27T13:49:01Z", "text": "You need to make sure you are using Tomcat 4.1.24. There are open reports about\nissues when not using the default ports (please do not open a new one)."}]