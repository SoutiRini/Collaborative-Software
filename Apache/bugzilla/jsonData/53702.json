[{"text": "Created attachment 29215\nModified files from the ROOT webapp\n\nAccording to XSDs (jsp_2_0.xsd, jsp_2_1.xsd, jsp_2_2.xsd), the \"url-pattern\" can occur more than once in the same \"jsp-property-group\".\n\n[[[\n  <xsd:complexType name=\"jsp-property-groupType\">\n...\n      <xsd:element name=\"url-pattern\"\n                   type=\"javaee:url-patternType\"\n                   maxOccurs=\"unbounded\"/>\n]]]\n\nThere are three places where the \"jsp-property-group\" element is represented by an object in Tomcat:\n\na) in Jasper, o.a.jasper.compiler.JspConfig$JspPropertyGroup\nb) in Catalina, o.a.catalina.deploy.JspPropertyGroup\nc) in Servlet 3.0 API, javax.servlet.descriptor.JspPropertyGroupDescriptor (implemented by o.a.c.core.ApplicationJspPropertyGroupDescriptor)\n\nThe implementations in a) and c) are correct ones,  but in b) the collection of url patterns is mistakenly represented by a single value and setUrlPattern() method.\n\nAs the \"setUrlPattern\" method is called by digester (configured in o.a.c.startup.WebRuleSet), only the last url-pattern value survives.\n\n\n\nThe observable consequences of this issue:\n===========================================\n1. Merged web.xml is reproduced and passed to Jasper incorrectly.\n\n(Currently it is passed only when metadata-complete=\"false\" or absent, as I noted in Re:r1371995 on dev@, which is a different issue but it hides the effect of this one).\n\n2. A known feature is that the paths mentioned in jsp-property-group are implicitly mapped to the JspServlet. Due to this issue this mapping occurs only for the last url-pattern.\n(in WebXml#configureContext())\n\n\nTo reproduce in current 7.0.x (7.0.29 is affected):\n====================================================\n1. Unpack attached archive and put the files into the ROOT webapp.\nThe files are context.xml with <Context logEffectiveWebXml=\"true\"/>\nand web.xml without metadata-compete attribute and adding the following:\n[[[\n  <jsp-config>\n    <jsp-property-group>\n      <url-pattern>*.foo</url-pattern>\n      <url-pattern>*.bar</url-pattern>\n      <is-xml>true</is-xml>\n    </jsp-property-group>\n  </jsp-config>\n]]]\n\n2. Start Tomcat and look into the \"catalina.`date`.log\" file. The merged web.xml should have been dumped there. Look for the \"jsp-property-group\" element.\nActual result:\n\n[[[\n  <jsp-config>\n    <jsp-property-group>\n      <url-pattern>*.bar</url-pattern>\n      <is-xml>true</is-xml>\n    </jsp-property-group>\n  </jsp-config>\n]]]\n\nExpected result: both *.foo and *.bar should be mentioned.\n\n\nTomcat 6 does not have this issue, because there is no such object in Catalina there. The digester configured in WebRuleSet calls StandardContext.addJspMapping(..), which is additive.", "tags": [], "creator": "knst.kolinko@gmail.com", "is_private": false, "count": 0, "id": 161306, "time": "2012-08-12T14:54:17Z", "bug_id": 53702, "creation_time": "2012-08-12T14:54:17Z", "attachment_id": 29215}, {"count": 1, "tags": [], "bug_id": 53702, "is_private": false, "id": 161439, "attachment_id": null, "creator": "markt@apache.org", "creation_time": "2012-08-15T20:41:15Z", "time": "2012-08-15T20:41:15Z", "text": "Fixed in trunk and 7.0.x and will be included in 7.0.30 onwards."}]