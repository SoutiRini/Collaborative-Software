[{"attachment_id": 25667, "tags": [], "bug_id": 49528, "text": "Created attachment 25667\nServlet 3.0 isAsyncStarted testcase\n\nIn the attached example, an async request is created, but within a Runnable started using AsyncContext.start() the isAsyncStarted() returns false. \n\nThis conflicts with the servlet 3.0 specification. Quoting chapter \"2.3.3.3 Asynchronous processing\" : \"\n  public boolean isAsyncStarted() - Returns true if async processing\n  has started on this request, and false otherwise. If this request has been\n  dispatched using one of the AsyncContext.dispatch methods since it was\n  put in asynchronous mode, or a call to AsynContext.complete is made, this\n  method returns false.\n\"\n\nThis output is generated by Tomcat 7.0.0:\n\nStart async()\nDispatching start()\nrequest.isAsyncStarted()1true\nReturning from doGet()\nrequest.isAsyncStarted()2false\nBefore sleep()\nAfter sleep()\nrequest.isAsyncStarted()3false\nReturning from run()\nrequest.isAsyncStarted()4false\n\nThe following output is what we would expect and what Jetty v8.0 generates:\n\nStart async()\nDispatching start()\nrequest.isAsyncStarted()1true\nReturning from doGet()\nrequest.isAsyncStarted()2true\nBefore sleep()\nAfter sleep()\nrequest.isAsyncStarted()3true\nReturning from run()\nrequest.isAsyncStarted()4false", "count": 0, "id": 138030, "time": "2010-06-30T06:32:11Z", "creator": "pieter@emweb.be", "creation_time": "2010-06-30T06:32:11Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 49528, "text": "Please could you confirm that the test case is provided under the terms of section 5 of the Apache License, v2 and that you have the right to provide this code under those terms. The header in the test case seems to suggest otherwise.", "id": 138096, "time": "2010-07-02T14:32:27Z", "creator": "markt@apache.org", "creation_time": "2010-07-02T14:32:27Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "text": "Check Revision 960283 and review my  test case TestAsyncContextImpl.\n\nFix is proposed at tomcat 7.0.1\n\nMany thanks to report this bug.\nPeter", "attachment_id": null, "bug_id": 49528, "id": 138125, "time": "2010-07-03T18:51:16Z", "creator": "pr@objektpark.de", "creation_time": "2010-07-03T18:51:16Z", "is_private": false}, {"count": 3, "attachment_id": null, "creator": "markt@apache.org", "text": "The fix breaks the Servlet TCK and therefore will have to be reverted.", "id": 138126, "time": "2010-07-04T11:22:01Z", "bug_id": 49528, "creation_time": "2010-07-04T11:22:01Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "creator": "markt@apache.org", "text": "I have reverted the original fix and applied a new fix that fixes the issue described here and still passes the Servlet TCK.", "id": 138133, "time": "2010-07-04T16:39:54Z", "bug_id": 49528, "creation_time": "2010-07-04T16:39:54Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 49528, "is_private": false, "count": 5, "id": 138154, "time": "2010-07-05T03:55:31Z", "creator": "pieter@emweb.be", "creation_time": "2010-07-05T03:55:31Z", "text": "(In reply to comment #1)\n> Please could you confirm that the test case is provided under the terms of\n> section 5 of the Apache License, v2 and that you have the right to provide this\n> code under those terms. The header in the test case seems to suggest otherwise.\n\nYes, that's fine."}, {"attachment_id": null, "tags": [], "bug_id": 49528, "text": "(In reply to comment #4)\n> I have reverted the original fix and applied a new fix that fixes the issue\n> described here and still passes the Servlet TCK.\n\nThanks for the quick fix! I'll give it a try.", "count": 6, "id": 138155, "time": "2010-07-05T03:56:31Z", "creator": "pieter@emweb.be", "creation_time": "2010-07-05T03:56:31Z", "is_private": false}, {"count": 7, "tags": [], "creator": "pieter@emweb.be", "attachment_id": null, "id": 138167, "time": "2010-07-05T09:06:05Z", "bug_id": 49528, "creation_time": "2010-07-05T09:06:05Z", "is_private": false, "text": "(In reply to comment #6)\n> (In reply to comment #4)\n> > I have reverted the original fix and applied a new fix that fixes the issue\n> > described here and still passes the Servlet TCK.\n> \n> Thanks for the quick fix! I'll give it a try.\n\nDear All,\n\nwhen I run the test case on the latest version of the tomcat trunk,\nI get the following output, which looks like the Runnable we try to start is never executed:\n\nStart async()\nDispatching start()\nrequest.isAsyncStarted()1true\nReturning from doGet()"}, {"count": 8, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 138177, "time": "2010-07-05T12:48:17Z", "bug_id": 49528, "creation_time": "2010-07-05T12:48:17Z", "is_private": false, "text": "Yep. The test only looked at the correctness of the return values present, it didn't check all the expected return values were present. I have fixed the test case and am looking at the additional changes required now. Should be quite quick."}, {"count": 9, "tags": [], "text": "Sorry about that. Fixed in trunk. Will be in 7.0.1 onwards.", "attachment_id": null, "bug_id": 49528, "id": 138186, "time": "2010-07-05T16:51:52Z", "creator": "markt@apache.org", "creation_time": "2010-07-05T16:51:52Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 49528, "attachment_id": null, "id": 138189, "time": "2010-07-05T17:15:08Z", "creator": "pieter@emweb.be", "creation_time": "2010-07-05T17:15:08Z", "is_private": false, "text": "(In reply to comment #9)\n> Sorry about that. Fixed in trunk. Will be in 7.0.1 onwards.\n\nThanks a lot for the quick response! \nI'll retest from the trunk tomorrow morning."}, {"count": 11, "tags": [], "bug_id": 49528, "attachment_id": null, "id": 138251, "time": "2010-07-07T09:25:06Z", "creator": "pieter@emweb.be", "creation_time": "2010-07-07T09:25:06Z", "is_private": false, "text": "(In reply to comment #10)\n> (In reply to comment #9)\n> > Sorry about that. Fixed in trunk. Will be in 7.0.1 onwards.\n> \n> Thanks a lot for the quick response! \n> I'll retest from the trunk tomorrow morning.\n\nthis problem appears to be fixed, thanks a lot!\n\nHowever, I ran into another problem,\nwhich I reported as new bug (49567)."}]