[{"count": 0, "tags": [], "bug_id": 42573, "attachment_id": null, "is_private": false, "id": 104019, "time": "2007-06-03T23:52:04Z", "creator": "stevegy@gmail.com", "creation_time": "2007-06-03T23:52:04Z", "text": "I have to use a iis6 + jboss4.0.5(tomcat 5.5.20) to serve our web site(both with\njsp and asp). The mod_jk is 1.2.23(isapi_redirect.dll) and the normal html file\nlooks fine. \nI have some privilege restricted image files that i should send with the\nservlet(response.write...) after the privilege check had be done. So, i use the\nServletOutputStream to write image file's byte array to the remote browser. But\ni find the image file transfered by the jk oftentimes corrupted(error occurs\nabout 10%). I test this servlet file download on http connector 8080 and this\nkind of data error has never been shown. When the file size is 100K-200K, this\nerror is more easy to re-produce on my windows machine and the server log\nnothing exceptions or errors.\n\nprivate void writeFileToResponse(FileInputStream fi, HttpServletResponse\nresponse, Attachment af, int filelength)\n    throws IOException {\n        String ContentType = af.getMime();\n        \n        int C_BUFSIZE = 1024*32;\n        byte[] buf = new byte[C_BUFSIZE];\n        \n       \nresponse.setContentType((ContentType==null)?\"application/octstream\":ContentType);\n        response.setContentLength(filelength);\n        response.setHeader(\"Content-Disposition\", \"inline; filename=\" + fname );\n        ServletOutputStream bout = response.getOutputStream();\n        try {\n            int i = 0;\n            while((i = fi.read(buf)) > 0) {\n                // if the user leave, then break the loop\n               bout.write(buf, 0, i);\n            }\n            bout.flush();\n        } catch(IOException ioe) {\n            //  write to the client error or read file error, but do not log\nanything\n        }\n        finally {\n            //bout.close();\n        }\n        \n    }"}, {"count": 1, "tags": [], "bug_id": 42573, "attachment_id": null, "text": "If you turn on debug level logging in mod_jk and replicate this bug, someone may\nbe able to tell what's going on - there isn't enough in this report to replicate\nthe issue (given that it's almost certainly environment specific).\nA WireShark trace of the traffic between Apache and the browser when the error\noccurs would also be great.\n\nIt could also be the bug in your while loop (if fi.read ever returns 0 bytes\nread, then your loop will terminate without writing the entire image).", "id": 104674, "time": "2007-06-25T01:55:33Z", "creator": "Tim.Whittington@orionhealth.com", "creation_time": "2007-06-25T01:55:33Z", "is_private": false}, {"count": 2, "tags": [], "creator": "rainer.jung@kippdata.de", "text": "Could you please check, if the problem is fixed in the new version 1.2.26?", "id": 112424, "time": "2008-01-01T21:39:22Z", "bug_id": 42573, "creation_time": "2008-01-01T21:39:22Z", "is_private": false, "attachment_id": null}, {"count": 3, "attachment_id": null, "bug_id": 42573, "text": "No response to Tim's original point that the sample code contains a bug and no response to Rainer's request to try the latest mod_jk.\n\nI am closing this as INVALID on the basis of the bug in the sample code.", "id": 120175, "time": "2008-08-28T07:13:28Z", "creator": "markt@apache.org", "creation_time": "2008-08-28T07:13:28Z", "tags": [], "is_private": false}]