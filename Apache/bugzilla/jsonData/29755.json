[{"count": 0, "tags": [], "bug_id": 29755, "text": "In short, we are running several large websites that have banner advertisements.\nA friendly way to serve banners is to configure the IMG SRC tags so that\nthey refer to an apache server using mod_usertrack and mod_rewrite.\nThis way, we get a decently reliable visitor log and banner exposure log.\nThe redirect points to the \"real\" image server that gives long expire times\nso that the browser does not have to download each banner every time,\nbut we still get nice logs for our advertisers.\n\nThe problem that we ran into, is that whenever you make a redirect from\nmod_rewrite, the fixups hooks stop and mod_usertrack is never called.\nSo we don't get cookies logged when http status is 302.\n\nI fixed this quite simply:\n\nin mod_usertrack, modify the function\n\n--- 8< ---\nstatic void register_hooks(apr_pool_t *p)\n{\n    ap_hook_fixups(spot_cookie,NULL,NULL,APR_HOOK_MIDDLE);\n}\n--- 8< ---\n\nto be\n\n--- 8< ---\nstatic void register_hooks(apr_pool_t *p)\n{\n    ap_hook_fixups(spot_cookie,NULL,NULL,APR_HOOK_FIRST);\n}\n--- 8< ---\n\n...and make sure that mod_usertrack is loaded before mod_rewrite,\nif using dynamic modules. We use RHEL3ES, and the apache distributed\nby Red Hat is using dynamic modules for almost everything.\n\nI would be very pleased if stock apache's mod_usertrack\nwould use APR_HOOK_FIRST in the future. I don't think\nthis small but important modification would break anything. :-o\n\nP.S.\n\nrequest.c says\n\nAP_IMPLEMENT_HOOK_RUN_ALL(int,fixups,\n                          (request_rec *r), (r), OK, DECLINED)\n\nit took some time for me to find out that \"RUN_ALL\" here\ndoes not mean \"run all hooks in any case\". It means actually\n\"run every hook until one of them does not return DECLINED or OK\".\nSheesh.", "id": 59757, "time": "2004-06-23T09:49:13Z", "creator": "sjm@almamedia.fi", "creation_time": "2004-06-23T09:49:13Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 29755, "text": "Changed in 2.1 CVS.\n\nThanks for using Apache!", "id": 66416, "time": "2004-11-04T03:28:58Z", "creator": "chip@force-elite.com", "creation_time": "2004-11-04T03:28:58Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "sjm@almamedia.fi", "is_private": false, "text": "Uh, the following hit us:\n\nhttp://ken.coar.org/burrow/index?entry=511\n\nin short, mod_usertrack really should set the cookie\nheader in err_headers_out, NOT headers_out.\n\nThe headers in headers_out will not get sent\nif the request ends in a redirect. Sigh.\n\nFurthermore, register_hooks should look like this:\n\nstatic void register_hooks(apr_pool_t *p)\n{\n    /* fixup before mod_proxy, so that the proxied url will not\n     * be escaped accidentally by our fixup.\n     */\n    static const char * const aszSucc[]={ \"mod_rewrite.c\", \"mod_proxy.c\",\n                                          \"mod_alias.c\", NULL };\n    ap_hook_fixups(spot_cookie, NULL, aszSucc, APR_HOOK_FIRST);\n}", "id": 66957, "time": "2004-11-15T21:47:36Z", "bug_id": 29755, "creation_time": "2004-11-15T21:47:36Z", "attachment_id": null}, {"count": 3, "text": "Sigh.\n\nI just checked Apache 2.0.52 source. It should be fixed.\nA simple and suitable patch is attached below:\n\n*** mod_usertrack_orig.c        2004-11-15 22:54:20.000000000 +0200\n--- mod_usertrack.c     2004-11-15 22:57:57.000000000 +0200\n***************\n*** 145,151 ****\n                                   NULL);\n      }\n  \n!     apr_table_addn(r->headers_out,\n                     (dcfg->style == CT_COOKIE2 ? \"Set-Cookie2\" : \"Set-Cookie\"),\n                     new_cookie);\n      apr_table_setn(r->notes, \"cookie\", apr_pstrdup(r->pool, cookiebuf));   /*\nlog first time */\n--- 145,151 ----\n                                   NULL);\n      }\n  \n!     apr_table_addn(r->err_headers_out,\n                     (dcfg->style == CT_COOKIE2 ? \"Set-Cookie2\" : \"Set-Cookie\"),\n                     new_cookie);\n      apr_table_setn(r->notes, \"cookie\", apr_pstrdup(r->pool, cookiebuf));   /*\nlog first time */\n***************\n*** 439,445 ****\n  \n  static void register_hooks(apr_pool_t *p)\n  {\n!     ap_hook_fixups(spot_cookie,NULL,NULL,APR_HOOK_MIDDLE);\n  }\n  \n  module AP_MODULE_DECLARE_DATA usertrack_module = {\n--- 439,450 ----\n  \n  static void register_hooks(apr_pool_t *p)\n  {\n!     /* fixup before mod_proxy, so that the proxied url will not\n!      *      * escaped accidentally by our fixup.\n!      */\n!     static const char * const aszSucc[]={ \"mod_rewrite.c\", \"mod_proxy.c\",\n!                                         \"mod_alias.c\", NULL };\n!     ap_hook_fixups(spot_cookie, NULL, aszSucc, APR_HOOK_FIRST);\n  }\n  \n  module AP_MODULE_DECLARE_DATA usertrack_module = {\n", "bug_id": 29755, "is_private": false, "id": 66964, "time": "2004-11-15T22:04:17Z", "creator": "sjm@almamedia.fi", "creation_time": "2004-11-15T22:04:17Z", "tags": [], "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 29755, "text": "This has beend fixed in 2.1.x, and not backported to 2.0.x.  I didn't feel it\nwas important enough to backport to 2.0.x.", "id": 73362, "time": "2005-04-06T23:04:42Z", "creator": "chip@force-elite.com", "creation_time": "2005-04-06T23:04:42Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 29755, "attachment_id": null, "text": "\nPart of this fix has not made it to 2.2 or 2.3. Fix needed:\n\n\n149c149\n<     apr_table_addn(r->err_headers_out,\n---\n>     apr_table_addn(r->headers_out,\n442,447c442\n<     /* fixup before mod_proxy, so that the proxied url will not\n<      *      * escaped accidentally by our fixup.\n<     */\n<     static const char * const aszSucc[]={ \"mod_rewrite.c\", \"mod_proxy.c\",\n<                                          \"mod_alias.c\", NULL };\n<     ap_hook_fixups(spot_cookie,NULL,aszSucc,APR_HOOK_FIRST);\n---\n>     ap_hook_fixups(spot_cookie,NULL,NULL,APR_HOOK_FIRST);", "id": 145192, "time": "2011-03-22T13:05:14Z", "creator": "plantin@cobaltgroup.com", "creation_time": "2011-03-22T13:05:14Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "covener@gmail.com", "is_private": false, "count": 6, "id": 148439, "time": "2011-08-06T23:16:47Z", "bug_id": 29755, "creation_time": "2011-08-06T23:16:47Z", "text": "Applied with modifications as http://svn.apache.org/viewvc?rev=1154620&view=rev"}, {"count": 7, "tags": [], "bug_id": 29755, "attachment_id": null, "is_private": false, "id": 195741, "time": "2016-12-31T00:19:59Z", "creator": "covener@gmail.com", "creation_time": "2016-12-31T00:19:59Z", "text": "Fixed in 2.4.x and later"}]