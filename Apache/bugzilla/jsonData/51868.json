[{"count": 0, "tags": [], "creator": "tedam@mail.ru", "text": "Created attachment 27558\nScenario for reproducing error\n\nIn some cases thread writes to log multiple exceptions (about 10MB per second).\nError occured in some combinations of controllers (presense/absence of \"Once Only\" and \"If\" controllers, beanshell samplers etc\nSimple scenario for reproducing have such structure:\nTestPlan\n+ThreadGroup (Start next loop on error)\n+BeanShellSampler (Some preparations)\n++Loop(Forever)\n+++HTTPRequests\n+++BeanShellSampler(Using data from preparations)\n+++IfController(condition based on beanshell result)\n++++SomeActions\nIf no any errors in samplers, scanario executed properly.\nIf error occured, then huge exceptions in log, no any further samplers execution, thread remain active\nIf any of following conditions become true, no such count of exceptions in log writed:\n1) \"If contorller\" named \"Validation based of beanshell values\" disabled\n2) loop has definite count of loops (not \"forever\")\n3) absense of \"BeanShell\" samplers\n\nI prepared scenario for reproducing.\nFirst, run it as is, then see log (all sampler must be successfull).\nThen, enable step \"(fail) Load page (loop)\" and run again. See log - GBs of exceptions\nP.S. this example is one of many cases for repeating this error. Mostly simplified", "id": 149610, "time": "2011-09-22T08:39:39Z", "bug_id": 51868, "creation_time": "2011-09-22T08:39:39Z", "is_private": false, "attachment_id": 27558}, {"count": 1, "tags": [], "bug_id": 51868, "text": "Created attachment 27559\nExample of jmeter.log\n\njmeter.log attached", "id": 149611, "attachment_id": 27559, "creator": "tedam@mail.ru", "creation_time": "2011-09-22T08:40:30Z", "time": "2011-09-22T08:40:30Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 51868, "text": "2011/09/22 12:36:56 ERROR - jmeter.control.IfController: missing ; before statement (<cmd>#1) org.mozilla.javascript.EvaluatorException: missing ; before statement (<cmd>#1)\n\nis caused by a syntax error in the JMX file\n\nTry disabling them in turn until the problem disappears, and then double-check the variables don't contain spaces etc. - use the Debug sampler.", "id": 149612, "attachment_id": null, "creator": "sebb@apache.org", "creation_time": "2011-09-22T09:18:41Z", "time": "2011-09-22T09:18:41Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 51868, "attachment_id": null, "text": "Please look at attachment. Error occured ONLY if option \"Start next loop on error\" set. Before error in sample all actions were successfull and all samplers after failed sampler must not be executed. But if ni any errors in loop occured, all work properly", "id": 149613, "time": "2011-09-22T09:41:30Z", "creator": "tedam@mail.ru", "creation_time": "2011-09-22T09:41:30Z", "is_private": false}, {"count": 4, "text": "Have you tried using the Debug Sampler to see what the variables are?\n\nHave you tried finding out which If Controller is involved?\n\nHave you tried enabling debug logging for the If Controller?\n\nThis will help narrow down the issue.", "bug_id": 51868, "is_private": false, "id": 149615, "time": "2011-09-22T10:25:19Z", "creator": "sebb@apache.org", "creation_time": "2011-09-22T10:25:19Z", "tags": [], "attachment_id": null}, {"count": 5, "text": "(In reply to comment #4)\n> Have you tried using the Debug Sampler to see what the variables are?\n  Yes. If no any errors in sample, variables calculated in BeanShell and used in IFC are valid  (see screenshot)\n\n> Have you tried finding out which If Controller is involved?\n  There is the only IFC in scenario. It work properly, if errors absent. And it must not be validated, if error occured at any sampler before IFC\n\n> Have you tried enabling debug logging for the If Controller?\n  In jmeter.properties I set everything to DEBUG. Now I see 2 errors here - one about recirculation (51865) and another - exception. IFC try to validate undefined value (getCondition() : [${spent_time}>5000]). Yes, it is not valid. But IFC must not be processed at all, because value calculating for IFC and IFC are at the end of loop. After error first sample of loop must be processed, is it?\nLog attached\n \n> This will help narrow down the issue.", "bug_id": 51868, "attachment_id": null, "id": 149620, "time": "2011-09-22T11:03:17Z", "creator": "tedam@mail.ru", "creation_time": "2011-09-22T11:03:17Z", "tags": [], "is_private": false}, {"count": 6, "tags": [], "bug_id": 51868, "text": "Created attachment 27560\nVariables", "id": 149621, "attachment_id": 27560, "creator": "tedam@mail.ru", "creation_time": "2011-09-22T11:04:02Z", "time": "2011-09-22T11:04:02Z", "is_private": false}, {"count": 7, "text": "Created attachment 27561\nDebug log", "bug_id": 51868, "is_private": false, "id": 149622, "time": "2011-09-22T11:04:43Z", "creator": "tedam@mail.ru", "creation_time": "2011-09-22T11:04:43Z", "tags": [], "attachment_id": 27561}, {"count": 8, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "text": "Hello,\nYour second BeanShell Sampler has an error, it should be:\nvars.put(\"spent_time\",execution_time.toString());\n\nlook in jmeter.log you have:\n2011/10/01 17:05:14 ERROR - jmeter.util.BeanShellInterpreter: Error invoking bsh method: eval\tSourced file: inline evaluation of: ``current_time = System.currentTimeMillis(); start_time = vars.get(\"start_time\");  . . . '' : Error in method invocation: Method put( java.lang.String, long ) not found in class'org.apache.jmeter.threads.JMeterVariables' \n2011/10/01 17:05:16 WARN  - jmeter.protocol.java.sampler.BeanShellSampler: org.apache.jorphan.util.JMeterException: Error invoking bsh method: eval\tSourced file: inline evaluation of: ``current_time = System.currentTimeMillis(); start_time = vars.get(\"start_time\");  . . . '' : Error in method invocation: Method put( java.lang.String, long ) not found in class'org.apache.jmeter.threads.JMeterVariables' \n\n\nRegarding the issue, this is my analysis, \nwhen error occurs in either HTTP Sampler or bean, as Start NExt loop is configured we enter this part of code of JMeterThread:\n\nsam = controller.next(); // need perfom a until loop for special case (tc as parent)\n\nwhile (sam != null && !sam.equals(firstSampler)) { // while the thread is NOT on the begining of the tree\n    sam = controller.next();\n}\n\nnext controller is IfController , I think we enter a known issue:\n\"The If Controller may cause an infinite loop if the condition is always false from the first iteration\"\n\n\nAnyway, Maybe IfController#evaluateCondition should throw an exception when condition has a evaluation error instead of returning false, it would stop test and let you know your condition is wrong.\nRegards\nPhilippe", "id": 150020, "time": "2011-10-01T15:27:51Z", "bug_id": 51868, "creation_time": "2011-10-01T15:27:51Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 51868, "text": "Created attachment 27658\nFix to bad handling of error in Condition", "id": 150021, "time": "2011-10-01T16:05:31Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-10-01T16:05:31Z", "is_private": false, "attachment_id": 27658}, {"count": 10, "tags": [], "bug_id": 51868, "attachment_id": null, "text": "Sorry I think I read too fast\nPart of my analysis is wrong.\nI recap:\nWhen an error occurs (enabled (fail) Load page (loop)) JMeterThread will enter this part of code:\nsam = controller.next(); // need perfom a until loop for special case (tc as\nparent)\n\nwhile (sam != null && !sam.equals(firstSampler)) { // while the thread is NOT\non the begining of the tree\n    sam = controller.next();\n}\n\nIt means if will for IfController execute the condition which is wrong due to the fact that BeanShell sampler just before did not run, so spend_time won't be in variables.\n\nThat explains the logs.\nRegards\nPhilippe", "id": 150022, "time": "2011-10-01T16:23:56Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-10-01T16:23:56Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 51868, "text": "A fix to issue would be to flag we are in a restartNextLoop\ntry{\n                                JMeterContextService.getContext().setIsWithinRestartNextLoop();\n                                // Last not ok. start get the begining of the tree\n                                sam = controller.next(); // need perfom a until loop for special case (tc as parent)\n                                while (sam != null && !sam.equals(firstSampler)) { // while the thread is NOT on the begining of the tree\n                                    sam = controller.next();\n                                }\n                                // At this point: begining tree, thus Last must Ok\n                                threadContext.getVariables().put(LAST_SAMPLE_OK, TRUE);\n                            } finally {\n                                JMeterContextService.getContext().unsetIsWithinRestartNextLoop();                                \n                            }\n\nIn IfController#next:\nTest for flag and don't eval condition but what to return ?\n\n\nWhat's your opinion ssebb ?\n\nRegards\nPhilippe", "id": 150023, "time": "2011-10-01T16:58:11Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-10-01T16:58:11Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 51868, "text": "Created attachment 27669\nFIx to issue\n\nHello,\nI implemented described solution that sets a flag when within restart next loop code in JMeterThread.\nIfController tests this state and does not evaluate condition and return next sampler as if condition was true.\n\nRegards\nPhilippe", "id": 150044, "time": "2011-10-02T06:48:50Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-10-02T06:48:50Z", "is_private": false, "attachment_id": 27669}, {"count": 13, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "text": "Created attachment 27696\nFix to issue taking into account your note in issue 51866\n\nHello,\nI think this fixes both 51868 and 51866.\n\nant test passed OK \n2 Test plans of 51866 and Test plan of 51868 also passed OK.\nRegards\nPhilippe M.", "id": 150177, "time": "2011-10-05T13:32:49Z", "bug_id": 51868, "creation_time": "2011-10-05T13:32:49Z", "is_private": false, "attachment_id": 27696}, {"count": 14, "tags": [], "bug_id": 51868, "text": "Date: Mon Oct 31 10:50:11 2011\nNew Revision: 1195404\n\nURL: http://svn.apache.org/viewvc?rev=1195404&view=rev\nLog:\nFix to Start Next Loop broken feature, fixes following issues:\n- Bug 51865 - Infinite loop inside thread group does not work properly if \"Start next loop after a Sample error\" option set\n- Bug 51868 - A lot of exceptions in jmeter.log while using option \"Start next loop\" for thread\n- Bug 51866 - Counter under loop doesn't work properly if \"Start next loop on error\" option set for thread group\n\n\nAdded:\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/threads/FindTestElementsUpToRootTraverser.java   (with props)\nModified:\n   jakarta/jmeter/trunk/src/components/org/apache/jmeter/control/ForeachController.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/control/Controller.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/control/GenericController.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/control/IfController.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/control/LoopController.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/control/RunTime.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/control/WhileController.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/threads/AbstractThreadGroup.java\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/threads/JMeterThread.java\n   jakarta/jmeter/trunk/xdocs/changes.xml", "id": 151073, "time": "2011-10-31T10:52:16Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-10-31T10:52:16Z", "is_private": false, "attachment_id": null}, {"count": 15, "text": "Hello,\nA Fix has been provided, it would be Nice of you to test it and submit a comment confirming it is fixed for you.\n\nRegards", "bug_id": 51868, "attachment_id": null, "id": 151097, "time": "2011-11-01T10:04:53Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-11-01T10:04:53Z", "tags": [], "is_private": false}, {"count": 16, "tags": [], "bug_id": 51868, "text": "verified on r1213077", "id": 152145, "time": "2011-12-13T14:07:38Z", "creator": "tedam@mail.ru", "creation_time": "2011-12-13T14:07:38Z", "is_private": false, "attachment_id": null}, {"count": 17, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "text": "I change state cause with VERIFIED state , issue still appears as opened in weekly bug report.\nThanks for verification.", "id": 152798, "time": "2012-01-15T13:40:08Z", "bug_id": 51868, "creation_time": "2012-01-15T13:40:08Z", "is_private": false, "attachment_id": null}]