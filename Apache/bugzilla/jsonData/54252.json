[{"count": 0, "tags": [], "bug_id": 54252, "is_private": false, "text": "openssl is  linked with -lz, so acinclude.m4 needs this modification for static libraries.\n\nMaybe this should be using pkg-config instead ?\n\n--- acinclude.m4.old\t2012-12-05 11:48:06.000000000 +0000\n+++ acinclude.m4\t2012-12-05 11:48:13.000000000 +0000\n@@ -543,7 +543,7 @@\n       [AC_MSG_RESULT(FAILED)])\n \n     if test \"x$ac_cv_openssl\" = \"xyes\"; then\n-      ap_openssl_libs=\"-lssl -lcrypto `$apr_config --libs`\"\n+      ap_openssl_libs=\"-lssl -lcrypto -lz `$apr_config --libs`\"\n       APR_ADDTO(SSL_LIBS, [$ap_openssl_libs])\n       APR_ADDTO(LIBS, [$ap_openssl_libs])\n       APACHE_SUBST(SSL_LIBS)", "id": 163892, "time": "2012-12-05T17:42:55Z", "creator": "alanh@fairlite.co.uk", "creation_time": "2012-12-05T17:42:55Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 54252, "is_private": false, "count": 1, "id": 164248, "time": "2012-12-26T12:02:42Z", "creator": "asfbugz@velox.ch", "creation_time": "2012-12-26T12:02:42Z", "text": "(In reply to comment #0)\n> openssl is  linked with -lz, so acinclude.m4 needs this modification for\n> static libraries.\n> \n> Maybe this should be using pkg-config instead ?\n\nAFAICT, using pkg-config wouldn't solve this particular problem, unfortunately... \"-lz\" would only appear in pkg-config's --libs output if pkg-config was called with\" --static\" - and that's something we don't want to unconditionally add to pkg-config calls in acinclude.m4/configure.\n\nCalling configure with LDFLAGS=-lz might be a workaround for you, but for a more thorough fix, we would have to add another configure option, I guess (comparable to the --enable-static-* options for the support binaries)."}, {"count": 2, "attachment_id": null, "creator": "asfbugz@velox.ch", "text": "(In reply to comment #1)\n> \"-lz\" would only appear in pkg-config's --libs output if\n> pkg-config was called with\" --static\" - and that's something we don't want\n> to unconditionally add to pkg-config calls in acinclude.m4/configure.\n\nAfter a closer look at the OpenSSL sources, I realized that -lz (and other potential linker flags for the static libs) were only moved to Libs.private in the openssl.pc file with OpenSSL 1.0.0h/1.0.1 and later (http://cvs.openssl.org/chngview?cn=22120 and http://cvs.openssl.org/chngview?cn=22121, respectively). With previous releases, pkg-config would output -lz also when \"--static\" was not specified.\n\nThat being said, relying on pkg-config for figuring out the proper ap_openssl_libs should be doable, I think... could you try the changes shown below and let me know if they fix the problem for you? (to be applied against a checkout of http://svn.apache.org/repos/asf/httpd/httpd/branches/2.4.x, and buildconf must be run afterwards)\n\nWith the modifications from r1390518, additional flags from pkg-config's \"--static\" option will only be added to modules/ssl/modules.mk and ab_LDFLAGS, i.e. we avoid the side effect of everything having unnecessary references to libz.\n\n\n--- acinclude.m4        (revision 1427763)\n+++ acinclude.m4        (working copy)\n@@ -517,7 +517,7 @@\n         PKG_CONFIG_PATH=\"${ap_openssl_base}/lib/pkgconfig${PKG_CONFIG_PATH+:}${PKG_CONFIG_PATH}\"\n         export PKG_CONFIG_PATH\n       fi\n-      ap_openssl_libs=\"`$PKGCONFIG --libs-only-l openssl 2>&1`\"\n+      ap_openssl_libs=\"`$PKGCONFIG --silence-errors --static --libs-only-l openssl`\"\n       if test $? -eq 0; then\n         ap_openssl_found=\"yes\"\n         pkglookup=\"`$PKGCONFIG --cflags-only-I openssl`\"\n@@ -557,7 +557,7 @@\n       [AC_MSG_RESULT(FAILED)])\n\n     if test \"x$ac_cv_openssl\" = \"xyes\"; then\n-      ap_openssl_libs=\"-lssl -lcrypto `$apr_config --libs`\"\n+      ap_openssl_libs=\"${ap_openssl_libs:--lssl -lcrypto} `$apr_config --libs`\"\n       APR_ADDTO(MOD_LDFLAGS, [$ap_openssl_libs])\n       APR_ADDTO(LIBS, [$ap_openssl_libs])\n       APR_SETVAR(ab_LDFLAGS, [$MOD_LDFLAGS])", "id": 164315, "time": "2013-01-02T13:28:43Z", "bug_id": 54252, "creation_time": "2013-01-02T13:28:43Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "creator": "alanh@fairlite.co.uk", "attachment_id": null, "id": 164318, "time": "2013-01-02T15:50:50Z", "bug_id": 54252, "creation_time": "2013-01-02T15:50:50Z", "is_private": false, "text": "Yes, that works."}, {"attachment_id": null, "tags": [], "creator": "asfbugz@velox.ch", "text": "Addressed in trunk with r1428184. Proposed for backport to 2.4.x in r1428185.", "count": 4, "id": 164344, "time": "2013-01-03T07:28:58Z", "bug_id": 54252, "creation_time": "2013-01-03T07:28:58Z", "is_private": false}, {"count": 5, "tags": [], "creator": "asfbugz@velox.ch", "attachment_id": null, "text": "(In reply to comment #1)\n> for a more thorough fix, we would have to add another configure option, I guess\n> (comparable to the --enable-static-* options for the support binaries).\n\nFeedback on the dev list suggests that people aren't really comfortable with adding --static to pkg-config by default (cf. e.g. http://mail-archives.apache.org/mod_mbox/httpd-dev/201301.mbox/%3C20130103132934.GA23175@redhat.com%3E). A new option has been therefore been added with r1429228:\n\n  --enable-ssl-staticlib-deps\n                          link mod_ssl with dependencies of OpenSSL's static\n                          libraries (as indicated by \"pkg-config --static\").\n                          Must be specified in addition to --enable-ssl.\n\nProposed for backport to 2.4.x in r1429229.", "id": 164400, "time": "2013-01-05T08:01:35Z", "bug_id": 54252, "creation_time": "2013-01-05T08:01:35Z", "is_private": false}]