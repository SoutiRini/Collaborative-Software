[{"count": 0, "tags": [], "bug_id": 56306, "attachment_id": null, "text": "This happens since I upgraded Apache from 2.4.7 to 2.4.9.\n\nThe error i get looks like this:\n\n[Sun Mar 23 23:33:13.231712 2014] [mpm_event:notice] [pid 21463:tid 140220024149824] AH00493: SIGUSR1 received.  Doing graceful restart\n[Sun Mar 23 23:33:13.290939 2014] [auth_digest:notice] [pid 21463:tid 140220024149824] AH01757: generating secret for digest authentication ...\n[Sun Mar 23 23:33:13.292180 2014] [ssl:error] [pid 21463:tid 140220024149824] AH02217: ssl_stapling_init_cert: Can't retrieve issuer certificate!\n[Sun Mar 23 23:33:13.292187 2014] [ssl:error] [pid 21463:tid 140220024149824] AH02567: Unable to configure certificate rtmp.btbn.de:443:0 for stapling\n[Sun Mar 23 23:33:13.292811 2014] [ssl:emerg] [pid 21463:tid 140220024149824] (2)No such file or directory: AH02574: Init: Can't open server private key file 8\\xd1\\x9a\n[Sun Mar 23 23:33:13.292833 2014] [ssl:emerg] [pid 21463:tid 140220024149824] AH02312: Fatal error initialising mod_ssl, exiting.\n[Sun Mar 23 23:33:13.292836 2014] [ssl:emerg] [pid 21463:tid 140220024149824] AH02564: Failed to configure encrypted (?) private key sync.btbn.de:443:1, check 8\\xd1\\x9a\n[Sun Mar 23 23:33:13.292839 2014] [:emerg] [pid 21463:tid 140220024149824] AH00020: Configuration Failed, exiting\n[Sun Mar 23 23:33:41.017925 2014] [ssl:error] [pid 21895:tid 140712203999040] AH02217: ssl_stapling_init_cert: Can't retrieve issuer certificate!\n[Sun Mar 23 23:33:41.017995 2014] [ssl:error] [pid 21895:tid 140712203999040] AH02567: Unable to configure certificate rtmp.btbn.de:443:0 for stapling\n[Sun Mar 23 23:33:41.019157 2014] [ssl:emerg] [pid 21895:tid 140712203999040] (2)No such file or directory: AH02574: Init: Can't open server private key file 8\\xc1\\xf2\\x01\n[Sun Mar 23 23:33:41.019176 2014] [ssl:emerg] [pid 21895:tid 140712203999040] AH02312: Fatal error initialising mod_ssl, exiting.\n[Sun Mar 23 23:33:41.019181 2014] [ssl:emerg] [pid 21895:tid 140712203999040] AH02564: Failed to configure encrypted (?) private key sync.btbn.de:443:1, check 8\\xc1\\xf2\\x01\nAH00016: Configuration Failed\n\n\nI am able to workaround this by putting SSLCertificateKeyFile and/or SSLCertificateFile in each single ssl enabled vhost. It doesn't matter which one i add(key or cert), just stating at least one of them makes the error disappear.\n\nI have a globaly configured wildcard cert which matches most of my vhosts, and only override it in those where it doesn't apply, that's why most of my vhosts didn't have an individual cert configured before.\n\nIt seems to be possible to reproduce it by just configuring a few vhosts which use ssl without specifiying a cert/key inside of them, while having both globaly configured. I am currently not able to test that, because i don't have a test machine available.", "id": 174043, "time": "2014-03-23T23:09:48Z", "creator": "timo@rothenpieler.org", "creation_time": "2014-03-23T23:09:48Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "asfbugz@velox.ch", "is_private": false, "count": 1, "id": 174099, "time": "2014-03-26T10:32:35Z", "bug_id": 56306, "creation_time": "2014-03-26T10:32:35Z", "text": "(In reply to Timo R. from comment #0)\n> It seems to be possible to reproduce it by just configuring a few vhosts\n> which use ssl without specifiying a cert/key inside of them, while having\n> both globaly configured. I am currently not able to test that, because i\n> don't have a test machine available.\n\nI'm not able to reproduce the problem with such a config, specifically, but I realize that a side effect of r1573360 is that the behavior when merging global and per-vhost SSLCertificateFile/SSLCertificateKeyFile directives is different now (cf. https://svn.apache.org/viewvc/httpd/httpd/branches/2.4.x/modules/ssl/ssl_engine_config.c?r1=1573360&r2=1573359&pathrev=1573360 for the specific changes).\n\nCould you provide the skeleton of your configuration, which only shows the global and per-vhost SSLCertificateFile and SSLCertificateKeyFile directives? Or as a first step, the output of \"/httpd -t -D DUMP_VHOSTS -D DUMP_CERTS\" perhaps?"}, {"count": 2, "tags": [], "text": "The output with the workaround in place is:\n\nhttp://bpaste.net/show/194089/\n\nIn a state where it fails it looks like this:\n\nhttp://bpaste.net/show/194091/\n\n\nThe condensed config looks like this:\n\nglobal:\nSSLSessionCache shmcb:/run/ssl_scache(512000)\nSSLSessionCacheTimeout 300\nSSLUseStapling on\nSSLStaplingCache shmcb:/run/ssl_stapling_cache(512000)\nSSLHonorCipherOrder On\nSSLCipherSuite ECDHE-RSA-AES128-SHA256:AES128-GCM-SHA256:RC4:HIGH:!MD5:!aNULL:!EDH\nMutex file:/run/apache_ssl_mutex ssl-cache\nSSLCertificateFile /etc/ssl/private/server.pem\nSSLCertificateKeyFile /etc/ssl/private/server.key\n\nvhosts:\n<VirtualHost *:443>\n        ServerName btbn.de\n        Include /etc/apache2/myvhosts.d/ssl.include\n</VirtualHost>\n<VirtualHost *:443>\n        ServerName zkb.mtl-eve.org\n        Include /etc/apache2/myvhosts.d/ssl.include\n</VirtualHost>\n<VirtualHost *:443>\n        ServerName www.mtl-eve.org\n        Include /etc/apache2/myvhosts.d/ssl-startcom.include\n        SSLCertificateFile /etc/ssl/private/mtl-eve.pem\n</VirtualHost>\n<VirtualHost *:443>\n        ServerName myadmin.oromit.de\n        Include /etc/apache2/myvhosts.d/ssl.include\n</VirtualHost>\n<VirtualHost *:443>\n        ServerName www.project-phaethon.de\n        Include /etc/apache2/myvhosts.d/ssl-startcom.include\n        SSLCertificateFile /etc/ssl/private/project-phaethon.pem\n</VirtualHost>\n<VirtualHost *:443>\n        ServerName ci.btbn.de\n        Include /etc/apache2/myvhosts.d/ssl-startcom.include\n        SSLCertificateFile /etc/ssl/private/ci.pem\n</VirtualHost>\n<VirtualHost *:443>\n        ServerName git.btbn.de\n        Include /etc/apache2/myvhosts.d/ssl.include\n</VirtualHost>\n<VirtualHost *:443>\n        ServerName bts.btbn.de\n        Include /etc/apache2/myvhosts.d/ssl.include\n</VirtualHost>\n<VirtualHost *:443>\n        ServerName sync.btbn.de\n        Include /etc/apache2/myvhosts.d/ssl-startcom.include\n        SSLCertificateFile /etc/ssl/private/sync.pem\n</VirtualHost>\n<VirtualHost *:443>\n        ServerName rtmp.btbn.de\n        Include /etc/apache2/myvhosts.d/ssl.include\n</VirtualHost>\n<VirtualHost *:443>\n        ServerName obsproject.org\n        Include /etc/apache2/myvhosts.d/ssl-startcom.include\n        SSLCertificateFile /etc/ssl/private/obsproject.pem\n</VirtualHost>\n\nssl-common.include:\nSSLEngine on\n#SSLCertificateKeyFile /etc/ssl/private/server.key  # Enabling this line fixes the problem\n\nssl.include:\nInclude ssl-common.include\n#SSLCertificateFile /etc/ssl/private/server.pem # Enabling this line also fixes it\n\nssl-startcom.include:\nInclude ssl-common.include\nSSLCACertificateFile /etc/apache2/startcom/ca.pem", "attachment_id": null, "bug_id": 56306, "id": 174117, "time": "2014-03-26T19:32:30Z", "creator": "timo@rothenpieler.org", "creation_time": "2014-03-26T19:32:30Z", "is_private": false}, {"count": 3, "tags": [], "creator": "asfbugz@velox.ch", "attachment_id": 31458, "id": 174172, "time": "2014-03-30T08:48:16Z", "bug_id": 56306, "creation_time": "2014-03-30T08:48:16Z", "is_private": false, "text": "Created attachment 31458\nOnly read \"active\" values from the mctx->pks->key_files array\n\n(In reply to Timo R. from comment #2)\n\nThank you for the detailed information.\n\n> The output with the workaround in place is:\n> \n> http://bpaste.net/show/194089/\n\nI assume that you disabled the two global-level SSLCertificateFile and SSLCertificateKeyFile directives for this case, is that correct? (The \"Server certificates\" list includes 11 entries, i.e. one per <VirtualHost *:443> block.)\n\n> In a state where it fails it looks like this:\n> \n> http://bpaste.net/show/194091/\n\nHere we find 27 entries in the server certificates list (and still 11 <VirtualHost *:443> blocks), so it's obvious that merging the global and the per-vhost settings has somewhat surprising effects.\n\nThe three-layer Include structure in your config makes it relatively hard to follow what SSLCertificate/SSLCertificateKeyFile directives are active for which VirtualHost (and what config exactly was used for the output at http://bpaste.net/show/194091/), but from looking at the code in ssl_engine_init.c and the errors shown in the description above, the problem seems to be that we try to read a bogus value for the SSLCertificateKeyFile directive.\n\nCould you try to apply the attached patch to 2.4.9? This should make the garbled log messages go away - but it might not yet fix the underlying issue, which probably needs further work (in particular when looking at the order of merging the global and per-vhost settings)."}, {"count": 4, "tags": [], "text": "Created attachment 31459\nOnly read \"active\" values from the mctx->pks->key_files array, v2\n\n(In reply to Kaspar Brand from comment #3)\n> Could you try to apply the attached patch to 2.4.9?\n\nHmpf, this was off by one, sorry. Please try this version instead.", "is_private": false, "bug_id": 56306, "id": 174174, "time": "2014-03-30T09:40:26Z", "creator": "asfbugz@velox.ch", "creation_time": "2014-03-30T09:40:26Z", "attachment_id": 31459}, {"count": 5, "tags": [], "text": "(In reply to Kaspar Brand from comment #4)\n> Created attachment 31459 [details]\n> Only read \"active\" values from the mctx->pks->key_files array, v2\n\nCommitted to trunk with r1585918 and proposed for backport to 2.4.x in r1585922.\n\nTimo, if you are able to try the patch with your setup and 2.4.9, a report on your tests is still appreciated.", "is_private": false, "bug_id": 56306, "id": 174396, "time": "2014-04-09T09:53:14Z", "creator": "asfbugz@velox.ch", "creation_time": "2014-04-09T09:53:14Z", "attachment_id": null}, {"count": 6, "tags": [], "creator": "timo@rothenpieler.org", "attachment_id": null, "id": 174403, "time": "2014-04-09T11:31:00Z", "bug_id": 56306, "creation_time": "2014-04-09T11:31:00Z", "is_private": false, "text": "Oh, i completely forgot about this one.\nWill test it later today."}, {"attachment_id": null, "tags": [], "bug_id": 56306, "is_private": false, "count": 7, "id": 174406, "time": "2014-04-09T11:52:58Z", "creator": "timo@rothenpieler.org", "creation_time": "2014-04-09T11:52:58Z", "text": "With the patch applied, it still does not start up, but the garbled part is gone. Instead i get:\n\n[Wed Apr 09 13:46:09.931766 2014] [ssl:error] [pid 29696:tid 139644707223360] AH02217: ssl_stapling_init_cert: Can't retrieve issuer certificate!\n[Wed Apr 09 13:46:09.931809 2014] [ssl:error] [pid 29696:tid 139644707223360] AH02567: Unable to configure certificate rtmp.btbn.de:443:0 for stapling\n[Wed Apr 09 13:46:09.932141 2014] [ssl:error] [pid 29696:tid 139644707223360] AH02217: ssl_stapling_init_cert: Can't retrieve issuer certificate!\n[Wed Apr 09 13:46:09.932146 2014] [ssl:error] [pid 29696:tid 139644707223360] AH02567: Unable to configure certificate sync.btbn.de:443:0 for stapling\n[Wed Apr 09 13:46:09.949913 2014] [ssl:error] [pid 29696:tid 139644707223360] AH02579: Init: Private key not found\n[Wed Apr 09 13:46:09.949940 2014] [ssl:error] [pid 29696:tid 139644707223360] SSL Library Error: error:0D0680A8:asn1 encoding routines:ASN1_CHECK_TLEN:wrong tag\n[Wed Apr 09 13:46:09.949950 2014] [ssl:error] [pid 29696:tid 139644707223360] SSL Library Error: error:0D08303A:asn1 encoding routines:ASN1_TEMPLATE_NOEXP_D2I:nested asn1 error\n[Wed Apr 09 13:46:09.949958 2014] [ssl:error] [pid 29696:tid 139644707223360] SSL Library Error: error:0D0680A8:asn1 encoding routines:ASN1_CHECK_TLEN:wrong tag\n[Wed Apr 09 13:46:09.949967 2014] [ssl:error] [pid 29696:tid 139644707223360] SSL Library Error: error:0D07803A:asn1 encoding routines:ASN1_ITEM_EX_D2I:nested asn1 error (Type=RSA)\n[Wed Apr 09 13:46:09.949975 2014] [ssl:error] [pid 29696:tid 139644707223360] SSL Library Error: error:04093004:rsa routines:OLD_RSA_PRIV_DECODE:RSA lib\n[Wed Apr 09 13:46:09.949982 2014] [ssl:error] [pid 29696:tid 139644707223360] SSL Library Error: error:0D0680A8:asn1 encoding routines:ASN1_CHECK_TLEN:wrong tag\n[Wed Apr 09 13:46:09.949990 2014] [ssl:error] [pid 29696:tid 139644707223360] SSL Library Error: error:0D07803A:asn1 encoding routines:ASN1_ITEM_EX_D2I:nested asn1 error (Type=PKCS8_PRIV_KEY_INFO)\n[Wed Apr 09 13:46:09.949994 2014] [ssl:emerg] [pid 29696:tid 139644707223360] AH02312: Fatal error initialising mod_ssl, exiting.\n[Wed Apr 09 13:46:09.949998 2014] [ssl:emerg] [pid 29696:tid 139644707223360] AH02564: Failed to configure encrypted (?) private key sync.btbn.de:443:1, check /etc/ssl/private/server.pem\nAH00016: Configuration Failed\n\nThe stapling errors don't seem to be part of the issue. The server.pem file does not contain a private key.\n\nPlase note that my server configuration has changed in the meantime(due to Heartbleed and StartCom beeing bad). All vhosts use the same cert and key now.\nIf no vhost has a Cert and Key defined, so only the global directives exist, it works(Starts up, erroring only about the stapling).\nIn order to replicate the issue i put an additional SSLCertificateFile into some of the vhosts."}, {"count": 8, "tags": [], "text": "Created attachment 31531\nRestore previous SSLCertificate[Key]File directive merging behavior for 2.4.x\n\nThank you for testing, and sorry for being late with my reply. The stapling errors are unrelated, indeed.\n\nThe root cause of this issue is what I already mentioned in comment 1: with  r1573360 (i.e. httpd 2.4.8/2.4.9), merging of global and per-vhost SSLCertificate[Key]File directives inadvertently changed in a non-backwards compatible way.\n\nWith the attached patch (to be applied in addition to the first one), I tried to restore the previous behavior as far as possible. The most important difference to 2.4.9 is that an SSLCertificate[Key]File directive in a VirtualHost block now again overrides a global setting (in 2.4.9, the global setting is appended to the list, and then mistakenly replaces the per-vhost setting, see also bug 56353).\n\nTesting of your setup (possibly with the one you originally reported) with this patch applied would be very much appreciated.", "is_private": false, "bug_id": 56306, "id": 174611, "time": "2014-04-16T08:06:07Z", "creator": "asfbugz@velox.ch", "creation_time": "2014-04-16T08:06:07Z", "attachment_id": 31531}, {"count": 9, "tags": [], "text": "(In reply to Kaspar Brand from comment #5)\n> proposed for backport to 2.4.x in r1585922.\n\nCommitted to 2.4.x with r1588246. To appear in 2.4.10. This fixes the specific issue reported in this bug, but doesn't restore backwards compatibility with versions before 2.4.8 yet (merging of global and vhost-level directives). Based on feedback from testing the patch in comment 8, I'm intending to propose an additional backport for 2.4.x.", "attachment_id": null, "bug_id": 56306, "id": 174693, "time": "2014-04-18T08:47:10Z", "creator": "asfbugz@velox.ch", "creation_time": "2014-04-18T08:47:10Z", "is_private": false}, {"count": 10, "text": "Comment on attachment 31531\nRestore previous SSLCertificate[Key]File directive merging behavior for 2.4.x\n\nObsolete in this form, as it is included in the https://people.apache.org/~kbrand/mod_ssl-2.4.x-pphrase-certkeyfile-compat.diff backport proposal", "bug_id": 56306, "is_private": false, "id": 174901, "time": "2014-04-27T08:52:01Z", "creator": "asfbugz@velox.ch", "creation_time": "2014-04-27T08:52:01Z", "tags": [], "attachment_id": 31531}, {"count": 11, "tags": [], "text": "(In reply to Kaspar Brand from comment #9)\n> I'm intending to propose an additional backport for 2.4.x.\n\nI've done so now with r1590359. Examining again the configuration from comment 2, I can also provide an explanation for the troubles you experienced when using your existing (pre-2.4.9) setup: as already mentioned in comment 8, a vhost-level SSLCertificate[Key]File directive is overriding a globally configured one in releases up to 2.4.7, but in 2.4.8/2.4.9, it is simply added to the list.\n\nIn your case, you had five VirtualHost blocks with an individual SSLCertificateFile directive, but no corresponding SSLCertificateKeyFile, and mod_ssl was trying to read the file name from an uninitialized key_files array value. The immediate fix for this has already been committed (see comment 9), but the additional patch in https://people.apache.org/~kbrand/mod_ssl-2.4.x-pphrase-certkeyfile-compat.diff will further restore backwards compatibility for existing configurations.", "is_private": false, "bug_id": 56306, "id": 174902, "time": "2014-04-27T08:55:03Z", "creator": "asfbugz@velox.ch", "creation_time": "2014-04-27T08:55:03Z", "attachment_id": null}, {"count": 12, "tags": [], "creator": "asfbugz@velox.ch", "attachment_id": null, "id": 175192, "time": "2014-05-14T06:30:38Z", "bug_id": 56306, "creation_time": "2014-05-14T06:30:38Z", "is_private": false, "text": "(In reply to Kaspar Brand from comment #11)\n> (In reply to Kaspar Brand from comment #9)\n> > I'm intending to propose an additional backport for 2.4.x.\n> \n> I've done so now with r1590359.\n\nThis has now been committed to the 2.4.x branch with r1593003 - will appear in 2.4.10."}, {"attachment_id": null, "tags": [], "creator": "christophe.jaillet@wanadoo.fr", "text": "Fixed and released in 2.4.10", "count": 13, "id": 177227, "time": "2014-08-18T07:49:27Z", "bug_id": 56306, "creation_time": "2014-08-18T07:49:27Z", "is_private": false}]