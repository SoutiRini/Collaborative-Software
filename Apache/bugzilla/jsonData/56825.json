[{"count": 0, "tags": [], "bug_id": 56825, "attachment_id": null, "text": "When using Tomcat SSL coyote connector, the request does not by default contain the certificate chain under the key javax.servlet.request.X509Certificate\n\nThe following coyote action must be invoked in order to extract the certificate chain and enrich the request under the right key.\n\nThis makes it impossible to use the SSLAuthenticator with preemptive mode for example.\n\nProvided a test to reproduce and the fix within the patch file.\nI tried to follow Tomcat guidelines and coding rules. If not lemme know so that I can resubmit a new patch.\n\nNot tested under Tomcat 6 and 8 but, the AuthenticatorBase does not change a lot over versions so I guess the bug existed before Tomcat 7 and still exists in Tomcat 8.", "id": 176975, "time": "2014-08-07T12:16:52Z", "creator": "jlmonteiro@tomitribe.com", "creation_time": "2014-08-07T12:16:52Z", "is_private": false}, {"count": 1, "tags": [], "text": "Created attachment 31885\nPatch with the test to reproduce and a fix", "is_private": false, "id": 176976, "creator": "jlmonteiro@tomitribe.com", "time": "2014-08-07T12:20:25Z", "bug_id": 56825, "creation_time": "2014-08-07T12:20:25Z", "attachment_id": 31885}, {"count": 2, "tags": [], "creator": "markt@apache.org", "text": "Generally we apply patches to the latest release and then back-port. Therefore patches should be against 8.0.x.\n\nThe current patch changes import order and white space which a) makes the patch harder to review and b) those changes would need to be reverted before the patch was committed.", "id": 177021, "time": "2014-08-08T14:59:53Z", "bug_id": 56825, "creation_time": "2014-08-08T14:59:53Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 56825, "attachment_id": null, "text": "Thanks for reviewing.\n\nI'll checkout the 8.0.x trunk and submit a new patch.\nI'll take care as well of the formatting (including imports).", "id": 177022, "time": "2014-08-08T15:03:50Z", "creator": "jlmonteiro@tomitribe.com", "creation_time": "2014-08-08T15:03:50Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "markt@apache.org", "text": "Sorry, I wanted to get the next 8.0.x release out so I have taken you patch and applied to to 8.0.x myself. In addition to the changes I mentioned previously, I also did the unit tests slightly differently to reduce the number of changes required.\n\nThis has been fixed in 8.0.x for 8.0.11 onwards and in 7.0.x for 7.0.56 onwards.", "count": 4, "id": 177099, "time": "2014-08-12T10:54:36Z", "bug_id": 56825, "creation_time": "2014-08-12T10:54:36Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 56825, "attachment_id": null, "id": 177101, "time": "2014-08-12T11:39:57Z", "creator": "jlmonteiro@tomitribe.com", "creation_time": "2014-08-12T11:39:57Z", "is_private": false, "text": "Thank you very much Mark.\nI'll check your commit so that I can avoid such mistakes next time."}, {"attachment_id": null, "tags": [], "creator": "knst.kolinko@gmail.com", "is_private": false, "count": 6, "id": 177406, "time": "2014-08-27T14:04:20Z", "bug_id": 56825, "creation_time": "2014-08-27T14:04:20Z", "text": "REOPENing for Tomcat 7.\nAs discussed in \"Re r1617445\" on dev, the change trigger re-authentication for webapps that do not need it.\n\nThe fix in Tomcat 8 is r1617461 but it has not been backported to Tomcat 7 yet."}, {"count": 7, "tags": [], "bug_id": 56825, "attachment_id": null, "id": 177519, "time": "2014-09-03T19:30:43Z", "creator": "markt@apache.org", "creation_time": "2014-09-03T19:30:43Z", "is_private": false, "text": "Re-authentication patch back-ported from truk for 7.0.56 onwards."}, {"count": 8, "tags": [], "bug_id": 56825, "attachment_id": null, "id": 177522, "time": "2014-09-04T00:17:36Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-09-04T00:17:36Z", "is_private": false, "text": "Re-reviewing the changes in Tomcat 7 (revisions r1617447 r1620827 and r1622328 ) I have a question.\n\nThere exists ActionCode.REQ_SSL_ATTRIBUTE.\n\nThe method org.apache.catalina.connector.Request.getAttribute() does\n\n  \"if (isSSLAttribute(name))\n      coyoteRequest.action(ActionCode.REQ_SSL_ATTRIBUTE, ...)\"\n\nThis action populates the \"javax.servlet.request.X509Certificate\" attribute (aka Globals.CERTIFICATES_ATTR).\n\nI mean that it is effectively equivalent to the new API of using ActionCode.REQ_SSL_CERTIFICATE with parameter Boolean.FALSE.\n\n> When using Tomcat SSL coyote connector, the request does not by default contain\n> the certificate chain under the key javax.servlet.request.X509Certificate\n>\n> The following coyote action must be invoked in order to extract the certificate\n> chain and enrich the request under the right key.\n\nIs the above really true? Why was the old code not working properly? Was all this fix really needed? Was the new API really needed?\n\nI did the following at tc7.0.x\\trunk:\nI reverted to the state before those fixes and updated the tests to their current versions:\n\nsvn up -r 1617446\ncd test/org/apache/tomcat/util/net\nsvn up TestClientCert.java\nsvn up TesterSupport.java\n\nThen I run test.entry=org.apache.tomcat.util.net.TestClientCert test with BIO, NIO, APR (java.7.home=JDK 7u67).\n\nResults are:\n1) With APR the tests were skipped,\n \"SKIPPED: SSL renegotiation has to be supported for this test\"\n2) With BIO and NIO the tests passed.\n\nSo it looks like there was no issue."}, {"count": 9, "tags": [], "bug_id": 56825, "attachment_id": null, "is_private": false, "id": 177526, "time": "2014-09-04T08:18:26Z", "creator": "jlmonteiro@tomitribe.com", "creation_time": "2014-09-04T08:18:26Z", "text": "Hi,\n\n(In reply to Konstantin Kolinko from comment #8)\n> Re-reviewing the changes in Tomcat 7 (revisions r1617447 r1620827 and\n> r1622328 ) I have a question.\n> \n> There exists ActionCode.REQ_SSL_ATTRIBUTE.\n> \n> The method org.apache.catalina.connector.Request.getAttribute() does\n> \n>   \"if (isSSLAttribute(name))\n>       coyoteRequest.action(ActionCode.REQ_SSL_ATTRIBUTE, ...)\"\n> \n> This action populates the \"javax.servlet.request.X509Certificate\" attribute\n> (aka Globals.CERTIFICATES_ATTR).\n\nRight the getAttribute invokes ActionCode.REQ_SSL_ATTRIBUTE, but the main difference between REQ_SSL_ATTRIBUTE and REQ_SSL_CERTIFICATE is the following invocation:\nsslO = sslSupport.getPeerCertificateChain(<force>);\n\nREQ_SSL_ATTRIBUTE --> force is false\nREQ_SSL_CERTIFICATE --> force is true\n\nREQ_SSL_ATTRIBUTE --> the certificate entry is never populated cause the certificate chain is never extracted (in the use case above)\n\n> \n> I mean that it is effectively equivalent to the new API of using\n> ActionCode.REQ_SSL_CERTIFICATE with parameter Boolean.FALSE.\n> \n\n\n> > When using Tomcat SSL coyote connector, the request does not by default contain\n> > the certificate chain under the key javax.servlet.request.X509Certificate\n> >\n> > The following coyote action must be invoked in order to extract the certificate\n> > chain and enrich the request under the right key.\n> \n> Is the above really true? Why was the old code not working properly? Was all\n> this fix really needed? Was the new API really needed?\n \nI created the test to reproduce before proposing a fix. So if now it does not fail anymore, there must be something else.\n\nDid the following with this revision\n$ svn info\nPath: .\nWorking Copy Root Path: /Users/jlmonteiro/devs/asf/tomcat/tc7.0.x/trunk\nURL: http://svn.apache.org/repos/asf/tomcat/tc7.0.x/trunk\nRepository Root: http://svn.apache.org/repos/asf\nRepository UUID: 13f79535-47bb-0310-9956-ffa450edef68\nRevision: 1616257\nNode Kind: directory\nSchedule: normal\nLast Changed Author: markt\nLast Changed Rev: 1615951\nLast Changed Date: 2014-08-05 17:50:13 +0200 (Mar, 05 ao\u00fb 2014)\n\nKept the test case portion of my patch and it actually still fails.\nSo either my test is wrong which is definitely possible, or I missed something.\n\nWhat do you think?"}, {"attachment_id": null, "tags": [], "creator": "markt@apache.org", "text": "I've dug a little more into this. The unit test setting clientAuth=\"want\" is hiding the fact that this still isn't quite right.\n\nSome new API is going to be necessary. That said, I'm not sure that the current API is exactly right either.", "count": 10, "id": 177535, "time": "2014-09-04T12:04:05Z", "bug_id": 56825, "creation_time": "2014-09-04T12:04:05Z", "is_private": false}, {"count": 11, "attachment_id": null, "bug_id": 56825, "is_private": false, "id": 177538, "time": "2014-09-04T13:20:15Z", "creator": "markt@apache.org", "creation_time": "2014-09-04T13:20:15Z", "tags": [], "text": "Fixed in 8.0.x for 8.0.13 onwards and in 7.0.x for 7.0.56 onwards. In the end, no new API was required as I was able to get the info I needed vai an existing API."}]