[{"count": 0, "tags": [], "text": "We have got  tomcat cluster of two nodes (each on its own server ), configured to use DeltaManger. \n\nOur Snder configure as following on both tomcats:\n              <Sender className=\"org.apache.catalina.tribes.transport.ReplicationTransmitter\">\n\t\t\t       <Transport className=\"org.apache.catalina.tribes.transport.nio.PooledParallelSender\"\n                                  timeout=\"6000\" maxRetryAttempts=\"2\" soKeepAlive=\"true\" soLingerTime=\"6\" soTrafficClass=\"0x08\"\n                               /> \n\t\t\t   </Sender>\n\nWhen we stop one of the tomcats  and  the other one is still trying to sent session delta information and fails with the following error:\n\n18-Dec-2011 21:48:05.648 FINE [pool-2-thread-4] org.apache.catalina.tribes.transport.nio.NioReplicationTask.remoteEof Channel closed on the remote end, disconnecting\n18-Dec-2011 21:48:05.650 FINE [pool-2-thread-5] org.apache.catalina.tribes.transport.nio.NioReplicationTask.remoteEof Channel closed on the remote end, disconnecting\n18-Dec-2011 21:48:06.114 FINE [http-8080-1] org.apache.catalina.ha.session.DeltaManager.sendCreateSession Manager [/myaccount] send new session (CE176CCE1BF31C41977B6D43891EFB36.)\n18-Dec-2011 21:48:06.115 FINE [http-8080-1] org.apache.catalina.ha.session.DeltaManager.createSession Created a DeltaSession with Id [CE176CCE1BF31C41977B6D43891EFB36.] Total count=276\n18-Dec-2011 21:48:06.117 WARNING [pool-1-thread-1] org.apache.catalina.tribes.transport.nio.ParallelNioSender.doLoop Member send is failing for:tcp://{10, 210, 160, 71}:4205 ; Setting to suspect and retrying.\n18-Dec-2011 21:48:06.121 FINE [pool-1-thread-1] org.apache.catalina.tribes.group.interceptors.MessageDispatchInterceptor.sendAsyncData Error while processing async message.\n org.apache.catalina.tribes.ChannelException: Send failed, attempt:3 max:2; Faulty members:tcp://{10, 210, 160, 71}:4205; \n\tat org.apache.catalina.tribes.transport.nio.ParallelNioSender.doLoop(ParallelNioSender.java:172)\n\tat org.apache.catalina.tribes.transport.nio.ParallelNioSender.sendMessage(ParallelNioSender.java:78)\n\tat org.apache.catalina.tribes.transport.nio.PooledParallelSender.sendMessage(PooledParallelSender.java:53)\n\tat org.apache.catalina.tribes.transport.ReplicationTransmitter.sendMessage(ReplicationTransmitter.java:81)\n\tat org.apache.catalina.tribes.group.ChannelCoordinator.sendMessage(ChannelCoordinator.java:78)\n\tat org.apache.catalina.tribes.group.ChannelInterceptorBase.sendMessage(ChannelInterceptorBase.java:75)\n\tat org.apache.catalina.tribes.group.interceptors.ThroughputInterceptor.sendMessage(ThroughputInterceptor.java:61)\n\tat org.apache.catalina.tribes.group.ChannelInterceptorBase.sendMessage(ChannelInterceptorBase.java:75)\n\tat org.apache.catalina.tribes.group.interceptors.MessageDispatchInterceptor.sendAsyncData(MessageDispatchInterceptor.java:178)\n\tat org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor$1.run(MessageDispatch15Interceptor.java:64)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\tat java.lang.Thread.run(Thread.java:619)\nCaused by: java.net.ConnectException: Connection refused\n\tat sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)\n\tat sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:574)\n\tat org.apache.catalina.tribes.transport.nio.NioSender.process(NioSender.java:88)\n\tat org.apache.catalina.tribes.transport.nio.ParallelNioSender.doLoop(ParallelNioSender.java:130)\n\t... 12 more\n\nAnd then ,when we start the other tomcat ,  Sender never gets connected again. \n\n18-Dec-2011 21:48:06.297 FINE [http-8080-1] org.apache.catalina.ha.session.DeltaManager.sendCreateSession Manager [/myaccount] send new session (A6955A82C56920EABFFA5096BA4ECD8C.)\n18-Dec-2011 21:48:06.297 FINE [http-8080-1] org.apache.catalina.ha.session.DeltaManager.createSession Created a DeltaSession with Id [A6955A82C56920EABFFA5096BA4ECD8C.] Total count=277\n18-Dec-2011 21:48:06.298 FINE [pool-1-thread-2] org.apache.catalina.tribes.group.interceptors.MessageDispatchInterceptor.sendAsyncData Error while processing async message.\n org.apache.catalina.tribes.ChannelException: Sender not connected.; No faulty members identified.\n\tat org.apache.catalina.tribes.transport.nio.PooledParallelSender.sendMessage(PooledParallelSender.java:45)\n\tat org.apache.catalina.tribes.transport.ReplicationTransmitter.sendMessage(ReplicationTransmitter.java:81)\n\tat org.apache.catalina.tribes.group.ChannelCoordinator.sendMessage(ChannelCoordinator.java:78)\n\tat org.apache.catalina.tribes.group.ChannelInterceptorBase.sendMessage(ChannelInterceptorBase.java:75)\n\tat org.apache.catalina.tribes.group.interceptors.ThroughputInterceptor.sendMessage(ThroughputInterceptor.java:61)\n\tat org.apache.catalina.tribes.group.ChannelInterceptorBase.sendMessage(ChannelInterceptorBase.java:75)\n\tat org.apache.catalina.tribes.group.interceptors.MessageDispatchInterceptor.sendAsyncData(MessageDispatchInterceptor.java:178)\n\tat org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor$1.run(MessageDispatch15Interceptor.java:64)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\tat java.lang.Thread.run(Thread.java:619)\n\nSo whenever we restart one of the tomcats the other keeps getting 'Sender not connected' exceptions and to re-connect the Sender we need to restart that tomcat instance. But when we do that the other tomcat instance gets the same problem. So cluster never works\n\nThe problem seems to happen in PooledParallelSender.sendMessage(...)\n\n   public void sendMessage(Member[] destination, ChannelMessage message) throws ChannelException {\n        if ( !connected ) throw new ChannelException(\"Sender not connected.\");\n...\n\nThat if statement makes sure Sender never gets connected again, unless we restart \n\nPlease advise", "attachment_id": null, "bug_id": 52365, "id": 152292, "time": "2011-12-19T15:58:17Z", "creator": "dhordey@gmail.com", "creation_time": "2011-12-19T15:58:17Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 52365, "text": "This works for me and is such a basic part of the cluster support that if it were broken, I'd expect to see many more complaints.\n\nThe most likely cause is a configuration error but without the full configuration from both nodes it is very difficult to tell.\n\nPlease use the users mailing list to debug this issue further. If that identifies a bug (one that can be produced on a clean installation of the latest Tomcat 6 release) then please re-open this bug and provide the reproduction steps.", "id": 152361, "attachment_id": null, "creator": "markt@apache.org", "creation_time": "2011-12-21T20:06:08Z", "time": "2011-12-21T20:06:08Z", "is_private": false}]