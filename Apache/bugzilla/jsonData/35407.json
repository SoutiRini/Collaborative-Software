[{"count": 0, "tags": [], "bug_id": 35407, "text": "> Gregor J. Rothfuss wrote \"The naive caching with the work directory makes this\n[dynamic pages] impossible. In my opinion, it should be removed from lenya.\"\nOn 6/17/05, Michael Wechner wrote, \"In productive environments with heavy load\nit's very useful.  Why don't we just DISABLE it by default instead of removing it?\"\n\nCaching seems very useful, but is incompatible with dynamic sites.  Disable it when:\n1. A visitor is logged in.  (My menus change when a visitor logs in.)\n2. There is a querystring (for Usecases and other fun.  Imagine if the Search\npage was cached so the same results showed for any request.)\n\nThat leaves regular URLs for non-loggedIn visitors.  That will at least speed\nthe homepage, and may help elsewhere.\n\nIn publication-sitemap.xmap, replace:\n<map:match pattern=\"**.html\">\n...\n</map:match>\n\nWith:\n\n<map:match pattern=\"**.nocache\">\n   <map:generate\nsrc=\"cocoon:/lenyabody-view/{page-envelope:publication-id}/{page-envelope:area}/{page-envelope:document-type}{page-envelope:document-url}\"/>\n     <map:match pattern=\"authoring/**.nocache\">\n        <map:transform\nsrc=\"cocoon://lenya-page/{page-envelope:publication-id}/{../1}.xml?doctype={page-envelope:document-type}\"/>\n     </map:match>\n     <map:transform src=\"../../xslt/util/strip_namespaces.xsl\"/>\n     <map:match pattern=\"live/**.nocache\">\n         <map:transform src=\"../../xslt/authoring/edit/addSourceTags.xsl\">\n             <map:parameter name=\"source\" value=\"{global:cache-dir}/live/{1}.html\"/>\n         </map:transform>\n         <map:transform type=\"write-source\">\n             <map:parameter name=\"serializer\" value=\"html-no-dtd\"/>\n         </map:transform>\n         <map:transform src=\"../../xslt/authoring/edit/removeSourceTags.xsl\"/>\n      </map:match>\n   <map:serialize type=\"xml\"/>\n</map:match>\n\n<map:match pattern=\"**.html\">\n   <map:act type=\"language-exists\">\n      <!-- Is visitor logged in? -->\n      <map:select type=\"parameter\">\n         <map:parameter name=\"parameter-selector-test\"\nvalue=\"{access-control:user-id}\"/>\n         <map:when test=\"\">\n         </map:when>\n        <map:otherwise>\n           <map:generate src=\"cocoon:/{../1}.nocache\"/>\n           <map:serialize type=\"html\"/>\n        </map:otherwise>\n      </map:select>\n      <!-- Has querystring? -->\n      <map:select type=\"parameter\">\n         <map:parameter name=\"parameter-selector-test\"\nvalue=\"{request:queryString}\"/>\n         <map:when test=\"\">\n         </map:when>\n        <map:otherwise>\n           <map:generate src=\"cocoon:/{../1}.nocache\"/>\n           <map:serialize type=\"html\"/>\n        </map:otherwise>\n      </map:select>\n      <map:select type=\"resource-exists\">\n        <!-- Check Cache -->\n        <map:when test=\"{global:cache-dir}/{../1}.html\">\n           <map:read src=\"{global:cache-dir}/{../1}.html\" mime-type=\"text/html\"/>\n        </map:when>\n        <map:otherwise>\n           <map:generate src=\"cocoon:/{../1}.nocache\"/>\n           <map:serialize type=\"html\"/>\n        </map:otherwise>\n      </map:select>\n   </map:act>\n   <!-- There is no version of the requested document-id for the requested\nlanguage. -->\n   <map:generate type=\"serverpages\"\nsrc=\"../../content/exception/missing-language.xsp\"/>\n   <map:transform src=\"../../xslt/exception/missing-language.xsl\"/>\n   <map:call resource=\"style-cms-page\"/>\n</map:match>\n\nThis has been alpha tested.  There were a few changes from the user-ML post. \nSomeone else should test before committing.\n\nsolprovider", "id": 76510, "time": "2005-06-18T01:57:26Z", "creator": "solprovider@gmail.com", "creation_time": "2005-06-18T01:57:26Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "solprovider@gmail.com", "attachment_id": null, "id": 76522, "time": "2005-06-18T23:28:31Z", "bug_id": 35407, "creation_time": "2005-06-18T23:28:31Z", "is_private": false, "text": "Moved writeToCache to only happen if the document was expected in the cache. \nPrevents security hole if the first visitor to a webpage does not use the cache.\n\n<map:match pattern=\"**.nocache\">\n   <map:generate\nsrc=\"cocoon:/lenyabody-view/{page-envelope:publication-id}/{page-envelope:area}/{page-envelope:document-type}{page-envelope:document-url}\"/>\n     <map:match pattern=\"authoring/**.nocache\">\n        <map:transform\nsrc=\"cocoon://lenya-page/{page-envelope:publication-id}/{../1}.xml?doctype={page-envelope:document-type}\"/>\n     </map:match>\n     <map:transform src=\"../../xslt/util/strip_namespaces.xsl\"/>\n   <map:serialize type=\"xml\"/>\n</map:match>\n\n<map:match pattern=\"**.html\">\n   <map:act type=\"language-exists\">\n      <!-- Is visitor logged in? -->\n      <map:select type=\"parameter\">\n         <map:parameter name=\"parameter-selector-test\"\nvalue=\"{access-control:user-id}\"/>\n         <map:when test=\"\">\n         </map:when>\n        <map:otherwise>\n           <map:generate src=\"cocoon:/{../1}.nocache\"/>\n           <map:serialize type=\"html\"/>\n        </map:otherwise>\n      </map:select>\n      <!-- Has querystring? -->\n      <map:select type=\"parameter\">\n         <map:parameter name=\"parameter-selector-test\"\nvalue=\"{request:queryString}\"/>\n         <map:when test=\"\">\n         </map:when>\n        <map:otherwise>\n           <map:generate src=\"cocoon:/{../1}.nocache\"/>\n           <map:serialize type=\"html\"/>\n        </map:otherwise>\n      </map:select>\n      <map:select type=\"resource-exists\">\n        <!-- Check Cache -->\n        <map:when test=\"{global:cache-dir}/{../1}.html\">\n           <map:read src=\"{global:cache-dir}/{../1}.html\" mime-type=\"text/html\"/>\n        </map:when>\n        <map:otherwise>\n           <map:generate src=\"cocoon:/{../1}.nocache\"/>\n     <map:match pattern=\"live/**.html\">\n         <map:transform src=\"../../xslt/authoring/edit/addSourceTags.xsl\">\n             <map:parameter name=\"source\" value=\"{global:cache-dir}/live/{1}.html\"/>\n         </map:transform>\n         <map:transform type=\"write-source\">\n             <map:parameter name=\"serializer\" value=\"html-no-dtd\"/>\n         </map:transform>\n         <map:transform src=\"../../xslt/authoring/edit/removeSourceTags.xsl\"/>\n      </map:match>\n           <map:serialize type=\"html\"/>\n        </map:otherwise>\n      </map:select>\n   </map:act>\n   <!-- There is no version of the requested document-id for the requested\nlanguage. -->\n   <map:generate type=\"serverpages\"\nsrc=\"../../content/exception/missing-language.xsp\"/>\n   <map:transform src=\"../../xslt/exception/missing-language.xsl\"/>\n   <map:call resource=\"style-cms-page\"/>\n</map:match>"}, {"text": "Created attachment 18321\ndisables browser and proxy caching in the authoring area, so that users see their changes immediately.", "tags": [], "bug_id": 35407, "attachment_id": 18321, "count": 2, "id": 89280, "time": "2006-05-19T08:36:54Z", "creator": "nettings@apache.org", "creation_time": "2006-05-19T08:36:54Z", "is_private": false}, {"count": 3, "attachment_id": null, "creator": "nettings@apache.org", "is_private": false, "id": 89285, "time": "2006-05-19T12:23:52Z", "bug_id": 35407, "creation_time": "2006-05-19T12:23:52Z", "tags": [], "text": "(In reply to comment #2)\n> Created an attachment (id=18321) [edit]\n> disables browser and proxy caching in the authoring area, so that users see\n> their changes immediately.\n\nsorry, this attachment was meant for bug #38723.\n"}]