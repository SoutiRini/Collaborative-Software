[{"count": 0, "tags": [], "creator": "sharathkumarmn@gmail.com", "attachment_id": 34710, "id": 196680, "time": "2017-02-03T04:13:08Z", "bug_id": 60685, "creation_time": "2017-02-03T04:13:08Z", "is_private": false, "text": "Created attachment 34710\ntest document\n\nWhen i try to parse the attached .pub file, it fails with the below exception\nCaused by: java.lang.ArrayIndexOutOfBoundsException: 88\nat org.apache.poi.util.LittleEndian.getUShort(LittleEndian.java:343)\nat org.apache.poi.hpbf.model.qcbits.QCPLCBit$Type12.<init>(QCPLCBit.java:215)\nat org.apache.poi.hpbf.model.qcbits.QCPLCBit$Type12.<init>(QCPLCBit.java:176)\nat org.apache.poi.hpbf.model.qcbits.QCPLCBit.createQCPLCBit(QCPLCBit.java:90)\nat org.apache.poi.hpbf.model.QuillContents.<init>(QuillContents.java:71)\nat org.apache.poi.hpbf.HPBFDocument.<init>(HPBFDocument.java:67)\nat org.apache.poi.hpbf.extractor.PublisherTextExtractor.<init>(PublisherTextExtractor.java:45)\nat org.apache.tika.parser.microsoft.OfficeParser.parse(OfficeParser.java:141)\nat org.apache.tika.parser.microsoft.OfficeParser.parse(OfficeParser.java:117)\nat org.apache.tika.parser.CompositeParser.parse(CompositeParser.java:280)\n... 28 more"}, {"count": 1, "tags": [], "creator": "onealj@apache.org", "attachment_id": null, "id": 199670, "time": "2017-07-09T23:51:27Z", "bug_id": 60685, "creation_time": "2017-07-09T23:51:27Z", "is_private": false, "text": "Knowing nothing about the Compound File Binary Format (is this the same as or a predecessor to OLE2 containers?) [1.2]\n\nCHNKINK record offset = 0x8200\nQC Bit offset = 0x8340 - 0x8200 = 0x0140\nAnnotated contents of data[offset:offset+24]:\n          +0    | +2          | +6    | +8    | +10   | +12         | +16         | +20\n          recID | thingType   | optA  | optB  | optC  | bitType     | from        | len\n00008340  18 00 | 54 4f 4b 4e | 00 00 | 01 00 | 00 00 | 50 4c 43 20 | 32 62 00 00 | 58 00 00 00\ndata      QCBit | \"TOKN\"      | false | true  | false | \"PLC \"      | 0x6232      | 0x58 = 88 bytes\n\n\nLocation    Len Hex Value    Field      Meaning (Little Endian conv, ASCII, hex to dec, etc)\n00008200+00 [8] 43 48 4e 4b 49 4e 4b 20 \"CHNKINK \"\n...\n00008340+00 [2] 18 00        QC Bit recID\n00008340+02 [4] 54 4f 4b 4e  thingType  \"TOKN\"\n00008340+06 [2] 00 00        optA       0x0000 -> false\n00008340+08 [2] 01 00        optB       0x0001 -> true\n00008340+10 [2] 00 00        optC       0x0000 -> false\n00008340+12 [4] 50 4c 43 20  bitType    \"PLC \"\n00008340+16 [4] 32 62 00 00  data from  0x6232, the byte offset from the beginning of the CHNKINK record at 0x8200\n00008340+20 [4] 58 00 00 00  data len   0x58 = 88 bytes\n...\nAnd the raw QCPLCBit record at 0x8200+0x6232=0xe432:\n0000e430        03 00 00 00 0c 00  00 00 ff ff 01 00 06 01    |..............|\n0000e440  00 00 11 01 00 00 4e 07  00 00 5a 07 00 00 16 00  |......N...Z.....|\n0000e450  00 00 00 22 00 06 00 00  01 22 09 00 00 00 02 22  |...\".....\".....\"|\n0000e460  07 00 00 00 0a 00 00 00  01 22 0f 00 00 00 0a 00  |.........\"......|\n0000e470  00 00 01 22 0a 00 00 00  0a 00 00 00 00 22 ff ff  |...\".........\"..|\n0000e480  ff ff 04 00 00 00 04 00  00 00                    |..........|\n\nInterpreting the QCPLCBit:\n0000e432+0  03 00 00 00   3       number of PLCs\n0000e432+4  0c 00 00 00   Type12 (holds hyperlinks, complicated) type of PLCs\n...\n\nThe QC Bit header specifies the QC PLC Bit record has a length of 88 bytes.\nThe QCPLCBit specifies it contains 3 hyperlink PLCs (Type 12, 0x0c).\nFrom how I interpret the current code, there's no way that 3 PLC hyperlinks can be specified in 88 bytes.\n> oneStartsAt = 0x4c\n> twoStartsAt = 0x68\n> threePlusIncrement = 22\nTherefore three probably starts at 0x68+22=0x7e and ends at 0x68+22*2=0x94\nWith 0x58=88 bytes, there aren't even enough bytes for a second, let alone a third PLC.\n\nI guess we'd have to consult [MS-CFB][2] to figure out if this QCPLCBit record really can be 88 bytes long or if the file is corrupt and silently skips over reading these hyperlinks.\n\n[1] https://en.wikipedia.org/wiki/Compound_File_Binary_Format\n[2] https://msdn.microsoft.com/en-us/library/dd942138.aspx"}, {"count": 2, "tags": [], "bug_id": 60685, "attachment_id": null, "text": "The last real change to supporting HPBF hyperlinks was nearly 9 years ago, and even then the commit message indicated partial hyperlink support. So it's quite likely that we haven't fully implemented all hyperlink variations.\n\nI expected to see some hyperlink URL as a string in the hexdump, but perhaps this is a hyperlink to another element within the document.\n\nNonetheless, there are some nuggets of insight in the comments and variable names to figure out what's going on in this QC PLC hyperlink bit.\nhttps://svn.apache.org/viewvc/poi/trunk/src/scratchpad/src/org/apache/poi/hpbf/model/qcbits/QCPLCBit.java?r1=690729&r2=690534", "id": 199671, "time": "2017-07-10T00:11:18Z", "creator": "onealj@apache.org", "creation_time": "2017-07-10T00:11:18Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 60685, "is_private": false, "id": 199672, "creation_time": "2017-07-10T01:28:31Z", "time": "2017-07-10T01:28:31Z", "creator": "onealj@apache.org", "text": "The Microsoft Publisher binary .pub format is undocumented, as indicated here: https://poi.apache.org/hpbf/index.html\n\nOpenOffice/LibreOffice doesn't have documentation or an open source application that reads this .pub format, to my knowledge, so that means we'd have to resort to figuring out the format through lots of hard work.\n\nAssuming the file you have provided is valid (opens without warnings or errors in Microsoft Publisher), if you're mostly interested in text extraction, then skipping over this hyperlink is probably preferable over throwing an exception.\nWe can log the error that we catch and move forward with extraction.", "attachment_id": null}, {"count": 4, "attachment_id": null, "creator": "onealj@apache.org", "is_private": false, "id": 199673, "time": "2017-07-10T01:38:26Z", "bug_id": 60685, "creation_time": "2017-07-10T01:38:26Z", "tags": [], "text": "Workaround applied in r1801405. Will be included in POI 3.17 beta 2.\n\nLooking for any volunteers willing to experiment with the .pub format and extend our documented understanding here: https://poi.apache.org/hpbf/file-format.html"}, {"count": 5, "tags": [], "creator": "tallison@mitre.org", "is_private": false, "id": 199689, "creation_time": "2017-07-10T12:53:16Z", "time": "2017-07-10T12:53:16Z", "bug_id": 60685, "text": "Looks like we have ~8500 publisher files in our regression corpus if those would be of any interest.  Some are likely truncated...so it goes w Common Crawl.", "attachment_id": null}]