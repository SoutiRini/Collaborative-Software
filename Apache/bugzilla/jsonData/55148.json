[{"count": 0, "tags": [], "bug_id": 55148, "attachment_id": null, "id": 168082, "time": "2013-06-26T20:20:10Z", "creator": "allen.zhao@telus.com", "creation_time": "2013-06-26T20:20:10Z", "is_private": false, "text": "We upgrade our apache from 2.2.17 to 2.2.24. We use the same setting. However, we keep getting 502 bad gateway issue.\n\nI tried following settings as well, but no luck.\n    SSLProxyCACertificateFile /work/users/infra/proxy/proxyCA.crt\n    SSLProxyMachineCertificateFile /work/users/infra/proxy/lp97643.pem\n    SSLProxyVerify none\n    SSLProxyCheckPeerCN off\n    SSLProxyCheckPeerExpire off\n\nI have verified by proxyCA with curl, it works fine.\n\nI struggled with this issue for couple of weeks. I doubt this might be new bug.\n\nThanks a lot,\n\nThe error log:\n[Wed Jun 26 19:08:35 2013] [error] (502)Unknown error 502: proxy: pass request body failed to 142.63.42.254:443 \n[Wed Jun 26 19:08:35 2013] [error] [client 192.168.156.135] proxy: Error during SSL Handshake with remote server returned by /Offline/, referer: https://abc.xyz.com/Offline/\n[Wed Jun 26 19:08:35 2013] [error] proxy: pass request body failed to 142.63.42.254:443 from 192.168.156.135 ()\n\n\nThe config:\nNameVirtualHost *:50211\n<VirtualHost *:50211>\n    ServerAdmin admin@example.com\n    DocumentRoot \"/work/users/infra/proxy/PR_Offline_https/htdocs\"\n    <Directory \"/work/users/infra/proxy/PR_Offline_https/htdocs\">\n        Allow from all\n    </Directory>\n    SSLEngine on\n    SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL\n    SSLProxyEngine on\n    SSLCertificateFile      /work/users/infra/proxy/lp97643.crt\n    SSLCertificateKeyFile   /work/users/infra/proxy/lp97643.key\n    RequestHeader set X-Authenticated-User %{REMOTE_USER}e\n    ProxyRequests On\n    ProxyVia On\n    ProxyPreserveHost On\n    ProxyPass /Offline http://142.63.42.254/Offline/\n    ProxyPassReverse /Offline http://142.63.42.254/OfflineS/\n    BrowserMatch \".*MSIE.*\" \\\n         nokeepalive ssl-unclean-shutdown \\\n         downgrade-1.0 force-response-1.0\n    SetEnv force-proxy-request-1.0 1\n    SetEnv proxy-nokeepalive 1\n</VirtualHost>\n\nThe compile settings:\n\nbin/httpd -V\nServer version: Apache/2.2.24 (Unix)\nServer built:   May 21 2013 14:49:46\nServer's Module Magic Number: 20051115:31\nServer loaded:  APR 1.4.6, APR-Util 1.4.1\nCompiled using: APR 1.4.6, APR-Util 1.4.1\nArchitecture:   64-bit\nServer MPM:     Prefork\n  threaded:     no\n    forked:     yes (variable process count)\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"/apps/infra/apache/2.2.24\"\n -D SUEXEC_BIN=\"/apps/infra/apache/2.2.24/bin/suexec\"\n -D DEFAULT_PIDLOG=\"logs/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_LOCKFILE=\"logs/accept.lock\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\""}, {"count": 1, "tags": [], "creator": "allen.zhao@telus.com", "text": "I also built openssl from source version: 1.0.1e", "id": 168084, "time": "2013-06-26T20:27:37Z", "bug_id": 55148, "creation_time": "2013-06-26T20:27:37Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "allen.zhao@telus.com", "attachment_id": null, "is_private": false, "id": 168096, "time": "2013-06-27T14:13:44Z", "bug_id": 55148, "creation_time": "2013-06-27T14:13:44Z", "text": "I rebuilt apache with openssl 1.0.0d. it works.\n\nAny idear?\n\nThx a lot,"}, {"attachment_id": null, "tags": [], "bug_id": 55148, "is_private": false, "count": 3, "id": 168099, "time": "2013-06-27T14:36:54Z", "creator": "covener@gmail.com", "creation_time": "2013-06-27T14:36:54Z", "text": "Can you validate a connection to the backend server with openssl s_client between the two builds?"}, {"attachment_id": null, "tags": [], "bug_id": 55148, "text": "1.0.0d works fine.\n\n1.0.1e: it doesn't read anything from stdin (e.g. enter a http request)\n\nI got same issue with 2.2.25/1.0.1e.\n\n2.2.25/1.0.0d works fine. This looks OpenSSL related.\n\nbin/openssl s_client -host 172.23.199.200 -port 443\nCONNECTED(00000003)\n\nwrite:errno=104\n---\nno peer certificate available\n---\nNo client certificate CA names sent\n---\nSSL handshake has read 0 bytes and written 321 bytes\n---\nNew, (NONE), Cipher is (NONE)\nSecure Renegotiation IS NOT supported\nCompression: NONE\nExpansion: NONE\n---", "count": 4, "id": 169888, "time": "2013-09-03T20:07:04Z", "creator": "allen.zhao@telus.com", "creation_time": "2013-09-03T20:07:04Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 55148, "is_private": false, "count": 5, "id": 169889, "time": "2013-09-03T20:17:15Z", "creator": "allen.zhao@telus.com", "creation_time": "2013-09-03T20:17:15Z", "text": "Here is part of the output from 1.0.0d:\n\nbin/openssl s_client -host 172.23.199.200 -port 443\nCONNECTED(00000003)\ndepth=1 C = CA, ST = Ontario, L = Toronto, O = TELUS, OU = Application Infrastructure, CN = www.telus.com\nverify error:num=19:self signed certificate in certificate chain\nverify return:0\n---\nCertificate chain\n 0 s:/C=CA/ST=Ontario/L=Toronto/O=TELUS/OU=Application Infrastructure/CN=telusmobility.tmi.telus.com\n   i:/C=CA/ST=Ontario/L=Toronto/O=TELUS/OU=Application Infrastructure/CN=www.telus.com\n 1 s:/C=CA/ST=Ontario/L=Toronto/O=TELUS/OU=Application Infrastructure/CN=www.telus.com\n   i:/C=CA/ST=Ontario/L=Toronto/O=TELUS/OU=Application Infrastructure/CN=www.telus.com\n---\nServer certificate\n-----BEGIN CERTIFICATE-----\nMIIDIDCCAomgAwIBAgIDEADpMA0GCSqGSIb3DQEBBQUAMH4xCzAJBgNVBAYTAkNB\nMRAwDgYDVQQIEwdPbnRhcmlvMRAwDgYDVQQHEwdUb3JvbnRvMQ4wDAYDVQQKEwVU\nRUxVUzEjMCEGA1UECxMaQXBwbGljYXRpb24gSW5mcmFzdHJ1Y3R1cmUxFjAUBgNV\nBAMTDXd3dy50ZWx1cy5jb20wHhcNMDkwMzAyMTYxNTA4WhcNMTQwMzAxMTYxNTA4\nWjCBjDELMAkGA1UEBhMCQ0ExEDAOBgNVBAgTB09udGFyaW8xEDAOBgNVBAcTB1Rv\ncm9udG8xDjAMBgNVBAoTBVRFTFVTMSMwIQYDVQQLExpBcHBsaWNhdGlvbiBJbmZy\nYXN0cnVjdHVyZTEkMCIGA1UEAxMbdGVsdXNtb2JpbGl0eS50bWkudGVsdXMuY29t\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCUi+ni+nyqZUugOOmkFovxmYi8\nN/bARsvInCK6bXzYDhQQJr6+NtX5LytUDhDYHQXQVAL9Lm0wtOcNsrFLjEukvPuc\nSI2Fr/4HWajIIA6uebFPIz5AvJh7jVYsDvv8/XcC+VgBh2TeJtSEZ5sDLj6mEF2y\nThAhffEHS3Ye5Ij+5wIDAQABo4GcMIGZMAkGA1UdEwQCMAAwEQYJYIZIAYb4QgEB\nBAQDAgXgMAsGA1UdDwQEAwIF4DAsBglghkgBhvhCAQ0EHxYdT3BlblNTTCBHZW5l\ncmF0ZWQgQ2VydGlmaWNhdGUwHQYDVR0OBBYEFI3c2E1SsZBpaTYZOd3y1yUdWZTH\nMB8GA1UdIwQYMBaAFFmwVgMX8YForRj3nr1434gfsUwaMA0GCSqGSIb3DQEBBQUA\nA4GBABb/lsKiK42488U0w3oJuRJdIl6IRdmZTCp223tFpFihc0Se7jeiJeHKPniq\neNFnuKWbc52wiyLk98q313vp3DV3wfAafcYo77KwiXVPx9PUFcsJvZb9kJ8M6CxG\nvLwicZg0gZFHegQRUkyKeYJHTcLbRZOyR5huX3gqklPJYlhm\n-----END CERTIFICATE-----\nsubject=/C=CA/ST=Ontario/L=Toronto/O=TELUS/OU=Application Infrastructure/CN=telusmobility.tmi.telus.com\nissuer=/C=CA/ST=Ontario/L=Toronto/O=TELUS/OU=Application Infrastructure/CN=www.telus.com\n---\nNo client certificate CA names sent\n---\nSSL handshake has read 1824 bytes and written 392 bytes\n---\nNew, TLSv1/SSLv3, Cipher is RC4-MD5\nServer public key is 1024 bit\nSecure Renegotiation IS NOT supported\nCompression: NONE\nExpansion: NONE\nSSL-Session:\n    Protocol  : TLSv1\n    Cipher    : RC4-MD5\n    Session-ID: 7549FF55BA4A41504A7E0C5AC261BC44BEFAA5E9CBEF366D7213C9A0DF2147BD\n    Session-ID-ctx:\n    Master-Key: 2D0F124D2315E89C48F4DD3573B1985716C56C90C4D6D723CB35701C0F0EA31AF47C84D3B772EC6DCD669A3D008C0771\n    Key-Arg   : None\n    PSK identity: None\n    PSK identity hint: None\n    Start Time: 1378238532\n    Timeout   : 300 (sec)\n    Verify return code: 19 (self signed certificate in certificate chain)\n---\nGET /\n\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\"\n \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">"}, {"count": 6, "tags": [], "bug_id": 55148, "attachment_id": null, "text": "For 1.0.1e, if I add -ssl3, it works:\n\nbin/openssl s_client -host 172.23.199.200 -port 443 -ssl3\nCONNECTED(00000003)\ndepth=1 C = CA, ST = Ontario, L = Toronto, O = TELUS, OU = Application Infrastructure, CN = www.telus.com\nverify error:num=19:self signed certificate in certificate chain\nverify return:0\n---\nCertificate chain\n 0 s:/C=CA/ST=Ontario/L=Toronto/O=TELUS/OU=Application Infrastructure/CN=telusmobility.tmi.telus.com\n   i:/C=CA/ST=Ontario/L=Toronto/O=TELUS/OU=Application Infrastructure/CN=www.telus.com\n 1 s:/C=CA/ST=Ontario/L=Toronto/O=TELUS/OU=Application Infrastructure/CN=www.telus.com\n   i:/C=CA/ST=Ontario/L=Toronto/O=TELUS/OU=Application Infrastructure/CN=www.telus.com\n---\nServer certificate\n-----BEGIN CERTIFICATE-----\n...", "id": 169890, "time": "2013-09-03T20:23:56Z", "creator": "allen.zhao@telus.com", "creation_time": "2013-09-03T20:23:56Z", "is_private": false}, {"count": 7, "tags": [], "creator": "allen.zhao@telus.com", "attachment_id": null, "text": "This seems caused by TLSV1.2.\n\nI solve the problem by adding following line to httpd.conf.\n\nSSLProxyProtocol +SSLv2 +SSLv3 +TLSv1 +TLSv1.1\n\nThanks a lot,\n\nAllen", "id": 169911, "time": "2013-09-05T05:37:55Z", "bug_id": 55148, "creation_time": "2013-09-05T05:37:55Z", "is_private": false}]