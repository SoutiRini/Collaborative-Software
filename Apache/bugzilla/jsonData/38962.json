[{"count": 0, "tags": [], "bug_id": 38962, "attachment_id": null, "text": "Configure an Apache to use a balancer to redirect requests say to one tomcat \nbut without failover system (noFailover=on). On tomcat, configure it with a \njvmroute (appended to JSESSIONID) and deploy a sample test.jsp page that \nsimply displays \"hello world !\".\n\n1/ Opens up your favourite browser and call the test jsp page: OK\n2/ Stop your tomcat and call the test jsp page: you get the 503 error page and \nyour worker is flagged in error state\n3/ don't close your browser, call again the page: you still get the 503 page \nbut in the error apache log, you get a \"All workers are in error state for \nroute (xxxxx)\" \n4/ don't close your browser (to keep the session cookie)\n5/ restart your tomcat and wait at least 90s (default retry timeout for a \nworker is 60s and give a chance to your tomcat to complete its startup)\n6/ call your test jsp page with your browser left opened in 4: still get a 503 \nerror\n7/ open a new browser, call the test jsp page: it works !\n\nPb in in mod_proxy_balancer.c inside find_session_route function: it finds the \nworker associated with the route provided by the client but doesn't call the \nap_proxy_retry_worker to check if it is time to try the worker again.\n\nWill attach the \"diff -u\" output as an attachment.", "id": 86798, "time": "2006-03-14T14:02:58Z", "creator": "christian_boitel@yahoo.fr", "creation_time": "2006-03-14T14:02:58Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 38962, "attachment_id": 17892, "id": 86799, "time": "2006-03-14T14:04:35Z", "creator": "christian_boitel@yahoo.fr", "creation_time": "2006-03-14T14:04:35Z", "is_private": false, "text": "Created attachment 17892\nUnified diff for patch to apply to mod_proxy_balancer.c"}, {"count": 2, "text": "Committed a slightly modified version to trunk as r417443\n(http://svn.apache.org/viewvc?rev=417443&view=rev). Thanks.", "bug_id": 38962, "attachment_id": null, "id": 90635, "time": "2006-06-27T12:08:14Z", "creator": "rpluem@apache.org", "creation_time": "2006-06-27T12:08:14Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "creator": "christian_boitel@yahoo.fr", "is_private": false, "id": 92447, "attachment_id": null, "bug_id": 38962, "creation_time": "2006-08-23T07:06:44Z", "time": "2006-08-23T07:06:44Z", "text": "Is it possible to commit change in 2.2 branch ?\n\nI was expecting the fix to appear in the recent 2.2.3 release."}, {"count": 4, "tags": [], "bug_id": 38962, "is_private": false, "id": 92475, "creation_time": "2006-08-23T19:32:27Z", "time": "2006-08-23T19:32:27Z", "creator": "rpluem@apache.org", "text": "Thanks for the reminder. Proposed for backport as r434133\n(http://svn.apache.org/viewvc?rev=434133&view=rev).", "attachment_id": null}, {"count": 5, "text": "Looks like I'm seeing this bugs as well.\n\nI am running Apache 2.2.3 on RedHat EL 5. I am trying to use Apache to load\nbalance between two local instances of tomcat in order to utilize the vast\nquantities of RAM on our production server.\n\nMy httpd setup looks like this:\n\n<Proxy balancer://tomcat>\n    BalancerMember ajp://localhost:8009 min=10 max=100 route=tomcat1\nloadfactor=1 retry=120\n    BalancerMember ajp://localhost:8010 min=10 max=100 route=tomcat2\nloadfactor=1 retry=120 </Proxy>\n\n<Location /balancer-manager>\n    SetHandler balancer-manager\n    Order deny,allow\n    Deny from all\n    Allow from .trimblecorp.net\n</Location>\n\nProxyPass /dscgi/ds.py/ balancer://tomcat/docushare/dsweb/\nstickysession=JSESSIONID nofailover=On ProxyPass /docushare\nbalancer://tomcat/docushare stickysession=JSESSIONID nofailover=On ProxyPass\n/docushare/ balancer://tomcat/docushare/ stickysession=JSESSIONID nofailover=On\n\nThe problem is that if one of the workers gets into error status, any client\nwith a JSESSIONID referencing that route is never able to receive a reply,\nApache *always* responds with a 503 \u2013 Temporarily unavailable, *until* another\nrequest is successful. I expected with \"retry=120\" that after 120 seconds the\nclient would be able to use the errored out worker, but this is *not* the case.\n\nTest case:\n\n1. Start tomcats\n2. Access /docushare, this succeeds and returns a JSESSIONID cookie referencing\nthe member e.g. JSESSIONID=BC90C156669FDF0194657FF27EC3AF99.tomcat2\n3. Stop tomcats to simulate a backend failure \n4. Access /docushare again in the same browser session, this fails with a 503\nerror (as expected). Balance-manager shows tomcat1 is OK, and tomcat2 is Err\nError_log shows: All workers are in error state for route (tomcat2) \n5. Start tomcats again \n6. Wait for 120+ seconds to allow retry=120 to take effect\n7. Access /docushare *using the session with the tomcat2 cookie*, expect\nsuccess, get 503 error. I can repeat this step ad nauseam without ever getting a\nsuccessful response.\nError_log shows: All workers are in error state for route (tomcat2) \n8. To resolve the issue, delete the JSESSIONID cookie from the client or open up\na new browser and access /docushare. Either of these seem to solve the problem\nfor the \"cookied\" browser session.\n", "bug_id": 38962, "attachment_id": null, "id": 103857, "time": "2007-05-30T20:42:53Z", "creator": "Dale_Ogilvie@trimble.com", "creation_time": "2007-05-30T20:42:53Z", "tags": [], "is_private": false}, {"count": 6, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "id": 103874, "time": "2007-05-31T05:43:47Z", "bug_id": 38962, "creation_time": "2007-05-31T05:43:47Z", "is_private": false, "text": "This should be fixed by the patch mentioned in comment #2. This fix is already\npart of httpd 2.2.4. So please apply the patch mentioned above or upgrade to\n2.2.4 to resolve your problem."}]