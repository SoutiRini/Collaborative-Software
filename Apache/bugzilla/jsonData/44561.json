[{"count": 0, "tags": [], "bug_id": 44561, "attachment_id": 21646, "text": "Created attachment 21646\nPatch for 2.0.63\n\nScenario:\n\n- Per-directory SSLVerifyClient\n- SSLOptions +OptRenegotiate\n\nQuick renegotiation fails because the certification verification procedure sets the Verify Result incorrectly.\n\nBug exists in 2.0/2.2/trunk.\n\nDetail:\n\n            if (!modssl_X509_verify_cert(&cert_store_ctx)) {\n                ap_log_error(APLOG_MARK, APLOG_ERR, 0, r->server,\n                             \"Re-negotiation verification step failed\");\n                ssl_log_ssl_error(APLOG_MARK, APLOG_ERR, r->server);\n            }\n\n            SSL_set_verify_result(ssl, cert_store_ctx.error);\n\nFunction mod_ssl_509_verify_cert(ctx) does not set cert_store.ctx.error unless there was a problem verifying the certificate. Therefore, we do not to set the verify_result to this value. Current behavior sets this to an undefined value (which is NOT X509_V_OK).\n\nFix attached (against 2.0).", "id": 114426, "time": "2008-03-07T11:44:12Z", "creator": "asf@divinehawk.com", "creation_time": "2008-03-07T11:44:12Z", "is_private": false}, {"count": 1, "tags": [], "creator": "asf@divinehawk.com", "attachment_id": null, "id": 114427, "time": "2008-03-07T11:48:09Z", "bug_id": 44561, "creation_time": "2008-03-07T11:48:09Z", "is_private": false, "text": "Also note that fixing this functionality exposes another issue. You can't use the dbm session cache since the certificate data won't fit.\n\n\"data size too large for DBM session cache\"\n\nI had to use shmcb backend instead.\n"}, {"count": 2, "tags": [], "bug_id": 44561, "attachment_id": null, "text": "Hmmm, another quick-reneg issue.\n\nWhat was getting logged on failure, without this patch?\n\nI don't understand why your patch would have any effect:\n\n1) X509_STORE_CTX_init does initialize context->error to 0 (aka X509_V_OK)\n2) SSL_set_verify_result should thus be safe.\n\nWhat version of OpenSSL are you using?", "id": 115876, "time": "2008-04-25T09:03:38Z", "creator": "jorton@redhat.com", "creation_time": "2008-04-25T09:03:38Z", "is_private": false}, {"count": 3, "tags": [], "creator": "asf@divinehawk.com", "attachment_id": null, "id": 115897, "time": "2008-04-25T13:57:56Z", "bug_id": 44561, "creation_time": "2008-04-25T13:57:56Z", "is_private": false, "text": "I could not reproduce the original problem I was having. \n\nPerhaps just using shmcb rather than dbm allowed it to work."}, {"count": 4, "tags": [], "bug_id": 44561, "attachment_id": null, "text": "Resolution: don't use DBM with client certificates.", "id": 132313, "time": "2009-11-25T07:15:45Z", "creator": "asf@divinehawk.com", "creation_time": "2009-11-25T07:15:45Z", "is_private": false}]