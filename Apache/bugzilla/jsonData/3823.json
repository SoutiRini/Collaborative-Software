[{"count": 0, "tags": [], "creator": "brett.knights@tanner.com", "attachment_id": null, "is_private": false, "id": 6016, "time": "2001-09-25T12:41:59Z", "bug_id": 3823, "creation_time": "2001-09-25T12:41:59Z", "text": "> I have installed TC4 and have it working.\n>\n> I am moving an app that worked fine under TC3.3.\n>\n> My problem is that when I call:\n>\n>\n> res.setHeader(\"WWW-Authenticate\", BASIC realm=\\\"\" + domain\n+\"\\\");\n> rese.sendError(res.SC_UNAUTHORIZED);\n>\n> in my servlet the authenticate header is stripped from the\n> result. (examples follow)\n> This occurs whether I make the request through IIS (actually\n> PWS) or to TC directly via port 8080\n\nThe problem appears to be in \norg.apache.catalina.core.StandardWrapperValve.status()\n\nThis is run to respond to status messages but it calls \norg.apache.catalina.connector.HttpResponseBase.reset(int status, String \nmessage) which in turn calls HttpResponse.reset()\n\nHttpResponseBase already resets the content or headers appropriately for the \nAPI methods called.\nstatus() does it again (in what I assume is a \"let's be sure it was done\" kind \nof way) but according to the spec that isn't appropriate.\n\nThe spec doesn't specify that HttpResponse.sendError(int status) must clear the \nheaders only that it must clear the buffer and set any appropriate headers.\n\nThe spec does specify that HttpResponse.sendError(int status, String message) \nand HttpResponse.setStatus(int status) should return any headers already set.  \n\nI believe the following would changes would restore spec compliance (at the \nrisk of breaking what else I don't know) \n\norg.apache.catalina.connector.HttpResponseBase.reset(int status, String \nmessage) method to call resetBuffer() rather than reset()\n\norg.apache.catalina.core.StandardWrapperValve.custom(req, res, errorpage) on \nline 481 to call hres.resetBuffer() rather than hres.reset()"}, {"count": 1, "tags": [], "bug_id": 3823, "text": "Fixing this bug is quite risky, but we can try it and see what happens. In any \ncase, a lot of headers need to be reset (content-length, content-encoding, \ntransfer-encoding, ranges, etc etc), so that's why we were resetting everything.\n\nEven after the problem is fixed, it would be cleaner to write a realm \nimplementation, instead of putting the authentication layer in the servlet.", "id": 6030, "time": "2001-09-25T14:24:25Z", "creator": "remm@apache.org", "creation_time": "2001-09-25T14:24:25Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 3823, "attachment_id": null, "text": "Overriding any already set headers can be done with the setHeader methods \nrather than addHeader methods.\n\nThe spec is pretty clear on what should happen and the reference implementation \nshould comply with the spec so whether it's risky or not (or my proposed fix \nworks or not) shouldn't really make any difference to whether this bug gets \nassigned a high priority or not.\n\nFWIW I have a bunch of applications running using this and, while I may go to \nrealm based security in the future, I don't want to have to change something \nthta isn't broken.", "id": 6034, "time": "2001-09-25T15:36:50Z", "creator": "brett.knights@tanner.com", "creation_time": "2001-09-25T15:36:50Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 3823, "text": "Fixed in the CVS HEAD branch.", "id": 6080, "time": "2001-09-26T18:07:15Z", "creator": "remm@apache.org", "creation_time": "2001-09-26T18:07:15Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 3823, "text": "*** Bug 3939 has been marked as a duplicate of this bug. ***", "id": 6320, "time": "2001-10-03T10:45:10Z", "creator": "remm@apache.org", "creation_time": "2001-10-03T10:45:10Z", "is_private": false, "attachment_id": null}]