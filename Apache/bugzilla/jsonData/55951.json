[{"count": 0, "tags": [], "bug_id": 55951, "attachment_id": null, "id": 172075, "time": "2014-01-04T21:34:01Z", "creator": "jboynes@apache.org", "creation_time": "2014-01-04T21:34:01Z", "is_private": false, "text": "The HTML5 specification is specifying that cookie values may contain characters that are not part of US-ASCII or ISO-8859-1 and that those codepoints should be UTF-8 encoded for display.\n\nhttp://www.w3.org/html/wg/drafts/html/master/single-page.html#cookie\n\nThis will result in 8-bit high values in cookies that need to be accepted and set.\n\nThis will also require special encoding to handle conversion to the UCS-16 characters used by the Java String used to represent the value in the Cookie class."}, {"count": 1, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "This will be available in 8.0.15 onwards via the Rfc6265CookieProcessor.", "id": 178224, "time": "2014-10-02T11:37:18Z", "bug_id": 55951, "creation_time": "2014-10-02T11:37:18Z", "is_private": false}, {"count": 2, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "Re-opening as the unit test didn't cover the end to end process are there are still some issues to resolve.", "id": 178227, "time": "2014-10-02T12:47:02Z", "bug_id": 55951, "creation_time": "2014-10-02T12:47:02Z", "is_private": false}, {"count": 3, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "text": "(In reply to Jeremy Boynes from comment #0)\n> The HTML5 specification is specifying that cookie values may contain\n> characters that are not part of US-ASCII or ISO-8859-1 and that those\n> codepoints should be UTF-8 encoded for display.\n> \n> http://www.w3.org/html/wg/drafts/html/master/single-page.html#cookie\n>\n\nWhat is the exact wording?\n\nThe above link is broken - there is no \"cookie\" anchor in the current version of that document. All I see are references to [COOKIES] document (#refsCOOKIES anchor) = RFC 6265.\n\nhttp://tools.ietf.org/html/rfc6265\n\n\nRFC 6265 does not allow non-ascii characters in cookie value in Set-Cookie header. Citing from its Chapter 4.1.1. Set-Cookie / Syntax,\n\n set-cookie-header = \"Set-Cookie:\" SP set-cookie-string\n set-cookie-string = cookie-pair *( \";\" SP cookie-av )\n cookie-pair       = cookie-name \"=\" cookie-value\n cookie-name       = token\n cookie-value      = *cookie-octet / ( DQUOTE *cookie-octet DQUOTE )\n cookie-octet      = %x21 / %x23-2B / %x2D-3A / %x3C-5B / %x5D-7E\n                       ; US-ASCII characters excluding CTLs,\n                       ; whitespace DQUOTE, comma, semicolon,\n                       ; and backslash\n\nThe cookie-value is limited to US-ASCII, even when quoted.\n\nAt the same time, attributes (cookie-av) do not have such limitation and as such may be UTF-8:\n\n path-av           = \"Path=\" path-value\n path-value        = <any CHAR except CTLs or \";\">\n\n\nFor reference, the place where UTF-8 is mentioned in RFC 6265 is in chapter 5.4. The Cookie Header. Citing:\n\n   NOTE: Despite its name, the cookie-string is actually a sequence of\n   octets, not a sequence of characters.  To convert the cookie-string\n   (or components thereof) into a sequence of characters (e.g., for\n   presentation to the user), the user agent might wish to try using the\n   UTF-8 character encoding [RFC3629] to decode the octet sequence.\n   This decoding might fail, however, because not every sequence of\n   octets is valid UTF-8.", "id": 178230, "time": "2014-10-02T14:33:20Z", "bug_id": 55951, "creation_time": "2014-10-02T14:33:20Z", "is_private": false}, {"count": 4, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 178234, "time": "2014-10-02T14:43:47Z", "bug_id": 55951, "creation_time": "2014-10-02T14:43:47Z", "is_private": false, "text": "(In reply to Konstantin Kolinko from comment #3)\n> The cookie-value is limited to US-ASCII, even when quoted.\nAgreed.\n\n> At the same time, attributes (cookie-av) do not have such limitation and as\n> such may be UTF-8:\n> \n>  path-av           = \"Path=\" path-value\n>  path-value        = <any CHAR except CTLs or \";\">\n\nNope. CHAR is limited to USASCII. See the definition in section 2.2 of RFC 6265."}, {"count": 5, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 178237, "time": "2014-10-02T15:42:32Z", "bug_id": 55951, "creation_time": "2014-10-02T15:42:32Z", "is_private": false, "text": "Here is a patch that adds support for sending HTTP headers in character sets other than ISO-8859-1 and then uses that support for sending Set-Cookie headers.\n\nBoth AJP and HTTP needed changes SPDY didn't as it already used the approach the patch uses.\n\nI still have some work to do to restore the filtering of CTLs.\n\nhttp://people.apache.org/~markt/patches/2014-10-02-bug55951-tc8-v1.patch"}, {"count": 6, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 178316, "time": "2014-10-07T08:28:52Z", "bug_id": 55951, "creation_time": "2014-10-07T08:28:52Z", "text": "This is the completed patch:\nhttp://people.apache.org/~markt/patches/2014-10-06-bug55951-tc8-v2.patch\n\nI'll give folks a day or so to review and comment and then commit it."}, {"count": 7, "tags": [], "bug_id": 55951, "attachment_id": null, "id": 178378, "time": "2014-10-10T14:29:19Z", "creator": "markt@apache.org", "creation_time": "2014-10-10T14:29:19Z", "is_private": false, "text": "This has now been fixed in 8.0.x for 8.0.15 onwards."}]