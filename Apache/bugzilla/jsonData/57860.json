[{"count": 0, "tags": [], "bug_id": 57860, "text": "Created attachment 32687\njava crash log\n\nI use mina with apr socket (AprSocketAcceptor and AprSocketConnector) for better perfermonce.\n\nthe situation is simple:\n1000 client connnet to mina server and keep alive connectons(long connection), and  another server tell the mina server to push group messages every one minitue. After servel group push, the mina server not work and crashs.\n\n\ni just download and compile  apr-1.5.1.tar.gz and tomcat-native-1.1.33, and modify the mina server code like this:\n        if(useAPR){\n            SimpleIoProcessorPool<AprSession> pool = new SimpleIoProcessorPool<AprSession>(AprIoProcessor.class);\n            acceptor = new AprSocketAcceptor(executor, pool);\n        }else{\n            SimpleIoProcessorPool<NioSession> pool = new SimpleIoProcessorPool<NioSession>(NioProcessor.class);\n            acceptor = new NioSocketAcceptor(executor, pool);\n        }\n\n\n        if(TcpServer.useAPR){\n            connector = new AprSocketConnector();  \n        }else{\n            connector = new NioSocketConnector();  \n        }\n\n\nStack: [0x00007f5a8d327000,0x00007f5a8d3a8000],  sp=0x00007f5a8d3a6470,  free space=509k\nNative frames: (J=compiled Java code, j=interpreted, Vv=VM code, C=native code)\nC  [libtcnative-1.so.0.1.33+0x148cf]  Java_org_apache_tomcat_jni_Poll_poll+0x7f\n\nJava frames: (J=compiled Java code, j=interpreted, Vv=VM code)\nJ  org.apache.tomcat.jni.Poll.poll(JJ[JZ)I\nJ  org.apache.mina.transport.socket.apr.AprIoProcessor.select(J)I\nj  org.apache.mina.core.polling.AbstractPollingIoProcessor$Processor.run()V+52\nj  org.apache.mina.util.NamePreservingRunnable.run()V+29\nj  java.util.concurrent.ThreadPoolExecutor.runWorker(Ljava/util/concurrent/ThreadPoolExecutor$Worker;)V+95\nj  java.util.concurrent.ThreadPoolExecutor$Worker.run()V+5\nj  java.lang.Thread.run()V+11\nv  ~StubRoutines::call_stub\n\n\n---------------  P R O C E S S  ---------------\n\n\n\nUse gdb to \n[root@iZ25kxtgwarZ push_heartserver8888]# gdb /opt/jdk1.7.0_45/bin/java core.17249 \nGNU gdb (GDB) Red Hat Enterprise Linux (7.2-64.el6_5.2)\nCopyright (C) 2010 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"x86_64-redhat-linux-gnu\".\nFor bug reporting instructions, please see:\n<http://www.gnu.org/software/gdb/bugs/>...\nReading symbols from /opt/jdk1.7.0_45/bin/java...Missing separate debuginfo for /opt/jdk1.7.0_45/bin/java\nTry: yum --disablerepo='*' --enablerepo='*-debug*' install /usr/lib/debug/.build-id/b8/2a586842f6da3df8a61093daadf04180e85c16.debug\n(no debugging symbols found)...done.\n[New Thread 17292]\n[New Thread 17312]\n[New Thread 17303]\n[New Thread 17294]\n[New Thread 17252]\n[New Thread 17307]\n[New Thread 17313]\n[New Thread 17304]\n[New Thread 17260]\n[New Thread 17255]\n[New Thread 17320]\n[New Thread 17251]\n[New Thread 17277]\n[New Thread 17325]\n[New Thread 17265]\n[New Thread 17249]\n[New Thread 17285]\n[New Thread 17295]\n[New Thread 17344]\n[New Thread 17343]\n[New Thread 17266]\n[New Thread 17256]\n[New Thread 17250]\n[New Thread 17290]\n[New Thread 17349]\n[New Thread 17253]\n[New Thread 17263]\n[New Thread 17262]\n[New Thread 17346]\n[New Thread 17258]\n[New Thread 17254]\n[New Thread 17272]\n[New Thread 17267]\n[New Thread 17347]\n[New Thread 17342]\n[New Thread 17287]\n[New Thread 17268]\n[New Thread 17257]\n[New Thread 17271]\n[New Thread 17286]\n[New Thread 17273]\n[New Thread 17297]\n[New Thread 17278]\n[New Thread 17274]\n[New Thread 17264]\n[New Thread 17348]\n[New Thread 17261]\n[New Thread 17259]\n[New Thread 17288]\n[New Thread 17308]\n[New Thread 17282]\n[New Thread 17345]\nMissing separate debuginfo for /opt/jdk1.7.0_45/bin/../lib/amd64/jli/libjli.so\nTry: yum --disablerepo='*' --enablerepo='*-debug*' install /usr/lib/debug/.build-id/34/5b529c72e59f506bf391be9a64cbbf7574211f\nMissing separate debuginfo for /opt/jdk1.7.0_45/jre/lib/amd64/server/libjvm.so\nTry: yum --disablerepo='*' --enablerepo='*-debug*' install /usr/lib/debug/.build-id/6f/31a11f5f50e47d14c9871057d41df781aa6ccd\nMissing separate debuginfo for /opt/jdk1.7.0_45/jre/lib/amd64/libverify.so\nTry: yum --disablerepo='*' --enablerepo='*-debug*' install /usr/lib/debug/.build-id/20/b03b77b651a0152ab8de47774328f0cef51987\nMissing separate debuginfo for /opt/jdk1.7.0_45/jre/lib/amd64/libjava.so\nTry: yum --disablerepo='*' --enablerepo='*-debug*' install /usr/lib/debug/.build-id/44/d3e7e98d5c21945a85d4ef6d5e6991a414ae6d\nMissing separate debuginfo for /opt/jdk1.7.0_45/jre/lib/amd64/libzip.so\nTry: yum --disablerepo='*' --enablerepo='*-debug*' install /usr/lib/debug/.build-id/07/c3e3ac6dc32953a6b623b6f9631d3ccc148800\nMissing separate debuginfo for /opt/jdk1.7.0_45/jre/lib/amd64/libnio.so\nTry: yum --disablerepo='*' --enablerepo='*-debug*' install /usr/lib/debug/.build-id/26/2c5a10aaf4e557c40616d0f8d2988fb9d0d323\nMissing separate debuginfo for /opt/jdk1.7.0_45/jre/lib/amd64/libnet.so\nTry: yum --disablerepo='*' --enablerepo='*-debug*' install /usr/lib/debug/.build-id/a5/ce95e2069f89c08f90a4876a18acf6a6fe28c2\nMissing separate debuginfo for /usr/local/apr/lib/libtcnative-1.so.0.1.33\nTry: yum --disablerepo='*' --enablerepo='*-debug*' install /usr/lib/debug/.build-id/64/c7c3ea9b1da0105a4831820cf77ce54b36dd5d\nMissing separate debuginfo for /usr/local/apr/lib/libapr-1.so.0\nTry: yum --disablerepo='*' --enablerepo='*-debug*' install /usr/lib/debug/.build-id/9f/82e698e6063202d19523bc3bbe9c96473fc73a\nMissing separate debuginfo for \nTry: yum --disablerepo='*' --enablerepo='*-debug*' install /usr/lib/debug/.build-id/1e/0a7d58f454926e2afb4797865d85801ed65ece\nReading symbols from /lib64/libpthread.so.0...(no debugging symbols found)...done.\n[Thread debugging using libthread_db enabled]\nLoaded symbols for /lib64/libpthread.so.0\nReading symbols from /opt/jdk1.7.0_45/bin/../lib/amd64/jli/libjli.so...(no debugging symbols found)...done.\nLoaded symbols for /opt/jdk1.7.0_45/bin/../lib/amd64/jli/libjli.so\nReading symbols from /lib64/libdl.so.2...(no debugging symbols found)...done.\nLoaded symbols for /lib64/libdl.so.2\nReading symbols from /lib64/libc.so.6...(no debugging symbols found)...done.\nLoaded symbols for /lib64/libc.so.6\nReading symbols from /lib64/ld-linux-x86-64.so.2...(no debugging symbols found)...done.\nLoaded symbols for /lib64/ld-linux-x86-64.so.2\nReading symbols from /opt/jdk1.7.0_45/jre/lib/amd64/server/libjvm.so...Missing separate debuginfo for /opt/jdk1.7.0_45/jre/lib/amd64/server/libjvm.so\nTry: yum --disablerepo='*' --enablerepo='*-debug*' install /usr/lib/debug/.build-id/6f/31a11f5f50e47d14c9871057d41df781aa6ccd.debug\n(no debugging symbols found)...done.\nLoaded symbols for /opt/jdk1.7.0_45/jre/lib/amd64/server/libjvm.so\nReading symbols from /lib64/libm.so.6...(no debugging symbols found)...done.\nLoaded symbols for /lib64/libm.so.6\nReading symbols from /lib64/librt.so.1...(no debugging symbols found)...done.\nLoaded symbols for /lib64/librt.so.1\nReading symbols from /opt/jdk1.7.0_45/jre/lib/amd64/libverify.so...Missing separate debuginfo for /opt/jdk1.7.0_45/jre/lib/amd64/libverify.so\nTry: yum --disablerepo='*' --enablerepo='*-debug*' install /usr/lib/debug/.build-id/20/b03b77b651a0152ab8de47774328f0cef51987.debug\n(no debugging symbols found)...done.\nLoaded symbols for /opt/jdk1.7.0_45/jre/lib/amd64/libverify.so\nReading symbols from /opt/jdk1.7.0_45/jre/lib/amd64/libjava.so...(no debugging symbols found)...done.\nLoaded symbols for /opt/jdk1.7.0_45/jre/lib/amd64/libjava.so\nReading symbols from /lib64/libnss_files.so.2...(no debugging symbols found)...done.\nLoaded symbols for /lib64/libnss_files.so.2\nReading symbols from /opt/jdk1.7.0_45/jre/lib/amd64/libzip.so...(no debugging symbols found)...done.\nLoaded symbols for /opt/jdk1.7.0_45/jre/lib/amd64/libzip.so\nReading symbols from /opt/jdk1.7.0_45/jre/lib/amd64/libnio.so...(no debugging symbols found)...done.\nLoaded symbols for /opt/jdk1.7.0_45/jre/lib/amd64/libnio.so\nReading symbols from /opt/jdk1.7.0_45/jre/lib/amd64/libnet.so...(no debugging symbols found)...done.\nLoaded symbols for /opt/jdk1.7.0_45/jre/lib/amd64/libnet.so\nReading symbols from /usr/local/apr/lib/libtcnative-1.so.0.1.33...done.\nLoaded symbols for /usr/local/apr/lib/libtcnative-1.so.0.1.33\nReading symbols from /usr/lib64/libssl.so.10...(no debugging symbols found)...done.\nLoaded symbols for /usr/lib64/libssl.so.10\nReading symbols from /usr/lib64/libcrypto.so.10...(no debugging symbols found)...done.\nLoaded symbols for /usr/lib64/libcrypto.so.10\nReading symbols from /usr/local/apr/lib/libapr-1.so.0...done.\nLoaded symbols for /usr/local/apr/lib/libapr-1.so.0\nReading symbols from /lib64/libcrypt.so.1...(no debugging symbols found)...done.\nLoaded symbols for /lib64/libcrypt.so.1\nReading symbols from /lib64/libgssapi_krb5.so.2...(no debugging symbols found)...done.\nLoaded symbols for /lib64/libgssapi_krb5.so.2\nReading symbols from /lib64/libkrb5.so.3...(no debugging symbols found)...done.\nLoaded symbols for /lib64/libkrb5.so.3\nReading symbols from /lib64/libcom_err.so.2...(no debugging symbols found)...done.\nLoaded symbols for /lib64/libcom_err.so.2\nReading symbols from /lib64/libk5crypto.so.3...(no debugging symbols found)...done.\nLoaded symbols for /lib64/libk5crypto.so.3\nReading symbols from /lib64/libz.so.1...(no debugging symbols found)...done.\nLoaded symbols for /lib64/libz.so.1\nReading symbols from /lib64/libfreebl3.so...(no debugging symbols found)...done.\nLoaded symbols for /lib64/libfreebl3.so\nReading symbols from /lib64/libkrb5support.so.0...(no debugging symbols found)...done.\nLoaded symbols for /lib64/libkrb5support.so.0\nReading symbols from /lib64/libkeyutils.so.1...(no debugging symbols found)...done.\nLoaded symbols for /lib64/libkeyutils.so.1\nReading symbols from /lib64/libresolv.so.2...(no debugging symbols found)...done.\nLoaded symbols for /lib64/libresolv.so.2\nReading symbols from /lib64/libselinux.so.1...(no debugging symbols found)...done.\nLoaded symbols for /lib64/libselinux.so.1\nCore was generated by `/opt/jdk1.7.0_45/bin/java -server -Xms14436m -Xms14436m -Xss512k -XX:MaxDirectM'.\nProgram terminated with signal 6, Aborted.\n#0  0x0000003712632925 in raise () from /lib64/libc.so.6\nMissing separate debuginfos, use: debuginfo-install glibc-2.12-1.132.el6_5.2.x86_64 keyutils-libs-1.4-5.el6.x86_64 krb5-libs-1.10.3-33.el6.x86_64 libcom_err-1.41.12-21.el6.x86_64 libselinux-2.0.94-5.8.el6.x86_64 nss-softokn-freebl-3.14.3-10.el6_5.x86_64 openssl-1.0.1e-30.el6_6.7.x86_64 zlib-1.2.3-29.el6.x86_64\n(gdb) bt\n#0  0x0000003712632925 in raise () from /lib64/libc.so.6\n#1  0x0000003712634105 in abort () from /lib64/libc.so.6\n#2  0x00007f5aef40f155 in os::abort(bool) () from /opt/jdk1.7.0_45/jre/lib/amd64/server/libjvm.so\n#3  0x00007f5aef58e087 in VMError::report_and_die() () from /opt/jdk1.7.0_45/jre/lib/amd64/server/libjvm.so\n#4  0x00007f5aef413adf in JVM_handle_linux_signal () from /opt/jdk1.7.0_45/jre/lib/amd64/server/libjvm.so\n#5  <signal handler called>\n#6  Java_org_apache_tomcat_jni_Poll_poll (e=0x7f5a6801e1e8, o=<value optimized out>, pollset=140028420158600, timeout=<value optimized out>, \n    set=0x7f5a8d3a64f0, remove=0 '\\000') at src/poll.c:310\n#7  0x00007f5ae517f6b5 in ?? ()\n#8  0x00007f5a8d3a6530 in ?? ()\n#9  0x0000000000000000 in ?? ()\n(gdb)\n\n\nthe core file is too big(>500MB) to attach. if you wish, i can provide the file. \n\nand i tried to fix the null point error by adding checking code like this:\nvim src/poll.c \nTCN_IMPLEMENT_CALL(jint, Poll, poll)(TCN_STDARGS, jlong pollset,\n                                     jlong timeout, jlongArray set,\n                                     jboolean remove)\n\n....\n        /* Find the minimum timeout */\n        APR_RING_FOREACH(ep, &p->poll_ring, tcn_pfde_t, link)\n        {\n            apr_interval_time_t socket_timeout = 0;\n            tcn_socket_t *s = (tcn_socket_t *)ep->fd.client_data;\n            if(s==NULL){\n               continue;\n            }\n\n            if (s->timeout == TCN_NO_SOCKET_TIMEOUT) {\n                socket_timeout = p->default_timeout;\n            }\n            else {\n                socket_timeout = s->timeout;\n            }\n\nit then works and don't crash, but the mina can't receive messages any more after some time(the time it should crashs and exits)", "id": 182645, "time": "2015-04-27T10:00:17Z", "creator": "zhangwei_eric@163.com", "creation_time": "2015-04-27T10:00:17Z", "is_private": false, "attachment_id": 32687}, {"count": 1, "tags": [], "creator": "markt@apache.org", "text": "The APR code is not very forgiving if it is mis-used. The crash you describe looks very much like an error in the Java code calling the APR library. Unless an explanation is provided (ideally with a test case to reproduce the issue but that isn't essential) that describes a bug in the native code the Tomcat team are going to mark reports like this as invalid and suggest that you raise a bug with the authors of code using Tomcat's APR library - in this case Mina.", "id": 182646, "time": "2015-04-27T10:08:30Z", "bug_id": 57860, "creation_time": "2015-04-27T10:08:30Z", "is_private": false, "attachment_id": null}]