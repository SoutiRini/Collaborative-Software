[{"count": 0, "tags": [], "bug_id": 56333, "attachment_id": null, "text": "When using SUSPENDED connections to serve HTTP request the connection is never closed. For example, as discussed at http://thread.gmane.org/gmane.comp.apache.user/104996, this test case https://gist.github.com/ArtemGr/9870554 will leak connections and will fail an \"ab\" test.\n\nPlease introduce an API allowing one to return a SUSPENDED connection back to the mpm_event queue, so that the mpm_event will properly flush and close the connection (or even reuse it with KeepAlive).\nA rough example of such an API was hacked together in the following patch: https://gist.github.com/ArtemGr/9887564 (for httpd 2.4.6).", "id": 174194, "time": "2014-03-31T20:38:08Z", "creator": "artemciy@gmail.com", "creation_time": "2014-03-31T20:38:08Z", "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 56333, "text": "FYI: In httpd 2.4.9 my hack no longer works for some reason.", "id": 174509, "time": "2014-04-12T03:56:33Z", "creator": "artemciy@gmail.com", "creation_time": "2014-04-12T03:56:33Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "text": "Created attachment 31519\nPatch for httpd-2.4.9 implementing `ap_resume_suspended`.\n\nA (hopefully improved) version of the patch.", "attachment_id": 31519, "id": 174511, "creator": "artemciy@gmail.com", "time": "2014-04-12T08:52:07Z", "bug_id": 56333, "creation_time": "2014-04-12T08:52:07Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 56333, "text": "Created attachment 31520\nTest case working with httpd-2.4.9.\n\nNevermind my previous comment about patch no longer working with httpd-2.4.9.\nIt works (if ap_mpm_register_timed_callback isn't used).\n\nAttached is the test case.\nWithout the patch it hangs on \"ab\" and with the patch it works NP.", "id": 174512, "time": "2014-04-12T08:55:27Z", "creator": "artemciy@gmail.com", "creation_time": "2014-04-12T08:55:27Z", "is_private": false, "attachment_id": 31520}, {"count": 4, "attachment_id": 31520, "bug_id": 56333, "text": "Comment on attachment 31520\nTest case working with httpd-2.4.9.\n\n>// apxs -i -a -c mod_sustest.c\n>// SetHandler sustest\n>// ab -n 9999 -c 9 http://localhost/sustest\n>\n>#include <httpd.h>\n>#include <http_protocol.h>\n>#include <http_config.h>\n>#include <http_request.h>\n>#include <http_log.h>\n>#include <http_connection.h>\n>#include <ap_mpm.h>\n>\n>#include <unistd.h>\n>\n>module sustest_module;\n>APLOG_USE_MODULE (sustest);\n>\n>static void render (request_rec* r) {\n>  r->content_type = \"text/html; charset=utf-8\";\n>  if (!r->header_only) {\n>    ap_rputs (\"<!doctype html><html lang=\\\"ru\\\"><head><meta charset=\\\"UTF-8\\\"><title>test</title></head><body>\\n\", r);\n>    if (r->filename) ap_rprintf (r, \"FS path: %s<br/>\\n\", r->filename);\n>    ap_rputs (\"v. 02<br/>\", r);\n>    ap_rputs (\"</body></html>\\n\", r);\n>  }\n>}\n>\n>static void setupSuspended (request_rec* r) {\n>}\n>\n>void ap_resume_suspended (conn_rec* c);\n>\n>static void finishSuspended (request_rec* r) {\n>  conn_rec* c = r->connection;\n>  apr_thread_mutex_lock (r->invoke_mtx);\n>\n>  if (r->connection->aborted) {\n>    ap_die (HTTP_INTERNAL_SERVER_ERROR, r);\n>  } else if (r->status == HTTP_OK) {\n>    apr_bucket_brigade* bb = apr_brigade_create (r->pool, r->connection->bucket_alloc);\n>    //APR_BRIGADE_INSERT_TAIL (bb, apr_bucket_flush_create (r->connection->bucket_alloc));\n>    APR_BRIGADE_INSERT_TAIL (bb, apr_bucket_eos_create (r->connection->bucket_alloc));\n>    ap_pass_brigade (r->output_filters, bb);\n>    apr_brigade_destroy (bb);\n>    ap_finalize_request_protocol (r);\n>  }\n>\n>  apr_thread_mutex_unlock (r->invoke_mtx);\n>  ap_process_request_after_handler (r);\n>  ap_log_rerror (APLOG_MARK, LOG_INFO, r->status, r, \"Calling resume_suspended...\");\n>  ap_resume_suspended (c);\n>}\n>\n>static void callback (void* vr) {\n>  request_rec* r = (request_rec*) vr;\n>  ap_log_rerror (APLOG_MARK, LOG_INFO, r->status, r, \"Callback.\");\n>\n>  if (!r->connection->aborted) render (r);\n>\n>  finishSuspended (r);\n>}\n>\n>static void* thread_func (void* vr) {\n>  usleep (100);\n>  callback (vr);\n>  return NULL;\n>}\n>\n>static int sustest_handler (request_rec* r) {\n>  if (!r->handler || strcmp (r->handler, \"sustest\")) return DECLINED;\n>  if (ap_meets_conditions (r) != OK) {ap_log_rerror (APLOG_MARK, APLOG_NOTICE, 0, r, \"!ap_meets_conditions\"); return DECLINED;}\n>\n>  ap_log_rerror (APLOG_MARK, LOG_INFO, r->status, r, \"sustest_handler\");\n>  //render (r); return OK;\n>  setupSuspended (r);\n>\n>  pthread_t thread;\n>  if (pthread_create (&thread, NULL, thread_func, r) != 0) return DECLINED;\n>  pthread_detach (thread);\n>  //ap_mpm_register_timed_callback (apr_time_from_msec (90), callback, r);\n>  return SUSPENDED;\n>}\n>\n>static void sustest_hooks (apr_pool_t *pool) {\n>  ap_hook_handler (sustest_handler, NULL, NULL, APR_HOOK_FIRST);\n>}\n>\n>module sustest_module = {\n>  STANDARD20_MODULE_STUFF,\n>  NULL,\n>  NULL,\n>  NULL,\n>  NULL,\n>  NULL,\n>  sustest_hooks\n>};", "id": 174528, "time": "2014-04-13T12:44:41Z", "creator": "artemciy@gmail.com", "creation_time": "2014-04-13T12:44:41Z", "tags": [], "is_private": false}, {"count": 5, "tags": [], "bug_id": 56333, "attachment_id": 31521, "text": "Created attachment 31521\nTest case working with httpd-2.4.9.\n\n(Keep-alive works fine with the patch).", "id": 174529, "time": "2014-04-13T12:47:29Z", "creator": "artemciy@gmail.com", "creation_time": "2014-04-13T12:47:29Z", "is_private": false}, {"count": 6, "tags": [], "text": "Created attachment 31548\nAdd support for connection suspension in Event MPM\n\nCleaned up the code; I changed the globally exposed function to a hook, modeled after the timed_callback which is very similar. The code within the hook is yours, though.\n\nIn doing so, I had to introduce a new ap_mpm_query() query, to make it worker/prefork-safe. Any code calling the new function should check if the MPM supports suspension first.", "attachment_id": 31548, "id": 174778, "creator": "Chaosed0@gmail.com", "time": "2014-04-22T20:29:24Z", "bug_id": 56333, "creation_time": "2014-04-22T20:29:24Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 56333, "attachment_id": 31549, "id": 174779, "time": "2014-04-22T20:31:41Z", "creator": "Chaosed0@gmail.com", "creation_time": "2014-04-22T20:31:41Z", "is_private": false, "text": "Created attachment 31549\nTestcase for new patch\n\nForgot to mention that the new patch is against trunk, not against 2.4.9.\n\nHere's the testcase, changed a little for the new patch."}, {"count": 8, "tags": [], "text": "Created attachment 31551\nAdd support for resuming a suspended connection in Event MPM\n\nFixed the error messages in the Edward Lu's patch to match the new function name.", "attachment_id": 31551, "id": 174794, "creator": "artemciy@gmail.com", "time": "2014-04-23T09:18:03Z", "bug_id": 56333, "creation_time": "2014-04-23T09:18:03Z", "is_private": false}, {"count": 9, "tags": [], "text": "Edward, thanks for looking at this!", "attachment_id": null, "id": 174808, "creator": "artemciy@gmail.com", "time": "2014-04-23T14:00:56Z", "bug_id": 56333, "creation_time": "2014-04-23T14:00:56Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 56333, "text": "http://svn.apache.org/r1593860", "id": 175149, "time": "2014-05-11T20:53:47Z", "creator": "covener@gmail.com", "creation_time": "2014-05-11T20:53:47Z", "is_private": false, "attachment_id": null}]