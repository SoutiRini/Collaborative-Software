[{"count": 0, "tags": [], "bug_id": 26025, "attachment_id": null, "id": 50332, "time": "2004-01-09T17:09:11Z", "creator": "waraujo@juniper.net", "creation_time": "2004-01-09T17:09:11Z", "is_private": false, "text": "Every time Jasper checks for modified pages, it opens a URL connection to that \nresource to check the modification time and never closes it. Normally it's not \na problem, since the FD will be freed when the object is garbage collected. \nHowever, when running on systems with more heap and less frequent GC events, \nthe system runs out of FDs before the GC is invoked.\nI noticed this problem in Jetty4.2.6, never with Tomcat. I'm providing a patch \nfor this problem when the WAR file is extracted. When this is not the case, I \ndon't know how to fix it. The patch follows.\n\n--- Compiler.java.orig  Mon Oct 27 16:24:08 2003\n+++ Compiler.java       Thu Jan  8 15:17:42 2004\n@@ -63,6 +63,8 @@\n import java.util.*;\n import java.io.*;\n import java.net.URL;\n+import java.net.URLConnection;\n+\n import javax.servlet.jsp.tagext.TagInfo;\n import javax.servlet.ServletException;\n import javax.servlet.Servlet;\n@@ -407,7 +409,11 @@\n                 ctxt.incrementRemoved();\n                 return false;\n             }\n-            jspRealLastModified = jspUrl.openConnection().getLastModified();\n+            \n+            // FIX: closes the stream to avoid FD leak\n+            URLConnection conn = jspUrl.openConnection();        \n+            jspRealLastModified = conn.getLastModified();\n+            conn.getInputStream().close();\n         } catch (Exception e) {\n             e.printStackTrace();\n             return true;\n@@ -468,11 +474,15 @@\n                     //System.out.println(\"Compiler: outdated, no includeUri \" \n+ include );\n                     return true;\n                 }\n-                if (includeUrl.openConnection().getLastModified() >\n-                    targetLastModified) {\n+                // FIX: closes the stream to avoid FD leak\n+                URLConnection conn = includeUrl.openConnection();\n+                if(conn.getLastModified() > targetLastModified)\n+                {\n+                    conn.getInputStream().close();\n                     //System.out.println(\"Compiler: outdated, include old \" + \ninclude );\n                     return true;\n                 }\n+                conn.getInputStream().close();\n             } catch (Exception e) {\n                 e.printStackTrace();\n                 return true;"}, {"count": 1, "tags": [], "creator": "waraujo@juniper.net", "attachment_id": null, "id": 50333, "creation_time": "2004-01-09T17:10:24Z", "time": "2004-01-09T17:10:24Z", "bug_id": 26025, "text": "The patch is provided against 4.1.29 release.", "is_private": false}, {"count": 2, "tags": [], "creator": "jan.luehe@sun.com", "is_private": false, "text": "This has been fixed in Tomcat 5 CVS.", "id": 56653, "time": "2004-04-29T18:31:40Z", "bug_id": 26025, "creation_time": "2004-04-29T18:31:40Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 60826, "creation_time": "2004-07-19T20:20:30Z", "time": "2004-07-19T20:20:30Z", "bug_id": 26025, "text": "And now in TC4.", "is_private": false}]