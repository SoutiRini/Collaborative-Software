[{"count": 0, "tags": [], "creator": "heyoulin@hotmail.com", "text": "Whatever asynclistener timeout call complete response always return http 500.", "id": 138859, "time": "2010-08-03T22:42:38Z", "bug_id": 49698, "creation_time": "2010-08-03T22:42:38Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 49698, "attachment_id": null, "text": "Which version are you using?\n\nThere were a number of fixes in this area included in 7.0.2 (currently being voted on for release).\n\nWhilst the release vote is in progress, you can get a copy for testing from here:\nhttp://people.apache.org/~markt/dev/tomcat-7/v7.0.2/\n\nNote that this is NOT an official release.", "id": 138877, "time": "2010-08-04T07:09:57Z", "creator": "markt@apache.org", "creation_time": "2010-08-04T07:09:57Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 49698, "attachment_id": null, "text": "(In reply to comment #1)\n> Which version are you using?\n> There were a number of fixes in this area included in 7.0.2 (currently being\n> voted on for release).\n> Whilst the release vote is in progress, you can get a copy for testing from\n> here:\n> http://people.apache.org/~markt/dev/tomcat-7/v7.0.2/\n> Note that this is NOT an official release.\n\nI build from svn sources. From the sources:\npublic void doInternalDispatch() throws ServletException, IOException {\n        if (this.state.compareAndSet(AsyncState.TIMING_OUT, AsyncState.COMPLETING)) {\n            log.debug(\"TIMING OUT!\");\n            boolean listenerInvoked = false;\n            for (AsyncListenerWrapper listener : listeners) {\n                listener.fireOnTimeout(event);\n                listenerInvoked = true;\n            }\n            if (listenerInvoked) {\n                // Listener should have called complete\n                if (state.get() != AsyncState.NOT_STARTED) {\n                    ((HttpServletResponse)servletResponse).setStatus(500);\n                    doInternalComplete(true);\n                }\n           .......\n\nWhen timeout AsyncState is COMPLETING. But complete method do nothing to COMPLETING state:\npublic void complete() {\n        if (log.isDebugEnabled()) {\n            log.debug(\"AsyncContext Complete Called[\"+state.get()+\"; \"+request.getRequestURI()+\"?\"+request.getQueryString()+\"]\", new DebugException());\n        }\n        if (state.get()==AsyncState.COMPLETING) {\n            //do nothing\n        }\n\nSo always return http500. It has changed since svn revision 966548.In revision 960692 is below:\n\nublic void doInternalDispatch() throws ServletException, IOException {\n        if (this.state.compareAndSet(AsyncState.TIMING_OUT, AsyncState.COMPLETING)) {\n            log.debug(\"TIMING OUT!\");\n            boolean listenerInvoked = false;\n            for (AsyncListenerWrapper listener : listeners) {\n                listener.fireOnTimeout(event);\n                listenerInvoked = true;\n            }\n            if (!listenerInvoked) {\n                ((HttpServletResponse)servletResponse).setStatus(500);\n            }\n            doInternalComplete(true);", "id": 138882, "time": "2010-08-04T12:02:52Z", "creator": "heyoulin@hotmail.com", "creation_time": "2010-08-04T12:02:52Z", "is_private": false}, {"count": 3, "tags": [], "creator": "markt@apache.org", "text": "You are required by the spec to implement a listener to handle the timeout.", "id": 138883, "time": "2010-08-04T12:35:27Z", "bug_id": 49698, "creation_time": "2010-08-04T12:35:27Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "heyoulin@hotmail.com", "attachment_id": null, "id": 138885, "time": "2010-08-04T13:03:05Z", "bug_id": 49698, "creation_time": "2010-08-04T13:03:05Z", "is_private": false, "text": "(In reply to comment #3)\n> You are required by the spec to implement a listener to handle the timeout.\nI have a listener to handle the timeout.\npublic void onTimeout(AsyncEvent event) throws IOException {\n\t\tevent.getAsyncContext().complete();\n\t}\n\nWhen implement event.getAsyncContext().complete() actually tomcat do nothing.AsyncState is still in COMPLETING.So return http500.\n\nSo how to handle the timeout to make AsyncState to NOT_STARTED only using servlet 3.0 api?"}, {"count": 5, "tags": [], "bug_id": 49698, "attachment_id": null, "text": "OK, let me take a look.", "id": 138886, "time": "2010-08-04T13:09:49Z", "creator": "markt@apache.org", "creation_time": "2010-08-04T13:09:49Z", "is_private": false}, {"count": 6, "tags": [], "text": "Yep. It was a bug in the state machine. I have fixed this for 7.0.x and it will be included in 7.0.3 onwards.\n\nThanks for the report.", "attachment_id": null, "bug_id": 49698, "id": 139529, "time": "2010-08-28T07:09:09Z", "creator": "markt@apache.org", "creation_time": "2010-08-28T07:09:09Z", "is_private": false}]