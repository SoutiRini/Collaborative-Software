[{"count": 0, "tags": [], "bug_id": 45023, "attachment_id": null, "is_private": false, "id": 116721, "time": "2008-05-16T23:53:11Z", "creator": "noah@dizzler.com", "creation_time": "2008-05-16T23:53:11Z", "text": "On my server, I recently added the DEFLATE filter for all application/x-javascript files, and noticed that apache has stopped sending 304 NOT MODIFIED on ALL my js files *always*.\n\nObserve this header trace:\n\n-----------------------------------------\nGET /main.js HTTP/1.1\nHost: xxxxxxxxxxxxx\nUser-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.14) Gecko/20080404 Firefox/2.0.0.14\nAccept: */*\nAccept-Language: en-us,en;q=0.5\nAccept-Encoding: gzip,deflate\nAccept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\nKeep-Alive: 300\nConnection: keep-alive\nIf-Modified-Since: Mon, 12 May 2008 16:09:00 GMT\nIf-None-Match: \"44d0ac3fd1f00\"-gzip\nCache-Control: max-age=0\n\n\nHTTP/1.x 200 OK\nDate: Sat, 17 May 2008 06:09:25 GMT\nServer: Apache\nLast-Modified: Mon, 12 May 2008 16:09:00 GMT\nEtag: \"44d0ac3fd1f00\"-gzip\nAccept-Ranges: bytes\nCache-Control: max-age=86400, must-revalidate, private\nExpires: Sun, 18 May 2008 06:09:25 GMT\nVary: Accept-Encoding\nContent-Encoding: gzip\nContent-Length: 9797\nKeep-Alive: timeout=2, max=299\nConnection: Keep-Alive\nContent-Type: application/x-javascript\n-----------------------------------------\n\nIt seems to me, that a 304 NOT MODIFIED would have been the appropriate response here.\n\nBefore I added DEFLATE to javascript files, the above response was always 304 NOT MODIFIED (except the first one).\nNow with deflate, it is *always* 200 OK.\n\nIs this by design, or is this a bug?\n\nOne thing to mention is - I have both mod_deflate and mod_expires statically compiled into httpd."}, {"attachment_id": null, "tags": [], "creator": "takashi.asfbugzilla@tks.st", "is_private": false, "count": 1, "id": 116722, "time": "2008-05-17T00:22:47Z", "bug_id": 45023, "creation_time": "2008-05-17T00:22:47Z", "text": "If we remove \"-gzip\" from Etag for If-None-Match, a server returns 304.\nmod_deflate adds \"-gzip\" and sends it to us, but condition check of If-None-Match runs before mod_deflate ...???"}, {"count": 2, "tags": [], "bug_id": 45023, "text": "This is actually a fix of Bug 39727.  Yes, we know the core code testing for conditional responses still needs work.", "id": 116747, "time": "2008-05-17T06:47:55Z", "creator": "nick@webthing.com", "creation_time": "2008-05-17T06:47:55Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 45023, "text": "This bug nearly defeats the purpose of mod_deflate.  I turned mod_deflate on with the intent of saving bandwidth when sending JavaScript and CSS files.  Instead, I'm using *more* bandwidth for every request but the first.  (Previously, subsequent requests would result in small, no-content 304 responses.  Now the compressed JS and CSS files are sent every time.)\n\nBTW, the change that appends \"-gzip\" to the etag (revision 607219, I think) is a bit wacky in its own right in that it appends outside the double quotes.  IOW, if the original header is:\n\n    Etag: \"5954c6-10f4-449d11713aac0\"\n\nthe modified header ends up as:\n\n    Etag: \"5954c6-10f4-449d11713aac0\"-gzip\n\nwhen it probably should be:\n\n    Etag: \"5954c6-10f4-449d11713aac0-gzip\"\n\nwith the \"-gzip\" inside the quotes.  I altered the code to do this, but it had no affect on this 304 bug.  I just wanted to note it here so the situation is avoided when this bug is fixed for real.\n", "id": 117938, "time": "2008-06-24T07:32:39Z", "creator": "siracusa@gmail.com", "creation_time": "2008-06-24T07:32:39Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "text": "There is a workaround, \nIf you are serving from a location say /js\nYou can use a configuration like below to switch ETag: $1-gzip to $1 \n\n<Location /js>\nRequestHeader  edit \"If-None-Match\" \"^(.*)-gzip$\" \"$1\"\nHeader  edit \"ETag\" \"^(.*[^g][^z][^i][^p])$\" \"$1-gzip\"\n</Location>\n\n(Perhaps this should be done from mod_deflate as input filter\nwith the condition that if Client requests with Accept-Encoding: gzip\nonly then modify If*match headers to their un-gzip values.)\n\n(Also the current value of ETag (+gzip) is not RFC compliant, since RFC mandates\na quoted string as the value of ETag. As the noted by john, -gzip should be inside quotes.)\n", "is_private": false, "id": 119912, "creator": "rahul.g.nair@gmail.com", "time": "2008-08-19T05:36:44Z", "bug_id": 45023, "creation_time": "2008-08-19T05:36:44Z", "attachment_id": null}, {"count": 5, "tags": [], "creator": "rahul.g.nair@gmail.com", "text": "Created attachment 22453\nA POC slightly better than the above conf lines,\n\nAdds an input filter ETAG that can be used like below, along with DEFLATE\nto let apache recognize ($1)-gzip as $1\n\nAddInputFilter ETAG .txt\nAddOutputFilterByType DEFLATE text/plain", "id": 119913, "time": "2008-08-19T06:41:51Z", "bug_id": 45023, "creation_time": "2008-08-19T06:41:51Z", "is_private": false, "attachment_id": 22453}, {"attachment_id": null, "tags": [], "bug_id": 45023, "is_private": false, "count": 6, "id": 119917, "time": "2008-08-19T07:47:26Z", "creator": "siracusa@gmail.com", "creation_time": "2008-08-19T07:47:26Z", "text": "Both the workaround in comment #4 and the patch in comment #5 appear to work.  Neither are real \"fixes\" for the bug, however.  (But I'm glad I have something to work with until a real fix arrives, so thanks rahul!)"}, {"count": 7, "tags": [], "creator": "rahul.g.nair@gmail.com", "text": "Created attachment 22468\nuse ap_hook_post_read_request instead of input filter\n\nIncorporate suggested changes by Nick", "id": 119993, "time": "2008-08-21T08:13:07Z", "bug_id": 45023, "creation_time": "2008-08-21T08:13:07Z", "is_private": false, "attachment_id": 22468}, {"count": 8, "tags": [], "bug_id": 45023, "attachment_id": null, "text": "Hello!\n\nI'm also facing the same problem -- I had been scratching my head for sometime before I found this bug report. I have to reduce my page size urgently and not having gzip on is not really an option for me.\n\nI'm not really comfortable having a customized compiled version of apache2 on my system and the regular expression \"hack\" will also slow things down (will it?).\n\nAny alternative ideas? When might this bug be fixed?\n\nThanks,\n\nSidharth", "id": 120745, "time": "2008-09-18T08:23:02Z", "creator": "sid.kshatriya@gmail.com", "creation_time": "2008-09-18T08:23:02Z", "is_private": false}, {"count": 9, "tags": [], "text": "I had a look at ap_hook_post_read_request attachment...seems like I can get away with just compiling mod_deflate.c\n\nI'm using Apache 2.2.8. Can anyone help me on where I can get the correct source for the corresponding mod_deflate and how I can compile mod_deflate?\n\nThanks for your help!\n\nSidharth", "is_private": false, "id": 120746, "creation_time": "2008-09-18T08:27:57Z", "time": "2008-09-18T08:27:57Z", "creator": "sid.kshatriya@gmail.com", "bug_id": 45023, "attachment_id": null}, {"count": 10, "tags": [], "text": "Hi, \n\nSorry for flooding this mailing list.\n\nIn this thread there is Rahul's mod_deflate patch and there are some patches in this bug thread:\n\nhttps://issues.apache.org/bugzilla/show_bug.cgi?id=39727\n(mostly by Nick Kew)\n\nWhich one is the best solution?\n\nThanks,\n\nSidharth\n\n", "is_private": false, "id": 120748, "creator": "sid.kshatriya@gmail.com", "time": "2008-09-18T09:19:28Z", "bug_id": 45023, "creation_time": "2008-09-18T09:19:28Z", "attachment_id": null}, {"count": 11, "tags": [], "creator": "rahul.g.nair@gmail.com", "text": "You will need both. This patch expects the other to have been applied (this is already applied on trunk).\nAlso please use the dev@httpd.apache.org for questions.\n\n", "id": 120752, "time": "2008-09-18T10:27:15Z", "bug_id": 45023, "creation_time": "2008-09-18T10:27:15Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 45023, "attachment_id": null, "text": "Thanks for your response Rahul.\n\nUnfortunately I am new to all of this. I applied Nick's patch to my mod_deflate.c but I got patching errors...his patch is assuming a slightly different mod_deflate.c from mine.\n\nWould really appreciate if you were able to direct me to the place (or even better just gave me the patched mod_deflate.c version) that I could just compile.\n\n[ASIDE: I am using apxs2 -c mod_deflate.c\n\nwith LDFLAGS=\"-lz\" set in /usr/bin/aprconfig\n\nI notice that my original mod_deflate.so depends on libpthread. When I apply your patch to my file and compile, I don't get dependency with libpthread.]\n\nPlease tell me if I would need to do any additional transformations to the file you would provide me (assuming you can :-) ).\n\nThanks a Ton!\n\nSidharth\n[Attaching the mod_deflate that I have. This I obtained by issuing\nsudo apt-get install apache2-src \non ubuntu. This is version 2.2.8 Apache]", "id": 120756, "time": "2008-09-18T11:03:49Z", "creator": "sid.kshatriya@gmail.com", "creation_time": "2008-09-18T11:03:49Z", "is_private": false}, {"attachment_id": 22605, "tags": [], "creator": "sid.kshatriya@gmail.com", "is_private": false, "count": 13, "id": 120758, "time": "2008-09-18T11:10:32Z", "bug_id": 45023, "creation_time": "2008-09-18T11:10:32Z", "text": "Created attachment 22605\nmod_deflate as found in apache2-src package on ubuntu version 2.2.8-1ubuntu0.3"}, {"attachment_id": null, "tags": [], "bug_id": 45023, "is_private": false, "count": 14, "id": 125994, "time": "2009-04-03T18:41:47Z", "creator": "fielding@apache.org", "creation_time": "2009-04-03T18:41:47Z", "text": "This bug was added in 2.2.8 in a failed attempt to address Bug 39727.\nSince a real fix will require extensive changes, I have reverted the\nchange in \n\n  http://svn.apache.org/viewvc?view=rev&revision=761835\n\nNote: if you are patching a released version of the source code,\nthen extract the patch from the original change\n\n  http://svn.apache.org/viewvc?view=rev&revision=608849\n\nand use patch -R to apply it in reverse.\n\nMeanwhile, the original bug will still be tracked as issue 39727."}, {"count": 15, "tags": [], "creator": "hackeron@gmail.com", "text": "I'm still experiencing this with 2.2.11-2ubuntu2 -- but adding these 2 lines are suggested by rahul works:\n\nRequestHeader  edit \"If-None-Match\" \"^(.*)-gzip$\" \"$1\"\nHeader  edit \"ETag\" \"^(.*[^g][^z][^i][^p])$\" \"$1-gzip\"", "id": 126201, "time": "2009-04-13T11:25:53Z", "bug_id": 45023, "creation_time": "2009-04-13T11:25:53Z", "is_private": false, "attachment_id": null}, {"count": 16, "tags": [], "bug_id": 45023, "attachment_id": null, "text": "Was this ever resolved in trunk/2.4?\n\nAlias /deflate /home/covener/SRC/httpd-trunk/built/htdocs/index.html\n<Location /deflate>\nSetOutputFilter DEFLATE\n</location>\n\n\n$ wget  --header=\"Accept-Encoding: gzip\" -S http://localhost/deflate -O/dev/null 2>&1 |grep ETag\n  ETag: \"58c5-4b26c6f28ce80-gzip\"\n\n$ wget --header='If-None-Match: \"58c5-4b26c6f28ce80-gzip\"'  --header=\"Accept-Encoding: gzip\" -S http://localhost/deflate -O/dev/null 2>&1\n--2013-06-23 13:39:47--  http://localhost/deflate\nResolving localhost (localhost)... 127.0.0.1\nConnecting to localhost (localhost)|127.0.0.1|:80... connected.\nHTTP request sent, awaiting response... \n  HTTP/1.1 200 OK\n  Date: Sun, 23 Jun 2013 17:39:47 GMT\n  Server: Apache/2.5.0-dev (Unix) OpenSSL/1.0.1c\n  Last-Modified: Wed, 23 Nov 2011 20:04:58 GMT\n  ETag: \"58c5-4b26c6f28ce80-gzip\"\n  Accept-Ranges: bytes\n  Vary: Accept-Encoding\n  Content-Encoding: gzip\n  Content-Length: 206\n  Keep-Alive: timeout=5, max=100\n  Connection: Keep-Alive\n  Content-Type: text/html\n\ncovener@cov-w520:~/SRC/httpd-trunk$ wget --header='If-None-Match: \"58c5-4b26c6f28ce80\"'  --header=\"Accept-Encoding: gzip\" -S http://localhost/deflate -O/dev/null 2>&1|grep HTTP/1.1\n  HTTP/1.1 304 Not Modified", "id": 167974, "time": "2013-06-23T17:41:44Z", "creator": "covener@gmail.com", "creation_time": "2013-06-23T17:41:44Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 45023, "text": "It's a copout, but I've made this configurable in r1586542 with a default for now of maintaining the 2.4 behavior.", "count": 17, "id": 174461, "time": "2014-04-11T02:43:20Z", "creator": "covener@gmail.com", "creation_time": "2014-04-11T02:43:20Z", "is_private": false}, {"count": 18, "tags": [], "bug_id": 45023, "attachment_id": null, "is_private": false, "id": 174625, "time": "2014-04-16T11:27:53Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-04-16T11:27:53Z", "text": "*** Bug 56354 has been marked as a duplicate of this bug. ***"}, {"attachment_id": null, "tags": [], "creator": "jcea@jcea.es", "is_private": false, "count": 19, "id": 174820, "time": "2014-04-23T21:27:46Z", "bug_id": 45023, "creation_time": "2014-04-23T21:27:46Z", "text": "Eric, I am graceful for the new directive, but why not implementing a better ETAG verification instead of altering the ETAG generation?.\n\nIf you get an etag with a \"-gzip\" suffix, you just verify the etag without that suffix. You could link this to the \"accept-encoding\" header, maybe."}, {"count": 20, "tags": [], "bug_id": 45023, "attachment_id": null, "text": "(In reply to Jes\u00fas Cea from comment #19)\n> Eric, I am graceful for the new directive, but why not implementing a better\n> ETAG verification instead of altering the ETAG generation?.\n\nMy immediate concern is the unnecessary difference between 2.2 and 2.4, allowing the 2.2 behavior in 2.4 is a lot simpler to tackle then adding some third behavior (I admitted before it was a copout)", "id": 174821, "time": "2014-04-23T21:38:26Z", "creator": "covener@gmail.com", "creation_time": "2014-04-23T21:38:26Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 45023, "is_private": false, "count": 21, "id": 181042, "time": "2015-02-13T08:10:40Z", "creator": "martin.heide@faroeurope.com", "creation_time": "2015-02-13T08:10:40Z", "text": "(In reply to Eric Covener from comment #17)\n> It's a copout, but I've made this configurable in r1586542 with a default\n> for now of maintaining the 2.4 behavior.\n\nHi Eric,\nwill your workaround of r1586542 make it into some Apache 2.4 release? I saw that it \nis integrated in 2.5, but it is not mentioned in the 2.4 docs.\nI tried the DeflateAlterETag directive, but it does not seem to available in Ubuntu 14.04 LTS (Apache 2.4.7).\n\nSince you only added a directive, this cannot break any existing server configurations, so it should be available in 2.4, too!"}, {"count": 22, "tags": [], "bug_id": 45023, "attachment_id": null, "text": "Am I correct to read in http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.26 that the If-None-Match header can contain mulitple ETAG values?\n\nIf so, maybe an alternative version of rahuls workaround could be:\n\nRequestHeader edit \"If-None-Match\" '^\"((.*)-gzip)\"$' '\"$1\", \"$2\"'\n\nWith above line, I think there is no need to modify the outgoing Header and the modefied RequestHeader works in with or without deflation", "id": 186327, "time": "2015-11-08T22:00:51Z", "creator": "joost.dekeijzer@gmail.com", "creation_time": "2015-11-08T22:00:51Z", "is_private": false}]