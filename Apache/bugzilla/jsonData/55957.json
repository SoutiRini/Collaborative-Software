[{"count": 0, "tags": [], "creator": "jidanni@jidanni.org", "text": "We can see the listing of\n\n$ w3m -dump http://radioscanningtw.jidanni.org/images/radioscanningtw/\nIndex of /images/radioscanningtw\n\n   [ICO]           Name          Last modified   Size Description\n-----------------------------------------------------------------\n[PARENTDIR] Parent Directory                        -\n[IMG]       radioscanningtw.png 2006-09-09 14:50 1.1K\n[TXT]       step.html           2009-04-15 20:40 4.1K\n-----------------------------------------------------------------\nApache/2.4.6 (Debian) Server at radioscanningtw.jidanni.org Port 80\n\nBut it is gone from the parent,\n\n$ w3m -dump -no-proxy http://radioscanningtw.jidanni.org/images/\nIndex of /images\n\n   [ICO]          Name        Last modified   Size Description\n--------------------------------------------------------------\n[PARENTDIR] Parent Directory                     -\n[ ]         README           2012-03-28 11:36  203\n--------------------------------------------------------------\nApache/2.4.6 (Debian) Server at radioscanningtw.jidanni.org Port 80\n\nIn addition error.log gets\n\n[Mon Jan 06 15:29:15.433307 2014] [access_compat:error] [pid 2798]\n[client 127.0.0.1:46481] AH01797: client denied by server\nconfiguration:\n/home/jidanni/radioscanningtw.jidanni.org/images/radioscanningtw/\n\nExamining the server,\n\n$ tree -a images/\nimages/\n|-- README\n|-- radioscanningtw\n|   |-- .htaccess\n|   |-- radioscanningtw.png\n|   `-- step.html\n\nWe find that if we edit .htaccess,\n\n$ cat images/radioscanningtw/.htaccess\nSetEnvIf host radioscanningtw\\.jidanni\\.org let_me_in\nOrder Deny,Allow\nDeny from all\nAllow from env=let_me_in\nAddDefaultCharset utf-8\n$ ed images/radioscanningtw/.htaccess\n134\n4\nAllow from env=let_me_in\ns/e.*/all\nAllow from all\nw\n124\nq\n$ w3m -dump http://radioscanningtw.jidanni.org/images/\nIndex of /images\n\n   [ICO]          Name        Last modified   Size Description\n--------------------------------------------------------------\n[PARENTDIR] Parent Directory                     -\n[ ]         README           2012-03-28 11:36  203\n[DIR]       radioscanningtw/ 2014-01-06 15:12    -\n--------------------------------------------------------------\nApache/2.4.6 (Debian) Server at radioscanningtw.jidanni.org Port 80\n\nThe problem goes away.\n\nThe problem is:\n\n1) The effects of .htaccess files in child directories on the parent's\nlisting is undocumented. And more importantly, it has a bug:\n\"SetEnvIf host\" loses track of the host name in this secondary query\nstage, even though it is all part of the same HTTP request!\n\n# a2query  -c\nother-vhosts-access-log (enabled by maintainer script)\nphp5-cgi (enabled by site administrator)\nserve-cgi-bin (enabled by maintainer script)\njidanni (enabled by site administrator)\nlocalized-error-pages (enabled by maintainer script)\nsecurity (enabled by maintainer script)\ncharset (enabled by maintainer script)\nphpmyadmin (enabled by maintainer script)\napache2-doc (enabled by maintainer script)\n\n# cat /etc/apache2/conf-enabled/jidanni.conf |grep -v ^\\#\nUseCanonicalName Off\nVirtualDocumentRoot /home/jidanni/%0\n<Directory \"/home/jidanni/*\">\n    Options Indexes MultiViews FollowSymLinks\n    Require all granted\n</Directory>\n<Directory /*>\n   AllowOverride All\n</Directory>", "id": 172098, "time": "2014-01-06T09:13:38Z", "bug_id": 55957, "creation_time": "2014-01-06T09:13:38Z", "is_private": false, "attachment_id": null}, {"count": 1, "attachment_id": null, "bug_id": 55957, "is_private": false, "id": 172099, "time": "2014-01-06T09:23:06Z", "creator": "jidanni@jidanni.org", "creation_time": "2014-01-06T09:23:06Z", "tags": [], "text": "s/And more importantly, it has a bug:/And more importantly, 2) it has a bug:/\n\nP.S., A workaround that would also work on Apache 2.2.9 would be welcome, as Dreamhost won't be updating soon."}, {"count": 2, "tags": [], "creator": "covener@gmail.com", "text": "mod_setenvif only runs on the main request, and subrequests (used by mod_dir to scan subdirs) do not inherit the environment.  Changing either of these to accomodate this scenario is not so appetizing.\n\nI guess mod_setenvif and mod_dir doc could include those hints.\n\nYou didn't mention IndexOptions +showforbidden.  Maybe that's enough for your scenario, but it will show the subdir for users w/o access too.", "id": 172105, "time": "2014-01-06T13:03:47Z", "bug_id": 55957, "creation_time": "2014-01-06T13:03:47Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "jidanni@jidanni.org", "text": "Thank you. Apparently the only choices are revealing too little, due to\nthe bug, or using IndexOptions +showforbidden and thus revealing too\nmuch.\n\nPlease inform me what else is left that I can test on in 2.2 and 2.4,\nnow that 'host' has been destroyed.\n\nAnyways, the whole idea of environment, is inheriting, at least in\nshells, I recall.\n\nIf you arbitrarily wipe it out on one of your internal steps, there is\nno way the user can recreate it.\n\nThis also raises *ONE BIG SECURITY ISSUE*, say the user was depending on\nblocking a certain Mr. Snowden, based on the environment. Well that\nworks... but not in this special certain case!", "id": 172128, "time": "2014-01-06T21:33:12Z", "bug_id": 55957, "creation_time": "2014-01-06T21:33:12Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "covener@gmail.com", "text": "> This also raises *ONE BIG SECURITY ISSUE*, say the user was depending on\n> blocking a certain Mr. Snowden, based on the environment. Well that\n> works... but not in this special certain case!\n\nIMO the configuration can be said to have a small security issue.\n\nThe resources do not require authentication, directory listings are turned on, and the configuration to block a user based on the environment was not tested.  The result is that the directory is visible in the parent, but not the filenames or their contents.\n\nI think we have a documentation issue, but no bug. Discussion of alternate configs to get the desired behavior is best taken to e.g. users@ stackexechange -- setting the envvar with mod_rewrite is one portable possibility since it runs in a different hook, but I haven't analyzed it.", "id": 172132, "time": "2014-01-06T22:50:06Z", "bug_id": 55957, "creation_time": "2014-01-06T22:50:06Z", "is_private": false, "attachment_id": null}, {"count": 5, "attachment_id": null, "bug_id": 55957, "is_private": false, "id": 172133, "time": "2014-01-06T23:52:05Z", "creator": "jidanni@jidanni.org", "creation_time": "2014-01-06T23:52:05Z", "tags": [], "text": "Just revealing a filename IS a security issue.\n\nImagine the (say Iran) authorities were able to figure out the\nmaintainer of the ho-hum 'abj' site was in fact also involved in\nradioscanning and, gasp, even transgender! Else why were there the mere\nmention of those directory names appearing in his shared /images folder!\nhttps://www.mediawiki.org/wiki/Manual:Wiki_family#Ultimate_minimalist_solution\n\nIt's either that or severing his directory tree dead in the middle.\n\nAs far as stack* I'm sorry but I have been banned for life there, so I\nstill need somebody to tell a workaround. It doesn't make sense to me\nthat HTTP_HOST or any other variable I would set would survive, but not 'host'."}, {"count": 6, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "id": 172134, "time": "2014-01-07T01:23:47Z", "bug_id": 55957, "creation_time": "2014-01-07T01:23:47Z", "is_private": false, "text": "> As far as stack* I'm sorry but I have been banned for life there, so I\n> still need somebody to tell a workaround. It doesn't make sense to me\n> that HTTP_HOST or any other variable I would set would survive, but not\n> 'host'.\n\nI don't think it's unique to HTTP_HOST, which you aren't even changing.  The output is an environment variable and they don't survive, and mod_setenvif is not re-run.\n\nBut, bugzilla is for bugs. I suggest users@ mailing list or IRC for this kind of discussion and won't continue it here."}, {"count": 7, "tags": [], "bug_id": 55957, "attachment_id": null, "text": "I am guessing that the authors were probably trying to be careful to\nfollow scope rules to not allow variables set in say many parallel\n/images/*/.htaccess files to affect each other, but overdid it, leaving\nno scope at all for the current file.\n\n-----------\nSetEnv only affects Allow from env=!... not env=...\n\nBy the way, also highly unexplainable to me is why only one of the\nfollowing four work, instead of two:\n\n# while read; do cat ~jidanni/mediawiki/images/radioscanningtw/.htaccess; w3m -dump http://radioscanningtw.jidanni.org/images |grep radio.*:; echo ----------; done\n\nOrder Deny,Allow\nDeny from all\nAllow from env=!let_me_in\n[DIR]       radioscanningtw/ 2014-01-07 11:18    -\n----------\nOrder Deny,Allow\nDeny from all\nAllow from env=let_me_in\n----------\nSetEnv let_me_in 1\nOrder Deny,Allow\nDeny from all\nAllow from env=let_me_in\n----------\nSetEnv let_me_in 1\nOrder Deny,Allow\nDeny from all\nAllow from env=!let_me_in\n----------\n\nBrowsing the child directly with\nd=radioscanningtw.jidanni.org/images/radioscanningtw/; while read; do\ncat ~jidanni/$d/.htaccess; w3m -dump http://$d; echo -n ----------;\ndone\nshows the same 3/1 pattern.\n\n\nBelow we observe SetEnvIfExpr is defective when processing the subdir.\n\n+ cat /home/jidanni/radioscanningtw.jidanni.org/images/radioscanningtw/.htaccess\nSetEnvIfExpr true let_me_inX\nOrder Deny,Allow\nDeny from all\nAllow from env=!let_me_inX\n+ w3m -dump http://radioscanningtw.jidanni.org/images\nIndex of /images\n\n   [ICO]          Name        Last modified   Size Description\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n[PARENTDIR] Parent Directory                     -\n[ ]         README           2012-03-28 11:36  203\n[DIR]       radioscanningtw/ 2014-01-07 13:19    -\n[DIR]       taizhongbus/     2014-01-06 15:14    -\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\n\nApache/2.4.6 (Debian) Server at radioscanningtw.jidanni.org Port 80\n+ w3m -dump http://radioscanningtw.jidanni.org/images/radioscanningtw\nForbidden\n\nYou don't have permission to access /images/radioscanningtw on this server.\n\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\nApache/2.4.6 (Debian) Server at radioscanningtw.jidanni.org Port 80\n\n=========\n\n\n\n==========AH WORKS!===========for both passes!=====\n<If \"%{HTTP_HOST} !~ /radioscanningtw\\.jidanni\\.org/i\">\nSetEnv blockme 1\n</If>\nOrder Deny,Allow\nDeny from all\nAllow from env=!blockme\n=============================\nSo we see the problem has nothing to do with the environment, but\ninstead some operators!\n\nSetEnv blockme 1\n<If \"%{HTTP_HOST} =~ /radioscanningtw\\.jidanni\\.org/i\">\nUnSetEnv blockme\n</If>\nOrder Deny,Allow\nDeny from all\nAllow from env=!blockme\n\nAbove also works.\n\nHowever, the following doesn't. How to explain that?!\n\n<If \"%{HTTP_HOST} =~ /radioscanningtw\\.jidanni\\.org/i\">\nSetEnv good 1\n</If>\nOrder Deny,Allow\nDeny from all\nAllow from env=good\n\n\nOK I have come up with a final working version,\n<If \"%{HTTP_HOST} !~ /radioscanningtw\\.jidanni\\.org/i\">\n    Deny from all\n</If>\nThank goodness!\n\nAlas, that works only for 2.4. Still working on 2.2.", "id": 172138, "time": "2014-01-07T08:16:56Z", "creator": "jidanni@jidanni.org", "creation_time": "2014-01-07T08:16:56Z", "is_private": false}, {"count": 8, "tags": [], "creator": "jidanni@jidanni.org", "text": "No there is no working equivalent for 2.2.9.", "id": 172141, "time": "2014-01-07T09:53:25Z", "bug_id": 55957, "creation_time": "2014-01-07T09:53:25Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "id": 172280, "time": "2014-01-11T14:02:00Z", "bug_id": 55957, "creation_time": "2014-01-11T14:02:00Z", "is_private": false, "text": "The doc info is addressed in trunk and 2.4, see http://svn.apache.org/r1556102\n\nI'd suggest closing this bug and opening a new simpler, shorter enhancement request if you need something very specific in 2.4. \n\nBut since there are 2.4 alternatives to setenvif (<if>) that is already run for subrequests, it's unlikely that anything without a patch provided would be likely to be worked on.\n\nOne thing we can't do in bug reports is address how to get your personal configuration working or. They have to be opened for single distinct issues."}, {"count": 10, "tags": [], "creator": "jidanni@jidanni.org", "attachment_id": null, "id": 172293, "time": "2014-01-12T00:31:31Z", "bug_id": 55957, "creation_time": "2014-01-12T00:31:31Z", "is_private": false, "text": "OK. Opened Bug 55990"}]