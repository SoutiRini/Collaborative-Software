[{"count": 0, "attachment_id": null, "bug_id": 10528, "text": "1) Set the following MDC conversion pattern in a PatternLayout for an appender:\n\n%X\n\n(note that no MDC key is specified)\n\n2) Set some MDC key/value pairs.\n3) Call a log message that will invoke the PatternLayout configured with the \nconversion pattern.\n\nResult: NullPointerException in MDC class.\n\nBug found by Eric Thors (etoelz@yahoo.com).  Data from original email:\n\nOS: Win2000\nJava:1.3.1\nLog4j: 1.2.4\n\n---- TestError.java----------\npublic class TestError {\n   static Logger log = Logger.getLogger(\"foo\");\n\n   public static void main (String[] args) {\n      PropertyConfigurator.configure(args[0]);\n\n      System.out.println(\"start\");\n      MDC.put(\"test\", \"foo\");\n      log.warn(\"Warn me\");\n      log.error(\"Warn me\");\n      System.out.println(\"done\");\n\n   }\n}\n-------------------\n------ log4j.properties --------------\nlog4j.rootCategory=warn, A2, RR, dest2\n\n# A2 is set to be a LF5Appender\nlog4j.appender.A2=org.apache.log4j.lf5.LF5Appender\nlog4j.appender.A2.layout=org.apache.log4j.PatternLayout\nlog4j.appender.A2.layout.ConversionPattern=[slf5s.start]%d{DATE}[slf5s.DATE]%n\\\n \n%p[slf5s.PRIORITY]%n%x[slf5s.NDC]%n%t[slf5s.THREAD]%n\\\n \n%c[slf5s.CATEGORY]%n%l[slf5s.LOCATION]%n%m[slf5s.MESSAGE]%n%n\n\nlog4j.appender.dest2.ImmediateFlush=true\nlog4j.appender.dest2.layout=org.apache.log4j.PatternLayout\nlog4j.appender.dest2.layout.ConversionPattern=%-4r\n[%t] %-5p %c (%X) - %m ~%l%n\n\n! WRITE LOG TO A FILE, ROLL THE FILE AFTER SOME SIZE\nlog4j.appender.dest2=org.apache.log4j.DailyRollingFileAppender\n! This appender will only log messages with priority\nequal to or higher than\n! the one specified here\nlog4j.appender.dest2.Threshold=WARN\n! Specify the file name (${property_key} gets\nsubstituted with its value)\nlog4j.appender.dest2.File=log4j.log\n\n# RR is the RollingFileAppender that outputs to a\nrolling log\n# file called sample.log.\n\nlog4j.appender.RR=org.apache.log4j.RollingFileAppender\nlog4j.appender.RR.File=sample.log\n\nlog4j.appender.RR.layout=org.apache.log4j.PatternLayout\nlog4j.appender.RR.layout.ConversionPattern=[slf5s.start]%d{DATE}[slf5s.DATE]%n\\\n \n%p[slf5s.PRIORITY]%n%x[slf5s.NDC]%n%t[slf5s.THREAD]%n\\\n \n%c[slf5s.CATEGORY]%n%l[slf5s.LOCATION]%n%m[slf5s.MESSAGE]%n%n\n\n# Set the max size of the file\nlog4j.appender.RR.MaxFileSize=500KB\n------------------------\n\n-------Error ----------------\n\njava TestError log4j.properties\nstart\njava.lang.NullPointerException\n        at java.util.Hashtable.get(Hashtable.java:320)\n        at org.apache.log4j.MDC.get0(MDC.java:121)\n        at org.apache.log4j.MDC.get(MDC.java:75)\n        at\norg.apache.log4j.spi.LoggingEvent.getMDC(LoggingEvent.java:228)\n        at\norg.apache.log4j.helpers.PatternParser$MDCPatternConverter.convert\n(PatternParser.java:455)\n        at\norg.apache.log4j.helpers.PatternConverter.format(PatternConverter.java:56)\n        at\norg.apache.log4j.PatternLayout.format(PatternLayout.java:495)\n        at\norg.apache.log4j.WriterAppender.subAppend(WriterAppender.java:292)\n        at\norg.apache.log4j.RollingFileAppender.subAppend(RollingFileAppender.java:225)\n        at\norg.apache.log4j.WriterAppender.append(WriterAppender.java:150)\n        at\norg.apache.log4j.AppenderSkeleton.doAppend(AppenderSkeleton.java:221)\n        at\norg.apache.log4j.helpers.AppenderAttachableImpl.appendLoopOnAppenders\n(AppenderAttachableImpl.java:57)\n        at\norg.apache.log4j.Category.callAppenders(Category.java:190)\n        at\norg.apache.log4j.Category.forcedLog(Category.java:375)\n        at\norg.apache.log4j.Category.warn(Category.java:1024)\n        at TestError.main(TestError.java:11)\n\nIf it were to exit gracefully, you should see \"done\".\n\n----- Patch -------------\n--- MDC.java    2002-07-03 12:09:01.000000000 -0400\n+++ c:/MDC.java 2002-07-03 08:40:54.000000000 -0400\n@@ -117,7 +117,7 @@\n       return null;\n     } else {\n       Hashtable ht = (Hashtable)\n((ThreadLocalMap)tlm).get();\n-      if(ht != null) {\n+      if(ht != null && key != null) {\n        return ht.get(key);\n       } else {\n        return null;", "id": 19089, "time": "2002-07-07T06:41:43Z", "creator": "mwomack@apache.org", "creation_time": "2002-07-07T06:41:43Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 10528, "is_private": false, "id": 19090, "attachment_id": null, "creator": "mwomack@apache.org", "creation_time": "2002-07-07T06:51:03Z", "time": "2002-07-07T06:51:03Z", "text": "Confirmed bug, applied Eric's patch to MDC.java, created new \nPatternParserTestCase to test fix.  Bug resolved."}]