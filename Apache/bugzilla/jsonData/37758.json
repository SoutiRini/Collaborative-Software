[{"count": 0, "tags": [], "bug_id": 37758, "attachment_id": null, "is_private": false, "id": 83151, "time": "2005-12-02T18:28:37Z", "creator": "bobsiegen@googlemail.com", "creation_time": "2005-12-02T18:28:37Z", "text": "When a sub directory was called without a trailing slash and RewriteRule was\nplaced into a .htaccess in that subdirectory, stripping of the per-dir prefix\nfails and an external redirect does not work as expected.\n\n-> The .htaccess is located at /test/.htaccess (which is\nC:/apache/htdocs/test/.htaccess)\n\n-> The URL called without the trailing slash is: http://localhost/test\n\nfirst scenario - internal rewrite -- works fine (expected result is /cef/):\n\nRewriteEngine on\nRewriteRule (.*) /cef/$1 [L]\n\nRewriteLog - loglevel 9\n[rid#11c8e18/initial] (3) [per-dir C:/apache/htdocs/test/] applying pattern\n'(.*)' to uri 'C:/apache/htdocs/test'\n[rid#11c8e18/initial] (2) [per-dir C:/apache/htdocs/test/] rewrite\nC:/apache/htdocs/test -> /cef/C:/apache/htdocs/test\n[rid#11c8e18/initial] (1) [per-dir C:/apache/htdocs/test/] internal redirect\nwith /cef/C:/apache/htdocs/test [INTERNAL REDIRECT]\n[rid#11cae20/initial] (3) [per-dir C:/apache/htdocs/test/] strip per-dir prefix:\nC:/apache/htdocs/test/ -> \n[rid#11cae20/initial] (3) [per-dir C:/apache/htdocs/test/] applying pattern\n'(.*)' to uri ''\n[rid#11cae20/initial] (2) [per-dir C:/apache/htdocs/test/] rewrite  -> /cef/\n[rid#11cae20/initial] (1) [per-dir C:/apache/htdocs/test/] internal redirect\nwith /cef/ [INTERNAL REDIRECT]\n\nDue to the missing trailing slash, mod_rewrite fails to strip the per-dir prefix.\nAfter the first (unexpected) internal redirect (rid#11c8e18) mod_dir acts and\nresponses with a 301 redirect to /test/. With rid#11cae20 mod_rewrite's\nprocessing starts again, strips the  per-dir prefix correctly and performs an\ninternal redirect to the expected URL /cef/.\n\nsecond scenario - external redirection -- does not work (expected result is\nexternal redirect to /cef/):\n\nRewriteEngine on\nRewriteRule (.*) /cef/$1 [R,L]\n\nRewriteLog - loglevel 9\n[rid#11826c0/initial] (3) [per-dir C:/apache/htdocs/test/] applying pattern\n'(.*)' to uri 'C:/apache/htdocs/test'\n[rid#11826c0/initial] (2) [per-dir C:/apache/htdocs/test/] rewrite\nC:/apache/htdocs/test -> /cef/C:/apache/htdocs/test\n[rid#11826c0/initial] (2) [per-dir C:/apache/htdocs/test/] explicitly forcing\nredirect with http://localhost/cef/C:/apache/htdocs/test\n[rid#11826c0/initial] (1) [per-dir C:/apache/htdocs/test/] escaping\nhttp://localhost/cef/C:/apache/htdocs/test for redirect\n[rid#11826c0/initial] (1) [per-dir C:/apache/htdocs/test/] redirect to\nhttp://localhost/cef/C:/apache/htdocs/test [REDIRECT/302]\n\nThe same case: Due to the missing trailing slash, mod_rewrite fails to strip the\nper-dir prefix and matches the RegEx against the full physical filepath. This\ntime mod_dir does not act and does not send the trailing slash. So the URL\nreturned to the client is http://localhost/cef/C:/apache/htdocs/test and not the\nexpected URL http://localhost/cef/.\n\nOf course a workaround is to place the rules into /.htaccess."}, {"count": 1, "tags": [], "bug_id": 37758, "attachment_id": null, "is_private": false, "id": 83264, "time": "2005-12-05T22:03:10Z", "creator": "johndstrunk@gmail.com", "creation_time": "2005-12-05T22:03:10Z", "text": "(In reply to comment #0)\n> When a sub directory was called without a trailing slash and RewriteRule was\n> placed into a .htaccess in that subdirectory, stripping of the per-dir prefix\n> fails and an external redirect does not work as expected.\n> \n> -> The .htaccess is located at /test/.htaccess (which is\n> C:/apache/htdocs/test/.htaccess)\n> \n> -> The URL called without the trailing slash is: http://localhost/test\n> \n> first scenario - internal rewrite -- works fine (expected result is /cef/):\n> \n> RewriteEngine on\n> RewriteRule (.*) /cef/$1 [L]\n> \n> RewriteLog - loglevel 9\n> [rid#11c8e18/initial] (3) [per-dir C:/apache/htdocs/test/] applying pattern\n> '(.*)' to uri 'C:/apache/htdocs/test'\n> [rid#11c8e18/initial] (2) [per-dir C:/apache/htdocs/test/] rewrite\n> C:/apache/htdocs/test -> /cef/C:/apache/htdocs/test\n> [rid#11c8e18/initial] (1) [per-dir C:/apache/htdocs/test/] internal redirect\n> with /cef/C:/apache/htdocs/test [INTERNAL REDIRECT]\n> [rid#11cae20/initial] (3) [per-dir C:/apache/htdocs/test/] strip per-dir prefix:\n> C:/apache/htdocs/test/ -> \n> [rid#11cae20/initial] (3) [per-dir C:/apache/htdocs/test/] applying pattern\n> '(.*)' to uri ''\n> [rid#11cae20/initial] (2) [per-dir C:/apache/htdocs/test/] rewrite  -> /cef/\n> [rid#11cae20/initial] (1) [per-dir C:/apache/htdocs/test/] internal redirect\n> with /cef/ [INTERNAL REDIRECT]\n> \n> Due to the missing trailing slash, mod_rewrite fails to strip the per-dir prefix.\n> After the first (unexpected) internal redirect (rid#11c8e18) mod_dir acts and\n> responses with a 301 redirect to /test/. With rid#11cae20 mod_rewrite's\n> processing starts again, strips the  per-dir prefix correctly and performs an\n> internal redirect to the expected URL /cef/.\n> \n> second scenario - external redirection -- does not work (expected result is\n> external redirect to /cef/):\n> \n> RewriteEngine on\n> RewriteRule (.*) /cef/$1 [R,L]\n> \n> RewriteLog - loglevel 9\n> [rid#11826c0/initial] (3) [per-dir C:/apache/htdocs/test/] applying pattern\n> '(.*)' to uri 'C:/apache/htdocs/test'\n> [rid#11826c0/initial] (2) [per-dir C:/apache/htdocs/test/] rewrite\n> C:/apache/htdocs/test -> /cef/C:/apache/htdocs/test\n> [rid#11826c0/initial] (2) [per-dir C:/apache/htdocs/test/] explicitly forcing\n> redirect with http://localhost/cef/C:/apache/htdocs/test\n> [rid#11826c0/initial] (1) [per-dir C:/apache/htdocs/test/] escaping\n> http://localhost/cef/C:/apache/htdocs/test for redirect\n> [rid#11826c0/initial] (1) [per-dir C:/apache/htdocs/test/] redirect to\n> http://localhost/cef/C:/apache/htdocs/test [REDIRECT/302]\n> \n> The same case: Due to the missing trailing slash, mod_rewrite fails to strip the\n> per-dir prefix and matches the RegEx against the full physical filepath. This\n> time mod_dir does not act and does not send the trailing slash. So the URL\n> returned to the client is http://localhost/cef/C:/apache/htdocs/test and not the\n> expected URL http://localhost/cef/.\n> \n> Of course a workaround is to place the rules into /.htaccess.\n\n\nI get a simmilar problems with mod_rewrite in the virtual host definitions on\nlinux distributions as well.\n\nHTTPS vhost:\nRewriteRule ^/subdirectory/(.*)$  /$1 [C]\nRewriteRule ^/(.*)$    http://www.mydomain.com:8080/subdirectory/$1  [P,L]\n\nIn FireFox, I dont seem to have an issue as frequently (maby becuase it occurs\non new sessions only), but with IE I get upredictable results; sometimes it\nworks, sometimes it doesn't, after the first failed and segfaulting child the\nnext one works, sometimes it takes multiple tries and child processes dying and\nfinnally works.  Wget also has an issue and sometimes it works right off, other\ntimes it takes multiple tries with child procs segfaulting.\n\nthe core dump I get is:\n\n#0  0x403da8c7 in memcpy () from /lib/libc.so.6\n#1  0x4054d6cf in do_expand (r=0x824aa08, input=0x8137c08 \"/SchedWorx/$1\",\n    buffer=0xbfffb850 \"/subdirectory/\", nbuf=8192, briRR=0x824bf50,\n    briRC=0x824bfa8) at mod_rewrite.c:2576\n#2  0x4054c655 in apply_rewrite_rule (r=0x824aa08, p=0x8137d68, perdir=0x0)\n    at mod_rewrite.c:2156\n#3  0x4054c0ed in apply_rewrite_list (r=0x824aa08, rewriterules=0x81378b8,\n    perdir=0x0) at mod_rewrite.c:1843\n#4  0x40553296 in hook_uri2file (r=0x824aa08) at mod_rewrite.c:1190\n#5  0x08080513 in ap_process_request_internal (r=0x824aa08) at request.c:65\n#6  0x080660b9 in ap_process_request (r=0x824aa08) at http_request.c:247\n#7  0x08060ffb in ap_process_http_connection (c=0x8242948) at http_core.c:251\n#8  0x080737d8 in ap_process_connection (c=0x8242948, csd=0x8242870)\n    at connection.c:43\n#9  0x080685d3 in child_main (child_num_arg=8179) at prefork.c:610\n#10 0x080679bc in make_child (s=0xbfffb85b, slot=6) at prefork.c:704\n#11 0x08067517 in ap_mpm_run (_pconf=0x6, plog=0x80cf348, s=0x2)\n    at prefork.c:722\n#12 0x0806e85a in main (argc=3, argv=0xbfffdf44) at main.c:618\n\n\nFrom what I can understand is that mod_rewrite.c failes with an out of mem\naccess and fails.  (mem leak bug?)\n\nI can understand maby the rules are wrong, but that should not *crash* Apache.\n\nThis is with and without the applyed patch of 37145_2.0.x.diff for which I had\nother issues with uploading files via proxy_http.c\n"}, {"count": 2, "tags": [], "text": "Created attachment 17527\nfix\n\nThis solved the issue for me on 2.0.55/Win32, but may be I'm missing something\nin a bigger picture?\n\nmod_rewrite on Apache 1.3.34/Win32 showes the same behavior, even for an\ninternal rewrite, which worked in 2.0.55.", "attachment_id": 17527, "id": 85166, "creator": "bobsiegen@googlemail.com", "time": "2006-01-28T20:27:37Z", "bug_id": 37758, "creation_time": "2006-01-28T20:27:37Z", "is_private": false}, {"count": 3, "tags": [], "text": "I experience the same bug on Gentoo/Linux with:\n\n# apache2 -V\nServer version: Apache/2.0.55\nServer built:   Jan 23 2006 17:02:51\nServer's Module Magic Number: 20020903:11\nArchitecture:   64-bit\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D HTTPD_ROOT=\"/usr\"\n -D SUEXEC_BIN=\"/usr/sbin/suexec2\"\n -D DEFAULT_PIDLOG=\"/var/run/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_LOCKFILE=\"/var/run/accept.lock\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"/etc/apache2/mime.types\"\n -D SERVER_CONFIG_FILE=\"/etc/apache2/httpd.conf\"\n\n\nLinux rackspace 2.6.14-hardened-r3 #5 Mon Jan 23 14:43:24 CST 2006 x86_64 AMD Athlon(tm) 64 \nProcessor 3000+ GNU/Linux\n\n\nThis is not windows specific.", "attachment_id": null, "id": 89147, "creator": "gabe@mudbugmedia.com", "time": "2006-05-15T19:48:11Z", "bug_id": 37758, "creation_time": "2006-05-15T19:48:11Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 37758, "attachment_id": null, "id": 92819, "time": "2006-08-31T20:03:17Z", "creator": "bobsiegen@googlemail.com", "creation_time": "2006-08-31T20:03:17Z", "is_private": false, "text": "This is actuallay a regression introduced with r104840,\n\nThe patch in trunk uses !is_proxyreq (r103199,\nhttp://svn.apache.org/viewvc?view=rev&revision=103199 )\n+    if (!is_proxyreq) {\n+        l = strlen(dconf->directory) - 1;\n+        if (r->filename && strlen(r->filename) == l &&\n+            (dconf->directory)[l] == '/' &&\n+            !strncmp(r->filename, dconf->directory, l)) {\n+            return DECLINED;\n+        }\n\nwhile the backport (r104840,\nhttp://svn.apache.org/viewvc?view=rev&revision=104840 ) uses\n+    if (is_proxyreq) {\n+        l = strlen(dconf->directory) - 1;\n\nSo the exclamation mark seems to be missing there. Marking as fixed, because\nthis problem is not present in trunk and the 2.2 branch."}]