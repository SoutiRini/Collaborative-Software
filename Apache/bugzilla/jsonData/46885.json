[{"count": 0, "tags": [], "creator": "josh@apache.org", "attachment_id": null, "text": "This bug was created due to the poi-user posting by Paul Dobson on Mar 20.\n\nThe following code will cause Excel to report the workbook as corrupted, and attempt a repair on it:\n\nString xlsxFilePath = \"empty.xlsx\";\nFileInputStream in = new FileInputStream(xlsxFilePath);\nWorkbook wb = WorkbookFactory.create(in);\nSheet sh = wb.getSheet(\"Sheet1\");\nRow row = sh.createRow(1);\nCell cell = row.createCell(1);\ncell.setCellFormula(\"NA()\");\ncell.setCellValue(\"Help, I will not change!\"); //corrupts workbook\nin.close();\nFileOutputStream out = new FileOutputStream(\"out.xlsx\");\nwb.write(out);\nout.close();\n\n\nWith some investigation, I found that Excel is missing the type attribute from the following XML fragment:\n<c r=\"B2\">\n  <f>NA()</f>\n  <v>Help, I will not change!</v>\n</c>\n\nBy adding 't=\"str\"' (as follows) the workbook opens properly.\n<c r=\"B2\" t=\"str\">\n  <f>NA()</f>\n  <v>Help, I will not change!</v>\n</c>\n\n\nHere is a patch that seems to have the desired effect.  Can someone review please?\n\n$ svn diff src/ooxml/java/org/apache/poi/xssf/usermodel/XSSFCell.java\nIndex: src/ooxml/java/org/apache/poi/xssf/usermodel/XSSFCell.java\n===================================================================\n--- src/ooxml/java/org/apache/poi/xssf/usermodel/XSSFCell.java  (revision 755692)\n+++ src/ooxml/java/org/apache/poi/xssf/usermodel/XSSFCell.java  (working copy)\n@@ -217,6 +217,7 @@\n             case CELL_TYPE_ERROR:\n             case CELL_TYPE_FORMULA:\n                 cell.setV(String.valueOf(value));\n+                cell.setT(STCellType.N);\n                 break;\n             default:\n                 cell.setT(STCellType.N);\n@@ -303,6 +304,7 @@\n         switch(cellType){\n             case Cell.CELL_TYPE_FORMULA:\n                 cell.setV(str.getString());\n+                cell.setT(STCellType.STR);\n                 break;\n             default:\n                 if(cell.getT() == STCellType.INLINE_STR) {", "id": 125671, "time": "2009-03-21T13:50:12Z", "bug_id": 46885, "creation_time": "2009-03-21T13:50:12Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 46885, "attachment_id": null, "id": 125682, "time": "2009-03-22T08:14:57Z", "creator": "yegor@dinom.ru", "creation_time": "2009-03-22T08:14:57Z", "is_private": false, "text": "Good catch, Josh!\n\nfixed in r757198\n\nThanks,\nYegor"}]