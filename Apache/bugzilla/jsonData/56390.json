[{"count": 0, "tags": [], "bug_id": 56390, "attachment_id": 31513, "id": 174471, "time": "2014-04-11T13:04:03Z", "creator": "violetagg@apache.org", "creation_time": "2014-04-11T13:04:03Z", "is_private": false, "text": "Created attachment 31513\nProfiling analyses\n\nHi,\n\nIf there are jar files in <app>/WEB-INF/lib, Tomcat keeps them opened and during undeploy they cannot be cleared. The following error appears:\n\n\"SEVERE [ContainerBackgroundProcessor[StandardEngine[Catalina]]] org.apache.catalina.startup.ExpandWar.delete [...] could not be completely deleted. The presence of the remaining files may cause problems\" \n\nThe problem is because during startup of the application, a call to o.a.catalina.loader.WebappClassLoader.findResource is made, which opens the files. See the profiling analyses that are attached. (openedfiles.jpg)\n\nA possible solution would be to invoke java.net.URLClassLoader.close() in org.apache.catalina.loader.WebappClassLoader.stop method:\n\nIndex: C:/tc8.0.x/java/org/apache/catalina/loader/WebappClassLoader.java\n===================================================================\n--- C:/tc8.0.x/java/org/apache/catalina/loader/WebappClassLoader.java\t(revision 1585681)\n+++ C:/tc8.0.x/java/org/apache/catalina/loader/WebappClassLoader.java\t(working copy)\n@@ -1497,6 +1497,12 @@\n \n         permissionList.clear();\n         loaderPC.clear();\n+\n+        try {\n+            super.close();\n+        } catch (IOException e) {\n+            throw new LifecycleException(e);\n+        }\n     }\n \nWhat do you think?\n\nRegards\nVioleta"}, {"count": 1, "tags": [], "bug_id": 56390, "attachment_id": null, "id": 174474, "time": "2014-04-11T13:15:59Z", "creator": "markt@apache.org", "creation_time": "2014-04-11T13:15:59Z", "is_private": false, "text": "Steps to reproduce?"}, {"count": 2, "tags": [], "bug_id": 56390, "attachment_id": null, "text": "May not be directly relevant, but I've noticed that Java on Windows keeps an OS lock on files that it has got open - even when read-only. So one cannot delete jars that are in use (and it makes tailing log files tricky in Windows!)\nUnix Java does not seem to have this restriction.", "id": 174480, "time": "2014-04-11T13:46:40Z", "creator": "sebb@apache.org", "creation_time": "2014-04-11T13:46:40Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 56390, "attachment_id": null, "id": 174484, "time": "2014-04-11T15:06:16Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-04-11T15:06:16Z", "is_private": false, "text": "> A possible solution would be to invoke java.net.URLClassLoader.close() in\n> org.apache.catalina.loader.WebappClassLoader.stop method:\n\n1. What will be an effect of calling stop(),start() (I have not checked if anything calls those methods in a pair).\n\nIf URLClassLoader cannot recover after a call to close() then it should be done in destroy() instead of stop().\n\n2. Are you running without a JreMemoryLeakPreventionListener ?"}, {"count": 4, "tags": [], "bug_id": 56390, "attachment_id": null, "id": 174491, "time": "2014-04-11T15:47:16Z", "creator": "violetagg@apache.org", "creation_time": "2014-04-11T15:47:16Z", "is_private": false, "text": "(In reply to Mark Thomas from comment #1)\n> Steps to reproduce?\n\n- ant clean deploy\n- go to output/build and start Tomcat\n- deploy the attached application\n- undeploy the application"}, {"count": 5, "tags": [], "bug_id": 56390, "attachment_id": 31515, "id": 174492, "time": "2014-04-11T15:48:27Z", "creator": "violetagg@apache.org", "creation_time": "2014-04-11T15:48:27Z", "is_private": false, "text": "Created attachment 31515\nexample"}, {"count": 6, "tags": [], "bug_id": 56390, "attachment_id": null, "text": "(In reply to Konstantin Kolinko from comment #3)\n> 2. Are you running without a JreMemoryLeakPreventionListener ?\n\nIt is there I did a regular \"ant clean deploy\" without any additional changes", "id": 174493, "time": "2014-04-11T15:50:40Z", "creator": "violetagg@apache.org", "creation_time": "2014-04-11T15:50:40Z", "is_private": false}, {"count": 7, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 174522, "time": "2014-04-13T02:00:05Z", "bug_id": 56390, "creation_time": "2014-04-13T02:00:05Z", "text": "Looking at this with YourKit the proposed patch (modified as suggested by Konstantin) addresses 2 out of the 4 open file issues I am seeing with lsof.\n\nI want to see if I can find the source of the remaining 2 files before I commit a fix.\n\nNote that triggering GC does clean up all the remaining open files."}, {"count": 8, "tags": [], "bug_id": 56390, "attachment_id": null, "id": 174633, "creation_time": "2014-04-16T14:23:12Z", "time": "2014-04-16T14:23:12Z", "creator": "markt@apache.org", "text": "I've committed a partial fix for this. I made some progress with tracking down the cause of the other files locks but still have some work to do there.", "is_private": false}, {"count": 9, "tags": [], "bug_id": 56390, "attachment_id": null, "id": 174649, "creation_time": "2014-04-16T18:00:15Z", "time": "2014-04-16T18:00:15Z", "creator": "markt@apache.org", "text": "Fix in 8.0.x for 8.0.6 onwards.", "is_private": false}, {"count": 10, "tags": [], "bug_id": 56390, "attachment_id": null, "id": 177439, "creation_time": "2014-08-29T12:42:44Z", "time": "2014-08-29T12:42:44Z", "creator": "dennisl@apache.org", "text": "We are seeing this issue as well in Tomcat 6.0.35 on Windows 7.\nIs there any chance of a back-port to Tomcat 6 or 7 for this fix?", "is_private": false}]