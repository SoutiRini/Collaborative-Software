[{"count": 0, "tags": [], "bug_id": 14556, "attachment_id": null, "is_private": false, "id": 26278, "time": "2002-11-14T16:04:03Z", "creator": "rx@armstrike.com", "creation_time": "2002-11-14T16:04:03Z", "text": "When document is cashed, mod_cache.c stores time of cash in date variable \n(info->date), when it happenes debug says \"Added date header\". Then every \nother request will use this cash and date variable will always be the same \nwith the date when cash stored. All works fine yet, but that happens if cashed \ndocument was changed: mod_cache stores new last modified date of the document \nin the lastmod variable, and then compares if lastmod > date then \nlastmod=date, debug says \"lastmod is in the future replacing with now\"(but \ndate its not now, its date of last cash?). The problem is how mod_cache \ncalculates cash expire. \n\nexpiry date = now + min((date - lastmod) * factor, maxexpire)\n\nIf document doesnt have Expire in the headers, then expire time will be: now + \n0 * factor = now, and mod_cache will never cash document anymore, before \napache restart when cashed headers with old date will be deleted. \n\nI dont know is it supposed to work this way, or maybe some removal algorithms \nof old cashed dates doesnt work? For now i deleted \"if lastmod>date then \nlastmod=date\" piece of code and all works fine. \n\nAlso i added:\nexpiry date = now + min(((date - lastmod) * factor) + conf->defex, maxexpire)\n\nso if i set \"CacheLastModifiedFactor 0\" and \"CacheDefaultExpire time\" in \nhttpd.conf, i can manually add expire time in seconds if i dont want to use \nExpires headers, so should be the way to manually enter expire time besides \nExpire headers."}, {"count": 1, "attachment_id": null, "bug_id": 14556, "text": "Thanks for the diagnosis and input. I have committed a fix for this PR which\nwill be shipped in a future release of Apache.\n\nThe fix simply changes the checking code in mod_cache (around line 853) from\n\nif (lastmod != APR_DATE_BAD)\n\nto\n\nif ((lastmod != APR_DATE_BAD) && (lastmod < date))\n\nThis forces the code into the else clause when lastmod == date.\n\nYou should not remove the \"if lastmod>date then lastmod=date\" code\nsince this has other negative consequences in checking for freshness.\nAlso, adding the conf->defex value into the expiry date calculation, as you\ndid, will either result in a longer than expected expiry date, or an expiry\ndate of maxexpire.\n\nPlease let me know if the above fix (adding \"&& (lastmod < date))\") fails to\nsolve the problem for you.\n\nThanks for using Apache and helping to make it better.", "id": 26746, "time": "2002-11-21T22:07:33Z", "creator": "rederpj@remulak.net", "creation_time": "2002-11-21T22:07:33Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 14556, "attachment_id": null, "is_private": false, "id": 27766, "time": "2002-12-12T22:15:04Z", "creator": "rx@armstrike.com", "creation_time": "2002-12-12T22:15:04Z", "text": "Hi,\n\ni just checked your response.\n\nLook, that if you change\n\nif (lastmod != APR_DATE_BAD)\n\nto\n\nif ((lastmod != APR_DATE_BAD) && (lastmod < date))\n\nthat will work, but it will break advantage of conf->factor future, and \nmodified documents always will be based on conf->defex variable. So what will \nbe the difference between document that is modified every 10 sec and another \nthat is modified every 5 hours? \nAs i got, the problem is that mod_cache doesnt refresh \"Date\" value in cached \nheaders untill apache restart, so, instead of that fix above, line 809 should \nbe changed from\n\nif (info->date == APR_DATE_BAD) {\n\nto\n\nif ((info->date == APR_DATE_BAD) || (lastmod >= info->date)) {\n\nthis will update date header in cache after document was modified, and after \nthat all will work fine, with conf->factor etc. as like apache was restarted.\n"}, {"count": 3, "attachment_id": null, "bug_id": 14556, "text": "The problem still in 2.0.44. With the fix above modified documents will never use \nthis formula: expiry date = now + min((date - lastmod) * factor, maxexpire), \nbecause the \"Date\" header doesnt refresh never, lastmod always will be greater \nthan date, isnt that a bug? So, the string around line 704 (in 2.0.44 mod_cache.c) \nshould be changed from\n\n    if (info->date == APR_DATE_BAD){  /* No, or bad date */\nto\n    if ((info->date == APR_DATE_BAD) || (lastmod > date)){  /* No, or bad date */\n\nthat will make \"Date\" header updated with *now* if document was modified and \nlastmod wont be greater than date. So the formula with conf->factor will work.\n\nAlso that string around line 752 that is now \n   if ((lastmod != APR_DATE_BAD) && (lastmod < date)) {\nshould be changed to\n   if ((lastmod != APR_DATE_BAD) && (lastmod <= date)) {\n\nBecause in some cases, then the document was modified in the same time(same \nsecond) as requested by server, it should really expired by now and not be \ncached for default time. \n\nWith these fixes above, it will be possible to configure the server to cache the \ndocuments for some time, BUT the documents that is modified for example every \n1 second, automatically will be almost not cached.", "id": 30047, "time": "2003-01-25T16:29:21Z", "creator": "rx@armstrike.com", "creation_time": "2003-01-25T16:29:21Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "creator": "rx@armstrike.com", "attachment_id": null, "id": 30054, "time": "2003-01-26T00:18:43Z", "bug_id": 14556, "creation_time": "2003-01-26T00:18:43Z", "is_private": false, "text": "One mistake above, line 752\n\n    if ((lastmod != APR_DATE_BAD) && (lastmod < date)) {\n\nshould be changed back to simple\n\n    if (lastmod != APR_DATE_BAD) {\n\nnot to\n\nif ((lastmod != APR_DATE_BAD) && (lastmod <= date)) {\n\nbecause there will be no difference, lastmod always <= date"}, {"count": 5, "tags": [], "creator": "chip@force-elite.com", "attachment_id": null, "id": 75899, "time": "2005-06-03T02:38:57Z", "bug_id": 14556, "creation_time": "2005-06-03T02:38:57Z", "is_private": false, "text": "Can you please try this with 2.0.54, and try using mod_disk_cache instead of\nmod_mem_cache?\n\nThanks"}, {"count": 6, "attachment_id": null, "bug_id": 14556, "is_private": false, "id": 104224, "time": "2007-06-08T12:02:07Z", "creator": "davi@apache.org", "creation_time": "2007-06-08T12:02:07Z", "tags": [], "text": "No response from user. If more information appears later, please re-open\nthe bug, for now, file it."}]