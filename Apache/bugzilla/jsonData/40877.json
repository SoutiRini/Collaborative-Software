[{"attachment_id": null, "tags": [], "creator": "bjoern@syltonline.de", "text": "Hi Mladen,\nWe migrate from JK2 to JK1 in the moment. We encountered some problems on \nbigger Webfarms with the JK1 / IIS6 in full Application Isolation mode. The \nmain blocker is, when a Application pool is run in multithreading \nconfiguration (App-Pool-> Properties->Performance-> Web-Garden-> Number of \nWorker Processes), the JK does not start right: (Loglevel Info)\n\n[Thu Nov 02 16:35:53 2006] [5872:5924] [error] validate::jk_lb_worker.c \n(1104): allocating worker record from shared memory\n[Thu Nov 02 16:35:53 2006] [5872:5924] [error] wc_create_worker::jk_worker.c \n(158): validate failed for P-NG-TC3Hx\n[Thu Nov 02 16:35:53 2006] [5872:5924] [error] build_worker_map::jk_worker.c \n(256): failed to create worker P-NG-TC3Hx\n[Thu Nov 02 16:35:54 2006] [4012:6612] [error] wc_create_worker::jk_worker.c \n(146): factory for lb failed for P-NG-TC3Hx\n[Thu Nov 02 16:35:54 2006] [4012:6612] [error] build_worker_map::jk_worker.c \n(256): failed to create worker P-NG-TC3Hx\n[Thu Nov 02 16:35:57 2006] [1672:6912] [error] wc_create_worker::jk_worker.c \n(146): factory for lb failed for P-NG-TC3Hx\n[Thu Nov 02 16:35:57 2006] [1672:6912] [error] build_worker_map::jk_worker.c \n(256): failed to create worker P-NG-TC3Hx\n[Thu Nov 02 16:36:27 2006] [6100:3092] [error] wc_create_worker::jk_worker.c \n(146): factory for lb failed for P-NG-TC3Hx\n[Thu Nov 02 16:36:27 2006] [6100:3092] [error] build_worker_map::jk_worker.c \n(256): failed to create worker P-NG-TC3Hx\n\nIt runs fine with a singler worker process. I also tried to \nreduce \"connection_pool_size\" to 1 (from 64) because there are known probs \nwith Apache prefork, but it didn't help. This is a real production blocker.\n\nI also realized that in the jkstatus, the live-config and stati apply only to \nthe application pool this web is in. If i reconfigure a jk in a web in a \ndifferent pool, it is totally independent. As I understand it, all jk-\ninstances on one server should share this information through a shared memory \narea. This doesn't seem to work either.With that bug, one can't use the nice \nfeature to reconfigure the jk online on IIS6 with multiple application pools.\n\nIf you need config files or debug logs, please ask. These are from production \nenvironment, so I'd prefere to send them personally.", "count": 0, "id": 95353, "time": "2006-11-02T09:01:42Z", "bug_id": 40877, "creation_time": "2006-11-02T09:01:42Z", "is_private": false}, {"count": 1, "tags": [], "creator": "mturk@apache.org", "attachment_id": null, "id": 95356, "time": "2006-11-02T09:11:01Z", "bug_id": 40877, "creation_time": "2006-11-02T09:11:01Z", "is_private": false, "text": "You are correct.\n\nWill you be willing to test the patched binary?\nAlso, what platfom it is. WIN32 or WIN64?"}, {"count": 2, "tags": [], "creator": "bjoern@syltonline.de", "attachment_id": null, "is_private": false, "id": 95357, "time": "2006-11-02T09:23:32Z", "bug_id": 40877, "creation_time": "2006-11-02T09:23:32Z", "text": "Yes, we can test the binaries. Thank you for the offer.\nIt happens on both, the 32 an 64 bit plattforms. in the moment, a 64 bit \nwebfarm produces the errors. But we also got 32 bit systems ready to test."}, {"count": 3, "tags": [], "creator": "bjoern@syltonline.de", "attachment_id": null, "id": 95456, "time": "2006-11-06T01:20:32Z", "bug_id": 40877, "creation_time": "2006-11-06T01:20:32Z", "is_private": false, "text": "Hi again, hete to say it, but we found another severe bug in the full \nApplication Isolation mode of IIS6 with jk1.2.x. Application pools recycle \nthemself after some time or number of requests. When this happens:\n\n Event Type:\tInformation\n Event Source:\tW3SVC\n Event Category:\tNone\n Event ID:\t1074\n Date:\t\t05.11.2006\n Time:\t\t02:41:15\n User:\t\tN/A\n Computer:\txxxxxxxxxxxxx\n Description:\n A worker process with process id of '1380' serving application\n pool 'www.premiere.de' has requested a recycle because the worker\n process reached its allowed processing time limit.  \n\n...the JK exits with an error:\n\n[Fri Nov 03 22:28:09 2006] [1380:6848] [info]  service::jk_lb_worker.c (873): \nunrecoverable error 413, request failed. Client failed in the middle of \nrequest, we can't recover to another instance.\n[Sun Nov 05 02:41:20 2006] [2044:3792] [error] wc_create_worker::jk_worker.c \n(146): factory for lb failed for P-NG-TC3Hx\n[Sun Nov 05 02:41:20 2006] [2044:3792] [error] build_worker_map::jk_worker.c \n(256): failed to create worker P-NG-TC3Hx\n[Sun Nov 05 02:41:20 2006] [6872:4756] [error] wc_create_worker::jk_worker.c \n(146): factory for lb failed for P-NG-TC3Hx\n[Sun Nov 05 02:41:20 2006] [6872:4756] [error] build_worker_map::jk_worker.c \n(256): failed to create worker P-NG-TC3Hx\n[Sun Nov 05 02:41:32 2006] [6568:3420] [error] wc_create_worker::jk_worker.c \n(146): factory for lb failed for P-NG-TC3Hx\n[Sun Nov 05 02:41:32 2006] [6568:3420] [error] build_worker_map::jk_worker.c \n(256): failed to create worker P-NG-TC3Hx\n[Sun Nov 05 02:42:04 2006] [1360:4448] [error] wc_create_worker::jk_worker.c \n(146): factory for lb failed for P-NG-TC3Hx\n[Sun Nov 05 02:42:04 2006] [1360:4448] [error] build_worker_map::jk_worker.c \n(256): failed to create worker P-NG-TC3Hx\n\nJK2 had no problem with this. Maybe this had also to do with the shared mem \nproblem, because the \"main\" jk1 ISAPI-extension is configured globaly in the \nIIS, and the called JK1-instances are run in the Application Pool environment. \nCan you tell me roughly when a testversion will be available? It matters for \nour Testsystems to be held in this state or, if it takes longer, to be re-\nsetup later."}, {"count": 4, "tags": [], "creator": "mturk@apache.org", "attachment_id": null, "id": 95458, "time": "2006-11-06T01:50:47Z", "bug_id": 40877, "creation_time": "2006-11-06T01:50:47Z", "is_private": false, "text": "Hi,\n\nYes the problem is with shared memory.\nIt is initialized as global while it should be initialized on\nper virtual server basis.\n\nI'll take a look at that this week."}, {"count": 5, "tags": [], "creator": "mturk@apache.org", "attachment_id": 19133, "id": 95855, "time": "2006-11-14T23:32:53Z", "bug_id": 40877, "creation_time": "2006-11-14T23:32:53Z", "is_private": false, "text": "Created attachment 19133\nWIN64/AMD64 ISAPI Redirect\n\nisapi_redirect 1.2.20 with shared memory patch"}, {"count": 6, "tags": [], "bug_id": 40877, "is_private": false, "text": "Thank you for the fix. I did a quick test on the AMD64 server and it looks \nreally good. Multithread in an applicationpool and app pool recyling seems to \nwork fine.\nA few tests later, only a few small flaws appeared.\n\nFirst, you get an (one!) error when die app-pool recycles. This is easy \nreproduceable. Recycle every 100 requests, you'll get one error like these \nevery 100 requests. Sometimes 2 per cycle at the same time.\n\n[Wed Nov 15 15:32:34 2006] [5536:4756] [error] \nHttpExtensionProc::jk_isapi_plugin.c (1102): could not get a worker for name P-\nNG-TC3Hx\n[Wed Nov 15 15:32:54 2006] [5568:6800] [error] \nHttpExtensionProc::jk_isapi_plugin.c (1102): could not get a worker for name P-\nNG-TC3Hx\n\nAlso, rarely, a \"WriteClient failed\" appears. This didn't happen before on the \nJK2. But I'm not totally sure if this applies to this jk-version as origin.\n\n[Wed Nov 15 17:16:48 2006] [0540:6520] [error] write::jk_isapi_plugin.c (656): \nWriteClient failed with 00002746\n[Wed Nov 15 17:16:48 2006] [0540:6520] [info]  \najp_process_callback::jk_ajp_common.c (1421): Writing to client aborted or \nclient network problems\n[Wed Nov 15 17:16:48 2006] [0540:6520] [info]  ajp_service::jk_ajp_common.c \n(1813): (P-NG-TC3H1) request failed, because of client write error without \nrecovery in send loop attempt=0\n[Wed Nov 15 17:16:48 2006] [0540:6520] [info]  service::jk_lb_worker.c (874): \nunrecoverable error 200, request failed. Client failed in the middle of \nrequest, we can't recover to another instance.\n\nAnd still in the jkstatus, the config and stati apply only to this app pool or \neven web / virtual server. I guess this is by design, because you mentioned to \nchange the shared mem to a per-vhost basis. But it is still not very handy. \nSay you want to drain a tomcat to do maintainance, on our farms you'd need to \ndo it not only on 11 frontent webservers but also on 41 webs per server. \nThat's not practicable. Hopefully in the future, there is a per-vhost an \nglobal section in jkstatus. But this would need globally initialized shared \nmem again :)\n\nAlso tested was the \"reference\" directive, which didn't work in the 1.2.19 on \nIIS. That also worked fine.\n\nAll in all, great work, thanks. If you can fix the last on-recycle error I'd \nsay test passed for amd64. Any idea when the final 1.2.20 will be released?", "id": 95873, "time": "2006-11-15T09:32:01Z", "creator": "bjoern@syltonline.de", "creation_time": "2006-11-15T09:32:01Z", "attachment_id": null}, {"count": 7, "tags": [], "creator": "opbhakar@yahoo.com", "attachment_id": null, "is_private": false, "id": 95882, "time": "2006-11-15T15:15:29Z", "bug_id": 40877, "creation_time": "2006-11-15T15:15:29Z", "text": "(In reply to comment #5)\n> Created an attachment (id=19133) [edit]\n> WIN64/AMD64 ISAPI Redirect\n> \n> isapi_redirect 1.2.20 with shared memory patch\n\nHi Mladen, \n\nWe are having similar sort of issue on Win32 Platform. I will explain in detail. \n\nEnvironment\nWe are running MS Application Center Load Balanced Web Server Farm with 3 nodes\nrunning IIS 6 in Worker Process Isolation mode. The Tomcat/JBoss runs on two\nseparate Servers (again Load Balanced via Application Center). The Web Server\nFarm is running 5 Websites. The JK ISAPI redirector version is 1.2.19 and is\nconfigured on per site basis.\n\nProblem\nEverything works fine except when the application pool undergoes recycling, the\nwebsite using that application pool wouldn't work. Recycling application pool\nagain, restarting website wouldn't help. The request to that website gets 404.2\nand 404.3 in IIS logs. The 404.2 indicates that JK ISAPI is locked or access is\ndenied to the JK ISAPI. The only way to get it working again is to do an\nIISRESET which affects all other websites and disconnects all the users\nconnected to those websites. Its very frustrating as the whole purpose of IIS 6\nrunning in worker process isolation mode is defeated.\n\nThe JK Logs shows the following \n[Wed Nov 15 17:25:41 2006] [1228:4924] [error] jk_worker.c (256): failed to\ncreate worker lbworker\n[Wed Nov 15 17:49:24 2006] [2332:2232] [error] jk_worker.c (146): factory for lb\nfailed for lbworker\n[Wed Nov 15 17:49:24 2006] [2332:2232] [error] jk_worker.c (256): failed to\ncreate worker lbworker\n[Wed Nov 15 18:31:12 2006] [4756:4804] [error] jk_worker.c (146): factory for lb\nfailed for lbworker\n[Wed Nov 15 18:31:12 2006] [4756:4804] [error] jk_worker.c (256): failed to\ncreate worker lbworker\n[Wed Nov 15 18:57:02 2006] [4044:6564] [error] jk_worker.c (146): factory for lb\nfailed for lbworker\n[Wed Nov 15 18:57:02 2006] [4044:6564] [error] jk_worker.c (256): failed to\ncreate worker lbworker\n[Wed Nov 15 18:57:24 2006] [0324:6956] [error] jk_worker.c (146): factory for lb\nfailed for lbworker\n[Wed Nov 15 18:57:24 2006] [0324:6956] [error] jk_worker.c (256): failed to\ncreate worker lbworker\n[Wed Nov 15 18:57:32 2006] [3660:5948] [error] jk_worker.c (146): factory for lb\nfailed for lbworker\n[Wed Nov 15 18:57:32 2006] [3660:5948] [error] jk_worker.c (256): failed to\ncreate worker lbworker\n\nThe windows eventlog would show the following: \nEvent Type:\tInformation\n Event Source:\tW3SVC\n Event Category:None\n Event ID:\t1074\n Date:\t\t15.11.2006\n Time:\t\t06:56:36\n User:\t\tN/A\n Computer:\txxxxxxxxxxxxx\n Description:\nA worker process with process id of '6308' serving application pool 'xxxxx' has\nrequested a recycle because the worker process reached its allowed processing\ntime limit.  \n\nWe didn't have any issues with the earlier version of JK which was 1.2.08. I\nhave a strong feeling that this has to do with the shared memory problem. \n\nPlease let me know if you need any further information, config files or log files. "}, {"count": 8, "tags": [], "text": "Hi Om Bhakar.\nYes, the problem you describe has been acknowledged by Mladen, he in working \non it and already released a patched version for 64bit systems, as you can \nread above. The test looked good, so I guess it's only a matter of days until \na patched version for you 32 bit environment is supplied. So we should better \nleave Mladen to do his good work.\n\nHi Mladen,\nI'm pretty sure now that the \"WriteClient failed\" problem has nothing to do \nwith your patch. After a few reconfigurations and tomcat restarts i managed a \n1h loadtest with several 100000 requests where only the expected ammount \nof \"could not get a worker for name ...\" recycle-errors occoured.", "is_private": false, "bug_id": 40877, "id": 95883, "time": "2006-11-15T15:28:25Z", "creator": "bjoern@syltonline.de", "creation_time": "2006-11-15T15:28:25Z", "attachment_id": null}, {"count": 9, "tags": [], "text": "Hi Bjoern Andersen,\n\nThe problem is very intermittent and we can't replicate it when we want to. It \nwould happen may be once a day, not necessarily but most probably around the \ntime when the application pool recycles itself. One website using JK stops \nworking and no matter what we do (except IISRESET), it wouldn't come up \nthrowing 404.2 and 404.3 errors.\n\nI don't have any idea as when the patch would be released. I am more than \nwilling to test it as soon as it is released. In the mean time while Mladen is \ndoing the good work to release patch for JK 1.2.19 for win32, What I am \nthinking is to roll back to JK 1.2.15 since this bug is affecting our \nproduction environment. Do you know by any chance if the version JK 1.2.15 is \nmore stable and doesn't have the shared memory bug. What version of JK would \nyou suggest to roll back to?", "attachment_id": null, "bug_id": 40877, "id": 96054, "time": "2006-11-21T17:46:39Z", "creator": "opbhakar@yahoo.com", "creation_time": "2006-11-21T17:46:39Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 40877, "attachment_id": null, "is_private": false, "id": 96058, "time": "2006-11-22T02:03:07Z", "creator": "bjoern@syltonline.de", "creation_time": "2006-11-22T02:03:07Z", "text": "Hi Om Bhakar,\nSorry, no idea. We are switching from jk2.0.4, and tested only 1.2.18 & 19. \nBoth had the recycle problem.\n\nHi Mladen,\nCan you give a quick insight into the release plans? Is there going to be a \n32bit patch version or is 1.2.20 so close that you want to wait for that? When \ncan we expect the 32bit version?"}, {"count": 11, "tags": [], "creator": "rainer.jung@kippdata.de", "attachment_id": null, "is_private": false, "id": 96060, "time": "2006-11-22T02:08:06Z", "bug_id": 40877, "creation_time": "2006-11-22T02:08:06Z", "text": "I don't know, if Mladen still want to do something for the Win world, but the\nchanges on my side will be finished latest next weekend. So I will suggest today\non the list to cut the release sometime very close to the next weekend, and if\nwe did our job good, it will take at most another week before it's final. After\ntagging we usually wait a few days for community testing and then we call a\nthree day vote on stability."}, {"count": 12, "tags": [], "creator": "mturk@apache.org", "text": "Created attachment 19156\nWIN32 ISAPI Redirect\n\nWIN32 ISAPI Redirect 1.2.20 dev version", "id": 96061, "time": "2006-11-22T02:27:20Z", "bug_id": 40877, "creation_time": "2006-11-22T02:27:20Z", "is_private": false, "attachment_id": 19156}, {"count": 13, "tags": [], "creator": "opbhakar@yahoo.com", "attachment_id": null, "id": 97518, "time": "2007-01-01T17:56:17Z", "bug_id": 40877, "creation_time": "2007-01-01T17:56:17Z", "is_private": false, "text": "Hi Mladen & Team, \n\nThe newer version of JK Redirector 1.2.20 is performing very well and doing a\nfantastic job as we didn't have any issues so far after deploying the newer\nversion 2 weeks back. I would like to thank you and the whole Tomcat Jakarta\nRedirector Development/Test Team for doing such an excellent job. \n\nThanks. \n"}]