[{"count": 0, "tags": [], "bug_id": 50898, "is_private": false, "id": 144849, "attachment_id": null, "creator": "moreira@privasphere.com", "creation_time": "2011-03-09T04:53:28Z", "time": "2011-03-09T04:53:28Z", "text": "I am facing a problem which appeared after my colleague updated one of our scripts. He saved the script with the jmeter revision 1077948\n\nI am able to load and execute my script without any problems if I do it from the GUI without providing it in the command line. However if I pass the script in the command line I get the following exception:\n\n2010/09/20 17:12:09 ERROR - jmeter.engine.StandardJMeterEngine: Uncaught exception:  java.lang.NullPointerException\n\tat org.apache.jorphan.collections.HashTree.traverseInto(HashTree.java:989)\n\tat org.apache.jorphan.collections.HashTree.traverseInto(HashTree.java:989)\n\tat org.apache.jorphan.collections.HashTree.traverseInto(HashTree.java:989)\n\tat org.apache.jorphan.collections.HashTree.traverseInto(HashTree.java:989)\n\tat org.apache.jorphan.collections.HashTree.traverse(HashTree.java:971)\n\tat org.apache.jmeter.engine.StandardJMeterEngine.run(StandardJMeterEngine.java:385)\n\tat java.lang.Thread.run(Thread.java:619)\n\t\n\tThe problem seems to be in Iterator<?> iter = list().iterator();\n            while (iter.hasNext()) {\n                Object item = iter.next();\n                final HashTree treeItem = getTree(item);\n                visitor.addNode(item, treeItem);\n                treeItem.traverseInto(visitor);\n            }\n     \n     I don't understand how this problem can even happen. What occurs is that treeItem is null. \n     Adding some expressions evaluation I got the following results:\n     list().contains(item) => true\n     containsKey(item) => false\n     get(item) != null => false\n     \n     I noticed that in the script that no longer works some elements are saved differently than they used to be:\n     This is how it used to work:\n     <org.apache.jmeter.protocol.smtp.sampler.SmtpSampler guiclass=\"org.apache.jmeter.protocol.smtp.sampler.gui.SmtpSamplerGui\" testclass=\"org.apache.jmeter.protocol.smtp.sampler.SmtpSampler\" testname=\"SMTP 1\" enabled=\"true\">\n     \n     This is how it is now:\n     <SmtpSampler guiclass=\"SmtpSamplerGui\" testclass=\"SmtpSampler\" testname=\"SMTP 1\" enabled=\"true\">\n     \n     However I do not know if this is the cause of the problem...\n     \n     Any light in this matter would be very appreciated."}, {"count": 1, "tags": [], "creator": "moreira@privasphere.com", "is_private": false, "text": "After digging more into this problem I found out a work around for my script.\n\nThe problem seems to come from IncludeController. I had in my script 2 IncludeControllers They had the same name and included the same file. By changing the name of one of the IncludeControllers I am now able to also launch JMeter passing this script as parameter.\n\nI guess this bug is related to the overridden methods equals() and hashCode from AbstractTestElement. Somehow that confused the HashMap.", "id": 144851, "time": "2011-03-09T05:39:54Z", "bug_id": 50898, "creation_time": "2011-03-09T05:39:54Z", "attachment_id": null}, {"count": 2, "tags": [], "text": "Created attachment 27664\nIncluding Plan  that reproduces the NullPointer in non gui mode", "is_private": false, "id": 150035, "creator": "p.mouawad@ubik-ingenierie.com", "time": "2011-10-01T22:31:30Z", "bug_id": 50898, "creation_time": "2011-10-01T22:31:30Z", "attachment_id": 27664}, {"count": 3, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "is_private": false, "text": "Created attachment 27665\nIncluded plan", "id": 150036, "time": "2011-10-01T22:31:57Z", "bug_id": 50898, "creation_time": "2011-10-01T22:31:57Z", "attachment_id": 27665}, {"attachment_id": 27666, "tags": [], "bug_id": 50898, "text": "Created attachment 27666\nLog file", "count": 4, "id": 150037, "time": "2011-10-01T22:37:38Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-10-01T22:37:38Z", "is_private": false}, {"count": 5, "tags": [], "text": "I confirm there is an issue related to hashCode and equals.\n\nto test this hypothesis I modified HashTree#traverseInto:\nprivate void traverseInto(HashTreeTraverser visitor) {\n\n        if (list().size() == 0) {\n            visitor.processPath();\n        } else {\n            Iterator<?> iter = list().iterator();\n            \n            while (iter.hasNext()) {\n                Object item = iter.next();\n                final HashTree treeItem = getTree(item);\n                visitor.addNode(item, treeItem);\n                if(treeItem==null)\n                {\n                    List<IncludeController>  list = new ArrayList<IncludeController>();\n                    Iterator<?> iter2 = list().iterator();\n                    while (iter2.hasNext()) {\n                        Object item2 = iter2.next();\n                        if(item2 instanceof IncludeController)\n                        {\n                            list.add((IncludeController)item2);\n                        }\n                    }\n                    if(list.size()==2)\n                    {\n                        IncludeController controller1 = list.get(0);\n                        IncludeController controller2 = list.get(1);\n                        System.out.println(controller1.equals(controller2));\n                        System.out.println(controller1.hashCode());\n                        System.out.println(controller2.hashCode());\n                    }\n                }\n                treeItem.traverseInto(visitor);\n            }\n        }\n        visitor.subtractNode();\n    }\n\n\n\nAnd it shows the following:\ntrue => Objects are equals\n831453930\n1248040939\n\nAccording to javadocs:\nIf two objects are equal according to the equals(Object) method, then calling the hashCode method on each of the two objects must produce the same integer result.", "is_private": false, "id": 150038, "creator": "p.mouawad@ubik-ingenierie.com", "time": "2011-10-01T23:24:41Z", "bug_id": 50898, "creation_time": "2011-10-01T23:24:41Z", "attachment_id": null}, {"count": 6, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "text": "Created attachment 27671\nFix to issue\n\nPatch relies on another more efficient iteration mode using entrySet.\nThis method will not use hashCode so will not meet bug.\n\ntraverse(HashTreeTraverser visitor) may have same issue:\n- Is there a reason why getTree is called twice ? I don't think so cause it would meen visitor.addNode() changes data Map which would provoke ConcurrentModificationException ? if answer is no, then same iteration mode could be used\n\nThere is still the root cause to investigate regarding hashCode bug.\n\nRegards\nPhilippe", "id": 150046, "time": "2011-10-02T07:01:01Z", "bug_id": 50898, "creation_time": "2011-10-02T07:01:01Z", "is_private": false, "attachment_id": 27671}, {"count": 7, "tags": [], "bug_id": 50898, "attachment_id": null, "text": "(In reply to comment #2)\n> Created attachment 27664 [details]\n> Including Plan  that reproduces the NullPointer in non gui mode\n\nDoes not appear to be the correct test plan; it does not use an include controller", "id": 150054, "time": "2011-10-02T14:16:34Z", "creator": "sebb@apache.org", "creation_time": "2011-10-02T14:16:34Z", "is_private": false}, {"count": 8, "tags": [], "text": "(In reply to comment #3)\n> Created attachment 27665 [details]\n> Included plan\n\nIf this is the sample included plan, it is excessively complicated.\nPlease use smallest possible test plan, and ideally use Java Request instead of HTTP sampler (unless the test requires an HTTP sample).", "is_private": false, "id": 150055, "creator": "sebb@apache.org", "time": "2011-10-02T14:18:56Z", "bug_id": 50898, "creation_time": "2011-10-02T14:18:56Z", "attachment_id": null}, {"attachment_id": 27673, "tags": [], "bug_id": 50898, "is_private": false, "count": 9, "id": 150057, "time": "2011-10-02T17:00:09Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-10-02T17:00:09Z", "text": "Created attachment 27673\nIncluder plan"}, {"count": 10, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "text": "Created attachment 27674\nIncluded in Use.Include.jmx\n\nHello Sebb,\nAs you requested, much simpler plan.\nRegards\nPhilippe", "id": 150058, "time": "2011-10-02T17:01:05Z", "bug_id": 50898, "creation_time": "2011-10-02T17:01:05Z", "is_private": false, "attachment_id": 27674}, {"attachment_id": null, "tags": [], "bug_id": 50898, "is_private": false, "count": 11, "id": 150063, "time": "2011-10-02T20:40:49Z", "creator": "sebb@apache.org", "creation_time": "2011-10-02T20:40:49Z", "text": "(In reply to comment #10)\n> Created attachment 27674 [details]\n> Included in Use.Include.jmx\n> \n> Hello Sebb,\n> As you requested, much simpler plan.\n\nThanks, that's better. \n\nNot sure why the Thread Group with the module controller is present, as the top-level script still fails without it in non-GUI mode. Likewise the Transaction Controller seems to be unnecessary.\n\nAll that is needed is a Test Fragment with a single Java sampler."}, {"attachment_id": 27675, "tags": [], "bug_id": 50898, "is_private": false, "count": 12, "id": 150064, "time": "2011-10-02T21:16:04Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-10-02T21:16:04Z", "text": "Created attachment 27675\nIncluded in Use.Include.jmx\n\nTest plan as you requested.\nSebb, about your request, I just took another plan I found in another IncludeController bug 51869 and tried to reproduce issue with it by changing what initial bug submitter described, once it reproduced it, I used it as is.\nThat's why plan was initially complex.\n\nRegards\nPhilippe"}, {"count": 13, "tags": [], "bug_id": 50898, "is_private": false, "id": 150065, "attachment_id": 27676, "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-10-02T21:18:27Z", "time": "2011-10-02T21:18:27Z", "text": "Created attachment 27676\nIncluder plan"}, {"attachment_id": null, "tags": [], "bug_id": 50898, "is_private": false, "count": 14, "id": 150069, "time": "2011-10-03T08:02:14Z", "creator": "sebb@apache.org", "creation_time": "2011-10-03T08:02:14Z", "text": "The fix looks OK, however it causes some tests to fail.\n\nIn particular, \"ant batchtest\" detects differences in BatchTestLocal.csv.\nThese show that the test plan behaves very differently."}, {"count": 15, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "text": "Hello Sebb,\nVery strange indeed, as strange as the fact that although key is here, getTree does not find its value.\n\nI think we should fix issue related to hashCode and equals in AbstractTestElement.\n\nRegards\nPhilippe", "id": 150070, "time": "2011-10-03T09:53:55Z", "bug_id": 50898, "creation_time": "2011-10-03T09:53:55Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 50898, "text": "(In reply to comment #15)\n> Hello Sebb,\n> Very strange indeed, as strange as the fact that although key is here, getTree\n> does not find its value.\n\nI think that can happen if the key changes whilst in the hash.\n\n> I think we should fix issue related to hashCode and equals in\n> AbstractTestElement.\n\nThat should help, but as has been seen from the patch failure, the behaviour of the JMeter code is quite tricky in this area.", "count": 16, "id": 150072, "time": "2011-10-03T10:31:18Z", "creator": "sebb@apache.org", "creation_time": "2011-10-03T10:31:18Z", "is_private": false}, {"count": 17, "tags": [], "creator": "sebb@apache.org", "is_private": false, "text": "The problem is in the ListedHashTree#replace method.\n\nThis updates the order of elements using the code:\n\norder.set(order.indexOf(currentKey), newKey);\n\nThe problem is that indexOf() uses equals() to scan the LinkedList to find the matching Object. The current implementation of equals for TestElelemts compares contents. So if there are two identical Include Controllers the wrong key may be found. [This problem does not affect the tree itself, because that is a hash tree, and test elements use the identity hashcode.]\n\nI suspect this does not affect the GUI tests because the Test Elements will then have additional properties which relate to the GUI.\n\nThe bug can be fixed by using Object equality for equals; unit tests all still work apart from TestHTTPFileArgs.testRemoving() which assumes that HTTPFileArgs are equal if they have equal contents. That could be fixed separately.\n\nI'm not entirely sure what it means for two test elements to be truly \"equal\".\nAt present, they violate the rule that equal objects must have equal hash codes.\n\nHowever, changing the AbstractTestElement#equals() method is a very big change and may have unexpected consequences (apart from just HTTPFileArgs).\n\nAs a workround for this bug, the IncludeController can be fixed to use Object equals.\nAfter further testing, the fix can hopefully be extended to all test elements.", "id": 159188, "time": "2012-05-21T01:59:57Z", "bug_id": 50898, "creation_time": "2012-05-21T01:59:57Z", "attachment_id": null}, {"count": 18, "tags": [], "text": "Added workround:\n\nURL: http://svn.apache.org/viewvc?rev=1340884&view=rev\nLog:\nBug 50898 - IncludeController : NullPointerException loading script in non-GUI mode if Includers use same element name\n\nModified:\n   jmeter/trunk/build.xml\n   jmeter/trunk/src/components/org/apache/jmeter/control/IncludeController.java\n   jmeter/trunk/xdocs/changes.xml", "is_private": false, "id": 159189, "creator": "sebb@apache.org", "time": "2012-05-21T02:12:21Z", "bug_id": 50898, "creation_time": "2012-05-21T02:12:21Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 50898, "text": "Great you fixed it Sebb .\nI close issue.", "count": 19, "id": 159190, "time": "2012-05-21T05:51:04Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2012-05-21T05:51:04Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 50898, "is_private": false, "count": 20, "id": 159247, "time": "2012-05-22T22:49:41Z", "creator": "sebb@apache.org", "creation_time": "2012-05-22T22:49:41Z", "text": "Reverted IncludeController change.\n\nNow use == rather than equals() when finding the entry in the list.\n\nURL: http://svn.apache.org/viewvc?rev=1341670&view=rev\nLog:\nBug 50898 - IncludeController : NullPointerException loading script in non-GUI mode if Includers use same element name\nApply better fix that applies for all elements, not just IncludeController\n\nModified:\n   jmeter/trunk/src/components/org/apache/jmeter/control/IncludeController.java\n   jmeter/trunk/src/jorphan/org/apache/jorphan/collections/ListedHashTree.java"}]