[{"count": 0, "tags": [], "creator": "andriju@gmail.com", "attachment_id": null, "text": "We have such problem situation and it is very important for us to find a\nvery fast and effective solution:\n\nWe use mod_proxy_balancer with mod_proxy_ajp in httpd-2.2.4.Tomcat (5.5.20) is\nused as the backend. We use stickysessions based on cookies in the balancer\n(CookieName=VotingRoute). Here is a part of httpd configuration taken from our\nconfiguration files\n\n---apache.conf\n<Proxy balancer://tomcat_voting/>\nBalancerMember ajp://xxx.xxx.xxx.135:8009 route=VOTING1_CURRENT loadfactor=1\nBalancerMember ajp://xxx.xxx.xxx.136:8009 route=VOTING2_CURRENT loadfactor=1\nProxySet stickysession=VotingRoute nofailover=Off\n</Proxy>\n\nRewriteRule /servlet/survey.Voting balancer://tomcat_voting%{REQUEST_URI} [P,L]\n---/apache.conf\n\nBelow you can see a sample of the httpd server log (with LogLevel=debug\noption),when the site looks working. As you can see from the log below\nqueries with Cookies received before get to the right tomcat from the\nbalancer\n\n---debug\n[Tue Feb 20 14:09:36 2007] [debug] mod_proxy_balancer.c(41): proxy: BALANCER:\ncanonicalising URL //tomcat_voting/survey/112333/4c39d6cf/\n[Tue Feb 20 14:09:36 2007] [debug] mod_proxy_balancer.c(247): proxy: BALANCER:\nFound value x.VOTING1_CURRENT for stickysession VotingRoute\n[Tue Feb 20 14:09:36 2007] [debug] mod_proxy_balancer.c(257): proxy: BALANCER:\nFound route VOTING1_CURRENT\n[Tue Feb 20 14:09:36 2007] [debug] mod_proxy_balancer.c(488): proxy: BALANCER\n(balancer://tomcat_voting) worker (ajp://xxx.xxx.xxx.135:8009) rewritten to\najp://xxx.xxx.xxx.135:8009/survey/112333/4c39d6cf/\n[Tue Feb 20 14:09:36 2007] [debug] mod_proxy.c(777): Running scheme balancer\nhandler (attempt 0)\n[Tue Feb 20 14:09:36 2007] [debug] mod_proxy_http.c(1652): proxy: HTTP:\ndeclining URL ajp://xxx.xxx.xxx.135:8009/survey/112333/4c39d6cf/\n[Tue Feb 20 14:09:36 2007] [debug] mod_proxy_ajp.c(507): proxy: AJP: serving URL\najp://xxx.xxx.xxx.135:8009/survey/112333/4c39d6cf/\n[Tue Feb 20 14:09:36 2007] [debug] proxy_util.c(1798): proxy: AJP: has acquired\nconnection for (xxx.xxx.xxx.135)\n[Tue Feb 20 14:09:36 2007] [debug] proxy_util.c(1859): proxy: connecting\najp://xxx.xxx.xxx.135:8009/survey/112333/4c39d6cf/ to xxx.xxx.xxx.135:8009\n[Tue Feb 20 14:09:36 2007] [debug] proxy_util.c(1955): proxy: connected\n/survey/112333/4c39d6cf/ to xxx.xxx.xxx.135:8009\n---/debug\n\nBut sometimes we strange things happen. Unexpectedly balancer chooses a\ntomcat that has different 'route' option that found in the Cookies. The query\ngoes to the wrong tomcat and receives another Cookie from it with\nanother 'route' in the Cookie, then the situation repeats, in other words\nthe balancer send the query to a wrong tomcat. And it happens to every next\nquery.Here is an example from the log files of httpd server with sending a query\nto a wrong Tomcat:\n\n---debug\n[Tue Feb 20 11:24:17 2007] [debug] mod_proxy_balancer.c(41): proxy: BALANCER:\ncanonicalising URL //tomcat_voting/servlet/survey.VotingSurvey\n[Tue Feb 20 11:24:17 2007] [debug] mod_proxy_balancer.c(247): proxy: BALANCER:\nFound value x.VOTING2_CURRENT for stickysession VotingRoute\n[Tue Feb 20 11:24:17 2007] [debug] mod_proxy_balancer.c(257): proxy: BALANCER:\nFound route VOTING2_CURRENT\n[Tue Feb 20 11:24:17 2007] [debug] mod_proxy_balancer.c(922): proxy: Entering\nbyrequests for BALANCER (balancer://tomcat_voting)\n[Tue Feb 20 11:24:17 2007] [debug] mod_proxy_balancer.c(488): proxy: BALANCER\n(balancer://tomcat_voting) worker (ajp://xxx.xxx.xxx.135:8009) rewritten to\najp://xxx.xxx.xxx.135:8009/servlet/survey.VotingSurvey?i_n_f=survey112333_pg0_totpg2_rid9392985_lqid2020313%23errQue\n[Tue Feb 20 11:24:17 2007] [debug] mod_proxy.c(777): Running scheme balancer\nhandler (attempt 0)\n[Tue Feb 20 11:24:17 2007] [debug] mod_proxy_http.c(1652): proxy: HTTP:\ndeclining URL\najp://xxx.xxx.xxx.135:8009/servlet/survey.VotingSurvey?i_n_f=survey112333_pg0_totpg2_rid9392985_lqid2020313%23errQue\n[Tue Feb 20 11:24:17 2007] [debug] mod_proxy_ajp.c(507): proxy: AJP: serving URL\najp://xxx.xxx.xxx.135:8009/servlet/survey.VotingSurvey?i_n_f=survey112333_pg0_totpg2_rid9392985_lqid2020313%23errQue\n[Tue Feb 20 11:24:17 2007] [debug] proxy_util.c(1798): proxy: AJP: has acquired\nconnection for (xxx.xxx.xxx.135)\n[Tue Feb 20 11:24:17 2007] [debug] proxy_util.c(1859): proxy: connecting\najp://xxx.xxx.xxx.135:8009/servlet/survey.VotingSurvey?i_n_f=survey112333_pg0_totpg2_rid9392985_lqid2020313%23errQue\nto xxx.xxx.xxx.135:8009\n[Tue Feb 20 11:24:17 2007] [debug] proxy_util.c(1955): proxy: connected\n/servlet/survey.VotingSurvey?i_n_f=survey112333_pg0_totpg2_rid9392985_lqid2020313%23errQue\nto xxx.xxx.xxx.135:8009\n---/debug\n\nWe reloaded tomcats one by one but it did not help to make the balancer work\ncorrectly. Execution of 'apachectl graceful' command does not help either. Only\nif we reload the httpd server balancer works ok (stickysessions work). It is\nvery hard to reproduce the problem but from time to time balancer\nworks as described above and we have to reload the httpd server. httpd\nserver reloading is a bad solution for us. \n\nPlease recommend what we can do to solve this problem.\n\nThanks.", "id": 99690, "time": "2007-02-22T09:01:45Z", "bug_id": 41680, "creation_time": "2007-02-22T09:01:45Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 41680, "attachment_id": null, "id": 99703, "time": "2007-02-22T14:10:46Z", "creator": "rpluem@apache.org", "creation_time": "2007-02-22T14:10:46Z", "is_private": false, "text": "From what I can see here is that the balancer switches to another Tomcat because\nthe Tomcat with the correct route set is not available. As you have set\nnofailover=Off this works as designed. If you would have set nofailover=On there\nshould be the following error message in the log in such situations:\n\nAll workers are in error state for route.\n\nPlease have a look in your error log for lines that contain the words 'proxy'\nand 'failed'.\nTo check the status of single workers please enable the balancer manager\n(http://httpd.apache.org/docs/2.2/en/mod/mod_proxy_balancer.html#enable) and\nhave a look on its status page."}, {"attachment_id": null, "tags": [], "bug_id": 41680, "text": "Thank you. Balancer-manager turned out to be a very helpful tool for analyzing\nof failures.\n\nWe seem to have found the reasons why we had issues with stickysessions. At\nleast we believe that these were the reasons. \n\nIf there are a few back-ends in the balancer description, then if a back-end is\neither deleted or added from/to the beginning of the list, then Route values of\nthe following back-ends are changed.\n\nAs an example here is a part of our test configuration: \n...\n<Proxy balancer://app/>\nBalancerMember ajp://app1:8009 route=T1 loadfactor=1\nBalancerMember ajp://app2:8009 route=T2 loadfactor=1\nBalancerMember ajp://app3:8009 route=T3 loadfactor=1\nBalancerMember ajp://app4:8009 route=T4 loadfactor=1\nProxySet stickysession=SessionRoute nofailover=Off\n</Proxy>\n...\n\nAfter rebooting the httpd server we can see the following on the\nbalancer-manager page \n\n...\nWorker URL\tRoute\tRouteRedir\tFactor\tSet\tStatus\tElected\tTo\tFrom\najp://app1:8009\tT1\t\t1\t0\tOk\t325\t1.3K\t1.3M\najp://app2:8009\tT2\t\t1\t0\tOk\t271\t587 \t1.2M\najp://app3:8009\tT3\t\t1\t0\tOk\t150\t19K\t1.2M\najp://app4:8009\tT4\t\t1\t0\tOk\t137\t38K\t1.3M\n...\n\nHowever, balancer works fine. But if a 'ajp://app2:8009'  back-end is deleted\nand then 'apachectl graceful' command is run, the following will be seen on the\nbalancer-manager page:\n\n...\nWorker URL\tRoute\tRouteRedir\tFactor\tSet\tStatus\tElected\tTo\tFrom\najp://app1:8009\tT1\t\t1\t0\tOk\t325\t1.3K\t1.3M\najp://app3:8009\tT2\t\t1\t0\tOk\t271\t587 \t1.2M\najp://app4:8009\tT3\t\t1\t0\tOk\t150\t19K\t1.2M\n...\n\nRoutes 'T2' &#1080; 'T3 correspond to \u2018app3\u2019 and \u2018app4\u2019 back-ends '. As a result\nStickySessions work non-properly. Adding back-ends to the list also results in\nbad referencing for the \u2018Route\u2019 options even though they are defined by the\nconfiguration.\n \nAlso, we noticed that deleting or adding back-ends affects properties of\nback-ends for other balancers as well, even back-ends for other VirtualHost\nsections.\n\nOf course after changing balancers descriptions we can reboot the httpd server\nor correct Route options with the help of balancer-manager. But the first\napproach is not fine for us as we use the server 24x7, and the latter is not\nvery good for us either as there are many balancers in the server\u2019s configuration.\n", "count": 2, "id": 104448, "time": "2007-06-15T11:54:17Z", "creator": "andriju@gmail.com", "creation_time": "2007-06-15T11:54:17Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 41680, "is_private": false, "id": 104463, "creation_time": "2007-06-16T08:56:14Z", "time": "2007-06-16T08:56:14Z", "creator": "rpluem@apache.org", "text": "You describe the really nasty effects of the root cause for PR42621. Please see\nmy comment there.\n\n*** This bug has been marked as a duplicate of 42621 ***", "attachment_id": null}]