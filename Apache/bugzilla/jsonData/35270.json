[{"count": 0, "tags": [], "text": "Tomcats implementation of RequestDispatcher forward not handling a \nServletRequestWrapper correctly when updating forward request params.\nSeems to modify the value of the javax.servlet.forward.request_uri\nrequest attribute incorrectly, according to servlet spec SRV.8.4.2.\n\nHere are some specifics, at least with version 5.0.28.\n\nStepping through the Tomcat source in the debugger, it\nappears that the request's requestURI field gets stomped\non in the forward method of the RequestDispatcher\n(ApplicationDispatcher.doForward()). I'm not sure Tomcat \nis handling a ServletRequestWrapper correctly.\n\nI gather the servlet spec says that users may wrap the\nrequest/response objects with their own implementation.\n\nTomcat's ApplicationDispatcher gets the request from\nthe outer request (the ServletRequestWrapper), trying to\nkeep track of the previous wrapper and current wrapper\n(or request) as it loops through to get the real request.\nWith a single wrapper, the value of \"previous\" is the\nsame as the original outer request. Then Tomcat calls...\n\n((ServletRequestWrapper) previous).setRequest(wrapper);\n\nwhich is the same as calling setRequest(wrapper) on the\nincoming request. Tomcat does not get and save the value\nof the original request URI. It calls setRequestURI(path)\non the wrapper, effectively changing the request URI of the\noriginal incoming request to the path of the forward.\n\nThen Tomcat sets the javax.servlet.forward.request_uri\nattribute by calling getRequestURI() from the original\nrequest... but that just got modified. Implying the\njavax.servlet.forward.request_uri attribute is going to\nget the value of the path for the forward.\n\nYou can test this on Tomcat by using a couple JSP to. Use\na HttpServletRequestWrapper in one JSP for the forward.\n\nFirst create \"result.jsp\" to display the desired request attribute...\n\n<%@ page language=\"java\" contentType=\"text/html;charset=UTF-8\"%>\n<html>\n    <head>\n        <title>RequestDispatcher Test</title>\n    </head>\n    <body>\n        <h1>Forward Request URI</h1>\n        javax.servlet.forward.request_uri =\n        <%= request.getAttribute(\"javax.servlet.forward.request_uri\") %>\n    </body>\n</html>\n\nCreate a JSP to forward without using a wrapper, \"forward.jsp\"...\n\n<%\n    javax.servlet.RequestDispatcher rd =\n        request.getRequestDispatcher(\"result.jsp\");\n    rd.forward(request, response);\n%>\n\nand a second forward using HttpServletRequestWrapper, \"wrapperforward.jsp\"...\n\n<%\n    HttpServletRequestWrapper wrapper = new HttpServletRequestWrapper(request);\n    javax.servlet.RequestDispatcher rd =\n        wrapper.getRequestDispatcher(\"result.jsp\");\n    rd.forward(wrapper, response);\n%>\n\nWhen you hit forward.jsp, the result page displays \"/some-context/forward.jsp\"\nfor the javax.servlet.forward.request_uri request attribute.\nHowever, hit wrapperforward.jsp and the result page displays\n\"/some-context/result.jsp\". From looking at the spec, I'd expect this \nshould be \"/some-context/wrapperforward.jsp\".", "attachment_id": null, "bug_id": 35270, "id": 76166, "time": "2005-06-08T17:34:20Z", "creator": "carlin.rogers@gmail.com", "creation_time": "2005-06-08T17:34:20Z", "is_private": false}, {"count": 1, "attachment_id": null, "creator": "brian.dehamer@hp.com", "is_private": false, "id": 76168, "time": "2005-06-08T17:44:07Z", "bug_id": 35270, "creation_time": "2005-06-08T17:44:07Z", "tags": [], "text": "I was able to reproduce this same bug on Tomcat 5.5.9 as well.  The \njavax.servlet.forward.request_uri attribute is definitely NOT being \nset correctly when forwarding with a wrapped request"}, {"count": 2, "attachment_id": null, "creator": "brian.dehamer@hp.com", "is_private": false, "id": 76169, "time": "2005-06-08T17:54:42Z", "bug_id": 35270, "creation_time": "2005-06-08T17:54:42Z", "tags": [], "text": "I'm guessing that the root cause is the same, but it should also be noted that \nthe javax.servlet.forward.servlet_path attribute is not being set correctly \nunder these conditions either."}, {"count": 3, "tags": [], "creator": "william.barker@wilshire.com", "attachment_id": null, "id": 76192, "time": "2005-06-09T07:54:23Z", "bug_id": 35270, "creation_time": "2005-06-09T07:54:23Z", "is_private": false, "text": "This is now fixed in the CVS head, and will appear in 5.5.10.\n\nIt currently seems unlikely that there will be another release on the 5.0.x \nline, so the 5.5.x line is all that there is."}, {"count": 4, "tags": [], "creator": "brian.dehamer@hp.com", "attachment_id": null, "id": 77020, "time": "2005-07-06T00:36:01Z", "bug_id": 35270, "creation_time": "2005-07-06T00:36:01Z", "is_private": false, "text": "It looks like there is a 5.0.30 Tomcat version in the works, will this fix be \nincluded in that version as well?"}, {"count": 5, "tags": [], "bug_id": 35270, "attachment_id": null, "id": 77881, "time": "2005-07-31T20:22:40Z", "creator": "topper@tlk.com.tw", "creation_time": "2005-07-31T20:22:40Z", "is_private": false, "text": "Forgive my poor English, it is not my native language.\nI found following bugs since 5.5.x, may be early.\n5.5.9, 5.5.10 have same bugs, too.\n\norg.apache.catalina.core.ApplicationDispatcher.doInclude\n  //HTTP named dispatcher include\n  //HTTP path based include\n  invoke(outerRequest, outerResponse); // bug here\n  --> invoke(wrequest, wresponse); // crect one\n\norg.apache.catalina.core.ApplicationDispatcher.processRequest\n  //HTTP named dispatcher forward\n  //HTTP path based forward\n  invoke(outerRequest, response); // bug here\n  --> invoke(wrequest, response); // crect\n\n\n1) If you have n HttpServletRequestWrapper, then\nOriginal HttpServletRequest\nDispatcher's HttpServletRequestWrapper <-- wrequest <-- suppose to invoke this one\nYour HttpServletRequestWrapper #1\nYour HttpServletRequestWrapper #2\n...\nYour HttpServletRequestWrapper #n <-- outerRequest\n\n2) If no HttpServletRequestWrapper, then\nOriginal HttpServletRequest\nDispatcher's HttpServletRequestWrapper <-- wrequest==outerRequest <-- it works\n\n\n\nTopper Lu\nemail: topper@tlk.com.tw\n"}, {"count": 6, "tags": [], "bug_id": 35270, "attachment_id": null, "text": "Ehhh, ok, I see the light now ;)\n\nForgive me for not being friendly, it is not my native behavior.\nPlease do not reopen the report.", "id": 77882, "time": "2005-07-31T22:40:24Z", "creator": "remm@apache.org", "creation_time": "2005-07-31T22:40:24Z", "is_private": false}]