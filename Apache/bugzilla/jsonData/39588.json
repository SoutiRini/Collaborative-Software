[{"count": 0, "tags": [], "bug_id": 39588, "attachment_id": null, "id": 89149, "time": "2006-05-15T23:33:39Z", "creator": "rdenison@gci.com", "creation_time": "2006-05-15T23:33:39Z", "is_private": false, "text": "The software is version 2.2.2 (prefork) built with GCC 3.4.2, compilation\ncommands and loaded modules are listed below.  We're using mod_rewrite,\nmod_proxy, and mod_proxy_balancer to distribute requests for a website between 2\nZope instances for local content, and a third-party content provider.\n\nThe problem occurs intermittently, where requests that should be proxied\nto a Zope instance running locally on the server are being submitted to\nthe third party content provider, like this configuration snippet:\n\n    RewriteRule ^/(yyyyyyyyy.*)$ http://content.provider.net/$1 [P,L]\n    RewriteRule ^/(zzzzzzzzz.*)$ http://content.provider.net/$1 [P,L]\n    RewriteRule ^/static(.*)$ /static$1 [L]\n    RewriteRule ^/(.*)$\nbalancer://zopecluster/VirtualHostBase/http/websites.domain.tld:80/www_site/VirtualHostRoot/$1\n[P,L]\n\n    <Proxy balancer://zopecluster>\n        BalancerMember http://localhost:9080\n        BalancerMember http://localhost:9081\n        #BalancerMember http://localhost:9082\n        #BalancerMember http://localhost:9083\n    </Proxy>\n\nWe upped the logging on the servers and extracted the following:\n\naccess_log:\n\nwebsite.domain.tld - - [12/May/2006:17:23:03 -0800] \"GET\n/outages_and_maintenance?[object%20Object] HTTP/1.1\" 404 346\n\nerror_log:\n\n[Fri May 12 17:23:03 2006] [debug] mod_proxy_balancer.c(41): proxy:\nBALANCER: canonicalising URL\n//zopecluster/VirtualHostBase/http/website.domain.tld:80/www_site/VirtualHostRoot/outages_and_maintenance\n[Fri May 12 17:23:03 2006] [debug] mod_proxy_balancer.c(803): proxy:\nEntering byrequests for BALANCER (balancer://zopecluster)\n[Fri May 12 17:23:03 2006] [debug] mod_proxy_balancer.c(396): proxy:\nBALANCER (balancer://zopecluster) worker (http://localhost:9081)\nrewritten to\nhttp://localhost:9081/VirtualHostBase/http/website.domain.tld:80/www_site/VirtualHostRoot/outages_and_maintenance?[object%20Object]\n[Fri May 12 17:23:03 2006] [debug] mod_proxy.c(736): Running scheme\nbalancer handler (attempt 0)\n[Fri May 12 17:23:03 2006] [debug] mod_proxy_http.c(1661): proxy: HTTP:\nserving URL\nhttp://localhost:9081/VirtualHostBase/http/website.domain.tld:80/www_site/VirtualHostRoot/outages_and_maintenance?[object%20Object]\n\n>>>\n[Fri May 12 17:23:03 2006] [debug] proxy_util.c(1811): proxy: connecting\nhttp://localhost:9081/VirtualHostBase/http/website.domain.tld:80/www_site/VirtualHostRoot/outages_and_maintenance?[object%20Object]\nto localhost:9081\n[Fri May 12 17:23:03 2006] [debug] proxy_util.c(1911): proxy: connected\n/VirtualHostBase/http/website.domain.tld:80/www_site/VirtualHostRoot/outages_and_maintenance?[object%20Object]\nto content.provider.net:80\n<<<<\n\n[Fri May 12 17:23:03 2006] [debug] proxy_util.c(2005): proxy: HTTP: fam\n2 socket created to connect to localhost\n[Fri May 12 17:23:03 2006] [debug] proxy_util.c(2101): proxy: HTTP:\nconnection complete to 64.8.70.102:80 (content.provider.net)\n[Fri May 12 17:23:03 2006] [debug] mod_proxy_http.c(1443): proxy: start\nbody send\n[Fri May 12 17:23:03 2006] [debug] mod_headers.c(612): headers:\nap_headers_output_filter()\n[Fri May 12 17:23:03 2006] [debug] mod_proxy_http.c(1530): proxy: end\nbody send\n[Fri May 12 17:23:03 2006] [debug] proxy_util.c(1769): proxy: HTTP: has\nreleased connection for (*)\n\nThe 404 return is coming from the third-party servers - this has been\nverified with packet traces running for incoming traffic and outgoing.\n\nThis behavior appears to be similar to PR 39253 - we upgraded to 2.2.2\nin an attempt to correct this behavior noting that this bug had been\nfixed.  My appologies if I should have re-opened that bug vs. opening a new\nreport - this is my first, please be gentle!\n\nThanks again for your time!\n\nRay D.\n\nCompiled in modules:\n  core.c\n  prefork.c\n  http_core.c\n  mod_so.c\n\nLoaded Modules:\n core_module (static)\n mpm_prefork_module (static)\n http_module (static)\n so_module (static)\n authn_file_module (shared)\n authn_dbm_module (shared)\n authn_anon_module (shared)\n authn_dbd_module (shared)\n authn_default_module (shared)\n authz_host_module (shared)\n authz_groupfile_module (shared)\n authz_user_module (shared)\n authz_dbm_module (shared)\n authz_owner_module (shared)\n authz_default_module (shared)\n auth_basic_module (shared)\n auth_digest_module (shared)\n dbd_module (shared)\n dumpio_module (shared)\n ext_filter_module (shared)\n include_module (shared)\n filter_module (shared)\n deflate_module (shared)\n log_config_module (shared)\n log_forensic_module (shared)\n logio_module (shared)\n env_module (shared)\n mime_magic_module (shared)\n cern_meta_module (shared)\n expires_module (shared)\n headers_module (shared)\n ident_module (shared)\n usertrack_module (shared)\n unique_id_module (shared)\n setenvif_module (shared)\n version_module (shared)\n ssl_module (shared)\n mime_module (shared)\n dav_module (shared)\n status_module (shared)\n autoindex_module (shared)\n asis_module (shared)\n info_module (shared)\n cgi_module (shared)\n dav_fs_module (shared)\n vhost_alias_module (shared)\n negotiation_module (shared)\n dir_module (shared)\n imagemap_module (shared)\n actions_module (shared)\n speling_module (shared)\n userdir_module (shared)\n alias_module (shared)\n rewrite_module (shared)\n proxy_module (shared)\n proxy_connect_module (shared)\n proxy_http_module (shared)\n proxy_balancer_module (shared)\nSyntax OK\n\n./configure --prefix=/usr/local/apache-2.2.2 --enable-mods-shared=all\n- --enable-deflate --enable-ssl=shared --enable-ssl --enable-proxy\n- --enable-proxy-http --enable-proxy-balancer --with-ssl=/usr/local/ssl"}, {"count": 1, "tags": [], "text": "Your logging output is from httpd 2.2.0 and not from httpd 2.2.2. In httpd 2.2.2\nthe line numbers for proxy_util.c are 1858 instead of 1811 and 1951 instead of\n1911. Please provide logging output from httpd 2.2.2.\n\n", "is_private": false, "bug_id": 39588, "id": 89160, "time": "2006-05-16T10:40:40Z", "creator": "rpluem@apache.org", "creation_time": "2006-05-16T10:40:40Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 39588, "is_private": false, "text": "\nHello -\n\nFirst off, thanks for all your hard work - we appreciate the rapid response and\nall your efforts.  Thanks for your patience, as well.\n\nI believe I've validated that I'm running the 2.2.2 release:\n\nProcess table shows:\n\n  daemon 10987  3887  0 11:41:18 ?        0:02 /usr/local/apache-2.2.2/bin/httpd\n-k start\n\nVersion information from the installed binary:\n\n  /usr/local/apache-2.2.2/bin/httpd -v\n  Server version: Apache/2.2.2\n  Server built:   May 10 2006 16:31:25\n\nWent to the build directory, pulled an md5 checksum from the built binary:\n\n  ~/httpd-2.2.2> /usr/local/ssl/bin/openssl md5 .libs/httpd\n  MD5(.libs/httpd)= 443968cbf377336dded319cee8f82f23\n\nThe md5 checksum matches the installed / running binary:\n\n  /usr/local/ssl/bin/openssl md5 /usr/local/apache-2.2.2/bin/httpd\n  MD5(/usr/local/apache-2.2.2/bin/httpd)= 443968cbf377336dded319cee8f82f23\n\nThe source package tarball md5 checksum matches\nhttp://www.apache.org/dist/httpd/httpd-2.2.2.tar.gz.md5:\n\n  /usr/local/ssl/bin/openssl md5 /users/rdenison/httpd-2.2.2.tar.gz\n  MD5(/users/rdenison/httpd-2.2.2.tar.gz)= a0d9f7f6f70110a5965340eb7f3a3e66\n\n  a0d9f7f6f70110a5965340eb7f3a3e66  httpd-2.2.2.tar.gz\n\nAll the above are from a clean build of the httpd-2.2.2 package above; I didn't\nuse a patch to avoid stupid mistakes on my part.  Here's the code snippets\ncorresponding to the debug logs from the tarball I'm using:\n\n~/httpd-2.2.2/modules/proxy> tail +1660 mod_proxy_http.c | head -10\n            proxy_function = \"FTP\";\n    }\n    ap_log_error(APLOG_MARK, APLOG_DEBUG, 0, r->server,\n             \"proxy: HTTP: serving URL %s\", url);\n\n\n    /* create space for state information */\n    if ((status = ap_proxy_acquire_connection(proxy_function, &backend,\n                                              worker, r->server)) != OK)\n        goto cleanup;\n\n~/httpd-2.2.2/modules/proxy> tail +1810 proxy_util.c | head -10\n}\n\nPROXY_DECLARE(int) ap_proxy_release_connection(const char *proxy_function,\n                                               proxy_conn_rec *conn,\n                                               server_rec *s)\n{\n    ap_log_error(APLOG_MARK, APLOG_DEBUG, 0, s,\n                 \"proxy: %s: has released connection for (%s)\",\n                 proxy_function, conn->worker->hostname);\n    /* If there is a connection kill it's cleanup */\n\n~/httpd-2.2.2/modules/proxy> tail +1910 proxy_util.c | head -10\n                         \"proxy: lock\");\n            return HTTP_INTERNAL_SERVER_ERROR;\n        }\n\n        /*\n         * Worker can have the single constant backend adress.\n         * The single DNS lookup is used once per worker.\n         * If dynamic change is needed then set the addr to NULL\n         * inside dynamic config to force the lookup.\n         */\n\nI had upped the log level to debug in the running configuration and reproduced\nthe problem, here's the pertinent stuff:\n\n  [Tue May 16 11:50:32 2006] [debug] mod_proxy_balancer.c(41): proxy: BALANCER:\ncanonicalising URL\n//zopecluster/VirtualHostBase/http/website.domain.tld:80/www_site/VirtualHostRoot/outages_and_maintenance\n  [Tue May 16 11:50:32 2006] [debug] mod_proxy_balancer.c(803): proxy: Entering\nbyrequests for BALANCER (balancer://zopecluster)\n  [Tue May 16 11:50:32 2006] [debug] mod_proxy_balancer.c(396): proxy: BALANCER\n(balancer://zopecluster) worker (http://localhost:9080) rewritten to\nhttp://localhost:9080/VirtualHostBase/http/website.domain.tld:80/www_site/VirtualHostRoot/outages_and_maintenance?[object%20Object]\n  [Tue May 16 11:50:32 2006] [debug] mod_proxy.c(736): Running scheme balancer\nhandler (attempt 0)\n  [Tue May 16 11:50:32 2006] [debug] mod_proxy_http.c(1661): proxy: HTTP:\nserving URL\nhttp://localhost:9080/VirtualHostBase/http/website.domain.tld:80/www_site/VirtualHostRoot/outages_and_maintenance?[object%20Object]\n  [Tue May 16 11:50:32 2006] [debug] proxy_util.c(1811): proxy: connecting\nhttp://localhost:9080/VirtualHostBase/http/website.domain.tld:80/www_site/VirtualHostRoot/outages_and_maintenance?[object%20Object]\nto localhost:9080\n  [Tue May 16 11:50:32 2006] [debug] proxy_util.c(1911): proxy: connected\n/VirtualHostBase/http/website.domain.tld:80/www_site/VirtualHostRoot/outages_and_maintenance?[object%20Object]\nto content.provider.net:80\n\nPlease let me know if there's anything else I can provide to assist you in\ntracking this one down, and thanks again!\n\nRay D.\n", "id": 89172, "time": "2006-05-16T20:46:30Z", "creator": "rdenison@gci.com", "creation_time": "2006-05-16T20:46:30Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "id": 89174, "time": "2006-05-16T21:20:40Z", "bug_id": 39588, "creation_time": "2006-05-16T21:20:40Z", "is_private": false, "text": "(In reply to comment #2)\n> \n> ~/httpd-2.2.2/modules/proxy> tail +1810 proxy_util.c | head -10\n> }\n> \n> PROXY_DECLARE(int) ap_proxy_release_connection(const char *proxy_function,\n>                                                proxy_conn_rec *conn,\n>                                                server_rec *s)\n> {\n>     ap_log_error(APLOG_MARK, APLOG_DEBUG, 0, s,\n>                  \"proxy: %s: has released connection for (%s)\",\n>                  proxy_function, conn->worker->hostname);\n>     /* If there is a connection kill it's cleanup */\n> \n> ~/httpd-2.2.2/modules/proxy> tail +1910 proxy_util.c | head -10\n>                          \"proxy: lock\");\n>             return HTTP_INTERNAL_SERVER_ERROR;\n>         }\n> \n\nAs you can see the code and your output in the logfile do not match. I believe\nyou that you have downloaded and compiled httpd 2.2.2, but the logfiles have\nbeen created by httpd 2.2.0 (at least mod_proxy is from 2.2.0). Please execute\nthe following command from the directory where the apachectl script can be found\nthat you use to start httpd:\n\n./httpd -V"}, {"count": 4, "tags": [], "bug_id": 39588, "attachment_id": null, "id": 89176, "time": "2006-05-16T22:00:09Z", "creator": "rdenison@gci.com", "creation_time": "2006-05-16T22:00:09Z", "is_private": false, "text": "Hello again!\n\nHere's the output you requested:\n\n/usr/local/apache-2.2.2/bin> ./httpd -V\nServer version: Apache/2.2.2\nServer built:   May 10 2006 16:31:25\nServer's Module Magic Number: 20051115:2\nServer loaded:  APR 1.2.7, APR-Util 1.2.7\nCompiled using: APR 1.2.7, APR-Util 1.2.7\nArchitecture:   32-bit\nServer MPM:     Prefork\n  threaded:     no\n    forked:     yes (variable process count)\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_FCNTL_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"/usr/local/apache-2.2.2\"\n -D SUEXEC_BIN=\"/usr/local/apache-2.2.2/bin/suexec\"\n -D DEFAULT_PIDLOG=\"logs/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_LOCKFILE=\"logs/accept.lock\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"\n\nI'll gladly concede the possibility I'm pulling a stupid (wouldn't be the first\ntime, won't be the last), but I just don't see it.\n\nAnyway, still more thanks!  Let me know what else I can provide!"}, {"count": 5, "tags": [], "bug_id": 39588, "is_private": false, "text": "\nRuediger -\n\nIn a fit of desperation / inspiration, I went back and double checked the\nmodules MD5 checksums for the built and installed versions, and it looks like\nthey match (below).\n\nI do see what you're saying about the reported line numbers not matching with\nthe code, but I'm not sure what I could have done to cause the problem.  If you\nbelieve it will help I will gladly blow away the existing install and rebuild\nfrom scratch though this couldn't be done till this evening.\n\nhttpd-2.2.2/modules/proxy/.libs> /usr/local/ssl/bin/openssl md5 *so\nMD5(mod_proxy.so)= aff7f902f7a6dce19868c84aa7b2381b\nMD5(mod_proxy_ajp.so)= 8d1cc24d411ef7fd10ebdcea6fd13622\nMD5(mod_proxy_balancer.so)= 880c83c69dc62028b34248573ada1cdd\nMD5(mod_proxy_connect.so)= 880e7a95f61620fc5445c119ce5511f9\nMD5(mod_proxy_ftp.so)= 93e5d455866065172df32683501c191d\nMD5(mod_proxy_http.so)= 335a5f8d30154e720f4dbbba2ad94be6\n\nfor I in *.so; do /usr/local/ssl/bin/openssl md5\n/usr/local/apache-2.2.2/modules/$I; done\nMD5(/usr/local/apache-2.2.2/modules/mod_proxy.so)= aff7f902f7a6dce19868c84aa7b2381b\nMD5(/usr/local/apache-2.2.2/modules/mod_proxy_ajp.so)=\n8d1cc24d411ef7fd10ebdcea6fd13622\nMD5(/usr/local/apache-2.2.2/modules/mod_proxy_balancer.so)=\n880c83c69dc62028b34248573ada1cdd\nMD5(/usr/local/apache-2.2.2/modules/mod_proxy_connect.so)=\n880e7a95f61620fc5445c119ce5511f9\nMD5(/usr/local/apache-2.2.2/modules/mod_proxy_ftp.so)=\n93e5d455866065172df32683501c191d\nMD5(/usr/local/apache-2.2.2/modules/mod_proxy_http.so)=\n335a5f8d30154e720f4dbbba2ad94be6\n\nThanks again!", "id": 89178, "time": "2006-05-16T22:27:32Z", "creator": "rdenison@gci.com", "creation_time": "2006-05-16T22:27:32Z", "attachment_id": null}, {"count": 6, "tags": [], "text": "(In reply to comment #5)\n\n> \n> I do see what you're saying about the reported line numbers not matching with\n> the code, but I'm not sure what I could have done to cause the problem.  If you\n> believe it will help I will gladly blow away the existing install and rebuild\n> from scratch though this couldn't be done till this evening.\n\nMaybe an idea. Or just make sure that you are really running httpd 2.2.2 and\nthat the log entries generated are generated by httpd 2.2.2. In order to do this\nset \n\nServerTokens Full\n\nin your configuration and watch the headers of the responses with something like\nlivehttpheaders for Firefox (http://livehttpheader.mozdev.org/).\n\n\n", "is_private": false, "bug_id": 39588, "id": 89184, "time": "2006-05-16T23:20:13Z", "creator": "rpluem@apache.org", "creation_time": "2006-05-16T23:20:13Z", "attachment_id": null}, {"count": 7, "tags": [], "creator": "rdenison@gci.com", "attachment_id": null, "id": 89224, "time": "2006-05-17T19:48:44Z", "bug_id": 39588, "creation_time": "2006-05-17T19:48:44Z", "is_private": false, "text": "Stupidity on the part of the user has been corrected, and the problem resolved.\n\nAs Ruediger noted, the errors were indeed coming from the 2.2.0 module - the\n2.2.2 core was running, but I used our existing 2.2.0 configuration and failed\nto taken into account the path changes needed for the loaded modules.\n\nMany thanks for all your help, and a kick-a-- product.  Your work sets an\nexcellent example for us all."}]