[{"count": 0, "tags": [], "bug_id": 37237, "attachment_id": null, "is_private": false, "id": 81675, "time": "2005-10-25T02:27:31Z", "creator": "edward.kuns@aspect.com", "creation_time": "2005-10-25T02:27:31Z", "text": "A project I work on uses an indexed jar file.  This builds perfectly under Ant\n1.6.2 and earlier, but under 1.6.3 and later it breaks with the error message:\n\nZ:\\uwa\\Build\\build.jars.xml:163: java.lang.RuntimeException: data starting at 0\nis in unknown format\n\nThat error message comes from ExtraFieldUtils.parse(byte[]).  The line\ncomplained about is the \"jar\" task.  To simplify, part of this ant target is:\n\n      <delete file=\"${agent.lib}/agent.jar\" failonerror=\"false\"/>\n      <delete file=\"${agent.lib}/agent.jar\"/>\n      <jar jarfile=\"${agent.lib}/agent.jar\" manifest=\"META-INF/manifest.mf\"\nindex=\"true\">\n        <fileset dir=\"${classes}/\">\n          <include name=\"${stemDir}/agent/**/*.class\"/>\n          <include name=\"${stemDir}/agent/i18n/*.properties\"/>\n        </fileset>\n        <!-- Dependencies outside the agent source tree -->\n        <fileset dir=\"${srcdir}\">\n          <include name=\"META-INF/services/org.apache.commons.logging.LogFactory\"/>\n        </fileset>\n        <indexjars>\n          <fileset file=\"${agent.lib}/client.jar\"/>\n          <fileset dir=\"${libdir}/\">\n            <include name=\"commons-codec.jar\"/>\n            <include name=\"commons-httpclient.jar\"/>\n            <include name=\"commons-logging.jar\"/>\n            <include name=\"jakarta-oro.jar\"/>\n            <include name=\"log4j.jar\"/>\n          </fileset>\n        </indexjars>\n      </jar>\n\nLooking at the source for 1.6.5 (since it is the most recent release) I find if\nI comment out two lines added to org.apache.tools.ant.taskdefs.Jar in 1.6.3,\nthen I do not have this breakage.  I comment out the lines:\n\n        zipDir(null, zOut, \"META-INF/\", ZipFileSet.DEFAULT_DIR_MODE,\n               JAR_MARKER);\n\nObviously, this is not the correct fix, but I am hoping that someone who is\nfamiliar with this code will immediately see what is causing this problem with\njar indexing.  The JAR_MARKER's ID is 0xCAFE.  If in\nExtraFieldUtils.parse(byte[]) I dump the byte array coming in, the byte array is\n zero length for absolutely every invocation except one -- the META_INF\ndirectory.  For this directory, the data array contains the values 0, 4, -2, -54\n(or 4, 0, -2, -54 ... I don't remember the order of the first two, just the\nvalues).  If I translate the last two into hex, I see 0xFE, 0xCA, aka 0xCAFE,\nthe ID from the JarMarker class.\n\nIf I remove the indexjars element from the jar task, but leave the index=\"true\"\nattribute, I do not get this error.  This error occurs only when the indexjars\nelement is present for ANT 1.6.3 and later.  I have not tested the current SVN\nversion.  I've searched the bug database for anything like this and have not\nfound anything."}, {"count": 1, "tags": [], "bug_id": 37237, "attachment_id": null, "is_private": false, "id": 82069, "time": "2005-11-02T21:48:16Z", "creator": "bodewig@apache.org", "creation_time": "2005-11-02T21:48:16Z", "text": "could you please append the full stack trace (running ant -v)?"}, {"count": 2, "attachment_id": null, "bug_id": 37237, "text": "Here is the full stack dump ... this is with ANT 1.6.5.\n\nBUILD FAILED\nZ:\\uwa\\Build\\build.jars.xml:153: The following error occurred while executing\nthis line:\nZ:\\uwa\\Build\\build.macros.xml:57: java.lang.RuntimeException: data starting at 0\nis in unknown format\n        at\norg.apache.tools.ant.ProjectHelper.addLocationToBuildException(ProjectHelper.java:539)\n        at\norg.apache.tools.ant.taskdefs.MacroInstance.execute(MacroInstance.java:380)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:275)\n        at org.apache.tools.ant.Task.perform(Task.java:364)\n        at org.apache.tools.ant.Target.execute(Target.java:341)\n        at org.apache.tools.ant.Target.performTasks(Target.java:369)\n        at org.apache.tools.ant.Project.executeSortedTargets(Project.java:1216)\n        at org.apache.tools.ant.Project.executeTarget(Project.java:1185)\n        at\norg.apache.tools.ant.helper.DefaultExecutor.executeTargets(DefaultExecutor.java:40)\n        at org.apache.tools.ant.Project.executeTargets(Project.java:1068)\n        at org.apache.tools.ant.Main.runBuild(Main.java:668)\n        at org.apache.tools.ant.Main.startAnt(Main.java:187)\n        at org.apache.tools.ant.launch.Launcher.run(Launcher.java:246)\n        at org.apache.tools.ant.launch.Launcher.main(Launcher.java:67)\nCaused by: Z:\\uwa\\Build\\build.macros.xml:57: java.lang.RuntimeException: data\nstarting at 0 is in unknown format\n        at org.apache.tools.ant.Task.perform(Task.java:373)\n        at org.apache.tools.ant.taskdefs.Sequential.execute(Sequential.java:64)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:275)\n        at org.apache.tools.ant.Task.perform(Task.java:364)\n        at\norg.apache.tools.ant.taskdefs.MacroInstance.execute(MacroInstance.java:378)\n        ... 12 more\nCaused by: java.lang.RuntimeException: data starting at 0 is in unknown format\n        at org.apache.tools.zip.ZipEntry.setExtra(ZipEntry.java:299)\n        at org.apache.tools.zip.ZipFile.resolveLocalFileHeaderData(ZipFile.java:414)\n        at org.apache.tools.zip.ZipFile.<init>(ZipFile.java:143)\n        at org.apache.tools.zip.ZipFile.<init>(ZipFile.java:126)\n        at org.apache.tools.ant.taskdefs.Jar.grabFilesAndDirs(Jar.java:830)\n        at org.apache.tools.ant.taskdefs.Jar.createIndexList(Jar.java:468)\n        at org.apache.tools.ant.taskdefs.Jar.finalizeZipOutputStream(Jar.java:417)\n        at org.apache.tools.ant.taskdefs.Zip.executeMain(Zip.java:522)\n        at org.apache.tools.ant.taskdefs.Zip.execute(Zip.java:350)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:275)\n        at org.apache.tools.ant.Task.perform(Task.java:364)\n        ... 16 more\n--- Nested Exception ---\nZ:\\uwa\\Build\\build.macros.xml:57: java.lang.RuntimeException: data starting at 0\nis in unknown format\n        at org.apache.tools.ant.Task.perform(Task.java:373)\n        at org.apache.tools.ant.taskdefs.Sequential.execute(Sequential.java:64)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:275)\n        at org.apache.tools.ant.Task.perform(Task.java:364)\n        at\norg.apache.tools.ant.taskdefs.MacroInstance.execute(MacroInstance.java:378)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:275)\n        at org.apache.tools.ant.Task.perform(Task.java:364)\n        at org.apache.tools.ant.Target.execute(Target.java:341)\n        at org.apache.tools.ant.Target.performTasks(Target.java:369)\n        at org.apache.tools.ant.Project.executeSortedTargets(Project.java:1216)\n        at org.apache.tools.ant.Project.executeTarget(Project.java:1185)\n        at\norg.apache.tools.ant.helper.DefaultExecutor.executeTargets(DefaultExecutor.java:40)\n        at org.apache.tools.ant.Project.executeTargets(Project.java:1068)\n        at org.apache.tools.ant.Main.runBuild(Main.java:668)\n        at org.apache.tools.ant.Main.startAnt(Main.java:187)\n        at org.apache.tools.ant.launch.Launcher.run(Launcher.java:246)\n        at org.apache.tools.ant.launch.Launcher.main(Launcher.java:67)\nCaused by: java.lang.RuntimeException: data starting at 0 is in unknown format\n        at org.apache.tools.zip.ZipEntry.setExtra(ZipEntry.java:299)\n        at org.apache.tools.zip.ZipFile.resolveLocalFileHeaderData(ZipFile.java:414)\n        at org.apache.tools.zip.ZipFile.<init>(ZipFile.java:143)\n        at org.apache.tools.zip.ZipFile.<init>(ZipFile.java:126)\n        at org.apache.tools.ant.taskdefs.Jar.grabFilesAndDirs(Jar.java:830)\n        at org.apache.tools.ant.taskdefs.Jar.createIndexList(Jar.java:468)\n        at org.apache.tools.ant.taskdefs.Jar.finalizeZipOutputStream(Jar.java:417)\n        at org.apache.tools.ant.taskdefs.Zip.executeMain(Zip.java:522)\n        at org.apache.tools.ant.taskdefs.Zip.execute(Zip.java:350)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:275)\n        at org.apache.tools.ant.Task.perform(Task.java:364)\n        ... 16 more\n--- Nested Exception ---\njava.lang.RuntimeException: data starting at 0 is in unknown format\n        at org.apache.tools.zip.ZipEntry.setExtra(ZipEntry.java:299)\n        at org.apache.tools.zip.ZipFile.resolveLocalFileHeaderData(ZipFile.java:414)\n        at org.apache.tools.zip.ZipFile.<init>(ZipFile.java:143)\n        at org.apache.tools.zip.ZipFile.<init>(ZipFile.java:126)\n        at org.apache.tools.ant.taskdefs.Jar.grabFilesAndDirs(Jar.java:830)\n        at org.apache.tools.ant.taskdefs.Jar.createIndexList(Jar.java:468)\n        at org.apache.tools.ant.taskdefs.Jar.finalizeZipOutputStream(Jar.java:417)\n        at org.apache.tools.ant.taskdefs.Zip.executeMain(Zip.java:522)\n        at org.apache.tools.ant.taskdefs.Zip.execute(Zip.java:350)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:275)\n        at org.apache.tools.ant.Task.perform(Task.java:364)\n        at org.apache.tools.ant.taskdefs.Sequential.execute(Sequential.java:64)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:275)\n        at org.apache.tools.ant.Task.perform(Task.java:364)\n        at\norg.apache.tools.ant.taskdefs.MacroInstance.execute(MacroInstance.java:378)\n        at org.apache.tools.ant.UnknownElement.execute(UnknownElement.java:275)\n        at org.apache.tools.ant.Task.perform(Task.java:364)\n        at org.apache.tools.ant.Target.execute(Target.java:341)\n        at org.apache.tools.ant.Target.performTasks(Target.java:369)\n        at org.apache.tools.ant.Project.executeSortedTargets(Project.java:1216)\n        at org.apache.tools.ant.Project.executeTarget(Project.java:1185)\n        at\norg.apache.tools.ant.helper.DefaultExecutor.executeTargets(DefaultExecutor.java:40)\n        at org.apache.tools.ant.Project.executeTargets(Project.java:1068)\n        at org.apache.tools.ant.Main.runBuild(Main.java:668)\n        at org.apache.tools.ant.Main.startAnt(Main.java:187)\n        at org.apache.tools.ant.launch.Launcher.run(Launcher.java:246)\n        at org.apache.tools.ant.launch.Launcher.main(Launcher.java:67)\n\nTotal time: 9 minutes 1 second\n", "id": 82070, "time": "2005-11-02T22:23:07Z", "creator": "edward.kuns@aspect.com", "creation_time": "2005-11-02T22:23:07Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 37237, "attachment_id": null, "is_private": false, "id": 85156, "time": "2006-01-28T16:07:19Z", "creator": "bodewig@apache.org", "creation_time": "2006-01-28T16:07:19Z", "text": "I've added a test\n\nhttp://svn.apache.org/viewcvs.cgi?rev=373154&view=rev\n\nand it passes, I think you are mixing different versions of ant.jar and load\nJarMarker.class from the newer one while ExtraFieldUtils has been loaded from an\nolder version.  That's the only explanation I have. "}]