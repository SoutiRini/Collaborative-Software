[{"attachment_id": null, "tags": [], "creator": "dustin.kirkland@gmail.com", "is_private": false, "count": 0, "id": 116511, "time": "2008-05-12T08:52:53Z", "bug_id": 44975, "creation_time": "2008-05-12T08:52:53Z", "text": "We have encountered an easily reproducible memory leak with Apache2 + mod_ssl with zlib encryption enabled.\n\nReproducing the problem is as simple as running Apache-bench against a vulnerable host:\n  ab -n 10000 -c 20 -f tls1 https://vulnerable.host.example.com:443/\n\nVulnerable hosts seem to be (apache >= 2.2.4) + (openssl >= 0.9.8e).\n\nDepending on how much memory is available on the server, you may need to scale the value of -n up or down.  With 128MB in a virtual machine -n 1000 is enough to manifest the problem.\n\nOn the client side, you will begin seeing:\n  SSL handshake failed (5).\n  SSL read failed - closing connection\n\nOn the server side under Linux, the kernel Out-of-memory (OOM) killer starts reaping runaway Apache2 instances.\n  Out of memory: kill process XXXX (apache2) \n\nThis bug is being tracked in Ubuntu's bug tracker here:\n  https://bugs.edge.launchpad.net/ubuntu/+source/apache2/+bug/224945\n\nAs this looks to be an issue with OpenSSL, it has been reported there as well:\n  http://marc.info/?l=openssl-dev&m=121060672602371&w=2\n\n:-Dustin"}, {"count": 1, "tags": [], "bug_id": 44975, "is_private": false, "text": "Can you check if r654119 (http://svn.apache.org/viewvc?view=rev&revision=654119) fixes your problem?", "id": 116520, "time": "2008-05-12T13:24:24Z", "creator": "rpluem@apache.org", "creation_time": "2008-05-12T13:24:24Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 44975, "is_private": false, "text": "Hi Ruediger-\n\nI applied that patch to our Apache 2.2.8 and that gets us halfway there.\n\nIt solves the Out-of-memory errors and the killing of the Apache processes for consuming all system memory.\n\nHowever, on the client end when running ab, I still see lots of:\nSSL read failed - closing connection\nSSL handshake failed (5).\n\nIt looks like it's just dropping the SSL connections when it gets busy.\n\nAs recently as Apache 2.2.3, I can run the same ab tests with no problems on either the client (dropping SSL connections) or the server (running out of memory).\n\n:-Dustin", "id": 116530, "time": "2008-05-12T14:44:50Z", "creator": "dustin.kirkland@gmail.com", "creation_time": "2008-05-12T14:44:50Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 44975, "attachment_id": null, "text": "Actually, I stand corrected.  Please disregard my previous post.  I did not apply the patch cleanly, and therefore those tests were invalid.\n\nI have since cleanly applied the patch, and it does in fact solve the issue.\n\nThank you very much for your prompt response.  We should be publishing updated packages for Ubuntu shortly.\n\nThanks,\n:-Dustin", "id": 116561, "time": "2008-05-13T07:34:45Z", "creator": "dustin.kirkland@gmail.com", "creation_time": "2008-05-13T07:34:45Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 44975, "is_private": false, "text": "Proposed for backport to 2.2.x as r655982 (http://svn.apache.org/viewvc?view=rev&revision=655982).", "id": 116577, "time": "2008-05-13T12:31:34Z", "creator": "rpluem@apache.org", "creation_time": "2008-05-13T12:31:34Z", "attachment_id": null}, {"count": 5, "tags": [], "creator": "mchen@interwoven.com", "attachment_id": null, "text": "For Apache 2.0.63 running on Windows 2003, I use the following to perform the test repeatedly.\nab -n 10000 -c 20 -f tls1 https://vulnerable.host.example.com:443/\n\nThe memory consumed by Apache keep growing and growing. Setting MaxRequestPerThread seems the only way to prevent it from happening...\n\nNot sure when we can have a patch or new release for Apache 2.0.x in the near future.", "id": 122605, "time": "2008-11-18T15:25:58Z", "bug_id": 44975, "creation_time": "2008-11-18T15:25:58Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "wrowe@apache.org", "is_private": false, "count": 6, "id": 122606, "time": "2008-11-18T15:34:01Z", "bug_id": 44975, "creation_time": "2008-11-18T15:34:01Z", "text": "This is by design...\n\nhttpd parks the memory allocations per-thread, and recycles this allocation for \nthe next request.  To alter this behavior, see the MaxMemFree directive, and\nabsolutely tune ThreadsPerChild to a number corresponding to your actual max\nconcurrent traffic.\n"}, {"count": 7, "tags": [], "bug_id": 44975, "is_private": false, "text": "(In reply to comment #6)\n> This is by design...\n> httpd parks the memory allocations per-thread, and recycles this allocation for \n> the next request.  To alter this behavior, see the MaxMemFree directive, and\n> absolutely tune ThreadsPerChild to a number corresponding to your actual max\n> concurrent traffic.\n\nI use the same test scenario for Apache2.2.10 but the memory usage is always around 20,000kb. for Apache 2.0.63, it will grow up 490,000KB after I run \nabs -n 100000 -c 149 -f tls1 https://localhost:443/ about 10 times. Any comment on that?\n\n\nI use the following Apache downloaded from http://httpd.apache.org.\napache2.0.63-x86-openssl-0.9.7m.msi\napache2.2.10-x86-openssl-0.9.8i.msi\n\n", "id": 122607, "time": "2008-11-18T16:35:30Z", "creator": "mchen@interwoven.com", "creation_time": "2008-11-18T16:35:30Z", "attachment_id": null}, {"count": 8, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "text": "mod_deflate has a memory leak in 2.0.x. This is fixed since 2.2.4 but was not backported to 2.0.x. Please use 2.2.x if you experience this problem.", "id": 122620, "time": "2008-11-19T00:55:02Z", "bug_id": 44975, "creation_time": "2008-11-19T00:55:02Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 44975, "attachment_id": null, "id": 122621, "time": "2008-11-19T01:09:32Z", "creator": "rpluem@apache.org", "creation_time": "2008-11-19T01:09:32Z", "is_private": false, "text": "(In reply to comment #8)\n> mod_deflate has a memory leak in 2.0.x. This is fixed since 2.2.4 but was not\n> backported to 2.0.x. Please use 2.2.x if you experience this problem.\n> \n\nSorry I got confused by the zlib in the subject and read mod_deflate instead of mod_ssl.\nNevertheless the patch in comment #1 was backported to 2.2.9 but not to 2.2.x.\nSo please use 2.2.9 and up if you are affected by this issue."}, {"count": 10, "tags": [], "bug_id": 44975, "attachment_id": null, "id": 122622, "time": "2008-11-19T01:11:44Z", "creator": "rpluem@apache.org", "creation_time": "2008-11-19T01:11:44Z", "is_private": false, "text": "(In reply to comment #9)\n\n> Nevertheless the patch in comment #1 was backported to 2.2.9 but not to 2.2.x.\n\nMust be 2.0.x instead of 2.2.x of course.\n\n"}, {"count": 11, "tags": [], "bug_id": 44975, "is_private": false, "text": "(In reply to comment #8)\n> mod_deflate has a memory leak in 2.0.x. This is fixed since 2.2.4 but was not\n> backported to 2.0.x. Please use 2.2.x if you experience this problem.\n\nI don't think this issue is related to mod_deflate.\nIf I use ab instead abs and run the following test 10 times:\nab -n 100000 -c 149 http://localhost:80/\n\nThe memory consumed by Apache will grow from 10,064KB and then is stablized to around 30,904KB.\n\nIt means that it only happens on https which might be related to mod_ssl...\n", "id": 122643, "time": "2008-11-19T10:43:17Z", "creator": "mchen@interwoven.com", "creation_time": "2008-11-19T10:43:17Z", "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 44975, "is_private": false, "text": "(In reply to comment #10)\n> (In reply to comment #9)\n> > Nevertheless the patch in comment #1 was backported to 2.2.9 but not to 2.2.x.\n> Must be 2.0.x instead of 2.2.x of course.\n\nYes, I am hopping that similar patch in comment #1 should be backported to 2.0.x. I know that the patch is backported to 2.2.x since I cannot reproduce the problem on 2.2.10.", "id": 122644, "time": "2008-11-19T10:47:36Z", "creator": "mchen@interwoven.com", "creation_time": "2008-11-19T10:47:36Z", "attachment_id": null}, {"count": 13, "tags": [], "bug_id": 44975, "is_private": false, "text": "(In reply to comment #9)\n> (In reply to comment #8)\n> > mod_deflate has a memory leak in 2.0.x. This is fixed since 2.2.4 but was not\n> > backported to 2.0.x. Please use 2.2.x if you experience this problem.\n> > \n> Sorry I got confused by the zlib in the subject and read mod_deflate instead of\n> mod_ssl.\n> Nevertheless the patch in comment #1 was backported to 2.2.9 but not to 2.2.x.\n> So please use 2.2.9 and up if you are affected by this issue.\n\nI cannot use 2.2.x... In fact, we are using apache 2.0.x as reverse proxy and applied some patches to enable features like IPV6. We have to continue to use Apache 2.0.x for a while...", "id": 122645, "time": "2008-11-19T10:50:51Z", "creator": "mchen@interwoven.com", "creation_time": "2008-11-19T10:50:51Z", "attachment_id": null}, {"count": 14, "tags": [], "bug_id": 44975, "text": "I just search google with the keyword \"Apache 2.0.59 mod_ssl memory leak\" and found that it is not just me who encountered this issue.\n\nhttp://mail-archives.apache.org/mod_mbox/httpd-users/200709.mbox/%3C1E5DDB0AD7F8FA4EA12097917C2FD18D027A0A1E06@BLRKECMBX04.ad.infosys.com%3E\n\nIn fact, it is our customer who reported this issue and ask for a solution. So far, it seems that the only solution for now is to set MaxRequestPerThread to non zero...", "id": 122646, "time": "2008-11-19T10:56:05Z", "creator": "mchen@interwoven.com", "creation_time": "2008-11-19T10:56:05Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "text": "Try backporting the patch to 2.0.x by yourself. The patch itself is quite simple:\nhttp://svn.apache.org/viewvc/httpd/httpd/trunk/modules/ssl/mod_ssl.c?r1=654119&r2=654118&pathrev=654119&view=patch", "id": 122649, "time": "2008-11-19T12:51:06Z", "bug_id": 44975, "creation_time": "2008-11-19T12:51:06Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "mchen@interwoven.com", "is_private": false, "count": 16, "id": 122651, "time": "2008-11-19T14:53:51Z", "bug_id": 44975, "creation_time": "2008-11-19T14:53:51Z", "text": "(In reply to comment #15)\n> Try backporting the patch to 2.0.x by yourself. The patch itself is quite\n> simple:\n> http://svn.apache.org/viewvc/httpd/httpd/trunk/modules/ssl/mod_ssl.c?r1=654119&r2=654118&pathrev=654119&view=patch\n\nYes, the patch itself is quite simple if you diff the file between apache 2.2.8 and apache 2.2.10. If you diff mod_ssl.c between Apache 2.0.63 and apache 2.2.10, there are quite a few differences between them.\n\nCan I simply copy mod_ssl.c from apache 2.2.10 over mod_ssl.c from Apache 2.0.63 and expect it to work?\n\nBTW, I am not even sure if they are the same problem. I just know that when I run abs -n 100000 -c 149 -f tls1 https://localhost:443 10 times, Apache will consume around 490,000KB. It will increase about 51MB each time I run it.\n\nWhen I run ab -n 100000 -c 149 http://localhost:80, I do not see the issue."}, {"count": 17, "tags": [], "bug_id": 44975, "text": "Minor revisions (2.0 vs 2.2 vs 2.4) are not binary compatible, you must upgrade\nentirely to apache 2.2 or hold on for the patch.\n\nThere's no promise to ever ship 2.0.64, probably only if a vulnerability is\ndiscovered, but I plan to backport this patch, and will look at attaching\nthat backported patch to this incident.", "id": 122654, "time": "2008-11-19T15:10:49Z", "creator": "wrowe@apache.org", "creation_time": "2008-11-19T15:10:49Z", "is_private": false, "attachment_id": null}, {"count": 18, "tags": [], "bug_id": 44975, "text": "(In reply to comment #17)\n> Minor revisions (2.0 vs 2.2 vs 2.4) are not binary compatible, you must upgrade\n> entirely to apache 2.2 or hold on for the patch.\n> There's no promise to ever ship 2.0.64, probably only if a vulnerability is\n> discovered, but I plan to backport this patch, and will look at attaching\n> that backported patch to this incident.\n\nCVE-2008-1678 seems to be the cause of this bug... I hope this justifies a new release,e.g. 2.0.64...", "id": 122685, "time": "2008-11-20T11:19:30Z", "creator": "mchen@interwoven.com", "creation_time": "2008-11-20T11:19:30Z", "is_private": false, "attachment_id": null}, {"count": 19, "tags": [], "creator": "mchen@interwoven.com", "attachment_id": null, "text": "(In reply to comment #17)\n> Minor revisions (2.0 vs 2.2 vs 2.4) are not binary compatible, you must upgrade\n> entirely to apache 2.2 or hold on for the patch.\n> There's no promise to ever ship 2.0.64, probably only if a vulnerability is\n> discovered, but I plan to backport this patch, and will look at attaching\n> that backported patch to this incident.\n\nOur customer is pushing us for a solution. Do you know any work around that can prevent the problem? If so, that will be great.", "id": 122804, "time": "2008-11-24T14:24:53Z", "bug_id": 44975, "creation_time": "2008-11-24T14:24:53Z", "is_private": false}, {"count": 20, "tags": [], "creator": "mchen@interwoven.com", "attachment_id": null, "text": "(In reply to comment #17)\n> Minor revisions (2.0 vs 2.2 vs 2.4) are not binary compatible, you must upgrade\n> entirely to apache 2.2 or hold on for the patch.\n> There's no promise to ever ship 2.0.64, probably only if a vulnerability is\n> discovered, but I plan to backport this patch, and will look at attaching\n> that backported patch to this incident.\n\nAny rough estimate when the patch will be available?", "id": 123992, "time": "2009-01-13T05:56:28Z", "bug_id": 44975, "creation_time": "2009-01-13T05:56:28Z", "is_private": false}, {"count": 21, "tags": [], "bug_id": 44975, "text": "ERR_free_strings and CRYPTO_cleanup_all_ex_data are never called by mod_ssl\nin the httpd 2.0.x tree now.  Apparently they might never have been.\n\nTherefore this ticket doesn't apply at all to 2.0.  If you have memory issues\nthey are elsewhere in the code, see similar tickets.  Also note that not much\nattention was paid in 2.0 to OpenSSL 0.9.8 as 0.9.7 was current.  You really\nmust upgrade your software in sync, you can't expect project maintainers to\nbe in sync with every flavor of dependent library releases, especially ancient\nand future ones.\n\nSuggestions; revert to OpenSSL 0.9.7, or upgrade to httpd 2.2.x.\n\nClosing", "id": 124000, "time": "2009-01-13T10:40:23Z", "creator": "wrowe@apache.org", "creation_time": "2009-01-13T10:40:23Z", "is_private": false, "attachment_id": null}, {"count": 22, "tags": [], "creator": "mchen@interwoven.com", "attachment_id": null, "text": "(In reply to comment #21)\n> ERR_free_strings and CRYPTO_cleanup_all_ex_data are never called by mod_ssl\n> in the httpd 2.0.x tree now.  Apparently they might never have been.\n> Therefore this ticket doesn't apply at all to 2.0.  If you have memory issues\n> they are elsewhere in the code, see similar tickets.  Also note that not much\n> attention was paid in 2.0 to OpenSSL 0.9.8 as 0.9.7 was current.  You really\n> must upgrade your software in sync, you can't expect project maintainers to\n> be in sync with every flavor of dependent library releases, especially ancient\n> and future ones.\n> Suggestions; revert to OpenSSL 0.9.7, or upgrade to httpd 2.2.x.\n> Closing\n\nI feel puzzled about your comment:\nSuggestions; revert to OpenSSL 0.9.7, or upgrade to httpd 2.2.x.\n\nI download the following installer from Apache web site:\napache2.0.63-x86-openssl-0.9.7m.msi\n\nIt uses OpenSSL 0.9.7 alreay and still has the same problem. The summary field for this bug is \"memory leak with mod_ssl and zlib compression\" and I can use the same test sequence to reproduce the problem, e.g. abs -n 100000 -c 149 -f tls1 https://localhost:443/.\n\nShould I report it in a seperate bug?\n\n\n", "id": 124102, "time": "2009-01-15T11:48:51Z", "bug_id": 44975, "creation_time": "2009-01-15T11:48:51Z", "is_private": false}, {"count": 23, "tags": [], "bug_id": 44975, "is_private": false, "text": "Dustin's bug report can be better understood here;\n\nhttps://bugzilla.redhat.com/show_bug.cgi?id=447268\n\nMichael, you either are looking at a leak in mod_ssl/openssl or mod_deflate/zlib \nbut not the combination which existed in 0.9.8e until 2.2.10.\n\nPlease don't file a bug report until we know which bug (probably already\nreported) your problem corresponds to.  Could I ask you to go ahead and try\nreproducing the problem with only SSL or mod_deflate enabled to narrow down\nwhich of these two modules is faulty?  Go ahead and stick with the 0.9.7 and\napache 2.0 flavor.  Then we'll look at 2.2 patches for the corresponding module.\n\nBut your issue is not the one documented in this PR. ", "id": 124103, "time": "2009-01-15T12:16:38Z", "creator": "wrowe@apache.org", "creation_time": "2009-01-15T12:16:38Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "mchen@interwoven.com", "text": "(In reply to comment #23)\n> Dustin's bug report can be better understood here;\n> https://bugzilla.redhat.com/show_bug.cgi?id=447268\n> Michael, you either are looking at a leak in mod_ssl/openssl or\n> mod_deflate/zlib \n> but not the combination which existed in 0.9.8e until 2.2.10.\n> Please don't file a bug report until we know which bug (probably already\n> reported) your problem corresponds to.  Could I ask you to go ahead and try\n> reproducing the problem with only SSL or mod_deflate enabled to narrow down\n> which of these two modules is faulty?  Go ahead and stick with the 0.9.7 and\n> apache 2.0 flavor.  Then we'll look at 2.2 patches for the corresponding\n> module.\n> But your issue is not the one documented in this PR. \n\nWe do not use mod_deflate. I also installed apache2.0.63-x86-openssl-0.9.7m.msi, and mod_deflate is not used at all. \n\nHopefully this helps.\n\n", "count": 24, "id": 124106, "time": "2009-01-15T16:05:24Z", "bug_id": 44975, "creation_time": "2009-01-15T16:05:24Z", "is_private": false}, {"count": 25, "tags": [], "bug_id": 44975, "attachment_id": null, "text": "I'm not sure where the claim that this doesn't affect OpenSSL 0.9.7 comes from.  My analysis of this last year was:\n\n\"\"\nHaving done some more testing, it looks like the current behaviour in\nOpenSSL was changed here:\n\n  http://cvs.openssl.org/chngview?cn=15897\n\nso the issue can only be triggered with OpenSSL versions >= 0.9.7f.\n\"\"", "id": 124118, "time": "2009-01-16T02:01:34Z", "creator": "jorton@redhat.com", "creation_time": "2009-01-16T02:01:34Z", "is_private": false}, {"count": 26, "tags": [], "bug_id": 44975, "attachment_id": null, "id": 124121, "time": "2009-01-16T06:14:47Z", "creator": "jorton@redhat.com", "creation_time": "2009-01-16T06:14:47Z", "is_private": false, "text": "My mistake, after double-checking this the OpenSSL code in question appears to be in 0.9.8e and later.\n\nAnother known memory leak in mod_ssl is the dbm session cache. "}, {"count": 27, "tags": [], "creator": "mchen@interwoven.com", "attachment_id": null, "text": "(In reply to comment #26)\n> My mistake, after double-checking this the OpenSSL code in question appears to\n> be in 0.9.8e and later.\n> Another known memory leak in mod_ssl is the dbm session cache. \n\nI've done some more investigation by taking the source code from 2.2.10 and build it and use our current httpd.conf from 2.0.x. To my surprise, I can still reproduce the problem with the source code in 2.2.10. If download 2.2.10 installer and use that, the problem does not exist.\n\nI then do a diff and migrate the change one by one using httpd.conf from 2.2.10 to the one from 2.0.x and identify the source of the problem.\n\nThis is the settings in httpd-ssl.conf from Apache 2.2.10.\n#   to use and second the expiring timeout (in seconds).\n#SSLSessionCache         \"dbm:c:/cache/2210-2/out_nti86/iw-webd/logs/ssl_scache\"\nSSLSessionCache        \"shmcb:c:/cache/2210-2/out_nti86/iw-webd/logs/ssl_scache(512000)\"\nSSLSessionCacheTimeout  300\n\nThis is the settings in ssl.conf from apache 2.0.x.\n#SSLSessionCache        none\n#SSLSessionCache        shmht:logs/ssl_scache(512000)\n#SSLSessionCache        shmcb:logs/ssl_scache(512000)\nSSLSessionCache         dbm:logs/ssl_scache\n\nIt means that in Apache 2.2.x, shmcb/path/to/cache is used while in Apache 2.0.x, dbm/path/to/cache is used which causes the problem.\n\nIn Apache 2.2.10, if I switch to use dbm/path/to/cache, I can reproduce the problem. In Apache 2.0.x, if I switch to use /shm/path/to/path, the problem goes away.\n\nAfter I found this, I did a search to see if there is any mod_ssl/SSLSessionCache issue which causes the memory memory leak and I did find it at https://issues.apache.org/bugzilla/show_bug.cgi?id=25667\n\nI am not sure why bug 25667 is left open and the solution is just to fix the configuration file and update the doc so that user using apache 2.0.x will be aware of that?\n", "id": 124253, "time": "2009-01-21T14:55:42Z", "bug_id": 44975, "creation_time": "2009-01-21T14:55:42Z", "is_private": false}]