[{"count": 0, "tags": [], "creator": "knst.kolinko@gmail.com", "text": "Created attachment 31637\n(1) localhost.2014-05-20.log\n\nTesting examples web application in 8.0.8 release candidate running with Security Manager enabled, with NIO connector, JDK 7u55 32-bit, Win7, I see several issues.\n\nSteps to reproduce (1).\n\n1. Edit conf/tomcat-users.xml  and uncomment sample roles there.\n2. Start bin/catalina.bat start -security\n\n3. Access the following page:\nhttp://localhost:8080/examples/jsp/security/protected/index.jsp\n\nExpected: Login page\nActual: Error 500\nAccess denied (\"java.lang.RuntimePermission\" \"accessClassInPackage.org.apache.tomcat.util.http.parser\")\n\nThe stack trace is:\n\n java.security.AccessControlException: access denied (\"java.lang.RuntimePermission\" \"accessClassInPackage.org.apache.tomcat.util.http.parser\")\nat java.security.AccessControlContext.checkPermission(AccessControlContext.java:372)\nat java.security.AccessController.checkPermission(AccessController.java:559)\nat java.lang.SecurityManager.checkPermission(SecurityManager.java:549)\nat java.lang.SecurityManager.checkPackageAccess(SecurityManager.java:1525)\nat sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:305)\nat java.lang.ClassLoader.loadClass(ClassLoader.java:412)\nat java.lang.ClassLoader.loadClass(ClassLoader.java:358)\nat org.apache.tomcat.util.http.parser.HttpParser.skipConstant(HttpParser.java:305)\nat org.apache.tomcat.util.http.parser.HttpParser.parseMediaType(HttpParser.java:192)\nat org.apache.tomcat.util.http.parser.MediaTypeCache.parse(MediaTypeCache.java:54)\nat org.apache.catalina.connector.Response.setContentType(Response.java:712)\nat org.apache.jsp.jsp.security.protected_.login_jsp._jspService(login_jsp.java:52)\nat org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:70)\nat javax.servlet.http.HttpServlet.service(HttpServlet.java:725)\n\nSee attached \"(1) localhost.2014-05-20.log\" for the full stack trace.", "id": 175324, "time": "2014-05-19T20:37:45Z", "bug_id": 56545, "creation_time": "2014-05-19T20:37:45Z", "is_private": false, "attachment_id": 31637}, {"count": 1, "tags": [], "creator": "knst.kolinko@gmail.com", "text": "The workaround for the issue in Comment 0 is to add the following class to the value of classesToInitialize attribute of JreMemoryLeakPreventionListener in server.xml. E.g.:\n\n<Listener className=\"org.apache.catalina.core.JreMemoryLeakPreventionListener\"\nclassesToInitialize=\"org.apache.tomcat.util.http.parser.HttpParser$SkipConstantResult\" />", "id": 175326, "time": "2014-05-19T20:44:40Z", "bug_id": 56545, "creation_time": "2014-05-19T20:44:40Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 56545, "attachment_id": null, "text": "4. On the login page, enter a username (role1) and password (see tomcat-users.xml). Press \"Login\" button.\n5. Look into logs/localhost.2014-05-20.log.\nThere is an exception thrown by Session attribute event listener.\n\norg.apache.catalina.session.StandardSession.setAttribute Session attribute event listener threw exception\n java.security.AccessControlException: access denied (\"java.lang.RuntimePermission\" \"accessClassInPackage.org.apache.catalina.util\")\nat java.security.AccessControlContext.checkPermission(AccessControlContext.java:372)\nat java.security.AccessController.checkPermission(AccessController.java:559)\nat java.lang.SecurityManager.checkPermission(SecurityManager.java:549)\nat java.lang.SecurityManager.checkPackageAccess(SecurityManager.java:1525)\nat sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:305)\nat java.lang.ClassLoader.loadClass(ClassLoader.java:412)\nat java.lang.ClassLoader.loadClass(ClassLoader.java:358)\nat org.apache.catalina.users.MemoryUser.toString(MemoryUser.java:312)\nat javax.security.auth.Subject.toString(Subject.java:842)\nat javax.security.auth.Subject.toString(Subject.java:825)\nat java.lang.String.valueOf(String.java:2854)\nat java.lang.StringBuilder.append(StringBuilder.java:128)\nat listeners.SessionListener.attributeAdded(SessionListener.java:56)\nat org.apache.catalina.session.StandardSession.setAttribute(StandardSession.java:1546)\n\n6. Press logout link (\"you can log off by clicking here.\")\n7. The same exception is thrown for \"attributeRemoved\" event.\n\nFrom the stacktrace (at org.apache.catalina.users.MemoryUser.toString(MemoryUser.java:312)) my guess is that it ties to call static method RequestUtil.filter(username).", "id": 175328, "time": "2014-05-19T20:51:16Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-05-19T20:51:16Z", "is_private": false}, {"count": 3, "tags": [], "creator": "knst.kolinko@gmail.com", "text": "Created attachment 31638\n(2) localhost.2014-05-20.log\n\nLog file with exceptions for issue in Comment 2.", "id": 175329, "time": "2014-05-19T20:52:40Z", "bug_id": 56545, "creation_time": "2014-05-19T20:52:40Z", "is_private": false, "attachment_id": 31638}, {"count": 4, "tags": [], "creator": "knst.kolinko@gmail.com", "text": "The workaround for issue in Comment 2 is to add \"org.apache.catalina.util.RequestUtil\" to the value of classesToInitialize attribute.\n\nWith the following configuration both issues are resolved:\n\n  <Listener className=\"org.apache.catalina.core.JreMemoryLeakPreventionListener\"\n   classesToInitialize=\n   \"org.apache.tomcat.util.http.parser.HttpParser$SkipConstantResult,\n    org.apache.catalina.util.RequestUtil\"\n  />", "id": 175330, "time": "2014-05-19T20:56:39Z", "bug_id": 56545, "creation_time": "2014-05-19T20:56:39Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 56545, "attachment_id": null, "text": "Update version now I have added 8.0.8 to the list of versions for 8.0.x", "id": 175333, "time": "2014-05-19T22:13:29Z", "creator": "markt@apache.org", "creation_time": "2014-05-19T22:13:29Z", "is_private": false}, {"count": 6, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 175341, "time": "2014-05-20T11:26:14Z", "bug_id": 56545, "creation_time": "2014-05-20T11:26:14Z", "is_private": false, "text": "These issues have been fixed in 8.0.x for 8.0.9 onwards."}, {"count": 7, "tags": [], "bug_id": 56545, "attachment_id": null, "text": "The issue from Comment 0 is reproducible with 7.0.54 release candidate,\nusing JDK 7u55 and the same reproduction recipe.\n\nThe issue from Comment 2 does not happen.\n\nThe workaround is as documented above,\n\n> The workaround for the issue in Comment 0 is to add the following class to\n> the value of classesToInitialize attribute of\n> JreMemoryLeakPreventionListener in server.xml. E.g.:\n\n <Listener\n className=\"org.apache.catalina.core.JreMemoryLeakPreventionListener\"\n classesToInitialize=\"org.apache.tomcat.util.http.parser. HttpParser$SkipConstantResult\" />\n\n\nFor a record, in 6.0.41 the issues do not happen.", "id": 175370, "time": "2014-05-21T13:34:10Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2014-05-21T13:34:10Z", "is_private": false}, {"count": 8, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "id": 175470, "time": "2014-05-26T14:16:19Z", "bug_id": 56545, "creation_time": "2014-05-26T14:16:19Z", "is_private": false, "text": "Fixed in Tomcat 7 by r1597592 and will be in 7.0.55.\n\nI did not backport r1596201."}]