[{"count": 0, "tags": [], "bug_id": 40376, "attachment_id": null, "id": 92792, "time": "2006-08-31T12:43:38Z", "creator": "awisniewski@dm4.com.pl", "creation_time": "2006-08-31T12:43:38Z", "is_private": false, "text": "Version:\n**********\nanws:~# apache -v\nServer version: Apache/1.3.34 (Debian)\nServer built:   Aug 16 2006 12:32:35\n**********\nI have very simple test config:\n*********\nServerRoot /etc/apache\nServerName localhost\nErrorLog logs/error_testowy.log\nDocumentRoot /var/www\nLoadModule mime_module /usr/lib/apache/1.3/mod_mime.so\nLoadModule config_log_module /usr/lib/apache/1.3/mod_log_config.so\nLogFormat \"%h %l %u %t \\\"%r\\\" %>s %b\" common\nCustomLog logs/access_log common\nKeepAlive on\nMaxKeepAliveRequests 2\nKeepAliveTimeout 130\n*********\nAs you can see there is MaxKeepAliveRequests=2 so apache should accept\nTCP/IP connection to the server, send 1st HTTP answer for request, wait\nfor the 2nd HTTP request on this same TCP/IP connection and then (after\nthe 2nd HTTP request) close TCP/IP connection. As I can see this is not\ntrue :/\n\nLet's check tcp/ip connections to port 80. There is no connections when I'm\nstarting:\n\n*******\nanws:/var/www# netstat -na --protocol=inet | grep 80 ; date tcp        0\n   0 0.0.0.0:80              0.0.0.0:*               LISTEN\n*******\n\nNow, I'm looking at my site in my favorit browser :) and I can see new\nTCP/IP connection:\n*****\nanws:/var/www# netstat -na --protocol=inet | grep 80 ; date\ntcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN\ntcp        0      0 127.0.0.1:80            127.0.0.1:1904          ESTABLISHED\ntcp        0      0 127.0.0.1:1904          127.0.0.1:80            ESTABLISHED\n&#347;ro sie 30 11:43:09 CEST 2006\n*****\n\n1st HTTP request was served.\nNow, I'm looking at my site in brobser again and I can see that my TCP/IP\nconnection is still active :/\n\n*****\nanws:/var/www# netstat -na --protocol=inet | grep 80 ; date tcp        0\n   0 0.0.0.0:80              0.0.0.0:*               LISTEN tcp        0 0\n   127.0.0.1:80            127.0.0.1:1904          ESTABLISHED tcp\n 0      0 127.0.0.1:1904          127.0.0.1:80            ESTABLISHED &#347;ro\nsie 30 11:43:16 CEST 2006\n*****\n*****\nanws:/var/www# netstat -na --protocol=inet | grep 80 ; date tcp        0\n   0 0.0.0.0:80              0.0.0.0:*               LISTEN tcp        0 0\n   127.0.0.1:80            127.0.0.1:1904          ESTABLISHED tcp\n 0      0 127.0.0.1:1904          127.0.0.1:80            ESTABLISHED &#347;ro\nsie 30 11:43:16 CEST 2006\n*****\n\n2nd HTTP request was served by this same TCP/IP connection and coneection\nis still active :/\n\nI'm looking at my site in brobser again and I can see that my TCP/IP\nconnection is in closing state:\n\n*****\nanws:/var/www# netstat -na --protocol=inet | grep 80 ; date tcp        0\n   0 0.0.0.0:80              0.0.0.0:*               LISTEN tcp        0 0\n   127.0.0.1:1904          127.0.0.1:80            TIME_WAIT &#347;ro sie 30\n11:43:22 CEST 2006\n*****\n\nbut this is after 3rd HTTP request (not after the 2nd as I have written in\nmy config).\n\nTo be sure that it was not cached I can show you also CustomLog:\n\n*****\n127.0.0.1 - - [30/Aug/2006:11:43:07 +0200] \"GET /index.cos HTTP/1.1\" 200 12\n127.0.0.1 - - [30/Aug/2006:11:43:14 +0200] \"GET /index.cos HTTP/1.1\" 200 12\n127.0.0.1 - - [30/Aug/2006:11:43:19 +0200] \"GET /index.cos HTTP/1.1\" 200 12\n*****\n\nSo there were three HTTP request with 12 bytes response :/"}, {"count": 1, "tags": [], "bug_id": 40376, "text": "And quick patch which can correct problem.\n\n***************\n\n--- apache_1.3.37/src/main/http_protocol.c      2006-07-12\n10:16:05.000000000 +0200\n+++ apache_1.3.37_correct/src/main/http_protocol.c      2006-08-31\n14:22:34.000000000 +0200\n@@ -431,7 +431,7 @@\n         r->server->keep_alive &&\n         (r->server->keep_alive_timeout > 0) &&\n         ((r->server->keep_alive_max == 0) ||\n-         (r->server->keep_alive_max > r->connection->keepalives)) &&\n+         (r->server->keep_alive_max > r->connection->keepalives + 1)) &&\n         !ap_status_drops_connection(r->status) &&\n         !wimpy &&\n         !ap_find_token(r->pool, conn, \"close\") &&\n\n\nThis quick fix corrects problem so problem is (I think) with \"keepalives\" start\nvalue (should be 1 not 0). I'm sure that you can find better place in code for\ncorrect this problem :) ", "id": 92793, "time": "2006-08-31T12:45:06Z", "creator": "awisniewski@dm4.com.pl", "creation_time": "2006-08-31T12:45:06Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 40376, "attachment_id": null, "id": 106207, "time": "2007-08-02T13:13:18Z", "creator": "jim@apache.org", "creation_time": "2007-08-02T13:13:18Z", "is_private": false, "text": "interpretation of directive is mistaken"}]