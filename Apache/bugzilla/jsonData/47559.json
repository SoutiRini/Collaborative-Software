[{"count": 0, "attachment_id": 24020, "creator": "lnelson@llnl.gov", "text": "Created attachment 24020\nsample file generated by POI that is unreadable by Excel 2008 SP2\n\nAfter upgrading to Excel 2008 SP2 for Mac, Excel is no longer able to read xlsx files generated by poi.  I am including an email thread with Microsoft relating to this.  I'm not sure if this is a POI issue, or a Microsoft one, but I wanted to document it here.\n\n--Leif\n\n===== EMAIL THREAD START ====\n\nPat-\n\nThanks for the response.  The solution of using windows excel won\u2019t work for us, as we have a batch system that generates literally thousands of excel files on a weekly basis that get distributed to users across our organization.  The batch system runs on linux-based servers.  This \u201csudden\u201d breaking of excel is really an issue for us, especially with the automatic updating of excel.  A quick and speedy resolution of this problem would help much.  If there are any more details on the specifics of the contents of the xlsx file that Excel 2008 SP2 cannot read, it might be possible to change our excel generator to tweak the xlsx files we generate.  I compared the contents of the \u201cfixed\u201d version ( windows->xlsb->xlsx) to the \u201cincompatible\u201d version by unzipping and comparing the contents of the embedded xml files.  But there are may differences.  Do you know what it is about the sample I sent you that Excel Mac doesn\u2019t like?\n\nThanks much,\n--Leif\n\n\nOn 7/22/09 3:52 PM, \"Patrick McMillan (MACBU)\" <patmcmil@microsoft.com> wrote:\n\nHi Leif,\n\nThere\u2019s some explanation for the cause of this at this link: http://support.microsoft.com/kb/972141. Basically, files that were generated in specific ways in particular versions of Windows Excel (for example, by opening a text file) and then saved to the .xlsx format will have this problem. We\u2019re working on a solution to this problem, but in the meantime, if you have access to Windows Excel, you should be able to \u201cfix\u201d affected files by opening them in Windows Excel, saving out as .xlsb, and then saving them again as .xlsx. At that point, the files should open fine in Mac Excel again.\n\nPlease let me know if that works for you.\n\nThanks,\n\nPat\n\n\nOn 7/22/09 2:06 PM, \"Leif Nelson\" wrote:\n\nHi Pat-\n\nI saw your posting on the Excel forum ( http://www.officeformac.com/ms/ProductForums/Excel/4544 ), and thought I could send you one of the files that I cannot open.  For our business systems, we generate xlsx files programmatically with Java using apache POI and their new xlsx support.  We have been happily using this for several months now with awesome results on Mac and Windows platforms for distributing our business data.  Well, after the SP2 update, ALL of the files we generate are now unable to be opened by Excel 2008 for Mac.  This is a huge issue for us.  I have generated the simplest excel file possible.  It works with Excel 12.1.9 and Excel 2007 for windows.  For completeness, here\u2019s the java code I\u2019m using to generate the xlsx file:\n\nThanks much,\nLeif Nelson\n\npackage org.apache.poi.xssf.util;\n\nimport java.io.File;\nimport java.io.FileOutputStream;\nimport java.io.OutputStream;\n\nimport org.apache.poi.ss.usermodel.Cell;\nimport org.apache.poi.ss.usermodel.Row;\nimport org.apache.poi.ss.usermodel.Sheet;\nimport org.apache.poi.xssf.usermodel.XSSFWorkbook;\n\npublic class PoiTest {\n\n  public static void main(String[] args) {\n    try {\n    XSSFWorkbook wb = new XSSFWorkbook();\n    Sheet sheet = wb.createSheet();\n    Row row = sheet.createRow(0);\n    Cell cell = row.createCell(0);\n    cell.setCellValue(\"Hi there\");\n    OutputStream out;\n      out = new FileOutputStream(new File(\"testout.xlsx\"));\n    wb.write(out);\n    out.flush();\n    out.close(); \n    } catch (Exception e) {\n      e.printStackTrace();\n    }\n  }\n  \n}\n\n===== EMAIL THREAD END ======", "id": 129059, "time": "2009-07-22T15:14:42Z", "bug_id": 47559, "creation_time": "2009-07-22T15:14:42Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 47559, "text": "Hi Leif,\n\nI have confirmed your trouble, and am very unhappy with Microsoft.\n\nI am very concerned about this quote from the link:\n\n> This problem occurs when Excel 2008, Word 2008, or PowerPoint 2008 has detected\n> that the file that you are trying to open abides by an interpretation of the \n> ISO29500 Office Open XML (OOXML) standard. Excel 2008, Word 2008, and\n> PowerPoint 2008 do not support this standard.\n\nWe'll see if we can find the correct interpretation. This certainly will have the attention of the Apache POI PMC.\n\nRegards,\nDave", "id": 129060, "time": "2009-07-22T17:05:33Z", "creator": "dfisher@jmlafferty.com", "creation_time": "2009-07-22T17:05:33Z", "is_private": false, "attachment_id": null}, {"count": 2, "attachment_id": null, "bug_id": 47559, "text": "I have a feeling it has to do with Bugs 47432 and 46419. If yes, then the problem is not how we generate SpreadsheetML, but how we build OPC packages. \n\nLeif, \n\n can you please check the two attached files :\n\n  - poi-test-1.xlsx. This is a simple test created by POI. Mac Excel 2008 should fail to read it. OpenOffice 3.0 can't read it either.\n  - poi-test-2.xlsx. This is a \"fixed\" version of  poi-test-1.xlsx, readable by OpenOffice 3.0\n\nThe fix:\n\n 1. unzip a file generated by POI\n 2. edit /_rels/.rels and remove leading slashes from Targets:\n \nTarget=\"/xl/workbook.xml\" --> Target=\"xl/workbook.xml\"\nTarget=\"/docProps/core.xml\" --> Target=\"docProps/core.xml\"\n\nall core relationships must be fixed. \n\n  3. zip the edited files into a .xlsx file\n\n\nRegards,\nYegor", "id": 129069, "time": "2009-07-23T04:31:29Z", "creator": "yegor@dinom.ru", "creation_time": "2009-07-23T04:31:29Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 47559, "attachment_id": 24023, "id": 129070, "time": "2009-07-23T04:34:02Z", "creator": "yegor@dinom.ru", "creation_time": "2009-07-23T04:34:02Z", "is_private": false, "text": "Created attachment 24023\npoi-test-1.xlsx: a simple file generated by POI"}, {"count": 4, "tags": [], "bug_id": 47559, "attachment_id": 24024, "id": 129071, "time": "2009-07-23T04:34:48Z", "creator": "yegor@dinom.ru", "creation_time": "2009-07-23T04:34:48Z", "is_private": false, "text": "Created attachment 24024\npoi-test-2.xlsx"}, {"count": 5, "tags": [], "bug_id": 47559, "attachment_id": null, "id": 129073, "time": "2009-07-23T07:25:31Z", "creator": "lnelson@llnl.gov", "creation_time": "2009-07-23T07:25:31Z", "is_private": false, "text": "(In reply to comment #4)\n> Created an attachment (id=24024) [details]\n> poi-test-2.xlsx\n\nHi Yegor-\n\nI tried both xlsx files (poi-test-1.xlsx and poi-test-2.xlsx) with Mac Excel 2008 SP2, and neither one can be opened.  Both give the error:  \"Microsoft Excel cannot open the file.  You may need to download the latest updates for Office for Mac.  Do you want to visit the Microsoft Web site for more information?\"\n\npoi-test-1.xlsx cannot be opened by OpenOffice, but poi-test-2.xlsx can be opened by OpenOffice, as you pointed out.  \n\nI will attach a file that has been converted to be readable by Mac Excel 2008 SP2 by using Windows Excel 2007 to open the poi-generated xlsx file (testout.xlsx).  Then saving as xlsb, then opening with Mac Excel and saving as xlsx.  I will call this file testout-converted.xlsx.\n\nThanks much!\n-Leif"}, {"count": 6, "attachment_id": 24025, "creator": "lnelson@llnl.gov", "text": "Created attachment 24025\ntestout.xlsb - testout.xlsx opened with MS Excel 2007 and \"saved as\" xlsb", "id": 129074, "time": "2009-07-23T07:29:00Z", "bug_id": 47559, "creation_time": "2009-07-23T07:29:00Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "creator": "lnelson@llnl.gov", "attachment_id": 24026, "text": "Created attachment 24026\ntestout-converted.xlsx - testout.xlsb opened with Mac Excel 2008 SP2 and saved as xlsx (readable by MS Excel 2008 SP2)", "id": 129075, "time": "2009-07-23T07:29:52Z", "bug_id": 47559, "creation_time": "2009-07-23T07:29:52Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 47559, "attachment_id": null, "id": 129080, "time": "2009-07-23T07:48:06Z", "creator": "dfisher@jmlafferty.com", "creation_time": "2009-07-23T07:48:06Z", "is_private": false, "text": "Hi Leif,\n\nWas your original file attached here converted by the program you just attached to https://issues.apache.org/bugzilla/show_bug.cgi?id=46419 ?\n\nRegards,\nDave"}, {"count": 9, "tags": [], "bug_id": 47559, "text": "(In reply to comment #8)\n> Hi Leif,\n> \n> Was your original file attached here converted by the program you just attached\n> to https://issues.apache.org/bugzilla/show_bug.cgi?id=46419 ?\n> \n> Regards,\n> Dave\n\nDave-\n\nNope.  These are two separate issues, and I was \"reminded\" about the OpenOffice issue by Yegor. :-)  The original file included here was generated with the code snippet in the first bug report (in the email thread).  It was generated by poi-3.5beta6.  I only included the program in the other bug to show the workaround I had implemented to deal with OpenOffice!\n\nThe other attachments I added to this bug (testout.xlsb and testout-converted.xlsx) were created as follows:\n\n1)  testout.xlsx (created by code snippet below - poi-3.5beta6)\n2)  testout.xlsb (testout.xlsx (from 1) opened with Windows Excel 2007 and saved as xlsb)\n3)  testout-converted.xlsx (testout.xlsb (from 2) opened with Mac Excel 2008 SP2 and saved as xlsx)\n\nHope that's more clear!\n\nThanks,\n--Leif\n\n\nimport java.io.File;\nimport java.io.FileOutputStream;\nimport java.io.OutputStream;\n\nimport org.apache.poi.ss.usermodel.Cell;\nimport org.apache.poi.ss.usermodel.Row;\nimport org.apache.poi.ss.usermodel.Sheet;\nimport org.apache.poi.xssf.usermodel.XSSFWorkbook;\n\npublic class PoiTest {\n\n  public static void main(String[] args) {\n    try {\n    XSSFWorkbook wb = new XSSFWorkbook();\n    Sheet sheet = wb.createSheet();\n    Row row = sheet.createRow(0);\n    Cell cell = row.createCell(0);\n    cell.setCellValue(\"Hi there\");\n    OutputStream out;\n      out = new FileOutputStream(new File(\"testout.xlsx\"));\n    wb.write(out);\n    out.flush();\n    out.close(); \n    } catch (Exception e) {\n      e.printStackTrace();\n    }\n  }\n\n}", "id": 129081, "time": "2009-07-23T07:56:45Z", "creator": "lnelson@llnl.gov", "creation_time": "2009-07-23T07:56:45Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 47559, "text": "I have found, that if I change the testout.xlsx file contents in the following ways, I can get the file to open with Mac Excel 2008 SP2:\n\n1)  Add this line to _rels/.rels\n  <Relationship Id=\"rId3\" Type=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties\" Target=\"/docProps/app.xml\"/>\n\n2) Add this line to [Content_Types].xml\n  <Override PartName=\"/docProps/app.xml\" ContentType=\"application/vnd.openxmlformats-officedocument.extended-properties+xml\"/>\n\n\n3)  Add this file:  docProps/app.xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Properties xmlns=\"http://schemas.openxmlformats.org/officeDocument/2006/extended-properties\" xmlns:vt=\"http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes\">\n  <Application>Microsoft Macintosh Excel</Application>\n  <DocSecurity>0</DocSecurity>\n  <ScaleCrop>false</ScaleCrop>\n  <HeadingPairs>\n    <vt:vector size=\"2\" baseType=\"variant\">\n      <vt:variant>\n        <vt:lpstr>Worksheets</vt:lpstr>\n      </vt:variant>\n      <vt:variant>\n        <vt:i4>1</vt:i4>\n      </vt:variant>\n    </vt:vector>\n  </HeadingPairs>\n  <TitlesOfParts>\n    <vt:vector size=\"1\" baseType=\"lpstr\">\n      <vt:lpstr>Sheet0</vt:lpstr>\n    </vt:vector>\n  </TitlesOfParts>\n  <LinksUpToDate>false</LinksUpToDate>\n  <SharedDoc>false</SharedDoc>\n  <HyperlinksChanged>false</HyperlinksChanged>\n  <AppVersion>12.0000</AppVersion>\n</Properties>\n\nI will attach a file modified in this way:  testout-fixed.xlsx\n\n--Leif", "id": 129082, "time": "2009-07-23T08:33:21Z", "creator": "lnelson@llnl.gov", "creation_time": "2009-07-23T08:33:21Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "bug_id": 47559, "attachment_id": 24028, "id": 129083, "time": "2009-07-23T08:34:52Z", "creator": "lnelson@llnl.gov", "creation_time": "2009-07-23T08:34:52Z", "is_private": false, "text": "Created attachment 24028\ntestout-fixed.xlsx - testout.xlsx with modifications to make it openable by Excel 2008 SP2"}, {"count": 12, "tags": [], "bug_id": 47559, "text": "Here is a simpler \"fix\" for files to make them openable in Excel 2008 SP2\n\n1)  Add this line to _rels/.rels\n  <Relationship Id=\"rId3\"\nType=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties\"\nTarget=\"/docProps/app.xml\"/>\n\n2) Add this line to [Content_Types].xml\n  <Override PartName=\"/docProps/app.xml\"\nContentType=\"application/vnd.openxmlformats-officedocument.extended-properties+xml\"/>\n\n\n3)  Add this file:  docProps/app.xml with contents:\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Properties xmlns=\"http://schemas.openxmlformats.org/officeDocument/2006/extended-properties\" xmlns:vt=\"http://schemas.openxmlformats.org/officeDocument/2006/docPro\npsVTypes\">\n  <Application>Microsoft Excel</Application>\n</Properties>", "id": 129086, "time": "2009-07-23T10:08:23Z", "creator": "lnelson@llnl.gov", "creation_time": "2009-07-23T10:08:23Z", "is_private": false, "attachment_id": null}, {"count": 13, "tags": [], "bug_id": 47559, "attachment_id": null, "id": 129087, "time": "2009-07-23T10:34:43Z", "creator": "lnelson@llnl.gov", "creation_time": "2009-07-23T10:34:43Z", "is_private": false, "text": "In response to a query from Dave, the only entries in the app.xml file that work are:\n    <Application>Microsoft Excel</Application>\nand\n    <Application>Microsoft Macintosh Excel</Application>\n\nIf I try\n    <Application>Apache POI 3.5</Application>\nI get the same error as before, Microsoft Excel Mac 2008 SP2 cannot open the file.\n\n--Leif"}, {"count": 14, "tags": [], "text": "(In reply to comment #13)\n> In response to a query from Dave, the only entries in the app.xml file that\n> work are:\n>     <Application>Microsoft Excel</Application>\n> and\n>     <Application>Microsoft Macintosh Excel</Application>\n> \n> If I try\n>     <Application>Apache POI 3.5</Application>\n> I get the same error as before, Microsoft Excel Mac 2008 SP2 cannot open the\n> file.\n> \n> --Leif\n\n\nAlso...  If I try <Application>Apache POI 3.5</Application> in app.xml, Microsoft Excel 2007 for Windows opens the file with no problem.  In fact, every variation of all these files is openable by Microsoft Excel 2007 for Windows.\n\n--Leif", "attachment_id": null, "id": 129088, "creator": "lnelson@llnl.gov", "time": "2009-07-23T10:36:58Z", "bug_id": 47559, "creation_time": "2009-07-23T10:36:58Z", "is_private": false}, {"count": 15, "tags": [], "text": "As a workaround, I have found that you can start by reading in a minimal workbook saved out Excel 2008. Delete its worksheet and then proceed as if you just created it with new XSSFWorkbook().", "attachment_id": null, "id": 129089, "creator": "prescindor@gmail.com", "time": "2009-07-23T11:01:13Z", "bug_id": 47559, "creation_time": "2009-07-23T11:01:13Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 47559, "text": "Hi Leif,\n\nPlease try app_xml_1.xlsx, now with extended properties (app.xml).\n\nThe code to generate is as follows:\n\n        XSSFWorkbook wb = new XSSFWorkbook();\n        XSSFSheet sh = wb.createSheet(\"Sheet1\");\n        sh.createRow(0).createCell(0).setCellValue(\"Hi There!\");\n\n        POIXMLProperties.ExtendedProperties ext =  wb.getProperties().getExtendedProperties();\n        ext.getUnderlyingProperties().setApplication(\"Microsoft Excel\");\n\n        FileOutputStream out = new FileOutputStream(\"app_xml_1.xlsx\");\n        wb.write(out);\n        out.close();\n\nHope it will help. \n\nRegards,\nYegor", "id": 129091, "time": "2009-07-23T12:05:56Z", "creator": "yegor@dinom.ru", "creation_time": "2009-07-23T12:05:56Z", "is_private": false, "attachment_id": null}, {"count": 17, "tags": [], "bug_id": 47559, "attachment_id": 24030, "id": 129092, "time": "2009-07-23T12:09:12Z", "creator": "yegor@dinom.ru", "creation_time": "2009-07-23T12:09:12Z", "is_private": false, "text": "Created attachment 24030\napp_xml_1.xlsx\n\ntest .xlsx file with extended properties (app.xml)"}, {"count": 18, "tags": [], "bug_id": 47559, "attachment_id": null, "id": 129093, "time": "2009-07-23T12:29:57Z", "creator": "dfisher@jmlafferty.com", "creation_time": "2009-07-23T12:29:57Z", "is_private": false, "text": "Yegor,\n\nThe app_xml_1.xlsx file works fine for me.\n\nDave"}, {"count": 19, "tags": [], "text": "\n(In reply to comment #18)\n> Yegor,\n> \n> The app_xml_1.xlsx file works fine for me.\n> \nExcellent! \nNow we know that Excel 2008 for Mac requires the extended property Application to be set. Valid values are either \"Microsoft Excel\" or \"Microsoft Macintosh Excel\". \n\nThis fully confirms the previous Leif's observations. \n\nFrom common sense point of view it is absolutely ridiculous - it is just a check that the creator application is Excel. \n\nYegor", "attachment_id": null, "id": 129099, "creator": "yegor@dinom.ru", "time": "2009-07-23T13:03:06Z", "bug_id": 47559, "creation_time": "2009-07-23T13:03:06Z", "is_private": false}, {"count": 20, "tags": [], "creator": "lnelson@llnl.gov", "attachment_id": null, "text": "Yegor-\n\nThanks so much!  I initially tried your sample code with poi-3.5beta6 and got an exception, but when I switched to the trunk, it works well.  I was able to run the sample code, generate an xlsx file and open it with Mac Excel 2008 SP2.  \n\nGreat news!  Now, hopefully they'll fix Excel 2008 so that it'll read all of the files we have previously generated and distributed. :-)\n\nThanks again for the quick turn-around on this!\n\n--Leif", "id": 129100, "time": "2009-07-23T13:07:27Z", "bug_id": 47559, "creation_time": "2009-07-23T13:07:27Z", "is_private": false}, {"count": 21, "tags": [], "bug_id": 47559, "attachment_id": null, "id": 129108, "time": "2009-07-24T01:50:52Z", "creator": "yegor@dinom.ru", "creation_time": "2009-07-24T01:50:52Z", "is_private": false, "text": "Leif,\n\nI fixed POI to generate files compatible with Excel 2008 Mac sp2. The fix was committed in r79735. \n\nI hope that Microsoft will release a fix for Excel Mac soon. Meantime, you can patch existing files with the following code:\n\n        XSSFWorkbook wb = new XSSFWorkbook(path);\n\n        POIXMLProperties.ExtendedProperties ext =  wb.getProperties().getExtendedProperties();\n        ext.getUnderlyingProperties().setAppVersion(\"Microsoft Excel\");\n\n        FileOutputStream out = new FileOutputStream(path);\n        wb.write(out);\n        out.close();\n\n\nYegor"}, {"count": 22, "tags": [], "bug_id": 47559, "attachment_id": null, "id": 129124, "time": "2009-07-24T08:37:44Z", "creator": "dfisher@jmlafferty.com", "creation_time": "2009-07-24T08:37:44Z", "is_private": false, "text": "Actually this is r797350 - http://svn.apache.org/viewvc?view=rev&revision=797350"}, {"count": 23, "tags": [], "text": "Fantastic!  I have placed this code on our servers, and now users can open excel files with Mac Excel 2008 SP2!\n\nThanks so much for the quick response!\n\n--Leif", "attachment_id": null, "id": 129172, "creator": "lnelson@llnl.gov", "time": "2009-07-27T07:47:21Z", "bug_id": 47559, "creation_time": "2009-07-27T07:47:21Z", "is_private": false}, {"count": 24, "tags": [], "bug_id": 47559, "attachment_id": null, "id": 129181, "time": "2009-07-27T09:51:48Z", "creator": "lnelson@llnl.gov", "creation_time": "2009-07-27T09:51:48Z", "is_private": false, "text": "(In reply to comment #21)\n> Leif,\n> \n> I fixed POI to generate files compatible with Excel 2008 Mac sp2. The fix was\n> committed in r79735. \n> \n> I hope that Microsoft will release a fix for Excel Mac soon. Meantime, you can\n> patch existing files with the following code:\n> \n>         XSSFWorkbook wb = new XSSFWorkbook(path);\n> \n>         POIXMLProperties.ExtendedProperties ext = \n> wb.getProperties().getExtendedProperties();\n>         ext.getUnderlyingProperties().setAppVersion(\"Microsoft Excel\");\n> \n>         FileOutputStream out = new FileOutputStream(path);\n>         wb.write(out);\n>         out.close();\n> \n> \n> Yegor\n\nI believe this should be changed to: \n\next.getUnderlyingProperties().setApplication(\"Microsoft Excel\");\n\nThe \"AppVersion\" field has something like \"12.000\" in it in my samples.\n\nSorry I didn't notice this earlier,\n\n--Leif"}, {"count": 25, "tags": [], "creator": "blair.neumann@microsoft.com", "is_private": false, "id": 129295, "creation_time": "2009-07-30T09:32:41Z", "time": "2009-07-30T09:32:41Z", "bug_id": 47559, "text": "See also my additional comments on the dev@poi.apache.org mailing list archive.\n\nhttp://mail-archives.apache.org/mod_mbox/poi-dev/200907.mbox/%3c78E528D1-9EFB-422C-B45E-946F9D1E9D2E@jmlafferty.com%3e\n\nBlair Neumann\nMacintosh Business Unit, Microsoft", "attachment_id": null}, {"count": 26, "tags": [], "bug_id": 47559, "text": "Microsoft has released Office 2008 12.2.1 which fixes this issue.  http://support.microsoft.com/kb/974170\n\n--Leif", "id": 129546, "time": "2009-08-06T14:25:00Z", "creator": "lnelson@llnl.gov", "creation_time": "2009-08-06T14:25:00Z", "is_private": false, "attachment_id": null}, {"count": 27, "tags": [], "creator": "yegor@dinom.ru", "attachment_id": null, "is_private": false, "id": 129576, "time": "2009-08-09T06:30:45Z", "bug_id": 47559, "creation_time": "2009-08-09T06:30:45Z", "text": "Very good. \nI changed XSSF and XWPF to set the Application setting to \"Apache POI\".\n\nYegor"}]