[{"count": 0, "tags": [], "text": " ", "is_private": false, "id": 61738, "creator": "apache@ggr8.net", "time": "2004-08-10T04:49:36Z", "bug_id": 30553, "creation_time": "2004-08-10T04:49:36Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 30553, "attachment_id": null, "is_private": false, "id": 61739, "time": "2004-08-10T06:22:32Z", "creator": "apache@ggr8.net", "creation_time": "2004-08-10T06:22:32Z", "text": "When using mod_rewrite with mod_proxy, mod_cache and mod_mem_cache to reverse \nproxy a Zope/Plone server, every second time a page with a query string is \nrequested by Apache from Zope the query string is duplicated.\n\nThis is somewhat similar to this bug: \nhttp://nagoya.apache.org/bugzilla/show_bug.cgi?id=13577 but I only experience \nthis problem with mod_mem_cache enabled.\n\nHere is the rewrite rule - only the directory gallery is run from the Zope \nserver:\n\nRewriteCond %{REQUEST_URI}    ^/gallery*\nRewriteRule ^/gallery/(.*)     http://xx.xx.xx.xx:8080/VirtualHostBase/http/%\n{HTTP_HOST}:80/Plone/gallery/VirtualHostRoot/_vh_gallery/$1 [P,L]\n\n(the VirtualHostBase and VirtualHostRoot and _vh_ parts of the URL are specific \nto Zope for the alteration of links generated in the page to suit being reverse \nproxied - http://mptc.eng.cmu.ac.th/docs/zope-book/VirtualHosting.html)\n\n\nThe duplication of the query string can be seen in the zope logs (modified for \nsecurity/paranoia). \"?SearchableText=text\" is duplicated on some requests:\n\nxx.xx.xx.xx - Anonymous [10/Aug/2004:15:11:17 \n+1000] \"GET /VirtualHostBase/http/www.xx.com:80/Plone/gallery/VirtualHostRoot/_v\nh_gallery/pictures/search?SearchableText=test HTTP/1.1\" 200 \n41353 \"http://www.xx.com/gallery/pictures/photoalbum_view\" \"Mozilla/4.0\"\n\nxx.xx.xx.xx - Anonymous [10/Aug/2004:15:11:19 \n+1000] \"GET /VirtualHostBase/http/www.xx.com:80/Plone/gallery/VirtualHostRoot/_v\nh_gallery/pictures/search?SearchableText=test?SearchableText=test HTTP/1.1\" 404 \n25883 \"http://www.xx.com/gallery/pictures/photoalbum_view\" \"Mozilla/4.0\"\n\nxx.xx.xx.xx - Anonymous [10/Aug/2004:15:11:20 \n+1000] \"GET /VirtualHostBase/http/www.xx.com:80/Plone/gallery/VirtualHostRoot/_v\nh_gallery/pictures/search?SearchableText=test HTTP/1.1\" 200 \n41353 \"http://www.xx.com/gallery/pictures/photoalbum_view\" \"Mozilla/4.0\"\n\nxx.xx.xx.xx - Anonymous [10/Aug/2004:15:11:22 \n+1000] \"GET /VirtualHostBase/http/www.xx.com:80/Plone/gallery/VirtualHostRoot/_v\nh_gallery/pictures/search?SearchableText=test?SearchableText=test HTTP/1.1\" 404 \n25883 \"http://www.xx.com/gallery/pictures/photoalbum_view\" \"Mozilla/4.0\"\n\n\nZope does not handle the duplication of \"?SearchableText=text\" and throws a 404 \npage back - which is displayed to the user.\n\n\nI also turned on RewriteLogLevel 3 to try and track this down - here is \nrewrite.log (sorry - clock on server running apache is ~2 mins fast):\n\nyy.yy.yy.yy - - [10/Aug/2004:15:13:40 +1000] [www.xx.com/sid#46f930]\n[rid#3ace2f0/initial] (2) init rewrite engine with requested \nuri /gallery/pictures/search\nyy.yy.yy.yy - - [10/Aug/2004:15:13:40 +1000] [www.xx.com/sid#46f930]\n[rid#3ace2f0/initial] (3) applying pattern '/(.*)' to \nuri '/gallery/pictures/search'\nyy.yy.yy.yy - - [10/Aug/2004:15:13:40 +1000] [www.xx.com/sid#46f930]\n[rid#3ace2f0/initial] (3) applying pattern '^/gallery/(.*)' to \nuri '/gallery/pictures/search'\nyy.yy.yy.yy - - [10/Aug/2004:15:13:40 +1000] [www.xx.com/sid#46f930]\n[rid#3ace2f0/initial] (2) rewrite /gallery/pictures/search -> \nhttp://xx.xx.xx.xx:8080/VirtualHostBase/http/www.xx.com:80/pbcGallery/gallery/Vi\nrtualHostRoot/_vh_gallery/pictures/search\nyy.yy.yy.yy - - [10/Aug/2004:15:13:40 +1000] [www.xx.com/sid#46f930]\n[rid#3ace2f0/initial] (2) forcing proxy-throughput with \nhttp://xx.xx.xx.xx:8080/VirtualHostBase/http/www.xx.com:80/pbcGallery/gallery/Vi\nrtualHostRoot/_vh_gallery/pictures/search\nyy.yy.yy.yy - - [10/Aug/2004:15:13:40 +1000] [www.xx.com/sid#46f930]\n[rid#3ace2f0/initial] (1) go-ahead with proxy request \nproxy:http://xx.xx.xx.xx:8080/VirtualHostBase/http/www.xx.com:80/pbcGallery/gall\nery/VirtualHostRoot/_vh_gallery/pictures/search [OK]\n\nyy.yy.yy.yy - - [10/Aug/2004:15:13:41 +1000] [www.xx.com/sid#46f930]\n[rid#3ad6400/initial] (2) uri already rewritten. Status 1, \nUri /gallery/pictures/search, r->filename \nproxy:http://xx.xx.xx.xx:8080/VirtualHostBase/http/www.xx.com:80/pbcGallery/gall\nery/VirtualHostRoot/_vh_gallery/pictures/search?SearchableText=test\nyy.yy.yy.yy - - [10/Aug/2004:15:13:41 +1000] [www.xx.com/sid#46f930]\n[rid#3ad6400/initial] (1) go-ahead with proxy request \nproxy:http://xx.xx.xx.xx:8080/VirtualHostBase/http/www.xx.com:80/pbcGallery/gall\nery/VirtualHostRoot/_vh_gallery/pictures/search?SearchableText=test [OK]\n\nyy.yy.yy.yy - - [10/Aug/2004:15:13:43 +1000] [www.xx.com/sid#46f930]\n[rid#3b8dcd8/initial] (2) init rewrite engine with requested \nuri /gallery/pictures/search\nyy.yy.yy.yy - - [10/Aug/2004:15:13:43 +1000] [www.xx.com/sid#46f930]\n[rid#3b8dcd8/initial] (3) applying pattern '/(.*)' to \nuri '/gallery/pictures/search'\nyy.yy.yy.yy - - [10/Aug/2004:15:13:43 +1000] [www.xx.com/sid#46f930]\n[rid#3b8dcd8/initial] (3) applying pattern '^/gallery/(.*)' to \nuri '/gallery/pictures/search'\nyy.yy.yy.yy - - [10/Aug/2004:15:13:43 +1000] [www.xx.com/sid#46f930]\n[rid#3b8dcd8/initial] (2) rewrite /gallery/pictures/search -> \nhttp://xx.xx.xx.xx:8080/VirtualHostBase/http/www.xx.com:80/Plone/gallery/Virtual\nHostRoot/_vh_gallery/pictures/search\nyy.yy.yy.yy - - [10/Aug/2004:15:13:43 +1000] [www.xx.com/sid#46f930]\n[rid#3b8dcd8/initial] (2) forcing proxy-throughput with \nhttp://xx.xx.xx.xx:8080/VirtualHostBase/http/www.xx.com:80/Plone/gallery/Virtual\nHostRoot/_vh_gallery/pictures/search\nyy.yy.yy.yy - - [10/Aug/2004:15:13:43 +1000] [www.xx.com/sid#46f930]\n[rid#3b8dcd8/initial] (1) go-ahead with proxy request \nproxy:http://xx.xx.xx.xx:8080/VirtualHostBase/http/www.xx.com:80/Plone/gallery/V\nirtualHostRoot/_vh_gallery/pictures/search [OK]\n\nyy.yy.yy.yy - - [10/Aug/2004:15:13:44 +1000] [www.xx.com/sid#46f930]\n[rid#3b8dcd8/initial] (2) uri already rewritten. Status 1, \nUri /gallery/pictures/search, r->filename \nproxy:http://xx.xx.xx.xx:8080/VirtualHostBase/http/www.xx.com:80/Plone/gallery/V\nirtualHostRoot/_vh_gallery/pictures/search?SearchableText=test\nyy.yy.yy.yy - - [10/Aug/2004:15:13:44 +1000] [www.xx.com/sid#46f930]\n[rid#3b8dcd8/initial] (1) go-ahead with proxy request \nproxy:http://xx.xx.xx.xx:8080/VirtualHostBase/http/www.xx.com:80/Plone/gallery/V\nirtualHostRoot/_vh_gallery/pictures/search?SearchableText=test [OK]\n\n\nAs explained above I only experience this problem with mod_mem_cache enabled. \nWith mod_disk_cache or no mem_cache I do not get this problem. I checked the \nrewrite.log on a test of using mod_disk_cache and the the line that occurs \nafter \"uri already rewritten\" -\n \"proxy:http://xx.xx.xx.xx:8080/VirtualHostBase/http/www.xx.com:80/pbcGallery/ga\nllery/VirtualHostRoot/_vh_gallery/pictures/search?SearchableText=test\" with the \nquery string in the proxy request does not occur. I think it is here that the \nquery string is been duplicated. Even though the querystring is not shown on \nthe other proxy requests, it must be added to the base url after this point, \nand is duplicated for these \"uri already rewritten\" situations\n\nIf any more details are needed please email me. Even though this appeared on \nWindows, I am guessing that it would also be occuring on other platforms."}, {"count": 2, "tags": [], "bug_id": 30553, "attachment_id": null, "text": "Have you tried the current (CVS) versions of mod_proxy and mod_cache?  There are\nmajor changes in both, that may well be relevant to this problem.", "id": 61748, "time": "2004-08-10T12:43:36Z", "creator": "nick@webthing.com", "creation_time": "2004-08-10T12:43:36Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 30553, "attachment_id": null, "is_private": false, "id": 61865, "time": "2004-08-12T07:12:52Z", "creator": "apache@ggr8.net", "creation_time": "2004-08-12T07:12:52Z", "text": "Nick Kew - Sorry I don't have enough skill in building in Windows to be able to \ncompile the CVS version of mod_mem_cache right now (or the necessary parts of \nMS VC++).\n\nIf someone is able to send me a compiled version of mod_mem_cache.so (and the \nother appropriate modules) for windows from the CVS I would happily test it.\n\nOtherwise, I hope to be able to have a go at compiling it myself next week."}, {"count": 4, "tags": [], "bug_id": 30553, "attachment_id": null, "is_private": false, "id": 66947, "time": "2004-11-15T20:41:04Z", "creator": "jerenkrantz@apache.org", "creation_time": "2004-11-15T20:41:04Z", "text": "The latest Win32 binary release (2.0.52) includes versions of mod_mem_cache and\nmod_cache that should resolve this.\n\nThanks!"}, {"id": 67140, "tags": [], "bug_id": 30553, "is_private": false, "count": 5, "text": "I can see the behavior described in the report with httpd-2.0.52 on both Linux\nand Solaris 9. Only the combination of mod_rewrite's [P,L], mod_mem_cache and a\nbackend- response with Cache-Control / Expires headers set triggers the bug. \n\nConfigurations  w/ ProxyPass work, and so do mod_rewrite + mod_disk_cache.\n\n(I assume the mentioned Win32 binary release has the same module versions?)\n\n", "time": "2004-11-18T16:06:37Z", "creator": "hansjoerg.pehofer@uibk.ac.at", "creation_time": "2004-11-18T16:06:37Z", "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 30553, "is_private": false, "text": "(In reply to comment #5)\n> I can see the behavior described in the report with httpd-2.0.52 on both Linux\n> and Solaris 9. [...]\n\nThe current Version from CVS works fine. Sorry for the noise.\n", "id": 67324, "time": "2004-11-22T11:19:44Z", "creator": "hansjoerg.pehofer@uibk.ac.at", "creation_time": "2004-11-22T11:19:44Z", "attachment_id": null}]