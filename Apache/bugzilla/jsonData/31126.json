[{"count": 0, "tags": [], "bug_id": 31126, "attachment_id": null, "text": "Just tested Reiser4 with Apache and found that it kept looking for\n/foo/bar/file.ext/.htaccess file.ext being a regular file like an image etc. \nAparently this is by design of the new FS that it treats files as folders etc\nand may change but I thought I'd best report it as the FS just got marked stable\nand a lot of people (unwisely?) switch straight away.\n\nHere's a snip from error_log\n[Wed Sep 08 16:17:47 2004] [crit] [client 192.168.8.3] (13)Permission denied:\n/home/shaun/public_html/rdr-blue/gfx/blue_top.jpeg/.htacce\nss pcfg_openfile: unable to check htaccess file, ensure it is readable, referer:\nhttp://192.168.8.3/~shaun/rdr-blue/\n[Wed Sep 08 16:17:47 2004] [crit] [client 192.168.8.3] (13)Permission denied:\n/home/shaun/public_html/rdr-blue/gfx/blue_bottom.jpeg/.hta\nccess pcfg_openfile: unable to check htaccess file, ensure it is readable,\nreferer: http://192.168.8.3/~shaun/rdr-blue/\n[Wed Sep 08 16:17:47 2004] [crit] [client 192.168.8.3] (13)Permission denied:\n/home/shaun/public_html/rdr-blue/gfx/index_pictures.png/.h\ntaccess pcfg_openfile: unable to check htaccess file, ensure it is readable,\nreferer: http://192.168.8.3/~shaun/rdr-blue/", "id": 63227, "time": "2004-09-08T18:13:31Z", "creator": "fasaxc@f2s.com", "creation_time": "2004-09-08T18:13:31Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 31126, "attachment_id": null, "text": "Apache runs as the user specified in the User directive. Files need to be\nreadable by that user. Directories need to be +x (searchable) by that user.\n\nAre you SURE you have your file permissions correct?\n", "id": 63230, "time": "2004-09-08T18:34:52Z", "creator": "chip@force-elite.com", "creation_time": "2004-09-08T18:34:52Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 31126, "is_private": false, "text": "okay, scratch that last comment, i just re-read the error messages and see that\nit is trying to read an .htaccess INSIDE the \"blue_bottom.jpeg\" file!\n\nGod. This screams of a File System Bug.  How is it apache's fault if the\nfilesystem tells us it is a directory?", "id": 63231, "time": "2004-09-08T18:36:49Z", "creator": "chip@force-elite.com", "creation_time": "2004-09-08T18:36:49Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "topia@clovery.jp", "attachment_id": null, "text": "maybe reiser4 is new and rare fs...\nI tried also, but I can't reproduce this.\n\n% mkdir reiser4/tempdir\n% ln -s reiser4/tempdir ~/public_html/temp\n% cd reiser4/tempdir\n% echo test > test.txt\n% cp /path/to/some/graphic.png test.png\n\nand accessed with Firefox. checked error_log(and vhost's error_log),\nbut logged only \"File does not exist: .../favicon.ico\" error.\n\n% chmod a+x test.txt test.png\n\nand accessed, but logged no (.htaccess) error, too.\n\nVersion information:\nApache2: 2.0.51-dev(2004-07-20) and 2.1.0-dev(2004-09-08)\nLinux: 2.6.9-rc1-mm1\nOS: Debian GNU/Linux (sid)\nFirefox: 1.0 Prerelease", "id": 63239, "time": "2004-09-08T19:53:56Z", "bug_id": 31126, "creation_time": "2004-09-08T19:53:56Z", "is_private": false}, {"count": 4, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "text": "Topia, the test is what:\n\n$ touch newfile.txt\n$ cat newfile.txt/.htaccess\n\nis supposed to do on reiserfs.  Accoding to this report the open fails with an\nEACCESS error, which is rather surprising behaviour.  What does it do for you?", "id": 63241, "time": "2004-09-08T20:01:11Z", "bug_id": 31126, "creation_time": "2004-09-08T20:01:11Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 31126, "is_private": false, "text": "$ touch newfile.txt\n$ cat newfile.txt/.htaccess\ncat: newfile.txt/.htaccess: Permission denied\n\nlooks like standard(?) behavior...", "id": 63242, "time": "2004-09-08T20:05:46Z", "creator": "topia@clovery.jp", "creation_time": "2004-09-08T20:05:46Z", "attachment_id": null}, {"count": 6, "tags": [], "creator": "nd@perlig.de", "attachment_id": null, "text": "ext3 behaviour on my machine:\n\n$ touch foo\n$ cat foo/.htaccess\ncat: foo/.htaccess: Not a directory\n\nreiser 3\n$ touch foo\n$ cat foo/.htaccess\ncat: foo/.htaccess: Not a directory\n\nhmm. looks clearly like a bug in the reiser 4 stuff.", "id": 63248, "time": "2004-09-08T20:22:21Z", "bug_id": 31126, "creation_time": "2004-09-08T20:22:21Z", "is_private": false}, {"count": 7, "tags": [], "creator": "fasaxc@f2s.com", "attachment_id": null, "text": "Been googling around a bit more, this is a designed behaviour of Reiser4 (in\ntheory it allows a plugin to reparse the path into a .tar for example so\n/foo/bar.tar/some.file would be legit).\n\nFrom http://www.namesys.com/v4/v4.html:\n\n\"Files That Are Also Directories\n\nIn Reiser4 (but not ReiserFS 3) an object can be both a file and a directory at\nthe same time. If you access it as a file, you obtain the named sequence of\nbytes. If you use it as a directory you can obtain files within it, directory\nlistings, etc. There was a lengthy discussion on the Linux Kernel Mailing List\nabout whether this was technically feasible to do. I won't reproduce it here\nexcept to summarize that Linus showed that this was feasible without \"breaking\" VFS.\n\nAllowing an object to be both a file and a directory is one of the features\nnecessary to to compose the functionality present in streams and attributes\nusing files and directories.\n\nTo implement a regular unix file with all of its metadata, we use a file plugin\nfor the body of the file, a directory plugin for finding file plugins for each\nof the metadata, and particular file plugins for each of the metadata. We use a\nunix_file file plugin to access the body of the file, and a unix_file_dir\ndirectory plugin to resolve the names of its metadata to particular file plugins\nfor particular metadata. These particular file plugins for unix file metadata\n(owner, permissions, etc.) are implemented to allow the metadata normally used\nby unix files to be quite compactly stored.\"\n\nReiser4 still hasn't hit the mainline kernel so maybe this behaviour will be\ndropped but right now it breaks Apache on my machine.", "id": 63252, "time": "2004-09-08T20:48:04Z", "bug_id": 31126, "creation_time": "2004-09-08T20:48:04Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 31126, "attachment_id": null, "id": 63255, "time": "2004-09-08T20:58:09Z", "creator": "jorton@redhat.com", "creation_time": "2004-09-08T20:58:09Z", "is_private": false, "text": "I was getting at the fact that the non-existant-file-within-a-file returned\nEACCESS rather than ENOENT which is the cause of the error messages.  But\npresumably httpd and half the rest of the world is completely broken anyway if\nS_ISDIR() is true for *any* file on reiser4."}, {"count": 9, "tags": [], "bug_id": 31126, "attachment_id": null, "text": "also tried,\n\n> $ test -d newfile.txt || echo is not dir\n> is not dir\n\nbut maybe this is standard behavior...\n", "id": 63256, "time": "2004-09-08T21:07:18Z", "creator": "topia@clovery.jp", "creation_time": "2004-09-08T21:07:18Z", "is_private": false}, {"count": 10, "tags": [], "creator": "fasaxc@f2s.com", "attachment_id": null, "text": "It must be the way apache is testing to see if a file is a directory or not...\nis there more than one method/syscall?", "id": 63259, "time": "2004-09-08T21:25:16Z", "bug_id": 31126, "creation_time": "2004-09-08T21:25:16Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 31126, "attachment_id": null, "is_private": false, "id": 63266, "time": "2004-09-09T04:21:21Z", "creator": "rici@ricilake.net", "creation_time": "2004-09-09T04:21:21Z", "text": "While the behaviour of ReiserFS is questionable, it does not seem that Apache is doing the\nright thing either.\n\nSpecifically, ap_parse_htaccess is being called under some circumstances even when the uri\nidentifies a specific file, rather than a directory. I believe the offending code is at line 923 of\nserver/request.c, following the comment:\n\n            /* First optimization;\n             * If...we knew r->filename was a file, and\n             * if...we have strict (case-sensitive) filenames, or\n             *      we know the canonical_filename matches to _this_ name, and\n             * if...we have allowed symlinks\n             * skip the lstat and dummy up an APR_DIR value for thisinfo.\n             */\n\nThe problem is that the dummy APR_DIR value will be inserted even if the last segment is a\nregular file; in the following iteration of the do loop, ap_parse_htaccess will attempt to\nappend \"/.htaccess\" (or whatever) onto the filename confident that it will be able to correctly\nidentify the resulting error. Unfortunately, Reiser4 appears to return EACCES instead of ENOENT\nor ENOTDIR in this particular case. I don't actually have Reiser to play with, but I checked the\nbehaviour by placing the following logging statement in ap_parse_htaccess, at the point\nwhere it has failed to open the .htaccess file:\n\n            ap_log_rerror(APLOG_MARK, APLOG_WARNING, status, r,\n                          \"pcfg_openfile tried %s and failed\", filename);\n\n\nWith -FollowSymLinks (thereby disabling the optimization), I got the following log trace:\nhttpd 2.0.50\ndocroot: /usr/local/www/perltest\nrequest: //freeb/perlest/foo/test.html\n(Note that the file exists and there are no .htaccess files)\n\n[Wed Sep 08 22:01:08 2004] [warn] [client 192.168.1.65]\n   (2)No such file or directory: pcfg_openfile tried /usr/local/www/perltest/.htaccess and failed\n[Wed Sep 08 22:01:08 2004] [warn] [client 192.168.1.65]\n   (2)No such file or directory: pcfg_openfile tried /usr/local/www/perltest/foo/.htaccess and failed\n\nEnabling FollowSymLinks and using exactly the same request reveals that the loop runs once too often: \n(and that the Ext3 filesystem return ENOTDIR for this error)\n\n[Wed Sep 08 22:03:08 2004] [warn] [client 192.168.1.65]\n   (2)No such file or directory: pcfg_openfile tried /usr/local/www/perltest/.htaccess and failed\n[Wed Sep 08 22:03:08 2004] [warn] [client 192.168.1.65]\n   (2)No such file or directory: pcfg_openfile tried /usr/local/www/perltest/foo/.htaccess and failed\n[Wed Sep 08 22:03:08 2004] [warn] [client 192.168.1.65]\n   (20)Not a directory: pcfg_openfile tried /usr/local/www/perltest/foo/test.html/.htaccess and failed\n\n"}, {"count": 12, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "text": "It looks like the reiser maintainers do consider this an fs bug and are trying\nto fix it, so I don't think we should change httpd at the moment.\n\nhttp://marc.theaimsgroup.com/?l=reiserfs&m=109510961420800&w=2\n", "id": 63979, "time": "2004-09-21T14:16:40Z", "bug_id": 31126, "creation_time": "2004-09-21T14:16:40Z", "is_private": false}]