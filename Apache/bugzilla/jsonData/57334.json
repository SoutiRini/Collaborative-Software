[{"attachment_id": null, "tags": [], "creator": "reto.ischi@ergon.ch", "text": "", "count": 0, "id": 179661, "time": "2014-12-09T18:31:21Z", "bug_id": 57334, "creation_time": "2014-12-09T18:31:21Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "reto.ischi@ergon.ch", "is_private": false, "count": 1, "id": 179663, "time": "2014-12-09T19:00:56Z", "bug_id": 57334, "creation_time": "2014-12-09T19:00:56Z", "text": "To reproduce the segmentation fault the following configuration prerequisites must be met:\n- SNI setup: Two VH on the same IP\n- SSLVerifyClient require or optional and OptRenegotiate set on the *second* virtual host\n- SSLInsecureRenegotiation on\n\nMinimal httpd.conf:\n===================\nServerRoot           /opt/airlock/ext-apache\nPidFile              /var/run/airlock-ext-apache/httpd.pid\nCoreDumpDirectory    /var/airlock/core/airlock-ext-apache\nUser                 extwww\nGroup                extwww\n\nLoadModule ssl_module        bin/mod_ssl.so\n\nListen     10.0.0.10\n\nSSLCertificateFile       conf/ssl.crt/server.crt\nSSLCertificateKeyFile    conf/ssl.key/server.key\n\nErrorDocument 403 /error_path/403.html\nSSLInsecureRenegotiation on\n\n<Location /error_path>\n</Location>\n\n<VirtualHost 10.0.0.10:443>\nServerName               serverA\nSSLEngine                on\n</VirtualHost>\n\n<VirtualHost 10.0.0.10:443>\nServerName               serverB\nSSLEngine                on\nSSLVerifyClient          require\nSSLOptions               +OptRenegotiate\n</VirtualHost>\n===================\n\nNow every request with a client certificate and without the TLS SNI extension set (like with IE7/XP) in the ClientHello message will cause the segmentation fault. This can be reproduced with openssl s_client without the \"-servername\" Option:\n\nopenssl s_client -connect serverB:443 -cert clientCert.pem -key clientKey.pem -tls1 -crlf\n\nGDB backtrace and additional infos:\n\nProgram received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0x7fffe37eb700 (LWP 13480)]\n0x00007ffff00000b8 in ?? ()\n(gdb) bt\n#0  0x00007ffff00000b8 in ?? ()\n#1  0x00007ffff615746b in SSL_renegotiate (s=0x7ffff0038e10) at ssl_lib.c:1032\n#2  0x00007ffff63a5add in ssl_hook_Access (r=0x7ffff003e7a0) at ssl_engine_kernel.c:801\n#3  0x00007ffff7fa1897 in ap_run_access_checker (r=0x7ffff003e7a0) at request.c:87\n#4  0x00007ffff7fa28a8 in ap_process_request_internal (r=0x7ffff003e7a0) at request.c:229\n#5  0x00007ffff7fd7c13 in ap_internal_redirect (new_uri=0x7ffff8273f98 \"/error_path/403.html\", r=0x7ffff003cde0) at http_request.c:642\n#6  0x00007ffff7fd6162 in ap_die (type=403, r=0x7ffff003cde0) at http_request.c:202\n#7  0x00007ffff7fd6b9a in ap_process_async_request (r=0x7ffff003cde0) at http_request.c:350\n#8  0x00007ffff7fd6bd1 in ap_process_request (r=0x7ffff003cde0) at http_request.c:363\n#9  0x00007ffff7fd26e3 in ap_process_http_sync_connection (c=0x7fffdc000c48) at http_core.c:190\n#10 0x00007ffff7fd280d in ap_process_http_connection (c=0x7fffdc000c48) at http_core.c:231\n#11 0x00007ffff7fbe5df in ap_run_process_connection (c=0x7fffdc000c48) at connection.c:41\n#12 0x00007ffff7fbeb0a in ap_process_connection (c=0x7fffdc000c48, csd=0x7fffdc000a30) at connection.c:203\n#13 0x00007ffff5ad1b5d in process_socket (thd=0x7ffff8241e70, dummy=Unhandled dwarf expression opcode 0xf3\n\n(gdb) frame 1\n#1  0x00007ffff615746b in SSL_renegotiate (s=0x7fffdc0028d0) at ssl_lib.c:1032\n1032            return(s->method->ssl_renegotiate(s));\n\n(gdb) print s->method->ssl_renegotiate\n$1 = (int (*)(SSL *)) 0x7fffdc0000b8\n\n(gdb) disassemble 0x7fffdc0000b8\nNo function contains specified address.\n\nThanks for your help\n\nReto"}, {"attachment_id": null, "tags": [], "creator": "ylavic.dev@gmail.com", "is_private": false, "count": 2, "id": 179669, "time": "2014-12-09T21:22:46Z", "bug_id": 57334, "creation_time": "2014-12-09T21:22:46Z", "text": "I can't reproduce here with openssl-1.0.1j, the regegotiation works expected.\n\nWhich version of openssl are you using?"}, {"count": 3, "tags": [], "bug_id": 57334, "text": "We have openssl-1.0.1j as well.\n\nI'm using this expect script to reproduce it:\n\n#!/usr/bin/expect\n\nset HOST serverB\nset CERT myCert.pem\nset KEY mykey.pem\n\nspawn openssl s_client -connect $HOST:443 -cert $CERT -key $KEY -tls1 -crlf\nexpect -- \"---\"\nsend \"GET / HTTP/1.1\\n\"\nsend \"Host: $HOST\\n\"\nsend \"\\n\"\nexpect eof\n\nNote that the lines:\n\nErrorDocument 403 /error_path/403.html\n<Location /error_path>\n</Location>\n\nfrom the minimal httpd.conf are also necessary to reproduce the segfault (independent whether 403.html exists or not).", "id": 179689, "time": "2014-12-10T10:04:31Z", "creator": "reto.ischi@ergon.ch", "creation_time": "2014-12-10T10:04:31Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "ylavic.dev@gmail.com", "text": "I still can't reproduce, even with ErrorDocument configured.\n\nShould ErrorDocument play a role here, maybe the renegotiation fails somehow (as opposed to a crash in SSL_renegotiate(), like in the provided backtrace), so that mod_ssl hits the HTTP_FORBIDDEN path.\n\nCan you please provide the log with LogLevel TRACE8 (and fake certificates) and also the backtrace of all the threads?", "count": 4, "id": 179690, "time": "2014-12-10T12:22:01Z", "bug_id": 57334, "creation_time": "2014-12-10T12:22:01Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 57334, "text": "All right, got it.\n\nIt only happens if I remove SSLCACertificateFile (which is not part of your minimal configuration...), hence the forbidden path is indeed involved.\n\nLet me take a look at the core file.", "count": 5, "id": 179692, "time": "2014-12-10T12:35:10Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2014-12-10T12:35:10Z", "is_private": false}, {"count": 6, "tags": [], "creator": "ylavic.dev@gmail.com", "attachment_id": 32281, "is_private": false, "id": 179698, "time": "2014-12-10T17:44:39Z", "bug_id": 57334, "creation_time": "2014-12-10T17:44:39Z", "text": "Created attachment 32281\nDon't crash on redirected SSL handshake failure\n\nThis patched fixed the issue for me.\nCan you give it a try?"}, {"count": 7, "tags": [], "text": "Patch works for me as well.\n\nThank you Yann!\n\nReto", "is_private": false, "bug_id": 57334, "id": 179700, "time": "2014-12-10T18:21:58Z", "creator": "reto.ischi@ergon.ch", "creation_time": "2014-12-10T18:21:58Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 57334, "is_private": false, "id": 179703, "creation_time": "2014-12-10T18:50:50Z", "time": "2014-12-10T18:50:50Z", "creator": "ylavic.dev@gmail.com", "text": "Proposed for backport in r1644501.", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 57334, "attachment_id": null, "id": 183782, "time": "2015-06-27T07:48:22Z", "creator": "christophe.jaillet@wanadoo.fr", "creation_time": "2015-06-27T07:48:22Z", "is_private": false, "text": "This is part of the (unreleased) 2.4.13\nbackport in r1662640"}]