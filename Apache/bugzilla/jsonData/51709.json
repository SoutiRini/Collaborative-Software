[{"count": 0, "attachment_id": null, "creator": "micha@lenk.info", "text": "As discussed on the mailing list, the following issue was found:\n\nShort summary:\nIf it matches, the parameter from VirtualHost overrides any ServerName or ServerAlias directive. Under some rare conditions, content for the wrong virtual host is delivered.\n\nDetailed description:\nI have configuration with two virtual hosts v1 and v2, both listening on\nthe same IP address. Assuming that v1.local and v2.local both resolve to the IP address 10.0.0.1, the configuration for the virtual hosts basically\nlooks like this:\n\nListen: 10.0.0.1:80 http\nNameVirtualHost 10.0.0.1:80\n<VirtualHost v2.local:80>     # <-- this is NO typo!\n    ServerName v1.local\n    DocumentRoot /srv/v1\n</VirtualHost>\n<VirtualHost v2.local:80>\n    ServerName v2.local\n    DocumentRoot /srv/v2\n</VirtualHost>\n\nFor HTTP requests with the request header 'Host: v2.local:80', the\nrequest always ends up on virtual host v1, delivering the content from\n/srv/v1.\n\nReading the code (version 2.2.19) I discovered, that in the function check_hostalias() defined in server/vhost.c the host header is\nmatched against the parameter from the VirtualHost container first,\nbefore it is then matched against any ServerName or ServerAlias\ndirective. And as soon as the first VirtualHost seems to match, no\nServerName or ServerAliases are checked. So, essentially any name or IP\nliteral specified as parameter to VirtualHost seems to have precedence\nover all ServerName or ServerAlias directives.\n\nI've already consulted the SVN history. Apparently this code flow didn't\nchange since the NameVirtualHost directive was added (SVN Rev. 79345)\nback in October 1997, and maybe is even older.", "id": 148780, "time": "2011-08-23T08:14:03Z", "bug_id": 51709, "creation_time": "2011-08-23T08:14:03Z", "tags": [], "is_private": false}, {"count": 1, "attachment_id": 27423, "creator": "micha@lenk.info", "text": "Created attachment 27423\nFix for function check_hostalias()\n\nPlease find attached my patch for check_hostalias(). I tried to stick to\nthe idea to do the ServerName and ServerAlias check only once for each\nserver. Also for this reason the result is in the end merely a rewrite\nof this function. I hope though that it is clear enough how it is\nintended to work.\n\nHowever, I believe the fix is yet incomplete. The function\nap_matches_request_vhost() used by modules like mod_proxy seems to\nimplement the virtual host check in the wrong order too.\n\nSee the dev mailinglist for more comments.", "id": 148781, "time": "2011-08-23T08:52:23Z", "bug_id": 51709, "creation_time": "2011-08-23T08:52:23Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "text": "Created attachment 27424\nFix for function ap_matches_request_vhost()\n\nThis is the suggested patch for ap_matches_request_vhost()", "is_private": false, "bug_id": 51709, "id": 148782, "time": "2011-08-23T10:06:38Z", "creator": "micha@lenk.info", "creation_time": "2011-08-23T10:06:38Z", "attachment_id": 27424}, {"count": 3, "tags": [], "creator": "micha@lenk.info", "attachment_id": 27424, "text": "Comment on attachment 27424\nFix for function ap_matches_request_vhost()\n\nAs discussed on the dev mailing list, the patch for ap_matches_request_vhost() is obsolete.\nhttp://mail-archives.apache.org/mod_mbox/httpd-dev/201109.mbox/%3C4E69DCA4.6070701@lenk.info%3E", "id": 149367, "time": "2011-09-17T14:18:48Z", "bug_id": 51709, "creation_time": "2011-09-17T14:18:48Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 51709, "text": "Created attachment 27520\nFix for function check_hostalias()\n\nUpdated the proposed fix for function check_hostalias(), based on SVN trunk, rev. 1171988.", "id": 149369, "time": "2011-09-17T14:30:06Z", "creator": "micha@lenk.info", "creation_time": "2011-09-17T14:30:06Z", "is_private": false, "attachment_id": 27520}, {"count": 5, "tags": [], "bug_id": 51709, "text": "Fixed in trunk as r1172002.", "id": 149376, "time": "2011-09-17T15:08:38Z", "creator": "rpluem@apache.org", "creation_time": "2011-09-17T15:08:38Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "text": "Was fixed by 2.4.0", "is_private": false, "bug_id": 51709, "id": 199398, "time": "2017-06-25T12:46:11Z", "creator": "covener@gmail.com", "creation_time": "2017-06-25T12:46:11Z", "attachment_id": null}]