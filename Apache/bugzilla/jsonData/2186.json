[{"count": 0, "tags": [], "bug_id": 2186, "attachment_id": null, "text": "When using dtd validation with SAX or DOM parsers if an ID/IDREF error is \nencountered the validation tables persist in new parser instances.  reset seems \nto have no effect \n\nhere's code to reproduce/workaround\n\nimport org.apache.xerces.parsers.DOMParser;\nimport org.apache.xerces.parsers.SAXParser;\n\n// for workaround\nimport org.apache.xerces.validators.datatype.IDREFDatatypeValidator;\nimport org.apache.xerces.validators.datatype.IDDatatypeValidator;\nimport org.apache.xerces.validators.datatype.StateMessageDatatype;\n\n\nimport org.xml.sax.ErrorHandler;\nimport org.xml.sax.SAXParseException;\nimport org.xml.sax.SAXException;\n\npublic class Test implements ErrorHandler {\n\n  static boolean workAround = false;\n  public void fatalError(SAXParseException ex) throws SAXException {throw ex;}\n  public void error(SAXParseException ex)  throws SAXException {throw ex;}\n  public void warning(SAXParseException ex) {}\n\n  public Test() {}\n  public void run() {\n    if(workAround) {\n      System.out.println(\"** Using workaround **\");\n    } else {\n      System.out.println(\"** Not using workaround **\");\n    }\n    System.out.println(\"parse test.xml\");\n    try {\n      SAXParser parser = new SAXParser();\n      parser.reset();\n      parser.setFeature(\"http://xml.org/sax/features/validation\",true);\n      parser.setErrorHandler(this);\n      parser.parse(\"test.xml\");\n    } catch (Exception ex) {\n      System.out.println(ex.getMessage());\n    }\n    System.out.println(\"parse test2.xml\");\n    if(workAround) {\n      resetIDREF_ID();\n    }\n    try {\n      SAXParser parser = new SAXParser();\n      parser.reset();\n      parser.setFeature(\"http://xml.org/sax/features/validation\",true);\n      parser.setErrorHandler(this);\n      parser.parse(\"test2.xml\");\n    } catch (Exception ex) {\n      System.out.println(ex.getMessage());\n    }\n  }\n\n  /* work around, use this between parser use */\n  private static void resetIDREF_ID() {\n    try {\n      IDREFDatatypeValidator idr = new IDREFDatatypeValidator();\n      idr.validate(null,\n        new StateMessageDatatype() {\n          public Object getDatatypeObject(){\n          return(Object) null;\n          }\n           public int    getDatatypeState(){\n             return IDREFDatatypeValidator.IDREF_CLEAR;\n          }\n          public void setDatatypeObject( Object data ){}\n        });\n      IDDatatypeValidator id = new IDDatatypeValidator();\n      id.validate(null,\n        new StateMessageDatatype() {\n          public Object getDatatypeObject(){\n            return(Object) null;\n          }\n           public int    getDatatypeState(){\n             return IDDatatypeValidator.ID_CLEAR;\n          }\n          public void setDatatypeObject( Object data ){}\n        });\n    } catch (Exception ex) {\n      System.out.println(\"Problem Clearing id/idref\");\n    }\n  }\n\n  public static void main(String [] args) {\n    workAround = false;\n    new Test().run();\n    workAround = true;\n    new Test().run();\n  }\n}\n\n\nsource dtd & docs\n\ntest.dtd\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n\n<!ELEMENT foo (bar) >\n<!ATTLIST foo \n  name ID #REQUIRED>\n\n<!ELEMENT bar EMPTY >\n<!ATTLIST bar\n\tname-ref IDREF #REQUIRED>\n\n\ntest.xml (creates id/idref error)\n\n<?xml version=\"1.0\" ?>\n<!DOCTYPE foo SYSTEM \"test.dtd\">\n<foo name=\"name1\">\n\t<bar name-ref=\"name2\"/>\n</foo>\n\ntest2.xml (should be ok)\n\n<?xml version=\"1.0\" ?>\n<!DOCTYPE foo SYSTEM \"test.dtd\">\n<foo name=\"name3\">\n\t<bar name-ref=\"name3\"/>\n</foo>", "id": 2996, "time": "2001-06-14T10:42:33Z", "creator": "lblanchette@grandcentral.com", "creation_time": "2001-06-14T10:42:33Z", "is_private": false}, {"count": 1, "tags": [], "creator": "elena@apache.org", "attachment_id": null, "id": 7316, "time": "2001-10-30T11:53:47Z", "bug_id": 2186, "creation_time": "2001-10-30T11:53:47Z", "is_private": false, "text": "The bug seemed to be fixed in the latest 1.4.3 Xerces-J release.\nThank you, for reporting the bug."}]