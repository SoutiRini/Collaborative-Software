[{"count": 0, "tags": [], "text": "Apache 2.4.6 with libapr 1.4.8 and libaprutil 1.5.2 running a bunch of proxy vhosts (some with proxy balancers) doing SSL encryption and decryption.  Using event MPM, on Linux kernel 3.11.0, 64 bit.\n\nThe child processes seem to segfault randomly (I don't know what triggers the segfaults).  Most of the backtraces point to apr_brigade_cleanup.\n\nHere's an example:\n\n#0  0x00007ff8f5e71b07 in apr_brigade_cleanup (data=0x7ff8ec35ca08) at buckets/apr_brigade.c:44\n#1  0x00007ff8f5c5348e in run_cleanups (cref=<optimized out>) at ../memory/unix/apr_pools.c:2352\n#2  apr_pool_destroy (pool=0x7ff8ec35b028) at ../memory/unix/apr_pools.c:814\n#3  0x00007ff8f65429ba in remove_empty_buckets (bb=0x7ff8ec3788f0) at core_filters.c:716\n#4  0x00007ff8f6543096 in setaside_remaining_output (f=0x7ff8ec378788, ctx=0x7ff8ec378850, bb=0x7ff8ec3788f0, c=<optimized out>) at core_filters.c:578\n#5  0x00007ff8f6543c45 in ap_core_output_filter (f=0x7ff8ec378788, new_bb=0x7ff8ec3788f0) at core_filters.c:562\n#6  0x00007ff8f655d86d in ap_process_request_after_handler (r=0x7ff8ec35b0a0) at http_request.c:256\n#7  0x00007ff8f655b170 in ap_process_http_async_connection (c=0x7ff8ec378330) at http_core.c:143\n#8  ap_process_http_connection (c=0x7ff8ec378330) at http_core.c:228\n#9  ap_process_http_connection (c=0x7ff8ec378330) at http_core.c:225\n#10 0x00007ff8f65519d8 in ap_run_process_connection (c=0x7ff8ec378330) at connection.c:41\n#11 0x00007ff8f277e820 in process_socket (my_thread_num=114, my_child_num=0, cs=0x7ff8ec3782b8, sock=0x7ff8ec3780b0, p=0x7ff8ec378028, thd=0x7ff8f0b87378) at event.c:964\n#12 worker_thread (thd=0x7ff8f0b87378, dummy=<optimized out>) at event.c:1812\n#13 0x00007ff8f5a24e9a in start_thread (arg=0x7ff8b2794700) at pthread_create.c:308\n#14 0x00007ff8f5751cbd in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:112\n#15 0x0000000000000000 in ?? ()\n\nIn this case, it seems that the error comes from inside the apr_bucket_delete macro, which (unwrapping the macros) calls APR_RING_NEXT(APR_RING_PREV(e, link), link) (apr-1.4.8/include/apr_ring.h:513), i.e., e->link.prev->link.next.  However:\n\n(gdb) p e->link.prev\n$2 = (struct apr_bucket * volatile) 0x0\n\nSo that's dereferencing a null pointer.\n\nInterestingly, we don't see any segfaults on a different Apache cluster with identical config (except for the vhosts, and the only differences there are the listening IPs, the proxy backends, and the SSL certificates).  The cluster which exhibits the issue consists of VMware VMs with 2 virtual cores and 6GB RAM, while the cluster where the issue doesn't happen consists of physical machines with 4 cores and 16GB of RAM.\n\nI would be happy to provide any additional info.", "attachment_id": null, "id": 172183, "creator": "avf@eldamar.org.uk", "time": "2014-01-08T14:54:45Z", "bug_id": 55979, "creation_time": "2014-01-08T14:54:45Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 55979, "attachment_id": null, "id": 172186, "time": "2014-01-08T15:58:41Z", "creator": "rpluem@apache.org", "creation_time": "2014-01-08T15:58:41Z", "is_private": false, "text": "Can you please check the patch found here:\nhttp://svn.apache.org/viewvc/httpd/httpd/branches/2.4.x/modules/proxy/mod_proxy_http.c?r1=1553540&r2=1553539&pathrev=1553540&view=patch\nand let us know if it fixes your issue?"}, {"count": 2, "tags": [], "text": "In case they fix it you hit PR50335", "is_private": false, "id": 172187, "creator": "rpluem@apache.org", "time": "2014-01-08T15:59:17Z", "bug_id": 55979, "creation_time": "2014-01-08T15:59:17Z", "attachment_id": null}, {"count": 3, "attachment_id": null, "creator": "avf@eldamar.org.uk", "is_private": false, "id": 172190, "time": "2014-01-08T16:40:54Z", "bug_id": 55979, "creation_time": "2014-01-08T16:40:54Z", "tags": [], "text": "I'll give it a go and report back tomorrow.  Thanks!"}, {"count": 4, "tags": [], "text": "Yes, the patch does seem to have fixed the problem.  Thanks!\n\n*** This bug has been marked as a duplicate of bug 50335 ***", "attachment_id": null, "bug_id": 55979, "id": 172202, "time": "2014-01-09T09:01:44Z", "creator": "avf@eldamar.org.uk", "creation_time": "2014-01-09T09:01:44Z", "is_private": false}]