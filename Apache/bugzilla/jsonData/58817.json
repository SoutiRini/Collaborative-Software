[{"attachment_id": 33415, "tags": [], "bug_id": 58817, "text": "Created attachment 33415\ncatalina.2016-01-07.log\n\nNoted when running a week old build of Tomcat 6 that used a different default value for mapperContextRootRedirectEnabled.\n\nSteps to reproduce with current Tomcat 6 trunk:\n1. Edit default conf/context.xml as\n<Context mapperContextRootRedirectEnabled=\"false\">\n\n2. Run\ncatalina.bat start\ncatalina.bat stop\n\n3. Tomcat shuts down successfully (immediately), but catalina.2016-01-07.log contains 2 copies of the following message:\n\n07.01.2016 4:50:30 org.apache.catalina.connector.MapperListener handleNotification\nWARNING: Error unregistering webapp Catalina:j2eeType=WebModule,name=//localhost/,J2EEApplication=none,J2EEServer=none\njava.lang.ArrayIndexOutOfBoundsException: -1\n\tat org.apache.tomcat.util.http.mapper.Mapper.internalMapWrapper(Mapper.java:769)\n\tat org.apache.tomcat.util.http.mapper.Mapper.internalMap(Mapper.java:691)\n\tat org.apache.tomcat.util.http.mapper.Mapper.map(Mapper.java:577)\n\tat org.apache.catalina.connector.MapperListener.unregisterContext(MapperListener.java:481)\n\n\nSee attached log file for details.", "count": 0, "id": 187449, "time": "2016-01-07T01:53:47Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2016-01-07T01:53:47Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 58817, "attachment_id": null, "id": 187450, "time": "2016-01-07T01:58:32Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2016-01-07T01:58:32Z", "is_private": false, "text": "Only Tomcat 6 is affected.\nI tested current 7/8/9 trunks and they shut down cleanly in this configuration."}, {"count": 2, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": null, "text": "Observations\n--------------\n1. Comparing Mapper.internalMapWrapper() implementations between Tomcat 6 and Tomcat 7, they are not very different.\n\nThe only substantial difference is a missing block of code in Tomcat 6 (-- the code block just above \"Rule 7\". In Tomcat 7 it is commented as \"/* welcome file processing - take 2\"),  but it does not matter for this bug. It fails earlier.\n\n2. MapperListener implementations are quite different. In Tomcat 7 it is a LifecycleListener, and has a reference to Context that is the cause of the event.\n\nIn Tomcat 6 it is a NotificationListener and this feature is triggered by unregistration of a JMX MBean. - See stacktrace attached in Description (Comment 0) of this bug.\n\nAs NotificationListener in Tomcat 6 does not have a reference to Context, it uses Mapper to get one, simulating a request with (host name = hostName, uri = contextName).\n\nFor ROOT context the uri becomes \"\", and the failure happens.\n\n3. A similar call to Mapper.map() is used in Tomcat 7 and later to implement ApplicationContext.getContext(uri). There is a check in that method that uri.startsWith(\"/\"), so it does not use an empty URI.\n\nConclusion\n-----------\n- NotificationListener of Tomcat 6 is the only place in Tomcat 6/7/8/9 that calls Mapper.map() with an empty string as URI. While it is possible to improve Mapper, I think it is sufficient to add workaround to NotificationListener to use a valid URI (\"/\") in this case.", "id": 188088, "time": "2016-01-31T17:45:48Z", "bug_id": 58817, "creation_time": "2016-01-31T17:45:48Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "knst.kolinko@gmail.com", "text": "Fixed in Tomcat 6 by r1727846 and will be in 6.0.45 onwards.", "count": 3, "id": 188090, "time": "2016-01-31T18:04:05Z", "bug_id": 58817, "creation_time": "2016-01-31T18:04:05Z", "is_private": false}]