[{"count": 0, "attachment_id": null, "bug_id": 31210, "is_private": false, "id": 63508, "time": "2004-09-14T03:10:35Z", "creator": "bugzilla-apache@queso.com", "creation_time": "2004-09-14T03:10:35Z", "tags": [], "text": "I seem to have discovered what I think is a bug in the interaction between\nmod_dir and mod_rewrite (at least as it functions on a per-directory basis)\ntoday.  It didn't exist on my old installation (1.3.27); when I moved a site\nover to my new installation (2.0.50), the bug reared its head.\n\nSay that you have a server with two files and a directory in its DocumentRoot,\nindex.php, stuff.txt, and /stuff.  One function of index.php is to include the\ntext of a file passed in as the query string -- e.g., /index.php?stuff.txt would\ninclude the text of the file stuff.txt.  Now, say that the following .htaccess\nfile existed:\n\nRewriteEngine on\nRewriteRule ^(stuff)$ /index.php?$1.txt [L]\n\nwhich served to allow people to shorten URLs; instead of /index.php?stuff.txt,\nthat would allow them to type /stuff and have the rewriting take place internal\nto httpd.\n\nThe problem here is that there's *also* a directory named /stuff, and while\nmod_rewrite sees a match with the URI \"/stuff\", mod_dir sees a potential\ndirectory name expansion from \"/stuff\" to \"/stuff/\".  And the way that it all\ncomes together is just broken -- the end result is \"/stuff/?stuff.txt\", which is\n just wrong.\n\nThe relevant directory definition in my httpd.conf file is:\n\n<Directory (DocumentRoot directory)>\n        Options FollowSymLinks\n        RewriteEngine on\n        AllowOverride FileInfo AuthConfig Limit Indexes\n</Directory>\n\nThe virtual host definition is:\n\n<VirtualHost 204.193.152.163>\n        ServerName rewritetest.queso.org\n        DocumentRoot (DocumentRoot directory)\n        CustomLog logs/rewrite-access_log combined\n        ErrorLog logs/rewrite-error_log\n        DirectoryIndex index.php\n        RewriteEngine on\n        SuexecUserGroup rewrite rewrite\n</VirtualHost>\n\nThere aren't any other directives in the httpd.conf file that would affect the\nbehavior of the host; the order that the LoadModule statements is that mod_dir\nis loaded before mod_rewrite.  (While I know that the new API structure is\nsupposed to make it meaningless what order they are loaded, I also know that\nthere have been a few edge cases in Bugzilla that showed that it can matter at\ntimes.)\n\nI've put together a test website that shows the problem -- it's (shockingly)\nlocated at http://rewritetest.queso.org/, and there's a slightly more\nfleshed-out example there, along with all the relevant sources and log files.\n\nAm I right that this is a bug, or is there something I'm missing in how one\nconfigures mod_rewrite and/or mod_dir?"}, {"count": 1, "tags": [], "bug_id": 31210, "attachment_id": null, "text": "mod_rewrite gets the first stab at processing the request. If we look at the\nrules described in the bug report, mod_rewrite first changes the URI \"/stuff\"\ninto two parts: the base URI \"/index.php\" and the arguments \"stuff.txt\".\nmod_rewrite can glue these back together, but the component parts are stored in\nthe request object.\n\nWhat looks like is happening is that \"/stuff\" gets left as the URI, the file\ngets set to \"/index.php\", and the arguments get set to \"stuff.txt\". This\nstructure gets passed to mod_dir, which adds a slash to the URI and glues on the\nargument resulting in an external redirect of \"/stuff/?stuff.txt\".\n\nBased on the documentation, I believe this is the correct behavior even if it is\nneither desirable nor intuitive.  I believe that the way to not encounter this\nbehavior would be to set the passthrough flag. If PT is set, \"/index.php\" should\nreplace \"/stuff\" as the request URI, and the argument \"stuff.txt\" still is added\nto the URI.\n\nUnfortunately, it looks like PT does not work with a per-directory\nconfiguration. The workaround is to move the rewrite directive from the\n.htaccess or <location> config locations and to a server location. \n\nThis comment from the source of mod_rewrite.c is interesting:\n> /* if someone used the PASSTHROUGH flag in per-dir\n> * context we just ignore it. It is only useful\n> * in per-server context\n> */\nI think this behavior is could be a bug in mod_rewrite. Alternatively, this\nbehavior should be documented outside of the source code.", "id": 63541, "time": "2004-09-14T18:59:28Z", "creator": "samg@unhinged.org", "creation_time": "2004-09-14T18:59:28Z", "is_private": false}, {"count": 2, "tags": [], "creator": "bobsiegen@googlemail.com", "is_private": false, "text": "\n\n*** This bug has been marked as a duplicate of bug 40373 ***", "id": 123276, "time": "2008-12-13T14:12:52Z", "bug_id": 31210, "creation_time": "2008-12-13T14:12:52Z", "attachment_id": null}]