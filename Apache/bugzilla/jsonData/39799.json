[{"count": 0, "tags": [], "text": "We are trying to use Apache 2.2.2 with mod_cache and mod_mem_cache as a reverse\nproxy server to reduce disk load on a main server, caching files in memory. But\nit doesn't appear to cache the files. If I use mod_disk_cache instead of\nmod_mem_cache, the files are cached correctly.\n\nHere is the httpd.conf file:\n\nServerRoot /usr/local/apache2.2\nListen 80\nServerAdmin systems@rightmove.co.uk\nServerName media.rightmove.co.uk\nDocumentRoot \"/usr/local/apache2.2/htdocs\"\n<Directory />\n    Options FollowSymLinks\n    AllowOverride None\n    Order deny,allow\n    Deny from all\n</Directory>\n<Directory \"/usr/local/apache2.2/htdocs\">\n    Options Indexes FollowSymLinks\n    AllowOverride None\n    Order allow,deny\n    Allow from all\n</Directory>\n<FilesMatch \"^\\.ht\">\n    Order allow,deny\n    Deny from all\n    Satisfy All\n</FilesMatch>\n\nErrorLog logs/error_log\nLogLevel debug\n<IfModule log_config_module>\n    LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b\" common\n    CustomLog logs/access_log common\n</IfModule>\n\nUser nobody\nGroup nobody\n\nDefaultType text/plain\n<IfModule mime_module>\n    TypesConfig conf/mime.types\n    AddType application/x-compress .Z\n    AddType application/x-gzip .gz .tgz\n</IfModule>\n\n#Include conf/extra/httpd-mpm.conf\n\nProxyRequests Off\nProxyPass / http://h1-img.rightmove.com/\nProxyPassReverse / http://h1-img.rightmove.com/\nProxyPreserveHost On\n\nCacheEnable mem /\n#CacheEnable disk /\nCacheDefaultExpire 3600\nCacheLastModifiedFactor 0.05\nCacheMaxExpire 3600\nCacheIgnoreCacheControl On\nCacheIgnoreNoLastMod On\n\nCacheMaxFileSize 8192\nCacheRoot /export/home/apache/cache\n\nMCacheMaxObjectSize 8192\nMCacheMaxObjectCount 1000000\nMCacheRemovalAlgorithm GDSF\nMCacheSize 1000000\n\nUseCanonicalName Off\n\nStartServers       10\nServerLimit        100\nMaxClients         100\nMaxRequestsPerChild  0\n\n\nHere are the HTTP headers from the first attempt to load a file (via telnet to\nport 80):\n\n# telnet h1-cache 80\nTrying 10.6.3.5...\nConnected to h1-cache.rightmove.com.\nEscape character is '^]'.\nGET /14k/13115/13115_419067A_19067_IMG_00_t.JPG HTTP/1.1\nHost:media.rightmove.co.uk\n\nHTTP/1.1 200 OK\nDate: Tue, 13 Jun 2006 12:29:11 GMT\nServer: Apache/1.3.29 (Unix)\nLast-Modified: Sun, 28 May 2006 09:39:03 GMT\nETag: \"f4ac4-d92-44796fb7\"\nAccept-Ranges: bytes\nContent-Length: 3474\nContent-Type: image/jpeg\nExpires: Tue, 13 Jun 2006 13:29:12 GMT\n\nHere are the HTTP headers from a second load of the same file:\n\n# telnet h1-cache 80\nTrying 10.6.3.5...\nConnected to h1-cache.rightmove.com.\nEscape character is '^]'.\nGET /14k/13115/13115_419067A_19067_IMG_00_t.JPG HTTP/1.1\nHost:media.rightmove.co.uk\n\nHTTP/1.1 200 OK\nDate: Tue, 13 Jun 2006 12:29:52 GMT\nServer: Apache/1.3.29 (Unix)\nLast-Modified: Sun, 28 May 2006 09:39:03 GMT\nETag: \"f4ac4-d92-44796fb7\"\nAccept-Ranges: bytes\nContent-Length: 3474\nContent-Type: image/jpeg\nExpires: Tue, 13 Jun 2006 13:29:52 GMT\n\n\nHere are the error_log entries (note that log level is set to DEBUG):\n\n[Tue Jun 13 13:29:12 2006] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /14k/13115/13115_419067A_19067_IMG_00_t.JPG\n[Tue Jun 13 13:29:12 2006] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /14k/13115/13115_419067A_19067_IMG_00_t.JPG\n[Tue Jun 13 13:29:12 2006] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //h1-img.rightmove.com/14k/13115/13115_419067A_19067_IMG_00_t.JPG\n[Tue Jun 13 13:29:12 2006] [debug] proxy_util.c(1378): [client 10.6.3.3] proxy:\nhttp: found worker http://h1-img.rightmove.com/ for\nhttp://h1-img.rightmove.com/14k/13115/13115_419067A_19067_IMG_00_t.JPG\n[Tue Jun 13 13:29:12 2006] [debug] mod_proxy.c(756): Running scheme http handler\n(attempt 0)\n[Tue Jun 13 13:29:12 2006] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://h1-img.rightmove.com/14k/13115/13115_419067A_19067_IMG_00_t.JPG\n[Tue Jun 13 13:29:12 2006] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (h1-img.rightmove.com)\n[Tue Jun 13 13:29:12 2006] [debug] proxy_util.c(1858): proxy: connecting\nhttp://h1-img.rightmove.com/14k/13115/13115_419067A_19067_IMG_00_t.JPG to\nh1-img.rightmove.com:80\n[Tue Jun 13 13:29:12 2006] [debug] proxy_util.c(1951): proxy: connected\n/14k/13115/13115_419067A_19067_IMG_00_t.JPG to h1-img.rightmove.com:80\n[Tue Jun 13 13:29:12 2006] [debug] proxy_util.c(2045): proxy: HTTP: fam 2 socket\ncreated to connect to h1-img.rightmove.com\n[Tue Jun 13 13:29:12 2006] [debug] proxy_util.c(2141): proxy: HTTP: connection\ncomplete to 10.6.3.1:80 (h1-img.rightmove.com)\n[Tue Jun 13 13:29:12 2006] [debug] mod_proxy_http.c(1448): proxy: start body send\n[Tue Jun 13 13:29:12 2006] [debug] mod_cache.c(602): cache: Caching url:\n/14k/13115/13115_419067A_19067_IMG_00_t.JPG\n[Tue Jun 13 13:29:12 2006] [debug] mod_cache.c(608): cache: Removing\nCACHE_REMOVE_URL filter.\n[Tue Jun 13 13:29:12 2006] [info] mem_cache: Cached url:\nhttp://media.rightmove.co.uk:80/14k/13115/13115_419067A_19067_IMG_00_t.JPG?\n[Tue Jun 13 13:29:12 2006] [debug] mod_proxy_http.c(1537): proxy: end body send\n[Tue Jun 13 13:29:12 2006] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (h1-img.rightmove.com)\n[Tue Jun 13 13:29:52 2006] [debug] mod_cache.c(129): Adding CACHE_SAVE filter\nfor /14k/13115/13115_419067A_19067_IMG_00_t.JPG\n[Tue Jun 13 13:29:52 2006] [debug] mod_cache.c(136): Adding CACHE_REMOVE_URL\nfilter for /14k/13115/13115_419067A_19067_IMG_00_t.JPG\n[Tue Jun 13 13:29:52 2006] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //h1-img.rightmove.com/14k/13115/13115_419067A_19067_IMG_00_t.JPG\n[Tue Jun 13 13:29:52 2006] [debug] proxy_util.c(1378): [client 10.6.3.3] proxy:\nhttp: found worker http://h1-img.rightmove.com/ for\nhttp://h1-img.rightmove.com/14k/13115/13115_419067A_19067_IMG_00_t.JPG\n[Tue Jun 13 13:29:52 2006] [debug] mod_proxy.c(756): Running scheme http handler\n(attempt 0)\n[Tue Jun 13 13:29:52 2006] [debug] mod_proxy_http.c(1662): proxy: HTTP: serving\nURL http://h1-img.rightmove.com/14k/13115/13115_419067A_19067_IMG_00_t.JPG\n[Tue Jun 13 13:29:52 2006] [debug] proxy_util.c(1798): proxy: HTTP: has acquired\nconnection for (h1-img.rightmove.com)\n[Tue Jun 13 13:29:52 2006] [debug] proxy_util.c(1858): proxy: connecting\nhttp://h1-img.rightmove.com/14k/13115/13115_419067A_19067_IMG_00_t.JPG to\nh1-img.rightmove.com:80\n[Tue Jun 13 13:29:52 2006] [debug] proxy_util.c(1951): proxy: connected\n/14k/13115/13115_419067A_19067_IMG_00_t.JPG to h1-img.rightmove.com:80\n[Tue Jun 13 13:29:52 2006] [debug] proxy_util.c(2045): proxy: HTTP: fam 2 socket\ncreated to connect to h1-img.rightmove.com\n[Tue Jun 13 13:29:52 2006] [debug] proxy_util.c(2141): proxy: HTTP: connection\ncomplete to 10.6.3.1:80 (h1-img.rightmove.com)\n[Tue Jun 13 13:29:52 2006] [debug] mod_proxy_http.c(1448): proxy: start body send\n[Tue Jun 13 13:29:52 2006] [debug] mod_cache.c(602): cache: Caching url:\n/14k/13115/13115_419067A_19067_IMG_00_t.JPG\n[Tue Jun 13 13:29:52 2006] [debug] mod_cache.c(608): cache: Removing\nCACHE_REMOVE_URL filter.\n[Tue Jun 13 13:29:52 2006] [info] mem_cache: Cached url:\nhttp://media.rightmove.co.uk:80/14k/13115/13115_419067A_19067_IMG_00_t.JPG?\n[Tue Jun 13 13:29:52 2006] [debug] mod_proxy_http.c(1537): proxy: end body send\n[Tue Jun 13 13:29:52 2006] [debug] proxy_util.c(1816): proxy: HTTP: has released\nconnection for (h1-img.rightmove.com)", "is_private": false, "id": 90134, "creator": "mike.scott@rightmove.co.uk", "time": "2006-06-13T12:33:50Z", "bug_id": 39799, "creation_time": "2006-06-13T12:33:50Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "is_private": false, "id": 90143, "time": "2006-06-13T15:16:03Z", "bug_id": 39799, "creation_time": "2006-06-13T15:16:03Z", "text": "Please keep in mind that each process of httpd has its own mem_cache (=>\nmod_mem_cache gets more and more effective with worker MPM and a high number of\nthreads per process and a low number of processes). So I guess your second\nrequest got to another httpd process. Please repeat the same with a keepalive\nconnection (so only one telnet call) which ensures that you are connected to the\nsame httpd process:\n\ntelnet h1-cache 80\nGET /14k/13115/13115_419067A_19067_IMG_00_t.JPG HTTP/1.1\nHost: media.rightmove.co.uk\n\n<Some output>\n\nGET /14k/13115/13115_419067A_19067_IMG_00_t.JPG HTTP/1.1\nHost: media.rightmove.co.uk\n"}, {"count": 2, "tags": [], "bug_id": 39799, "attachment_id": null, "text": "(In reply to comment #1)\n> Please keep in mind that each process of httpd has its own mem_cache (=>\n> mod_mem_cache gets more and more effective with worker MPM and a high number of\n> threads per process and a low number of processes). So I guess your second\n> request got to another httpd process. Please repeat the same with a keepalive\n> connection (so only one telnet call) which ensures that you are connected to the\n> same httpd process:\n\nThank you, this explains it completely. This is therefore a documentation error\nrather than a code error, since there is no mention that I can see of this\nrather important point at http://httpd.apache.org/docs/2.2/mod/mod_mem_cache.html\n\nMeanwhile, I've got it working properly using the worker MPM with a single\nprocess and 3000 threads -- which seems to be performing OK on Solaris.\n", "id": 90202, "time": "2006-06-14T14:04:29Z", "creator": "mike.scott@rightmove.co.uk", "creation_time": "2006-06-14T14:04:29Z", "is_private": false}, {"count": 3, "tags": [], "creator": "nick@webthing.com", "attachment_id": null, "is_private": false, "id": 116659, "time": "2008-05-15T09:58:39Z", "bug_id": 39799, "creation_time": "2008-05-15T09:58:39Z", "text": "Added a brief note to the docs.  Should show up in next release, and soon at the website."}]