[{"count": 0, "tags": [], "bug_id": 37516, "is_private": false, "text": "I'm getting a committed HttpServletResponse object in my doGet() without \nexecuting any command that could change its state to committed. Some of the \ntimes this error has occurred I noticed that the response was committed even \nbefore the first command in the doGet method. I don't get this behavior on Sun \nJava System Application Server 8.1. I got this behavior on Tomcat 5.5.7, \n5.5.9, 5.5.12 both on Windows XP and Linux (Fedora 2).\n\nI'm sending a brief code to simulate this error (two servlets and the \ndescriptor. Please note that in order to test this code you may have to change \nthe port number in the HTML generated in Test.java. Also, the generated page \nuses a HTML Header to automatically refreshs the page every second to spare \nthe person who's testing to press F5. But one can erase this Refresh-Header \nand do the refreshs by pressing F5 and after some refreshs the error will \noccur).\n\n//*********** web.xml ***************\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<web-app version=\"2.4\" xmlns=\"http://java.sun.com/xml/ns/j2ee\" \nxmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" \nxsi:schemaLocation=\"http://java.sun.com/xml/ns/j2ee \nhttp://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd\">\n  <servlet>\n    <servlet-name>Test</servlet-name>\n    <servlet-class>Test</servlet-class>\n  </servlet>\n  <servlet>\n    <servlet-name>Image</servlet-name>\n    <servlet-class>Image</servlet-class>\n  </servlet>\n  <servlet-mapping>\n    <servlet-name>Test</servlet-name>\n    <url-pattern>/test</url-pattern>\n  </servlet-mapping>\n  <servlet-mapping>\n    <servlet-name>Image</servlet-name>\n    <url-pattern>*.jpg</url-pattern>\n  </servlet-mapping>\n  <session-config>\n    <session-timeout>\n            30\n        </session-timeout>\n  </session-config>\n</web-app>\n\n\n\n// ******************* Test.java ***********************************\n// Note: if you use a port number other than 8080 please change the line \nout.println(\"<img alt=\\\"image\\\" src=\\\"http://localhost:8080/... in Test.java\n\nimport java.io.*;\nimport java.net.*;\n \nimport javax.servlet.*;\nimport javax.servlet.http.*;\n \n/**\n *\n * @author Adriano\n * @version\n */\npublic class Test extends HttpServlet {\n    \n    protected void processRequest(HttpServletRequest request, \nHttpServletResponse response)\n    throws ServletException, IOException {\n        if (response.isCommitted()) {\n            System.out.println(\"Response is committed in Test.processRequest\");\n        }\n        \n        response.setContentType(\"text/html;charset=UTF-8\");\n        PrintWriter out = response.getWriter();\n        out.println(\"<html>\");\n        out.println(\"<head>\");\n        out.println(\"<meta http-equiv=\\\"Refresh\\\" content=\\\"1\\\">\");\n        out.println(\"<title>Servlet Test</title>\");\n        out.println(\"</head>\");\n        out.println(\"<body>\");\n        out.println(\"<img alt=\\\"image\\\" \nsrc=\\\"http://localhost:8080/BugTest/image.jpg\\\"\");\n        out.println(\"</body>\");\n        out.println(\"</html>\");\n        out.close();\n    }\n    \n    protected void doGet(HttpServletRequest request, HttpServletResponse \nresponse)\n    throws ServletException, IOException {\n        processRequest(request, response);\n    }\n    \n    protected void doPost(HttpServletRequest request, HttpServletResponse \nresponse)\n    throws ServletException, IOException {\n        processRequest(request, response);\n    }\n}\n\n\n//******************************* Image.java *************************\n \nimport java.awt.Font;\nimport java.awt.Graphics2D;\nimport java.awt.image.BufferedImage;\nimport java.io.*;\nimport java.util.Iterator;\nimport javax.imageio.ImageIO;\nimport javax.imageio.ImageWriter;\nimport javax.imageio.stream.ImageOutputStream;\n \nimport javax.servlet.*;\nimport javax.servlet.http.*;\n \n/**\n *\n * @author Adriano\n * @version\n */\npublic class Image extends HttpServlet {\n    \n    protected void processRequest(HttpServletRequest request, \nHttpServletResponse response)\n    throws ServletException, IOException {\n        \n        if (response.isCommitted()) {\n            System.out.println(\"Response is committed in \nImage.processRequest\");\n        }\n        \n        response.setContentType(\"image/jpg\");\n        response.setBufferSize(8192);\n        \n        OutputStream out = response.getOutputStream();\n        \n        //Generates an image\n        BufferedImage image = new BufferedImage(100, 100, \nBufferedImage.TYPE_INT_RGB);\n        Graphics2D graphics = image.createGraphics();\n        Font font = new Font(\"Arial\", Font.BOLD, 20);\n        graphics.setFont(font);\n        graphics.drawString(\"Test\", 20, 20);\n        Iterator writers = ImageIO.getImageWritersByFormatName(\"jpg\");\n        ImageWriter writer = (ImageWriter)writers.next();\n        ImageOutputStream imageOutput = ImageIO.createImageOutputStream(out);\n        writer.setOutput(imageOutput);\n        writer.write(image);\n        writer.dispose();\n        \n        out.close();\n        \n        response.flushBuffer();\n    }\n    \n    protected void doGet(HttpServletRequest request, HttpServletResponse \nresponse)\n    throws ServletException, IOException {\n        processRequest(request, response);\n    }\n    \n    protected void doPost(HttpServletRequest request, HttpServletResponse \nresponse)\n    throws ServletException, IOException {\n        processRequest(request, response);\n    }\n    \n}", "id": 82535, "time": "2005-11-16T00:07:24Z", "creator": "nobreadriano@yahoo.ca", "creation_time": "2005-11-16T00:07:24Z", "attachment_id": null}, {"text": "I looked at that issue in the past, and Java2D accesses the streams outside of\nthe service methods.", "tags": [], "bug_id": 37516, "is_private": false, "count": 1, "id": 82597, "time": "2005-11-16T21:59:13Z", "creator": "remm@apache.org", "creation_time": "2005-11-16T21:59:13Z", "attachment_id": null}]