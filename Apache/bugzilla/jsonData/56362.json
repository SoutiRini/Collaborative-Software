[{"count": 0, "tags": [], "creator": "aikishugyo@gmail.com", "text": "Hello all,\nThis is my first bug report here, so please be kind if I am missing some simple information I should check first, apart from searches for similar bugs.\n\nI am trying to figure out how to force mod_authnz_ldap to use a non-standard port for an LDAPS connection using ldaps://<server>:<port>/....\n\nAt present we simply get an Internal Error (500) in the browser and the following type of message in the logs, with no packets at all detected with tcpdump:\n[LDAP: ldap_simple_bind_s() failed][Can't contact LDAP server]\n\nDetails below.\n\n\nBackground\n----------\n\nAt our company, we use CentOS5 and CentOS6 for LDAP gateway servers. These servers run httpd with mod_authnz_ldap set up to connect to customers' LDAP and AD servers.\n\nCentOS5:\nopenssl: 0.9.8e-22.el5_8.4\nopenldap: 2.3.43-25.el5_8.1\nhttpd: 2.2.3-76.el5.centos\n\nCentOS6:\nopenssl: 1.0.1e-16.el6_5.4\nopenldap: 2.4.23-34.el6_5.1\nhttpd: 2.2.15-29.el6.centos\n\n\nIn the past, there had been problems with mutually-exclusive mod_ldap settings needed to get either non-SSL (standard port 389 or non-standard ports) or SSL (on standard port 636) to work with mod_authnz_ldap (either \"LDAPTrustedMode SSL\" or \"LDAPTrustedMode None\" required), so we have two types of setup based on that.\n\nWe have successfully used the non-SSL URI (LDAP) with non-standard ports, as in this snippet for an AD server connection:\n\n<AuthnProviderAlias ldap ldapservice1>\nAuthLDAPBindDN \"cn=...,ou=...,dc=...,dc=...\"\nAuthLDAPBindPassword \"...\"\nAuthLDAPURL \"ldap://<serverIP1>:<port>,<serverIP2>:<port>/ou=...,dc=...,dc=...?sAMAccountName\"\n</AuthnProviderAlias>\n\nHowever, similar configuration with SSL ignores the specified port and instead defaults to port 636:\n\n<AuthnProviderAlias ldap ldapservice1>\nAuthLDAPBindDN \"cn=...,ou=...,dc=...,dc=...\"\nAuthLDAPBindPassword \"...\"\nAuthLDAPURL \"ldaps://<serverIP1>:<port>,<serverIP2>:<port>/ou=...,dc=...,dc=...?sAMAccountName\"\n</AuthnProviderAlias>\n\n\nldapsearch\n----------\n\nldapsearch works perfectly well using -H ldaps://<server>:<port>... for a non-standard port for both LDAP and LDAPS, so the /etc/openldap/ldap.conf file seems to be in order. The only change from default is the addition of the following line to permit connection to AD server without certificate verification (sidenote: we did use openssl to verify that the chain has no problems):\nTLS_REQCERT never\n\n\nProblem with non-standard port for ldaps URI\n--------------------------------------------\n\nWhen using ldaps://<server>:<port> syntax, the module still insists on using port 636.\n\nFor my mod_ldap settings I have made sure to turn off the extension LDAPTrustedMode, since it defaults to port 636 if set to \"SSL\". I also have the local CA authority certificate available (although usually it is simple to test that the LDAP server queries works with \"LDAPVerifyServerCert off\")\n\nUse of tcpdump shows no packets at all, but as soon as port is set to 636, or left out entirely, then packets are shown and the connection works.\n\n\nHere is the complete general configuration of mod_authnz_ldap:\n\nLDAPSharedCacheSize 500000\nLDAPCacheEntries 1024\nLDAPCacheTTL 600\nLDAPOpCacheEntries 1024\nLDAPOpCacheTTL 600\n\nLDAPTrustedGlobalCert CA_BASE64 /etc/ssl/certs/<ADserverCAcert>.pem\nLDAPVerifyServerCert on\n#LDAPTrustedMode SSL\n#LDAPTrustedMode NONE\n\nLDAPConnectionTimeout 1\n\n\nHere the configuration of the directory to be protected:\n\n<Directory \"/var/www/protecteddir\">\n  # from mod_auth_basic:\n  AuthType basic\n  AuthName \"privateauth user authentication\"\n  AuthBasicProvider ldap\n  # from mod_authnz_ldap:\n  AuthzLDAPAuthoritative off\n  AuthLDAPBindDN \"cn=...,ou=...,dc=...,dc=...\"\n  AuthLDAPBindPassword RoSYS302\n  AuthLDAPURL\nldaps://<server>:50001/ou=...,ou=...,dc=...,dc=...,dc=...?sAMAccountName?sub?(objectClass=person)\n  Require valid-user\n</Directory>\n\nIs this a configuration bug (LDAP settings forcing a default somewhere?), a misconfiguration of mod_authnz_ldap, or a bug?\n\nAny hints or advice much appreciated.\nRegards,\nGernot Hassenpflug\n-- \nASAHI Net, Inc.\nTokyo, Japan", "id": 174361, "time": "2014-04-08T06:48:47Z", "bug_id": 56362, "creation_time": "2014-04-08T06:48:47Z", "is_private": false, "attachment_id": null}]