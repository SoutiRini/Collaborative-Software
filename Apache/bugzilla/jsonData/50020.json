[{"count": 0, "tags": [], "creator": "sjk1471@yahoo.com", "attachment_id": null, "text": "Add a cell drop-down (using a formula list constraint) in a worksheet where there is already a macro attached.\n\nExpected result:\nThe chosen cell has a validation list applied to it.\n\nActual result:\nIllegalStateException occurs.\n\nStack trace:\nException in thread \"main\" java.lang.IllegalStateException: Unexpected (org.apache.poi.hssf.record.UnknownRecord) while looking for DV Table insert pos\n\tat org.apache.poi.hssf.model.RecordOrderer.findDataValidationTableInsertPos(RecordOrderer.java:310)\n\tat org.apache.poi.hssf.model.RecordOrderer.findSheetInsertPos(RecordOrderer.java:98)\n\tat org.apache.poi.hssf.model.RecordOrderer.addNewSheetRecord(RecordOrderer.java:92)\n\tat org.apache.poi.hssf.model.Sheet.getOrCreateDataValidityTable(Sheet.java:1579)\n\tat org.apache.poi.hssf.usermodel.HSSFSheet.addValidationData(HSSFSheet.java:364)\n\tat com.du.sjk.scrap.POIBug.main(POIBug.java:42)\n\n\nCode to reproduce:\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.IOException;\n\nimport org.apache.poi.hssf.usermodel.DVConstraint;\nimport org.apache.poi.hssf.usermodel.HSSFCell;\nimport org.apache.poi.hssf.usermodel.HSSFDataValidation;\nimport org.apache.poi.hssf.usermodel.HSSFName;\nimport org.apache.poi.hssf.usermodel.HSSFSheet;\nimport org.apache.poi.hssf.usermodel.HSSFWorkbook;\nimport org.apache.poi.ss.util.CellRangeAddressList;\n\npublic class POIBug\n{\n    /**\n     * filename which points to any existing .xls file with \n     * a macro attached to the first sheet.\n     */\n    private static String filename = \"C:\\\\scrap\\\\test.xls\";\n\n\n    public static void main(String[] args)\n    {\n        try {\n            HSSFWorkbook wb = new HSSFWorkbook(new FileInputStream(filename));\n            HSSFSheet sheet = wb.getSheetAt(0);\n            HSSFCell cell;\n            for (int i = 0; i < 5; i++) {\n                cell = sheet.createRow(i).createCell(0);\n                cell.setCellType(HSSFCell.CELL_TYPE_NUMERIC);\n                cell.setCellValue(i);\n            }\n\n            HSSFName nameObj = wb.createName();\n            nameObj.setNameName(\"list\");\n            nameObj.setRefersToFormula(\"$A$1:$A$6\");\n\n            cell = sheet.createRow(6).createCell(0);\n\n            HSSFDataValidation dataValidation = new HSSFDataValidation(\n                new CellRangeAddressList(6, 6, 0, 0), \n                DVConstraint.createFormulaListConstraint(\"list\")\n             );\n            cell.getSheet().addValidationData(dataValidation);\n\n            wb.write(new FileOutputStream(\"C:\\\\scrap\\\\out.xls\"));\n        }\n\n        catch (IOException e) {\n            e.printStackTrace();\n        }\n    }\n}\n\nBuild where bug occurred: poi-3.6-20091214", "id": 140271, "time": "2010-09-28T11:43:01Z", "bug_id": 50020, "creation_time": "2010-09-28T11:43:01Z", "is_private": false}, {"count": 1, "tags": [], "creator": "sjk1471@yahoo.com", "attachment_id": null, "text": "This bug occurs with the simplest of macros. Here is the VB Macro I used to reproduce this (added in first sheet but infact can be on any sheet or in separate 'module'):\n\nSub AnyOldMacro()\n    MsgBox \"Oh Hi!\"\nEnd Sub", "id": 140272, "time": "2010-09-28T12:35:34Z", "bug_id": 50020, "creation_time": "2010-09-28T12:35:34Z", "is_private": false}, {"text": "Fixed in r1004143, junit added\n\nYegor", "tags": [], "creator": "yegor@dinom.ru", "attachment_id": null, "count": 2, "id": 140425, "time": "2010-10-04T04:47:42Z", "bug_id": 50020, "creation_time": "2010-10-04T04:47:42Z", "is_private": false}]