[{"count": 0, "attachment_id": null, "creator": "john.haan@chello.nl", "is_private": false, "id": 133104, "time": "2009-12-23T17:19:16Z", "bug_id": 48441, "creation_time": "2009-12-23T17:19:16Z", "tags": [], "text": "it has come to my attention, that mod_cache automatically adds CACHE_SAVE and CACHE_REMOVE_URL filters when a request is made towards a URL ending in '/' (i.e. http://www.site.com/page/). There is no check whatsoever; the content is cached automatically and hence not served from the cache. Here are some log entries relevant to my problem:\n\n[Thu Dec 24 02:01:34 2009] [debug] mod_cache.c(131): Adding CACHE_SAVE filter for /energie/\n[Thu Dec 24 02:01:34 2009] [debug] mod_cache.c(138): Adding CACHE_REMOVE_URL filter for /energie/\n[Thu Dec 24 02:01:34 2009] [debug] mod_cache.c(131): Adding CACHE_SAVE filter for /index.php/energie/cache\n[Thu Dec 24 02:01:34 2009] [debug] mod_cache.c(138): Adding CACHE_REMOVE_URL filter for /index.php/energie/cache\n[Thu Dec 24 02:01:34 2009] [debug] mod_headers.c(743): headers: ap_headers_output_filter()\n[Thu Dec 24 02:01:34 2009] [debug] mod_cache.c(663): cache: Caching url: /index.php/energie/cache\n[Thu Dec 24 02:01:34 2009] [debug] mod_cache.c(669): cache: Removing CACHE_REMOVE_URL filter.\n[Thu Dec 24 02:01:34 2009] [debug] mod_disk_cache.c(977): disk_cache: Stored headers for URL http://www.mysite.com:80/index.php/energie/cache?\n[Thu Dec 24 02:01:34 2009] [debug] mod_disk_cache.c(1066): disk_cache: Body for URL http://www.mysite.com:80/index.php/energie/cache? cached.\n\nNote that this entire procedure recurs every time the page /energie/ is requested."}, {"count": 1, "attachment_id": null, "creator": "poirier@pobox.com", "text": "mod_cache always checks the cache before adding the filters, so this log indicates it's not finding that request saved in the cache, not that it's not looking for it.\n\nThere are two different requests in the log fragment that was included:\n/energie/\n/index.php/energie/cache\n\nwhich one are you concerned about?\n\nPlease attach your configuration file(s), including any .htaccess files involved.  State the complete URL that is being requested.  How is it requested (browser? which one?  is caching enabled in the browser?).  \n\nThen clear your logs, set LogLevel to debug (I think it already is, from the log posted), restart the server, request the URL exactly twice, stop the server and include both the error and access logs.  \n\nIf requesting the URL from a browser, use shift-Reload or whatever it takes to tell that browser not to use anything it has cached itself.  It would be better for debugging this, though, to request the URL using a tool like wget or curl, to avoid any risk of browser caching confusing matters.", "id": 133111, "time": "2009-12-25T06:35:11Z", "bug_id": 48441, "creation_time": "2009-12-25T06:35:11Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "creator": "john.haan@chello.nl", "text": "Hi Dan,\n\nThank you for your reply. Actually, these log entries describe the same request. /energie/ is internally rewritten to index.php/energie/ (the /cache fragment was a test) using the following .htaccess file:\n\n<BEGIN .HTACCESS>\n\n<IfModule mod_rewrite.c>\n\tRewriteEngine On\n\n\tRewriteCond %{REQUEST_URI} [A-Z]\n\tRewriteRule ^(.*)$ lcaseurl\\.php [L,NC]\n\n\tRewriteCond %{HTTP_HOST} ^ikleefgroen.nl\n\tRewriteRule (.*) http://www.ikleefgroen.nl/$1 [R=301,L]\n\n\tRewriteCond %{REQUEST_URI} !(/$|\\.) \n\tRewriteRule (.+) http://www.ikleefgroen.nl/$1/ [R=301,L] \n\n\tRewriteCond %{THE_REQUEST} ^[A-Z]{3,9}\\ /index\\.php\\ HTTP/\n\tRewriteRule ^index\\.php$ http://www.ikleefgroen.nl/ [R=301,L]\n\t\n\tRewriteCond %{QUERY_STRING} ^s=(.*) \n\tRewriteRule ^(.*)$ http://www.ikleefgroen.nl/%1/? [R=301,L]\n\n\tRewriteCond %{REQUEST_FILENAME} -f [OR]\n\tRewriteCond %{REQUEST_FILENAME} -d\n\tRewriteRule ^(.+) - [PT,L]\n\n\tRewriteRule ^(.*) index.php/$1\n\n\tRewriteCond %{HTTP:Authorization} !^$\n\tRewriteRule .* - [E=REMOTE_USER:%{HTTP:Authorization}]\n\n</IfModule>\n\nFileETag none\n\n<END .HTACCESS>\n\nHere are the logs entries you requested after requesting the page /isolatie/ twice using two different user agents. Once using firefox, once using wget:\n\n<BEGIN ACCESS LOG>\n213.93.114.240 - - [25/Dec/2009:16:30:33 +0100] \"GET /isolatie/ HTTP/1.1\" 200 1253 \"http://www.ikleefgroen.nl/windenergie/windturbine/\" \"Mozilla/5.0 (Windows; U; Windows NT 6.1; nl; rv:1.9.1.5) Gecko/20091102 Firefox/3.5.5\"\n94.75.206.140 - - [25/Dec/2009:16:30:47 +0100] \"GET /isolatie/ HTTP/1.0\" 200 2712 \"-\" \"Wget/1.11.4 Red Hat modified\"\n<END ACCESS LOG>\n\n<BEGIN ERROR LOG>\n[Fri Dec 25 16:30:33 2009] [debug] mod_cache.c(131): Adding CACHE_SAVE filter for /isolatie/\n[Fri Dec 25 16:30:33 2009] [debug] mod_cache.c(138): Adding CACHE_REMOVE_URL filter for /isolatie/\n[Fri Dec 25 16:30:33 2009] [debug] mod_cache.c(131): Adding CACHE_SAVE filter for /index.php/isolatie/\n[Fri Dec 25 16:30:33 2009] [debug] mod_cache.c(138): Adding CACHE_REMOVE_URL filter for /index.php/isolatie/\n[Fri Dec 25 16:30:33 2009] [debug] mod_deflate.c(602): [client 213.93.114.240] Zlib: Compressed 2712 to 1235 : URL /index.php/isolatie/, referer: http://www.ikleefgroen.nl/windenergie/windturbine/\n[Fri Dec 25 16:30:33 2009] [debug] mod_cache.c(663): cache: Caching url: /index.php/isolatie/\n[Fri Dec 25 16:30:33 2009] [debug] mod_cache.c(669): cache: Removing CACHE_REMOVE_URL filter.\n[Fri Dec 25 16:30:33 2009] [debug] mod_disk_cache.c(977): disk_cache: Stored headers for URL http://www.ikleefgroen.nl:80/index.php/isolatie/?\n[Fri Dec 25 16:30:33 2009] [debug] mod_disk_cache.c(1066): disk_cache: Body for URL http://www.ikleefgroen.nl:80/index.php/isolatie/? cached.\n[Fri Dec 25 16:30:47 2009] [debug] mod_cache.c(131): Adding CACHE_SAVE filter for /isolatie/\n[Fri Dec 25 16:30:47 2009] [debug] mod_cache.c(138): Adding CACHE_REMOVE_URL filter for /isolatie/\n[Fri Dec 25 16:30:47 2009] [debug] mod_cache.c(131): Adding CACHE_SAVE filter for /index.php/isolatie/\n[Fri Dec 25 16:30:47 2009] [debug] mod_cache.c(138): Adding CACHE_REMOVE_URL filter for /index.php/isolatie/\n[Fri Dec 25 16:30:47 2009] [debug] mod_cache.c(663): cache: Caching url: /index.php/isolatie/\n[Fri Dec 25 16:30:47 2009] [debug] mod_cache.c(669): cache: Removing CACHE_REMOVE_URL filter.\n[Fri Dec 25 16:30:47 2009] [debug] mod_disk_cache.c(977): disk_cache: Stored headers for URL http://www.ikleefgroen.nl:80/index.php/isolatie/?\n[Fri Dec 25 16:30:47 2009] [debug] mod_disk_cache.c(1066): disk_cache: Body for URL http://www.ikleefgroen.nl:80/index.php/isolatie/? cached.\n<END ERROR LOG>\n\nAs you can see, no cache! I have explicitly made sure no vary: header is sent.\n\n(In reply to comment #1)\n> mod_cache always checks the cache before adding the filters, so this log\n> indicates it's not finding that request saved in the cache, not that it's not\n> looking for it.\n> \n> There are two different requests in the log fragment that was included:\n> /energie/\n> /index.php/energie/cache\n> \n> which one are you concerned about?\n> \n> Please attach your configuration file(s), including any .htaccess files\n> involved.  State the complete URL that is being requested.  How is it requested\n> (browser? which one?  is caching enabled in the browser?).  \n> \n> Then clear your logs, set LogLevel to debug (I think it already is, from the\n> log posted), restart the server, request the URL exactly twice, stop the server\n> and include both the error and access logs.  \n> \n> If requesting the URL from a browser, use shift-Reload or whatever it takes to\n> tell that browser not to use anything it has cached itself.  It would be better\n> for debugging this, though, to request the URL using a tool like wget or curl,\n> to avoid any risk of browser caching confusing matters.", "id": 133114, "time": "2009-12-25T07:33:32Z", "bug_id": 48441, "creation_time": "2009-12-25T07:33:32Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 48441, "text": "Before I forget, my config file. It is a standard file slightly modified to suit my needs.\n\nServerRoot \"/usr/local/apache\"\n\nListen 80\nServerSignature Off\nServerTokens Prod\n\nLoadModule php5_module        modules/libphp5.so\n\n\n<IfModule !mpm_netware_module>\n<IfModule !mpm_winnt_module>\nUser apache\nGroup apache\n</IfModule>\n</IfModule>\n\nServerAdmin <removed for spambots>\nServerName 94.75.206.140:80\nDocumentRoot \"/srv/domains\"\n\n<Directory />\n    Options FollowSymLinks\n    AllowOverride None\n    Order deny,allow\n    Deny from all\n</Directory>\n\n<Directory \"/srv/domains\">\n    Options FollowSymLinks\n    AllowOverride All\n    Order allow,deny\n    Allow from all\n</Directory>\n\n<IfModule dir_module>\n    DirectoryIndex index.html index.php\n</IfModule>\n\n<FilesMatch \"^\\.ht\">\n    Order allow,deny\n    Deny from all\n    Satisfy All\n</FilesMatch>\n\nErrorLog \"/var/log/httpd/error_log\"\nLogLevel debug\n\n<IfModule log_config_module>\n    LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\" combined\n    LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b\" common\n\n    <IfModule logio_module>\n      LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" %I %O\" combinedio\n    </IfModule>\n</IfModule>\n\n<IfModule alias_module>\n    ScriptAlias /cgi-bin/ \"/usr/local/apache/cgi-bin/\"\n\n</IfModule>\n\n<Directory \"/usr/local/apache/cgi-bin\">\n    AllowOverride None\n    Options None\n    Order allow,deny\n    Allow from all\n</Directory>\n\nDefaultType text/plain\n\n<IfModule mime_module>\n    TypesConfig /etc/httpd/mime.types\n AddType application/x-httpd-php .php\n    AddType application/x-httpd-php-source .phps\n    AddType application/x-compress .Z\n    AddType application/x-gzip .gz .tgz\n</IfModule>\n\nInclude /etc/httpd/extra/httpd-vhosts.conf\n\n<IfModule ssl_module>\nSSLRandomSeed startup builtin\nSSLRandomSeed connect builtin\n</IfModule>\n\n<IfModule mod_deflate.c>\nSetOutputFilter DEFLATE\nBrowserMatch ^Mozilla/4 gzip-only-text/html\nBrowserMatch ^Mozilla/4\\.0[678] no-gzip\nBrowserMatch \\bMSIE !no-gzip !gzip-only-text/html\nSetEnvIfNoCase Request_URI \\\\.(?:gif|jpe?g|png|rar|zip)$ no-gzip dont-vary\n# Header append Vary User-Agent env=!dont-vary\n</IfModule>\n\n<IfModule mod_expires.c>\nExpiresActive On\nExpiresByType image/jpeg \"access plus 2 months\"\nExpiresByType image/png \"access plus 2 months\"\nExpiresByType image/gif \"access plus 2 months\"\nExpiresByType text/html \"access plus 2 hours\"\nExpiresByType text/css \"access plus 1 month\"\nAddType image/vnd.microsoft.icon .ico\nExpiresByType image/vnd.microsoft.icon \"access plus 3 months\"\n</IfModule>\n\n<IfModule mod_disk_cache.c>\nCacheRoot /var/cache/httpd\nCacheDirLength 2\n</IfModule>\n\n<IfModule mod_cache.c>\nCacheEnable disk /\nCacheDisable /textpattern\nCacheDisable /images\nCacheDefaultExpire 86400\nCacheIgnoreCacheControl On\nCacheIgnoreHeaders Set-Cookie\n</IfModule>", "id": 133116, "time": "2009-12-25T07:45:39Z", "creator": "john.haan@chello.nl", "creation_time": "2009-12-25T07:45:39Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "rpluem@apache.org", "is_private": false, "text": "Can you please provide a network sniff of the two consecutive requests?", "id": 133117, "time": "2009-12-25T08:34:05Z", "bug_id": 48441, "creation_time": "2009-12-25T08:34:05Z", "attachment_id": null}, {"count": 5, "attachment_id": null, "creator": "john.haan@chello.nl", "is_private": false, "id": 133120, "time": "2009-12-25T18:11:39Z", "bug_id": 48441, "creation_time": "2009-12-25T18:11:39Z", "tags": [], "text": "All-right.\n\nI (or rather the developers my CMS) goofed up on this one. They apparently thought it necessary to append a no-cache cache-control header if one chooses to make use of last-modified.\n\nPuzzling.\n\nThank you for your time though, sorry for wasting it."}]