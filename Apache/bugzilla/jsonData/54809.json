[{"count": 0, "tags": [], "creator": "sonotwind@sohu.com", "attachment_id": null, "text": "appliction server: glassfish3.1.2.2\n\nthe deployed structure of EAR:\n/lib\n--/log4j.jar\n--/openjpa-2.2.1.jar\n--/project-entity.jar\n--/...\n/project-ejb.jar\n/project-web.war\n/project-ejb_jar\n--/log4j.properties\n--/...\n/project-web_war\n--/WEB-INF\n--/META-INF\n\nlog4j.properties:\nlog4j.rootLogger=DEBUG, CONSOLE\nlog4j.appender.CONSOLE=org.apache.log4j.ConsoleAppender\nlog4j.appender.CONSOLE.layout=org.apache.log4j.PatternLayout\nlog4j.appender.CONSOLE.layout.ConversionPattern=%d [%t] %-5p %c - %m%n\n\nwhen log4j.ignoreTCL is false, log4j.propeties can be found, but org.apache.log4j.Appender and org.apache.log4j.ConsoleAppender are loaded by different class loader. when log4j.ignoreTCL is true, org.apache.log4j.Appender and org.apache.log4j.ConsoleAppender are loaded by same class loader, but log4j.propeties cann't be found.\n\nI suggest adding ignoreTCLForResource and ignoreTCLForClass options, and modifying org.apache.log4j.helpers.Loader to this:\n\n// add two class variables\nstatic private boolean ignoreTCLForResource = false;\nstatic private boolean ignoreTCLForClass = false;\n\n// add code in static block\nstatic\n{\n    ...;\n\n    String value = OptionConverter.getSystemProperty(\"log4j.ignoreTCLForResource\", null);\n    ignoreTCLForResource = value == null ? ignoreTCL : OptionConverter.toBoolean(value, true); \n\t     \n    value = OptionConverter.getSystemProperty(\"log4j.ignoreTCLForClass\", null); \n    ignoreTCLForClass = value == null ? ignoreTCL : OptionConverter.toBoolean(value, true);      \t\t  \n}\n\n// apply ignoreTCLForClass\nstatic public Class loadClass (String clazz) throws ClassNotFoundException \n{\n    if(java1 || ignoreTCLForClass) \n    {\n       return Class.forName(clazz);\t\t\n    } else\n    {\n       ...;\n    }\n    return Class.forName(clazz);\n}\n\n// apply ignoreTCLForResource\nstatic public URL getResource(String resource) \n{\n    ...;\n \n    if(!java1 && !ignoreTCLForResource) \n    {\n       classLoader = getTCL();\n       if(classLoader != null) \n       {\n            LogLog.debug(\"Trying to find [\"+resource+\"] using context classloader \"+classLoader+\".\");\n            url = classLoader.getResource(resource);  \t\t\n            ...;\n       }\n\n    ...;\n}", "id": 166444, "time": "2013-04-07T04:08:21Z", "bug_id": 54809, "creation_time": "2013-04-07T04:08:21Z", "is_private": false}]