[{"count": 0, "text": "Created attachment 31068\nExample XLSX, Java, and Outputs\n\nWhen cloning an XSSFWorksheet with the cloneSheet method, the cloned sheet does not display the comments associated with the original sheet:\n\nThis appears to be due to <legacyDrawing r:id=\"...\"/> not appearing in the <worksheet /> element.\n\nXSSFWorksheet.getCTWorksheet().setLegacyDrawing(old XSSFWorksheet.getCTWorksheet().getLegacyDrawing());\n\nAppears to work around or resolve the issue with comments not appearing.\n\nI suspect there is a further problem where after cloneSheet(...) is called any modification of comments for both sheets will become linked. The relationships from the sheet XML point toward the same comment XML document, instead of a cloned copy of that document.\n\nExample Code (Included in Zip)\n\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.IOException;\n\nimport org.apache.poi.xssf.usermodel.XSSFSheet;\nimport org.apache.poi.xssf.usermodel.XSSFWorkbook;\n\npublic class POICloneComments {\n\tpublic static void main(String[] args) {\n\t\ttry {\n\t\t\tXSSFWorkbook wb = new XSSFWorkbook(new FileInputStream(\"comment.xlsx\"));\n\n\t\t\tint oldsheetIndex = wb.getSheetIndex(\"example\");\n\t\t\tXSSFSheet oldsheet = wb.getSheetAt(oldsheetIndex);\n\t\t\tXSSFSheet newsheet = wb.cloneSheet(oldsheetIndex);\n\n\t\t\twb.removeSheetAt(oldsheetIndex);\n\t\t\twb.write(new FileOutputStream(\"outnocomment.xlsx\"));\n\n\t\t\twb = new XSSFWorkbook(new FileInputStream(\"comment.xlsx\"));\n\n\t\t\toldsheetIndex = wb.getSheetIndex(\"example\");\n\t\t\toldsheet = wb.getSheetAt(oldsheetIndex);\n\t\t\tnewsheet = wb.cloneSheet(oldsheetIndex);\n\t\t\twb.removeSheetAt(oldsheetIndex);\n\n\t\t\t// This fixes the comment going missing\n\t\t\tnewsheet.getCTWorksheet().setLegacyDrawing(oldsheet.getCTWorksheet().getLegacyDrawing());\n\n\t\t\twb.write(new FileOutputStream(\"outhascomment.xlsx\"));\n\t\t} catch (IOException e) {\n\t\t\te.printStackTrace();\n\t\t\tSystem.exit(1);\n\t\t}\n\t}\n}", "creator": "corey@teffetalor.com", "attachment_id": 31068, "id": 171406, "time": "2013-11-22T23:30:10Z", "bug_id": 55814, "creation_time": "2013-11-22T23:30:10Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 55814, "text": "I can confirm the bug (poi-3.11, poi-3.12-beta1). Unfortonatly the workaround \"newsheet.getCTWorksheet().setLegacyDrawing(oldsheet.getCTWorksheet().getLegacyDrawing());\" does not work for me. When using the workaround, the resulting excel-document is corrupted.", "id": 181462, "time": "2015-03-03T12:26:40Z", "creator": "fabian.fischer@iav.de", "creation_time": "2015-03-03T12:26:40Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "fabian.fischer@iav.de", "is_private": false, "text": "The problem still exists in poi-3.14-FINAL.\nThe workaround now works for me.", "id": 191883, "time": "2016-06-22T13:19:22Z", "bug_id": 55814, "creation_time": "2016-06-22T13:19:22Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 55814, "attachment_id": null, "is_private": false, "id": 201906, "time": "2017-11-04T13:46:14Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2017-11-04T13:46:14Z", "text": "This seems to have been fixed at some point, I could not reproduce this any more, cloning sheets seems to correctly clone comments as well now. Bug #52425 and especially bug #56017 sound related.\n\nAdded some unit-test that tries to reproduce the problem via r1814290."}]