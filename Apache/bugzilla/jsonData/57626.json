[{"text": "Our webapp was working fine with Tomcat 8.0.14, we recently did an upgrade to 8.0.18 and since then we are experiencing an exception during the compilation of the JSP pages.\n\nThe exception is effectively an IllegalStateException, with message zip file is closed.\n\nWe did some debugging in the Tomcat source code and found out that the probable cause of this issue is the fix applied to ensure that all JARs files gets properly closed to prevent resource leaks (SVN revision 1641056).\n\nMore concretely in JspCompilationContext, the method getLastModified() will use an already closed instance of the tagJar. This occurs when the JSP file gets recompiled, and thus not upon first compilation.\n\nThe full exception is:\n\njava.lang.IllegalStateException: zip file closed \n        java.util.zip.ZipFile.ensureOpen(ZipFile.java:670) \n        java.util.zip.ZipFile.getEntry(ZipFile.java:310) \n        java.util.jar.JarFile.getEntry(JarFile.java:240) \n        org.apache.tomcat.util.scan.JarFileUrlJar.getLastModified(JarFileUrlJar.java:87) \n        org.apache.jasper.JspCompilationContext.getLastModified(JspCompilationContext.java:358) \n        org.apache.jasper.compiler.Compiler.isOutDated(Compiler.java:434) \n        org.apache.jasper.compiler.Compiler.isOutDated(Compiler.java:408) \n        org.apache.jasper.JspCompilationContext.compile(JspCompilationContext.java:563) \n        org.apache.jasper.servlet.JspServletWrapper.loadTagFile(JspServletWrapper.java:239) \n        org.apache.jasper.compiler.TagFileProcessor.loadTagFile(TagFileProcessor.java:580) \n        org.apache.jasper.compiler.TagFileProcessor.access$000(TagFileProcessor.java:50) \n        org.apache.jasper.compiler.TagFileProcessor$TagFileLoaderVisitor.visit(TagFileProcessor.java:662) \n        org.apache.jasper.compiler.Node$CustomTag.accept(Node.java:1536) \n        org.apache.jasper.compiler.Node$Nodes.visit(Node.java:2376) \n        org.apache.jasper.compiler.Node$Visitor.visitBody(Node.java:2428) \n        org.apache.jasper.compiler.Node$Visitor.visit(Node.java:2434) \n        org.apache.jasper.compiler.Node$Root.accept(Node.java:464) \n        org.apache.jasper.compiler.Node$Nodes.visit(Node.java:2376) \n        org.apache.jasper.compiler.TagFileProcessor.loadTagFiles(TagFileProcessor.java:680) \n        org.apache.jasper.compiler.Compiler.generateJava(Compiler.java:229) \n        org.apache.jasper.compiler.Compiler.compile(Compiler.java:356) \n        org.apache.jasper.compiler.Compiler.compile(Compiler.java:336) \n        org.apache.jasper.compiler.Compiler.compile(Compiler.java:323) \n        org.apache.jasper.JspCompilationContext.compile(JspCompilationContext.java:570) \n        org.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:356) \n        org.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:396) \n        org.apache.jasper.servlet.JspServlet.service(JspServlet.java:340) \n        javax.servlet.http.HttpServlet.service(HttpServlet.java:725) \n        org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52) \n        org.apache.struts.action.RequestProcessor.doForward(RequestProcessor.java:1078) \n        org.apache.struts.tiles.TilesRequestProcessor.doForward(TilesRequestProcessor.java:295) \n        org.apache.struts.tiles.TilesRequestProcessor.processTilesDefinition(TilesRequestProcessor.java:271) \n        org.apache.struts.tiles.TilesRequestProcessor.processForwardConfig(TilesRequestProcessor.java:332) \n        org.apache.struts.action.RequestProcessor.process(RequestProcessor.java:232) \n        org.apache.struts.action.ActionServlet.process(ActionServlet.java:1913) \n        org.apache.struts.action.ActionServlet.doGet(ActionServlet.java:449) \n        javax.servlet.http.HttpServlet.service(HttpServlet.java:618) \n        javax.servlet.http.HttpServlet.service(HttpServlet.java:725) \n        org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52) \n        be.cipal.setup.SetupFilter.doFilter(SetupFilter.java:60) \n        be.cipal.web.struts.tiles.AppModeFilter.doFilter(AppModeFilter.java:45) \n        be.cipal.filter.UTF8Filter.doFilter(UTF8Filter.java:44)", "tags": [], "bug_id": 57626, "attachment_id": null, "count": 0, "id": 181284, "time": "2015-02-24T07:08:03Z", "creator": "kenny.moens@cipal.be", "creation_time": "2015-02-24T07:08:03Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 57626, "attachment_id": null, "id": 181323, "time": "2015-02-25T11:27:27Z", "creator": "markt@apache.org", "creation_time": "2015-02-25T11:27:27Z", "is_private": false, "text": "Thanks for the report. This has been fixed in trunk and 8.0.x for 8.0.21 onwards."}, {"count": 2, "tags": [], "creator": "hm1rafael@gmail.com", "attachment_id": null, "text": "Was this solved? I'm still having this issue on Tomcat 8.0.21", "id": 182822, "time": "2015-05-04T18:33:28Z", "bug_id": 57626, "creation_time": "2015-05-04T18:33:28Z", "is_private": false}, {"id": 182824, "tags": [], "bug_id": 57626, "attachment_id": null, "count": 3, "text": "Which part of \"This has been fixed in trunk and 8.0.x for 8.0.21 onwards.\" is not clear?\n\nIf you are seeing a similar issue then open a new bug report and provide the steps to reproduce it.", "time": "2015-05-04T19:41:22Z", "creator": "markt@apache.org", "creation_time": "2015-05-04T19:41:22Z", "is_private": false}]