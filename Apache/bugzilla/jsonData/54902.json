[{"count": 0, "tags": [], "creator": "m.sigor@gmail.com", "attachment_id": null, "id": 166926, "time": "2013-04-29T10:36:56Z", "bug_id": 54902, "creation_time": "2013-04-29T10:36:56Z", "is_private": false, "text": "DESCRIPTION:\n\nI'm runninn the attached 'test.jmx' file as follows:\n--------------\njmeter -p jmeter.properties  -Jsummariser.name=summary -Jsummariser.interval=5 -Jsummariser.log=true -Jsummariser.out=false -Dsun.net.http.allowRestrictedHeaders=true -n -t test.jmx\n--------------\nThe 'jmeter.properties' file is also attached.\n\nThe test plan has two thread groups each with one sampler and one constant throughput timer.\nOne thread group has the the constant throughput timer set to 300 (5 req/sec). And runs from t0-t120 (120 secs duration).\nThe other thread group has the the constant throughput timer set to 1500 (25 req/sec).  And runs from t120-t240 (120 secs duration after 120 secs delay).\nThe test is executed against a server that rate limits all traffic that exceds 5 req/sec. beyond 5 req/sec the requests are droped with a TCP RST.\n\nLooking at Jmeter log summary, it seems that Jmeter did just what it was told to do (25.0/s Avg) and (5.0/s Avg) - \n--------------\n2013/04/26 18:36:14 INFO  - jmeter.reporters.Summariser: /dos1.php-2 =  3006 in 120.1s =   25.0/s Avg:     9 Min:     0 Max:    20 Err:   969 (32.24%) \n2013/04/26 18:36:14 INFO  - jmeter.reporters.Summariser: /dos1.php-1 =   608 in 120.8s =    5.0/s Avg:    13 Min:    13 Max:    17 Err:     0 (0.00%) \n2013/04/26 18:36:14 INFO  - jmeter.engine.StandardJMeterEngine: Test has ended \n--------------\n\nHowever, recording a tcpdump of the traffic that is generated by Jmeter shows otherwise.\nThe mentioned tcpdump recorded as follows on the target server: tcpdump -i any -s0 -w /shared/tmp/my.pcap\nThe mentioned tcpdump is then filtered out (in wireshark) as follows: ip.src == jmeter_machine_ip and ip.dst == server_ip and tcp.flags.push == 1\n\nLooking at the tcpdump shows that - \n--------------\nThe execution of the first thread goes as designed: 5 req/sec are generated by Jmeter  and all traffic goes through.\nThe execution of the second thread goes bad: ~50(+/-) req/sec are generated by Jmeter. Instead of the defined 25 req/sec.\n--------------\n\nSo, there are actually two bugs here - when connections are getting reset:\n1) Jmeter exceeds the defined (via 'Constant throughput timer') traffic rate. \n2) provides a wrong thread summary in log.\n\nSTEPS TO REPRODUCE:\n\n1) Configure 'Constant throughput timer' to  1500 (25 req/sec).\n2) Start a tcpdump recording\n3) Run the test with an available back-end server (no connection resets) - see (via tcpdump) that Jmeter sends 25 req/sec.\n4) Shut down the back end server\n3) Run the test (there are connection resets) - see (via tcpdump) that Jmeter exceeds the rate of 25 req/sec by far.\n4) Look into the Jmeter log - the summary provides data that differs from the tcpdump data.\n\nSETUP DETAILS:\n\n$ java -version\njava version \"1.6.0_22\"\nOpenJDK Runtime Environment (IcedTea6 1.10.10) (rhel-1.28.1.10.10.el5_8-i386)\nOpenJDK Server VM (build 20.0-b11, mixed mode)\n\n$ cat /etc/redhat-release \nCentOS release 5.8 (Final)\n\n$ ./jmeter -v\nlog_file=jmeter.log java.io.FileNotFoundException: jmeter.log (Permission denied)\n[log_file-> System.out]\n2013/04/29 12:56:02 INFO  - jmeter.util.JMeterUtils: Setting Locale to en_US \n2013/04/29 12:56:02 INFO  - jmeter.JMeter: Loading user properties from: /usr/apache-jmeter-2.9/bin/user.properties \n2013/04/29 12:56:02 INFO  - jmeter.JMeter: Loading system properties from: /usr/apache-jmeter-2.9/bin/system.properties \n2013/04/29 12:56:02 INFO  - jmeter.JMeter: Copyright (c) 1998-2013 The Apache Software Foundation \n2013/04/29 12:56:02 INFO  - jmeter.JMeter: Version 2.9 r1437961 \n2013/04/29 12:56:02 INFO  - jmeter.JMeter: java.version=1.6.0_22 \n2013/04/29 12:56:02 INFO  - jmeter.JMeter: java.vm.name=OpenJDK Server VM \n2013/04/29 12:56:02 INFO  - jmeter.JMeter: os.name=Linux \n2013/04/29 12:56:02 INFO  - jmeter.JMeter: os.arch=i386 \n2013/04/29 12:56:02 INFO  - jmeter.JMeter: os.version=2.6.18-238.el5xen \n2013/04/29 12:56:02 INFO  - jmeter.JMeter: file.encoding=ANSI_X3.4-1968 \n2013/04/29 12:56:02 INFO  - jmeter.JMeter: Default Locale=English (United States) \n2013/04/29 12:56:02 INFO  - jmeter.JMeter: JMeter  Locale=English (United States) \n2013/04/29 12:56:02 INFO  - jmeter.JMeter: JMeterHome=/usr/apache-jmeter-2.9 \n2013/04/29 12:56:02 INFO  - jmeter.JMeter: user.dir  =/usr/apache-jmeter-2.9/bin \n2013/04/29 12:56:02 INFO  - jmeter.JMeter: PWD       =/usr/apache-jmeter-2.9/bin \n2013/04/29 12:56:02 INFO  - jmeter.JMeter: IP: 10.10.10.107 Name: tlv-sigurko-xen-centos-clean.xxx.com FullName: tlv-sigurko-xen-centos-clean.xxx.com \nCopyright (c) 1998-2013 The Apache Software Foundation\nVersion 2.9 r1437961"}, {"count": 1, "tags": [], "creator": "m.sigor@gmail.com", "text": "Created attachment 30236\nJmeter jmx file 'test.jmx'", "id": 166927, "time": "2013-04-29T10:37:47Z", "bug_id": 54902, "creation_time": "2013-04-29T10:37:47Z", "is_private": false, "attachment_id": 30236}, {"count": 2, "text": "Created attachment 30237\nJmeter properties file", "bug_id": 54902, "attachment_id": 30237, "id": 166928, "time": "2013-04-29T10:38:11Z", "creator": "m.sigor@gmail.com", "creation_time": "2013-04-29T10:38:11Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "creator": "sebb@apache.org", "attachment_id": null, "id": 166929, "time": "2013-04-29T11:20:27Z", "bug_id": 54902, "creation_time": "2013-04-29T11:20:27Z", "is_private": false, "text": "Please also provide the results log file (JTL). Either CSV or XML format."}, {"count": 4, "tags": [], "bug_id": 54902, "attachment_id": 30238, "id": 166931, "time": "2013-04-29T12:19:12Z", "creator": "m.sigor@gmail.com", "creation_time": "2013-04-29T12:19:12Z", "is_private": false, "text": "Created attachment 30238\njmeter log file"}, {"count": 5, "tags": [], "bug_id": 54902, "attachment_id": null, "text": "jmeter log attached.", "id": 166932, "time": "2013-04-29T12:20:21Z", "creator": "m.sigor@gmail.com", "creation_time": "2013-04-29T12:20:21Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 54902, "attachment_id": null, "id": 166933, "time": "2013-04-29T12:22:57Z", "creator": "m.sigor@gmail.com", "creation_time": "2013-04-29T12:22:57Z", "is_private": false, "text": "(In reply to comment #5)\n> jmeter log attached.\n\nI hope tha this what you mean by - results log file (JTL). Either CSV or XML format.\n\nIf not - please let me know how can I produce that for you."}, {"count": 7, "tags": [], "bug_id": 54902, "attachment_id": null, "id": 166941, "time": "2013-04-29T15:49:33Z", "creator": "sebb@apache.org", "creation_time": "2013-04-29T15:49:33Z", "is_private": false, "text": "That might be useful, but what we really need is a sample result file which contains details of all the samples.\n\nSee http://jmeter.apache.org/usermanual/listeners.html#sample_configuration\n\nMake sure you specify a file name.\nUse the Simple Data Writer.\nPlease attach the jmeter.log file that was produced at the same time.\n\nBy the way, it looks as though the JMeter launch directory is not writable, which is why the log is going to the console. Either start from a writable directory, or use the -j option to redirect the output\n\nhttp://jmeter.apache.org/usermanual/get-started.html#options"}, {"count": 8, "tags": [], "text": "I identified the problem to be the following - \n\nMy test plan jmx file was created for an older Jmeter version.\nThat test plan makes use of 'HTTPSampler' rather than the 'HTTPSamplerProxy' xml tag.\n\nNow, I'm using Jmeter 2.9.\n\nThe effect of that is that the 'HTTP Request' implementation drop-down box remains set to 'Java'.\n\nOnce I changed the 'HTTPSampler' xml tag to the 'HTTPSamplerProxy' tag - the 'jmeter.httpsampler=HttpClient3.1' setting in the 'jmeter.properties' file took affectt and the 'HTTP Request' implementation drop-down box got set to 'HttpClient3.1'.\n\nOnce that was done - the bug was gone.\n\nJmeter maintains the designated traffic rate even when connections get reset.\n\nHowever - \nI tried the same with 'jmeter.httpsampler=HttpClient4' and to my big surprise the bug was there again.\n\nAnyway, I'm glad that HttpClient3.1 does not have that bug and I can use  it.\n\nSince this seems to be a 'HttpClient4' bug - this bug can be closed.", "is_private": false, "id": 166967, "creator": "m.sigor@gmail.com", "time": "2013-04-30T14:44:42Z", "bug_id": 54902, "creation_time": "2013-04-30T14:44:42Z", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 54902, "attachment_id": null, "text": "Flipping to closed due to the explained above reasons.", "id": 166968, "time": "2013-04-30T14:45:28Z", "creator": "m.sigor@gmail.com", "creation_time": "2013-04-30T14:45:28Z", "is_private": false}, {"count": 10, "tags": [], "text": "Reopening. If there is a difference in behaviour with HC4, that needs to be investigated and fixed.\n\nPerhaps HC4 was retrying internally? \nThat would explain why the tcpdump traffic was higher than the traffic measured by JMeter as it would only see the initial request, not the retries.", "attachment_id": null, "bug_id": 54902, "id": 167112, "time": "2013-05-09T10:44:40Z", "creator": "sebb@apache.org", "creation_time": "2013-05-09T10:44:40Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 54902, "text": "Also see Bug 55060", "id": 167845, "time": "2013-06-15T19:24:48Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2013-06-15T19:24:48Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 54902, "attachment_id": null, "id": 168695, "time": "2013-07-21T19:55:17Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2013-07-21T19:55:17Z", "is_private": false, "text": "By default:\nhttpclient4.retrycount=1\nwhich means HttpClient4 will internally retry any idempotent request which fails an this on Connect and Receive.\n\nCould you make a test setting httpclient4.retrycount to 0 in user.properties to see what happens ?\n\nNote that HC3 also has this setting enabled also and set to 1 but it seems retry only applied to both connect and receive."}, {"count": 13, "tags": [], "bug_id": 54902, "text": "With no retry, My tests with last nightly build do not show issue.\nHc4 and Hc31 have nearly the same results.", "id": 168700, "time": "2013-07-21T21:44:02Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2013-07-21T21:44:02Z", "is_private": false, "attachment_id": null}, {"count": 14, "attachment_id": null, "creator": "sebb@apache.org", "is_private": false, "id": 168701, "time": "2013-07-21T22:07:56Z", "bug_id": 54902, "creation_time": "2013-07-21T22:07:56Z", "tags": [], "text": "It might not be the best choice for JMeter to default to retrying requests.\nThis may result in additional unexpected traffic, which is perhaps happening here.\n\nPerhaps default both retry counts to 0?"}, {"attachment_id": null, "tags": [], "creator": "milamber@apache.org", "text": "(In reply to Sebb from comment #14)\n> It might not be the best choice for JMeter to default to retrying requests.\n> This may result in additional unexpected traffic, which is perhaps happening\n> here.\n> \n> Perhaps default both retry counts to 0?\n\n+1 for me. In another case, I had to set this value to 0 to see a webapp's bug which crashes the process Apache+PHP on server. With the value 1, the crash occurred but JMeter retrying (on a new process Apache+PHP) and doesn't show the bug.", "count": 15, "id": 168702, "time": "2013-07-21T22:32:24Z", "bug_id": 54902, "creation_time": "2013-07-21T22:32:24Z", "is_private": false}, {"count": 16, "tags": [], "text": "Created attachment 30664\nignore\n\nrefer to comment from toogoodtopassup.  This is the system 1 stack trace, running w/ the Mac look and feel.", "is_private": false, "id": 169044, "creator": "toogoodtopassup@gmail.com", "time": "2013-08-02T15:20:49Z", "bug_id": 54902, "creation_time": "2013-08-02T15:20:49Z", "attachment_id": 30664}, {"count": 17, "tags": [], "bug_id": 54902, "attachment_id": 30665, "text": "Created attachment 30665\nignore\n\nrefer to comment from toogoodtopassup.  This is the system 2 stack trace with the Generic LaF.", "id": 169045, "time": "2013-08-02T15:22:00Z", "creator": "toogoodtopassup@gmail.com", "creation_time": "2013-08-02T15:22:00Z", "is_private": false}, {"count": 18, "tags": [], "bug_id": 54902, "attachment_id": null, "text": "As a followup to my previous message, I get very similar results on System 1 when using Java 7:\njava version \"1.7.0_25\"\nJava(TM) SE Runtime Environment (build 1.7.0_25-b15)\nJava HotSpot(TM) 64-Bit Server VM (build 23.25-b01, mixed mode)", "id": 169046, "time": "2013-08-02T15:32:28Z", "creator": "toogoodtopassup@gmail.com", "creation_time": "2013-08-02T15:32:28Z", "is_private": false}, {"count": 19, "tags": [], "bug_id": 54902, "attachment_id": 30664, "id": 169050, "time": "2013-08-02T15:38:49Z", "creator": "toogoodtopassup@gmail.com", "creation_time": "2013-08-02T15:38:49Z", "is_private": false, "text": "Comment on attachment 30664\nignore\n\nPlease Ignore - wrong bug"}, {"count": 20, "tags": [], "bug_id": 54902, "attachment_id": 30665, "text": "Comment on attachment 30665\nignore\n\nwrong bug", "id": 169051, "time": "2013-08-02T15:39:09Z", "creator": "toogoodtopassup@gmail.com", "creation_time": "2013-08-02T15:39:09Z", "is_private": false}, {"count": 21, "tags": [], "bug_id": 54902, "attachment_id": null, "text": "Please ignore my comments on this bug - somehow I shifted what bug I was looking at during reporting.", "id": 169052, "time": "2013-08-02T15:39:56Z", "creator": "toogoodtopassup@gmail.com", "creation_time": "2013-08-02T15:39:56Z", "is_private": false}, {"count": 22, "tags": [], "bug_id": 54902, "attachment_id": null, "text": "Closing issue which is fixed as per our analysis.\nFeel free to reopen if it's not the case, anyway having your feedback would be really nice.", "id": 169935, "time": "2013-09-05T19:41:59Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2013-09-05T19:41:59Z", "is_private": false}]