[{"count": 0, "tags": [], "creator": "kimhanse@gmail.com", "text": "I have noticed that triggering a dependset task right after a build causes the\ndependset to complaint about future files. I think it is caused by the Date\nResourceSelector's granularity of 1s on UNIX systems, this means that a file\n0.5s old is seen as from the future.\n\nI don't think the bug causes any kind of errors in the files build, but it\nlowers my colleagues trust in Ant.\n\nThis is an example showing the complaints:\n========================\nkim@raph:~/orion/svn/repo3/servlet/frontend$ ant clean build build\nBuildfile: build.xml\n\nclean:\n   [delete] Deleting directory /mnt/crypt/orion/svn/repo3/servlet/frontend/build\n\nbuild:\n    [mkdir] Created dir: /mnt/crypt/orion/svn/repo3/servlet/frontend/build/classes\n    [javac] Compiling 91 source files to\n/mnt/crypt/orion/svn/repo3/servlet/frontend/build/classes\n\nbuild:\n[dependset] Warning:\n/mnt/crypt/orion/svn/repo3/servlet/frontend/build/classes/dk/ange/orion/servlet/format/jobs/PrerunWarnings$1.class\nmodified in the future.\n[dependset] Warning:\n/mnt/crypt/orion/svn/repo3/servlet/frontend/build/classes/dk/ange/orion/servlet/format/jobs/PrerunWarnings$BasicWarning.class\nmodified in the future.\n[dependset] Warning:\n/mnt/crypt/orion/svn/repo3/servlet/frontend/build/classes/dk/ange/orion/servlet/format/jobs/PrerunWarnings$FormattedWarning.class\nmodified in the future.\n[dependset] Warning:\n/mnt/crypt/orion/svn/repo3/servlet/frontend/build/classes/dk/ange/orion/servlet/format/jobs/PrerunWarnings$ParseWarning.class\nmodified in the future.\n[dependset] Warning:\n/mnt/crypt/orion/svn/repo3/servlet/frontend/build/classes/dk/ange/orion/servlet/format/jobs/PrerunWarnings$StabWarning.class\nmodified in the future.\n[dependset] Warning:\n/mnt/crypt/orion/svn/repo3/servlet/frontend/build/classes/dk/ange/orion/servlet/format/jobs/PrerunWarnings$TooFewMovesWarning.class\nmodified in the future.\n[dependset] Warning:\n/mnt/crypt/orion/svn/repo3/servlet/frontend/build/classes/dk/ange/orion/servlet/format/jobs/PrerunWarnings.class\nmodified in the future.\n\nBUILD SUCCESSFUL\nTotal time: 9 seconds\nkim@raph:~/orion/svn/repo3/servlet/frontend$", "id": 109513, "time": "2007-10-20T08:39:26Z", "bug_id": 43665, "creation_time": "2007-10-20T08:39:26Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "stevel@apache.org", "text": "The whole thing about filesystem granularity is trouble; it is worse on windows.\n\ne warn about clock differences because if you have a network mounted disk on a\ndifferent clock, you are in deep trouble. \n\n1. <date> selectors have a granularity of 0s on unix these days, I think. Now\nthat Ant on DOS is NT only, we could perhaps tighten the 2s rule for windows,\nand allow some property to set the default granularity if you still build on FAT\nfilesystems.\n\n2. what does an ls -l of the specific files show, compared to the original file.?\n3. what does the clock test in ant -diagnostics print?", "id": 109534, "attachment_id": null, "bug_id": 43665, "creation_time": "2007-10-22T02:15:30Z", "time": "2007-10-22T02:15:30Z", "is_private": false}, {"count": 2, "attachment_id": null, "bug_id": 43665, "is_private": false, "id": 109536, "time": "2007-10-22T02:25:15Z", "creator": "jkf@apache.org", "creation_time": "2007-10-22T02:25:15Z", "tags": [], "text": "On windows NT this has already happened quite some time ago (1 ms).\n\nRevision 278117 - (view) (download) (annotate) - [select for diffs]\nModified Thu Apr 7 19:59:35 2005 UTC (2 years, 6 months ago) by bruce\nFile length: 58537 byte(s)\nDiff to previous 278110 (colored)\n\nRound NTFS Granularity up rather than down\n"}, {"count": 3, "tags": [], "text": "(In reply to comment #1)\n> The whole thing about filesystem granularity is trouble; it is worse on windows.\n> \n> e warn about clock differences because if you have a network mounted disk on a\n> different clock, you are in deep trouble. \n> \n> 1. <date> selectors have a granularity of 0s on unix these days, I think. Now\n> that Ant on DOS is NT only, we could perhaps tighten the 2s rule for windows,\n> and allow some property to set the default granularity if you still build on FAT\n> filesystems.\n\nI added some debug statements to the ant code (version 1.7.0), it showed that\nthe granularity was 1000ms.\n\n> 2. what does an ls -l of the specific files show, compared to the original file.?\n\nI added some debug statements into the DependSet class, it showed that the files\n res.getLastModified() was around 500ms old compared to the\nSystem.currentTimeMillis() used when creating the Date selector. I don't think\nit should warn in that case, but it does.\n\nPerhaps the granularity should be set to zero when generating the warning about\nfiles from the future.\n\n> 3. what does the clock test in ant -diagnostics print?\n\nThe only thing I could find about clock in that output was:\n  Temp dir alignment with system clock is -413 ms\n\nRunning the diagnostics a lot of times gives me numbers from around -300ms to\n-1100ms, but most were around -800ms.\n", "attachment_id": null, "id": 109538, "creation_time": "2007-10-22T02:31:22Z", "time": "2007-10-22T02:31:22Z", "creator": "kimhanse@gmail.com", "bug_id": 43665, "is_private": false}, {"count": 4, "attachment_id": null, "bug_id": 43665, "is_private": false, "id": 109539, "time": "2007-10-22T02:35:07Z", "creator": "peterreilly@apache.org", "creation_time": "2007-10-22T02:35:07Z", "tags": [], "text": "I do not think that this is due to mounted file systems.\n(despite the /mnt/crypt in the bug report).\nThe follows gives me with trunk ant.\n\nsrc/example/Hello.java: |-\n  package example; \n  public class Hello{}\nbuild.xml:  |-\n  <project name=\"d\" default=\"run\">\n    <target name=\"run\">\n      <delete dir=\"classes\"/>\n      <mkdir dir=\"classes\"/>\n      <javac srcdir=\"src\" destdir=\"classes\" debug=\"yes\"/>\n      <dependset>\n        <sources>\n          <fileset dir=\"src\" includes=\"**/*.java\"/>\n        </sources>\n        <targets>\n          <fileset dir=\"classes\" includes=\"**/*.class\"/>\n        </targets>\n      </dependset>\n    </target>\n  </project>\n\nResult:\nrun:\nCreated dir: /work/reilly/learning/a/dependset/classes\nCompiling 1 source file to /work/reilly/learning/a/dependset/classes\nWarning: /work/reilly/learning/a/dependset/classes/example/Hello.class modified\nin the future.\n\n~/learning/a/dependset> ls -lR\n.:\ntotal 12\n-rw-r--r--  1 reilly ccgrp01  393 Oct 22 09:44 build.xml\ndrwxr-xr-x  3 reilly ccgrp01 4096 Oct 22 09:46 classes\ndrwxr-xr-x  3 reilly ccgrp01 4096 Oct 22 09:41 src\n\n./classes:\ntotal 4\ndrwxr-xr-x  2 reilly ccgrp01 4096 Oct 22 09:46 example\n\n./classes/example:\ntotal 4\n-rw-r--r--  1 reilly ccgrp01 256 Oct 22 09:46 Hello.class\n\n./src:\ntotal 4\ndrwxr-xr-x  2 reilly ccgrp01 4096 Oct 22 09:41 example\n\n./src/example:\ntotal 4\n-rw-r--r--  1 reilly ccgrp01 41 Oct 22 09:41 Hello.java\n"}, {"count": 5, "tags": [], "creator": "kimhanse@gmail.com", "text": "(In reply to comment #4)\n> I do not think that this is due to mounted file systems.\n> (despite the /mnt/crypt in the bug report).\n\n/mnt/crypt is a local device mounted with encryption.", "id": 109540, "time": "2007-10-22T02:38:46Z", "bug_id": 43665, "creation_time": "2007-10-22T02:38:46Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "creator": "jkf@apache.org", "text": "From DependSet:\n\n    private boolean uptodate(ResourceCollection src, ResourceCollection target) {\n        org.apache.tools.ant.types.resources.selectors.Date datesel\n            = new org.apache.tools.ant.types.resources.selectors.Date();\n        datesel.setMillis(System.currentTimeMillis());\n        datesel.setWhen(TimeComparison.AFTER);\n        logFuture(targets, datesel);\n\nTo make matters worse the filesystem granularity is added by the\nresourceselector in favour of matching.\n\n\n\n", "id": 109542, "time": "2007-10-22T02:59:48Z", "bug_id": 43665, "creation_time": "2007-10-22T02:59:48Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 43665, "attachment_id": null, "id": 111419, "time": "2007-12-04T06:14:38Z", "creator": "kimhanse@gmail.com", "creation_time": "2007-12-04T06:14:38Z", "is_private": false, "text": "Would this fix be acceptable ?\n\n--- DependSet.java.orig 2006-12-13 13:16:18.000000000 +0100\n+++ DependSet.java      2007-12-04 15:12:10.000000000 +0100\n@@ -213,6 +213,7 @@\n             = new org.apache.tools.ant.types.resources.selectors.Date();\n         datesel.setMillis(System.currentTimeMillis());\n         datesel.setWhen(TimeComparison.AFTER);\n+        datesel.setGranularity(0);\n         logFuture(targets, datesel);\n \n         int neTargets = new NonExistent(targets).size();\n"}, {"count": 8, "attachment_id": null, "bug_id": 43665, "text": "since this is just logging anyway, yes, I think the patch is save.\n\nCommitted as svn revision 722942", "id": 123047, "time": "2008-12-03T07:50:35Z", "creator": "bodewig@apache.org", "creation_time": "2008-12-03T07:50:35Z", "tags": [], "is_private": false}]