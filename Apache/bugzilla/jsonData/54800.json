[{"count": 0, "tags": [], "bug_id": 54800, "attachment_id": null, "id": 166396, "time": "2013-04-04T21:47:00Z", "creator": "rstoyanchev@yahoo.com", "creation_time": "2013-04-04T21:47:00Z", "is_private": false, "text": "Whenever WebSocketContainer is used to connect to a server endpoint, the following message appears when Tomcat shuts down:\n\nSEVERE: The web application [/websocket-test] appears to have started a thread named [Thread-4] but has failed to stop it. This is very likely to create a memory leak.\n\nThe message is repeated for 6 different threads. I don't have proof this is caused by the use of WebSocketContainer but the messages don't appear when it isn't used.\n\nThe Endpoint used to connect is very simple. It sends a message when the session is opened to the EchoEndpoint on the server side, and prints the response and closes when the message is echoed back."}, {"count": 1, "tags": [], "bug_id": 54800, "attachment_id": null, "id": 166477, "time": "2013-04-08T19:25:44Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-04-08T19:25:44Z", "is_private": false, "text": "It might be useful to modify WebappClassLoader#clearReferencesThreads() to call Thread#getStackTrace() on the offending thread to see what it is doing.\n\n\nDo you have a recipe & sample application to reproduce your issue?\n\nTomcat usually sets names to threads (e.g. http-nio-8080-exec-1), so I do not remember such name as \"Thread-4\"."}, {"count": 2, "tags": [], "creator": "rstoyanchev@yahoo.com", "attachment_id": 30218, "text": "Created attachment 30218\nPatch that modifies EchoEndpoint to add a client connection\n\nIt should be as easy as opening a client WebSocket connection. See the attached patch that modifies the echo sample. Once the patch is applied, open the echo HTML page and send a message. That will trigger added code. Then shut down the server and you should see this message:\n\nSEVERE: The web application [/examples] appears to have started a thread named [WebSocket background processing] but has failed to stop it. This is very likely to create a memory leak.", "id": 166744, "time": "2013-04-20T17:40:34Z", "bug_id": 54800, "creation_time": "2013-04-20T17:40:34Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 54800, "text": "You'll also see these threads with the units tests e.g. TestWsRemoteEndpoint\n\nThey are a side-effect of using AsynchronousSocketChannel on the client side.\n\nI'm looking into what I can do either in the WebSocket implementation or in Tomcat's memory leak prevention code to address this.", "id": 166786, "time": "2013-04-23T12:51:38Z", "creator": "markt@apache.org", "creation_time": "2013-04-23T12:51:38Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 54800, "is_private": false, "text": "Thanks for the report. I fixed this memory leak and a related one I found while doing some testing.", "id": 166791, "time": "2013-04-23T16:25:03Z", "creator": "markt@apache.org", "creation_time": "2013-04-23T16:25:03Z", "attachment_id": null}]