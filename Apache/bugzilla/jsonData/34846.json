[{"count": 0, "tags": [], "bug_id": 34846, "attachment_id": null, "is_private": false, "id": 74679, "time": "2005-05-10T18:21:28Z", "creator": "apache.org@tisc.de", "creation_time": "2005-05-10T18:21:28Z", "text": "I created a simple SSL-Setup with client certificates. It initially worked on\nanother machine (even with same Apache version), but now fails when going into\nproduction.\n\nI have a VirtualHost _default_:443 configured to handle SSL (the machine has\nonly 1 IP) like this:\n\n<VirtualHost _default_:443>\n  # ...ServerName, DocumentRoot, ServerAdmin, Logfiles...\n\n  SSLEngine on\n  SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL\n \n  # first: Server certificate settings\n  # server certificate signed by self-made CA\n  SSLCertificateFile /etc/apache2/ssl.crt/server2.crt\n  # 1024 Bit RSA key without passphrase\n  SSLCertificateKeyFile /etc/apache2/ssl.key/server2.key\n  # self-signed CA certificate\n  SSLCertificateChainFile /etc/apache2/ssl.crt/cacert.crt\n \n  # client certificate settings, uses same certificate\n  SSLCACertificateFile /etc/apache2/ssl.crt/cacert.crt\n  # no CRLs there yet\n  SSLCARevocationPath /etc/apache2/ssl.crl\n \n  SSLVerifyClient optional\n  SSLVerifyDepth 2\n\n  # standard config for IE bugs\n  SetEnvIf User-Agent \".*MSIE.*\" \\\n         nokeepalive ssl-unclean-shutdown \\\n         downgrade-1.0 force-response-1.0\n\n  # ...some RewriteRules...\n</VirtualHost>\n\nWhen accessing this, the browser correctly prompts for the client certificate.\nIf I do not chose any, it works. It also works if I disable SSLClientVerify.\nAs soon as Apache gets a certificate, it fails.\n\nStack trace (sorry, no debug info):\nProgram received signal SIGSEGV, Segmentation fault.\n0x4041605b in CRYPTO_get_ex_data () from /usr/lib/libcrypto.so.0.9.7\n(gdb) bt\n#0  0x4041605b in CRYPTO_get_ex_data () from /usr/lib/libcrypto.so.0.9.7\n#1  0x00000000 in ?? ()\n#2  0x00000000 in ?? ()\n#3  0x404712bd in CRYPTO_lock () from /usr/lib/libcrypto.so.0.9.7\n#4  0x403b6d0c in ?? () from /usr/lib/libssl.so.0.9.7\n#5  0x00000000 in ?? ()\n#6  0x00000000 in ?? ()\n#7  0x403ac60d in SSL_get_ex_data () from /usr/lib/libssl.so.0.9.7\n#8  0x00000000 in ?? ()\n#9  0x4037efc4 in ?? () from /usr/lib/apache2-prefork/mod_ssl.so\n#10 0x40367e95 in ssl_callback_SSLVerify () from /usr/lib/apache2-prefork/mod_ssl.so\n#11 0x40454310 in internal_verify () from /usr/lib/libcrypto.so.0.9.7\n#12 0x40367e60 in ssl_callback_SSLVerify_CRL ()\n   from /usr/lib/apache2-prefork/mod_ssl.so\nPrevious frame inner to this frame (corrupt stack?)\n\nI set LogLevel to debug and got this in the VirtualHost-specific log file:\n[Tue May 10 18:16:58 2005] [debug] ssl_engine_kernel.c(1786): OpenSSL:\nHandshake: start\n[Tue May 10 18:16:58 2005] [debug] ssl_engine_kernel.c(1794): OpenSSL: Loop:\nbefore/accept initialization\n[Tue May 10 18:16:58 2005] [debug] ssl_engine_io.c(1621): OpenSSL: read 11/11\nbytes from BIO#82821d8 [mem: 8289858] (BIO dump follows)\n[...]\n[Tue May 10 18:16:58 2005] [debug] ssl_engine_io.c(1621): OpenSSL: read 94/94\nbytes from BIO#82821d8 [mem: 8289863] (BIO dump follows)\n[...]\n[Tue May 10 18:16:58 2005] [debug] ssl_engine_kernel.c(1794): OpenSSL: Loop:\nSSLv3 read client hello A\n[Tue May 10 18:16:58 2005] [debug] ssl_engine_kernel.c(1794): OpenSSL: Loop:\nSSLv3 write server hello A\n[Tue May 10 18:16:58 2005] [debug] ssl_engine_kernel.c(1794): OpenSSL: Loop:\nSSLv3 write certificate A\n[Tue May 10 18:16:58 2005] [debug] ssl_engine_kernel.c(1178): handing out\ntemporary 1024 bit DH key\n[Tue May 10 18:16:58 2005] [debug] ssl_engine_kernel.c(1794): OpenSSL: Loop:\nSSLv3 write key exchange A\n[Tue May 10 18:16:58 2005] [debug] ssl_engine_kernel.c(1794): OpenSSL: Loop:\nSSLv3 write certificate request A\n[Tue May 10 18:16:58 2005] [debug] ssl_engine_kernel.c(1794): OpenSSL: Loop:\nSSLv3 flush data\n[Tue May 10 18:17:01 2005] [debug] ssl_engine_io.c(1621): OpenSSL: read 5/5\nbytes from BIO#82821d8 [mem: 8289858] (BIO dump follows)\n[...]\n[Tue May 10 18:17:01 2005] [debug] ssl_engine_io.c(1621): OpenSSL: read\n1115/1115 bytes from BIO#82821d8 [mem: 828985d] (BIO dump follows)\n[... lots of data containing client certificate...]\n\nThat's it. Then, the global error_log says:\n[Tue May 10 18:17:01 2005] [notice] child pid 27886 exit signal Segmentation\nfault (11)"}, {"count": 1, "tags": [], "text": "This is SuSE?  The issue is fixed in 2.0.54, it's partly a bug due to bad\npatches applied by SuSE.\n\n*** This bug has been marked as a duplicate of 32529 ***", "attachment_id": null, "id": 74696, "creator": "jorton@redhat.com", "time": "2005-05-10T22:47:00Z", "bug_id": 34846, "creation_time": "2005-05-10T22:47:00Z", "is_private": false}, {"count": 2, "tags": [], "text": "Yes, it is SuSE 9.3, apache2-2.0.53-9 .\n\nThanks for the quick response, I'll ask SuSE about it. I also saw the other case\nbut it did not look related to me.", "attachment_id": null, "id": 74720, "creator": "apache.org@tisc.de", "time": "2005-05-11T16:44:05Z", "bug_id": 34846, "creation_time": "2005-05-11T16:44:05Z", "is_private": false}]