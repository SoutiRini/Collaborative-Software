[{"count": 0, "tags": [], "bug_id": 17191, "attachment_id": null, "text": "tmpnam is not good on win32 platforms.\nI was changing it in mod_authn_mysql, and figured i could help fix\nmod_auth_digest while i was at it.\n\n\n--- mod_auth_digest.c\tTue Feb 18 22:25:50 2003\n+++ mod_auth_digest.c.new\tTue Feb 18 22:36:31 2003\n@@ -119,6 +119,7 @@\n #include \"apr_shm.h\"\n #include \"apr_rmm.h\"\n #include \"ap_provider.h\"\n+#include \"apr_file_io.h\" /* for apr_file_mktemp */\n \n #include \"mod_auth.h\"\n \n@@ -222,8 +223,8 @@\n static apr_time_t     *otn_counter;     /* one-time-nonce counter */\n static apr_global_mutex_t *client_lock = NULL;\n static apr_global_mutex_t *opaque_lock = NULL;\n-static char           client_lock_name[L_tmpnam];\n-static char           opaque_lock_name[L_tmpnam];\n+static char           *client_lock_name;\n+static char           *opaque_lock_name;\n \n #define DEF_SHMEM_SIZE  1000L           /* ~ 12 entries */\n #define DEF_NUM_BUCKETS 15L\n@@ -304,10 +305,17 @@\n {\n     unsigned long idx;\n     apr_status_t   sts;\n+    apr_file_t *tmpfile;\n+    char *shm_create_name;\n \n-    /* set up client list */\n+    sts = apr_file_mktemp(&tmpfile, shm_create_name, 0, ctx);\n+    if (sts != APR_SUCCESS) {\n+        log_error_and_cleanup(\"failed to allocate temp file for shared memory\nsegments\", sts, s);         \n+        return;\n+    }\n \n-    sts = apr_shm_create(&client_shm, shmem_size, tmpnam(NULL), ctx);\n+    /* set up client list */\n+    sts = apr_shm_create(&client_shm, shmem_size, shm_create_name, ctx);\n     if (sts != APR_SUCCESS) {\n         log_error_and_cleanup(\"failed to create shared memory segments\", sts, s);\n         return;\n@@ -326,9 +334,12 @@\n     client_list->tbl_len     = num_buckets;\n     client_list->num_entries = 0;\n \n-    tmpnam(client_lock_name);\n-    /* FIXME: get the client_lock_name from a directive so we're portable\n-     * to non-process-inheriting operating systems, like Win32. */\n+    sts = apr_file_mktemp(&tmpfile, client_lock_name, 0, ctx);\n+    if (sts != APR_SUCCESS) {\n+        log_error_and_cleanup(\"failed to allocate temp file for client\nlocking\", sts, s);         \n+        return;\n+    }\n+\n     sts = apr_global_mutex_create(&client_lock, client_lock_name,\n                                   APR_LOCK_DEFAULT, ctx);\n     if (sts != APR_SUCCESS) {\n@@ -346,9 +357,11 @@\n     }\n     *opaque_cntr = 1UL;\n \n-    tmpnam(opaque_lock_name);\n-    /* FIXME: get the opaque_lock_name from a directive so we're portable\n-     * to non-process-inheriting operating systems, like Win32. */\n+    sts = apr_file_mktemp(&tmpfile, opaque_lock_name, 0, ctx);\n+    if(sts != APR_SUCCESS) {\n+        log_error_and_cleanup(\"failed to allocate temp file for global\nlocking\", sts, s);         \n+        return;\n+    }\n     sts = apr_global_mutex_create(&opaque_lock, opaque_lock_name,\n                                   APR_LOCK_DEFAULT, ctx);\n     if (sts != APR_SUCCESS) {", "id": 31575, "time": "2003-02-19T06:46:36Z", "creator": "chip@cyan.com", "creation_time": "2003-02-19T06:46:36Z", "is_private": false}, {"text": "I'm going through the bug db to make sure patches are findable.  Please see \nhttp://httpd.apache.org/dev/patches.html\n", "tags": [], "bug_id": 17191, "is_private": false, "count": 1, "id": 47810, "time": "2003-11-21T17:21:15Z", "creator": "trawick@apache.org", "creation_time": "2003-11-21T17:21:15Z", "attachment_id": null}, {"text": "Note that the logic from your patch, which I copied below, is usually going to\nsegfault.  Also, the associated feature of mod_auth_digest is disabled via\n\"#define APR_HAS_SHARED_MEMORY 0\" until other problems are resolved.  For now\nI'm marking the PR as invalid, but feel free to re-open if you can correct this\nissue (see doc for apr_file_mktemp()) and submit a new, tested patch.  Thanks!\n\n+    char *shm_create_name;\n \n-    /* set up client list */\n+    sts = apr_file_mktemp(&tmpfile, shm_create_name, 0, ctx);\n", "tags": [], "bug_id": 17191, "is_private": false, "count": 2, "id": 48347, "time": "2003-12-01T17:58:05Z", "creator": "trawick@apache.org", "creation_time": "2003-12-01T17:58:05Z", "attachment_id": null}]