[{"count": 0, "tags": [], "text": "Created attachment 27047\nEnhance mod_proxy and _balancer with worker status flag to only accept sticky session routes\n\nThis enhancement, actually SVN Patched against 2.2.19, provides a worker status flag to set a proxy worker as only accepting requests with sticky session routes, e.g. only accept requests with a .route such as Cookie JSESSIONID=xxx.tc2.\n\nThis allows for a graceful fade-out of servers when their sessions are removed; they continue to receive requests for their sticky session routes but are passed over for requests with no specified route, just as if they were disabled.  In other words, route-only workers are only enabled for sticky session routes.\n\nIntended use (Tomcat JSESSIONID noted here but could be PHPSESSIONID, Ruby _session_id, or anything with cookie or request-parameter based session ids):\n1. An Apache rev-proxy running for multiple Tomcats.\n2. To fade-out a Tomcat for maintenance, set route-only enabled in the balancer-manager or reload the configuration with the worker status +R.\n(This depends on Tomcat web-apps delete session cookies, see further below.)\n3. Check on the balancer-manager or its Tomcat worker even a few minutes / hours, and when it seems to have completed old sessions you can mark it fully disabled/\n4. Once done maintenance, you can then set route-only disabled (status -R) and fully enable the worker again.\n\nTo delete a JSESSIONID Cookie from a Servlet, you need to specify the same Domain and Path as the original Cookie and setMaxAge=0 as in the typical example below but you should check on your own Domain and Path when a Cookie is created, e.g. watch the Cookie headers in Firefox Firebug.\n\n\t// To delete a Cookie setMaxAge(0) and also any original domain and path if specified.\n\tCookie ck = new Cookie(\"JSESSIONID\", null);\n\t//ck.setDomain(\"\");\n\tck.setPath(request.getContextPath());\n\tck.setMaxAge(0);\n\tresponse.addCookie(ck);", "is_private": false, "bug_id": 51247, "id": 146552, "time": "2011-05-23T18:42:44Z", "creator": "kmashint@yahoo.com", "creation_time": "2011-05-23T18:42:44Z", "attachment_id": 27047}, {"attachment_id": 27060, "tags": [], "bug_id": 51247, "is_private": false, "count": 1, "id": 146621, "time": "2011-05-25T12:29:20Z", "creator": "kmashint@yahoo.com", "creation_time": "2011-05-25T12:29:20Z", "text": "Created attachment 27060\nmod_proxy_route_only_for_trunk.patch\n\nThis is a patch in theory only, since I'm still fighting to get the trunk to compile, but wanted to share the intent and will replace once compiled."}, {"attachment_id": 27061, "tags": [], "bug_id": 51247, "is_private": false, "count": 2, "id": 146624, "time": "2011-05-25T12:53:18Z", "creator": "kmashint@yahoo.com", "creation_time": "2011-05-25T12:53:18Z", "text": "Created attachment 27061\nmod_proxy_route_only_for_2_2_19.patch\n\nRe-attach patch for 2.2.19 marking it specifically as a patch."}, {"count": 3, "tags": [], "text": "Created attachment 27073\nmod_proxy_route_only_for_2_2_19\n\nJust making the constant forward compatible with the trunk for 2.3.x.", "attachment_id": 27073, "bug_id": 51247, "id": 146669, "time": "2011-05-27T01:13:54Z", "creator": "kmashint@yahoo.com", "creation_time": "2011-05-27T01:13:54Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 51247, "is_private": false, "count": 4, "id": 148739, "time": "2011-08-21T15:48:26Z", "creator": "kmashint@yahoo.com", "creation_time": "2011-08-21T15:48:26Z", "text": "A similar idea is in https://issues.apache.org/bugzilla/show_bug.cgi?id=48841 :\n\"mod_proxy only allows a BalancerMember's loadfactor to be set to a value\nbetween 1 and 100.  Ideally, loadfactor should be allowed to be set to 0 so\nthat a BalancerMember can be removed from new traffic but allowed to keep\nservicing existing sessions (i.e. bleeding off sessions) or to be able to start\na BalancerMember and test it before letting new traffic access it.\"\n\nThis is also a useful way to gracefully drop a reverse-proxy back-end server from use."}, {"count": 5, "tags": [], "text": "A similar idea is in https://issues.apache.org/bugzilla/show_bug.cgi?id=48841 :\n\"mod_proxy only allows a BalancerMember's loadfactor to be set to a value\nbetween 1 and 100.  Ideally, loadfactor should be allowed to be set to 0 so\nthat a BalancerMember can be removed from new traffic but allowed to keep\nservicing existing sessions (i.e. bleeding off sessions) or to be able to start\na BalancerMember and test it before letting new traffic access it.\"\n\nThis is also a useful way to gracefully drop a reverse-proxy back-end server from use.", "is_private": false, "id": 148740, "creation_time": "2011-08-21T15:54:26Z", "time": "2011-08-21T15:54:26Z", "creator": "kmashint@yahoo.com", "bug_id": 51247, "attachment_id": null}, {"count": 6, "tags": [], "creator": "kmashint@yahoo.com", "attachment_id": null, "is_private": false, "id": 148741, "time": "2011-08-21T15:55:54Z", "bug_id": 51247, "creation_time": "2011-08-21T15:55:54Z", "text": "A similar idea is in https://issues.apache.org/bugzilla/show_bug.cgi?id=48841 :\n\"mod_proxy only allows a BalancerMember's loadfactor to be set to a value\nbetween 1 and 100.  Ideally, loadfactor should be allowed to be set to 0 so\nthat a BalancerMember can be removed from new traffic but allowed to keep\nservicing existing sessions (i.e. bleeding off sessions) or to be able to start\na BalancerMember and test it before letting new traffic access it.\"\n\nThis is also a useful way to gracefully drop a reverse-proxy back-end server from use.  Either one will do.  Would be good as a backport to 2.2 as well."}, {"count": 7, "tags": [], "bug_id": 51247, "attachment_id": null, "id": 149511, "time": "2011-09-20T01:39:25Z", "creator": "kmashint@yahoo.com", "creation_time": "2011-09-20T01:39:25Z", "is_private": false, "text": "Related to https://issues.apache.org/bugzilla/show_bug.cgi?id=48841 where that allows the magic/special value of lbfactor=0 to support the same idea, taking that server out of the balancer for new sessions but still allowing sticky sessions/routes through.  The other has the advantage of not requiring a new status and reusing the lbfactor, but complicates the lbfactor calculations to ensure they deal with divide-by-zero."}, {"attachment_id": 27542, "tags": [], "bug_id": 51247, "is_private": false, "count": 8, "id": 149519, "time": "2011-09-20T11:26:03Z", "creator": "kmashint@yahoo.com", "creation_time": "2011-09-20T11:26:03Z", "text": "Created attachment 27542\nmod_proxy_route_only_for_2_2_21.patch"}, {"count": 9, "tags": [], "text": "This was resolved in the trunk for 2.4.x as https://issues.apache.org/bugzilla/show_bug.cgi?id=48841.\n\n*** This bug has been marked as a duplicate of bug 48841 ***", "attachment_id": null, "bug_id": 51247, "id": 149521, "time": "2011-09-20T11:34:27Z", "creator": "kmashint@yahoo.com", "creation_time": "2011-09-20T11:34:27Z", "is_private": false}, {"count": 10, "text": "Created attachment 27585\nBackport of this idea adopted as a Drain status from 2.3/2.4 to Apache-2.2", "creator": "kmashint@yahoo.com", "attachment_id": 27585, "id": 149730, "time": "2011-09-25T18:03:58Z", "bug_id": 51247, "creation_time": "2011-09-25T18:03:58Z", "tags": [], "is_private": false}, {"count": 11, "tags": [], "bug_id": 51247, "attachment_id": null, "id": 150508, "time": "2011-10-13T02:21:41Z", "creator": "kmashint@yahoo.com", "creation_time": "2011-10-13T02:21:41Z", "is_private": false, "text": "Also note the difference with this and 48841 as compared to the \"Route Redirect\" functionality is that the \"Route Redirect\" only redirects existing routes but allows new sessions to be balanced/elected on the server intended to be redirected.\n\nThe \"Drain\" change happens such that ONLY a defined route will make it to the server, and it will never be balanced/elected for requests without its defined route.  This cleanly supports phasing a server completely out of use when all its sessions have ended.\n\nI'll try to keep up with the backport as new 2.2.x versions come out, but it would be nice to include in a futre 2.2.x version."}, {"attachment_id": null, "tags": [], "bug_id": 51247, "is_private": false, "count": 12, "id": 158764, "time": "2012-05-03T04:39:27Z", "creator": "kmashint@yahoo.com", "creation_time": "2012-05-03T04:39:27Z", "text": "I checked against the Apache 2.2.22 release and the backport of the Drain status from 2.3/2.4 to Apache-2.2 should work for 2.2.22 as well as 2.2.21 since there were no competing changes."}, {"count": 13, "tags": [], "creator": "kmashint@yahoo.com", "is_private": false, "text": "Created attachment 28765\n2.2.21 Win32 Release build to add Drain status to proxy balancer workers", "id": 158995, "time": "2012-05-12T22:36:19Z", "bug_id": 51247, "creation_time": "2012-05-12T22:36:19Z", "attachment_id": 28765}, {"count": 14, "tags": [], "creator": "kmashint@yahoo.com", "is_private": false, "text": "Created attachment 28769\n2.2.22 Win32 Release build to add Drain status to proxy balancer workers", "id": 159010, "time": "2012-05-13T15:07:38Z", "bug_id": 51247, "creation_time": "2012-05-13T15:07:38Z", "attachment_id": 28769}, {"count": 15, "tags": [], "bug_id": 51247, "attachment_id": null, "id": 159042, "time": "2012-05-14T18:28:44Z", "creator": "wrowe@apache.org", "creation_time": "2012-05-14T18:28:44Z", "is_private": false, "text": "Keith, I am deleting the binary attachments.  We have a quite strict policy of\nonly posting binaries on apache.org that come from committers to a project.\nWhile we expect anyone applying patches from our issue trackers to carefully\nvet and evaluate the suitability of patches for their own compilations, it is\nnot possible to do this effectively with binary blobs.\n\nMoreso, the bug tracker is not an efficient distribution mechanism, please feel\nfree to post a link to your own site for users who might want to obtain this\nfeature in advance of a release, of course the onus is on them and as it isn't\nhosted at the ASF, we disclaim any responsibility.\n\nBut please don't let this dampen your enthusiam, this is a long sought-after\nfeature and the contribution was great!"}, {"count": 16, "tags": [], "text": "Understood that ASF doesn't want the security and other overhead of dealing with binary files in Bugzilla.\n\nI've provided a URL, also below, to download the backport of the proxy balancer/worker Drain status to Apache 2.2.21 and .22.\n\nhttps://docs.google.com/open?id=0B5zLg35jBZLTMFN3c2JBc014RVU", "attachment_id": null, "id": 159056, "creation_time": "2012-05-14T23:28:18Z", "time": "2012-05-14T23:28:18Z", "creator": "kmashint@yahoo.com", "bug_id": 51247, "is_private": false}, {"count": 17, "text": "Reopened to tag as fixed.", "creator": "wrowe@apache.org", "attachment_id": null, "id": 162521, "time": "2012-10-02T20:38:27Z", "bug_id": 51247, "creation_time": "2012-10-02T20:38:27Z", "tags": [], "is_private": false}, {"count": 18, "tags": [], "text": "Fixed on trunk and 2.4.x.", "is_private": false, "id": 162522, "creation_time": "2012-10-02T20:38:55Z", "time": "2012-10-02T20:38:55Z", "creator": "wrowe@apache.org", "bug_id": 51247, "attachment_id": null}, {"count": 19, "tags": [], "text": "*** Bug 48841 has been marked as a duplicate of this bug. ***", "is_private": false, "id": 162528, "creation_time": "2012-10-02T22:41:27Z", "time": "2012-10-02T22:41:27Z", "creator": "sebb@apache.org", "bug_id": 51247, "attachment_id": null}, {"count": 20, "tags": [], "text": "Does this work?\nThree years later, the documentation still states that load factor has range 1..100, and 0 does not work in Apache 2.4.12:\n\nAH00526: Syntax error on line 13 of /.../config/workers.conf:\nBalancerMember LoadFactor must be a number between 1..100\n\nWould anyone care to shed some light on this?", "attachment_id": null, "id": 182747, "creation_time": "2015-04-30T08:15:40Z", "time": "2015-04-30T08:15:40Z", "creator": "einarmr@gmail.com", "bug_id": 51247, "is_private": false}, {"count": 21, "tags": [], "creator": "kmashint@yahoo.com", "is_private": false, "text": "This was implemented in Apache 2.4 as the Drain status, a separate configuration from the LoadFactor.  I noted a \"backport ... to Apache-2.2\" as attached, which introduces the Drain status to Apache 2.2 as it would be in 2.4 rather than accepting LoadFactor 0.", "id": 182921, "time": "2015-05-11T04:15:08Z", "bug_id": 51247, "creation_time": "2015-05-11T04:15:08Z", "attachment_id": null}]