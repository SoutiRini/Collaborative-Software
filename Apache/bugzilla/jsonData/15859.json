[{"count": 0, "tags": [], "text": "Looks like a possible RFC 2616 MUST violation. \nApache decodes chunked encoding correctly but\nforwards wrong Content-Length header which now MUST\nbe honored since Apache removed chunked encoding.\nThus, the overall result is that a compliant client\nwould see truncated content (e.g., $100 instead of $1000)\nbecause of how Apache changed the message it was\nforwarding.\n\nSee attached trace for details and ways to reproduce.\n\nTest case IDs in the trace link to human-oriented test case\ndescription and RFC quotes, if available.", "attachment_id": null, "id": 28960, "creator": "coad@measurement-factory.com", "time": "2003-01-07T21:01:22Z", "bug_id": 15859, "creation_time": "2003-01-07T21:01:22Z", "is_private": false}, {"count": 1, "tags": [], "text": "Created attachment 4352\ntest case trace", "attachment_id": 4352, "id": 28961, "creator": "coad@measurement-factory.com", "time": "2003-01-07T21:02:06Z", "bug_id": 15859, "creation_time": "2003-01-07T21:02:06Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 15859, "attachment_id": null, "is_private": false, "id": 35244, "time": "2003-04-15T17:32:23Z", "creator": "minfrin@sharp.fm", "creation_time": "2003-04-15T17:32:23Z", "text": "Is the following sentence correct?\n\n\"A proxy MUST remove a Content-Length header from chunked responses, in case\nthis content length header is wrong\".\n"}, {"count": 3, "tags": [], "bug_id": 15859, "text": "Not exactly, but very close, IMO.\n\nThe proxy MUST ignore wrong Content-Length header in chunked\nresponses (which is what Apache is probably doing). It would\nbe OK to forward that header, provided that the proxy does\nnot decode chunks on-the-fly. A compliant recipient would\nnot have a problem handling such a response (chunked\nencoding with wrong Content-Length header).\n\nHowever, Apache decodes chunks into \"normal\" (identity)\nencoding and forwards the response with the original (wrong)\nContent-Length value. While there is no specific MUST about\nthis case, the only logical interpretation or RFC 2616\nsuggests that the wrong Content-Length header must be\nremoved. Otherwise, a compliant recipient will mis-interpret\nthe response!\n\nIf you want a one sentence summary, I would say: \"A proxy\nhas to remove the wrong Content-Length header when\nforwarding a chunked response using identity encoding (i.e.,\nwhen de-chunking on-the-fly).\"\n", "id": 35248, "time": "2003-04-15T17:50:45Z", "creator": "coad@measurement-factory.com", "creation_time": "2003-04-15T17:50:45Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "text": "The problem though is that we cannot know the Content-Length is wrong until we\nhave processed the entire request. At this point we would have already sent the\nContent-Length header onwards, so it's too late to fix it if it is wrong - it\nwould require the proxy to buffer the entire request before sending it on, which\nis not practical.\n\nOne possible thing to do though is to remove the Content-Length header should\nApache decide to send chunked encoding. This needs to be done inside the filter\nresponsible for chunking, rather than mod_proxy.\n\nThoughts?\n", "attachment_id": null, "id": 35249, "creator": "minfrin@sharp.fm", "time": "2003-04-15T17:57:34Z", "bug_id": 15859, "creation_time": "2003-04-15T17:57:34Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 15859, "attachment_id": null, "text": "The Content-Length header is _always_ wrong when it is used together\nwith chunking because Content-Length header is defined to represent\nboth entity-length and the transfer-length. It is not possible to represent both with a single value when chunking is used.\n\nThus, only two actions would be correct, IMO:\n   - leave wrong Content-Length header and do NOT de-chunk\n   - remove wrong Content-Length header\n\nNote that there is no need to remove Content-Length header if Apache decides to send chunked encoding. It is de-chunking that causes the problem.", "id": 35250, "time": "2003-04-15T18:05:11Z", "creator": "coad@measurement-factory.com", "creation_time": "2003-04-15T18:05:11Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 15859, "text": "Is this related to:\n<http://nagoya.apache.org/bugzilla/show_bug.cgi?id=21348>\n\nIf so, this bug breaks WindowsUpdate when used behind mod_proxy. Patch is linked\nin above bug that might be applicable.", "id": 41578, "time": "2003-07-26T22:08:31Z", "creator": "cvig@raw-io.com", "creation_time": "2003-07-26T22:08:31Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 15859, "text": "The WindowsUpdate patch you mentioned has no visible effect\non this bug. Note that the patch seems to be designed to\naffect HEAD responses while this bug deals with GET responses.\n", "id": 42829, "time": "2003-08-15T21:37:06Z", "creator": "coad@measurement-factory.com", "creation_time": "2003-08-15T21:37:06Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 15859, "text": "*** Bug 31454 has been marked as a duplicate of this bug. ***", "id": 64346, "time": "2004-09-28T19:13:06Z", "creator": "nick@webthing.com", "creation_time": "2004-09-28T19:13:06Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 15859, "text": "*** Bug 11993 has been marked as a duplicate of this bug. ***", "id": 67485, "time": "2004-11-26T11:31:33Z", "creator": "nick@webthing.com", "creation_time": "2004-11-26T11:31:33Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 15859, "text": "I believe that this problem relates to proxying of _all_ requests with\nchunked request data, not just those with a bogus Content-Length.\n\nmod_proxy is de-chunking and removing Transfer-Encoding: chunked, forwarding\na request with neither Content-Length: or Transfer-Encoding: header. This\ncauses the downstream server to reply with error 411 \"Length Required\".\n\nBug 11618 has a network trace showing this clearly.\n\nSince it is not possible to send a correct Content-Length header without\nbuffering all request data, it seems to me that the proper fix is to not\nde-chunk if the original request is chunked?\n\nI looked briefly in the function ap_proxy_http_request in proxy_http.c.\nHow about if the original request uses chunked transfer-encoding, then\nthe proxied request is also send as chunked? I could try to create a patch\nto add that to the code, it seems not too hard:\n\n    /* send the request data, if any. */\n    seen_eos = 0;\n    do {\n        status = ap_get_brigade(r->input_filters, bb, AP_MODE_READBYTES,\n                                APR_BLOCK_READ, HUGE_STRING_LEN);\n\n        if (status != APR_SUCCESS) {\n            return status;\n        }\n\n        /* If this brigade contain EOS, either stop or remove it. */\n        if (APR_BUCKET_IS_EOS(APR_BRIGADE_LAST(bb))) {\n            /* As a shortcut, if this brigade is simply an EOS bucket,\n             * don't send anything down the filter chain.\n             */\n            if (APR_BUCKET_IS_EOS(APR_BRIGADE_FIRST(bb))) {\n                break;\n            }\n\n            /* We can't pass this EOS to the output_filters. */\n            e = APR_BRIGADE_LAST(bb);\n            apr_bucket_delete(e);\n            seen_eos = 1;\n        }\n\n        e = apr_bucket_flush_create(c->bucket_alloc);\n        APR_BRIGADE_INSERT_TAIL(bb, e);\n\n        status = ap_pass_brigade(origin->output_filters, bb);\n        if (status != APR_SUCCESS) {\n            ap_log_error(APLOG_MARK, APLOG_ERR, status, r->server,\n                         \"proxy: pass request data failed to %pI (%s)\",\n                         p_conn->addr, p_conn->name);\n            return status;\n        }\n        apr_brigade_cleanup(bb);\n    } while (!seen_eos);\n", "id": 67488, "time": "2004-11-26T12:03:10Z", "creator": "kn@sifira.dk", "creation_time": "2004-11-26T12:03:10Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "text": "You do not need to code it as httpd-2.1 has it already fixed.\nI also backported it in the patch of Bug 31454 which was apparently a DUPE, you\ncan repost the patch here if you wish.\nI am using my patch on my server for: Fedora Core 3 httpd-2.0.52-3.1\n", "attachment_id": null, "id": 67489, "creator": "web-nagoya.apache.org@jankratochvil.net", "time": "2004-11-26T12:30:23Z", "bug_id": 15859, "creation_time": "2004-11-26T12:30:23Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 15859, "text": "I've been working on some improvements to the current solution in Apache 2.1.  A\nbackport of my current 2.0 code is in a patch at\nhttp://www.apache.org/~trawick/20proxyreqbody.txt\nThe version of this for Apache 2.1-dev is in the proxy-reqbody branch in subversion.\n.\nAny comments or additional testing would be appreciated.\n", "id": 69384, "time": "2005-01-07T19:47:50Z", "creator": "trawick@apache.org", "creation_time": "2005-01-07T19:47:50Z", "is_private": false, "attachment_id": null}, {"count": 13, "tags": [], "bug_id": 15859, "text": "The current version of http://www.apache.org/~trawick/20proxyreqbody.txt\nsuccessfully tested on SonyEricsson P900 (sorry for the response time as I do\nnot have the device available). <bite>Patch version-name change on its content\nchange would be preferred.</bite>\n", "id": 70393, "time": "2005-02-02T18:18:04Z", "creator": "web-nagoya.apache.org@jankratochvil.net", "creation_time": "2005-02-02T18:18:04Z", "is_private": false, "attachment_id": null}, {"count": 14, "tags": [], "text": ">Patch version-name change on its content change would be preferred.\n\ngood idea for the future...\n\nand thanks for the test report!  I assume that some type of upload from the\nphone would not work through mod_proxy without this patch????", "attachment_id": null, "id": 70401, "creator": "trawick@apache.org", "time": "2005-02-02T19:13:29Z", "bug_id": 15859, "creation_time": "2005-02-02T19:13:29Z", "is_private": false}, {"count": 15, "tags": [], "creator": "web-nagoya.apache.org@jankratochvil.net", "attachment_id": null, "text": "SonyEricsson P900 uses buzzword WAP-2.0 which no longer transfers WAP/WML over\nWSP/WTP protocols but it started using HTTP/TCP. P900 will interpret WAP-1.x WAP\ngateway settings sent over SMS as HTTP proxy for its WAP-2.0 (IMO incorrectly).\nDuring MMS send operation P900 will send chunked POST, current mod_proxy will\ndechunk it but it will not fill in the Content-Length making the final head+body\nPOST request combo invalid. See (I could no longer find the TCP snaps):\nhttp://marc.theaimsgroup.com/?l=apache-httpd-dev&m=109186315924289\n", "id": 70403, "time": "2005-02-02T19:32:00Z", "bug_id": 15859, "creation_time": "2005-02-02T19:32:00Z", "is_private": false}, {"count": 16, "tags": [], "creator": "trawick@apache.org", "attachment_id": null, "text": "fix committed to 2.0.next", "id": 75170, "time": "2005-05-21T14:54:33Z", "bug_id": 15859, "creation_time": "2005-05-21T14:54:33Z", "is_private": false}, {"count": 17, "tags": [], "bug_id": 15859, "text": "Created attachment 15295\nfresh test trace\n\nSorry, but the current http://www.apache.org/~trawick/20proxyreqbody.txt\nfix does not solve the problem. Patched Apache httpd-2.0.54 is still\nsending\n    Content-Length: 15\nwhen the [dechunked] content is actually 20 bytes. \nPlease see the attached fresh trace.\nAre we testing with the wrong fix?", "id": 75997, "time": "2005-06-03T23:48:50Z", "creator": "coad@measurement-factory.com", "creation_time": "2005-06-03T23:48:50Z", "is_private": false, "attachment_id": 15295}, {"count": 18, "tags": [], "creator": "coad@measurement-factory.com", "attachment_id": null, "text": "I am taking the liberty of reopening this bug\nbecause the test case still fails (see above).\n", "id": 75998, "time": "2005-06-03T23:50:45Z", "bug_id": 15859, "creation_time": "2005-06-03T23:50:45Z", "is_private": false}, {"count": 19, "tags": [], "bug_id": 15859, "attachment_id": null, "text": "btw, the proxy-reqbody patch did not affect the response processing...\n\nany idea what is required to have the origin server send both Content-Length\n*and*  Transfer-Encoding?\n", "id": 76002, "time": "2005-06-04T00:46:48Z", "creator": "trawick@apache.org", "creation_time": "2005-06-04T00:46:48Z", "is_private": false}, {"count": 20, "tags": [], "bug_id": 15859, "attachment_id": null, "is_private": false, "id": 76018, "time": "2005-06-04T10:55:34Z", "creator": "jorton@redhat.com", "creation_time": "2005-06-04T10:55:34Z", "text": "Sending both would violate 2616, if the proxy receives a message with both C-L\nand T-E it MUST ignore the C-L header per comment 3."}, {"count": 21, "tags": [], "creator": "web-nagoya.apache.org@jankratochvil.net", "is_private": false, "text": "Created attachment 16218\nsecurity fix for C-L vs T-E handling (Joe Orton, CVE CAN-2005-2088)\n\nJust FYI Joe Orton fixed: Fedora Core Bug:\nhttps://bugzilla.redhat.com/bugzilla/show_bug.cgi?id=162245\n, the same as Red Hat Enterprise Bug:\nhttps://bugzilla.redhat.com/bugzilla/show_bug.cgi?id=162244\nbut unfortunately these patches will disable the funtionality of:\nhttp://www.apache.org/~trawick/20proxyreqbody.txt\nas presented here in Comment #17 .\nReverting its first part restores 20proxyreqbody.txt back as WORKSFORME,\nNot sure if its second part resolves the issue of Comment #17 .", "id": 79066, "time": "2005-08-26T16:07:56Z", "bug_id": 15859, "creation_time": "2005-08-26T16:07:56Z", "attachment_id": 16218}, {"count": 22, "tags": [], "bug_id": 15859, "text": "Is this still open?  It appears to be fixed in trunk at least.", "id": 106130, "time": "2007-07-31T18:19:34Z", "creator": "nick@webthing.com", "creation_time": "2007-07-31T18:19:34Z", "is_private": false, "attachment_id": null}, {"count": 23, "tags": [], "bug_id": 15859, "text": "OK, tested in 2.2.5; the proxy removes the Content-Length.", "id": 107590, "time": "2007-09-01T12:12:36Z", "creator": "nick@webthing.com", "creation_time": "2007-09-01T12:12:36Z", "is_private": false, "attachment_id": null}]