[{"count": 0, "tags": [], "bug_id": 22805, "attachment_id": null, "id": 43453, "time": "2003-08-28T20:09:28Z", "creator": "rgreab@fx.ro", "creation_time": "2003-08-28T20:09:28Z", "is_private": false, "text": "In the message available at the mentioned URL, I describe a bug in Apache that\nsometimes blocks Bricolage, a mod_perl application.\n\nThe bug is caused by the recent work of adding proactive close functions to\nprevent file descriptors leaking to the child processes. Basically, in\nhttp_main.c, some calls of ap_note_cleanups_for_fd() were replaced with calls to\nap_note_cleanups_for_socket_ex(), but ap_bclose() still calls ap_pclosef() which\ndisarms the cleanup for files, not for sockets. Later, the cleanup for socket is\ninvoked because it was not disabled and closes for the second time a file\ndescriptor which may be already closed (no harm) or may be in use by someone\nelse (the Bricolage problem).\n\nI'm proposing a patch that:\n- in buff.c: modifies ap_bclose() so that on all platforms ap_pclosesocket() is\ncalled for sockets and ap_closef() is called for files;\n- in http_main.c:\n  - disarms a cleanup before ap_slack() because ap_slack() closes the socket \n    itself\n  - changes the level to critical for the error message issued when the fd_sets \n    test fails\n  - removes a kill_cleanup before ap_bclose() because it is redundant"}, {"count": 1, "tags": [], "bug_id": 22805, "text": "Created attachment 7989\nproposed patch", "id": 43454, "time": "2003-08-28T20:10:06Z", "creator": "rgreab@fx.ro", "creation_time": "2003-08-28T20:10:06Z", "is_private": false, "attachment_id": 7989}, {"count": 2, "tags": [], "creator": "david@wheeler.net", "is_private": false, "text": "FWIW, Radu wrote up a really good analysis of the problem here:\n\n  http://marc.theaimsgroup.com/?l=apache-modperl-dev&m=106200188613283&w=2", "id": 43908, "time": "2003-09-09T19:15:28Z", "bug_id": 22805, "creation_time": "2003-09-09T19:15:28Z", "attachment_id": null}, {"count": 3, "tags": [], "text": "Fixed in 1.3.29 (ap_bclose changes only)", "is_private": false, "id": 45901, "creator": "jim@apache.org", "time": "2003-10-19T18:40:33Z", "bug_id": 22805, "creation_time": "2003-10-19T18:40:33Z", "attachment_id": null}]