[{"count": 0, "tags": [], "bug_id": 49839, "attachment_id": null, "text": "Confirmed with httpd-2.3.6 (patched with the segmentation fault patch I attached to ticket 49838), built with the following options:\n\n./configure --with-included-apr --with-mpm=prefork\n\nWhen using mod_remoteip, requests handled by an ErrorDocument ignore the mod_remoteip settings.  (The wrong IP is logged to access_log; the wrong REMOTE_ADDR is passed to a PHP-script ErrorDocument.)\n\n(However, the \"[client 1.2.3.4:12345] File does not exist:\" entry in error_log *does* log the correct address.)", "id": 139533, "time": "2010-08-28T16:16:37Z", "creator": "voltara@gmail.com", "creation_time": "2010-08-28T16:16:37Z", "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 49839, "text": "Did you in fact set up the remoteip settings in a global context (or the context\nof the virtual host), or strictly in the context of specific directories/locations\n... if the later you would need to include the error document's context.\n\nIt is all going to depend on whether the error is noted before or after the\nconnection is established and the headers parsed and adjusted; this is as designed.", "id": 139534, "time": "2010-08-28T16:36:01Z", "creator": "wrowe@apache.org", "creation_time": "2010-08-28T16:36:01Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 49839, "attachment_id": null, "is_private": false, "id": 139535, "time": "2010-08-28T17:01:43Z", "creator": "voltara@gmail.com", "creation_time": "2010-08-28T17:01:43Z", "text": "My reduced test case is based on the stock httpd.conf, which is not configured with virtual hosts.  So yes, the configuration is in the global context.\n\nI will poke around at it a bit more today.  Here's what I have so far:\n\nIt looks like remoteip_modify_connection gets called twice when an ErrorDocument is triggered.  The first pass through, it successfully modifies the remote IP; the second pass, it reverts back to the proxy IP.\n\n  Breakpoint 1, remoteip_modify_connection (r=0x1aec3a0) at mod_remoteip.c:222\n\n    [Sat Aug 28 16:53:33.551855 2010] [info] [pid 11585] [client 1.2.3.4:49009] Using 1.2.3.4 as client's IP by proxies 127.0.0.1\n    [Sat Aug 28 16:54:28.524987 2010] [error] [pid 11585] [client 1.2.3.4:49009] File does not exist: /usr/local/apache2/htdocs/blah\n\n  Breakpoint 1, remoteip_modify_connection (r=0x1ae89e8) at mod_remoteip.c:222\n\n    127.0.0.1 - - [28/Aug/2010:16:52:38 -0400] \"GET /blah HTTP/1.1\" 404 45\n\n\n(Don't mind the timestamps; I was single-stepping through with gdb.  The log entries all came from the same HTTP request.)"}, {"count": 3, "tags": [], "bug_id": 49839, "is_private": false, "text": "Created attachment 25957\nproposed bugfix\n\nThe attached patch changes remoteip_modify_connection() to run only once per request.\n\nThe issue I encountered with ErrorRedirect was caused by the handler running again on every internal redirect/subrequest.  Because it removes the proxy IP from the X-Forwarded-For (X-Client-IP) header, each iteration of remoteip_modify_connection would take a different IP from the comma-separated list, until the list was exhausted.", "id": 139536, "time": "2010-08-28T20:10:08Z", "creator": "voltara@gmail.com", "creation_time": "2010-08-28T20:10:08Z", "attachment_id": 25957}, {"count": 4, "tags": [], "text": "Are there any plans to apply this bug fix?  I have been using the attached patch for almost a full year without any problems.\n\nReproducing the bug is straightforward:\n\n1) Compile 2.3.12-beta from sources\n\n2) Add the following to httpd.conf (global scope is OK):\n    Listen 8080\n    RemoteIPHeader X-IP\n    RemoteIPTrustedProxy 127.0.0.0/8 ::1\n    ErrorDocument 404 /index.html\n\n3) Start up httpd and watch the access_log:\n\n# The /index.html file exists, so this works fine:\n$ curl -H'X-IP: 11.22.33.44' http://localhost:8080/index.html\n11.22.33.44 - - [19/Jul/2011:11:21:52 -0400] \"GET /index.html HTTP/1.1\" 200 45\n\n# However, anything that hits the ErrorDocument does not:\n$ curl -H'X-IP: 11.22.33.44' http://localhost:8080/asdfasdfasdf\n127.0.0.1 - - [19/Jul/2011:11:22:55 -0400] \"GET /asdfasdfasdf HTTP/1.1\" 404 45\n\n# And here is how it behaves when multiple, comma-separated addresses are given...\n\n# Correct behavior:\n$ curl -H'X-IP: 2000::1, 11.22.33.44' http://localhost:8080/index.html\n11.22.33.44 - - [19/Jul/2011:12:01:59 -0400] \"GET /index.html HTTP/1.1\" 200 45\n\n# Incorrect behavior:\n$ curl -H'X-IP: 2000::1, 11.22.33.44' http://localhost:8080/asdfasdfasdf\n2000::1 - - [19/Jul/2011:12:02:24 -0400] \"GET /asdfasdfasdf HTTP/1.1\" 404 45", "attachment_id": null, "bug_id": 49839, "id": 148012, "time": "2011-07-19T16:04:38Z", "creator": "voltara@gmail.com", "creation_time": "2011-07-19T16:04:38Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 49839, "attachment_id": null, "is_private": false, "id": 152163, "time": "2011-12-14T13:05:28Z", "creator": "Thomas.jouas@gmail.com", "creation_time": "2011-12-14T13:05:28Z", "text": "(In reply to comment #4)\n> Are there any plans to apply this bug fix?  I have been using the attached\n> patch for almost a full year without any problems.\n\nI Andrew,\nI applied this patch but it doesn't resolve the issue (with my patched version which also include backport to 2.2 and patch for bug 49272) :\n\nwhen a 404 is sent, the RemoteIPHeader is logged in the errorlog but the Proxy IP is logged in the access log. do you confirm ?"}, {"count": 6, "tags": [], "bug_id": 49839, "attachment_id": null, "is_private": false, "id": 152169, "time": "2011-12-14T19:31:01Z", "creator": "voltara@gmail.com", "creation_time": "2011-12-14T19:31:01Z", "text": "(In reply to comment #5)\n> (In reply to comment #4)\n> > Are there any plans to apply this bug fix?  I have been using the attached\n> > patch for almost a full year without any problems.\n> \n> I Andrew,\n> I applied this patch but it doesn't resolve the issue (with my patched version\n> which also include backport to 2.2 and patch for bug 49272) :\n> \n> when a 404 is sent, the RemoteIPHeader is logged in the errorlog but the Proxy\n> IP is logged in the access log. do you confirm ?\n\nThat is how the unpatched mod_remoteip behaves.  The attached patch to remoteip_modify_connection() should have corrected the problem.  I tested by backporting the 2.3.15-beta mod_remoteip.c to compile against 2.2.20-prefork on an Ubuntu machine, and the patch on this ticket worked as expected.\n\nThe only change I had to make to compile the 2.3.15-beta module against 2.2.20 was one line:\n\n<AP_DECLARE_MODULE(remoteip) = {\n>module AP_MODULE_DECLARE_DATA remoteip_module = {\n\nThe fixes for bugs 49272 and 49838 are already included in 2.3.15-beta."}, {"count": 7, "tags": [], "text": "(In reply to comment #6)\n\ndon't know what went wrong in my previous test, I reapplied the patch over the 2.3.15-beta mod_remoteip.c and can confirm you that it works fine and fixed the bug.\n\nThanks", "is_private": false, "id": 152284, "creator": "Thomas.jouas@gmail.com", "time": "2011-12-19T11:26:03Z", "bug_id": 49839, "creation_time": "2011-12-19T11:26:03Z", "attachment_id": null}, {"count": 8, "attachment_id": null, "creator": "wrowe@apache.org", "is_private": false, "id": 152303, "time": "2011-12-19T22:39:47Z", "bug_id": 49839, "creation_time": "2011-12-19T22:39:47Z", "tags": [], "text": "I agree with you that internal subrequests shouldn't be processed.\n\nI'm having trouble with denying these to internal redirects.  If the initial\nvhost/location is not configured for mod_remoteip parsing, but the subsequent\nlocation is configured (because it is mapped to an app uri space, for example),\nthen that subsequent location won't be processed correctly.\n\nComments?"}, {"count": 9, "tags": [], "bug_id": 49839, "attachment_id": null, "id": 174568, "time": "2014-04-15T01:19:15Z", "creator": "voltara@gmail.com", "creation_time": "2014-04-15T01:19:15Z", "is_private": false, "text": "This issue was resolved in httpd-2.3.16 as a consequence of SVN r1208378"}]