[{"count": 0, "tags": [], "bug_id": 41897, "attachment_id": null, "id": 100643, "time": "2007-03-19T19:39:41Z", "creator": "Thorsten.Blome@net-m.de", "creation_time": "2007-03-19T19:39:41Z", "is_private": false, "text": "We're using Apaches(2.2.4) mod_proxy and mod_proxy_balancer to loadbalance \nTomcats(5.5) using mod_proxy_ajp, and found a problem getting both cookie-\nbased and url-rewriting based session-ids to be 'sticky' for \nmod_proxy_balancer.\n\nThe Servlet Spec(see i.e.: \nhttp://www.jcp.org/aboutJava/communityprocess/final/jsr053/ ), in section 7, \nbinds Servlet Containers to use an uppercase param 'JSESSIONID' to hold the \nsessionid in cookies, but a lowercase 'jsessionid' if using url-rewriting(used \nwhen cookies are disabled). And thats exactly what the Tomcats do.\n\nNow, if we have defined stickysession to be 'JSESSIONID' in the ProxyPass \ndirective, i.e. like this:\nProxyPass /me/pub/ balancer://ME-Test/me/pub/ stickysession=JSESSIONID\nwe observe the stickysession feature to work with cookies, but not with url-\nrewriting.\n\nIf we define stickysession to use the lowercase variant, like this:\nProxyPass /me/pub/ balancer://ME-Test/me/pub/ stickysession=jsessionid\nit's just the other way round: url-rewriting is working, but cookies are not.\n\n\nmod_proxy_balancer uses the value stickysession is set to in a case-sensitive \nway for both cookie-based and url-based session-ids, thus being unable to cope \nwith the different cases of 'jsessionid' defined as mandatory by the Servlet \nSpec. This can be seen in the mod_proxy_balancer.c source in get_path_param() \nand get_cookie_param().\n\n\nWhat we did to circumvent the problem was to patch mod_proxy_balancer.c like \nthis:\n--------------------------\n--- mod_proxy_balancer.c.ORIG   2005-11-10 16:20:05.000000000 +0100\n+++ mod_proxy_balancer.c        2006-01-31 18:03:56.000000000 +0100\n@@ -111,9 +111,17 @@\n                           const char *name)\n{\n   char *path = NULL;\n+    char *session_id = NULL;\n+    int  i;\n\n+    session_id= apr_pstrdup(pool, name);\n+    /* Change 'JSESSIONID' to 'jsessionid' to match the value in the url */\n+    if (isupper(name[0])) {\n+        for (i=0;i<=strlen(session_id);i++)\n+            session_id[i] = tolower(session_id[i]);\n+    }\n\n-    for (path = strstr(url, name); path; path = strstr(path + 1, name)) {\n-        path += (strlen(name) + 1);\n+    for (path = strstr(url, session_id); path; path = strstr(path + 1, \nsession_id)) {\n+        path += strlen(session_id);\n       if (*path == '=') {\n           /*\n            * Session path was found, get it's value\n-------------------------- \n(found here: http://mail-archives.apache.org/mod_mbox/httpd-users/200603.mbox/%\n3c9B4E37DCB8D57D408FF960B536F0E5274330E6@ms01012.avinci.de%3e )\n\nAlthough that fixed the problem for us, I do not request to apply exactly this \npatch to the mod_proxy_balancer.c source(because it's rude in a way that it \nonly looks for the lowercase identifier in the URL if an uppercase one is \nconfigured), but I think mod_proxy_balancer.c has to be changed so that either:\n- it is handling the stickysession identifier in an overall case-insensitive \nway, or at least\n- it could additionally look for the lowercase variant in get_path_param(), if \nan uppercase one is configured and not found in the URL"}, {"count": 1, "tags": [], "bug_id": 41897, "is_private": false, "text": "After thinking to it the best way seems to allow 2 parameters separated with a |\nLike:\nProxyPass balancer://mycluster/myapp stickysession=JESSSIONID|jsessionid", "id": 104685, "time": "2007-06-25T07:47:00Z", "creator": "jfclere@gmail.com", "creation_time": "2007-06-25T07:47:00Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 41897, "attachment_id": 20480, "text": "Created attachment 20480\npatch for the httpd-2.2.x\n\nPatch for the 2.2.x branch.", "id": 105208, "time": "2007-07-09T07:00:58Z", "creator": "jfclere@gmail.com", "creation_time": "2007-07-09T07:00:58Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 41897, "attachment_id": null, "text": "This was committed to trunk in this series of patches:\n\n  http://svn.apache.org/viewvc?view=rev&rev=550519\n  http://svn.apache.org/viewvc?view=rev&rev=551099\n  http://svn.apache.org/viewvc?view=rev&rev=551126\n  http://svn.apache.org/viewvc?view=rev&rev=551935\n  http://svn.apache.org/viewvc?view=rev&rev=554892\n\nand backported to 2.2.x here:\n\n  http://svn.apache.org/viewvc?view=rev&rev=557993\n", "id": 116555, "time": "2008-05-13T04:31:42Z", "creator": "jorton@redhat.com", "creation_time": "2008-05-13T04:31:42Z", "is_private": false}]