[{"count": 0, "tags": [], "bug_id": 50833, "text": "Created attachment 26695\nsample xls workbook to use with code provided in description\n\nIf you have a workbook that is protected and you open the it and write it to an output stream, all comments in the workbook end up corrupted.\nAttached is a sample workbook (protected password is \"password\") to use with the following code:\n\nimport java.io.File;\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport org.apache.poi.hssf.usermodel.HSSFWorkbook;\n\npublic class CommentTest {\n\tpublic static void main(String[] args) throws Exception {\n\t\tFile file = new File(\"Book1.xls\");\n\t\tFileInputStream fileInputStream = new FileInputStream(file);\n\t\tHSSFWorkbook workbook = new HSSFWorkbook(fileInputStream);\n\t\tworkbook.write(new FileOutputStream(new File(\"Book1_copy.xls\")));\n\t}\n}", "id": 144569, "time": "2011-02-25T18:49:20Z", "creator": "robertl@jlab.org", "creation_time": "2011-02-25T18:49:20Z", "is_private": false, "attachment_id": 26695}, {"count": 1, "tags": [], "bug_id": 50833, "text": "When you first read the file in, can POI see all your comments fine?\n\nAfter writing the file out, can POI read it back in and still see the comments? (i.e. are they corrupted for both POI and Excel, or just for Excel?)", "id": 144590, "time": "2011-02-26T16:44:11Z", "creator": "apache@gagravarr.org", "creation_time": "2011-02-26T16:44:11Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 50833, "attachment_id": null, "text": "Not quite sure why you need me to answer these questions as the bug is easily reproduce-able using the provided code and any Excel doc...\nDon't you guys verify these bugs?\nI assume that if I don't answer them, this bug report will probably be dismissed because no one takes the initiative to try to answer the questions themselves so I will...\n\nQ: When you first read the file in, can POI see all your comments fine?\nA: Yes\n\nQ: After writing the file out, can POI read it back in and still see the comments?\n(i.e. are they corrupted for both POI and Excel, or just for Excel?)\nA: POI can read the file back in and still see the comments.\n\n\n\nHere is a modified version of my original test code that answers your questions:\n\n\nimport java.io.File;\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport org.apache.poi.hssf.usermodel.HSSFWorkbook;\n\npublic class CommentTest {\n\tpublic static void main(String[] args) throws Exception {\n\t\tFile file = new File(\"Book1.xls\");\n\t\tFileInputStream fileInputStream = new FileInputStream(file);\n\t\tHSSFWorkbook workbook = new HSSFWorkbook(fileInputStream);\n\t\tSystem.out.println(file.getName() + \" sheet1.cellA1 comment=\" + workbook.getSheetAt(0).getRow(0).getCell(0).getCellComment().getString());\n\t\tFile newFile = new File(\"Book1_copy.xls\");\n\t\tworkbook.write(new FileOutputStream(newFile));\n\t\tfileInputStream = new FileInputStream(newFile);\n\t\tworkbook = new HSSFWorkbook(fileInputStream);\n\t\tSystem.out.println(newFile.getName() + \" sheet1.cellA1 comment=\" + workbook.getSheetAt(0).getRow(0).getCell(0).getCellComment().getString());\n\t}\n}", "id": 144610, "time": "2011-02-28T10:05:06Z", "creator": "robertl@jlab.org", "creation_time": "2011-02-28T10:05:06Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 50833, "attachment_id": null, "text": "Everyone here are volunteers, and there are lots of people with bugs and not nearly so many people producing patches to fix them. Plus, you know your problem much better than we do....\n\nIn terms of your problem, OpenOffice can open the poi written file just fine, so it looks like we're not doing too much wrong. \n\nHowever, your original source file seems to be problematic. When I try to run it through BiffViewer, BiffViewer blows up. When I try to run it through the beta Microsoft validator, that claims not to recognise the file. So, I think there's something odd about your source file.\n\nHow was the file generated?", "id": 144750, "time": "2011-03-04T16:05:04Z", "creator": "apache@gagravarr.org", "creation_time": "2011-03-04T16:05:04Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 50833, "is_private": false, "text": "The example spreadsheet I uploaded to the bug was generated with Microsoft Office 2007 and saved as an Excel 97-2003 format.", "id": 144751, "time": "2011-03-04T16:12:56Z", "creator": "robertl@jlab.org", "creation_time": "2011-03-04T16:12:56Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 50833, "attachment_id": null, "text": "I opened the original file in Mac Excel 2008 and 2011. It opened fine. I did notice that the comment had a different vertical position in the two versions.\n\nIn 2008 it was slightly above the top of the top row.\n\nin 2011 it was slightly below the top of the top row.", "id": 144752, "time": "2011-03-04T16:37:13Z", "creator": "dfisher@jmlafferty.com", "creation_time": "2011-03-04T16:37:13Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 50833, "is_private": false, "text": "Hmm, so it ought to be fine then.\n\nBiffViewer is blowing up though with:\n\njava.lang.IllegalArgumentException: Name is too long: k~\ufffd\ufffd\ufffd\ufffd\ufffd\u0011>\ufffd`\ufffd8\ufffd\ufffd<()\ufffd\u001a~i:\u0011\ufffd\u0018\n2\u00c5$a\ufffd\u0543\u0014p\u0003\u001f\ufffd\ufffd\ufffd\ufffd\u06f5\u0002\ufffd\ufffd\u0001\ufffd\u00136\ufffd\ufffd\u0016\u04d4\ufffd\ufffd\u001dm.\ufffd\ufffd\ufffd\ufffd#p1tP>\ufffd\ufffd=\ufffd \ufffd\ufffd\u0209a\ufffd\ufffdy\ufffd\ufffdQ1\ufffd\u0004\ufffd\u001c\ufffd8\ufffdYZwbN\ufffd!{\ufffd\ufffd\n\tat org.apache.poi.hssf.record.WriteAccessRecord.setUsername(WriteAccessRecord.java:104)\n\tat org.apache.poi.hssf.record.WriteAccessRecord.<init>(WriteAccessRecord.java:72)\n\tat org.apache.poi.hssf.dev.BiffViewer.createRecord(BiffViewer.java:254)\n\tat org.apache.poi.hssf.dev.BiffViewer.createRecords(BiffViewer.java:86)\n\tat org.apache.poi.hssf.dev.BiffViewer.main(BiffViewer.java:416)\n\nUntil we get that fixed, we probably can't figure out what's being changed by the read/write from POI to know what it might be that excel doesn't like...", "id": 144753, "time": "2011-03-04T16:39:11Z", "creator": "apache@gagravarr.org", "creation_time": "2011-03-04T16:39:11Z", "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 50833, "is_private": false, "text": "I'm sorry - my comment was incorrect.\nThe file was created in MS Excel 2010.", "id": 144754, "time": "2011-03-04T16:40:16Z", "creator": "robertl@jlab.org", "creation_time": "2011-03-04T16:40:16Z", "attachment_id": null}]