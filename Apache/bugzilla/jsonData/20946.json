[{"count": 0, "tags": [], "bug_id": 20946, "text": "Currently if server-side includes are active, and mod_ext_filter is active,\nmod_ext_filter goes first, then mod_include goes second.  There doesn't appear\nto be any way of reversing this order in the configuration.\n\nI would argue that either the order should be configurable, or if not, the order\nshould be reversed.  Arguments for this are:\n* mod_ext_filter is a slow application, thus it should be called once on the\nfinal output, rather than many times for components.\n* A filter that just gets SSI fragments is unable to know the context of the\nfragment (is it in the body, in the head, in a textarea, etc).  This means\nfilters can't formatting, many types of logging, or other useful tasks.\n* If the order were reversed, bug 20945 would vanish.", "id": 39152, "time": "2003-06-20T10:56:45Z", "creator": "apache@neil.fraser.name", "creation_time": "2003-06-20T10:56:45Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 20946, "text": "I've never actually tested this, but according to the docs, you should\nbe able to specify filter order.\n\nAddOutputFilter INCLUDES;DEFLATE html\nis different from\nAddOutputFilter DEFLATE;INCLUDES html\n\nPlease check to see if that works for you.", "id": 39194, "time": "2003-06-20T17:59:32Z", "creator": "slive@apache.org", "creation_time": "2003-06-20T17:59:32Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "apache@neil.fraser.name", "attachment_id": null, "text": "> AddOutputFilter INCLUDES;DEFLATE html\n> is different from\n> AddOutputFilter DEFLATE;INCLUDES html\n>\n> Please check to see if that works for you.\n\nYup, I worked at this several days ago, but wasn't able to keep them from\nstepping on each other's feet or dropping stuff.\n\nThe server-wide config has these lines:\n  AddType text/html .shtml\n  AddOutputFilter INCLUDES .shtml\nAnd my virtual host config has these lines:\n  ExtFilterDefine htmlparser mode=output cmd=/bin/cat intype=text/html\n  SetOutputFilter htmlparser\n\nAny thoughts on how to get them both active, in the right order (SSI first,\nfilter second), and processing the correct files (SSI takes shtml, filter takes\nhtml and shtml)?  The above config gets it all correct except for the order. \nAnd there's no obvious way to swap them.", "id": 39235, "time": "2003-06-21T21:20:47Z", "bug_id": 20946, "creation_time": "2003-06-21T21:20:47Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 20946, "text": "AddOutputFilter INCLUDES;htmlparser shtml\nAddOuptutFilter htmlparser html", "id": 39248, "time": "2003-06-22T14:46:27Z", "creator": "slive@apache.org", "creation_time": "2003-06-22T14:46:27Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "apache@neil.fraser.name", "text": "> AddOutputFilter INCLUDES;htmlparser shtml\n> AddOuptutFilter htmlparser html\n\n(Thanks for crashing my server when I copied and pasted the above 'Ouptut' typo ;-)\n\nThat config works perfectly for *.html and *.shtml.  But there are also htm, pl,\npy, php, cgi, sh, and lord knows what else which also generate HTML pages. \nSurely one doesn't have to come up with an exhaustive list of file extentions. \nAnd to make things even more fun, the extention is case-sensitive.  Not to\nmention those files without extentions (usually CGI binaries).", "count": 4, "id": 39496, "time": "2003-06-26T16:34:30Z", "bug_id": 20946, "creation_time": "2003-06-26T16:34:30Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "slive@apache.org", "text": "The extension is not case-sensitive (or if it is, it is a bug, which you should\nreport in a separate entry).\n\nYes, it is a weakness of the filter system that you can't\nspecify the order if you want to combine setting filters\nby extension and by mime-type.  I'm changing this bug\nreport to address that issue.\n\nThe only way I can think of to address that is to add\na OutputFilterOrder directive.", "count": 5, "id": 39503, "time": "2003-06-26T17:54:21Z", "bug_id": 20946, "creation_time": "2003-06-26T17:54:21Z", "is_private": false}, {"count": 6, "tags": [], "creator": "apache@neil.fraser.name", "text": "> The extension is not case-sensitive (or if it is, it\n> is a bug, which you should report in a separate entry).\n\nMy mistake Joshua, you're correct.\n\n> The only way I can think of to address that is to\n> add a OutputFilterOrder directive.\n\nAnother fix would be to allow one to negate extentions.  Something like this:\n  AddOutputFilter htmlparser !shtml\n\nWhile that would fix this situation, I don't know enough about the Apache style\nto know if that's an elegant solution or an ugly hack.  In any event, I think\nyour proposal is better.", "id": 39527, "time": "2003-06-26T21:39:15Z", "bug_id": 20946, "creation_time": "2003-06-26T21:39:15Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 20946, "text": "if you use ftype argument to ExtFilterDefine, you can override the default\nplacement of your external filter.  Normally it is defined as a resource filter,\njust like mod_include's filter.  If you define it as something that comes after\nresource, then mod_include will necessarily come before it.\n\nTry this modified directive:\n\nExtFilterDefine htmlparser mode=output cmd=/bin/cat intype=text/html ftype=11\n\n11 is 1 more than AP_FTYPE_RESOURCE, so the htmlparser filter would have to come\nafter any resource filters such as the INCLUDES filter.\n", "id": 40527, "time": "2003-07-12T00:46:04Z", "creator": "trawick@apache.org", "creation_time": "2003-07-12T00:46:04Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 20946, "is_private": false, "text": "> 11 is 1 more than AP_FTYPE_RESOURCE, so the htmlparser filter would\n> have to come after any resource filters such as the INCLUDES filter.\n\nI tried 11 and 19, but there was no change in either case.  The filter still\nprocesses each include separately.", "id": 40560, "time": "2003-07-12T21:55:59Z", "creator": "apache@neil.fraser.name", "creation_time": "2003-07-12T21:55:59Z", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 20946, "text": "What do you mean by \"The filter still processes each include separately.\" ?\nIs it seeing the included bits but not the main document?  Is any of the\nresponse not getting into the external filter?\n", "id": 40561, "time": "2003-07-12T22:27:18Z", "creator": "trawick@apache.org", "creation_time": "2003-07-12T22:27:18Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "text": "> What do you mean by \"The filter still processes each include separately.\" ?\n\nHere's a recipe (borrowed from bug 20945):\n1. Create the following SHTML file called test.shtml:\n  <HTML><HEAD><TITLE>Title</TITLE></HEAD><BODY>\n  <H1>Start</H1>\n  <H3>[<!--#include virtual=\"sub.html\"-->]</H3>\n  <H1>End</H1>\n  </BODY></HTML>\n2. Create the following include file called sub.html:\n  This is the include.\n3. Apache displays test.shtml file properly when viewed.  Now add the following\ndirectives:\n  ExtFilterDefine htmlparser mode=output cmd=\"/bin/cat -n\" ftype=11\n  <Location />\n  SetOutputFilter htmlparser\n  </Location>\n\nWith this filter, the source code of test.shtml changes to the following:\n     1\t<html><head><title>Title</title></head><body>\n     2\t<h1>Start</h1>\n     3\t<h3>[     1\tThis is the include.\n     4\t]</h3>\n     5\t<h1>End</h1>\n     6\t</body></html>\nAs you can see, test.shtml is passed through the filter (as seen by the line\nnumbers 1-6), and sub.html is also through the filter (as seen by line number\n1).  Then the results are merged by mod_include.\n\nThe result I'd like is the reversal of mod_ext_filter and mod_include, which\nwould result in this:\n     1\t<html><head><title>Title</title></head><body>\n     2\t<h1>Start</h1>\n     3\t<h3>[This is the include.\n     4\t]</h3>\n     5\t<h1>End</h1>\n     6\t</body></html>\n\n> Is it seeing the included bits but not the main document?\n> Is any of the response not getting into the external filter?\n\nEverything is going through the filter (which is good).  But the filter is being\ncalled separately for each section, not once on the combined document.  This\nmeans that the filter can't do html parsing or many other useful tasks since it\ndoesn't know the context of the page fragments.\n\nHope this makes things clearer.", "is_private": false, "bug_id": 20946, "id": 41707, "time": "2003-07-29T11:15:15Z", "creator": "apache@neil.fraser.name", "creation_time": "2003-07-29T11:15:15Z", "attachment_id": null}, {"count": 11, "tags": [], "bug_id": 20946, "is_private": false, "text": "The above analysis is incorrect.  Here's the result if sub.html is expanded to\nthree lines:\n     1\t<html><head><title>Title</title></head><body>\n     2\t<h1>Start</h1>\n     3\t<h3>[     1\tThis is the start of the include.\n     4\t     2\tThis is the middle of the include.\n     5\t     3\tThis is the end of the include.\n     6\t]</h3>\n     7\t<h1>End</h1>\n     8\t</body></html>\nFrom this one can see that the filter is being called on the combined final\ndocument (which is perfect), as well as on the file fragment (which is\nredundant).  So all we need to do is stop it from filtering the fragments.", "id": 41759, "time": "2003-07-30T10:39:49Z", "creator": "apache@neil.fraser.name", "creation_time": "2003-07-30T10:39:49Z", "attachment_id": null}]