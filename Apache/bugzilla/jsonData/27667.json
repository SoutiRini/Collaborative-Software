[{"count": 0, "tags": [], "bug_id": 27667, "attachment_id": null, "text": "I think that there is a bug in jk2 connector related to\nmultithreading.\n\njk2 connector uses globalPool variable (an instance of apr_pool) to\nstore various data, for example apr_socket variables.\nApr_sockets are then accessed (created and closed) from multiple\nthreads. And they should not be, because as far as I can tell,\napr_pools are not thread safe.\n\nApr_pool implementation contains list of cleanup functions registered\nin the pool. This list is not protected by synchronization code,\nneither in the apr library, nor in jk2 connector.\nAs a result, this list can become corrupted and can cause apache\nserver to malfunction. In our environment we have noticed two kinds of\nbehavior:\n1. apache dumping core after segmentation fault\n2. apache entering infinite loop, because cleanup list got corrupted\nand one of the elements on the list points to itself.\n\nThe sequence of functions causing the problem is:\njk2_channel_apr_close\n  -> apr_socket_close\n     -> apr_pool_cleanup_run\n        -> apr_pool_cleanup_kill\n\nand the apr_pool_cleanup_kill function looks as follows:\n\nAPR_DECLARE(void) apr_pool_cleanup_kill(apr_pool_t *p, const void *data,\n                      apr_status_t (*cleanup_fn)(void *))\n{\n    cleanup_t *c, **lastp;\n\n#if APR_POOL_DEBUG\n    apr_pool_check_integrity(p);\n#endif /* APR_POOL_DEBUG */\n\n    if (p == NULL)\n        return;\n\n    c = p->cleanups;\n    lastp = &p->cleanups;\n    while (c) {\n        if (c->data == data && c->plain_cleanup_fn == cleanup_fn) {\n            *lastp = c->next;\n            break;\n        }\n\n        lastp = &c->next;\n        c = c->next;\n    }\n}\n\nIf apr_pool_cleanup_kill gets called from two threads at the same\ntime, the list can become corrupted.", "id": 54006, "time": "2004-03-15T15:12:05Z", "creator": "tomcat@kivus.no-ip.org", "creation_time": "2004-03-15T15:12:05Z", "is_private": false}, {"count": 1, "tags": [], "text": "As of November 15, 2004, JK2 is no longer supported. All bugs related to JK2 \nwill be marked as WONTFIX. In its place, some of its features have been \nbackported to jk1. Most of those features will be seen in 1.2.7, which is \nslated for release on November 30th, 2004.\n\nAnother alternative is the ajp addition to mod_proxy which will be part of \napache 2.\n\nFor more information on the Tomat connectors docs at\nhttp://jakarta.apache.org/tomcat/connectors-doc/\n\n", "attachment_id": null, "id": 68442, "creator": "funkman@joedog.org", "time": "2004-12-14T01:35:49Z", "bug_id": 27667, "creation_time": "2004-12-14T01:35:49Z", "is_private": false}]