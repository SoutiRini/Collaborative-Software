[{"count": 0, "tags": [], "bug_id": 40179, "text": "Hello\n\nAt our company are using apache as a forward proxy, with squid as an upstream \nproxy. (2.0.49). A user has complained that http://www.lexbase.fr was not \npossible to reach.\nDigging a little we have found that this web site uses http return code 205 \nwhen sending back some javascript.\nsquid does forward to apache the javascript, but mod_proxy stops the \nconnection, sending a tcp reset to squid, and forwarding to the client browser \nonly the header received, adding a COntent-Length: 0.\nWe have tested and found that mod_proxy 2.0.58 and possibly 2.0.59 behave the \nsame.\nDoes anyone have encountered the same problems ?\n\nThanks for your help\n\nRegards.\n\nFran\u00e7ois AZELART\n\nHere the simulated server\nlocalhost ~ # nc -l -p 8081\nGET http://www.lexbase.fr/lexbase/SilverStream/Pages/homepage.html HTTP/1.1\nHost: www.lexbase.fr\nAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg,\napplication/vnd.ms-excel, application/vnd.ms-powerpoint, application/msword,\napplication/x-shockwave-flash, */*\nReferer: http://www.lexbase.fr\nAccept-Language: fr\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\nPragma: no-cache\nCookie: sess=@1be923e:10cced1dc28\nX-NovINet: v1.2\nVia: 1.1 PX20412001, 1.1 www4.lexbase.fr:8080, 1.1, 1.0\nlxispaepxy03.unedic.dmz: 8082 (squid/2.5.STABLE5)\nCache-Control: max-age=259200\nMax-Forwards: 10\n\nHTTP/1.0 205 Reset Content\nDate: Wed, 02 Aug 2006 12:24:46 GMT\nContent-Type: text/html;charset=iso-8859-1\nLast-Modified: Fri, 01 Apr 2005 17:09:16 GMT\nServer: SilverStream Server/4.0\nContent-Length: 120\n\n\nfrancois@localhost ~ $\n\nHere the simulated browser:\nfrancois@localhost ~ $ nc 127.0.0.1 8080\nGET http://www.lexbase.fr/lexbase/SilverStream/Pages/homepage.html HTTP/1.0\nHost: www4.lexbase.fr\nAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg,\napplication/vnd.ms-excel, application/vnd.ms-powerpoint, application/msword,\napplication/x-shockwave-flash, */*\nReferer: http://www.lexbase.fr\nAccept-Language: fr\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\nPragma: no-cache\nCookie: sess=@1be923e:10cced1dc28\nX-NovINet: v1.2\nVia: 1.1 PX20412001, 1.1 www4.lexbase.fr:8080, 1.1\nlxispaepxy03.unedic.dmz:8082 (squid/2.5.STABLE5)\nCache-Control: max-age=259200\nConnection: keep-alive\n\nHTTP/1.1 205 Reset Content\nDate: Thu, 03 Aug 2006 13:49:49 GMT\nServer: SilverStream Server/4.0\nContent-Type: text/html;charset=iso-8859-1\nLast-Modified: Fri, 01 Apr 2005 17:09:16 GMT\nContent-Length: 0\nVia: 1.0\nConnection: close\n\n\nan (hopefully relevant) extract from httpd.conf\n\n# ---------------------------------------------------------------------\n# PARAMETRAGE DU PROXY HTTP\n\n<IfModule mod_proxy.c>\nProxyRequests On\nProxyRemote * http://127.0.0.1:8081\n\n</IfModule>\n\n\nProxyRemote * http://127.0.0.1:8081", "id": 91864, "time": "2006-08-03T14:05:21Z", "creator": "fazelart@unedic.fr", "creation_time": "2006-08-03T14:05:21Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "nick@webthing.com", "attachment_id": null, "is_private": false, "id": 91865, "time": "2006-08-03T14:44:32Z", "bug_id": 40179, "creation_time": "2006-08-03T14:44:32Z", "text": "Can you supply a test case?\n\nYou say the server returns status code 205 with some javascript.  But HTTP \nmakes it clear that the server MUST NOT return any contents with a 205.  So it \nseems your backend is broken, squid is doing nothing to correct it, and Apache \nmay be correcting it.  Unless that tcp reset is premature, or something?"}, {"count": 2, "tags": [], "bug_id": 40179, "attachment_id": null, "text": "Damn.  I didn't read beyond your signature (well, I read the email on the bugs \nlist, not this page, and it looked like an end-of-message).\n\nAnyway, the headers you posted seem to confirm that the backend is broken and \nApache is correcting it  When I try the URL \nhttp://www.lexbase.fr/lexbase/SilverStream/Pages/homepage.html I get a 404 \n(Not Found) and a very, very old Apache version.", "id": 91866, "time": "2006-08-03T14:53:54Z", "creator": "nick@webthing.com", "creation_time": "2006-08-03T14:53:54Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 40179, "attachment_id": null, "id": 91868, "creation_time": "2006-08-03T15:06:11Z", "time": "2006-08-03T15:06:11Z", "creator": "fazelart@unedic.fr", "text": "http://www.lexbase.fr/lexbase/SilverStream/Pages/homepage.html indeed returns \nan http 404.\nIf you want to reproduce the problem, you have to access http://www.lexbase.fr \nusing MS IE. Firefox for some reason does not trigger the 205 return code.\nThe remote webserver seems to be an Silver Stream. (Novell? This would be \nhandy as we are using SLES 9 ou our side!)\nYou say that HTTP makes it clear that no data should be provided with a 205 \nReturn Code. Do you know where I can find this info ? (eg RFC-XYZT)\nMod_proxy sends a TCP reset to the upstream Proxy as soon as the last header \nhas been forwarded. (Blank line)\nThanks for your help.\n", "is_private": false}, {"count": 4, "tags": [], "text": "This is what I have found in RFC 2616\n10.2.6 205 Reset Content\n\nThe server has fulfilled the request and the user agent SHOULD reset the \ndocument view which caused the request to be sent. This response is primarily \nintended to allow input for actions to take place via user input, followed by \na clearing of the form in which the input is given so that the user can easily \ninitiate another input action. The response MUST NOT include an entity.\n\nIs \"The response MUST NOT include an entity\" synonymous to \"No data?\"\n\nThis would mean that squid is more permissive than the RFC. (And trendmicro \nInterscan too, as we are using it).\n\nThanks for your advice.\n", "attachment_id": null, "id": 91869, "creator": "fazelart@unedic.fr", "time": "2006-08-03T15:27:35Z", "bug_id": 40179, "creation_time": "2006-08-03T15:27:35Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 40179, "text": "I brought this up on the httpwg list a while back and IIRC the 2.0 proxy was\nwrong and it was fixed for 2.2.  Does this work with 2.2.x?", "id": 91871, "time": "2006-08-03T15:35:52Z", "creator": "jorton@redhat.com", "creation_time": "2006-08-03T15:35:52Z", "is_private": false, "attachment_id": null}, {"count": 6, "attachment_id": null, "creator": "fazelart@unedic.fr", "text": "Would 2.2.3 be relevant for such a test ? If yes, I will try to set up this \ntomorrow.\n\nThanks\n\nFran\u00e7ois", "id": 91873, "time": "2006-08-03T15:55:07Z", "bug_id": 40179, "creation_time": "2006-08-03T15:55:07Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "bug_id": 40179, "attachment_id": null, "id": 91888, "time": "2006-08-04T11:14:49Z", "creator": "jorton@redhat.com", "creation_time": "2006-08-04T11:14:49Z", "is_private": false, "text": "Yes, please try 2.2.3."}, {"count": 8, "tags": [], "bug_id": 40179, "is_private": false, "id": 91890, "creation_time": "2006-08-04T12:07:10Z", "time": "2006-08-04T12:07:10Z", "creator": "fazelart@unedic.fr", "text": "I am in the process of compiling... (using gentoo)\nOne question: is the httpd.conf syntax new with 2.2.3 or may I use the file I \nhave setup for 2.0.58 ?\nIf not, would it be easy for someone here to provide me with a sample proxy \nconf?\n\nThanks again for your help\n\nFran\u00e7ois\n", "attachment_id": null}, {"count": 9, "tags": [], "creator": "fazelart@unedic.fr", "attachment_id": null, "id": 91900, "time": "2006-08-04T14:39:16Z", "bug_id": 40179, "creation_time": "2006-08-04T14:39:16Z", "is_private": false, "text": "OK, I have just managed to setup apache 2.2.3.\n\nAs suggested by Joe Orton (thank you Joe !), mod_proxy 2.2.3 does not behave \nthe same.\nmod_proxy does not set Content-Length to 0, nor it does send a reset to the \nupstream Proxy. (See traces below)\n\nAs a result, should we consider the 2.0.X mod_proxy as a bug ?\nIf so, would it be difficult/possible to backport mod_proxy 2.2.3 behaviour \nback to 2.0 ?\n\nThanks.\n\nFran\u00e7ois\n\nSimulated Client:\nGentooVmware ~ # nc 127.0.0.1 8080\nGET http://www.lexbase.fr/lexbase/SilverStream/Pages/homepage.html HTTP/1.0\nHost: www4.lexbase.fr\nAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, \napplication/vnd.ms-excel, application/vnd.ms-powerpoint, application/msword, \napplication/x-shockwave-flash, */*\nReferer: http://www.lexbase.fr\nAccept-Language: fr\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\nPragma: no-cache\nCookie: sess=@1be923e:10cced1dc28\nX-NovINet: v1.2\nVia: 1.1 PX20412001, 1.1 www4.lexbase.fr:8080, 1.1\nlxispaepxy03.unedic.dmz:8082 (squid/2.5.STABLE5)\nCache-Control: max-age=259200\nConnection: keep-alive\n\nHTTP/1.1 205 Reset Content\nDate: Fri, 04 Aug 2006 16:37:08 GMT\nServer: SilverStream Server/4.0\nContent-Type: text/html;charset=iso-8859-1\nLast-Modified: Fri, 01 Apr 2005 17:09:16 GMT\nVia: 1.0\nConnection: close\n\n<HTML>\n<HEAD ><SCRIPT LANGUAGE=\"JavaScript1.2\" \nSRC=\"../Objectstore/General/LexFonctions.js\"></SCRIPT>\n<META HTTP-EQUIV=\"Pragma\" CONTENT=\"no-cache\">\n<META HTTP-EQUIV=\"Cache-Control\" CONTENT=\"no-cache\">\n<META NAME=\"robots\" CONTENT=\"FOLLOW,INDEX\">\n<TITLE>Bienvenue sur LEXBASE, premier editeur juridique 100% internet</TITLE>\n\n<SCRIPT>\n<!--\n etc...\n\nSimulated server:\nGET http://www.lexbase.fr/lexbase/SilverStream/Pages/homepage.html HTTP/1.1\nHost: www.lexbase.fr\nAccept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, \napplication/vnd.ms-excel, application/vnd.ms-powerpoint, application/msword, \napplication/x-shockwave-flash, */*\nReferer: http://www.lexbase.fr\nAccept-Language: fr\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\nPragma: no-cache\nCookie: sess=@1be923e:10cced1dc28\nX-NovINet: v1.2\nVia: 1.1 PX20412001, 1.1 www4.lexbase.fr:8080, 1.1, 1.0\nlxispaepxy03.unedic.dmz: 8082 (squid/2.5.STABLE5)\nCache-Control: max-age=259200\nMax-Forwards: 10\nConnection: Keep-Alive\n\nHTTP/1.0 205 Reset Content\nDate: Wed, 02 Aug 2006 12:24:46 GMT\nContent-Type: text/html;charset=iso-8859-1\nLast-Modified: Fri, 01 Apr 2005 17:09:16 GMT\nServer: SilverStream Server/4.0\n\n<HTML>\n<HEAD ><SCRIPT LANGUAGE=\"JavaScript1.2\" \nSRC=\"../Objectstore/General/LexFonctions.js\"></SCRIPT>\n<META HTTP-EQUIV=\"Pragma\" CONTENT=\"no-cache\">\n<META HTTP-EQUIV=\"Cache-Control\" CONTENT=\"no-cache\">\n<META NAME=\"robots\" CONTENT=\"FOLLOW,INDEX\">\n<TITLE>Bienvenue sur LEXBASE, premier editeur juridique 100% internet</TITLE>\n\n<SCRIPT>\n<!--\netc...\n\n"}, {"count": 10, "tags": [], "bug_id": 40179, "attachment_id": null, "is_private": false, "id": 92113, "time": "2006-08-10T14:40:45Z", "creator": "fazelart@unedic.fr", "creation_time": "2006-08-10T14:40:45Z", "text": "Hi,\n\nI am still dealing with this problem.\nDo you think that a patch to mod_proxy changing the 205 handling would be \nwelcomed ? If so I could try to write such a patch. But I need it to be \naccepted by the community (assuming that the resulting code is correct), \nbecause our servers are supported by Novell (SLES9) and as a consequence, the \npatch to mod_proxy must be provided by them.\nSo basically, does such a patch have any chance to be accepted ?\n\nThanks for your help.\n\nFran\u00e7ois"}, {"count": 11, "tags": [], "text": "After a quick look at proxy_http.c it seems that the change could be fairly \nsimple. in function\napr_status_t ap_proxy_http_process_response()\n\nRESET_CONTENT is checked in two places:\n\n        /* send body - but only if a body is expected */\n        if ((!r->header_only) &&                   /* not HEAD request */\n            (r->status > 199) &&                   /* not any 1xx response */\n            (r->status != HTTP_NO_CONTENT) &&      /* not 204 */\n            (r->status != HTTP_RESET_CONTENT) &&   /* not 205 */\n            (r->status != HTTP_NOT_MODIFIED)) {    /* not 304 */\n\n            /* We need to copy the output headers and treat them as input\n\nand later\n\n            /* Discard body, if one is expected */\n            if ((status > 199) && /* not any 1xx response */\n                (status != HTTP_NO_CONTENT) && /* not 204 */\n                (status != HTTP_RESET_CONTENT) && /* not 205 */\n                (status != HTTP_NOT_MODIFIED)) { /* not 304 */\n               ap_discard_request_body(rp);\n\nMaybe removing those two lines would be enough ?\n\nI have checked in the 2.2.3 source mod_proxy_http.c that those lines are \nremoved.\nDo you think that other changes are involved ?\n\nThanks\n\nFran\u00e7ois", "is_private": false, "bug_id": 40179, "id": 92135, "time": "2006-08-11T09:03:36Z", "creator": "fazelart@unedic.fr", "creation_time": "2006-08-11T09:03:36Z", "attachment_id": null}, {"count": 12, "tags": [], "text": "Just to confirm: when you say that \"2.2.3 does not behave the same\" do you mean\nthat 2.2.3 fixes the problem?", "attachment_id": null, "id": 92141, "creator": "jorton@redhat.com", "time": "2006-08-11T12:50:47Z", "bug_id": 40179, "creation_time": "2006-08-11T12:50:47Z", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "fazelart@unedic.fr", "text": "Sorry for my poor english.\n\nYes absolutely 2.2.3 does fix my problem.\n\nThanks Joe", "count": 13, "id": 92142, "time": "2006-08-11T12:55:31Z", "bug_id": 40179, "creation_time": "2006-08-11T12:55:31Z", "is_private": false}, {"count": 14, "tags": [], "creator": "fazelart@unedic.fr", "attachment_id": null, "id": 94765, "time": "2006-10-12T07:54:26Z", "bug_id": 40179, "creation_time": "2006-10-12T07:54:26Z", "is_private": false, "text": "Hi,\n\nSuse Novell has provided a fix, so the bug may be closed.\n\nThanks"}]