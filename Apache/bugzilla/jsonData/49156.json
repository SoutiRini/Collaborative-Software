[{"count": 0, "tags": [], "creator": "gavr145@gmail.com", "text": "During evaluation of formulas using FormulaEvaluator's evaluateInCell(cell) - getting the following NPE. Using evaluateFormulaCell(cell) instead - no such problem. It occurs on complex spreadsheets and I was not able to reproduce the exception reading the same formulas from the same spreadsheets individually. So, it may be happening as a side effect of sequential bulk reading of a bunch of formulas (probably in combination with some styles?). Looks like a caching problem somewhere inside the framework. I'm using the most recent, yesterday's snapshot (20100419), - to avoid 48026 and few following exceptions.\n\n\njava.lang.Class - java.lang.NullPointerException\n\tat org.apache.poi.xssf.usermodel.XSSFCell.convertSharedFormula(XSSFCell.java:369)\n\tat org.apache.poi.xssf.usermodel.XSSFCell.getCellFormula(XSSFCell.java:353)\n\tat org.apache.poi.xssf.usermodel.XSSFEvaluationWorkbook.getFormulaTokens(XSSFEvaluationWorkbook.java:141)\n\tat org.apache.poi.ss.formula.WorkbookEvaluator.evaluateAny(WorkbookEvaluator.java:259)\n\tat org.apache.poi.ss.formula.WorkbookEvaluator.evaluate(WorkbookEvaluator.java:207)\n\tat org.apache.poi.xssf.usermodel.XSSFFormulaEvaluator.evaluateFormulaCellValue(XSSFFormulaEvaluator.java:252)\n\tat org.apache.poi.xssf.usermodel.XSSFFormulaEvaluator.evaluateInCell(XSSFFormulaEvaluator.java:173)\n\tat org.apache.poi.xssf.usermodel.XSSFFormulaEvaluator.evaluateInCell(XSSFFormulaEvaluator.java:46)\n\tat org.is.jxlpoi.JXLPOIWorkbook.getCellContentAsString(JXLPOIWorkbook.java:137)", "id": 136257, "time": "2010-04-20T09:43:11Z", "bug_id": 49156, "creation_time": "2010-04-20T09:43:11Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 49156, "text": "Exception occurs only when reading Excel 2007 files. When using the same spreadsheet but been saved as 97/2000 Excel format (the same formulas) and so HSSF is used internally - everything is fine. (but we need to process files been saved by default as 2007+ as well!)\n\nI've tried to use evaluateFormulaCell() instead, but the formulas results are different (we have a bunch of regression tests using aggregate functions such as calculating of the sum of all formulas sums etc) than using evaluateInCell(). The later calculates correctly but due to the NPE mentioned above - it works for 97/2000 Excel files only. I'm expecting it to work in the same way (with the same results) - for 2007 format.\nThat is why I'm waiting for NPE fix - for evaluateInCell() and can't use evaluateFormulaCell().", "id": 136280, "time": "2010-04-20T15:48:34Z", "creator": "gavr145@gmail.com", "creation_time": "2010-04-20T15:48:34Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 49156, "text": "I've found a walkaround\n(using FormulaEvaluator's evaluate(c), returning a copy of the cell instead), \nsince it appeared that this method does not give the above-mentioned NPE (at least for now) and behaves in the same way with both 97/2000 and 2007 Excel formats.\nSo, I'm degrading the importance to Normal (but sure, NPE in evaluateInCell is better to be fixed before the next stable version).", "id": 136295, "time": "2010-04-21T14:23:07Z", "creator": "gavr145@gmail.com", "creation_time": "2010-04-21T14:23:07Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 49156, "attachment_id": null, "text": "We will probably need a copy of the offending xlsx file to diagnose this bug properly.  It's likely that you have found a slightly unusual situation that Excel perhaps encodes in an unusual way.\n\nThe workaround you describe doesn't sound right.  If you are doing *any* sort of formula evaluation, the convertSharedFormula will still need to be called, and I don't see any reason why it should behave differently depending on whether you call evaluateInCell() or evaluate().  I have a feeling you might have done something else that made the problem go away.", "id": 136744, "time": "2010-05-09T12:03:57Z", "creator": "josh@apache.org", "creation_time": "2010-05-09T12:03:57Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 49156, "text": "We are not doing anything special.\nThe only difference is one line (please make diff).\nYou can remove switch statement after the call and it will be the same crash, so the only difference is:\n\nformulaEvaluator.evaluateInCell(c); //crashes with the NPE\n\nor\n\nCellValue cv = formulaEvaluator.evaluate(c); //working\n\n\nIt crashes on all our files. I can't send the file since it is internal. I can send it to you directly although. But it seems it will not very helpful and will only confuse since we have thousands of cells and the order of reading is not sequential, so we'll need somehow to simulate the order etc. May be it is easier to understand the cause theoretically? If it is not possible, we can think - how to separate the problem into an individual test case. Let me know - if you need my help in this.", "count": 4, "id": 136752, "time": "2010-05-10T10:21:11Z", "creator": "gavr145@gmail.com", "creation_time": "2010-05-10T10:21:11Z", "is_private": false}, {"count": 5, "tags": [], "creator": "gavr145@gmail.com", "text": "Created attachment 25420\nnot working case", "id": 136753, "time": "2010-05-10T10:22:17Z", "bug_id": 49156, "creation_time": "2010-05-10T10:22:17Z", "is_private": false, "attachment_id": 25420}, {"count": 6, "tags": [], "creator": "gavr145@gmail.com", "text": "Created attachment 25421\nworking case", "id": 136754, "time": "2010-05-10T10:22:42Z", "bug_id": 49156, "creation_time": "2010-05-10T10:22:42Z", "is_private": false, "attachment_id": 25421}, {"count": 7, "tags": [], "creator": "gavr145@gmail.com", "attachment_id": null, "id": 136764, "time": "2010-05-10T16:00:38Z", "bug_id": 49156, "creation_time": "2010-05-10T16:00:38Z", "is_private": false, "text": "I was able to clean the workbook, isolating the case. Further cleaning eliminate the problem (although, I believe this state is already fine for you).\n\nAttached:\n\n1) unit test \nnotice if you will comment-out one line \n    formulaEvaluator.evaluateInCell(c)\nand uncomment:\n    formulaEvaluator.evaluate(c)\nthe problem will go away\n\n2) testNPE.xlsx\nNotice that if you will remove all rows from the beginning - the problem will go away. The same - if you will not read the first value, which is determined as a formula, although it is not actually.\n\n\nHopefully, this will be helpful\n\nRegards\nVasili"}, {"count": 8, "attachment_id": 25425, "bug_id": 49156, "is_private": false, "id": 136765, "time": "2010-05-10T16:01:29Z", "creator": "gavr145@gmail.com", "creation_time": "2010-05-10T16:01:29Z", "tags": [], "text": "Created attachment 25425\ntestcase"}, {"count": 9, "tags": [], "creator": "gavr145@gmail.com", "attachment_id": 25426, "text": "Created attachment 25426\nminimal spreadsheet which cases problem", "id": 136766, "time": "2010-05-10T16:02:48Z", "bug_id": 49156, "creation_time": "2010-05-10T16:02:48Z", "is_private": false}, {"count": 10, "tags": [], "creator": "yegor@dinom.ru", "text": "The problem is not reproducible with current trunk. \n\nTry the latest build, daily builds can be downloaded from here:\nhttp://encore.torchbox.com/poi-cvs-build/\n\nYegor", "id": 142589, "time": "2010-12-11T08:10:12Z", "bug_id": 49156, "creation_time": "2010-12-11T08:10:12Z", "is_private": false, "attachment_id": null}]