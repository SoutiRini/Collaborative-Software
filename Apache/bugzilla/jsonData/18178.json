[{"count": 0, "tags": [], "creator": "jkb@stian.freeserve.co.uk", "attachment_id": null, "id": 33510, "time": "2003-03-20T02:06:13Z", "bug_id": 18178, "creation_time": "2003-03-20T02:06:13Z", "is_private": false, "text": "It looks like the HTTP sampler keeps creating new connections when using the \nkeep-alive feature.\n\nAt the end of SampleResult, the connection is disconnected if the \"Connection\" \nheader field is \"close\". [The conn variable is not set to null - should it be?]\n\nHowever, at the beginning of the same routine it always creates a new \nconnection using setupConnection(), even if Keep-Alive is being used.\n\nThis only becomes obvious under heavy load and/or long tests - otherwise the \nconnections timeout and get cleared up anyway. [But it can be easily \ndemonstrated with netstat!]\n\nNot exactly sure where to correct this - but it looks as though \nsetupConnection could return the previous connection if it still existed.\n\nMeanwhile, a work-round is obviously to disable keep-alive."}, {"count": 1, "tags": [], "creator": "jkb@stian.freeserve.co.uk", "text": "Created attachment 5665\nFix HTTP/1.1 connection close in HTTPSampler[Full]", "id": 34595, "time": "2003-04-06T22:40:56Z", "bug_id": 18178, "creation_time": "2003-04-06T22:40:56Z", "is_private": false, "attachment_id": 5665}, {"count": 2, "tags": [], "bug_id": 18178, "attachment_id": 5666, "text": "Created attachment 5666\nFix HTTP/1.1 connection close in HTTPSampler[Full]", "id": 34596, "time": "2003-04-06T22:41:15Z", "creator": "jkb@stian.freeserve.co.uk", "creation_time": "2003-04-06T22:41:15Z", "is_private": false}, {"count": 3, "tags": [], "creator": "jkb@stian.freeserve.co.uk", "attachment_id": null, "id": 34597, "time": "2003-04-06T22:42:43Z", "bug_id": 18178, "creation_time": "2003-04-06T22:42:43Z", "is_private": false, "text": "It turns out that the HttpURLConnection method does not support connection re-\nuse anyway, and there is no control over when the underlying implementation \ncreates new connections or reuses old ones.\n\nHowever, there is still a bug which can cause problems for HTTP/1.1 servers: \nthese use persistent connections by default, and should only be disconnected \nif the header Connection: close is seen. However the code currently also \ndisconnects if the Connection header is missing - i.e. it will disconnect \nHTTP/1.1 connections every time, which can cause the server problems under \nheavy load.\n\nA patch is attached to fix this - it won't fix the underlying connection \ncreations in HttpURLConnection, but it does at least give the server a better \nchance...\n\nThe same disconnect problem occurs in HTTPSamplerFull (patch also attached)\n\n[Sorry, managed to attach same patch twice - did not realise one has to save \nthis page first.]"}, {"count": 4, "tags": [], "bug_id": 18178, "attachment_id": null, "is_private": false, "id": 36039, "time": "2003-04-25T02:23:51Z", "creator": "mstover1@apache.org", "creation_time": "2003-04-25T02:23:51Z", "text": "Seems reasonable.  It's true we have no control over how and when connections\nare re-used - we've looked into that pretty thoroughly.  But, I applied the\nsimple patch provided."}]