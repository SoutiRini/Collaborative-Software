[{"count": 0, "attachment_id": null, "bug_id": 43220, "text": "We've got a tomcat 5.5.23 server hiding behind an apache 2.2.3 server using\nmod_proxy.  the configuration is:\n\n  ProxyPass /confluence/ ajp://feta.dlib.indiana.edu:8079/confluence/\n  ProxyPassReverse /confluence/ ajp://feta.dlib.indiana.edu:8079/confluence/\n\nWhen we access the application directly (i.e. on port 8070) the data comes back\nok, but when using the proxy, it is truncated.  The data we're sending back is >\n2M, so most requests are ok, and sometimes it does work for larger requests.  \n\nThe test url through the proxy for this is:\n  http://wiki.dlib.indiana.edu/confluence/download/attachments/25/boot.iso\nor directly\n  http://wiki.dlib.indiana.edu:8070/confluence/download/attachments/25/boot.iso\n\nFeta and wiki are different IPs, but both the tomcat and the apache instance are\nlistening on all IPs.  The content-length header coming back to the browser\nseems to be correct -- when it failed on a wget request, wget retried.", "id": 107290, "time": "2007-08-27T07:53:37Z", "creator": "bdwheele@indiana.edu", "creation_time": "2007-08-27T07:53:37Z", "tags": [], "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 43220, "is_private": false, "id": 107303, "time": "2007-08-27T13:19:11Z", "creator": "rpluem@apache.org", "creation_time": "2007-08-27T13:19:11Z", "tags": [], "text": "Please provide the output of your error_log file. Sorry for being confused\nregarding your size observations.\nYou mean requests below 2 GB are fine and request above 2 GB only work sometimes?"}, {"count": 2, "tags": [], "text": "The proxy is cutting off data less than 2 Meg, not G.  The test URL is ~8M and\non some requests I may only get 500K.  However, sometimes (using wget, but never\nfirefox, it seems) I will get the whole file, though wget had to retry and\nmanaged to get all of the content.\n\nI went to the page:\n\nhttp://wiki.dlib.indiana.edu/confluence/pages/viewpageattachments.action?pageId=25\n\nand clicked on the boot.iso link.  The original file is 8,161,280 bytes.  These\nmessages were generated in the log:\n[Mon Aug 27 16:37:47 2007] [error] ajp_check_msg_header() got bad signature d3e6\n[Mon Aug 27 16:37:47 2007] [error] ajp_ilink_receive() received bad header\n[Mon Aug 27 16:37:47 2007] [error] ajp_read_header: ajp_ilink_receive failed\n[Mon Aug 27 16:37:47 2007] [error] (120007)APR does not understand this error\ncode: proxy: send body failed to 156.56.241.30:8079 (feta.dlib.indiana.edu)\n\nand only 663,544 bytes were transferred.\n\n\nIf I go to \nhttp://wiki.dlib.indiana.edu:8070/confluence/pages/viewpageattachments.action?pageId=25\n\nwhich is the tomcat instance without the proxy, clicking on the boot.iso link\ngives me the entire file as expected.\n\n", "attachment_id": null, "bug_id": 43220, "id": 107304, "time": "2007-08-27T13:43:51Z", "creator": "bdwheele@indiana.edu", "creation_time": "2007-08-27T13:43:51Z", "is_private": false}, {"count": 3, "attachment_id": null, "bug_id": 43220, "text": "(In reply to comment #2)\nThese\n> messages were generated in the log:\n> [Mon Aug 27 16:37:47 2007] [error] ajp_check_msg_header() got bad signature d3e6\n\nIt seems that your Tomcat is sending wrong data. So please:\n\n- Increase the loglevel of your Apache to debug.\n- Try sniffing the ajp traffic between your Apache and your Tomcat and attach\nthe sniff file.\n\n", "id": 107305, "time": "2007-08-27T14:28:51Z", "creator": "rpluem@apache.org", "creation_time": "2007-08-27T14:28:51Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "creator": "bdwheele@indiana.edu", "attachment_id": null, "is_private": false, "id": 107333, "time": "2007-08-28T05:26:02Z", "bug_id": 43220, "creation_time": "2007-08-28T05:26:02Z", "text": "I've done the proxy from my workstation's apache (2.2.4 vs 2.2.3 of the\nproduction server) and it still does the same thing.  Here's the error messages\ngenerated when setting LogLevel debug and requesting the file.  I will attach a\ndump from wireshark of the transaction.\n\n[Tue Aug 28 08:20:19 2007] [debug] mod_proxy_ajp.c(44): proxy: AJP:\ncanonicalising URL\n//feta.dlib.indiana.edu:8079/confluence/download/attachments/25/boot.iso\n[Tue Aug 28 08:20:19 2007] [debug] proxy_util.c(1378): [client 127.0.0.1] proxy:\najp: found worker ajp://feta.dlib.indiana.edu:8079/confluence/ for\najp://feta.dlib.indiana.edu:8079/confluence/download/attachments/25/boot.iso,\nreferer: http://localhost/confluence/pages/viewpageattachments.action?pageId=25\n[Tue Aug 28 08:20:19 2007] [debug] mod_proxy.c(777): Running scheme ajp handler\n(attempt 0)\n[Tue Aug 28 08:20:19 2007] [debug] mod_proxy_http.c(1652): proxy: HTTP:\ndeclining URL\najp://feta.dlib.indiana.edu:8079/confluence/download/attachments/25/boot.iso\n[Tue Aug 28 08:20:19 2007] [debug] mod_proxy_ajp.c(507): proxy: AJP: serving URL\najp://feta.dlib.indiana.edu:8079/confluence/download/attachments/25/boot.iso\n[Tue Aug 28 08:20:19 2007] [debug] proxy_util.c(1798): proxy: AJP: has acquired\nconnection for (feta.dlib.indiana.edu)\n[Tue Aug 28 08:20:19 2007] [debug] proxy_util.c(1859): proxy: connecting\najp://feta.dlib.indiana.edu:8079/confluence/download/attachments/25/boot.iso to\nfeta.dlib.indiana.edu:8079\n[Tue Aug 28 08:20:19 2007] [debug] proxy_util.c(1955): proxy: connected\n/confluence/download/attachments/25/boot.iso to feta.dlib.indiana.edu:8079\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(218): Into ajp_marshal_into_msgb\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(284): ajp_marshal_into_msgb:\nHeader[0] [Host] = [localhost]\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(284): ajp_marshal_into_msgb:\nHeader[1] [User-Agent] = [Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.1.5)\nGecko/20070718 Fedora/2.0.0.5-1.fc7 Firefox/2.0.0.5]\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(284): ajp_marshal_into_msgb:\nHeader[2] [Accept] =\n[text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5]\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(284): ajp_marshal_into_msgb:\nHeader[3] [Accept-Language] = [en-us,en;q=0.5]\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(284): ajp_marshal_into_msgb:\nHeader[4] [Accept-Encoding] = [gzip,deflate]\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(284): ajp_marshal_into_msgb:\nHeader[5] [Accept-Charset] = [ISO-8859-1,utf-8;q=0.7,*;q=0.7]\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(284): ajp_marshal_into_msgb:\nHeader[6] [Keep-Alive] = [300]\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(284): ajp_marshal_into_msgb:\nHeader[7] [Connection] = [keep-alive]\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(284): ajp_marshal_into_msgb:\nHeader[8] [Referer] =\n[http://localhost/confluence/pages/viewpageattachments.action?pageId=25]\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(284): ajp_marshal_into_msgb:\nHeader[9] [Cookie] = [JSESSIONID=AEAB20432F03EE55B61C3DF792948B91;\nwikiuserUserID=1; wikiuserUserName=Admin;\nwikiuserToken=0a2ca7abde82342684d88f18c80498bf]\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(284): ajp_marshal_into_msgb:\nHeader[10] [Max-Forwards] = [10]\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(424): ajp_marshal_into_msgb: Done\n[Tue Aug 28 08:20:19 2007] [debug] mod_proxy_ajp.c(188): proxy: APR_BUCKET_IS_EOS\n[Tue Aug 28 08:20:19 2007] [debug] mod_proxy_ajp.c(193): proxy: data to read\n(max 8186 at 4)\n[Tue Aug 28 08:20:19 2007] [debug] mod_proxy_ajp.c(208): proxy: got 0 bytes of data\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 04\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 04\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(484): ajp_unmarshal_response:\nstatus = 200\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(495): ajp_unmarshal_response:\nNumber of headers is = 5\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(557): ajp_unmarshal_response:\nHeader[0] [Last-Modified] = [Mon, 27 Aug 2007 13:52:44 GMT]\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(557): ajp_unmarshal_response:\nHeader[1] [ETag] = [\"1188222764000\"]\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(557): ajp_unmarshal_response:\nHeader[2] [Content-Disposition] = [inline; filename=\"boot.iso\"]\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(557): ajp_unmarshal_response:\nHeader[3] [Content-Type] = [application/x-cd-image;charset=UTF-8]\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(567): ajp_unmarshal_response:\nap_set_content_type done\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(557): ajp_unmarshal_response:\nHeader[4] [Content-Length] = [8161280]\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(643): ajp_read_header:\najp_ilink_received 03\n[Tue Aug 28 08:20:19 2007] [debug] ajp_header.c(653): ajp_parse_type: got 03\n[Tue Aug 28 08:20:19 2007] [error] ajp_check_msg_header() got bad signature 5528\n[Tue Aug 28 08:20:19 2007] [error] ajp_ilink_receive() received bad header\n[Tue Aug 28 08:20:19 2007] [error] ajp_read_header: ajp_ilink_receive failed\n[Tue Aug 28 08:20:19 2007] [debug] mod_proxy_ajp.c(395): (120007)APR does not\nunderstand this error code: ajp_read_header failed\n[Tue Aug 28 08:20:19 2007] [error] (120007)APR does not understand this error\ncode: proxy: send body failed to 156.56.241.30:8079 (feta.dlib.indiana.edu)\n[Tue Aug 28 08:20:19 2007] [debug] proxy_util.c(1816): proxy: AJP: has released\nconnection for (feta.dlib.indiana.edu)"}, {"count": 5, "tags": [], "creator": "bdwheele@indiana.edu", "attachment_id": 20719, "is_private": false, "id": 107334, "time": "2007-08-28T05:28:44Z", "bug_id": 43220, "creation_time": "2007-08-28T05:28:44Z", "text": "Created attachment 20719\npcap dump from wireshark of truncated transaction\n\nThis is the proxy request from my workstation to the tomcat server via\nmod_proxy."}, {"count": 6, "tags": [], "text": "Thanks for the feedback. According to my first analysis of the pcap dump Tomcat\nsents the data correctly. The debug messages from httpd are not sufficient for\nme for further analysis. It seems that some debug messages get written to the\nmain server error log and not to the error log of the virtual host which you\nadded. Can you please also add the corresponding entries from the main server log?", "is_private": false, "bug_id": 43220, "id": 107361, "time": "2007-08-28T14:01:05Z", "creator": "rpluem@apache.org", "creation_time": "2007-08-28T14:01:05Z", "attachment_id": null}, {"count": 7, "tags": [], "creator": "bdwheele@indiana.edu", "text": "I'm not sure where to look, since I didn't put the redirect into a virtual host.\n I set \"LogLevel\" to debug -- is there a different setting I should have used? \nWhat error message are you looking for?  Maybe I can grep around and see where\nit went.\n\n", "id": 107387, "time": "2007-08-29T05:19:32Z", "bug_id": 43220, "creation_time": "2007-08-29T05:19:32Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "text": "Sorry for creating confusion. I assume that you use a virtual host and that this\nvirtual host contains an ErrorLog directive. I guess you put excerpts from this\nfile into your report. There should be also an ErrorLog directive outside of any\nvirtual host and I need the appropriate messages of this file. Of course this\nrequires that you set LogLevel to debug outside of the virtual host.\nIf this is not the case could you please repeat your debugging session and\nattach the messages from both logs plus the dump.\nAnd it does not matter that the ProxyPass is outside of the virtual host. It\nonly matters that there is one with a separate ErrorLog directive.", "is_private": false, "bug_id": 43220, "id": 107419, "time": "2007-08-29T12:18:25Z", "creator": "rpluem@apache.org", "creation_time": "2007-08-29T12:18:25Z", "attachment_id": null}, {"count": 9, "attachment_id": 20732, "bug_id": 43220, "text": "Created attachment 20732\nError Log\n\nFull error log with truncated output", "id": 107420, "time": "2007-08-29T12:29:08Z", "creator": "bdwheele@indiana.edu", "creation_time": "2007-08-29T12:29:08Z", "tags": [], "is_private": false}, {"count": 10, "tags": [], "bug_id": 43220, "attachment_id": null, "text": "I've attached the full error log from a startup and a few hits ending with the\ntruncated output download.  This should be all the logging messages there are.", "id": 107421, "time": "2007-08-29T12:29:54Z", "creator": "bdwheele@indiana.edu", "creation_time": "2007-08-29T12:29:54Z", "is_private": false}, {"count": 11, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "id": 107423, "time": "2007-08-29T13:07:19Z", "bug_id": 43220, "creation_time": "2007-08-29T13:07:19Z", "is_private": false, "text": "Thanks for the quick response, but I see no failing request in your error_log.\nYour request to /confluence/download/attachments/25/boot.iso results in a 304\n(not modified). Please clear the cache of your browser and try again."}, {"count": 12, "tags": [], "text": "Forgot one thing: I am sorry but I need a network dump AND the error_log for the\nsame failing request as I need to analyse this data together. Sorry for the\ninconvenience.", "attachment_id": null, "bug_id": 43220, "id": 107424, "time": "2007-08-29T13:09:40Z", "creator": "rpluem@apache.org", "creation_time": "2007-08-29T13:09:40Z", "is_private": false}, {"count": 13, "tags": [], "creator": "bdwheele@indiana.edu", "attachment_id": 20740, "id": 107467, "time": "2007-08-30T06:28:07Z", "bug_id": 43220, "creation_time": "2007-08-30T06:28:07Z", "is_private": false, "text": "Created attachment 20740\npacket dump for truncated request (part 1 of 2)\n\nHere's a packet dump from the startup of apache to after the truncated request.\n I had to split it due to size."}, {"count": 14, "tags": [], "creator": "bdwheele@indiana.edu", "attachment_id": 20741, "id": 107468, "time": "2007-08-30T06:30:18Z", "bug_id": 43220, "creation_time": "2007-08-30T06:30:18Z", "is_private": false, "text": "Created attachment 20741\npacket dump for truncated request (part 2 of 2)\n\nThis is part 2 of 2."}, {"count": 15, "attachment_id": 20742, "bug_id": 43220, "is_private": false, "id": 107469, "time": "2007-08-30T06:31:06Z", "creator": "bdwheele@indiana.edu", "creation_time": "2007-08-30T06:31:06Z", "tags": [], "text": "Created attachment 20742\nError log for truncated transaction\n\nThis is the error log in question"}, {"count": 16, "tags": [], "text": "Thanks for the update. I am still missing the debug message I expected :-(. This\nis not your fault. I do not know why it does not show up. I need to think about it.", "attachment_id": null, "bug_id": 43220, "id": 107491, "time": "2007-08-30T14:13:34Z", "creator": "rpluem@apache.org", "creation_time": "2007-08-30T14:13:34Z", "is_private": false}, {"count": 17, "attachment_id": null, "bug_id": 43220, "text": "Are there any thoughts on this issue? Brian, did you resolve this?", "id": 108857, "time": "2007-10-01T09:04:57Z", "creator": "john@sourcelabs.com", "creation_time": "2007-10-01T09:04:57Z", "tags": [], "is_private": false}, {"count": 18, "attachment_id": null, "bug_id": 43220, "text": "I resolved it in a round-about sort of way:  I used the http proxy instead of\nthe ajp proxy.  ", "id": 108858, "time": "2007-10-01T09:57:21Z", "creator": "bdwheele@indiana.edu", "creation_time": "2007-10-01T09:57:21Z", "tags": [], "is_private": false}, {"count": 19, "tags": [], "text": "We're seeing this problem too. The tomcat configuration works fine with Apache\n1.3, but we recently decided to move to Apache2 and it's broken for large files\nsent with AJP.\n\nThis is with Apache 2.2.4 on gentoo, tomcat 5.5.25, so slightly more up to date\nthan Brian's case, and it's still there.\n\nThis is preventing us moving to Apache2 at the moment...", "attachment_id": null, "bug_id": 43220, "id": 109924, "time": "2007-10-29T14:47:29Z", "creator": "apsmith@aps.org", "creation_time": "2007-10-29T14:47:29Z", "is_private": false}, {"count": 20, "attachment_id": null, "bug_id": 43220, "text": "Some more testing on our systems:\n\n* truncation happens reliably on any ajp response page longer than 1 MB, and\nintermittently on responses in the 100 - 500 kB range (the longer the response,\nthe more likely to have a problem)\n* problem is there for apache 2.2.6 server (latest download) as well.\n* However, the problem is only there when the tomcat server is on a linux box.\nRunning the identical tomcat server on a Mac OS X box resulted in no ajp\ntruncation problems.\n* We've tried this with apache-tomcat-5.5.20 and 5.5.25, same issue.\n* on the apache side in debug mode we're seeing the following error messages\nwhen it happens:\n    [error] ajp_check_msg_header() got bad signature 3d22\n    [error] ajp_ilink_receive() received bad header\n    [error] ajp_read_header: ajp_ilink_receive failed\n...\n\nexcept the '3d22' may be some other random 4-hex number\n* on the tomcat side we're seeing an IOException (5.5.25):\n    at org.apache.coyote.ajp.AjpAprProcessor.flush(AjpAprProcessor.java:1199)\n    at\norg.apache.coyote.ajp.AjpAprProcessor$SocketOutputBuffer.doWrite(AjpAprProcessor.java:1284)\n    at org.apache.coyote.Response.doWrite(Response.java:560)\n    at\norg.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:361)\n    at org.apache.tomcat.util.buf.ByteChunk.append(ByteChunk.java:352)\n...\n\nthough presumably tomcat is seeing the IO error because apache has closed the\nconnection?", "id": 109964, "time": "2007-10-30T11:06:23Z", "creator": "apsmith@aps.org", "creation_time": "2007-10-30T11:06:23Z", "tags": [], "is_private": false}, {"count": 21, "tags": [], "creator": "apsmith@aps.org", "attachment_id": null, "id": 109967, "time": "2007-10-30T12:51:32Z", "bug_id": 43220, "creation_time": "2007-10-30T12:51:32Z", "is_private": false, "text": "However, the problem is gone when we use tomcat 6.0.14. Maybe time to switch to\nthat... It would be nice to know what was causing this issue though!"}, {"count": 22, "attachment_id": null, "bug_id": 43220, "text": "What AJP connector did you use with 5.5.x? Despite one of my first comments I\nnow think that the Tomcat connector sends wrong data, but I did not have the\ntime to check this further and prove it.. It would be useful to know whether you\nused the \"classic\" blocking pure java ajp connector or the APR ajp connector.", "id": 109972, "time": "2007-10-30T13:42:23Z", "creator": "rpluem@apache.org", "creation_time": "2007-10-30T13:42:23Z", "tags": [], "is_private": false}, {"count": 23, "tags": [], "creator": "apsmith@aps.org", "attachment_id": null, "id": 109973, "time": "2007-10-30T13:55:15Z", "bug_id": 43220, "creation_time": "2007-10-30T13:55:15Z", "is_private": false, "text": "(In reply to comment #22)\n> What AJP connector did you use with 5.5.x? Despite one of my first comments I\n> now think that the Tomcat connector sends wrong data, but I did not have the\n> time to check this further and prove it.. It would be useful to know whether you\n> used the \"classic\" blocking pure java ajp connector or the APR ajp connector.\n\nHere's the server.xml line:\n    <Connector port=\"8009\" enableLookups=\"false\" redirectPort=\"8443\"\nprotocol=\"AJP/1.3\" />\n\n- i.e. no mention of APR. On the other hand, the tomcat stack trace started in:\n\norg.apache.coyote.ajp.AjpAprProcessor\n\nwhich sounds like an APR version of the connector. I'm afraid I'm not familiar\nenough with that to know if that answers the question or not! \n"}, {"count": 24, "tags": [], "creator": "apsmith@aps.org", "attachment_id": null, "id": 109975, "time": "2007-10-30T14:14:12Z", "bug_id": 43220, "creation_time": "2007-10-30T14:14:12Z", "is_private": false, "text": "Ah, if APR = Apache Portable Runtime, then no, we're not using that at the\nmoment, just pure java on the tomcat side."}, {"count": 25, "tags": [], "bug_id": 43220, "attachment_id": null, "text": "(In reply to comment #23)\n\n> \n> Here's the server.xml line:\n>     <Connector port=\"8009\" enableLookups=\"false\" redirectPort=\"8443\"\n> protocol=\"AJP/1.3\" />\n\nThis should use the APR connector if the APR libraries are present. If not the\npure java connector is used.\n\n> \n> - i.e. no mention of APR. On the other hand, the tomcat stack trace started in:\n> \n> org.apache.coyote.ajp.AjpAprProcessor\n\nUps. My fault I should have read your answer more closely. So yes, you used the\nAPR (= Apache Portable Runtime) connector in the case where the error occurred.\nMaybe you only used the APR connector on Linux and not on Mac OS (as the APR\nlibraries were possibly not present on Mac OS).\n", "id": 109977, "time": "2007-10-30T14:23:01Z", "creator": "rpluem@apache.org", "creation_time": "2007-10-30T14:23:01Z", "is_private": false}, {"count": 26, "tags": [], "creator": "apsmith@aps.org", "attachment_id": null, "id": 109988, "time": "2007-10-30T16:36:52Z", "bug_id": 43220, "creation_time": "2007-10-30T16:36:52Z", "is_private": false, "text": "Yup, APR's the problem! Those tricky sysadmin's, I hadn't realized it was set up\non our server.\n\nI removed the /usr/lib/libtcnative* libraries, restarted the tomcat-5.5.20\nserver, and the truncation problem was gone.  Restored them, and the truncations\nare back.\n\nSo, who's responsible for the APR AJP stuff?!"}, {"count": 27, "tags": [], "creator": "apsmith@aps.org", "attachment_id": null, "id": 110073, "time": "2007-10-31T12:37:19Z", "bug_id": 43220, "creation_time": "2007-10-31T12:37:19Z", "is_private": false, "text": "It turns out we didn't have the latest 'tomcat-native' package for gentoo. The\none that was causing problems was version 1.1.7. We've now updated to\ntomcat-native-1.1.10 and the truncation problem is gone!\n\nIt seems likely this was the same problem Brian was having - should probably\nconfirm this, but if so this bug can probably be considered resolved. Thanks."}, {"count": 28, "attachment_id": null, "bug_id": 43220, "text": "No further feedback. I assume it was a bug in tcnative and upgrading it fixed\nthe problem.", "id": 113059, "time": "2008-01-22T12:26:40Z", "creator": "rpluem@apache.org", "creation_time": "2008-01-22T12:26:40Z", "tags": [], "is_private": false}, {"count": 29, "tags": [], "creator": "tr.ml@gmx.de", "attachment_id": null, "id": 115603, "time": "2008-04-15T01:47:05Z", "bug_id": 43220, "creation_time": "2008-04-15T01:47:05Z", "is_private": false, "text": "(In reply to comment #28)\n> No further feedback. I assume it was a bug in tcnative and upgrading it fixed\n> the problem.\n\nHmm, I'm afraid we are still seeing this here with tcnative 1.12.\nWhen starting tomcat with \"-Djava.library.path=/usr/local/apr/lib\" we get:\n\najp_check_msg_header() got bad signature 420\n[error] ajp_ilink_receive() received bad header\n[error] ajp_read_header: ajp_ilink_receive failed\n[error] (120007)APR does not understand this error\ncode: proxy: send body failed to 127.0.0.1:8009\n\nWhen starting tomcat without this env variable it runs fine.\n\n- Redhat EL4 x86_64 U6, kernel 2.6.9-67.0.7.ELsmp x86_64\n\n- java version \"1.5.0_13\"\nJava(TM) 2 Runtime Environment, Standard Edition (build 1.5.0_13-b05)\nJava HotSpot(TM) 64-Bit Server VM (build 1.5.0_13-b05, mixed mode) \n\n- Apache Tomcat/5.5.25\n\n- ./httpd -V\nServer version: Apache/2.2.8 (Unix)\nServer built:   Mar 31 2008 15:17:07\nServer's Module Magic Number: 20051115:11\nServer loaded:  APR 1.2.12, APR-Util 1.2.12\nCompiled using: APR 1.2.12, APR-Util 1.2.12\nArchitecture:   64-bit\nServer MPM:     Worker\n  threaded:     yes (fixed thread count)\n    forked:     yes (variable process count)\n\n- # ll /usr/local/apr/lib/\ninsgesamt 2316\n-rw-r--r--  1 root root 1502768 31. M\u00e4r 15:24 libtcnative-1.a\n-rwxr-xr-x  1 root root     953 31. M\u00e4r 15:24 libtcnative-1.la\nlrwxrwxrwx  1 root root      23 31. M\u00e4r 15:24 libtcnative-1.so -> libtcnative-1.so.0.1.12\nlrwxrwxrwx  1 root root      23 31. M\u00e4r 15:24 libtcnative-1.so.0 -> libtcnative-1.so.0.1.12\n-rwxr-xr-x  1 root root  850307 31. M\u00e4r 15:24 libtcnative-1.so.0.1.12\ndrwxr-xr-x  2 root root    4096 31. M\u00e4r 15:24 pkgconfig"}, {"count": 30, "tags": [], "creator": "jim@apache.org", "attachment_id": null, "id": 121777, "time": "2008-10-22T07:07:54Z", "bug_id": 43220, "creation_time": "2008-10-22T07:07:54Z", "is_private": false, "text": "Can you confirm that this is actually a bug in HTTPD..."}, {"count": 31, "tags": [], "creator": "bdwheele@indiana.edu", "text": "Since we're no longer using it, I can't directly confirm it is an httpd issue, but since it doesn't appear when using mod_jk or when connecting to the tomcat instance directly, it does kind of point that way.", "id": 121778, "time": "2008-10-22T07:27:14Z", "bug_id": 43220, "creation_time": "2008-10-22T07:27:14Z", "is_private": false, "attachment_id": null}]