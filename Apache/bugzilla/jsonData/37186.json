[{"count": 0, "tags": [], "bug_id": 37186, "text": "I accidentally added a blank line to the start of my conf/tomcat-users.xml \nfile (i.e., above the \"<?xml\" line).  This caused a long stacktrace to \nlogs\\stdout[date].log on startup (see below), and failure of \"standard\" Realm \nauthentication.  This seems a very tiny error to cause a failure, and the \nerror message did not help to find it.\n\nThis error happened on an otherwise clean install of TC5.5.9/JDK1.5.0_02-b09 - \nthe only change that I had made was to edit tomcat-users.xml to enable access \nto the manager webapp.\n\nThe key parts of the stack trace were:\n\n20-Oct-2005 19:16:20 org.apache.tomcat.util.digester.Digester fatalError\nSEVERE: Parse Fatal Error at line 2 column 6: The processing instruction \ntarget matching \"[xX][mM][lL]\" is not allowed.\n...\n20-Oct-2005 19:49:50 org.apache.naming.NamingContext lookup\nWARNING: Unexpected exception resolving reference\n...\n20-Oct-2005 19:49:51 org.apache.catalina.realm.UserDatabaseRealm start\nSEVERE: Exception looking up UserDatabase under key UserDatabase\n\nThis baffled me initially.  It was not initially clear that this was an XML \nvalidation error, or even which file was causing the error.  In fact the last \nof the 3 errors above initially made me suspect a UserDatabase naming problem \nbetween server.xml and manager.xml.\n\nOn a related point, the parser seems more tolerant of other similar errors.  \nIf a comment line is added above the \"<?xml\" line rather than a blank line, \ncatalina removes the comment and carries on.  If a blank line is added after \nthe \"<?xml\" line, rather than before it, catalina removes the line from the \nfile.  Equally, catalina adds the \"<?xml\" line to the file if it is omitted.  \nIn all 3 cases, catalina overwrites the file with a \"corrected\" version.  None \nof these errors cause exceptions or failure of the UserDatabase.\n\nSo I have three points that I'd like to make please:\n\n1. The error message would be much more helpful if it included the path/name \nof the XML file that is causing the problem :)\n\n2. Is a blank line above the \"<?xml\" line actually invalid XML?  Even if it \nis, it seems very harsh to reject this error when other similar ones are \nallowed/corrected.\n\n3. Overwriting the config file is an annoyance for administrators, especially \nwhen it removes comments.  I would suggest that it might be better to just \nreport an exception and have the adminstrator look at it the config file and \nfix it.\n\nContents of tomcat-users.xml and stack trace follow.\n\nThanks.\n\n============================================================\ntomcat-users.xml as follows:\n------------------------------------------------------------\n<?xml version='1.0' encoding='utf-8'?>\n<tomcat-users>\n  <role rolename=\"manager\"/>\n  <user username=\"manager\" password=\"manager\" roles=\"manager\"/>\n</tomcat-users>\n============================================================\n\n============================================================\nTrimmed stack trace from stdout log follows:\n------------------------------------------------------------\n20-Oct-2005 19:49:50 org.apache.coyote.http11.Http11Protocol init\nINFO: Initializing Coyote HTTP/1.1 on http-8080\n\n20-Oct-2005 19:49:50 org.apache.catalina.startup.Catalina load\nINFO: Initialization processed in 3875 ms\n\n20-Oct-2005 19:49:50 org.apache.tomcat.util.digester.Digester fatalError\nSEVERE: Parse Fatal Error at line 2 column 6: The processing instruction \ntarget matching \"[xX][mM][lL]\" is not allowed.\norg.xml.sax.SAXParseException: The processing instruction target matching \"[xX]\n[mM][lL]\" is not allowed.\n\tat \ncom.sun.org.apache.xerces.internal.util.ErrorHandlerWrapper.createSAXParseExcep\ntion(ErrorHandlerWrapper.java:236)\n\n20-Oct-2005 19:49:50 org.apache.naming.NamingContext lookup\nWARNING: Unexpected exception resolving reference\norg.xml.sax.SAXParseException: The processing instruction target matching \"[xX]\n[mM][lL]\" is not allowed.\n\tat com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.parse\n(AbstractSAXParser.java:1269)\n\n20-Oct-2005 19:49:50 \norg.apache.catalina.mbeans.GlobalResourcesLifecycleListener createMBeans\nSEVERE: Exception processing Global JNDI Resources\njavax.naming.NamingException: The processing instruction target matching \"[xX]\n[mM][lL]\" is not allowed.\n\tat org.apache.naming.NamingContext.lookup(NamingContext.java:804)\n\n20-Oct-2005 19:49:50 org.apache.catalina.core.StandardService start\nINFO: Starting service Catalina\n\n20-Oct-2005 19:49:50 org.apache.catalina.core.StandardEngine start\nINFO: Starting Servlet Engine: Apache Tomcat/5.5.9\n\n20-Oct-2005 19:49:50 org.apache.tomcat.util.digester.Digester fatalError\nSEVERE: Parse Fatal Error at line 2 column 6: The processing instruction \ntarget matching \"[xX][mM][lL]\" is not allowed.\norg.xml.sax.SAXParseException: The processing instruction target matching \"[xX]\n[mM][lL]\" is not allowed.\n\tat \ncom.sun.org.apache.xerces.internal.util.ErrorHandlerWrapper.createSAXParseExcep\ntion(ErrorHandlerWrapper.java:236)\n\n20-Oct-2005 19:49:50 org.apache.naming.NamingContext lookup\nWARNING: Unexpected exception resolving reference\norg.xml.sax.SAXParseException: The processing instruction target matching \"[xX]\n[mM][lL]\" is not allowed.\n\tat com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.parse\n(AbstractSAXParser.java:1269)\n\n20-Oct-2005 19:49:51 org.apache.catalina.realm.UserDatabaseRealm start\nSEVERE: Exception looking up UserDatabase under key UserDatabase\njavax.naming.NamingException: The processing instruction target matching \"[xX]\n[mM][lL]\" is not allowed.\n\tat org.apache.naming.NamingContext.lookup(NamingContext.java:804)\n\n20-Oct-2005 19:49:51 org.apache.catalina.startup.Catalina start\nSEVERE: Catalina.start: \nLifecycleException:  No UserDatabase component found under key UserDatabase\n\tat org.apache.catalina.realm.UserDatabaseRealm.start\n(UserDatabaseRealm.java:230)\n\n20-Oct-2005 19:49:51 org.apache.catalina.startup.Catalina start\nINFO: Server startup in 859 ms\n============================================================", "id": 81480, "time": "2005-10-20T21:11:54Z", "creator": "apache-bug-db@web-startup.co.uk", "creation_time": "2005-10-20T21:11:54Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "bugzilla@schoenhaber.de", "attachment_id": null, "text": "(In reply to comment #0)\n> I accidentally added a blank line to the start of my conf/tomcat-users.xml \n> file (i.e., above the \"<?xml\" line).  This caused a long stacktrace to \n> logs\\stdout[date].log on startup (see below), and failure of \"standard\" Realm \n> authentication.  This seems a very tiny error to cause a failure, and the \n> error message did not help to find it.\n\nIn an XML file, the XML declaration (<?xml ...), if present, has to start at the\nbeginning of the document and must *not* be preceded by newlines, whitespaces or\nsomething else.\nSo, what you did was not \"a very tiny error\" but you destroyed the XML format of\nthe document. Therefore the XML parser borked and the error message you quoted\nsays so. I can't see any fault on tomcat's side here.\n\nMy proposal is to change this bug's status ro \"resolved, invalid\". I don't know\nwhether I'm allowed to do that. So I leave it to the developers to decide.\n", "id": 81483, "time": "2005-10-20T22:02:16Z", "bug_id": 37186, "creation_time": "2005-10-20T22:02:16Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 37186, "attachment_id": null, "text": "(In reply to comment #1)\n\nMarkus, you might well be right that I broke the XML syntax by adding that \nnewline char before the XML declaration.  I really don't know.  But I accept \nwhat you say.  I did look up some XML syntax docs on the web before posting \nthe original report, but I could not find anywhere that mentioned the xml \ndeclaration having to begin at the first char in the file.  If you have a \nmoment to point me to a webpage that describes this, I would be grateful :)\n\nI made three separate suggestions in my original report.  You have responded \nto point 2 (thank you), but please do not mark the whole \nreport \"resolved,invalid\" unless all 3 points are invalid.  I don't think that \nthey are ;)\n\nPS regarding my point 3, I'm not sure whether the files are re-written by the \norg.xml.sax classes or by TC classes.  If by org.xml.sax, then obviously there \nis nothing the TC team can do about it.  If not, I think this would be useful \nto fix.\n\nThanks!\n", "id": 81491, "time": "2005-10-21T01:23:42Z", "creator": "apache-bug-db@web-startup.co.uk", "creation_time": "2005-10-21T01:23:42Z", "is_private": false}, {"count": 3, "tags": [], "creator": "bugzilla@schoenhaber.de", "attachment_id": null, "id": 81493, "time": "2005-10-21T03:26:25Z", "bug_id": 37186, "creation_time": "2005-10-21T03:26:25Z", "is_private": false, "text": "(In reply to comment #2)\n> declaration having to begin at the first char in the file.  If you have a \n> moment to point me to a webpage that describes this, I would be grateful :)\n\nhttp://www.w3.org/TR/2004/REC-xml-20040204/#sec-well-formed\n\n> I made three separate suggestions in my original report.  You have responded \n> to point 2 (thank you), but please do not mark the whole \n> report \"resolved,invalid\" unless all 3 points are invalid.  I don't think that \n> they are ;)\n\nAs you can see, I have not changed this bug's status. Since I'm not a tomcat\ncommiter - I simply proposed to do so. And I simply expressed my opinion (which\nis in no way \"official\") as I do here:\nYou may have made three suggestions but you made only one bug report ;-). And\nthat one report is either valid or not. I don't think it is.\nIMO you could file your 1st suggestion (report the name of the broken file) in\nan enhancement request - or change this bug's status and description appropriately.\n\n> PS regarding my point 3, I'm not sure whether the files are re-written by the \n> org.xml.sax classes or by TC classes.  If by org.xml.sax, then obviously there \n> is nothing the TC team can do about it.  If not, I think this would be useful \n> to fix.\n\nThis is already fixed. Add the attribute readonly=\"true\" to the Resource element\ndeclaring the UserDatabase:\n<Resource name=\"UserDatabase\" auth=\"Container\"\n          type=\"org.apache.catalina.UserDatabase\"\n   description=\"User database that can be updated and saved\"\n       factory=\"org.apache.catalina.users.MemoryUserDatabaseFactory\"\n      pathname=\"conf/tomcat-users.xml\"\n      readonly=\"true\"/>\nI haven't found this documented in the changelog (may be blind) but I seem to\nremember that you need some tomcat version > 5.5.9. In 5.5.12 this definitely works.\n"}, {"count": 4, "tags": [], "creator": "apache-bug-db@web-startup.co.uk", "text": "(In reply to comment #3)\n\n> (In reply to comment #2)\n> > declaration having to begin at the first char in the file.  If you have a \n> > moment to point me to a webpage that describes this, I would be grateful :)\n> http://www.w3.org/TR/2004/REC-xml-20040204/#sec-well-formed\n\nThanks.  Yes I saw that and can see that it indicates that the XMLdecl has to \nbe at the beginning, but was unsure about how that was to be read, related to \nthis other section, which seems to imply that whitespace can optionally be \nadded, and the parser is to ignore it (?):\nhttp://www.w3.org/TR/2004/REC-xml-20040204/#sec-white-space\n\nBut I'm going off-topic now.  This is clearly an issue of my understanding of \nthe spec doc rather than any bug in TC or org.xml.sax.\n\n> > PS regarding my point 3\n\n> This is already fixed. \n>.In 5.5.12 this definitely works.\n\nOK then fair enough, that's point 3 resolved. I couldn't find any mention of \nit in the changelog or bugzilla either.\n\n> IMO you could file your 1st suggestion (report the name of the broken file) \nin\n> an enhancement request - or change this bug's status and description \nappropriately.\n\nI agree based on the above.  I have changed the status/descr just now.\n\nThanks again :)\n", "id": 81514, "time": "2005-10-21T13:03:23Z", "bug_id": 37186, "creation_time": "2005-10-21T13:03:23Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "text": "I have been bitten by similar er... problems in the past and would agree with\nthe OP that his point #1 is a very significant one. Yes, as Markus pointed out,\nXML has strict well-formedness rules. But the purpose of those rules is to make\nsyntax errors/inconsistencies stand out early, so they can be fixed. Reporting\nill-formed XML without reporting the file it occurred in falls far short of this\npurpose. I have spent valuable time trying to track down Tomcat's reported XML\nparsing problems in the past, and eventually gave up.\n\nI propose changing the severity of this issue from \"enhancement\" to \"normal\" or\nat least \"minor\".", "attachment_id": null, "id": 81844, "creator": "lars@huttar.net", "time": "2005-10-27T19:13:06Z", "bug_id": 37186, "creation_time": "2005-10-27T19:13:06Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 37186, "text": "If you enable DEBUG-level logging for any of the classes in your stack trace,\nyou'll see additional information, including the full name and path of the files\nit is parsing BEFORE it starts parsing them.", "count": 6, "id": 82380, "time": "2005-11-11T03:59:39Z", "creator": "yoavs@computer.org", "creation_time": "2005-11-11T03:59:39Z", "is_private": false}]