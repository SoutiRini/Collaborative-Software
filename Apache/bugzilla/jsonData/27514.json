[{"count": 0, "tags": [], "creator": "remus@nolimits.ro", "attachment_id": null, "is_private": false, "id": 53653, "time": "2004-03-08T12:36:26Z", "bug_id": 27514, "creation_time": "2004-03-08T12:36:26Z", "text": "Environment variables mapped through the JkEnvVar (mod_jk 1.2) are present in \nthe request.getAttribute(xxx) but not in request.getAttributeNames(). \n \nAs it turns out in \njakarta-tomcat-catalina/catalina/src/share/org/apache/coyote/tomcat5/CoyoteRequest.java \ngetAttribute method is properly implemented but in the getAttributeNames the \nattributes comming from the coyoteRequest are not taken into consideration \n(the same might happen in Tomcat 4 too, didn't tested) \n \nI made a patch to correct the behavior, however not being very familiar with \nthe tomcat sources the patch corrects the above described behavior but might \nnot be in line with your way of doing things so feel free to adjust on it. \n \nBest regards, \n\tRemus \n \n--- CoyoteRequest.java\t2004-02-14 12:26:50.000000000 +0200 \n+++ CoyoteRequest.java\t2004-03-08 14:17:13.661831128 +0200 \n@@ -163,6 +163,7 @@ \n      */ \n     public void setCoyoteRequest(Request coyoteRequest) { \n         this.coyoteRequest = coyoteRequest; \n+        if(coyoteRequest.getAttributes().size() == 0) copyOriginalAttributes \n= false;\t\t \n         inputBuffer.setRequest(coyoteRequest); \n     } \n  \n@@ -403,6 +404,14 @@ \n      */  \n     protected Log log=null; \n      \n+ \n+    /** \n+    * We can have attributes comming from JK (JkEnvVar) so before serving \nthem \n+    * trough getAttributeNames we have to be sure that the local attributes  \n+    * contains the ones from the coyoteRequest. \n+    */ \n+    protected boolean copyOriginalAttributes = true; \n+ \n     // --------------------------------------------------------- Public \nMethods \n  \n     /** \n@@ -436,6 +445,7 @@ \n         localName = null; \n  \n         attributes.clear(); \n+        copyOriginalAttributes = true; \n         notes.clear(); \n         cookies = null; \n  \n@@ -990,6 +1000,7 @@ \n         if (isSecure()) { \n             getAttribute(Globals.CERTIFICATES_ATTR); \n         } \n+        if( copyOriginalAttributes) \nattributes.putAll(coyoteRequest.getAttributes()); \n         return new Enumerator(attributes.keySet(), true); \n     }"}, {"count": 1, "tags": [], "bug_id": 27514, "attachment_id": 10704, "id": 53654, "time": "2004-03-08T12:37:48Z", "creator": "remus@nolimits.ro", "creation_time": "2004-03-08T12:37:48Z", "is_private": false, "text": "Created attachment 10704\nThe patch."}, {"count": 2, "tags": [], "bug_id": 27514, "attachment_id": null, "id": 53655, "time": "2004-03-08T12:49:41Z", "creator": "remm@apache.org", "creation_time": "2004-03-08T12:49:41Z", "is_private": false, "text": "\n\n*** This bug has been marked as a duplicate of 25363 ***"}]