[{"count": 0, "tags": [], "bug_id": 10909, "text": "Symptoms: Servlet destroy() method fails with a java.lang.NoClassDefFoundError\nwhen an anonymous local class is used.  A similar anonymous local class can be\nused e.g. in the servlet doGet() method without error.\n\nExample code producing the error:\n\npackage tests;\n\nimport javax.servlet.*;\nimport javax.servlet.http.*;\n\npublic class TestServlet extends HttpServlet {\n   \n   protected String[] strings = {\n         \"delta\",  \"charlie\", \"echo\", \n         \"foxtrot\", \"alpha\", \"bravo\"\n   };\n   \n   public void init() {\n   }\n   \n   protected void doGet(HttpServletRequest request, HttpServletResponse response)\n   throws ServletException, java.io.IOException {\n\n      java.util.ArrayList myList = new java.util.ArrayList();\n      for(int i = 0; i < strings.length; ++i) {\n         myList.add(strings[i]);\n      }\n\n      response.setContentType(\"text/plain\");\n      java.io.PrintWriter out = response.getWriter();\n      out.println(new java.util.Date());\n      out.println(\"Unsorted list:\");\n      for(java.util.Iterator it = myList.iterator(); it.hasNext(); ) {\n         out.println(it.next());\n      }\n      out.println(\"Reverse sorted using comparator inner class:\");\n      java.util.Collections.sort(myList, new java.util.Comparator() {\n         public int compare(java.lang.Object o1, java.lang.Object o2) {\n            String s1 = (String) o1;\n            String s2 = (String) o2;\n            return s2.compareTo(s1);\n         }\n      });\n      for(java.util.Iterator it = myList.iterator(); it.hasNext(); ) {\n         out.println(it.next());\n      }\n      out.close();\n   }\n   \n   public void destroy() {\n\n      java.util.ArrayList myList = new java.util.ArrayList();\n      for(int i = 0; i < strings.length; ++i) {\n         myList.add(strings[i]);\n      }\n\n      try {\n         System.out.println(\"Reverse sorted list:\");\n         for(java.util.Iterator it = myList.iterator(); it.hasNext(); ) {\n            System.out.println(it.next());\n         }\n         System.out.println(\"Sorted using comparator inner class:\");\n         java.util.Collections.sort(myList, new java.util.Comparator() {\n            public int compare(java.lang.Object o1, java.lang.Object o2) {\n               String s1 = (String) o1;\n               String s2 = (String) o2;\n               return s1.compareTo(s2);\n            }\n         });\n         for(java.util.Iterator it = myList.iterator(); it.hasNext(); ) {\n            System.out.println(it.next());\n         }\n      }\n      catch(Throwable th) {\n         log(\"caught in destroy(): \", th);\n      }\n      super.destroy();\n   }\n   \n}\n\nThe code in the doGet() method works fine (i.e. the list is sorted in reverse\nalphabetical order as expected).  However, when Tomcat is stopped in the normal\nway, the essentially identical code in the destroy() method throws an exception\nlike:\n\n2002-07-17 18:12:14 TestServlet: caught in destroy(): \njava.lang.NoClassDefFoundError: tests/TestServlet$2\n\tat tests.TestServlet.destroy(TestServlet.java:58)\n\tat org.apache.catalina.core.StandardWrapper.unload(StandardWrapper.java:1090)\n\tat org.apache.catalina.core.StandardWrapper.stop(StandardWrapper.java:1298)\n\tat org.apache.catalina.core.ContainerBase.removeChild(ContainerBase.java:984)\n\tat org.apache.catalina.startup.ContextConfig.stop(ContextConfig.java:877)\n\tat org.apache.catalina.startup.ContextConfig.lifecycleEvent(ContextConfig.java:226)\n\tat\norg.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:155)\n\tat org.apache.catalina.core.ContainerBase.stop(ContainerBase.java:1151)\n\tat org.apache.catalina.core.StandardContext.stop(StandardContext.java:3495)\n\tat org.apache.catalina.core.ContainerBase.removeChild(ContainerBase.java:984)\n\tat org.apache.catalina.core.StandardHost.remove(StandardHost.java:815)\n\tat org.apache.catalina.startup.HostConfig.undeployApps(HostConfig.java:422)\n\tat org.apache.catalina.startup.HostConfig.stop(HostConfig.java:402)\n\tat org.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java:234)\n\tat\norg.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:155)\n\tat org.apache.catalina.core.ContainerBase.stop(ContainerBase.java:1151)\n\tat org.apache.catalina.core.ContainerBase.stop(ContainerBase.java:1163)\n\tat org.apache.catalina.core.StandardService.stop(StandardService.java:435)\n\tat org.apache.catalina.core.StandardServer.stop(StandardServer.java:535)\n\tat org.apache.catalina.startup.Catalina.start(Catalina.java:799)\n\tat org.apache.catalina.startup.Catalina.execute(Catalina.java:681)\n\tat org.apache.catalina.startup.Catalina.process(Catalina.java:179)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat\nsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:324)\n\tat org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:243)\n\nThe TestServlet$2.class (and the TestServlet$1.class) anonymous class\nimplementation files are both present in the WEB-INF/classes/tests subdirectory.\n\nThe problem seems to only occur in the destroy() method.", "id": 19698, "time": "2002-07-17T17:20:21Z", "creator": "alex-news@oenone.demon.co.uk", "creation_time": "2002-07-17T17:20:21Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "alex-news@oenone.demon.co.uk", "text": "I have verified this bug as occuring with Tomcat 4.0.4 (released) under both:\nWindows XP, Sun JDK 1.4.0-b92\nand\nLinux Debian 3.0/testing, kernel 2.2.20, Sun JDK 1.4.0-b92\n\nA recent Tomcat 4.1 release running on Linux seems to not have this bug.", "id": 19777, "time": "2002-07-18T15:15:38Z", "bug_id": 10909, "creation_time": "2002-07-18T15:15:38Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "medthomas@ntlworld.com", "attachment_id": null, "id": 49746, "time": "2003-12-27T20:53:30Z", "bug_id": 10909, "creation_time": "2003-12-27T20:53:30Z", "is_private": false, "text": "Since Alex added a comment that this has been fixed in Tomcat 4.1.x (version \nnot specified) I am closing this bug as fixed."}]