[{"count": 0, "tags": [], "bug_id": 41011, "attachment_id": null, "text": "After switching to a client configuration where two JSP pages are loaded\nsimultaneously, I started getting LinkageErrors 10-20% of the time after\nrestarting Tomcat.  By passing -verbose:class to the JVM, I discovered that:\n\n1. If the JSP classes and their dependencies are loaded one at a time,\neverything is fine.\n\n2. If the same classes are loaded concurrently in different threads, some of the\ndependencies may be loaded twice.  In this case the -verbose:class output shows\na class loaded twice from the same location.\n\nThis tends to happen to me with the Struts Tiles classes, which are used by both\nJSPs.  The first JSP starts loading its classes:\n\n[Loaded org.apache.jsp.WEB_002dINF.include.xxx.pages.sidebar_jsp from\nfile:/xxx/catalina-base/work/Catalina/localhost/_/]\n[Loaded org.apache.struts.taglib.tiles.PutTagParent from\nfile:/xxx/repository/struts/struts/1.2.9/struts-1.2.9.jar]\n[Loaded org.apache.struts.taglib.tiles.PutListTagParent from\nfile:/xxx/repository/struts/struts/1.2.9/struts-1.2.9.jar]\n...\n\nThe second JSP starts loading before the first finishes:\n\n[Loaded org.apache.jsp.WEB_002dINF.include.xxx.pages.welcome_jsp from\nfile:/xxx/catalina-base/work/Catalina/localhost/_/]\n[Loaded org.apache.struts.taglib.tiles.InsertTag$InsertHandler from\nfile:/xxx/repository/struts/struts/1.2.9/struts-1.2.9.jar]\n\nOne of the Tiles classes ends up being loaded twice:\n\n[Loaded org.apache.struts.taglib.tiles.PutTag from\nfile:/xxx/repository/struts/struts/1.2.9/struts-1.2.9.jar]\n[Loaded org.apache.struts.taglib.tiles.PutTag from\nfile:/xxx/repository/struts/struts/1.2.9/struts-1.2.9.jar]\n\nThe second JSP pages fails to render:\n\n2006-11-21 11:32:49,617 [http-8080-Processor3] ERROR\norg.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/].[jsp] -\nServlet.service() for servlet jsp threw exception\njava.lang.LinkageError: duplicate class definition:\norg/apache/struts/taglib/tiles/PutTag\n\tat java.lang.ClassLoader.defineClass1(Native Method)\n\tat java.lang.ClassLoader.defineClass(ClassLoader.java:620)\n\tat java.security.SecureClassLoader.defineClass(SecureClassLoader.java:124)\n\tat java.net.URLClassLoader.defineClass(URLClassLoader.java:260)\n\tat java.net.URLClassLoader.access$100(URLClassLoader.java:56)\n\tat java.net.URLClassLoader$1.run(URLClassLoader.java:195)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat java.net.URLClassLoader.findClass(URLClassLoader.java:188)\n\tat\norg.apache.catalina.loader.WebappClassLoader.findClass(WebappClassLoader.java:880)\n\tat\norg.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1319)\n\tat\norg.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1198)\n\tat org.apache.jasper.servlet.JasperLoader.loadClass(JasperLoader.java:127)\n\tat org.apache.jasper.servlet.JasperLoader.loadClass(JasperLoader.java:65)\n\tat java.lang.ClassLoader.loadClassInternal(ClassLoader.java:319)\n\tat\norg.apache.jsp.WEB_002dINF.include.xxx.pages.welcome_jsp._jspx_meth_tiles_put_0(welcome_jsp.java:135)\n\tat\norg.apache.jsp.WEB_002dINF.include.xxx.pages.welcome_jsp._jspx_meth_tiles_insert_0(welcome_jsp.java:109)\n\tat\norg.apache.jsp.WEB_002dINF.include.xxx.pages.welcome_jsp._jspService(welcome_jsp.java:79)\n\tat org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:97)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:802)\n\tat org.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:332)\n\tat org.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:314)\n\tat org.apache.jasper.servlet.JspServlet.service(JspServlet.java:264)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:802)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:252)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)\n\tat\norg.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:672)\n\tat\norg.apache.catalina.core.ApplicationDispatcher.processRequest(ApplicationDispatcher.java:463)\n\tat\norg.apache.catalina.core.ApplicationDispatcher.doForward(ApplicationDispatcher.java:398)\n\tat\norg.apache.catalina.core.ApplicationDispatcher.forward(ApplicationDispatcher.java:301)\n\tat org.apache.struts.action.RequestProcessor.doForward(RequestProcessor.java:1085)\n\tat\norg.apache.struts.tiles.TilesRequestProcessor.doForward(TilesRequestProcessor.java:263)\n\tat\norg.apache.struts.action.RequestProcessor.processForwardConfig(RequestProcessor.java:398)\n\tat\norg.apache.struts.tiles.TilesRequestProcessor.processForwardConfig(TilesRequestProcessor.java:318)\n\tat org.apache.struts.action.RequestProcessor.process(RequestProcessor.java:241)\n\tat org.apache.struts.action.ActionServlet.process(ActionServlet.java:1196)\n\tat org.apache.struts.action.ActionServlet.doGet(ActionServlet.java:414)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:689)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:802)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:252)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)\n\tat xxx.ResponseHeaderInserter.doFilter(ResponseHeaderInserter.java:62)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)\n\tat\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)\n\tat\norg.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:213)\n\tat\norg.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:178)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:126)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:105)\n\tat org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:541)\n\tat\norg.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:107)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:148)\n\tat org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:869)\n\tat\norg.apache.coyote.http11.Http11BaseProtocol$Http11ConnectionHandler.processConnection(Http11BaseProtocol.java:664)\n\tat\norg.apache.tomcat.util.net.PoolTcpEndpoint.processSocket(PoolTcpEndpoint.java:527)\n\tat\norg.apache.tomcat.util.net.LeaderFollowerWorkerThread.runIt(LeaderFollowerWorkerThread.java:80)\n\tat\norg.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:684)\n\tat java.lang.Thread.run(Thread.java:613)\n\nThe error seems to be recoverable, ie. I can hit refresh and it works.  I see\nthat there have been some WebappClassLoader synchronization issues in the past.\n I've only tried 5.5.17, but I don't think recent fixes were related (maybe\nrevision 469360?).\n\nI'm using a custom Loader (to load jars from outside of WEB-INF/lib), but it\njust wraps a normal WebappLoader(getContainer().getParentClassLoader()) and\ncalls addRepository with file URLs.  I don't think it's related to this situation...\n\nJava version:\njava version \"1.5.0_08\"\nJava(TM) 2 Runtime Environment, Standard Edition (build 1.5.0_08-b03)\nJava HotSpot(TM) 64-Bit Server VM (build 1.5.0_08-b03, mixed mode)\n\nThanks!", "id": 96051, "time": "2006-11-21T14:22:25Z", "creator": "crv@itasoftware.com", "creation_time": "2006-11-21T14:22:25Z", "is_private": false}, {"count": 1, "tags": [], "creator": "chris@sourcelabs.com", "attachment_id": null, "text": "Can you provide a stripped-down test case that reproduces this issue?", "id": 96091, "time": "2006-11-22T10:56:06Z", "bug_id": 41011, "creation_time": "2006-11-22T10:56:06Z", "is_private": false}, {"count": 2, "attachment_id": null, "bug_id": 41011, "text": "Hmm, I'm having trouble reproducing today.  I guess I'll need to investigate\nfurther.", "id": 96104, "time": "2006-11-22T14:11:13Z", "creator": "crv@itasoftware.com", "creation_time": "2006-11-22T14:11:13Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 41011, "text": "Looking at the stack trace, Tomcat's WebappClassLoader couldn't find the class\nand  delegated to the parent class loader. It is an instance of\njava.net.URLClassLoader that is loading the class.\n\nGiven it is the JVM that is loading the class, this looks like a synchronisation\n(or rather lack of synchronisation) issue with the JVM. A quick check of the JVM\nsource suggests this is likely since I can't see any synchronisation at all.", "id": 96697, "time": "2006-12-09T21:32:52Z", "creator": "markt@apache.org", "creation_time": "2006-12-09T21:32:52Z", "is_private": false, "attachment_id": null}]