[{"count": 0, "tags": [], "creator": "joe@ispsoft.de", "attachment_id": null, "id": 2519, "time": "2001-05-17T17:34:34Z", "bug_id": 1802, "creation_time": "2001-05-17T17:34:34Z", "is_private": false, "text": "If a servlet uses response.getWriter(), then the Writers flush() method\nwon't work. The reason is the following code in\norg.apache.tomcat.core.BufferedServletOutputStream:\n\n    // If a servlet is using PrintWriter then this method is NO-OP.\n    public void flush() throws IOException {\n\tif (this.usingWriter == false)\n\t    reallyFlush();\n    }\n\nI can see no reason for this NO-OP and suggest changing this to\n\n    public void flush() throws IOException { reallyFlush(); }\n\nor perhaps removing the usingWriter variable completely.\n\nThe problem can be demonstrated with the servlet that I will attach.\nThe example emits 7 lines with a delay of 10 seconds between two\nlines. The example is included 30 times:\n\n  - The first 10 tests are using response.getOutputStream() and\n    are working fine.\n  - Tests 11-20 are using response.getWriter() and fail (from my\n    point of view), because the client is waiting more than one\n    minute for the first line\n  - Tests 21-30 are using response.getOutputStream() again.\n    Surprisingly they fail also! The reason is that the recycle\n    method in BufferedServletOutputStream doesn't reset the\n    usingWriter() variable\n\nConclusion: TomCat is completely useless in push mode.\n\nP.S: If that is of importance: I am using TomCat in standalone mode,\nbecause Apache on Windows is also useless for push mode."}, {"count": 1, "tags": [], "creator": "joe@ispsoft.de", "text": "Created attachment 164\nServlet with main() mode demonstrating the problem", "id": 2520, "time": "2001-05-17T17:35:35Z", "bug_id": 1802, "creation_time": "2001-05-17T17:35:35Z", "is_private": false, "attachment_id": 164}, {"count": 2, "tags": [], "text": "First, thanks for the very thorough sample application, if half the bug reports \ncame with stuff like this my life would be *much* easier.\n\nThe recycle() thing is obviously a bug and simple to fix.  It should appear in \nthe next tomcat_32 nightly bulid.\n\nThe flush part is a little more difficult.  There is code in \nBufferedServletOutputStream.flush(), that dates back to the beginning of time, \nthat explicitly causes a flush on the PrintWriter to be ignored in the output \nstream.  I'm not sure that I completely agree with this, but making a change \nhere runs a high risk of causing problems in other parts of the system \n(JSPWriter, BodyContentImpl, etc.).  I primary requirement at this stage of the \ntomcat_32 branch is to avoid breaking anything.  There are so many buffers \ninvolved in the PrintWriter case that changing the flushing could cause \nunexpected results.\n\nThere is a work around that should be portable to all containers.  Instead of \ncalling flush() on the output stream or the PrintWriter call \nServletRequest.flushBuffer().  This will cause the PrintWriter to be flushed \ninto the BufferedServletOutputStream and then that buffer will be flushed to \nthe client.  ", "attachment_id": null, "id": 3213, "creation_time": "2001-06-22T13:19:36Z", "time": "2001-06-22T13:19:36Z", "creator": "marc.saegesser@apropos.com", "bug_id": 1802, "is_private": false}]