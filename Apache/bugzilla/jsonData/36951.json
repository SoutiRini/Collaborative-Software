[{"count": 0, "text": "I don't think this is a dupe of 29744.  \n\nApache 2.1.8 (also checked 2.1.7 and 2.1.6, same prob)\nOccurs on UnixWare 7.1.3 MP2, unable to demonstrate on Linux.\n\nI realize most folks don't have a UnixWare box to abuse.  I'd like to help \nisolate this.  Please let me know what I can do.  \n\nUsing Apache as a caching-proxy.  When the browser attempts to make a secure \nCONNECT through the proxy, and the browser side of the connection terminates \nungracefully, the related httpd processes run away with the processor.  \n\nConfiguration:\nCC=cc CFLAGS=\"-KPIC,thread\" ./configure \\\n--prefix=/usr/local/apache2 \\\n--enable-cache \\\n--enable-disk-cache \\\n--enable-proxy \\\n--enable-proxy-connect \\\n--enable-proxy-http \\\n--disable-ipv6 \\\n--disable-autoindex \\\n--disable-userdir \\\n--with-mpm=prefork\n\nI've tried to build with the worker MPM, no joy.  Output from make and \nhttpd.conf available as;\n\nhttp://citiperk.net/make_out.txt\nhttp://citiperk.net/make_err.txt\nhttp://citiperk.net/httpd.conf.txt\n\nThis problem came up while we were adding people to the proxy for the first \ntime, trying to see how it would perform with more than just me.  It worked \nfine, but I would occasionally find a runaway process after a day or two of it \nbeing up.  \n\nI can now reliably reproduce the problem by requesting a secure page and \nclosing the browser before the page can complete. I am not able to break it by \nrequesting non-secure pages. \n\nWith the processes spun up I looked at netstat.  There appeared to be three \nconnections from the proxy to the content still open.\n\nProto Recv-Q Send-Q  Local Address   Foreign Address        (state)\ntcp        0      0  proxy.51767     content.443   ESTABLISHED\ntcp        0      0  proxy.51766     content.443   ESTABLISHED\ntcp        0      0  proxy.51765     content.443   ESTABLISHED\n\nThese close after a few minutes, but the runaway httpd processes are still \nconsuming all the available cpu time.  With the Apache log running at debug \nlevel the only relevant entries indicates a CONNECT has been established\n\n[Wed Oct 05 03:05:20 2005] [debug] proxy_util.c(1428): proxy: CONNECT: fam 2 \nsocket created to connect to content.company.net\n[Wed Oct 05 03:05:20 2005] [debug] mod_proxy_connect.c(231): proxy: CONNECT: \nReturning 200 OK Status\n[Wed Oct 05 03:05:20 2005] [debug] mod_proxy_connect.c(252): proxy: CONNECT: \nsetting up poll()\n\nRunning \"truss -f -n -rall -mall -tall -p <runaway pid>\" shows similar for each \nrunaway, and they each stream to the screen as fast as the window will paint.\n\n28750:  poll(0x081C8820, 2, -1)         = 1\n\nWould appreciate any ideas on how to help debug.", "bug_id": 36951, "is_private": false, "id": 80848, "time": "2005-10-06T16:29:25Z", "creator": "rjs@cityperk.net", "creation_time": "2005-10-06T16:29:25Z", "tags": [], "attachment_id": null}, {"count": 1, "tags": [], "creator": "rpluem@apache.org", "is_private": false, "id": 80849, "attachment_id": null, "bug_id": 36951, "creation_time": "2005-10-06T16:46:12Z", "time": "2005-10-06T16:46:12Z", "text": "I guess http://httpd.apache.org/dev/debugging.html#gdb could be useful for you\nto further debug the problem. It would be nice to have stacktrace of the runaway\nprocess to get an idea what goes wrong."}, {"count": 2, "tags": [], "creator": "trawick@apache.org", "text": "I wonder if this is it?  Streams-based TCP surfacing EOF situation in different\nmanner?\n\nIndex: modules/proxy/mod_proxy_connect.c\n===================================================================\n--- modules/proxy/mod_proxy_connect.c   (revision 292899)\n+++ modules/proxy/mod_proxy_connect.c   (working copy)\n@@ -358,6 +358,7 @@\n                         break;\n                 }\n                 else if ((pollevent & APR_POLLERR) || (pollevent & APR_POLLHUP))\n+                    rv = APR_EOF;\n                     break;\n             }\n             else\n\nThe break in that scenario just gets us out of the loop for checking events\nwhich were notified.  It doesn't get us out of the while (1).\n\nThere are other paths to consider in that loop as well.  This was just a quick\ntheory.", "id": 80853, "attachment_id": null, "bug_id": 36951, "creation_time": "2005-10-06T18:05:31Z", "time": "2005-10-06T18:05:31Z", "is_private": false}, {"count": 3, "text": "UnixWare debug stack trace follows.  I'm currently stepping through and \nprinting the stack.  If I get it to loop I'll put the whole trace up.\n\nNew program httpd (process p1) grabbed\nCreated 1 thread(s) for process p1\nHALTED p1.1 [_poll]\n        0xbffc3b3c (_poll+12:)          jb     0x1 <bffc3b3f>\nError: Could not grab /usr/local/apache2/bin/httpd\ndebug> stack\nStack Trace for p1.1, Program httpd\n*[0] _poll(0x81bdac8, 0x2, 0xffffffff)  [0xbffc3b3c]\n [1] apr_pollset_poll(0x81bdab0, 0xffffffff, 0xffffffff, 0x8045558, 0x804555c)  \n[0xbfc7a4a9]\n [2] proxy_connect_handler(r=0x81bc498, worker=0x8179258, conf=0x80f5de8, \nurl=\"content:443\", proxyname=NULL, proxyport=0) [mod_proxy_connect.c@284]\n [3] proxy_run_scheme_handler(r=0x81bc498, worker=0x8179258, conf=0x80f5de8, \nurl=\"content:443\", proxyhost=NULL, proxyport=0)      [mod_proxy.c@1928]\n [4] proxy_handler(r=0x81bc498) [mod_proxy.c@725]\n [5] ap_run_handler(r=0x81bc498)        [config.c@158]\n [6] ap_invoke_handler(r=0x81bc498)     [config.c@371]\n [7] ap_process_request(r=0x81bc498)    [http_request.c@258]\n [8] ap_process_http_connection(c=0x81b6538)    [http_core.c@172]\n [9] ap_run_process_connection(c=0x81b6538)     [connection.c@43]\n [10] ap_process_connection(c=0x81b6538, csd=0x81b6480) [connection.c@178]\n [11] child_main(child_num_arg=5)       [prefork.c@640]\n [12] make_child(s=0x80f3120, slot=5)   [prefork.c@736]\n [13] perform_idle_server_maintenance(p=0x80ed3c0)      [prefork.c@871]\n [14] ap_mpm_run(_pconf=0x80ed3c0, plog=0x81334d8, s=0x80f3120) [prefork.c@1075]\n [15] main(argc=3, argv=0x804790c, 0x804791c)   [main.c@710]\n [16] _start()  [0x8053650]\n", "bug_id": 36951, "is_private": false, "id": 80855, "time": "2005-10-06T18:40:40Z", "creator": "rjs@cityperk.net", "creation_time": "2005-10-06T18:40:40Z", "tags": [], "attachment_id": null}, {"count": 4, "text": "Here's the loop.\n\n [2] proxy_connect_handler(r=0x81bc498, worker=0x8179258, conf=0x80f5de8, \nurl=\"content:443\", proxyname=NULL, proxyport=0) [mod_proxy_connect.c@284]\n\n*[0] proxy_connect_handler(r=0x81bc498, worker=0x8179258, conf=0x80f5de8, \nurl=\"content:443\", proxyname=NULL, proxyport=0) [mod_proxy_connect.c@294]\n\n*[0] proxy_connect_handler(r=0x81bc498, worker=0x8179258, conf=0x80f5de8, \nurl=\"content:443\", proxyname=NULL, proxyport=0) [mod_proxy_connect.c@295]\n\n*[0] proxy_connect_handler(r=0x81bc498, worker=0x8179258, conf=0x80f5de8, \nurl=\"content:443\", proxyname=NULL, proxyport=0) [mod_proxy_connect.c@297]\n\n*[0] proxy_connect_handler(r=0x81bc498, worker=0x8179258, conf=0x80f5de8, \nurl=\"content:443\", proxyname=NULL, proxyport=0) [mod_proxy_connect.c@331]\n\n*[0] proxy_connect_handler(r=0x81bc498, worker=0x8179258, conf=0x80f5de8, \nurl=\"content:443\", proxyname=NULL, proxyport=0) [mod_proxy_connect.c@332]\n\n*[0] proxy_connect_handler(r=0x81bc498, worker=0x8179258, conf=0x80f5de8, \nurl=\"content:443\", proxyname=NULL, proxyport=0) [mod_proxy_connect.c@333]\n\n*[0] proxy_connect_handler(r=0x81bc498, worker=0x8179258, conf=0x80f5de8, \nurl=\"content:443\", proxyname=NULL, proxyport=0) [mod_proxy_connect.c@360]\n\n*[0] proxy_connect_handler(r=0x81bc498, worker=0x8179258, conf=0x80f5de8, \nurl=\"content:443\", proxyname=NULL, proxyport=0) [mod_proxy_connect.c@361]\n\n*[0] proxy_connect_handler(r=0x81bc498, worker=0x8179258, conf=0x80f5de8, \nurl=\"content:443\", proxyname=NULL, proxyport=0) [mod_proxy_connect.c@366]\n\n*[0] proxy_connect_handler(r=0x81bc498, worker=0x8179258, conf=0x80f5de8, \nurl=\"content:443\", proxyname=NULL, proxyport=0) [mod_proxy_connect.c@284]\n", "bug_id": 36951, "is_private": false, "id": 80857, "time": "2005-10-06T19:43:10Z", "creator": "rjs@cityperk.net", "creation_time": "2005-10-06T19:43:10Z", "tags": [], "attachment_id": null}, {"count": 5, "tags": [], "creator": "rpluem@apache.org", "text": "Thanks for the data. It is very helpful. The loop seems to confirm Jeffs theory.\nBut I guess the patch should look like\n\nIndex: mod_proxy_connect.c\n===================================================================\n--- mod_proxy_connect.c (Revision 295013)\n+++ mod_proxy_connect.c (Arbeitskopie)\n@@ -357,8 +357,11 @@\n                     else\n                         break;\n                 }\n-                else if ((pollevent & APR_POLLERR) || (pollevent & APR_POLLHUP))\n+                else if ((pollevent & APR_POLLERR)\n+                         || (pollevent & APR_POLLHUP)) {\n+                    rv = APR_EOF;\n                     break;\n+                }\n             }\n             else\n                 break;\n\nbecause I guess we need to set rv to APR_EOF *and* do a break.", "id": 80865, "attachment_id": null, "bug_id": 36951, "creation_time": "2005-10-06T20:49:18Z", "time": "2005-10-06T20:49:18Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 36951, "text": "Ruediger, that appears to correct the bug.  With the change you describe \ncompiled in I am no longer able to reproduce the problem.  Ausgezeichnete \nArbeit.", "id": 80868, "time": "2005-10-06T21:39:01Z", "creator": "rjs@cityperk.net", "creation_time": "2005-10-06T21:39:01Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 36951, "attachment_id": null, "text": "The credits belong to Jeff who had the correct theory just from the start. I\nonly tweaked his patch.\nJeff I am not quite sure by your comments if you fear bad sideeffects of this\npatch. So I would like to leave the commit decision to you.", "id": 80872, "time": "2005-10-06T22:13:24Z", "creator": "rpluem@apache.org", "creation_time": "2005-10-06T22:13:24Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 36951, "attachment_id": null, "text": "Thanks for the follow-up fix, Reudiger!  That was the intended execution but I\nam too old and blind to see properly and too lazy to test for myself.\n\nThanks for the quick feedback, Rocky!\n\nNow committed to 2.2 branch and trunk.", "id": 80876, "time": "2005-10-06T23:05:00Z", "creator": "trawick@apache.org", "creation_time": "2005-10-06T23:05:00Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 36951, "is_private": false, "id": 135508, "creation_time": "2010-03-22T06:01:18Z", "time": "2010-03-22T06:01:18Z", "creator": "wrowe@apache.org", "text": "Reclassed to delete a version", "attachment_id": null}]