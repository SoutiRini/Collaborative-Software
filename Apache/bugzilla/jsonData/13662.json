[{"count": 0, "tags": [], "bug_id": 13662, "attachment_id": null, "text": "When doing an \"If-Modified-Since\" request against a static file \n(StaticInterceptor), in the case of a \"304 Not Modified\", the Content-Type \nheader is always supplied as \"text/html\". \n\nThis results in problems in our apache httpd 1.3.26 mod_proxy reverse proxy \ncache. mod_proxy updates the Content-Type field of the object with the new \ndata. E.g. a gif file will upon entering the cache have the correct \ntype \"image/gif\", but when anyone does an \"If-Modified-Since\" request and the \ncache asks tomcat if the content is up to date, the type gets overwritten \nwith \"text/html\" which was supplied by tomcat. This then results in images \nwith the wrong content type.\n\nAccording to W3C spec of 304 response header \n(http://www.w3.org/Protocols/HTTP/HTRESP.html):\n\"Response headers are as if the client had sent a HEAD request, but limited to \nonly those headers which make sense in this context. This means only headers \nthat are relevant to cache managers and which may have changed independently \nof the document's Last-Modified date. Examples include Date , Server and \nExpires . \"\n\nI suspect mod_proxy interprets this *very* broadly and updates most headers \nthat are sent over. Arguably changing the Content-Type does not make sense in \nthis context, and such both Apache httpd and Apache Tomcat should change the \nbehaviour.\n\nConsider the following:\n\n$ curl -I http://mytomcat:18000/images/bit.gif\nHTTP/1.0 200 OK\nContent-Type: image/gif\nContent-Length: 48\nLast-Modified: Thu, 03 Oct 2002 15:49:27 GMT\nDate: Tue, 15 Oct 2002 16:46:03 GMT\nServer: Tomcat Web Server/3.3.1 Final ( JSP 1.1; Servlet 2.2 )\n\n$ curl -I http://mytomcat:18000/images/bit.gif -H \"If-Modified-Since: Thu, 03 \nOct 2002 15:49:27 GMT\"\nHTTP/1.0 304 Not Modified\nContent-Type: text/html\nDate: Tue, 15 Oct 2002 16:46:22 GMT\nServer: Tomcat Web Server/3.3.1 Final ( JSP 1.1; Servlet 2.2 )\n\nThe second 'curl' shows the problem.\n\nA quick fix is not to send the Content-Type header on 304. I believe that \nwould also be more close to spec. Looking at the Tomcat code I've found that \nthe internal StatusHandler always sets \"text/html\". Here is a patch that makes \nthe StatusHandler only do that in case it isn't a 304:\n\n$ diff -u ErrorHandler.java-2002-10-15 ErrorHandler.java\n--- ErrorHandler.java-2002-10-15        Tue Mar 26 15:36:55 2002\n+++ ErrorHandler.java   Tue Oct 15 18:56:23 2002\n@@ -683,7 +683,6 @@\n        String msg=(String)req.getAttribute(\"javax.servlet.error.message\");\n        String errorURI = res.getErrorURI();\n\n-       res.setContentType(\"text/html\");\n        // res is reset !!!\n        // status is already set\n        int sc=res.getStatus();\n@@ -691,6 +690,11 @@\n        if( sc == 304 ) {\n            //NotModified must not return a body\n            return;\n+       } else {\n+         // don't set a content type if we are answering If-Modified-Since.\n+         // Proxy caches might update their cached content-type with this\n+         // info (mod_proxy does it). Martin Algesten 15th Oct, 2002.\n+         res.setContentType(\"text/html\");\n        }\n\n        if( sbNote==0 ) {", "id": 24568, "time": "2002-10-15T18:05:41Z", "creator": "puckman@taglab.com", "creation_time": "2002-10-15T18:05:41Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 13662, "text": "Patch applied.\n\nThanks Much!", "id": 24600, "time": "2002-10-16T06:05:18Z", "creator": "william.barker@wilshire.com", "creation_time": "2002-10-16T06:05:18Z", "is_private": false, "attachment_id": null}]