[{"count": 0, "tags": [], "bug_id": 44079, "text": "mod_proxy_http randomly returns a proxy error when the proxy request to the\nbackend server is non-SSL. The apache server is configured with both SSL and\nnon-SSL but the error randomly occurs no matter if the request is http or https.\nWith proxy configuration:\n\n        ProxyPass /bugs http://internal.server.com/bugs\n        ProxyPassReverse /bugs http://internal.server.com/bugs\n\n\nApache randomly returns 'Error reading from remote server':\n\n        [Thu Dec 13 15:40:47 2007] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //internal.server.com/bugs/heartbeat.asp\n        [Thu Dec 13 15:40:47 2007] [debug] proxy_util.c(1378): [client\n192.168.1.131] proxy: http: found worker http://internal.server.com/bugs for\nhttp://internal.server.com/bugs/heartbeat.asp\n        [Thu Dec 13 15:40:47 2007] [debug] mod_proxy.c(756): Running scheme http\nhandler (attempt 0)\n        [Thu Dec 13 15:40:47 2007] [debug] mod_proxy_ajp.c(493): proxy: AJP:\ndeclining URL http://internal.server.com/bugs/heartbeat.asp\n        [Thu Dec 13 15:40:47 2007] [debug] mod_proxy_http.c(1662): proxy: HTTP:\nserving URL http://internal.server.com/bugs/heartbeat.asp\n        [Thu Dec 13 15:40:47 2007] [debug] proxy_util.c(1798): proxy: HTTP: has\nacquired connection for (internal.server.com)\n        [Thu Dec 13 15:40:47 2007] [debug] proxy_util.c(1858): proxy: connecting\nhttp://internal.server.com/bugs/heartbeat.asp to internal.server.com:80\n        [Thu Dec 13 15:40:47 2007] [debug] proxy_util.c(1951): proxy: connected\n/bugs/heartbeat.asp to internal.server.com:80\n        [Thu Dec 13 15:40:47 2007] [debug] proxy_util.c(2141): proxy: HTTP:\nconnection complete to 192.168.1.131:80 (internal.server.com)\n        [Thu Dec 13 15:40:47 2007] [info] [client 192.168.1.131] (32)Broken\npipe: core_output_filter: writing data to the network\n        [Thu Dec 13 15:40:47 2007] [error] [client 192.168.1.131] proxy: error\nreading status line from remote server internal.server.com\n        [Thu Dec 13 15:40:47 2007] [error] [client 192.168.1.131] proxy: Error\nreading from remote server returned by /bugs/heartbeat.asp\n        [Thu Dec 13 15:40:47 2007] [debug] proxy_util.c(1816): proxy: HTTP: has\nreleased connection for (internal.server.com)\n\n\nMore often, the request is processed correctly:\n\n        [Thu Dec 13 15:40:32 2007] [debug] mod_proxy_http.c(54): proxy: HTTP:\ncanonicalising URL //internal.server.com/bugs/heartbeat.asp\n        [Thu Dec 13 15:40:32 2007] [debug] proxy_util.c(1378): [client\n192.168.1.131] proxy: http: found worker http://internal.server.com/bugs for\nhttp://internal.server.com/bugs/heartbeat.asp\n        [Thu Dec 13 15:40:32 2007] [debug] mod_proxy.c(756): Running scheme http\nhandler (attempt 0)\n        [Thu Dec 13 15:40:32 2007] [debug] mod_proxy_ajp.c(493): proxy: AJP:\ndeclining URL http://internal.server.com/bugs/heartbeat.asp\n        [Thu Dec 13 15:40:32 2007] [debug] mod_proxy_http.c(1662): proxy: HTTP:\nserving URL http://internal.server.com/bugs/heartbeat.asp\n        [Thu Dec 13 15:40:32 2007] [debug] proxy_util.c(1798): proxy: HTTP: has\nacquired connection for (internal.server.com)\n        [Thu Dec 13 15:40:32 2007] [debug] proxy_util.c(1858): proxy: connecting\nhttp://internal.server.com/bugs/heartbeat.asp to internal.server.com:80\n        [Thu Dec 13 15:40:32 2007] [debug] proxy_util.c(1951): proxy: connected\n/bugs/heartbeat.asp to internal.server.com:80\n        [Thu Dec 13 15:40:32 2007] [debug] proxy_util.c(2045): proxy: HTTP: fam\n2 socket created to connect to internal.server.com\n        [Thu Dec 13 15:40:32 2007] [debug] proxy_util.c(2141): proxy: HTTP:\nconnection complete to 192.168.1.131:80 (internal.server.com)\n        [Thu Dec 13 15:40:32 2007] [debug] mod_proxy_http.c(1448): proxy: start\nbody send\n        [Thu Dec 13 15:40:32 2007] [debug] mod_proxy_http.c(1537): proxy: end\nbody send\n        [Thu Dec 13 15:40:32 2007] [debug] proxy_util.c(1816): proxy: HTTP: has\nreleased connection for (internal.server.com)\n\n\nIt's interesting to note that when the error occurs, there's no socket created.\nWhen the connection to the backend server is SSL:\n\n        ProxyPass /bugs https://internal.server.com/bugs\n        ProxyPassReverse /bugs https://internal.server.com/bugs\n\n\neverything works correctly 100% of the time. From what I know, mod_proxy cannot\nhandle persistent SSL backend connections. Is it possible that the non-SSL\nbackend connections are persistent and that's causing all this? I've tried quite\na few things, including  'SetEnv force-proxy-request-1.0 1 SetEnv\nproxy-nokeepalive 1' without luck. Apache 1.x didn't had this issue.", "id": 111811, "time": "2007-12-14T08:52:31Z", "creator": "todorz@phantomfiber.com", "creation_time": "2007-12-14T08:52:31Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "text": "Whilst this is a long-standing issue, your report is useful as it tends to\nsupport Rudiger's diagnosis of what causes it.  Thank you.\n\n*** This bug has been marked as a duplicate of 37770 ***", "attachment_id": null, "id": 111813, "creator": "nick@webthing.com", "time": "2007-12-14T12:29:41Z", "bug_id": 44079, "creation_time": "2007-12-14T12:29:41Z", "is_private": false}, {"count": 2, "tags": [], "text": "(In reply to comment #0)\n\n> \n> everything works correctly 100% of the time. From what I know, mod_proxy cannot\n> handle persistent SSL backend connections. Is it possible that the non-SSL\n> backend connections are persistent and that's causing all this? I've tried \n\nYes, this is exactly the reason. SSL backend connections are not persistent\nwhereas non-SSL connections are.\n\n\n> quite a few things, including  'SetEnv force-proxy-request-1.0 1 SetEnv\n> proxy-nokeepalive 1' without luck. Apache 1.x didn't had this issue.\n\nproxy-nokeepalive 1 should really help as it ensures that the backend connection\ngets closed like in the SSL case. I assume you placed\n\nSetEnv proxy-nokeepalive 1\n\nin the wrong place of your config. Where did you place it?\n\n", "attachment_id": null, "id": 111817, "creator": "rpluem@apache.org", "time": "2007-12-14T14:10:23Z", "bug_id": 44079, "creation_time": "2007-12-14T14:10:23Z", "is_private": false}]