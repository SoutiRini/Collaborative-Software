[{"count": 0, "tags": [], "bug_id": 58856, "is_private": false, "text": "Created attachment 33441\nFix regression of AddOutputFilterByType using wrong filter type\n\nAs reported also per mail:\nhttp://mail-archives.apache.org/mod_mbox/httpd-dev/201601.mbox/%3C64eebd8fd16ad6b8a4a187b5d349f169%40mail.lenk.info%3E\n\nPROBLEM DESCRIPTION\n\nI observed that the behavior of this directive changed in Apache 2.4 for \nfilters. Starting with Apache 2.4 filters are inserted at an earlier \nplace in the filter chain than they were inserted with Apache 2.2. For \nexample, if you use the directive\n\n     AddOutputFilterByType DEFLATE text/html\n\nThe filter is inserted with AP_FTYPE_RESOURCE, even though it was \nregistered in mod_deflate.c as AP_FTYPE_SET_CONTENT.\nThe effect is that using \"AddOutputFilterByType DEFLATE text/html\" the \nresulting filter chain is ordered diferrently compared to using \n\"SetOutputFilter DEFLATE\".\n\nThis can be fixed in configuration by adding the following directive \nright after AddOutputFilterByType:\n\n     FilterDeclare BYTYPE:DEFLATE CONTENT_SET\n\nUnfortunately the order and placement of FilterDeclare seems to be \nrelevant, i.e. this fix only works if FilterDeclare comes *after* \nAddOutputFilterByType within the same container.\n\nI wonder whether this is an intentional behavior change of \nAddOutputFilterByType or not.\n\nANALYSIS\n\nApparently the filter type (ap_filter_rec_t struct member ftype) of the \nfilter provider isn't respected anymore.\n\nThe intended filter type is provided when registering the output filter \nby calling ap_register_output_filter(). In branch 2.2.x this was \nsufficient, because the conditional filter (based on the MIME type) was \nadded directly by name (i.e. by calling ap_add_output_filter() in \nap_add_output_filters_by_type). In branches 2.4.x and trunk the \nimplementation of AddOutputFilterByType apparently moved to mod_filter \nand a layer of indirection (the filter harness) is introduced. But the \nfilter harness is apparently created unconditionally with \nAP_FTYPE_RESOURCE.\n\nFIX APPROACH\n\nWhen implicitly creating a filter harness by calling the function \nadd_filter(), we have access to the provider's ap_filter_rec_t anyways. \nSo I recommend to just copy it from the filter provider (e.g. DEFLATE) \nto the filter harness (e.g. BYTYPE:DEFLATE).\n\nI've tested this approach with the attached patch for a setup without any \nFilterDeclare directive, and it fixed the regression; the DEFLATE filter \nwas ordered correctly at AP_FTYPE_CONTENT_SET again.", "id": 187654, "time": "2016-01-14T08:37:11Z", "creator": "micha@lenk.info", "creation_time": "2016-01-14T08:37:11Z", "attachment_id": 33441}, {"count": 1, "tags": [], "bug_id": 58856, "is_private": false, "text": "Applied this patch to trunk r1726705 - thanks.", "id": 187965, "time": "2016-01-25T22:33:31Z", "creator": "nick@webthing.com", "creation_time": "2016-01-25T22:33:31Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 58856, "attachment_id": null, "text": "Great, thanks for accepting the patch in Trunk.\n\nWhat is needed to get the fix backported to 2.4.x?", "id": 187967, "time": "2016-01-26T07:50:30Z", "creator": "micha@lenk.info", "creation_time": "2016-01-26T07:50:30Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 58856, "is_private": false, "text": "Fixed in r1781433 for 2.4.x.", "id": 196672, "time": "2017-02-02T17:16:30Z", "creator": "jorton@redhat.com", "creation_time": "2017-02-02T17:16:30Z", "attachment_id": null}]