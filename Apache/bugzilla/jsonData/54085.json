[{"count": 0, "tags": [], "bug_id": 54085, "is_private": false, "text": "Java-based server using Tomcat Native sometimes falls into a busy loop consuming 100% CPU.\nThe native stack trace of the problem:\n\nThread 58 (Thread 1249868096 (LWP 29778)):\n#0  0x00007fdf3ca93e6b in __read_nocancel () from /lib64/libpthread.so.0\n#1  0x00007fdf2205f092 in sock_read (b=0x7fdec7bc58a0, out=0x7fdeb0b31448, outl=3869) at /usr/include/bits/unistd.h:35\n#2  0x00007fdf2205d56f in BIO_read (b=0x7fdec7bc58a0, out=0x7fdeb0b31448, outl=3869) at bio_lib.c:212\n#3  0x00007fdf2234795b in ssl3_read_n (s=0x7fdec5a51340, n=6624, max=6624, extend=<value optimized out>) at s3_pkt.c:199\n#4  0x00007fdf22347efe in ssl3_read_bytes (s=0x7fdec5a51340, type=23, buf=0x7fdeb9a70000, len=4096, peek=0) at s3_pkt.c:324\n#5  0x00007fdf223458c8 in ssl3_read (s=0x7fdec5a51340, buf=0x7fdeb9a70000, len=4096) at s3_lib.c:2574\n#6  0x00007fdf2258c36e in ssl_socket_recv (sock=0x7fdeb9b2c8b0, buf=0x7fdeb9a70000, len=0x4a7f6a38) at src/sslnetwork.c:397\n#7  0x00007fdf2258aa10 in Java_org_apache_tomcat_jni_Socket_recvbt (e=<value optimized out>, o=<value optimized out>, sock=140594574968408, buf=<value optimized out>, offset=0, len=<value optimized out>, timeout=1000) at src/network.c:972\n\nThe infinite loop appears to be in ssl_socket_recv() with the following scenario:\n1. SSL_read() at line 397 returns -1;\n2. apr_get_netos_error() at line 398 returns EAGAIN;\n3. SSL_get_error() at line 402 returns SSL_ERROR_SSL.\n\nThe socket is in O_NONBLOCK mode. SSL handshake has passed.\n\nHere is the patch that helped me to overcome the problem:\n\n*** sslnetwork.c\n--- sslnetwork-patched.c\n***************\n*** 420,429 ****\n                  break;\n                  case SSL_ERROR_SYSCALL:\n                  case SSL_ERROR_SSL:\n!                     if (!APR_STATUS_IS_EAGAIN(os) &&\n!                         !APR_STATUS_IS_EINTR(os)) {\n                          con->shutdown_type = SSL_SHUTDOWN_TYPE_UNCLEAN;\n!                         return os == APR_SUCCESS ? APR_EGENERAL : os;\n                      }\n                  break;\n                  default:\n--- 420,428 ----\n                  break;\n                  case SSL_ERROR_SYSCALL:\n                  case SSL_ERROR_SSL:\n!                     if (!APR_STATUS_IS_EINTR(os)) {\n                          con->shutdown_type = SSL_SHUTDOWN_TYPE_UNCLEAN;\n!                         return os == APR_SUCCESS || APR_STATUS_IS_EAGAIN(os) ? APR_EGENERAL : os;\n                      }\n                  break;\n                  default:", "id": 163111, "time": "2012-11-01T12:47:47Z", "creator": "andrei@art.su", "creation_time": "2012-11-01T12:47:47Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 54085, "is_private": false, "text": "Possibly fixed by http://svn.apache.org/viewvc?view=revision&revision=1490001", "id": 169736, "time": "2013-08-27T14:08:22Z", "creator": "chris@christopherschultz.net", "creation_time": "2013-08-27T14:08:22Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 54085, "is_private": false, "text": "*** Bug 53847 has been marked as a duplicate of this bug. ***", "id": 186178, "time": "2015-11-02T11:07:23Z", "creator": "markt@apache.org", "creation_time": "2015-11-02T11:07:23Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "markt@apache.org", "text": "This was fixed in r1409681 (1.1.25 onwards) and r1712437 (1.2.2 onwards).", "id": 196604, "attachment_id": null, "bug_id": 54085, "creation_time": "2017-01-31T13:39:36Z", "time": "2017-01-31T13:39:36Z", "is_private": false}]