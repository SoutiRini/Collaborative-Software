[{"count": 0, "tags": [], "creator": "b.mason@adinstruments.com", "is_private": false, "text": "Created attachment 29093\nStandalone test app which reproduces the issue\n\nWe have an application which uses the forms authentication provided by Servlet specification and is configured store session IDs in the URL rather than using cookies. This configuration has been working as expected under Tomcat 6.0.32 and earlier.\n\nOn upgrading to Tomcat 6.0.33 or 6.0.35 this combination no longer works as expected. Specifically, when a user initially submits the login form they are immediately returned back to the form-login-page. Submitting the login form a second time allows them to log in. The only difference I have been able to spot between the first and second form submission is for the second submission the request attribute \"javax.servlet.forward.request_uri\" now has the jsessionid appended to the URL.\n\nAttached is a standalone WAR which reliably reproduces the problem with 6.0.33 and 6.0.35. Steps to reproduce:\n\n1) Unpack tomcat 6.0.33. I used windows version \"apache-tomcat-6.0.33-windows-x86.zip\".\n2) Drop forms-auth-test.war into the webapps directory.\n3) Disable cookies by editing conf/context.xml:\n<Context cookies=\"false\">\n    ....\n</Context>\n\n4) Add a user to authenticated with to conf/tomcat-users.xml:\n<tomcat-users>\n  <role rolename=\"tomcat\"/>\n  <user username=\"tomcat\" password=\"tomcat\" roles=\"tomcat\"/>\n</tomcat-users>\n\n5) Launch tomcat, I used \"bin/catalina.bat start\".\n6) Navigate to http://localhost:8080/forms-auth-test/index.jsp\n7) Enter user:tomcat pass:tomcat (should be prefilled). Click login.\n8) Observe that you are returned to the login page (with a session ID in the URL this time).\n9) Enter the username and password again and click login.\n10) Login should succeed this time.\n\n\nEnvironment details:\n- Windows 7 64-bit, Oracle JVM 1.6.0u32 & 1.7.0u4.\n- Debian 5 32-bit, Oracle JVM 1.6.0u32.\n\nRelevant tomcat-user mailing list thread: http://tomcat.markmail.org/thread/kywykrrjvwuavndp", "id": 160800, "time": "2012-07-22T23:28:24Z", "bug_id": 53584, "creation_time": "2012-07-22T23:28:24Z", "attachment_id": 29093}, {"count": 1, "tags": [], "bug_id": 53584, "attachment_id": null, "id": 161160, "time": "2012-08-07T21:33:38Z", "creator": "markt@apache.org", "creation_time": "2012-08-07T21:33:38Z", "is_private": false, "text": "Thanks for an excellent bug report. The issue was a real pleasure to investigate - not just because the root cause was interesting but because I could focus on the interesting bits rather than having to waste time trying to build the test WAR using the current flavour of the month for scm and/or build tool and/or source layout. Simple WARs are *SO* much easier to work with.\n\nThe clear steps to re-create the issue were also extremely helpful. So again, thank-you.\n\nThe root cause is that as of 6.0.33 path parameters are included the value returned from HttpServletRequest.getRequestURI(). During the FORM auth, one of the checks post authentication is \"Does the current URI equal the original URI?\" The problem is that the current URI always contains the session ID as a path parameter whereas the first time through the authentication the original URI does not.\n\nThis issue also affects trunk and 7.0.x.\n\nI have fixed this issue in trunk and 7.0.x for 7.0.30 onwards and proposed the fix for 6.0.x."}, {"count": 2, "tags": [], "bug_id": 53584, "attachment_id": null, "id": 161213, "time": "2012-08-09T21:29:51Z", "creator": "b.mason@adinstruments.com", "creation_time": "2012-08-09T21:29:51Z", "is_private": false, "text": "(In reply to comment #1)\n\nThanks Mark. Glad my steps made the bug easy to reproduce. I'm a software developer myself so tried to add everything I would want in a bug report."}, {"count": 3, "tags": [], "text": "Fixed in 6.0.x and will be included in 6.0.36 onwards.", "attachment_id": null, "id": 161749, "creator": "markt@apache.org", "time": "2012-08-27T21:29:55Z", "bug_id": 53584, "creation_time": "2012-08-27T21:29:55Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 53584, "attachment_id": null, "id": 164396, "time": "2013-01-04T22:16:29Z", "creator": "markt@apache.org", "creation_time": "2013-01-04T22:16:29Z", "is_private": false, "text": "*** Bug 54340 has been marked as a duplicate of this bug. ***"}]