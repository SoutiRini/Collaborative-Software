[{"count": 0, "tags": [], "bug_id": 49884, "attachment_id": null, "text": "Hi, I'm running Tomcat trunk (revision 992708, 2010-09-03) and I'm hitting an async servlet (see attached) with Apache Bench, and every once in a while I see a NullPointerException in org.apache.catalina.core.AsyncContextImpl.doInternalComplete:\n\nSep 4, 2010 8:09:39 PM org.apache.catalina.core.AsyncContextImpl doInternalDispatch\nFINE: TIMING OUT!\nSep 4, 2010 8:09:40 PM org.apache.catalina.core.AsyncContextImpl doInternalDispatch\nFINE: TIMING OUT!\nSep 4, 2010 8:09:40 PM org.apache.catalina.core.AsyncContextImpl doInternalComplete\nSEVERE: \nThrowable occurred: java.lang.NullPointerException\n\tat org.apache.catalina.core.AsyncContextImpl.doInternalComplete(AsyncContextImpl.java:384)\n\tat org.apache.catalina.core.AsyncContextImpl.doInternalDispatch(AsyncContextImpl.java:327)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:238)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:201)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:163)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:108)\n\tat org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:557)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)\n\tat org.apache.catalina.connector.CoyoteAdapter.asyncDispatch(CoyoteAdapter.java:301)\n\tat org.apache.coyote.http11.Http11Processor.asyncDispatch(Http11Processor.java:333)\n\tat org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:258)\n\tat org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:257)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:898)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:920)\n\tat java.lang.Thread.run(Thread.java:736)", "id": 139700, "time": "2010-09-04T23:16:09Z", "creator": "kevin@infofinity.com", "creation_time": "2010-09-04T23:16:09Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 49884, "attachment_id": 25989, "id": 139701, "time": "2010-09-04T23:24:22Z", "creator": "kevin@infofinity.com", "creation_time": "2010-09-04T23:24:22Z", "is_private": false, "text": "Created attachment 25989\nServlet used to reproduce the problem"}, {"count": 2, "tags": [], "bug_id": 49884, "attachment_id": null, "id": 139706, "creation_time": "2010-09-05T17:10:09Z", "time": "2010-09-05T17:10:09Z", "creator": "markt@apache.org", "text": "The state changes in AsyncContextImpl aren't atomic so I think what you are seeing is the result of multiple parallel calls to doInternalComplete(). Am I correct in thinking this error is fairly rare?", "is_private": false}, {"count": 3, "tags": [], "creator": "kevin@infofinity.com", "attachment_id": null, "id": 139707, "creation_time": "2010-09-05T17:42:02Z", "time": "2010-09-05T17:42:02Z", "bug_id": 49884, "text": "(In reply to comment #2)\n> The state changes in AsyncContextImpl aren't atomic so I think what you are\n> seeing is the result of multiple parallel calls to doInternalComplete(). Am I\n> correct in thinking this error is fairly rare?\n\nYes, it is rare. The reason I reported this is that I'm load testing this servlet (well, my real servlet, but this one just to repro the problem), and every once in a while I get a 200 or 500 response that takes over 10 seconds whereas the average is half a second (using AccessLogValve %D to see this). I ran with tracing and noticed this NPE and thought maybe it's somehow related to the sporadic long request, but I don't know if it's root cause. Also, it is preceded by the \"TIMING OUT!\" entry, so maybe this NPE is just a side effect of the timeout?", "is_private": false}, {"count": 4, "tags": [], "creator": "markt@apache.org", "text": "I've been able to spend some time looking at this. It is very easy to reproduce on a multi-core machine with relatively low numbers of requests and concurrency.\n\nThere is definitely a threading issue at the heart of this. I need to dig deeper to find out exactly what the root cause is.", "id": 139731, "time": "2010-09-07T09:03:57Z", "bug_id": 49884, "creation_time": "2010-09-07T09:03:57Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "creator": "kevin@infofinity.com", "text": "(In reply to comment #4)\n> I've been able to spend some time looking at this. It is very easy to reproduce\n> on a multi-core machine with relatively low numbers of requests and\n> concurrency.\n> \n> There is definitely a threading issue at the heart of this. I need to dig\n> deeper to find out exactly what the root cause is.\n\nThanks Mark.", "id": 139738, "time": "2010-09-07T10:46:43Z", "bug_id": 49884, "creation_time": "2010-09-07T10:46:43Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 49884, "attachment_id": 26022, "id": 139850, "time": "2010-09-13T12:13:42Z", "creator": "sebb@apache.org", "creation_time": "2010-09-13T12:13:42Z", "is_private": false, "text": "Created attachment 26022\nPatch to make some private fields final\n\nThey are probably not a cause of the synch. issues, but it would not harm to make these fields final."}, {"count": 7, "tags": [], "bug_id": 49884, "attachment_id": null, "text": "This has been fixed in trunk and will be included in 7.0.3. Thanks for uncovering this. It highlighted a bunch of issues with the async implementation that are hopefully now fixed.", "id": 140209, "time": "2010-09-27T08:14:41Z", "creator": "markt@apache.org", "creation_time": "2010-09-27T08:14:41Z", "is_private": false}]