[{"count": 0, "tags": [], "text": "Created attachment 27041\nScreen shots of one of crash dumps in Visual Studio 2010 debugger\n\nThis happens in our production environment almost every day.  It causes the Apache httpd.exe process to crash and restart itself.\n\nThe error shows up in the Windows event log as:\nFaulting application httpd.exe, version 2.2.17.0, faulting module msvcrt.dll, version 7.0.3790.3959, fault address 0x00038bab.\n\nWe have not been able to reproduce it with tests, but we do have several crash dumps that can be used to debug.  \n\nThe fault is always in exactly the same spot in the mod_jk code.  I opened one of the crash dumps in Visual Studio 2010 and tried to find the problem.  I found that the code is going out of bounds of an array in get_sessionid() in jk_lb_worker.c because the num_headers in jk_ws_service_t that gets passed in ot the get_sessionid method is bigger than the actual number of headers in header_names and header_values.  See ApacheCrash_2.png in the attached zip file.  I don't know how it got this way though...\n\nI can provide crash dumps to someone who can look into this.  We get new ones regularly.\n\nConfiguration:\n2 load balanced web servers running httpd 2.2.17 mod_jk 1.2.28 on Windows Server 2003\n6 JBOSS 4.2 workers running ATG 9.0 application using mod_jk loadbalancer", "is_private": false, "id": 146480, "creator": "pierre.boudreau@t4g.com", "time": "2011-05-20T18:05:04Z", "bug_id": 51235, "creation_time": "2011-05-20T18:05:04Z", "attachment_id": 27041}, {"count": 1, "text": "1.2.28 is old, and there have been a few bug fixes that could have touched this.\n\nCan you reproduce with 1.2.31?", "creator": "wrowe@apache.org", "is_private": false, "id": 146482, "time": "2011-05-20T18:21:53Z", "bug_id": 51235, "creation_time": "2011-05-20T18:21:53Z", "tags": [], "attachment_id": null}, {"count": 2, "text": "I have not tried reproducing it with 1.2.31, but I have looked through the changelog and compared the code between the two versions and didn't see anything that looked like it addressed this.  Only a couple lines of code have changed in jk_lb_worker.c where the fault happens and they are not near the location of the fault...  Of course, the root cause could be somewhere else...  \n\nConsidering that this only happens in our production environment, I have been reluctant to upgrade without some indication that there is a good chance that it will resolve the problem.  Do some particular bug fixes come to mind that could have indirectly fixed this?", "creator": "pierre.boudreau@t4g.com", "is_private": false, "id": 146483, "time": "2011-05-20T18:34:16Z", "bug_id": 51235, "creation_time": "2011-05-20T18:34:16Z", "tags": [], "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 51235, "attachment_id": null, "id": 146489, "time": "2011-05-20T19:23:19Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2011-05-20T19:23:19Z", "is_private": false, "text": "If you really can not upgrade: could you tell us, what the header names and values are? The screenshot looks like the num_headers is 10, but it doesn't give us any info about how many headers are in the arrays and what the names and values are. If you could provide a list of names and values, we might be able to guess the root cause.\n\nRegards,\n\nRainer"}, {"count": 4, "tags": [], "text": "At first I thought there was only one header, which was showing in the watch window in one of the screen shots, but now I see there is the correct amount of header names and values.  Below are header names and values for the crash dump I am looking at now.  The fault happens while parsing the Cookies values for JSESSIONID.  Anything unusual with that Cookie string?  The spaces after the ; maybe?  Are those supposed to be there?\n\ns->headers_names[0]\t0x66452f08 \"Host\"\ns->headers_values[0]\t0x66452f10 \"www.superstore.ca\"\ns->headers_names[1]\t0x66452f28 \"Accept-Encoding\"\ns->headers_values[1]\t0x66452f38 \"gzip\"\ns->headers_names[2]\t0x66452f40 \"Referer\"\ns->headers_values[2]\t0x66452f48 \"http://www.superstore.ca/LCLOnline/home.jsp?_requestid=18620\"\ns->headers_names[3]\t0x66452f88 \"Accept-Language\"\ns->headers_values[3]\t0x66452f98 \"en-US\"\ns->headers_names[4]\t0x66452fa0 \"x-wap-profile\"\ns->headers_values[4]\t0x66452fb0 \"http://wap.sonyericsson.com/UAprof/X10aR201.xml\"\ns->headers_names[5]\t0x66452fe0 \"User-Agent\"\ns->headers_values[5]\t0x66452ff0 \"Mozilla/5.0 (Linux; U; Android 2.1-update1; en-us; SonyEricssonX10a Build/2.0.A.0.504) AppleWebKit/530.17 (KHTML, like Gecko) Version/4.0 Mobile Safari/530.17\"\ns->headers_names[6]\t0x66453090 \"Cookie\"\ns->headers_values[6]\t0x66453098 \"lclLastVsitedUserStore=203; ATG_SESSION_ID=MXBsllpe5HEZQUMWUFUtog**.node3; JSESSIONID=MXBsllpe5HEZQUMWUFUtog**.node3\"\ns->headers_names[7]\t0x134ea6a8 \"Accept\"\ns->headers_values[7]\t0x134ea6b0 \"text/xml, text/html, application/xhtml+xml, image/png, text/plain, */*;q=0.8\"\ns->headers_names[8]\t0x134ea700 \"Accept-Charset\"\ns->headers_values[8]\t0x134ea710 \"utf-8, iso-8859-1, utf-16, *;q=0.7\"\ns->headers_names[9]\t0x6a6e7a80 \"content-length\"\ns->headers_values[9]\t0x6a6e7488 \"0\"", "is_private": false, "id": 146505, "creator": "pierre.boudreau@t4g.com", "time": "2011-05-20T22:22:30Z", "bug_id": 51235, "creation_time": "2011-05-20T22:22:30Z", "attachment_id": null}, {"count": 5, "text": "I constructed a request with all the same headers with Firefox and the Poster add-on and send it to our dev server.  It returned without crashing the httpd, so it looks like there's something more to it...\n\nI'll look at some other crash dumps to see if there is some kind of recurring pattern in the requests.  This one was requesting an image, which returned fine when I sent the same request to our dev server.", "creator": "pierre.boudreau@t4g.com", "is_private": false, "id": 146506, "time": "2011-05-20T22:55:00Z", "bug_id": 51235, "creation_time": "2011-05-20T22:55:00Z", "tags": [], "attachment_id": null}, {"count": 6, "tags": [], "text": "Here's another one.  A common thing that jumps out to me is that the User-Agent shows that both requests are coming from devices running Android 2.1-update1.  I'm guessing that's not a coincidence.\n\ns->headers_names[3]\t0x78074330 \"Accept-Language\"\ns->headers_values[3]\t0x78074340 \"en-CA, en-US\"\ns->headers_names[4]\t0x78074350 \"x-wap-profile\"\ns->headers_values[4]\t0x78074360 \"http://wap.samsungmobile.com/uaprof/SGH-I896.xml\"\ns->headers_names[5]\t0x78074398 \"User-Agent\"\ns->headers_values[5]\t0x780743a8 \"Mozilla/5.0 (Linux; U; Android 2.1-update1; en-ca; SAMSUNG-SGH-I896 Build/ECLAIR) AppleWebKit/530.17 (KHTML, like Gecko) Version/4.0 Mobile Safari/530.17\"\ns->headers_names[6]\t0x78074448 \"Cookie\"\ns->headers_values[6]\t0x78074450 \"lclLastVsitedUserStore=200004; ATG_SESSION_ID=uYF2WRWqtZMu65os-uonsA**.node24; JSESSIONID=uYF2WRWqtZMu65os-uonsA**.node24\"\ns->headers_names[7]\t0x10eadd60 \"Accept\"\ns->headers_values[7]\t0x10eadd68 \"text/xml, text/html, application/xhtml+xml, image/png, text/plain, */*;q=0.8\"", "is_private": false, "id": 146507, "creator": "pierre.boudreau@t4g.com", "time": "2011-05-21T00:53:28Z", "bug_id": 51235, "creation_time": "2011-05-21T00:53:28Z", "attachment_id": null}, {"count": 7, "tags": [], "text": "Can you compile the module yourself?\n\nIf yes, it would be helpful if you could test the following patch:\n\nIndex: jk/native/common/jk_lb_worker.c\n===================================================================\n--- jk/native/common/jk_lb_worker.c     (revision 1125686)\n+++ jk/native/common/jk_lb_worker.c     (working copy)\n@@ -470,6 +470,9 @@\n                             strcat(result, \";\");\n                             strncat(result, id_start, sz);\n                         }\n+                        if (!*id_end) {\n+                            break;\n+                        }\n                         id_start = id_end;\n                     }\n                 }\n\nThe line numbers are for mod_jk 1.2.28, but the same patch applies to newer versions with some offset.\n\nRegards,\n\nRainer", "is_private": false, "id": 146516, "creator": "rainer.jung@kippdata.de", "time": "2011-05-21T12:47:12Z", "bug_id": 51235, "creation_time": "2011-05-21T12:47:12Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 51235, "text": "Hi Rainer,\n\nWere you able to reproduce the fault in a unit test with the cookies strings I provided?\n\nI tried unit testing the suggested fix with a few of the cookies strings that I got from crash dumps and it didn't crash in the unit test, with or without the fix, so it's inconclusive.\n\nThe version I compiled is using a newer CRT, which makes me wonder if the problem only happens with specific cookies string and the specific version of msvcrt.dll (7.0.3790.3959)...  but then we have that same version of msvcrt.dll in our test environments and haven't seen the crash there.\n\nI have compiled the module with the suggested fix and installed it in our test environments.  We won't know if it fixes the issue until it has been in our production environment for a few days.  The crashes only happen in production 2-3 times / week.\n\nPierre", "count": 8, "id": 146791, "time": "2011-06-01T13:17:41Z", "creator": "pierre.boudreau@t4g.com", "creation_time": "2011-06-01T13:17:41Z", "is_private": false}, {"count": 9, "tags": [], "text": "Hi Pierre,\n\ndo you have any update on this? Did the patch work?", "attachment_id": null, "id": 150861, "creator": "rainer.jung@kippdata.de", "time": "2011-10-23T20:27:06Z", "bug_id": 51235, "creation_time": "2011-10-23T20:27:06Z", "is_private": false}, {"count": 10, "text": "Sorry Rainer for the delay in getting back to you on this.  The bad news is that the patch did not work.  But the good news is that we upgraded to the versions of Apache and mod_JK below and have not seen the error since.  It's been a bit over a month now and the problem was happening once every 2-3 days.  Not sure if the fix was in Apache, mod_jk or in one of the Windows patches that we installed at the same time... but all is good now.  This issue can be closed.\n\nServer Version: Apache/2.2.21 (Win32) mod_ssl/2.2.21 OpenSSL/0.9.8r mod_jk/1.2.28 \n\n\n(In reply to comment #9)\n> Hi Pierre,\n> \n> do you have any update on this? Did the patch work?", "creator": "pierre.boudreau@t4g.com", "is_private": false, "id": 153363, "time": "2012-02-02T11:58:41Z", "bug_id": 51235, "creation_time": "2012-02-02T11:58:41Z", "tags": [], "attachment_id": null}, {"count": 11, "tags": [], "creator": "pierre.boudreau@t4g.com", "is_private": false, "text": "\nActually, now that I look at it, we did not upgrade mod_jk.  We are still running 1.2.28 which is the same version we had when I submitted this issue.  The fix must have been in Apache between 2.2.17 and 2.2.21.\n\n(In reply to comment #10)\n> Sorry Rainer for the delay in getting back to you on this.  The bad news is\n> that the patch did not work.  But the good news is that we upgraded to the\n> versions of Apache and mod_JK below and have not seen the error since.  It's\n> been a bit over a month now and the problem was happening once every 2-3 days. \n> Not sure if the fix was in Apache, mod_jk or in one of the Windows patches that\n> we installed at the same time... but all is good now.  This issue can be\n> closed.\n> \n> Server Version: Apache/2.2.21 (Win32) mod_ssl/2.2.21 OpenSSL/0.9.8r\n> mod_jk/1.2.28 \n> \n> \n> (In reply to comment #9)\n> > Hi Pierre,\n> > \n> > do you have any update on this? Did the patch work?", "id": 153364, "time": "2012-02-02T12:02:47Z", "bug_id": 51235, "creation_time": "2012-02-02T12:02:47Z", "attachment_id": null}, {"count": 12, "tags": [], "creator": "rainer.jung@kippdata.de", "is_private": false, "id": 153383, "creation_time": "2012-02-02T21:06:52Z", "time": "2012-02-02T21:06:52Z", "bug_id": 51235, "text": "Thanks for the update. Will close the issue then.", "attachment_id": null}]