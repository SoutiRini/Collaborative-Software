[{"count": 0, "attachment_id": null, "bug_id": 57229, "is_private": false, "id": 179160, "time": "2014-11-17T11:45:39Z", "creator": "ok@exklusiv.de", "creation_time": "2014-11-17T11:45:39Z", "tags": [], "text": "When mod_sed is used to replace strings in a document that has long lines (i.e. some Kilobytes), it dies on the first long line that matches and terminates transmission of the rest of the document.\n\nThis is reproducable.\nHow: Make a skript that produces output in a single line and matches. Increase length of line and see when mod_said begins to fail.\n\nBug is present in apache http 2.4.10 and apache http trunk. \n\nHere is the rundown:\n\nmod1.c has\n#define INIT_BUF_SIZE 1024\n\nIf a filtered document has a longer line, buffer gets grown.\nBut as soon as buffer is grown, mod_sed fails afterwards.\n\nPartial Workaround (compiletime only):\nincrease\n#define INIT_BUF_SIZE 1024\nto a larger value that is safe for all lines in all documents you will process.\n#define INIT_BUF_SIZE 16384\n\nImpact:\nmod_sed breaks reliable document delivery.\n\nRisks:\nDenial of Service\nExploits?\n\nMaintainer:\nPlease urgently check and fix this mod_sed bug.\n\nMy consideration:\nIt seems to be a buffer problem.\nmod_sed very likely works on user submitted content.\nFrom the code I see mod_sed uses a lot of pointers involved with the buffers.\nThere might be a high risk for buffer overrun/underrun or remote code executions.\n\nRegards,\nOliver"}, {"count": 1, "tags": [], "creator": "jkaluza@redhat.com", "text": "I'm not able to reproduce it in quick test. Could you attach some minimal configuration which reproduces this issue?", "id": 179269, "time": "2014-11-25T12:21:16Z", "bug_id": 57229, "creation_time": "2014-11-25T12:21:16Z", "is_private": false, "attachment_id": null}, {"count": 2, "attachment_id": null, "bug_id": 57229, "is_private": false, "id": 179403, "time": "2014-12-01T13:01:22Z", "creator": "ok@exklusiv.de", "creation_time": "2014-12-01T13:01:22Z", "tags": [], "text": "Bug has been reproduced and confirmed by jkaluza @ redhat . com."}, {"count": 3, "tags": [], "text": "Hi,\n\ncould you provide a way to easily reproduce the issue?\n\n\nOne fix has been applied recently to 2.4.x branch (r1748706) and another one will be proposed for backport in the coming hours. (r1749401)\nIt is really unlikely that one of these fixes is related to your problem.\n\nBut, while at it, if we could investigate on the issue you have reported, it would be fine.", "is_private": false, "id": 191882, "creator": "christophe.jaillet@wanadoo.fr", "time": "2016-06-22T12:28:07Z", "bug_id": 57229, "creation_time": "2016-06-22T12:28:07Z", "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 57229, "attachment_id": null, "text": "Way to reproduce, sent by Kaufmann, Oliver:\n\n\n\n1)\nsample php code to reliably trigger the problem:\n\n<?php\nprint \"first line with newline (all good)<br>\\n\";\n$myline=\"https://www.asl.com<br>\";\n$myline2=\"https://ge-dev.itools.de.cse.comfin.ge.com\";\n$mylength=strlen($myline);\n$mylength2=strlen($myline2);\n$mynum=178;\n$bytes=$mynum*$mylength;\n$bytes2=$mynum*$mylength2;\nprint \"now printing one single matching line with $mynum*$mylength=$bytes bytes expanding to $bytes2 bytes:<br>\\n\";\nfor ($i=0; $i < $mynum; $i++)\n{\n                print \"$myline\";\n}\nprint \"\\nThis is a test line. If you see it, all is good. Else mod_sed crashed.<br>\\n\"; \n?>\n\n\n\n2)\nApache config snipplet:\n\n\u2026\nLoadModule authn_file_module modules/mod_authn_file.so\nLoadModule authn_core_module modules/mod_authn_core.so\nLoadModule authz_host_module modules/mod_authz_host.so\nLoadModule authz_groupfile_module modules/mod_authz_groupfile.so\nLoadModule authz_user_module modules/mod_authz_user.so\nLoadModule authz_core_module modules/mod_authz_core.so\nLoadModule access_compat_module modules/mod_access_compat.so\nLoadModule auth_basic_module modules/mod_auth_basic.so\nLoadModule reqtimeout_module modules/mod_reqtimeout.so\nLoadModule filter_module modules/mod_filter.so\nLoadModule sed_module modules/mod_sed.so\nLoadModule mime_module modules/mod_mime.so\nLoadModule log_config_module modules/mod_log_config.so\nLoadModule env_module modules/mod_env.so\nLoadModule headers_module modules/mod_headers.so\nLoadModule setenvif_module modules/mod_setenvif.so\nLoadModule version_module modules/mod_version.so\nLoadModule proxy_module modules/mod_proxy.so\nLoadModule proxy_ajp_module modules/mod_proxy_ajp.so\nLoadModule unixd_module modules/mod_unixd.so\nLoadModule status_module modules/mod_status.so\nLoadModule autoindex_module modules/mod_autoindex.so\nLoadModule info_module modules/mod_info.so\nLoadModule vhost_alias_module modules/mod_vhost_alias.so\nLoadModule dir_module modules/mod_dir.so\nLoadModule alias_module modules/mod_alias.so\nLoadModule rewrite_module modules/mod_rewrite.so\nLoadModule ssl_module modules/mod_ssl.so\nLoadModule php5_module modules/libphp5.so\nAddHandler php5-script php\n\u2026\nIn vhost:\n\u2026\nRequestHeader unset Accept-Encoding\nAddOutputFilterByType Sed text/html text/css text/javascript application/javascript\nHeader unset Content-Length\nOutputSed \"s/https:\\/\\/www.asl.com/https:\\/\\/ge-dev.itools.de.cse.comfin.ge.com/g\"\n\n\n3)\nSoftware: Apache 2.4.10 + mod_sed compiled from source.\nmod_sed  source taken from trunk at the moment, but error also happened on stock apache 2.4.10 release version, this is why we switched to trunk.\nFor our tests we have also compiled sed1.c with different #define INIT_BUF_SIZE values (stock value is 1024). Error scales with this buffer size.\nIn our current test we have set INIT_BUF_SIZE to 8092 (not 8192).\n\n5)\nRemember: We have INIT_BUF_SIZE 8092 in this test.\na)\nOuput: nothing if $mynum>=176. Browser times out and says Connection Problem (Message depends on Browser vendor of course).\nb)\nOutput: correct if $mynum<=175;\nfirst line with newline (all good)\nnow printing one single matching line with 175*23=4025 bytes expanding to 7350 bytes:\nhttps://ge-dev.itools.de.cse.comfin.ge.com\n\u2026\nLast line is also shown\n\nc)\nBeware: Sometimes (maybe on first request, but seldom) you may get output with values near 176 as well. If you get output this way, you can see that substitution stopped before all lines were processed. Output then shows correctly substituted lines at the beginning but at the end the original lines are shown and rest of document may be completely truncated. Usually if you see this, you can try to reload the page and might then end up with an empty page and the connection problem. With $mynum=178 you will always trigger the error.\n\nJust run your own tests with different buffer sizes.\n\n6)\nLinux system: Redhat 6.5 x64\nHW: HP Proliant G6 with 192GB of RAM\nNo other jobs or load on this test system.\n\nRegards,\nOliver", "id": 192230, "time": "2016-07-08T05:04:35Z", "creator": "christophe.jaillet@wanadoo.fr", "creation_time": "2016-07-08T05:04:35Z", "is_private": false}]