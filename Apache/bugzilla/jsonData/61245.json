[{"text": "Building Apache 2.4.26 against lua 5.3.1, or 5.3.4 compiled from scratch (latest version as of this writing) does not work.\n\nCompilation against lua 5.3.1 did work with 2.4.25.\n\nSo far downgrading to lua 5.2.4 seems to have fixed things.\n\nThe error seen is as follows:\n\nchecking for lua.h in /opt/amp/amptools/releases_develop/develop-3b8c979-81/include/lua-5.3... no\nchecking for lua.h in /opt/amp/amptools/releases_develop/develop-3b8c979-81/include/lua5.3... no\nchecking for lua.h in /opt/amp/amptools/releases_develop/develop-3b8c979-81/include/lua53... no\nchecking for lua.h in /opt/amp/amptools/releases_develop/develop-3b8c979-81/include... yes\nchecking for luaL_newstate in -llua... yes\nchecking for luaL_register in -llua... no\nchecking for lua.h in /opt/amp/amptools/releases_develop/develop-3b8c979-81/include/lua-5.2... no\nchecking for lua.h in /opt/amp/amptools/releases_develop/develop-3b8c979-81/include/lua5.2... no\nchecking for lua.h in /opt/amp/amptools/releases_develop/develop-3b8c979-81/include/lua52... no\nchecking for lua.h in /opt/amp/amptools/releases_develop/develop-3b8c979-81/include/lua-5.1... no\nchecking for lua.h in /opt/amp/amptools/releases_develop/develop-3b8c979-81/include/lua5.1... no\nchecking for lua.h in /opt/amp/amptools/releases_develop/develop-3b8c979-81/include/lua51... no\nconfigure: WARNING: *** Lua 5.3 5.2 or 5.1 library not found.\nconfigure: error: Lua 5.3 5.2 or 5.1 library is required", "tags": [], "creator": "matthew@mucklo.com", "attachment_id": null, "count": 0, "id": 199528, "time": "2017-07-03T07:25:03Z", "bug_id": 61245, "creation_time": "2017-07-03T07:25:03Z", "is_private": false}, {"count": 1, "tags": [], "creator": "toscano.luca@gmail.com", "attachment_id": null, "id": 199545, "time": "2017-07-04T13:40:25Z", "bug_id": 61245, "creation_time": "2017-07-04T13:40:25Z", "is_private": false, "text": "Hi Matthew,\n\nprobably modules/lua/config.m4 would need to be updated, but afaics you should be able to use --with-lua=PATH as configure parameter and get around the 5.3.1 limitation.\n\n./configure --help | grep lua\n  --enable-lua            Apache Lua Framework\n  --enable-luajit         Enable LuaJit Support\n  --with-lua=PATH         Path to the Lua 5.3/5.2/5.1 prefix"}, {"count": 2, "tags": [], "bug_id": 61245, "attachment_id": null, "id": 199546, "time": "2017-07-04T13:49:18Z", "creator": "toscano.luca@gmail.com", "creation_time": "2017-07-04T13:49:18Z", "is_private": false, "text": "Sorry completely missed the fact that it was working on 2.4.25, will try to repro asap."}, {"count": 3, "tags": [], "creator": "rainer.jung@kippdata.de", "attachment_id": null, "text": "To the OP: can you please provide your file config.log from the top level build directory?\n\nSince the file is relatively big, we would need at least the part that starts similar to:\n\nconfigure:20506: checking for lua.h in /opt/amp/amptools/releases_develop/develop-3b8c979-81/include\nconfigure:20509: result: yes\nconfigure:20519: checking for luaL_newstate in -llua\n...\n\nand then all the rest to the end of the file.", "id": 199552, "time": "2017-07-04T14:20:02Z", "bug_id": 61245, "creation_time": "2017-07-04T14:20:02Z", "is_private": false}, {"count": 4, "tags": [], "creator": "jchampion@apache.org", "attachment_id": null, "text": "Possible dupe of bug 60831?\n\nIf I recall correctly, 5.3 wasn't supported in 2.4.25. It would \"build\" but not function. Now (as of 2.4.26) it functions, but won't build without the Lua compatibility APIs enabled.", "id": 199553, "time": "2017-07-04T14:30:32Z", "bug_id": 61245, "creation_time": "2017-07-04T14:30:32Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 61245, "attachment_id": null, "id": 199554, "time": "2017-07-04T15:40:34Z", "creator": "toscano.luca@gmail.com", "creation_time": "2017-07-04T15:40:34Z", "is_private": false, "text": "On Debian Stretch I can see the following:\n\n$ dpkg --list | grep lua\nrc  liblua5.1-0:amd64                      5.1.5-7.1                      amd64        Shared library for the Lua interpreter version 5.1\nii  liblua5.3-0:amd64                      5.3.3-1                        amd64        Shared library for the Lua interpreter version 5.3\nii  liblua5.3-dev:amd64                    5.3.3-1                        amd64        Development files for the Lua language version 5.\n\n\nconfigure:19958: checking whether to enable mod_lua\nconfigure:20017: result: checking dependencies\nconfigure:20037: checking for pow in -lm\nconfigure:20062: gcc -o conftest  -g -O2 -pthread  -DLINUX -D_REENTRANT -D_GNU_SOURCE   conftest.c -lm   >&5\nconftest.c:52:6: warning: conflicting types for built-in function 'pow'\n char pow ();\n      ^~~\nconfigure:20062: $? = 0\nconfigure:20071: result: yes\nconfigure:20077: checking for sqrt in -lm\nconfigure:20102: gcc -o conftest  -g -O2 -pthread  -DLINUX -D_REENTRANT -D_GNU_SOURCE   conftest.c -lm   >&5\nconftest.c:52:6: warning: conflicting types for built-in function 'sqrt'\n char sqrt ();\n      ^~~~\nconfigure:20102: $? = 0\nconfigure:20111: result: yes\nconfigure:20118: checking for lua.h in ./include/lua-5.3\nconfigure:20247: result: no\nconfigure:20251: checking for lua.h in ./include/lua5.3\nconfigure:20380: result: no\nconfigure:20384: checking for lua.h in ./include/lua53\nconfigure:20513: result: no\nconfigure:20518: checking for lua.h in ./include\nconfigure:20647: result: no\nconfigure:20652: checking for lua.h in ./include/lua-5.2\nconfigure:20781: result: no\nconfigure:20785: checking for lua.h in ./include/lua5.2\nconfigure:20914: result: no\nconfigure:20918: checking for lua.h in ./include/lua52\nconfigure:21047: result: no\nconfigure:21052: checking for lua.h in ./include/lua-5.1\nconfigure:21181: result: no\nconfigure:21185: checking for lua.h in ./include/lua5.1\nconfigure:21314: result: no\nconfigure:21318: checking for lua.h in ./include/lua51\nconfigure:21447: result: no\nconfigure:20118: checking for lua.h in /usr/local/include/lua-5.3\nconfigure:20247: result: no\nconfigure:20251: checking for lua.h in /usr/local/include/lua5.3\nconfigure:20380: result: no\nconfigure:20384: checking for lua.h in /usr/local/include/lua53\nconfigure:20513: result: no\nconfigure:20518: checking for lua.h in /usr/local/include\nconfigure:20647: result: no\nconfigure:20652: checking for lua.h in /usr/local/include/lua-5.2\nconfigure:20781: result: no\nconfigure:20785: checking for lua.h in /usr/local/include/lua5.2\nconfigure:20914: result: no\nconfigure:20918: checking for lua.h in /usr/local/include/lua52\nconfigure:21047: result: no\nconfigure:21052: checking for lua.h in /usr/local/include/lua-5.1\nconfigure:21181: result: no\nconfigure:21185: checking for lua.h in /usr/local/include/lua5.1\nconfigure:21314: result: no\nconfigure:21318: checking for lua.h in /usr/local/include/lua51\nconfigure:21447: result: no\nconfigure:20118: checking for lua.h in /usr/include/lua-5.3\nconfigure:20247: result: no\nconfigure:20251: checking for lua.h in /usr/include/lua5.3\nconfigure:20254: result: yes\nconfigure:20264: checking for luaL_newstate in -llua5.3\nconfigure:20289: gcc -o conftest  -g -O2 -pthread  -DLINUX -D_REENTRANT -D_GNU_SOURCE -L/usr/lib   -lm conftest.c -llua5.3   >&5\nconfigure:20289: $? = 0\nconfigure:20298: result: yes\nconfigure:20302: checking for luaL_register in -llua5.3\nconfigure:20330: gcc -o conftest  -g -O2 -pthread -I/usr/include/lua5.3  -DLINUX -D_REENTRANT -D_GNU_SOURCE -L/usr/lib   -lm conftest.c -llua5.3 >&5\n/tmp/ccs0jUf9.o: In function `main':\n/home/vagrant/httpd-2.4.x/conftest.c:60: undefined reference to `luaL_openlib'\ncollect2: error: ld returned 1 exit status\nconfigure:20330: $? = 1\nconfigure: failed program was:\n| /* confdefs.h */\n| #define PACKAGE_NAME \"\"\n| #define PACKAGE_TARNAME \"\"\n| #define PACKAGE_VERSION \"\"\n| #define PACKAGE_STRING \"\"\n| #define PACKAGE_BUGREPORT \"\"\n| #define PACKAGE_URL \"\"\n| #define STDC_HEADERS 1\n| #define HAVE_SYS_TYPES_H 1\n| #define HAVE_SYS_STAT_H 1\n| #define HAVE_STDLIB_H 1\n| #define HAVE_STRING_H 1\n| #define HAVE_MEMORY_H 1\n| #define HAVE_STRINGS_H 1\n| #define HAVE_INTTYPES_H 1\n| #define HAVE_STDINT_H 1\n| #define HAVE_UNISTD_H 1\n| #define __EXTENSIONS__ 1\n| #define _ALL_SOURCE 1\n| #define _GNU_SOURCE 1\n| #define _POSIX_PTHREAD_SEMANTICS 1\n| #define _TANDEM_SOURCE 1\n| #define STDC_HEADERS 1\n| #define HAVE_STRING_H 1\n| #define HAVE_LIMITS_H 1\n| #define HAVE_UNISTD_H 1\n| #define HAVE_SYS_SOCKET_H 1\n| #define HAVE_PWD_H 1\n| #define HAVE_GRP_H 1\n| #define HAVE_STRINGS_H 1\n| #define HAVE_SYS_PRCTL_H 1\n| #define HAVE_SYS_SEM_H 1\n| #define HAVE_SYS_WAIT_H 1\n| #define HAVE_GETPWNAM 1\n| #define HAVE_GETGRNAM 1\n| #define HAVE_INITGROUPS 1\n| #define HAVE_PRCTL 1\n| #define HAVE_TIMEGM 1\n| #define HAVE_GETPGID 1\n| #define HAVE_FOPEN64 1\n| #define HAVE_GETLOADAVG 1\n| #define HAVE_GETTID 1\n| #define HAVE_GMTOFF 1\n| /* end confdefs.h.  */\n| \n| \n|                     #define LUA_COMPAT_ALL\n|                     #define LUA_COMPAT_5_2\n|                     #define LUA_COMPAT_5_1\n|                     #define LUA_COMPAT_MODULE\n| \n|                     #include <lua.h>\n|                     #include <lauxlib.h>\n| \n| int\n| main ()\n| {\n| \n|                     /* This isn't a valid call, but we're testing linkability */\n|                     luaL_register(NULL, NULL, NULL);\n| \n|   ;\n|   return 0;\n| }\n| \nconfigure:20362: result: no\nconfigure:20384: checking for lua.h in /usr/include/lua53\nconfigure:20513: result: no\nconfigure:20518: checking for lua.h in /usr/include\nconfigure:20647: result: no\nconfigure:20652: checking for lua.h in /usr/include/lua-5.2\nconfigure:20781: result: no\nconfigure:20785: checking for lua.h in /usr/include/lua5.2\nconfigure:20914: result: no\nconfigure:20918: checking for lua.h in /usr/include/lua52\nconfigure:21047: result: no\nconfigure:21052: checking for lua.h in /usr/include/lua-5.1\nconfigure:21181: result: no\nconfigure:21185: checking for lua.h in /usr/include/lua5.1\nconfigure:21314: result: no\nconfigure:21318: checking for lua.h in /usr/include/lua51\nconfigure:21447: result: no\nconfigure:21457: WARNING: *** Lua 5.3 5.2 or 5.1 library not found.\nconfigure:21461: WARNING: Lua 5.3 5.2 or 5.1 library is required\nconfigure:21547: checking whether to enable mod_lua\nconfigure:21553: error: mod_lua has been requested but can not be built due to prerequisite failures"}, {"count": 6, "tags": [], "bug_id": 61245, "attachment_id": null, "id": 199555, "time": "2017-07-04T18:21:11Z", "creator": "matthew@mucklo.com", "creation_time": "2017-07-04T18:21:11Z", "is_private": false, "text": "(In reply to Jacob Champion from comment #4)\n> Possible dupe of bug 60831?\n> \n> If I recall correctly, 5.3 wasn't supported in 2.4.25. It would \"build\" but\n> not function. Now (as of 2.4.26) it functions, but won't build without the\n> Lua compatibility APIs enabled.\n\nInteresting.\n\nI need to double check how lua was compiled.  I may need to ensure the following flags are set then if what you're saying is correct:\n\nMYCFLAGS=\"-DLUA_COMPAT_5_2 -DLUA_COMPAT_5_1\""}, {"count": 7, "tags": [], "bug_id": 61245, "attachment_id": null, "id": 199556, "time": "2017-07-04T18:49:30Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2017-07-04T18:49:30Z", "is_private": false, "text": "Thanks Luca.\n\nDue to our compat settings, the symbol luaL_register() that we use in our code will fall back to a define:\n\n#define luaL_register(L,n,l)      (luaL_openlib(L,(n),(l),0))\n\nin the lua include file lauxlib.h for Lua 5.3.\n\nUnfortunately when the lua lib itself gets build, Lua 5.3 only includes code for Lua 5.2 compatibility (the Makefile of Lua 5.3 by default defines LUA_COMPAT_5_2), but not those for 5.1 which luaL_openlib() is part of and which we need for mod_lua.\n\nOne solution is building lua by oneself and adding the define LUA_COMPAT_5_1 when building it. That only helps people who are prepared to build their lua themselves (which is not hard but most would probably want to stick to a distribution provided build).\n\nThe other solution for us would be to make the code at least compatible with 5.2 (first released on December 2011), maybe even conditionally compatible with 5.3. I do not know how easy that will be.\n\nRegards,\n\nRainer"}, {"count": 8, "tags": [], "bug_id": 61245, "attachment_id": null, "id": 199562, "time": "2017-07-04T22:40:43Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2017-07-04T22:40:43Z", "is_private": false, "text": "I applied a variant of the patch from BZ 58188 to httpd trunk and backported it to 2.4.x in r1800835. With this patch, mod_lua should also compile against lua 5.1, 5.2 and 5.3 which were build without any COMPAT flags defined.\n\nIt will be part of version 2.4.27.\n\nIt would be nice if you could verify the fix either from the current 2.4.x head or during the release vote with the 2.4.27 candidate or after the release of 2.4.27."}, {"count": 9, "tags": [], "bug_id": 61245, "attachment_id": null, "id": 199568, "time": "2017-07-05T08:24:47Z", "creator": "toscano.luca@gmail.com", "creation_time": "2017-07-05T08:24:47Z", "is_private": false, "text": "Tested HEAD of 2.4.x and it now configure/compiles correctly on Debian Stretch with lua 5.3.x. I also tested a simple script/handler to be sure and everything works correctly."}]