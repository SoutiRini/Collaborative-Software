[{"count": 0, "attachment_id": 22042, "creator": "michael@stroeder.com", "text": "Created attachment 22042\nPatch for mod_ssl: Map attribute name \"UID\" to NID_userId\n\nWhen connecting with a client certificate which contains attribute UID in its subject-DN the following env vars are set:\nSSL_CLIENT_S_DN: /O=Company Name/OU=Authc/UID=userid/CN=Full name\nSSL_CLIENT_S_DN_UID: (none)\n\nFrom discussion on modssl-users list I've learned that SSL_CLIENT_S_DN contains the string representation of the subject-DN generated by OpenSSL libs and SSL_CLIENT_S_DN_UID is set by mod_ssl.\n\nFurthermore I've learned that SSL_CLIENT_S_DN_UID is set by mod_ssl based on attribute 'x500UniqueIdentifier' (OID 2.5.4.45). I consider this to be seriously broken because the syntax assigned to attribute type 'x500UniqueIdentifier' (OID 2.5.4.45) is 'Bit String' (OID 1.3.6.1.4.1.1466.115.121.1.6) which cannot be used to store a user ID with characters like 'ABCDEF'.\n\nSee also http://www.alvestrand.no/objectid/2.5.4.45.html\n\nFurthermore RFC 4514 contains a table of short and long attribute type names and their OIDs (end of chapter 3). See the relevant excerpt:\n\nString  X.500 AttributeType\n      ------  --------------------------------------------\n[..]\n      UID     userId (0.9.2342.19200300.100.1.1)\n\nSo please consider the patch attached to be applied to mod_ssl to fix this bug.\n\nThanks in advance.\n\nCiao, Michael.", "id": 117205, "time": "2008-05-31T04:03:49Z", "bug_id": 45107, "creation_time": "2008-05-31T04:03:49Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "bug_id": 45107, "attachment_id": null, "id": 127913, "time": "2009-06-12T05:23:12Z", "creator": "peter.sylvester@edelweb.fr", "creation_time": "2009-06-12T05:23:12Z", "is_private": false, "text": "OpenSSL has changed the definition of the NIDs in question some time\nin the past. Until the definition of NID_Userid, the OID was simply wrong.\n\nin the example, the x_DN is correctly formatted using an openssl function. \n\nThe patch replaces the ifdefs and nids by an unconditional use of NID_userId\n\nIn order to maintain the possibility to compile with older versions\n(without any consideration about their stability in other areas)\nI suggest to use\n\n+ #ifdef NID_userId\n+    { \"UID\",   NID_userId                 }, /* officially see RFC 4514 */\n+ #endif\n\nPeter Sylvester"}, {"count": 2, "tags": [], "text": "The bug is the same as for ticket 29201. \n\nThe proposed solution in 29201 to have a different environment variable\ndoesn't make much sense.", "attachment_id": null, "id": 128170, "creator": "peter.sylvester@edelweb.fr", "time": "2009-06-23T04:41:51Z", "bug_id": 45107, "creation_time": "2009-06-23T04:41:51Z", "is_private": false}, {"count": 3, "attachment_id": null, "creator": "jorton@redhat.com", "text": "Yes, I think I was convinced by Martin's argument on the mailing list about this.  I will dupe the other bug against this and commit that fix.  Thanks, guys.", "id": 128185, "time": "2009-06-23T07:02:41Z", "bug_id": 45107, "creation_time": "2009-06-23T07:02:41Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "bug_id": 45107, "attachment_id": null, "text": "*** Bug 29201 has been marked as a duplicate of this bug. ***", "id": 128187, "time": "2009-06-23T07:10:34Z", "creator": "jorton@redhat.com", "creation_time": "2009-06-23T07:10:34Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 45107, "text": "Discussion thread, for reference:\n\nhttp://marc.info/?l=apache-modssl&m=121118489703295&w=2\n\nCommitted in r787683.", "id": 128188, "time": "2009-06-23T07:12:18Z", "creator": "jorton@redhat.com", "creation_time": "2009-06-23T07:12:18Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "text": "still no working in 2.2.13 (and 2.2.9) (at least for me)\n\nusing OpenSSL 0.9.8k 25 Mar 2009 and mod_ssl/2.2.13 compiled against Server: Apache/2.2.13, Library: OpenSSL/0.9.8k\n\ntried old certs and generated new one and also tried userID, UID\n\nafter aplying Peter Sylvester minipatch\n#ifdef NID_userId\n    { \"UID\",   NID_userId                 }, /* officially see RFC 4514 */\n#else\n        #ifdef NID_x500UniqueIdentifier /* new name as of Openssl 0.9.7 */\n    { \"UID\",   NID_x500UniqueIdentifier   },\n        #else /* old name, OpenSSL < 0.9.7 */\n    { \"UID\",   NID_uniqueIdentifier       },\n        #endif\n#endif\n\nstart working", "attachment_id": null, "id": 129985, "creator": "lampacz@gmail.com", "time": "2009-08-27T07:48:33Z", "bug_id": 45107, "creation_time": "2009-08-27T07:48:33Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 45107, "text": "Can someone provide a non working cert and the values of both\nSSL_CLIENT_S_DN and SSL_CLIENT_S_DN_UID.", "id": 129988, "time": "2009-08-27T08:37:04Z", "creator": "peter.sylvester@edelweb.fr", "creation_time": "2009-08-27T08:37:04Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 45107, "attachment_id": null, "text": "using CustomLog \"%{SSL_PROTOCOL}x \\\"%{SSL_CIPHER}x\\\" \\\"%{SSL_CLIENT_S_DN_CN}x\\\" \\\"%{SSL_CLIENT_S_DN_UID}x\\\" \\\"%r\\\" %>s %b %T\"\n\nbefore patch:\nTLSv1 \"DHE-RSA-AES256-SHA\" \"/C=CZ/ST=State/L=Location/O=Organization/OU=Test Unit/CN=Test User/emailAddress=test@test.com/UID=d1bff376-3788-404f-ae9c-ffffffffffff\" \"-\" \"GET / HTTP/1.1\" 403 217 1\n\nafter patch:\nTLSv1 \"DHE-RSA-AES256-SHA\" \"/C=CZ/ST=State/L=Location/O=Organization/OU=Test Unit/CN=Test User/emailAddress=test@test.com/UID=d1bff376-3788-404f-ae9c-ffffffffffff\" \"d1bff376-3788-404f-ae9c-ffffffffffff\" \"GET / HTTP/1.1\" 403 217 1\n\nalso  SSLRequire %{SSL_CLIENT_S_DN_UID} doesn't work\n\nopenssl.cnf:\n\n[ req_distinguished_name ]\n....\nuid                             = User ID\nuid_min                         = 36\nuid_max                         = 36\n\n\nand cert:\n\n-----BEGIN CERTIFICATE-----\nMIIEvjCCAqagAwIBAgIBBTANBgkqhkiG9w0BAQUFADCBijELMAkGA1UEBhMCQ1ox\nGDAWBgNVBAgTD0Nlc2thIFJlcHVibGlrYTEOMAwGA1UEBxMFUHJhaGExFTATBgNV\nBAoTDFNhbnRlIHMuci5vLjEZMBcGA1UEAxMQTUFYIHYxIENsaWVudCBDQTEfMB0G\nCSqGSIb3DQEJARYQc3VwcG9ydEBzYW50ZS5jejAeFw0wOTA4MjcxNjU4MjdaFw0x\nMDA4MjcxNjU4MjdaMIHDMQswCQYDVQQGEwJDWjEOMAwGA1UECBMFU3RhdGUxETAP\nBgNVBAcTCExvY2F0aW9uMRUwEwYDVQQKEwxPcmdhbml6YXRpb24xEjAQBgNVBAsT\nCVRlc3QgVW5pdDESMBAGA1UEAxMJVGVzdCBVc2VyMRwwGgYJKoZIhvcNAQkBFg10\nZXN0QHRlc3QuY29tMTQwMgYKCZImiZPyLGQBARMkZDFiZmYzNzYtMzc4OC00MDRm\nLWFlOWMtZmZmZmZmZmZmZmZmMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDM\n1V8TAu3mfzXduSI6fZcbT00mbZjOuvBBn+SAKnSn0Evf/x3qzfzRcG3fyXrOICnF\nA66R9Dm3SGyuhr7SnWSrOtezAUkOsBejke2tdElk7OgoXQQHblBAKFGcJ7yeKxdy\n+nk9CGvXV1SaLJYU+DOAQt1h6qaHbi8+soRtJWs8CwIDAQABo3gwdjAMBgNVHRMB\nAf8EAjAAMBEGCWCGSAGG+EIBAQQEAwIHgDALBgNVHQ8EBAMCB4AwEwYDVR0lBAww\nCgYIKwYBBQUHAwIwMQYJYIZIAYb4QgENBCQWIk9wZW5TU0wgQ2VydGlmaWNhdGUg\nZm9yIFNTTCBDbGllbnQwDQYJKoZIhvcNAQEFBQADggIBAE1a/t72msEM69N/k6hw\npBAc3hHQKlcmM+jSX5RhuuQEJu3iKf9OeExULZnBhBK1VhwEcYKOP3On/fbFC/Hi\nLVawkt4S67bgxCzVSiHiEp7vJpoPBRH1ifZO5TzbXsKrGjN6zNy9zSS7QFWE0hy6\ndtX0Jjx8iU3c46+E+R5OK6nlbcLXIh6DYXSZgo0FdeF+m9unQoE34TRe9imbh8ZF\n6e4noXEYAna9sVEMQDvGKycC7HJaltV/iS44UXji0uvUA31sUfhEbGAlGxw3DhXr\nHQAhv7xQ4QICzGANtF/Tic4zi+KNvWtGZ+MtOWxkcLgxc13Vhr+Hp1d+cGWMj9A3\nxRjeW5DK1DVBjI8dAb1B14lCYrd4sXZbSDH2YhbXAw6PILN7hmrauJTIlMyz8LEn\nAKcIxlR59QaimZgfiN9c0gV4QKHAUO+seHGIa9/1ewZ1vidbGyldpCojbbfMnCX6\ncPISe+fIl8h5Ph81iRYNGiT6dqoHk3OHhw2PtXSCDieN5qZrqBigaDnRQ9awWbnK\nl2m19MBVaE7VtPCmqrqLH+uTqepFFspBs29AFHXiSw4L0aGicuaduSyZ5XpZ0xN3\nojDfBQYTmcafwmfyDDi2YsNJqCgJJLMmYo5eIklt3sgKypCs6NwJGl18Wgcv1WRO\n4YOTATlUek/SuqnvIVl4Fv4A\n-----END CERTIFICATE-----", "id": 129994, "time": "2009-08-27T10:05:28Z", "creator": "lampacz@gmail.com", "creation_time": "2009-08-27T10:05:28Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 45107, "attachment_id": null, "text": "As far as I understand your log entry:\n\nSSL_CLIENT_S_DN_UID seems ok in your customlog.\n\nbefore the patch it is \"-\" (bad) \nafter it is \"d1bff376-3788-404f-ae9c-ffffffffffff\" (good)", "id": 130000, "time": "2009-08-27T11:03:32Z", "creator": "peter.sylvester@edelweb.fr", "creation_time": "2009-08-27T11:03:32Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 45107, "attachment_id": null, "id": 130009, "time": "2009-08-27T13:51:17Z", "creator": "lampacz@gmail.com", "creation_time": "2009-08-27T13:51:17Z", "is_private": false, "text": "exactly, before patch modules/ssl/ssl_engine_vars.c contains only:\n\n        #ifdef NID_x500UniqueIdentifier /* new name as of Openssl 0.9.7 */\n    { \"UID\",   NID_x500UniqueIdentifier   },\n        #else /* old name, OpenSSL < 0.9.7 */\n    { \"UID\",   NID_uniqueIdentifier       },\n        #endif\n\nand wasn't possible to log only UID (\"-\" instead d1bff376-3788-404f-ae9c-ffffffffffff in custom log file; DN containted UID) after patch UID appears in custon log file\n\n/usr/include/openssl/objects.h:\n....\n#define SN_uniqueIdentifier             \"UID\"\n#define LN_uniqueIdentifier             \"uniqueIdentifier\"\n#define NID_uniqueIdentifier            102\n#define OBJ_uniqueIdentifier            OBJ_X509,45L\n...\n\n\n/usr/include/openssl/obj_mac.h:\n...\n#define SN_userId               \"UID\"\n#define LN_userId               \"userId\"\n#define NID_userId              458\n#define OBJ_userId              OBJ_pilotAttributeType,1L\n....\n#define LN_x500UniqueIdentifier         \"x500UniqueIdentifier\"\n#define NID_x500UniqueIdentifier                503\n#define OBJ_x500UniqueIdentifier                OBJ_X509,45L\n....\n\nopenssl x509 -in test2.crt -noout  -subject -nameopt RFC2253  -nameopt sname\nsubject= UID=d1bff376-3788-404f-ae9c-ffffffffffff,emailAddress=test@test.com,CN=Test User,OU=Test Unit,O=Organization,L=Location,ST=State,C=CZ\n\nopenssl x509 -in test2.crt -noout  -subject -nameopt RFC2253  -nameopt oid\nsubject= 0.9.2342.19200300.100.1.1=d1bff376-3788-404f-ae9c-ffffffffffff,1.2.840.113549.1.9.1=test@test.com,2.5.4.3=Test User,2.5.4.11=Test Unit,2.5.4.10=Organization,2.5.4.7=Location,2.5.4.8=State,2.5.4.6=CZ"}, {"count": 11, "tags": [], "bug_id": 45107, "attachment_id": null, "text": "So, where is the problem?\n\nDon't you like tha UID id the OID 0.9.2342.19200300.100.1.1?\n\nDo you prefer OID 2.5.4.45? \n\nThe routine that shows the full Dn uses UID for the 0.9.2342.19200300.100.1.1\nsince several years since one cannot have a nice representation of 2.5.4.45\nanyway.\n\nThe patch aligns the SSL_type_x_UID variable to match the UID=\nin the full DN in alignment with ldap.  \n\nOr do you want certificates that have OID 2.5.4.45?", "id": 130011, "time": "2009-08-27T14:51:23Z", "creator": "peter.sylvester@edelweb.fr", "creation_time": "2009-08-27T14:51:23Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 45107, "attachment_id": null, "id": 130016, "time": "2009-08-27T21:22:37Z", "creator": "lampacz@gmail.com", "creation_time": "2009-08-27T21:22:37Z", "is_private": false, "text": "problem is that must patch modules/ssl/ssl_engine_vars.c with\n\n+ #ifdef NID_userId\n+    { \"UID\",   NID_userId                 }, /* officially see RFC 4514 */\n+ #endif\n\nto get uid working (in my casse) but this is not possible when you use distro packages (debian testing)"}, {"count": 13, "tags": [], "bug_id": 45107, "text": "The patch should be backported as soon as possible so\nthat packaged standard versions get it.", "id": 130021, "time": "2009-08-28T03:31:41Z", "creator": "peter.sylvester@edelweb.fr", "creation_time": "2009-08-28T03:31:41Z", "is_private": false, "attachment_id": null}, {"count": 14, "tags": [], "bug_id": 45107, "text": "great, i hope that will be in next release (2.2.14)\n\nthank you", "id": 130040, "time": "2009-08-28T21:46:45Z", "creator": "lampacz@gmail.com", "creation_time": "2009-08-28T21:46:45Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "text": "This issue was fixed in 2.2.x branch with r811812 and will ship with httpd 2.2.14.", "attachment_id": null, "id": 130171, "creator": "eflash@gmx.net", "time": "2009-09-06T17:45:23Z", "bug_id": 45107, "creation_time": "2009-09-06T17:45:23Z", "is_private": false}, {"count": 16, "tags": [], "bug_id": 45107, "attachment_id": null, "id": 135618, "time": "2010-03-25T11:20:26Z", "creator": "lampacz@gmail.com", "creation_time": "2010-03-25T11:20:26Z", "is_private": false, "text": "Is possible in 2.2.15 version reverted to (eg discarded http://svn.apache.org/viewvc?view=revision&revision=811812):\n\n#ifdef NID_userId\n    { \"UID\",   NID_x500UniqueIdentifier,   1 },\n#endif\n\ninstead:\n+ #ifdef NID_userId\n+    { \"UID\",   NID_userId                 }, /* officially see RFC 4514 */\n+ #endif\n?\n\nNow is not possible to use SSL_CLIENT_S_DN_UID which refers to openssl NID_userId"}, {"count": 17, "tags": [], "creator": "ymmt2005@gmail.com", "text": "Just for information, this broke compatibility between Ubuntu 10.04\n(shipped with Apache 2.2.14) and Ubuntu 12.04 (shipped with Apache 2.2.22).", "id": 160556, "time": "2012-07-10T04:44:10Z", "bug_id": 45107, "creation_time": "2012-07-10T04:44:10Z", "is_private": false, "attachment_id": null}, {"count": 18, "tags": [], "bug_id": 45107, "attachment_id": null, "text": "Frankly I don't understand why this bug has been reopened. Anybody who claims that using the correct mapping { \"UID\",NID_userId} is a regression should elaborate why that is.\n\nIMO maintaining backward compability between distro packages does not have higher priority over fixing wrong behaviour in upstream source. Especially as comment#17 does not contain any useful information about the problem. (I suspect it's a misconfiguration anyway.)\n\nNote that referencing x500UniqueIdentifier in older Apache versions was never correct. It never worked right at all! Never! It was absolutely wrong. Got it?\nEverybody having doubts about this should re-read my initial issue text more closely and comment based on real knowledge about structure of X.509 certs.", "id": 160557, "time": "2012-07-10T07:03:42Z", "creator": "michael@stroeder.com", "creation_time": "2012-07-10T07:03:42Z", "is_private": false}, {"count": 19, "tags": [], "text": "Michael,\n\nI'm sorry.  That is a Ubuntu's backward compatibility problem, not apache's.\nI agree with you that using userId is appropriate.", "is_private": false, "id": 160560, "creator": "ymmt2005@gmail.com", "time": "2012-07-10T11:30:39Z", "bug_id": 45107, "creation_time": "2012-07-10T11:30:39Z", "attachment_id": null}, {"count": 20, "attachment_id": null, "creator": "covener@gmail.com", "text": "Create a new bugzilla entry if you think there's followup work to do here.", "id": 160561, "time": "2012-07-10T11:54:10Z", "bug_id": 45107, "creation_time": "2012-07-10T11:54:10Z", "tags": [], "is_private": false}, {"count": 21, "tags": [], "bug_id": 45107, "text": "I think comment 16 was overlooked in the ubuntu backward compatibility debate.\n\nIt looks like:\nhttp://svn.apache.org/viewvc?view=revision&revision=910319\n #ifdef NID_userId\n-    { \"UID\",   NID_userId                 },\n+    { \"UID\",   NID_x500UniqueIdentifier,   1 },\n #endif\n\nreverted the attribute back to x500UniqueIdentifier.   Based on comment 18 I think this submission was a regression.\n\nI'll open a new bug report against that.", "id": 164956, "time": "2013-01-31T17:11:17Z", "creator": "dopey@moonteeth.com", "creation_time": "2013-01-31T17:11:17Z", "is_private": false, "attachment_id": null}, {"count": 22, "tags": [], "bug_id": 45107, "attachment_id": null, "text": "I opened bug 54510 to report the regression noted in Comment 16", "id": 164958, "time": "2013-01-31T17:16:15Z", "creator": "dopey@moonteeth.com", "creation_time": "2013-01-31T17:16:15Z", "is_private": false}, {"count": 23, "tags": [], "bug_id": 45107, "attachment_id": null, "id": 165002, "time": "2013-02-02T07:44:30Z", "creator": "asfbugz@velox.ch", "creation_time": "2013-02-02T07:44:30Z", "is_private": false, "text": "Comment 16 (and comment 21) is correct, it's indeed a regression introduced in 2.2.15, with r910319.\n\nAs noted in comment 15, it was originally fixed for 2.2.14 with r811812.\n\nResetting version info to the previous values from 2009. For the fix, see bug 54510 and the proposal in r1441707."}, {"count": 24, "tags": [], "text": "Fixed in 2.2.24 with r1445112.\n\nAs mentioned in the previous comment, it was originally fixed with 2.2.14, but then regressed and was broken in 2.2.15 through 2.2.23.", "attachment_id": null, "id": 165670, "creator": "asfbugz@velox.ch", "time": "2013-03-06T10:39:06Z", "bug_id": 45107, "creation_time": "2013-03-06T10:39:06Z", "is_private": false}]