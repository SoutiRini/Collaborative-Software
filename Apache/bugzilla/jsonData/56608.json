[{"count": 0, "tags": [], "creator": "remnar@gmail.com", "attachment_id": 31700, "id": 175739, "time": "2014-06-09T12:36:20Z", "bug_id": 56608, "creation_time": "2014-06-09T12:36:20Z", "is_private": false, "text": "Created attachment 31700\nLog files for the day the error occurred and context reloading stopped being automatic.  Context file for app in question included.\n\nI have set up a context XML file within $TOMCAT_HOME\\conf\\Catalina\\localhost which has a docbase on a network fileshare.  I have set up a WatchedResource for a handful of files on this fileshare so that whenever one of the files is updated, the context is refreshed.  This works fine for sometime, but after a while, I see an error in the logs saying \"java.io.IOException: The semaphore timeout period has expired\" (Log file with full stack trace is uploaded).\n\nAfter we notice this error, I had to start the context back via the Tomcat manager (to be expected, since it appears that a short network unavailability caused the issue).  However, once the application is started manually, the WatchedResources being updated no longer force the context to reload.  We have to reload the context manually until we do a full restart of the Tomcat service."}, {"count": 1, "tags": [], "creator": "knst.kolinko@gmail.com", "text": "The error in the log is:\n[[[\nJun 5, 2014 4:35:15 PM org.apache.catalina.startup.HostConfig checkResources\nWARNING: Error delete redeploy resources from context [/CTIOutreachPrompts]\njava.io.IOException: The semaphore timeout period has expired\n\tat java.io.WinNTFileSystem.canonicalize0(Native Method)\n\tat java.io.Win32FileSystem.canonicalize(Unknown Source)\n\tat java.io.File.getCanonicalPath(Unknown Source)\n\tat java.io.File.getCanonicalFile(Unknown Source)\n\tat org.apache.catalina.startup.HostConfig.checkResources(HostConfig.java:1246)\n\tat org.apache.catalina.startup.HostConfig.check(HostConfig.java:1382)\n\tat org.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java:306)\n\tat org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:142)\n\tat org.apache.catalina.core.ContainerBase.backgroundProcess(ContainerBase.java:1389)\n\tat org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1653)\n\tat org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.processChildren(ContainerBase.java:1662)\n\tat org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run(ContainerBase.java:1642)\n\tat java.lang.Thread.run(Unknown Source)\n]]]\n\n> which has a docbase on a network fileshare.", "id": 175742, "time": "2014-06-09T13:48:33Z", "bug_id": 56608, "creation_time": "2014-06-09T13:48:33Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 56608, "attachment_id": null, "id": 175880, "time": "2014-06-18T21:53:26Z", "creator": "markt@apache.org", "creation_time": "2014-06-18T21:53:26Z", "is_private": false, "text": "Could you provide some more detail please.\n\nIs the context.xml file deleted from $TOMCAT_HOME\\conf\\Catalina\\localhost when the error occurs?\n\nWhat state is the app shown in in the Manager app (stopped, missing, ???)\n\nWhat steps do you perform in the Manager app?"}, {"count": 3, "tags": [], "bug_id": 56608, "attachment_id": null, "id": 176276, "time": "2014-07-07T16:36:47Z", "creator": "markt@apache.org", "creation_time": "2014-07-07T16:36:47Z", "is_private": false, "text": "Ping. Without the requested information this is likely to get closed as WORKSFORME."}, {"count": 4, "tags": [], "bug_id": 56608, "text": "Sorry, I completely forgot to come back and update this ticket with the information.\n\nThe context file was deleted from the $TOMCAT_HOME\\conf\\Catalina\\localhost directory.  We have a job that is scheduled to run every 5 minutes to check whether or not the context file exists, and if not replaces the file in the directory.  After this job ran and replaced the missing file, Tomcat was showing the application as stopped, and I had to manually start the context.  However, if one of the \"WatchedResource\" files was updated, the context would not refresh.  If I manually did a \"Reload\", the context would refresh correctly, but the \"WatchedResources\" would not trigger a refresh until Tomcat was restarted.", "id": 176311, "time": "2014-07-09T18:17:09Z", "creator": "remnar@gmail.com", "creation_time": "2014-07-09T18:17:09Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 56608, "text": "OK. Things are getting clearer. A few more questions.\n\nWhen you say manually do you mean with the Manager web application?\n\nWhat caused the file to be deleted in the first place?\n\nWhen the file was restored was it exactly the same as the old file including timestamps? If it was different, how was it different?\n\nWhat are you host settings for autoDeploy and deployOnStartup?", "id": 176312, "time": "2014-07-09T18:30:46Z", "creator": "markt@apache.org", "creation_time": "2014-07-09T18:30:46Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 56608, "attachment_id": null, "text": "> When you say manually do you mean with the Manager web application?\nYes, I used the manager web application\n\n\n> What caused the file to be deleted in the first place?\nI'm honestly not sure on this part.  My assumption was that Tomcat deleted it for some reason once the network path became unavailable (I had seen the file get deleted seemingly randomly before, which is why we have the batch file that replaces the file if it goes missing).\n\n\n> When the file was restored was it exactly the same as the old file including timestamps? If it was different, how was it different?\nThe file being restored is exactly the same.  Barring any weirdness in the windows \"copy\" command, even the timestamps should be the same.\n\n> What are you host settings for autoDeploy and deployOnStartup?\nWe have left these settings as default.  From the $TOMCAT_HOME\\conf\\server.xml file for the autoDeploy:\n<Host name=\"localhost\"  appBase=\"webapps\"\n            unpackWARs=\"true\" autoDeploy=\"true\"\n            xmlValidation=\"false\" xmlNamespaceAware=\"false\">\n\nI cannot find the deployOnStartup setting, but if you let me know where it is set, I can show you that value to confirm.", "id": 176313, "time": "2014-07-09T18:40:12Z", "creator": "remnar@gmail.com", "creation_time": "2014-07-09T18:40:12Z", "is_private": false}, {"count": 7, "tags": [], "text": "deployOnStartup will be in server.xml on the Host. It will use the default (true) if not specified.\n\nThanks for all the information. I think we have enough information to start looking at this.", "is_private": false, "bug_id": 56608, "id": 176314, "time": "2014-07-09T18:51:01Z", "creator": "markt@apache.org", "creation_time": "2014-07-09T18:51:01Z", "attachment_id": null}, {"count": 8, "text": "Sorry it has taken me a while to get around to looking at this.\n\nI've been able to figure out what is going on. The sequence of events is:\n\n1. Start with everything working\n2. Network hosting docBase drops out\n3. Tomcat detects this an undeploys the app\n   This includes removing context.xml\n4. Your script re-adds context.xml\n5. Network still not available so Context fails to start. This failure happens\n   before watched resources are added to the Context.\n6. The network comes back up.\n7. Context is re-loaded. (Re0loading does not re-parse context.xml)\n8. Context is running without watched resource information\n\nThe work-around is to touch the context.xml file to trigger a re-deploy rather than to reload it through the manager.", "bug_id": 56608, "attachment_id": null, "id": 181502, "time": "2015-03-04T15:22:35Z", "creator": "markt@apache.org", "creation_time": "2015-03-04T15:22:35Z", "tags": [], "is_private": false}, {"count": 9, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 181509, "time": "2015-03-04T18:43:50Z", "bug_id": 56608, "creation_time": "2015-03-04T18:43:50Z", "is_private": false, "text": "Further digging shows my analysis for step 5 is not quite correct. The issue - and it exists all the way up to trunk - is that when adding watched resources, relative resources are skipped if the docBase is not valid."}, {"count": 10, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 181524, "time": "2015-03-05T12:25:08Z", "bug_id": 56608, "creation_time": "2015-03-05T12:25:08Z", "is_private": false, "text": "Fixed in trunk, 8.0.x (for 8.0.21 onwards) and 7.0.x (for 7.0.60 onwards).\n\nProposed for 6.0.x.\n\nNote a side effect of fixing this is that it will no longer be necessary to restart the application in the Manager. The newly appeared watched resource (when the network share returns) will trigger a reload which will start the app."}, {"count": 11, "tags": [], "bug_id": 56608, "text": "I'm excited that you found and fixed a possible multi-reload trigger, because that seems to happen to me with some regularity -- a series of reloads, one after another, and then things settle down. Often, there are enough reloads that I get tired of the applications pauses and just bounce Tomcat.", "id": 181537, "time": "2015-03-05T17:00:02Z", "creator": "chris@christopherschultz.net", "creation_time": "2015-03-05T17:00:02Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 56608, "text": "Fixed for 6.0.44 onwards.", "id": 181865, "time": "2015-03-18T14:51:13Z", "creator": "markt@apache.org", "creation_time": "2015-03-18T14:51:13Z", "is_private": false, "attachment_id": null}]