[{"count": 0, "tags": [], "bug_id": 43310, "attachment_id": null, "id": 107738, "time": "2007-09-05T04:45:37Z", "creator": "zsunno@gmail.com", "creation_time": "2007-09-05T04:45:37Z", "is_private": false, "text": "If entire output size of ap_vrprintf() is multiple of 8192(AP_IOBUFSIZE),\nthen vd.vbuff.curpos is equal to vd.vbuff.curend\nand null terminator is written over the end of vrprintf_buf[].\n\nIn my machine, first byte of vd.vbuff.curpos is cleared to zero, and 3rd \nparameter of output_buffer() is calcurated incorrectly.\n\ntested on apache-2.2.4\n========\nstep to reproduce the problem:\n1) make sample module\n$ apxs -g -n test\n\n2) edit test_handler\n/* The sample content handler */\nstatic int test_handler(request_rec *r)\n{\n    if (strcmp(r->handler, \"test\")) {\n        return DECLINED;\n    }\n    r->content_type = \"text/html\";\n\n    int n = atoi(r->args) ;\n    char * s = apr_pcalloc(r->pool, n+1) ;\n    memset(s, '1', n) ;\n    ap_rprintf(r, \"%s\", s) ;\n\n    return OK;\n}\n\n3) append to httpd.conf and apachectl start\nLoadModule test_module modules/mod_test.so\n<Location /test>\nSetHandler test\n</Location>\n\n4) module output size test\n$ N=8192 ; for ((i=$N-4; i<$N+4; i++)) ; do echo $i `curl -s localhost/test?$i \n| wc -c` ; done\n8188 8188\n8189 8189\n8190 8190\n8191 8191\n8192 8112        <-- expected size is 8192\n8193 8193\n8194 8194\n8195 8195"}, {"count": 1, "text": "Created attachment 20774\nPatch against httpd-2.2.4\n\nnull terminator is not used", "bug_id": 43310, "is_private": false, "id": 107739, "time": "2007-09-05T04:52:10Z", "creator": "zsunno@gmail.com", "creation_time": "2007-09-05T04:52:10Z", "tags": [], "attachment_id": 20774}, {"count": 2, "text": "I reviewed the patch. Patch looks ok to me. Here is the description of the bug\n:\n\nIn ap_vrprintf, vrprintf_buf is a array allocated on stack of 8192 bytes.\nap_vrprintf invokes ap_vformatter to format the string.  ap_vformatter prints\nthe data character by character, if buffer is overflowed, then it flushes the\ndata and reset the vdbuf.curpos to beginning of buffer.\n\nIf  the size of the output is a multiplication of 8192 then after\nap_vformatter returns, vbuff.curpos just passes one byte after the allocated\nvalue. (ap_vformatter himself doesn't write beyond the allocated buffer). We\ncan't write NULL to this value as it overflow the buffer.\n\nFor a request with /test/?8192, here is the debugger session :\n\nBreakpoint 1, ap_vrprintf (r=0x91f6028, fmt=0xd137af \"%s\", va=0xb731d218\n\"(\u00dcM\\t\\005\")\n    at protocol.c:1530\n1530        vd.vbuff.curpos = vrprintf_buf;\n(gdb) n\n1531        vd.vbuff.endpos = vrprintf_buf + AP_IOBUFSIZE;\n(gdb) n\n1532        vd.r = r;\n(gdb) n\n1533        vd.buff = vrprintf_buf;\n(gdb) n\n1535        if (r->connection->aborted)\n(gdb) n\n1538        written = apr_vformatter(r_flush, &vd.vbuff, fmt, va);\n(gdb) n\n1541        *(vd.vbuff.curpos) = '\\0';\n(gdb) p vd.vbuff.curpos - vrprintf_buf\n$1 = 8192\n(gdb) p sizeof(vrprintf_buf)\n$2 = 8192\n(gdb)\n\nThis patch deletes the statement which sets the null value. This null value is\nnot used later in the function. buffer_output function flushes rest of the\ndata and it doesn't see the data beyond vdbuff.curpos. Also buffer_output\ndoesn't make any call which assumes NULL character at the end.\n", "bug_id": 43310, "attachment_id": null, "id": 107810, "time": "2007-09-06T19:45:01Z", "creator": "basant.kukreja@sun.com", "creation_time": "2007-09-06T19:45:01Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 43310, "attachment_id": 20781, "is_private": false, "id": 107842, "time": "2007-09-07T20:31:54Z", "creator": "basant.kukreja@sun.com", "creation_time": "2007-09-07T20:31:54Z", "text": "Created attachment 20781\nSame patch against trunk.\n\nSame patch as submitted by Sunho kim but patch is against trunk."}, {"count": 4, "tags": [], "bug_id": 43310, "attachment_id": null, "is_private": false, "id": 110466, "time": "2007-11-12T19:04:11Z", "creator": "davi@apache.org", "creation_time": "2007-11-12T19:04:11Z", "text": "A patch for this issue was committed in revision 589461:\n\nhttp://svn.apache.org/viewvc?rev=589461&view=rev"}, {"count": 5, "tags": [], "bug_id": 43310, "attachment_id": null, "id": 111064, "time": "2007-11-24T22:11:48Z", "creator": "takashi.asfbugzilla@tks.st", "creation_time": "2007-11-24T22:11:48Z", "is_private": false, "text": "a backport proposal (2.2.x)\nhttp://svn.apache.org/viewvc?view=rev&revision=589638"}, {"count": 6, "tags": [], "bug_id": 43310, "attachment_id": null, "id": 111584, "time": "2007-12-08T11:34:10Z", "creator": "jim@apache.org", "creation_time": "2007-12-08T11:34:10Z", "is_private": false, "text": "In 2.2.7"}]