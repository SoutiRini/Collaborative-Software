[{"count": 0, "tags": [], "bug_id": 58096, "attachment_id": null, "id": 183867, "time": "2015-07-02T22:41:40Z", "creator": "supermmx@gmail.com", "creation_time": "2015-07-02T22:41:40Z", "is_private": false, "text": "I tried a very simple webapp, with a test.jsp and WEB-INF/classes/test/pkg/Test.class on both Tomcat 7 and Tomcat 8 latest version (with Java 7 and Java 8 respectively)\n\n==== test.jsp ====\nTest: <%= test.pkg.Test.class.getProtectionDomain().getCodeSource().getLocation() %>\n==================\n\nand Tomcat 8 shows\n\nTest: file:/C:/Install/apache-tomcat-8.0.23/webapps/test/WEB-INF/classe/test/pkg/Test.class\n\n\nTomcat 7 shows the similar result.\n\nIn a standalone Java program, the similar code shows the top-level classpath entry like xxx/classes where test/pkg/Test.class is saved.\n\nI also tried Jetty, it shows it correctly like:\n\nTest: file:/C:/Install/jetty-distribution-9.3.0.v20150612/test-base/webapps/test/WEB-INF/classes/\n\n\nSo what I expect is WEB-INF/classes, is there any reason why Tomcat returns the full path of the class file instead of WEB-INF/classes ?\n\nI have a quick fix to get what I want, but not sure whether there are other impacts, at least all unit tests are passed except two TEST-org.apache.catalina.filters.TestRemoteIpFilter.*.\n\nThe fix is here:\n\nhttps://github.com/SuperMMX/tomcat/commit/a96b4a80144f78140690fd35e47d0fdd1a64d0ae"}, {"count": 1, "tags": [], "bug_id": 58096, "attachment_id": null, "id": 183868, "creation_time": "2015-07-02T22:43:10Z", "time": "2015-07-02T22:43:10Z", "creator": "supermmx@gmail.com", "text": "Comment from Mark Thomas:\n\nI've taken a quick look and the issue looks valid. I'm not sure about\nthe proposed fix though. It is almost certainly better to correct the\nvalue returned by getCodeBase() (fix the root cause, not one of the\nsymptoms).", "is_private": false}, {"attachment_id": null, "tags": [], "creator": "supermmx@gmail.com", "is_private": false, "count": 2, "id": 183876, "time": "2015-07-03T05:19:44Z", "bug_id": 58096, "creation_time": "2015-07-03T05:19:44Z", "text": "I create a new fix based on Mark's comment:\n\nhttps://github.com/SuperMMX/tomcat/commit/1e5335629ca48608d59b3bc1247c853920157d46"}, {"count": 3, "tags": [], "text": "Thanks for the patch. I took a slightly different approach which was to use getURL() on the resource obtained for \"/WEB-INF/classes/\".\n\nThe fix has been applied to trunk (for 9.0.x) and to 8.0.x for 8.0.25 onwards.\n\n7.0.x will need a different fix since it uses a different resources implementation.", "attachment_id": null, "id": 183906, "creator": "markt@apache.org", "time": "2015-07-06T10:31:55Z", "bug_id": 58096, "creation_time": "2015-07-06T10:31:55Z", "is_private": false}, {"count": 4, "tags": [], "creator": "markt@apache.org", "is_private": false, "text": "Fixed in 7.0.x as well for 7.0.64 onwards.", "id": 183908, "time": "2015-07-06T13:31:53Z", "bug_id": 58096, "creation_time": "2015-07-06T13:31:53Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 58096, "text": "Thanks, your fix is much better than mine, I need to learn more about Tomcat codebase :)", "count": 5, "id": 183917, "time": "2015-07-06T22:03:55Z", "creator": "supermmx@gmail.com", "creation_time": "2015-07-06T22:03:55Z", "is_private": false}]