[{"count": 0, "attachment_id": null, "creator": "ruediger.pluem@vodafone.com", "is_private": false, "id": 61537, "time": "2004-08-04T13:08:13Z", "bug_id": 30464, "creation_time": "2004-08-04T13:08:13Z", "tags": [], "text": "Hi,\n\n1. Environment:\n\nOS: Linux\nApache: 2.0.50\n\n2. Problem:\n\nAs I upgraded some Apache 1.3.x systems to Apache 2.0.50 I noticed that the\nSSL_ variables defined by mod_ssl are no longer available for checks\nwith RewriteCond.\n\nIn Apache 1.3.x RewriteConds like the following delivered reasonable results:\n\nRewriteCond %{SSL_CIPHER_USEKEYSIZE} !^[0-9][0-9][0-9]\n\nOn Apache 2.0.50 the input stays empty as the following excerpt from\nthe RewriteLog (Level 9) shows:\n\n92.168.2.4 - - [04/Aug/2004:11:57:06 +0200] [www.something.de/sid#8122700][rid#\n818a1b0/initial] (4) RewriteCond: input='' pattern='!^[0-9][0-9][0-9]' => matche\nd\n\nEven after adding SSLOptions +StdEnvVars and modifying the RewriteCond to\n\nRewriteCond %{ENV:SSL_CIPHER_USEKEYSIZE} !^[0-9][0-9][0-9]\n\nnothing changed. The input remains empty.\n\n3. Analysis\n\nThe root cause for this problem is that mod_ssl writes its SSL_ variables\nto r->subprocess_env in its fixup handler (provided SSLOptions contains\nStdEnvVars), but all fixup handlers are executed after the translate_name\nhandlers. On the other hand the evaluation of the rewrite rules happens\nin mod_rewrites translate_name handler, so the variables are not available\nat this point of time.\n\n4. Solution proposal\n\nI noticed that the documentation for mod_rewrite of Apache 2.1 points out\na special prefix for the SSL_ variables named SSL: (like ENV: for environment\nvariables). So the solution approach is to add a piece of code to\nlookup_variable in mod_rewrite.c that checks for variablenames that start with\nSSL: after the check for the variables which names start with ENV:.\nThe mod_ssl function ssl_var_lookup can be used to get the values for the\nspecific variables as it has been registered by mod_ssl with\nAPR_REGISTER_OPTIONAL_FN in ssl_engine_vars.c. After that it would be\npossible to check the SSL_ variables in RewriteCond's via prefixing the\nvariable name with SSL:. For example the following RewriteCond \n\nRewriteCond %{SSL:SSL_CIPHER_USEKEYSIZE} !^[0-9][0-9][0-9]\n\nwould be a replacement for my old (Apache 1.3.x) RewriteCond\n\nRewriteCond %{SSL_CIPHER_USEKEYSIZE} !^[0-9][0-9][0-9]\n\nI wrote an appropriate patch for mod_rewrite which I tested on my environment.\nIt worked as designed. I attach the patch.\n\n\nRegards\n\nR\u00fcdiger Pl\u00fcm"}, {"count": 1, "tags": [], "bug_id": 30464, "attachment_id": 12327, "is_private": false, "id": 61538, "time": "2004-08-04T13:09:03Z", "creator": "ruediger.pluem@vodafone.com", "creation_time": "2004-08-04T13:09:03Z", "text": "Created attachment 12327\nSolution proposal patch"}, {"count": 2, "tags": [], "bug_id": 30464, "attachment_id": null, "is_private": false, "id": 62374, "time": "2004-08-24T08:27:57Z", "creator": "ruediger.pluem@vodafone.com", "creation_time": "2004-08-24T08:27:57Z", "text": "Currently my patch is missing the according patch of the mod_rewrite\ndocumentation. As my patch is a backport (even from the coding point of view as\nI compared my patch and an actual CVS snapshot of Apache 2.1) of the same\nfunctionality offered by Apache 2.1 I simply backported the according paragraph\nfor the Apache 2.1 documentation of mod_rewrite.xml. So the contents of the\ndocumentation patch I will attach has been written by one of the Apache 2.1\nmod_rewrite contributors / authors."}, {"count": 3, "tags": [], "bug_id": 30464, "attachment_id": 12515, "is_private": false, "id": 62375, "time": "2004-08-24T08:28:32Z", "creator": "ruediger.pluem@vodafone.com", "creation_time": "2004-08-24T08:28:32Z", "text": "Created attachment 12515\nDocumentation patch"}, {"count": 4, "tags": [], "bug_id": 30464, "attachment_id": null, "is_private": false, "id": 62385, "time": "2004-08-24T09:40:02Z", "creator": "jorton@redhat.com", "creation_time": "2004-08-24T09:40:02Z", "text": "Thanks for the patch.\n\nThis has been proposed for backport to 2.0.  It can't be done by including\nmod_ssl.h, since that fails if mod_ssl is not enabled in 2.0, so the optional\nfunction declarations have to be duplicated."}, {"count": 5, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "text": "For references, the proposed patches are:\n\nhttp://www.apache.org/~jorton/mod_rewrite-2.0-sslvar.diff\nhttp://www.apache.org/~jorton/mod_ssl-2.0-ishttps.diff", "id": 62387, "time": "2004-08-24T09:42:58Z", "bug_id": 30464, "creation_time": "2004-08-24T09:42:58Z", "is_private": false}, {"count": 6, "tags": [], "creator": "ruediger.pluem@vodafone.com", "attachment_id": null, "text": "Thanks for the feedback and the references. You are right it is not possible to\ninclude mod_ssl.h in Apache 2.0 without enabling it via configure. I did not\nnotice that as I compile my Apache always with mod_ssl. So I included mod_ssl.h\nto avoid the duplication of the optional function declarations.\nIt is nice to hear that this feature should be backported to Apache 2.0. Do you\nalready know a release of Apache 2.0 in which this will be included?", "id": 62389, "time": "2004-08-24T10:32:43Z", "bug_id": 30464, "creation_time": "2004-08-24T10:32:43Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 30464, "attachment_id": null, "is_private": false, "id": 62390, "time": "2004-08-24T11:22:19Z", "creator": "jorton@redhat.com", "creation_time": "2004-08-24T11:22:19Z", "text": "The backport requires votes from two additional developers, so it depends when\npeople have time to review the changes."}, {"count": 8, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "id": 62585, "time": "2004-08-27T14:10:30Z", "bug_id": 30464, "creation_time": "2004-08-27T14:10:30Z", "is_private": false, "text": "Now committed for 2.0.51."}, {"count": 9, "tags": [], "text": "Thats very good news. Thanks.", "is_private": false, "id": 62587, "creator": "ruediger.pluem@vodafone.com", "time": "2004-08-27T14:16:34Z", "bug_id": 30464, "creation_time": "2004-08-27T14:16:34Z", "attachment_id": null}]