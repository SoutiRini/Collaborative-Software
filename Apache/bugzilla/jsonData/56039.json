[{"count": 0, "tags": [], "bug_id": 56039, "attachment_id": 31242, "id": 172567, "time": "2014-01-20T20:33:46Z", "creator": "esengstrom@gmail.com", "creation_time": "2014-01-20T20:33:46Z", "is_private": false, "text": "Created attachment 31242\nPatch against http://svn.apache.org/repos/asf/tomcat/tc7.0.x/trunk\n\nUsing JmxRemoteLifecycleListener with SSL results in the following error on startup:\n\nJan 16, 2014 4:34:20 PM org.apache.catalina.mbeans.JmxRemoteLifecycleListener createServer\nSEVERE: The JMX connector server could not be created or failed to start for the Platform server\njava.io.IOException: Cannot bind to URL [rmi://localhost:1900/jmxrmi]: javax.naming.CommunicationException [Root exception is java.rmi.ConnectIOException: non-JRMP server at remote endpoint]\n        at javax.management.remote.rmi.RMIConnectorServer.newIOException(Unknown Source)\n        at javax.management.remote.rmi.RMIConnectorServer.start(Unknown Source)\n        at org.apache.catalina.mbeans.JmxRemoteLifecycleListener.createServer(JmxRemoteLifecycleListener.java:304)\n        at org.apache.catalina.mbeans.JmxRemoteLifecycleListener.lifecycleEvent(JmxRemoteLifecycleListener.java:258)\n        at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:119)\n        at org.apache.catalina.util.LifecycleBase.fireLifecycleEvent(LifecycleBase.java:90)\n        at org.apache.catalina.util.LifecycleBase.setStateInternal(LifecycleBase.java:402)\n        at org.apache.catalina.util.LifecycleBase.setState(LifecycleBase.java:347)\n        at org.apache.catalina.core.StandardServer.startInternal(StandardServer.java:725)\n        at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:150)\n        at org.apache.catalina.startup.Catalina.start(Catalina.java:691)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)\n        at java.lang.reflect.Method.invoke(Unknown Source)\n        at org.apache.catalina.startup.Bootstrap.start(Bootstrap.java:322)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)\n        at java.lang.reflect.Method.invoke(Unknown Source)\n        at org.apache.commons.daemon.support.DaemonLoader.start(DaemonLoader.java:243)\nCaused by: javax.naming.CommunicationException [Root exception is java.rmi.ConnectIOException: non-JRMP server at remote endpoint]\n        at com.sun.jndi.rmi.registry.RegistryContext.bind(Unknown Source)\n        at com.sun.jndi.toolkit.url.GenericURLContext.bind(Unknown Source)\n        at javax.naming.InitialContext.bind(Unknown Source)\n        at javax.management.remote.rmi.RMIConnectorServer.bind(Unknown Source)\n        ... 20 more\nCaused by: java.rmi.ConnectIOException: non-JRMP server at remote endpoint\n        at sun.rmi.transport.tcp.TCPChannel.createConnection(Unknown Source)\n        at sun.rmi.transport.tcp.TCPChannel.newConnection(Unknown Source)\n        at sun.rmi.server.UnicastRef.newCall(Unknown Source)\n        at sun.rmi.registry.RegistryImpl_Stub.bind(Unknown Source)\n        ... 24 more\n\n\nThe relevant configuration from server.xml:\n\n<Listener className=\"org.apache.catalina.mbeans.JmxRemoteLifecycleListener\" rmiRegistryPortPlatform=\"1900\" rmiServerPortPlatform=\"11900\" />\n\nand java properties:\n\n-Djavax.net.ssl.keyStore=$KEYSTORE -Djavax.net.ssl.keyStorePassword=$KEY_PASS -Dcom.sun.management.jmxremote.ssl.need.client.auth=true -Djavax.net.ssl.trustStore=$TRUSTSTORE -Djavax.net.ssl.trustStorePassword=$TRUST_PASS -Dcom.sun.management.jmxremote.registry.ssl=true -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Djava.rmi.server.hostname=$HOST_IP -Dcom.sun.management.jmxremote.ssl=true\n\nIf com.sun.management.jmxremote.ssl is changed to false everything works as expected except without SSL.\n\nLooking at the source code, I there is a property missing from the environment:\n\n env.put(\"com.sun.jndi.rmi.factory.socket\", csf);\n\nAdding this to JmxRemoteLifecycleListener allows SSL to work properly.\n\nPatch attatched."}, {"count": 1, "text": "Thanks for the report and the patch. The patch has been applied to 8.0.x for 8.0.0 onwards and to 7.0.x for 7.0.51 onwards.", "bug_id": 56039, "attachment_id": null, "id": 172647, "time": "2014-01-23T21:25:53Z", "creator": "markt@apache.org", "creation_time": "2014-01-23T21:25:53Z", "tags": [], "is_private": false}]