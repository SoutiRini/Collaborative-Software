[{"count": 0, "tags": [], "text": "Created attachment 34872\nAdd expires parameters in Apache-issued cookies\n\nap_cookie_write() sets a cookie with an optional max-age parameter. Unfortunately, Microsoft Internet Explorer and Edge browsers do not support max-age and will only consider the expires property.\n\nThe attached patch adds an expires property matching max-age, so that cookies set with ap_cookie_write() behave the same way on all browsers.", "attachment_id": 34872, "bug_id": 60908, "id": 197956, "time": "2017-03-24T04:33:21Z", "creator": "manu@netbsd.org", "creation_time": "2017-03-24T04:33:21Z", "is_private": false}, {"count": 1, "tags": [], "text": "Comment on attachment 34872\nAdd expires parameters in Apache-issued cookies\n\n>Index: server/util_cookies.c\n>===================================================================\n>--- server/util_cookies.c\t(revision 1788360)\n>+++ server/util_cookies.c\t(working copy)\n>@@ -35,7 +35,8 @@\n>  * @param val The value to place in the cookie.\n>  * @param attrs The string containing additional cookie attributes. If NULL, the\n>  *              DEFAULT_ATTRS will be used.\n>- * @param maxage If non zero, a Max-Age header will be added to the cookie.\n>+ * @param maxage If non zero, Max-Age and derived Expires header will be \n>+                 added to the cookie.\n>  */\n> AP_DECLARE(apr_status_t) ap_cookie_write(request_rec * r, const char *name, const char *val,\n>                                          const char *attrs, long maxage, ...)\n>@@ -49,7 +50,12 @@\n>     /* handle expiry */\n>     buffer = \"\";\n>     if (maxage) {\n>+        char expires[APR_RFC822_DATE_LEN];\n>+\n>         buffer = apr_pstrcat(r->pool, \"Max-Age=\", apr_ltoa(r->pool, maxage), \";\", NULL);\n>+\n>+        if (apr_rfc822_date(expires, apr_time_now() + apr_time_from_sec(maxage)) == APR_SUCCESS)\n>+            buffer = apr_pstrcat(r->pool, buffer, \"Expires=\", expires, \";\", NULL);\n>     }\n> \n>     /* create RFC2109 compliant cookie */\n>@@ -124,6 +130,7 @@\n> \n>     /* create RFC2109 compliant cookie */\n>     const char *rfc2109 = apr_pstrcat(r->pool, name, \"=;Max-Age=0;\",\n>+                                \"Expires=Thu, 01-Jan-1970 01:00:00 GMT;\",\n>                                 attrs ? attrs : CLEAR_ATTRS, NULL);\n>     ap_log_rerror(APLOG_MARK, APLOG_DEBUG, 0, r, APLOGNO(00009) LOG_PREFIX\n>                   \"user '%s' removed cookie: '%s'\", r->user, rfc2109);", "attachment_id": 34872, "bug_id": 60908, "id": 197957, "time": "2017-03-24T04:34:20Z", "creator": "manu@netbsd.org", "creation_time": "2017-03-24T04:34:20Z", "is_private": false}]