[{"count": 0, "tags": [], "text": "Created attachment 30062\nPatch to address issue\n\nIf an endpoint is configured with a custom ServerEndpointConfig.Configurator, the modifyHandshake() method never gets called. Other methods do, but this one does not. I have attached a patch to revise this.", "attachment_id": 30062, "bug_id": 54715, "id": 165945, "time": "2013-03-18T05:43:22Z", "creator": "nicholas@nicholaswilliams.net", "creation_time": "2013-03-18T05:43:22Z", "is_private": false}, {"text": "Thanks for the patch. I didn't apply it as is but used it as a guide / reference while I went through and made broadly the same changes but with some differences:\n1. WsHandshakeResponse added a no-arg constructor\n2. Session.userProperties. I kept this as a ConcurrentHashMap to protect against user implementations of EndpointConfig that don't use ConcurrentHashMap\n3. WsHandshakeRequest. Wrapped the request, moved logic from WsServlet and added protection against a developer retaining a reference to the HandshakeRequest.\n4. WsServlet/WsHandshakeResponse This is only for inserting headers not inspecting/modifying existing headers.", "tags": [], "creator": "markt@apache.org", "is_private": false, "count": 1, "id": 165988, "time": "2013-03-19T13:00:36Z", "bug_id": 54715, "creation_time": "2013-03-19T13:00:36Z", "attachment_id": null}, {"count": 2, "tags": [], "text": "There's only one problem I see: The implementations of getRequestURI, getParameterMap and getHeaders, according to your comment, all assume they only get called zero or one times, and so all calculate their values on-the-fly. However, all three of these methods DO get called in WsProtocolHandler when it creates a new WsSession, so they are already called at least once. If the developer also calls them, they will get called TWICE. Plus, I've been known (and I've seen it plenty of other places, too), to do something like this, instead of creating a local reference:\n\nrequest.getParameterMap().get(\"var1\")\nrequest.getParameterMap().get(\"var2\")\nrequest.getParameterMap().get(\"var3\")\n\nThis could get very inefficient fast.\n\nI think the values these three methods return should be calculated only once, no matter how many times they are called.", "is_private": false, "bug_id": 54715, "id": 165989, "time": "2013-03-19T13:20:34Z", "creator": "nicholas@nicholaswilliams.net", "creation_time": "2013-03-19T13:20:34Z", "attachment_id": null}, {"count": 3, "tags": [], "text": "The unit tests already picked that up. Fix has been applied.", "is_private": false, "id": 165991, "creator": "markt@apache.org", "time": "2013-03-19T13:30:53Z", "bug_id": 54715, "creation_time": "2013-03-19T13:30:53Z", "attachment_id": null}, {"count": 4, "tags": [], "text": "About half the unit tests started failing because the request URI was null when the processing reached the WsProtocolHandler. Even though I had forgotten to call finish(), the HttpServletRequest has been recycled by that point.", "is_private": false, "bug_id": 54715, "id": 165992, "time": "2013-03-19T13:55:48Z", "creator": "markt@apache.org", "creation_time": "2013-03-19T13:55:48Z", "attachment_id": null}, {"count": 5, "tags": [], "creator": "nicholas@nicholaswilliams.net", "attachment_id": null, "text": "Nice! :-)", "id": 165996, "time": "2013-03-19T14:50:33Z", "bug_id": 54715, "creation_time": "2013-03-19T14:50:33Z", "is_private": false}]