[{"count": 0, "tags": [], "bug_id": 51884, "attachment_id": null, "text": "When Apache attempts to load a page where PHP makes any LDAP calls (ldap_connect is typically the function that leads to failure here), the child process (or main process in no-thread mode) throws a segmentation fault and dies.  I wrote a test PHP script to connect to our LDAP server and pull down some basic information.  Apache segfaults when I load this page as well, but if I run this directly through PHP's CLI parser, it succeeds immediately.  As far as I can tell, my config is proper.  Upon failure, the error reported by all browsers I've tested is an HTTP 324 (ERR_EMPTY_RESPONSE).\n\nRunning on Solaris 10 with the latest patches applied.  httpd is version 2.2.21, compiled from source.  Here are my configure strings:\n\nOpenLDAP 2.4.23: ./configure --prefix=/opt/utsawebstack/lib/ --disable-slapd --disable-slurpd\n\nApache httpd 2.2.21: ./configure --prefix=/opt/utsawebstack/apache2 --with-ldap --enable-auth-ldap=shared --enable-ldap=shared --enable-headers=shared --enable-mime-magic=shared --enable-proxy=shared --enable-rewrite=shared --enable-mods-shared --enable-ssl=shared --with-z=/opt/utsawebstack/lib\n\nPHP 5.3.8: ./configure --prefix=/opt/utsawebstack/php --with-apxs2=/opt/utsawebstack/apache2/bin/apxs --with-zlib=/opt/utsawebstack/lib --with-curl=/opt/utsawebstack/lib --with-iconv=/opt/utsawebstack/lib --with-ldap=/opt/utsawebstack/lib --enable-calendar --with-mysql=mysqlnd --with-mysqli=mysqlnd --enable-sockets --enable-zip --with-pear -with-mcrypt=/opt/utsawebstack/lib --enable-mbstring\n\n### Single User Mode -> load test script\n# ./httpd -X\nhttpd: Could not reliably determine the server's fully qualified domain name, using 10.9.11.163 for ServerName\nSegmentation Fault\n\n### error_log output with 'LogLevel debug'\n### This output comes from a test where I launch httpd\n### load the failing test page, then stop httpd\n\n\n[Fri Sep 23 09:38:43 2011] [info] Init: Seeding PRNG with 136 bytes of entropy\n[Fri Sep 23 09:38:43 2011] [info] Init: Generating temporary RSA private keys (512/1024 bits)\n[Fri Sep 23 09:38:43 2011] [info] Init: Generating temporary DH parameters (512/1024 bits)\n[Fri Sep 23 09:38:43 2011] [debug] ssl_scache_dbm.c(408): Inter-Process Session Cache (DBM) Expiry: old: 0, new: 0, removed: 0\n[Fri Sep 23 09:38:43 2011] [info] Init: Initializing (virtual) servers for SSL\n[Fri Sep 23 09:38:43 2011] [info] mod_ssl/2.2.21 compiled against Server: Apache/2.2.21, Library: OpenSSL/0.9.7d\n[Fri Sep 23 09:38:43 2011] [debug] util_ldap.c(1990): LDAP merging Shared Cache conf: shm=0x812ff30 rmm=0x812ff60 for VHOST: stacker.it.utsa.edu\n[Fri Sep 23 09:38:43 2011] [debug] util_ldap.c(1990): LDAP merging Shared Cache conf: shm=0x812ff30 rmm=0x812ff60 for VHOST: stacker.it.utsa.edu\n[Fri Sep 23 09:38:43 2011] [info] APR LDAP: Built with Sun Microsystems Inc. LDAP SDK\n[Fri Sep 23 09:38:43 2011] [info] LDAP: SSL support unavailable: LDAP: ldapssl_client_init() failed.\n[Fri Sep 23 09:38:43 2011] [info] Init: Seeding PRNG with 136 bytes of entropy\n[Fri Sep 23 09:38:43 2011] [info] Init: Generating temporary RSA private keys (512/1024 bits)\n[Fri Sep 23 09:38:43 2011] [info] Init: Generating temporary DH parameters (512/1024 bits)\n[Fri Sep 23 09:38:43 2011] [debug] ssl_scache_dbm.c(408): Inter-Process Session Cache (DBM) Expiry: old: 0, new: 0, removed: 0\n[Fri Sep 23 09:38:43 2011] [info] Init: Initializing (virtual) servers for SSL\n[Fri Sep 23 09:38:43 2011] [info] mod_ssl/2.2.21 compiled against Server: Apache/2.2.21, Library: OpenSSL/0.9.7d\n[Fri Sep 23 09:38:43 2011] [warn] pid file /opt/utsawebstack/apache2/logs/httpd.pid overwritten -- Unclean shutdown of previous Apache run?\n[Fri Sep 23 09:38:43 2011] [debug] proxy_util.c(1818): proxy: grabbed scoreboard slot 0 in child 19842 for worker proxy:reverse\n[Fri Sep 23 09:38:43 2011] [debug] proxy_util.c(1934): proxy: initialized single connection worker 0 in child 19842 for (*)\n[Fri Sep 23 09:38:43 2011] [debug] proxy_util.c(1818): proxy: grabbed scoreboard slot 0 in child 19843 for worker proxy:reverse\n[Fri Sep 23 09:38:43 2011] [debug] proxy_util.c(1837): proxy: worker proxy:reverse already initialized\n[Fri Sep 23 09:38:43 2011] [debug] proxy_util.c(1934): proxy: initialized single connection worker 0 in child 19843 for (*)\n[Fri Sep 23 09:38:43 2011] [debug] proxy_util.c(1818): proxy: grabbed scoreboard slot 0 in child 19844 for worker proxy:reverse\n[Fri Sep 23 09:38:43 2011] [debug] proxy_util.c(1837): proxy: worker proxy:reverse already initialized\n[Fri Sep 23 09:38:43 2011] [debug] proxy_util.c(1934): proxy: initialized single connection worker 0 in child 19844 for (*)\n[Fri Sep 23 09:38:43 2011] [notice] Apache/2.2.21 (Unix) mod_ssl/2.2.21 OpenSSL/0.9.7d PHP/5.3.8 configured -- resuming normal operations\n[Fri Sep 23 09:38:43 2011] [info] Server built: Sep 22 2011 16:58:51\n[Fri Sep 23 09:38:43 2011] [debug] prefork.c(1023): AcceptMutex: pthread (default: pthread)\n[Fri Sep 23 09:38:43 2011] [debug] proxy_util.c(1818): proxy: grabbed scoreboard slot 0 in child 19845 for worker proxy:reverse\n[Fri Sep 23 09:38:43 2011] [debug] proxy_util.c(1837): proxy: worker proxy:reverse already initialized\n[Fri Sep 23 09:38:43 2011] [debug] proxy_util.c(1934): proxy: initialized single connection worker 0 in child 19845 for (*)\n[Fri Sep 23 09:38:43 2011] [debug] proxy_util.c(1818): proxy: grabbed scoreboard slot 0 in child 19846 for worker proxy:reverse\n[Fri Sep 23 09:38:43 2011] [debug] proxy_util.c(1837): proxy: worker proxy:reverse already initialized\n[Fri Sep 23 09:38:43 2011] [debug] proxy_util.c(1934): proxy: initialized single connection worker 0 in child 19846 for (*)\n[Fri Sep 23 09:38:48 2011] [debug] proxy_util.c(1818): proxy: grabbed scoreboard slot 0 in child 19851 for worker proxy:reverse\n[Fri Sep 23 09:38:48 2011] [debug] proxy_util.c(1837): proxy: worker proxy:reverse already initialized\n[Fri Sep 23 09:38:48 2011] [debug] proxy_util.c(1934): proxy: initialized single connection worker 0 in child 19851 for (*)\n[Fri Sep 23 09:38:48 2011] [info] removed PID file /opt/utsawebstack/apache2/logs/httpd.pid (pid=19841)\n[Fri Sep 23 09:38:48 2011] [notice] caught SIGTERM, shutting down\n[Fri Sep 23 09:38:48 2011] [info] Init: Seeding PRNG with 136 bytes of entropy\n[Fri Sep 23 09:38:48 2011] [info] Init: Generating temporary RSA private keys (512/1024 bits)\n[Fri Sep 23 09:38:48 2011] [info] Init: Generating temporary DH parameters (512/1024 bits)\n[Fri Sep 23 09:38:48 2011] [debug] ssl_scache_dbm.c(408): Inter-Process Session Cache (DBM) Expiry: old: 0, new: 0, removed: 0\n[Fri Sep 23 09:38:48 2011] [info] Init: Initializing (virtual) servers for SSL\n[Fri Sep 23 09:38:48 2011] [info] mod_ssl/2.2.21 compiled against Server: Apache/2.2.21, Library: OpenSSL/0.9.7d\n[Fri Sep 23 09:38:48 2011] [debug] util_ldap.c(1990): LDAP merging Shared Cache conf: shm=0x812ff30 rmm=0x812ff60 for VHOST: stacker.it.utsa.edu\n[Fri Sep 23 09:38:48 2011] [debug] util_ldap.c(1990): LDAP merging Shared Cache conf: shm=0x812ff30 rmm=0x812ff60 for VHOST: stacker.it.utsa.edu\n[Fri Sep 23 09:38:48 2011] [info] APR LDAP: Built with Sun Microsystems Inc. LDAP SDK\n[Fri Sep 23 09:38:48 2011] [info] LDAP: SSL support unavailable: LDAP: ldapssl_client_init() failed.\n[Fri Sep 23 09:38:48 2011] [info] Init: Seeding PRNG with 136 bytes of entropy\n[Fri Sep 23 09:38:48 2011] [info] Init: Generating temporary RSA private keys (512/1024 bits)\n[Fri Sep 23 09:38:48 2011] [info] Init: Generating temporary DH parameters (512/1024 bits)\n[Fri Sep 23 09:38:48 2011] [debug] ssl_scache_dbm.c(408): Inter-Process Session Cache (DBM) Expiry: old: 0, new: 0, removed: 0\n[Fri Sep 23 09:38:48 2011] [info] Init: Initializing (virtual) servers for SSL\n[Fri Sep 23 09:38:48 2011] [info] mod_ssl/2.2.21 compiled against Server: Apache/2.2.21, Library: OpenSSL/0.9.7d\n[Fri Sep 23 09:38:48 2011] [debug] proxy_util.c(1818): proxy: grabbed scoreboard slot 0 in child 19857 for worker proxy:reverse\n[Fri Sep 23 09:38:48 2011] [debug] proxy_util.c(1934): proxy: initialized single connection worker 0 in child 19857 for (*)\n[Fri Sep 23 09:38:48 2011] [debug] proxy_util.c(1818): proxy: grabbed scoreboard slot 0 in child 19858 for worker proxy:reverse\n[Fri Sep 23 09:38:48 2011] [debug] proxy_util.c(1837): proxy: worker proxy:reverse already initialized\n[Fri Sep 23 09:38:48 2011] [debug] proxy_util.c(1934): proxy: initialized single connection worker 0 in child 19858 for (*)\n[Fri Sep 23 09:38:48 2011] [notice] Apache/2.2.21 (Unix) mod_ssl/2.2.21 OpenSSL/0.9.7d PHP/5.3.8 configured -- resuming normal operations\n[Fri Sep 23 09:38:48 2011] [info] Server built: Sep 22 2011 16:58:51\n[Fri Sep 23 09:38:48 2011] [debug] prefork.c(1023): AcceptMutex: pthread (default: pthread)\n[Fri Sep 23 09:38:48 2011] [debug] proxy_util.c(1818): proxy: grabbed scoreboard slot 0 in child 19859 for worker proxy:reverse\n[Fri Sep 23 09:38:48 2011] [debug] proxy_util.c(1837): proxy: worker proxy:reverse already initialized\n[Fri Sep 23 09:38:48 2011] [debug] proxy_util.c(1934): proxy: initialized single connection worker 0 in child 19859 for (*)\n[Fri Sep 23 09:38:48 2011] [debug] proxy_util.c(1818): proxy: grabbed scoreboard slot 0 in child 19860 for worker proxy:reverse\n[Fri Sep 23 09:38:48 2011] [debug] proxy_util.c(1837): proxy: worker proxy:reverse already initialized\n[Fri Sep 23 09:38:48 2011] [debug] proxy_util.c(1934): proxy: initialized single connection worker 0 in child 19860 for (*)\n[Fri Sep 23 09:38:48 2011] [debug] proxy_util.c(1818): proxy: grabbed scoreboard slot 0 in child 19861 for worker proxy:reverse\n[Fri Sep 23 09:38:48 2011] [debug] proxy_util.c(1837): proxy: worker proxy:reverse already initialized\n[Fri Sep 23 09:38:48 2011] [debug] proxy_util.c(1934): proxy: initialized single connection worker 0 in child 19861 for (*)\n[Fri Sep 23 09:38:56 2011] [info] removed PID file /opt/utsawebstack/apache2/logs/httpd.pid (pid=19856)\n[Fri Sep 23 09:38:56 2011] [notice] caught SIGTERM, shutting down\n\nAny ideas?", "id": 149698, "time": "2011-09-23T14:45:19Z", "creator": "gradysghost@gmail.com", "creation_time": "2011-09-23T14:45:19Z", "is_private": false}, {"count": 1, "tags": [], "text": "It looks like you build Apache against Solaris LDAP and PHP against OpenLDAP. When running the Apache with PHP, the runtime linker will first load system LDAP (the Apache dependency) and then OpenLDAP (when loading the PHP module).\n\nNow when calling actual LDAP functions from within mod_php, the runtime linker will not resolve the symbols first in OpenLDAP, but will search all libs in the original loading order, so system LDAP first. If it finds a symbol there, it will use it there, if not then in OpenLDAP. This can easily lead to inconsistencies and crashes.\n\nCheck, whether it is true, that your Apache including mod_php loads different versions of LDAP. Use e.g. Solaris \"pldd\". Then try to produce a core for the crash and check with \"pstack\" or a debugger, where the crash happens, e.g. if it happens inside an LDAP function. If so, the above situation is likely the culprit.\n\nThink about building PHP against the system LDAP. As an alternative, you can try the so-called \"direct\" linking (linker flag -Bdirect), which changes the runtime linker search order. But that might lead to a tedious exercise in changing build files.\n\nRegards,\n\nRainer", "is_private": false, "bug_id": 51884, "id": 149703, "time": "2011-09-23T15:16:26Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2011-09-23T15:16:26Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 51884, "attachment_id": null, "text": "As I have nothing to do except fix this, I will try your suggestion.  Is there a way to compile Apache against OpenLDAP?  For the project I'm working on, it's best if the LDAP libraries are packaged with the rest of this web stack.  I have tried using --with-ldap=/opt/utsawebstack/lib/lib (where OpenLDAP libs end up after their compilation), but I think that failed to build.  I will reattempt that as well.", "id": 149705, "time": "2011-09-23T15:32:14Z", "creator": "gradysghost@gmail.com", "creation_time": "2011-09-23T15:32:14Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 51884, "attachment_id": null, "text": "My experience says that's hard to do, because some of the system libs needed by Apache themselves will load sytem LDAP.", "id": 149706, "time": "2011-09-23T15:50:30Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2011-09-23T15:50:30Z", "is_private": false}, {"count": 4, "tags": [], "creator": "wrowe@apache.org", "is_private": false, "text": "Bugzilla is not a support forum; users@httpd.apache.org or php's users or \ninstallation mailing lists are.\n\nhttp://php.net/mailing-lists.php\nhttp://httpd.apache.org/lists.html#http-users", "id": 149708, "time": "2011-09-23T16:35:15Z", "bug_id": 51884, "creation_time": "2011-09-23T16:35:15Z", "attachment_id": null}, {"count": 5, "tags": [], "creator": "gradysghost@gmail.com", "is_private": false, "text": "William, you're absolutely right.  I apologize for going to the wrong place.  This is the last you'll hear from me on this thread, but just in case Google returns this page for others with this problem, I'm going to post the solution I found.  Hope you don't mind.\n\nBasically, I mistakenly assumed that the --with-ldap configure argument would accept a directory to look for the OpenLDAP libs in.  It does not.  I used --with-ldap with no directory attached to it in conjunction with --with-ldap-libs=/my/openldap/lib/dir and --with-ldap-include=/my/openldap/include/dir\n\nFound the solution in some random RedHat forum out there.  Anyway, thanks for the help, guys.", "id": 149920, "time": "2011-09-28T16:18:58Z", "bug_id": 51884, "creation_time": "2011-09-28T16:18:58Z", "attachment_id": null}]