[{"count": 0, "tags": [], "creator": "dimitris@watchmouse.com", "text": "Created attachment 25715\npatch for correcting the parent's \"size in bytes\" when following redirections\n\nUsing an HttpRequest Sampler on a url that redirects but also returns some body message next to the 30x headers, gives wrong size in bytes.\n\nMore precise, the \"parent\" http sample gets a value in \"size in bytes\" equal to 2x[initial request] + [size of the rest subrequests]\n\nThis issue has been addressed quite some time ago (http://www.mail-archive.com/jmeter-user@jakarta.apache.org/msg25592.html) by one of my colleagues (Mr. Pieter Ennes, WatchMouse.com) but it has not been fixed yet (checked in version 2.3.4).\n\nWe have located the root cause of this problem and it resides in the class src/core/org/apache/jmeter/samplers/SampleResult.java. The constructor \"SampleResult(SampleResult res)\", clones the initial result to a \"Parent\" result object and sets it as the child of the Parent.\nDuring this cloning the following piece of code causes some trouble:\n\n<code>\npublic SampleResult(SampleResult res) {\n...\nsetResponseData(res.getResponseData());\n...\n...\naddSubResult(res); // this will add res.getTime() to getTime().\n...\n</code>\n\nThe invocation of addSubResult in the code above does this: setBytes(getBytes() + subResult.getBytes()); which sets the bytes of the parent to 2x[size of initial subresult].\n\nOf course that is if the initial request has some body message and not just the headers with the 30x response. \nAlthough it's common that 30x response have no message body, it is not always the case. And I think JMeter should give fine figures at all times.\n\n\nIn the patch attached to this report, I have replaced this invocation with this code:\n\n<code>\nString tn = getThreadName();\nif (tn.length()==0) {\n    tn=Thread.currentThread().getName();//TODO do this more efficiently\n    this.setThreadName(tn);\n}\nres.setThreadName(tn);\nif (subResults == null) {\n    subResults = new ArrayList<SampleResult>();\n}\nsubResults.add(res);\n// Extend the time to the end of the added sample\nsetEndTime(res.getEndTime());\n// Include the byte count for the added sample\nsetBytes(res.getBytes());\nres.setParent(this);\n</code>\n\n\nwhich is the code of the function addSubResult but stripping out the \"getBytes()\" part.\n\nThis patch has been tested over several scripts and gave fine results.\nPlease give it a look as you might find it useful; if so, please add it in a next release.", "id": 138219, "time": "2010-07-06T12:39:31Z", "bug_id": 49560, "creation_time": "2010-07-06T12:39:31Z", "is_private": false, "attachment_id": 25715}, {"count": 1, "tags": [], "text": "There are two different usages for the constructor \n   SampleResult(SampleResult res)\n- following redirects\n- downloading page resources\n\nI agree it seems wrong the way the sub-results are added currently, but I'm not yet sure of the best solution. Possibly the constructor should only create a clone of itself, and not add itself as a sub-result. The calling code would need to be changed accordingly, but would be easier to understand.\n\nOther samplers that call addSubResult() do so directly; it only seems to be the HTTP samplers that use the copy constructor.\n\nIs there a public URL that could be used to test against?", "is_private": false, "id": 138256, "creator": "sebb@apache.org", "time": "2010-07-07T11:11:52Z", "bug_id": 49560, "creation_time": "2010-07-07T11:11:52Z", "attachment_id": null}, {"count": 2, "attachment_id": null, "bug_id": 49560, "text": "Just noticed - google's redirect response includes text, so that can be used for testing.", "id": 138257, "time": "2010-07-07T11:14:58Z", "creator": "sebb@apache.org", "creation_time": "2010-07-07T11:14:58Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "text": "I've reworked the copy constructor to do a real copy and fixed the bytes problem (I hope!) In the process, the latency was also fixed for redirects.\n\nURL: http://svn.apache.org/viewvc?rev=961539&view=rev\nLog:\nBug 49560 - wrong \"size in bytes\" when following redirections\n\nModified:\n   jakarta/jmeter/trunk/src/core/org/apache/jmeter/samplers/SampleResult.java\n   jakarta/jmeter/trunk/src/protocol/http/org/apache/jmeter/protocol/http/sampler/HTTPSamplerBase.java\n   jakarta/jmeter/trunk/xdocs/changes.xml\n   jakarta/jmeter/trunk/xdocs/usermanual/component_reference.xml\n\nThe code will be in nightlies after r961539 - if possible, please could you try one and report back?\n\nThanks!", "is_private": false, "bug_id": 49560, "id": 138262, "time": "2010-07-07T19:59:04Z", "creator": "sebb@apache.org", "creation_time": "2010-07-07T19:59:04Z", "attachment_id": null}, {"count": 4, "tags": [], "creator": "dimitris@watchmouse.com", "text": "Hi Sebb,\n\nI've just svn up-ed my working copy to the HEAD revision and it looks nice!\nMany thanks for this quick fix!\n\nI have once more question though; I am wondering why did you set the latency of the parent to the latency of the first child? Shouldn't you count the overhead of the redirections in that figure?\n\nI would think that the latency of the parent element is from START until the first byte of the FINAL (landing) page.\n\nThanks again!", "id": 138268, "time": "2010-07-08T02:06:15Z", "bug_id": 49560, "creation_time": "2010-07-08T02:06:15Z", "is_private": false, "attachment_id": null}, {"count": 5, "attachment_id": null, "bug_id": 49560, "text": "In the case of \"download embedded\", latency should definitely only be time to first response of parent page, but then the parent page is the first to be downloaded anyway.\n\nIn the case of redirects, it's not so clear-cut, but I still think it makes sense to stick with the intial redirect latency, as that is how quickly the server has responded to the original request.", "id": 138271, "time": "2010-07-08T05:09:59Z", "creator": "sebb@apache.org", "creation_time": "2010-07-08T05:09:59Z", "tags": [], "is_private": false}, {"count": 6, "attachment_id": null, "bug_id": 49560, "text": "hmm..indeed it's not so clear in case of redirects..\nMaybe an \"overall_latency\" figure would make sense here.\n\nAnyways, thanks again for the fix!", "id": 138277, "time": "2010-07-08T11:41:41Z", "creator": "dimitris@watchmouse.com", "creation_time": "2010-07-08T11:41:41Z", "tags": [], "is_private": false}]