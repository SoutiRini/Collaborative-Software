[{"count": 0, "tags": [], "creator": "adrian.sandu@asandu.eu", "attachment_id": 33843, "text": "Created attachment 33843\nlogs\n\nUsing gentoo, I got the latest (2.4.20) apache, with latest mod_lua ( compiled separately ) and mod_http2 ( compiled with apache ).\n\nI got the following 10_mod_lua.conf\n```\n<IfDefine LUA>\nLoadModule lua_module         modules/mod_lua.so\nAddHandler lua-script .lua\nLogLevel mod_lua.c:debug\nLuaScope thread\nLuaCodeCache stat\nLuaRoot /etc/apache2/lua_scripts/\nLuaHookAccessChecker authcheck_hook.lua authcheck_hook\n</IfDefine>\n```\n\n41_mod_http2.conf\n```\n<IfDefine SSL>\n  <IfModule http2_module>\n    LogLevel http2:debug\n    Protocols h2 http/1.1\n  </IfModule>\n</IfDefine>\n```\n\nand the authcheck_hook.lua script\n```\nprocesshostnames = { 'd3xbucharest.go.ro', '192.168.1.95', 'd3xt3r01.tk' }\n\nfunction authcheck_hook(r)\n        if r.uri == \"/favicon.ico\" then return apache2.DECLINED end\n\n        processhostname = false\n        for key,value in pairs(processhostnames) do\n                if r.hostname == value then\n                        processhostname = true\n                        break\n                end\n        end\n        if not processhostname then\n                return apache2.DECLINED\n        end\n\n        return apache2.OK\nend\n```\n\nDisabling either mod_lua or mod_http2 works.\n\nI've created a test page like this:\nindex.php\n```\nIT WORKS\n<?php\nif(isset($_GET['frame'])){\n        echo \"FRAME \".$_GET['frame'];\n        die();\n}\nfor($i=0;$i<30;$i++){\n        echo '<iframe src=\"index.php?frame='.$i.'\"></iframe>';\n}\n```\nNothing special, just some frames with text. The result is that some frames load, some show an internal error .. some crash completely. Not always in the same order or on the same frames.", "id": 190941, "time": "2016-05-13T12:46:38Z", "bug_id": 59542, "creation_time": "2016-05-13T12:46:38Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 59542, "text": "Looks like there is currently no setting of c->current_thread in h2 but there used to be (my cscope had one before I re-ran). Stefan, do you recall when it was dropped?  May be relevant to the PR.\n\nAdrian, you could try probably any other LuaScope for relief.", "id": 190950, "time": "2016-05-13T13:05:07Z", "creator": "covener@gmail.com", "creation_time": "2016-05-13T13:05:07Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 59542, "text": "@eric I have no idea what you're sayin' ! :) I could try what ?", "id": 190951, "time": "2016-05-13T13:26:40Z", "creator": "adrian.sandu@asandu.eu", "creation_time": "2016-05-13T13:26:40Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 59542, "attachment_id": null, "id": 190952, "time": "2016-05-13T13:31:15Z", "creator": "covener@gmail.com", "creation_time": "2016-05-13T13:31:15Z", "is_private": false, "text": "(In reply to Adrian Sandu from comment #2)\n> @eric I have no idea what you're sayin' ! :) I could try what ?\n\nYour conf has:\n\n  LuaScope thread\n\nI suspect it might be broken with h2, but the other options would not be. e.g. \"LuaScope server\""}, {"count": 4, "tags": [], "bug_id": 59542, "attachment_id": null, "id": 190953, "time": "2016-05-13T13:57:54Z", "creator": "adrian.sandu@asandu.eu", "creation_time": "2016-05-13T13:57:54Z", "is_private": false, "text": "@eric .. yep, works ! Thanks."}, {"count": 5, "tags": [], "bug_id": 59542, "attachment_id": null, "id": 190963, "time": "2016-05-13T18:50:21Z", "creator": "adrian.sandu@asandu.eu", "creation_time": "2016-05-13T18:50:21Z", "is_private": false, "text": "*** Bug 59370 has been marked as a duplicate of this bug. ***"}, {"count": 6, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "text": "I was able to generate my own errors with a dummy LuaTranslateName and \"LuaScope thread\". This seemed to do the trick, but I can't tell for sure if tasks might jump h2 threads over time.\n\nIndex: modules/http2/h2_worker.c\n===================================================================\n--- modules/http2/h2_worker.c   (revision 1743942)\n+++ modules/http2/h2_worker.c   (working copy)\n@@ -42,7 +42,8 @@\n         /* Get a h2_task from the main workers queue. */\n         worker->get_next(worker, worker->ctx, &task, &sticky);\n         while (task) {\n-        \n+            task->c->current_thread = thread; \n+\n             h2_task_do(task);\n             /* report the task done and maybe get another one from the same\n              * mplx (= master connection), if we can be sticky.", "id": 190976, "time": "2016-05-15T19:11:55Z", "bug_id": 59542, "creation_time": "2016-05-15T19:11:55Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 59542, "attachment_id": null, "id": 191011, "time": "2016-05-17T08:04:26Z", "creator": "stefan@eissing.org", "creation_time": "2016-05-17T08:04:26Z", "is_private": false, "text": "Added slightly modified to trunk in r1744203. Can you verify if this fixes the problem for you? Thanks!"}, {"count": 8, "tags": [], "bug_id": 59542, "text": "Yep, all seems great now !\nThanks !", "id": 191055, "time": "2016-05-18T15:39:03Z", "creator": "adrian.sandu@asandu.eu", "creation_time": "2016-05-18T15:39:03Z", "is_private": false, "attachment_id": null}]