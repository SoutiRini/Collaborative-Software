[{"count": 0, "attachment_id": null, "creator": "DRuggeri@primary.net", "text": "I have detected what appears to be a regression in 8.5.20 with JSSE keystores since 8.5.16. With my limited understanding I'm unable to pinpoint the exact cause to a certainty after poking around a bit, so I thought I'd pass what info I have along and get some thoughts.\n\nBelow is the error message I am getting:\n21-Aug-2017 15:01:57.989 SEVERE [main] org.apache.catalina.core.StandardService.initInternal Failed to initialize connector [Connector[Http11Nio2ProtocolCryptovault-25005\n]]\n org.apache.catalina.LifecycleException: Failed to initialize component [Connector[Http11Nio2ProtocolCryptovault-25005]]\n        at org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:112)\n        at org.apache.catalina.core.StandardService.initInternal(StandardService.java:549)\n        at org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n        at org.apache.catalina.core.StandardServer.initInternal(StandardServer.java:875)\n        at org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n        at org.apache.catalina.startup.Catalina.load(Catalina.java:607)\n        at org.apache.catalina.startup.Catalina.load(Catalina.java:630)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:49\n        at org.apache.catalina.startup.Bootstrap.load(Bootstrap.java:311)\n        at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:494)\nCaused by: org.apache.catalina.LifecycleException: Protocol handler initialization failed\n        at org.apache.catalina.connector.Connector.initInternal(Connector.java:999)\n        at org.apache.catalina.util.LifecycleBase.init(LifecycleBase.java:107)\n        ... 12 more\nCaused by: java.lang.IllegalArgumentException: java.security.KeyStoreException: Cannot get key bytes, not PKCS#8 encoded\n        at org.apache.tomcat.util.net.AbstractJsseEndpoint.createSSLContext(AbstractJsseEndpoint.java:114)\n        at org.apache.tomcat.util.net.AbstractJsseEndpoint.initialiseSsl(AbstractJsseEndpoint.java:85)\n        at org.apache.tomcat.util.net.Nio2Endpoint.bind(Nio2Endpoint.java:163)\n        at org.apache.tomcat.util.net.AbstractEndpoint.init(AbstractEndpoint.java:982)\n        at org.apache.tomcat.util.net.AbstractJsseEndpoint.init(AbstractJsseEndpoint.java:244)\n        at org.apache.coyote.AbstractProtocol.init(AbstractProtocol.java:620)\n        at org.apache.coyote.http11.AbstractHttp11Protocol.init(AbstractHttp11Protocol.java:66)\n        at org.apache.catalina.connector.Connector.initInternal(Connector.java:997)\n        ... 13 more\nCaused by: java.security.KeyStoreException: Cannot get key bytes, not PKCS#8 encoded\n        at sun.security.provider.KeyProtector.protect(KeyProtector.java:174)\n        at sun.security.provider.JavaKeyStore.engineSetKeyEntry(JavaKeyStore.java:267)\n        at sun.security.provider.JavaKeyStore$JKS.engineSetKeyEntry(JavaKeyStore.java:56)\n        at sun.security.provider.KeyStoreDelegator.engineSetKeyEntry(KeyStoreDelegator.java:117)\n        at sun.security.provider.JavaKeyStore$DualFormatJKS.engineSetKeyEntry(JavaKeyStore.java:70)\n        at java.security.KeyStore.setKeyEntry(KeyStore.java:1140)\n        at org.apache.tomcat.util.net.jsse.JSSEUtil.getKeyManagers(JSSEUtil.java:226)\n        at org.apache.tomcat.util.net.AbstractJsseEndpoint.createSSLContext(AbstractJsseEndpoint.java:112)\n        ... 20 mor\n\nI did notice that because of the revision mentioned above (to JSSEUtil.java), KeyStore objects that aren't PEM encoded are loaded as an in-memory JKS keystore and a call to setKeyEntry is made. I may be wrong, but I think this is causing the failure. The hint I had to go from is that the documentation for the second form of setKeyEntry requires the key bytes to be PKCS8 encoded since this underlying keystore is JKS[1]... but we cannot guarantee that the getKey[2] call returned a Key that is PKCS8 encoded. With the implementation I am using, it's unclear what the encoding is for the Key object, but since PKCS11 is a common interface for hardware crypto, I'm sure many different types (or none at all) are possible. Looking into the source for engineSetKeyEntry(String alias, byte[] key, Certificate[] chain), I see that a call to protect() is made which does the check for PKCS8 encoding. This appears to explain the exception.\n\nUnfortunately... I'm not sure where to go from there (if that even is the issue). It wouldn't help to switch to setKeyEntry(String alias, byte[] key, Certificate[] chain) since that also has the same PKCS8 encoding requirement. I also don't think it would be possible to obtain the raw key bytes since a hardware crypto device would certainly block such an operation and it would be out of Tomcat's place to try to convert among encoding formats.\n\nThoughts greatly appreciated\n\n[1] https://docs.oracle.com/javase/7/docs/api/java/security/KeyStore.html#setKeyEntry(java.lang.String,%20java.security.Key,%20char[],%20java.security.cert.Certificate[]\n[2] https://docs.oracle.com/javase/7/docs/api/java/security/KeyStore.html#getKey(java.lang.String, char[])", "id": 200421, "time": "2017-08-22T19:35:38Z", "bug_id": 61451, "creation_time": "2017-08-22T19:35:38Z", "tags": [], "is_private": false}, {"count": 1, "attachment_id": null, "creator": "DRuggeri@primary.net", "text": "Please note dev list discussion:\nhttps://lists.apache.org/thread.html/b2523c4cdb25ec6b6ffdb0667d529f6fafe71281a20f9afdd4d2ca6a@%3Cdev.tomcat.apache.org%3E", "id": 200422, "time": "2017-08-22T19:37:54Z", "bug_id": 61451, "creation_time": "2017-08-22T19:37:54Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 200551, "time": "2017-08-31T19:35:43Z", "bug_id": 61451, "creation_time": "2017-08-31T19:35:43Z", "is_private": false, "text": "*** Bug 61445 has been marked as a duplicate of this bug. ***"}, {"count": 3, "tags": [], "text": "Fixed in:\n- trunk for 9.0.0.M27 onwards\n- 8.5.x for 8.5.21 onwards", "is_private": false, "id": 200555, "creator": "markt@apache.org", "time": "2017-08-31T21:52:22Z", "bug_id": 61451, "creation_time": "2017-08-31T21:52:22Z", "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 61451, "is_private": false, "text": "*** Bug 61497 has been marked as a duplicate of this bug. ***", "id": 200716, "time": "2017-09-06T18:43:42Z", "creator": "markt@apache.org", "creation_time": "2017-09-06T18:43:42Z", "attachment_id": null}]