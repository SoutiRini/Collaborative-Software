[{"count": 0, "tags": [], "bug_id": 59857, "attachment_id": null, "is_private": false, "id": 192376, "time": "2016-07-14T14:32:43Z", "creator": "nick@fina2.net", "creation_time": "2016-07-14T14:32:43Z", "text": "I have problem XLS file reading with POI:\n\n\norg.apache.poi.EncryptedDocumentException: HSSF does not currently support CryptoAPI encryption\n\tat org.apache.poi.hssf.record.FilePassRecord$Rc4KeyData.read(FilePassRecord.java:66)\n\tat org.apache.poi.hssf.record.FilePassRecord.<init>(FilePassRecord.java:215)\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)\n\tat sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\n\tat java.lang.reflect.Constructor.newInstance(Constructor.java:423)\n\tat org.apache.poi.hssf.record.RecordFactory$ReflectionConstructorRecordCreator.create(RecordFactory.java:84)\n\tat org.apache.poi.hssf.record.RecordFactory.createSingleRecord(RecordFactory.java:334)\n\tat org.apache.poi.hssf.record.RecordFactoryInputStream$StreamEncryptionInfo.<init>(RecordFactoryInputStream.java:70)\n\tat org.apache.poi.hssf.record.RecordFactoryInputStream.<init>(RecordFactoryInputStream.java:203)\n\tat org.apache.poi.hssf.record.RecordFactory.createRecords(RecordFactory.java:475)\n\tat org.apache.poi.hssf.usermodel.HSSFWorkbook.<init>(HSSFWorkbook.java:337)\n\tat org.apache.poi.ss.usermodel.WorkbookFactory.create(WorkbookFactory.java:95)\n\tat org.apache.poi.ss.usermodel.WorkbookFactory.create(WorkbookFactory.java:178)\n\tat org.apache.poi.ss.usermodel.WorkbookFactory.create(WorkbookFactory.java:140)\n\nFile has workbook protection with Microsoft Enhanced Cryptographic Provider v1.0.\n\nI have found on bugzilla  issue https://bz.apache.org/bugzilla/show_bug.cgi?format=multiple&id=35897 \n\n\nProblem with Word doc was resolved.  but how about EXCEL ?  was it resolved for Excel?"}, {"count": 1, "tags": [], "creator": "kiwiwings@apache.org", "attachment_id": null, "is_private": false, "id": 192377, "time": "2016-07-14T14:57:24Z", "bug_id": 59857, "creation_time": "2016-07-14T14:57:24Z", "text": "As the exception says: cryptoapi is not yet supported / implemented ...\nSee also: http://poi.apache.org/encryption.html\n\nit's on my todo-list, therefore I leave this bug entry open.\nBut as usual, I won't have the implementation in the near future ... maybe someone else give it a try ..."}, {"count": 2, "tags": [], "creator": "kakhaberi@fina2.net", "is_private": false, "text": "Dear Andreas, \n\nMany thanks for your response.  We (small open source fun club from Georgia) appreciate your time and will be very thankful if that bug will be resolved.  I am sure it will also help to many devs who are using POI for Excel files. \n \nThanks \nKakha  & Nick\n\nP.S.  By the way \u2013 very interesting question is how  and when that cryptographic method occurs?  With normal way of work non of the Excel s (2003, 2007,  2010, 2013, 2016) never have such kind of problem .", "id": 192544, "time": "2016-07-20T07:49:11Z", "bug_id": 59857, "creation_time": "2016-07-20T07:49:11Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 59857, "attachment_id": null, "id": 192585, "time": "2016-07-23T19:26:01Z", "creator": "kiwiwings@apache.org", "creation_time": "2016-07-23T19:26:01Z", "is_private": false, "text": "Just for the record ... there's already a crypto api XLS in our corpus:\nspreadsheet/35897-type4.xls - password \"freedom\"\n\nIt actually doesn't look that complicated - I hope I can mix something of the HSLF encrypted document stream handling with the existing XLS RC4 encryption"}, {"attachment_id": null, "tags": [], "bug_id": 59857, "text": "The hssf_cryptoapi branch [1] contains an implementation.\nI try to provide encryption support too, before I merge it back to the trunk.\nThe tests which covers Xor, RC4 and CryptoAPI is in [2]\n\n\n[1] https://svn.apache.org/repos/asf/poi/branches/hssf_cryptoapi/\n[2] org.apache.poi.hssf.usermodel.TestCryptoAPI", "count": 4, "id": 192949, "time": "2016-08-08T00:16:07Z", "creator": "kiwiwings@apache.org", "creation_time": "2016-08-08T00:16:07Z", "is_private": false}, {"count": 5, "attachment_id": null, "bug_id": 59857, "text": "Many thanks Andreas. Nick is on vacation but I will inform him about your message.", "id": 192978, "time": "2016-08-10T13:51:43Z", "creator": "kakhaberi@fina2.net", "creation_time": "2016-08-10T13:51:43Z", "tags": [], "is_private": false}, {"count": 6, "attachment_id": null, "bug_id": 59857, "is_private": false, "id": 193229, "time": "2016-08-19T21:24:02Z", "creator": "kiwiwings@apache.org", "creation_time": "2016-08-19T21:24:02Z", "tags": [], "text": "Added encryption support for XOR/RC4/CryptoAPI via r1756964\n\nUnfortunately I've realized, that the existing and modified XOR obfuscation is flawed.\nIt works for very small files, but for files > ~4kb, the office file validation complaints and it doesn't get opened anymore ...\n\nOf course I've tried to generate un-/encrypted files via Office and check when the de-/encryption goes wrong. Interestingly the first encrypted records (even long ones) get de-/encrypted correctly, but starting with the FontRecords (with the xor-encryption-abc.xls) only one of the bytes differ.\nThis also happens even when the whole record processing is bypassed and the plain/encrypted stream of the POIFS is processed.\n\nMy guess is, that similar to RC4/CryptoAPI there's a block key somewhere, although libre office [1] hasn't got something like this.\n... but probably, it's something completely different and I was just focusing to much on the wrong spots ...\n\n[1] http://docs.libreoffice.org/oox/html/binarycodec_8cxx_source.html"}, {"count": 7, "tags": [], "creator": "kiwiwings@apache.org", "text": "Patch for applied with r1762726\n\nthis also contains the mentioned encrpytion routines.\nUp till now I couldn't fix the xor obfuscation bug.\n\nApart of the encryption routines, I needed to tweak the little endian stream classes to be real In-/OutputStreams, but that change effect only the closed resources warning, which were ignored in the original version", "id": 194075, "time": "2016-09-28T23:40:39Z", "bug_id": 59857, "creation_time": "2016-09-28T23:40:39Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 59857, "attachment_id": null, "id": 194286, "time": "2016-10-09T17:57:59Z", "creator": "fanningpj@yahoo.com", "creation_time": "2016-10-09T17:57:59Z", "is_private": false, "text": "I have come across a possible regression related to this patch. https://bz.apache.org/bugzilla/show_bug.cgi?id=60230"}]