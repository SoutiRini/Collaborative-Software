[{"attachment_id": null, "tags": [], "bug_id": 47389, "is_private": false, "count": 0, "id": 128042, "time": "2009-06-18T03:39:55Z", "creator": "fujino.keiichi@oss.ntt.co.jp", "creation_time": "2009-06-18T03:39:55Z", "text": "DeltaManager is used. \nWhen notifySessionListenersOnReplication is set to false, session replication is not done. \n\nThis cause is in the following DeltaManager#handleSESSION_CREATED's codes. \nprotected void handleSESSION_CREATED(SessionMessage msg,Member sender) {\n...\n    if(notifySessionListenersOnReplication)\n        session.setId(msg.getSessionID());\n    else\n        session.setIdInternal(msg.getSessionID());\n    session.resetDeltaRequest();\n    session.endAccess();\n\n}\n\nWhen notifySessionListenersOnReplication is false, only session.setIdInternal is executed.\nSession is not added to session map of DeltaManager in session.setIdInternal method.\nAs a result, session replication is not done. \n\nWhen notifySessionListenersOnReplication is false, \nI think that I should add session to session map of DeltaManager. \nFor instance, as follows.\n\n[start.]\n\nIndex: java/org/apache/catalina/ha/session/DeltaManager.java\n===================================================================\n--- java/org/apache/catalina/ha/session/DeltaManager.java\t(revision 763870)\n+++ java/org/apache/catalina/ha/session/DeltaManager.java\t(working copy)\n@@ -1435,10 +1435,12 @@\n         // use container maxInactiveInterval so that session will expire correctly in case of primary transfer\n         session.setMaxInactiveInterval(getMaxInactiveInterval());\n         session.access();\n-        if(notifySessionListenersOnReplication)\n+        if(notifySessionListenersOnReplication) {\n             session.setId(msg.getSessionID());\n-        else\n+        } else {\n             session.setIdInternal(msg.getSessionID());\n+            add(session);\n+        }\n         session.resetDeltaRequest();\n         session.endAccess();\n \n\n[end.]\n\nBest regards."}, {"count": 1, "tags": [], "bug_id": 47389, "is_private": false, "text": "Fixed in http://svn.apache.org/viewvc?rev=786124&view=rev\nBackport proposed for 6.0\nMany thanks for the patch!", "id": 128058, "time": "2009-06-18T08:31:02Z", "creator": "fhanik@apache.org", "creation_time": "2009-06-18T08:31:02Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "rainer.jung@kippdata.de", "attachment_id": null, "id": 128462, "time": "2009-07-01T12:07:36Z", "bug_id": 47389, "creation_time": "2009-07-01T12:07:36Z", "is_private": false, "text": "Applied to TC6 as r790313 and to TC5.5 as r790307. Will be part of 6.0.21 and 5.5.28."}]