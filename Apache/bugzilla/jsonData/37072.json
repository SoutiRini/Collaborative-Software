[{"count": 0, "tags": [], "text": "I found a possible bug in the class org/apache/catalina/connector/Response.java.\n\nI try to explain the problem with steps of the request flow (I use a filter, a\nservlet and a JSP page):\n\n1. Tomcat gets a request from outside\n2. The filter gets the response and does the following:\n2.1 Sets the character encoding to UTF-8\n2.2 Gets the writer with response.getWriter() and writes out a message if the\ncontent type is text/html. This locks the writer which means you can not set the\ncharacter encoding later anymore.\n3 The servlet gets the request and an exception occurs (this is a simulated\nexception)\n4 Tomcat gets back the request and processes the error\n4.1 The response is reset:\n4.1.1 the response itself is reset\n4.1.2 the outputstream is reset\n4.1.1+2 both are reset to ISO-8859-1 which is the default value.\n5 The error page is called which has the encoding UTF-8. \n5.1 BUG: The encoding of the page is not used because the writer is still locked\nbut the encoding in the writer is set to default which is ISO-8859-1\n\nMy suggestion is to let the character encoding be untouched in the error case\nbecause in the error case the encoding was already set somewhere before (e.g.\nfilter or servlet).\n\n1. Tomcat (ISO-8859-1, writer unlocked)\n2. Filter (-> UTF-8, writer locked)\n3. Servlet (UTF-8, exception raised, writer locked)\n4. Tomcat (ISO-8859-1, writer locked)\n5. JSP (UTF-8 <-> ISO-8859-1 conflict because writer still locked ->\nsetCharacterEncoding is locked)\n\n\nWith regards\nUdo Walker", "is_private": false, "id": 81118, "creator": "Udo.Walker@abas.de", "time": "2005-10-13T14:44:56Z", "bug_id": 37072, "creation_time": "2005-10-13T14:44:56Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "yoavs@computer.org", "attachment_id": null, "id": 97220, "time": "2006-12-24T08:47:34Z", "bug_id": 37072, "creation_time": "2006-12-24T08:47:34Z", "is_private": false, "text": "I understand your use case and your concern.  But we can't count on the encoding\nbeing set somewhere before, can we?  Even detecting that we're in the error case\nas opposed to a normal reset is somewhat challenging.  If you've got a patch you\nwant us to consider, please attach it to this issue."}, {"count": 2, "tags": [], "bug_id": 37072, "attachment_id": null, "text": "In bug 36814 I first thought it is some other problem in Tomcat. Then I found\nout the problem described above. \n\nIn bug 36814 I described a possible solution with a context parameter to set the\ndefault encoding of the container. The solution was denied :( .\n\nI don't know how to solve the encoding problem if nobody is able to configure\nthe default encoding. \n\nYou could still implement the default encoding as ISO-8859-1 but then if there\nis a context parameter set then use the encoding value described there.\n", "id": 97522, "time": "2007-01-02T03:18:43Z", "creator": "Udo.Walker@abas.de", "creation_time": "2007-01-02T03:18:43Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 37072, "attachment_id": null, "is_private": false, "id": 99773, "time": "2007-02-26T00:25:30Z", "creator": "suzuki.yuichiro@jp.fujitsu.com", "creation_time": "2007-02-26T00:25:30Z", "text": "How about the following corrections?\n\norg.apache.catalina.connector.Response:\n---\n    public void reset(int status, String message) {\n        reset();\n        setStatus(status, message);\n        usingWriter = false; // add for user error page\n    }\n---\nThis makes the user error page be able to set encoding again.\nEven if there is already a generated Writer object,\nI think it has not been referred any longer usually because \nthe application(filter, servlet, etc.) is already over.\n\n\norg.apache.catalina.valves.ErrorReportValve:\nin  protected void report(Request request, Response response, Throwable \nthrowable)\n...\ntry {\n    response.setContentType(\"text/html\");\n    response.setCharacterEncoding(\"utf-8\");\n    \n    // add for default error page\n    if(!\"utf-8\".equals(response.getCharacterEncoding())){\n        response.getCoyoteResponse().setCharacterEncoding(\"utf-8\");\n    }\n} catch (Throwable t) {\n...\nIf the writer object is already generated, setCharacterEncoding will not work.\nSo I think we must force set encoding direct to coyote response.\n\n\nI know the specification says setCharacterEncoding should effect only before \ngetWriter,\nand says nothing about getWriter in reset method description.\nBut we need a fix in multi byte character environment.\n"}, {"count": 4, "tags": [], "text": "-1 for the patch you suggest. It works for your case but won't work for many\nusers that don't use UTF-8.\n\nI have started a thread on the dev list about this.", "attachment_id": null, "id": 99955, "creator": "markt@apache.org", "time": "2007-03-01T20:19:34Z", "bug_id": 37072, "creation_time": "2007-03-01T20:19:34Z", "is_private": false}, {"count": 5, "tags": [], "text": "The mailing list thread is here:\nhttp://marc.info/?l=tomcat-dev&m=117280911532391&w=2\n", "is_private": false, "id": 100872, "creator": "yoavs@computer.org", "time": "2007-03-25T08:08:29Z", "bug_id": 37072, "creation_time": "2007-03-25T08:08:29Z", "attachment_id": null}, {"count": 6, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 111867, "time": "2007-12-18T15:50:10Z", "bug_id": 37072, "creation_time": "2007-12-18T15:50:10Z", "text": "The fix in the duplicate allows the encoding of the error page to be completely\nindependent of the original page.\n\n*** This bug has been marked as a duplicate of 43236 ***"}]