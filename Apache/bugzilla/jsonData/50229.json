[{"count": 0, "tags": [], "bug_id": 50229, "attachment_id": null, "id": 141528, "time": "2010-11-07T13:03:23Z", "creator": "msunde@tillnow.com", "creation_time": "2010-11-07T13:03:23Z", "is_private": false, "text": "Upgrading from ant 1.7.1 to ant 1.8.1 resulted in build times doubling (2hrs vs 1hr). Most of the time increase seems to be related to lines similar to the following:\n\n<java classname=\"com.MyClass\" fork=\"true\" failonerror=\"true\"\n\tinput=\"${destdir}/inputFile.zip\"\n\toutput=\"${destdir}/outputFile.zip\">\n\t<classpath refid=\"my.classpath\"/>\n\t<arg value=\"AppSrv\"/>\n</java>\n\nI put together a simple test that uses exec and cat to copy a 38MB file and times went from 6sec to 9min when the version of ant changed. My guess is that this is being caused by changes to StreamPumper.\n\n----------------------------------------------\nBuildfile: build.xml\n\ninit:\n     [echo] Start Time: Sun, Nov 7, 2010 - 12:00:05 EST\n     [echo] Ant version: Apache Ant version 1.7.1 compiled on June 27 2008\n     [echo] Java version: 1.5.0_22-b03\n     [echo] OS Name: Windows XP\n     [echo]\n\nall:\n\nBUILD SUCCESSFUL\nTotal time: 6 seconds\n----------------------------------------------\nBuildfile: S:\\ant\\test\\build.xml\n\ninit:\n     [echo] Start Time: Sun, Nov 7, 2010 - 12:05:19 EST\n     [echo] Ant version: Apache Ant version 1.8.2alpha compiled on October 27 2010\n     [echo] Java version: 1.5.0_22-b03\n     [echo] OS Name: Windows XP\n     [echo]\n\nall:\n\nBUILD SUCCESSFUL\nTotal time: 9 minutes 10 seconds\n----------------------------------------------\n<project name=\"test\" default=\"all\" basedir=\".\">\n\n<target name=\"init\">\n\t<tstamp>\n\t\t<format property=\"start_time\" pattern=\"E, MMM d, yyyy - HH:mm:ss z\" locale=\"en\" />\n\t</tstamp>\n\n\t<echo>Start Time: ${start_time}</echo>\n\t<echo>Ant version: ${ant.version}</echo>\n\t<echo>Java version: ${java.vm.version}</echo>\n\t<echo>OS Name: ${os.name}</echo>\n\t<echo message=\"\" />\n\n\t<!-- 38MB file -->\n\t<property name=\"largefile\" location=\"large_file.zip\" />\n\t<property name=\"outfile\" location=\"copy.zip\" />\n</target>\n\n<target name=\"all\" depends=\"init\">\n\t<exec executable=\"cat\" input=\"${largefile}\" output=\"${outfile}\"/>\n</target>\n\n<target name=\"clean\" depends=\"init\">\n\t<delete file=\"${outfile}\"/>\n</target>\n\n</project>\n\n----------------------------------------------\nSuspected changes:\nsrc\\main\\org\\apache\\tools\\ant\\taskdefs\\StreamPumper.java\nAnt 1.7.1\n    while ((length = is.read(buf)) > 0 && !finish) {\n        os.write(buf, 0, length);\n        if (autoflush) {\n            os.flush();\n        }\n    }\n\nAnt 1.8.2\n    while (true) {\n        waitForInput(is);\n\n        if (finish || Thread.interrupted()) {\n            break;\n        }\n\n        length = is.read(buf);\n        if (length <= 0 || finish || Thread.interrupted()) {\n            break;\n        }\n        os.write(buf, 0, length);\n        if (autoflush) {\n            os.flush();\n        }\n    }"}, {"count": 1, "tags": [], "bug_id": 50229, "attachment_id": null, "id": 141529, "time": "2010-11-07T13:05:52Z", "creator": "msunde@tillnow.com", "creation_time": "2010-11-07T13:05:52Z", "is_private": false, "text": "This might be related to Bug 49888, although in that case, exec is called many times. In this case, exec is only called once."}, {"count": 2, "tags": [], "bug_id": 50229, "attachment_id": null, "id": 142760, "time": "2010-12-15T18:49:41Z", "creator": "antoine@apache.org", "creation_time": "2010-12-15T18:49:41Z", "is_private": false, "text": "*** Bug 49888 has been marked as a duplicate of this bug. ***"}, {"count": 3, "tags": [], "bug_id": 50229, "attachment_id": null, "id": 142761, "time": "2010-12-15T19:11:03Z", "creator": "antoine@apache.org", "creation_time": "2010-12-15T19:11:03Z", "is_private": false, "text": "Michael, you are right, the loop in StreamPumper#run is causing the problem.\nRolling it back to 1.7.1 style brings back the same performance."}, {"count": 4, "tags": [], "bug_id": 50229, "attachment_id": null, "id": 142764, "time": "2010-12-16T01:02:59Z", "creator": "msunde@tillnow.com", "creation_time": "2010-12-16T01:02:59Z", "is_private": false, "text": "It looks like the StreamPumper changes were checked in as part of Bug 5003, specifically svn revision 711860."}, {"count": 5, "tags": [], "text": "The change is necessary in order to properly deal with grandchild processes\non Windows - that's why it used to be explicitly restricted to Windows\ninitially.\n\nIf you take out the change the AntUnit test testDoesntWaitForChildren in\nexec-test is going to take more than 20 seconds because Ant now waits\nfor the grandchildren the forked (and long finished) child process\nhas spawned.\n\nSo reverting the change is no option.  Finding a different solution for\nbug 5003 would be one, but so far nobody has found one.\n\nOne option may be to not set useAvailable to true if we know the forked\nprocess is not going to spawn additional child prcesses - like in <attrib>'s\ncase and make it configurable via attributes on <exec> and friends.\n\nOne thing to consider is that a while back the useAvailable flag has\nbeen set to true on all operating systems because it seemed to fix\nanother bug.  I don't recall which bug it has been and don't have the time\nto search for it right away, but I recall it was not related to grandchildren\nat all - so this bug might reappear with my idea above.  Then again I also\nrecall somebody (I think Jesse) questioned whether the bug has really been\nfixed and whether the change was the correct one at all.", "is_private": false, "id": 142765, "creator": "bodewig@apache.org", "time": "2010-12-16T03:49:44Z", "bug_id": 50229, "creation_time": "2010-12-16T03:49:44Z", "attachment_id": null}, {"count": 6, "tags": [], "creator": "bodewig@apache.org", "is_private": false, "text": "I knew I had pulled together related bug ids once.\n\nhttp://marc.info/?t=127652142200010&r=1&w=2", "id": 142766, "time": "2010-12-16T03:55:12Z", "bug_id": 50229, "creation_time": "2010-12-16T03:55:12Z", "attachment_id": null}, {"count": 7, "tags": [], "creator": "antoine@apache.org", "is_private": false, "text": "Hello Stefan,\n\nI changed PumpStreamHandler to always set \"useavailable\" to true in order to fix the bug 48746, \"exec task sometimes inserts extraneous newlines\". This was svn revision 912298. \n\nI remember that I was able to reproduce bug 48746 on MacOS with useavailable=\"false\" and that setting useavailable=\"true\" there helped.\n\nMaybe we would need to have useavailable=\"true\" by default on Windows and MacOS and set it to false on other operating systems including Linux.\n\nAntoine", "id": 142775, "time": "2010-12-16T10:22:37Z", "bug_id": 50229, "creation_time": "2010-12-16T10:22:37Z", "attachment_id": null}, {"count": 8, "tags": [], "text": "Is there a reason StreamPumper uses a SMALL_BUFFER_SIZE (128)? In this particular bug, a large file on disk is being read in so a larger buffer may be beneficial (not tested).\n\nIn this bug, the parent java/exec task knows that it is reading from a file on disk so does useavailable make sense for that input stream?", "attachment_id": null, "id": 142777, "creator": "msunde@tillnow.com", "time": "2010-12-16T11:08:19Z", "bug_id": 50229, "creation_time": "2010-12-16T11:08:19Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 50229, "attachment_id": null, "id": 152068, "time": "2011-12-08T14:32:01Z", "creator": "James.Poli@sas.com", "creation_time": "2011-12-08T14:32:01Z", "is_private": false, "text": "Stefan,\nThis bug has caused significant degradation in the performance of our testing framework which runs Ant with AntUnit and then forks off another ANT process with the ANT Java task.  Our forked ANT produces a large amount of output.  Do you see a solution coming soon to fix this?  \nThanks in advance,\nJames Poli"}, {"count": 10, "tags": [], "bug_id": 50229, "attachment_id": null, "id": 159965, "time": "2012-06-13T16:02:15Z", "creator": "schlm3@gmail.com", "creation_time": "2012-06-13T16:02:15Z", "is_private": false, "text": "hi ant maintainers,\n\nIs there any work planned on this issue?\nWe are still on ant 1.7.1 here because of this issue, since our build takes 1h 15min with 1.8.4 instead of 44min with ant 1.7.1\nNow we'd like to use IVY and some other new stuff. This is a showstopper for years now. We never had problems with the ant 1.7.1 StreamPumper."}, {"count": 11, "tags": [], "bug_id": 50229, "attachment_id": null, "is_private": false, "id": 159967, "time": "2012-06-13T16:15:37Z", "creator": "schlm3@gmail.com", "creation_time": "2012-06-13T16:15:37Z", "text": "Did anyone tried out the patch provided by Rohit Kelapure on  [Bug 5003] ?"}, {"count": 12, "tags": [], "creator": "schlm3@gmail.com", "is_private": false, "text": "I tried the patch from Rohit, but it does not speed up anything (tested with attrib).\n\nFor me, I have a workaround by using exec directly, since I have to attrib all files contained in a folder:\n\n<exec executable=\"attrib\" dir=\"${my.dir}\" >\n    <arg value=\"-R\"/>\n    <arg value=\"/S\"/>\n</exec>\n\nThe exec command takes 2 seconds, while the attrib-command for the same folder takes more than 9 Minutes.\n\nMaybe, you could add some note to the doc of attrib...", "id": 159983, "time": "2012-06-13T20:52:18Z", "bug_id": 50229, "creation_time": "2012-06-13T20:52:18Z", "attachment_id": null}, {"count": 13, "tags": [], "bug_id": 50229, "text": "I have an ANT-script that takes 37min instead of 2min because ist makes heavy use of exec.\n\nIs there any workaround except using ANT 1.7 to obtain the 'old' performance?", "id": 168617, "time": "2013-07-16T08:12:04Z", "creator": "paltzern@hdpgmbh.de", "creation_time": "2013-07-16T08:12:04Z", "is_private": false, "attachment_id": null}, {"count": 14, "tags": [], "text": "Bug 54128 seems to address this issue more actively.", "is_private": false, "id": 169728, "creator": "paltzern@hdpgmbh.de", "time": "2013-08-27T08:41:46Z", "bug_id": 50229, "creation_time": "2013-08-27T08:41:46Z", "attachment_id": null}, {"count": 15, "tags": [], "creator": "bodewig@apache.org", "is_private": false, "text": "\n\n*** This bug has been marked as a duplicate of bug 54128 ***", "id": 171866, "time": "2013-12-21T19:53:33Z", "bug_id": 50229, "creation_time": "2013-12-21T19:53:33Z", "attachment_id": null}]