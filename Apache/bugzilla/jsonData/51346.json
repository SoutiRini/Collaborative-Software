[{"count": 0, "tags": [], "bug_id": 51346, "attachment_id": 27136, "text": "Created attachment 27136\ntest-input-stream web application\n\nHello,\n\nI have an application that tries to get InputStream and to read from it.\nWithout RequestDumperValve everything is OK.\nWhen I enable RequestDumperValve it appears that the InputStream is already read and the end of stream is reached.\n\nHow to reproduce:\n1.Deploy the attached test-input-stream.war.\n2.Use the attached TestClient that will send a POST request.\n3.In the console you will see \"in.read() != -1\" which is OK\n4.Enable the RequestDumperValve in the server.xml\n5.Use again the attached TestClient that will send a POST request.\n6.In the console you will see \"in.read() == -1\" which is true when the end of stream is reached.\n\nWhat TestClient does:\n- sends POST request via HttpURLConnection\n- writes to the OutputStream\n\nMy suspicious is that RequestDumperValve wants to dump the parameters, but parsing the parameters operation will read InputStream.\n\nCan you give me advice how to proceed.\n\nThanks in advance.\nRegards\nVioleta", "id": 146982, "time": "2011-06-09T07:54:08Z", "creator": "violetagg@apache.org", "creation_time": "2011-06-09T07:54:08Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 51346, "text": "Created attachment 27137\nTestClient", "id": 146983, "time": "2011-06-09T07:55:13Z", "creator": "violetagg@apache.org", "creation_time": "2011-06-09T07:55:13Z", "is_private": false, "attachment_id": 27137}, {"count": 2, "tags": [], "bug_id": 51346, "attachment_id": null, "text": "(In reply to comment #1)\n> Created attachment 27137 [details]\n> TestClient\n\nYes, the valve dumps headers, parameters causing the InputStream to be consumed:\nhttp://svn.apache.org/repos/asf/tomcat/sandbox/comet/java/org/apache/catalina/valves/RequestDumperValve.java\n\nThe users list is where to ask for help, rather than bugzilla.", "id": 146987, "time": "2011-06-09T09:37:43Z", "creator": "bugzilla@pidster.com", "creation_time": "2011-06-09T09:37:43Z", "is_private": false}, {"count": 3, "text": "(In reply to comment #2)\n> (In reply to comment #1)\n> > Created attachment 27137 [details]\n> > TestClient\n> Yes, the valve dumps headers, parameters causing the InputStream to be\n> consumed:\n> http://svn.apache.org/repos/asf/tomcat/sandbox/comet/java/org/apache/catalina/valves/RequestDumperValve.java\n> The users list is where to ask for help, rather than bugzilla.\n\nYes but don't you think that this is a problem?\nTypically you can use this Valve for debugging your application:\n\n\"* ...It is especially useful in debugging problems\n * related to headers and cookies.\"\n\nBut what happens actually is that your application will stop working because of this valve.\n\nIs it possible at least to document this behavior?\n\nThanks\nVioleta", "bug_id": 51346, "attachment_id": null, "id": 146988, "time": "2011-06-09T10:36:09Z", "creator": "violetagg@apache.org", "creation_time": "2011-06-09T10:36:09Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "bug_id": 51346, "attachment_id": null, "id": 146989, "time": "2011-06-09T10:49:14Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2011-06-09T10:49:14Z", "is_private": false, "text": "(In reply to comment #3)\n> \"* ...It is especially useful in debugging problems\n>  * related to headers and cookies.\"\n\nThe JavaDoc that you are citing above does not have the warning,\n\nbut the documentation does have it,\nhttp://tomcat.apache.org/tomcat-6.0-doc/config/valve.html#Request_Dumper_Valve"}, {"count": 5, "attachment_id": null, "bug_id": 51346, "text": "(In reply to comment #4)\n> (In reply to comment #3)\n> > \"* ...It is especially useful in debugging problems\n> >  * related to headers and cookies.\"\n> The JavaDoc that you are citing above does not have the warning,\n> but the documentation does have it,\n> http://tomcat.apache.org/tomcat-6.0-doc/config/valve.html#Request_Dumper_Valve\n\nThe page contains the following:\n\"WARNING: Using this valve has side-effects. The output from this valve includes any parameters included with the request. The parameters will be decoded using the default platform encoding. Any subsequent calls to request.setCharacterEncoding() within the web application will have no effect.\n\"\n\nThere is no explicit note for inputstream consumption which actually happens.\n\nI can propose a patch if you think it is applicable, but this will take some time.\n\nWhat do you think?", "id": 146990, "time": "2011-06-09T10:55:30Z", "creator": "violetagg@apache.org", "creation_time": "2011-06-09T10:55:30Z", "tags": [], "is_private": false}, {"count": 6, "tags": [], "text": "Created attachment 27138\nPatch for RDV javadoc including a warning.", "attachment_id": 27138, "id": 146993, "creator": "bugzilla@pidster.com", "time": "2011-06-09T12:30:54Z", "bug_id": 51346, "creation_time": "2011-06-09T12:30:54Z", "is_private": false}, {"count": 7, "tags": [], "creator": "bugzilla@pidster.com", "attachment_id": 27139, "id": 146994, "time": "2011-06-09T12:38:37Z", "bug_id": 51346, "creation_time": "2011-06-09T12:38:37Z", "is_private": false, "text": "Created attachment 27139\nPatch for the docs page on valves, including more info about RDV behaviour."}, {"count": 8, "tags": [], "bug_id": 51346, "attachment_id": null, "id": 146995, "time": "2011-06-09T12:38:52Z", "creator": "bugzilla@pidster.com", "creation_time": "2011-06-09T12:38:52Z", "is_private": false, "text": "Done."}, {"count": 9, "tags": [], "bug_id": 51346, "attachment_id": null, "text": "That statements in the patch are incorrect. The inputstream is only consumed when a) the request is a POST and b) the request content type is \"application/x-www-form-urlencoded\"", "id": 147003, "time": "2011-06-09T19:28:30Z", "creator": "markt@apache.org", "creation_time": "2011-06-09T19:28:30Z", "is_private": false}, {"count": 10, "tags": [], "creator": "bugzilla@pidster.com", "attachment_id": null, "id": 147004, "time": "2011-06-09T19:44:46Z", "bug_id": 51346, "creation_time": "2011-06-09T19:44:46Z", "is_private": false, "text": "(In reply to comment #9)\n> That statements in the patch are incorrect. The inputstream is only consumed\n> when a) the request is a POST and b) the request content type is\n> \"application/x-www-form-urlencoded\"\n\nDoh."}, {"count": 11, "text": "Created attachment 27141\ncorrected patch", "bug_id": 51346, "attachment_id": 27141, "id": 147005, "time": "2011-06-09T19:50:11Z", "creator": "bugzilla@pidster.com", "creation_time": "2011-06-09T19:50:11Z", "tags": [], "is_private": false}, {"count": 12, "tags": [], "bug_id": 51346, "text": "Created attachment 27142\ncorrected patch for docs", "id": 147006, "time": "2011-06-09T19:50:36Z", "creator": "bugzilla@pidster.com", "creation_time": "2011-06-09T19:50:36Z", "is_private": false, "attachment_id": 27142}, {"count": 13, "tags": [], "bug_id": 51346, "attachment_id": null, "text": "Modified patch applied (the updated patch still ignored the content-type) to 6.0.x and will be included in 6.0.33 onwards.", "id": 147114, "time": "2011-06-14T13:46:44Z", "creator": "markt@apache.org", "creation_time": "2011-06-14T13:46:44Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 51346, "text": "(In reply to comment #13)\n> Modified patch applied (the updated patch still ignored the content-type) to\n> 6.0.x and will be included in 6.0.33 onwards.\n\nThanks!", "id": 147115, "time": "2011-06-14T14:17:47Z", "creator": "violetagg@apache.org", "creation_time": "2011-06-14T14:17:47Z", "is_private": false, "attachment_id": null}]