[{"count": 0, "tags": [], "bug_id": 47478, "attachment_id": null, "id": 128547, "time": "2009-07-06T03:05:17Z", "creator": "fujino.keiichi@oss.ntt.co.jp", "creation_time": "2009-07-06T03:05:17Z", "is_private": false, "text": "When BackupManager is used,\nDeltaSession notifies session listener even if notifyListenersOnReplication is set to false. \n\nThe cause is in the following o.a.c.h.s.DeltaSession#applyDiff's codes. \n\npublic void applyDiff(byte[] diff, int offset, int length) throws IOException, ClassNotFoundException {\n    try {\n        ...\n            getDeltaRequest().execute(this);\n        } finally {\n            Thread.currentThread().setContextClassLoader(contextLoader);\n        }\n    }finally {\n        unlock();\n    }\n}\n\nDeltaSession always notifies the session listener regardless of the value of notifyListenersOnReplication. \nDo not notify the session listener when notifyListenersOnReplication is set to false. \n\nI think that I should add notifyListenersOnReplication to the second parameter \nwhen o.a.c.h.s.DeltaRequest#execute is invoked. \nFor instance, as follows.\n\n[start.]\n\nIndex: java/org/apache/catalina/ha/session/DeltaSession.java\n===================================================================\n--- java/org/apache/catalina/ha/session/DeltaSession.java\t(revision 763870)\n+++ java/org/apache/catalina/ha/session/DeltaSession.java\t(working copy)\n@@ -175,7 +175,7 @@\n                     ClassLoader[] loaders = getClassLoaders();\n                     if (loaders != null && loaders.length > 0)\n                         Thread.currentThread().setContextClassLoader(loaders[0]);\n-                    getDeltaRequest().execute(this);\n+                    getDeltaRequest().execute(this, ((ClusterManager) getManager()).isNotifyListenersOnReplication());\n                 } finally {\n                     Thread.currentThread().setContextClassLoader(contextLoader);\n                 }\n\n[end.]\n\nBest regards"}, {"count": 1, "tags": [], "text": "Fixed in revision 791524.\nSuggested for inclusion in Tomcat 6.", "attachment_id": null, "bug_id": 47478, "id": 128558, "time": "2009-07-06T08:45:59Z", "creator": "fhanik@apache.org", "creation_time": "2009-07-06T08:45:59Z", "is_private": false}]