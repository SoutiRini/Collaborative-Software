[{"count": 0, "tags": [], "creator": "mgrieder@gmx.ch", "attachment_id": 24763, "id": 133166, "time": "2009-12-29T02:46:52Z", "bug_id": 48454, "creation_time": "2009-12-29T02:46:52Z", "is_private": false, "text": "Created attachment 24763\nPatch\n\nThe internal CGIRunner-thread which reads the errorstream logs a \"Bad file descriptor\"-IOException everytime i called a program (see stacktrace at the end). The program works fine, but the log-messages disturb.\n\nI could reproduce the behaviour with Nagiostat as CGI-Program (http://nagiostat.sourceforge.net/). I think the behaviour depends on how fast the cgi-program will return, because I haven't the error with another cgi-program on the same machine.\n\nLooking at the code shows that the Process-Object in CGIRunner could be destroyed before the internal Thread has a chance to completely read the errorstream.  \n\nI fixed the problem in CGIServlet with a errorStreamReaderThread.join(...) before proc.destroy() to allow a clean processing of the errorstream.\nThis is not yet fixed in tomcat trunk / branch tc6.0.x\n\nEnvironment:\nLinux, Centos5.3 x64, JDK SUN 1.6.0_17, JBoss AS 5.1.0.GA (based on tomcat6.0)\n\nPatch: The attached Patch is against source of JBossWeb2.1.3. Improvement: The timeout of the join should be configurable.\n\njava.io.IOException: Bad file descriptor\n        at java.io.FileInputStream.readBytes(Native Method)\n        at java.io.FileInputStream.read(FileInputStream.java:199)\n        at sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:264)\n        at sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:306)\n        at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:158)\n        at java.io.InputStreamReader.read(InputStreamReader.java:167)\n        at java.io.BufferedReader.fill(BufferedReader.java:136)\n        at java.io.BufferedReader.readLine(BufferedReader.java:299)\n        at java.io.BufferedReader.readLine(BufferedReader.java:362)\n        at org.apache.catalina.servlets.CGIServlet$CGIRunner.sendToLog(CGIServlet.java:1828)\n        at org.apache.catalina.servlets.CGIServlet$CGIRunner.access$400(CGIServlet.java:1388)\n        at org.apache.catalina.servlets.CGIServlet$CGIRunner$1.run(CGIServlet.java:1663)"}, {"count": 1, "tags": [], "bug_id": 48454, "attachment_id": null, "text": "Thanks for the report and the patch.\n\nI have applied the patch + a configuration option for the timeout to trunk (Tomcat 7) and proposed it for 6.0.x.", "id": 133206, "time": "2009-12-30T02:47:51Z", "creator": "markt@apache.org", "creation_time": "2009-12-30T02:47:51Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 48454, "text": "This has been fixed in 6.0.x and will be included in 6.0.23 onwards.", "id": 133372, "time": "2010-01-06T02:29:50Z", "creator": "markt@apache.org", "creation_time": "2010-01-06T02:29:50Z", "is_private": false, "attachment_id": null}]