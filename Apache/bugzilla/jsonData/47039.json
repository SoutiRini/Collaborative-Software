[{"count": 0, "tags": [], "bug_id": 47039, "is_private": false, "text": "Created attachment 23499\nproposed patch that fixes the bug\n\n1. BUG DESCRIPTION\n\nThis bug is present in apache 2.2.3 and 2.2.9, so likely all 2.2.x versions.\n\nThe Options settings \"FollowSymlinks\" and \"SymlinksIfOwnerMatch\"\ndo not work for files included using SSI when the files are symlinks\nand located in the same directory.\n\n2. HOW TO REPRODUCE\n\nReproduce with:\n\n  * server settings\n\n    Options FollowSymlinks # usually the default\n\n    <VirtualHost testhost>\n        ServerName testhost.test.tld\n        <Directory /var/www/>\n        Options Indexes IncludesNoExec # note no FollowSymlinks\n    </VirtualHost>\n\n  * index.shtml file:\n\n    <Pre><!--#include file=\"foo.txt\"--></Pre><P>\n    <Pre><!--#include file=\"root_link_to_foo.txt\"--><Pre><P>\n    <Pre><!--#include file=\"user_link_to_foo.txt\"--><Pre>\n    \n  * data files / links:\n\n    -rw-r--r-- 1 root   root    25 Sep  7 11:47 foo.txt\n    lrwxrwxrwx 1 root   root    10 Sep  7 12:32 root_link_to_foo.txt -> foo.txt\n    lrwxrwxrwx 1 www    www      7 Sep  7 15:09 user_link_to_foo.txt -> foo.txt\n\n    (the last link is used to check if SymlinksIfOwnerMatch works)\n\nThe index.shmtl files will now show the contents of 'foo.txt'\nthree times, even though it should error out on the symlinks.\n\n3. PROPOSED PATCH\n\nThe patch below fixes things in three places:\n\n  a. in ap_sub_req_lookup_file(), ap_allow_options() is used to\n     find out if OPT_SYM_LINKS is set. However this is done on\n     the 'rnew' variable, which points to a just created subrequest.\n     The rnew->per_dir_config is still the default, so using\n     ap_sub_req_lookup_file(rnew) is wrong. We can just use\n     the main request though - it's a file in the same directory.\n\n  b. ap_directory_walk() builds a cache for requests in the same\n     directory. It overwrites the r->finfo data with a new\n     apr_stat() without APR_FINFO_LINK, so we forget if the file\n     is a symlink. We must save the old r->finfo for re-use.\n  c. If the directory cache is used, the file is not re-examined to\n     see if it is a link. We need to run resolve_symlink() if the\n     file actually is a symlink (using the saved data from b.) to\n     see if that link is allowed here.\n\nNote that no unnecessary extra overhead is introduced.\n\nThe patch applies cleanly to both 2.2.9 and 2.2.11.", "id": 126282, "time": "2009-04-16T06:54:10Z", "creator": "mikevs@xs4all.net", "creation_time": "2009-04-16T06:54:10Z", "attachment_id": 23499}, {"count": 1, "tags": [], "bug_id": 47039, "text": "Another patch to fix the issue was applied in r733754\n\n*** This bug has been marked as a duplicate of bug 45959 ***", "id": 126284, "time": "2009-04-16T08:06:13Z", "creator": "bobsiegen@googlemail.com", "creation_time": "2009-04-16T08:06:13Z", "is_private": false, "attachment_id": null}]