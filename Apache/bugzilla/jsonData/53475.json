[{"count": 0, "tags": [], "creator": "jan.asf@cominvent.com", "attachment_id": 29002, "is_private": false, "id": 160289, "time": "2012-06-27T11:35:15Z", "bug_id": 53475, "creation_time": "2012-06-27T11:35:15Z", "text": "Created attachment 29002\nEncrypted word doc which crashes POI\n\nPROBLEM\n=======\n\nWhen parsing password protected OOXML Word files, the EncryptionInfo class has explicit support for (versionMajor == 4 && versionMinor == 4 && encryptionFlags == 0x40), while all other versions are treated the same. For some enctypted DOCX documents this causes an exception:\n\njava.lang.RuntimeException: Salt size != 16 !?\n\tat org.apache.poi.poifs.crypt.EncryptionVerifier.<init>(EncryptionVerifier.java:121)\n\tat org.apache.poi.poifs.crypt.EncryptionInfo.<init>(EncryptionInfo.java:66)\n\tat org.apache.tika.parser.microsoft.OfficeParser.parse(OfficeParser.java:211)\n\nHOW TO REPRODUCE\n================\nDownload Apache Tika 1.1 (http://www.apache.org/dyn/closer.cgi/tika/tika-app-1.1.jar) and start it using \n  java -jar tika-app-1.1.jar password-is-solrcell.docx\nwhich triggers the exception. NOTE: Tika does not yet have an option to pass in a password but it crashes before we get to dectyption.\n\nSOLUTION\n========\nWe need to dig into the various versions that a doc can have and what encryption schemes to support. Here is a link to a page explaining the file formats and also providing a .NET program for dectyption (have not had the chance to test it on my example docx file though): http://www.lyquidity.com/devblog/?p=35"}, {"count": 1, "tags": [], "creator": "kiwiwings@apache.org", "attachment_id": 31004, "id": 171016, "time": "2013-11-03T20:43:35Z", "bug_id": 53475, "creation_time": "2013-11-03T20:43:35Z", "is_private": false, "text": "Created attachment 31004\npatch for ignore missing cspname element\n\nThe patch workarounds a missing data element - namely the cspname element in the EncryptionHeader. Although the MS-OFFCRYPTO doesn't mention anything of it being optional, Libre Office and Word Viewer can open the file.\n\nFurther encrypted test files with different encryption settings would be nice."}, {"count": 2, "tags": [], "text": "Created attachment 31021\nencrypted doc - AES-128 with 256 bit key\n\nThis attachment is a Word 2010 encrypted .docx - with customized encryption settings. I have only changed the keysize from 128 to 256 bits, but it might be neccessary to change other encryption settings too. Currently POI can't open this file.\n\nLibre Office 4.0 can't display the file too, but the ms word viewer does.\n\nTo test the file simply use the test class of the cspname patch - password is \"pass\"\n\nTo verify the (registry) settings, have a look in the EncryptionVerifier - the xml discriptor says 256 bits \n\nJust for further reference:\n- To change the word encryption settings, you'll need to use the \"office administration templates\" (just google for your version)\n- use the policy editor \"gpedit.msc\" and add the word adm file under user policies\n- change the registry settings over the templates\n- see also http://www.dslreports.com/forum/r20210979-Office-2007-Enabling-256bit-AES-encryption", "is_private": false, "bug_id": 53475, "id": 171104, "time": "2013-11-06T23:45:45Z", "creator": "kiwiwings@apache.org", "creation_time": "2013-11-06T23:45:45Z", "attachment_id": 31021}, {"count": 3, "tags": [], "creator": "kiwiwings@apache.org", "text": "I've forgotten to mention, that Word 2010 has two options: a password for read and for edit/write protection. Although both password are the same for the test file, this might result in an additional decryption step ...", "id": 171105, "time": "2013-11-06T23:58:21Z", "bug_id": 53475, "creation_time": "2013-11-06T23:58:21Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "apache@gagravarr.org", "attachment_id": null, "is_private": false, "id": 171131, "time": "2013-11-07T21:30:28Z", "bug_id": 53475, "creation_time": "2013-11-07T21:30:28Z", "text": "Thanks for this, applied (with minor test and comments tweaks) in r1539828."}, {"count": 5, "tags": [], "text": "Created attachment 31029\nPatch for decrypting AES-192/256\n\nAES has always a block-size of 128 bits, therefore we need take the keysize of 128, 192 or 256 bits into account.\nPart of the patch fixes a wrong usage of the bit-sizes, i.e. the IV has to be calculated by the block size (128 bits) whereas the encrypted key needs to use the key size (e.g. 256 bits).\nSee also MS-OFFCRYPTO - 2.3.4.11ff\nI'll try to provide a few more test files with other different encryption settings and haven't tested document encryption at all ...\n\n[1] http://msdn.microsoft.com/en-us/library/dd924776(v=office.12).aspx", "is_private": false, "bug_id": 53475, "id": 171165, "time": "2013-11-10T11:40:03Z", "creator": "kiwiwings@apache.org", "creation_time": "2013-11-10T11:40:03Z", "attachment_id": 31029}, {"count": 6, "tags": [], "bug_id": 53475, "attachment_id": null, "text": "Thanks for this, applied (with the odd minor tweak) in r1541009.\n\nOne thing I did notice is that the code is a little short on JavaDocs in places, and can be a bit short on comments too. If you have a few minutes, while you can still remember the code flow and meaning, it'd be great if you could do a patch to solve that too!", "id": 171190, "time": "2013-11-12T11:38:29Z", "creator": "apache@gagravarr.org", "creation_time": "2013-11-12T11:38:29Z", "is_private": false}, {"count": 7, "attachment_id": 31061, "bug_id": 53475, "text": "Created attachment 31061\nJCE-check added to tests and AgileDecryptor\n\nThis patch contains the Assume-Check if the JCE restrictions are in place, which Dominik recommended.\n\nWith the Junit3 code, the Assume didn't work, so I needed to convert it to Junit4 annotated code.\n\nFurthermore I've removed some obsolete lines, as the Biff8EncryptionKey is not needed with Agile-Decryption.\n\nI'll add more javadocs when the encryption stuff is finished and also a comment about the JCE policies in the website docs.", "id": 171362, "time": "2013-11-21T00:00:13Z", "creator": "kiwiwings@apache.org", "creation_time": "2013-11-21T00:00:13Z", "tags": [], "is_private": false}, {"count": 8, "attachment_id": null, "bug_id": 53475, "is_private": false, "id": 171371, "time": "2013-11-21T11:18:30Z", "creator": "apache@gagravarr.org", "creation_time": "2013-11-21T11:18:30Z", "tags": [], "text": "Thanks, latest patch (applied with a few minor tweaks to comments/error messages) in r1544121."}, {"count": 9, "tags": [], "bug_id": 53475, "attachment_id": 31073, "text": "Created attachment 31073\npatch for encryption support - Part 1 - refactor crypt code\n\nThis is part 1 (of presumably 4-5 parts).\n\nAs this is a bigger change, I'll post changes as soon as a certain feature compiles/tests stable.\n\nI plan the following parts:\n- Part 1: refactor decryption code, so I can use it for encryption\n- Part 2: xmlbeans support for encryption descriptor (see details at Part 2)\n- Part 3: encryption classes\n- Part 4: move en-/decryption code out of main-poi???\n\nAs part 2 will break the release, i.e. you'll need xmlbeans for the main-poi, you might want to wait until all parts are out and of course I wouldn't mind a discussion \"xmlbeans vs. static xml strings in code\"\n\nCurrently the patches will be based on the trunk, so part X contains changes of part X-1,... I'll update the diffs, if predecessor parts have been applied", "id": 171429, "time": "2013-11-24T11:34:27Z", "creator": "kiwiwings@apache.org", "creation_time": "2013-11-24T11:34:27Z", "is_private": false}, {"count": 10, "tags": [], "creator": "apache@gagravarr.org", "text": "Anything that's to do with xmlbeans needs to live in the poi-ooxml jar, not the main poi one. Possibly that means we need to move some of the encrypt/decrypt code into the poi-ooxml jar\n\nAlso, it might make sense to open a new bug for this, rather than using this one, so it's easier to track the new features", "id": 171430, "time": "2013-11-24T18:26:46Z", "bug_id": 53475, "creation_time": "2013-11-24T18:26:46Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "creator": "kiwiwings@apache.org", "attachment_id": null, "id": 171455, "time": "2013-11-26T23:46:49Z", "bug_id": 53475, "creation_time": "2013-11-26T23:46:49Z", "is_private": false, "text": "(In reply to comment #10)\n> Also, it might make sense to open a new bug for this, rather than using this\n> one, so it's easier to track the new features\n\nI've created the bug entry #55818 and will log my progress there ..."}]