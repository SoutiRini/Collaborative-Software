[{"count": 0, "tags": [], "creator": "jakub@pakamera.com.pl", "attachment_id": null, "text": "Hi,\n\nI upgraded Tomcat from 8.0.22 to 8.0.36 and all my website doesn't work anymore because of one simple problem.\n\nI have this code in JSP:\n\n<%\nHashMap<String,String> params = (HashMap)((HashMap)request.getParameterMap()).clone();\npageContext.setAttribute(\"params\",params);\nparams.put(\"data\",\"xx\");\n%>\n\nIt used to work before, for many many year.\nNow, suddenly last line throws an exception:\n \njava.lang.IllegalStateException: No modifications are allowed to a locked ParameterMap\n\n\nI understand why parameter map is locked, but that's why I made a clone.\nThe thing is, with Tomcat 8.0.22 and before this exception was not fired.\n\nI think \"clone\" should not copy \"locked\" class attribute or there should be an option in configuration to keep Tomcat compatible with previous version, on request.", "id": 191971, "time": "2016-06-27T15:28:00Z", "bug_id": 59761, "creation_time": "2016-06-27T15:28:00Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 59761, "attachment_id": null, "id": 191983, "time": "2016-06-27T20:13:04Z", "creator": "jakub@pakamera.com.pl", "creation_time": "2016-06-27T20:13:04Z", "is_private": false, "text": "I think the problem is in org.apache.catalina.core.ApplicationHttpRequest, parseParameters() method.\nline 726: \n((ParameterMap<String,String[]>) parameters).setLocked(true);\n\nIn my opinion parameters should not be locked here. This is huge change comparing to older versions."}, {"count": 2, "tags": [], "creator": "mgrigorov@apache.org", "attachment_id": null, "text": "Why don't you use normal copy constructors instead of cloning ?\nMap myMap = new HashMap(originalMap)\n\nThis way you will not depend on implementation details.", "id": 191992, "time": "2016-06-28T08:45:38Z", "bug_id": 59761, "creation_time": "2016-06-28T08:45:38Z", "is_private": false}, {"count": 3, "tags": [], "text": "Well, of course copy constructor is better.\nBut don't focus on this line too much - it was just an example.\nMore important it in previous Tomcat version parameterMap was not locked and I could change or add new parameter to this map easily in JSP. \nThis code was valid for all the years in JSP file:\n\nrequest.getParameterMap().put(\"key\", \"value\");\n\nSuddenly developers decided to lock it, \"put\" throws exception\nand all my web apps doesn't work anymore. \n\nIf using \"put\" on parameterMap in JSP is incorrect, it should, at least, be deprecated for a while.\n\nNow I have to go through code of hundreds of pages and add some code to make a copy of parameterMap.", "attachment_id": null, "id": 191994, "creator": "jakub@pakamera.com.pl", "time": "2016-06-28T09:00:51Z", "bug_id": 59761, "creation_time": "2016-06-28T09:00:51Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 59761, "attachment_id": null, "id": 191995, "time": "2016-06-28T09:05:55Z", "creator": "mgrigorov@apache.org", "creation_time": "2016-06-28T09:05:55Z", "is_private": false, "text": "https://bz.apache.org/bugzilla/show_bug.cgi?id=58946\n\nThis is the ticket that made the change.\nAccording to http://docs.oracle.com/javaee/6/api/javax/servlet/ServletRequest.html#getParameterMap() the returned value must be an immutable map.\nSo it was a bug that it was allowed to put more items into it.\nI'm afraid you will have to use older version of Tomcat until you fix your application(s)."}, {"attachment_id": null, "tags": [], "bug_id": 59761, "text": "Yes, I know. \nMay I ask here for an enhancement then and a new configuration parameter which I could pass to a virtual machine, to keep my apps working on new Tomcat versions?", "count": 5, "id": 191996, "time": "2016-06-28T09:22:10Z", "creator": "jakub@pakamera.com.pl", "creation_time": "2016-06-28T09:22:10Z", "is_private": false}, {"count": 6, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "text": "It could be possible to override clone so that the cloned ParameterMap object isn't locked. Would that be legitimate ?", "id": 192000, "time": "2016-06-28T11:47:50Z", "bug_id": 59761, "creation_time": "2016-06-28T11:47:50Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 59761, "attachment_id": null, "id": 192001, "time": "2016-06-28T12:00:53Z", "creator": "jakub@pakamera.com.pl", "creation_time": "2016-06-28T12:00:53Z", "is_private": false, "text": "Well, for me it would be very helpful, but I think it won't address the core of this problem."}, {"count": 8, "tags": [], "bug_id": 59761, "attachment_id": null, "is_private": false, "id": 192008, "time": "2016-06-28T20:17:58Z", "creator": "chris@christopherschultz.net", "creation_time": "2016-06-28T20:17:58Z", "text": "Messing-around with the ParameterMap might be considered a security issue. Producing a writable clone makes sense, but I'm not convinced that a clone method that ignored the \"lock\" status would follow the contract for clone().\n\nI'm -1 on changing the behavior of the parameter map in this way. If the client code wants a clone that doesn't have Tomcat's parameter Map's restrictions, then that client code should create a new Map of the appropriate type and copy the mappings from one to the other."}]