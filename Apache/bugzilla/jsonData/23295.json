[{"count": 0, "tags": [], "bug_id": 23295, "text": "In my frontend apache, I use a .htaccess like this one:\n------------------------------------------------\nRewriteEngine on\nRewriteRule (.*) http://backend/somedir/$1 [P]\n------------------------------------------------\n\nbut for certain request like this one:\nhttp://frontend/the%20url/pic.jpg\nI got a 404 error \"http://frontend/the\" not found\n(because frontend don't escape the request before asking the backend...\n\nI don't know if the fix should be added to mod_rewrite or to mod_proxy...\nbut I fix like this:\n\n/usr/local/src/httpd-2.0.47/modules/mappers # diff mod_rewrite.c.dist \nmod_rewrite.c\n2165a2166\n>       r->filename = ap_escape_uri(r->pool, r->filename);\n\nRegards, Benoit DEVIJVER\n(perhaps is there a way to do it in the .htaccess, but I didn't find...)", "id": 44385, "time": "2003-09-20T18:51:20Z", "creator": "benoit-apache@pub.devijver.org", "creation_time": "2003-09-20T18:51:20Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "bp@thinkpink.com", "attachment_id": null, "text": "URI's are unescaped when processing starts but aren't escaped before being passed to the proxy.  \nThe query string needs to be escaped in addition to the filename.  Here are my diffs for 2.0.48:\n\n*** new_mod_rewrite.c   Mon Mar  1 10:49:17 2004\n--- mod_rewrite.c       Fri Mar  5 10:23:26 2004\n***************\n*** 1245,1250 ****\n--- 1245,1257 ----\n                                            \"?\", r->args, NULL);\n              }\n  \n+             if (rulestatus != ACTION_NOESCAPE && ((skip = is_absolute_uri(r->filename+6)) > 0)) {\n+                 r->filename = escape_absolute_uri(r->pool, r->filename, skip+6);\n+                 if (r->args != NULL) {\n+                     r->args = ap_escape_uri(r->pool, r->args);\n+                 }\n+             }\n+             \n              /* now make sure the request gets handled by the proxy handler */\n              r->proxyreq = PROXYREQ_REVERSE;\n              r->handler  = \"proxy-server\";\n\n", "id": 53526, "time": "2004-03-05T18:33:06Z", "bug_id": 23295, "creation_time": "2004-03-05T18:33:06Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 23295, "attachment_id": null, "id": 55179, "time": "2004-04-02T18:54:20Z", "creator": "bp@thinkpink.com", "creation_time": "2004-04-02T18:54:20Z", "is_private": false, "text": "Ignore that code.  Escaping of URL parts and query terms is happening OK.\n\nFor me, the problem was occurring when I moved a piece of text from the path to\nthe query string.  For example:\n\nRewriteRule ^foo/(.*)   http://another.host.name/foo?page=$1 [qsappend,P]\n\nIn this case, $1 will not be escaped correctly for the query string: it could\nstill contain unescaped ampersands, question marks or equals.  To fix this, one\ncan easily encode $1 using an external program (or hack the source to use a\nform-encoder natively, as I did.)\n"}, {"count": 3, "tags": [], "text": "This looks like a probable duplicate of Bug 13577.\n\nSince that is down as probably fixed in recent patches to mod_proxy, can you\ncheck whether this one is still reproducable with the updates?  The key to it is\nthe June 29th mod_proxy patch which fixed bug 15207 (mod_proxy mangling URLs in\na very similar manner to this bug).  Need mod_rewrite+proxy users to test\nwhether it fixes this case too.", "attachment_id": null, "id": 64231, "creator": "nick@webthing.com", "time": "2004-09-26T16:20:56Z", "bug_id": 23295, "creation_time": "2004-09-26T16:20:56Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 23295, "attachment_id": null, "id": 84272, "time": "2006-01-05T19:02:05Z", "creator": "nekozzz@mail.goo.ne.jp", "creation_time": "2006-01-05T19:02:05Z", "is_private": false, "text": "At least, 2.0.54 has same problem.\nAfter per-dir context rewriting ,the request doesn't\nhandled by canonicalise handler of proxy-http.\nthen mod_rewrite needs to canonicalise url on the case,\nsuch like redirection case.\nI thik that hook-fixup() needs a patch."}, {"count": 5, "tags": [], "bug_id": 23295, "attachment_id": null, "text": "*** Bug 32328 has been marked as a duplicate of this bug. ***", "id": 100195, "time": "2007-03-08T13:11:30Z", "creator": "postmaster@raasu.org", "creation_time": "2007-03-08T13:11:30Z", "is_private": false}, {"count": 6, "tags": [], "bug_id": 23295, "text": "The problem still occurs in Apache 2.0.59. mod_rewrite with a [P] RewriteRule \nremoves the percent-encoding for umlaut characters from the URL.", "id": 100588, "time": "2007-03-19T05:47:16Z", "creator": "ulf.moeller@secardeo.com", "creation_time": "2007-03-19T05:47:16Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 23295, "text": "It turns out that the problem only occurs when the RewriteRule is defined \ninside a location. Outside of locations the encoding is correct.\n\n", "id": 100737, "time": "2007-03-21T10:03:52Z", "creator": "ulf.moeller@secardeo.com", "creation_time": "2007-03-21T10:03:52Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "creator": "nick@webthing.com", "attachment_id": null, "text": "Looks as if the patch for PR #34602 should fix this.  Please reopen if I'm wrong\n(and if it's still a bug).\n\n*** This bug has been marked as a duplicate of 34602 ***", "id": 107957, "time": "2007-09-10T05:06:37Z", "bug_id": 23295, "creation_time": "2007-09-10T05:06:37Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 23295, "text": "For comment #0\n\n------------------------------------------------\nRewriteEngine on\nRewriteRule (.*) http://backend/somedir/$1 [P]\n------------------------------------------------\n\nI think this work correctly.\nIf you need to pass the url encoded to the proxied web server, you need to do\nthis  :\n\n------------------------------------------------------------\nFirst, add this line to the server config :\nRewriteMap encode int:escape\n\nSecond, use this rewrite rule to your .htaccess file :\nRewriteRule (.*) http://backend/somedir/${encode:$1} [P]\n------------------------------------------------------------\n\nI'm using a similar configuration and rules to proxy all php files to another\nserver.\nMy configuration is :\n\nIn server config file :\n<IfModule mod_rewrite.c>\n        RewriteEngine On\n        RewriteMap encode int:escape\n</IfModule>\n\nAnd to process php files on backend server, i also added this to server config\nfile :\n<Files *.php>\n        RewriteEngine On\n        RewriteOptions inherit\n        RewriteCond %{SCRIPT_FILENAME} -f\n        RewriteRule (.*)$ http://%{SERVER_NAME}:81${encode:%{REQUEST_URI}} [P]\n</Files>\n", "id": 108244, "time": "2007-09-16T14:48:01Z", "creator": "roms2000@free.fr", "creation_time": "2007-09-16T14:48:01Z", "is_private": false, "attachment_id": null}]