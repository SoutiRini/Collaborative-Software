[{"count": 0, "tags": [], "bug_id": 53178, "attachment_id": 28709, "text": "Created attachment 28709\nSmall example for the bug\n\nHi,\n\nI got the following problem, I try to read the cell formula from an HSSFCell, of cell type \"HSSFCell.CELL_TYPE_FORMULA\":\n\nif (cell.getCellType() == HSSFCell.CELL_TYPE_FORMULA) {\n  String formula = cell.getCellFormula();\n}\n\n\nThis all works well, unless in the attached excel sheet, where I get the following excpetion:\n\nException in thread \"main\" java.lang.RuntimeException: Unexpected tAttr: org.apache.poi.ss.formula.ptg.AttrPtg []\n        at org.apache.poi.ss.formula.FormulaRenderer.toFormulaString(FormulaRenderer.java:87)\n        at org.apache.poi.hssf.model.HSSFFormulaParser.toFormulaString(HSSFFormulaParser.java:83)\n        at org.apache.poi.hssf.usermodel.HSSFCell.getCellFormula(HSSFCell.java:628)\n\n\nI don't really see the point. I assume, this is because the formula in the cell is rather long:\n\n=WENN('E:\\Berichtswesen\\Programme\\pis_esm.xla'!Twert(#BEZUG!C320;\"h\";#BEZUG!;#BEZUG!)/1000<LTC_ENTRY_FLEX_MIN/(23+ABS(SOWI-2))*1000-1;1;WENN('E:\\Berichtswesen\\Programme\\pis_esm.xla'!Twert(#BEZUG!C320;\"h\";#BEZUG!;#BEZUG!)/1000>LTC_ENTRY_FLEX_MAX/(23+ABS(SOWI-2))*1000+1;1;0))", "id": 158741, "time": "2012-05-02T14:43:00Z", "creator": "npaetsch@psi.de", "creation_time": "2012-05-02T14:43:00Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 53178, "attachment_id": null, "text": "I have to add, that the same exception occurs for the following formula:\n\n=WENN(('E:\\Berichtswesen\\Programme\\pis_esm.xla'!Tmark($Q$12;\"STD\";$B$4;$B$4)) = \"N\";\"No Allocation\";\"\")\n\nSo, somehow this exception occurs due to the nested functions.", "id": 158770, "time": "2012-05-03T08:14:35Z", "creator": "npaetsch@psi.de", "creation_time": "2012-05-03T08:14:35Z", "is_private": false}, {"count": 2, "tags": [], "creator": "npaetsch@psi.de", "is_private": false, "text": "The exception is thrown in org.apache.poi.ss.formula.ForumlaRenderer.\n\nWhen stepping through the source code while parsing the Excel-formula \n\n{=WENN(('E:\\Berichtswesen\\Programme\\pis_esm.xla'!Tmark($Q$12;\"STD\";$B$4;$B$4)) = \"N\";\"No Allocation\";\"\")}\n\nas indicated in my second comment, the following stack is already set up\n\nstack\tStack<E>  (id=135)\t\n\tcapacityIncrement\t0\t\n\telementCount\t2\t\n\telementData\tObject[10]  (id=139)\t\n\t\t[0]\t\"(Tmark(#REF!,\"STD\",#REF!,#REF!))=\"N\"\" (id=143)\t\n\t\t[1]\t\"\"No Allocation\"\" (id=1046)\t\n\t\t[2]\tnull\t\n\t\t[3]\tnull\t\n\t\t[4]\tnull\t\n\t\t[5]\tnull\t\n\t\t[6]\tnull\t\n\t\t[7]\tnull\t\n\t\t[8]\tnull\t\n\t\t[9]\tnull\t\n\tmodCount\t18\t\n\nThe next element ptgs[13] which is of instance AttrPtg then causes the exception.", "id": 158775, "time": "2012-05-03T09:06:11Z", "bug_id": 53178, "creation_time": "2012-05-03T09:06:11Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "dominik.stadler@gmx.at", "is_private": false, "text": "Still reproducible in 3.14-beta1 with the following unit-test\n\n    @Test\n    public void test53178() {\n        Workbook wb = HSSFTestDataSamples.openSampleWorkbook(\"53178.xls\");\n        Sheet sheet = wb.getSheetAt(0);\n        Row row = sheet.getRow(0);\n        Cell cell = row.getCell(0);\n\n        assertEquals(Cell.CELL_TYPE_FORMULA, cell.getCellType());\n        assertEquals(\"\", cell.getCellFormula());\n    }", "id": 188534, "time": "2016-02-17T21:41:39Z", "bug_id": 53178, "creation_time": "2016-02-17T21:41:39Z", "attachment_id": null}]