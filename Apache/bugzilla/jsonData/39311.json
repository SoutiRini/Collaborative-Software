[{"count": 0, "tags": [], "creator": "ovchinnikov@slavgrad.ru", "text": "When several Graceful Restart requests (in my case, due to Log rotaiton) \ncoincide with many HTTP-requests Apache crashes with the following message in \nerror log:\n[Thu Apr 13 13:03:40 2006] [notice] Graceful restart requested, doing restart\n[Thu Apr 13 13:03:40 2006] [emerg] (2)No such file or directory: Couldn't \ninitialize cross-process lock in child\n[Thu Apr 13 13:03:41 2006] [notice] Apache/2.0.50 (FreeBSD) PHP/4.3.6 \nconfigured -- resuming normal operations\n[Thu Apr 13 13:03:41 2006] [alert] Child 99131 returned a Fatal \nerror...\\nApache is exiting!\n\nIt seems to be race condition and heavily reproducible.\nMore detailed description is provided on:\nhttp://mail-archives.apache.org/mod_mbox/httpd-dev/200403.mbox/%\n3c20040314201218.GB22315@clove.org%3e\n\nWe updated server to version 2.0.55, but source code analysis \n(file /server/mpm/prefork/prefork.c), reviewing of CHANGES file and bugzilla \nshows that bug is unfixed \n\nOur Server OS is FreeBSD 4.9;\nApache is running standart config with 6 virtual hosts\n\nThe simpliest path to patch is to change line 489 \nof /server/mpm/prefork/prefork.c (v 2.0.55)\nfrom\nclean_child_exit(APEXIT_CHILDFATAL);\nto\nclean_child_exit(APEXIT_CHILDSICK);\n\nI'm not Unix programmer, so didn't check the effect, consider it a suggestion", "id": 88043, "time": "2006-04-14T10:20:53Z", "bug_id": 39311, "creation_time": "2006-04-14T10:20:53Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "ovchinnikov@slavgrad.ru", "text": "We updated server to 2.0.55 and today got the same error and server crash.\nHere's our error log:\n\n[Thu May 04 00:04:30 2006] [notice] Graceful restart requested, doing restart\n[Thu May 04 00:04:30 2006] [emerg] (2)No such file or directory: Couldn't \ninitialize cross-process lock in child\n[Thu May 04 00:04:32 2006] [notice] Apache/2.0.55 (FreeBSD) PHP/4.3.6 \nconfigured -- resuming normal operations\n[Thu May 04 00:04:32 2006] [alert] Child 26695 returned a Fatal error... Apache \nis exiting!\n", "count": 1, "id": 88794, "time": "2006-05-04T05:16:22Z", "bug_id": 39311, "creation_time": "2006-05-04T05:16:22Z", "is_private": false}, {"count": 2, "tags": [], "creator": "james@nyi.net", "text": "I use graceful restarting to do log rotation and this is the first time I came\nacross this. I guess the race condition in the new version only comes up rarely?\n\n[root@web2 ~]# tail -f -n 50 /var/log/httpd-error.log\n...\n[Wed Feb 28 13:00:01 2007] [notice] Graceful restart requested, doing restart\n[Wed Feb 28 13:00:01 2007] [emerg] (2)No such file or directory: Couldn't\ninitialize cross-process lock in child (/var/run/accept.lock.39428) (5)\n[Wed Feb 28 13:00:01 2007] [warn] (22)Invalid argument: Failed to enable the\n'httpready' Accept Filter\n[Wed Feb 28 13:00:01 2007] [notice] Apache configured -- resuming normal operations\n[Wed Feb 28 13:00:01 2007] [alert] Child 37499 returned a Fatal error... Apache\nis exiting!\n[Wed Feb 28 13:00:56 2007] [warn] pid file /var/run/httpd.pid overwritten --\nUnclean shutdown of previous Apache run?\n[Wed Feb 28 13:00:56 2007] [notice] Apache configured -- resuming normal operations\n\n[root@web2 ~]# httpd -v\nServer version: Apache/2.2.3\nServer built:   Sep 13 2006 14:13:54\n", "id": 99906, "time": "2007-02-28T10:23:19Z", "bug_id": 39311, "creation_time": "2007-02-28T10:23:19Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 39311, "text": "After several graceful restarts after logrotate, we sporadically get:\n\n[Wed Sep 26 03:00:02 2007] [notice] Graceful restart requested, doing restart\n[Wed Sep 26 03:00:02 2007] [error] (9)Bad file descriptor: apr_socket_accept:\n(client socket)\n[Wed Sep 26 03:00:02 2007] [error] (9)Bad file descriptor: apr_socket_accept:\n(client socket)\nSyntax error on line 101 of /etc/apache2/server-tuning.conf:\nInvalid command 'BrowserMatch', perhaps misspelled or defined by a module not\nincluded in the server configuration\n[Wed Sep 26 03:10:02 2007] [warn] pid file /var/run/httpd2.pid overwritten --\nUnclean shutdown of previous Apache run?\n[Wed Sep 26 03:10:02 2007] [notice] Apache/2.2.3 (Linux/SUSE) configured --\nresuming normal operations\n", "id": 108722, "time": "2007-09-27T07:16:54Z", "creator": "axelseaa@modevia.com", "creation_time": "2007-09-27T07:16:54Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 39311, "text": "I've got a simple script for log rotation.\nfor every site script does:\n-----------------------------------\ndate=`date '+%Y%m%d'`\nmv apache_access_log apache_access_log.$date\nmv apache_error_log apache_error_log.$date\napachectl graceful\n-----------------------------------\n\nand it worked till last midnight.\nWhen I tried to open site today in the morning, apache was down.\nI've run apachectl graceful from console. After that ps shows me:\n---------------------------------------------------------------------------------\n# ps axuwww|grep http\nwww       99087  6.5  1.3 109664 26812  ??  S     8:58AM   0:00.83 /usr/local/sbin/httpd -k graceful\nwww       96707  3.3  1.4 107792 28596  ??  S     8:56AM   0:04.33 /usr/local/sbin/httpd -k graceful\nwww       99125  2.5  1.2 108120 25552  ??  S     8:58AM   0:00.28 /usr/local/sbin/httpd -k graceful\nwww       99123  2.2  1.1 107212 23364  ??  S     8:58AM   0:00.25 /usr/local/sbin/httpd -k graceful\nwww       83161  2.1  1.6 107200 33084  ??  R     8:41AM   0:26.33 /usr/local/sbin/httpd -k graceful\nwww       88613  1.9  1.7 111304 35672  ??  S     8:47AM   0:16.29 /usr/local/sbin/httpd -k graceful\nwww       96706  1.8  1.3 107756 27556  ??  S     8:56AM   0:03.58 /usr/local/sbin/httpd -k graceful\nwww       51619  1.6  1.5 107196 31008  ??  S     8:06AM   1:08.64 /usr/local/sbin/httpd -k graceful\nwww       99124  0.9  1.0 107056 21636  ??  S     8:58AM   0:00.14 /usr/local/sbin/httpd -k graceful\nwww       99121  0.8  1.0 107068 19840  ??  S     8:58AM   0:00.10 /usr/local/sbin/httpd -k graceful\nwww       81090  0.7  1.6 107204 33268  ??  S     8:39AM   0:30.71 /usr/local/sbin/httpd -k graceful\nwww       99122  0.6  1.0 107064 21216  ??  S     8:58AM   0:00.13 /usr/local/sbin/httpd -k graceful\nwww       88648  0.5  1.6 108204 33188  ??  S     8:47AM   0:18.60 /usr/local/sbin/httpd -k graceful\nroot      40282  0.0  0.7 105504 15304  ??  Ss    7:54AM   0:00.55 /usr/local/sbin/httpd -k graceful\nwww       40283  0.0  0.4 12316  8520  ??  I     7:54AM   0:00.00 /usr/local/sbin/httpd -k graceful\nwww       66731  0.0  0.8 106812 15700  ??  I    12:20AM   0:00.00 /usr/local/sbin/httpd\nwww       66733  0.0  0.8 106812 15700  ??  I    12:20AM   0:00.00 /usr/local/sbin/httpd\nwww       66735  0.0  0.8 106780 15660  ??  I    12:20AM   0:00.00 /usr/local/sbin/httpd\nwww       66736  0.0  0.8 106780 15660  ??  I    12:20AM   0:00.00 /usr/local/sbin/httpd\nroot      99250  0.0  0.0  1592   908  p5  S+    8:58AM   0:00.00 grep http\n----------------------------------------------------------------\n\nThen I made /usr/local/etc/rc.d/apache restart and all proccess \"httpd -k graceful\" was killed, and then everything is work ok.\n", "id": 119100, "time": "2008-07-29T07:45:43Z", "creator": "alexey.portnov@gmail.com", "creation_time": "2008-07-29T07:45:43Z", "is_private": false, "attachment_id": null}, {"count": 5, "attachment_id": null, "bug_id": 39311, "text": "CC myself on FreeBSD related bugs", "id": 124157, "time": "2009-01-18T16:19:13Z", "creator": "pgollucci@apache.org", "creation_time": "2009-01-18T16:19:13Z", "tags": [], "is_private": false}, {"count": 6, "tags": [], "bug_id": 39311, "attachment_id": 27693, "id": 150162, "time": "2011-10-05T00:01:36Z", "creator": "smichael@rightnow.com", "creation_time": "2011-10-05T00:01:36Z", "is_private": false, "text": "Created attachment 27693\nPatch race condition during high load and a graceful restart\n\nThis patch applies cleanly to 2.2-HEAD as well as 2.2.3 Red Hat.  \n\nThe patch takes a look at the generation of the child process that is exiting.  If the child is from a previous generation then fatal errors are ignored.  Only current generation children can cause the death of the parent."}, {"count": 7, "text": "Changing this from Freebsd to All (it affects all prefork platforms not just Freebsd).  Changing from 2.2.3 to 2.2-HEAD.\n\nThis is a long standing bug that apparently goes back to at least 2.0.55 based on this thread.  The jist of the bug is that a new prefork process is spawned  during a graceful event.  The old generation process tries to acquire a lock that is removed during the graceful reconfiguration.  This failure to acquire a lock is a fatal error and gets passed up the chain to the parent process which then exits.\n\nI have attached a patch that I believe fixes this problem (in prefork.c only).  This patch applies cleanly to 2.2-HEAD as well as 2.2.3 Red Hat.  The patch takes a look at the generation of the child process that is exiting.  If the child is from a previous generation then fatal errors are ignored.  Only current generation children can cause the death of the parent.", "bug_id": 39311, "attachment_id": null, "id": 150163, "time": "2011-10-05T00:05:28Z", "creator": "smichael@rightnow.com", "creation_time": "2011-10-05T00:05:28Z", "tags": [], "is_private": false}, {"count": 8, "tags": [], "bug_id": 39311, "text": "Committed as r1180742 with some tweaks: Shawn's patch ignored the child if its generation could not be determined. The committed patch still exits in this case.\n\nIt would be nice if someone could verify that this still fixes the issue.", "id": 150392, "time": "2011-10-09T23:13:41Z", "creator": "sf@sfritsch.de", "creation_time": "2011-10-09T23:13:41Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 39311, "attachment_id": null, "id": 154184, "time": "2012-02-26T16:39:45Z", "creator": "sf@sfritsch.de", "creation_time": "2012-02-26T16:39:45Z", "is_private": false, "text": "fixed in 2.4.1"}]