[{"count": 0, "tags": [], "bug_id": 51110, "attachment_id": null, "is_private": false, "id": 145965, "time": "2011-04-22T22:07:30Z", "creator": "acwwat@gmail.com", "creation_time": "2011-04-22T22:07:30Z", "text": "= Overview =\nWhen using a <url> as the nested resource the <resourceexists> condition, my expectation is that the condition should evaluate to true if the remote file referred to by the URL does not exist. However, the sample test case below demonstrates otherwise. Looking at the URLResource code, it seems like URLConnection.connect() is used for the evaluation. I've done some test and notice that this method returns true as long as the connection to the server can be made.\n\nI am not sure whether this is by design, but I find that in order to truly determine if the remote file exists, the URLConnection.getContent() method must be called. It is when the method returns FileNotFoundException as expected (at least for files . I assume that a call to conn.getContent() can be added to isExists() in URLResource, but I am not sure what to do with the UnknownServiceException that it throws. Perhaps someone can comment more on this to determine what the best solution is.\n\n= Steps to Reproduce =\nRun the following sample Ant build file on a system with Internet access.\n\n<project name=\"build\" default=\"all\">\n  <target name=\"all\">\n    <fail message=\"Resource does not exist.\">\n      <condition>\n        <not>\n          <resourceexists>\n            <url url=\"http://ant.apache.org/nosuchfile.html\" />\n          </resourceexists>\n        </not>\n      </condition>\n    </fail>\n  </target>\n</project>\n\n= Actual Result =\nAnt build fails with the message \"Resource does not exist.\"\n\n= Expected Result =\nAnt build completes \"successfully\"."}, {"count": 1, "tags": [], "creator": "bodewig@apache.org", "attachment_id": null, "text": "would getHeaderFields work as well?", "id": 146312, "time": "2011-05-13T15:15:27Z", "bug_id": 51110, "creation_time": "2011-05-13T15:15:27Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 51110, "text": "(In reply to comment #1)\n> would getHeaderFields work as well?\n\nI just did some test with the URL API and getHeaderFields() won't fail even if the resource does not exist. It seems that only getContent() and getOutputStream() would fail.", "id": 146315, "time": "2011-05-13T19:14:38Z", "creator": "acwwat@gmail.com", "creation_time": "2011-05-13T19:14:38Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 51110, "text": "Created attachment 28307\nPatch to add check for true existence of a URL resource\n\nThe patch is for src/main/org/apache/tools/ant/types/resources/URLResource.java.", "id": 153709, "time": "2012-02-13T02:09:16Z", "creator": "acwwat@gmail.com", "creation_time": "2012-02-13T02:09:16Z", "is_private": false, "attachment_id": 28307}, {"count": 4, "tags": [], "creator": "acwwat@gmail.com", "attachment_id": null, "is_private": false, "id": 153710, "time": "2012-02-13T02:11:22Z", "bug_id": 51110, "creation_time": "2012-02-13T02:11:22Z", "text": "It seems that URLConnection.getContent() and URLConnection.getInputStream() are the only methods that can generate FileNotFoundException when the resource really does not exist. I've created a patch to use the latter, which will avoid unused data from being downloaded. Please review and commit if everything looks OK. Thanks a lot."}, {"count": 5, "text": "Thanks Anthony.\n\nI'm not sure what happens if the closeConnection to isExists is false.  With your patch we may call getInputStream, close the stream and call it again later.", "bug_id": 51110, "attachment_id": null, "id": 153742, "time": "2012-02-13T16:58:09Z", "creator": "bodewig@apache.org", "creation_time": "2012-02-13T16:58:09Z", "tags": [], "is_private": false}, {"count": 6, "tags": [], "bug_id": 51110, "attachment_id": 28324, "is_private": false, "id": 153748, "time": "2012-02-13T19:34:39Z", "creator": "acwwat@gmail.com", "creation_time": "2012-02-13T19:34:39Z", "text": "Created attachment 28324\nUpdated patch with better connection state handling"}, {"count": 7, "tags": [], "bug_id": 51110, "is_private": false, "text": "(In reply to comment #6)\n> Created attachment 28324 [details]\n> Updated patch with better connection state handling\n\nThanks Stefan for your review. I've improved the patch to reconnect after the InputStream verification. Please take another look at your convenience and let me know if it looks better now.", "id": 153749, "time": "2012-02-13T19:35:59Z", "creator": "acwwat@gmail.com", "creation_time": "2012-02-13T19:35:59Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 51110, "is_private": false, "text": "Created attachment 28330\nAlternative patch using the HTTP status code\n\nThanks again.\n\nI think we have a problem, though.  The whole point of the closeConnection parameter is to avoid opening more connections to the server than necessary.  With your patch we could simply ignore the flag and always close the connection as the result would be the same.\n\nOTOH your experiments show there is no way to be absolutely sure the URL actually is connected to an existing resource without using a method that makes the connection unusable for subsequent calls.  Is this correct?\n\nI have extended your example to cover file and jar URLs as well and the current code works for those.  I need to dig out an ftp-server to verify there.\n\nFor HTTP URLs we could check the status-code and in fact the patch I'll attach does just that and makes your test pass.  In my simplistic patch I assume the URLConnection already handles redirects so any 1xx, 2xx and 3xx should mean the resource exists.", "id": 153775, "time": "2012-02-14T11:35:20Z", "creator": "bodewig@apache.org", "creation_time": "2012-02-14T11:35:20Z", "attachment_id": 28330}, {"count": 9, "tags": [], "creator": "bodewig@apache.org", "attachment_id": null, "text": "My patch (and thus Ant's current code) doesn't work for FTP.", "id": 153776, "time": "2012-02-14T11:40:39Z", "bug_id": 51110, "creation_time": "2012-02-14T11:40:39Z", "is_private": false}, {"attachment_id": 28331, "tags": [], "bug_id": 51110, "text": "Created attachment 28331\nCombining both approaches\n\nAt least for me this patch works for http, ftp, file and jar URLs (at least jar URLs on top of file URLs).", "count": 10, "id": 153777, "time": "2012-02-14T11:58:31Z", "creator": "bodewig@apache.org", "creation_time": "2012-02-14T11:58:31Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 51110, "text": "svn revision 1577796", "count": 11, "id": 173842, "time": "2014-03-15T07:16:59Z", "creator": "bodewig@apache.org", "creation_time": "2014-03-15T07:16:59Z", "is_private": false}]