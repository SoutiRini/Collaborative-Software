[{"count": 0, "tags": [], "creator": "rruiz@gridsystems.com", "attachment_id": null, "id": 44212, "time": "2003-09-15T17:00:44Z", "bug_id": 23180, "creation_time": "2003-09-15T17:00:44Z", "is_private": false, "text": "My server randomly enters in a deadlock condition during startup.\n\nFrom the thread stack dump below, it seems to be between \"Thread-14\" \nand \"Thread-26\" threads.\n\nThe server has one HTTPS and two HTTP connector instances (all three are \nCoyoteConnector instances). Sometimes, my axis servlet is being called BEFORE \nSSL connector setup is complete. When this happens, the deadlock appears.\n\nConfiguration:\n  - Sun JDK 1.3.1_01\n  - Tomcat 4.1.24\n  - JSSE 1.0.3\n  - Axis 1.0\n\nThread Stack Dump Excerpt:\n\n\"Thread-nn\" daemon prio=5 tid=0xcfce408 nid=0x960 waiting for monitor entry \n[0xdadf000..0xdadfdbc]\n        at org.apache.axis.transport.http.AxisServletBase.getEngine\n(AxisServletBase.java:206)\n        at org.apache.axis.transport.http.AxisServletBase.getEngine\n(AxisServletBase.java:187)\n        at org.apache.axis.transport.http.AxisServlet.doPost\n(AxisServlet.java:635)\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:760)\n\n\"Thread-26\" daemon prio=5 tid=0xcfbd6c8 nid=0x754 waiting for monitor entry \n[0xd99e000..0xd99fdbc]\n        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:279)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:253)\n        at sun.security.x509.OIDMap$1.run(OIDMap.java:259)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at sun.security.x509.OIDMap.loadOidClass(OIDMap.java:256)\n        at sun.security.x509.OIDMap.getClass(OIDMap.java:239)\n        at sun.security.x509.CertificateExtensions.parseExtension\n(CertificateExtensions.java:88)\n        at sun.security.x509.CertificateExtensions.init\n(CertificateExtensions.java:81)\n        at sun.security.x509.CertificateExtensions.<init>\n(CertificateExtensions.java:60)\n        at sun.security.x509.X509CertInfo.parse(X509CertInfo.java:719)\n        at sun.security.x509.X509CertInfo.<init>(X509CertInfo.java:155)\n        at sun.security.x509.X509CertImpl.parse(X509CertImpl.java:1044)\n        at sun.security.x509.X509CertImpl.<init>(X509CertImpl.java:149)\n        at sun.security.provider.X509Factory.engineGenerateCertificate\n(X509Factory.java:89)\n        at java.security.cert.CertificateFactory.generateCertificate\n(CertificateFactory.java:286)\n        at sun.security.pkcs.PKCS7.parseSignedData(PKCS7.java:257)\n        at sun.security.pkcs.PKCS7.parse(PKCS7.java:133)\n        at sun.security.pkcs.PKCS7.parse(PKCS7.java:102)\n        at sun.security.pkcs.PKCS7.<init>(PKCS7.java:90)\n        at sun.security.util.SignatureFileVerifier.<init>\n(SignatureFileVerifier.java:67)\n        at java.util.jar.JarVerifier.processEntry(JarVerifier.java:263)\n        at java.util.jar.JarVerifier.update(JarVerifier.java:197)\n        at java.util.jar.JarFile.initializeVerifier(JarFile.java:248)\n        at java.util.jar.JarFile.getInputStream(JarFile.java:310)\n        at sun.misc.URLClassPath$4.getInputStream(URLClassPath.java:537)\n        at sun.misc.Resource.getBytes(Resource.java:60)\n        at java.net.URLClassLoader.defineClass(URLClassLoader.java:245)\n        at java.net.URLClassLoader.access$100(URLClassLoader.java:56)\n        at java.net.URLClassLoader$1.run(URLClassLoader.java:195)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at java.net.URLClassLoader.findClass(URLClassLoader.java:188)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:297)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:253)\n        at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:313)\n        at com.sun.net.ssl.internal.ssl.SSLSocketImpl.<init>(DashoA6275)\n        at com.sun.net.ssl.internal.ssl.SSLServerSocketImpl.a(DashoA6275)\n        at com.sun.net.ssl.internal.ssl.SSLServerSocketImpl.accept(DashoA6275)\n        at org.apache.tomcat.util.net.jsse.JSSESocketFactory.acceptSocket\n(JSSESocketFactory.java:240)\n        at org.apache.tomcat.util.net.PoolTcpEndpoint.acceptSocket\n(PoolTcpEndpoint.java:356)\n        at org.apache.tomcat.util.net.TcpWorkerThread.runIt\n(PoolTcpEndpoint.java:529)\n        at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run\n(ThreadPool.java:619)\n        at java.lang.Thread.run(Thread.java:484)\n\n\"Thread-14\" daemon prio=5 tid=0xcfbbc28 nid=0xa70 waiting for monitor entry \n[0xd69e000..0xd69fdbc]\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:286)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:290)\n        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:286)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:253)\n        at org.apache.catalina.loader.WebappClassLoader.loadClass\n(WebappClassLoader.java:1355)\n        at org.apache.catalina.loader.WebappClassLoader.loadClass\n(WebappClassLoader.java:1289)\n        at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:313)\n        at java.lang.Class.forName0(Native Method)\n        at java.lang.Class.forName(Class.java:195)\n        at org.apache.axis.utils.ClassUtils$2.run(ClassUtils.java:193)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at org.apache.axis.utils.ClassUtils.loadClass(ClassUtils.java:171)\n        at org.apache.axis.utils.ClassUtils.forName(ClassUtils.java:112)\n        at \norg.apache.axis.encoding.ser.BaseSerializerFactory.getSerializerMethod\n(BaseSerializerFactory.java:210)\n        at org.apache.axis.encoding.ser.BaseSerializerFactory.<init>\n(BaseSerializerFactory.java:105)\n        at org.apache.axis.encoding.ser.BeanSerializerFactory.<init>\n(BeanSerializerFactory.java:88)\n        ..."}, {"count": 1, "tags": [], "creator": "rruiz@gridsystems.com", "text": "Another execution, this time in a Solaris 7 box, whith Sun JDK 1.3.1_04:\n\nThis time I have a deadlock report from the JVM:\n\nFOUND A JAVA LEVEL DEADLOCK:\n----------------------------\n\"Thread-28\":\n  waiting to lock monitor 0xa8448 (object 0xf1ada6c8, a \nsun.misc.Launcher$AppClassLoader),\n  which is locked by \"Thread-18\"\n\"Thread-18\":\n  waiting to lock monitor 0xa83d8 (object 0xf1afeb48, a \nsun.misc.Launcher$ExtClassLoader),\n  which is locked by \"Thread-28\"\n\nJAVA STACK INFORMATION FOR THREADS LISTED ABOVE:\n------------------------------------------------\nJava Stack for \"Thread-28\":\n==========\n        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:274)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:250)\n        at sun.security.x509.OIDMap$1.run(OIDMap.java:254)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at sun.security.x509.OIDMap.loadOidClass(OIDMap.java:251)\n        at sun.security.x509.OIDMap.getClass(OIDMap.java:234)\n        at sun.security.x509.CertificateExtensions.parseExtension\n(CertificateExtensions.java:83)\n        at sun.security.x509.CertificateExtensions.init\n(CertificateExtensions.java:76)\n        at sun.security.x509.CertificateExtensions.<init>\n(CertificateExtensions.java:55)\n        at sun.security.x509.X509CertInfo.parse(X509CertInfo.java:714)\n        at sun.security.x509.X509CertInfo.<init>(X509CertInfo.java:150)\n        at sun.security.x509.X509CertImpl.parse(X509CertImpl.java:1039)\n        at sun.security.x509.X509CertImpl.<init>(X509CertImpl.java:144)\n        at sun.security.provider.X509Factory.engineGenerateCertificate\n(X509Factory.java:84)\n        at java.security.cert.CertificateFactory.generateCertificate\n(CertificateFactory.java:281)\n        at sun.security.pkcs.PKCS7.parseSignedData(PKCS7.java:252)\n        at sun.security.pkcs.PKCS7.parse(PKCS7.java:128)\n        at sun.security.pkcs.PKCS7.parse(PKCS7.java:97)\n        at sun.security.pkcs.PKCS7.<init>(PKCS7.java:85)\n        at sun.security.util.SignatureFileVerifier.<init>\n(SignatureFileVerifier.java:62)\n        at java.util.jar.JarVerifier.processEntry(JarVerifier.java:258)\n        at java.util.jar.JarVerifier.update(JarVerifier.java:192)\n        at java.util.jar.JarFile.initializeVerifier(JarFile.java:243)\n        at java.util.jar.JarFile.getInputStream(JarFile.java:305)\n        - locked <f1b25510> (a java.util.jar.JarFile)\n        at sun.misc.URLClassPath$4.getInputStream(URLClassPath.java:532)\n        at sun.misc.Resource.getBytes(Resource.java:55)\n        at java.net.URLClassLoader.defineClass(URLClassLoader.java:240)\n        at java.net.URLClassLoader.access$100(URLClassLoader.java:51)\n        at java.net.URLClassLoader$1.run(URLClassLoader.java:190)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at java.net.URLClassLoader.findClass(URLClassLoader.java:183)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:294)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:250)\n        at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:310)\n        at com.sun.net.ssl.internal.ssl.SSLSocketImpl.<init>(DashoA6275)\n        at com.sun.net.ssl.internal.ssl.SSLServerSocketImpl.a(DashoA6275)\n        - locked <f1b96408> (a com.sun.net.ssl.internal.ssl.SSLServerSocketImpl)\n        at com.sun.net.ssl.internal.ssl.SSLServerSocketImpl.accept(DashoA6275)\n        at org.apache.tomcat.util.net.jsse.JSSESocketFactory.acceptSocket\n(JSSESocketFactory.java:240)\n        at org.apache.tomcat.util.net.PoolTcpEndpoint.acceptSocket\n(PoolTcpEndpoint.java:356)\n        at org.apache.tomcat.util.net.TcpWorkerThread.runIt\n(PoolTcpEndpoint.java:529)\n        at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run\n(ThreadPool.java:619)\n        at java.lang.Thread.run(Thread.java:479)\nJava Stack for \"Thread-18\":\n==========\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:283)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:287)\n        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:281)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:250)\n        at org.apache.catalina.loader.StandardClassLoader.loadClass\n(StandardClassLoader.java:941)\n        at org.apache.catalina.loader.StandardClassLoader.loadClass\n(StandardClassLoader.java:857)\n        at java.util.ResourceBundle.loadBundle(ResourceBundle.java:905)\n        at java.util.ResourceBundle.findBundle(ResourceBundle.java:786)\n        at java.util.ResourceBundle.getBundleImpl(ResourceBundle.java:635)\n        at java.util.ResourceBundle.getBundle(ResourceBundle.java:541)\n        at javax.servlet.ServletOutputStream.<clinit>\n(ServletOutputStream.java:90)\n        at org.apache.coyote.tomcat4.CoyoteResponse.<init>\n(CoyoteResponse.java:243)\n        at org.apache.coyote.tomcat4.CoyoteConnector.createResponse\n(CoyoteConnector.java:943)\n        at org.apache.coyote.tomcat4.CoyoteAdapter.service\n(CoyoteAdapter.java:205)\n        at org.apache.coyote.http11.Http11Processor.process\n(Http11Processor.java:594)\n        at \norg.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.processConnectio\nn(Http11Protocol.java:392)\n        at org.apache.tomcat.util.net.TcpWorkerThread.runIt\n(PoolTcpEndpoint.java:565)\n        at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run\n(ThreadPool.java:619)\n        at java.lang.Thread.run(Thread.java:479)\n\nFound 1 deadlock.", "id": 44285, "time": "2003-09-18T07:44:29Z", "bug_id": 23180, "creation_time": "2003-09-18T07:44:29Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 23180, "text": "I don't think Tomcat has anything to do with that problem. JSSE is always loaded\nby the system classloader (as proven by your stack traces). The locked objects\nare also related to the system classloader, which (of course) Tomcat doesn't\nattempt to sync on.", "count": 2, "id": 44286, "time": "2003-09-18T08:08:26Z", "creator": "remm@apache.org", "creation_time": "2003-09-18T08:08:26Z", "is_private": false}, {"count": 3, "tags": [], "creator": "rruiz@gridsystems.com", "text": "I agree in that the deadlock seems to be related only to JDK internal \nimplementation. Anyway, the problem appears when a request is processed before\nthe SSL connector initialization is finished.\n\nIs there any possibility of avoiding it by not accepting any request until all\nconnectors are initialized? Could I force this behaviour through a valve or a \nfilter or simething like this?\n\nI can upgrade my JDK, but it is not always possible or easy to do so in a \ncustomer host.", "id": 44289, "time": "2003-09-18T10:07:57Z", "bug_id": 23180, "creation_time": "2003-09-18T10:07:57Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 23180, "attachment_id": null, "id": 51954, "time": "2004-02-09T00:37:52Z", "creator": "funkman@joedog.org", "creation_time": "2004-02-09T00:37:52Z", "is_private": false, "text": "Does this error still occur in 4.1.30? I thought some jsse like patches were\napplied since 4.1.24 but can't remember the specifics."}, {"count": 5, "tags": [], "bug_id": 23180, "text": "Since the root cause is a JDK issue and there has been no response to Tim's\nquestion, I am resolving this as WONTFIX.", "id": 71638, "time": "2005-02-28T21:57:16Z", "creator": "markt@apache.org", "creation_time": "2005-02-28T21:57:16Z", "is_private": false, "attachment_id": null}]