[{"count": 0, "tags": [], "text": "We have a setup with Nginx, Varnish and Apache, where Nginx terminates HTTPS-traffic and proxies everything to Varnish. All HTTP-traffic goes through Varnish, before hitting Apache.\n\nAfter upgrading to Apache 2.4.20 we've started noticing that when looking at PHP's phpinfo() output (PHP is running as an Apache module), HTTP_X_FORWARDED_FOR is frequently missing from the reported Apache environment.\n\nI'm using this config for mod_remoteip.conf:\nRemoteIPHeader X-Forwarded-For\nRemoteIPInternalProxy 127.0.0.1/8\nRemoteIPInternalProxy ::1\n\nOutput from varnishlog for one such request:\n\n**  << BeReq    >> 230295    \n--  Begin          bereq 230294 pass\n--  Timestamp      Start: 1465298356.399670 0.000000 0.000000\n--  BereqMethod    GET\n--  BereqURL       /XXXXXXX.php\n--  BereqProtocol  HTTP/1.1\n--  BereqHeader    Host: XXXXXXX.no\n--  BereqHeader    X-Real-IP: XXX.XXX.XXX.XXX\n--  BereqHeader    X-Forwarded-Proto: https\n--  BereqHeader    X-Secure-Port: 443\n--  BereqHeader    Pragma: no-cache\n--  BereqHeader    Cache-Control: no-cache\n--  BereqHeader    Upgrade-Insecure-Requests: 1\n--  BereqHeader    User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.79 Safari/537.36\n--  BereqHeader    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\n--  BereqHeader    Accept-Encoding: gzip, deflate, sdch, br\n--  BereqHeader    Accept-Language: en-US,en;q=0.8,nb;q=0.6,sv;q=0.4\n--  BereqHeader    grace: none\n--  BereqHeader    Surrogate-Capability: apt24=ESI/1.0\n--  BereqHeader    X-Forwarded-Port: 443\n--  BereqHeader    X-Forwarded-For: XXX.XXX.XXX.XXX, 127.0.0.1, 127.0.0.1\n--  BereqHeader    Cookie: bjarne=anders\n--  BereqHeader    X-Varnish: 230295\n\nAs you can see the request from Varnish to the backend (Apache) had the X-Forwarded-For header present, but that header was not available to PHP.\n\nIf I change mod_remoteip configuration to this, it works for HTTPS sites but not for HTTP, since it's Nginx that adds the X-Real-IP header:\n\nRemoteIPHeader X-Real-IP\nRemoteIPProxiesHeader X-Forwarded-For\nRemoteIPTrustedProxy 127.0.0.1/8\nRemoteIPTrustedProxy ::1\n\nHowever, the variable REMOTE_ADDR will then get the wrong IP.\n\nAny tips for fixing this is appreciated.", "attachment_id": null, "id": 191446, "creation_time": "2016-06-07T13:08:25Z", "time": "2016-06-07T13:08:25Z", "creator": "vn@cl.no", "bug_id": 59669, "is_private": false}, {"count": 1, "tags": [], "text": "We're seeing the same thing. We've got NGINX and Varnish in front of Apache and passing the X-Forwarded-For and X-Real-IP Headers. Apache is using the event MPM and passing PHP to FastCGI.\n\nAll of the headers come through when doing a var_dump on $_SERVER. However when using the X-Forwarded-For or the X-Real-IP headers for RemoteIPHeader, you get the right IP for REMOTE_ADDR but the header disappears.", "is_private": false, "id": 198524, "creator": "jayrscott@gmail.com", "time": "2017-04-25T13:10:13Z", "bug_id": 59669, "creation_time": "2017-04-25T13:10:13Z", "attachment_id": null}, {"count": 2, "attachment_id": null, "creator": "covener@gmail.com", "is_private": false, "id": 198526, "time": "2017-04-25T13:46:30Z", "bug_id": 59669, "creation_time": "2017-04-25T13:46:30Z", "tags": [], "text": "(In reply to KakersUK from comment #1)\n> We're seeing the same thing. We've got NGINX and Varnish in front of Apache\n> and passing the X-Forwarded-For and X-Real-IP Headers. Apache is using the\n> event MPM and passing PHP to FastCGI.\n> \n> All of the headers come through when doing a var_dump on $_SERVER. However\n> when using the X-Forwarded-For or the X-Real-IP headers for RemoteIPHeader,\n> you get the right IP for REMOTE_ADDR but the header disappears.\n\nAFAICT this is intentional in mod_remoteip. Addresses essentially move from XFF to the internal representation of the client address. Entries only remain in if they're not trusted."}]