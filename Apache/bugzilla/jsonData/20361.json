[{"count": 0, "tags": [], "text": "When performing a redirection response\n\n response.sendRedirect(response.encodeRedirectURL(<myurl>));\n\nin a Tomcat instance running on a localized Japanese or French OS the \nredirection response sent to the browser can be incorrectly encoded or have the \nencoding misidentified.\n\nThe Tomcat ErrorHandler class explicitly sets the ContentType to be \"text/html\" \nfor redirections.  This causes the ContentType header to be \"text/html\".  \nHowever the response itself can contain multibyte data taken from the Japanese \nand French resource files distibuted with Tomcat.  The following section of \ncode shows how these resource files are used to construct a response based upon \nthe default locale of the JVM:\n\nFrom ErrorHandler.java\n\n\tres.setContentType(\"text/html\");\t// ISO-8859-1 default\n\tres.setHeader(\"Location\", location);\n\n\tif( sbNote==0 ) {\n\t    sbNote=req.getContextManager().getNoteId\n(ContextManager.REQUEST_NOTE,\n\t\t\t\t\t\t     \"RedirectHandler.buff\");\n\t}\n\n\t// we can recycle it because\n\t// we don't call toString();\n\tStringBuffer buf=(StringBuffer)req.getNote( sbNote );\n\tif( buf==null ) {\n\t    buf = new StringBuffer();\n\t    req.setNote( sbNote, buf );\n\t}\n\tbuf.append(\"<html><head><title>\").\n\t    append(sm.getString(\"defaulterrorpage.documentmoved\")).\n\t    append(\"</title></head>\\r\\n<body><h1>\").\n\t    append(sm.getString(\"defaulterrorpage.documentmoved\")).\n\t    append(\"</h1>\\r\\n\").\n\t    append(sm.getString(\"defaulterrorpage.thisdocumenthasmoved\")).\n\t    append(\" <a href=\\\"\").\n\t    append( HttpMessages.filter( location ) ).\n\t    append(\"\\\">here</a>.<p>\\r\\n</body>\\r\\n</html>\");\n\n\tres.setContentLength(buf.length());\n\tres.getBuffer().write( buf );\n        res.getBuffer().close();\n\tbuf.setLength(0);\n\nIf the encoding has been specified earlier in the JSP using a page directive:\n\n<%@page contentType=\"text/html; charset=utf-8\"%>\n\nthe encoding of the redirection response will be the charset specified in the \npage directive even though the response header indicates otherwise.  On some \nbrowsers this disagreement between specified encoding and actual encoding can \ncause the browser to hang and not be redirected (seen on IE 6 - strangely only \nwhen the redirection url is sufficiently long).", "is_private": false, "bug_id": 20361, "id": 38057, "time": "2003-05-30T17:09:18Z", "creator": "gbraven@yahoo.com", "creation_time": "2003-05-30T17:09:18Z", "attachment_id": null}, {"count": 1, "tags": [], "text": "I've commited a fix to the CVS that should make this work.  The fix should show \nup in the next 'nightly' (which aren't actually generated nightly anymore :)\nUnfortunately, I don't have access to a French or Japanese box to test it on.  \nFeel free to re-open if this patch doesn't solve the problem.", "is_private": false, "bug_id": 20361, "id": 38110, "time": "2003-05-31T02:51:43Z", "creator": "william.barker@wilshire.com", "creation_time": "2003-05-31T02:51:43Z", "attachment_id": null}]