[{"count": 0, "tags": [], "bug_id": 58825, "attachment_id": null, "text": "Hello,\n\nI encountered a bug that only happens when using Google Chrome and Apache HTTP2 : when I send big files, lets say at least 500Mo, using XMLHTTPRequest and PUT method, the upload hangs around 200Mo and 450Mo.\n\nThis does not seem to happen when using FireFox and Apache2 HTTP2 (or maybe on higher sizes),\nThis does not happen with Google Chrome nor FireFox using NGINX with HTTP2,\nand this does not happen with any browser using HTTP/1.1 with Apache\n\nwhen it hangs, i have to restart Apache to kill connections (and to also release php-fpm sockets)\n\nWe used Apache 2.4.18 w/ nghttp2 1.6.0 versus nginx 1.9.7 on Gentoo Linux\nI tried with Google Chrome 47 and Canary 49 vs Firefox 43\nI did not tried if it can work with POST method, because in this case PHP load files into memory since we can't stream directly using php://stdin", "id": 187500, "time": "2016-01-08T14:33:38Z", "creator": "stephane@compodata.com", "creation_time": "2016-01-08T14:33:38Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 58825, "text": "Can you mail me a error_log of such an upload with \n\n  LogLevel http2:debug\n\nto icing (at) apache.org? That would give me a good start in finding where the problem is. Thanks!", "count": 1, "id": 187504, "time": "2016-01-08T16:17:48Z", "creator": "stefan@eissing.org", "creation_time": "2016-01-08T16:17:48Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 58825, "text": "Thanks for the logs. What I see is the following:\n\nFirefox\n- sends 516255587 bytes in the PUT body, closes and gets a 200 response\n- the worker consumes 516255587 bytes (= all bytes)\n\nChrome\n- sends 105153266 bytes in the PUT body, stops sending and, after a timeout, \n- the worker consumes 105118981 bytes, which is 34285 bytes less than sent\n- Apache waits for data several seconds\n- chrome closes the stream RST_STREAM, error=8 (\"cancel\").\n\nNow, this can be explained by a bug in mod_http2 2.4.18 which calculates WINDOW_UPDATE wrong, *if* the client uploads using HTTP/1.1 chunked encoding. Does the Firefox PUT have a content-length? Does the Chrome lack one? \n\nThen this makes the difference. I have fixed this in the development trunk and you can also build a fixed version from https://github.com/icing/mod_h2, if you have the 2.4.18 apxs installed.", "id": 187532, "time": "2016-01-11T10:32:47Z", "creator": "stefan@eissing.org", "creation_time": "2016-01-11T10:32:47Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "stephane@compodata.com", "attachment_id": null, "id": 187537, "time": "2016-01-11T10:59:52Z", "bug_id": 58825, "creation_time": "2016-01-11T10:59:52Z", "is_private": false, "text": "I sent you another log, the one from chrome://net-internals, and there is a content-length. BTW, the chunk are indeed smalls compared to firefox ones (approx 2k vs 64k)"}, {"count": 4, "tags": [], "creator": "stefan@eissing.org", "attachment_id": null, "id": 187541, "time": "2016-01-11T11:52:02Z", "bug_id": 58825, "creation_time": "2016-01-11T11:52:02Z", "is_private": false, "text": "I see. Well, so much for that explanation...\n\nTo read the log correctly: do you have a H2WindowSize configured and at what value? Thanks,\n\nStefan"}, {"count": 5, "tags": [], "bug_id": 58825, "text": "no H2WindowSize configured, nor any H2 directives", "id": 187547, "time": "2016-01-11T13:21:19Z", "creator": "stephane@compodata.com", "creation_time": "2016-01-11T13:21:19Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 58825, "text": "I managed to compile the latest https://github.com/icing/mod_h2 using apxs, and despite that content-length is present using chrome, this version seems to resolve the issue. Will try on another server to confirm that...", "id": 187548, "time": "2016-01-11T13:38:26Z", "creator": "stephane@compodata.com", "creation_time": "2016-01-11T13:38:26Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 58825, "attachment_id": null, "text": "I confirm that installing version 1.1.0 from https://github.com/icing/mod_h2 did the trick, now big files upload work on chrome, it's still 3 times slower than FireFox, but at least it works", "id": 187549, "time": "2016-01-11T14:22:52Z", "creator": "stephane@compodata.com", "creation_time": "2016-01-11T14:22:52Z", "is_private": false}, {"count": 8, "tags": [], "creator": "stefan@eissing.org", "attachment_id": null, "id": 187550, "time": "2016-01-11T14:31:42Z", "bug_id": 58825, "creation_time": "2016-01-11T14:31:42Z", "is_private": false, "text": "So, the bugfix with window_size calculations did not only affect chunked encodings but also sth in regard to the small frame sizes of the Chrome uploads. Good to know.\n\nRegarding the speed differences, that seems worth investigating and reporting to the Chrome team. I admit that upload speed tests have not been my top priority and there is probably something to improve in Apache, but the Firefox comparison shows that Chrome also has a task here, it seems.\n\nThanks for the logs and the testing!\n\n-Stefan"}, {"count": 9, "tags": [], "bug_id": 58825, "attachment_id": null, "text": "Currently, and at least for big file upload using XMLHTTPRequest, here are the avg speed results (incl. php overhead) :\n\nChrome / HTTP2 / Apache : 21MB/s\nChrome / HTTP1 / Apache : 49MB/s\nChrome / HTTP2 / NGinx  : 18MB/s\nChrome / HTTP1 / NGinx  : 40MB/s\nFireFox / HTTP2 / Apache : 51MB/s\nFireFox / HTTP1 / Apache : 98MB/s\nFireFox / HTTP2 / NGinx  : 45MB/s\nFireFox / HTTP1 / NGinx  : 86MB/s\n\nSo Chrome performs really really bad, but HTTP2 protocol is not good for that too... and I'm not convinced that doing Apache/HTTP2 speed optimisation would greatly improve speed for the last...", "id": 187559, "time": "2016-01-12T06:36:46Z", "creator": "stephane@compodata.com", "creation_time": "2016-01-12T06:36:46Z", "is_private": false}, {"count": 10, "tags": [], "creator": "adrian.sandu@asandu.eu", "attachment_id": null, "id": 187766, "time": "2016-01-17T11:06:47Z", "bug_id": 58825, "creation_time": "2016-01-17T11:06:47Z", "is_private": false, "text": "I think I'm hitting the same thing with a simple form\n\n<form method=\"post\" action=\"upload.html\" enctype=\"multipart/form-data\">\nFile: <input type=\"file\" name=\"file\" />\n<input type=\"submit\" name=\"submit\" />\n</form>\n\nupload.html is empty.\n\nWithout the HTTP2 module, everything is ok.\nI can send you a debug log too if interested...\nI tried compiling https://github.com/icing/mod_h2 with no luck.\n\n  CC       mod_http2_la-h2_push.lo\nh2_push.c:682:22: error: conflicting types for built-in function \u2018log2\u2019 [-Werror]\n static unsigned char log2(apr_uint32_t n)\n                      ^\ncc1: all warnings being treated as errors\nMakefile:703: recipe for target 'mod_http2_la-h2_push.lo' failed\nmake[1]: *** [mod_http2_la-h2_push.lo] Error 1\n\ngcc version 4.9.3 (Gentoo 4.9.3 p1.2, pie-0.6.3)\nApache 2.4.18"}, {"count": 11, "tags": [], "bug_id": 58825, "text": "Hello Adrian\n\nPlease try with\n\ngit clone https://github.com/icing/mod_h2/ --branch v1.1.0\n\nsince v1.2.0 HEAD does not compile yet", "id": 187785, "time": "2016-01-18T06:48:07Z", "creator": "stephane@compodata.com", "creation_time": "2016-01-18T06:48:07Z", "is_private": false, "attachment_id": null}, {"count": 12, "text": "There is a release 1.2.2 out that should compile without errors.", "bug_id": 58825, "attachment_id": null, "id": 187820, "time": "2016-01-19T10:43:06Z", "creator": "stefan@eissing.org", "creation_time": "2016-01-19T10:43:06Z", "tags": [], "is_private": false}, {"count": 13, "tags": [], "creator": "stephane@compodata.com", "attachment_id": null, "id": 187822, "time": "2016-01-19T10:50:26Z", "bug_id": 58825, "creation_time": "2016-01-19T10:50:26Z", "is_private": false, "text": "I can confirm that v1.2.2 compiles fine"}, {"count": 14, "tags": [], "creator": "stefan@eissing.org", "attachment_id": null, "id": 188955, "time": "2016-02-29T12:04:21Z", "bug_id": 58825, "creation_time": "2016-02-29T12:04:21Z", "is_private": false, "text": "Seems fixed with upcoming changes available via github."}, {"count": 15, "tags": [], "creator": "stephane@compodata.com", "attachment_id": null, "id": 188966, "time": "2016-02-29T14:00:36Z", "bug_id": 58825, "creation_time": "2016-02-29T14:00:36Z", "is_private": false, "text": "Yes, it's fixed since 1.1.0"}]