[{"count": 0, "tags": [], "creator": "awilkinson@pivotal.io", "text": "The changes made in http://svn.apache.org/viewvc?view=revision&revision=1766521 have regressed org.apache.catalina.startup.Tomcat's behaviour at start up.\n\nPrior to those changes it was possible to create a Tomcat instance, remove its default Connector and start it. At this point no Connectors would be started. One or more Connectors could then be added at which point they would be started automatically.\n\nThe behaviour prior to the changes made in 1766521 was useful as it allowed precise control over when Tomcat would start accepting and processing requests. As far as I can tell, this is no longer possible.", "id": 194962, "time": "2016-11-14T09:23:16Z", "bug_id": 60368, "creation_time": "2016-11-14T09:23:16Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 60368, "attachment_id": null, "text": "It looks to me you were taking advantage of a hack: getConnector, then remove connector. Uh. I'll restore in 8.5 code so that a default connector is only created once.\n\nIn 9, it would be good to remove the automatic connector creation in init and start, since it doesn't make sense.", "id": 194963, "time": "2016-11-14T10:17:08Z", "creator": "remm@apache.org", "creation_time": "2016-11-14T10:17:08Z", "is_private": false}, {"count": 2, "tags": [], "text": "Fixed in Tomcat 8.5.9. In Tomcat 9.0M14, I have removed automatic connector creation on start or when using Tomcat.getConnector.\nI left in place the creation of other components such as service/engine/host since the defaults for them are more likely to be acceptable and they are not automatically created on start either.", "is_private": false, "id": 194973, "creator": "remm@apache.org", "time": "2016-11-14T14:20:06Z", "bug_id": 60368, "creation_time": "2016-11-14T14:20:06Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 60368, "attachment_id": null, "text": "Thank you. Would it be possible to publish an 8.5 snapshot that contains the fix?", "id": 194975, "time": "2016-11-14T14:59:17Z", "creator": "awilkinson@pivotal.io", "creation_time": "2016-11-14T14:59:17Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 60368, "attachment_id": null, "text": "I can take care of that. Give it an hour or so and the snapshot should be available in the usual location.", "id": 194976, "time": "2016-11-14T15:03:12Z", "creator": "markt@apache.org", "creation_time": "2016-11-14T15:03:12Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 60368, "is_private": false, "count": 5, "id": 194978, "time": "2016-11-14T16:10:17Z", "creator": "awilkinson@pivotal.io", "creation_time": "2016-11-14T16:10:17Z", "text": "Thanks, Mark. I've tried the snapshot and, unfortunately, it hasn't restored the previous behaviour.\n\nThe latest change relies on getConnector() being called directly on the Tomcat instance. Our code that works with 8.5.6 doesn't call getConnector(), instead it retrieves the Connectors from their Services: https://github.com/spring-projects/spring-boot/blob/6aa57e8ffe0a868fa5ed081f784015f3463022b3/spring-boot/src/main/java/org/springframework/boot/context/embedded/tomcat/TomcatEmbeddedServletContainer.java#L138-L146. As a result the new defaultConnectorCreated flag remains false and when start is called the default connector is created when previously it was not."}, {"count": 6, "tags": [], "bug_id": 60368, "attachment_id": null, "text": "When you write hacks, you get into trouble at some point :) \n\nAs you're not calling setConnector either, I don't understand how start doesn't create a new default connector behind your back by calling getConnector ... Look at the code in Tomcat 8.0.\n\nSolutions:\n- The new behavior from Tomcat 9 can be ported (IMO creating default connectors is a bad idea)\n- Call getConnector, it won't hurt", "id": 194980, "time": "2016-11-14T16:30:44Z", "creator": "remm@apache.org", "creation_time": "2016-11-14T16:30:44Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 60368, "attachment_id": null, "text": "> As you're not calling setConnector either\n\nWe do call setConnector but I neglected to mention it until now as I hadn't realised it was pertinent. Sorry. It's called as part of configuring the embedded Tomcat instance. This configuration can also include customisations that are made by users' code. Once everything's been configured we temporarily remove the connectors and start Tomcat. Once Tomcat and other bits and pieces have successfully started and we're in a position to start handling requests, the Connectors are reinstated.\n\nPreviously (8.5.6 and earlier), calling setConnector meant that the Connector was cached in Tomcat's connector field. This cached Connector would then be returned from getConnector() instead of creating the default Connector which prevented the call to start from creating an unwanted Connector.\n\n> Call getConnector, it won't hurt\n\nThanks for the suggestion. Won't we end up with the Service having an extra connector (one from our call to setConnector and one from the call to getConnector)?. Instead, perhaps the defaultConnectorCreated flag could be set when setConnector is called?", "id": 194982, "time": "2016-11-14T16:52:19Z", "creator": "awilkinson@pivotal.io", "creation_time": "2016-11-14T16:52:19Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 60368, "is_private": false, "count": 8, "id": 194983, "time": "2016-11-14T17:05:10Z", "creator": "remm@apache.org", "creation_time": "2016-11-14T17:05:10Z", "text": "Ok, let's try that, the behavior from 8.0 makes sense if setConnector is called."}, {"count": 9, "tags": [], "creator": "awilkinson@pivotal.io", "text": "Thanks, Remy.\n\nMark, could you publish another snapshot please?", "id": 195009, "time": "2016-11-15T15:58:36Z", "bug_id": 60368, "creation_time": "2016-11-15T15:58:36Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 60368, "attachment_id": null, "text": "Hi,\n\n(In reply to Andy Wilkinson from comment #9)\n> Mark, could you publish another snapshot please?\n\nI published a new snapshot. Can you test it?\n\nThanks,\nVioleta", "id": 195033, "time": "2016-11-16T14:50:53Z", "creator": "violetagg@apache.org", "creation_time": "2016-11-16T14:50:53Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 60368, "attachment_id": null, "text": "Thanks, Violeta. I've tested the -5 snapshot and it hasn't completely fixed the problem.\n\nOur code currently does this:\n\ntomcat.getService().addConnector(connector);\ntomcat.setConnector(connector);\n\nThis worked fine in 8.5.6 and earlier.\n\nWith the latest snapshot we still end up with two connectors because adding the connector to the service prevents setConnector from setting the defaultConnectorCreated flag. So, strictly speaking, there's still a behaviour change here.\n\nThat said, as far as I can tell there's no need to be add the Connector to the Service and set it on the Tomcat instance so we can change our code to just do this:\n\ntomcat.setConnector(connector);\n\nIt should then work as it did with 8.5.6.", "id": 195036, "time": "2016-11-16T15:13:19Z", "creator": "awilkinson@pivotal.io", "creation_time": "2016-11-16T15:13:19Z", "is_private": false}, {"count": 12, "tags": [], "creator": "remm@apache.org", "text": "I made another change to set the flag in all cases in setConnector.", "id": 195038, "time": "2016-11-16T15:23:41Z", "bug_id": 60368, "creation_time": "2016-11-16T15:23:41Z", "is_private": false, "attachment_id": null}, {"count": 13, "tags": [], "creator": "violetagg@apache.org", "text": "(In reply to Remy Maucherat from comment #12)\n> I made another change to set the flag in all cases in setConnector.\n\nOk I can publish another snapshot if it is needed?", "id": 195039, "time": "2016-11-16T15:27:35Z", "bug_id": 60368, "creation_time": "2016-11-16T15:27:35Z", "is_private": false, "attachment_id": null}, {"count": 14, "tags": [], "creator": "violetagg@apache.org", "text": "(In reply to Violeta Georgieva from comment #13)\n> (In reply to Remy Maucherat from comment #12)\n> > I made another change to set the flag in all cases in setConnector.\n> \n> Ok I can publish another snapshot if it is needed?\n\nI published another snapshot.\n\nRegards,\nVioleta", "id": 195040, "time": "2016-11-16T16:08:11Z", "bug_id": 60368, "creation_time": "2016-11-16T16:08:11Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "bug_id": 60368, "attachment_id": null, "text": "Thank you, Remy and Violeta. The behaviour of the latest snapshot (-6) is the same as 8.5.6.", "id": 195041, "time": "2016-11-16T16:25:30Z", "creator": "awilkinson@pivotal.io", "creation_time": "2016-11-16T16:25:30Z", "is_private": false}]