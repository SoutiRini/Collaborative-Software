[{"id": 192715, "tags": [], "bug_id": 59912, "is_private": false, "count": 0, "text": "Created attachment 34080\nZip with fiddler trace, servlet Java source, web.xml\n\nTomcat 8.0.33 (also fails on 7.0.55)\nJDK 1.8.0_66\n\nWrote a servlet that simply calls readLine() on the HttpServletRequest.getReader() and dumps the incoming lines.\n\nWhen I do a POST that has at least two lines in the body, with a content-length of exactly 8192 bytes, the last readLine() call throws an IOException.\n\n8191 works fine, 8193 works fine, but 8192 bombs.\n\njava.io.IOException\n\tat org.apache.catalina.connector.InputBuffer.reset(InputBuffer.java:576)\n\tat org.apache.catalina.connector.CoyoteReader.reset(CoyoteReader.java:142)\n\tat org.apache.catalina.connector.CoyoteReader.readLine(CoyoteReader.java:200)\n\tat com.cerner.TestServlet.service(TestServlet.java:33)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:729)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:292)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n\tat org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:212)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:106)\n\tat org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:502)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:141)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:79)\n\tat org.apache.catalina.valves.AbstractAccessLogValve.invoke(AbstractAccessLogValve.java:616)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:88)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:522)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1095)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:672)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1502)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1458)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n\tat java.lang.Thread.run(Thread.java:745)\n\nSee attached servlet source, fiddler trace file.", "time": "2016-07-29T19:39:22Z", "creator": "Peter.Teunissen@cerner.com", "creation_time": "2016-07-29T19:39:22Z", "attachment_id": 34080}, {"count": 1, "tags": [], "bug_id": 59912, "is_private": false, "text": "Seems to be same (similar?) issue as bug 42727", "id": 192716, "time": "2016-07-29T20:14:26Z", "creator": "Peter.Teunissen@cerner.com", "creation_time": "2016-07-29T20:14:26Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "csutherl@apache.org", "attachment_id": null, "text": "Can you provide a data file to use that you can reliably reproduce this with? I tried creating a file of size 8192 (and using the request contents from the fiddler logging), but don't see any issues in 8.0.33 or 8.0.x-dev. I'm testing with the following using your servlet packaged into asf-test.war:\n\ncurl -is -X POST --data @test2.dat http://localhost:8080/asf-test/test", "id": 192717, "time": "2016-07-29T20:19:42Z", "bug_id": 59912, "creation_time": "2016-07-29T20:19:42Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 59912, "attachment_id": null, "id": 192718, "time": "2016-07-29T20:46:45Z", "creator": "Peter.Teunissen@cerner.com", "creation_time": "2016-07-29T20:46:45Z", "is_private": false, "text": "I tested this by replaying the transaction through fiddler.\n\nWhen I hit it through CURL, it always posts is such away that in one call to readLine() we get all the data.\n\nWhen submitted from fiddler, it does the first readLine(), then enters the loop to do additional readLines() and fails on the last:\n\nContent-length:8192\nRead-1:109 bytes  magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pret\nRead-2:122 bytes ium uis, sem. Nulla consequat massa quis enim. Donec pede justo, fringilla vel, aliquet nec, vulputate eget, arcu. In enim\nRead-2:124 bytes  justo, rhoncus ut, imperdiet a, venenatis vitae, justo. \n\n(many Read-2's)\n\nipsum aliquam libero, non adipiscing dolor urna a orci.\njava.io.IOExceptionError caught:null\nSize: 7938 Len:27 Request:!!! We had an error!!! null\n\n\tat org.apache.catalina.connector.InputBuffer.reset(InputBuffer.java:521)\n\tat org.apache.catalina.connector.CoyoteReader.reset(CoyoteReader.java:142)\n\n\nThrough CURL with an input file:\n\n$ curl -is -X POST --data @test.log http://localhost:8080/coyrdr/test\n\nContent-length:8192\nRead-1:8192 bytes  magnis dis parturient \n--blablabla--\naliquam libero, non adipiscing dolor urna a orci. Nulla porta dolor. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos hymenaeos. Pelxxl\nReading-2 string=null"}, {"count": 4, "tags": [], "bug_id": 59912, "attachment_id": null, "id": 192719, "time": "2016-07-29T21:02:30Z", "creator": "Peter.Teunissen@cerner.com", "creation_time": "2016-07-29T21:02:30Z", "is_private": false, "text": "(In reply to Coty Sutherland from comment #2)\n> Can you provide a data file to use that you can reliably reproduce this\n> with? I tried creating a file of size 8192 (and using the request contents\n> from the fiddler logging), but don't see any issues in 8.0.33 or 8.0.x-dev.\n> I'm testing with the following using your servlet packaged into asf-test.war:\n> \n> curl -is -X POST --data @test2.dat http://localhost:8080/asf-test/test\n\nFound a way to reproduce with curl using --data-binary and a multi line input file. Keep tweaking the input until the servlet shows exactly Content-Length= 8192.\n\n$ curl -is -X POST --data-binary @test.log http://localhost:8081/coyrdr/test"}, {"count": 5, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 192976, "time": "2016-08-10T11:29:47Z", "bug_id": 59912, "creation_time": "2016-08-10T11:29:47Z", "text": "Replaying with Fiddler I see the same problem with 9.0.x as well. Investigating..."}, {"count": 6, "tags": [], "bug_id": 59912, "attachment_id": null, "text": "Thanks for the report and test case. This has been fixed in the following versions:\n9.0.x for 9.0.0.M10 onwards\n8.5.x for 8.5.5 onwards\n8.0.x for 8.0.37 onwards\n7.0.x for 7.0.71 onwards", "id": 192990, "time": "2016-08-10T22:33:51Z", "creator": "markt@apache.org", "creation_time": "2016-08-10T22:33:51Z", "is_private": false}]