[{"text": "Created attachment 23528\nproposed patch to possibly fix this issue\n\nWhen dumping an (untouched) class file containing a StackMap table, the result is not faithful and cannot be be reloaded afterwards.\n\nThe problem, I reckon, is within the method StackMapTableEntry.dump. One case raises an exception though it should not and other cases write byte values though short values should be written instead.\n\nThe attached diff fixed the problem for my purposes, but I do not know whether it is correct.\n\nRegards,\n    Mattias", "tags": [], "creator": "mulbrich@ira.uka.de", "is_private": false, "count": 0, "id": 126433, "time": "2009-04-22T06:24:47Z", "bug_id": 47073, "creation_time": "2009-04-22T06:24:47Z", "attachment_id": 23528}, {"count": 1, "tags": [], "bug_id": 47073, "attachment_id": null, "is_private": false, "id": 127026, "time": "2009-05-14T15:09:20Z", "creator": "lenbok@gmail.com", "creation_time": "2009-05-14T15:09:20Z", "text": "I think I'm hitting this same problem (processing jdk1.6-generated class files).  I applied your patch, but it does not make any changes to StackMapTableEntry.dump() where the exception is being raised.\n\nI assume there should be an\n\nif (frame_type >= Constants.SAME_FRAME && frame_type <= Constants.SAME_FRAME_MAX) {\n...\n} else ....\n\nafter the initial write of frame_type, but what should be inside the if?"}, {"count": 2, "tags": [], "bug_id": 47073, "text": "Actually, it looks like you incorrectly attached the same patch as for bug 47072 -- can you please attach the patch relevant to this bug?", "id": 127027, "time": "2009-05-14T15:43:15Z", "creator": "lenbok@gmail.com", "creation_time": "2009-05-14T15:43:15Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 47073, "is_private": false, "text": "Created attachment 23709\nproposed patch to possibly fix this issue (2nd try)\n\nOoops. You are right. I attached the wrong file. I hope that this patch is the right one.\n\nRegards, Mattias", "id": 127356, "time": "2009-05-25T01:16:08Z", "creator": "mulbrich@ira.uka.de", "creation_time": "2009-05-25T01:16:08Z", "attachment_id": 23709}, {"count": 4, "tags": [], "bug_id": 47073, "is_private": false, "text": "> I assume there should be an\n>\n> if (frame_type >= Constants.SAME_FRAME && frame_type <=\n> Constants.SAME_FRAME_MAX) {\n> ...\n> } else ....\n> after the initial write of frame_type, but what should be inside the if?\n\nI reckon that the \"if\" branch can remain empty since there is no\nadditional information to be stored in this case.", "id": 127357, "time": "2009-05-25T01:19:32Z", "creator": "mulbrich@ira.uka.de", "creation_time": "2009-05-25T01:19:32Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 47073, "text": "Finally had a chance to get back to this. This patch and your other patch are now allowing me to process annotations in my project. Thanks!", "id": 129865, "time": "2009-08-23T22:19:20Z", "creator": "lenbok@gmail.com", "creation_time": "2009-08-23T22:19:20Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 47073, "attachment_id": null, "is_private": false, "id": 129866, "time": "2009-08-23T23:30:48Z", "creator": "lenbok@gmail.com", "creation_time": "2009-08-23T23:30:48Z", "text": "Damn, so close. It works with some classes, but BCEL-svn seems to die processing other classes with e.g.:\n\nException in thread \"main\" java.lang.ClassFormatError: Illegal constant pool index 29440 for method name in class file MyTestClass\n\nProbably unrelated to this bug though, as I have not yet got to putting annotations on that class."}, {"count": 7, "tags": [], "bug_id": 47073, "attachment_id": null, "is_private": false, "id": 131451, "time": "2009-10-28T03:46:09Z", "creator": "enrico.gueli@polito.it", "creation_time": "2009-10-28T03:46:09Z", "text": "(In reply to comment #6)\n> Damn, so close. It works with some classes, but BCEL-svn seems to die\n> processing other classes with e.g.:\n> \n> Exception in thread \"main\" java.lang.ClassFormatError: Illegal constant pool\n> index 29440 for method name in class file MyTestClass\n> \n> Probably unrelated to this bug though, as I have not yet got to putting\n> annotations on that class.\n\nHello,\nthe same applies for me. I encountered the problem in this bug report, applied the patch (with some handwork, because the HEAD (826342) revision is a bit different) but I had to stop again in the same exception as yours. Only the index changes, mine is 64764.\n\nBest regards, Enrico"}, {"count": 8, "attachment_id": 24557, "creator": "mulbrich@ira.uka.de", "text": "Created attachment 24557\nProposed patch\n\nThere was write() instead writeShort() that I had missed in the last patch.", "id": 132090, "time": "2009-11-18T07:03:56Z", "bug_id": 47073, "creation_time": "2009-11-18T07:03:56Z", "tags": [], "is_private": false}, {"count": 9, "tags": [], "text": "Hello!\n\nIn addition to the here report bugs, I assume very much that all those \"readShort\" method calls should actually read \"readUnsignedShort\" since negative values would not make sense there ...\n\n5.2 does not allow to modify classes that have stack maps and save them, since the dumping is very likely to crash. (Hope the patch NOW solves the issue)", "is_private": false, "id": 132091, "creation_time": "2009-11-18T07:09:06Z", "time": "2009-11-18T07:09:06Z", "creator": "mulbrich@ira.uka.de", "bug_id": 47073, "attachment_id": null}, {"count": 10, "tags": [], "creator": "enrico.gueli@polito.it", "attachment_id": null, "is_private": false, "id": 132324, "time": "2009-11-25T10:09:43Z", "bug_id": 47073, "creation_time": "2009-11-25T10:09:43Z", "text": "(In reply to comment #8)\n> Created an attachment (id=24557) [details]\n> Proposed patch\n> \n> There was write() instead writeShort() that I had missed in the last patch.\n\nDear Mattias,\nI tried to apply the patch, but it expects a different hunk. Even if I try to patch manually, I still get \"Attribute name has bad constant pool index\" errors.\nBTW, the patch refers to revision 881793, but in SVN the most recent revision for this file is currently 826333. Is this patch coming from the future? ;)\n\nBest regards, Enrico"}, {"count": 11, "attachment_id": null, "creator": "enrico.gueli@polito.it", "text": "*** Bug 48270 has been marked as a duplicate of this bug. ***", "id": 132326, "time": "2009-11-25T10:11:39Z", "bug_id": 47073, "creation_time": "2009-11-25T10:11:39Z", "tags": [], "is_private": false}, {"count": 12, "attachment_id": null, "creator": "mulbrich@ira.uka.de", "text": "Hi!\n\nDo you have changed anything in the classes that fail to be read? If you - for instance - add instructions to the code block and modify the constant pool with that, the stack map table is not updated like the line number table is. The dumping might then export invalid constants (perhaps).\n\nCould you possibly post an example of a corrupted file (pre- and post-processing)?\n\nRegards, Mattia", "id": 132478, "time": "2009-11-30T15:22:34Z", "bug_id": 47073, "creation_time": "2009-11-30T15:22:34Z", "tags": [], "is_private": false}, {"count": 13, "tags": [], "bug_id": 47073, "text": "Forgive me for the false alarm: I did some mistakes while applying the patch and therefore I got those errors again. I've retried now, and it works like a charm. THANK YOU!!\n\nBTW, the difficulties I had in applying the patch were only due to differences in the whitespace.\n\nBest regards", "id": 132479, "time": "2009-11-30T15:23:34Z", "creator": "enrico.gueli@polito.it", "creation_time": "2009-11-30T15:23:34Z", "is_private": false, "attachment_id": null}, {"count": 14, "attachment_id": null, "bug_id": 47073, "text": "Applied. Thx!", "id": 133488, "time": "2010-01-10T12:41:54Z", "creator": "tcurdt@apache.org", "creation_time": "2010-01-10T12:41:54Z", "tags": [], "is_private": false}]