[{"count": 0, "tags": [], "bug_id": 31517, "attachment_id": null, "text": "In httpd-2.0.51 and httpd-2.0.52, suEXEC will not load under OpenBSD if compiled\nin directly due to a faulty setuid check.\n\n  $ ./configure --prefix=/usr/local/apache2 --exec-prefix=/usr/local/apache2\n--bindir=/usr/local/apache2/bin --sbindir=/usr/local/apache2/sbin\n--enable-layout=OpenBSD --enable-modules=all --enable-so --enable-ssl\n--enable-rewrite --enable-autoindex --enable-suexec\n--with-suexec-bin=/usr/local/apache2/sbin/suexec --with-suexec-caller=www\n--with-suexec-docroot=/usr/local/apache2/cgi-bin --disable-ipv6 --with-ssl\n\n$ /usr/local/apache2/sbin/httpd -V\nServer version: Apache/2.0.52\nServer built:   Oct  3 2004 09:25:52\nServer's Module Magic Number: 20020903:9\nArchitecture:   32-bit\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_MMAP\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D HTTPD_ROOT=\"/usr/local/apache2\"\n -D SUEXEC_BIN=\"/usr/local/apache2/sbin/suexec\"\n -D DEFAULT_PIDLOG=\"logs/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_LOCKFILE=\"logs/accept.lock\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"\n\n$ ls -lF /usr/local/apache2/sbin/suexec\n-rwsr-x---  1 root  suexec  30529 Oct  3 09:28 /usr/local/apache2/sbin/suexec*\n\n$ /usr/local/apache2/sbin/suexec -V\n -D AP_DOC_ROOT=\"/usr/local/apache2/cgi-bin\"\n -D AP_GID_MIN=100\n -D AP_HTTPD_USER=\"www\"\n -D AP_LOG_EXEC=\"/usr/local/apache2/logs/suexec_log\"\n -D AP_SAFE_PATH=\"/usr/local/bin:/usr/bin:/bin\"\n -D AP_UID_MIN=100\n -D AP_USERDIR_SUFFIX=\"public_html\"\n\n[httpd runs as user www, group suexec]:\n\n$ ps auxwwww | grep httpd\nwww      10433  0.0  0.3  1936  1716 ??  I      9:29AM    0:00.01\n/usr/local/apache2/sbin/httpd -k start\n\n$ /usr/local/apache2/sbin/apachectl configtest\nWarning: SuexecUserGroup directive requires SUEXEC wrapper.\nWarning: SuexecUserGroup directive requires SUEXEC wrapper.\nWarning: SuexecUserGroup directive requires SUEXEC wrapper.\nSyntax OK\n\nOn lines 217 and 221 of httpd-2.0.52/os/unix/unixd.c :\n\n/* since APR 0.9.5 */\n#ifdef APR_USETID\n    if ((wrapper.protection & APR_USETID) && wrapper.user == 0) {\n#endif\n        unixd_config.suexec_enabled = 1;\n#ifdef APR_USETID\n    }\n#endif\n}\n\n...changed to the following (to disable the check):\n\n/* since APR 0.9.5 */\n#if 0\n    if ((wrapper.protection & APR_USETID) && wrapper.user == 0) {\n#endif\n        unixd_config.suexec_enabled = 1;\n#if 0\n    }\n#endif\n}\n\n...it then allows suexec to work fine once you rebuild. This is the case in\nhttpd-2.0.51 and httpd-2.0.52 on OpenBSD.", "id": 64521, "time": "2004-10-03T15:51:24Z", "creator": "justin.r.hall@gmail.com", "creation_time": "2004-10-03T15:51:24Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 31517, "attachment_id": null, "text": "Can you:\n\n1) make sure that httpd is not linked against on old version of the APR\nlibraries someone on the system using \"ldd\" or similar\n\n2) modify the code to add something like:\n\n  fprintf(stderr, \"perms=%o, user=%d\\n\", wrapper.protection, wrapper.user);\n\nbefore the code in question to see what permissions are being picked up.\n", "id": 64745, "time": "2004-10-07T12:23:35Z", "creator": "jorton@redhat.com", "creation_time": "2004-10-07T12:23:35Z", "is_private": false}, {"count": 2, "tags": [], "creator": "justin.r.hall@gmail.com", "attachment_id": null, "id": 64764, "time": "2004-10-07T15:08:02Z", "bug_id": 31517, "creation_time": "2004-10-07T15:08:02Z", "is_private": false, "text": "jorton[at]redhat[dot]com requested I show the libraries httpd is linked against:\n\n$ ldd /usr/local/apache2/sbin/httpd\n/usr/local/apache2/sbin/httpd:\n        Start    End      Type Ref Name\n        00000000 00000000 exe   1  /usr/local/apache2/sbin/httpd\n        01f87000 21f91000 rlib  1  /usr/lib/libssl.so.9.0\n        06fc9000 26ff9000 rlib  1  /usr/lib/libcrypto.so.11.0\n        0a697000 2a69b000 rlib  1  /usr/local/apache2/lib/libaprutil-0.so.9.5\n        0b95c000 2b972000 rlib  1  /usr/local/lib/libdb.so.4.2\n        0232d000 22332000 rlib  1  /usr/local/lib/libexpat.so.4.0\n        028a3000 228a8000 rlib  1  /usr/local/apache2/lib/libapr-0.so.9.5\n        03817000 2381e000 rlib  2  /usr/lib/libm.so.2.0\n        08c49000 28c52000 rlib  2  /usr/lib/libpthread.so.6.0\n        0e6af000 2e6e7000 rlib  1  /usr/lib/libc.so.34.1\n        0028a000 0028a000 rtld  1  /usr/libexec/ld.so\n\nAlso requested was the code change to add the following line to\nhttpd-2.0.52/os/unix/unixd.c to show which permissions were being detected\n(causing the suexec failure):\n  fprintf(stderr, \"perms=%o, user=%d\\n\", wrapper.protection, wrapper.user);\n\nThe results of adding this line to the code are as follows:\n  $ chown root:suexec /usr/local/apache2/sbin/suexec\n  $ chmod 4750 /usr/local/apache2/sbin/suexec\n  $ ls -lF /usr/local/apache2/sbin/suexec\n  -rwsr-x---  1 root  suexec  30529 Oct  7 09:00 /usr/local/apache2/sbin/suexec*\n  $ apachectl start\n  perms=7520, user=0"}, {"count": 3, "tags": [], "bug_id": 31517, "attachment_id": null, "text": "Hmmm, %x would have been better of course...\n\n07520 == 0x1600\n      == APR_UREAD | APR_UWRITE | 0x1000???\n\nsomething seems quite wrong.  Can you try running the APR test suite?\n\n cd srclib/apr/test && make testall && ./testall -v\n", "id": 64765, "time": "2004-10-07T15:24:54Z", "creator": "jorton@redhat.com", "creation_time": "2004-10-07T15:24:54Z", "is_private": false}, {"count": 4, "tags": [], "text": "Ah, my use of /usr/bin/bc is quite wrong to start with, changing ibase before\nobase is not clever.\n\n07520 == 0xF50\n\nthe problem is that you have compiled 2.0.52 against the headers from the APR\nincluded in 2.0.51, since the APR_USETID definition changed from 0x800 to 0x8000\nbetween the two releases.\n\nThis bug would not affect you if httpd did not include random APR snapshots in\nreleases tarballs, since this change should never have leaked out, but that is\nthe status quo unfortunately.  Bug 18959 might be the cause of the header mixups.\n\nTo fix it, be sure to remove all traces of the headers from old releases from\nyour system, and build 2.0.52 again; the problems should go away.", "attachment_id": null, "bug_id": 31517, "id": 64767, "time": "2004-10-07T15:34:55Z", "creator": "jorton@redhat.com", "creation_time": "2004-10-07T15:34:55Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 31517, "attachment_id": null, "text": "I'm not sure how or why, but my build was pulling from /usr/lib/apache/include \nbefore the current httpd-2.0.52 include headers. I removed the /usr/lib/apache \ndirectory and rebuilt 2.0.52, and it appears to be working fine now. Thanks for \nthe help.", "id": 64870, "time": "2004-10-09T20:18:39Z", "creator": "justin.r.hall@gmail.com", "creation_time": "2004-10-09T20:18:39Z", "is_private": false}]