[{"count": 0, "tags": [], "bug_id": 50722, "text": "On a fresh lenya 2.0.4 install, trying to empty the trash leads to (after clicking on the delete button in the confirmation dialog):\n\njava.lang.RuntimeException: The document [test:trash:b005a910-315f-11e0-806c-93e5409e06ee:de] is not referenced in the site structure.\n\n        at org.apache.lenya.cms.publication.DocumentImpl.getLocator(DocumentImpl.java:508)\n        at org.apache.lenya.cms.publication.DocumentManagerImpl.deleteAllLanguageVersions(DocumentManagerImpl.java:763)\n        at org.apache.lenya.cms.publication.DocumentManagerImpl$DeleteVisitor.visitDocument(DocumentManagerImpl.java:791)\n        at org.apache.lenya.cms.publication.DocumentImpl.accept(DocumentImpl.java:404)\n        at org.apache.lenya.cms.publication.util.DocumentSet.visit(DocumentSet.java:131)\n        at org.apache.lenya.cms.publication.DocumentManagerImpl.delete(DocumentManagerImpl.java:817)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:592)\n        at org.apache.avalon.excalibur.component.ComponentProxyGenerator$ComponentInvocationHandler.invoke(ComponentProxyGenerator.java:143)\n        at $Proxy56.delete(Unknown Source)\n        at org.apache.lenya.cms.site.usecases.EmptyTrash.doExecute(EmptyTrash.java:116)\n        at org.apache.lenya.cms.usecase.AbstractUsecase.execute(AbstractUsecase.java:319)", "id": 143998, "time": "2011-02-05T15:52:40Z", "creator": "rainer.schoepf@gmx.net", "creation_time": "2011-02-05T15:52:40Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 50722, "text": "Analysis of the bug:\n\nThe exception happens if you try to delete more than one language version of a document. EmptyTrash.doExecute passes a list of documents to DocumentManager.delete. Different language versions are passed as separate documents.\n\nHowever, the method DeleteVisitor.visitDocument (in DocumentManagerImpl) calls deleteAllLanguageVersions on each of the documents, hence on each of the language versions, ie. tries to delete the same thing several times.\n\nReplacing the call of deleteAllLanguageVersions by delete seems to do the trick.", "id": 144028, "time": "2011-02-07T15:08:20Z", "creator": "rainer.schoepf@gmx.net", "creation_time": "2011-02-07T15:08:20Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 50722, "attachment_id": null, "text": "Fixed in r1068192 (2.0.4), added test case in r1070690.\n\nNeeds to be merged to 2.1.X", "id": 144285, "time": "2011-02-15T01:59:18Z", "creator": "rainer.schoepf@gmx.net", "creation_time": "2011-02-15T01:59:18Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 50722, "is_private": false, "id": 144437, "attachment_id": null, "creator": "rainer.schoepf@gmx.net", "creation_time": "2011-02-20T09:24:56Z", "time": "2011-02-20T09:24:56Z", "text": "(In reply to comment #2)\n> Fixed in r1068192 (2.0.4), added test case in r1070690.\n> \n> Needs to be merged to 2.1.X\n\nDone in r1072602."}, {"count": 4, "tags": [], "creator": "rainer.schoepf@gmx.net", "attachment_id": null, "id": 144438, "time": "2011-02-20T09:25:34Z", "bug_id": 50722, "creation_time": "2011-02-20T09:25:34Z", "is_private": false, "text": "Fixed for Release 2.0.4."}]