[{"count": 0, "tags": [], "bug_id": 61855, "text": "When using mod_rewrite and mod_proxy together to create a reverse proxy based on the Host http header, connection reuse is disabled.\n\nHere is a sample configuration:\n\n--- SAMPLE CONFIG ---\nRewriteEngine On\nRewriteRule .* - [E=TARGET:%{HTTP_HOST}]\n\nSSLProxyEngine on\nSSLProxyCheckPeerName off\nSSLProxyCheckPeerCN off\nSSLProxyCACertificatePath /etc/certs/\nSSLProxyVerify none\n\nProxyPass / https://${TARGET}/ retry=0 ttl=5 keepalive=on interpolate\nProxyPassReverse / https://${RARGET}/ interpolate\nProxyPassInterpolateEnv on\nProxyPreserveHost On\n--- END SAMPLE CONFIG ---\n\nIt was thought that this would allow connection reuse and lower the CPU usage due to SSL negotiation not being repeated. However, this doesn't work, and a new backend connection is created for every request.\n\nI'd like to suggest a documentation update that explicitly calls this out so future users will learn this information sooner. This update could go in the following places:\n\n  https://httpd.apache.org/docs/2.4/mod/mod_rewrite.html\n  https://httpd.apache.org/docs/2.4/mod/mod_proxy.html\n\nNote the following:\n\n  - The mod_rewrite proxy flag [P] is not being used here\n  - The security implication of using the Host header to determine backend server is known, and is something that is worked around through other means.", "id": 202563, "time": "2017-12-04T17:06:48Z", "creator": "dmulford@redhat.com", "creation_time": "2017-12-04T17:06:48Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "toscano.luca@gmail.com", "attachment_id": null, "text": "Hi Dave,\n\ndid you try the mod_proxy options disablereuse/enablereuse? https://httpd.apache.org/docs/current/mod/mod_proxy.html\n\nLuca", "id": 202921, "time": "2017-12-26T19:20:01Z", "bug_id": 61855, "creation_time": "2017-12-26T19:20:01Z", "is_private": false}, {"count": 2, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "text": "(In reply to Dave Mulford from comment #0)\n> When using mod_rewrite and mod_proxy together to create a reverse proxy\n> based on the Host http header, connection reuse is disabled.\n> \n> Here is a sample configuration:\n> \n> --- SAMPLE CONFIG ---\n> RewriteEngine On\n> RewriteRule .* - [E=TARGET:%{HTTP_HOST}]\n> \n> SSLProxyEngine on\n> SSLProxyCheckPeerName off\n> SSLProxyCheckPeerCN off\n> SSLProxyCACertificatePath /etc/certs/\n> SSLProxyVerify none\n> \n> ProxyPass / https://${TARGET}/ retry=0 ttl=5 keepalive=on interpolate\n> ProxyPassReverse / https://${RARGET}/ interpolate\n> ProxyPassInterpolateEnv on\n> ProxyPreserveHost On\n> --- END SAMPLE CONFIG ---\n\nFor reuse, the server needs to know the backend workers in advance.  TARGET is not known until request processing.  You need to list out the backends you want a dedicated worker for.", "id": 202922, "time": "2017-12-26T19:24:16Z", "bug_id": 61855, "creation_time": "2017-12-26T19:24:16Z", "is_private": false}]