[{"count": 0, "tags": [], "text": "Related LOG4J tickets: \n * https://issues.apache.org/bugzilla/show_bug.cgi?id=44157\n * https://issues.apache.org/bugzilla/show_bug.cgi?id=47401\n\nThe interrupted state is no longer swallowed, but logging still gets corrupted on Solaris, when the thread has the interrupt flag set while it is logging something.\n\nUnder Linux everything works well, but under Solaris, logging output gets corrupted.\n\nOn an earlier Log4J version we also had the issue that the interrupted flag got cleared unexpectedly when the Thread was logging something and has been interrupted just before logging. See related tickets above.\n\nThe test shows that it is not the case now, when the interrupted flag was set before calling the logger, but I haven't tested yet, what happens, when the Thread gets interrupted while it is already executing code from Log4J.\nLinux was not affected.\n\nlog4j   version = 1.2.17\nSolaris version = SunOS xsola07 5.10 Generic_147441-12 i86pc i386 i86pc\n                  Solaris 10 10/08 s10x_u6wos_07b X86\n\nThe Logger class in this example delegates the logging to LOG4J.\n\nNOTE: In my case the UnitTest succeeds, but logging is corrupted. Please verify the logging output.\n\npublic class UnitTest_Logger {\n\n    /**\n     * This test tests the handling of the interrupted flag in Log4J. The interrupted flag should not be modified during\n     * logging. DEVTS-353: Test if \"Failed to flush writer\" issue has been fixed: Should fail on Solaris, if the bug has\n     * not been fixed. Hudson should complain on Solaris while this works under LINUX.\n     *\n     * @throws Exception\n     */\n    @Test\n    public void testLoggingWhenInterrupted()\n        throws Exception {\n        boolean failed = false;\n        final String longString = \"...\";\n        int counter = 0;\n        final Logger myLogger = new Logger( getClass() );\n        final List<String> logMessageList = new ArrayList<String>();\n        Thread.interrupted(); // Clear interrupted Flag (if it was set)\n        for ( int i = 1; i <= 9; i++ ) {\n            final boolean interrupted = getInterrupted();\n            failed |= interrupted;\n            final String logmessage = ++counter + \" \" + interruptedString( interrupted ) + i + longString;\n            logMessageList.add( logmessage );\n            myLogger.logInfo( logmessage );\n        }\n        Thread.currentThread().interrupt(); // Set interrupted Flag.\n        for ( int i = 1; i <= 9; i++ ) {\n            final boolean interrupted = getInterrupted();\n            failed |= ( !interrupted );\n            final String logmessage = ++counter + \" \" + interruptedString( interrupted ) + i + longString;\n            logMessageList.add( logmessage );\n            myLogger.logInfo( logmessage );\n        }\n        Thread.interrupted(); // Clear interrupted Flag\n        for ( int i = 1; i <= 9; i++ ) {\n            final boolean interrupted = getInterrupted();\n            failed |= interrupted;\n            final String logmessage = ++counter + \" \" + interruptedString( interrupted ) + i + longString;\n            logMessageList.add( logmessage );\n            myLogger.logInfo( logmessage );\n        }\n        assertFalse( \"Interrupted flag has been modified unexpectedly.\", failed );\n        myLogger.logInfo( \"These messages should have been logged:\" );\n        for ( final String logMessage : logMessageList ) {\n            myLogger.logInfo( \"\" + logMessage );\n        }\n    }\n\n\n\n    private String interruptedString( final boolean interrupted ) {\n        return interrupted ? \"INTERRUPTED\" : \"NOT interrupted\";\n    }\n\n\n\n    private boolean getInterrupted() {\n        return Thread.currentThread().isInterrupted();\n    }\n\n\n\n    public static void main( final String[] args ) {\n        try {\n            new UnitTest_Logger().testLoggingWhenInterrupted();\n        } catch ( final Exception e ) {\n            throw new IllegalStateException( e );\n        }\n    }\n\n}\n\n\n\nThis is the logging output from Solaris: When the Interrupted flag is set, only one line gets logged, the rest is silently dropped.\nAfter clearing the interrupted flag, everything works fine again.\n\n[2012-07-31 14:43:03,877] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 1 NOT interrupted1...\n[2012-07-31 14:43:03,877] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 2 NOT interrupted2...\n[2012-07-31 14:43:03,877] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 3 NOT interrupted3...\n[2012-07-31 14:43:03,878] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 4 NOT interrupted4...\n[2012-07-31 14:43:03,878] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 5 NOT interrupted5...\n[2012-07-31 14:43:03,878] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 6 NOT interrupted6...\n[2012-07-31 14:43:03,878] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 7 NOT interrupted7...\n[2012-07-31 14:43:03,878] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 8 NOT interrupted8...\n[2012-07-31 14:43:03,879] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 9 NOT interrupted9...\n[2012-07-31 14:43:03,879] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 10 INTERRUPTED1...\n3,0001,3,0001,[2012-07-31 14:43:03,882] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 19 NOT interrupted1...\n[2012-07-31 14:43:03,882] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 20 NOT interrupted2...\n[2012-07-31 14:43:03,882] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 21 NOT interrupted3...\n[2012-07-31 14:43:03,882] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 22 NOT interrupted4...\n[2012-07-31 14:43:03,883] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 23 NOT interrupted5...\n[2012-07-31 14:43:03,883] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 24 NOT interrupted6...\n[2012-07-31 14:43:03,883] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 25 NOT interrupted7...\n[2012-07-31 14:43:03,883] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 26 NOT interrupted8...\n[2012-07-31 14:43:03,884] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 27 NOT interrupted9...\n[2012-07-31 14:43:03,884] [INFO ] [com.macd.logging.UnitTest_Logger] [main] These messages should have been logged:\n[2012-07-31 14:43:03,884] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 1 NOT interrupted1...\n[2012-07-31 14:43:03,884] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 2 NOT interrupted2...\n[2012-07-31 14:43:03,885] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 3 NOT interrupted3...\n[2012-07-31 14:43:03,885] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 4 NOT interrupted4...\n[2012-07-31 14:43:03,885] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 5 NOT interrupted5...\n[2012-07-31 14:43:03,885] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 6 NOT interrupted6...\n[2012-07-31 14:43:03,885] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 7 NOT interrupted7...\n[2012-07-31 14:43:03,886] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 8 NOT interrupted8...\n[2012-07-31 14:43:03,886] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 9 NOT interrupted9...\n[2012-07-31 14:43:03,886] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 10 INTERRUPTED1...\n[2012-07-31 14:43:03,886] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 11 INTERRUPTED2...\n[2012-07-31 14:43:03,886] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 12 INTERRUPTED3...\n[2012-07-31 14:43:03,887] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 13 INTERRUPTED4...\n[2012-07-31 14:43:03,887] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 14 INTERRUPTED5...\n[2012-07-31 14:43:03,887] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 15 INTERRUPTED6...\n[2012-07-31 14:43:03,887] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 16 INTERRUPTED7...\n[2012-07-31 14:43:03,888] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 17 INTERRUPTED8...\n[2012-07-31 14:43:03,888] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 18 INTERRUPTED9...\n[2012-07-31 14:43:03,888] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 19 NOT interrupted1...\n[2012-07-31 14:43:03,888] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 20 NOT interrupted2...\n[2012-07-31 14:43:03,888] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 21 NOT interrupted3...\n[2012-07-31 14:43:03,889] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 22 NOT interrupted4...\n[2012-07-31 14:43:03,889] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 23 NOT interrupted5...\n[2012-07-31 14:43:03,889] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 24 NOT interrupted6...\n[2012-07-31 14:43:03,889] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 25 NOT interrupted7...\n[2012-07-31 14:43:03,890] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 26 NOT interrupted8...\n[2012-07-31 14:43:03,890] [INFO ] [com.macd.logging.UnitTest_Logger] [main] 27 NOT interrupted9...", "is_private": false, "id": 161044, "creator": "michael@michaelmess.de", "time": "2012-08-01T12:57:03Z", "bug_id": 53635, "creation_time": "2012-08-01T12:57:03Z", "attachment_id": null}]