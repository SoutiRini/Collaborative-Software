[{"count": 0, "tags": [], "text": "Created attachment 28129\n2012-01-09_trunk_TestTomcat_twoapps.patch\n\nInspired by this thread on dev@:\nhttp://tomcat.markmail.org/thread/5qxa7gjsaav4ytcd\n\"problem using default Realm in new unit tests\"\n\nThe problem is the following:\n\n1. Tomcat.getDefaultRealm() is effectively a factory method for some Realm instance. It creates this Realm once and caches it as Tomcat#defaultRealm\n\n2. Tomcat.addWebapp() method calls ctx.setRealm(defaultRealm); for every Context that it creates. Thus the Realm instance is shared between web applications.\n\n3. When Context starts it calls start() method on the realm. When the above method was used to create several web applications then during the start of the second and later ones the following message is logged:\n\n09.01.2012 19:19:29 org.apache.catalina.util.LifecycleBase start\nINFO: The start() method was called on component [Realm[Simple]] after start() had already been called. The second call will be ignored.\n\nTo reproduce:\n1) Apply attached patch to org.apache.catalina.startup.TestTomcat of trunk.\n2) Run the test.\n3) See the above \"The start() method was called\" message in the logs.\n\n\nI think there are several ways to resolve this:\na) Do not call start() on the Realm if it is already started, as indicated by Lifecycle.getState()\nb) Change Tomcat class to do not share the Realm instance between Contexts. b.1) assign it to the Engine, or\nb.2) create a new instance every time.\n\n\nThe a) way may lead to problems when the Context is stopped. It is not clear whether the Realm shall be stopped or not. It it is stopped it will affect another webapp. It may also cause problems with asynchronous start of contexts implemented in 7.0.23+.\n\nThe b) way is consistent with what happens when server.xml is parsed.", "is_private": false, "bug_id": 52443, "id": 152639, "time": "2012-01-09T16:43:35Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2012-01-09T16:43:35Z", "attachment_id": 28129}, {"count": 1, "tags": [], "bug_id": 52443, "text": "One more:\nAssigning explicit defaultRealm in Tomcat.addWebapp() prevents us from assign a realm to Engine.  Because of the Realm created in addWebapp() the realm in Engine is never used in the new web application.", "id": 152640, "time": "2012-01-09T16:48:29Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2012-01-09T16:48:29Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 152733, "time": "2012-01-12T20:51:28Z", "bug_id": 52443, "creation_time": "2012-01-12T20:51:28Z", "text": "Fixed in trunk and 7.0.x and will be included in 7.0.24 onwards."}]