[{"count": 0, "tags": [], "text": "Problem: With Apache configured as a reverse HTTP proxy, when the backend server\nreturns a redirect, any output headers (other than Location) are getting lost. I\nnoticed and reproduced this with Set-Cookie but it applies to others too.\n\nCause: What's happening is that proxy_http_handler() in\nmodules/proxy/mod_proxy_http.c is returning an error state (ie: not OK or DONE)\nto ap_process_request() in modules/http/http_request.c ap_invoke_handler (by way\nof ap_invoke_handler/ap_run_handler). This causes ap_die() to be invoked, and\nthere the output headers are replaced with the error headers. The Location is\nspecifically kept. The body is also potentially stripped (though for most\nredirects this is not an issue).\n\nThe bug seems to be that ap_proxy_http_process_response() - called within\nproxy_http_handler() - is being too restrictive in what HTTP status code it\nconsiders to be \"not an error\" when dealing with its error-override logic:\n\n    if (conf->error_override) {\n        /* the code above this checks for 'OK' which is what the hook expects */\n        if (ap_is_HTTP_SUCCESS(r->status))\n            return OK;\n        else {\n            // ... stripped some lines here for clarity\n            return r->status;\n        }\n    } else\n        return OK;\n\nSo if you have 'ProxyErrorOverride On', this will return OK if the status coming\nfrom the backend server is >= 200 or < 300 only. Obviously redirects (which are\nnot errors) fall outside of this range.\n\nFix: the check here needs to also include redirect status codes. Ie: use\nap_is_HTTP_REDIRECT. There is a similar check futher up in the same function\nwhich also needs ammending (that deals with passing the body through).\n\nThis bug is a regression in behaviour from the 2.0 branch (currently we run\n2.0.58). Bug discovered and fix tested with 2.2.4 (will attach patch). Looking\nat SVN, the current behaviour has been in the 2.2 branch since before 2.2.0, and\nit is also in current trunk.", "is_private": false, "bug_id": 41601, "id": 99329, "time": "2007-02-13T07:29:24Z", "creator": "stuart@terminus.co.uk", "creation_time": "2007-02-13T07:29:24Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "stuart@terminus.co.uk", "text": "Created attachment 19579\npatch to fix bug on trunk", "id": 99330, "time": "2007-02-13T07:31:47Z", "bug_id": 41601, "creation_time": "2007-02-13T07:31:47Z", "is_private": false, "attachment_id": 19579}, {"count": 2, "tags": [], "creator": "stuart@terminus.co.uk", "text": "Created attachment 19580\npatch against 2.2.4 to fix bug", "id": 99331, "time": "2007-02-13T07:32:34Z", "bug_id": 41601, "creation_time": "2007-02-13T07:32:34Z", "is_private": false, "attachment_id": 19580}, {"count": 3, "tags": [], "bug_id": 41601, "attachment_id": null, "id": 99332, "time": "2007-02-13T07:46:59Z", "creator": "stuart@terminus.co.uk", "creation_time": "2007-02-13T07:46:59Z", "is_private": false, "text": "Hohum, clearly didn't search well enough before filing.\n\n*** This bug has been marked as a duplicate of 39245 ***"}]