[{"attachment_id": 31317, "tags": [], "bug_id": 56149, "is_private": false, "count": 0, "id": 173311, "time": "2014-02-18T08:21:09Z", "creator": "fschuler@bottomline.com", "creation_time": "2014-02-18T08:21:09Z", "text": "Created attachment 31317\nXML file to reproduce\n\nOn Solaris, we have a program that creates a named pipe in a directory, and is connected to it.\n\nWe use ant to collect files from this directory, but if the process is started (and so linked to the named pipe), ant is no longer able to parse the directory, as it will open the named pipe and wait for an answer on it.\n\nAttached is an XML script to reproduce. \n\n\nHere is the output of \"ant -v -f test_pipe.xml\" :\n> ant -v -f test_pipe.xml\nApache Ant(TM) version 1.8.2 compiled on December 20 2010\nBuildfile: /stelink/USERS/FSCH/ant/test_pipe.xml\nDetected Java version: 1.6 in: /stelink/steprt/package/jre/1.6.0\nDetected OS: SunOS\nparsing buildfile /stelink/USERS/FSCH/ant/test_pipe.xml with URI = file:/stelink/USERS/FSCH/ant/test_pipe.xml\nProject base dir set to: /stelink/USERS/FSCH/ant\nparsing buildfile jar:file:/stelink/steprt/package/ant/lib/ant.jar!/org/apache/tools/ant/antlib.xml with URI = jar:file:/stelink/steprt/package/ant/lib/ant.jar!/org/apache/tools/ant/antlib.xml from a zip file\nparsing buildfile jar:file:/stelink/steprt/package/ant/lib/ant-contrib-1.0b3.jar!/net/sf/antcontrib/antlib.xml with URI = jar:file:/stelink/steprt/package/ant/lib/ant-contrib-1.0b3.jar!/net/sf/antcontrib/antlib.xml from a zip file\nBuild sequence for target(s) `main' is [main]\nComplete build sequence is [main, ]\n\nmain:\n [property] Loading Environment env.\n     [echo] arch=sparc\n     [echo] dir=.\n\nWhatever the time waited, the script won't go further.\nHere is what is seen when following the system calls with \"truss -fale ant -v -f test_pipe.xml\" (last correct file parsed, and the open of the named pipe) : \n................................\n25708/2:        openat(-3041965, \"/stelink/steprt/server/exec/srvaig.exe.ORIGINAL\", O_RDONLY|O_NDELAY|O_LARGEFILE) = 34\n25708/2:        fcntl(34, F_SETFD, 0x00000001)                  = 0\n25708/2:        fstat64(34, 0xFAB7E7E0)                         = 0\n25708/2:        close(34)                                       = 0\n25708/23:       pollsys(0x00000000, 0, 0xB2AFFC98, 0x00000000)  = 0\n25708/23:       pollsys(0x00000000, 0, 0xB2AFFC98, 0x00000000)  = 0\n................................\n25708/23:       pollsys(0x00000000, 0, 0xB2AFFC98, 0x00000000)  = 0\n25708/21:       lwp_cond_wait(0x001BCE48, 0x001BCE30, 0x00000000, 0) (sleeping...)\n25708/23:       pollsys(0x00000000, 0, 0xB2AFFC98, 0x00000000)  = 0\n25708/2:        openat(-3041965, \"/stelink/steprt/server/exec/ISH.pipe.0.1100.11100\", O_RDONLY|O_NDELAY|O_LARGEFILE) (sleeping...)\n25708/23:       pollsys(0x00000000, 0, 0xB2AFFC98, 0x00000000)  = 0\n................................\n\nThe pollsys continue, with a lwp_cond_wait error every 17 calls : \n25708/16:       lwp_cond_wait(0x0019E648, 0x0019E630, 0xB31FFB58, 0) Err#62 ETIME\n\n\nThe problem does not occur if the <include name> does not contain a '*' (ie : if looking for a specific file).\n\nThis problem is reproductible at will on our solaris plateforms (not on other because the ISH process that creates and uses the pipe uses sockets on other systems)."}, {"count": 1, "tags": [], "text": "I haven't got access to a Solaris machine.\n\nCan you tell us what java.io.File's isFile and isDirectory think about the named pipe?  Also in your example, the name of the named pipe is /stelink/steprt/server/exec/srvaig.exe.ORIGINAL?", "is_private": false, "id": 173555, "creator": "bodewig@apache.org", "time": "2014-02-28T17:21:50Z", "bug_id": 56149, "creation_time": "2014-02-28T17:21:50Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 56149, "attachment_id": null, "id": 173575, "time": "2014-03-03T09:29:36Z", "creator": "fschuler@bottomline.com", "creation_time": "2014-03-03T09:29:36Z", "is_private": false, "text": "Hello,\n\nThanks for your answer.\n\njava.io.File's isFile and isDirectory both return false. If I can provide anything more, don't hesitate to ask.\n\nIn the sample, we can see two calls to openat : \nthe first one, on /stelink/steprt/server/exec/srvaig.exe.ORIGINAL, returns 34, which is a valid return value for openat (any value above 0 is OK). No problem here.\n\nThe second one, /stelink/steprt/server/exec/ISH.pipe.0.1100.11100, which never returns : it only shows (sleeping...)\n\nAs far as my understanding of the pipe is correct, this is a normal behavior as there is a program that is listening on this pipe : the open of the pipe \"connects\" to this program, waiting for a response that never comes.\n\nThe same call of \"truss\" on the \"ls\" command -- which does not reveal the same problem -- result in the following 5 calls : \nlstat64(\"./ISH.pipe.0.1100.11100\", 0xFFBFA420)  = 0\npathconf(\"./ISH.pipe.0.1100.11100\", 20)         = 0\nacl(\"./ISH.pipe.0.1100.11100\", GETACLCNT, 0, 0x00000000) = 4\nstat64(\"./ISH.pipe.0.1100.11100\", 0xFFBF9228)   = 0\nacl(\"./ISH.pipe.0.1100.11100\", GETACL, 4, 0x000316D8) = 4\n\nThere is no open of the file, just some \"stat\" calls, which look to the file but do not try to open it.\n\nIf I'm unclear or if I can provide some more help, feel free to ask.\n\nBest regards,\nFabrice"}, {"count": 3, "text": "Thanks for verifying.\n\nThere are several places in DirectoryScanner that assume isFile/isDirectory to be two sides of a coin.  In particular in one place if isFile is false it is assumed the \"thing\" must be a dirctory and it is traversed - this may trigger opening the named pipe on Solaris.\n\nI guess we need to decide what to do with entities that are neither files nor directories in Ant to properly fix this.\n\nAt first I thought using selectors could help (<or> together <type> selectors for file and directory) but I think they'd be considered to late and Ant would still try to traverse the named pipe as directory first.\n\nSo yes, this is a bug and unfortunately I don't see any workaround for now.  I'll start a discussion on the dev list and we'll see what kind of fix we'll come up with.\n\nThanks!", "creator": "bodewig@apache.org", "attachment_id": null, "id": 173585, "time": "2014-03-03T13:33:17Z", "bug_id": 56149, "creation_time": "2014-03-03T13:33:17Z", "tags": [], "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 56149, "is_private": false, "count": 4, "id": 173587, "time": "2014-03-03T14:11:43Z", "creator": "fschuler@bottomline.com", "creation_time": "2014-03-03T14:11:43Z", "text": "Thanks to you !\n\nFor information, the only workaround we found is to execute a shell procedure that  copies the files we are interested in to a temporary directory, and then work with ant on this tmp dir.\n\nIf you need any other information, feel free to ask.\n\nBR\nFabrice"}, {"count": 5, "tags": [], "bug_id": 56149, "attachment_id": null, "text": "should be fixed with svn revision 1573999", "id": 173615, "time": "2014-03-04T10:06:15Z", "creator": "bodewig@apache.org", "creation_time": "2014-03-04T10:06:15Z", "is_private": false}]