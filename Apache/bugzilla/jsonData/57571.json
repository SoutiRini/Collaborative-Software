[{"attachment_id": 32457, "tags": [], "creator": "genka_v@yahoo.com", "is_private": false, "count": 0, "id": 180984, "time": "2015-02-11T23:39:06Z", "bug_id": 57571, "creation_time": "2015-02-11T23:39:06Z", "text": "Created attachment 32457\nTest to reproduce.\n\nSXSSF output with cell comments cannot be opened in Excel 2013. Excel shows a dialog \"We found some problems...\". After Excel attempts to \"fix\" the doc, it shows the following message: \"Removed Records: Comments from /xl/comments1.xml part (Comments)\" \nAfter this, all comments are gone. \n\nSee attached test to reproduce. It' based on POI's own SSPerformanceTest, with a few modifications (added comments, changed to default packaging, etc). \nIf you run it as below, the problem should be evident:\n  ... -Dexcel.comments=some SSPerformanceTest SXSSF 10000 6 1 \n\nBy contrast, XSSF works fine. After running the test with \"XSSF\" as the first arg, the resulting spreadsheet is valid.\n\nFrom our perspective, it's a blocker since we use comments extensively.\nNB: also submitting another bug about comments causing quick OOM in SXSSF"}, {"count": 1, "tags": [], "bug_id": 57571, "text": "Can POI XSSF read the SXSSF comment file without error? Can it see the comments? Can older versions of Excel read it without error? If you generate the same file with XSSF and SXSSF, then unzip the two, how do the two files differ in the xml inside?", "id": 180985, "time": "2015-02-11T23:44:59Z", "creator": "apache@gagravarr.org", "creation_time": "2015-02-11T23:44:59Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 57571, "text": "Created attachment 32459\nzip with two outputs valid (XSSF) invalid (SXSSF)\n\nAttaching a zip with two outputs valid (XSSF) invalid (SXSSF). Both are generated by the harness attached. \nAttempted to open the invalid XLSX with Excel 2003. It failed", "id": 180987, "time": "2015-02-12T00:13:00Z", "creator": "genka_v@yahoo.com", "creation_time": "2015-02-12T00:13:00Z", "is_private": false, "attachment_id": 32459}, {"count": 3, "tags": [], "bug_id": 57571, "text": "How do the two files differ though? (The OOXMLPrettyPrint tool could help with this, if you don't fancy just unzipping the two files and diffing yourself)", "id": 180998, "time": "2015-02-12T08:33:43Z", "creator": "apache@gagravarr.org", "creation_time": "2015-02-12T08:33:43Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "genka_v@yahoo.com", "text": "I found root cause and workaround. \nHere is how I add comments. Notice two extra calls added that address the problem. Now I can open spreadsheets in Excel\n    private static void createComment(Drawing drawing, Cell cell)\n    {\n        CreationHelper factory = workBook.getCreationHelper();\n\n        ClientAnchor anchor = factory.createClientAnchor();\n        anchor.setCol1(cell.getColumnIndex());\n        anchor.setCol2(cell.getColumnIndex() + 2);\n        anchor.setRow1(cell.getRowIndex());\n        anchor.setRow2(cell.getRowIndex()+1);\n\n        Comment comment = drawing.createCellComment(anchor);\n        comment.setAuthor(\"Tester\");\n        comment.setString(factory.createRichTextString(\"Cell \" + cell.getColumnIndex() + \"x\" + cell.getRowIndex() + \" commment\"));\n        cell.setCellComment(comment);\n        comment.setColumn(cell.getColumnIndex());   // <<<<<<<< fixes the problem        comment.setRow(cell.getRowIndex());    // <<<<<<<< fixes the problem\n    }\nNow, the diff on vmlDrawing1.xml highlighted the problem I have addressed by those two extra calls. Observe that for SXSSF, <Row> and <Column> are always 0 for ALL comments:\n  <v:shape id=\"_x0000_s1248\" type=\"#_xssf_cell_comment\" style=\"position:absolute; visibility:hidden\" fillcolor=\"#ffffe1\" o:insetmode=\"auto\">\n    <v:fill color=\"#ffffe1\"/>\n    <v:shadow on=\"t\" color=\"black\" obscured=\"t\"/>\n    <v:path o:connecttype=\"none\"/>\n    <v:textbox style=\"mso-direction-alt:auto\"/>\n    <x:ClientData ObjectType=\"Note\">\n      <x:MoveWithCells/>\n      <x:SizeWithCells/>\n      <x:Anchor>2, 0, 7500, 0, 4, 0, 7501, 0</x:Anchor>\n      <x:AutoFill>False</x:AutoFill>\n      <x:Row>0</x:Row>\n      <x:Column>0</x:Column>\n    </x:ClientData>\n  </v:shape>\n  <v:shape id=\"_x0000_s1249\" type=\"#_xssf_cell_comment\" style=\"position:absolute; visibility:hidden\" fillcolor=\"#ffffe1\" o:insetmode=\"auto\">\n    <v:fill color=\"#ffffe1\"/>\n    <v:shadow on=\"t\" color=\"black\" obscured=\"t\"/>\n    <v:path o:connecttype=\"none\"/>\n    <v:textbox style=\"mso-direction-alt:auto\"/>\n    <x:ClientData ObjectType=\"Note\">\n      <x:MoveWithCells/>\n      <x:SizeWithCells/>\n      <x:Anchor>4, 0, 7500, 0, 6, 0, 7501, 0</x:Anchor>\n      <x:AutoFill>False</x:AutoFill>\n      <x:Row>0</x:Row>\n      <x:Column>0</x:Column>\n    </x:ClientData>\n  </v:shape>\nSince workaround is good, I am lowering the severity of this bug", "count": 4, "id": 181009, "time": "2015-02-12T16:11:32Z", "bug_id": 57571, "creation_time": "2015-02-12T16:11:32Z", "is_private": false}, {"count": 5, "tags": [], "text": "This is now fixed again via r1692483, it was a regression that was introduced in 2013 as part of fixing Bug 54920, your workaround was pretty much the fix as well, thanks for reporting!", "is_private": false, "id": 184160, "creator": "dominik.stadler@gmx.at", "time": "2015-07-24T12:03:01Z", "bug_id": 57571, "creation_time": "2015-07-24T12:03:01Z", "attachment_id": null}]