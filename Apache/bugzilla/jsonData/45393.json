[{"count": 0, "tags": [], "creator": "dstusynski@ptc.com", "is_private": false, "text": "There seems to be an issue on Windows Apache 2.2.9 when compiled against the MSSDK for LDAP. When a user accesses a authenticated resource and is prompted for credentials, if they do not enter a username and password and instead hit ok at the prompt, Apache returns a 500 error due to a filter error.\n\nExcerpt from the Error Log:\n[Mon Jul 14 11:16:04 2008] [debug] mod_headers.c(711): headers: ap_headers_output_filter()\n[Mon Jul 14 11:16:08 2008] [debug] mod_authnz_ldap.c(377): [client 132.253.10.108] [6488] auth_ldap authenticate: using URL ldap://server:389/ou=people,cn=EnterpriseLdap,cn=app,dc=server,dc=subdomain,dc=domain,dc=com, referer: http://server:10080/app/\n[Mon Jul 14 11:16:08 2008] [warn] [client 132.253.10.108] [6488] auth_ldap authenticate: user  authentication failed; URI /app/servlet/Navigation [ldap_search_ext_s() for user failed][Filter Error], referer: http://server:10080/app/\n\nTaken from the Access Log:\n132.253.10.108 - - [14/Jul/2008:11:16:08 -0500] \"GET /PDMPJL91/servlet/Navigation HTTP/1.1\" 500 487 15625\n\nI was slightly curious about this so I recompiled with a few lines of \"random\" debugging to see what statements where firing and what some variables were being set to in mod_authnz_ldap.c and util_ldap.c.\n\nIn mod_authnz_ldap.c's function static void authn_ldap_build_filter(...):\nI added a logging statement in the \nif (sent_user != NULL) {\n        user = apr_pstrdup (r->pool, sent_user);\nto see what the user was being set to in the event this statement was executing. Ther user was logged as \"user=[]\" and is clearly not NULL which I expected since in fact the if(sent_user != NULL) was executing. I originally didn't expect this statement to execute at all.\n\nThe filter eventually gets created by:\nelse\n        filter = sec->filter;\n\nand is set to the \"objectclass=*\" (my logs kick out filter=[objectclass=*]). From a quick glance that appears to be a valid filter for the MS ldap_search_ext_s API.\n\nThen when authn_ldap_check_password function gets executed I originally expected the request to error out on the password=NULL and/or the username=NULL check, however, these did not execute. I guess that means the empty user/pass is an empty string as opposed to NULL.\n\nIn util_ldap.c the statement:\nresult = ldap_search_ext_s(ldc->ldap,\n                               (char *)basedn, scope,\n                               (char *)filter, attrs, 0,\n                               NULL, NULL, NULL, APR_LDAP_SIZELIMIT, &res);\n\nin results error code being Filter Error from the logs.\n\nFor sanity sake, I tested with Firefox and IE to rule out any odd IE quirk. \n\nIs this an Apache issue not handling the blank user/pass credentials properly?", "id": 118656, "time": "2008-07-14T11:07:35Z", "bug_id": 45393, "creation_time": "2008-07-14T11:07:35Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "covener@gmail.com", "attachment_id": null, "text": "I went down this path for another PR (or issue raised on IRC) a few months ago.\n\nThe empty userid is permitted by HTTP basic auth, and some LDAP SDKs do support the filter generated such as \"attr=\" with no value.  I believe I lost the heart to try to change it when both openldap and Tivoli directory server supported the syntax.\n\nif you can find chapter and verse of the LDAP filter syntax that says it's forbidden, mod_authnz_ldap would be able to short-circuit sending the DN search -- otherwise we'd have to add some special-case MSSDK logic to do the same (to prevent the 500, request still forbidden obviously)", "id": 118658, "time": "2008-07-14T13:50:06Z", "bug_id": 45393, "creation_time": "2008-07-14T13:50:06Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 45393, "text": "The additional bug 41435 seems the same as this one I reported (not sure if that is what you were referring to). I tried to decide on a way to modify mod_authnz_ldap.c authn_ldap_build_filter() function to handle this situation but I don't see a way that one can build a valid MS LDAP filter that is 1) valid for syntax and 2) that isn't guaranteed to return any users. Simply using objectclass=* wouldn't work for the use case of 1 LDAP user, nor would the attempt to have a uid=null (a null string) since that gets translated to a literal uid when searching LDAP (as opposed to '\\0' or similar C representation).\n\nI'm left thinking that just modifying util_ldap.c as the original poster in that bug mentioned is a decent option while adding a check that the requests user isn't blank (so we only gobble the FILTER_ERROR when a username is blank). For example: \n\n/* MS LDAP SDK returns a FILTER ERROR when searching for \"attr=\" \n   attribute=nothing). Check the result error and user length from the request\n   and return invalid instead of 500. */\n#if APR_HAS_MICROSOFT_LDAPSDK\n    if ( (result == LDAP_FILTER_ERROR) && (strlen(r->user) <= 0) )\n    {   \n        ldc->reason = \"ldap_search_ext_s() to search for user failed\";\n        ldap_msgfree(res);\n        uldap_connection_unbind(ldc);\n        return LDAP_INVALID_CREDENTIALS;\n    }\n#endif\n\nPlace this just after the ldap_search_ext_s() ldap call and before the all encompassing if (result != LDAP_SUCCESS) statement.\n\n", "id": 118772, "time": "2008-07-17T13:18:05Z", "creator": "dstusynski@ptc.com", "creation_time": "2008-07-17T13:18:05Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "iblanco@flumotion.com", "attachment_id": null, "text": "We have Linux RHEL6 with httpd 2.2.15, and after loged with LDAP username and password, apache return 500 error.\n\nNo information available about this error in the server error log.\n\nWith the follow configuration:\n\n# vim: syntax=apache\n\n<VirtualHost _default_:443>\n    SSLEngine On\n    SSLProtocol all -SSLv2\n    SSLCipherSuite HIGH:MEDIUM\n    SSLCertificateFile /etc/pki/tls/certs/xxx.crt\n    SSLCertificateKeyFile /etc/pki/tls/private/xxxxxxxxx.key\n    ServerName xxxxxxxxxx\n    ServerAlias xxxxxxxxxxxxx\n    DocumentRoot /var/www/xxxxxxxx\n    # Specific configuration\n    <Location /private/status>\n        SetHandler server-status\n    </Location>\n    <Location />\n        AuthType Basic\n        AuthName \"Admin xxxxxx\"\n        AuthBasicProvider ldap\n        AuthzLDAPAuthoritative on\n        AuthLDAPURL ldaps://ldap.xxxxxxxx.com/ou=People,dc=xxxxx,dc=com?uid?one\n        Require ldap-user xxxx xxxx\n    </Location>\n    ErrorLog logs/xxxxxxxx-ssl-error_log\n    CustomLog logs/xxxxxxxxx-ssl-access_log combined\n</VirtualHost>\n\nModules loaded:\n\nauth_basic_module\nldap_module\nauthnz_ldap_module\n\n\nThe same configuration works with RHEL5.x and httpd 2.2.3.", "id": 143545, "time": "2011-01-21T07:27:23Z", "bug_id": 45393, "creation_time": "2011-01-21T07:27:23Z", "is_private": false}, {"count": 4, "tags": [], "text": "Ignasi, don't misapropriate someone elses open bug report.", "is_private": false, "id": 143546, "creator": "covener@gmail.com", "time": "2011-01-21T07:38:15Z", "bug_id": 45393, "creation_time": "2011-01-21T07:38:15Z", "attachment_id": null}]