[{"count": 0, "tags": [], "text": "I have received no response from Apache Dev Mailing List for 5 days.\n\nI would like to draw your attention to a new patch for OpenSSL which will ultimately mean that Apache needs to treat dual EC-RSA certificate configurations with server info (currently used only for TLS extension of certificate transparency) differently than until now. Specifically, the patches are https://github.com/openssl/openssl/pull/914 and https://github.com/openssl/openssl/pull/915.\n\nThey originated from research involving my Apache server configuration (on Ubuntu 16.04) and Castaglia's coding of patches.\n\nThe Apache/OpenSSL bug is described fully here: http://serverfault.com/questions/758482/apache-extension-error (the software I used when I published this Serverfault thread was a bit older than now, but the problem still persists in a different from: now instead of quitting the connection OpenSSL accepts the connection but doesn't send ServerInfo data). In particular, see the comment of Castaglia on their answer to the thread for possible new Apache idea of implementation.\n\nMaybe the following would be a good approach: After the first certificate-private key pair, accept a ServerInfo Openssl configuration directive which would call SSL_CTX_use_serverinfo_file for that certificate. Then the configuration goes on with the second certificate-private key pair and after that, the second serverinfo file location via Openssl configuration directive (if applicable, that is if the server has dual certificate configuration). So, Apache would need to process each pair and then, if it finds directly below it a serverinfo, call SSL_CTX_use_serverinfo_file for THAT certificate. When a new certificate-key pair is registered, the SSL_CTX_use_serverinfo_file would be called again but for the last certificate only.\n\nThere is no error logged on any Apache log file.", "attachment_id": null, "bug_id": 59438, "id": 190763, "time": "2016-05-08T10:49:08Z", "creator": "jasonmili@hotmail.com", "creation_time": "2016-05-08T10:49:08Z", "is_private": false}, {"count": 1, "tags": [], "text": "*in a different form", "is_private": false, "bug_id": 59438, "id": 190764, "time": "2016-05-08T10:51:09Z", "creator": "jasonmili@hotmail.com", "creation_time": "2016-05-08T10:51:09Z", "attachment_id": null}, {"count": 2, "attachment_id": null, "creator": "jasonmili@hotmail.com", "text": "Detailed OpenSSL session when this fails:\n\nCommand: \"openssl s_client -CApath /etc/ssl/certs -cipher DHE-RSA-AES256-SHA -serverinfo 18 -connect winpack.eu.org:443\"\n\nOutput:\n\nCONNECTED(00000003)\ndepth=2 O = Digital Signature Trust Co., CN = DST Root CA X3\nverify return:1\ndepth=1 C = US, O = Let's Encrypt, CN = Let's Encrypt Authority X3\nverify return:1\ndepth=0 CN = winpack.cf\nverify return:1\n---\nCertificate chain\n 0 s:/CN=winpack.cf\n   i:/C=US/O=Let's Encrypt/CN=Let's Encrypt Authority X3\n 1 s:/C=US/O=Let's Encrypt/CN=Let's Encrypt Authority X3\n   i:/O=Digital Signature Trust Co./CN=DST Root CA X3\n---\nServer certificate\n-----BEGIN CERTIFICATE-----\nMIIGmzCCBYOgAwIBAgISA3XRpPHxuH1gqdOpHtPHPmzMMA0GCSqGSIb3DQEBCwUA\nMEoxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MSMwIQYDVQQD\nExpMZXQncyBFbmNyeXB0IEF1dGhvcml0eSBYMzAeFw0xNjAzMjUxOTU3MDBaFw0x\nNjA2MjMxOTU3MDBaMBUxEzARBgNVBAMTCndpbnBhY2suY2YwggIiMA0GCSqGSIb3\nDQEBAQUAA4ICDwAwggIKAoICAQCn/fciS4Z+YPTHtkNrWjTj1Bv222hBw6zBtbGz\nt20cC64rACNfUjYCNDfgmhIo/lbhi23Kow7Maah74riLY0Dlr2iFELAUD2w+V2z6\nacusjpVYKidubwrFT8Re5L6MzSq0BXEzcxIx4FWVBlfaYguGpMZqjOLhbxQgHFHZ\nsVp2/dtxLrB5C2iUlU5v4mcoMR4hCc9/WHgqi5tqSUT8G/XNzwXe8kj3iJ5WL6bL\nxy0MYfi7Lq5KIHsfu7RZiJuPoqia6H3PhKLqDylcch/+40IPk8wCEZvDACDh2tX0\nXGYmGKjVzli/P62H0hepn9cKiMoxck6Uk+YZiZWEKllldzbuNpTaZyEF939NJ6Ga\n/rHnVqIHetUKJhuRu5Ph+OMOPGUyzPt57G4TNTKGrpwvdTUvmliZmfCXZEi3XnJm\no+ULsxM6ByF+mMMOGiVJ7K0sv1KW9k8clK1zqCc6ZKz8wivPL9/YLYVCplS7vzCK\nHFqGF6t6YbM7VoCvkKCeK5gro2V8M4ggGo5YxQogg2SHVqg8ZEHFt4nIYJdBf9Hu\nGTNP/yiOkysSys+g3bKQ+2kkZatYtcw61G75adml4DyPt5t83T2mlcCXgxwRdz19\nD25vLlTiH1jCdM7x9b/j+WGMbWDfDTCfSNlNW5Myv8gI7uI54Kr/yJ3YMvu8gl07\npmNJRQIDAQABo4ICrjCCAqowDgYDVR0PAQH/BAQDAgWgMB0GA1UdJQQWMBQGCCsG\nAQUFBwMBBggrBgEFBQcDAjAMBgNVHRMBAf8EAjAAMB0GA1UdDgQWBBTQ50MGPlk7\nMq2jmYluZCmYgee7ijAfBgNVHSMEGDAWgBSoSmpjBH3duubRObemRWXv86jsoTBw\nBggrBgEFBQcBAQRkMGIwLwYIKwYBBQUHMAGGI2h0dHA6Ly9vY3NwLmludC14My5s\nZXRzZW5jcnlwdC5vcmcvMC8GCCsGAQUFBzAChiNodHRwOi8vY2VydC5pbnQteDMu\nbGV0c2VuY3J5cHQub3JnLzCBtwYDVR0RBIGvMIGsgg9tYWlsLndpbnBhY2suY2aC\nE21haWwud2lucGFjay5ldS5vcmeCDW14LndpbnBhY2suY2aCEW14LndpbnBhY2su\nZXUub3Jngg5teDIud2lucGFjay5jZoISbXgyLndpbnBhY2suZXUub3Jnggp3aW5w\nYWNrLmNmgg53aW5wYWNrLmV1Lm9yZ4IOd3d3LndpbnBhY2suY2aCEnd3dy53aW5w\nYWNrLmV1Lm9yZzCB/gYDVR0gBIH2MIHzMAgGBmeBDAECATCB5gYLKwYBBAGC3xMB\nAQEwgdYwJgYIKwYBBQUHAgEWGmh0dHA6Ly9jcHMubGV0c2VuY3J5cHQub3JnMIGr\nBggrBgEFBQcCAjCBngyBm1RoaXMgQ2VydGlmaWNhdGUgbWF5IG9ubHkgYmUgcmVs\naWVkIHVwb24gYnkgUmVseWluZyBQYXJ0aWVzIGFuZCBvbmx5IGluIGFjY29yZGFu\nY2Ugd2l0aCB0aGUgQ2VydGlmaWNhdGUgUG9saWN5IGZvdW5kIGF0IGh0dHBzOi8v\nbGV0c2VuY3J5cHQub3JnL3JlcG9zaXRvcnkvMA0GCSqGSIb3DQEBCwUAA4IBAQAa\nWVAFmNQaKw9ZDTuz0tW9ZadB0cO6ufLtC7J6THERQhtGcisgtRQdRgrlNOTdvkyL\nGi5zoqoSiz0AyMWsyB5f7ZoFDiB3ZGJ/Z1nGELmRpVVbUVsZqOEIrf1hb9tgV0IE\no+uCBMZJBRlLzeKvWLkoruOScEY+3W8SQHUKc1FHsOxAEhjuM2xx6XrbfT6BlvaO\nFtZzhgbTvVRZ4g2eC/W2bEhy7erHpFTbFukRwjfKiE5BF+gwpyy8S/2mS3pR8klG\nZoDUcnMJLOqsc97L2mhnjKyW360cIsu4n/Rpd3CCw3lTLLZ9XVae8PjjSzDo2Nc/\nbIl/ANOzNDUJr+JRGUiw\n-----END CERTIFICATE-----\nsubject=/CN=winpack.cf\nissuer=/C=US/O=Let's Encrypt/CN=Let's Encrypt Authority X3\n---\nNo client certificate CA names sent\nPeer signing digest: SHA512\nServer Temp Key: DH, 4096 bits\n---\nSSL handshake has read 4797 bytes and written 701 bytes\n---\nNew, TLSv1/SSLv3, Cipher is DHE-RSA-AES256-SHA\nServer public key is 4096 bit\nSecure Renegotiation IS supported\nCompression: NONE\nExpansion: NONE\nNo ALPN negotiated\nSSL-Session:\n    Protocol  : TLSv1.2\n    Cipher    : DHE-RSA-AES256-SHA\n    Session-ID: B1796305C99DC2086C9AEBAD8CD1C8F7A0F1E5DC06D940E8B40E4C349D2E268C\n    Session-ID-ctx: \n    Master-Key: 5A06BEEB42CA60AEA80CABFEBED2E1D3301E6979C5851CF3BFC0DA654E2EDEEA023918E8E254F0E8B119F7101CDF31F0\n    Key-Arg   : None\n    PSK identity: None\n    PSK identity hint: None\n    SRP username: None\n    TLS session ticket lifetime hint: 300 (seconds)\n    TLS session ticket:\n\n            (info truncated by me)\n\n    Start Time: 1462704766\n    Timeout   : 300 (sec)\n    Verify return code: 0 (ok)\n---\n\n(note that there is no serverinfo tls extension here)", "id": 190765, "time": "2016-05-08T10:54:12Z", "bug_id": 59438, "creation_time": "2016-05-08T10:54:12Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "text": "The issue seems to be that SSLOpenSSLConfCmd and SSLCertificateFile/SSLCertificateKeyFile don't mix well with each other.\n\nCould you try to use exclusively SSLOpenSSLConfCmd to configure your certificate(s) file/key/info/dhparams?\n\nSomething like:\n\nSSLOpenSSLConfCmd Certificate /path/to/server/cert/file\nSSLOpenSSLConfCmd PrivateKey /path/to/server/cert/key\nSSLOpenSSLConfCmd ServerInfoFile /path/to/server/info/file\nSSLOpenSSLConfCmd DHParameters /path/to/dh/params/file (if any)\n\nrepeated for every certificate/info/dhparams you need to configure, and see if it works?", "is_private": false, "bug_id": 59438, "id": 190772, "time": "2016-05-08T19:50:15Z", "creator": "ylavic.dev@gmail.com", "creation_time": "2016-05-08T19:50:15Z", "attachment_id": null}, {"count": 4, "attachment_id": null, "bug_id": 59438, "text": "Great, Yann, this worked like a charm.\n\nHowever, I am curious: When using the above mentioned command \"openssl s_client -CApath /etc/ssl/certs -cipher DHE-RSA-AES256-SHA -serverinfo 18 -connect winpack.eu.org:443\" after displaying ServerInfo extension OpenSSL hangs for about 0.75 seconds and then displays other info, whereas when using ECDSA (without the -cipher DHE-RSA-AES256-SHA) everything is displaying without the intermittent 0.75-second lag.\n\nSo, maybe document that for dual EC/RSA certificate configurations the SSLOpenSSLConfCmd should be used exclusively?", "id": 190774, "time": "2016-05-08T20:14:50Z", "creator": "jasonmili@hotmail.com", "creation_time": "2016-05-08T20:14:50Z", "tags": [], "is_private": false}]