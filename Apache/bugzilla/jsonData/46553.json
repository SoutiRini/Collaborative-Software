[{"count": 0, "attachment_id": 23137, "bug_id": 46553, "text": "Created attachment 23137\nCode that demonstrates the problem\n\nI believe I found a bug in the applyFont() method of class HSSFRichTextString. I am also posting the corresponding fix. I am also including posting think demo code is necessary for this because \n\n\n\nIncidently, in searching for a related bug to which I could apply this fix, I found a similar bug: Bug 40520, \"HSSFFont.applyFont() formats wrong parts of HSSFRichTextString\". \n\nIt looks like this bug has already been resolved in release 3.5-beta4. (I didn't test if it was resolved in 3.2 FINAL). I'm not fully familiar with the posting rules, so I didn't mark it as such.", "id": 124141, "time": "2009-01-17T06:57:10Z", "creator": "davidcw@mit.edu", "creation_time": "2009-01-17T06:57:10Z", "tags": [], "is_private": false}, {"count": 1, "attachment_id": null, "bug_id": 46553, "text": "Apologies, I accidently submitted this bug by clicking the Commit button prematurely. Here is the completed report...\n\nI believe I found a bug in the applyFont() method of class HSSFRichTextString.\nThe fix for the applyFont() method is included in plain-text, below. The fix is simple: In the applyFont() method, in the section of code that \"reapplies\" the current font, it samples the font at the \"startIndex\". However, it would seem to make more sense if it samples the font at the \"endIndex\", and reapplies that instead.\n\nI have also attached the code that demonstrates this bug, this time with the associated excel file.\n\nThis 'bug' exists in both release 3.2 FINAL and 3.5-beta4.\n\nPROPOSED FIX:\n============================\n    public void applyFont(int startIndex, int endIndex, short fontIndex)\n    {\n        if (startIndex > endIndex)\n            throw new IllegalArgumentException(\"Start index must be less than end index.\");\n        if (startIndex < 0 || endIndex > length())\n            throw new IllegalArgumentException(\"Start and end index not in range.\");\n        if (startIndex == endIndex)\n            return;\n\n        //Need to check what the font is currently, so we can reapply it after\n        //the range is completed\n        short currentFont = NO_FONT;\n        if (endIndex != length()) {\n          // FIX: USES \"endIndex\" instead of the original \"startIndex\".\n          currentFont = this.getFontAtIndex(endIndex); \n        }\n\n        //Need to clear the current formatting between the startIndex and endIndex\n        string = cloneStringIfRequired();\n        Iterator formatting = string.formatIterator();\n        if (formatting != null) {\n          while (formatting.hasNext()) {\n            UnicodeString.FormatRun r = (UnicodeString.FormatRun)formatting.next();\n            if ((r.getCharacterPos() >= startIndex) && (r.getCharacterPos() < endIndex))\n              formatting.remove();\n          }\n        }\n\n\n        string.addFormatRun(new UnicodeString.FormatRun((short)startIndex, fontIndex));\n        if (endIndex != length())\n          string.addFormatRun(new UnicodeString.FormatRun((short)endIndex, currentFont));\n          \n        addToSSTIfRequired();\n    }\n\n\n============================\n\nIncidently, in searching for a related bug to which I could apply this fix, I\nfound a similar bug: Bug 40520, \"HSSFFont.applyFont() formats wrong parts of\nHSSFRichTextString\". \n\nIt looks like this bug has already been resolved in release 3.5-beta4. (I\ndidn't test if it was resolved in 3.2 FINAL). I'm not fully familiar with the\nposting rules, so I didn't mark it as such. ", "id": 124142, "time": "2009-01-17T07:11:28Z", "creator": "davidcw@mit.edu", "creation_time": "2009-01-17T07:11:28Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 46553, "is_private": false, "text": "Created attachment 23138\nExample problem code with the excel document it acts on.", "id": 124143, "time": "2009-01-17T07:12:57Z", "creator": "davidcw@mit.edu", "creation_time": "2009-01-17T07:12:57Z", "attachment_id": 23138}, {"count": 3, "tags": [], "bug_id": 46553, "text": "the fix applied in r738908.\n\nThanks,\nYegor", "id": 124476, "time": "2009-01-29T08:06:16Z", "creator": "yegor@dinom.ru", "creation_time": "2009-01-29T08:06:16Z", "is_private": false, "attachment_id": null}]