[{"count": 0, "tags": [], "bug_id": 45959, "attachment_id": null, "is_private": false, "id": 121256, "time": "2008-10-06T18:56:00Z", "creator": "henson@acm.org", "creation_time": "2008-10-06T18:56:00Z", "text": "I'm running Apache 2.2.8, configured with SymlinkIfOwnerMatch and\nserver-side includes enabled.\n\nIt looks like the server-side include \"include\" directive ignores the\nsetting of SymlinkIfOwnerMatch?\n\nFor example, let's say I have an htpasswd configuration file outside of\nthe document root:\n\n-rw-r-----   1 root     webservd       7 Oct  3 14:00\n/usr/pkg/etc/httpd/htpasswd\n\nIf I then make a symbolic link to that from a user account:\n\nlrwxrwxrwx   1 henson   csupomona      27 Oct  3 14:01\n/user/henson/www/pass.html -> /usr/pkg/etc/httpd/htpasswd\n\n\nAccess is forbidden, with the following message in the log file:\n\n[Fri Oct 03 14:01:51 2008] [error] [client 134.71.248.12] Symbolic link\nnot\nallowed or link target not accessible: /export/user/henson/www/pass.html\n\n\nHowever, if I create a server parsed HTML file in the same directory\ncontaining the following:\n\n        <!--#include file=\"pass.html\" -->\n\nWhen I request the .shtml file, the contents of the file pointed to by\nthe\nsymbolic link are included.\n\nI had thought that configuring server side includes with IncludesNoExec\nwas reasonably safe, but it would appear that such a configuration allows\nany file readable by the web server itself to be served?\n\nI took a look at mod_include.c, the include directive appears to be handled\nby the handle_include function which calls either ap_sub_req_lookup_file or\nap_sub_req_lookup_uri depending on whether the include is file or\nvirtual, and then calls ap_run_sub_req to presumably handle dumping out the\ncontent of the include.\n\nAs a sub request, I would have intuitively thought it would honor the\nconfiguration setting regarding symbolic links?\n\nAm I confused? Is there something wrong with my configuration? Is this an\nexpected behavior (I searched quite a bit and didn't find anything\nrelevant)? I also posted to the mailing list last week:\n\nhttp://marc.info/?l=apache-httpd-users&m=122306900916369&w=2\n\nAnd didn't receive any responses that really answered my questions.\n\nThanks much for any help..."}, {"count": 1, "tags": [], "creator": "henson@acm.org", "attachment_id": null, "text": "Just wondering if anyone had any thoughts on this? I'd like to verify if this is actually a bug, or expected behavior...\n\nThanks...", "id": 121380, "time": "2008-10-09T17:21:05Z", "bug_id": 45959, "creation_time": "2008-10-09T17:21:05Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 45959, "is_private": false, "count": 2, "id": 121381, "time": "2008-10-09T17:45:16Z", "creator": "wrowe@apache.org", "creation_time": "2008-10-09T17:45:16Z", "text": "Include cgi and include file do not validate their context.\n\nInclude virtual is what you were looking for, it does validate the cgi\nor file resource included virtually."}, {"count": 3, "tags": [], "bug_id": 45959, "is_private": false, "text": "Thanks for taking a look at this. However, include virtual appears to have the exact same problem. Given the following files in my web home directory:\n\nlrwxrwxrwx 1 henson csupomona 27 Oct  3 14:01 pass.html -> /usr/pkg/etc/httpd/htpasswd\n-rw-r--r-- 1 henson csupomona 37 Oct  9 17:50 test_ssi.shtml\n\nIf I attempt to access /~henson/pass.html,  I receive \"Forbidden You don't have permission to access /~henson/pass.html on this server.\" as expected.\n\nThe contents of test_ssi.shtml are:\n\n<!--#include virtual=\"pass.html\" -->\n\nWhen I access /~henson/test_ssi.shtml, the contents of /usr/pkg/etc/httpd/htpasswd appear in my browser.\n\nAs far as I can tell, \"include virtual\" also appears to ignore the setting of SymlinkIfOwnerMatch.\n\nIn addition, while you can enable includes without exec, I don't believe there is a way to allow include virtual only, IncludesNoExec allows both file and virtual includes. So even if include virtual respected SymlinkIfOwnerMatch (which it appears not to, unless I am missing something), it would not resolve the issue of being able to have SSI enabled on a server while preventing users from serving content via symbolic links.\n", "id": 121382, "time": "2008-10-09T18:01:12Z", "creator": "henson@acm.org", "creation_time": "2008-10-09T18:01:12Z", "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 45959, "attachment_id": null, "is_private": false, "id": 121384, "time": "2008-10-09T18:16:46Z", "creator": "wrowe@apache.org", "creation_time": "2008-10-09T18:16:46Z", "text": "can you take a moment to ensure your browser cache is completely flushed out\nand the server is restarted before trying /~henson/test_ssi.shtml once more?\n\nJust want to rule out that you aren't looking at the prior request."}, {"attachment_id": null, "tags": [], "bug_id": 45959, "is_private": false, "count": 5, "id": 121385, "time": "2008-10-09T18:47:36Z", "creator": "henson@acm.org", "creation_time": "2008-10-09T18:47:36Z", "text": "I'll do you one better than flushing my browser cache ;) :\n\n-----\n$ telnet 134.71.248.148 80\nTrying 134.71.248.148...\nConnected to 134.71.248.148.\nEscape character is '^]'.\nGET /~henson/test_ssi.shtml HTTP/1.1\nHost: www.csupomona.edu\n\nHTTP/1.1 200 OK\nDate: Fri, 10 Oct 2008 01:28:09 GMT\nServer: Apache/2.2.8 (Unix) mod_ssl/2.2.8 OpenSSL/0.9.8g\nAccept-Ranges: bytes\nTransfer-Encoding: chunked\nContent-Type: text/html\n\n7\nsecret\n-----\n\n\"secret\" is the contents of /usr/pkg/etc/httpd/htpasswd, I'm just using it as a test.\n\nIt's quite possible I am doing something stupid anyway, in which case I apologize in advance; but as far as I can tell everything is configured correctly.\n\nIdeally I would like both virtual and file SSI includes to respect symbolic link restrictions, as I was counting on that for my deployment; the users will revolt if our new services don't include SSI, but my plan for deploying authenticated content will not be secure if any of them are able to create symlinks to and serve arbitrary web server readable content :(.\n\nThanks much...\n"}, {"count": 6, "tags": [], "bug_id": 45959, "attachment_id": null, "is_private": false, "id": 121408, "time": "2008-10-10T07:49:44Z", "creator": "rpluem@apache.org", "creation_time": "2008-10-10T07:49:44Z", "text": "Please post your configuration."}, {"count": 7, "tags": [], "bug_id": 45959, "is_private": false, "text": "I stripped the configuration down to the bare minimum to demonstrate the problem:\n\n-------------------------------------\nServerRoot \"/usr/pkg\"\nListen 0.0.0.0:8080\nLoadModule authz_host_module lib/httpd/mod_authz_host.so\nLoadModule include_module lib/httpd/mod_include.so\nLoadModule log_config_module lib/httpd/mod_log_config.so\nLoadModule mime_module lib/httpd/mod_mime.so\nUser webservd\nGroup webservd\nServerAdmin root@csupomona.edu\nServerName www.csupomona.edu:8080\nUseCanonicalName On\nDocumentRoot \"/usr/pkg/share/httpd/htdocs\"\nPidFile \"/var/run/httpd-test.pid\"\nLockFile \"/var/log/httpd/accept-test.lock\"\n<Directory />\n        Options -FollowSymLinks\n        AllowOverride None\n        Order deny,allow\n        Deny from all\n</Directory>\n<Directory \"/usr/pkg/share/httpd/htdocs\">\n        Options -FollowSymLinks\n        AllowOverride None\n        Order allow,deny\n        Allow from all\n</Directory>\nLogLevel warn\nErrorLog \"/var/log/httpd/error-test_log\"\nLogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\"\ncombined\nCustomLog \"/var/log/httpd/access-test_log\" combined\nAddOutputFilter INCLUDES .shtml\n-------------------------------\n\nThe contents of /usr/pkg/share/httpd/htdocs are:\n\n-rw-r--r--   1 root     root        2326 Jun 25 09:58 apache_pb.gif\n-rw-r--r--   1 root     root        1385 Jun 25 09:58 apache_pb.png\n-rw-r--r--   1 root     root        2410 Jun 25 09:58 apache_pb22.gif\n-rw-r--r--   1 root     root        1502 Jun 25 09:58 apache_pb22.png\n-rw-r--r--   1 root     root        2205 Jun 25 09:58 apache_pb22_ani.gif\n-rw-r--r--   1 root     root          44 Jun 25 09:58 index.html\nlrwxrwxrwx   1 root     root          32 Oct 10 17:01 secret.html ->\n/usr/pkg/etc/httpd/htaccess-test\n-rw-r--r--   1 root     root          39 Oct 10 16:55 test_ssi.shtml\n\n\nThe ownership/permissions of the file /usr/pkg/etc/httpd/htaccess-test are:\n\n-rw-r-----   1 root     webservd      12 Oct 10 17:01/usr/pkg/etc/httpd/htaccess-test\n\n(Note: in this case, the ownership of the actual file matches the ownership of the symbolic link, but I changed the test configuration to \"Options -FollowSymLinks\" so it should not be allowed regardless)\n\nThe contents of test_ssi.shtml are:\n\n<!--#include virtual=\"secret.html\" -->\n\nTo rule out any browser caching or idiosyncrasies, I tested by connecting directly to the web server via telnet.\n\nAttempting to access the symbolic link directly failed as expected:\n\n-----\n# telnet 0 8080\nTrying 0.0.0.0...\nConnected to 0.\nEscape character is '^]'.\nGET /secret.html HTTP/1.1\nHost: www.csupomona.edu\n\nHTTP/1.1 403 Forbidden\nDate: Sat, 11 Oct 2008 00:03:08 GMT\nServer: Apache/2.2.8 (Unix)\nContent-Length: 213\nContent-Type: text/html; charset=iso-8859-1\n\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>403 Forbidden</title>\n</head><body>\n<h1>Forbidden</h1>\n<p>You don't have permission to access /secret.html\non this server.</p>\n</body></html>\n--------------\n\nWith the following in the access/error log:\n\n127.0.0.1 - - [10/Oct/2008:17:03:08 -0700] \"GET /secret.html HTTP/1.1\" 403\n213 \"-\" \"-\"\n\n[Fri Oct 10 17:03:11 2008] [error] [client 127.0.0.1] Symbolic link not\nallowed or link target not accessible:\n/usr/pkg/share/httpd/htdocs/secret.html\n\n\nHowever, accessing the SSI file did not result in any errors, and returned the contents of the file pointed to by the symbolic link:\n\n------\n# telnet 0 8080\nTrying 0.0.0.0...\nConnected to 0.\nEscape character is '^]'.\nGET /test_ssi.shtml HTTP/1.1\nHost: www.csupomona.edu\n\nHTTP/1.1 200 OK\nDate: Sat, 11 Oct 2008 00:04:12 GMT\nServer: Apache/2.2.8 (Unix)\nAccept-Ranges: bytes\nTransfer-Encoding: chunked\nContent-Type: text/plain\n\nc\nsecret data\n\n------\n\nThere was nothing in the error log, and only the following in the access log:\n\n127.0.0.1 - - [10/Oct/2008:17:04:12 -0700] \"GET /test_ssi.shtml HTTP/1.1\"\n200 13 \"-\" \"-\"\n\n\n\nIdeally, I would expect the server-side include code to follow the same configuration regarding symbolic links as accessing the links directly would.\n\nIs this expected behavior? A bug? A problem with my configuration or misunderstanding on my part?\n\nThanks...", "id": 121433, "time": "2008-10-10T19:28:32Z", "creator": "henson@acm.org", "creation_time": "2008-10-10T19:28:32Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 45959, "attachment_id": null, "is_private": false, "id": 121705, "time": "2008-10-20T14:19:25Z", "creator": "henson@acm.org", "creation_time": "2008-10-20T14:19:25Z", "text": "Any further thoughts on this?\n\nThanks..."}, {"count": 9, "tags": [], "bug_id": 45959, "attachment_id": null, "is_private": false, "id": 122014, "time": "2008-10-29T19:35:52Z", "creator": "henson@acm.org", "creation_time": "2008-10-29T19:35:52Z", "text": "I dug into this some more.\n\nIn the file request.c, the function ap_directory_walk contains the following code:\n\n    /* If we have a file already matches the path of r->filename,\n     * and the vhost's list of directory sections hasn't changed,\n             * we can skip rewalking the directory_walk entries.\n             */\n            if (cache->cached\n                && ((r->finfo.filetype == APR_REG)\n                    || ((r->finfo.filetype == APR_DIR)\n                        && (!r->path_info || !*r->path_info)))\n                && (cache->dir_conf_tested == sec_ent)\n                && (strcmp(entry_dir, cache->cached) == 0)) {\n                /* Well this looks really familiar!  If our end-result (per_dir_result)\n                 * didn't change, we have absolutely nothing to do :)\n                 * Otherwise (as is the case with most\ndir_merged/file_merged requests)\n                 * we must merge our dir_conf_merged onto this new\nr->per_dir_config.\n                 */\n\n\n                if (r->per_dir_config == cache->per_dir_result) {\n                    return OK;\n                }\n\n                if (r->per_dir_config == cache->dir_conf_merged) {\n                    r->per_dir_config = cache->per_dir_result;\n                    return OK;\n                }\n\nWhen the SSI include is processed, either file or virtual, the check in the last if statement shown above is true, and the function immediately returns OK with no further processing.\n\nIf I comment out the section of code that checks for a cached entry, and force it to fully process the request, the attempted inclusion of the symbolic link fails:\n\n[Wed Oct 29 19:30:50 2008] [error] [client 134.71.248.12] Symbolic link not\nallowed or link target not accessible: /export/user/bldewolf/www/secrets3\n[Wed Oct 29 19:30:50 2008] [error] [client 134.71.248.12] unable to include\n\"secrets3\" in parsed file /export/user/bldewolf/www/test3.shtml\n\n\nThere appears to be an invalid assumption in this cache check, clearly behavior is different if the subrequest is fully processed rather than using the cache.\n\nI think this is a security bug, the configured restriction on symbolic link handling is being bypassed by the cache optimization.\n\nPlease let me know what you think of this.\n\n\n\n"}, {"attachment_id": null, "tags": [], "bug_id": 45959, "is_private": false, "count": 10, "id": 122509, "time": "2008-11-14T19:49:33Z", "creator": "henson@acm.org", "creation_time": "2008-11-14T19:49:33Z", "text": "I've done some further testing, and confirmed that this is only a problem if the included symbolic link is in the same directory as the shtml file.\n\nConsider the following file served via apache:\n\n$ ls -l /export/user/henson/www/\n\ntotal 2-rw-------+  1 henson   csupomona      13 Nov 14 19:24 secured.html\n\nFor the sake of discussion, assume this file is readable by the web server, but restricted to require authentication.\n\nNow, another user creates a symbolic link to that file:\n\n$ ls -l /export/user/astudent/www/symlink.html\nlrwxrwxrwx 1 astudent csupomona 36 Nov 14 19:31 /export/user/astudent/www/symlink.html ->/export/user/henson/www/secured.html\n\n\nAttempting to access the symbolic link directly fails, as SymlinkIfOwnerMatch is configured:\n\n$ curl http://stan.unx.csupomona.edu/~astudent/symlink.html\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>403 Forbidden</title>\n</head><body>\n<h1>Forbidden</h1>\n<p>You don't have permission to access /~astudent/symlink.html\non this server.</p>\n</body></html>\n\n\n[Fri Nov 14 19:29:06 2008] [error] [client 134.71.248.140] Symbolic link\nnot allowed or link target not accessible:\n/export/user/astudent/www/symlink.html\n\nNow, the user creates an SSI file:\n\n$ ls -l /export/user/astudent/www/symlink_ssi.html\n\n-rw-r--r--+ 1 astudent csupomona 40 Nov 14 19:27\n/export/user/astudent/www/symlink_ssi.shtml\n\nWhose contents are:\n\n$cat /export/user/astudent/www/symlink_ssi.shtml\n<!--#include virtual=\"/~astudent/symlink.html\" -->\n\nAccessing this file:\n\n$ curl http://stan.unx.csupomona.edu/~astudent/symlink_ssi.shtml\nSecret data.\n\nReturns the restricted data, bypassing the SymlinkIfOwnerMatch configuration directive.\n\nAs I discovered, this appears to be a bug in ap_directory_walk. Let's say we move the SSI file to a subdirectory:\n\n$ ls -l /export/user/astudent/www/subdir/symlink_ssi.shtml\n-rw-r--r--+  1 astudent csupomona      40 Nov 14 19:27\n/export/user/astudent/www/subdir/symlink_ssi.shtml\n\n\nAttempting to request it then fails as expected:\n\n$ curl http://stan.unx.csupomona.edu/~astudent/subdir/symlink_ssi.shtml\n[an error occurred while processing this directive]\n\n[Fri Nov 14 19:37:04 2008] [error] [client 134.71.248.140] Symbolic link\nnot allowed or link target not accessible:\n/export/user/astudent/www/symlink.html\n[Fri Nov 14 19:37:04 2008] [error] [client 134.71.248.140] unable to\ninclude \"/~astudent/symlink.html\" in parsed file\n/export/user/astudent/www/subdir/symlink_ssi.shtml\n\n\nThe exact same include behaves differently depending on whether or not the included file happens to be in the same directory as the SSI.\n\nAgain, this would appear to be a security bug to me. Not a critical one by any means, but still a security bug. I would greatly appreciate some feedback from a developer on this issue."}, {"count": 11, "tags": [], "bug_id": 45959, "attachment_id": null, "id": 122517, "time": "2008-11-15T15:46:23Z", "creator": "nick@webthing.com", "creation_time": "2008-11-15T15:46:23Z", "is_private": false, "text": "This looks like a duplicate of PR#41960, which was fixed in 2.2.9.\nPlease reopen if an upgrade doesn't fix it for you.\n\n*** This bug has been marked as a duplicate of bug 41960 ***"}, {"count": 12, "tags": [], "bug_id": 45959, "is_private": false, "text": "My most recent testing was under 2.2.9:\n\n[Fri Nov 14 19:04:27 2008] [notice] Apache/2.2.9 (Unix) mod_ssl/2.2.9 OpenSSL/0.9.8h configured -- resuming normal op\nerations\n\nI don't think they are related. The other bug was regarding ap_location_walk for subrequests that don't have an associated file. This bug appears to be in ap_directory_walk, and there is a file associated.\n", "id": 122538, "time": "2008-11-16T09:50:43Z", "creator": "henson@acm.org", "creation_time": "2008-11-16T09:50:43Z", "attachment_id": null}, {"attachment_id": 22915, "tags": [], "bug_id": 45959, "is_private": false, "count": 13, "id": 122745, "time": "2008-11-22T14:42:24Z", "creator": "henson@acm.org", "creation_time": "2008-11-22T14:42:24Z", "text": "Created attachment 22915\nPatch to disable ap_directory_walk cache\n\nFor now, I'm running with this patch which disables the caching in ap_directory_walk, and instead logs a notice that the cache would have been used. Seems to be working fine, solves my problem. Not sure what extra inefficiency this is, but I need security first.\n\nPlease let me know when you have time to investigate this problem and find a better resolution."}, {"count": 14, "tags": [], "bug_id": 45959, "attachment_id": null, "id": 123656, "time": "2008-12-30T19:27:04Z", "creator": "nick@webthing.com", "creation_time": "2008-12-30T19:27:04Z", "is_private": false, "text": "OK, I've just had a good hack at this, and I can reproduce the problem.  It seems \"Options\" values are completely ignored in subrequests, so it never tests for symlinks, let alone if owner matches.  That applies both to file and virtual/uri lookups.\n\nPlease bug me if I don't apply your patch or something equivalent within a week.  Thanks for persisting with the report!"}, {"count": 15, "text": "Thanks, I appreciate the acknowledgment that this is a valid bug. All my patch does is disable the caching,  which might not be the best thing to do. I didn't have the time to familiarize myself with the code enough to see if there was a way to cache while still respecting options. If there isn't, then getting rid of the caching might be the only secure approach.", "creator": "henson@acm.org", "is_private": false, "id": 123809, "time": "2009-01-06T14:48:45Z", "bug_id": 45959, "creation_time": "2009-01-06T14:48:45Z", "tags": [], "attachment_id": null}, {"count": 16, "tags": [], "bug_id": 45959, "attachment_id": null, "id": 123810, "time": "2009-01-06T15:22:30Z", "creator": "bobsiegen@googlemail.com", "creation_time": "2009-01-06T15:22:30Z", "is_private": false, "text": "There's a propose for backporting patches which have been applied to trunk some time ago, see r732133"}, {"count": 17, "tags": [], "bug_id": 45959, "attachment_id": null, "id": 123844, "time": "2009-01-07T15:52:49Z", "creator": "henson@acm.org", "creation_time": "2009-01-07T15:52:49Z", "is_private": false, "text": "Based on my inexpert review, the referenced patch does look like it would resolve the problem. I look forward to its inclusion :).\n"}, {"count": 18, "tags": [], "text": "Fix backported in r733754.", "is_private": false, "id": 123958, "creation_time": "2009-01-12T06:50:25Z", "time": "2009-01-12T06:50:25Z", "creator": "nick@webthing.com", "bug_id": 45959, "attachment_id": null}, {"count": 19, "text": "*** Bug 14206 has been marked as a duplicate of this bug. ***", "bug_id": 45959, "is_private": false, "id": 124506, "time": "2009-01-29T15:49:21Z", "creator": "nick@webthing.com", "creation_time": "2009-01-29T15:49:21Z", "tags": [], "attachment_id": null}, {"count": 20, "tags": [], "text": "*** Bug 47039 has been marked as a duplicate of this bug. ***", "is_private": false, "bug_id": 45959, "id": 126285, "time": "2009-04-16T08:06:13Z", "creator": "bobsiegen@googlemail.com", "creation_time": "2009-04-16T08:06:13Z", "attachment_id": null}, {"count": 21, "tags": [], "bug_id": 45959, "is_private": false, "text": "*** Bug 47337 has been marked as a duplicate of this bug. ***", "id": 127864, "time": "2009-06-11T04:42:52Z", "creator": "bobsiegen@googlemail.com", "creation_time": "2009-06-11T04:42:52Z", "attachment_id": null}]