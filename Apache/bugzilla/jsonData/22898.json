[{"count": 0, "tags": [], "creator": "mara@chlup.net", "attachment_id": null, "text": "Hi!\n\nmy conf:\n--------\nAddHandler application/x-httpd-eperl .phtml\nAction application/x-httpd-eperl /cgi-bin/nph-test\n\nmy request:\n-----------\ntelnet myhost 80\nGET /test/t1.phtml HTTP 1.1\nHost: myhost\n\napache send me:\n---------------\nHTTP/1.1 200 OK\nContent-Type: text/plain\n\nHello!\nHTTP/1.1 200 OK\nDate: Tue, 02 Sep 2003 21:27:38 GMT\nServer: Apache/2.0.47 (Debian GNU/Linux) mod_perl/1.99_09 Perl/v5.8.0\nmod_ssl/2.0.47 OpenSSL/0.9.7b\nContent-Length: 0\nConnection: close\nContent-Type: application/x-httpd-php\n\nmy script nph-test:\n-------------------\n#!/usr/bin/perl\nprint \"HTTP/1.1 200 OK\\n\";\nprint \"Content-Type: text/plain\\n\\n\";\nprint \"Hello!\\n\";\n\nwhere is bug?\n-------------\nMy script noprint seccond HTTP header. Why apache generate second header?\n\nBye\nMarek", "id": 43641, "time": "2003-09-02T21:39:06Z", "bug_id": 22898, "creation_time": "2003-09-02T21:39:06Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 22898, "text": "Hmm. e-perl is mod_perl, isn't it? I'd guess, mod_perl doesn't support\nnph-scripts at all, you'd have to use mod_cgi instead.", "id": 43677, "time": "2003-09-03T19:43:40Z", "creator": "nd@perlig.de", "creation_time": "2003-09-03T19:43:40Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 22898, "text": "mod_perl no problem. I tested my example without loading mod_perl module too.\nProblem is mod_cgi and mod_cgid. My example don't use e-perl. ", "id": 43695, "time": "2003-09-04T06:28:19Z", "creator": "mara@chlup.net", "creation_time": "2003-09-04T06:28:19Z", "is_private": false, "attachment_id": null}, {"count": 3, "attachment_id": null, "creator": "sdhill@metasystema.net", "text": "I am getting this problem too, with Meta-HTML. I have not been able to reproduce\nby telnetting to port, b/c the second header seems to be sent after the\nconnection is closed! but all my pages are served with a second header at the\nend. For example, http://www.metasystema.net/welcome.mhtml\n\ntelnet shows the Meta-HTML headers at the beginning where one would expect them:\n\nget /welcome.mhtml\nHTTP/1.0 200 OK\nServer: MHttpd/4.1 (bfox; i686-linux; Meta-HTML/6.11)\nDate: Fri, 31 Oct 2003 23:08:24 GMT\nExpires: Thu, 30 Oct 2003 23:08:24 GMT\nLast-modified: Fri, 31 Oct 2003 23:07:24 GMT\nContent-length: 9585\nMeta-HTML-Engine: MHttpd/4.1 (bfox; i686-linux; Meta-HTML/6.11)\nContent-type: text/html\n\nthen at the end, the page displays the apache2 header (from view source):\n\nHTTP/1.1 200 OK\nDate: Fri, 31 Oct 2003 23:05:58 GMT\nServer: Apache/2.0.48 (Gentoo/Linux)\nContent-Length: 0\nKeep-Alive: timeout=15, max=100\nConnection: Keep-Alive\nContent-Type: metahtml/interpreted\n\nMy conf:\n--------\nAddType         metahtml/interpreted .mhtml\nAction          metahtml/interpreted /cgi-bin/nph-engine\nScriptAlias     /cgi-bin/   /www/metasystema.net/cgi-bin/\n\nI've verified this occurs in 2.0.48 as well as 2.0.47.", "id": 46599, "time": "2003-10-31T23:16:40Z", "bug_id": 22898, "creation_time": "2003-10-31T23:16:40Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "creator": "nd@perlig.de", "attachment_id": null, "text": "sounds really like a nasty bug ;-)", "id": 46606, "time": "2003-11-01T09:44:10Z", "bug_id": 22898, "creation_time": "2003-11-01T09:44:10Z", "is_private": false}, {"count": 5, "attachment_id": null, "creator": "jorton@redhat.com", "text": "*** Bug 26724 has been marked as a duplicate of this bug. ***", "id": 58646, "time": "2004-06-03T16:19:31Z", "bug_id": 22898, "creation_time": "2004-06-03T16:19:31Z", "tags": [], "is_private": false}, {"count": 6, "tags": [], "bug_id": 22898, "attachment_id": null, "id": 85829, "time": "2006-02-15T21:33:04Z", "creator": "sean@conman.org", "creation_time": "2006-02-15T21:33:04Z", "is_private": false, "text": "I have a similar problem, using an \"nph-\" script via mod_cgi, being redirected\nvia mod_rewrite.  If I call the script directly, I do not get the additonal\nheader at the end, but if I go through mod_rewrite, I do.  This is with Apache\n2.0.54 and 2.0.55.\n"}, {"attachment_id": null, "tags": [], "bug_id": 22898, "text": "This bug persists on Apache 2.2.It is caused in generators/mod_cgi.c, line 760 \nnph = !(strncmp(argv0, \"nph-\", 4));\n    \nAdd the following just before it (recompile, start with debug logging on):\nap_log_rerror(APLOG_MARK, APLOG_DEBUG, 0, r, \"Identifying cgi script:%s\",\nr->filename);\n\nWe can see that the strncmp will fail, because the cgi script will include a\nfull path: e.g.\n \"Identifying cgi script:/home/www/site/test/bin/nph-foobar.cgi\"\n\nThe conf lines for this are as follows:\n ScriptAlias  /x/         /home/www/site/test/bin\n Action       foo-file    /x/nph-foobar.cgi\n AddHandler   foo-file    .foo\n\nSo - changing line 760 to:\nnph = ( strstr(argv0,\"nph-\") != NULL );\n(which of course means that any \"nph-\" will return positive...)\nnow identifies nph scripts as such. However.. the additional headers STILL\nappear... at which point.. I am stumped. ", "count": 7, "id": 86206, "time": "2006-02-24T20:26:47Z", "creator": "ben@redsnapper.net", "creation_time": "2006-02-24T20:26:47Z", "is_private": false}, {"count": 8, "attachment_id": null, "creator": "ben@redsnapper.net", "text": "There is a work-around, which is to change the return line of any cgi script\nfrom being e.g.\nHTTP/1.1 200 OK\nto\nStatus 200 OK\n- and dropping nph- status. \n\nOf course this does NOT fix the legacy issue, and probably remains a typical\nreason why so many people carry on using 1.3.x (slaps wrist).\n\nI've done some more RA on this.\nThe dupe header always shows Content-Length: 0\nIt looks like a default / stub header is being pushed out.\n\nInterestingly - this bug ONLY appears to occur when using the Action directive,\n(It makes no difference if one uses AddType or AddHandler or SetHandler ) ..\nguess where I will look next...\n\nOutput filters are being correctly stripped by mod-cgi - though it seems like it\nwould be easier just to do something like \nrv = ap_pass_brigade(r->output_filters, bb);\n.. but hey, what do I know?\n\n\n", "id": 86218, "time": "2006-02-24T23:37:55Z", "bug_id": 22898, "creation_time": "2006-02-24T23:37:55Z", "tags": [], "is_private": false}, {"count": 9, "tags": [], "creator": "ben@redsnapper.net", "attachment_id": 17796, "text": "Created attachment 17796\nThis is a drop in replacement that fixes bug 22898\n\nThis adds some APLOG_DEBUG messages, which are useful for nph- bug issues.\nThere are 2 major bugs that are now 'fixed' here. Of course, the fixes are\nkludges, but then I'm not a core Apache programmer. Note that identification of\nnph- now uses strstr, rather than strncmp! Also note that the nph- code part\nstrips out output_filters from it's immediate caller!", "id": 86221, "time": "2006-02-25T00:35:53Z", "bug_id": 22898, "creation_time": "2006-02-25T00:35:53Z", "is_private": false}, {"count": 10, "attachment_id": null, "creator": "ben@redsnapper.net", "text": "This bug is essentially fixed - though it needs to be folded into the main cvs.\nThere were two basic bugs here - one was the faulty (ie not working)\nidentification of nph- cgi scripts. The other was the misconception that an\nnph-cgi request will be the initial request; something patently not true when\nbeing called via Action.\n\nThe fix that I have done is lame. It only deals with one previous process;\nhowever, this seems to be the primary problem, so it works. Basically, we now\ncall ap_is_initial_req(r) and if it is !=1, then we also strip the\noutput_filters of the previous/container request.\n\nI have posted the entire amended file. sorry. I don't understand the patch system..\n\n", "id": 86222, "time": "2006-02-25T00:38:18Z", "bug_id": 22898, "creation_time": "2006-02-25T00:38:18Z", "tags": [], "is_private": false}, {"count": 11, "tags": [], "creator": "ben@redsnapper.net", "attachment_id": 17891, "text": "Created attachment 17891\nmod_cgi diff file that fixes 22898 and related bugs\n\nThe Apache2.x fails to behave properly when nph- are used in Actions.\nThis patch includes some debugging messages, and fixes two related severe bugs\nwhich cause nph- cgi scripts to fail when cgi,_handler is called via an Action\ndirective. The bugs are (1) apr_filepath_name_get(r->filename) returns a full\npath when cgi_handler is accessed via Action, which means that the strncmp test\nfails to identify the nph- prefix. (2) The clear up of the bucket brigade fails\nunless the request is the ap_is_initial_req. The fix in the patch for (1) is to\nuse strstr instead of strncmp - though there may be a better fix for that.  The\nfix in the patch for (2) is on false for ap_is_initial_req to clear the bucket\nbrigade at r->prev.", "id": 86796, "time": "2006-03-14T12:40:19Z", "bug_id": 22898, "creation_time": "2006-03-14T12:40:19Z", "is_private": false}, {"count": 12, "tags": [], "creator": "ben@redsnapper.net", "attachment_id": null, "text": "After a year, the patch below has still not been folded into the 2.2 trunk.\n\nUntil it is,  nph- scripts addressed via AddHandler or Action fail on Apache 2.x!\n\nI am aware that nph- is considered a dead area - but it's necessary for legacy\ncode and regardless, Apache 2.x claims support for it (and indeed does support\nit when it is not referred to via Action or AddHandler)", "id": 104287, "time": "2007-06-11T02:30:44Z", "bug_id": 22898, "creation_time": "2007-06-11T02:30:44Z", "is_private": false}]