[{"count": 0, "tags": [], "text": "On TIKA-2147 and TIKA-2149, Seva Alekseyev and Sharath Kumar shared two documents that throw:\n\njava.lang.ClassCastException: org.apache.poi.POIXMLDocumentPart cannot be cast to org.apache.poi.xwpf.usermodel.XWPFDocument\nat org.apache.poi.xwpf.usermodel.XWPFFootnotes.getXWPFDocument(XWPFFootnotes.java:162)\nat org.apache.poi.xwpf.usermodel.XWPFFootnote.<init>(XWPFFootnote.java:47)\nat org.apache.poi.xwpf.usermodel.XWPFFootnotes.onDocumentRead(XWPFFootnotes.java:95)\nat org.apache.poi.POIXMLDocumentPart._invokeOnDocumentRead(POIXMLDocumentPart.java:658)\nat org.apache.poi.xwpf.usermodel.XWPFDocument.onDocumentRead(XWPFDocument.java:235)\nat org.apache.poi.POIXMLDocument.load(POIXMLDocument.java:160)\nat org.apache.poi.xwpf.usermodel.XWPFDocument.<init>(XWPFDocument.java:124)\nat org.apache.poi.xwpf.extractor.XWPFWordExtractor.<init>(XWPFWordExtractor.java:58)\nat org.apache.poi.extractor.ExtractorFactory.createExtractor(ExtractorFactory.java:237)\nat org.apache.tika.parser.microsoft.ooxml.OOXMLExtractorFactory.parse(OOXMLExtractorFactory.java:86)\n\nI think the issue is that the because the footnotes are within a glossary, when we call getXWPFDocument(), we're invoking .getParent() which gets the POIXMLDocumentPart.  If we get the grandparent in this case, we actually get the XWPFDocument.\n\nI propose something along these lines:\n\n    public XWPFDocument getXWPFDocument() {\n        if (document != null) {\n            return document;\n        } else {\n            Object parent = getParent();\n            if (parent != null) {\n                if (parent instanceof XWPFDocument) {\n                    return (XWPFDocument)parent;\n                } else if (parent instanceof POIXMLDocumentPart) {\n                    Object grandParent = ((POIXMLDocumentPart) parent).getParent();\n                    if (grandParent instanceof XWPFDocument) {\n                        return (XWPFDocument) grandParent;\n                    }\n                }\n            }\n            throw new IllegalStateException(\"couldn't find the parent\");\n        }\n    }", "attachment_id": null, "id": 194703, "creator": "tallison@mitre.org", "time": "2016-10-28T16:24:19Z", "bug_id": 60316, "creation_time": "2016-10-28T16:24:19Z", "is_private": false}, {"count": 1, "tags": [], "creator": "tallison@mitre.org", "attachment_id": null, "text": "On further review, and given TIKA-2163, it looks like this is a whole new kettle of worms.  The proposed fix is incorrect duct tape over a far larger issue.\n\nWe aren't currently handling the glossaryDocument as a special relationship type.  Anyone have experience with glossaryDocument?  Looks like an entire other document stored within the document...", "id": 194822, "time": "2016-11-04T16:56:18Z", "bug_id": 60316, "creation_time": "2016-11-04T16:56:18Z", "is_private": false}]