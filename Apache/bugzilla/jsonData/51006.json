[{"count": 0, "tags": [], "bug_id": 51006, "attachment_id": null, "is_private": false, "id": 145465, "time": "2011-04-01T09:31:14Z", "creator": "martin.cmelik@gmail.com", "creation_time": "2011-04-01T09:31:14Z", "text": "Hi,\n\nfor a long time/days I have try to upgrade our current reverse proxies farm from version 2.0.61 to 2.2.17.\n\nWith default config it start without problem, but when I include our config of reverse proxies it consume all memory (3GB) and after that whole swap (2GB) on machine where same config works well on 2.0.61\n\nIn our config is 14k virtual hosts as ProxyPass configured in this way:\n\n<VirtualHost *>\nServerName test.example.com\nServerAdmin postmaster@example.com\nProxyPass / http://1.1.1.1:1234/\nProxyPassReverse / http://1.1.1.1:1234/\nProxyPreserveHost On\n</VirtualHost>\n...\n\nI have take config.nice from old one and compile 2.2.17 in same way:\n\n[root@redhat-testing opt]# cat /usr/src/httpd-2.2.17/config.nice\n#! /bin/sh\n#\n# Created by configure\n\n\"./configure\" \\\n\"--prefix=/opt/apache\" \\\n\"--exec-prefix=/opt/apache\" \\\n\"--enable-cache\" \\\n\"--enable-disk-cache\" \\\n\"--enable-mem-cache\" \\\n\"--enable-logio\" \\\n\"--enable-headers\" \\\n\"--enable-usertrack\" \\\n\"--enable-version\" \\\n\"--enable-proxy\" \\\n\"--enable-proxy-connect\" \\\n\"--enable-proxy-ftp\" \\\n\"--enable-proxy-http\" \\\n\"--enable-static-support\" \\\n\"--enable-static-htpasswd\" \\\n\"--enable-static-htdigest\" \\\n\"--enable-static-rotatelogs\" \\\n\"--enable-static-logresolve\" \\\n\"--enable-static-htdbm\" \\\n\"--enable-static-ab\" \\\n\"--enable-static-checkgid\" \\\n\"--enable-http\" \\\n\"--enable-info\" \\\n\"--enable-cgi\" \\\n\"--enable-vhost-alias\" \\\n\"--disable-userdir\" \\\n\"--enable-rewrite\" \\\n\"--enable-so\" \\\n\"--with-mpm=prefork\" \\\n\"$@\"\n\n#./config.nice\n#make\n#make install\n\n[root@redhat-testing opt]# /opt/apache/bin/apachectl -V\nServer version: Apache/2.2.17 (Unix)\nServer built:   Apr  1 2011 08:41:55\nServer's Module Magic Number: 20051115:25\nServer loaded:  APR 1.4.2, APR-Util 1.3.10\nCompiled using: APR 1.4.2, APR-Util 1.3.10\nArchitecture:   32-bit\nServer MPM:     Prefork\n  threaded:     no\n    forked:     yes (variable process count)\nServer compiled with....\n -D APACHE_MPM_DIR=\"server/mpm/prefork\"\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_SYSVSEM_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=128\n -D HTTPD_ROOT=\"/opt/apache\"\n -D SUEXEC_BIN=\"/opt/apache/bin/suexec\"\n -D DEFAULT_PIDLOG=\"logs/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_LOCKFILE=\"logs/accept.lock\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"conf/mime.types\"\n -D SERVER_CONFIG_FILE=\"conf/httpd.conf\"\n\n[root@redhat-testing opt]# /opt/apache/bin/apachectl -l\nCompiled in modules:\n  core.c\n  mod_authn_file.c\n  mod_authn_default.c\n  mod_authz_host.c\n  mod_authz_groupfile.c\n  mod_authz_user.c\n  mod_authz_default.c\n  mod_auth_basic.c\n  mod_cache.c\n  mod_disk_cache.c\n  mod_mem_cache.c\n  mod_include.c\n  mod_filter.c\n  mod_log_config.c\n  mod_logio.c\n  mod_env.c\n  mod_headers.c\n  mod_usertrack.c\n  mod_setenvif.c\n  mod_version.c\n  mod_proxy.c\n  mod_proxy_connect.c\n  mod_proxy_ftp.c\n  mod_proxy_http.c\n  mod_proxy_scgi.c\n  mod_proxy_ajp.c\n  mod_proxy_balancer.c\n  prefork.c\n  http_core.c\n  mod_mime.c\n  mod_status.c\n  mod_autoindex.c\n  mod_asis.c\n  mod_info.c\n  mod_cgi.c\n  mod_vhost_alias.c\n  mod_negotiation.c\n  mod_dir.c\n  mod_actions.c\n  mod_alias.c\n  mod_rewrite.c\n  mod_so.c\n\nPrefork configuration:\n\n<IfModule prefork.c>\nStartServers         100\nMinSpareServers      50\nMaxSpareServers     100\nServerLimit        1600\nMaxClients         1600\nMaxRequestsPerChild  25000\n</IfModule>\n\n\nIn normal state (2.0.61) when you start apache it will create one root server process and waiting for connection (then create childs).\nBut on 2.2.17 it will start up all StartServers and Childs as well and in next 15 seconds start swaping until consume all of available space.\n\nWhen I setup debug log level I see only thousands of errors like:\n\n[Fri Apr 01 11:32:27 2011] [debug] proxy_util.c(1837): proxy: worker http://1.2.3.4:10080/ already initialized\n[Fri Apr 01 11:32:27 2011] [debug] proxy_util.c(1934): proxy: initialized single connection worker 12779 in child 2508 for (1.2.3.4)\n[Fri Apr 01 11:32:27 2011] [debug] proxy_util.c(1818): proxy: grabbed scoreboard slot 12778 in child 2508 for worker http://1.2.3.4:10080/\n[Fri Apr 01 11:32:27 2011] [debug] proxy_util.c(1837): proxy: worker http://1.2.3.4:10080/ already initialized\n[Fri Apr 01 11:32:27 2011] [debug] proxy_util.c(1934): proxy: initialized single connection worker 12778 in child 2508 for (1.2.3.4)\n[Fri Apr 01 11:32:27 2011] [debug] proxy_util.c(1818): proxy: grabbed scoreboard slot 12777 in child 2508 for worker http://1.2.3.4:10080/\n[Fri Apr 01 11:32:27 2011] [debug] proxy_util.c(1837): proxy: worker http://1.2.3.4:10080/ already initialized\n[Fri Apr 01 11:32:27 2011] [debug] proxy_util.c(1934): proxy: initialized single connection worker 12777 in child 2508 for (1.2.3.4)\n[Fri Apr 01 11:32:27 2011] [debug] proxy_util.c(1818): proxy: grabbed scoreboard slot 12776 in child 2508 for worker http://1.2.3.4:10080/\n[Fri Apr 01 11:32:27 2011] [debug] proxy_util.c(1837): proxy: worker http://1.2.3.4:10080/ already initialized\n[Fri Apr 01 11:32:27 2011] [debug] proxy_util.c(1934): proxy: initialized single connection worker 12776 in child 2508 for (1.2.3.4)\n\n\nWhen I make same steps with latest 2.0.64 it seems that it works fine (only seems because I don't forward traffic to this box).\n\nPlease let me know what all informatin should be provided.\n\nOS is latest RedHat 5.6"}, {"count": 1, "tags": [], "text": "We having similar memory issues at around 4k virtual hosts, on 2.2.26. Each child process consumes 3GB of memory, so on our idle server there is 9GB dedicated to Apache. Do we need to downgrade to circumvent this issue?", "is_private": false, "id": 174368, "creator": "jacob@eatstreet.com", "time": "2014-04-08T13:38:13Z", "bug_id": 51006, "creation_time": "2014-04-08T13:38:13Z", "attachment_id": null}]