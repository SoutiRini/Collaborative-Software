[{"count": 0, "tags": [], "text": "When using a ByteArrayOutputStream in order to get an byte array of bzip2 compressed data, only the first byte is in the resulting array.\nThe same file with the same code with a FileOutputStream however works fine.\n\nYou can use this code to reproduce the error (hope it compiles):\n\nBufferedInputStream in = new BufferedInputStream(new FileInputStream(file));\nByteArrayOutputStream byteOut = new ByteArrayOutputStream();\nCBZip2OutputStream outFail = new CBZip2OutputStream(byteOut);\nFileOutputStream fos = new FileOutputStream(\"C:\\\\test.bz2\");\nCBZip2OutputStream outOk = new CBZip2OutputStream(fos);\nbyte[] bs = new byte[1024];\nint l = in.read(bs);\nwhile (l == 1024)\n{\n  outFail.write(bs);\n  outOk.write(bs);\n  l = in.read(bs);\n}\nif (l > 0)\n{\n  outFail.write(bs, 0, l);\n  outOk.write(bs, 0, l);\n}\noutFail.flush();\noutOk.flush();\nin.close();\n\n// FAIL\n// at this point, byteOut.toByteArray() has always length 1\n\noutFail.close();\noutOk.close();", "attachment_id": null, "bug_id": 45044, "id": 116839, "time": "2008-05-20T05:59:14Z", "creator": "deppdepp@gmx.net", "creation_time": "2008-05-20T05:59:14Z", "is_private": false}, {"count": 1, "tags": [], "creator": "peterreilly@apache.org", "attachment_id": null, "is_private": false, "id": 116845, "time": "2008-05-20T07:58:47Z", "bug_id": 45044, "creation_time": "2008-05-20T07:58:47Z", "text": "I am not too sure that the ant project is meant to\nbe used as a general purpose java api.\n\nIn any case, the bzip output code has changed between\nant 1.7.0 and ant 1.7.1 (as the 1.7.0 code can\ncorrupt bzip), can you test with the 1.7.1 code."}, {"count": 2, "tags": [], "creator": "deppdepp@gmx.net", "attachment_id": null, "is_private": false, "id": 116868, "time": "2008-05-20T23:35:01Z", "bug_id": 45044, "creation_time": "2008-05-20T23:35:01Z", "text": "I'm sorry but I'm not able to find 1.7.1.\nI have to do a checkout from svn, right? Or is there a more convenient way to get it?\n"}, {"count": 3, "attachment_id": null, "creator": "peterreilly@apache.org", "is_private": false, "id": 116873, "time": "2008-05-21T01:11:17Z", "bug_id": 45044, "creation_time": "2008-05-21T01:11:17Z", "tags": [], "text": "There is a bata at\nhttp://people.apache.org/dist/ant/v1.7.1beta2/"}, {"count": 4, "tags": [], "creator": "deppdepp@gmx.net", "attachment_id": null, "is_private": false, "id": 116920, "time": "2008-05-23T00:51:05Z", "bug_id": 45044, "creation_time": "2008-05-23T00:51:05Z", "text": "Same error with the beta version."}, {"count": 5, "tags": [], "text": "<project>\n  <echo file=\"TestBZip.java\"><![CDATA[\nimport org.apache.tools.bzip2.*;\nimport java.io.*;\npublic class TestBZip {\n    public static void main(String[] args) throws Throwable {\n        BufferedInputStream in = new BufferedInputStream(new FileInputStream(\"bzip.xml\"));\n        ByteArrayOutputStream byteOut = new ByteArrayOutputStream();\n        CBZip2OutputStream outFail = new CBZip2OutputStream(byteOut);\n        FileOutputStream fos = new FileOutputStream(\"bzip.xml.bz2\");\n        CBZip2OutputStream outOk = new CBZip2OutputStream(fos);\n        byte[] bs = new byte[1024];\n        int l = in.read(bs);\n        while (l == 1024)\n        {\n          outFail.write(bs);\n          outOk.write(bs);\n          l = in.read(bs);\n        }\n        if (l > 0)\n        {\n          outFail.write(bs, 0, l);\n          outOk.write(bs, 0, l);\n        }\n        outFail.flush();\n        outOk.flush();\n        in.close();\n        \n        // FAIL\n        // at this point, byteOut.toByteArray() has always length 1\n        \n        outFail.close();\n        outOk.close();\n        int len = byteOut.toByteArray().length;\n        System.out.println(\"length: \" + len);\n        if (len > 1) {\n            System.exit(0);\n        } else {\n            System.exit(1);\n        }        \n    }\n}\n]]></echo>\n  <javac srcdir=\".\" destdir=\".\" includes=\"TestBZip.java\"/>\n  <java classname=\"TestBZip\" classpath=\".;${java.class.path}\" fork=\"true\"/>\n</project>\n\nwith Ant 1.7.1 leads to\n\n$ ant -f ../../Temp/bzip.xml\nBuildfile: ..\\..\\Temp\\bzip.xml\n    [javac] Compiling 1 source file to c:\\Temp\n     [java] length: 650\n\nBUILD SUCCESSFUL\nTotal time: 0 seconds\n\nwhich looks OK since the file is 650 bytes as well.\n\nSeems to have been fixed for 1.7.1.\n", "attachment_id": null, "bug_id": 45044, "id": 120990, "time": "2008-09-25T07:39:58Z", "creator": "bodewig@apache.org", "creation_time": "2008-09-25T07:39:58Z", "is_private": false}]