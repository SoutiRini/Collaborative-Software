[{"count": 0, "tags": [], "bug_id": 53952, "attachment_id": 29433, "text": "Created attachment 29433\npatch for tomcat trunk that adds support for newer TLS versions\n\nIt would be nice to have support for newer versions of TLS protocol. Due to BEAST attack, the only usable ciphersuites supported by TLS version 1.0 are those based on RC4.\n\nI'll attach compile-tested patches for both tcnative and tomcat.", "id": 162503, "time": "2012-10-02T13:56:30Z", "creator": "sebek64@post.cz", "creation_time": "2012-10-02T13:56:30Z", "is_private": false}, {"count": 1, "tags": [], "creator": "sebek64@post.cz", "text": "Created attachment 29434\npatch for tcnative trunk that adds support for newer TLS versions", "id": 162504, "attachment_id": 29434, "bug_id": 53952, "creation_time": "2012-10-02T13:57:25Z", "time": "2012-10-02T13:57:25Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 53952, "attachment_id": 29435, "text": "Created attachment 29435\npatch for tcnative 1.1 branch", "id": 162505, "time": "2012-10-02T13:57:51Z", "creator": "sebek64@post.cz", "creation_time": "2012-10-02T13:57:51Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 53952, "attachment_id": null, "id": 162519, "time": "2012-10-02T20:21:04Z", "creator": "chris@christopherschultz.net", "creation_time": "2012-10-02T20:21:04Z", "is_private": false, "text": "This introduces a compile-time dependency on OpenSSL 1.0.1+."}, {"count": 4, "tags": [], "bug_id": 53952, "attachment_id": null, "id": 162525, "time": "2012-10-02T20:50:35Z", "creator": "sebek64@post.cz", "creation_time": "2012-10-02T20:50:35Z", "is_private": false, "text": "This is not the case, because the parts of code which depend on the newer library version are #ifdef'ed. Actually, the patches improve compatibility with newer openssl versions, as the library may be compiled without SSL2 support (for example, current Debian testing contains such a version)."}, {"count": 5, "text": "(In reply to comment #3)\n> This introduces a compile-time dependency on OpenSSL 1.0.1+.\n\nRetracted: I have successfully built (but not tested) this patch against tcnative 1.1.x with both OpenSSL 0.9.8o and OpenSSL 1.0.0j.", "bug_id": 53952, "attachment_id": null, "id": 162572, "time": "2012-10-04T17:44:39Z", "creator": "chris@christopherschultz.net", "creation_time": "2012-10-04T17:44:39Z", "tags": [], "is_private": false}, {"count": 6, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "is_private": false, "id": 162575, "time": "2012-10-04T18:13:34Z", "bug_id": 53952, "creation_time": "2012-10-04T18:13:34Z", "text": "I like this patch, but since security is involved, I think I'd like to see a check in the Java code against the (likely) tcnative version that can support TLSv1.1 and TLSv1.2. We don't want people using \"TLSv1+TLSv1.1+TLSv1.2\" as their protocol string and thinking that they can get access to TLSv1.2 if tcnative isn't up to the task.\n\nSimilarly, there should probably be a check at the JNI level to check to see that the underlying OpenSSL supports TLSv1.1 or TLSv1.2 when attempting to use them. The existing patch will allow a user to request \"TLSv1+TLSv1.1+TLSv1.2\" and silently implement only TLSv1.\n\nJava code can check org.apache.tomcat.jni.Library.TCN_MAJOR_VERSION, etc. and the C code can use #ifdef checks."}, {"count": 7, "tags": [], "creator": "sebek64@post.cz", "attachment_id": 29457, "id": 162609, "time": "2012-10-07T12:19:27Z", "bug_id": 53952, "creation_time": "2012-10-07T12:19:27Z", "is_private": false, "text": "Created attachment 29457\npatch for tcnative trunk that adds support for newer TLS versions"}, {"count": 8, "text": "Created attachment 29458\npatch for tcnative 1.1 branch", "bug_id": 53952, "attachment_id": 29458, "id": 162610, "time": "2012-10-07T12:20:30Z", "creator": "sebek64@post.cz", "creation_time": "2012-10-07T12:20:30Z", "tags": [], "is_private": false}, {"count": 9, "tags": [], "bug_id": 53952, "text": "Created attachment 29459\npatch for tomcat trunk that adds support for newer TLS versions\n\nOk, I agree with your comments, and I've reworked the patches.\n\nIn the tcnative part, it should be sufficient to move ifdefs inside the if blocks. When newer TLS versions are not available, the variable ctx remains null, and an error is emitted.\n\nIn the tomcat part, I rely on the SSL.hasOp functionality to check whether the tcnative library supports newer protocols. I needed to change both AprEndpoint and AprSocketContext, which resulted in some code duplication. I think the ssl protocol parsing should be implemented in one place only. Now AprSocketContext doesn't support more protocols (via +), and it produces no error when the string is invalid.", "id": 162611, "time": "2012-10-07T12:44:03Z", "creator": "sebek64@post.cz", "creation_time": "2012-10-07T12:44:03Z", "is_private": false, "attachment_id": 29459}, {"count": 10, "tags": [], "creator": "sebek64@post.cz", "text": "I've forgot to mention that the patches are compile-tested only.", "id": 162613, "attachment_id": null, "bug_id": 53952, "creation_time": "2012-10-07T17:34:14Z", "time": "2012-10-07T17:34:14Z", "is_private": false}, {"count": 11, "tags": [], "text": "(In reply to comment #9)\n> In the tomcat part, I rely on the SSL.hasOp functionality to check whether\n> the tcnative library supports newer protocols.\n\nGood thing someone fixed that recently ;)", "attachment_id": null, "id": 162614, "creator": "chris@christopherschultz.net", "time": "2012-10-07T20:47:53Z", "bug_id": 53952, "creation_time": "2012-10-07T20:47:53Z", "is_private": false}, {"count": 12, "tags": [], "bug_id": 53952, "attachment_id": null, "text": "Now when there is a known practical attack against RC4 in SSL, we have no secure ciphersuite in TLS 1.0, and this issue has probably higher priority than before. What is the reason for not applying this patch for half a year? Is there anything I can do to have this patch merged?", "id": 166095, "time": "2013-03-22T14:07:41Z", "creator": "sebek64@post.cz", "creation_time": "2013-03-22T14:07:41Z", "is_private": false}, {"count": 13, "tags": [], "creator": "chris@christopherschultz.net", "text": "Have you been testing your patch? Last I heard, you had only compile-tested it...\n\nIf you have some additional evidence that it's working in a test rig, I'm happy to give it a shot.", "id": 166185, "attachment_id": null, "bug_id": 53952, "creation_time": "2013-03-27T20:02:22Z", "time": "2013-03-27T20:02:22Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 53952, "text": "Created attachment 30111\nPatch for tomcat native adding support for newer TLS versions\n\nOk, I've tested the patches and found an error in tcnative part. Here is a fixed patch. The problem was that OpenSSL API is quite counter-intuitive. If one wants more than one protocol to be supported, SSLv23_server_method() should be called and unwanted protocols should then be disabled by SSL_OP_NO_*. Other *_server_methods() always make available just one specific version of SSL/TLS.\n\nTo be precise, I've tested tcnative not with Tomcat, but with JBoss and analogical patch for jboss-web. The reason is that I'm primarily interested in JBoss and I don't know how to configure Tomcat.", "id": 166203, "time": "2013-03-28T14:26:26Z", "creator": "sebek64@post.cz", "creation_time": "2013-03-28T14:26:26Z", "is_private": false, "attachment_id": 30111}, {"count": 15, "tags": [], "creator": "sebek64@post.cz", "attachment_id": 30112, "id": 166204, "time": "2013-03-28T14:31:28Z", "bug_id": 53952, "creation_time": "2013-03-28T14:31:28Z", "is_private": false, "text": "Created attachment 30112\nPatch for jboss-web\n\nJust for the reference, here is the patch for jboss-web that I've tested."}, {"count": 16, "tags": [], "bug_id": 53952, "attachment_id": null, "is_private": false, "id": 166205, "time": "2013-03-28T15:08:55Z", "creator": "sebek64@post.cz", "creation_time": "2013-03-28T15:08:55Z", "text": "Oops, there seems to be a problem with OpenSSL 0.9.8. Previously, I've tested 1.0.1e and that worked, but the older version seems to have problems with default protocol set. I currently have no time to find the precise culprit, so in a week or so, I will attach fixed patches that works with all OpenSSL versions."}, {"count": 17, "tags": [], "text": "The problem is following. OpenSSL 0.9.8y defines SSL_OP_PKCS1_CHECK_{1,2} as 0x08000000L and 0x10000000L while OpenSSL 1.0.1e uses the same values for SSL_OP_NO_TLSv1_{1,2}, and defines SSL_OP_PKCS1_CHECK_{1,2} as zero. Therefore, java code calling hasOp with SSL_OP_NO_TLSv1_{1,2} succeeds against both 0.9.8 and 1.0.1. I see no perfect solution, but quite a good way to overcome this issue is to drop SSL_OP_PKCS1_CHECK_* from supported_ssl_opts. Then, these OP's cannot be tested via hasOp, but the flags seem to be unused anyway, according to the comment in 1.0.1e:\n\n/* These next two were never actually used for anything since SSLeay\n * zap so we have some more flags.\n */\n\nI'll send fixed patches in a moment. They have been tested (with JBoss, as before) against both 0.9.8y and 1.0.1e. I've also tested newer java against old tcnative, and it works correctly (enabling one of the newer protocols causes a failure).", "attachment_id": null, "bug_id": 53952, "id": 166389, "time": "2013-04-04T21:02:26Z", "creator": "sebek64@post.cz", "creation_time": "2013-04-04T21:02:26Z", "is_private": false}, {"count": 18, "tags": [], "bug_id": 53952, "is_private": false, "id": 166391, "attachment_id": 30149, "creator": "sebek64@post.cz", "creation_time": "2013-04-04T21:04:50Z", "time": "2013-04-04T21:04:50Z", "text": "Created attachment 30149\npatch dropping SSL_OP_PKCS* from supported_ssl_opts"}, {"count": 19, "text": "Created attachment 30150\nPatch for tomcat native adding support for newer TLS versions", "creator": "sebek64@post.cz", "attachment_id": 30150, "id": 166392, "time": "2013-04-04T21:05:19Z", "bug_id": 53952, "creation_time": "2013-04-04T21:05:19Z", "tags": [], "is_private": false}, {"count": 20, "tags": [], "bug_id": 53952, "attachment_id": null, "is_private": false, "id": 166413, "time": "2013-04-05T14:27:13Z", "creator": "chris@christopherschultz.net", "creation_time": "2013-04-05T14:27:13Z", "text": "Given the comment in OpenSSL that SSL_OP_PKCS1_CHECK_{1,2} were never used, I think it's reasonable to use the new symbolic names and remove the old ones. Note that it will also require a patch to Tomcat trunk as well.\n\nInterestingly, there is this comment in o.a.t.jni.SSL:\n\n    /* The next flag deliberately changes the ciphertest, this is a check\n     * for the PKCS#1 attack */\n    public static final int SSL_OP_PKCS1_CHECK_1                    = 0x08000000;\n    public static final int SSL_OP_PKCS1_CHECK_2                    = 0x10000000;\n\nNeither of these constants are used anywhere in Tomcat trunk, so I'm not sure a) what that comment means and b) whether there is anything to be concerned about.\n\nThat comment is attributed to mturk, but so is nearly the entire file, so I suspect that his commit r423920 just ended up touching every line in the file or something.\n\ntcnative's code has the same comment in the same place (SSL.java) attributed to mturk in r300716, where it seems those constants were actually added. That was way back in 2005. I wonder if Mladen remembers whether that comment is relevant anymore."}, {"count": 21, "text": "Actually, the comment came from OpenSSL. Here is part of 1.0.1e ssl.h:\n\n/* These next two were never actually used for anything since SSLeay\n * zap so we have some more flags.\n */\n/* The next flag deliberately changes the ciphertest, this is a check\n * for the PKCS#1 attack */\n#define SSL_OP_PKCS1_CHECK_1                            0x0\n#define SSL_OP_PKCS1_CHECK_2                            0x0\n\nOpenSSL 0.9.8y contains the same comment, but different values.", "bug_id": 53952, "attachment_id": null, "id": 166414, "time": "2013-04-05T14:41:06Z", "creator": "sebek64@post.cz", "creation_time": "2013-04-05T14:41:06Z", "tags": [], "is_private": false}, {"count": 22, "tags": [], "creator": "sebek64@post.cz", "attachment_id": 30166, "text": "Created attachment 30166\npatch for tomcat trunk that adds support for newer TLS versions\n\nI've updated the patch for tomcat that can be applied to current trunk. It also drops PKCS* constants from SSL.java.", "id": 166488, "time": "2013-04-09T13:09:49Z", "bug_id": 53952, "creation_time": "2013-04-09T13:09:49Z", "is_private": false}, {"count": 23, "tags": [], "bug_id": 53952, "is_private": false, "id": 168794, "attachment_id": null, "creator": "chris@christopherschultz.net", "creation_time": "2013-07-25T21:27:10Z", "time": "2013-07-25T21:27:10Z", "text": "I've taken another look at the (updated) patches. I'm confused by the changes to sslcontext.c. It looks like there is no provision for combinations of SSL/TLS protocols.\n\nFor instance, if I request (TLSv1_1 | TLSv1_2) then I don't get a configured SSL engine because of this:\n\n+#ifndef SSL_OP_NO_TLSv1_2\n+    } else if (protocol & SSL_PROTOCOL_TLSV1_2) {\n+        /* requested but not supported */\n+#endif\n\nOr is this because (TLSv1_1 | TLSv1_2) is not a supported protocol definition? I could only find these TLS-related server-method functions in the OpenSSL API:\n\nconst SSL_METHOD *TLSv1_server_method(void);    /* TLSv1.0 */\nconst SSL_METHOD *TLSv1_1_server_method(void);  /* TLSv1.1 */\nconst SSL_METHOD *TLSv1_2_server_method(void);  /* TLSv1.2 */"}, {"count": 24, "tags": [], "text": "I suggest we try to stay compatible with the httpd notations:\n\nhttp://httpd.apache.org/docs/2.4/en/mod/mod_ssl.html#sslprotocol\n\nThe code in tcnative that handles the protocol settings was largely borrowed from mod_ssl, so we can again look there how TLSV1_1 and 1_2 are handled:\n\nhttp://svn.apache.org/viewvc/httpd/httpd/branches/2.4.x/modules/ssl/\n\nEspecially interesting are ssl_engine_config.c and ssl_engine_init.c.", "attachment_id": null, "id": 168795, "creator": "rainer.jung@kippdata.de", "time": "2013-07-25T23:44:55Z", "bug_id": 53952, "creation_time": "2013-07-25T23:44:55Z", "is_private": false}, {"count": 25, "tags": [], "text": "(In reply to Christopher Schultz from comment #23)\n> I've taken another look at the (updated) patches. I'm confused by the\n> changes to sslcontext.c. It looks like there is no provision for\n> combinations of SSL/TLS protocols.\n> \n> For instance, if I request (TLSv1_1 | TLSv1_2) then I don't get a configured\n> SSL engine because of this:\n> \n> +#ifndef SSL_OP_NO_TLSv1_2\n> +    } else if (protocol & SSL_PROTOCOL_TLSV1_2) {\n> +        /* requested but not supported */\n> +#endif\n> \n> Or is this because (TLSv1_1 | TLSv1_2) is not a supported protocol\n> definition? I could only find these TLS-related server-method functions in\n> the OpenSSL API:\n> \n> const SSL_METHOD *TLSv1_server_method(void);    /* TLSv1.0 */\n> const SSL_METHOD *TLSv1_1_server_method(void);  /* TLSv1.1 */\n> const SSL_METHOD *TLSv1_2_server_method(void);  /* TLSv1.2 */\n\nWell, I'm no longer interested in merging the patches upstream. In particular, I'm not going to update them anymore. However, I feel that I should explain current patches.\n\nIf I remember it correctly, I found out by experiments that the only method supporting any combination of protocol versions is SSLv23_server_method. So whenever more protocols are requested, this method should be used. Don't be confused by its name, it actually supports all TLS versions.\n\nThe code\n+#ifndef SSL_OP_NO_TLSv1_2\n...\nmeans that whenever SSL library agains which tcnative is built is old enough so that it doesn't support newer TLS versions, and the user requested any of these versions, an error is returned.", "attachment_id": null, "id": 168805, "creator": "sebek64@post.cz", "time": "2013-07-26T11:53:09Z", "bug_id": 53952, "creation_time": "2013-07-26T11:53:09Z", "is_private": false}, {"count": 26, "tags": [], "text": "see also Bug 55537", "attachment_id": null, "bug_id": 53952, "id": 169969, "time": "2013-09-08T22:10:08Z", "creator": "hauser@acm.org", "creation_time": "2013-09-08T22:10:08Z", "is_private": false}, {"count": 27, "tags": [], "bug_id": 53952, "attachment_id": 29433, "id": 171994, "time": "2014-01-01T16:22:02Z", "creator": "withmudassir@gmail.com", "creation_time": "2014-01-01T16:22:02Z", "is_private": false, "text": "Comment on attachment 29433\npatch for tomcat trunk that adds support for newer TLS versions\n\nHI,\n\nThis patch is not working for me \n\n/opt/apache-tomcat-7.0.47-src# patch -R < patch\ncan't find file to patch at input line 5\nPerhaps you should have used the -p or --strip option?\nThe text leading up to this was:\n--------------------------\n|Index: webapps/docs/config/http.xml\n|===================================================================\n|--- webapps/docs/config/http.xml       (revision 1392879)\n|+++ webapps/docs/config/http.xml       (working copy)\n--------------------------\nFile to patch: webapps/docs/config/http.xml\npatching file webapps/docs/config/http.xml\nHunk #1 succeeded at 1212 (offset 22 lines).\ncan't find file to patch at input line 23\nPerhaps you should have used the -p or --strip option?\nThe text leading up to this was:\n--------------------------\n|Index: webapps/docs/ssl-howto.xml\n|===================================================================\n|--- webapps/docs/ssl-howto.xml (revision 1392879)\n|+++ webapps/docs/ssl-howto.xml (working copy)\n--------------------------\nFile to patch: webapps/docs/ssl-howto.xml\npatching file webapps/docs/ssl-howto.xml\nUnreversed patch detected!  Ignore -R? [n] y\nHunk #1 succeeded at 368 (offset -1 lines).\ncan't find file to patch at input line 36\nPerhaps you should have used the -p or --strip option?\nThe text leading up to this was:\n--------------------------\n|Index: java/org/apache/tomcat/jni/SSLContext.java\n|===================================================================\n|--- java/org/apache/tomcat/jni/SSLContext.java (revision 1392879)\n|+++ java/org/apache/tomcat/jni/SSLContext.java (working copy)\n--------------------------\nFile to patch: java/org/apache/tomcat/jni/SSLContext.java\npatching file java/org/apache/tomcat/jni/SSLContext.java\nUnreversed patch detected!  Ignore -R? [n] -R\nApply anyway? [n]\nSkipping patch.\n1 out of 1 hunk ignored -- saving rejects to file java/org/apache/tomcat/jni/SSLContext.java.rej\ncan't find file to patch at input line 56\nPerhaps you should have used the -p or --strip option?\nThe text leading up to this was:\n--------------------------\n|Index: java/org/apache/tomcat/jni/SSL.java\n|===================================================================\n|--- java/org/apache/tomcat/jni/SSL.java        (revision 1392879)\n|+++ java/org/apache/tomcat/jni/SSL.java        (working copy)\n--------------------------"}, {"count": 28, "tags": [], "bug_id": 53952, "text": "Comment on attachment 29433\npatch for tomcat trunk that adds support for newer TLS versions\n\nHI,\n\nThis patch is not working for me \n\n/opt/apache-tomcat-7.0.47-src# patch -R < patch\ncan't find file to patch at input line 5\nPerhaps you should have used the -p or --strip option?\nThe text leading up to this was:\n--------------------------\n|Index: webapps/docs/config/http.xml\n|===================================================================\n|--- webapps/docs/config/http.xml       (revision 1392879)\n|+++ webapps/docs/config/http.xml       (working copy)\n--------------------------\nFile to patch: webapps/docs/config/http.xml\npatching file webapps/docs/config/http.xml\nHunk #1 succeeded at 1212 (offset 22 lines).\ncan't find file to patch at input line 23\nPerhaps you should have used the -p or --strip option?\nThe text leading up to this was:\n--------------------------\n|Index: webapps/docs/ssl-howto.xml\n|===================================================================\n|--- webapps/docs/ssl-howto.xml (revision 1392879)\n|+++ webapps/docs/ssl-howto.xml (working copy)\n--------------------------\nFile to patch: webapps/docs/ssl-howto.xml\npatching file webapps/docs/ssl-howto.xml\nUnreversed patch detected!  Ignore -R? [n] y\nHunk #1 succeeded at 368 (offset -1 lines).\ncan't find file to patch at input line 36\nPerhaps you should have used the -p or --strip option?\nThe text leading up to this was:\n--------------------------\n|Index: java/org/apache/tomcat/jni/SSLContext.java\n|===================================================================\n|--- java/org/apache/tomcat/jni/SSLContext.java (revision 1392879)\n|+++ java/org/apache/tomcat/jni/SSLContext.java (working copy)\n--------------------------\nFile to patch: java/org/apache/tomcat/jni/SSLContext.java\npatching file java/org/apache/tomcat/jni/SSLContext.java\nUnreversed patch detected!  Ignore -R? [n] -R\nApply anyway? [n]\nSkipping patch.\n1 out of 1 hunk ignored -- saving rejects to file java/org/apache/tomcat/jni/SSLContext.java.rej\ncan't find file to patch at input line 56\nPerhaps you should have used the -p or --strip option?\nThe text leading up to this was:\n--------------------------\n|Index: java/org/apache/tomcat/jni/SSL.java\n|===================================================================\n|--- java/org/apache/tomcat/jni/SSL.java        (revision 1392879)\n|+++ java/org/apache/tomcat/jni/SSL.java        (working copy)\n--------------------------", "id": 171995, "time": "2014-01-01T16:22:43Z", "creator": "withmudassir@gmail.com", "creation_time": "2014-01-01T16:22:43Z", "is_private": false, "attachment_id": 29433}, {"count": 29, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "text": "(In reply to Mudassir Aftab from comment #27)\n> Comment on attachment 29433 [details]\n> patch for tomcat trunk that adds support for newer TLS versions\n> \n> This patch is not working for me \n> \n> /opt/apache-tomcat-7.0.47-src# patch -R < patch\n> can't find file to patch at input line 5\n> Perhaps you should have used the -p or --strip option?\n\nYou have not used 'patch' correctly.", "id": 172088, "time": "2014-01-05T14:48:12Z", "bug_id": 53952, "creation_time": "2014-01-05T14:48:12Z", "is_private": false}, {"count": 30, "tags": [], "bug_id": 53952, "text": "Another day, another SSL vulnerability.  Any chance this will go through any time soon?", "id": 178493, "attachment_id": null, "creator": "markwoon@gmail.com", "creation_time": "2014-10-15T22:35:56Z", "time": "2014-10-15T22:35:56Z", "is_private": false}, {"count": 31, "tags": [], "bug_id": 53952, "attachment_id": 32114, "text": "Created attachment 32114\npatch for the issue.\n\nThe patch works for me.\nBasically the SSL.java needs the new SSL_PROTOCOL_TLS11 and SSL_PROTOCOL_TLS12 and add to ALL.\n\nTo set the protocol I have set it to SSL.SSL_PROTOCOL_ALL; and use !protocol.contains(\"java name\") to allow support the java syntax for protocol.", "id": 178502, "time": "2014-10-16T09:47:51Z", "creator": "jfclere@gmail.com", "creation_time": "2014-10-16T09:47:51Z", "is_private": false}, {"count": 32, "tags": [], "creator": "jfclere@gmail.com", "attachment_id": 32115, "text": "Created attachment 32115\npatch for tc-trunk.", "id": 178504, "time": "2014-10-16T10:16:28Z", "bug_id": 53952, "creation_time": "2014-10-16T10:16:28Z", "is_private": false}, {"count": 33, "tags": [], "bug_id": 53952, "attachment_id": null, "id": 178511, "time": "2014-10-16T16:49:57Z", "creator": "Jeffrey.Janner@polydyne.com", "creation_time": "2014-10-16T16:49:57Z", "is_private": false, "text": "I was looking at the code for the patch in Comment #32 and noticed that you introduced a regression. SSLv2 was removed from the ALL list sometime back so that the default was to not support SSLv2. This is also how it is documented on the Tomcat website.\nPlease remove SSLv2 from the list of ALL protocols.\nMight I suggest that our new default for ALL also not include SSLv3, since it is now basically a useless protocol?"}, {"count": 34, "tags": [], "bug_id": 53952, "is_private": false, "id": 178521, "attachment_id": null, "creator": "chris@christopherschultz.net", "creation_time": "2014-10-16T21:16:08Z", "time": "2014-10-16T21:16:08Z", "text": "(In reply to jfclere from comment #31)\n> Created attachment 32114 [details]\n> patch for the issue.\n> \n> The patch works for me.\n> Basically the SSL.java needs the new SSL_PROTOCOL_TLS11 and\n> SSL_PROTOCOL_TLS12 and add to ALL.\n> \n> To set the protocol I have set it to SSL.SSL_PROTOCOL_ALL; and use\n> !protocol.contains(\"java name\") to allow support the java syntax for\n> protocol.\n\nTo be clear, this also requires a patch to tcnative as well.\n\nSounds like it's time to pull the trigger on this."}, {"count": 35, "tags": [], "text": "Agreed. I'll start looking at this today with a view to getting a release out next week.", "attachment_id": null, "bug_id": 53952, "id": 178529, "time": "2014-10-17T07:56:36Z", "creator": "markt@apache.org", "creation_time": "2014-10-17T07:56:36Z", "is_private": false}, {"count": 36, "tags": [], "creator": "chris@christopherschultz.net", "text": "I'll do another review of the tcnative patch and apply as appropriate.", "id": 178542, "attachment_id": null, "bug_id": 53952, "creation_time": "2014-10-17T13:38:15Z", "time": "2014-10-17T13:38:15Z", "is_private": false}, {"count": 37, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": null, "is_private": false, "id": 178548, "time": "2014-10-17T14:44:38Z", "bug_id": 53952, "creation_time": "2014-10-17T14:44:38Z", "text": "I'm looking at Marcel's attachment #30150 and the protocol selection is a bit verbose though methodical.\n\nIt took a bit of thinking to understand why the code does what it does. Specifically, it does not explicitly cover all possible combinations of values for \"protocol\". Instead, it takes a top-down approach assuming that the user will want the highest-available protocol to be supported.\n\nChecks for exact matches are performed for TLSv1.2, TLSv1.1, TLSv1(.0), SSLv3, and SSLv2 are performed and the client gets the requested version unless the library doesn't support that version, in which case the client gets an inert SSL engine. It's debatable whether or not this should throw some kind of error.\n\nAfter the exact checks, there are checks for \"anything including TLSv1.2\" and \"anything including TLSv1.1\", except that those checks are not even compiled if OpenSSL does not support them. (Of those, the highest protocol supported by the library is used.)\n\nFailing the above, SSL2/3 is selected.\n\nI see a consistency problem, here: if TLSv1.2 is not supported by OpenSSL but the client requests is specifically, then they will get an inert engine. If the client requests TLSv1.2 + SSLv3 and TLSv1.2 is not supported, they'll get the SSLv2/3 engine instead instead of the SSLv3 engine. It's not clear to me whether this was intentional.\n\nI will be committing attachment #30150 without modification and we can debate the correct behavior later.\n\nWhat's interesting (or awful: you decide) about OpenSSL is that you can't choose the exact set of protocols to support when choosing an engine method. Instead, you have to choose the engine method that makes the most sense (usually the highest version-number that is supported and requested by the client) and then you have to go back and black-list all the protocols that the selected method may support but that you don't want. A perfect case is that of requesting TLS1.2+TLS1.1 and nothing else. For that, you have to ask for the TLSv1.2 method in OpenSSL, but that method also provides TLS1, SSLv3, and SSLv2. So you have to call SSL_CTX_set_options and *enable* the *disable flags* for those other protocols. It's not straightforward at all and worth mentioning this to those who would like to review the patch."}, {"count": 38, "tags": [], "creator": "chris@christopherschultz.net", "attachment_id": 32114, "is_private": false, "id": 178550, "time": "2014-10-17T14:55:37Z", "bug_id": 53952, "creation_time": "2014-10-17T14:55:37Z", "text": "Comment on attachment 32114\npatch for the issue.\n\nMarking jfclere's patch as obsolete because I like the changes to the protocol selection that Marcel made. He also correctly included support for the SSL_OP_NO_TLS* options in supported_ssl_opts."}, {"count": 39, "tags": [], "bug_id": 53952, "is_private": false, "id": 178552, "attachment_id": null, "creator": "chris@christopherschultz.net", "creation_time": "2014-10-17T15:22:02Z", "time": "2014-10-17T15:22:02Z", "text": "Fixed in tcnative-trunk in r1632593 and tcnative-1.1.x in r1632595. Will be in tcnative 1.1.32."}, {"count": 40, "tags": [], "text": "Fixed in Tomcat-trunk in r1632604. Will be in Tomcat 8.0.15.\nFixed in Tomcat 7 in r1632606. Will be in Tomcat 7.0.57.", "attachment_id": null, "bug_id": 53952, "id": 178553, "time": "2014-10-17T15:31:45Z", "creator": "chris@christopherschultz.net", "creation_time": "2014-10-17T15:31:45Z", "is_private": false}, {"count": 41, "tags": [], "text": "I'll prepare a patch for Tomcat 6 as well.", "attachment_id": null, "bug_id": 53952, "id": 178559, "time": "2014-10-17T15:52:41Z", "creator": "chris@christopherschultz.net", "creation_time": "2014-10-17T15:52:41Z", "is_private": false}, {"count": 42, "tags": [], "bug_id": 53952, "attachment_id": null, "is_private": false, "id": 178619, "time": "2014-10-20T13:38:12Z", "creator": "chris@christopherschultz.net", "creation_time": "2014-10-20T13:38:12Z", "text": "Patch proposed for tc6:\nhttp://people.apache.org/~schultz/patches/53952.tc6.patch"}, {"count": 43, "tags": [], "bug_id": 53952, "attachment_id": null, "is_private": false, "id": 178632, "time": "2014-10-21T08:51:11Z", "creator": "hauser@acm.org", "creation_time": "2014-10-21T08:51:11Z", "text": "I guess comment 30 ff. refers to \nhttps://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-3566  ?"}, {"count": 44, "tags": [], "bug_id": 53952, "attachment_id": null, "text": "(In reply to Ralf Hauser from comment #43)\n> I guess comment 30 ff. refers to \n> https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-3566  ?\n\nYes.\n\nPatches are available for all supported versions of Tomcat as well as tcnative. Voting is in process for tcnative 1.1.32 and I have voted to release (successfully tested with Tomcat 8-trunk which will be Tomcat 8.0.15). Feedback on the tcnative release candidate is welcome even for non-committers. Please reply to the [VOTE] thread on dev@tomcat.apache.org for tcnative 1.1.32.", "id": 178655, "time": "2014-10-21T20:02:59Z", "creator": "chris@christopherschultz.net", "creation_time": "2014-10-21T20:02:59Z", "is_private": false}, {"count": 45, "tags": [], "text": "In reply to comment #43: yes.\n\nI also agree with comment #33 - SSLv2 and SSLv3 should just be removed from the options.\n\nSo glad to see that this is moving forward.", "attachment_id": null, "bug_id": 53952, "id": 178658, "time": "2014-10-21T21:58:29Z", "creator": "markwoon@gmail.com", "creation_time": "2014-10-21T21:58:29Z", "is_private": false}, {"count": 46, "tags": [], "bug_id": 53952, "attachment_id": null, "is_private": false, "id": 178990, "time": "2014-11-06T11:00:22Z", "creator": "markt@apache.org", "creation_time": "2014-11-06T11:00:22Z", "text": "Fix has been applied to 6.0.x for 6.0.43 onwards."}]