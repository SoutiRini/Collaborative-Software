[{"count": 0, "attachment_id": null, "bug_id": 50627, "text": "I noticed a problem that did not exist in Tomcat 6: event CometEvent.EventType.END is not fired when client connection is closed.\nIt is very easy to duplicate. The server and client code is below. You would need to open html page in a browser and press \"TEST\". This should print \"Begin Event\" in the server. If you close the browser (close connection), the \"End Event\" is not printed. It is printed with Tomcat 6.\n\nIt is similar to bug https://issues.apache.org/bugzilla/show_bug.cgi?id=50207, that marked as fixed. Not sure if it is related or not.\n\nSERVER:\npackage test;\n\nimport java.io.IOException;\n\nimport javax.servlet.ServletException;\nimport javax.servlet.http.HttpServlet;\n\nimport org.apache.catalina.comet.CometEvent;\nimport org.apache.catalina.comet.CometProcessor;\n\npublic class TomcatBug extends HttpServlet implements CometProcessor {\n\n    public void event(CometEvent event) throws IOException, ServletException {\n        if (event.getEventType() == CometEvent.EventType.BEGIN) {\n            System.out.println(\"Begin Event\");\n        }\n        else if (event.getEventType() == CometEvent.EventType.ERROR) {\n            System.out.println(\"Error Event\");\n            event.close();\n        }\n        else if (event.getEventType() == CometEvent.EventType.END) {\n            System.out.println(\"End Event\");\n            event.close();\n        }\n    }\n}\n\nCLIENT (html):\n<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd\">\n<html>\n<head>\n    <title>test</title>\n</head>\n<body>\n    <input type=\"button\" value=\"TEST\" onclick=\"test(); return false;\" />\n\n    <script type=\"text/javascript\">\n        function test() {\n            var api = new XMLHttpRequest;\n            api.onreadystatechange = onreadystatechange;\n\n            api.open(\"GET\", \"http://localhost/Test/Controller\", true);\n\n            api.send(\"\");\n        }\n\n        function onreadystatechange() {\n        }\n\n    </script>\n\n</body>\n</html>", "id": 143536, "time": "2011-01-20T21:08:31Z", "creator": "goberman@msn.com", "creation_time": "2011-01-20T21:08:31Z", "tags": [], "is_private": false}, {"count": 1, "text": "This is fixed for the NIO connector and will be in 7.0.7 onwards. I'll check the APR connector before closing this bug.", "bug_id": 50627, "attachment_id": null, "id": 143626, "time": "2011-01-25T12:34:24Z", "creator": "markt@apache.org", "creation_time": "2011-01-25T12:34:24Z", "tags": [], "is_private": false}, {"count": 2, "attachment_id": null, "bug_id": 50627, "text": "Some APR fixes were also required for comet. These will also be in 7.0.7 onwards.", "id": 143722, "time": "2011-01-27T12:42:51Z", "creator": "markt@apache.org", "creation_time": "2011-01-27T12:42:51Z", "tags": [], "is_private": false}]