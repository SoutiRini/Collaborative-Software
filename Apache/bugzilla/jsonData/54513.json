[{"count": 0, "tags": [], "text": "Trunk at r1441188, running the test suite with APR connector, Native 1.1.26 Windows 32-bit with JDK 7u11.\n\nI encountered the following when running org.apache.catalina.loader.TestVirtualContext test\n\nOn second re-run of the test the same issue happened, so it is as if there is something specific here. I have not encountered the issue with the rest of testsuite yet.\n\n[[[\nFeb 01, 2013 2:07:26 AM org.apache.tomcat.util.net.AprEndpoint$Poller run\nWARNING: Unexpected poller error\njava.lang.NullPointerException\n\tat org.apache.tomcat.util.net.AprEndpoint$AprSocketWrapper.access$200(AprEndpoint.java:2198)\n\tat org.apache.tomcat.util.net.AprEndpoint$Poller.run(AprEndpoint.java:1632)\n\tat java.lang.Thread.run(Thread.java:722)\n]]]\n\nThe code at AprEndpoint$Poller.run(AprEndpoint.java:1632) is\n\n1628 for (int n = 0; n < rv; n++) {\n1629  timeouts.remove(desc[n*2+1]);\n1630  AprSocketWrapper wrapper = connections.get(\n1631          Long.valueOf(desc[n*2+1]));\n1632  wrapper.pollerFlags = wrapper.pollerFlags & ~((int) desc[n*2]);\n\nI suspect that \"wrapper\" is null here.\n\nThe above code is specific to Tomcat trunk and is not present in 7.0.x.\n\n\nWhen this happened, the test hung for 15 minutes (1000 secs) waiting on a socket read. When time out passed, it continued to run all the other tests.\n\n[[[\nTestcase: testAdditionalWebInfClassesPaths took 1\u00a0006,735 sec\n\tCaused an ERROR\nRead timed out\njava.net.SocketTimeoutException: Read timed out\n\tat java.net.SocketInputStream.socketRead0(Native Method)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:150)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:121)\n\tat java.io.BufferedInputStream.fill(BufferedInputStream.java:235)\n\tat java.io.BufferedInputStream.read1(BufferedInputStream.java:275)\n\tat java.io.BufferedInputStream.read(BufferedInputStream.java:334)\n\tat sun.net.www.http.HttpClient.parseHTTPHeader(HttpClient.java:633)\n\tat sun.net.www.http.HttpClient.parseHTTP(HttpClient.java:579)\n\tat sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1322)\n\tat java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:468)\n\tat org.apache.catalina.startup.TomcatBaseTest.methodUrl(TomcatBaseTest.java:247)\n\tat org.apache.catalina.startup.TomcatBaseTest.getUrl(TomcatBaseTest.java:219)\n\tat org.apache.catalina.startup.TomcatBaseTest.getUrl(TomcatBaseTest.java:213)\n\tat org.apache.catalina.startup.TomcatBaseTest.getUrl(TomcatBaseTest.java:202)\n\tat org.apache.catalina.loader.TestVirtualContext.assertPageContains(TestVirtualContext.java:326)\n\tat org.apache.catalina.loader.TestVirtualContext.assertPageContains(TestVirtualContext.java:320)\n\tat org.apache.catalina.loader.TestVirtualContext.testAdditionalWebInfClassesPaths(TestVirtualContext.java:311)\n]]]", "is_private": false, "bug_id": 54513, "id": 164966, "time": "2013-01-31T23:15:59Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-01-31T23:15:59Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 54513, "attachment_id": 29911, "is_private": false, "id": 164967, "time": "2013-01-31T23:18:25Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-01-31T23:18:25Z", "text": "Created attachment 29911\nTEST-org.apache.catalina.loader.TestVirtualContext.APR.txt\n\nJUnit test result file"}, {"count": 2, "tags": [], "bug_id": 54513, "attachment_id": 29912, "is_private": false, "id": 164968, "time": "2013-01-31T23:20:09Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-01-31T23:20:09Z", "text": "Created attachment 29912\nthread_dump_2013-02-01.txt\n\nThread dump, taken with jvisualvm during the 15-minutes pause"}, {"count": 3, "tags": [], "bug_id": 54513, "attachment_id": null, "is_private": false, "id": 164970, "time": "2013-01-31T23:55:20Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2013-01-31T23:55:20Z", "text": "> I suspect that \"wrapper\" is null here.\n\nYes, it is null. I added the following code at line 1632: \n\n[[[\nif (wrapper==null) throw new NullPointerException(\"wrapper is null, n: \" + n + \", rv: \"+rv+\", desc[n*2+1]: \" + desc[n*2+1]);\n]]]\n\nIt results in the following on console:\n    [junit] WARNING: Unexpected poller error\n    [junit] java.lang.NullPointerException: wrapper is null, n: 0, rv: 1, desc[n*2+1]: 52898296\n    [junit] \tat org.apache.tomcat.util.net.AprEndpoint$Poller.run(AprEndpoint.java:1632)\n    [junit] \tat java.lang.Thread.run(Thread.java:722)"}, {"count": 4, "tags": [], "text": "Reproduced this issue with Native 1.1.24, but a bit different.\nI was not able to reproduce the NPE, but SocketInputStream.socketRead0 in the test hung in the same way. There were two variants:\na) no error message is printed\nb) Feb 01, 2013 H:MM:SS AM org.apache.tomcat.util.net.AprEndpoint$Poller run\nWARNING: Error processing socket timeout\n\n\nThere were a pair of runs with 1.1.26 and with 1.1.24 when the issue did not reproduce.\n\n\n>  thread_dump_2013-02-01.txt (14.90 KB, text/plain) \n\nWhat is odd in the thread dump is that there are two threads:\n\"http-apr-127.0.0.1-auto-2-Poller\"\n\"http-apr-127.0.0.1-auto-1-Poller\"\n\nAll other threads besides this poller one are \"auto-2\".\nIt is the second test, but the poller thread from the first test has not stopped.", "attachment_id": null, "id": 164971, "creator": "knst.kolinko@gmail.com", "time": "2013-02-01T01:16:12Z", "bug_id": 54513, "creation_time": "2013-02-01T01:16:12Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 54513, "attachment_id": null, "id": 164979, "time": "2013-02-01T13:33:54Z", "creator": "markt@apache.org", "creation_time": "2013-02-01T13:33:54Z", "is_private": false, "text": "I can repeat this on 64-bit Windows."}, {"count": 6, "tags": [], "bug_id": 54513, "is_private": false, "text": "I believe I have found the root cause of this. There is a bug in tc native introduced in r1412919 in the implementation of Poll.pollset(). n is incremented twice inside the for each loop for each entry in the poller. That means the return value is 2 * number of entries rather than number of entries.", "id": 164993, "time": "2013-02-01T21:05:02Z", "creator": "markt@apache.org", "creation_time": "2013-02-01T21:05:02Z", "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 54513, "is_private": false, "text": "Hmm. There may be more to this problem than just that. I still see issues even with a workaround for the Poll.poollset() return value problem.", "id": 164994, "time": "2013-02-01T21:10:33Z", "creator": "markt@apache.org", "creation_time": "2013-02-01T21:10:33Z", "attachment_id": null}, {"count": 8, "tags": [], "text": "Hmm, reading the code it seems that a socket is member of two pollsets (timeouts and connections). Is this correct. Note that socket can be member of only one pollset and 1.1.26 kind of enforces that.", "is_private": false, "bug_id": 54513, "id": 165005, "time": "2013-02-02T11:41:25Z", "creator": "mturk@apache.org", "creation_time": "2013-02-02T11:41:25Z", "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 54513, "attachment_id": null, "is_private": false, "id": 165028, "time": "2013-02-02T18:49:35Z", "creator": "markt@apache.org", "creation_time": "2013-02-02T18:49:35Z", "text": "(In reply to comment #8)\n> Hmm, reading the code it seems that a socket is member of two pollsets\n> (timeouts and connections). Is this correct. Note that socket can be member\n> of only one pollset and 1.1.26 kind of enforces that.\n\nNeither of those are pollsets. There are local lists of sockets.\n\nThere are a handful of bugs I have found in the new AprEndpoint. Fixes are on the way. In the meantime, I would be helpful if you could look at the return value of Poll.pollset. The use of n++ twice inside the loop looks like a bug to me."}, {"count": 10, "tags": [], "bug_id": 54513, "attachment_id": null, "is_private": false, "id": 165029, "time": "2013-02-02T19:22:59Z", "creator": "mturk@apache.org", "creation_time": "2013-02-02T19:22:59Z", "text": "Not sure what you mean by double increment. Is it?\n\n        p->set[n++]   = (jlong)(fd->rtnevents);\n        p->set[n++]   = P2J(fd->client_data);\n\nThat should be fine.\nThe returned array consist of pair of values odd being event and even being the socket. It was always like that.\n\nBut you are right, there is a bug. Returned number should be n/2 not n.\nI'll fix that.\nIf you create a shortcut in Java which calls .pollset(...)\nand divide by two in case the value is > 0 doesn't that help?\nAnyhow, I'll fix the native and create test 1.1.27-dev binaries for further test."}, {"count": 11, "tags": [], "bug_id": 54513, "attachment_id": null, "is_private": false, "id": 165030, "time": "2013-02-02T19:30:07Z", "creator": "markt@apache.org", "creation_time": "2013-02-02T19:30:07Z", "text": "(In reply to comment #10)\n> Not sure what you mean by double increment. Is it?\n> \n>         p->set[n++]   = (jlong)(fd->rtnevents);\n>         p->set[n++]   = P2J(fd->client_data);\n> \n> That should be fine.\n> The returned array consist of pair of values odd being event and even being\n> the socket. It was always like that.\n> \n> But you are right, there is a bug. Returned number should be n/2 not n.\n> I'll fix that.\n\nThanks.\n\n> If you create a shortcut in Java which calls .pollset(...)\n> and divide by two in case the value is > 0 doesn't that help?\n\nAlready doing this locally. That was how I moved past this issue and found the others.\n\n> Anyhow, I'll fix the native and create test 1.1.27-dev binaries for further\n> test.\n\nPerfect. I see your commit, so I'm going to move this back to Tomact 8 to track the remaining AprEndpoint issies."}, {"count": 12, "tags": [], "bug_id": 54513, "is_private": false, "text": "The root cause of the initial issue is the tc native bug that Mladen has now fixed. This affected Tomcat 7 and 8.\n\nThe other issues (the poller threads not stopping, socket reads hanging) are Tomcat 8 specific and have been fixed in trunk.", "id": 165031, "time": "2013-02-02T20:41:02Z", "creator": "markt@apache.org", "creation_time": "2013-02-02T20:41:02Z", "attachment_id": null}, {"count": 13, "tags": [], "text": "Please try with the binaries from\nhttp://people.apache.org/~mturk/native/1.1.27-dev-20130202/", "is_private": false, "bug_id": 54513, "id": 165032, "time": "2013-02-02T21:02:17Z", "creator": "mturk@apache.org", "creation_time": "2013-02-02T21:02:17Z", "attachment_id": null}, {"count": 14, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 165033, "time": "2013-02-02T21:10:28Z", "bug_id": 54513, "creation_time": "2013-02-02T21:10:28Z", "is_private": false, "text": "Sure. Just as soon as you make those files world readable ;)"}, {"count": 15, "tags": [], "bug_id": 54513, "attachment_id": null, "id": 165035, "time": "2013-02-03T05:21:12Z", "creator": "mturk@apache.org", "creation_time": "2013-02-03T05:21:12Z", "is_private": false, "text": "Attrs should be fine now."}, {"count": 16, "attachment_id": null, "creator": "markt@apache.org", "is_private": false, "id": 165037, "time": "2013-02-03T10:09:33Z", "bug_id": 54513, "creation_time": "2013-02-03T10:09:33Z", "tags": [], "text": "Looks good to me. The failing tests pass. I haven't done a full test run though."}]