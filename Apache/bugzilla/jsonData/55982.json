[{"count": 0, "tags": [], "bug_id": 55982, "attachment_id": 31188, "text": "Created attachment 31188\nExcel file which produces the exception\n\nThis exception happens when trying to clone the Second sheet in the Workbook. I can modify it (inserting contents, saving) but if I want to clone and prepend this \"empty\" sheet, a ClassCastException is thrown.\n\njava.lang.ClassCastException: org.apache.poi.hssf.record.BOFRecord cannot be cast to org.apache.poi.hssf.record.TabIdRecord\n\tat org.apache.poi.hssf.model.InternalWorkbook.fixTabIdRecord(InternalWorkbook.java:732)\n\tat org.apache.poi.hssf.model.InternalWorkbook.checkSheets(InternalWorkbook.java:687)\n\tat org.apache.poi.hssf.model.InternalWorkbook.setSheetName(InternalWorkbook.java:524)\n\tat org.apache.poi.hssf.usermodel.HSSFWorkbook.cloneSheet(HSSFWorkbook.java:717)\n\tat org.apache.poi.hssf.usermodel.HSSFWorkbook.cloneSheet(HSSFWorkbook.java:85)", "id": 172211, "time": "2014-01-09T14:04:18Z", "creator": "bachelier.matthieu@gmail.com", "creation_time": "2014-01-09T14:04:18Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 55982, "attachment_id": 31189, "text": "Created attachment 31189\n[PATCH] First patch for Apache Software Foundation", "id": 172221, "time": "2014-01-09T16:16:22Z", "creator": "bachelier.matthieu@gmail.com", "creation_time": "2014-01-09T16:16:22Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 55982, "text": "Any chance you could produce a diff of the changes, rather than the whole changed file? The former makes it much easier to identify what has changed than the latter", "id": 172222, "time": "2014-01-09T16:20:57Z", "creator": "apache@gagravarr.org", "creation_time": "2014-01-09T16:20:57Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 55982, "text": "Sure, I change the method fixTabIdRecord() :\n\n    /**\n     * Make the tabid record look like the current situation.\n     */\n    private void fixTabIdRecord() {\n        Record r = records.get(records.getTabpos());\n        if (r instanceof TabIdRecord) {\n        \tTabIdRecord tir = ( TabIdRecord ) r;\n        \tint sz = tir.getRecordSize();\n            short[]     tia = new short[ boundsheets.size() ];\n\n            for (short k = 0; k < tia.length; k++) {\n                tia[ k ] = k;\n            }\n            tir.setTabIdArray(tia);\n            // No need to return int because it's not used in this class\n            // return tir.getRecordSize() - sz;\n        } else if (r instanceof BOFRecord) {\n        \t// so what ?\n        \tBOFRecord bof = null; \n        }\n    }", "id": 172224, "attachment_id": null, "creator": "bachelier.matthieu@gmail.com", "creation_time": "2014-01-09T16:44:46Z", "time": "2014-01-09T16:44:46Z", "is_private": false}, {"count": 4, "tags": [], "creator": "dominik.stadler@gmx.at", "attachment_id": null, "id": 188063, "time": "2016-01-30T09:32:20Z", "bug_id": 55982, "creation_time": "2016-01-30T09:32:20Z", "is_private": false, "text": "Hm, this still does not look like a full solution, the assignment in the else is quite useless. And what happens for even other Record-types, should we at least log out or throw an exception?"}, {"count": 5, "tags": [], "bug_id": 55982, "text": "Unfortunately the patch attached here needs more work, therefore I am removing the \"PatchAvailable\" marker.\n\nFYI, when running our large regression test suite against 1 mio files this exception pops among the top failures besides invalid file formats, see http://people.apache.org/~centic/poi_regression/reportsAll/ for some details.\n\nWhen verifying 1051003 files, this exception is found 10674 times, i.e. roughly 1% fails with this exception.", "id": 188801, "time": "2016-02-25T14:55:45Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2016-02-25T14:55:45Z", "is_private": false, "attachment_id": null}, {"id": 189921, "tags": [], "bug_id": 55982, "attachment_id": null, "count": 6, "text": "As this is responsible for a large part of failing documents in our large CommonCrawl regression test-suite and thus is likely to affect some people, I have now put in a fix which tries to handle this similar to what LibreOffice/Excel seem to do in these cases.\n\nSee r1737602 for the actual changes.", "time": "2016-04-03T18:40:17Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2016-04-03T18:40:17Z", "is_private": false}]