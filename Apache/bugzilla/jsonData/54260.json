[{"count": 0, "tags": [], "text": "Since Tomcat 7.0.30 (currently using version 7.0.33) we are faced with the\nfollowing NullPointerException:\n\nDec 7, 2012 2:10:28 PM\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor\nprocessChildren\nSEVERE: Exception invoking periodic operation:\njava.lang.NullPointerException\n        at\norg.apache.jasper.util.FastRemovalDequeue$Entry.access$700(FastRemovalDe\nqueue.java:254)\n        at\norg.apache.jasper.util.FastRemovalDequeue.remove(FastRemovalDequeue.java\n:177)\n        at\norg.apache.jasper.compiler.JspRuntimeContext.checkUnload(JspRuntimeConte\nxt.java:610)\n        at\norg.apache.jasper.servlet.JspServlet.periodicEvent(JspServlet.java:360)\n        at\norg.apache.catalina.core.StandardWrapper.backgroundProcess(StandardWrapp\ner.java:709)\n        at\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.proc\nessChildren(ContainerBase.java:1530)\n        at\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.proc\nessChildren(ContainerBase.java:1540)\n        at\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.proc\nessChildren(ContainerBase.java:1540)\n        at\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.proc\nessChildren(ContainerBase.java:1540)\n        at\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run(\nContainerBase.java:1519)\n        at java.lang.Thread.run(Thread.java:662)\n\n\n\nInvestigation results:\n\nI was able to debug and trace the exception and found that the Excpetion\nis caused by a '.tag', I'm including in my JSP, which has no\nUnloadHandle assigned when processed in\norg.apache.jasper.compiler.JspRuntimeContext.checkUnload() line 610:\njspQueue.remove(jsw.getUnloadHandle());\n\nBecause jsw.getUnloadHandle() returns null, jspQueue.remove() fails and\nis throwing the NullPointerException everytime, aborting the \"unload\".\n\n\n\nReproducing the exceptiopn:\n\nIt looks like the exception appears only when \"maxLoadedJsps\" and \" jspIdleTimeout\" are set to a value >0 in tomcat/conf/web.xml and \".tag\" files are used with jsp-scriptlets.\n\nWeb.xml changes:\n        <init-param>\n            <param-name>maxLoadedJsps</param-name>\n            <param-value>1000</param-value>\n        </init-param>\n        <init-param>\n            <param-name>jspIdleTimeout</param-name>\n            <param-value>5</param-value>\n        </init-param>\n\n\nThe exception can be observed in the example \"Tag Files\" -> \"Display Products Example\" but you have to edit the WEB-INF/tags/displayProducts.tag and append the following example scriptlet:\n\n<%\n String test = \"this is =\";\n if (normalPrice != null)\n  test = test + normalPrice + \" something\";\n else\n  test = test + onSale + \"=\";\n StringBuilder tags=new StringBuilder(test);\n tags.append(\".\").append(test).append(\"...\"); // change here\n test = tags.toString();\n request.setAttribute(\"test\", test);\n%>\n<%=test %>\n\nStart Tomcat and invoke the example jsp http://localhost:8080/examples/jsp/jsp2/tagfiles/products.jsp\n\nWait and observe the catalina.out (or tomcat output) for exceptions. Normaly the exception won't appear. Now edit the previously added scriplet in WEB-INF/tags/displayProducts.tag modifying any string in one of the append statements.\nCall the example jsp again, tomcat should recompile the tag, wait and observe again your tomcat output.\nDo not shutdown or restart tomcat between these steps! Tomcat should recompile the tag on the fly.\n\nWe were able to reproduce the exception on Tomcat 7.0.30, 7.0.32 and 7.0.33 on different machines using the described steps.", "attachment_id": null, "bug_id": 54260, "id": 163958, "time": "2012-12-07T17:58:25Z", "creator": "laszlo.keszthelyi@diepresse.com", "creation_time": "2012-12-07T17:58:25Z", "is_private": false}, {"count": 1, "text": "Confirming: I am able to reproduce this issue in 7.0.34 with the provided recipe.\n\nOnce the problem occurs, the same exception starts to be printed every 10 seconds.", "bug_id": 54260, "attachment_id": null, "id": 163994, "time": "2012-12-09T21:03:41Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2012-12-09T21:03:41Z", "tags": [], "is_private": false}, {"count": 2, "tags": [], "bug_id": 54260, "text": "Thanks for the report and the easy to reproduce test case.\n\nThe problem has been fixed in trunk and 7.0.x and will be included in 7.0.35 onwards.", "id": 164351, "attachment_id": null, "creator": "markt@apache.org", "creation_time": "2013-01-03T14:20:31Z", "time": "2013-01-03T14:20:31Z", "is_private": false}]