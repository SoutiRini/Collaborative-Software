[{"count": 0, "attachment_id": null, "bug_id": 50746, "text": "I am using mod_rewrite to set/unset variables, these are later checked\nin Allow directives:\n\n  RewriteMap nonfob txt:/usr/local/apache2/conf/nonfob\n   \n  RewriteCond ${nonfob:%{REMOTE_ADDR}} _ok_\n  RewriteRule (.*)       -    [env=nonfobaccess:1,env=nokeepalive]\n\n  RewriteCond  ${nonfob:%{REMOTE_ADDR}}  ^$\n  RewriteRule (.*)       -   [env=nonfobaccess,env=nokeepalive:1]\n\n  ...\n\n  Order                 Allow,Deny\n  Allow from            env=nonfobaccess\n\nThis works until 2.2.15, but as of 2.2.16 there is a change [Rainer Jung] \nin mod_rewrite which sets the variable to an empty value, rather than removing\nor unsetting it.\nAs of 2.2.16 both of these forms set the variable with an \"empty\" value:\n  env=nonfobaccess\n  env=nonfobaccess:\n\nHere's an (abridged) rewrite log from 2.2.15:\n(5) cache lookup OK: map=nonfob[txt] key=10.0.0.10 -> val= \n(4) RewriteCond: input='' pattern='^$' => matched\n(5) setting env variable 'nokeepalive' to '1'\n\nand from 2.2.16:\n(5) cache lookup OK: map=nonfob[txt] key=10.0.0.10 -> val=\n(4) RewriteCond: input='' pattern='^$' => matched\n(5) setting env variable 'nonfobaccess' to ''\n(5) setting env variable 'nokeepalive' to '1'\n\nThis means that the \"Allow from env=...\"  no longer has the same effect as \nthe variable now always exists. There seems no longer to be a way to unset a\nvariable with mod_rewrite (until the patch for bug 49512 is backported...)\n\nIn this case \"Allow\" + \"Satisfy Any\" is being used to bypass basic auth,\nso I cannot use extra \"Deny\" directives.\n\nI'm currently using \"Unsetenv\" with modified rewrite rules as a partial work-around, but I cannot fix nokeepalive with mod_rewrite.\n\nThis change means that no-cache, no-gzip and nokeeplive and other \"special \npurpose\" vairable can no longer be conditionally unset using mod_write.\n\nSo: I would like to request backporting \"env=!variable\" to 2.2.x (or \nallowing \"env=variable\" and \"env=variable:\" to do different things).\n\n(I acknowledge that the behaviour I am relying on is undocumented, but\nI suggest also that the change in behaviour be clarified in the 2.2 documentation, if you think that is appropriate.)\n\n-C", "id": 144099, "time": "2011-02-09T12:56:36Z", "creator": "Conor@kerna.ie", "creation_time": "2011-02-09T12:56:36Z", "tags": [], "is_private": false}, {"count": 1, "attachment_id": 26646, "bug_id": 50746, "text": "Created attachment 26646\nPatch for mod_rewrite", "id": 144235, "time": "2011-02-12T18:13:12Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2011-02-12T18:13:12Z", "tags": [], "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 50746, "is_private": false, "count": 2, "id": 144236, "time": "2011-02-12T18:13:39Z", "creator": "rainer.jung@kippdata.de", "creation_time": "2011-02-12T18:13:39Z", "text": "Can you please try the attached patch. It is a direct backport from trunk and I plan to propose it for 2.2."}, {"attachment_id": null, "tags": [], "bug_id": 50746, "text": "Great, will do. Thanks!", "count": 3, "id": 144250, "time": "2011-02-14T07:06:00Z", "creator": "Conor@kerna.ie", "creation_time": "2011-02-14T07:06:00Z", "is_private": false}, {"count": 4, "attachment_id": null, "bug_id": 50746, "is_private": false, "id": 144327, "time": "2011-02-15T13:28:06Z", "creator": "Conor@kerna.ie", "creation_time": "2011-02-15T13:28:06Z", "tags": [], "text": "Applied patch to 2.2.17, clean.\nRewrite directives updated to use the [env=!variable] form.\nTested, and works fine for me. \n\nMy config only uses the mod_write env flags as indicated below,\nand both \"Allow from env=...\" and \"nokeepalive\" work as before.\n\nThanks!"}, {"count": 5, "tags": [], "creator": "rainer.jung@kippdata.de", "is_private": false, "text": "Proposed for inclusion into 2.2.x.", "id": 144329, "time": "2011-02-15T15:27:13Z", "bug_id": 50746, "creation_time": "2011-02-15T15:27:13Z", "attachment_id": null}, {"count": 6, "tags": [], "creator": "rainer.jung@kippdata.de", "text": "Applied to 2.2.x as r1078933.\nWill be part of 2.2.18.", "id": 144808, "time": "2011-03-07T15:40:47Z", "bug_id": 50746, "creation_time": "2011-03-07T15:40:47Z", "is_private": false, "attachment_id": null}]