[{"count": 0, "tags": [], "bug_id": 48270, "attachment_id": null, "is_private": false, "id": 132270, "time": "2009-11-24T03:43:21Z", "creator": "enrico.gueli@polito.it", "creation_time": "2009-11-24T03:43:21Z", "text": "The following code defines a class, lets BCEL parse and rewrite it without any modification, then it tries to load it into the JVM.\n================================================================\nimport org.apache.bcel.Repository;\nimport org.apache.bcel.classfile.JavaClass;\n\nclass TestClass {\n\tpublic void foo() {\n\t\tint a = 0;\n\n\t\t/* FIRST CONDITIONAL BLOCK */\n\t\tif (a == 1) {\n\t\t\ta = 0;\n\t\t}\n\t\t/* SECOND CONDITIONAL BLOCK */\n\t\tif (a == 1) {\n\t\t\ta = 0;\n\t\t}\n\t};\n}\n\nclass MyClassLoader extends ClassLoader {\n\tpublic Class getTestClass() throws ClassNotFoundException {\n\t\tJavaClass jcl;\n\t\tjcl = Repository.lookupClass(TestClass.class);\n\t\tbyte[] data = jcl.getBytes();\n\t\treturn defineClass(TestClass.class.getName(), data, 0, data.length);\n\t}\n}\n\npublic class Main {\n\tpublic static void main(String[] args) {\n\t\ttry {\n\t\t\tMyClassLoader mcl = new MyClassLoader();\n\t\t\tmcl.getTestClass();\n\t\t} catch (Exception e) {\n\t\t\te.printStackTrace();\n\t\t}\n\t}\n}\n\n================================================================\n\nIf both conditional blocks are present (i.e. not commented), the following exception appears instead:\n\norg.apache.bcel.classfile.ClassFormatException: Invalid Stack map table tag: 6\n\tat org.apache.bcel.classfile.StackMapTableEntry.dump(StackMapTableEntry.java:143)\n\tat org.apache.bcel.classfile.StackMapTable.dump(StackMapTable.java:86)\n\tat org.apache.bcel.classfile.Code.dump(Code.java:154)\n\tat org.apache.bcel.classfile.FieldOrMethod.dump(FieldOrMethod.java:111)\n\tat org.apache.bcel.classfile.JavaClass.dump(JavaClass.java:317)\n\tat org.apache.bcel.classfile.JavaClass.getBytes(JavaClass.java:268)\n\tat MyClassLoader.getTestClass(Main.java:23)\n\tat Main.main(Main.java:32)\n\n\nIf only the second one is commented, the following exception is thrown:\n\nException in thread \"main\" java.lang.ClassFormatError: Attribute name has bad constant pool index 4608 in class file TestClass\n\tat java.lang.ClassLoader.defineClass1(Native Method)\n\tat java.lang.ClassLoader.defineClass(ClassLoader.java:621)\n\tat java.lang.ClassLoader.defineClass(ClassLoader.java:466)\n\tat MyClassLoader.getTestClass(Main.java:24)\n\tat Main.main(Main.java:32)\n\n\nIf both conditional blocks are commented, or if the code is compiled with Java 1.5 compiler instead of 1.6, everything is OK.\n\n\nThis happens with BCEL revision 883394."}, {"count": 1, "attachment_id": null, "bug_id": 48270, "is_private": false, "id": 132325, "time": "2009-11-25T10:11:39Z", "creator": "enrico.gueli@polito.it", "creation_time": "2009-11-25T10:11:39Z", "tags": [], "text": "\n\n*** This bug has been marked as a duplicate of bug 47073 ***"}]