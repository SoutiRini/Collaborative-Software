[{"count": 0, "tags": [], "creator": "philip75_t@hotmail.com", "attachment_id": null, "id": 119921, "time": "2008-08-19T08:50:39Z", "bug_id": 45653, "creation_time": "2008-08-19T08:50:39Z", "is_private": false, "text": "Tomcat leaks classloader reference, causing java.lang.OutOfMemoryError: PermGen space\n\nSorry my bad English.\nTomcat version: 6.0.18, 6.0.14, looks like other versions suffer too.\nJava: Java(TM) SE Runtime Environment (build 1.6.0_07-b06)\nProblem: \u201cjava.lang.OutOfMemoryError: PermGen space\u201d after several redeployments of a custom web application\nCause: Tomcat does not clear a reference to WebappClassLoader used by undeployed web applications. This reference is stored in field contextClassLoader of a thread, used by tomcat. This thread is included in a ThreadGroup. The ThreadGroup contains several dozens threads used by tomcat, for shutdown hooks and other needs. This prevents WebappClassLoader of a undeployed web applications to be collected. All Class\u2019es, loaded by this classloader are still in memory too.\nTomcat has to clean all references to undeployed WebappClassLoader.\n\nHow to reproduce:\nA proof of concept simple web application. Of course, this app does nothing with threads.\n1. deploy this web application\n2. undeploy this web app using Tomcat\u2019s Manager\n3. Force GC using jconsole\n4. take a memory dump using jmap -dump:file=1.dmp 3740 (Tomcat\u2019s process id for Jps)\n5. Open the memory dump in jhat 1.dmp\n6. You will see, classes of undeployed web application are still in memory.\n7. Using Jhat, find the classloader example used for web application (org.apache.catalina.loader.WebappClassLoader@0x31337a0\nIn the file attached)\n8. Take a look at rootset references to this WebappClassLoader@0x31337a0, exclude WeakRefs\n9. You can see a lot of links, preventing this WebappClassLoader@0x31337a0 from being collected. All links are ended in java.util.TimerThread@0x34962c0 (109 bytes) (field contextClassLoader:)\n\nFor example --> org.apache.catalina.startup.Bootstrap@0x2eb2310 (24 bytes) (field catalinaDaemon:)\n--> org.apache.catalina.startup.Catalina@0x2ec6bd0 (101 bytes) (field shutdownHook:)\n--> org.apache.catalina.startup.Catalina$CatalinaShutdownHook@0x33c0018 (108 bytes) (field group:)\n--> java.lang.ThreadGroup@0x2eb1f40 (43 bytes) (field threads:)\n--> [Ljava.lang.Thread;@0x33aeda0 (72 bytes) (Element 11 of [Ljava.lang.Thread;@0x33aeda0:)\n--> java.util.TimerThread@0x34962c0 (109 bytes) (field contextClassLoader:)\n--> org.apache.catalina.loader.WebappClassLoader@0x31337a0 (152 bytes)\n\nBest regards"}, {"count": 1, "tags": [], "creator": "philip75_t@hotmail.com", "text": "Created attachment 22462\nJhat memory report\n\nJhat memory report", "id": 119954, "time": "2008-08-20T10:52:33Z", "bug_id": 45653, "creation_time": "2008-08-20T10:52:33Z", "is_private": false, "attachment_id": 22462}, {"count": 2, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 119966, "time": "2008-08-20T16:30:56Z", "bug_id": 45653, "creation_time": "2008-08-20T16:30:56Z", "is_private": false, "text": "This is a caused by coding errors in your test application and/or bugs in the libraries you are using. Please ask on the users list if you need further assistance."}]