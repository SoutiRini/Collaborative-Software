[{"count": 0, "tags": [], "text": "Problem: access violation exception in isapi_redirect.dll.\n\nEnvironment: Two front end IIS 7.5 web servers (Windows 2008 R2 SP1) in DMZ redirecting to an application server through isapi_redirect. The website on the web servers is protected by Siteminder 12.0SP2 (an ISAPI filter).\n\nDescription:\nThe worker processes on the web servers crash multiple times a day, often within minutes of the previous crash, with either \"Faulting module name: isapi_redirect.dll, version: 1.2.37.0\" or \"Faulting module name: msvcrt.dll, version: 7.0.7601.17744.\"\n\nThe stack traces for the crash dumps vary slightly:\n\n1.\nisapi_redirect!GetExtensionVersion+7bf2\nisapi_redirect+74eb\nisapi_redirect+d726\nisapi_redirect!GetExtensionVersion+3161\nisapi_redirect!HttpExtensionProc+541\n\n2.\nmsvcrt!_ascii_stricmp+3\nmsvcrt!stricmp+43\nisapi_redirect!GetExtensionVersion+e69\nisapi_redirect!GetExtensionVersion+10b8\nisapi_redirect!GetExtensionVersion+2d6c\nisapi_redirect!HttpExtensionProc+541\n\n3.\nisapi_redirect+6dea\nisapi_redirect+7420\nisapi_redirect+d726\nisapi_redirect!GetExtensionVersion+3161\nisapi_redirect!HttpExtensionProc+541 \n\nThe current log_level of info does not provide any usefull information, and the information I've found indicate that a log_level of trace will severely impact performance?\n\nAttached are the minidumps and crash dump analysis generated by the \"Debug Diagnostics Tool\".", "attachment_id": null, "id": 163273, "creator": "werner.peenz@charteredaccountants.com.au", "time": "2012-11-08T04:05:38Z", "bug_id": 54117, "creation_time": "2012-11-08T04:05:38Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 54117, "attachment_id": 29568, "id": 163274, "time": "2012-11-08T04:13:41Z", "creator": "werner.peenz@charteredaccountants.com.au", "creation_time": "2012-11-08T04:13:41Z", "is_private": false, "text": "Created attachment 29568\nMinidumps and analysis\n\nTHe attachment includes a number of crash analysis reports and one minidump."}, {"count": 2, "tags": [], "bug_id": 54117, "attachment_id": null, "text": "Could you attach all configuration data, both registry and eventual .ini file(s)\nas well as worker properties and uri mappings?\nPlease scramble the data but in such way that string lengths remain the same as in the original in case you have some private data there.\n\nAlso there is symbol file (.pdb) for each isapi_redirect we release.\nUse the .zip file (x86_64) from \nhttp://apache.org/dist/tomcat/tomcat-connectors/jk/binaries/windows/symbols/\nand put isapi_redirect.pdb from that file along with isapi_redirect.dll.\nThis should give more detailed crash dump.\n\nYou might also check\nhttp://httpd.apache.org/dev/debugging.html\n(windows section)", "id": 163275, "time": "2012-11-08T05:21:01Z", "creator": "mturk@apache.org", "creation_time": "2012-11-08T05:21:01Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 54117, "attachment_id": 29569, "text": "Created attachment 29569\nConfiguration files\n\nAttachment contains configuration (files and registry) and previous crash dump analysed with symbol file. There are no ini files. Will look at capturing full dumps.", "id": 163276, "time": "2012-11-08T05:59:21Z", "creator": "werner.peenz@charteredaccountants.com.au", "creation_time": "2012-11-08T05:59:21Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 54117, "attachment_id": null, "is_private": false, "id": 163279, "time": "2012-11-08T06:50:58Z", "creator": "mturk@apache.org", "creation_time": "2012-11-08T06:50:58Z", "text": "Great. Thanks. This dump makes a bit more sense.\nActually the best would be to use real debugger which (AFAIK) comes with Visual Studio, but it seems they can be installed standalone.\nhttp://msdn.microsoft.com/en-us/windows/hardware/gg463009.aspx"}, {"count": 5, "tags": [], "bug_id": 54117, "attachment_id": null, "text": "With debug log turned on there should a line(s)\n... Number of headers is = 45\n... Header[number] [name] = [value]\n\n\nThis all looks like either some protocol error or buffer overflow.\nTo which app server you are connecting (exact version pls.)?\n\nAlso could you try with larger message buffer size?\nworker.ajp13w.max_packet_size=65536 and packetSize=\"65536\" in server.xml for AJP connector", "id": 163281, "time": "2012-11-08T07:58:44Z", "creator": "mturk@apache.org", "creation_time": "2012-11-08T07:58:44Z", "is_private": false}, {"count": 6, "tags": [], "text": "Created attachment 29571\niis 1.2.38-dev\n\nTry with this file, I added a patch that should at least trace the problem for the given crash dump. It zeroes out the header value pointers in case something invalid comes in.", "attachment_id": 29571, "id": 163288, "creator": "mturk@apache.org", "time": "2012-11-08T11:46:17Z", "bug_id": 54117, "creation_time": "2012-11-08T11:46:17Z", "is_private": false}, {"count": 7, "tags": [], "creator": "werner.peenz@charteredaccountants.com.au", "attachment_id": null, "is_private": false, "id": 163297, "time": "2012-11-09T04:31:41Z", "bug_id": 54117, "creation_time": "2012-11-09T04:31:41Z", "text": "Changed the message buffer sizes to 65536 (we move application to new servers in the past week - had same issue on previous servers where we did change the message buffer size to 65536, without success).\n\nDebug log kills performance, had it on briefly to get:\n\nNumber of headers is = 4\nHeader[0] [Set-Cookie] = [JSESSIONID...\nHeader[1] [Cache-Control] = [No-Cach...\nHeader[2] [Content-Type] = [text/htm...\nHeader[3] [Content-Length] = [21837]\n\nNumber of headers is = 5\nHeader[0] [Accept-Ranges] = [bytes]\nHeader[1] [ETag] = [W/\"13968-1352262....\nHeader[2] [Last-Modified] = [Wed, 07...\nHeader[3] [Content-Type] = [text/jav...\nHeader[4] [Content-Length] = [13968]\n\nNumber of headers is = 3\nHeader[0] [Cache-Control] = [No-Cach...\nHeader[1] [Content-Type] = [text/htm...\nHeader[2] [Content-Length] = [24471]\n\nIs it worth getting this data from our UAT environment (where we have not had these crashes)?\n\nHave deployed 1.2.38-dev (does this require log_level=trace - as mentioned it killed performance?), will attached results after next crash."}, {"count": 8, "tags": [], "creator": "werner.peenz@charteredaccountants.com.au", "text": "Created attachment 29574\nScreen shot of Visual Studio debug session\n\nNot sure whether it's usefull but attached screen shots of debug session of existing crash dumps in Visual Studio.", "id": 163298, "time": "2012-11-09T04:37:40Z", "bug_id": 54117, "creation_time": "2012-11-09T04:37:40Z", "is_private": false, "attachment_id": 29574}, {"count": 9, "tags": [], "bug_id": 54117, "attachment_id": null, "text": "So the latest crash dump is from 1.2.38-dev, correct?\n... and the screen shots make no difference. Pls attach crash dump file since it now matches the sources from trunk.\n\nInspecting the previous crash data I see that 'Number of headers is = 45' but that data in not in the log files, so either something gets corrupted or crash happens so fast that log is not written.\n\nI'll create a new build with some current [debug] messages turned to info so that your performance doesn't suffer and that we get logged only the interesting part.\nHowever this won't happen before Monday. Willing to give it a shot?", "id": 163300, "time": "2012-11-09T08:59:46Z", "creator": "mturk@apache.org", "creation_time": "2012-11-09T08:59:46Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 54117, "attachment_id": 29579, "text": "Created attachment 29579\nCrash 20121109 1.2.38.dev\n\nPrevious upload was still for 1.2.37.0. This dump+analysis attachment is for 1.2.38 dev.\nLooks like nothing is written to the logs related to crash, only starting and initialized messages when the process starts again.\nYes, will give another build with debug messages a shot.\n\nIn answer to a previous question, we're connecting to Tomcat 6.0.29.", "id": 163339, "time": "2012-11-10T05:20:09Z", "creator": "werner.peenz@charteredaccountants.com.au", "creation_time": "2012-11-10T05:20:09Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 54117, "attachment_id": 29593, "is_private": false, "id": 163405, "time": "2012-11-13T04:17:47Z", "creator": "werner.peenz@charteredaccountants.com.au", "creation_time": "2012-11-13T04:17:47Z", "text": "Created attachment 29593\nheaders\n\nThe attachment shows the 46 header values when the process crashes obtained from a full crash dump and debugging with Visual Studio using the 1.2.38 pdb, but 1.2.37 jk_ajp.common.c file. The last of the headers is at address 0x0000000000000000.\nHope this helps."}, {"count": 12, "tags": [], "text": "This is huge help, thanks!\n\nSeems your application is faulty, but that shouldn't cause the crash. Let me try to fix that and I'll attach a new .dll", "attachment_id": null, "id": 163406, "creator": "mturk@apache.org", "time": "2012-11-13T05:49:48Z", "bug_id": 54117, "creation_time": "2012-11-13T05:49:48Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 54117, "attachment_id": 29594, "text": "Created attachment 29594\nisapi_redirect-1.2.38-dev-v2-win64\n\nPlease try with this version. It should have more reliable header parser", "id": 163408, "time": "2012-11-13T06:27:35Z", "creator": "mturk@apache.org", "creation_time": "2012-11-13T06:27:35Z", "is_private": false}, {"count": 14, "tags": [], "creator": "werner.peenz@charteredaccountants.com.au", "attachment_id": null, "is_private": false, "id": 163437, "time": "2012-11-14T05:03:19Z", "bug_id": 54117, "creation_time": "2012-11-14T05:03:19Z", "text": "This version was installed today, and there have been no worker process crashes since. Need another 2 days without issue (as we've gone without a crash for a day in the past) to declare victory, but looks promising.\n\n(In reply to comment #13)\n> Created attachment 29594 [details]\n> isapi_redirect-1.2.38-dev-v2-win64\n> \n> Please try with this version. It should have more reliable header parser"}, {"count": 15, "tags": [], "creator": "werner.peenz@charteredaccountants.com.au", "attachment_id": null, "id": 163542, "time": "2012-11-19T22:02:28Z", "bug_id": 54117, "creation_time": "2012-11-19T22:02:28Z", "is_private": false, "text": "We've experienced no crashes since using the 2nd dev version, so this issue appears to be resolved.\n\nSince this was a targeted dev version, should we upgrade to the general release of 1.2.38 when it becomes available, and when is that expected to be?\n\nYour assistance to a speedy resolution the past 2 weeks is much appreciated."}, {"count": 16, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 193954, "time": "2016-09-23T13:35:12Z", "bug_id": 54117, "creation_time": "2016-09-23T13:35:12Z", "text": "Mladen - Ping.\n\nIt has been rather a long time but do you happen to remember what you fixed for this or, better still, do you still have the patch? I couldn't find a relevant change in the svn history so I am wondering if the change was committed to svn or not."}]