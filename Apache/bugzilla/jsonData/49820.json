[{"text": "Created attachment 25934\nFixed version\n\nWhen you ParagraphProperties.getLvl() for any style sheet, that is a part of the outline, it returns a value from 0 to 8 for Heading 1 to Heading 9. But for normal styles it returns 0, which makes it indistinguishable from each other.\n\nThe MICROSOFT OFFICE WORD 97-2007 BINARY FILE FORMAT SPECIFICATION states the following:\n\n  The standard PAP is all zeros except: \n  fWidowControl  1 \n  fMultLineSpace  1 \n  dyaLine  240 twips \n  Lvl  9\n\nI solved this problem by changing the initial value for property org.apache.poi.hwpf.model.types.PAPAbstractType#field_58_lvl to 9. After this, I can read the same outline levels as Word shows me: getLvl() returns values from 0 to 9; 9 is Body text and 0..8 are outline levels 1..9.\n\nAttached is a modified version of PAPAbstractType.java, which also alters the initial value for the property field_17_fWidowControl according to specification. Properties for fMultLineSpace and dyaLine are not there, it is probably for some newer version of Word.", "tags": [], "bug_id": 49820, "attachment_id": 25934, "count": 0, "id": 139437, "time": "2010-08-25T07:16:27Z", "creator": "a6537691@bofthew.com", "creation_time": "2010-08-25T07:16:27Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 49820, "attachment_id": null, "text": "Any chance you could do a quick unit test, which shows it getting the correct values for the headings even after the change, along with then getting the correct one for normal text with the change?", "id": 139441, "time": "2010-08-25T07:46:33Z", "creator": "apache@gagravarr.org", "creation_time": "2010-08-25T07:46:33Z", "is_private": false}, {"count": 2, "attachment_id": null, "bug_id": 49820, "text": "I studied the problem further and found several other problems:\n\n- the ParagraphSprmUncompressor class sets value for operation 0x40 incorrectly to ilvl instead of to lvl, according to binary format specification\n\n- the lvl in operation 0x40 should be set always, not only when istd is between 1..9. The binary format specification says that, but in Word you can set outline level for any paragraph except Heading 1..9, and with this condition in place POI does not see it. When it is commented out, everything seems OK, see testcase.\n\n- I added the getLvl() method to Paragraph, which enables to read outline level at the paragraph level.\n\nAttached is the JUnit testcase. This is its output in current version (3.7b2, style level shown in place of paragraph level, as current version does not support reading level at paragraph level):\nStyle level: 0, paragraph level: 0, text: Heading 1\nStyle level: 0, paragraph level: 0, text: Heading 2\nStyle level: 0, paragraph level: 0, text: Heading 3\nStyle level: 0, paragraph level: 0, text: Heading 4\nStyle level: 0, paragraph level: 0, text: Heading 5\nStyle level: 0, paragraph level: 0, text: Heading 6\nStyle level: 0, paragraph level: 0, text: Heading 7\nStyle level: 0, paragraph level: 0, text: Heading 8\nStyle level: 0, paragraph level: 0, text: Heading 9\nStyle level: 0, paragraph level: 0, text: Body text with unchanged outline level\nStyle level: 0, paragraph level: 0, text: Body text with outline level changed to Level 1\nStyle level: 0, paragraph level: 0, text: Body text with outline level changed to Level 5\n\n\nThis is the output after applying attached patches to version 3.7b2:\nStyle level: 0, paragraph level: 0, text: Heading 1\nStyle level: 1, paragraph level: 1, text: Heading 2\nStyle level: 2, paragraph level: 2, text: Heading 3\nStyle level: 3, paragraph level: 3, text: Heading 4\nStyle level: 4, paragraph level: 4, text: Heading 5\nStyle level: 5, paragraph level: 5, text: Heading 6\nStyle level: 6, paragraph level: 6, text: Heading 7\nStyle level: 7, paragraph level: 7, text: Heading 8\nStyle level: 8, paragraph level: 8, text: Heading 9\nStyle level: 9, paragraph level: 9, text: Body text with unchanged outline level\nStyle level: 9, paragraph level: 0, text: Body text with outline level changed to Level 1\nStyle level: 9, paragraph level: 4, text: Body text with outline level changed to Level 5\n\n\nSpecification used: http://download.microsoft.com/download/0/B/E/0BE8BDD7-E5E8-422A-ABFD-4342ED7AD886/Word97-2007BinaryFileFormat(doc)Specification.pdf", "id": 139485, "time": "2010-08-26T02:12:05Z", "creator": "a6537691@bofthew.com", "creation_time": "2010-08-26T02:12:05Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "creator": "a6537691@bofthew.com", "text": "Created attachment 25946\nPatched files and test case", "id": 139486, "time": "2010-08-26T02:17:00Z", "bug_id": 49820, "creation_time": "2010-08-26T02:17:00Z", "is_private": false, "attachment_id": 25946}, {"count": 4, "tags": [], "creator": "a6537691@bofthew.com", "text": "I found a mistake in my patch. I added the initial values to PAPAbstractType, but they already were in ParagraphProperties's constructor. But the initial value for lvl was incorrectly assigned to ilvl (which are two different properties) - that is the problem to be fixed.\n\nI will attach new patch. Please apply the patch to version 3.7 so we could use the final version without patching.", "id": 139750, "time": "2010-09-08T03:00:31Z", "bug_id": 49820, "creation_time": "2010-09-08T03:00:31Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 49820, "text": "Created attachment 26000\nPatched files and test case version 2", "id": 139751, "attachment_id": 26000, "creator": "a6537691@bofthew.com", "creation_time": "2010-09-08T03:01:39Z", "time": "2010-09-08T03:01:39Z", "is_private": false}, {"count": 6, "tags": [], "creator": "a6537691@bofthew.com", "text": "Created attachment 26020\nDiff file to be applied to repository\n\nThis is a patch created by following the rules in the POI Contribution Guidelines, along with a testcase. It is created upon the current repository head version. Please check it and possibly merge it.", "id": 139846, "time": "2010-09-13T05:14:58Z", "bug_id": 49820, "creation_time": "2010-09-13T05:14:58Z", "is_private": false, "attachment_id": 26020}, {"count": 7, "attachment_id": 26021, "bug_id": 49820, "text": "Created attachment 26021\nNew files not included in the diff", "id": 139847, "time": "2010-09-13T05:15:48Z", "creator": "a6537691@bofthew.com", "creation_time": "2010-09-13T05:15:48Z", "tags": [], "is_private": false}, {"count": 8, "tags": [], "creator": "apache@gagravarr.org", "text": "Thanks, patch applied in r998897.", "id": 139972, "time": "2010-09-20T07:46:02Z", "bug_id": 49820, "creation_time": "2010-09-20T07:46:02Z", "is_private": false, "attachment_id": null}]