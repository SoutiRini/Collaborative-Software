[{"count": 0, "tags": [], "bug_id": 52196, "attachment_id": null, "text": "request_rec->connection->current_thread is a new feature, \nand every request_rec->connection->current_thread should have different pool, but now with a same pool,\n\nThis is need to fix.\n\nI fix this, Please see below\n---------------------------------------------------\n===================================================================\n--- mpm/winnt/child.c   (\u7248\u672c 1202642)\n+++ mpm/winnt/child.c   (\u5de5\u4f5c\u526f\u672c)\n@@ -754,9 +754,11 @@\n     int rc;\n     conn_rec *c;\n     apr_int32_t disconnected;\n+    apr_pool_t* self;\n\n     osthd = apr_os_thread_current();\n-    apr_os_thread_put(&thd, &osthd, pchild);\n+    apr_pool_create(&self,pchild);\n+    apr_os_thread_put(&thd, &osthd, self);\n\n     while (1) {\n\n@@ -858,6 +860,7 @@\n\n     ap_update_child_status_from_indexes(0, thread_num, SERVER_DEAD,\n                                         (request_rec *) NULL);\n+    apr_pool_destroy(self);\n\n     return 0;\n }", "id": 151548, "time": "2011-11-16T12:45:52Z", "creator": "zhaozg@gmail.com", "creation_time": "2011-11-16T12:45:52Z", "is_private": false}, {"count": 1, "tags": [], "creator": "trawick@apache.org", "text": "This appears to affect all MPMs.\nThe limitation is that certain APR thread functions can't be used, as the pool is shared between threads.\nmod_lua in particular has a method to retrieve the pool of the thread, which would always be pchild (almost certainly not what the caller expected).", "id": 161516, "time": "2012-08-19T21:50:42Z", "bug_id": 52196, "creation_time": "2012-08-19T21:50:42Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 52196, "attachment_id": null, "text": "I had already noticed a thread-safety issue in the WinNT MPM code you modified, and the fix for that solves the problem you reported for this MPM without creating another pool.  (The code you posted didn't fix the thread-safety issue.)\n\nHere is that revision:\n\nhttp://svn.apache.org/viewvc?view=revision&revision=1374874\n\nIn order to justify changing the other MPMs for this problem report, I suggest that you add a comment describing the problem you face because the apr_thread_t structures are not associated with unique pools.  Thanks!", "id": 161519, "time": "2012-08-19T22:43:23Z", "creator": "trawick@apache.org", "creation_time": "2012-08-19T22:43:23Z", "is_private": false}]