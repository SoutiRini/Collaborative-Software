[{"count": 0, "tags": [], "bug_id": 45292, "attachment_id": null, "id": 118037, "time": "2008-06-26T14:44:23Z", "creator": "jrobinson852@yahoo.com", "creation_time": "2008-06-26T14:44:23Z", "is_private": false, "text": "If I serve files that reside on a SMB file share via apache 2.2.3 (or 2.2.7 built from source) on a fully updated CentOS 5, files over 64K are truncated to 64K when sent. \n\nApache does not report any errors (in fact the access_log shows the correct number of bytes being sent) but clients receive only 64k. (Tested with multiple browsers and OS'es, including using wget on the machine itself).\n\nI can provide any details requested, this is a pretty serious bug which I'm surprised to find. It took a while to hunt down as it was not expected!"}, {"count": 1, "text": "Changes \"Hardware\" to reflect that the server is on HP hardware.", "creator": "jrobinson852@yahoo.com", "is_private": false, "id": 118038, "time": "2008-06-26T14:45:34Z", "bug_id": 45292, "creation_time": "2008-06-26T14:45:34Z", "tags": [], "attachment_id": null}, {"count": 2, "tags": [], "text": "does this happen with \"EnableSendfile Off\" ?", "is_private": false, "id": 118040, "creator": "trawick@apache.org", "time": "2008-06-26T14:49:42Z", "bug_id": 45292, "creation_time": "2008-06-26T14:49:42Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 45292, "text": "Will test tomorrow and let you know.", "id": 118044, "attachment_id": null, "creator": "jrobinson852@yahoo.com", "creation_time": "2008-06-26T14:59:10Z", "time": "2008-06-26T14:59:10Z", "is_private": false}, {"count": 4, "tags": [], "text": "yes, Jeff, using EnableSendfile Off fixed the issue. \n\nThanks!\n\nSo the bug is (arguably) that apache didn't even know! \n\nIt logged no error, and furthermore, logged that all the bytes of the file were successfully sent. \n\nShould I file this as a new bug, \"Apache doesn't notice files over 64KB are truncated when using sendfile on SMB mounted filesystems?\" Let me know (alternately, perhaps it's a bug against sendfile())", "is_private": false, "id": 118068, "creator": "jrobinson852@yahoo.com", "time": "2008-06-27T09:04:33Z", "bug_id": 45292, "creation_time": "2008-06-27T09:04:33Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 45292, "attachment_id": null, "id": 118070, "time": "2008-06-27T09:19:06Z", "creator": "trawick@apache.org", "creation_time": "2008-06-27T09:19:06Z", "is_private": false, "text": "Historically, these issues have been declared to OS problems.\n\nIf you collect an strace showing the use of sendfile for the failing responses, POSSIBLY somebody will have time/inclination to look at it further and see if httpd/apr is getting any unexpected feedback from the syscall.\n"}, {"count": 6, "tags": [], "bug_id": 45292, "text": "Thanks for the response, Jeff.\n\nI'm wondering if apache is doing the right thing with the sendfile() return value. The sendfile() docs say: \n\n\"...If the transfer was successful, _the number of bytes written to out_fd is returned_.  On error, -1 is returned, and errno is set appropriately.\"\n\nPerhaps in this case sendfile isn't returning an error, but is returning a short byte count, and apache doesn't notice? (Not sure if that's what it's supposed to do, but...) \n\nMy reading of srclib/apr/network_io/unix/sendrecv.c suggests that. \n\nI will test what sendfile() is actually returning when serving files from the SMB server in the case without \"EnableSendfile Off\" if you want-- let me know.\n", "id": 118071, "attachment_id": null, "creator": "jrobinson852@yahoo.com", "creation_time": "2008-06-27T09:38:30Z", "time": "2008-06-27T09:38:30Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 45292, "attachment_id": null, "id": 118072, "time": "2008-06-27T10:04:25Z", "creator": "trawick@apache.org", "creation_time": "2008-06-27T10:04:25Z", "is_private": false, "text": "have a look at sendfile_it_all() in server/core.c; we expect partial writes (\"short byte count\"); with a look at that code and strace, maybe you can determine if we're getting accurate feedback from sendfile(), and if we're doing the right thing with it; and plz post the pertinent part of the trace here if you can\n"}, {"count": 8, "tags": [], "text": "Sendfile and non-local filesystems are a documented issue.", "is_private": false, "id": 132986, "creator": "nick@webthing.com", "time": "2009-12-20T15:26:34Z", "bug_id": 45292, "creation_time": "2009-12-20T15:26:34Z", "attachment_id": null}]