[{"count": 0, "tags": [], "bug_id": 60891, "attachment_id": null, "is_private": false, "id": 197835, "time": "2017-03-20T20:17:38Z", "creator": "tallison@mitre.org", "creation_time": "2017-03-20T20:17:38Z", "text": "While trying to write an example of TestSecureTempZip's protectedTempZip for the new XLSB parser, I got an exception which I tracked down to LittleEndianInputStream's readFully, doesn't actually read fully; rather, it makes a single call to read and then checks if that hit EOF.  \n\nWhen I fixed it (i.e. copied/pasted from commons-io IOUtils readFully) to read until the length was hit or an EOF was hit, the example worked with an encrypted xlsb.  All unit (including stress) tests pass.\n\nAny objections to fixing this?  \n\nOr, does this subtly change the expectations of readFully, and I should leave this as is?\n\nThis seems like such a core component, we should have found this earlier?!"}, {"count": 1, "tags": [], "bug_id": 60891, "is_private": false, "text": "This was the stacktrace I got before the fix:\n\njava.lang.RuntimeException: Unexpected end-of-file\n\n\tat org.apache.poi.util.LittleEndianInputStream.checkEOF(LittleEndianInputStream.java:122)\n\tat org.apache.poi.util.LittleEndianInputStream.readFully(LittleEndianInputStream.java:134)\n\tat org.apache.poi.util.LittleEndianInputStream.readFully(LittleEndianInputStream.java:128)\n\tat org.apache.poi.xssf.binary.XSSFBParser.readNext(XSSFBParser.java:93)\n\tat org.apache.poi.xssf.binary.XSSFBParser.parse(XSSFBParser.java:62)\n\tat org.apache.poi.xssf.binary.XSSFBSharedStringsTable.readFrom(XSSFBSharedStringsTable.java:82)\n\tat org.apache.poi.xssf.binary.XSSFBSharedStringsTable.<init>(XSSFBSharedStringsTable.java:69)\n\tat org.apache.poi.xssf.extractor.XSSFBEventBasedExcelExtractor.getText(XSSFBEventBasedExcelExtractor.java:120)\n\tat org.apache.poi.poifs.crypt.TestSecureTempZip.protectedXLSBZip(TestSecureTempZip.java:114)", "id": 197836, "time": "2017-03-20T20:29:54Z", "creator": "tallison@mitre.org", "creation_time": "2017-03-20T20:29:54Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 60891, "is_private": false, "count": 2, "id": 197837, "time": "2017-03-20T20:42:24Z", "creator": "dominik.stadler@gmx.at", "creation_time": "2017-03-20T20:42:24Z", "text": "+1 for fixing it. \n\nThe fact that read() might not read as much data as requested manifests itself only very rarely, mostly when you read larger chunks than what the OS buffers or similar. I saw this in a number of other places already where it also went undetected for a long time before causing hard to detect problems.\n\nIf the change causes other code-parts to misbehave I think we should rather fix those as well, unit tests and large-scale tests ought to cover most cases anyway nowadays."}, {"count": 3, "tags": [], "text": "Thank you, Dominik.\n\nr1787846", "attachment_id": null, "bug_id": 60891, "id": 197841, "time": "2017-03-20T20:49:05Z", "creator": "tallison@mitre.org", "creation_time": "2017-03-20T20:49:05Z", "is_private": false}]