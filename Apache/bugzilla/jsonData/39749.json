[{"count": 0, "tags": [], "bug_id": 39749, "text": "It appears that somewhere between 2.0.48 and 2.0.58 the setting of the Content-\nDisposition to set the file name for content returned broke.  We are using \nTomcat 5.0.28 and modJK 1.2.15.  I have put the example servlet code below.  \nWhen you run the URL the browser pops up with the file name \"TestServlet.doc\" \ninstead of \"test_file_name.doc\".  I don't believe this to be a Tomcat issue \nsince it works with HTTP 2.0.48 and not with HTTP 2.0.58.\n\nI ran http://dev.servicebench.com/rbaily/servlet/TestServlet on my system with \nthis test servlet.\n\nPlease let me know if there is anything I can do to clarify or help.  Thanks!\n\n/*\n * Created on Jun 7, 2006\n *\n * TODO To change the template for this generated file go to\n * Window - Preferences - Java - Code Style - Code Templates\n */\npackage com.servicebench.webside.servlet;\n\nimport java.io.IOException;\n\nimport javax.servlet.ServletException;\nimport javax.servlet.ServletOutputStream;\nimport javax.servlet.http.*;\n\n/**\n * @author rbaily\n *\n * TODO To change the template for this generated type comment go to\n * Window - Preferences - Java - Code Style - Code Templates\n */\npublic class TestServlet extends HttpServlet {\n\n\tpublic void doGet(HttpServletRequest req, HttpServletResponse res)\n\tthrows ServletException, IOException\n\t{\n\t\tdoPost(req, res);\n\t}\n\n\tpublic void doPost(HttpServletRequest req, HttpServletResponse res)\n\tthrows ServletException, IOException\n\t{\n\t\tres.setContentType( \"application/msword\" );\n\t\tres.setContentLength( 20 );\n\t\t// set up file name\n\t\tString fileName = \"filename=\\\"test_file_name.doc\\\"\";\nSystem.out.println( \"filename=\" + fileName );\t\t\t\t\n\t\tres.setHeader( \"Content-Disposition\", \"attachment;\" + \nfileName );\n\t\tres.setHeader( \"Expires\", \"0\" );\n\t\tres.setHeader( \"Cache-Control\", \"must-revalidate, post-\ncheck=0, pre-check=0\" );\n\t\tServletOutputStream output = res.getOutputStream();\nSystem.out.println( \"about to write\" );\t\t\t\t\n\t\toutput.print( \"012345678900987654321\" );\n\t\toutput.flush();\n\t\toutput.close();\n\t}\n\t\n}", "id": 89884, "time": "2006-06-07T15:17:47Z", "creator": "rbaily@servicebench.com", "creation_time": "2006-06-07T15:17:47Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 39749, "attachment_id": null, "id": 89947, "time": "2006-06-08T11:12:05Z", "creator": "rbaily@servicebench.com", "creation_time": "2006-06-08T11:12:05Z", "is_private": false, "text": "It appears that this was introduced in 2.0.49.  This morning I built and \ninstalled 2.0.49 and had the same issue while using 2.0.48 does not.  I looked \nat the change list and didn't see anything obvious that looked related."}, {"count": 2, "tags": [], "text": "I looked through 2.0.48->2.0.49 changes and am stumped.\n\nI suggest you discuss with the Tomcat folks which web server behavior inflences\nthe generation of that header field.", "is_private": false, "id": 89962, "creator": "trawick@apache.org", "time": "2006-06-08T16:48:52Z", "bug_id": 39749, "creation_time": "2006-06-08T16:48:52Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 39749, "attachment_id": null, "text": "A similar application does work in my environment. Please provide the following\ninformation:\n\n- Browser you use. Especially please try with both IE and Firefox.\n- Please capture the HTTP conversation either with a tool like livehttpheaders\nfor Firefox or provide a network sniff of the request and the response.", "id": 89968, "time": "2006-06-08T19:28:37Z", "creator": "rpluem@apache.org", "creation_time": "2006-06-08T19:28:37Z", "is_private": false}, {"count": 4, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "is_private": false, "id": 89969, "time": "2006-06-08T19:29:56Z", "bug_id": 39749, "creation_time": "2006-06-08T19:29:56Z", "text": "Forgot one thing: Please provide a network sniff with 2.0.48 and one with a\nlater version >= 2.0.49 where it does not work as expected."}, {"count": 5, "tags": [], "bug_id": 39749, "text": "Ok, thanks for the push in this direction.  I've done more research and seem \nto be at the root of the problem which looks like it was a combination of \nconfiguration mistake on my part and IE behavior.  I apologize now if I've \nwasted anyone's time.\n\nHere are snapshots using tcpdump for 2.0.48 and 2.0.58.\n\nDate: Fri, 09 Jun 2006 01:43:08 GMT\nServer: Apache/2.0.58 (Unix) mod_ssl/2.0.58 OpenSSL/0.9.7d mod_jk/1.2.15\nContent-Disposition: attachment;filename=\"test_file_name.xls\"\nExpires: 0\nCache-Control: must-revalidate, post-check=0, pre-check=0\nVary: Accept-Encoding,User-Agent\nContent-Encoding: gzip\nKeep-Alive: timeout=15, max=100\nConnection: Keep-Alive\nTransfer-Encoding: chunked\nContent-Type: application/vnd.ms-excel\n\na\n..........\n\n21:38:10.448716 IP devbox2.servicebench.com.http > \ncheetah.servicebench.com.2156: P 1:421(420) ack 455 win 6432\nE....)@.@.x[\n..w\n../.P.l...i=...P.. ....HTTP/1.1 200 OK\nDate: Fri, 09 Jun 2006 01:38:10 GMT\nServer: Apache/2.0.48 (Unix) mod_ssl/2.0.48 OpenSSL/0.9.7d mod_jk/1.2.15\nContent-Disposition: attachment;filename=\"test_file_name.xls\"\nExpires: 0\nCache-Control: must-revalidate, post-check=0, pre-check=0\nContent-Length: 20\nVary: User-Agent\nKeep-Alive: timeout=15, max=100\nConnection: Keep-Alive\nContent-Type: application/vnd.ms-excel\n\n0\n12345678900987654321\n\nI have the mod_deflate module active.  So what happened is that our \nconfiguration had the regex in there for IE (BrowserMatch \\bMSIE !no-gzip !\ngzip-only-text/html) which according to some other text did not work due to a \nbug in mod_setenvif up to 2.0.48.  So as you can see from the captures the \ncontent was not being compressed in 2.0.48 but was in any version after due to \nthe mod_setenvif fix.  I did find that this does work for Firefox even with \nthe compression.  So it appears that there is an ongoing issue with the way \nthat IE handles the content-disposition when the result is compressed.\n\nSo I don't know if there is a good way to document this for future reference \nfor other.  I'll see if I can do anything to start the Micorsoft machine in \nmotion if that is even possible.  Again, sorry if this wasted anyone's time.", "id": 89975, "time": "2006-06-09T02:23:11Z", "creator": "rbaily@servicebench.com", "creation_time": "2006-06-09T02:23:11Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "creator": "rpluem@apache.org", "attachment_id": null, "id": 90011, "time": "2006-06-09T15:10:56Z", "bug_id": 39749, "creation_time": "2006-06-09T15:10:56Z", "is_private": false, "text": "Thanks for feedback. So I mark the report as invalid. I currently have no good\nidea where to place this information, but it would be very kind of you if you\ncould add any further information regarding this problem just to this report. So\nonce we have found a good place to store this information we can take it from\nhere and it does not get lost. Furthermore other users can search bugzilla by\nits own search capabilities or via a search engine such they possibly get this\ninformation."}, {"count": 7, "tags": [], "bug_id": 39749, "attachment_id": null, "id": 90353, "time": "2006-06-19T13:28:04Z", "creator": "rbaily@servicebench.com", "creation_time": "2006-06-19T13:28:04Z", "is_private": false, "text": "I have been unable to find any Microsoft realted information on this at the \npresent time.  Sorry."}]