[{"count": 0, "tags": [], "text": "Overview\nSuppose there is an web application A that uses a database and registers a Driver with the java.sql.DriverManager, and a web application B that doesn't use a database but has a jar file in its WEB-INF/lib directory that contains the same Driver. Suppose you undeploy web application B.\nRunning the org.apache.catalina.loader.JdbcLeakPrevention class will actually register the Driver and leave it loaded! The cause is the way the DriverManager checks whether a ClassLoader has permission to load the Driver. It does that by calling Class.forName with the ClassLoader, which will load the class if the class has not been loaded by that ClassLoader. Loading a Driver class triggers the Driver to register itself. \n\nSteps to reproduce\nCreate two web applications: one which registeres a Driver with the java.sql.Drivermanager and one that uses no database. Put the jar containing the Driver class in the WEB-INF/lib directory of both applications. Deploy both in Tomcat. Then undeploy the latter one.\nInspect catalina.out, verify that there are no messages about a JDBC Driver being forcibly unregistered.\nCreate a memory dump using jmap and inspect the dump using jhat.\n\nActual results\nThe WebappClassLoader for the latter application is still present. Its \"rootset references\" page shows two reference chains from class java.sql.DriverManager:\nStatic reference from java.sql.DriverManager.readDrivers (from class java.sql.DriverManager) :\n--> java.util.Vector@0xeb6eb3f0 (24 bytes) (field elementData:)\n--> [Ljava.lang.Object;@0xeb6eb408 (20 bytes) (Element 2 of [Ljava.lang.Object;@0xeb6eb408:)\n--> java.sql.DriverInfo@0xeb6eb420 (20 bytes) (field driverClass:)\n--> class oracle.jdbc.driver.OracleDriver (84 bytes) (??:)\n--> org.apache.catalina.loader.WebappClassLoader@0xeb5a84a0 (157 bytes) \n\nand a similar one from java.sql.DriverManager.writeDrivers.\n\nExpected results\nThe WebappClassLoader is not present in memory anymore.\n\nBuild date & platform\nDownloaded Core tar.gz from http://tomcat.apache.org/download-70.cgi", "is_private": false, "id": 138735, "creation_time": "2010-07-29T09:31:33Z", "time": "2010-07-29T09:31:33Z", "creator": "ArjenCornelis.Knibbe@Getronics.com", "bug_id": 49667, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 49667, "attachment_id": null, "id": 138737, "time": "2010-07-29T10:08:42Z", "creator": "ArjenCornelis.Knibbe@Getronics.com", "creation_time": "2010-07-29T10:08:42Z", "is_private": false, "text": "Before making a memory dump, you must wait an hour."}, {"count": 2, "tags": [], "bug_id": 49667, "attachment_id": null, "text": "I don't see this error with the latest 7.0.x code. Please test with 7.0.2 and if you still see the issue please provide sample web applications and the exact steps to reproduce from a clean 7.0.2 install.", "id": 139425, "time": "2010-08-24T16:51:04Z", "creator": "markt@apache.org", "creation_time": "2010-08-24T16:51:04Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 49667, "attachment_id": 25935, "id": 139438, "time": "2010-08-25T07:37:16Z", "creator": "ArjenCornelis.Knibbe@Getronics.com", "creation_time": "2010-08-25T07:37:16Z", "is_private": false, "text": "Created attachment 25935\nDemo for bug 49667\n\nThis tar/zip contains a minimal implementation of the A application as mentioned in the bug Overview. Application B will follow. Both applications contain the MySQL JdbC jar file. A pplication A loads the Driver on startup, B doesn' t.\n\nStarting with a clean Tomcat (no entries in webapps), the bug can be reproduces as follows:\n* copy A.war into webapps, wait until catalina.out shows application A deployed.\n* copy B.war into webapps, wait until catalina.out shows application B deployed.\n* Remove B.war from webapps, wait until catalina.out shows context /B undeployed. Verify that no warning is issued about a Driver being forcilbly unloaded.\n* Optionally, wait an hour.\n* Trigger a memory dump using jmap, inspect the dump using jhat.\n* in the All Classes excluding plathform screen, verify that class com.snt.connect.demo.B.servlet.Servlet is still there.\n* Click on the class, then click on its class loader.\n* Click on Other Queries/Exclude weak refs, verify that class java.sql.DriverManager is in the System class references, and that class com.mysql.jdbc.Driver is in that reference chain."}, {"count": 4, "tags": [], "creator": "ArjenCornelis.Knibbe@Getronics.com", "attachment_id": 25936, "text": "Created attachment 25936\nDemo for bug 49667 - Application B\n\nAnd here is application B. It had to be uploaded separately, since Bugzilla accepts only 1000Kb as attachment :-(", "id": 139440, "time": "2010-08-25T07:39:02Z", "bug_id": 49667, "creation_time": "2010-08-25T07:39:02Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 49667, "text": "I added attachments and a description how to repoduce the bugs as requested by Mark Thomas (comment 2). See comments 3 and 4. Tested with Tomcat 7.0.2 and jdk 6.0.21 on a Solaris machine.", "id": 140347, "time": "2010-10-01T05:19:17Z", "creator": "ArjenCornelis.Knibbe@Getronics.com", "creation_time": "2010-10-01T05:19:17Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "is_private": false, "id": 140351, "time": "2010-10-01T06:47:44Z", "bug_id": 49667, "creation_time": "2010-10-01T06:47:44Z", "text": "Thanks for the sample apps. I can now reproduce this. Looking at a fix now..."}, {"count": 7, "tags": [], "bug_id": 49667, "attachment_id": null, "id": 140352, "time": "2010-10-01T07:13:26Z", "creator": "markt@apache.org", "creation_time": "2010-10-01T07:13:26Z", "is_private": false, "text": "Fixed in trunk and will be included in 7.0.3 onwards.\n\nProposed for 6.0.x"}, {"count": 8, "tags": [], "bug_id": 49667, "text": "That was a quick fix Thomas! Thanks a lot.", "id": 140353, "time": "2010-10-01T07:16:52Z", "creator": "ArjenCornelis.Knibbe@Getronics.com", "creation_time": "2010-10-01T07:16:52Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 49667, "attachment_id": null, "id": 140407, "time": "2010-10-03T13:36:57Z", "creator": "markt@apache.org", "creation_time": "2010-10-03T13:36:57Z", "is_private": false, "text": "Fixed in 6.0.x and will be included in 6.0.30 onwards."}]