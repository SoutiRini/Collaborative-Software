[{"count": 0, "tags": [], "bug_id": 56274, "attachment_id": 31393, "text": "Created attachment 31393\nSample input file exhibiting the problem\n\nUpgrading from poi-3.9 to poi-3.10 caused a bug where xlsx files loaded as a template using XSSF, added with some data and written with SXSSF resulted in corrupt files.\n\nOpening the resulting files with Excel 2013 results in the following Yes/No dialog:\n\"We found a problem with some content in 'Filename.xlsx'. Do you want us to try to recover as much as we can? If you trust the source of this workbook, click Yes.\"\nClicking yes shows the recovery result dialog, with a list of repaired table*.xml files under /xl/tables in the internal excel structure.\n\nAttached is a sample input xlsx file exhibiting the problem, which can be reproduced by the following reduced test:\n\npublic static void main(String[] args) throws Exception {\n    File inputFile = new File(\"ExecutiveReportTemplate.xlsx\");\n    File outputFile = new File(\"ExecutiveReportTemplate-new.xlsx\");\n    XSSFWorkbook inputWorkbook = new XSSFWorkbook(new FileInputStream(inputFile));\n    SXSSFWorkbook outputWorkbook = new SXSSFWorkbook(inputWorkbook);\n    outputWorkbook.write(new FileOutputStream(outputFile));\n}\n\nI examined the internal xml files, and the differences seem to be in the /xl/tables/table*.xml files -\nThe tableColumn elements have the same id and dataDxfId attributes, but different name attributes:\nin poi-3.9 the name attributes correspond to the order of the columns in the template worksheet,\nin poi-3.10 the name attributes seem to be out-of-order, and one of the columns have a duplicate name.", "id": 173862, "time": "2014-03-16T15:10:42Z", "creator": "yaniv@kundas.net", "creation_time": "2014-03-16T15:10:42Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 56274, "attachment_id": 31403, "text": "Created attachment 31403\nPatch for fixing the bug (and other minor optimizations)\n\nI've located the bug XSSFTable.updateHeaders(), where the xmlFragment id is used as a cellnum - which will only be the same in the special case of adding columns to a sheet one by one, in order; inserting/moving columns will create xmlFragment ids not consistent with cell numbers.\n\nI have fixed it by using a counter (starting from firstHeaderColumn) that advances along the table columns, and then used to fetch sheet cells by their actual cellnum.\n\nThe additional minor optimizations are not related, but I deemed them appropriate while reviewing XSSFTable - if a commiter wishes to discard them for the purpose of fixing this bug, then only the changes in the updateHeaders() method should be included.", "id": 173926, "time": "2014-03-19T09:26:59Z", "creator": "yaniv@kundas.net", "creation_time": "2014-03-19T09:26:59Z", "is_private": false}, {"count": 2, "tags": [], "creator": "dominik.stadler@gmx.at", "attachment_id": null, "id": 174701, "time": "2014-04-18T15:06:06Z", "bug_id": 56274, "creation_time": "2014-04-18T15:06:06Z", "is_private": false, "text": "I tried to take a look, but unfortunately your patch changes lots of whitespaces and other unrelated things like imports and thus is hard to apply cleanly.\n\nAny chance you can produce a minimal patch with only the actually required changes? This will make it easier for others to review/apply the patch.\n\nThanks!"}, {"count": 3, "tags": [], "bug_id": 56274, "attachment_id": 31564, "is_private": false, "id": 174904, "time": "2014-04-27T10:58:11Z", "creator": "yaniv@kundas.net", "creation_time": "2014-04-27T10:58:11Z", "text": "Created attachment 31564\nPatch for fixing the bug"}, {"count": 4, "tags": [], "bug_id": 56274, "attachment_id": null, "is_private": false, "id": 174915, "time": "2014-04-28T11:24:06Z", "creator": "apache@gagravarr.org", "creation_time": "2014-04-28T11:24:06Z", "text": "Thanks for this updated patch\n\nIs there any chance you could write a short unit test, which triggers the problem on 3.10, and shows it's fixed with the patch applied? That way, we can be sure it's solved, and also be sure it remains fixed into the future!"}, {"count": 5, "tags": [], "creator": "yaniv@kundas.net", "attachment_id": 31605, "id": 175151, "creation_time": "2014-05-12T07:16:26Z", "time": "2014-05-12T07:16:26Z", "bug_id": 56274, "text": "Created attachment 31605\nUnit test for bug #56274", "is_private": false}, {"count": 6, "tags": [], "creator": "yaniv@kundas.net", "attachment_id": 31606, "text": "Created attachment 31606\nSample input file exhibiting the problem (required by unit test)\n\nThis is the sample input file for the attached unit test -\nit should be placed in the /test-data/spreadsheet/ directory of the distribution", "id": 175152, "time": "2014-05-12T07:18:39Z", "bug_id": 56274, "creation_time": "2014-05-12T07:18:39Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 56274, "attachment_id": null, "text": "Thanks, patch and unit test applied in r1596624.", "id": 175374, "time": "2014-05-21T17:08:30Z", "creator": "apache@gagravarr.org", "creation_time": "2014-05-21T17:08:30Z", "is_private": false}]