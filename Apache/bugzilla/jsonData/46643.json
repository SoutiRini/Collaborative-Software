[{"count": 0, "tags": [], "creator": "rpate@enservio.com", "is_private": false, "text": "When generating an Excel document from scratch, I am placing the number 1 in cell A1, the number 2 in cell A2, and the formula SUM(A1:A2) in cell A3.  I then shift rows 2 and 3 down and insert another row.  I then put the number 3 in newly emptied cell A2.  After writin gthis file to disk, I open the file and see the numbers and the formula correctly entered but when I change the value in cell A2 (the newly inserted cell) the sum in A4 does not update.  ANd it will not update until I enter cell A4 and hit enter.  Help please.", "id": 124548, "time": "2009-01-30T16:10:36Z", "bug_id": 46643, "creation_time": "2009-01-30T16:10:36Z", "attachment_id": null}, {"count": 1, "tags": [], "text": "Created attachment 23210\nTemplate file loaded into POI", "is_private": false, "id": 124560, "creator": "rpate@enservio.com", "time": "2009-01-31T08:38:25Z", "bug_id": 46643, "creation_time": "2009-01-31T08:38:25Z", "attachment_id": 23210}, {"count": 2, "tags": [], "bug_id": 46643, "text": "Created attachment 23211\nOutput file generated by POI", "id": 124561, "time": "2009-01-31T08:39:11Z", "creator": "rpate@enservio.com", "creation_time": "2009-01-31T08:39:11Z", "is_private": false, "attachment_id": 23211}, {"count": 3, "tags": [], "bug_id": 46643, "is_private": false, "id": 124562, "attachment_id": null, "creator": "rpate@enservio.com", "creation_time": "2009-01-31T08:53:42Z", "time": "2009-01-31T08:53:42Z", "text": "After looking at this issue, I have discovered that it is the area range reference in the sum formula that seems to be missing the change value events on cells in between the range.  The first and last cells of the range affect the formula as they should but anything in between does not affect the sum.  Attached are example documents and below are better steps to reproduce.\n\nThe following are better reproduction steps for this issue:\n1. Load the attached template into POI.\n2. Find the cell with the string 'sumofprice' and replace it with the formula SUM(A2:A3)\n3. Begin inserting rows in between the rows with the 'firstrow' and 'lastrow' tags by shifting the 'lastrow' row and the 'sumofprice' row down by 1.\n4. For each row inserted, place numeric values in the 'price' column.\n5. After two or three rows, output the file to another file name. "}, {"count": 4, "tags": [], "bug_id": 46643, "is_private": false, "id": 124582, "attachment_id": null, "creator": "apache@gagravarr.org", "creation_time": "2009-02-02T02:12:06Z", "time": "2009-02-02T02:12:06Z", "text": "Are you aware the excel caches formula values, and you need to re-calculate those cached values after altering things in poi?\n\nhttp://poi.apache.org/spreadsheet/eval.html"}, {"count": 5, "tags": [], "bug_id": 46643, "text": "I have attempted the re-calculation solution but with no avail.  If you open the output file generated, you will see the issue.  If you change any of the valus from D3 to D23 the sukm formula in D25 will not update but if you change the values in D2 or D24, the sum will update correctly.  The file was generated while using the reevaluate solution.\n\nIf I generate the same output but replace the sum formula with a daisy chain of pluses (D2+D3+D4+D5 ..... +D23+D24), the formula works correctly every time, but if I have more then 308 lines to sum, the formula grows too big.\n\nPlease help.", "id": 124585, "time": "2009-02-02T10:04:47Z", "creator": "rpate@enservio.com", "creation_time": "2009-02-02T10:04:47Z", "is_private": false, "attachment_id": null}, {"count": 6, "attachment_id": null, "bug_id": 46643, "is_private": false, "id": 124603, "time": "2009-02-02T14:54:42Z", "creator": "josh@apache.org", "creation_time": "2009-02-02T14:54:42Z", "tags": [], "text": "There is definitely something funky going on in attachment (id=23211) .  When you open it in Excel it has the behaviour you describe (updating cells within the range does not cause the formula to be automatically updated).  Another observation is that re-entering the formula (F2, <enter>) in Excel fixes the problem.  This is almost always a sign that POI has incorrectly encoded the formula tokens.\n\nBiffViewer shows the formula from the attachment (id=23211) as:\n    Ptg[0]=org.apache.poi.hssf.record.formula.Ref3DPtg [sheetIx=0 ! D2]R\n    Ptg[1]=org.apache.poi.hssf.record.formula.Ref3DPtg [sheetIx=0 ! D24]R\n    Ptg[2]=class org.apache.poi.hssf.record.formula.RangePtg.\n    Ptg[3]=org.apache.poi.hssf.record.formula.FuncVarPtg [SUM nArgs=1]V\n\nAfter re-enterring the formula and saving with Excel this becomes:\n    Ptg[0]=org.apache.poi.hssf.record.formula.MemFuncPtg [len=15]R\n    Ptg[1]=org.apache.poi.hssf.record.formula.Ref3DPtg [sheetIx=0 ! D2]R\n    Ptg[2]=org.apache.poi.hssf.record.formula.Ref3DPtg [sheetIx=0 ! D6]R\n    Ptg[3]=class org.apache.poi.hssf.record.formula.RangePtg.\n    Ptg[4]=org.apache.poi.hssf.record.formula.AttrPtg [sum ].\n\nI have done a quick test and found that the critical difference is the presence of the token tMemFunc.  If POI is modified to encode this token, Excel opens the file OK and the symptoms are gone.  I have changed the summary to reflect this.\n\n\n\n\n\n\n"}, {"count": 7, "tags": [], "text": "Initially had I thought that the different encoding of SUM (as tfuncVar(SUM) instead of tAttrSum) was causing the problem, but this did not prove to be the case.  Nonetheless, it turns out to be a small change that we should probably do in order to make POI's formula encoding more closely match that of Excel.\n", "is_private": false, "id": 124604, "creator": "josh@apache.org", "time": "2009-02-02T14:56:59Z", "bug_id": 46643, "creation_time": "2009-02-02T14:56:59Z", "attachment_id": null}, {"count": 8, "attachment_id": null, "bug_id": 46643, "is_private": false, "id": 124607, "time": "2009-02-02T15:07:01Z", "creator": "josh@apache.org", "creation_time": "2009-02-02T15:07:01Z", "tags": [], "text": "Another important detail about these tokens is that the range is encoded as two 3D cell refs with an explicit range operator.  From the instructions you provided, Step 2 is expected to produce token tArea(D2:D3).  The obvious way to get the encoding (tRef3D(D2),tRef3D(D3),tRange) is to instead call:\ncell.setCellFormula(\"SUM(InventoryDetails!D2:InventoryDetails!D3)\");\n\nI am assuming that this is much closer to the code you actually executed.\n\nIt's possible that there is some *other* bug in POI that caused the formula originally set as \"SUM(D2:D3)\" to transform into  \"SUM(InventoryDetails!D2:InventoryDetails!D3\", but this doesn't seem likely to me.  If you *did* call setCellFormula(\"SUM(D2:D3)\") while creating the attachment, that would represent another bug. If so please can you open another bugzilla with exact details of the code that will produce that error. For example:\n\ncell.setCellFormula(\"SUM(D2:D3)\");\n// do specific things to cause bug ... shift rows ?\n// Check that the formula hasn't changed:\nSystem.out.println(cell.getCellFormula()); \n// anything but \"SUM(D2:D3)\" would indicate a bug\n"}, {"count": 9, "tags": [], "bug_id": 46643, "text": "Fixed in svn r740146\n\nJunit added.", "id": 124608, "time": "2009-02-02T15:16:25Z", "creator": "josh@apache.org", "creation_time": "2009-02-02T15:16:25Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 46643, "attachment_id": null, "is_private": false, "id": 124609, "time": "2009-02-02T15:23:14Z", "creator": "rpate@enservio.com", "creation_time": "2009-02-02T15:23:14Z", "text": "I used the formula reference:\ncell.setCellFormula(\"SUM(InventoryDetails!D2:InventoryDetails!D3)\");\n\nI am new to POI and need to fix this in a production environment on the 3.2.FINAL release.  Could you show me how to do this or ppoint me in the right direct (classes to look at, etc)?\n\nThank you so much for you help."}, {"count": 11, "tags": [], "text": "(In reply to comment #10)\n> I used the formula reference:\n> cell.setCellFormula(\"SUM(InventoryDetails!D2:InventoryDetails!D3)\");\n\nCool.  So the other, hypothetical bug doesn't exist :)\n\n> I am new to POI and need to fix this in a production environment on the\n> 3.2.FINAL release.  Could you show me how to do this or ppoint me in the right\n> direct (classes to look at, etc)?\n\nYou have three main choices:\n\n(1) Work Around\nIf it's easy enough for you to change that line of code to\ncell.setCellFormula(\"SUM(D2:D3)\");\nthen you can use POI 3.2-FINAL as-is, since the problem only occurs with the explicit range operator (which is more or less ':' with a complex RHS)\n\n(2) Wait for the next POI release\nNext: 'nightly build' tomorrow, 'betawithin a week or so, or 'final' in perhaps a month.\n\n(3) Patch your local 3.2\nThe fix was quite small (details below), but I am not 100% sure if all of the other stuff needed to make this work are present in version 3.2.  For example I think bug 44675 is important (it *is* present in 3.1-beta2).  There could be other important fixes things that I am not remembering.\n\n\nThe critical change was on line 347 of this file:\nhttp://svn.apache.org/viewvc/poi/trunk/src/java/org/apache/poi/ss/formula/FormulaParser.java?annotate=729028&pathrev=740146\nDelete one line and add three:\n-                return new ParseNode(RangePtg.instance, children);\n+                ParseNode result = new ParseNode(RangePtg.instance, children);\n+                MemFuncPtg memFuncPtg = new MemFuncPtg(result.getEncodedSize());\n+                return new ParseNode(memFuncPtg, result);\n\n\nOf course in 3.2 the line number is different (326): \nhttp://svn.apache.org/viewvc/poi/tags/REL_3_2_FINAL/src/java/org/apache/poi/ss/formula/FormulaParser.java?annotate=703641\n\n\n\n\n\n\n\nhttp://svn.apache.org/viewvc/poi/trunk/src/java/org/apache/poi/ss/formula/FormulaParser.java?r1=740146&r2=740145&pathrev=740146\n\n", "is_private": false, "id": 124611, "creator": "josh@apache.org", "time": "2009-02-02T16:26:55Z", "bug_id": 46643, "creation_time": "2009-02-02T16:26:55Z", "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 46643, "is_private": false, "id": 124612, "attachment_id": null, "creator": "josh@apache.org", "creation_time": "2009-02-02T16:27:34Z", "time": "2009-02-02T16:27:34Z", "text": "(In reply to comment #7)\nAlso made POI follow Excel's special case for the encoding of SUM taking a single\nargument.  This was done for consistency; it is not critical for fixing any\nknown bug.\n\nFixed in svn r740159"}]