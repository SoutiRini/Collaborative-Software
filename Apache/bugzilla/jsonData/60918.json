[{"count": 0, "tags": [], "text": "Created attachment 34876\nSome pieces of the full trace showing the issue\n\nThis is a similar report to https://bz.apache.org/bugzilla/show_bug.cgi?id=58646 but whatever fix was done in that case does not prevent this issue.\n\nBasic outline:\n\n1. thread http-nio-8080-exec-1 processes a request that will result in send file.  It pops Http11Processor@8dc1458 from recycledProcessors\n2. The send file action is completed in thread http-nio-8080-ClientPoller-0.  Then that thread is done, it pushes Http11Processor@8dc1458 onto recycledProcessors\n3. A few milliseconds later, http-nio-8080-exec-1 also pushes Http11Processor@8dc1458 onto recycledProcessors, so now that one processor is in the list of recycledProcessors twice\n4. Eventually, two nio exec threads both pop that one instance off of recycledProcessors\n\n4A.  The second thread to use it throws\n\n24-Mar-2017 12:08:08.093 INFO [http-nio-8080-exec-1] org.apache.coyote.http11.Http11Processor.service Error parsing HTTP request header\n Note: further occurrences of HTTP header parsing errors will be logged at DEBUG level.\n java.lang.IllegalStateException: Unexpected state: headers already parsed. Buffer not recycled?\n        at org.apache.coyote.http11.Http11InputBuffer.parseHeaders(Http11InputBuffer.java:554)\n        at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:683)\n\n\n4B.  The first thread, which completes after the second one, throws\n\n24-Mar-2017 12:08:08.833 SEVERE [http-nio-8080-exec-7] org.apache.coyote.http11.Http11Processor.service Error processing request\n java.lang.NullPointerException\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:389)\n        at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:783)\n\nand then\n\n24-Mar-2017 12:08:08.849 SEVERE [http-nio-8080-exec-7] org.apache.coyote.http11.Http11Processor.endRequest Error finishing response\n java.lang.NullPointerException\n        at org.apache.coyote.http11.Http11OutputBuffer.commit(Http11OutputBuffer.java:351)\n        at org.apache.coyote.http11.Http11Processor.prepareResponse(Http11Processor.java:1288)\n        at org.apache.coyote.AbstractProcessor.action(AbstractProcessor.java:254)\n        at org.apache.coyote.http11.Http11Processor.endRequest(Http11Processor.java:1457)\n        at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:823)", "is_private": false, "bug_id": 60918, "id": 197975, "time": "2017-03-24T17:43:14Z", "creator": "andrew.garland@sunbirddcim.com", "creation_time": "2017-03-24T17:43:14Z", "attachment_id": 34876}, {"count": 1, "tags": [], "text": "To me, there are two separate issues here:\n\n1.  The logic for pushing the processor back in send file case has some flaw.\n\n2.  RecycledProcessors should protect against the same instance being in the stack more than once, as a defense against this flaw or any future flaws that result in mistakenly putting the same processor in twice.", "is_private": false, "bug_id": 60918, "id": 197976, "time": "2017-03-24T17:47:03Z", "creator": "andrew.garland@sunbirddcim.com", "creation_time": "2017-03-24T17:47:03Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "markt@apache.org", "text": "Thanks for the report and especially the debug logs. I was able to pin-point the root cause very quickly from those.\n\nAre you able to build Tomcat from svn in order to confirm a fix?", "id": 197979, "time": "2017-03-24T20:32:00Z", "bug_id": 60918, "creation_time": "2017-03-24T20:32:00Z", "is_private": false, "attachment_id": null}, {"count": 3, "attachment_id": null, "bug_id": 60918, "is_private": false, "id": 197980, "time": "2017-03-24T20:33:57Z", "creator": "andrew.garland@sunbirddcim.com", "creation_time": "2017-03-24T20:33:57Z", "tags": [], "text": "i haven't before, but I am sure I could :)\n\nPlease point me at BUILD instructions."}, {"count": 4, "tags": [], "bug_id": 60918, "attachment_id": null, "text": "These are the instructions for 9.0.x\nhttps://svn.apache.org/viewvc/tomcat/trunk/BUILDING.txt?view=markup\n\n8.5.x is very similar, just a different svn path and a different minimum Java version.\n\nBoth 9.0.x and 8.5.x have the fix. I'm currently working on a back-port to 8.0.x.", "id": 197981, "time": "2017-03-24T20:56:39Z", "creator": "markt@apache.org", "creation_time": "2017-03-24T20:56:39Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 60918, "attachment_id": null, "is_private": false, "id": 197982, "time": "2017-03-24T20:59:28Z", "creator": "andrew.garland@sunbirddcim.com", "creation_time": "2017-03-24T20:59:28Z", "text": "thanks for the info.\n\nCan you point me to the commit diff?  Just curious."}, {"count": 6, "attachment_id": null, "bug_id": 60918, "text": "r1788544 (for 9.0.x)", "id": 197983, "time": "2017-03-24T21:06:40Z", "creator": "markt@apache.org", "creation_time": "2017-03-24T21:06:40Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "bug_id": 60918, "is_private": false, "text": "FYI, minor typo in changelog\n\nsubsequent requests experiencing and <code>IllegalStateException</code>.\n\n\"and\" -> \"an\"", "id": 197984, "time": "2017-03-24T21:09:12Z", "creator": "andrew.garland@sunbirddcim.com", "creation_time": "2017-03-24T21:09:12Z", "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 60918, "attachment_id": null, "text": "8.0.x and earlier are not affected. This bug was introduced by the refactoring in 8.5.x onwards.", "id": 197985, "time": "2017-03-24T21:16:18Z", "creator": "markt@apache.org", "creation_time": "2017-03-24T21:16:18Z", "is_private": false}, {"count": 9, "attachment_id": 34877, "bug_id": 60918, "text": "Created attachment 34877\nRecoded RecycledProcessors\n\nThe problem does not recur using the version built from trunk!  Thanks for the rapid turnaround.  I guess it will be a month or two before this is part of an official release?\n\nFYI, I had also prevented the problem by re-coding the RecycledProcessors class to check for existence before pushing onto the stack.  This was quick and dirty and would not scale, but food for thought.", "id": 197986, "time": "2017-03-24T21:29:46Z", "creator": "andrew.garland@sunbirddcim.com", "creation_time": "2017-03-24T21:29:46Z", "tags": [], "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 60918, "text": "We'll probably start the release process next week. It is normally started around the beginning of the every month but the first week of April is looking busy for me. We could delay it but there is enough in the changelog to justify a release.", "count": 10, "id": 197987, "time": "2017-03-24T21:33:09Z", "creator": "markt@apache.org", "creation_time": "2017-03-24T21:33:09Z", "is_private": false}, {"count": 11, "attachment_id": null, "bug_id": 60918, "text": "(In reply to Andrew Garland from comment #9)\n> Created attachment 34877 [details]\n> Recoded RecycledProcessors\n> \n> The problem does not recur using the version built from trunk!  Thanks for\n> the rapid turnaround.  I guess it will be a month or two before this is part\n> of an official release?\n> \n> FYI, I had also prevented the problem by re-coding the RecycledProcessors\n> class to check for existence before pushing onto the stack.  This was quick\n> and dirty and would not scale, but food for thought.\n\nAnd we're not going to do that :)", "id": 197988, "time": "2017-03-24T21:49:29Z", "creator": "remm@apache.org", "creation_time": "2017-03-24T21:49:29Z", "tags": [], "is_private": false}, {"count": 12, "attachment_id": null, "bug_id": 60918, "is_private": false, "id": 198005, "time": "2017-03-27T10:34:48Z", "creator": "markt@apache.org", "creation_time": "2017-03-27T10:34:48Z", "tags": [], "text": "Fixed in:\n- trunk for 9.0.0.M19 onwards\n- 8.5.x for 8.5.13 onwards"}]