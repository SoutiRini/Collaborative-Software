[{"count": 0, "tags": [], "bug_id": 60849, "attachment_id": null, "id": 197612, "time": "2017-03-13T07:10:39Z", "creator": "rambabu.eedala@gmail.com", "creation_time": "2017-03-13T07:10:39Z", "is_private": false, "text": "SSL Renegotiation was restricted by using this -Djdk.tls.rejectClientInitiatedRenegotiation=true. As expected tomcat is throwing the exception but the exception was not handled by NIO connector. Where as with BIO connector , the exception was handled properly and a proper alert was sent to openssl client.\n\nSteps To reproduce:\n\nTomcat version: 8.0.37\nOracle Java : 1.8.0.112\n\n1) Configure tomcat server.xml with NIO connector on ssl port which was on 8443 by default and with self signed certificate.\n\n <Connector SSLEnabled=\"true\" acceptCount=\"100\" ciphers=\" TLS_RSA_WITH_AES_128_CBC_SHA \" clientAuth=\"false\" disableUploadTimeout=\"true\" enableLookups=\"false\" maxHttpHeaderSize=\"8192\" maxThreads=\"150\" minSpareThreads=\"25\" port=\"8443\" protocol=\"HTTP/1.1\" scheme=\"https\" sekeystoreFile=\"/home/.keystore\" keystorePass=\"password\" cure=\"true\" sslEnabledProtocols=\"TLSv1,TLSv1.1,TLSv1.2\" sslProtocol=\"TLS\"/>\n\n2) Restrict SSL renegotiation by setting this flag  CATALINA_OPTS=\"$CATALINA_OPTS -Djdk.tls.rejectClientInitiatedRenegotiation=true\" at setenv.sh file present in bin folder.\n\n3) Enable debug mode by setting this flag in CATALINA_OPTS=\"$CATALINA_OPTS -Djavax.net.debug=all\" at setenv.sh present in bin folder\n\n4) Try to renegotiate with openssl and observe the cataline.out file at logs folder.\n\nError Message :\n\n%% Cached server session: [Session-4, TLS_DHE_RSA_WITH_AES_128_CBC_SHA]\nhttp-nio2-8443-exec-15, READ: TLSv1 Handshake, length = 224\nAllow unsafe renegotiation: false\nAllow legacy hello messages: true\nIs initial handshake: false\nIs secure renegotiation: true\n*** ClientHello, TLSv1\nRandomCookie:  GMT: 1358710174 bytes = { 192, 154, 132, 174, 67, 12, 146, 242, 194, 112, 62, 72, 182, 17, 144, 176, 95, 0, 228, 50, 124, 188, 160, 233, 52, 78, 195, 186 }\nSession ID:  {}\nCipher Suites: [TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_DHE_RSA_WITH_AES_256_CBC_SHA, TLS_DHE_DSS_WITH_AES_256_CBC_SHA, TLS_DH_RSA_WITH_AES_256_CBC_SHA, TLS_DH_DSS_WITH_AES_256_CBC_SHA, TLS_DHE_RSA_WITH_CAMELLIA_256_CBC_SHA, TLS_DHE_DSS_WITH_CAMELLIA_256_CBC_SHA, TLS_DH_RSA_WITH_CAMELLIA_256_CBC_SHA, TLS_DH_DSS_WITH_CAMELLIA_256_CBC_SHA, TLS_ECDH_RSA_WITH_AES_256_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA, TLS_RSA_WITH_AES_256_CBC_SHA, TLS_RSA_WITH_CAMELLIA_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA, TLS_DH_RSA_WITH_AES_128_CBC_SHA, TLS_DH_DSS_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_SEED_CBC_SHA, TLS_DHE_DSS_WITH_SEED_CBC_SHA, TLS_DH_RSA_WITH_SEED_CBC_SHA, TLS_DH_DSS_WITH_SEED_CBC_SHA, TLS_DHE_RSA_WITH_CAMELLIA_128_CBC_SHA, TLS_DHE_DSS_WITH_CAMELLIA_128_CBC_SHA, TLS_DH_RSA_WITH_CAMELLIA_128_CBC_SHA, TLS_DH_DSS_WITH_CAMELLIA_128_CBC_SHA, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_SEED_CBC_SHA, TLS_RSA_WITH_CAMELLIA_128_CBC_SHA, TLS_ECDHE_RSA_WITH_RC4_128_SHA, TLS_ECDHE_ECDSA_WITH_RC4_128_SHA, TLS_ECDH_RSA_WITH_RC4_128_SHA, TLS_ECDH_ECDSA_WITH_RC4_128_SHA, SSL_RSA_WITH_RC4_128_SHA, SSL_RSA_WITH_RC4_128_MD5, TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA, SSL_DH_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DH_DSS_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA, SSL_RSA_WITH_3DES_EDE_CBC_SHA]\nCompression Methods:  { 0 }\nExtension renegotiation_info, renegotiated_connection: df:3c:e7:d4:4d:b6:87:23:28:a7:2f:61\nExtension ec_point_formats, formats: [uncompressed, ansiX962_compressed_prime, ansiX962_compressed_char2]\nExtension elliptic_curves, curve names: {secp256r1, secp521r1, unknown curve 28, unknown curve 27, secp384r1, unknown curve 26, secp256k1}\nUnsupported extension type_35, data:\nUnsupported extension type_15, data: 01\n***\nhttp-nio2-8443-exec-15, fatal error: 40: Client initiated renegotiation is not allowed\njavax.net.ssl.SSLHandshakeException: Client initiated renegotiation is not allowed\n%% Invalidated:  [Session-4, TLS_DHE_RSA_WITH_AES_128_CBC_SHA]\nhttp-nio-8443-exec-15, SEND TLSv1 ALERT:  fatal, description = handshake_failure\nhttp-nio-8443-exec-15, WRITE: TLSv1 Alert, length = 32\nhttp-nio-8443-exec-17, called closeOutbound()\nhttp-nio-8443-exec-17, closeOutboundInternal()\nhttp-nio-8443-exec-17, fatal: engine already closed.  Rethrowing javax.net.ssl.SSLHandshakeException: Client initiated renegotiation is not allowed\n\n\nBIO Connector Message where ssl handshake exception was handled properly.\n\n%% Cached server session: [Session-2, TLS_DHE_RSA_WITH_AES_128_CBC_SHA]\nhttp-bio-8443-exec-1, setSoTimeout(59673) called\nhttp-bio-8443-exec-1, READ: TLSv1 Handshake, length = 224\nAllow unsafe renegotiation: false\nAllow legacy hello messages: true\nIs initial handshake: false\nIs secure renegotiation: true\n*** ClientHello, TLSv1\nRandomCookie:  GMT: 1367302669 bytes = { 190, 58, 232, 25, 36, 252, 0, 164, 52, 168, 124, 230, 150, 191, 73, 250, 174, 70, 153, 199, 156, 188, 34, 138, 146, 208, 66, 242 }\nSession ID:  {}\nCipher Suites: [TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_DHE_RSA_WITH_AES_256_CBC_SHA, TLS_DHE_DSS_WITH_AES_256_CBC_SHA, TLS_DH_RSA_WITH_AES_256_CBC_SHA, TLS_DH_DSS_WITH_AES_256_CBC_SHA, TLS_DHE_RSA_WITH_CAMELLIA_256_CBC_SHA, TLS_DHE_DSS_WITH_CAMELLIA_256_CBC_SHA, TLS_DH_RSA_WITH_CAMELLIA_256_CBC_SHA, TLS_DH_DSS_WITH_CAMELLIA_256_CBC_SHA, TLS_ECDH_RSA_WITH_AES_256_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA, TLS_RSA_WITH_AES_256_CBC_SHA, TLS_RSA_WITH_CAMELLIA_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA, TLS_DH_RSA_WITH_AES_128_CBC_SHA, TLS_DH_DSS_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_SEED_CBC_SHA, TLS_DHE_DSS_WITH_SEED_CBC_SHA, TLS_DH_RSA_WITH_SEED_CBC_SHA, TLS_DH_DSS_WITH_SEED_CBC_SHA, TLS_DHE_RSA_WITH_CAMELLIA_128_CBC_SHA, TLS_DHE_DSS_WITH_CAMELLIA_128_CBC_SHA, TLS_DH_RSA_WITH_CAMELLIA_128_CBC_SHA, TLS_DH_DSS_WITH_CAMELLIA_128_CBC_SHA, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_SEED_CBC_SHA, TLS_RSA_WITH_CAMELLIA_128_CBC_SHA, TLS_ECDHE_RSA_WITH_RC4_128_SHA, TLS_ECDHE_ECDSA_WITH_RC4_128_SHA, TLS_ECDH_RSA_WITH_RC4_128_SHA, TLS_ECDH_ECDSA_WITH_RC4_128_SHA, SSL_RSA_WITH_RC4_128_SHA, SSL_RSA_WITH_RC4_128_MD5, TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA, SSL_DH_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DH_DSS_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA, SSL_RSA_WITH_3DES_EDE_CBC_SHA]\nCompression Methods:  { 0 }\nExtension renegotiation_info, renegotiated_connection: 17:03:f4:e4:ee:78:fc:bd:f9:45:f5:d0\nExtension ec_point_formats, formats: [uncompressed, ansiX962_compressed_prime, ansiX962_compressed_char2]\nExtension elliptic_curves, curve names: {secp256r1, secp521r1, unknown curve 28, unknown curve 27, secp384r1, unknown curve 26, secp256k1}\nUnsupported extension type_35, data:\nUnsupported extension type_15, data: 01\n***\n%% Invalidated:  [Session-2, TLS_DHE_RSA_WITH_AES_128_CBC_SHA]\nhttp-bio-8443-exec-1, SEND TLSv1 ALERT:  fatal, description = handshake_failure\nhttp-bio-8443-exec-1, WRITE: TLSv1 Alert, length = 32\nhttp-bio-8443-exec-1, called closeSocket()\nhttp-bio-8443-exec-1, handling exception: javax.net.ssl.SSLHandshakeException: Client initiated renegotiation is not allowed\nhttp-bio-8443-exec-1, called close()\nhttp-bio-8443-exec-1, called closeInternal(true)"}, {"count": 1, "tags": [], "bug_id": 60849, "text": "I would say these configuration options and questionable behaviors are less likely to be handled in any way when using the SSL engine.", "id": 197613, "time": "2017-03-13T09:07:29Z", "creator": "remm@apache.org", "creation_time": "2017-03-13T09:07:29Z", "is_private": false, "attachment_id": null}]