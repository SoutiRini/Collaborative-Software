[{"count": 0, "tags": [], "creator": "corporate_gadfly@hotmail.com", "attachment_id": null, "text": "From haroon.rafique@utoronto.ca Tue Dec  5 16:44:03 2006\nDate: Tue, 5 Dec 2006 16:39:27 -0500 (EST)\nFrom: Haroon Rafique <haroon.rafique@utoronto.ca>\nReply-To: Tomcat Developers List <dev@tomcat.apache.org>\nTo: dev@tomcat.apache.org\nSubject: mod_jk problem when streaming files larger than ~400k (causes\nClientAbortException)\n\nHi Devs,\n\nI sent this to the user list without any responses. I am looking for some\ninsight from the dev list. You can also see the nabble archive of the\nuser-list posting at\nhttp://www.nabble.com/mod_jk-problem-when-streaming-files-larger-than-%7E400\nk-%28causes-ClientAbortException%29-t2756411.html\n\nIf I don't get any responses, then I can submit a bugzilla bug with a\n\"testcase\" war file and its source (maven driven) so that the devs can play\naround with it.\n\nCheers,\n--\nHaroon Rafique\n<haroon.rafique@utoronto.ca>\n\n\n---------- Forwarded message ----------\nDate: Mon, 4 Dec 2006 15:01:19 -0500 (EST)\nFrom: Haroon Rafique <haroon.rafique@utoronto.ca>\nTo: users@tomcat.apache.org\nSubject: mod_jk problem when streaming files larger than ~400k (causes\n    ClientAbortException)\n\nHi,\n\nI am using mod_jk 1.2.19 on Linux with JDK 1.5.0_08, tomcat 5.5.20. Our\napplication is struts-based and in one of our actions we stream a PDF to the\nclient. The pseudo-code for outputting the response back to the client is as\nfollows (assuming baos contains a ByteArrayOutputStream):\n\n             OutputStream out = response.getOutputStream();\n             baos.writeTo(out);\n             out.flush();\n             out.close();\n\nWe noticed no problems when the size of baos was less than 400k. Now the\nfilesize has jumped to a little greater than 400k. With mod_jk in the\npicture, intermittently (not all the time), we get ClientAbortException:\n\n     Caused by: ClientAbortException:  java.io.IOException\n         at\n         org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuf\n         fer.java:366)\n\nThe end result being that the PDF is truncated and Acrobat considers it\ndamaged.\n\nWithout mod_jk in the picture, everything is fine.\n\nTurning up the mod_jk logging to debug gave me too much info. Turning it\ndown to info gave me some clues. Basically, there are 3 flavors of the\nfailures. Maybe they are all the same but it might appear different to a\ntrained eye, so I'm posting all three.\n\nFlavor 1 error:\n===============\n[Mon Dec 04 14:28:59 2006] [25445:9920] [info]\n     ajp_connection_tcp_get_message::\n     jk_ajp_common.c (941): (local) Tomcat has forced a connection close for\n     socket 22\n[Mon Dec 04 14:28:59 2006] [25445:9920] [error]\n     ajp_get_reply::jk_ajp_common.c (1562): (local) Tomcat is down or\n     network\n     problems. Part of the response has already been sent to the client\n[Mon Dec 04 14:28:59 2006] [25445:9920] [info]\n     ajp_service::jk_ajp_common.c (18 28): (local) receiving from tomcat\n     failed,\n     recoverable operation attempt=0\n[Mon Dec 04 14:28:59 2006] [25445:9920] [info]\n     ajp_service::jk_ajp_common.c (1867): (local) sending request to tomcat\n     failed,\n     recoverable operation attempt=1\n[Mon Dec 04 14:28:59 2006] [25445:9920] [info]\n     ajp_process_callback::jk_ajp_common.c (1410): Writing to client aborted\n     or\n     client\n     network problems\n[Mon Dec 04 14:28:59 2006] [25445:9920] [info]\n     ajp_service::jk_ajp_common.c (1795): (local) request failed, because of\n     client\n     write error without recovery in send loop attempt=1\n[Mon Dec 04 14:28:59 2006] [25445:9920] [info]\n     jk_handler::mod_jk.c (2056): Aborting connection for worker=local\n\nFlavor 2 error:\n===============\n[Mon Dec 04 14:30:30 2006] [25448:9920] [info]\n     ajp_send_request::jk_ajp_common.c (1170): (local) socket 22 is not\n     connected\n     any more (errno=0)\n[Mon Dec 04 14:30:30 2006] [25448:9920] [info]\n     ajp_send_request::jk_ajp_common.c (1194): (local) error sending\n     request.\n     Will\n     try another pooled connection\n[Mon Dec 04 14:30:30 2006] [25448:9920] [info]\n     ajp_send_request::jk_ajp_common.c (1218): (local) all endpoints are\n     disconnected\n     or dead\n[Mon Dec 04 14:30:30 2006] [25448:9920] [info]\n     ajp_service::jk_ajp_common.c (1867): (local) sending request to tomcat\n     failed,\n     recoverable operation attempt=1\n[Mon Dec 04 14:30:32 2006] [25448:9920] [info]\n     ajp_connection_tcp_get_message::jk_ajp_common.c (941): (local) Tomcat\n     has\n     forced a connection close for socket 22\n[Mon Dec 04 14:30:32 2006] [25448:9920] [error]\n     ajp_get_reply::jk_ajp_common.c (1562): (local) Tomcat is down or\n     network\n     problems. Part of the response has already been sent to the client\n[Mon Dec 04 14:30:32 2006] [25448:9920] [info]\n     ajp_service::jk_ajp_common.c (1828): (local) receiving from tomcat\n     failed,\n     recoverable operation attempt=1\n[Mon Dec 04 14:30:32 2006] [25448:9920] [info]\n     ajp_service::jk_ajp_common.c (1867): (local) sending request to tomcat\n     failed,\n     recoverable operation attempt=2\n[Mon Dec 04 14:30:32 2006] [25448:9920] [error]\n     ajp_service::jk_ajp_common.c (1879): (local) Connecting to tomcat\n     failed.\n     Tomcat is probably not started or is listening on the wrong port\n[Mon Dec 04 14:30:32 2006] [25448:9920] [info]\n     jk_handler::mod_jk.c (2063): Service error=0 for worker=local\n\nFlavor 3 error:\n===============\n[Mon Dec 04 14:32:31 2006] [25444:9920] [info]\n     ajp_send_request::jk_ajp_common.c (1170): (local) socket 22 is not\n     connected any more (errno=0)\n[Mon Dec 04 14:32:31 2006] [25444:9920] [info]\n     ajp_send_request::jk_ajp_common.c (1194): (local) error sending\n     request.  Will try another pooled connection\n[Mon Dec 04 14:32:31 2006] [25444:9920] [info]\n     ajp_send_request::jk_ajp_common.c (1218): (local) all endpoints are\n     disconnected or dead\n[Mon Dec 04 14:32:31 2006] [25444:9920] [info]\n     ajp_service::jk_ajp_common.c (1867): (local) sending request to tomcat\n     failed,  recoverable operation attempt=1\n\n\nDoes anyone have any experience with streaming large files using mod_jk? If\nI don't get any responses I will try the dev list.\n\nHere's my mod_jk.conf:\n\nLoadModule jk_module modules/mod_jk.so\nJkWorkersFile conf/workers.properties\nJkLogFile logs/mod_jk.log\nJkLogLevel info\nJkShmFile logs/mod_jk.shm\nJkMount /jkstatus/ status\nJkMount /sws/* local\n\nHere's my workers.properties:\n\nworker.list=local,status\nworker.local.type=ajp13\nworker.local.port=8009\nworker.local.host=localhost\nworker.status.type=status\nworker.status.port=8009\nworker.status.host=localhost\n\nAnyone see any glaring mistakes or oddities? As I mentioned earlier, the\nsame setup worked fine. The only trigger that I can think of is the slight\nincrease in file size.\n\nAny help appreciated.", "id": 96605, "time": "2006-12-07T07:16:23Z", "bug_id": 41124, "creation_time": "2006-12-07T07:16:23Z", "is_private": false}, {"count": 1, "tags": [], "text": "My environment is as follows:\n\ntcnative 1.1.7\nmod_jk 1.2.19\ntomcat 5.5.20\njdk 1.5.0_08\nGentoo Linux (2.6 kernel)\n", "is_private": false, "id": 96606, "creator": "corporate_gadfly@hotmail.com", "time": "2006-12-07T07:19:33Z", "bug_id": 41124, "creation_time": "2006-12-07T07:19:33Z", "attachment_id": null}, {"count": 2, "tags": [], "creator": "hgomez@apache.org", "attachment_id": null, "is_private": false, "id": 96607, "time": "2006-12-07T07:23:35Z", "bug_id": 41124, "creation_time": "2006-12-07T07:23:35Z", "text": "Same problem here with configuration :\n\nSuse Linux SLES 9 \nApache 2.0.49 + Suse fixes\nmod_jk 1.2.19 and 1.2.20-dev\nTomcat 6.0.2 \nTomcat Native 1.1.7\nAPR 1.2.7\n\nDisabling APR use resolv the problem"}, {"count": 3, "tags": [], "bug_id": 41124, "text": "(In reply to comment #2)\n> Same problem here with configuration :\n> \n> Suse Linux SLES 9 \n> Apache 2.0.49 + Suse fixes\n> mod_jk 1.2.19 and 1.2.20-dev\n> Tomcat 6.0.2 \n> Tomcat Native 1.1.7\n> APR 1.2.7\n> \n> Disabling APR use resolv the problem\n\n\nFor me, I have the following line in my server.xml:\n\n    <!-- Define an AJP 1.3 Connector on port 8009 -->\n    <Connector port=\"8009\" \n               connectionTimeout=\"20000\"\n               enableLookups=\"false\" redirectPort=\"8443\" protocol=\"AJP/1.3\" />\n\ntaking out connectionTimeout=\"20000\" fixed it for me. I can't remember why i put\na timeout there in the first place, but what's the downside of taking it out?", "id": 96608, "time": "2006-12-07T07:29:37Z", "creator": "corporate_gadfly@hotmail.com", "creation_time": "2006-12-07T07:29:37Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "corporate_gadfly@hotmail.com", "attachment_id": null, "text": "Testcase .war file is at:\nhttp://haroon.sis.utoronto.ca/bugzilla41124/modjk.war\n\nMaven 2 project file is at (so that you can tinker with the source):\nhttp://haroon.sis.utoronto.ca/bugzilla41124/modjk.zip\n\nBTW, I tried reproducing this on Windows but couldn't (possibly because I was\nonly using mod_jk.so and no tcnative dll)", "id": 96609, "time": "2006-12-07T07:33:50Z", "bug_id": 41124, "creation_time": "2006-12-07T07:33:50Z", "is_private": false}, {"count": 5, "tags": [], "creator": "hgomez@apache.org", "attachment_id": null, "is_private": false, "id": 96611, "time": "2006-12-07T08:04:09Z", "bug_id": 41124, "creation_time": "2006-12-07T08:04:09Z", "text": "Tried your webapp on WinXP, Apache 2.0.58, Tomcat 6.0.4, mod_jk 1.2.19 and\ntcnative 1.1.7 and it works.\n\nIt's really something related to Linux/APR/tcnative ;("}, {"count": 6, "attachment_id": null, "bug_id": 41124, "is_private": false, "id": 96667, "time": "2006-12-08T12:14:21Z", "creator": "corporate_gadfly@hotmail.com", "creation_time": "2006-12-08T12:14:21Z", "tags": [], "text": "(In reply to comment #3)\n> \n> [..snip..]\n> \n> taking out connectionTimeout=\"20000\" fixed it for me. I can't remember why i put\n> a timeout there in the first place, but what's the downside of taking it out?\n> \n\nSpoke too soon. I don't think that had anything to do with it. The only fix is\nto not specify -Djava.library.path (which is where it looks for the native library).\n"}, {"count": 7, "tags": [], "creator": "hgomez@apache.org", "attachment_id": null, "is_private": false, "id": 96672, "time": "2006-12-08T13:40:33Z", "bug_id": 41124, "creation_time": "2006-12-08T13:40:33Z", "text": "I tried tcnative 1.1.7 against the recent APR 1.2.8 and it didn't works either ;("}, {"count": 8, "tags": [], "creator": "rainer.jung@kippdata.de", "attachment_id": null, "is_private": false, "id": 96690, "time": "2006-12-09T10:35:35Z", "bug_id": 41124, "creation_time": "2006-12-09T10:35:35Z", "text": "I can't reproduce this problem for the follwoing three setups. I used your\nmodjk.war with:\n\nTC 5.5.17, apr lib 1.1.3 and apr 1.2.7. Connector setting default:\n<Connector port=\"8009\" enableLookups=\"false\" redirectPort=\"8443\"\nprotocol=\"AJP/1.3\" />\nJVM 1.5.0_06\nApache 2.0.59/mod_jk 1.2.19\nboth on the same machine running SLES 9 SP2 x86_64\n\nTC 5.5.20, apr lib 1.1.8-dev and apr 1.2.8-dev. Connector setting default:\n<Connector port=\"8009\" enableLookups=\"false\" redirectPort=\"8443\"\nprotocol=\"AJP/1.3\" />\nJVM 1.5.0_07 on Solaris 10, Apache 2.0.59/mod_jk 1.2.19 on SLES 9 SP2 x86_64\n\nTC 5.5.20, apr lib 1.1.8-dev and apr 1.2.8-dev. Connector setting default:\n<Connector port=\"8009\" enableLookups=\"false\" redirectPort=\"8443\"\nprotocol=\"AJP/1.3\" />\nJVM 1.5.0_05 on SLES 9 SP2 i586, Apache 2.0.59/mod_jk 1.2.19 on SLES 9 SP2 x86_64\n\nmod_jk settings for the worker default apart from type=ajp13, host and port\n\nIn all cases I could retrive the five different PDF files and the results had\nthe correct checksum.\n\nBut: I didn't use acrobat. I simply used curl to retrieve the result, to make\nsure, that it's not a combined problem with the client. Also the connection\nbetween apache and tomcat was a fast one.\n\napr was compiled with enabled thread support in all cases.\n\nCould you please check, if the problem can be reproduced using a simple client\nlike curl? How long does the download take (add %D to your LogFormat in apache)?\nWhat are the exact mod_jk and the connector settings?\n\n"}, {"count": 9, "tags": [], "creator": "corporate_gadfly@hotmail.com", "text": "(In reply to comment #8)\n> I can't reproduce this problem for the follwoing three setups. I used your\n> modjk.war with:\n> \n\nHi Rainer,\n\nThanks for replying.\n\n> [..snip..]\n> \n> But: I didn't use acrobat. I simply used curl to retrieve the result, to make\n> sure, that it's not a combined problem with the client. Also the connection\n> between apache and tomcat was a fast one.\n> \n> apr was compiled with enabled thread support in all cases.\n> \n> Could you please check, if the problem can be reproduced using a simple client\n> like curl?\n\nThat's the thing. I tried with both curl and wget and cannot get it to fail. If\nI try with either IE or Firefox it starts failing (usually) for file4.pdf and\nfile10.pdf. Sometimes even file1.pdf fails. Even if you try to say \"save\"\ninstead of \"open\", the file size ends up truncated. Can you try your test again\nwith browsers?\n\n> \n> How long does the download take (add %D to your LogFormat in apache)?\n> \n\nFor a few failed requests it was (I believe in microseconds):\n\n3448705\n3594590\n857019\n\n> \n> What are the exact mod_jk and the connector settings?\n> \n\nI believe I mentioned the mod_jk settings in comment 0. Here they are again:\n\nHere's my mod_jk.conf:\n\nLoadModule jk_module modules/mod_jk.so\nJkWorkersFile conf/workers.properties\nJkLogFile logs/mod_jk.log\nJkLogLevel info\nJkShmFile logs/mod_jk.shm\nJkMount /jkstatus/ status\nJkMount /sws/* local\nJkMount /modjk/* local\n\n(I forgot to type in the /modjk/* line last time).\n\nHere's my workers.properties:\n\nworker.list=local,status\nworker.local.type=ajp13\nworker.local.port=8009\nworker.local.host=localhost\nworker.status.type=status\nworker.status.port=8009\nworker.status.host=localhost\n\nFor the connector setting (from comment 3) is:\n\n    <Connector port=\"8009\"\n               connectionTimeout=\"20000\"\n               enableLookups=\"false\" redirectPort=\"8443\" protocol=\"AJP/1.3\" />\n\nThe only thing I have done from the default setup is to add the\nconnectionTimeout value. The rest is plain vanilla.\n\nMy apr was configured using:\n    ./configure\nMy tcnative was configured using:\n    ./configure --with-apr=/usr/local/apr\nMy apache was configured using:\n    ./configure --prefix=/www --enable-ssl --enable-proxy --enable-mods-shared=all\nMy modjk was configured using:\n    ./configure --with-apxs=/www/bin/apxs --enable-jni --with-java-platform=2", "id": 96691, "time": "2006-12-09T14:45:44Z", "bug_id": 41124, "creation_time": "2006-12-09T14:45:44Z", "is_private": false, "attachment_id": null}, {"count": 10, "tags": [], "creator": "mturk@apache.org", "is_private": false, "text": "Can you guys try the latest trunk from the native.\n(or just copy the network.c over the one from 1.1.7)\n\nhttp://svn.apache.org/viewvc/tomcat/connectors/trunk/jni/native/src/network.c?view=co\n\nThe problem was that timeout was not restored in readbbt so the next send was\nusing the 100ms timeout.", "id": 96703, "time": "2006-12-10T00:55:11Z", "bug_id": 41124, "creation_time": "2006-12-10T00:55:11Z", "attachment_id": null}, {"count": 11, "tags": [], "creator": "corporate_gadfly@hotmail.com", "is_private": false, "text": "(In reply to comment #10)\n> Can you guys try the latest trunk from the native.\n> (or just copy the network.c over the one from 1.1.7)\n> \n\nYes, I can confirm that this is fixed. Are there any plans for rolling 1.1.8?\nFor my production setup, should I just copy over network.c and go from there?", "id": 96709, "time": "2006-12-10T06:22:17Z", "bug_id": 41124, "creation_time": "2006-12-10T06:22:17Z", "attachment_id": null}, {"count": 12, "tags": [], "creator": "mturk@apache.org", "text": "Yes, I'll tag the 1.1.8 tomorrow, so it can be included in consequtive Tomcat\nreleases.", "id": 96710, "time": "2006-12-10T09:34:05Z", "bug_id": 41124, "creation_time": "2006-12-10T09:34:05Z", "is_private": false, "attachment_id": null}, {"count": 13, "tags": [], "text": "Oops, it was not supposed to be calling readbbt in the default configuration. I\nforgot to port a patch from the HTTP connector.\n\nIt's still a serious bug though, so it's good to fix it.", "is_private": false, "bug_id": 41124, "id": 96723, "time": "2006-12-10T17:27:55Z", "creator": "remm@apache.org", "creation_time": "2006-12-10T17:27:55Z", "attachment_id": null}, {"count": 14, "tags": [], "creator": "rainer.jung@kippdata.de", "text": "Removing Native:JK component, because this issue belongs to tcnative, which\nseems to not have a component value.\n\nAlso moving from resolved to closed.", "id": 112396, "time": "2008-01-01T16:41:12Z", "bug_id": 41124, "creation_time": "2008-01-01T16:41:12Z", "is_private": false, "attachment_id": null}]