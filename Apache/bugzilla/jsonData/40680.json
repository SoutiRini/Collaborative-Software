[{"count": 0, "attachment_id": null, "creator": "mags75@club-internet.fr", "is_private": false, "id": 94479, "time": "2006-10-04T09:35:37Z", "bug_id": 40680, "creation_time": "2006-10-04T09:35:37Z", "tags": [], "text": "When using self signed certificates, I get no problem to get SSL connections\nwith Tomcat.\n\nThen I tried using the certificate I already used in Apache (and that worked\nwell). This certificate has been signed by my own CA, which I created with CA.pl\nfrom OpenSSL. This certificate is server.cert and is PEM encrypted.\nHere is what I did : \n1) Make a X509 valid certificate :\nopenssl x509 -in server.cert -out serverx509.pem\n\n2) import the certificate in a keystore :\nkeytool -import -keystore c:\\ssl\\.keystore -alias tomcat -file serverx509.pem\n(password is \"changeit\" as expected by Tomcat)\n\nThe import is OK, I get a correct .keystore file which I can read with :\nkeytool -list -keystore c:\\ssl\\.keystore\n\n4) Configure Tomcat in server.xml :\n    <!-- Define a SSL HTTP/1.1 Connector on port 8443 -->\n    <Connector port=\"8443\" maxHttpHeaderSize=\"8192\"\n               maxThreads=\"150\" minSpareThreads=\"25\" maxSpareThreads=\"75\"\n               enableLookups=\"false\" disableUploadTimeout=\"true\"\n               acceptCount=\"100\" scheme=\"https\" secure=\"true\"\n               clientAuth=\"false\" sslProtocol=\"TLS\"\n\t       keystoreFile=\"c:\\ssl\\.keystore\" />\n\n5) Launch Tomcat :\nTomcat launches but catalina.xxx.log tells me :\n4 oct. 2006 17:11:41 org.apache.catalina.core.AprLifecycleListener lifecycleEvent\nINFO: The Apache Tomcat Native library which allows optimal performance in\nproduction environments was not found on the java.library.path: C:\\Program\nFiles\\Apache Software Foundation\\Tomcat\n5.5\\bin;.;C:\\WINDOWS\\System32;C:\\WINDOWS;C:\\Perl\\bin\\;C:\\Program Files\\Windows\nResource\nKits\\Tools\\;C:\\WINDOWS\\system32;C:\\WINDOWS;C:\\WINDOWS\\System32\\Wbem;C:\\Program\nFiles\\ATI Technologies\\ATI Control Panel;C:\\Program Files\\Fichiers\ncommuns\\GTK\\2.0\\bin;C:\\informix\\bin;c:\\OpenSSL\\bin;C:\\Program\nFiles\\Java\\jre1.5.0_09\\bin\n4 oct. 2006 17:11:41 org.apache.coyote.http11.Http11BaseProtocol init\nINFO: Initialisation de Coyote HTTP/1.1 sur http-8081\n4 oct. 2006 17:11:42 org.apache.coyote.http11.Http11BaseProtocol init\nINFO: Initialisation de Coyote HTTP/1.1 sur http-8443\n4 oct. 2006 17:11:42 org.apache.catalina.startup.Catalina load\nINFO: Initialization processed in 1472 ms\n4 oct. 2006 17:11:42 org.apache.catalina.core.StandardService start\nINFO: D\u00e9marrage du service Catalina\n4 oct. 2006 17:11:42 org.apache.catalina.core.StandardEngine start\nINFO: Starting Servlet Engine: Apache Tomcat/5.5.17\n4 oct. 2006 17:11:42 org.apache.catalina.core.StandardHost start\nINFO: XML validation disabled\n4 oct. 2006 17:11:44 org.apache.catalina.startup.HostConfig deployWAR\nINFO: D\u00e9ploiement de l'archive standard-examples.war de l'application web\n4 oct. 2006 17:11:45 org.apache.catalina.startup.HostConfig deployWAR\nINFO: D\u00e9ploiement de l'archive PharmaJ.war de l'application web\n4 oct. 2006 17:11:46 org.apache.coyote.http11.Http11BaseProtocol start\nINFO: D\u00e9marrage de Coyote HTTP/1.1 sur http-8081\n4 oct. 2006 17:11:46 org.apache.coyote.http11.Http11BaseProtocol start\nINFO: D\u00e9marrage de Coyote HTTP/1.1 sur http-8443\n4 oct. 2006 17:11:46 org.apache.tomcat.util.net.PoolTcpEndpoint acceptSocket\nGRAVE: Le point de contact [SSL:\nServerSocket[addr=0.0.0.0/0.0.0.0,port=0,localport=8443]] a ignor\u00e9 l'exception:\njava.net.SocketException: SSL handshake errorjavax.net.ssl.SSLException: No\navailable certificate or key corresponds to the SSL cipher suites which are enabled.\njava.net.SocketException: SSL handshake errorjavax.net.ssl.SSLException: No\navailable certificate or key corresponds to the SSL cipher suites which are enabled.\n\tat\norg.apache.tomcat.util.net.jsse.JSSESocketFactory.acceptSocket(JSSESocketFactory.java:113)\n\tat\norg.apache.tomcat.util.net.PoolTcpEndpoint.acceptSocket(PoolTcpEndpoint.java:407)\n\tat\norg.apache.tomcat.util.net.LeaderFollowerWorkerThread.runIt(LeaderFollowerWorkerThread.java:70)\n\tat\norg.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:684)\n\tat java.lang.Thread.run(Unknown Source)\n4 oct. 2006 17:11:46 org.apache.tomcat.util.net.PoolTcpEndpoint acceptSocket\nATTENTION: R\u00e9initialisation du ServerSocket\n[...]\n\nAnd I can't get a ssl connection of course\n\n\nI've been working on it hard for several days and then found a post on a mail\nlist, which suggested to use pkcs12 keystore instead.\nSo, here is what I did :\n6) Create a pkcs12 from the already existing server.cert (the same file as used\nabove !) :\nopenssl pkcs12 -export -in server.cert -out keystore.p12 -inkey server.key -name\n\"Certificat Serveur Tomcat\"\nmove keystore.p12 c:\\ssl\\\n\n7) Configure Tomcat to use a pkcs12 keystore :\n    <!-- Define a SSL HTTP/1.1 Connector on port 8443 -->\n    <Connector port=\"8443\" maxHttpHeaderSize=\"8192\"\n               maxThreads=\"150\" minSpareThreads=\"25\" maxSpareThreads=\"75\"\n               enableLookups=\"false\" disableUploadTimeout=\"true\"\n               acceptCount=\"100\" scheme=\"https\" secure=\"true\"\n               clientAuth=\"false\" sslProtocol=\"TLS\"\n\t       keystoreType= \"PKCS12\" \n\t       keystoreFile=\"c:\\ssl\\keystore.p12\" />\n\n8) Launch Tomcat :\nIt works !\nHere is the catalina.xxx.log :\n4 oct. 2006 17:30:05 org.apache.catalina.core.AprLifecycleListener lifecycleEvent\nINFO: The Apache Tomcat Native library which allows optimal performance in\nproduction environments was not found on the java.library.path: C:\\Program\nFiles\\Apache Software Foundation\\Tomcat\n5.5\\bin;.;C:\\WINDOWS\\System32;C:\\WINDOWS;C:\\Perl\\bin\\;C:\\Program Files\\Windows\nResource\nKits\\Tools\\;C:\\WINDOWS\\system32;C:\\WINDOWS;C:\\WINDOWS\\System32\\Wbem;C:\\Program\nFiles\\ATI Technologies\\ATI Control Panel;C:\\Program Files\\Fichiers\ncommuns\\GTK\\2.0\\bin;C:\\informix\\bin;c:\\OpenSSL\\bin;C:\\Program\nFiles\\Java\\jre1.5.0_09\\bin\n4 oct. 2006 17:30:05 org.apache.coyote.http11.Http11BaseProtocol init\nINFO: Initialisation de Coyote HTTP/1.1 sur http-8081\n4 oct. 2006 17:30:05 org.apache.coyote.http11.Http11BaseProtocol init\nINFO: Initialisation de Coyote HTTP/1.1 sur http-8443\n4 oct. 2006 17:30:05 org.apache.catalina.startup.Catalina load\nINFO: Initialization processed in 1673 ms\n4 oct. 2006 17:30:06 org.apache.catalina.core.StandardService start\nINFO: D\u00e9marrage du service Catalina\n4 oct. 2006 17:30:06 org.apache.catalina.core.StandardEngine start\nINFO: Starting Servlet Engine: Apache Tomcat/5.5.17\n4 oct. 2006 17:30:06 org.apache.catalina.core.StandardHost start\nINFO: XML validation disabled\n4 oct. 2006 17:30:08 org.apache.catalina.startup.HostConfig deployWAR\nINFO: D\u00e9ploiement de l'archive standard-examples.war de l'application web\n4 oct. 2006 17:30:08 org.apache.catalina.startup.HostConfig deployWAR\nINFO: D\u00e9ploiement de l'archive PharmaJ.war de l'application web\n4 oct. 2006 17:30:09 org.apache.coyote.http11.Http11BaseProtocol start\nINFO: D\u00e9marrage de Coyote HTTP/1.1 sur http-8081\n4 oct. 2006 17:30:09 org.apache.coyote.http11.Http11BaseProtocol start\nINFO: D\u00e9marrage de Coyote HTTP/1.1 sur http-8443\n4 oct. 2006 17:30:09 org.apache.jk.common.ChannelSocket init\nINFO: JK: ajp13 listening on /0.0.0.0:8010\n4 oct. 2006 17:30:09 org.apache.jk.server.JkMain start\nINFO: Jk running ID=0 time=0/30  config=null\n4 oct. 2006 17:30:10 org.apache.catalina.storeconfig.StoreLoader load\nINFO: Find registry server-registry.xml at classpath resource\n4 oct. 2006 17:30:10 org.apache.catalina.startup.Catalina start\nINFO: Server startup in 4186 ms\n\n\nAnd I can access Tomcat in SSL mode with https://localhost:8443/ (the\ncertificate popup prompts and so on).\n\nSo, only the file format change from x509 to pcks12 and this makes Tomcat accept\nthe cert, why ?\n\nNote this occurs on Win XP and I haven't tested it on Linux platform.\n\n--\nArnaud"}, {"count": 1, "tags": [], "creator": "markt@apache.org", "is_private": false, "id": 95988, "attachment_id": null, "bug_id": 40680, "creation_time": "2006-11-19T17:58:32Z", "time": "2006-11-19T17:58:32Z", "text": "This looks like an issue with the certificate conversion. As the you note at the\nstart of this report (and my experience confirms) self-signed X509 certificates\ndo work.\n\nThe Tomcat users mailing list if the most suitable forum to request help with\nthe conversion process. OpenSSL forums may also be able to help."}]