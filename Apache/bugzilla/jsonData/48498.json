[{"count": 0, "tags": [], "bug_id": 48498, "attachment_id": 24808, "id": 133400, "time": "2010-01-06T19:40:54Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2010-01-06T19:40:54Z", "is_private": false, "text": "Created attachment 24808\n/webapps/examples/WEB-INF/tags/panel.tagx\n\nSteps to reproduce:\n1. Remove /WEB-INF/tags/panel.tag\nfrom the Tomcat Examples webapp and replace it with the attached XML Tag file, panel.tagx\n\n2. Visit the following page:\nhttp://localhost:8080/examples/jsp/jsp2/tagfiles/panel.jsp\n\n3. The page contains a scriptlet, with a CDATA block that produces\na compilatin error.\n\nExpected result:\nCompilation error being reported for line 39,\n  Integer.parseInt(10);\n\nActual result:\njava.lang.ArrayIndexOutOfBoundsException: 46\n\torg.apache.jasper.compiler.JavacErrorDetail.<init>(JavacErrorDetail.java:111)\n\n4. If I add sufficient number of empty lines after the CDATA block,\nArrayIndexOutOfBoundsException disappears and I can see the compiler error,\nbut the error lines shown are wrong. The shown lines are below the actual\nlocation of the error.\nIt looks like this offset in line numbers is due to the size of the CDATA\nblock.\n\n\n\n\n\n\n====================================================================\nFull stacktrace of the above ArrayIndexOutOfBoundsException exception:\n\njava.lang.ArrayIndexOutOfBoundsException: 46\n\torg.apache.jasper.compiler.JavacErrorDetail.<init>(JavacErrorDetail.java:111)\n\torg.apache.jasper.compiler.ErrorDispatcher.createJavacError(ErrorDispatcher.java:533)\n\torg.apache.jasper.compiler.JDTCompiler$2.acceptResult(JDTCompiler.java:377)\n\torg.eclipse.jdt.internal.compiler.Compiler.compile(Compiler.java:398)\n\torg.apache.jasper.compiler.JDTCompiler.generateClass(JDTCompiler.java:429)\n\torg.apache.jasper.compiler.Compiler.compile(Compiler.java:334)\n\torg.apache.jasper.compiler.Compiler.compile(Compiler.java:312)\n\torg.apache.jasper.compiler.Compiler.compile(Compiler.java:299)\n\torg.apache.jasper.JspCompilationContext.compile(JspCompilationContext.java:589)\n\torg.apache.jasper.servlet.JspServletWrapper.loadTagFile(JspServletWrapper.java:215)\n\torg.apache.jasper.compiler.TagFileProcessor.loadTagFile(TagFileProcessor.java:625)\n\torg.apache.jasper.compiler.TagFileProcessor.access$000(TagFileProcessor.java:52)\n\torg.apache.jasper.compiler.TagFileProcessor$TagFileLoaderVisitor.visit(TagFileProcessor.java:685)\n\torg.apache.jasper.compiler.Node$CustomTag.accept(Node.java:1530)\n\torg.apache.jasper.compiler.Node$Nodes.visit(Node.java:2361)\n\torg.apache.jasper.compiler.Node$Visitor.visitBody(Node.java:2411)\n\torg.apache.jasper.compiler.Node$Visitor.visit(Node.java:2417)\n\torg.apache.jasper.compiler.Node$Root.accept(Node.java:495)\n\torg.apache.jasper.compiler.Node$Nodes.visit(Node.java:2361)\n\torg.apache.jasper.compiler.TagFileProcessor.loadTagFiles(TagFileProcessor.java:703)\n\torg.apache.jasper.compiler.Compiler.generateJava(Compiler.java:195)\n\torg.apache.jasper.compiler.Compiler.compile(Compiler.java:332)\n\torg.apache.jasper.compiler.Compiler.compile(Compiler.java:312)\n\torg.apache.jasper.compiler.Compiler.compile(Compiler.java:299)\n\torg.apache.jasper.JspCompilationContext.compile(JspCompilationContext.java:589)\n\torg.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:317)\n\torg.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:313)\n\torg.apache.jasper.servlet.JspServlet.service(JspServlet.java:260)\n\tjavax.servlet.http.HttpServlet.service(HttpServlet.java:717)\n===================================================================="}, {"count": 1, "tags": [], "creator": "knst.kolinko@gmail.com", "attachment_id": 24809, "text": "Created attachment 24809\n/webapps/examples/jsp/jsp2/jspx/basic.jspx\n\nOne more example - a JSP page.\n\nLocation: /webapps/examples/jsp/jsp2/jspx/basic.jspx\nHTTP Address: http://localhost:8080/examples/jsp/jsp2/jspx/basic.jspx\n\nDisplays\n java.lang.ArrayIndexOutOfBoundsException: 57", "id": 133401, "time": "2010-01-06T19:47:10Z", "bug_id": 48498, "creation_time": "2010-01-06T19:47:10Z", "is_private": false}, {"count": 2, "attachment_id": null, "creator": "knst.kolinko@gmail.com", "text": "Reproducible in 6.0.20.\nSo, it is not a regression in the current 6.0.x.\n\n\nIf anyone encounters this, one way to find where it failed is to search in the /work directory for a *.java file that does not have *.class file of the same name. That matches to a jsp or tag file that failed to compile.", "id": 133590, "time": "2010-01-13T17:00:40Z", "bug_id": 48498, "creation_time": "2010-01-13T17:00:40Z", "tags": [], "is_private": false}, {"count": 3, "tags": [], "bug_id": 48498, "text": "This is not a Tomcat but, but a bug in the SAX Parser provided by the JDK. Local testing shows:\n1.5.0_22_x64 - works\n1.6.0_16_x64 - ArrayIndexOutOfBoundsException\n1.7.0_b76_x64 - ArrayIndexOutOfBoundsException\n\nThe bug is that in LexicalHandler.startCDATA() the Locator points to the end of the CDATA section rather than the start. This will always lead to misleading JSP snippets any may result in an ArrayIndexOutOfBoundsException if the CDATA block is close enough to the end of the JSP file.\n\nI have reported the bug to Sun and am awaiting a public bug number. I'll update this issue when I get it.\n\nYou can use Xerces 2.9.1 to override the default SAX Parser provided by the JDK to work around this bug if required.\n\nI looked at providing a work around in Tomcat but correctly handling the behaviour of different JDKs with and without Xerces overriding was getting just too messy to be worth while.", "id": 134520, "time": "2010-02-15T16:42:03Z", "creator": "markt@apache.org", "creation_time": "2010-02-15T16:42:03Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "knst.kolinko@gmail.com", "is_private": false, "id": 134526, "creation_time": "2010-02-15T17:53:00Z", "time": "2010-02-15T17:53:00Z", "bug_id": 48498, "text": "Reopening. Even if we cannot fix/workaround the root cause, at least we can add bounds checking to JavacErrorDetail constructor.\n\nThe sad outcome of this issue was that when this ArrayIndexOutOfBoundsException error occurs, there is no information in the stack trace about what JSP or Tag file caused this issue.\n\nEven if we cannot display the source lines, it would be nice to display all other details.", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 48498, "attachment_id": null, "id": 134535, "time": "2010-02-16T00:48:14Z", "creator": "markt@apache.org", "creation_time": "2010-02-16T00:48:14Z", "is_private": false, "text": "As much as it pains me to have to add a workaround in Tomcat for a Java bug you have a fair point that hiding the compilation error is a nasty side-effect.\n\nWorkaround added to 7.0.x and proposed for 6.0.x"}, {"count": 6, "tags": [], "bug_id": 48498, "text": "The workaround has been applied to 6.0.x and will be included in 6.0.26 onwards.", "id": 135016, "time": "2010-03-03T14:30:55Z", "creator": "markt@apache.org", "creation_time": "2010-03-03T14:30:55Z", "is_private": false, "attachment_id": null}]