[{"count": 0, "tags": [], "bug_id": 50799, "attachment_id": 26671, "id": 144358, "time": "2011-02-16T11:16:44Z", "creator": "bernibb@hotmail.com", "creation_time": "2011-02-16T11:16:44Z", "is_private": false, "text": "Created attachment 26671\ntestplan demonstrating this issue\n\nSteps to reproduce:\n- build up a testplan ass followed (testplan attached) and execute it:\n/\n|- Test Plan\n   |- MyThreadGroup\n       |- HttpRequest Sampler 1\n       |- Beanshell Sampler\n       |- HttpRequest Sampler 2\n       |- 2ndLevel HttpHeaderManager\n   |- 1stLevel HttpHeaderManager\n|- WorkBench\n\nExpected behavior: \n- The header sent by 'HttpRequest Sampler 1' contains the values configured in '1stLevel HttpHeaderManager' and '2ndLevel HttpHeaderManager'\n- The header sent by 'HttpRequest Sampler 2' contains the values configured in '1stLevel HttpHeaderManager' and '2ndLevel HttpHeaderManager'\n\nActual behavior:\n- The header sent by 'HttpRequest Sampler 1' contains all expected values\n- The header sent by 'HttpRequest Sampler 2' contains only the values configured in '1stLevel HttpHeaderManager'\n\nNotes:\n- it seems that the used beanshell sampler prevents the '2ndLevel HttpHeaderManager' from setting its header values to all HttpRequest Samplers which are positioned below/after the beanshell sampler.\n- the log file doesn't show any errors or other abnormalities.\n- if only one 'http header manager' (it doesn't matter which one in the example mentioned above) is used, the header values are set as expected."}, {"count": 1, "attachment_id": null, "creator": "sebb@apache.org", "is_private": false, "id": 145249, "time": "2011-03-24T23:33:21Z", "bug_id": 50799, "creation_time": "2011-03-24T23:33:21Z", "tags": [], "text": "Does not appear to be anything to do with BeanShell - replacing the BSH sampler with a Java request has the same effect.\n\nHowever 3 HTTP samplers in succession do work OK."}, {"count": 2, "attachment_id": null, "creator": "p.mouawad@ubik-ingenierie.com", "is_private": false, "id": 151233, "time": "2011-11-06T17:11:19Z", "bug_id": 50799, "creation_time": "2011-11-06T17:11:19Z", "tags": [], "text": "This issue is due to the following:\nJMeterThread#process_sampler calls :\nSamplePackage pack = compiler.configureSampler(current);\n\nThis calls :\nconfigureWithConfigElements(sampler, pack.getConfigs());\nWhich ends up calling:\nmergeIn()\nThis methods iterates over HeaderManager properties and adds them to AbstractTestElement as temporary properties but it adds their reference not a clone.\n\n\nSo AbstractTestElement ends up sharing a CollectionProperty with HeaderManager\nWhen sampler.recoverRunningVersion() is called in SamplePackage#recoverRunningVersion(), it calls prop.recoverRunningVersion(this being  AbstractTestElement) \n\nThis calls recoverRunningVersionOfSubElements(this being  AbstractTestElement)\nThis enters this part of code:\nif (owner.isTemporary(prop)) {\n   iter.remove();\n}\nAnd ends up cleaning HeaderManager collection.\n\n\nSo I think the issue is due to the fact that A CollectionProperty is shared between HeaderManager and AbstractTestElement.\n\nYou can see this behaviour by just disabling the 2 HTTP Samplers and keeping only the BeanShellSampler or any other AbstractTestElement except for those who redefined addTestElement (as it's the case for HttpSamplerBase).\n\n\nI attach a patch (not committed) because I need further advice from Sebb regarding the fix and its impacts."}, {"count": 3, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "is_private": false, "id": 151234, "creation_time": "2011-11-06T17:11:58Z", "time": "2011-11-06T17:11:58Z", "bug_id": 50799, "text": "Created attachment 27902\nFix proposal", "attachment_id": 27902}, {"count": 4, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": null, "id": 151236, "creation_time": "2011-11-06T20:24:40Z", "time": "2011-11-06T20:24:40Z", "bug_id": 50799, "text": "Test Case:\nDate: Sun Nov  6 20:18:40 2011\nNew Revision: 1198547\n\nURL: http://svn.apache.org/viewvc?rev=1198547&view=rev\nLog:\nTest Case that will fails until BUG 50799 is fixed.\n\nModified:\n   jmeter/trunk/test/src/org/apache/jmeter/testelement/PackageTest.java", "is_private": false}, {"count": 5, "tags": [], "bug_id": 50799, "attachment_id": null, "id": 151277, "time": "2011-11-07T21:22:43Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-11-07T21:22:43Z", "is_private": false, "text": "I wait for your further checks sebb to mark it as fixed.\n\nDate: Mon Nov  7 21:21:26 2011\nNew Revision: 1198945\n\nURL: http://svn.apache.org/viewvc?rev=1198945&view=rev\nLog:\nBug 50799 - Having a non-HTTP sampler in a http test plan prevents multiple header managers from working\n\nModified:\n   jmeter/trunk/src/core/org/apache/jmeter/testelement/AbstractTestElement.java\n   jmeter/trunk/test/src/org/apache/jmeter/testelement/PackageTest.java\n   jmeter/trunk/xdocs/changes.xml"}, {"count": 6, "tags": [], "bug_id": 50799, "is_private": false, "text": "Date: Mon Nov  7 22:08:15 2011\nNew Revision: 1198971\n\nURL: http://svn.apache.org/viewvc?rev=1198971&view=rev\nLog:\nBug 50799 - Having a non-HTTP sampler in a http test plan prevents multiple header managers from working\n\nThe good fix\n\nModified:\n   jmeter/trunk/src/core/org/apache/jmeter/testelement/AbstractTestElement.java", "id": 151279, "time": "2011-11-07T22:10:39Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2011-11-07T22:10:39Z", "attachment_id": null}, {"count": 7, "attachment_id": null, "creator": "p.mouawad@ubik-ingenierie.com", "is_private": false, "id": 151508, "time": "2011-11-15T13:13:49Z", "bug_id": 50799, "creation_time": "2011-11-15T13:13:49Z", "tags": [], "text": "Fix introduced issue 52187"}, {"count": 8, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "is_private": false, "id": 151510, "creation_time": "2011-11-15T13:23:05Z", "time": "2011-11-15T13:23:05Z", "bug_id": 50799, "text": "Date: Tue Nov 15 13:20:20 2011\nNew Revision: 1202175\n\nURL: http://svn.apache.org/viewvc?rev=1202175&view=rev\nLog:\nBug 50799 - Having a non-HTTP sampler in a http test plan prevents multiple header managers from working\n\nFix ROLLBACK", "attachment_id": null}, {"count": 9, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": null, "id": 157231, "creation_time": "2012-04-05T22:05:20Z", "time": "2012-04-05T22:05:20Z", "bug_id": 50799, "text": "Date: Thu Apr  5 22:04:43 2012\nNew Revision: 1310098\n\nURL: http://svn.apache.org/viewvc?rev=1310098&view=rev\nLog:\nBug 50799 - Having a non-HTTP sampler in a http test plan prevents multiple header managers from working\n\nModified:\n   jmeter/trunk/src/protocol/java/org/apache/jmeter/protocol/java/sampler/BSFSampler.java\n   jmeter/trunk/src/protocol/java/org/apache/jmeter/protocol/java/sampler/BeanShellSampler.java", "is_private": false}, {"count": 10, "tags": [], "bug_id": 50799, "attachment_id": null, "id": 157673, "time": "2012-04-08T08:00:56Z", "creator": "p.mouawad@ubik-ingenierie.com", "creation_time": "2012-04-08T08:00:56Z", "is_private": false, "text": "Fixed by changes done on Bug 53042"}]