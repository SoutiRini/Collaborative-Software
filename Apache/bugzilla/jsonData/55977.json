[{"count": 0, "tags": [], "creator": "luca.maragnani@gmail.com", "attachment_id": 31181, "is_private": false, "id": 172166, "time": "2014-01-08T10:20:31Z", "bug_id": 55977, "creation_time": "2014-01-08T10:20:31Z", "text": "Created attachment 31181\nJmeter log of the scenario.\n\nIn jdbc load test Keepalive age is not respected with bundled excalibur libraries. Versions tried: 2.9, 2.11, trunk.\n\nFor example, consider this configuration:\n- keepalive: true\n- Max Connection age: 5000\n- Validation query: select 1 from dual\n\nInsert in a thread group a jdbc sampler and a timer to execute 1 sample per second.\n\nEnabled debug in jmeter properties:\nlog_level.jmeter.protocol.jdbc=DEBUG\n\nIn the output in jmeter.log, after \"Max connection age\" seconds it seems that  the flag which marks the connection idle is not reset, and for every following sample a keepalive query is executed:\n2014/01/08 10:56:20 DEBUG - jmeter.protocol.jdbc.sampler.JDBCSampler: sampling jdbc\n2014/01/08 10:56:20 DEBUG - jmeter.protocol.jdbc.config.DataSourceElement: Got a com.sun.proxy.$Proxy0 from the pool.\n2014/01/08 10:56:20 DEBUG - jmeter.protocol.jdbc.config.DataSourceElement: Pinging database after 5999ms of inactivity.\n2014/01/08 10:56:20 DEBUG - jmeter.protocol.jdbc.AbstractJDBCTestElement: executing jdbc\n2014/01/08 10:56:20 DEBUG - jmeter.protocol.jdbc.config.DataSourceElement: Put a com.sun.proxy.$Proxy0 back into the pool.\n2014/01/08 10:56:21 DEBUG - jmeter.protocol.jdbc.sampler.JDBCSampler: sampling jdbc\n2014/01/08 10:56:21 DEBUG - jmeter.protocol.jdbc.config.DataSourceElement: Got a com.sun.proxy.$Proxy0 from the pool.\n2014/01/08 10:56:21 DEBUG - jmeter.protocol.jdbc.config.DataSourceElement: Pinging database after 6999ms of inactivity.\n2014/01/08 10:56:21 DEBUG - jmeter.protocol.jdbc.AbstractJDBCTestElement: executing jdbc\n\nIn attach the whole log.\n\nUnder heavy load the Oracle DB is flooded by keepalive queries that cause unexpected cpu utilization and latencies (even with dual table). \n\nI tried the latest jars from excalibur (datasource and pool) and the problem seem to me that is solved:\n- excalibur-datasource-1.2.0.jar\n- excalibur-pool-api-2.1.jar\n- excalibur-pool-impl-2.1.jar\n- excalibur-pool-instrumented-2.1.jar\n\nHope this helps to solve the problem, thanks.\n\nLuca"}, {"count": 1, "tags": [], "bug_id": 55977, "is_private": false, "text": "(In reply to Luca from comment #0)\n> ... \n> Under heavy load the Oracle DB is flooded by keepalive queries that cause\n> unexpected cpu utilization and latencies (even with dual table). \n> \n> I tried the latest jars from excalibur (datasource and pool) and the problem\n> seem to me that is solved:\n> - excalibur-datasource-1.2.0.jar\n\nDid you try datasource 2.1 ?\n\n> - excalibur-pool-api-2.1.jar\n\nI don't think you need the api jar.\n\n> - excalibur-pool-impl-2.1.jar\n> - excalibur-pool-instrumented-2.1.jar\n\nWe currently use the following:\n\nexcalibur-datasource.version = 1.1.1\nexcalibur-instrument.version = 1.0\nexcalibur-logger.version    = 1.1\nexcalibur-pool.version      = 1.2\n\nWhich of these did you keep?\n\n> Hope this helps to solve the problem, thanks.\n\nThanks very much, useful to know.\n \n> Luca", "id": 172177, "time": "2014-01-08T14:11:29Z", "creator": "sebb@apache.org", "creation_time": "2014-01-08T14:11:29Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 55977, "is_private": false, "text": "> Did you try datasource 2.1 ?\n\nI tried it now and seems working.\n\n> \n> > - excalibur-pool-api-2.1.jar\n> \n> I don't think you need the api jar.\n\nWithout the jar I get this exception:\n\n2014/01/08 15:22:16 ERROR - jmeter.JMeter: Uncaught exception:  java.lang.NoClassDefFoundError: org/apache/avalon/excalibur/pool/ObjectFactory\n        at org.apache.jmeter.protocol.jdbc.config.DataSourceElement.initPool(DataSourceElement.java:162)\n[...]\n \n> We currently use the following:\n> \n> excalibur-datasource.version = 1.1.1\n> excalibur-instrument.version = 1.0\n> excalibur-logger.version    = 1.1\n> excalibur-pool.version      = 1.2\n> \n> Which of these did you keep?\n\nHere is the list of excalibur jars that I'm using:\n\nexcalibur-instrument-1.0.jar\nexcalibur-logger-1.1.jar\nexcalibur-datasource-2.1.jar\nexcalibur-pool-api-2.1.jar\nexcalibur-pool-impl-2.1.jar\nexcalibur-pool-instrumented-2.1.jar\n\n\nThanks,\nLuca", "id": 172180, "time": "2014-01-08T14:33:22Z", "creator": "luca.maragnani@gmail.com", "creation_time": "2014-01-08T14:33:22Z", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 55977, "text": "(In reply to Luca from comment #2)\n> > Did you try datasource 2.1 ?\n> \n> I tried it now and seems working.\n\nGreat\n\n> > \n> > > - excalibur-pool-api-2.1.jar\n> > \n> > I don't think you need the api jar.\n> \n> Without the jar I get this exception:\n> \n> 2014/01/08 15:22:16 ERROR - jmeter.JMeter: Uncaught exception: \n> java.lang.NoClassDefFoundError:\n> org/apache/avalon/excalibur/pool/ObjectFactory\n>         at\n> org.apache.jmeter.protocol.jdbc.config.DataSourceElement.\n> initPool(DataSourceElement.java:162)\n> [...]\n\nMy bad, I assumed the API contained empty classes.\n  \n> > We currently use the following:\n> > \n> > excalibur-datasource.version = 1.1.1\n> > excalibur-instrument.version = 1.0\n> > excalibur-logger.version    = 1.1\n> > excalibur-pool.version      = 1.2\n> > \n> > Which of these did you keep?\n> \n> Here is the list of excalibur jars that I'm using:\n> \n> excalibur-instrument-1.0.jar\n> excalibur-logger-1.1.jar\n> excalibur-datasource-2.1.jar\n> excalibur-pool-api-2.1.jar\n> excalibur-pool-impl-2.1.jar\n> excalibur-pool-instrumented-2.1.jar\n> \n> Thanks,\n\nThanks again!", "id": 172184, "time": "2014-01-08T14:57:53Z", "creator": "sebb@apache.org", "creation_time": "2014-01-08T14:57:53Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "p.mouawad@ubik-ingenierie.com", "attachment_id": null, "is_private": false, "id": 172195, "time": "2014-01-08T21:32:28Z", "bug_id": 55977, "creation_time": "2014-01-08T21:32:28Z", "text": "It might be the opportunity to switch to Tomcat pool ."}, {"count": 5, "tags": [], "bug_id": 55977, "text": "(In reply to Philippe Mouawad from comment #4)\n> It might be the opportunity to switch to Tomcat pool .\n\nPlease create a new thread on the dev list about this.", "id": 172197, "time": "2014-01-08T21:59:20Z", "creator": "sebb@apache.org", "creation_time": "2014-01-08T21:59:20Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 55977, "text": "Fixed:\n\nURL: http://svn.apache.org/r1556884\nLog:\nJdbc pool keepalive flooding - update Excalibur versions\nBugzilla Id: 55977\n\nModified:\n    jmeter/trunk/build.properties\n    jmeter/trunk/build.xml\n    jmeter/trunk/eclipse.classpath\n    jmeter/trunk/lib/   (props changed)\n    jmeter/trunk/res/maven/ApacheJMeter_parent.pom\n\n\nURL: http://svn.apache.org/r1556889\nLog:\nJdbc pool keepalive flooding\nBugzilla Id: 55977\n\nModified:\n    jmeter/trunk/xdocs/changes.xml", "id": 172231, "time": "2014-01-09T17:43:24Z", "creator": "sebb@apache.org", "creation_time": "2014-01-09T17:43:24Z", "is_private": false, "attachment_id": null}]