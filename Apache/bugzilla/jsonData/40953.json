[{"count": 0, "tags": [], "bug_id": 40953, "attachment_id": null, "text": "Hi,\n\nWhen Apache passes a request of to a CGI or PHP script or the like, and that\nscript returns a 304 Not Modified header, and that script sends some additional\ncontent, Apache happily sends that content on to the client.\n\nAccording to RFC 2616, no content must be sent on a 304 Not Modified. This is\nultimately the responsibility of the script in question, but as Apache should be\nstrict in what it sends, it could stop any script output after it has sent a 304.", "id": 95728, "time": "2006-11-12T06:19:06Z", "creator": "thijs@debian.org", "creation_time": "2006-11-12T06:19:06Z", "is_private": false}, {"count": 1, "tags": [], "creator": "enc@comlab.ox.ac.uk", "attachment_id": null, "id": 114119, "time": "2008-02-29T02:43:27Z", "bug_id": 40953, "creation_time": "2008-02-29T02:43:27Z", "is_private": false, "text": "According to RFC 2616:\n\"All 1xx (informational), 204 (no content), and 304 (not modified) responses\n   MUST NOT include a message-body. \"\n\nI have just found that Safari - including the latest version - freezes when it gets content for these with other requests pending - i.e. it gets stuck.\n\nExample response:\n\nHTTP/1.1 204 No Content\nDate: Fri, 29 Feb 2008 09:45:53 GMT\nServer: Apache/2.2.4 (Ubuntu) mod_jk/1.2.23\nContent-Length: 8\nKeep-Alive: timeout=15, max=100\nConnection: Keep-Alive\nContent-Type: text/html;charset=ISO-8859-1\n\n(The 8 bytes is just whitespace from formatting in a jsp.)\n\nThe response is clearly incorrect.\n\nThe safest thing for Apache to do would be to set the content-length to 0 and discard any contents up to the advertised content-length from the cgi/php/servlet.\n"}, {"count": 2, "tags": [], "creator": "takashi.asfbugzilla@tks.st", "attachment_id": null, "id": 114121, "time": "2008-02-29T04:06:41Z", "bug_id": 40953, "creation_time": "2008-02-29T04:06:41Z", "is_private": false, "text": "IMHO if a CGI sends 304 with content and apache sends it to client, this is not an apache's but CGI's fault. So this issue is renhancement request."}, {"count": 3, "tags": [], "creator": "enc@comlab.ox.ac.uk", "attachment_id": null, "id": 114122, "time": "2008-02-29T04:19:12Z", "bug_id": 40953, "creation_time": "2008-02-29T04:19:12Z", "is_private": false, "text": "(In reply to comment #2)\n> IMHO if a CGI sends 304 with content and apache sends it to client, this is not\n> an apache's but CGI's fault. So this issue is renhancement request.\n> \nI can accept that it is a fine line between any cgi/script/php/servlet not respecting the RFC and apache not respecting it for 304 not modified but I have a higher opinion of apache.\n\nShould I then open a new bug for the 204 no content response?\n\nWhat about the 1xx responses?\n"}, {"count": 4, "tags": [], "creator": "takashi.asfbugzilla@tks.st", "text": "> I can accept that it is a fine line between any cgi/script/php/servlet not\n> respecting the RFC and apache not respecting it for 304 not modified\n\nI agree.\nI still think \"Severity\" should be \"enhancement\" but just a little thing.\n\n> Should I then open a new bug for the 204 no content response?\n> What about the 1xx responses?\n\nI've renaming this report's sumary.", "id": 114124, "time": "2008-02-29T05:15:06Z", "bug_id": 40953, "creation_time": "2008-02-29T05:15:06Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 40953, "text": "(In reply to comment #4)\n> I agree.\n> I still think \"Severity\" should be \"enhancement\" but just a little thing.\n> I've renaming this report's sumary.\n\nThankyou :-) \n\n", "count": 5, "id": 114125, "time": "2008-02-29T05:19:19Z", "creator": "enc@comlab.ox.ac.uk", "creation_time": "2008-02-29T05:19:19Z", "is_private": false}, {"count": 6, "tags": [], "creator": "ezyang@mit.edu", "attachment_id": null, "id": 124955, "time": "2009-02-18T13:49:04Z", "bug_id": 40953, "creation_time": "2009-02-18T13:49:04Z", "is_private": false, "text": "We've run into this \"feature enhancement request\" recently. It's actually a more specific example of the fact that Apache doesn't sanity check Status Code/Content-Length headers that scripts send back. For example, I can take advantage of this to make a CGI script send two HTTP responses back to a user, when Keep-Alive is on and a single connection is used:\n\nPoC: https://scripts.mit.edu/~apo/mitchtest/304.py\nCode: http://mit.edu/~mitchb/Public/304.py\n\nIf the PoC works (it occasionally fails, if that happens, try again), it will redirect you to https://scripts.mit.edu/~geofft but will display \"Injected Content\", which was the second HTTP request sent.\n\nThere is also a relevant Firefox bug:\nhttps://bugzilla.mozilla.org/show_bug.cgi?id=363109#c12\n\nIt would be very nice to see this fixed."}, {"count": 7, "tags": [], "creator": "nick@webthing.com", "attachment_id": null, "id": 124957, "time": "2009-02-18T16:27:30Z", "bug_id": 40953, "creation_time": "2009-02-18T16:27:30Z", "is_private": false, "text": "This now looks like two separate issues.  Comment 6 concerns a 302 response with a Content-Length header but too much content.  FWIW, I expect it can be more easily duplicated with mod_asis.\n\nFWIW, I *think* (but haven't tested - bug me if I drop it) the following patch should fix the original issue.  But it won't do anything for your 302 case.\n\n--- server/util_script.c        (revision 745696)\n+++ server/util_script.c        (working copy)\n@@ -488,6 +488,11 @@\n             if ((cgi_status == HTTP_UNSET) && (r->method_number == M_GET)) {\n                 cond_status = ap_meets_conditions(r);\n             }\n+            else if ((cgi_status == HTTP_NO_CONTENT) ||\n+                     (cgi_status == HTTP_NOT_MODIFIED) ||\n+                     ap_is_HTTP_INFO(cgi_status)) {\n+                r->header_only = 1; /* discard any body */\n+            }\n             apr_table_overlap(r->err_headers_out, merge,\n                 APR_OVERLAP_TABLES_MERGE);\n             if (!apr_is_empty_table(cookie_table)) {"}, {"count": 8, "tags": [], "creator": "nick@webthing.com", "attachment_id": null, "id": 125887, "time": "2009-03-30T13:53:09Z", "bug_id": 40953, "creation_time": "2009-03-30T13:53:09Z", "is_private": false, "text": "Fixed in trunk - r760167.\n\nChanged from the patch I posted in that I dropped 1xx responses and just fixup 204/304.  Since this is about httpd correcting a broken script, we should be conservative in correcting something that might possibly be intentional, like a comet-ish script sending a 100-continue followed by more."}, {"count": 9, "tags": [], "text": "Patch was vetoed by Roy T. Fielding.", "attachment_id": null, "bug_id": 40953, "id": 125907, "time": "2009-03-31T07:39:32Z", "creator": "ezyang@mit.edu", "creation_time": "2009-03-31T07:39:32Z", "is_private": false}]