[{"count": 0, "tags": [], "text": "A program I am working on is throwing an exception \njava.lang.StringIndexOutOfBoundsException: String index out of range: -1\nfrom within\norg.apache.jasper.runtime.JspRuntimeLibrary.getContextRelativePath\n(JspRuntimeLibrary.java:963)\n\nAccording to the docs http://jakarta.apache.org/tomcat/tomcat-5.0-\ndoc/servletapi/javax/servlet/http/HttpServletRequest.html#getServletPath(), \ngetServletPath() can return an empty string which is what is happening in my \napp.  The line in question:\n\n    uri.substring(0, uri.lastIndexOf('/')) + '/' + relativePath\n\nwhere uri is an empty string is what is causing this exception to be thrown.  \nAs you can see uri.lastIndexOf is going to return -1 and uri.substring(0, -1) \njust does not work.", "is_private": false, "id": 54889, "creation_time": "2004-03-30T18:17:25Z", "time": "2004-03-30T18:17:25Z", "creator": "pruchaba_bah@scrb.navy.mil", "bug_id": 28058, "attachment_id": null}, {"count": 1, "tags": [], "creator": "jan.luehe@sun.com", "attachment_id": null, "text": "I was able to reproduce your problem w/ TC 5.0.19.\n\nI assume you have a chain of jsp:include, and have the following jsp-config\nelement in your web.xml:\n\n    <jsp-config>\n      <jsp-property-group>\n        <url-pattern>/*</url-pattern>\n      </jsp-property-group>\n    </jsp-config>\n\nIf so, this bug has already been fixed - it is a duplicate of Bugzilla 27704\n(\"Result of request.getServletPath() wrong in case JSP inside\njsp-property-group\").\n\nThe fix is in CVS, and will be available in TC 5.0.21.\n\nPlease confirm that your problem is being caused by the above jsp-config, and I\nwill go ahead and close this bug as a duplicate of Bugzilla 27704.", "id": 54893, "time": "2004-03-30T19:21:38Z", "bug_id": 28058, "creation_time": "2004-03-30T19:21:38Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 28058, "text": "Thats my problem.  Though it's not a chain of jsp includes.  I have a servlet \nthat forwards a request to a JSP using the \"jsp\" named dispatcher.  The JSP \nthen has an include in it.", "id": 54896, "time": "2004-03-30T19:29:16Z", "creator": "pruchaba_bah@scrb.navy.mil", "creation_time": "2004-03-30T19:29:16Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "text": "The servlet is at\n\n  <servlet-mapping>\n    <servlet-name>foo</servlet-name>\n    <url-pattern>/*</url-pattern>\n  </servlet-mapping>\n", "is_private": false, "id": 54897, "creation_time": "2004-03-30T19:32:26Z", "time": "2004-03-30T19:32:26Z", "creator": "pruchaba_bah@scrb.navy.mil", "bug_id": 28058, "attachment_id": null}, {"count": 4, "tags": [], "creator": "pruchaba_bah@scrb.navy.mil", "attachment_id": 11064, "text": "Created attachment 11064\nTest Case", "id": 54900, "time": "2004-03-30T20:25:33Z", "bug_id": 28058, "creation_time": "2004-03-30T20:25:33Z", "is_private": false}, {"count": 5, "tags": [], "bug_id": 28058, "text": "I have attached a test case.\n\n/test/jsp/test.jsp displays \"This is a test\"\n/test/jsp/include.jsp throws java.lang.StringIndexOutOfBoundsException", "id": 54901, "time": "2004-03-30T20:26:13Z", "creator": "pruchaba_bah@scrb.navy.mil", "creation_time": "2004-03-30T20:26:13Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 28058, "text": "I was able to reproduce this bug using the servlet wildcard mapping.\n\nBugzilla 27704 fixes the problem where the including JSP was mapped to by\na \"/*\" jsp-config mapping (and getServletPath() used to be empty), but it does\nnot address the case where a servlet mapped to by \"/*\" is the entry point.\n\nKin-Man committed a fix earlier that fixes this problem.", "id": 54903, "time": "2004-03-30T20:41:17Z", "creator": "jan.luehe@sun.com", "creation_time": "2004-03-30T20:41:17Z", "is_private": false, "attachment_id": null}, {"count": 7, "attachment_id": null, "creator": "jan.luehe@sun.com", "is_private": false, "id": 54912, "time": "2004-03-30T23:59:55Z", "bug_id": 28058, "creation_time": "2004-03-30T23:59:55Z", "tags": [], "text": "I think your test case has a problem unrelated to the\nStringIndexOutOfBoundsException issue it uncovered.\n\nNot only the initial request, but also the target of your <jsp:include> will be\nrouted through your \"test\" servlet (due to the \"/*\" mapping), which means you\nend up doing a request dispatcher forward (from your servlet) inside an include.\n\nAs a result of this, you'll see this warning in the logs:\n\n  WARNING: Internal error flushing the buffer in release(): java.io.IOException:\nStream closed\n\nwhen releasing the page context of the including JSP.\n"}, {"count": 8, "tags": [], "bug_id": 28058, "text": "You are right.  I ended up stripping out the code to handle that because I \nnever got that far.  Here is the code:\n\nimport java.io.IOException;\n\nimport javax.servlet.RequestDispatcher;\nimport javax.servlet.ServletContext;\nimport javax.servlet.ServletException;\nimport javax.servlet.http.HttpServlet;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\n\n/**\n * Example servlet\n *\n */\n\npublic class Test extends HttpServlet {\n\n\tpublic void service(HttpServletRequest req, HttpServletResponse resp)\n\t\tthrows ServletException, IOException {\n\t\n\t\tServletContext sc = getServletContext();\n\t\tRequestDispatcher rd = sc.getNamedDispatcher(\"jsp\");\n\n\t\tObject attr = req.getAttribute\t\t\t\t\t\n\t            (\"javax.servlet.include.request_uri\");\n\t\t\n\t\tif (attr != null) {\n\t\t\trd.include(req, resp);\n\t\t\treq.setAttribute(\"javax.servlet.include.request_uri\", \n                            attr);\n\t\t} else {\n\t\t\ttry {\n\t\t\t\trd.forward(req, resp);\n\t\t\t} catch (IllegalStateException e) {\n\t\t\t\trd.include(req, resp);\n\t\t\t}\n\t\t}\n\t}\n}\n\n", "id": 54984, "time": "2004-03-31T17:35:37Z", "creator": "pruchaba_bah@scrb.navy.mil", "creation_time": "2004-03-31T17:35:37Z", "is_private": false, "attachment_id": null}]