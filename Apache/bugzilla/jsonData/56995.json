[{"count": 0, "tags": [], "bug_id": 56995, "attachment_id": null, "text": "We are using tomcat 7.0.55 with bio connector.\n\nWe are seeing threads go into bad BLOCKED state when client's throw IOException when trying to flush and the process tries to call setErrorState which then calls processSocketAsync. But processSocketAsync waits to hold a lock on the socket which previously held by the processor.\n\nBelow is part of the stacktrace where it shows this.\n\n\"http-bio-0.0.0.0-8042-exec-35\" daemon prio=10 tid=0x0000000003647000 nid=0x3605 waiting on condition [0x00007f0e02d8c000]\n   java.lang.Thread.State: WAITING (parking)\n        at sun.misc.Unsafe.park(Native Method)\n        - parking to wait for  <0x000000073d3d20b0> (a com.google.common.util.concurrent.AbstractFuture$Sync)\n        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)\n        at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:834)\n        at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:994)\n        at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1303)\n        at com.google.common.util.concurrent.AbstractFuture$Sync.get(AbstractFuture.java:285)\n        at com.google.common.util.concurrent.AbstractFuture.get(AbstractFuture.java:116)\n        at com.yahoo.yql.plus.writer.ResultEnvelope.processResults(ResultEnvelope.java:140)\n        at com.yahoo.yql.plus.writer.ResultEnvelope.write(ResultEnvelope.java:64)\n        at com.yahoo.yql.plus.writer.ResultEnvelope.write(ResultEnvelope.java:57)\n        at com.yahoo.yql.plus.ProgramEngine.write(ProgramEngine.java:247)\n        at com.yahoo.yql.plus.ProgramEngine.execute(ProgramEngine.java:221)\n        at com.yahoo.yql.plus.ProgramEngine.execute(ProgramEngine.java:263)\n        at com.yahoo.yql.core.Container.executeProgramRequest(Container.java:340)\n        at com.yahoo.yql.container.servlet.filter.DispatchFilter.doFilter(DispatchFilter.java:154)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\n        at yjava.servlet.FilterChainInvoker$ServletFilterChainInvoker.invoke(FilterChainInvoker.java:49)\n        at yjava.servlet.filter.YHdrsFilter.doFilter(YHdrsFilter.java:69)\n        at yjava.servlet.filter.YHdrsFilter.doFilter(YHdrsFilter.java:53)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\n        at yjava.servlet.FilterChainInvoker$ServletFilterChainInvoker.invoke(FilterChainInvoker.java:49)\n        at yjava.cookie.CookieDataFilter.doFilter(CookieDataFilter.java:135)\n        at yjava.cookie.CookieDataFilter.doFilter(CookieDataFilter.java:111)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\n        at yjava.servlet.FilterChainInvoker$ServletFilterChainInvoker.invoke(FilterChainInvoker.java:49)\n        at yjava.servlet.filter.SSLCrimeFilter.doFilter(SSLCrimeFilter.java:82)\n        at yjava.servlet.filter.SSLCrimeFilter.doFilter(SSLCrimeFilter.java:47)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\n        at yjava.servlet.FilterChainInvoker$ServletFilterChainInvoker.invoke(FilterChainInvoker.java:49)\n        at yjava.servlet.filter.DoNotTrackFilter.doFilter(DoNotTrackFilter.java:110)\n        at yjava.servlet.filter.DoNotTrackFilter.doFilter(DoNotTrackFilter.java:50)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\n        at yjava.servlet.FilterChainInvoker$ServletFilterChainInvoker.invoke(FilterChainInvoker.java:49)\n        at yjava.remote.ip.RemoteIPFilter.doFilter(RemoteIPFilter.java:104)\n        at yjava.remote.ip.RemoteIPFilter.doFilter(RemoteIPFilter.java:65)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\n        at yjava.servlet.FilterChainInvoker$ServletFilterChainInvoker.invoke(FilterChainInvoker.java:49)\n        at yjava.security.yiv.servlet.InputValidationFilter.doFilter(InputValidationFilter.java:244)\n        at yjava.security.yiv.servlet.InputValidationFilter.doFilter(InputValidationFilter.java:151)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\n        at yjava.servlet.FilterChainInvoker$ServletFilterChainInvoker.invoke(FilterChainInvoker.java:49)\n        at yjava.servlet.filter.StatsFilter.doFilter(StatsFilter.java:90)\n        at yjava.servlet.filter.StatsFilter.doFilter(StatsFilter.java:65)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:220)\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:122)\n        at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:501)\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:103)\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:116)\n        at com.yahoo.yjava.AccessLogValveCopy.invoke(AccessLogValveCopy.java:580)\n        at yjava.tomcat.valves.YahooConnectionValve.invoke(YahooConnectionValve.java:141)\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)\n        at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1070)\n        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:611)\n        at org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:314)\n        - locked <0x000000073cff7db0> (a org.apache.tomcat.util.net.SocketWrapper)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n        at java.lang.Thread.run(Thread.java:724)\n\n\n\nThis is a thread that throws IOException and waiting to get hold of lock on the socket which is privioulsy held by above http-bio thread.\n\n\"work-7907\" daemon prio=10 tid=0x0000000004b26800 nid=0x3a16 waiting for monitor entry [0x00007f0d8116b000]\n   java.lang.Thread.State: BLOCKED (on object monitor)\n        at org.apache.tomcat.util.net.JIoEndpoint.processSocketAsync(JIoEndpoint.java:560)\n        - waiting to lock <0x000000073cff7db0> (a org.apache.tomcat.util.net.SocketWrapper)\n        at org.apache.coyote.AbstractProcessor.setErrorState(AbstractProcessor.java:84)\n        at org.apache.coyote.http11.AbstractHttp11Processor.action(AbstractHttp11Processor.java:802)\n        at org.apache.coyote.Response.action(Response.java:172)\n        at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:363)\n        at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:331)\n        at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:101)\n        at java.io.PrintStream.flush(PrintStream.java:338)\n        - locked <0x000000073cff7e10> (a java.io.PrintStream)\n        at com.yahoo.media.yql.lib.listener.ProtoSerializer.writeMessagePart(ProtoSerializer.java:77)\n        at com.yahoo.media.yql.lib.listener.ProtoSerializer.onResultSuccess(ProtoSerializer.java:59)\n        at com.yahoo.yql.plus.writer.ResultEnvelope$YQLResultCallback.onSuccess(ResultEnvelope.java:192)\n        - locked <0x000000073cff7e50> (a com.yahoo.yql.plus.ProgramResponseImpl)\n        at com.yahoo.yql.plus.writer.ResultEnvelope$YQLResultCallback.onSuccess(ResultEnvelope.java:146)\n        at com.google.common.util.concurrent.Futures$4.run(Futures.java:1169)\n        at com.google.common.util.concurrent.MoreExecutors$SameThreadExecutorService.execute(MoreExecutors.java:297)\n        at com.google.common.util.concurrent.ExecutionList.executeListener(ExecutionList.java:156)\n        at com.google.common.util.concurrent.ExecutionList.execute(ExecutionList.java:145)\n        at com.google.common.util.concurrent.AbstractFuture.set(AbstractFuture.java:185)\n        at com.google.common.util.concurrent.Futures$ChainingListenableFuture$1.run(Futures.java:860)\n        at com.google.common.util.concurrent.MoreExecutors$SameThreadExecutorService.execute(MoreExecutors.java:297)\n        at com.google.common.util.concurrent.Futures$ImmediateFuture.addListener(Futures.java:100)\n        at com.google.common.util.concurrent.Futures$ChainingListenableFuture.run(Futures.java:856)\n        at com.google.common.util.concurrent.MoreExecutors$SameThreadExecutorService.execute(MoreExecutors.java:297)\n        at com.yahoo.yqlplus.engine.internal.scope.ExecutionScoper$1.execute(ExecutionScoper.java:99)\n        at com.google.common.util.concurrent.ExecutionList.executeListener(ExecutionList.java:156)\n        at com.google.common.util.concurrent.ExecutionList.execute(ExecutionList.java:145)\n        at com.google.common.util.concurrent.AbstractFuture.set(AbstractFuture.java:185)\n        at com.google.common.util.concurrent.SettableFuture.set(SettableFuture.java:53)\n        at com.yahoo.yqlplus.engine.internal.java.runtime.TimeoutHandler$3.onSuccess(TimeoutHandler.java:100)\n        at com.google.common.util.concurrent.Futures$4.run(Futures.java:1169)\n        at com.google.common.util.concurrent.MoreExecutors$SameThreadExecutorService.execute(MoreExecutors.java:297)\n        at com.google.common.util.concurrent.ExecutionList.executeListener(ExecutionList.java:156)\n        at com.google.common.util.concurrent.ExecutionList.execute(ExecutionList.java:145)\n        at com.google.common.util.concurrent.AbstractFuture.set(AbstractFuture.java:185)\n        at com.google.common.util.concurrent.SettableFuture.set(SettableFuture.java:53)\n        at com.yahoo.yqlplus.engine.internal.programs.Program62219060_b47e_42cb_b726_b87eaabec462.task_109(Program62219060_b47e_42cb_b726_b87eaabec462.java)\n        at java.lang.invoke.LambdaForm$DMH/33003170.invokeSpecial_L_V(LambdaForm$DMH)\n        at java.lang.invoke.LambdaForm$BMH/1542947881.reinvoke(LambdaForm$BMH)\n        at java.lang.invoke.LambdaForm$MH/1589590023.exactInvoker(LambdaForm$MH)\n        at java.lang.invoke.LambdaForm$MH/1744671065.exactInvoker(LambdaForm$MH)\n        at java.lang.invoke.LambdaForm$MH/1579626491.collect(LambdaForm$MH)\n        at java.lang.invoke.LambdaForm$MH/284451544.invoke_MT(LambdaForm$MH)\n        at com.yahoo.yqlplus.engine.internal.java.functions.MethodHandleRunnable.run(MethodHandleRunnable.java:19)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:262)\n        at com.yahoo.yqlplus.engine.internal.scope.ExecutionScoper$2.run(ExecutionScoper.java:113)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:724)", "id": 177966, "time": "2014-09-19T00:21:59Z", "creator": "charlesk40@yahoo.com", "creation_time": "2014-09-19T00:21:59Z", "is_private": false}, {"count": 1, "tags": [], "bug_id": 56995, "attachment_id": null, "id": 177967, "time": "2014-09-19T00:30:15Z", "creator": "charlesk40@yahoo.com", "creation_time": "2014-09-19T00:30:15Z", "is_private": false, "text": "locks the socket here.\n\nhttp://svn.apache.org/repos/asf/tomcat/tc7.0.x/tags/TOMCAT_7_0_55/java/org/apache/tomcat/util/net/JIoEndpoint.java\n\n        @Override\n        public void run() {\n            boolean launch = false;\n            synchronized (socket) {\n                try {\n                    SocketState state = SocketState.OPEN;\n\nclient tries to flush but throws IOException\n\nhttp://svn.apache.org/repos/asf/tomcat/tc7.0.x/tags/TOMCAT_7_0_55/java/org/apache/coyote/http11/AbstractHttp11Processor.java\n\n       case CLIENT_FLUSH: {\n            try {\n                getOutputBuffer().flush();\n            } catch (IOException e) {\n                setErrorState(ErrorState.CLOSE_NOW, e);\n                response.setErrorException(e);\n            }\n            break;\n        }\n\nCalls setErrorState and which then calls processSocketAsync\n\n\n  /**\n     * Update the current error state to the new error state if the new error\n     * state is more severe than the current error state.\n     */\n    protected void setErrorState(ErrorState errorState, Throwable t) {\n        boolean blockIo = this.errorState.isIoAllowed() && !errorState.isIoAllowed();\n        this.errorState = this.errorState.getMostSevere(errorState);\n        if (blockIo && !ContainerThreadMarker.isContainerThread()) {\n            // The error occurred on a non-container thread which means not all\n            // of the necessary clean-up will have been completed. Dispatch to\n            // a container thread to do the clean-up. Need to do it this way to\n            // ensure that all the necessary clean-up is performed.\n            if (response.getStatus() < 400) {\n                response.setStatus(500);\n            }\n            getLog().info(sm.getString(\"abstractProcessor.nonContainerThreadError\"), t);\n            getEndpoint().processSocketAsync(socketWrapper, SocketStatus.CLOSE_NOW);\n        }\n    }\n\n\nTries to hold the same lock here causing threads to be in bad BLOCKED states which eventually make all available threads to hang.\n\nhttp://svn.apache.org/repos/asf/tomcat/tc7.0.x/tags/TOMCAT_7_0_55/java/org/apache/tomcat/util/net/JIoEndpoint.java\n\n    @Override\n    public void processSocketAsync(SocketWrapper<Socket> socket,\n            SocketStatus status) {\n        try {\n            synchronized (socket) {\n                if (waitingRequests.remove(socket)) {"}, {"count": 2, "tags": [], "bug_id": 56995, "attachment_id": null, "id": 177968, "time": "2014-09-19T00:38:19Z", "creator": "charlesk40@yahoo.com", "creation_time": "2014-09-19T00:38:19Z", "is_private": false, "text": "Please let me know if you need any other information.\nThank you."}, {"count": 3, "tags": [], "bug_id": 56995, "attachment_id": null, "text": "You have two threads trying to write to the socket at the same time. That is not permitted.", "id": 178023, "time": "2014-09-22T11:04:00Z", "creator": "markt@apache.org", "creation_time": "2014-09-22T11:04:00Z", "is_private": false}, {"count": 4, "tags": [], "bug_id": 56995, "attachment_id": null, "text": "Okay. I'm trying to understand this better. So is the synchronization on the socket only implemented for handling exceptions?\nApplication should not use separate thread to do any of response write/flush using BIO connector? Tomcat doesn't seem to prevent that and it works when there are no exceptions.\nThanks.", "id": 178186, "time": "2014-09-29T22:10:32Z", "creator": "charlesk40@yahoo.com", "creation_time": "2014-09-29T22:10:32Z", "is_private": false}]