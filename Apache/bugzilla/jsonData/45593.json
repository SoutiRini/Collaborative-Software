[{"count": 0, "tags": [], "creator": "vinod.sangwan@ebusinessware.com", "is_private": false, "text": "I have an excel file with following:\nRow1, column a1 to e1 has value AAA. \nRow2 Col1 has a formula \"=sum(a1:e1)\"\nRow2 Col2 has a formula \"=A1+B1+C1+D1+E1\"\n\nNow I read this excel sheet using POI, and modify the AAA values to 5.\nAnd used the following to calculate formulas, but Row2Col1 calculate to 0, where as Row2Col2 calculates to 30:\n--------------------------\n\t\tfor(int sheetNum = 0; sheetNum < wb.getNumberOfSheets(); sheetNum++) {\n\t\t\tHSSFSheet sheet = wb.getSheetAt(sheetNum);\n\t\t\tHSSFFormulaEvaluator evaluator = new HSSFFormulaEvaluator(sheet, wb);\n\n\t\t\tfor(Iterator rit = sheet.rowIterator(); rit.hasNext();) {\n\t\t\t\tHSSFRow r = (HSSFRow)rit.next();\n\t\t\t\tevaluator.setCurrentRow(r);\n\n\t\t\t\tfor(Iterator cit = r.cellIterator(); cit.hasNext();) {\n\t\t\t\t\tHSSFCell c = (HSSFCell)cit.next();\n\t\t\t\t\tif(c.getCellType() == HSSFCell.CELL_TYPE_FORMULA) {\n\t\t\t\t\t\tevaluator.evaluateFormulaCell(c);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n---------------------------------", "id": 119568, "time": "2008-08-07T14:49:07Z", "bug_id": 45593, "creation_time": "2008-08-07T14:49:07Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "josh@apache.org", "attachment_id": null, "text": "I'm having trouble reproducing this bug.  I tried on version 3.1 and also svn trunk, and both seem to be OK.  Here is the code I used:\n\nInputStream is = new FileInputStream(\"c:/temp/ex44593.xls\");\nHSSFWorkbook wb = new HSSFWorkbook(is);\nHSSFSheet sheet = wb.getSheetAt(0);\nHSSFRow row = sheet.getRow(0);\nfor(int i=0; i<5; i++) {\n\trow.getCell(i).setCellValue(5.0);\n}\nrow = sheet.getRow(1);\nHSSFFormulaEvaluator evaluator = new HSSFFormulaEvaluator(sheet, wb);\nevaluator.setCurrentRow(row);\nSystem.out.println(evaluator.evaluate(row.getCell(0)).getNumberValue());\nSystem.out.println(evaluator.evaluate(row.getCell(1)).getNumberValue());\nsheet.setForceFormulaRecalculation(true);\nFileOutputStream fos = new FileOutputStream(\"c:/temp/ex44593-out.xls\");\nwb.write(fos);\nfos.close();\n\n----\n\nThe output is:\n25.0\n25.0\n\n----\n\nI tried to create the input spreadsheet according to your instructions. I'll attach it for reference.\n\nI'm  closing the bug for the moment, but please re-open if you can clarify how to reproduce the problem.", "id": 119583, "time": "2008-08-08T00:30:53Z", "bug_id": 45593, "creation_time": "2008-08-08T00:30:53Z", "is_private": false}, {"count": 2, "tags": [], "text": "Created attachment 22409\nInput spreadsheet", "attachment_id": 22409, "bug_id": 45593, "id": 119584, "time": "2008-08-08T00:32:35Z", "creator": "josh@apache.org", "creation_time": "2008-08-08T00:32:35Z", "is_private": false}, {"count": 3, "tags": [], "creator": "vinod.sangwan@ebusinessware.com", "is_private": false, "text": "Created attachment 22413\nThis is the input file", "id": 119595, "time": "2008-08-08T04:11:58Z", "bug_id": 45593, "creation_time": "2008-08-08T04:11:58Z", "attachment_id": 22413}, {"attachment_id": 22414, "tags": [], "bug_id": 45593, "is_private": false, "count": 4, "id": 119596, "time": "2008-08-08T04:12:29Z", "creator": "vinod.sangwan@ebusinessware.com", "creation_time": "2008-08-08T04:12:29Z", "text": "Created attachment 22414\nThis is the output file"}, {"count": 5, "tags": [], "creator": "vinod.sangwan@ebusinessware.com", "is_private": false, "text": "Created attachment 22415\nThis is the code\n\nThis is the code which is not calculating the formulas correctly", "id": 119597, "time": "2008-08-08T04:14:21Z", "bug_id": 45593, "creation_time": "2008-08-08T04:14:21Z", "attachment_id": 22415}, {"attachment_id": null, "tags": [], "bug_id": 45593, "is_private": false, "count": 6, "id": 119598, "time": "2008-08-08T04:18:06Z", "creator": "vinod.sangwan@ebusinessware.com", "creation_time": "2008-08-08T04:18:06Z", "text": "The code attached is a simple java file('This is the code') with main method, where we are replacing values of cells with 5, and the formula is not working.\n\nAlso find attached the input file ('This is the input file') and output file ('This is the output file').\n\nKindly suggest, what is wrong in here as my requirement is that I have to dynamically change the Strings with actual values, and the formula should be calculated.\n\nThanks,\nVinod"}, {"count": 7, "tags": [], "creator": "josh@apache.org", "attachment_id": null, "text": "I'm sorry but you'll have to be clearer about what you mean by 'the formula is not working'.   Is it the value actually calculated by POI evaluator or value shown by the spreadsheet when it opens in Excel? (they are not guaranteed to be the same)  Which cell?\n\nI just ran your attached code with the attached sheet.  The following formula values were calculated:\n\nG1 -> 0.0\nH1 -> 0.0\nI1 -> 25.0\nJ1 -> 1.0\nK1 -> 0.0\nG2 -> 25.0\n\nThe same values are visible when I open the file in Excel (2007). Your attached output file looks the same to me.\n\nCan you be more specific please?", "id": 119620, "time": "2008-08-08T09:16:55Z", "bug_id": 45593, "creation_time": "2008-08-08T09:16:55Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 45593, "text": "The value of G1 is coming out to be 0 where as it should be 30. This is using formula \"=SUM(A1:F1)\".\n\nBut instead of using this SUM formula, if I use \"=A1+B1+C1+D1+E1\", then it works fine, see cell G2.\n\nI took the source code of POI to find out that the if clause is not executed in the following: \nClass - org.apache.poi.hssf.record.formula.eval.ValueEvalToNumericXlator\nMethod - xlateRefStringEval\n\nTo test this I modified this method xlateRefStringEval\nif ( (flags & REF_STRING_IS_PARSED) > 0) {\nto\nif ( true || (flags & REF_STRING_IS_PARSED) > 0) { // forcing to go in if block\n\nand then the SUM formula worked.", "count": 8, "id": 119622, "time": "2008-08-08T09:39:38Z", "creator": "vinod.sangwan@ebusinessware.com", "creation_time": "2008-08-08T09:39:38Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 45593, "text": "(In reply to comment #8)\n> The value of G1 is coming out to be 0 where as it should be 30. This is using\n> formula \"=SUM(A1:F1)\".\n> \n> But instead of using this SUM formula, if I use \"=A1+B1+C1+D1+E1\", then it\n> works fine, see cell G2.\n\nPOI is just replicating Excel's behaviour here.  Excel evaluates G1 to 0.00 too.\n\nThere are quite a few tricks/inconsistencies in the implicit type conversions that Excel does while evaluating formulas.  For example, sum(\"5\", \"5\", \"5\", \"5\", \"5\") = 25. \nGo figure.\n\n\nPOI does not attempt to 'correct' these inconsistencies.", "count": 9, "id": 119632, "time": "2008-08-08T17:11:43Z", "creator": "josh@apache.org", "creation_time": "2008-08-08T17:11:43Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 45593, "is_private": false, "count": 10, "id": 119636, "time": "2008-08-09T03:36:12Z", "creator": "vinod.sangwan@ebusinessware.com", "creation_time": "2008-08-09T03:36:12Z", "text": "The excel is evaluating G1 correctly, if you replace cell A1 to F1 with value 5 in the input file , the excel will correctly sum this to 30, but when we replace the values using POI, the calculation comes out to be 0."}, {"count": 11, "tags": [], "creator": "vinod.sangwan@ebusinessware.com", "text": "Kindly update.", "id": 119718, "time": "2008-08-12T07:46:55Z", "bug_id": 45593, "creation_time": "2008-08-12T07:46:55Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "creator": "josh@apache.org", "is_private": false, "text": "(In reply to comment #10)\n\nNote that there is a difference between a text cell with value \"5\" and a numeric cell with value 5.0.  In the excel UI, the user can choose either text or numeric format when entering cell values. Text values can be forced by prepending a single quote (') to the entered text.  For example '5 will create a text value \"5\".\n\n\nThe sample code I added in  comment #1 uses numeric cells:\ncell.setCellValue(5.0);\n... which Excel/SUM() handles 'normally'.\n\nYour sample code (from attachment id=22415) uses text cells: \ncell.setCellValue(new HSSFRichTextString(\"5\"));\n... which Excel/SUM() ignores. \n\n\n\nI am still sure that POI is consistent with Excel's behaviour\n\n\n\n", "id": 119909, "time": "2008-08-19T01:14:42Z", "bug_id": 45593, "creation_time": "2008-08-19T01:14:42Z", "attachment_id": null}, {"attachment_id": null, "tags": [], "bug_id": 45593, "text": "Ok, got it. Now I am setting it as follows and it works fine.\n\n----------------------\nString outputStr = replaceVariable(inputStr);\n\ntry {\n\tdouble kkk = Double.parseDouble(outputStr);\n\tcell.setCellValue(kkk);\n} catch (NumberFormatException e) {\n\t// this is a string, so set as string\n\tcell.setCellValue(new HSSFRichTextString(outputStr));\n}----------------------\n\nThanks a lot for your help.", "count": 13, "id": 119999, "time": "2008-08-21T13:24:28Z", "creator": "vinod.sangwan@ebusinessware.com", "creation_time": "2008-08-21T13:24:28Z", "is_private": false}]