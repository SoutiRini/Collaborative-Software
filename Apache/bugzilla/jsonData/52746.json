[{"count": 0, "tags": [], "creator": "freds@jfrog.org", "text": "We have an application were all the jars reside in the shared (or common) classloader of Tomcat, and then we are starting multiple webapp using the common jars.\nThis setup works good with Java 1.6 and 1.7 on Tomcat 7.0.14.\nWhen using Tomcat 7.0.16-19-22 and 26 (the 4 versions I tested), on both JVM, we are getting the following for a random number of webapps (4 out of 11 always deploys, 7 fails) on a single tomcat instance.\n\nSo, we tried to debug when, who, why the \u201cjava.util.zip.InflaterInputStream\u201d was closed before the web application finished loading the resources and classes.\nIn debug mode with a breaking point on \u201cjava.util.zip.InflaterInputStream#close\u201d of course the bug does not happens :(\nWe tested with JDK 1.7.0_01 and 1.6.0_20, on Tomcat 7.0.16, 7.0.19, 7.0.22, 7.0.26. On all configurations we got the issue.\n\nThis error appears on all kind of resources from the jar (xml, properties, classes, \u2026), during a tomcat call to \"javax.servlet.ServletContextListener#contextInitialized\".\n\nFor java 7 we got:\nCaused by: org.springframework.beans.factory.BeanDefinitionStoreException: IOException parsing XML document from class path resource [META-INF/spring/addons.xml]; nested exception is java.io.IOException: Stream closed\n\tat org.springframework.beans.factory.xml.XmlBeanDefinitionReader.doLoadBeanDefinitions(XmlBeanDefinitionReader.java:408) [spring-beans-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n\tat org.springframework.beans.factory.xml.XmlBeanDefinitionReader.loadBeanDefinitions(XmlBeanDefinitionReader.java:334) [spring-beans-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n\tat org.springframework.beans.factory.xml.XmlBeanDefinitionReader.loadBeanDefinitions(XmlBeanDefinitionReader.java:302) [spring-beans-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n\tat org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:143) [spring-beans-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n\tat org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:178) [spring-beans-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n\tat org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:149) [spring-beans-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n\tat org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:212) [spring-beans-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n\tat org.springframework.context.support.AbstractXmlApplicationContext.loadBeanDefinitions(AbstractXmlApplicationContext.java:126) [spring-context-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n\tat org.springframework.context.support.AbstractXmlApplicationContext.loadBeanDefinitions(AbstractXmlApplicationContext.java:92) [spring-context-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n\tat org.springframework.context.support.AbstractRefreshableApplicationContext.refreshBeanFactory(AbstractRefreshableApplicationContext.java:130) [spring-context-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n\tat org.springframework.context.support.AbstractApplicationContext.obtainFreshBeanFactory(AbstractApplicationContext.java:467) [spring-context-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n\tat org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:397) [spring-context-3.0.6.RELEASE.jar:3.0.6.RELEASE]\nCaused by: java.io.IOException: Stream closed\n\tat java.util.zip.InflaterInputStream.ensureOpen(InflaterInputStream.java:67) [na:1.7.0_01]\n\tat java.util.zip.InflaterInputStream.read(InflaterInputStream.java:121) [na:1.7.0_01]\n\tat java.io.FilterInputStream.read(FilterInputStream.java:83) [na:1.7.0_01]\n\tat com.sun.org.apache.xerces.internal.impl.XMLEntityManager$RewindableInputStream.read(XMLEntityManager.java:2905) [na:1.7.0_01]\n\tat com.sun.org.apache.xerces.internal.impl.XMLEntityManager$RewindableInputStream.read(XMLEntityManager.java:2937) [na:1.7.0_01]\n\tat com.sun.org.apache.xerces.internal.impl.io.UTF8Reader.read(UTF8Reader.java:302) [na:1.7.0_01]\n\tat com.sun.org.apache.xerces.internal.impl.XMLEntityScanner.load(XMLEntityScanner.java:1750) [na:1.7.0_01]\n\tat com.sun.org.apache.xerces.internal.impl.XMLEntityScanner.scanLiteral(XMLEntityScanner.java:1071) [na:1.7.0_01]\n\tat com.sun.org.apache.xerces.internal.impl.XMLScanner.scanPseudoAttribute(XMLScanner.java:590) [na:1.7.0_01]\n\tat com.sun.org.apache.xerces.internal.impl.XMLScanner.scanXMLDeclOrTextDecl(XMLScanner.java:407) [na:1.7.0_01]\n\tat com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanXMLDeclOrTextDecl(XMLDocumentFragmentScannerImpl.java:913) [na:1.7.0_01]\n\tat com.sun.org.apache.xerces.internal.impl.XMLDocumentScannerImpl$XMLDeclDriver.next(XMLDocumentScannerImpl.java:775) [na:1.7.0_01]\n\tat com.sun.org.apache.xerces.internal.impl.XMLDocumentScannerImpl.next(XMLDocumentScannerImpl.java:607) [na:1.7.0_01]\n\tat com.sun.org.apache.xerces.internal.impl.XMLNSDocumentScannerImpl.next(XMLNSDocumentScannerImpl.java:116) [na:1.7.0_01]\n\tat com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanDocument(XMLDocumentFragmentScannerImpl.java:430) [na:1.7.0_01]\n\tat com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:835) [na:1.7.0_01]\n\tat com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:764) [na:1.7.0_01]\n\tat com.sun.org.apache.xerces.internal.parsers.XMLParser.parse(XMLParser.java:123) [na:1.7.0_01]\n\tat com.sun.org.apache.xerces.internal.parsers.DOMParser.parse(DOMParser.java:240) [na:1.7.0_01]\n\tat com.sun.org.apache.xerces.internal.jaxp.DocumentBuilderImpl.parse(DocumentBuilderImpl.java:300) [na:1.7.0_01]\n\tat org.springframework.beans.factory.xml.DefaultDocumentLoader.loadDocument(DefaultDocumentLoader.java:75) [spring-beans-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n\tat org.springframework.beans.factory.xml.XmlBeanDefinitionReader.doLoadBeanDefinitions(XmlBeanDefinitionReader.java:388) [spring-beans-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n\t... 20 common frames omitted\n\nFor Java 6 we got:\nCaused by: java.util.zip.ZipException: ZipFile closed\n        at java.util.zip.ZipFile.ensureOpenOrZipException(ZipFile.java:413) [na:1.6.0_20]\n        at java.util.zip.ZipFile.access$1100(ZipFile.java:29) [na:1.6.0_20]\n        at java.util.zip.ZipFile$ZipFileInputStream.read(ZipFile.java:445) [na:1.6.0_20]\n        at java.util.zip.ZipFile$1.fill(ZipFile.java:230) [na:1.6.0_20]\n        at java.util.zip.InflaterInputStream.read(InflaterInputStream.java:141) [na:1.6.0_20]\n        at java.io.FilterInputStream.read(FilterInputStream.java:116) [na:1.6.0_20]\n        at org.springframework.asm.ClassReader.a(Unknown Source) [spring-asm-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n        at org.springframework.asm.ClassReader.<init>(Unknown Source) [spring-asm-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n        at org.springframework.core.type.classreading.SimpleMetadataReader.<init>(SimpleMetadataReader.java:48) [spring-core-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n        at org.springframework.core.type.classreading.SimpleMetadataReaderFactory.getMetadataReader(SimpleMetadataReaderFactory.java:80) [spring-core-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n        at org.springframework.core.type.classreading.CachingMetadataReaderFactory.getMetadataReader(CachingMetadataReaderFactory.java:101) [spring-core-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n        at org.springframework.core.type.classreading.SimpleMetadataReaderFactory.getMetadataReader(SimpleMetadataReaderFactory.java:76) [spring-core-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n        at org.springframework.core.type.filter.AbstractTypeHierarchyTraversingFilter.match(AbstractTypeHierarchyTraversingFilter.java:105) [spring-core-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n        at org.springframework.core.type.filter.AbstractTypeHierarchyTraversingFilter.match(AbstractTypeHierarchyTraversingFilter.java:76) [spring-core-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n        at org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider.isCandidateComponent(ClassPathScanningCandidateComponentProvider.java:280) [spring-context-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n        at org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider.findCandidateComponents(ClassPathScanningCandidateComponentProvider.java:214) [spring-context-3.0.6.RELEASE.jar:3.0.6.RELEASE]\n        ... 29 common frames omitted\n\nWe saw that the GC finalizer is closing the zip on finalize. Playing with \u201c-XX:+UseConcMarkSweepGC -XX:+UseParNewGC\u201d has no effect.", "id": 154063, "time": "2012-02-23T12:16:25Z", "bug_id": 52746, "creation_time": "2012-02-23T12:16:25Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 52746, "attachment_id": null, "id": 154617, "time": "2012-03-07T10:51:52Z", "creator": "markt@apache.org", "creation_time": "2012-03-07T10:51:52Z", "is_private": false, "text": "I don't see any Tomcat code in those stack traces therefore it is hard to see how this could be a Tomcat issue.\n\nTomcat did change the it's own JAR scanning code between 7.0.14 and 7.0.16 but since that runs before any application code, it is hard to see how that may impact the application. I did double check it ensure all JARS and InputStreams that are opened are closed and I didn't see any gaps.\n\nAbsent any evidence that points to a Tomcat issue then there isn't much that can be done."}, {"count": 2, "tags": [], "bug_id": 52746, "attachment_id": null, "id": 159169, "time": "2012-05-18T18:21:26Z", "creator": "igor.mihalik@gmail.com", "creation_time": "2012-05-18T18:21:26Z", "is_private": false, "text": "There's a workaround for this issue to use:\n<Listener className=\"org.apache.catalina.core.JreMemoryLeakPreventionListener\" urlCacheProtection=\"true\"/>\n\nwhich is used by default in default server.xml configuration file, but if you removed the listener completely you can encounter this problem. It is very likely it was introduced by this improvement: https://issues.apache.org/bugzilla/show_bug.cgi?id=51276\nsvn revision: r1130497"}, {"count": 3, "tags": [], "bug_id": 52746, "attachment_id": null, "id": 159555, "time": "2012-05-31T10:38:04Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2012-05-31T10:38:04Z", "is_private": false, "text": "Marking as DUPLICATE of bug 53225.\n\n*** This bug has been marked as a duplicate of bug 53225 ***"}]