[{"attachment_id": null, "tags": [], "bug_id": 11971, "is_private": false, "count": 0, "id": 21602, "time": "2002-08-23T14:01:08Z", "creator": "apache-bugzilla@deuxchevaux.org", "creation_time": "2002-08-23T14:01:08Z", "text": "Summary:\n\nWhen using mod_proxy without a ServerName directive (as in the default config)\nor UseCanonicalName Off, the Via-Header of HTTP/1.1 proxy responses show either\nthe hostname of the requested ressource or the hostname of the requested\nressource plus the port of the proxy, but not the hostname of the proxy itself.\n\nShort examples:\n\nWithout ServerName set (equal if UseCanonicalName on or off), the request \"GET\nhttp://noone.org/ HTTP/1.1\" results incorrectly in \"Via: 1.1 noone.org\n(Apache/2.0.40)\" and \"GET http://www.apache.org/ HTTP/1.1\" results incorrectly\nin \"Via: 1.1 www.apache.org (Apache/2.0.40)\".\n\nWith ServerName set to abe.i.ecos.de:8002 and \"UseCanoncialName Off\", \"GET\nhttp://noone.org/ HTTP/1.1\" results incorrectly but differently in \"Via: 1.1\nnoone.org:8002 (Apache/2.0.40)\"\n\nWith ServerName set to abe.i.ecos.de:8002 and \"UseCanoncialName On\", \"GET\nhttp://noone.org/ HTTP/1.1\" results correctly in \"Via: 1.1 abe.i.ecos.de:8002\n(Apache/2.0.40)\"\n\nLong and detailed examples (response bodies suppressed):\n\nWithout ServerName:\n\nGET http://noone.org/ HTTP/1.1\nHost: noone.org\nConnection: Close\n\nHTTP/1.1 200 OK\nDate: Fri, 23 Aug 2002 13:36:14 GMT\nServer: Apache/1.3.26 (Unix) mod_ssl/2.8.10 OpenSSL/0.9.6e\nLast-Modified: Wed, 17 Apr 2002 08:48:05 GMT\nETag: \"1bc0e0-5b8-3cbd36c5\"\nAccept-Ranges: bytes\nContent-Type: text/html; charset=ISO-8859-1\nVia: 1.1 noone.org (Apache/2.0.40)\nContent-Length: 1464\nConnection: close\n\nor\n\nGET http://www.apache.org/ HTTP/1.1\nHost: www.apache.org\nConnection: close\n\nHTTP/1.1 200 OK\nDate: Fri, 23 Aug 2002 13:35:46 GMT\nServer: Apache/2.0.40 (Unix)\nCache-Control: max-age=86400\nExpires: Sat, 24 Aug 2002 13:35:45 GMT\nAccept-Ranges: bytes\nContent-Type: text/html; charset=ISO-8859-1\nVia: 1.1 www.apache.org (Apache/2.0.40)\nContent-Length: 7751\nConnection: close\n\nWith ServerName set to abe.i.ecos.de:8002 and UseCanonicalName On:\n\nGET http://noone.org/ HTTP/1.1\nHost: noone.org\nConnection: Close\n\nHTTP/1.1 200 OK\nDate: Fri, 23 Aug 2002 13:37:54 GMT\nServer: Apache/1.3.26 (Unix) mod_ssl/2.8.10 OpenSSL/0.9.6e\nLast-Modified: Wed, 17 Apr 2002 08:48:05 GMT\nETag: \"1bc0e0-5b8-3cbd36c5\"\nAccept-Ranges: bytes\nContent-Type: text/html; charset=ISO-8859-1\nVia: 1.1 abe.i.ecos.de:8002 (Apache/2.0.40)\nContent-Length: 1464\nConnection: close\n\nIf I switch off UseCanonicalName, it's wrong again, but differently.\nI set the following in httpd.conf:\n\nServerName abe.i.ecos.de:8002\nUseCanonicalName Off\n\nThen the following happens:\n\nGET http://noone.org/ HTTP/1.1\nHost: noone.org\nConnection: Close\n\nHTTP/1.1 200 OK\nDate: Fri, 23 Aug 2002 13:44:38 GMT\nServer: Apache/1.3.26 (Unix) mod_ssl/2.8.10 OpenSSL/0.9.6e\nLast-Modified: Wed, 17 Apr 2002 08:48:05 GMT\nETag: \"1bc0e0-5b8-3cbd36c5\"\nAccept-Ranges: bytes\nContent-Type: text/html; charset=ISO-8859-1\nVia: 1.1 noone.org:8002 (Apache/2.0.40)\nContent-Length: 1464\nConnection: close"}, {"count": 1, "attachment_id": null, "bug_id": 11971, "is_private": false, "id": 24712, "time": "2002-10-17T02:34:39Z", "creator": "slive@apache.org", "creation_time": "2002-10-17T02:34:39Z", "tags": [], "text": "[This is a mass bug update.]\nThis bug reports a problem in an older version of Apache 2.\nCould you please update to the most recent version and see\nif you can reproduce this problem.  If the bug still exists,\nplease update the bug with the latest version number.  If \nthe bug no longer exists, please close the bug report.\n\nSorry for this impersonal response, but we get many more bug\nreports than our volunteers can keep up with.\nThanks for using Apache!"}, {"count": 2, "tags": [], "text": "[This is a mass bug update.] [Resolve-20021102]\nNo response from submitter; assuming issue is resolved.\nIf the problem still exists in the lastest version,\nplease reopen this report and update appropriately.", "attachment_id": null, "bug_id": 11971, "id": 25537, "time": "2002-11-02T20:18:18Z", "creator": "slive@apache.org", "creation_time": "2002-11-02T20:18:18Z", "is_private": false}, {"count": 3, "tags": [], "creator": "dkluge@acm.org", "text": "Bug reproducable in Apache 2.0.54 on Windows XP, which is the current version,\nreopening.", "id": 77013, "time": "2005-07-05T21:18:31Z", "bug_id": 11971, "creation_time": "2005-07-05T21:18:31Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 11971, "text": "Created attachment 18027\npatch to fix Via: behavior when ServerName not set ot set or UseCanonicalName Off\n\nThis also fix the :port appending behavior.\nproxy_http.c was calling ap_get_server_name (resp. ap_get_server_port) to fill\nVia: HTTP header, with server name (resp. server port), but these functions\nwere confident into request_rec informations and were even returning data from\nthe request : hostname from Host: (resp. Port from uri parsed).\n\nThe submitted patch might fix this bug.", "id": 87611, "time": "2006-04-05T18:39:16Z", "creator": "francois.pesce@gmail.com", "creation_time": "2006-04-05T18:39:16Z", "is_private": false, "attachment_id": 18027}, {"count": 5, "tags": [], "creator": "francois.pesce@gmail.com", "text": "Created attachment 18028\nNo buggy patch to fix Via: behavior when ServerName not set ot set or UseCanonicalName Off\n\nOops,I introduced a bug in the precedent patch, and just saw it after\nsubmitting.\nIt must be correct now.", "id": 87612, "time": "2006-04-05T18:46:25Z", "bug_id": 11971, "creation_time": "2006-04-05T18:46:25Z", "is_private": false, "attachment_id": 18028}, {"count": 6, "tags": [], "bug_id": 11971, "attachment_id": null, "is_private": false, "id": 87613, "time": "2006-04-05T20:16:01Z", "creator": "rpluem@apache.org", "creation_time": "2006-04-05T20:16:01Z", "text": "Could you please split your patch in two parts (port issue / server_name issue)? \n\n1. I am not sure if the port part of the patch is correct. I currently do not\nunderstand what needs fixing here. Could you please explain?\n2. The server_name part of the patch is basicly the same code that is currently\nin trunk / 2.2.x (r102320 (http://svn.apache.org/viewcvs?rev=102320&view=rev)).\nThis part can be proposed for backport. The port part of your patch would need\nto be integrated into the trunk first."}, {"count": 7, "attachment_id": 18036, "bug_id": 11971, "text": "Created attachment 18036\npatch to fix proxy's port in Via: header when ServerName not set ot set or UseCanonicalName Off\n\nI did'nt know that patch was already in 2.2 !\nFunny to see how similar it is!\n\nFor the port part, the problem is the same than server_name, ap_get_server_port\nreturns the port of the destination URI specified in the request, not the port\nof the proxy, thus if the port is specified into the requested URI like in this\nexample:\n\necho -e \"GET http://host:6672/ HTTP/1.1\\r\\nHost: host:6672\\r\\n\\r\\n\" | nc proxy\n8081\n\nThe host receive a request with Via set like this:\nVia: 1.1 host:6672\n\neither the host and the port are wrong.\n\nwith a patched servername it will receive :\nVia: 1.1 proxy:6672\n\nhost correct but port wrong\n\nIn the summary of the bug, I suppose the initial reporter of the bug did'nt\nnotice this, because he set the port of the proxy with ServerName directive.\nBut if you just set the hostname (without a final :port) AND the request\ncontains a specific port, the Via: will display correct proxy host with\nincorrect port (the destination one).\n\nthe bug happens because ap_get_server_port returns :\n\tr->parsed_uri.port_str ? r->parsed_uri.port :\n\t       r->server->port ? r->server->port :\n\t       ap_default_port(r);\nWhat we want here is the server port, if i understand correctly, not the\nparsed_uri port.\n\nBTW, imho there is some refactoring to do here, because the server name stuff\nis duplicated code, and may be generated in the same code area than the server\nport.", "id": 87645, "time": "2006-04-06T20:15:05Z", "creator": "francois.pesce@gmail.com", "creation_time": "2006-04-06T20:15:05Z", "tags": [], "is_private": false}, {"count": 8, "attachment_id": 18037, "bug_id": 11971, "is_private": false, "id": 87650, "time": "2006-04-06T21:07:52Z", "creator": "rpluem@apache.org", "creation_time": "2006-04-06T21:07:52Z", "tags": [], "text": "Created attachment 18037\nBackport of r102320 to httpd 2.0.x"}, {"count": 9, "tags": [], "bug_id": 11971, "text": "Servername part proposed for backport to 2.0.x as r392058\n(http://svn.apache.org/viewcvs?rev=392058&view=rev)", "id": 87651, "time": "2006-04-06T21:15:10Z", "creator": "rpluem@apache.org", "creation_time": "2006-04-06T21:15:10Z", "is_private": false, "attachment_id": null}, {"count": 10, "attachment_id": null, "bug_id": 11971, "text": "Closing, as this has been fixed in the stable 2.2.x branch. Also, the 2.0.x patch is up for vote and\nshould be committed soon (missing just one vote).", "id": 104212, "time": "2007-06-08T09:22:49Z", "creator": "davi@apache.org", "creation_time": "2007-06-08T09:22:49Z", "tags": [], "is_private": false}]