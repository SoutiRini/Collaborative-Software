[{"count": 0, "tags": [], "bug_id": 54497, "is_private": false, "id": 164904, "attachment_id": null, "creator": "knst.kolinko@gmail.com", "creation_time": "2013-01-25T23:16:17Z", "time": "2013-01-25T23:16:17Z", "text": "Observed this when testing Tomcat trunk at r1438747, at WinXP 32-bit, JDK 7u11.\n(running TestWsWebSocketContainer with APR, Tomcat-Native 1.1.26 RC)\n\nThere occurred an NPE in WebappClassLoader.checkThreadLocalMapForLeaks(). It was uncaught and caused LifecycleException and ultimately a failure to stop Tomcat.\n\n===============\nIn stderr:\nSEVERE: A child container failed during stop\njava.util.concurrent.ExecutionException: org.apache.catalina.LifecycleException: Failed to stop component [StandardEngine[Tomcat].StandardHost[localhost].StandardContext[]]\n\tat java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:252)\n\tat java.util.concurrent.FutureTask.get(FutureTask.java:111)\n\tat org.apache.catalina.core.ContainerBase.stopInternal(ContainerBase.java:974)\n\tat org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:232)\n\tat org.apache.catalina.core.ContainerBase$StopChild.call(ContainerBase.java:1404)\n\tat org.apache.catalina.core.ContainerBase$StopChild.call(ContainerBase.java:1393)\n\tat java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:166)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)\n\tat java.lang.Thread.run(Thread.java:722)\nCaused by: org.apache.catalina.LifecycleException: Failed to stop component [StandardEngine[Tomcat].StandardHost[localhost].StandardContext[]]\n\tat org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:236)\n\t... 7 more\nCaused by: org.apache.catalina.LifecycleException: Failed to stop component [WebappLoader[]]\n\tat org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:236)\n\tat org.apache.catalina.core.StandardContext.stopInternal(StandardContext.java:5365)\n\tat org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:232)\n\t... 7 more\nCaused by: java.lang.NullPointerException\n\tat sun.reflect.UnsafeFieldAccessorImpl.ensureObj(UnsafeFieldAccessorImpl.java:54)\n\tat sun.reflect.UnsafeObjectFieldAccessorImpl.get(UnsafeObjectFieldAccessorImpl.java:36)\n\tat java.lang.reflect.Field.get(Field.java:372)\n\tat org.apache.catalina.loader.WebappClassLoader.checkThreadLocalMapForLeaks(WebappClassLoader.java:2247)\n\tat org.apache.catalina.loader.WebappClassLoader.checkThreadLocalsForLeaks(WebappClassLoader.java:2188)\n\tat org.apache.catalina.loader.WebappClassLoader.clearReferences(WebappClassLoader.java:1731)\n\tat org.apache.catalina.loader.WebappClassLoader.stop(WebappClassLoader.java:1641)\n\tat org.apache.catalina.loader.WebappLoader.stopInternal(WebappLoader.java:491)\n\tat org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:232)\n\t... 9 more\n===============\nIn testcase:\nTestcase: testSmallTextBufferClientTextMessage took 2,328 sec\n\tCaused an ERROR\nFailed to stop component [StandardServer[-1]]\norg.apache.catalina.LifecycleException: Failed to stop component [StandardServer[-1]]\n\tat org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:236)\n\tat org.apache.catalina.startup.Tomcat.stop(Tomcat.java:336)\n\tat org.apache.catalina.startup.TomcatBaseTest.tearDown(TomcatBaseTest.java:163)\nCaused by: org.apache.catalina.LifecycleException: Failed to stop component [StandardService[Tomcat]]\n\tat org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:236)\n\tat org.apache.catalina.core.StandardServer.stopInternal(StandardServer.java:766)\n\tat org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:232)\nCaused by: org.apache.catalina.LifecycleException: Failed to stop component [StandardEngine[Tomcat]]\n\tat org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:236)\n\tat org.apache.catalina.core.StandardService.stopInternal(StandardService.java:501)\n\tat org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:232)\nCaused by: org.apache.catalina.LifecycleException: A child container failed during stop\n\tat org.apache.catalina.core.ContainerBase.stopInternal(ContainerBase.java:981)\n\tat org.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:232)\n===============\n\nThoughts:\n1. We should catch throwables in those checkFor**Leaks methods. It should not cause a \"failed to stop component\" failure.\n2. In that method there are many calls to \"table[j]\". The array member should be evaluated only once, so that it does not become null unexpectedly."}, {"count": 1, "tags": [], "bug_id": 54497, "text": "Looks like I fixed the multiple references to table[j] and committed it accidentally as part of r1440622. I'll look at adding the try/catch.", "id": 164975, "attachment_id": null, "creator": "markt@apache.org", "creation_time": "2013-02-01T12:41:49Z", "time": "2013-02-01T12:41:49Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 54497, "is_private": false, "text": "Fixed in trunk and 7.0.x. Will be in 7.0.26 onwards.", "id": 164978, "time": "2013-02-01T12:52:21Z", "creator": "markt@apache.org", "creation_time": "2013-02-01T12:52:21Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "chuck.caldarale@unisys.com", "text": "(In reply to comment #2)\n> Fixed in trunk and 7.0.x. Will be in 7.0.26 onwards.\n\nThat would be 7.0.36 onwards.", "id": 164983, "time": "2013-02-01T14:19:22Z", "bug_id": 54497, "creation_time": "2013-02-01T14:19:22Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 54497, "is_private": false, "id": 166672, "attachment_id": null, "creator": "violetagg@apache.org", "creation_time": "2013-04-17T04:53:58Z", "time": "2013-04-17T04:53:58Z", "text": "*** Bug 54831 has been marked as a duplicate of this bug. ***"}]