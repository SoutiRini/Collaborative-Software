[{"count": 0, "tags": [], "creator": "metekural@yahoo.com", "is_private": false, "text": "Below is the code for method \norg.apache.catalina.core.ApplicationDispatcher.unwrapRequest() in \nApplicationDispatcher.java. You can clearly see here that the objects \"current\" \nand \"previous\" are declared as ServletRequest objects although later in the \ncode they are attempted to be casted as ServletRequestWrapper objects. This \ncauses a ClassCastException in Tomcat. I will also attach exception stack trace \nthat I got at the bottom of this.\n\n    private void unwrapRequest() {\n\n        if (wrapRequest == null)\n            return;\n\n        ServletRequest previous = null;\n        ServletRequest current = outerRequest;\n        while (current != null) {\n\n            // If we run into the container request we are done\n            if (current instanceof Request)\n                break;\n\n            // Remove the current request if it is our wrapper\n            if (current == wrapRequest) {\n                ServletRequest next =\n                  ((ServletRequestWrapper) current).getRequest();\n                if (previous == null)\n                    outerRequest = next;\n                else\n                    ((ServletRequestWrapper) previous).setRequest(next);\n                break;\n            }\n\n            // Advance to the next request in the chain\n            previous = current;\n            current = ((ServletRequestWrapper) current).getRequest();\n\n        }\n\n    }\n\nStack Trace for the said ClassCastException (found in Tomcat log files):\n---------------------------------------------\n\n2002-05-01 12:13:42 StandardWrapperValve[Quran]: Servlet.service() for servlet \nQuran threw exception\njava.lang.ClassCastException: org.apache.catalina.connector.HttpRequestFacade\n\tat org.apache.catalina.core.ApplicationDispatcher.unwrapRequest\n(ApplicationDispatcher.java:845)\n\tat org.apache.catalina.core.ApplicationDispatcher.doForward\n(ApplicationDispatcher.java:432)\n\tat org.apache.catalina.core.ApplicationDispatcher.forward\n(ApplicationDispatcher.java:355)\n\tat Quran.searchQuran(Quran.java:1396)\n\tat Quran.doGet(Quran.java:603)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:740)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:853)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter\n(ApplicationFilterChain.java:247)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter\n(ApplicationFilterChain.java:193)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke\n(StandardWrapperValve.java:243)\n\tat org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:566)\n\tat org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:472)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:943)\n\tat org.apache.catalina.core.StandardContextValve.invoke\n(StandardContextValve.java:190)\n\tat org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:566)\n\tat org.apache.catalina.valves.CertificatesValve.invoke\n(CertificatesValve.java:246)\n\tat org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:564)\n\tat org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:472)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:943)\n\tat org.apache.catalina.core.StandardContext.invoke\n(StandardContext.java:2343)\n\tat org.apache.catalina.core.StandardHostValve.invoke\n(StandardHostValve.java:180)\n\tat org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:566)\n\tat org.apache.catalina.valves.ErrorDispatcherValve.invoke\n(ErrorDispatcherValve.java:170)\n\tat org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:564)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke\n(ErrorReportValve.java:170)\n\tat org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:564)\n\tat org.apache.catalina.valves.AccessLogValve.invoke\n(AccessLogValve.java:468)\n\tat org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:564)\n\tat org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:472)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:943)\n\tat org.apache.catalina.core.StandardEngineValve.invoke\n(StandardEngineValve.java:174)\n\tat org.apache.catalina.core.StandardPipeline.invokeNext\n(StandardPipeline.java:566)\n\tat org.apache.catalina.core.StandardPipeline.invoke\n(StandardPipeline.java:472)\n\tat org.apache.catalina.core.ContainerBase.invoke(ContainerBase.java:943)\n\tat org.apache.catalina.connector.http.HttpProcessor.process\n(HttpProcessor.java:1012)\n\tat org.apache.catalina.connector.http.HttpProcessor.run\n(HttpProcessor.java:1107)\n\tat java.lang.Thread.run(Thread.java:536)\n\nThanks,\nMete Kural", "id": 15290, "time": "2002-05-01T23:24:47Z", "bug_id": 8717, "creation_time": "2002-05-01T23:24:47Z", "attachment_id": null}, {"count": 1, "text": "The thing is that you are not allowed to wrap the request with something which \ndoesn't implement the wrapper objects given by the servlet API, and then expect \nrequest dispatching to work. Apparently, that's what you did here.", "bug_id": 8717, "attachment_id": null, "id": 15311, "time": "2002-05-02T06:19:30Z", "creator": "remm@apache.org", "creation_time": "2002-05-02T06:19:30Z", "tags": [], "is_private": false}]