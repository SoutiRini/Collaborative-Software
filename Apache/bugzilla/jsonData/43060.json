[{"count": 0, "tags": [], "text": "The situation is as follows (you might include this in the bug description):\n\nApache httpd decodes HTTP methods as method_number. HTTP HEAD and GET get the same \nmethod_number. To make HEAD distinguishable form GET, adiitionally header_only gets set for a HEAD \nrequest.\n\nmod_proxy_ajp only decodes the method_number and doesn't check the header_only flag. So every \nHEAD request gets forwarded as a GET request.\n\nIn order to fix the forwarding, one has to improve ajp_marshal_into_msgb() in ajp_header.c and also \nap_proxy_ajp_request(9 in mod_proxy_ajp.c. A patch against 2.2.4 could be close to the following (I \ndidn't test, I didn't even compile it):\n\n\nIndex: mod_proxy_ajp.c\n===============================================================\n====\n--- mod_proxy_ajp.c     (revision 563796)\n+++ mod_proxy_ajp.c     (working copy)\n@@ -313,6 +313,16 @@\n                 break;\n             case CMD_AJP13_SEND_BODY_CHUNK:\n                 /* AJP13_SEND_BODY_CHUNK: piece of data */\n+                if (r->header_only) {\n+                    ap_log_error(APLOG_MARK, APLOG_DEBUG, 0, r->server,\n+                                 \"proxy: header only\");\n+                    isok = 0;\n+                    /* Pass EOS bucket down the filter chain. */\n+                    e = apr_bucket_eos_create(r->connection->bucket_alloc);\n+                    APR_BRIGADE_INSERT_TAIL(output_brigade, e);\n+                    apr_brigade_cleanup(output_brigade);\n+                    break;\n+                }\n                 status = ajp_parse_data(r, conn->data, &size, &buff);\n                 if (status == APR_SUCCESS) {\n                     if (size == 0) {\nIndex: ajp_header.c\n===============================================================\n====\n--- ajp_header.c        (revision 563796)\n+++ ajp_header.c        (working copy)\n@@ -224,6 +224,9 @@\n                r->method);\n         return AJP_EBAD_METHOD;\n     }\n+    if ((method == SC_M_GET) && r->header_only) {\n+        method = SC_M_HEAD;\n+    }\n\n     is_ssl = (apr_byte_t) ap_proxy_conn_is_https(r->connection);\n\n\nRegards,\n\nRainer\n\nChad Scholes wrote:\nI am using Apache 2.2.3 and Tomcat 5.0.  I use ProxyPass to ajp to\nsend Servlet requests from Apache to Tomcat and for some reason all\nHEAD requests are being sent to my servlets as GET requests.  I\nprobably don't have something setup correctly but I don't know what\nwould affect the HEAD request.\nMy Apache configuration for ProxyPass is set like:\nAlias /qfsearch \"/var/lib/qfsearch/docs\" <Location \"/qfsearch\"> Allow\nfrom all </Location> ProxyPass /qfsearch\najp://localhost:9009/qfsearch\nmod_proxy and mod_rewrite are setup as:\n<IfModule mod_proxy.c> <Proxy *> Order deny,allow Deny from all </Proxy> ProxyRequests Off </\nIfModule>\n<IfModule mod_rewrite.c> RewriteEngine On RewriteLog\n/var/log/apache2/rewrite_log RewriteLogLevel 1 </IfModule>\nIn the apache access log the request is getting to apache as a \"HEAD\"\nrequest: 137.65.79.137 - - [06/Aug/2007:14:33:45 -0600] \"HEAD\n/qfsearch/ClusterServlet?\nserver=qfsearch3.provo.novell.com&type=index&putname=duh&putsubname=qfind.idx&idxdatetime=\n1186176509000&idxlocation=%2Fvar%2Flib%2Fqfsearch%2FSites%2Fdefault%2Findexes%2Fduh%\n2F2007-08-03%3B\n+15.28.29&put=qfind.idx&filesize=11709498&datetime=1186176509000&do=canput\nHTTP/1.1\" 503 - \"-\" \"Java/1.5.0\"\nHowever, I have a servlet that overrides the service function and in\nthat call request.getMethod() and it is now returning \"GET\" not\n\"HEAD\".\nIf I call Tomcat directly then everything works fine\n(request.getMethod() returns \"HEAD\"). This particular section of code\nhas been working for years with the JKMount command but now that we\nhave changed to the ProxyPass it is not working.  If you have any\nideas what could be wrong I would appreciate the help!\nThanks you!! Chad", "attachment_id": null, "id": 106486, "creator": "jim@apache.org", "time": "2007-08-08T06:37:37Z", "bug_id": 43060, "creation_time": "2007-08-08T06:37:37Z", "is_private": false}, {"count": 1, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "id": 106519, "time": "2007-08-09T03:22:34Z", "bug_id": 43060, "creation_time": "2007-08-09T03:22:34Z", "is_private": false, "text": "[changing the bug assignment field means that the bugs@ mailing list never gets\ncopies -- fixed]"}, {"count": 2, "tags": [], "text": "I think the fix to ajp_header is sufficient as for header_only requests response\nbodys get discarded by  http_filters.c:ap_http_header_filter.\nFurthermore I think that\n\nIndex: modules/proxy/ajp_header.c\n===================================================================\n--- modules/proxy/ajp_header.c  (revision 563471)\n+++ modules/proxy/ajp_header.c  (working copy)\n@@ -218,7 +218,11 @@\n     ap_log_error(APLOG_MARK, APLOG_DEBUG, 0, r->server,\n                          \"Into ajp_marshal_into_msgb\");\n \n-    if ((method = sc_for_req_method_by_id(r->method_number)) == UNKNOWN_METHOD) {\n+    if (r->header_only) {\n+        method = SC_M_HEAD;\n+    }\n+    else if ((method = sc_for_req_method_by_id(r->method_number))\n+             == UNKNOWN_METHOD) {\n         ap_log_error(APLOG_MARK, APLOG_ERR, 0, r->server,\n                \"ajp_marshal_into_msgb - No such method %s\",\n                r->method);\n\nshould be sufficient as header only is only set for HEAD requests.", "is_private": false, "bug_id": 43060, "id": 106687, "time": "2007-08-13T04:01:02Z", "creator": "rpluem@apache.org", "creation_time": "2007-08-13T04:01:02Z", "attachment_id": null}, {"count": 3, "tags": [], "creator": "jim@apache.org", "text": "in trunk (r574024)", "id": 107902, "time": "2007-09-09T09:22:03Z", "bug_id": 43060, "creation_time": "2007-09-09T09:22:03Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 43060, "attachment_id": null, "id": 108047, "time": "2007-09-12T00:42:37Z", "creator": "rpluem@apache.org", "creation_time": "2007-09-12T00:42:37Z", "is_private": false, "text": "Proposed for backport as r574823."}, {"count": 5, "tags": [], "text": "Backported to 2.2.x", "is_private": false, "bug_id": 43060, "id": 111635, "time": "2007-12-11T05:14:35Z", "creator": "rpluem@apache.org", "creation_time": "2007-12-11T05:14:35Z", "attachment_id": null}]