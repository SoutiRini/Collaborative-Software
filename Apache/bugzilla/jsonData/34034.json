[{"count": 0, "tags": [], "bug_id": 34034, "attachment_id": null, "is_private": false, "id": 72484, "time": "2005-03-16T14:57:01Z", "creator": "hgomez@apache.org", "creation_time": "2005-03-16T14:57:01Z", "text": "While converting my apps from Tomcat 3.3.x to Tomcat 5.5.x, I discovered a\nserious bug in Jasper.\n\nMy web.xml is :\n\n<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?>\n\n<!DOCTYPE web-app\n    PUBLIC \"-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN\"\n    \"http://java.sun.com/dtd/web-app_2_3.dtd\" [ \n    \n<!ENTITY base      SYSTEM \"base.xml\">\n\n]>\n\n<web-app>\n\n...\n&base.xml;\n\n</web-app>\n\n\nTomcat 5.0.30 and 5.5.8 have no problem in loading web.xml at startup, they\nresolve since the base.xml external entity file is local to the WAR.\n\nBut jasper when it tried to compile it's first JSP fail with message :\n\n\nEtat HTTP 500 -\n\ntype Rapport d'exception\n\nmessage\n\ndescription Le serveur a rencontr\u00e9 une erreur interne () qui l'a\nemp\u00each\u00e9 de satisfaire la requ\u00eate.\n\nexception\n\norg.apache.jasper.JasperException: Erreur d'\u00e9valuation XML sur le\nfichier /WEB-INF/web.xml\n      \norg.apache.jasper.xmlparser.ParserUtils.parseXMLDocument(ParserUtils.java:113)\n       org.apache.jasper.compiler.JspConfig.processWebDotXml(JspConfig.java:70)\n       org.apache.jasper.compiler.JspConfig.init(JspConfig.java:188)\n       org.apache.jasper.compiler.JspConfig.findJspProperty(JspConfig.java:240)\n       org.apache.jasper.compiler.Compiler.generateJava(Compiler.java:103)\n       org.apache.jasper.compiler.Compiler.compile(Compiler.java:286)\n       org.apache.jasper.compiler.Compiler.compile(Compiler.java:267)\n       org.apache.jasper.compiler.Compiler.compile(Compiler.java:255)\n      \norg.apache.jasper.JspCompilationContext.compile(JspCompilationContext.java:556)\n      \norg.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:296)\n       org.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:291)\n       org.apache.jasper.servlet.JspServlet.service(JspServlet.java:241)\n       javax.servlet.http.HttpServlet.service(HttpServlet.java:802)\n\ncause m\u00e8re\n\njava.io.FileNotFoundException: C:\\eclipse3\\base.xml (Le fichier\nsp\u00e9cifi\u00e9 est introuvable)\n       java.io.FileInputStream.open(Native Method)\n       java.io.FileInputStream.<init>(FileInputStream.java:106)\n       java.io.FileInputStream.<init>(FileInputStream.java:66)\n      \nsun.net.www.protocol.file.FileURLConnection.connect(FileURLConnection.java:69)\n      \nsun.net.www.protocol.file.FileURLConnection.getInputStream(FileURLConnection.java:156)\n       org.apache.xerces.impl.XMLEntityManager.setupCurrentEntity(Unknown Source)\n       org.apache.xerces.impl.XMLEntityManager.startEntity(Unknown Source)\n       org.apache.xerces.impl.XMLEntityManager.startEntity(Unknown Source)\n      \norg.apache.xerces.impl.XMLDocumentFragmentScannerImpl.scanEntityReference(Unknown\nSource)\n      \norg.apache.xerces.impl.XMLDocumentFragmentScannerImpl$FragmentContentDispatcher.dispatch(Unknown\nSource)\n       org.apache.xerces.impl.XMLDocumentFragmentScannerImpl.scanDocument(Unknown\nSource)\n       org.apache.xerces.parsers.XML11Configuration.parse(Unknown Source)\n       org.apache.xerces.parsers.XML11Configuration.parse(Unknown Source)\n       org.apache.xerces.parsers.XMLParser.parse(Unknown Source)\n       org.apache.xerces.parsers.DOMParser.parse(Unknown Source)\n       org.apache.xerces.jaxp.DocumentBuilderImpl.parse(Unknown Source)\n       javax.xml.parsers.DocumentBuilder.parse(Unknown Source)\n       org.apache.jasper.xmlparser.ParserUtils.parseXMLDocument(ParserUtils.java:98)\n       org.apache.jasper.compiler.JspConfig.processWebDotXml(JspConfig.java:70)\n       org.apache.jasper.compiler.JspConfig.init(JspConfig.java:188)\n       org.apache.jasper.compiler.JspConfig.findJspProperty(JspConfig.java:240)\n       org.apache.jasper.compiler.Compiler.generateJava(Compiler.java:103)\n       org.apache.jasper.compiler.Compiler.compile(Compiler.java:286)\n       org.apache.jasper.compiler.Compiler.compile(Compiler.java:267)\n       org.apache.jasper.compiler.Compiler.compile(Compiler.java:255)\n      \norg.apache.jasper.JspCompilationContext.compile(JspCompilationContext.java:556)\n      \norg.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:296)\n       org.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:291)\n       org.apache.jasper.servlet.JspServlet.service(JspServlet.java:241)\n       javax.servlet.http.HttpServlet.service(HttpServlet.java:802)\n\nnote La trace compl\u00e8te de la cause m\u00e8re de cette erreur est disponible\ndans les fichiers journaux de Apache Tomcat/5.5.8.\n\nIt seems that Jasper didn't use the WEBAPP path but start from my environnement\npath, in my case eclipse3, c:\\eclipse3, which is bad."}, {"count": 1, "tags": [], "creator": "remm@apache.org", "is_private": false, "text": "As promised ;)", "id": 72485, "time": "2005-03-16T15:00:15Z", "bug_id": 34034, "creation_time": "2005-03-16T15:00:15Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 34034, "attachment_id": null, "text": "Reread xml spec, nothing prevent us to use external entities like this.\nAlso external entities are invalid when outside webapp, it's not the case here.\n\nYou should read :\n\nMy web.xml is :\n\n<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?>\n\n<!DOCTYPE web-app\n    PUBLIC \"-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN\"\n    \"http://java.sun.com/dtd/web-app_2_3.dtd\" [ \n    \n<!ENTITY base      SYSTEM \"base.xml\">\n\n]>\n\n<web-app>\n\n...\n&base;\n\n</web-app>\n\n", "id": 72487, "time": "2005-03-16T15:02:33Z", "creator": "hgomez@apache.org", "creation_time": "2005-03-16T15:02:33Z", "is_private": false}, {"count": 3, "tags": [], "creator": "remm@apache.org", "text": "Webapps are not necessarily filesystem based. As a result, that kind of little\ntricks are not portable, and cannot be supported. As you know, I am very\nefficient at marking reports invalid ;)", "id": 72488, "time": "2005-03-16T15:04:26Z", "bug_id": 34034, "creation_time": "2005-03-16T15:04:26Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "remm@apache.org", "is_private": false, "text": "Actually, I just saw it maybe can work even when not filesystem based:\n                if (altDDName != null) {\n                    url = new File(altDDName).toURL();\n                } else {\n                    url = servletContext.getResource(\n                                                Constants.ApplicationWebXml);\n                }\n                if( url!=null ) {\n                    InputSource is = new InputSource(url.toExternalForm());\n                    is.setByteStream(stream);\n\nI still really don't care about the issue, but my big issue with this might go away.\n\nThis might teach people that it's not a good idea to bug me about something I\ndon't care about all morning long (some people you might not know about may have\ngotten the same idea at the same time) ;)", "id": 72489, "time": "2005-03-16T15:16:32Z", "bug_id": 34034, "creation_time": "2005-03-16T15:16:32Z", "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 34034, "attachment_id": 14517, "is_private": false, "id": 72666, "time": "2005-03-18T14:47:36Z", "creator": "hgomez@apache.org", "creation_time": "2005-03-18T14:47:36Z", "text": "Created attachment 14517\na patch to allow Jasper to resolve external entities located in WEBAPP"}, {"count": 6, "tags": [], "bug_id": 34034, "attachment_id": null, "text": "if (systemId.startsWith(\"file:///WEB-INF/\"))\n  return new InputSource(ctxt.getResourceAsStream(systemId.substring(7)));\n\n-> -1\nNo surprise here ...", "id": 72669, "time": "2005-03-18T16:05:36Z", "creator": "remm@apache.org", "creation_time": "2005-03-18T16:05:36Z", "is_private": false}, {"count": 7, "tags": [], "bug_id": 34034, "attachment_id": null, "text": "It's a trick :\n\nif (systemId.startsWith(\"file:///WEB-INF/\"))\n  return new InputSource(ctxt.getResourceAsStream(systemId.substring(7)));\n\nXML parser have a pseudo root origine set to /WEB-INF/ and as such you get the\nsystemId filed with 'file:///WEB-INF/whatever.xml' when you have defined a\n<ENTITY what SYSTEM \"whatever.xml\">\n\nWith the substring 7 we remove the \"file:////\" and as such get\n\"/WEB-INF/whatever.xml\" from ServletContext via getResourceAsStream.\n\nSo it should works EVEN if the webapp is not file based.\n\nI do that to respect WHAT YOU REQUIRED, ie no InputSource from a File, just from\na resource.\n\n", "id": 72671, "time": "2005-03-18T16:15:27Z", "creator": "hgomez@apache.org", "creation_time": "2005-03-18T16:15:27Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 34034, "attachment_id": null, "is_private": false, "id": 72676, "time": "2005-03-18T20:17:32Z", "creator": "william.barker@wilshire.com", "creation_time": "2005-03-18T20:17:32Z", "text": "It should be enough to do (in JspConfig):\n  URL uri = ctcx.getResource(WEB_XML);\n  InputSource ip = new InputSource(uri.openStream());\n  ip.setSystemId(uri.toExternalForm());\n\nand leave the EntityResolver alone.  Between Xerces and o.a.naming they can \nwork out the relative Entity references.\n\n\n\n"}, {"count": 9, "text": "Well if it works, I'm happy with this patch.\n\nWill try it Monday.\n\nThanks William", "bug_id": 34034, "is_private": false, "id": 72692, "time": "2005-03-19T10:36:22Z", "creator": "hgomez@apache.org", "creation_time": "2005-03-19T10:36:22Z", "tags": [], "attachment_id": null}, {"count": 10, "tags": [], "bug_id": 34034, "attachment_id": null, "text": "Couldn't wait monday.\n\nOk it seems to works.\n\nResolver get a systemId : jndi:/localhost/webappname/WEB-INF/app.xml\n\nAnd it works.\n\nOnly got in System.out :\n\n19 mars 2005 11:06:49 org.apache.jasper.xmlparser.MyEntityResolver resolveEntity\nGRAVE: PUBLIC ID invalide: null\n19 mars 2005 11:06:57 org.apache.jasper.xmlparser.MyEntityResolver resolveEntity\nGRAVE: PUBLIC ID invalide: null\n19 mars 2005 11:06:59 org.apache.jasper.xmlparser.MyEntityResolver resolveEntity\nGRAVE: PUBLIC ID invalide: null\n19 mars 2005 11:07:00 org.apache.jasper.xmlparser.MyEntityResolver resolveEntity\nGRAVE: PUBLIC ID invalide: null\n19 mars 2005 11:07:02 org.apache.jasper.xmlparser.MyEntityResolver resolveEntity\nGRAVE: PUBLIC ID invalide: null\n\n\nSo a simpler patch could be commited :)", "id": 72693, "time": "2005-03-19T11:09:49Z", "creator": "hgomez@apache.org", "creation_time": "2005-03-19T11:09:49Z", "is_private": false}, {"count": 11, "text": "Created attachment 14546\nAllow jasper to resolve external entities", "bug_id": 34034, "is_private": false, "id": 2205, "time": "2005-03-23T15:36:00Z", "creator": "hgomez@apache.org", "creation_time": "2005-03-23T15:36:00Z", "tags": [], "attachment_id": 14546}, {"count": 12, "tags": [], "bug_id": 34034, "attachment_id": null, "text": "After Bill and Jan review, a new patch to close this BZ", "id": 2185, "time": "2005-03-23T15:36:55Z", "creator": "hgomez@apache.org", "creation_time": "2005-03-23T15:36:55Z", "is_private": false}, {"count": 13, "attachment_id": null, "creator": "william.barker@wilshire.com", "text": "*** Bug 36284 has been marked as a duplicate of this bug. ***", "id": 78757, "time": "2005-08-20T21:31:37Z", "bug_id": 34034, "creation_time": "2005-08-20T21:31:37Z", "tags": [], "is_private": false}]