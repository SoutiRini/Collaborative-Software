[{"count": 0, "attachment_id": null, "creator": "eirik.lygre@gmail.com", "text": "We have been trying to set up Apache on Windows with ldaps (ssl) authentication, using apr-util compiled with the Microsoft ldap sdk, with little success. Looking at the log output, reading the source code and discussions on email lists indicate that there is a bug in the interaction between httpd (util_ldap.c) and apr-util which makes this combination impossible.\n\nIn short, this is what happens (with more detail below):\n\n- util_ldap.c always calls apr_ldap_set_option(...,APR_LDAP_OPT_TLS_CERT,...), even when there are no global certs\n- apr_ldap_set_option(...,APR_LDAP_OPT_TLS_CERT,...) always fails when called with APR_HAS_MICROSOFT_LDAPSDK\n- when this fails, ldaps is disabled\n\nThe probable fix would be in util_ldap.c, the function util_ldap_post_config. Immediately after calling apr_ldap_ssl_init(), the function calls apr_ldap_set_option() with global certs. The fix would be only make the call to apr_ldap_set_option() when there are in fact any global certs defined. Coded blindly, as I don't have a build environment:\n\n    rc = apr_ldap_ssl_init(p,\n                      NULL,\n                      0,\n                      &(result_err));\n-   if (APR_SUCCESS == rc) {\n+   if (APR_SUCCESS == rc && !apr_is_empty_array(st->global_certs)) {\n        rc = apr_ldap_set_option(ptemp, NULL, APR_LDAP_OPT_TLS_CERT,\n                                 (void *)st->global_certs, &(result_err));\n    }\n\n++++++++++++++++++++++++++++++++\n\n1) Extracs of httpd-config:\n\nLoadModule ldap_module        modules/mod_ldap.so\nLoadModule authnz_ldap_module modules/mod_authnz_ldap.so\n<Location />\n    AuthLDAPURL ldaps://127.0.0.1:1389/ou=People,dc=example,dc=com?uid\n</Location>\n\n2) The error_log has the following entries:\n\n[Mon Feb 25 22:21:18 2013] [info] APR LDAP: Built with Microsoft Corporation. LDAP SDK\n[Mon Feb 25 22:21:18 2013] [info] LDAP: SSL support unavailable: LDAP: CA certificates cannot be set using this method, as they are stored in the registry instead.\n\n3) During initialization of util_ldap.c (http://svn.apache.org/viewvc/httpd/httpd/branches/2.2.x/modules/ldap/util_ldap.c?view=markup), in util_ldap_post_config(): After calling apr_ldap_ssl_init(), on line 2031, the method apr_ldap_set_option (APR_LDAP_OPT_TLS_CERT) is always called, regardless of whether there are any global certs or not.\n\n2020     /*\n2021      * Initialize SSL support, and log the result for the benefit of the admin.\n2022      *\n2023      * If SSL is not supported it is not necessarily an error, as the\n2024      * application may not want to use it.\n2025      */\n2026     rc = apr_ldap_ssl_init(p,\n2027                       NULL,\n2028                       0,\n2029                       &(result_err));\n2030     if (APR_SUCCESS == rc) {\n2031         rc = apr_ldap_set_option(ptemp, NULL, APR_LDAP_OPT_TLS_CERT,\n2032                                  (void *)st->global_certs, &(result_err));\n2033     }\n2034\t\n2035\t    if (APR_SUCCESS == rc) {\n2036\t        st->ssl_supported = 1;\n2037\t        ap_log_error(APLOG_MARK, APLOG_INFO, 0, s,\n2038\t                     \"LDAP: SSL support available\" );\n2039\t    }\n2040\t    else {\n2041\t        st->ssl_supported = 0;\n2042\t        ap_log_error(APLOG_MARK, APLOG_INFO, 0, s,\n2043\t                     \"LDAP: SSL support unavailable%s%s\",\n2044\t                     result_err ? \": \" : \"\",\n2045\t                     result_err ? result_err->reason : \"\");\n2046\t    }\n\n4) Now, in apr_ldap (http://svn.apache.org/viewvc/apr/apr-util/tags/1.4.1/ldap/apr_ldap_option.c?view=markup), the method apr_ldap_set_option() forwards to option_set_cert() (line 396), which ends up in the following code which *always* fails.\n\n627   #if APR_HAS_MICROSOFT_LDAPSDK\n628       /* Microsoft SDK use the registry certificate store - error out\n629        * here with a message explaining this. */\n630       result->reason = \"LDAP: CA certificates cannot be set using this method, \"\n631                        \"as they are stored in the registry instead.\";\n632       result->rc = -1;\n633   #endif", "id": 165569, "time": "2013-03-01T14:42:47Z", "bug_id": 54626, "creation_time": "2013-03-01T14:42:47Z", "tags": [], "is_private": false}, {"count": 1, "tags": [], "text": "looks sensible, but i think we ought to also:\n\n* block LDAPTrustedGlobalCert on MS SDK\n* change the INFO messages that follow for the MS SDK.", "is_private": false, "bug_id": 54626, "id": 165571, "time": "2013-03-01T16:15:48Z", "creator": "covener@gmail.com", "creation_time": "2013-03-01T16:15:48Z", "attachment_id": null}, {"count": 2, "tags": [], "bug_id": 54626, "attachment_id": null, "is_private": false, "id": 170268, "time": "2013-09-25T14:03:58Z", "creator": "jfclere@gmail.com", "creation_time": "2013-09-25T14:03:58Z", "text": "I am working on a better patch."}, {"count": 3, "attachment_id": 30881, "creator": "jfclere@gmail.com", "text": "Created attachment 30881\npatch again the 2.2.25", "id": 170269, "time": "2013-09-25T15:52:01Z", "bug_id": 54626, "creation_time": "2013-09-25T15:52:01Z", "tags": [], "is_private": false}, {"count": 4, "tags": [], "bug_id": 54626, "is_private": false, "text": "http://svn.apache.org/viewvc?view=revision&revision=r1526436", "id": 170281, "time": "2013-09-26T09:58:23Z", "creator": "jfclere@gmail.com", "creation_time": "2013-09-26T09:58:23Z", "attachment_id": null}, {"count": 5, "tags": [], "creator": "jecousteille@ptc.com", "attachment_id": null, "is_private": false, "id": 184910, "time": "2015-09-02T12:16:07Z", "bug_id": 54626, "creation_time": "2015-09-02T12:16:07Z", "text": "Good morning,\n\nI am facing the same problem as Mr Lygre.\nWe are using Apache 2.2.29, and trying to connect to a directory (Sun Directory Server) in ldaps.\nI receive the same message as mentionned in this post :\n[info] APR LDAP: Built with Microsoft Corporation. LDAP SDK\n[info] LDAP: SSL support unavailable: LDAP: CA certificates cannot be set using this method, as they are stored in the registry instead.\n\nBy reading this article, we thought the 2.2.25 was correcting the problem.\nDo you have any information about this ? Is it really corrected on the 2.2.25 ? \nIs there still some cases where the correction is not enough ? \n\nAny help would be much appreciated.\nThanks in advance,\n\nJC"}, {"count": 6, "attachment_id": null, "creator": "covener@gmail.com", "text": "(In reply to JCCousteille from comment #5)\n> Good morning,\n> \n> I am facing the same problem as Mr Lygre.\n> We are using Apache 2.2.29, and trying to connect to a directory (Sun\n> Directory Server) in ldaps.\n> I receive the same message as mentionned in this post :\n> [info] APR LDAP: Built with Microsoft Corporation. LDAP SDK\n> [info] LDAP: SSL support unavailable: LDAP: CA certificates cannot be set\n> using this method, as they are stored in the registry instead.\n> \n> By reading this article, we thought the 2.2.25 was correcting the problem.\n> Do you have any information about this ? Is it really corrected on the\n> 2.2.25 ? \n> Is there still some cases where the correction is not enough ? \n> \n\nNo, this was only fixed in trunk. It needs to be backported.", "id": 185047, "time": "2015-09-09T02:34:54Z", "bug_id": 54626, "creation_time": "2015-09-09T02:34:54Z", "tags": [], "is_private": false}, {"count": 7, "tags": [], "creator": "dopey@moonteeth.com", "attachment_id": null, "is_private": false, "id": 185088, "time": "2015-09-10T19:29:59Z", "bug_id": 54626, "creation_time": "2015-09-10T19:29:59Z", "text": "I'm not convinced this actually is a problem.\n\nIf you grep the code for ssl_supported there isn't anything functional that uses it except for:\nstatic apr_status_t util_ldap_cleanup_module(void *data)\n{\n\n    server_rec *s = data;\n    util_ldap_state_t *st = (util_ldap_state_t *)ap_get_module_config(\n        s->module_config, &ldap_module);\n\n    if (st->ssl_supported) {\n        apr_ldap_ssl_deinit();\n    }\n\n    return APR_SUCCESS;\n\n}\n\napr_ldap_ssl_deinit() simply calls ldapssl_client_deinit() if it's available and if you look at apr-ldap.h that's configured against the microsoft sdk:\n#define APR_HAS_LDAPSSL_CLIENT_DEINIT 0\n\nSo that doesn't do anything.\n\nThere is this commented block in mod_authnz_ldap.c\n    /*\n    authn_ldap_config_t *sec = (authn_ldap_config_t *)\n                                    ap_get_module_config(s->module_config,\n                                                         &authnz_ldap_module);\n\n    if (sec->secure)\n    {\n        if (!util_ldap_ssl_supported(s))\n        {\n            ap_log_error(APLOG_MARK, APLOG_CRIT, 0, s,\n                     \"LDAP: SSL connections (ldaps://) not supported by utilLDAP\");\n            return(!OK);\n        }\n    }\n    */\n\nBut as it's commented, it's irrelevant.\n\nI just staged both a 2.4.16 and 2.2.31 install and had no problems connecting to an ldaps server once I trusted the right certificate in the microsoft certificate management console even though it stated:\nLDAP: SSL support unavailable: LDAP: CA certificates cannot be set using this method, as they are stored in the registry instead.\n\nThat said, the patch in trunk is broken as it was hueristically applied wrong, and it will not compile on windows.  I'll upload a new version of it.  But best i can tell, this simply ensures ldapssl_client_deinit is called if it's supported, and cosmetically fixes that message so it's correct.  I don't see any functional changes otherwise."}, {"count": 8, "tags": [], "bug_id": 54626, "text": "Created attachment 33094\nfixed version of patch in trunk\n\nthis patch applies properly to 2.4.16 and should replace the fix in trunk.", "id": 185089, "time": "2015-09-10T19:32:19Z", "creator": "dopey@moonteeth.com", "creation_time": "2015-09-10T19:32:19Z", "is_private": false, "attachment_id": 33094}]