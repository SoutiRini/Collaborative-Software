[{"count": 0, "tags": [], "bug_id": 56917, "attachment_id": null, "id": 177558, "time": "2014-09-05T16:46:31Z", "creator": "ajay.sindwani@gmail.com", "creation_time": "2014-09-05T16:46:31Z", "is_private": false, "text": "Create a Tomcat configuration to force tomcat to write relative location headers in 301/302 responses instead of absolute location headers.\n\nPurpose:\nToday Tomcat always writes an absolute response for redirects per RFC2616 standards.  However as many modern browsers support 302s to relative Locations as explained in https://en.wikipedia.org/wiki/HTTP_location , our friendly Tomcat application server should allow configuration to write back 302s in the more friendly form.\n\nThe ripple effect of this where applications choose to use this setting, will be very good for cpu cycles of web servers and load balancers all over the world.   This can greatly reduce the need for ProxyPassReverse in the Apache web server, and also for URL rewriting happenin in physical load balancers.\n\nSee this example where another gentleman has been compelled to recompile Tomcat to achieve the same thing\nhttp://community.jaspersoft.com/wiki/f5-load-balancer-and-tomcat-302-error"}, {"count": 1, "tags": [], "creator": "markt@apache.org", "text": "This would be contrary to the requirements of the Servlet specification.\n\nSee https://java.net/jira/browse/SERVLET_SPEC-100 for the request to change that (and some other stuff).", "id": 177559, "time": "2014-09-05T18:26:04Z", "bug_id": 56917, "creation_time": "2014-09-05T18:26:04Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "ajay.sindwani@gmail.com", "attachment_id": null, "text": "Both the servlet spec and Tomcat need to be updated then.  Tomcat doesn't have to wait for the servlet spec, unless the update is already accepted.\n\nThe expense of doing 302 rewriting can be cleaned from numerous webserver environments.", "id": 177564, "time": "2014-09-05T22:06:07Z", "bug_id": 56917, "creation_time": "2014-09-05T22:06:07Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 56917, "attachment_id": null, "id": 177894, "time": "2014-09-15T18:54:35Z", "creator": "chris@christopherschultz.net", "creation_time": "2014-09-15T18:54:35Z", "is_private": false, "text": "(In reply to Ajay Sindwani from comment #2)\n> Both the servlet spec and Tomcat need to be updated then.  Tomcat doesn't\n> have to wait for the servlet spec, unless the update is already accepted.\n\nTomcat, being spec-compliant, must maintain spec-compliance.\n\nThere are certainly examples of out-of-spec behavior in Tomcat which are usually controllable via certain configuration options. It seems like this could be one of them. Patches are always welcome.\n\n> The expense of doing 302 rewriting can be cleaned from numerous webserver\n> environments.\n\nAre you sure? If not all clients support it, then you can't remove that capability. It's one of the awful things about the web: you can't force users to upgrade. ;)"}, {"count": 4, "tags": [], "bug_id": 56917, "attachment_id": null, "id": 186615, "time": "2015-11-27T21:21:20Z", "creator": "markt@apache.org", "creation_time": "2015-11-27T21:21:20Z", "is_private": false, "text": "Good news. RFC2616 has been obsoleted by RFC7231 and friends. RFC7231 allows redirects to be relative. This looks like it could turn into my favourite type of bug report - one I can fix by deleting code :)"}, {"count": 5, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "id": 186665, "time": "2015-11-30T14:36:12Z", "bug_id": 56917, "creation_time": "2015-11-30T14:36:12Z", "is_private": false, "text": "Similar to 58660, I think the behavior change may not be such a good idea. It could be done in 9, but not elsewhere by default."}, {"count": 6, "tags": [], "creator": "markt@apache.org", "text": "Allowing relative URIs should be low risk and it is consistent with RFC7231.\n\nI know the commit is large but 99% of that is for testing. My first approach replaced the encodeXXX methods so I added some tests. While I eventually dropped that approach (we need Java 9 for the URI performance to be better than the current one) I wanted to keep the tests.\n\nThe main reason for back-porting this beyond 9.0.x is that we need this to be able to fix bug 58655 without duplicating huge amounts of code. Hence back-porting as far as 7.0.x which is the earliest version we need to fix 58655.\n\nWould you like to see a configuration option for this in 7.0.x and 8.0.x. And if so, which what default?", "id": 186668, "time": "2015-11-30T15:40:47Z", "bug_id": 56917, "creation_time": "2015-11-30T15:40:47Z", "is_private": false, "attachment_id": null}, {"count": 7, "tags": [], "bug_id": 56917, "attachment_id": null, "id": 186672, "time": "2015-11-30T16:33:41Z", "creator": "remm@apache.org", "creation_time": "2015-11-30T16:33:41Z", "is_private": false, "text": "I verified the behavior with a telnet. If it is known all clients are compatible, then it should be fine. I read in the original description \"many modern browsers support 302s to relative Locations\", so what are the \"non modern\" browsers or clients that would not support it ?"}, {"count": 8, "tags": [], "bug_id": 56917, "text": "Not really related, the processing for session id encoding in the URL (encodeRedirectURL and encodeURL) is extraordinarily complex and expensive. I don't remember why it looks like that.", "id": 186673, "time": "2015-11-30T16:40:37Z", "creator": "remm@apache.org", "creation_time": "2015-11-30T16:40:37Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 56917, "attachment_id": null, "id": 186674, "time": "2015-11-30T16:43:44Z", "creator": "markt@apache.org", "creation_time": "2015-11-30T16:43:44Z", "is_private": false, "text": "The complexity is to ensure that the session ID only gets added if the redirect is to a location within the current web application.\n\nIn nearly all cases it will get skipped anyway since the session will have been provided by a cookie."}, {"count": 10, "tags": [], "bug_id": 56917, "text": "I haven't found a client that doesn't support it yet. I did find one reference for curl [1] that suggests back then all browsers supported various forms of relative redirects.\n\n[1] http://daniel.haxx.se/blog/2011/12/31/top-3-curl-bugs-in-2011/", "id": 186690, "time": "2015-11-30T21:20:21Z", "creator": "markt@apache.org", "creation_time": "2015-11-30T21:20:21Z", "is_private": false, "attachment_id": null}, {"count": 11, "tags": [], "bug_id": 56917, "text": "@Mark Thomas\n\nLogically since 7/8 backports, existing app servers, will receive your patch through minor upgrades, the defaults should maintain the existing behavior to prevent wasted labor and troubleshooting for the majority of people.\n\nI'd recommend in 9 and up that the the default become the more efficient behavior and inline with RFC-7231.  \n\nDoing this CR is a good deed!  Imagine all the CPU cycles saved when the world no longer has all these Tomcats adding base URLs to redirects and Apache Httpd no longer has ProxyPassReverse added to every ProxyPass.  This is a good \"green\" eco-friendly change.", "id": 186698, "time": "2015-12-01T02:48:02Z", "creator": "ajay.sindwani@gmail.com", "creation_time": "2015-12-01T02:48:02Z", "is_private": false, "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 56917, "text": "1. I think this feature must be configurable.\n\na. Regardless of browsers, this may affect configuration of reverse proxies.\n\nI guess that ProxyPassReverse may fail to rewrite some of redirects.\n\nhttp://httpd.apache.org/docs/2.4/mod/mod_proxy.html#proxypassreverse\n\nb. There may be some old / dumb clients.\n\nI am REOPENING this.\n\n\n2. I agree that this is a nice feature and I think that enabling this feature by default is better from security point of view.", "id": 186708, "time": "2015-12-01T09:54:36Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-12-01T09:54:36Z", "is_private": false, "attachment_id": null}, {"count": 13, "tags": [], "bug_id": 56917, "attachment_id": null, "id": 186710, "time": "2015-12-01T11:04:34Z", "creator": "markt@apache.org", "creation_time": "2015-12-01T11:04:34Z", "is_private": false, "text": "It appears that ProxyPassReverse only rewrites absolute URLs. That will be a problem for redirects of the form /some/path\n\nTomcat generates redirects like this in a few places and we can fix those but it does look like an option is going to be required for the reverse proxy case where the context path is changed in the proxy.\n\nSomething else to add to the long list of reasons why changing the context path in the reverse proxy is a bad idea."}, {"count": 14, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "I can get Tomcat to send a suitable relative redirect for directories but not context roots. I don't see a way around this. Any relative redirect from from /foo to /foo/ is going to have to have 'foo/' in it and that won't be caught by ProxyPassReverse. If the context name has been changed the redirect will break.\n\nAt the point where the redirect is generated, we have access to the context so adding a per context option for this should be fairly simple. I don't like adding configuration options unless we have to but the case for doing so here is strong, even if it does depend on a configuration (changing context paths in the proxy) that we know is generally problematic.\n\nI should be able to get this option added shortly.", "id": 186712, "time": "2015-12-01T11:38:56Z", "bug_id": 56917, "creation_time": "2015-12-01T11:38:56Z", "is_private": false}, {"count": 15, "attachment_id": null, "bug_id": 56917, "text": "Configuration option added.", "id": 186714, "time": "2015-12-01T13:08:28Z", "creator": "markt@apache.org", "creation_time": "2015-12-01T13:08:28Z", "tags": [], "is_private": false}, {"count": 16, "tags": [], "bug_id": 56917, "attachment_id": null, "id": 186721, "time": "2015-12-01T16:56:35Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2015-12-01T16:56:35Z", "is_private": false, "text": "Thank you.\n\nMinor things\n\n1. JMX\n\n2. As Servlet Specification javadoc [1] explicitly says \"servlet container must convert the relative URL to an absolute URL before sending the response to the client\" and references RFC 3986 (\"absolute\" is defined there), I think the default value of this option should depend on STRICT_SERVLET_COMPLIANCE.\n\nIt is not yet known what will be for Servlet 4.0, we can change the default later. The [1] link is for Servlet 3.1.\n\n\n[1] http://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpServletResponse.html#sendRedirect-java.lang.String-"}, {"count": 17, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "text": "Review comments fixed.", "id": 186725, "time": "2015-12-01T20:34:17Z", "bug_id": 56917, "creation_time": "2015-12-01T20:34:17Z", "is_private": false}]