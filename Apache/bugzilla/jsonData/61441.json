[{"count": 0, "tags": [], "text": "On RHEL/Centos/Fedora, when java is installed from the RPMs neither JAVA_HOME nor JRE_HOME environment variables are set. Luckily, the Tomcat startup scripts are able to auto-detect them but the daemon.sh script cannot properly do so. The failure is in the JAVA_HOME auto-detection in the script here:\n\ndaemon.sh:96:\n\n~~~\nJAVA_BIN=\"`which java 2>/dev/null || type java 2>&1`\"\ntest -x \"$JAVA_BIN\" && JAVA_HOME=\"`dirname $JAVA_BIN`\"\ntest \".$JAVA_HOME\" != . && JAVA_HOME=`cd \"$JAVA_HOME/..\" >/dev/null; pwd`\n~~~\n\nThe problem is that when java is installed from the RPMs, `which java` evaluates to '/usr/bin/java', which is a symlink maintained by alternatives. The code snippet above will evaluate to JAVA_HOME and JRE_HOME being set to '/usr'. Having JRE_HOME set to '/usr' doesn't seem to cause problems for Tomcat, but the problem manifests itself when running the daemon.sh script:\n\n~~~\n# ./daemon.sh start\nCannot find any VM in Java Home /usr\n~~~\n \njsvc is only used in daemon.sh, therefore this problem was not seen when starting Tomcat using startup.sh or catalina.sh.\n\nI think a good fallback for JAVA_HOME and JRE_HOME is '/usr/lib/jvm/java' and '/usr/lib/jvm/jre' respectively.\n\nTo Reproduce:\n\n1. Install tomcat\n2. Install java from RPMs\n3. cd $CATALINA_HOME\n4. bin/daemon.sh start\n5. Observe error mentioned above", "attachment_id": null, "id": 200362, "creator": "csutherl@apache.org", "time": "2017-08-17T18:44:37Z", "bug_id": 61441, "creation_time": "2017-08-17T18:44:37Z", "is_private": false}, {"count": 1, "tags": [], "creator": "csutherl@apache.org", "text": "Created attachment 35246\nOption to add fallbacks\n\nThis patch would just add a check for JAVA_HOME being /usr and if it is, use the correct directories for the JDK or JRE installation.", "id": 200363, "time": "2017-08-17T18:45:51Z", "bug_id": 61441, "creation_time": "2017-08-17T18:45:51Z", "is_private": false, "attachment_id": 35246}, {"count": 2, "tags": [], "bug_id": 61441, "attachment_id": 35247, "text": "Created attachment 35247\nAnother seemingly viable option\n\nAnother option is to remove the -java-home option from the JSVC command lines. Doing so resolves the issue for me because JSVC seems to be able to figure out what to do on it's own.", "id": 200364, "time": "2017-08-17T18:46:54Z", "creator": "csutherl@apache.org", "creation_time": "2017-08-17T18:46:54Z", "is_private": false}, {"count": 3, "tags": [], "creator": "rainer.jung@kippdata.de", "text": "What about the following addition, copied and adjusted from the top of the file where it is used to resolve another possible symlink:\n\nIndex: bin/daemon.sh\n===================================================================\n--- bin/daemon.sh       (revision 1805340)\n+++ bin/daemon.sh       (working copy)\n@@ -94,6 +94,15 @@\n #\n if [ -z \"$JAVA_HOME\" ]; then\n     JAVA_BIN=\"`which java 2>/dev/null || type java 2>&1`\"\n+    while [ -h \"$JAVA_BIN\" ]; do\n+        ls=`ls -ld \"$JAVA_BIN\"`\n+        link=`expr \"$ls\" : '.*-> \\(.*\\)$'`\n+        if expr \"$link\" : '/.*' > /dev/null; then\n+            JAVA_BIN=\"$link\"\n+        else\n+            JAVA_BIN=\"`dirname $JAVA_BIN`/$link\"\n+        fi\n+    done\n     test -x \"$JAVA_BIN\" && JAVA_HOME=\"`dirname $JAVA_BIN`\"\n     test \".$JAVA_HOME\" != . && JAVA_HOME=`cd \"$JAVA_HOME/..\" >/dev/null; pwd`\n else\n\n\nDoes that work?", "id": 200367, "time": "2017-08-17T22:19:41Z", "bug_id": 61441, "creation_time": "2017-08-17T22:19:41Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 61441, "attachment_id": null, "id": 200372, "time": "2017-08-18T12:06:10Z", "creator": "csutherl@apache.org", "creation_time": "2017-08-18T12:06:10Z", "is_private": false, "text": "Yeah, that works. I think I like that approach best also because it eliminates guessing."}, {"count": 5, "tags": [], "bug_id": 61441, "attachment_id": null, "is_private": false, "id": 200543, "time": "2017-08-31T15:00:17Z", "creator": "markt@apache.org", "creation_time": "2017-08-31T15:00:17Z", "text": "Fixed in:\n- trunk for 9.0.0.M27 onwards\n- 8.5.x for 8.5.21 onwards\n- 8.0.x for 8.0.47 onwards\n- 7.0.x for 7.0.82 onwards"}]