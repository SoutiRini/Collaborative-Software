[{"count": 0, "tags": [], "bug_id": 29554, "text": "I'm using a backend server behind a ProxyPass and a ProxyPassReverse.\n\nWhen the URL contains a %3A (encoded colon :) this %3A is passed to the backend\nas : instead of being kept as %3A, which yields an invalid URL and confuses the\nbackend.\n\nWhen the URL contains a %2F (encoded slash /), mod_proxy becomes quite confused,\nand yields a 404 without even consulting the backend.", "id": 59178, "time": "2004-06-14T11:05:21Z", "creator": "fare@tunes.org", "creation_time": "2004-06-14T11:05:21Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "text": "Tested with apache 1.3.26-0woody3 from debian as well as with a libproxy\nrecompiled from the 1.3.31-1 source package from debian.\n\nRelevant lines from httpd.conf:\nProxyPass / http://my.server.fqdn:8000/\nProxyPassReverse / http://my.server.fqdn:8000/\n", "attachment_id": null, "id": 59179, "creation_time": "2004-06-14T11:11:00Z", "time": "2004-06-14T11:11:00Z", "creator": "fare@tunes.org", "bug_id": 29554, "is_private": false}, {"count": 2, "tags": [], "text": "While trying to isolate the bug, I found that the : behaviour went wrong when\napache is listening on port 80, but not when it is listening to port 8000. The\nway things are handled seem quite messy -- walking to the first : in a decoded URL?\n\nNote that the symptoms are vaguely similar to those of bug 11265, though the\ninternal details differ.\n", "attachment_id": null, "id": 59193, "creator": "fare@tunes.org", "time": "2004-06-14T13:39:06Z", "bug_id": 29554, "creation_time": "2004-06-14T13:39:06Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 29554, "text": "The problem seems to be in the URL \"canonicalization\" happening in\nproxy_http.c:ap_proxy_http_canon, as called from mod_proxy.c:proxy_fixup.\nI can't fix it right now, because I don't understand the ins and outs of the\nproxy protocol: particularly, the GET http://foo.bar/baz HTTP/0.9 is one thing,\nand GET /baz HTTP/1.1 Host: foo.bar is another, but there are other cases.\n\nCan anyone point me to a document that explains this part of the protocol?\n", "id": 59269, "time": "2004-06-16T09:01:44Z", "creator": "fare@tunes.org", "creation_time": "2004-06-16T09:01:44Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "text": "Created attachment 11856\nFix for ProxyPass with encoded : and /", "attachment_id": 11856, "id": 59303, "creation_time": "2004-06-16T14:41:43Z", "time": "2004-06-16T14:41:43Z", "creator": "fare@tunes.org", "bug_id": 29554, "is_private": false}, {"count": 5, "tags": [], "bug_id": 29554, "text": "OK. There were two bugs involved.\n\nThe port 80/8000 thing might have had to do with my incorrectly tweaking\nhttpd.conf during testing, so let's forget it.\n\nThe problem with %3A ':' was due to a misguided URI canonicalization attempt in\nfunction modules/proxy/mod_proxy.c:proxy_fixup(). I added a bypass to the\ncanonicalization in the case of PROXY_PASS. Actually I believe canonicalization\nshouldn't happen in the STD_PROXY case either and the whole function should be\nscrapped.\n\nThe problem with %2F '/' was due to r->proxyreq=PROXY_PASS being declared too\nlate, only in modules/proxy/mod_proxy.c:proxy_trans(), so that\nmain/http_request.c:process_request_internal() messed up with the URL, not\nrealizing there is a proxy request going on. Consequently, I moved the stuff\nfrom modules/proxy/mod_proxy.c:proxy_trans() into\nmodules/proxy/mod_proxy.c:proxy_detect().\n\nPS: note that so as to compile mod_proxy from apache 1.3.31 on my old apache\n1.3.26, I had to add this to mod_proxy.h:\n#define ap_psocket_ex(p,q,r,s,t) (t==1?ap_psocket(p,q,r,s):-1)\n\nTHE HORROR! THE HORROR!\n", "id": 59305, "time": "2004-06-16T14:45:13Z", "creator": "fare@tunes.org", "creation_time": "2004-06-16T14:45:13Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 29554, "attachment_id": null, "id": 59316, "time": "2004-06-16T15:22:22Z", "creator": "fare@tunes.org", "creation_time": "2004-06-16T15:22:22Z", "is_private": false, "text": "Oops. A stupid bug in my previous patch (forgot to return DECLINED; in\nproxy_trans()) broke everything outside of the proxy. Fixed in the following\npatch...\n"}, {"count": 7, "tags": [], "bug_id": 29554, "text": "Created attachment 11858\nFix ProxyPass AND not break everything else.", "id": 59317, "time": "2004-06-16T15:24:18Z", "creator": "fare@tunes.org", "creation_time": "2004-06-16T15:24:18Z", "is_private": false, "attachment_id": 11858}, {"count": 8, "tags": [], "creator": "fare@tunes.org", "attachment_id": null, "text": "Looking at the sources for apache 2.0.49, I can see that the same bug is there, too.", "id": 59335, "time": "2004-06-16T17:42:47Z", "bug_id": 29554, "creation_time": "2004-06-16T17:42:47Z", "is_private": false}, {"count": 9, "tags": [], "bug_id": 29554, "attachment_id": null, "id": 59336, "time": "2004-06-16T17:49:08Z", "creator": "fare@tunes.org", "creation_time": "2004-06-16T17:49:08Z", "is_private": false, "text": "Final notes:\n\nMy debugging tool was to have LogLevel debug in the proper VirtualHost, and to\nadd the following macro to mod_proxy.h\n#define DEBUGMSG(FMT...) \\\n        ap_log_rerror(APLOG_MARK, APLOG_DEBUG|APLOG_NOERRNO,r,FMT)\n\nIn Apache 2, the bug is the same at the same places, modulo the change in names:\nsee server/request.c instead of main/http_request.c, etc. The algorithm and its\nbug are the very same.\n\n"}, {"count": 10, "tags": [], "creator": "fare@tunes.org", "attachment_id": null, "text": "Since I'm asked about a test case, try the following URL through a proxypass:\nhttp://cliki.tunes.org/CP%2FM\nhttp://cliki.tunes.org/Word%20Processors%3A%20Stupid%20and%20Inefficient\n\nFor instance add this line to a test virtual host:\n        ProxyPass /cto/ http://cliki.tunes.org/\nAnd then access /cto/CP%2FM\n\nLog the result with ap_log_rerror as above...", "id": 59838, "time": "2004-06-24T12:44:58Z", "bug_id": 29554, "creation_time": "2004-06-24T12:44:58Z", "is_private": false}, {"count": 11, "tags": [], "text": "This is not exactly the same problem, but it can be related.\n\nI've setup the following conf :\n  ProxyPass /info/ http://internal:8888/info.asp?\n\nThe problem is that \"?\" is replaced by a \"%3F\", like in this example :\n\"http://website.com/info/param\" --> \"http://internal:8888/info.asp%3Fparam\" \n\n\nIf I replace the previous conf, with the following one, I get the correct \nrequest.\n  RewriteRule ^/info/(.*) http://internal:8888/info.asp?$1 [P]\n\n\"http://website.com/info/param\" -> \"http://internal:8888/info.asp?param\"\n\nIs this a normal behaviour ?\n", "attachment_id": null, "id": 61299, "creator": "ed@decaen.com", "time": "2004-07-29T11:43:44Z", "bug_id": 29554, "creation_time": "2004-07-29T11:43:44Z", "is_private": false}, {"count": 12, "tags": [], "creator": "ed@decaen.com", "attachment_id": null, "text": "Ok, the problem I had, is more similar to 13577 bugid.\n\nhttp://nagoya.apache.org/bugzilla/show_bug.cgi?id=13577\n\nSorry for the Duplicate.\n", "id": 61367, "time": "2004-07-30T09:52:37Z", "bug_id": 29554, "creation_time": "2004-07-30T09:52:37Z", "is_private": false}, {"count": 13, "tags": [], "text": "The mishandled escapes occur even with a regular proxy under Apache 1.3.31, \nnot just with a ProxyPass proxy.\n\nIn my httpd.conf I have \n\n    <Directory proxy:*>\n        Order deny,allow\n        Deny from all\n        Allow from .my.trusted.domain\n        Allow from .other.trusted.domain\n    </Directory>\n\n<VirtualHost *:15151>\n    ProxyRequests On\n    ProxyVia On\n    NoCache *\n</VirtualHost>\n\nWhen I send a request to this proxy for http://myserver/something-with-%2B, \nthe proxy asks myserver for /something-with-+, where the %2B was mistakenly \ndecoded. This situation is like the one reported in #13577, but that one is \nmarked as fixed and applies to Apache 2.0 only, and this bug (29554) mentions \nProxyPass only. If the problem is more general, then it should be fixed more \ngenerally, not just for the ProxyPass situation.", "attachment_id": null, "id": 62447, "creator": "mike@hyperreal.org", "time": "2004-08-25T05:52:04Z", "bug_id": 29554, "creation_time": "2004-08-25T05:52:04Z", "is_private": false}, {"count": 14, "tags": [], "bug_id": 29554, "text": "I just noticed that Far\u00e9 wrote:\n\n\"Actually I believe canonicalization shouldn't happen in the STD_PROXY case \neither and the whole function should be scrapped.\"\n\nSo please regard my previous comment as a \"me too\".\n", "id": 62448, "time": "2004-08-25T05:55:10Z", "creator": "mike@hyperreal.org", "creation_time": "2004-08-25T05:55:10Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "creator": "tril@tunes.org", "text": "Changing bug summary to indicate bug is for proxy in general and for escapes in\ngeneral, not just ProxyPass for / and :", "id": 64338, "attachment_id": null, "bug_id": 29554, "creation_time": "2004-09-28T17:52:55Z", "time": "2004-09-28T17:52:55Z", "is_private": false}, {"count": 16, "tags": [], "text": "Can someone please create a patch that makes the suggested change, removing the\noffending function, so it can be tested?", "attachment_id": null, "id": 64339, "creator": "tril@tunes.org", "time": "2004-09-28T17:56:44Z", "bug_id": 29554, "creation_time": "2004-09-28T17:56:44Z", "is_private": false}, {"count": 17, "tags": [], "bug_id": 29554, "attachment_id": null, "id": 71313, "time": "2005-02-21T17:31:32Z", "creator": "workingschreier@gmx.ch", "creation_time": "2005-02-21T17:31:32Z", "is_private": false, "text": "i use mod_proxy on apache 2.0.50\ncan somebody tell me when an official patch or bugfix or next apache release\nwill be available?\nthere have been no posts since 2004-Sep-18\nthanks"}, {"count": 18, "tags": [], "creator": "minfrin@sharp.fm", "attachment_id": null, "text": "Does anybody have a patch for either v2.0.x or trunk?", "id": 71347, "time": "2005-02-22T14:00:57Z", "bug_id": 29554, "creation_time": "2005-02-22T14:00:57Z", "is_private": false}, {"count": 19, "tags": [], "creator": "ocapache@simplexity.net", "attachment_id": null, "text": "Have you tried this (much simpler) patch for the \"misguided canonicalization\"\nproblem?\n\nhttp://issues.apache.org/bugzilla/show_bug.cgi?id=34688", "id": 74981, "time": "2005-05-18T01:21:39Z", "bug_id": 29554, "creation_time": "2005-05-18T01:21:39Z", "is_private": false}, {"count": 20, "tags": [], "text": "Fixed for 2.0.55: http://svn.apache.org/viewcvs.cgi?rev=227435&view=rev", "attachment_id": null, "id": 78159, "creator": "jorton@redhat.com", "time": "2005-08-05T16:00:30Z", "bug_id": 29554, "creation_time": "2005-08-05T16:00:30Z", "is_private": false}, {"count": 21, "tags": [], "bug_id": 29554, "attachment_id": null, "id": 78160, "time": "2005-08-05T16:01:29Z", "creator": "jorton@redhat.com", "creation_time": "2005-08-05T16:01:29Z", "is_private": false, "text": "Heh.  Now I screwed up the bug reference too.  This bug is not fixed in 1.3 yet."}, {"count": 22, "tags": [], "creator": "jorton@redhat.com", "attachment_id": null, "text": "*** Bug 34688 has been marked as a duplicate of this bug. ***", "id": 78162, "time": "2005-08-05T16:02:10Z", "bug_id": 29554, "creation_time": "2005-08-05T16:02:10Z", "is_private": false}]