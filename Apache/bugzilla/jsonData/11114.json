[{"count": 0, "tags": [], "creator": "aangel@myrealbox.com", "is_private": false, "text": "I have the following setup:\n\nVHosts: www.aquarius.null (default), www.ipv6.aquarius.null, ...etc.\nwww.aquarius.null's DocumentRoot is /afs/aquarius.null/common/htdocs/www/, which\nis stored in an AFS cell, on a file server on the local ethernet segment. \nImages served from AFS are corrupt when served by Apache2, until viewed for the\nfirst time from outside of AFS (or something like that; let me explain what I've\nwitnessed).\n\nI first attempted to publish an image of my desktop, the URL to which originally\n=~ s/png/gif/.  I copied the image to a location outside of the AFS cell, onto\nthe local machine running Apache2 (the directory aliased as /icons/ by default).\n I pointed my browsers to http://.../icons/kde-...724.gif, and the image came up\nfine.\n\nNext, I went back to the old URL, which was served from the AFS cell. I did not\nmanipulate the original image in anyway, but now it came up fine.  First, I\nsaved the image in a different format (.png), browsed to it, and the image was\nbroken.  I also tried copying the .gif file to antoher name, and it was back to\nbeing broken again.", "id": 20101, "time": "2002-07-24T05:55:52Z", "bug_id": 11114, "creation_time": "2002-07-24T05:55:52Z", "attachment_id": null}, {"count": 1, "tags": [], "creator": "trawick@apache.org", "is_private": false, "text": "What level of FreeBSD are you using?  4.6-STABLE and later versions have\na kernel update a few weeks ago which changed the API to sendfile().  \nAPR had to change to accomodate, but the change is not yet in an Apache \nrelease.  If this is the case, we can provide an easy patch to the\nsendfile interface in APR until the real fix is released.\n\nHere is the way to tell:  Run \"/sbin/sysctl kern.osreldate\".  If the value\ndisplayed is >= 460001, APR from Apache 2.0.39 is busted and is not passing \nthe right data to sendfile, which can lead to corrupted data sent.\n\n", "id": 20249, "time": "2002-07-26T12:34:58Z", "bug_id": 11114, "creation_time": "2002-07-26T12:34:58Z", "attachment_id": null}, {"count": 2, "attachment_id": null, "bug_id": 11114, "is_private": false, "id": 20277, "time": "2002-07-26T18:02:35Z", "creator": "aangel@myrealbox.com", "creation_time": "2002-07-26T18:02:35Z", "tags": [], "text": "The machine running Apache2 is running FreeBSD 4.6-RELEASE-p1, the AFS server is\nrunning FreeBSD 4.6-RELEASE-p2."}, {"count": 3, "tags": [], "creator": "slive@apache.org", "attachment_id": null, "is_private": false, "id": 21307, "time": "2002-08-19T18:23:18Z", "bug_id": 11114, "creation_time": "2002-08-19T18:23:18Z", "text": "Hmmm... I don't think you ever exactly answered Jeff's question.\n\nIn any case, please try with 2.0.40 and see if it fixes your problem.  If not,\nfeel free to reopen this report.\n\n"}, {"count": 4, "tags": [], "text": "Upgraded to Apache 2.0.40, FreeBSD 4.6.2-RELEASE; problem still exists.\n\nI'm not so sure this is a problem with the sendfile(2) changes, as that only\nchanges what is retured in sbytes, so I don't see how that would be cause a\nproblem with the actual contents returned.\n\nThe problem definately seems to be with the way either AFS is handling things or\nthe way Apache is handling AFS.  I'm leaning toward the latter because other\nprograms work fine w.r.t. viewing images on AFS, except Apache corrupts things\nbadly...download the image and take a look at it and see what I mean.  It seems\nto collect things from all across the filesystem inadvertantly.", "is_private": false, "bug_id": 11114, "id": 21985, "time": "2002-08-29T17:01:10Z", "creator": "aangel@myrealbox.com", "creation_time": "2002-08-29T17:01:10Z", "attachment_id": null}, {"count": 5, "tags": [], "creator": "aangel@myrealbox.com", "attachment_id": null, "is_private": false, "id": 23997, "time": "2002-10-05T15:39:00Z", "bug_id": 11114, "creation_time": "2002-10-05T15:39:00Z", "text": "Upgraded to 2.0.42, ... now I'm really sad.  *Everything* is like this, not  just images. "}, {"count": 6, "tags": [], "text": "First thing to try:\n\nAdd --without-sendfile to configure, see if you can duplicate the problem.\n\nNext thing to try:\n\nSee doc for EnableMMap directive; use \"EnableMMap Off\" in a container for the\nfiles mounted via AFS.  See if you can duplicate te problem when we don't\nmmap the files.\n\nNext thing to try:\n\nUse truss to get a syscall trace of an httpd process delivering a corrupted\nfile and attach the trace to this PR.\n\nI assume that you're using prefork MPM and thread support is disabled, right?\n(Those are the defaults for FreeBSD.)\n\nThanks,\n\nJeff", "attachment_id": null, "id": 23999, "creation_time": "2002-10-05T17:34:51Z", "time": "2002-10-05T17:34:51Z", "creator": "trawick@apache.org", "bug_id": 11114, "is_private": false}, {"count": 7, "attachment_id": 3370, "bug_id": 11114, "is_private": false, "id": 24020, "time": "2002-10-06T04:30:22Z", "creator": "aangel@myrealbox.com", "creation_time": "2002-10-06T04:30:22Z", "tags": [], "text": "Created attachment 3370\nOutput of truss -o httpd.truss httpd -X"}, {"count": 8, "attachment_id": null, "bug_id": 11114, "is_private": false, "id": 24021, "time": "2002-10-06T04:32:59Z", "creator": "aangel@myrealbox.com", "creation_time": "2002-10-06T04:32:59Z", "tags": [], "text": "First thing tried, failed.  Second thing tried, failed.  Didn't mess with MPM\nstuff, nor threading, so if that's default, then that should be what it is. \nTruss output attached.  Also, what does --without-sendfile do?  I see no mention\nof it in the configure script."}, {"count": 9, "tags": [], "text": "my comments to your previous comments:\n\n>Truss output attached.  \n\nlooks like it is truncated...  doesn't seem to show anything beyond Apache\ninitialization\n\n>Also, what does --without-sendfile do?  \n\nit disables support for the sendfile() kernel call\n\n>I see no mention of it in the configure script.\n\n--without-sendfile is an APR configure option; specify it on the Apache\nconfigure and it will pass it through to APR\n\ndo \"srclib/apr/configure --help\" to see APR configure options\n\n", "attachment_id": null, "id": 26842, "creator": "trawick@apache.org", "time": "2002-11-23T02:24:59Z", "bug_id": 11114, "creation_time": "2002-11-23T02:24:59Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 11114, "attachment_id": null, "id": 46238, "time": "2003-10-24T11:24:37Z", "creator": "trawick@apache.org", "creation_time": "2003-10-24T11:24:37Z", "is_private": false, "text": "If you still encounter this problem with recent Apache, try \"EnableSendfile Off\"\nin config file and verify with truss that sendfile() isn't used.\n"}]