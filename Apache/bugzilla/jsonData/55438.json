[{"count": 0, "tags": [], "bug_id": 55438, "attachment_id": 30738, "id": 169523, "time": "2013-08-16T18:51:10Z", "creator": "dmikusa@gopivotal.com", "creation_time": "2013-08-16T18:51:10Z", "is_private": false, "text": "Created attachment 30738\nPatch against TestNonBlockingAPI.java\n\nI have a simple echo servlet which uses the Servlet 3.1 Non-Blocking IO API.  It creates a ReadListener, that reads the request's input, buffers it, creates a WriteListener that takes the buffered input and echoes it back to the response.\n\nMost of the time this works OK, but when I send a request with no input data I get the following error.\n\n6-Aug-2013 11:18:09.523 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 1452 ms\njava.lang.IllegalStateException: The non-blocking write listener has already been set\n       at org.apache.coyote.Response.setWriteListener(Response.java:583)\n       at org.apache.catalina.connector.OutputBuffer.setWriteListener(OutputBuffer.java:665)\n       at org.apache.catalina.connector.CoyoteOutputStream.setWriteListener(CoyoteOutputStream.java:162)\n       at com.pivotal.demos.nbio.EchoNbioServlet$1.onAllDataRead(EchoNbioServlet.java:77)\n       at org.apache.catalina.connector.CoyoteAdapter.asyncDispatch(CoyoteAdapter.java:384)\n       at org.apache.coyote.http11.AbstractHttp11Processor.asyncDispatch(AbstractHttp11Processor.java:1607)\n       at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:622)\n       at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n       at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1592)\n       at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1550)\n       at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n       at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n       at java.lang.Thread.run(Thread.java:724)\n16-Aug-2013 11:20:13.205 SEVERE [http-nio-8080-exec-7] org.apache.catalina.connector.CoyoteAdapter.asyncDispatch Exception while processing an asynchronous request\njava.lang.NullPointerException\n       at org.apache.catalina.connector.CoyoteAdapter.asyncDispatch(CoyoteAdapter.java:429)\n       at org.apache.coyote.http11.AbstractHttp11Processor.asyncDispatch(AbstractHttp11Processor.java:1607)\n       at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:622)\n       at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:223)\n       at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1592)\n       at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1550)\n       at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n       at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n       at java.lang.Thread.run(Thread.java:724)\n\nLooking into it, what appears to be happening is that the \"ReadListener.onAllDataRead()\" method is being called twice.  Because I'm setting the WriteListener in the \"onAllDataRead\" method, the second invocation of \"onAllDataRead\" causes the IllegalStateException.  I was assuming that \"onAllDataRead\" should only be called once and so it would be OK to set the WriteListener in that method.  Can \"onAllDataRead\" be legitimately called multiple times?\n\nMark> No. Any chance you could convert the code below into a Tomcat unit test?\n\nAttaching unit test to replicate the issue."}, {"count": 1, "tags": [], "bug_id": 55438, "attachment_id": null, "text": "One additional note about the test, if you set the \"streaming\" argument to \"postUrl\" method to \"true\" then the test passes.  This seems to only occur when \"streaming\" is set to \"false\".", "id": 169524, "time": "2013-08-16T18:54:17Z", "creator": "dmikusa@gopivotal.com", "creation_time": "2013-08-16T18:54:17Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 55438, "attachment_id": null, "id": 169572, "time": "2013-08-19T14:54:53Z", "creator": "markt@apache.org", "creation_time": "2013-08-19T14:54:53Z", "is_private": false, "text": "Thanks for the test case. I have committed it to trunk along with a fix that works on OSX. I need to check the fix on Windows and Linux before closing this issue."}, {"count": 3, "tags": [], "bug_id": 55438, "attachment_id": null, "text": "Tests pass on Linux and Windows. Resolving as fixed.", "id": 169573, "time": "2013-08-19T15:13:39Z", "creator": "markt@apache.org", "creation_time": "2013-08-19T15:13:39Z", "is_private": false}]