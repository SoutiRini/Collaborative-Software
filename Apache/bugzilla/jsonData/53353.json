[{"attachment_id": null, "tags": [], "bug_id": 53353, "text": "If contentType attribute of a JSP page has a broken value, Tomcat 7 can behave strangely and send two charset values in Content-Type header.\n\nTo reproduce:\n1. Create this simple JSP file, ROOT/test.jsp\nNote, that there is a typo: \"UTF-8\" instead of \"charset=UTF-8\". It is what triggers this issue.\n\n[[[\n<%@page pageEncoding=\"UTF-8\" contentType=\"text/html; UTF-8\" %>\nHello world!\n]]]\n\n2. Start Tomcat and access the page with Firefox\nhttp://localhost:8080/test.jsp\n\n(I am using version 12, with Live HTTP Headers addon). When the page loads: right-click -> Page info -> look for the value of Encoding. Then look for the value of Content-Type header.\n\nWith current Tomcat 6.0:\nEncoding: UTF-8\nContent-Type header: text/html; UTF-8;charset=UTF-8\n\nWith current Tomcat 7.0 (7.0.23):\nEncoding: ISO-8859-1\nContent-Type header: text/html; UTF-8;charset=UTF-8;charset=ISO-8859-1\n\n===============\n\nI think it is related to new contentType header parser (fix for bug 52811: r1300154 + r1300155 + r1304275 + r1304895).\n\nIt is not a very convincing example, but it looks like it confirms the fears against backporting the fix for bug 52811 to 6.0.", "count": 0, "id": 159652, "time": "2012-06-03T17:55:37Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2012-06-03T17:55:37Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 53353, "text": "> With current Tomcat 7.0 (7.0.23)\n\nI meant 7.0.27. The issue is reproducible with 7.0.27 release and with current trunk of 7.0.x.", "count": 1, "id": 159653, "time": "2012-06-03T18:03:42Z", "creator": "knst.kolinko@gmail.com", "creation_time": "2012-06-03T18:03:42Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 53353, "is_private": false, "id": 159656, "creation_time": "2012-06-03T19:29:24Z", "time": "2012-06-03T19:29:24Z", "creator": "markt@apache.org", "text": "At one level, this is just a case of \"garbage in, garbage out\" with current 7.0.x producing different garbage that 6.0.x for the same input. Granted, the 7.0.x garbage is likely to cause more problems for clients.\n\nDigging a little deeper, it appears that Jasper is making the same error as the root cause of bug 52811, namely using contentType.indexOf(\"charset=\") < 0. That is probably more forgivable in Jasper than it was in Tomcat.\n\nI'll see if I can configure the parser to handle parameters of the form \"name\" rather than \"name=value\". That should make Tomcat a little more robust against this sort of input. Since the input is invalid, the specs don't say how this should be handled so we have a little latitude here.", "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 53353, "attachment_id": null, "id": 159657, "time": "2012-06-03T20:05:06Z", "creator": "markt@apache.org", "creation_time": "2012-06-03T20:05:06Z", "is_private": false, "text": "Fixed in trunk and 7.0.x and will be included in 7.0.28 onwards.\n\nInvalid parameters in the content-type header value will now be ignored. The resulting header for 7.0.x of the input above is:\n\nContent-Type header: text/html;charset=UTF-8"}]