[{"count": 0, "tags": [], "bug_id": 60488, "is_private": false, "text": "After upgrading to 8.5.9 we have a number of failing tests with this stacktrace:\n\njava.lang.NullPointerException\n\tat org.apache.catalina.connector.Request.parseCookies(Request.java:3056)\n\tat org.apache.catalina.connector.Request.convertCookies(Request.java:3076)\n\tat org.apache.catalina.connector.Request.addCookie(Request.java:1733)\n\nThe request is minimally populated so there are no cookies on it, however, the parseCookies method should not fail.  This was broken by rev 1766675 on Oct 26 2016.", "id": 195517, "time": "2016-12-16T13:48:42Z", "creator": "apache@ben.eflow.org", "creation_time": "2016-12-16T13:48:42Z", "attachment_id": null}, {"count": 1, "tags": [], "bug_id": 60488, "is_private": false, "text": "Created attachment 34529\nPatch to fix NPE\n\nSee attached patch to fix this.", "id": 195518, "time": "2016-12-16T13:49:18Z", "creator": "apache@ben.eflow.org", "creation_time": "2016-12-16T13:49:18Z", "attachment_id": 34529}, {"text": "In that kind of situation, we usually fix the mock object (TesterRequest here) to make it more complete. But it's not failing any Tomcat test, so there's nothing to fix here.\nYou should probably add your own mock object rather than rely on Tomcat's mock objects.", "tags": [], "bug_id": 60488, "attachment_id": null, "count": 2, "id": 195519, "time": "2016-12-16T14:33:10Z", "creator": "remm@apache.org", "creation_time": "2016-12-16T14:33:10Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 60488, "is_private": false, "text": "The test in my code does this, why should I need to generate mock objects?\n\n_request = new Request();\nContext context = new StandardContext();\ncontext.setCookieProcessor( new LegacyCookieProcessor() );\n_request.getMappingData().context = context;\n_request.addCookie( new Cookie( \"session_id\", \"s1\" ) ); // NPE happens here\n\n\nIf I add the cookie before setting the context it passes because of null check in convertCookies().  \n\nIf I call _request.clearCookies() before addCookie() it works because the cookiesConverted boolean is set to true.", "id": 195520, "time": "2016-12-16T15:03:05Z", "creator": "apache@ben.eflow.org", "creation_time": "2016-12-16T15:03:05Z", "attachment_id": null}, {"count": 4, "tags": [], "creator": "remm@apache.org", "attachment_id": null, "is_private": false, "id": 195527, "time": "2016-12-16T17:00:23Z", "bug_id": 60488, "creation_time": "2016-12-16T17:00:23Z", "text": "Well, if you're using the real org.apache.catalina.connector.Request object, it needs a non null org.apache.coyote.Request coyoteRequest field to work properly (which then takes care of the serverCookies instance being there). Otherwise you have to create a mock object like TesterRequest to have it work right."}, {"count": 5, "tags": [], "bug_id": 60488, "attachment_id": null, "id": 195528, "time": "2016-12-16T18:40:47Z", "creator": "apache@ben.eflow.org", "creation_time": "2016-12-16T18:40:47Z", "is_private": false, "text": "Yes, we do set that too, I just neglected to copy it in:\n_request.setCoyoteRequest( new org.apache.coyote.Request() );\n\nI did make a mistake, seems its the connector that is null on that line, not the serverCookies.\n\nSetting a connector on the request in our test does fix this.  Is it possible to have a null connector at this point during normal operation? If not, then we can just chalk this up to more setup being required in testing.  \n\nAnd as a sidenote: just because you don't have any tomcat tests failing does not mean it's not a bug! :-)"}, {"count": 6, "tags": [], "bug_id": 60488, "is_private": false, "id": 195816, "creation_time": "2017-01-03T11:57:52Z", "time": "2017-01-03T11:57:52Z", "creator": "markt@apache.org", "text": "Yes, it is expected that the Connector is non-null.\n\nLooking at the code, we could make the connector field final and requiring it in the constructor. We might be able to go further and require a non-null Connector is provided. That would require refactoring a few tests but the changes to the Tomcat code would be minimal. I'll look at this for trunk (9.0.x). Whether I actually commit it will depend on what the refactoring ends up looking like and if there are any side-effects I haven't spotted yet.", "attachment_id": null}]