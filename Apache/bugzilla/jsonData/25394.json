[{"count": 0, "tags": [], "creator": "j_a_fernandez@yahoo.com", "text": "This is a regression from ANT1.5.\n\nI have a buildfile which needs to call multiple <script> tasks during the \nbuilding process. The scripts are complex requiring database connections and \nsuch. In ANT1.5 the build runs without problems but in ANT1.6 it runs out of \nmemory.\n\nWe are talking about 100 script calls.", "id": 48804, "time": "2003-12-10T12:54:06Z", "bug_id": 25394, "creation_time": "2003-12-10T12:54:06Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "peter.reilly@corvil.com", "text": "Hi Jose, is is possible to provide a simple\nexample showing the problem.\n\nI have tested with:\n<project default=\"doscript\">\n  <target name=\"doscript\">\n    <script language=\"javascript\"/>\n    <script language=\"javascript\"/>\n    <script language=\"javascript\"/>\n    <script language=\"javascript\"/>\n    <script language=\"javascript\"/>\n    <script language=\"javascript\"/>\n    <script language=\"javascript\"/>\n    <taskdef name=\"jwait\" classname=\"task.JWait\" classpath=\"classes\"/>\n    <jwait/>\n  </target>\n</project>\n\nAnd there does not seem to be much difference in use\nof memory on ant1.5 and ant1.6.\n(in this case ant1.6 seems to use less due to the on demand loading\nof tasks)", "id": 48892, "time": "2003-12-11T10:37:52Z", "bug_id": 25394, "creation_time": "2003-12-11T10:37:52Z", "is_private": false, "attachment_id": null}, {"count": 2, "tags": [], "creator": "j_a_fernandez@yahoo.com", "text": "I am not sure how to give you an example here.\nBut maybe I can give some details on the kind of environment I am using:\nscript.language = beanshell\nscript.length ~~ 1000 lines\n\nI will try to see if I can get numbers on memory utilization from inside the \nscripts.\n\nIs there a way to ask ant to report memory utilization?", "id": 48895, "time": "2003-12-11T12:41:20Z", "bug_id": 25394, "creation_time": "2003-12-11T12:41:20Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 25394, "is_private": false, "id": 49234, "attachment_id": null, "creator": "j_a_fernandez@yahoo.com", "creation_time": "2003-12-17T10:59:47Z", "time": "2003-12-17T10:59:47Z", "text": "I am seeing a lost of between 2100KB and 2500KB for each call to one of my \nscripts that connect to the database. The memory hogging seems quite \nconsistent. The memory is not been release even if the <script> runs inside an \n<antcall>. I.e., after returning from the <antcall>, the memory does not get \nreleased.\n\nSo, this may give some clues for people looking at this bug.\nI will try to see if I can find some more clues on what is going on. This \nhappens when using beanshell as the scripting language.\n\n"}, {"count": 4, "tags": [], "creator": "j_a_fernandez@yahoo.com", "text": "\nI have been investigating more about this issue and I am getting very\ndisappointing numbers on memory utilization for ANT1.6.0.\n\nI am uploading two attachements for the run of the exact same build and script\nusing 1.5.3 and 1.6.0 the script as part of the job shows the memory \nutilization at different times by executing the following code:\n\n    long getMemoryUsage() {\n        Runtime runtime = Runtime.getRuntime();\n        runtime.gc();\n        return (runtime.totalMemory() - runtime.freeMemory())/1024;\n    }\n\nThe results indicate two things:\n1) 1.6.0 takes much more memory to execute the script\n2) Although memory is release in 1.5.3 between separate executions of\n<ant> in 1.6.0 memory is never released.\n\nIn both cases there is memory hogging overall. But in 1.6.0 is quite bad.\nAny ideas.\n", "id": 49603, "time": "2003-12-23T13:41:03Z", "bug_id": 25394, "creation_time": "2003-12-23T13:41:03Z", "is_private": false, "attachment_id": null}, {"count": 5, "tags": [], "bug_id": 25394, "is_private": false, "id": 49604, "attachment_id": 9683, "creator": "j_a_fernandez@yahoo.com", "creation_time": "2003-12-23T13:42:05Z", "time": "2003-12-23T13:42:05Z", "text": "Created attachment 9683\nScript output on ANT 1.5.3"}, {"count": 6, "tags": [], "creator": "j_a_fernandez@yahoo.com", "is_private": false, "id": 49605, "creation_time": "2003-12-23T13:42:45Z", "time": "2003-12-23T13:42:45Z", "bug_id": 25394, "text": "Created attachment 9684\nScript output on ANT 1.6.0", "attachment_id": 9684}, {"count": 7, "tags": [], "creator": "antoine@apache.org", "text": "Hi,\nI have just had a quick look at the code of the script task. Can it be the \n    private ScriptRunner runner = new ScriptRunner();\nwhich does not get set to null at the end of the execute method, and which is\nholding memory ?", "id": 49606, "time": "2003-12-23T14:57:51Z", "bug_id": 25394, "creation_time": "2003-12-23T14:57:51Z", "is_private": false, "attachment_id": null}, {"count": 8, "tags": [], "bug_id": 25394, "attachment_id": null, "is_private": false, "id": 49613, "time": "2003-12-23T15:52:25Z", "creator": "peter.reilly@corvil.com", "creation_time": "2003-12-23T15:52:25Z", "text": "I do not think so.\nThere is no need to set fields in a object to\nnull - if the object itself is garbage collected....\noh, oh...................... penny drops.....\n\nAntonie, you are correct........\nThe script task object is referenced by the wrapper pointer\nin RuntimeConfigurable, the RuntimeConfigurable object is referenced\nby the UnknownElement, the UnknownElement is referenced by its\nparent and it by the target and it by the project.\n\nSo tasks in ant are created and never GC'ed - not good.\n\nActually the live-cycle of a Task is not well documented so simply\nsetting the scriptrunner to null is not good as the execute\nmay be called twice.\n\nIn any case, a simple change like Antoine's should solve\nthis particular problem.\n\nI have updated ant HEAD and ant 1.6 HEAD"}, {"count": 9, "attachment_id": null, "bug_id": 25394, "text": "Do not forget ScriptDef which uses the same code pattern as Script.\n\nIn the mean time I have been looking at BSF (as an act of desperation) and \nnotice that there is a bunch of calls that we are probably missing, in \nparticular in the Engines do static things.\n\nSo the BSFManager has a terminate() that terminates properly all the engines\nthat are active. Maybe it is a good idea for ScriptRunner to call it on a \nfinally block in executeScript().\n\nAdditionally there are BSFManager.setClassPath(String) and \nBSFManager.setClassLoader(ClassLoader) that when given will be used by engines \nthat need such things. This would really help for people like me that use \nbeanshell which can made use the code I am building.\n\nAnybody willing to take a look at this?\n", "id": 49614, "time": "2003-12-23T16:11:18Z", "creator": "j_a_fernandez@yahoo.com", "creation_time": "2003-12-23T16:11:18Z", "tags": [], "is_private": false}, {"count": 10, "tags": [], "bug_id": 25394, "text": "Non of this things have fix the problem. Still there is a  memory overflow", "id": 49622, "attachment_id": null, "creator": "j_a_fernandez@yahoo.com", "creation_time": "2003-12-23T18:11:32Z", "time": "2003-12-23T18:11:32Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 25394, "attachment_id": null, "text": "Grrr... ok can you use a memory displayer\nto show the objects.\nLike:\nhttp://khelekore.org/jmp/\n", "id": 49624, "time": "2003-12-23T18:32:22Z", "creator": "peter.reilly@corvil.com", "creation_time": "2003-12-23T18:32:22Z", "is_private": false}, {"count": 12, "tags": [], "creator": "j_a_fernandez@yahoo.com", "is_private": false, "id": 49852, "creation_time": "2003-12-30T16:45:36Z", "time": "2003-12-30T16:45:36Z", "bug_id": 25394, "text": "OK I ran the profilers and it looks like the problem is not ANT 1.6.0\nbut beanshell 2.0b1 which has a memory leak of its bsh.Token objects.\nThe more parsing one does (more scripts one calls) the worst the problem\ngets.\n\nSince ANT 1.6.0 requires people to upgrade to BSH2.0b1 (prev versions\nneed IBM's BSF), I would suggest leaving this issue open (corrected the \nsubject).\n", "attachment_id": null}, {"count": 13, "attachment_id": null, "bug_id": 25394, "text": "Cool, btw, I think that beanshell 1.3 should work with\nant 1.6.0 (at least that is what I put in the manual\npage ;-)).\n\n", "id": 49853, "time": "2003-12-30T16:51:25Z", "creator": "peter.reilly@corvil.com", "creation_time": "2003-12-30T16:51:25Z", "tags": [], "is_private": false}, {"count": 14, "tags": [], "creator": "j_a_fernandez@yahoo.com", "text": "I tried BSH 1.3 but I get a NullPointerException when accessing\nproperties or something like that. The same buildfile runs fine\nwith BSH 2.0b1 (except for the memory leak).\n", "id": 49881, "time": "2003-12-31T01:20:13Z", "bug_id": 25394, "creation_time": "2003-12-31T01:20:13Z", "is_private": false, "attachment_id": null}, {"count": 15, "tags": [], "creator": "peterreilly@apache.org", "text": "As the problem is with beanshell, I am closing this.\nPlease reopen if required.", "id": 63370, "time": "2004-09-10T16:59:58Z", "bug_id": 25394, "creation_time": "2004-09-10T16:59:58Z", "is_private": false, "attachment_id": null}]