[{"count": 0, "tags": [], "bug_id": 38464, "text": "While fiddeling around WRT Bug 37788 I did some more intensive testing of the\nAPR-Connector and noticed that sometimes the transmitted data is corrupted or\nthe transmission stalls prematurely.\nTwo cases where I can reproduce this reliabally:\n1. A listing of a directory containing ~ 2500 files will never be completely\nshown in the broser - only ~ 500 files are shown (the exact number varies).\n2. When trying to download the attached binary file (filled with random bytes)\nusing Firefox only part of the file will be transmitted. Doing the same with\nwget results in the following:\n$ LC_ALL=C http_proxy=\"\" wget http://192.168.42.4:8080/t2.bin\n--16:21:31--  http://192.168.42.4:8080/t2.bin\n           => `t2.bin'\nConnecting to 192.168.42.4:8080... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 38,144 (37K) [application/octet-stream]\n\n77% [==========================================================>               \n  ] 29,656        --.--K/s    ETA 00:05\n\n16:21:51 (1.45 KB/s) - Connection closed at byte 29656. Retrying.\n\n--16:21:52--  http://192.168.42.4:8080/t2.bin\n  (try: 2) => `t2.bin'\nConnecting to 192.168.42.4:8080... connected.\nHTTP request sent, awaiting response... 206 Partial Content\nLength: 38,144 (37K), 8,488 (8.3K) remaining [application/octet-stream]\n\n100%[+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++=================>]\n38,144        --.--K/s\n\n16:21:52 (33.87 MB/s) - `t2.bin' saved [38144/38144]\n\nThe downloaded file differs from the file on the server.\nWether useSendfile is set to false or not on the Connector doesn't make a\ndifference.\n\nNeither of these problems shows up when using the pure Java Connector.\n\nSystem spec:\nGentoo Linux with kernel 2.6.15-gentoo-r1\nSun JDK 1.5.0.06\nAPR 1.2.2\ntomcat-native-1.1.1 from the 5.5.15 distribution\ngcc 3.4.4\nStock Tomcat 5.5.15 (5.5.15 should be added to bugzilla's version field BTW)\n\nSince I thought there might be some oddity with my Gentoo system, I installed\nKubuntu breezy badger (5.10) with kernel 2.6.12-10-386 and gcc 4.01 on another\nmachine and could reproduce both problems there.\nI've also tested the file download (case 2.) on a Windows machine with Tomcat\n5.5.15 - there ist works flawlessly.\n\nBTW: although I mentioned Bug 37788 this issue is completely unrelated since I\ndid not use any modified components but the stock Tomcat 5.5.15.", "id": 85262, "time": "2006-01-31T16:25:49Z", "creator": "bugzilla@schoenhaber.de", "creation_time": "2006-01-31T16:25:49Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "text": "Created attachment 17548\nBinary file for download test", "attachment_id": 17548, "id": 85263, "creator": "bugzilla@schoenhaber.de", "time": "2006-01-31T16:28:15Z", "bug_id": 38464, "creation_time": "2006-01-31T16:28:15Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 38464, "text": "I doubt it makes a difference on 2.6 kernel (i386) cause it works on\namd64. Here is the fresh build with your test file.\napr-1.2.2\ntomcat-native-1.1.1\napache-tomcat-5.5.15\nOpenSSL 0.9.7a (part of distro)\n\n[mturk@dev03 bin]$ uname -a\nLinux 2.4.21-37.ELsmp #1 SMP Wed Sep 7 13:28:55 EDT 2005 i686 i686 i386 GNU/Linux\n\n[mturk@dev03 bin]$ wget http://localhost:9080/t2.bin\n--11:40:02--  http://localhost:9080/t2.bin\n           => `t2.bin'\nResolving localhost... 127.0.0.1\nConnecting to localhost|127.0.0.1|:9080... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 38,144 (37K) [application/octet-stream]\n\n100%[========================================================================================>]\n38,144        --.--K/s\n\n11:40:03 (94.00 MB/s) - `t2.bin' saved [38144/38144]", "id": 85265, "time": "2006-01-31T17:44:52Z", "creator": "mturk@apache.org", "creation_time": "2006-01-31T17:44:52Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "bug_id": 38464, "attachment_id": null, "id": 85267, "time": "2006-01-31T18:08:27Z", "creator": "remm@apache.org", "creation_time": "2006-01-31T18:08:27Z", "is_private": false, "text": "Another user reported the same thing with about any resource (JSPs, files), but\nhis report was bad. I cannot reproduce this (advice: if the test case seems too\ntrivial, then there's something wrong with the report), so you'll have to\ninvestigate yourself if you are interested."}, {"count": 4, "tags": [], "creator": "psamek@redash.cz", "is_private": false, "text": "When APR and compression=\"off\" are used I will get only:\n- 16Kb (yes 16384B) output from jsp on AMD64 (2xOpteron, Sun JDK\n1.5.0.06,APR 1.2.2,tomcat-native-1.1.1 from the 5.5.15 distribution, gcc\n3.4.4, StockTomcat 5.5.15)\n- 64Kb output from jsp on Intel P4 (Sun JDK 1.5.0.06,APR\n1.2.2,tomcat-native-1.1.1 from the 5.5.15 distribution, gcc 3.4.4,\nStockTomcat 5.5.15).\nThese sizes are reported by firefox 1.5. If I use wget, then the output\nseems complete (goes beyond 64Kb), but some corruptions take place (f.e.\n\"</psp;\" instead of \"</p>&nbsp;\"). The jsp gets some data from MySQL db.\n\nBinary data (.mp3) and static text/plain are OK, but static html or xml not.\nWith wget and html I have similar reconnecting behavior like described\nin the initial report. The simple test - serving only static web.xml from tomcat\ndistribution - looks so with wget:\npavel$ wget http://myserver.cz:8080/web.xml\n--14:23:41--  http://myserver.cz:8080/web.xml\n           => `web.xml'\nResolving myserver.cz... x.x.x.x\nConnecting to myserver.cz|x.x.x.x|:8080... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 45,215 (44K) [application/xml]\n\n78% [===========================>         ] 35,279        --.--K/s    ETA 00:05\n\n14:24:02 (1.64 KB/s) - Connection closed at byte 35279. Retrying.\n\n--14:24:02--  http://myserver.cz:8080/web.xml\n  (try: 2) => `web.xml'\nConnecting to myserver.cz|x.x.x.x|:8080... connected.\nHTTP request sent, awaiting response... 206 Partial Content\nLength: 45,215 (44K), 9,936 (9.7K) remaining [application/xml]\n\n100%[++++++++++++++++++++++++++++========>] 45,215        --.--K/s             \n\n14:24:02 (13.12 MB/s) - `web.xml' saved [45215/45215]\n\n\nIn the case of APR and compression=\"on\" the .jsp are OK (but the\nreported size is far below the above limits, so I can't say if it works\nin general).\n\nMaybe I have to \"set some option\" in server.xml or in configure for apr, but\nwhich one???\n\nSimilar output has been reported: [1],[2]\n[1] http://marc.theaimsgroup.com/?l=tomcat-user&m=113711225801348&w=2\n[2] http://marc.theaimsgroup.com/?l=tomcat-user&m=113819615811780&w=2\n", "id": 85342, "time": "2006-02-02T14:29:44Z", "bug_id": 38464, "creation_time": "2006-02-02T14:29:44Z", "attachment_id": null}, {"count": 5, "tags": [], "creator": "remm@apache.org", "is_private": false, "text": "(In reply to comment #4)\n> Similar output has been reported: [1],[2]\n> [1] http://marc.theaimsgroup.com/?l=tomcat-user&m=113711225801348&w=2\n> [2] http://marc.theaimsgroup.com/?l=tomcat-user&m=113819615811780&w=2\n\nThe first one doesn't know what he's talking about, the second one is using a\nbuild which has a buffering bug in some cases, while I will ignore the third one\n(that's you) since he didn't read our replies.\n", "id": 85343, "time": "2006-02-02T14:42:41Z", "bug_id": 38464, "creation_time": "2006-02-02T14:42:41Z", "attachment_id": null}, {"count": 6, "attachment_id": null, "bug_id": 38464, "is_private": false, "id": 85346, "time": "2006-02-02T15:07:21Z", "creator": "bugzilla@schoenhaber.de", "creation_time": "2006-02-02T15:07:21Z", "tags": [], "text": "(In reply to comment #3)\n> Another user reported the same thing with about any resource (JSPs, files), but\n> his report was bad. I cannot reproduce this (advice: if the test case seems too\n> trivial, then there's something wrong with the report), so you'll have to\n> investigate yourself if you are interested.\n\n(In reply to comment #3)\n> Another user reported the same thing with about any resource (JSPs, files), but\n> his report was bad. I cannot reproduce this (advice: if the test case seems too\n> trivial, then there's something wrong with the report), so you'll have to\n> investigate yourself if you are interested.\n\nOf course I'm interested - and even more so since I'm obviously not the only one\nhaving problems with the APR Connector.\nAnd yes, my testcase ist absolutely trivial. That's because it's trivial for me\nto trigger the error. For me, what's not trivial but extremely hard, is to set\nup a linux system where this simple file gets served without errors. I have yet\nto succeed in this task.\nI'm not very experienced in debugging tomcat and even less when it comes to\ndebugging JNI parts. So, comparing a system that shows the error with one that\ndoesn't seems to me a reasonable first try.\nIf you have any other hints on what to do to get this tracked down, I'd be grateful.\n\n"}, {"count": 7, "tags": [], "bug_id": 38464, "attachment_id": null, "text": "(In reply to comment #5)\n> The first one doesn't know what he's talking about, the second one is using a\n> build which has a buffering bug in some cases, while I will ignore the third one\n> (that's you) since he didn't read our replies.\n> \nI have read your replies (although a reply in the sense of \"it works for me,\ndon't bother\" is not much constructive). Maybe the buffering bug is not\ncompletely solved in 5.5.15, I don't know. \nAnyway if you have some hint (what to test, configure) I would be also very\ngrateful.\n(BTW: The compression seems to be a workaround only for usual files. For bigger\nfiles output is corrupted or not complete again.)", "id": 85351, "time": "2006-02-02T16:20:10Z", "creator": "psamek@redash.cz", "creation_time": "2006-02-02T16:20:10Z", "is_private": false}, {"count": 8, "attachment_id": null, "bug_id": 38464, "is_private": false, "id": 85353, "time": "2006-02-02T16:48:16Z", "creator": "remm@apache.org", "creation_time": "2006-02-02T16:48:16Z", "tags": [], "text": "(In reply to comment #6)\n> Of course I'm interested - and even more so since I'm obviously not the only one\n> having problems with the APR Connector.\n> And yes, my testcase ist absolutely trivial. That's because it's trivial for me\n> to trigger the error. For me, what's not trivial but extremely hard, is to set\n> up a linux system where this simple file gets served without errors.\n\nYou can try to look at what would make your configuration/usage different. Ex:\nrunning as root or not, TCP parameters, etc."}, {"count": 9, "tags": [], "text": "(In reply to comment #8)\n> You can try to look at what would make your configuration/usage different. Ex:\n> running as root or not, TCP parameters, etc.\n\nNeither does the account Tomcat is running under make any difference nor have I\nset any TCP parameters, I'm simply using the defaults.\n\nI'm not sure how I managed to miss the following point: the download of the\nbinary file works without problems for me, if the client runs on the same\nmachine as Tomcat. Downloading from a different machine results in a corrupted\nfile - as initially reported. I'm sorry for this omitment.\nMladen, could you please check if it still works for you when you download the\nfile from a different machine?\n\nRemote or not - the listing of the directory with many files is always somehow\ngarbled for me. To simulate this I'll attach a JSP that creates a HTML table\nwith many rows (1000 by default, cofigurable via the \"rows\" request parameter).\nDepending on the number of rows actually requested, most of the time the\ndocument differs in one way or another from what is to be expected. This ranges\nfrom a <tr> not correctly closed somewhere in the middle of the document to only\npart of it being actually transmitted.\nIt would be nice if you could check this too.\n\nI thought the NPTL-enabled libc on my system might have something to do with the\nproblem. So I started Tomcat using a libc using LinuxThreads - no difference.\nI've even set up a complete system with kernel 2.4.31 (and a libc with\nLinuxThreads obviously) but the behaviour was the same - local download works,\nremote doesn't.\n\nAfter all, I have still not been able to set up a systen on which the APR\nConnector works reliabaly. I start to get desperate.\n", "attachment_id": null, "id": 85459, "creator": "bugzilla@schoenhaber.de", "time": "2006-02-06T13:26:42Z", "bug_id": 38464, "creation_time": "2006-02-06T13:26:42Z", "is_private": false}, {"count": 10, "attachment_id": 17601, "bug_id": 38464, "is_private": false, "id": 85460, "time": "2006-02-06T13:28:54Z", "creator": "bugzilla@schoenhaber.de", "creation_time": "2006-02-06T13:28:54Z", "tags": [], "text": "Created attachment 17601\nJSP that creates a table with many rows. Default 1000, configure via rows request param"}, {"count": 11, "tags": [], "creator": "mturk@apache.org", "is_private": false, "text": "Right, you are correct.\nFor slow networks the actuall number written can be lower,\nand inside InternalAprOutputBuffer we presume that all the\ndata has been written.\n\nI'll create a patch, although I'm not sure wether it should\ngo in native or InternalAprOutputBuffer.\nIf it's implemented in native (already done that) it will follow the Java\nOutputStream api, but in that case it would not follow the APR api.\n\nI'll discuss that with other guys to see what they think.\n\nHere a snippet for network.c that resolves that, so you can test it\nand tell me if it's working for you too. I think it should because\nI was able to duplicate the bug.\n\nTCN_IMPLEMENT_CALL(jint, Socket, sendbb)(TCN_STDARGS, jlong sock,\n                                         jint offset, jint len)\n{\n    tcn_socket_t *s = J2P(sock, tcn_socket_t *);\n    apr_size_t nbytes = (apr_size_t)len;\n    apr_size_t sent = 0;\n    apr_status_t ss;\n\n    UNREFERENCED_STDARGS;\n    TCN_ASSERT(sock != 0);\n    TCN_ASSERT(s->opaque != NULL);\n    TCN_ASSERT(s->jsbbuff != NULL);\n#ifdef TCN_DO_STATISTICS\n    sp_max_send = TCN_MAX(sp_max_send, nbytes);\n    sp_min_send = TCN_MIN(sp_min_send, nbytes);\n    sp_tot_send += nbytes;\n    sp_num_send++;\n#endif\n\n    while (sent < nbytes) {\n\tapr_size_t wr = nbytes - sent;\n\tss = (*s->net->send)(s->opaque, s->jsbbuff + offset + sent, &wr);\n\tif (ss != APR_SUCCESS)\n\t    break;\n\tsent += wr;\n    }\n    if (ss == APR_SUCCESS)\n        return (jint)sent;\n    else {\n        TCN_ERROR_WRAP(ss);\n        return -(jint)ss;\n    }\n}", "id": 85511, "time": "2006-02-07T10:45:15Z", "bug_id": 38464, "creation_time": "2006-02-07T10:45:15Z", "attachment_id": null}, {"count": 12, "tags": [], "bug_id": 38464, "attachment_id": null, "text": "(In reply to comment #11)\n> Here a snippet for network.c that resolves that, so you can test it\n> and tell me if it's working for you too. I think it should because\n> I was able to duplicate the bug.\n\nYes, it's working for me too.\n\nThanks Mladen! I already began to think that THEY manipulated my Tomcat because\nTHEY had decided to drive me nuts.", "id": 85518, "time": "2006-02-07T11:51:32Z", "creator": "bugzilla@schoenhaber.de", "creation_time": "2006-02-07T11:51:32Z", "is_private": false}, {"count": 13, "tags": [], "bug_id": 38464, "attachment_id": null, "is_private": false, "id": 85521, "time": "2006-02-07T12:08:15Z", "creator": "mturk@apache.org", "creation_time": "2006-02-07T12:08:15Z", "text": "I think we'll made a patch in java instead tweaking native.\nI spoke with Remy, and he'll try to update the usage of sendXX calls\nto conform to APR api, that is similar to NIO."}, {"count": 14, "tags": [], "bug_id": 38464, "attachment_id": null, "id": 85522, "time": "2006-02-07T13:06:30Z", "creator": "remm@apache.org", "creation_time": "2006-02-07T13:06:30Z", "is_private": false, "text": "Yes, the APR API seems more closely related to java.nio, but I am too used to\njava.io. Since I don't want to compromise usage of the API in non blocking\nsituations, it is probably better to do the loop in Java.\n\nThe Java patch applied is (hopefully it's correct, please test it):\n\nModified:\ntomcat/connectors/trunk/http11/src/java/org/apache/coyote/http11/InternalAprOutputBuffer.java\nURL:\nhttp://svn.apache.org/viewcvs/tomcat/connectors/trunk/http11/src/java/org/apache/coyote/http11/InternalAprOutputBuffer.java?rev=375582&r1=375581&r2=375582&view=diff\n==============================================================================\n---\ntomcat/connectors/trunk/http11/src/java/org/apache/coyote/http11/InternalAprOutputBuffer.java\n(original)\n+++\ntomcat/connectors/trunk/http11/src/java/org/apache/coyote/http11/InternalAprOutputBuffer.java\nTue Feb  7 03:47:20 2006\n@@ -695,9 +695,14 @@\n     protected void flushBuffer()\n         throws IOException {\n         if (bbuf.position() > 0) {\n-            if (Socket.sendbb(socket, 0, bbuf.position()) < 0) {\n-                throw new IOException(sm.getString(\"iib.failedwrite\"));\n-            }\n+            int i = 0;\n+            int n = 0;\n+            do {\n+                if ((n = Socket.sendbb(socket, i, bbuf.position())) < 0) {\n+                    throw new IOException();\n+                }\n+                i += n;\n+            } while (i < bbuf.position());\n             bbuf.clear();\n         }\n     }\n\n"}, {"count": 15, "tags": [], "creator": "bugzilla@schoenhaber.de", "is_private": false, "text": "(In reply to comment #14)\n> The Java patch applied is (hopefully it's correct, please test it):\n\nNo, doesn't work for me. The table.jsp gets corrupted. (It does work when a\ntcnative with Mladen's patch is used - but that's beside the point, isn't it?)\n", "id": 85530, "time": "2006-02-07T15:05:43Z", "bug_id": 38464, "creation_time": "2006-02-07T15:05:43Z", "attachment_id": null}, {"count": 16, "tags": [], "bug_id": 38464, "attachment_id": null, "id": 85532, "time": "2006-02-07T15:32:46Z", "creator": "remm@apache.org", "creation_time": "2006-02-07T15:32:46Z", "is_private": false, "text": "(In reply to comment #15)\n> (In reply to comment #14)\n> > The Java patch applied is (hopefully it's correct, please test it):\n> \n> No, doesn't work for me. The table.jsp gets corrupted. (It does work when a\n> tcnative with Mladen's patch is used - but that's beside the point, isn't it?)\n\nI do not find this convincing."}, {"count": 17, "tags": [], "creator": "bugzilla@schoenhaber.de", "attachment_id": null, "text": "(In reply to comment #16)\n> I do not find this convincing.\n\nI do.\nAren't you interested in an AprConnector that actually works?\n", "id": 85533, "time": "2006-02-07T15:37:08Z", "bug_id": 38464, "creation_time": "2006-02-07T15:37:08Z", "is_private": false}, {"count": 18, "tags": [], "creator": "mturk@apache.org", "is_private": false, "text": "Fixed in the SVN.", "id": 85538, "time": "2006-02-07T16:26:07Z", "bug_id": 38464, "creation_time": "2006-02-07T16:26:07Z", "attachment_id": null}, {"count": 19, "tags": [], "creator": "bugzilla@schoenhaber.de", "is_private": false, "text": "Mladen, R\u00e9my, thanks for the good work!", "id": 85547, "time": "2006-02-07T18:18:44Z", "bug_id": 38464, "creation_time": "2006-02-07T18:18:44Z", "attachment_id": null}]