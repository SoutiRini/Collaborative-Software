[{"count": 0, "tags": [], "bug_id": 40470, "text": "When use ServerSupportFunction function with HSE_REQ_SEND_RESPONSE_HEADER or\nHSE_REQ_SEND_RESPONSE_HEADER_EX and supply valid headers, HTTP status become 0 (\naccess log recorded as - ) and the HTTP response status is 500 in Apache 2.2.3.\nOn Apache 2.0.54, the HTTP return status is 200 OK but the access log also\nrecorded - as return status code.\n\n(I do the debug on 2.2.3 src)\nThis seems to be because of the return value of ap_scan_script_header_err_core\nand ap_scan_script_header_err_strs functions (in server/util_script.c) or\nincorrectly replace HTTP response status code in send_response_header\n(arch/win32/mod_isapi.c).\n\nserver/util_script.c\nap_scan_script_header_err_core -> the function does look for Status in the\nheaders and set the r->status if it exist. The function then return OK (which is\ndefine as 0). Shouldn't this function return HTTP_OK if status is not define in\nthe header or the status that is provided in the header?\n\nap_scan_script_header_err_strs -> return the result from\nap_scan_script_header_err_core\n\narch/win32/mod_isapi.c\nsend_response_header -> Call ap_scan_script_header_err_strs then assign the\nreturn value to cid->r->status.\n\nFrom line 712\n    if (stat) {\n        cid->r->status = ap_scan_script_header_err_strs(cid->r, NULL,\n                                        &termch, &termarg, stat, head, NULL);\n        cid->ecb->dwHttpStatusCode = cid->r->status;\n    }\n    else {\n        cid->r->status = ap_scan_script_header_err_strs(cid->r, NULL,\n                                        &termch, &termarg, head, NULL);\n  .....\n\nIn both case cid->r->status get set to 0 (with valid header) when it should be\n200 (HTTP_OK) or other status which may be set from ap_scan_script_header_err_core.\n\nI call ServerSupportFunction by:\n1)\nstrTemp.Format(\"Content-Type: text/html\\r\\nContent-Length: %d\\r\\n\\r\\n\",\nstrResult.GetLength());\ndw = strTemp.GetLength();\npECB->ServerSupportFunction( pECB->ConnID, HSE_REQ_SEND_RESPONSE_HEADER,\n\t\t\t\tNULL, \n\t\t\t\t&dw, \n\t\t\t\t(DWORD *)(LPCTSTR) strTemp)\n2)\nstrTemp.Format(\"Content-Type: text/html\\r\\nContent-Length: %d\\r\\n\\r\\n\",\nstrResult.GetLength());\ndw = strTemp.GetLength();\npECB->ServerSupportFunction( pECB->ConnID, HSE_REQ_SEND_RESPONSE_HEADER,\n\t\t\t\t\"200 OK\", \n\t\t\t\t&dw, \n\t\t\t\t(DWORD *)(LPCTSTR) strTemp)\n3)\nWith HSE_REQ_SEND_RESPONSE_HEADER_EX putting the same info in HSE_URL_MAPEX_INFO \nfor the second param.\n\nLet me know if you need more info.\nTP", "id": 93355, "time": "2006-09-11T18:13:26Z", "creator": "tpirapokin@kencast.com", "creation_time": "2006-09-11T18:13:26Z", "is_private": false, "attachment_id": null}, {"attachment_id": null, "tags": [], "creator": "wrowe@apache.org", "text": "I believe you will find this solved in the dev branch, and I've prepared the\nbackport in source and binary form for you to test against 2.0 or 2.2.\n\nPlease grab http://people.apache.org/~wrowe/mod_isapi-416293.zip - replace\nyour mod_isapi.so (or the sources of mod_isapi.c/.h if you compile your own\napache server) and report back.\n", "count": 1, "id": 93356, "time": "2006-09-11T18:38:27Z", "bug_id": 40470, "creation_time": "2006-09-11T18:38:27Z", "is_private": false}, {"count": 2, "tags": [], "bug_id": 40470, "attachment_id": null, "text": "The new mod_isapi-416293 still have problem with ServerSupportFunction at least\non HSE_REQ_SEND_RESPONSE_HEADER\n\nFor HSE_REQ_SEND_RESPONSE_HEADER, after send_response_header call, no handling\nof ate == headlen. \n\n        if (ate < 0) {\n            apr_set_os_error(APR_FROM_OS_ERROR(ERROR_INVALID_PARAMETER));\n            return 0;\n        }\n        else if ((apr_size_t)ate < headlen) {\n            apr_bucket_brigade *bb;\n            apr_bucket *b;\n            bb = apr_brigade_create(cid->r->pool, c->bucket_alloc);\n            b = apr_bucket_transient_create((char*) data_type + ate,\n                                           headlen - ate, c->bucket_alloc);\n            APR_BRIGADE_INSERT_TAIL(bb, b);\n            b = apr_bucket_flush_create(c->bucket_alloc);\n            APR_BRIGADE_INSERT_TAIL(bb, b);\n            rv = ap_pass_brigade(cid->r->output_filters, bb);\n            cid->response_sent = 1;\n            return (rv == APR_SUCCESS);\n        }\n    }\n\nFrom looking at the code for case HSE_REQ_SEND_RESPONSE_HEADER_EX, the return\n\"return (rv == APR_SUCCESS);\", rv may not be initialized.\n\nIn my test with Apache 2.2.3, now I get status log as 1 on the access log, and\nget real Internal Error from apache. I test with HSE_REQ_SEND_RESPONSE_HEADER\ncase and get ate == headlen (Is that suppose to be the normal correct case?)\n\nThanks,\nTP", "id": 93359, "time": "2006-09-11T19:58:37Z", "creator": "tpirapokin@kencast.com", "creation_time": "2006-09-11T19:58:37Z", "is_private": false}, {"count": 3, "tags": [], "bug_id": 40470, "text": "Good catch, thank you.\n\nWhen there is a new update, I'll point you at it, or feel free to offer the\npatch you believe will fix it.", "id": 93364, "time": "2006-09-11T21:02:16Z", "creator": "wrowe@apache.org", "creation_time": "2006-09-11T21:02:16Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "bug_id": 40470, "attachment_id": 19151, "id": 96019, "time": "2006-11-20T15:34:14Z", "creator": "wrowe@apache.org", "creation_time": "2006-11-20T15:34:14Z", "is_private": false, "text": "Created attachment 19151\nDon't fail when sent is the length of the headers\n\nHere's a suggested patch that retains the ability to incrementally add headers,\n\nand won't send them until some of the body is ready.\n\nFeedback please, I plan to commit in the next day if possible."}, {"count": 5, "tags": [], "creator": "tpirapokin@kencast.com", "text": "From your last change:\n- server response with correct status code (200 OK)\n- apache log response code as 1 on the isapi handled request (shouldn't it be 200)\n- PROBLEM - The response has \n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>200 OK</title>\n</head><body>\n<h1>OK</h1>\n<p>The server encountered an internal error or\nmisconfiguration and was unable to complete\nyour request.</p>\n<p>Please contact the server administrator,\n root@localhost and inform them of the time the error occurred,\nand anything you might have done that may have\ncaused the error.</p>\n<p>More information about this error may be available\nin the server error log.</p>\n</body></html>\n\nappend to the end of it.\n\nI change the code from the last patch mod_isapi-416293 you direct to me.\n\nThanks\n\n\n(In reply to comment #4)\n> Created an attachment (id=19151) [edit]\n> Don't fail when sent is the length of the headers\n> \n> Here's a suggested patch that retains the ability to incrementally add headers,\n> \n> and won't send them until some of the body is ready.\n> \n> Feedback please, I plan to commit in the next day if possible.", "id": 96039, "time": "2006-11-21T09:38:38Z", "bug_id": 40470, "creation_time": "2006-11-21T09:38:38Z", "is_private": false, "attachment_id": null}, {"count": 6, "tags": [], "bug_id": 40470, "attachment_id": 19256, "text": "Created attachment 19256\n2.0 isapi workaround\n\nThe problem in the last comment is caused with persistent connections. Apply\nthis patch to work around this problem (reverting to old behavior for this\nreturn code).", "id": 96879, "time": "2006-12-13T12:35:05Z", "creator": "asf@divinehawk.com", "creation_time": "2006-12-13T12:35:05Z", "is_private": false}, {"count": 7, "tags": [], "text": "Created attachment 19257\nPatch to record non-APR_SUCCESS results (do not apply with the hack)\n\nObviously if ap_pass_brigade fails, we should -not- return OK.\n\nWhat rv are we seeing here?  Are we getting (invalid) http\nresult codes from ap_pass_brigade?  or another error?\n\nIt seems an error emit would be appropriate here.  See patch.", "attachment_id": 19257, "bug_id": 40470, "id": 96883, "time": "2006-12-13T13:15:29Z", "creator": "wrowe@apache.org", "creation_time": "2006-12-13T13:15:29Z", "is_private": false}, {"count": 8, "tags": [], "creator": "asf@divinehawk.com", "text": "Well the problem is that (rv == APR_SUCCESS) is 1. OK is 0.\n\nSo I am not sure if the right solution is:\n\nreturn ((rv == APR_SUCCESS) ? OK : HTTP_INTERNAL_SERVER_ERROR);\n", "id": 96920, "time": "2006-12-14T09:56:55Z", "bug_id": 40470, "creation_time": "2006-12-14T09:56:55Z", "is_private": false, "attachment_id": null}, {"count": 9, "tags": [], "bug_id": 40470, "attachment_id": null, "text": "http://svn.apache.org/viewvc?view=rev&revision=492333\n\nPatch committed, thanks to all who provided feedback, and to Matt for the pointer\nto OK results from the handler.", "id": 97584, "time": "2007-01-03T15:03:00Z", "creator": "wrowe@apache.org", "creation_time": "2007-01-03T15:03:00Z", "is_private": false}, {"count": 10, "tags": [], "creator": "wrowe@apache.org", "attachment_id": null, "id": 97587, "time": "2007-01-03T15:11:03Z", "bug_id": 40470, "creation_time": "2007-01-03T15:11:03Z", "is_private": false, "text": "*** Bug 40698 has been marked as a duplicate of this bug. ***"}, {"count": 11, "tags": [], "bug_id": 40470, "attachment_id": null, "id": 97589, "time": "2007-01-03T15:12:58Z", "creator": "wrowe@apache.org", "creation_time": "2007-01-03T15:12:58Z", "is_private": false, "text": "*** Bug 40549 has been marked as a duplicate of this bug. ***"}, {"count": 12, "tags": [], "creator": "wrowe@apache.org", "text": "An unreleased build of this module including the last several patches is now \navailable for testing against httpd-2.0 and 2.2 from \n\n  http://people.apache.org/~wrowe/mod_isapi-r492341-win32.zip\n\nIt's not a release; if you test, report back 1) here, at 2) dev@httpd.a.o, or\nat users@httpd.a.o.  Thank you.", "id": 97613, "time": "2007-01-03T20:05:12Z", "bug_id": 40470, "creation_time": "2007-01-03T20:05:12Z", "is_private": false, "attachment_id": null}]