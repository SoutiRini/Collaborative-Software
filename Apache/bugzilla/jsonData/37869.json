[{"count": 0, "tags": [], "creator": "s.dimichele@auselda.it", "text": "I configured tomcat to use SSL client-certificate authentication and i need to\naccess the client certificate contained in the request. To do this, i use:\n\nObject cert = request.getAttribute(\"javax.servlet.request.X509Certificate\");\n\nIf i do not use the APR components, this works correctly.\nIf i use the APR components, instead, the object returned by the previous\nstatement is always null.\nThe authentication itself works correctly (for instance if CA not valid,\ncertificate expired, etc..) in both cases.\n\nFor use the APR components, i just put the binary files downloaded at:\n\nhttp://tomcat.heanet.ie/native/1.1.1/binaries/win32/\n\nin the bin directory of my tomcat installation, according the guide found on\ntomcat site:\n\nhttp://tomcat.apache.org/tomcat-5.5-doc/apr.html\n\nThis is the SSL HTTP connector extract from my server.xml (non APR version):\n\n<Connector port=\"443\" maxHttpHeaderSize=\"8192\"\nmaxThreads=\"150\" minSpareThreads=\"25\" maxSpareThreads=\"75\"\nenableLookups=\"false\" disableUploadTimeout=\"true\"\nacceptCount=\"100\" scheme=\"https\" secure=\"true\"\nclientAuth=\"want\" \nsslProtocol=\"TLS\"\ntruststoreFile=\"./tomcat5keystore.jks\" truststorePass=\"xxx\"\nkeystoreFile=\"./tomcat5keystore.jks\" keystorePass=\"xxx\"                 \n/>\n\n\nThis is the SSL HTTP connector extract from my server.xml (non APR version):\n\n<Connector port=\"443\" maxHttpHeaderSize=\"8192\"\nmaxThreads=\"150\" minSpareThreads=\"25\" maxSpareThreads=\"75\"\nenableLookups=\"false\" disableUploadTimeout=\"true\"\nacceptCount=\"100\" scheme=\"https\" secure=\"true\"\nclientAuth=\"want\" \nSSLEngine=\"on\" \nSSLVerifyClient=\"optional\"\nSSLCertificateFile=\"${catalina.base}/cert.crt\"\nSSLCertificateKeyFile=\"${catalina.base}/key.pem\"\nSSLCACertificateFile=\"${catalina.base}/ca_postecom.crt\"\nSSLPassword=\"xxx\"\n/>", "id": 83548, "time": "2005-12-12T11:49:58Z", "bug_id": 37869, "creation_time": "2005-12-12T11:49:58Z", "is_private": false, "attachment_id": null}, {"count": 1, "tags": [], "creator": "mturk@apache.org", "attachment_id": null, "id": 83549, "time": "2005-12-12T12:20:52Z", "bug_id": 37869, "creation_time": "2005-12-12T12:20:52Z", "is_private": false, "text": "Is it working with\nSSLVerifyClient=\"require\"\n\n"}, {"count": 2, "tags": [], "creator": "s.dimichele@auselda.it", "text": "(In reply to comment #1)\n> Is it working with\n> SSLVerifyClient=\"require\"\n\nNo, same behaviour described before.\nNon-APR: client-certificate authentication works, certificate obtained in request.\nAPR: client-certificate authentication works, but no certificate in request.\n\n\n", "id": 83551, "time": "2005-12-12T12:44:08Z", "bug_id": 37869, "creation_time": "2005-12-12T12:44:08Z", "is_private": false, "attachment_id": null}, {"count": 3, "tags": [], "creator": "ms.mouha@progress.com.tn", "text": "I have the same problem on Apache 2.054, Fedora 4, Tomcat 5.0.30-5jpp_6fc and\nmod_jk.i386 1.2.6-3jpp_4fc\n\nAll these packages are installed via yum\nWhen I try to get the client cert from the request\n(javax.servlet.request.X509Certificate) it fails and I get this message in\ncatalina.out :\norg.apache.jk.server.JkCoyoteHandler action(org.apache.coyote.ActionCode,\njava.lang.Object)\nSEVERE: Certificate convertion failed\n\nI have found no work arround\n\n", "id": 84705, "time": "2006-01-17T12:08:24Z", "bug_id": 37869, "creation_time": "2006-01-17T12:08:24Z", "is_private": false, "attachment_id": null}, {"count": 4, "tags": [], "creator": "fubar@mytrashmail.com", "attachment_id": null, "id": 91320, "time": "2006-07-14T18:25:05Z", "bug_id": 37869, "creation_time": "2006-07-14T18:25:05Z", "is_private": false, "text": "yes, i got this behaviour too.\ni tryed with \nall SSLVerifyClient options and SSLVerifyDepth but still certifcate dont get\nforwared to request.\n\ni guess problem is in: org.apache.coyote.http11.Http11AprProcessor \nelse if (actionCode == ActionCode.ACTION_REQ_SSL_ATTRIBUTE)\nelse if (actionCode == ActionCode.ACTION_REQ_SSL_CERTIFICATE)"}, {"count": 5, "tags": [], "text": "\nI have the same problem (Tomcat 6.0.2, Tomcat-Native 1.1.7-win32, Windows XPSP2,\nOpenSSL 0.9.8d, APR from Apache-2.2.3).\n\n1) when I HTTP-GET some sample servlet from browser (IE, FireFox),\nHttp11APRProcessor doesn't insert user certificate into request object\n\n2) when I use \"openssl s_client\", everything's fine\n\nSimple debug reveals one problem - in request from browser, there is no data in:\nint certLength = SSLSocket.getInfoI(socket, SSL.SSL_INFO_CLIENT_CERT_CHAIN)\n\nand so there is no cert chain in:\nbyte[] data = SSLSocket.getInfoB(socket, SSL.SSL_INFO_CLIENT_CERT_CHAIN + i);\n\nbut there IS client's certificate in (my added sample line):\nSSLSocket.getInfoB(socket, org.apache.tomcat.jni.SSL.SSL_INFO_CLIENT_CERT)\n\nand it is the client's certificate.\n\nI think the problem is with not looking for data under key\n\"org.apache.tomcat.jni.SSL.SSL_INFO_CLIENT_CERT\" but only under\n\"org.apache.tomcat.jni.SSL.SSL_INFO_CLIENT_CERT_CHAIN\"...\n\nwith regards\nGrzegorz Grzybek\n\n", "attachment_id": null, "bug_id": 37869, "id": 96271, "time": "2006-11-28T07:35:25Z", "creator": "grgr@winuel.com.pl", "creation_time": "2006-11-28T07:35:25Z", "is_private": false}, {"attachment_id": null, "tags": [], "bug_id": 37869, "text": "If you have tested a patch to also consider SSL_INFO_CLIENT_CERT if the chain is\nempty, you can submit it.", "count": 6, "id": 96281, "time": "2006-11-28T09:04:23Z", "creator": "remm@apache.org", "creation_time": "2006-11-28T09:04:23Z", "is_private": false}, {"text": "Created attachment 19196\nPatch to look for client's certificate in Http11AprProcessor\n\nThis patch searches for client's certificate when there is no client's\ncertificate chain under SSL.SSL_INFO_CLIENT_CERT_CHAIN key.\nWhen SSLSocket.getInfoI(socket, SSL.SSL_INFO_CLIENT_CERT_CHAIN) returns 0 (not\n-1), client's cert is retrieved using SSLSocket.getInfoB(socket,\nSSL.SSL_INFO_CLIENT_CERT).", "tags": [], "bug_id": 37869, "attachment_id": 19196, "count": 7, "id": 96340, "time": "2006-11-29T04:11:12Z", "creator": "grgr@winuel.com.pl", "creation_time": "2006-11-29T04:11:12Z", "is_private": false}, {"count": 8, "tags": [], "bug_id": 37869, "attachment_id": null, "text": "I forgot - this patch is for tomcat 6.0.2, it could also be applied to e.g.\n5.5.20 (with changed line numbers).\n\nGrzegorz Grzybek\n", "id": 96342, "time": "2006-11-29T04:17:00Z", "creator": "grgr@winuel.com.pl", "creation_time": "2006-11-29T04:17:00Z", "is_private": false}, {"count": 9, "tags": [], "text": "Re-opening since the patch has yet to be applied.", "attachment_id": null, "bug_id": 37869, "id": 97015, "time": "2006-12-18T03:55:23Z", "creator": "markt@apache.org", "creation_time": "2006-12-18T03:55:23Z", "is_private": false}, {"count": 10, "tags": [], "bug_id": 37869, "text": "Seems like this one\nhttp://issues.apache.org/bugzilla/show_bug.cgi?id=41382\nis the same issue.\n\nThe patch given with #41382 was designed for 5.5.20 and fixes also the\nbug-replication (bug copy/paste?) found a few lines down in the code. It has\nbeen tested at Sparus Software with various scenarios (e.g.: SSL client does not\ngive a cert chain, gives a cert chain, etc)\n\nIf I am not mistaken, the patch given with #37869 seems incorrect as it replaces\nan incorrect behaviour (only giving certification chain excluding client\ncertificate) with another incorrect behaviour (only giving client cert but not\nthe certificate chain, see servlet spec for details of what the correct behavior is)\n\n", "id": 98203, "attachment_id": null, "creator": "cpierret@sparus-software.com", "creation_time": "2007-01-17T15:09:01Z", "time": "2007-01-17T15:09:01Z", "is_private": false}, {"count": 11, "tags": [], "bug_id": 37869, "attachment_id": null, "text": "*** Bug 41382 has been marked as a duplicate of this bug. ***", "id": 98205, "time": "2007-01-17T15:12:45Z", "creator": "cpierret@sparus-software.com", "creation_time": "2007-01-17T15:12:45Z", "is_private": false}, {"count": 12, "tags": [], "creator": "cpierret@sparus-software.com", "text": "Created attachment 19425\nA patch making the behavior consistent with Servlet spec 2.3 (for v5.5.20)\n\nSame as patch in #41382\nFixes issues in patch \"19196: Patch to look for client's certificate in\nHttp11AprProcessor\"", "id": 98206, "time": "2007-01-17T15:15:19Z", "bug_id": 37869, "creation_time": "2007-01-17T15:15:19Z", "is_private": false, "attachment_id": 19425}, {"count": 13, "tags": [], "creator": "marcin.burdyk@aigcredit.pl", "text": "Comment on attachment 19196\nPatch to look for client's certificate in Http11AprProcessor\n\nNigdy nie my&#347;l&#281; o przysz&#322;o&#347;ci. Nadchodzi ona\nwystarczaj&#261;co szybko.", "id": 98316, "time": "2007-01-20T18:46:48Z", "bug_id": 37869, "creation_time": "2007-01-20T18:46:48Z", "is_private": false, "attachment_id": 19196}, {"count": 14, "tags": [], "bug_id": 37869, "attachment_id": 19425, "text": "Comment on attachment 19425\nA patch making the behavior consistent with Servlet spec 2.3 (for v5.5.20)\n\n>Index: connectors/http11/src/java/org/apache/coyote/http11/Http11AprProcessor.java\n>===================================================================\n>--- Http11AprProcessor.java\t(revision 496746)\n>+++ Http11AprProcessor.java\t(working copy)\n>@@ -1095,16 +1095,29 @@\n>                             (AprEndpoint.CIPHER_SUITE_KEY, sslO);\n>                     }\n>                     // Client certificate chain if present\n>+                    //////////////////////////////////////////////////\n>+                    // CP: does not include client certificate, only CA certificates\n>+                    // see documentation of SSL_get_peer_cert_chain() in openssl and sslinfo.c in native APR code\n>+                    // SSL_get_peer_cert_chain() returns a pointer to STACKOF(X509) certificates forming the certificate chain of the peer.\n>+                    // If called on the client side, the stack also contains the peer's certificate;\n>+                    // if called on the server side, the peer's certificate must be obtained separately using SSL_get_peer_certificate(3).\n>+                    // If the peer did not present a certificate, NULL is returned.\n>+                    //\n>                     int certLength = SSLSocket.getInfoI(socket, SSL.SSL_INFO_CLIENT_CERT_CHAIN);\n>+                    // retrieve client certificate\n>+                    byte[] clientCert = SSLSocket.getInfoB(socket, SSL.SSL_INFO_CLIENT_CERT);\n>                     X509Certificate[] certs = null;\n>-                    if (certLength > 0) {\n>-                        certs = new X509Certificate[certLength];\n>+                    if (clientCert != null) {\n>+                        certs = new X509Certificate[certLength+1]; // add one for the client certificate\n>+\n>+                        CertificateFactory cf =\n>+                        CertificateFactory.getInstance(\"X.509\");\n>+\n>+                        certs[0] = (X509Certificate) cf.generateCertificate(new ByteArrayInputStream(clientCert));\n>+\n>                         for (int i = 0; i < certLength; i++) {\n>                             byte[] data = SSLSocket.getInfoB(socket, SSL.SSL_INFO_CLIENT_CERT_CHAIN + i);\n>-                            CertificateFactory cf =\n>-                                CertificateFactory.getInstance(\"X.509\");\n>-                            ByteArrayInputStream stream = new ByteArrayInputStream(data);\n>-                            certs[i] = (X509Certificate) cf.generateCertificate(stream);\n>+                            certs[i+1] = (X509Certificate) cf.generateCertificate(new ByteArrayInputStream(data));\n>                         }\n>                     }\n>                     if (certs != null) {\n>@@ -1142,16 +1155,29 @@\n>                     // Renegociate certificates\n>                     SSLSocket.renegotiate(socket);\n>                     // Client certificate chain if present\n>+                    //////////////////////////////////////////////////\n>+                    // CP: does not include client certificate, only CA certificates\n>+                    // see documentation of SSL_get_peer_cert_chain() in openssl and sslinfo.c in native APR code\n>+                    // SSL_get_peer_cert_chain() returns a pointer to STACKOF(X509) certificates forming the certificate chain of the peer.\n>+                    // If called on the client side, the stack also contains the peer's certificate;\n>+                    // if called on the server side, the peer's certificate must be obtained separately using SSL_get_peer_certificate(3).\n>+                    // If the peer did not present a certificate, NULL is returned.\n>+                    //\n>                     int certLength = SSLSocket.getInfoI(socket, SSL.SSL_INFO_CLIENT_CERT_CHAIN);\n>+                    // retrieve client certificate\n>+                    byte[] clientCert = SSLSocket.getInfoB(socket, SSL.SSL_INFO_CLIENT_CERT);\n>                     X509Certificate[] certs = null;\n>-                    if (certLength > 0) {\n>-                        certs = new X509Certificate[certLength];\n>+                    if (clientCert != null) {\n>+                        certs = new X509Certificate[certLength+1]; // add one for the client certificate\n>+\n>+                        CertificateFactory cf =\n>+                        CertificateFactory.getInstance(\"X.509\");\n>+\n>+                        certs[0] = (X509Certificate) cf.generateCertificate(new ByteArrayInputStream(clientCert));\n>+\n>                         for (int i = 0; i < certLength; i++) {\n>                             byte[] data = SSLSocket.getInfoB(socket, SSL.SSL_INFO_CLIENT_CERT_CHAIN + i);\n>-                            CertificateFactory cf =\n>-                                CertificateFactory.getInstance(\"X.509\");\n>-                            ByteArrayInputStream stream = new ByteArrayInputStream(data);\n>-                            certs[i] = (X509Certificate) cf.generateCertificate(stream);\n>+\t\t\t\t\t\t\tcerts[i+1] = (X509Certificate) cf.generateCertificate(new ByteArrayInputStream(data));\n>                         }\n>                     }\n>                     if (certs != null) {", "id": 98333, "time": "2007-01-21T15:49:00Z", "creator": "marcin.burdyk@aigcredit.pl", "creation_time": "2007-01-21T15:49:00Z", "is_private": false}, {"count": 15, "tags": [], "creator": "andre.cruz@co.sapo.pt", "text": "I see that 6.0 was patched. Will this be applied to 5.5 as well?", "id": 115796, "time": "2008-04-23T03:41:12Z", "bug_id": 37869, "creation_time": "2008-04-23T03:41:12Z", "is_private": false, "attachment_id": null}, {"text": "*** Bug 39637 has been marked as a duplicate of this bug. ***", "tags": [], "bug_id": 37869, "attachment_id": null, "count": 16, "id": 128514, "time": "2009-07-05T07:35:41Z", "creator": "markt@apache.org", "creation_time": "2009-07-05T07:35:41Z", "is_private": false}, {"count": 17, "tags": [], "creator": "markt@apache.org", "attachment_id": null, "id": 128657, "time": "2009-07-09T01:23:07Z", "bug_id": 37869, "creation_time": "2009-07-09T01:23:07Z", "is_private": false, "text": "This has been fixed in 5.5.x and will be included in 5.5.28 onwards"}]